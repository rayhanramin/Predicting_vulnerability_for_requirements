<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23480:044240bd35e00b5c202b97d37ba532ef5f23d309</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 044240bd35e00b5c202b97d37ba532ef5f23d309" />
<meta property="og:url" content="/comm-central/rev/044240bd35e00b5c202b97d37ba532ef5f23d309" />
<meta property="og:description" content="Bug 463402 - Remove E-Mail notification dialogs - Part 1: processing;r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 044240bd35e00b5c202b97d37ba532ef5f23d309 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/044240bd35e00b5c202b97d37ba532ef5f23d309">shortlog</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/044240bd35e00b5c202b97d37ba532ef5f23d309">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309">files</a> |
changeset |
<a href="/comm-central/raw-rev/044240bd35e00b5c202b97d37ba532ef5f23d309">raw</a>  | <a href="/comm-central/archive/044240bd35e00b5c202b97d37ba532ef5f23d309.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463402">Bug 463402</a> - Remove E-Mail notification dialogs - Part 1: processing;r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#109;&#97;&#107;&#101;&#109;&#121;&#100;&#97;&#121;&#64;&#103;&#109;&#120;&#45;&#116;&#111;&#112;&#109;&#97;&#105;&#108;&#46;&#100;&#101;</td></tr>
<tr><td></td><td class="date age">Sun, 11 Mar 2018 13:59:42 +0100</td></tr>

<tr>
 <td>changeset 23480</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/044240bd35e00b5c202b97d37ba532ef5f23d309">044240bd35e00b5c202b97d37ba532ef5f23d309</a></td>
</tr>



<tr>
<td>parent 23479</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3cc1812a10b418c8aac85feb001e332cb56892c9">3cc1812a10b418c8aac85feb001e332cb56892c9</a>
</td>
</tr>

<tr>
<td>child 23481</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5ae749bd1ed8dbb33e1995c60fdc13152c066752">5ae749bd1ed8dbb33e1995c60fdc13152c066752</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=044240bd35e00b5c202b97d37ba532ef5f23d309">14181</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 11 Mar 2018 20:22:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@3c9b650ac751 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3c9b650ac75148a4f0e1d9d121bc90b04fd82e5e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3c9b650ac75148a4f0e1d9d121bc90b04fd82e5e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3c9b650ac75148a4f0e1d9d121bc90b04fd82e5e&newProject=comm-central&newRevision=d6eb1caf9e2d690cc2c5429e573b7beb6bb695a8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3c9b650ac75148a4f0e1d9d121bc90b04fd82e5e&newProject=comm-central&newRevision=d6eb1caf9e2d690cc2c5429e573b7beb6bb695a8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3c9b650ac75148a4f0e1d9d121bc90b04fd82e5e&newProject=comm-central&newRevision=d6eb1caf9e2d690cc2c5429e573b7beb6bb695a8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463402">463402</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463402">Bug 463402</a> - Remove E-Mail notification dialogs - Part 1: processing;r=philipp

- adding support for processing in different response modes
- removing compatibility mode for OL 2002 and earlier</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/public/calITransactionManager.idl">calendar/base/public/calITransactionManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/public/calITransactionManager.idl">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/public/calITransactionManager.idl">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/public/calITransactionManager.idl">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/public/calITransactionManager.idl">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/public/calITransactionManager.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calItemModule.manifest">calendar/base/src/calItemModule.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calItemModule.manifest">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calItemModule.manifest">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calItemModule.manifest">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calItemModule.manifest">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calItemModule.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/lightning/content/lightning.js">calendar/lightning/content/lightning.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/lightning/content/lightning.js">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/lightning/content/lightning.js">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/lightning/content/lightning.js">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/lightning/content/lightning.js">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/lightning/content/lightning.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/locales/en-US/chrome/lightning/lightning.properties">calendar/locales/en-US/chrome/lightning/lightning.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/locales/en-US/chrome/lightning/lightning.properties">file</a> |
<a href="/comm-central/annotate/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/locales/en-US/chrome/lightning/lightning.properties">annotate</a> |
<a href="/comm-central/diff/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/locales/en-US/chrome/lightning/lightning.properties">diff</a> |
<a href="/comm-central/comparison/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/locales/en-US/chrome/lightning/lightning.properties">comparison</a> |
<a href="/comm-central/log/044240bd35e00b5c202b97d37ba532ef5f23d309/calendar/locales/en-US/chrome/lightning/lightning.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -222,24 +222,24 @@ function setDefaultItemValues(aItem, aCa</span>
<a href="#l1.4"></a><span id="l1.4">  * @param startDate     (optional) The event's start date.</span>
<a href="#l1.5"></a><span id="l1.5">  * @param endDate       (optional) The event's end date.</span>
<a href="#l1.6"></a><span id="l1.6">  * @param summary       (optional) The event's title.</span>
<a href="#l1.7"></a><span id="l1.7">  * @param event         (optional) A template event to show in the dialog</span>
<a href="#l1.8"></a><span id="l1.8">  * @param aForceAllDay  (optional) Make sure the event shown in the dialog is an</span>
<a href="#l1.9"></a><span id="l1.9">  *                                   allday event.</span>
<a href="#l1.10"></a><span id="l1.10">  */</span>
<a href="#l1.11"></a><span id="l1.11"> function createEventWithDialog(calendar, startDate, endDate, summary, event, aForceAllday) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let onNewEvent = function(item, opcalendar, originalItem, listener) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let onNewEvent = function(item, opcalendar, originalItem, listener, extresponse=null) {</span>
<a href="#l1.14"></a><span id="l1.14">         if (item.id) {</span>
<a href="#l1.15"></a><span id="l1.15">             // If the item already has an id, then this is the result of</span>
<a href="#l1.16"></a><span id="l1.16">             // saving the item without closing, and then saving again.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-            doTransaction(&quot;modify&quot;, item, opcalendar, originalItem, listener);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+            doTransaction(&quot;modify&quot;, item, opcalendar, originalItem, listener, extresponse);</span>
<a href="#l1.19"></a><span id="l1.19">         } else {</span>
<a href="#l1.20"></a><span id="l1.20">             // Otherwise, this is an addition</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-            doTransaction(&quot;add&quot;, item, opcalendar, null, listener);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+            doTransaction(&quot;add&quot;, item, opcalendar, null, listener, extresponse);</span>
<a href="#l1.23"></a><span id="l1.23">         }</span>
<a href="#l1.24"></a><span id="l1.24">     };</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     if (event) {</span>
<a href="#l1.27"></a><span id="l1.27">         if (!event.isMutable) {</span>
<a href="#l1.28"></a><span id="l1.28">             event = event.clone();</span>
<a href="#l1.29"></a><span id="l1.29">         }</span>
<a href="#l1.30"></a><span id="l1.30">         // If the event should be created from a template, then make sure to</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineat">@@ -277,24 +277,24 @@ function createEventWithDialog(calendar,</span>
<a href="#l1.32"></a><span id="l1.32">  *</span>
<a href="#l1.33"></a><span id="l1.33">  * @param calendar      (optional) The calendar to create the task in</span>
<a href="#l1.34"></a><span id="l1.34">  * @param dueDate       (optional) The task's due date.</span>
<a href="#l1.35"></a><span id="l1.35">  * @param summary       (optional) The task's title.</span>
<a href="#l1.36"></a><span id="l1.36">  * @param todo          (optional) A template task to show in the dialog.</span>
<a href="#l1.37"></a><span id="l1.37">  * @param initialDate   (optional) The initial date for new task datepickers</span>
<a href="#l1.38"></a><span id="l1.38">  */</span>
<a href="#l1.39"></a><span id="l1.39"> function createTodoWithDialog(calendar, dueDate, summary, todo, initialDate) {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    let onNewItem = function(item, opcalendar, originalItem, listener) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    let onNewItem = function(item, opcalendar, originalItem, listener, extresponse=null) {</span>
<a href="#l1.42"></a><span id="l1.42">         if (item.id) {</span>
<a href="#l1.43"></a><span id="l1.43">             // If the item already has an id, then this is the result of</span>
<a href="#l1.44"></a><span id="l1.44">             // saving the item without closing, and then saving again.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-            doTransaction(&quot;modify&quot;, item, opcalendar, originalItem, listener);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+            doTransaction(&quot;modify&quot;, item, opcalendar, originalItem, listener, extresponse);</span>
<a href="#l1.47"></a><span id="l1.47">         } else {</span>
<a href="#l1.48"></a><span id="l1.48">             // Otherwise, this is an addition</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-            doTransaction(&quot;add&quot;, item, opcalendar, null, listener);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+            doTransaction(&quot;add&quot;, item, opcalendar, null, listener, extresponse);</span>
<a href="#l1.51"></a><span id="l1.51">         }</span>
<a href="#l1.52"></a><span id="l1.52">     };</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">     if (todo) {</span>
<a href="#l1.55"></a><span id="l1.55">         // If the todo should be created from a template, then make sure to</span>
<a href="#l1.56"></a><span id="l1.56">         // remove the id so that the item obtains a new id when doing the</span>
<a href="#l1.57"></a><span id="l1.57">         // transaction</span>
<a href="#l1.58"></a><span id="l1.58">         if (todo.id) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineat">@@ -343,18 +343,18 @@ function createTodoWithDialog(calendar, </span>
<a href="#l1.60"></a><span id="l1.60"> function modifyEventWithDialog(aItem, job=null, aPromptOccurrence, initialDate=null, aCounterProposal) {</span>
<a href="#l1.61"></a><span id="l1.61">     let dlg = cal.item.findWindow(aItem);</span>
<a href="#l1.62"></a><span id="l1.62">     if (dlg) {</span>
<a href="#l1.63"></a><span id="l1.63">         dlg.focus();</span>
<a href="#l1.64"></a><span id="l1.64">         disposeJob(job);</span>
<a href="#l1.65"></a><span id="l1.65">         return;</span>
<a href="#l1.66"></a><span id="l1.66">     }</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-    let onModifyItem = function(item, calendar, originalItem, listener) {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-        doTransaction(&quot;modify&quot;, item, calendar, originalItem, listener);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    let onModifyItem = function(item, calendar, originalItem, listener, extresponse=null) {</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        doTransaction(&quot;modify&quot;, item, calendar, originalItem, listener, extresponse);</span>
<a href="#l1.72"></a><span id="l1.72">     };</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">     let item = aItem;</span>
<a href="#l1.75"></a><span id="l1.75">     let response;</span>
<a href="#l1.76"></a><span id="l1.76">     if (aPromptOccurrence !== false) {</span>
<a href="#l1.77"></a><span id="l1.77">         [item, , response] = promptOccurrenceModification(aItem, true, &quot;edit&quot;);</span>
<a href="#l1.78"></a><span id="l1.78">     }</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80" class="difflineat">@@ -624,28 +624,31 @@ function getTransactionMgr() {</span>
<a href="#l1.81"></a><span id="l1.81">  * manager. Also updates the undo/redo menu.</span>
<a href="#l1.82"></a><span id="l1.82">  *</span>
<a href="#l1.83"></a><span id="l1.83">  * @see                 calITransactionManager</span>
<a href="#l1.84"></a><span id="l1.84">  * @param aAction       The action to do.</span>
<a href="#l1.85"></a><span id="l1.85">  * @param aItem         The new item to add/modify/delete</span>
<a href="#l1.86"></a><span id="l1.86">  * @param aCalendar     The calendar to do the transaction on</span>
<a href="#l1.87"></a><span id="l1.87">  * @param aOldItem      (optional) some actions require an old item</span>
<a href="#l1.88"></a><span id="l1.88">  * @param aListener     (optional) the listener to call when complete.</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+ * @param aExtResponse  (optional) JS object with additional parameters for sending itip messages</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+ *                                 (see also description of checkAndSend in calItipUtils.jsm)</span>
<a href="#l1.91"></a><span id="l1.91">  */</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-function doTransaction(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+function doTransaction(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse=null) {</span>
<a href="#l1.94"></a><span id="l1.94">     // This is usually a user-initiated transaction, so make sure the calendar</span>
<a href="#l1.95"></a><span id="l1.95">     // this transaction is happening on is visible.</span>
<a href="#l1.96"></a><span id="l1.96">     ensureCalendarVisible(aCalendar);</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98">     // Now use the transaction manager to execute the action</span>
<a href="#l1.99"></a><span id="l1.99">     getTransactionMgr().createAndCommitTxn(aAction,</span>
<a href="#l1.100"></a><span id="l1.100">                                            aItem,</span>
<a href="#l1.101"></a><span id="l1.101">                                            aCalendar,</span>
<a href="#l1.102"></a><span id="l1.102">                                            aOldItem,</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-                                           aListener ? aListener : null);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+                                           aListener ? aListener : null,</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+                                           aExtResponse);</span>
<a href="#l1.106"></a><span id="l1.106">     updateUndoRedoMenu();</span>
<a href="#l1.107"></a><span id="l1.107"> }</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> /**</span>
<a href="#l1.110"></a><span id="l1.110">  * Undo the last operation done through the transaction manager.</span>
<a href="#l1.111"></a><span id="l1.111">  */</span>
<a href="#l1.112"></a><span id="l1.112"> function undo() {</span>
<a href="#l1.113"></a><span id="l1.113">     if (canUndo()) {</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineat">@@ -700,25 +703,37 @@ function canRedo() {</span>
<a href="#l1.115"></a><span id="l1.115"> /**</span>
<a href="#l1.116"></a><span id="l1.116">  * Update the undo and redo commands.</span>
<a href="#l1.117"></a><span id="l1.117">  */</span>
<a href="#l1.118"></a><span id="l1.118"> function updateUndoRedoMenu() {</span>
<a href="#l1.119"></a><span id="l1.119">     goUpdateCommand(&quot;cmd_undo&quot;);</span>
<a href="#l1.120"></a><span id="l1.120">     goUpdateCommand(&quot;cmd_redo&quot;);</span>
<a href="#l1.121"></a><span id="l1.121"> }</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-function setContextPartstat(value, scope, items) {</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+/**</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+ * Updates the partstat of the calendar owner for specified items triggered by a</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+ * ontext menu operation</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+ *</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+ * @param {String}  aPartStat     a valid partstat string as per RfC 5545</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+ * @param {String}  aScope        indicates the scope of anrecurring event - must</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+ *                                  be 'this-occurrence' || 'all-occurences'</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+ * @param {Array}   aItems        an array of calEvent or calIToDo items</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+ * @param {Object}  aExtResponse  [optional] an object to provide additional</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+ *                                  parameters for sending itip messages as response</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+ *                                  response</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+ */</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+function setContextPartstat(aPartStat, aScope, aItems, aExtResponse=null) {</span>
<a href="#l1.137"></a><span id="l1.137">     startBatchTransaction();</span>
<a href="#l1.138"></a><span id="l1.138">     try {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-        for (let oldItem of items) {</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+        for (let oldItem of aItems) {</span>
<a href="#l1.141"></a><span id="l1.141">             // Skip this item if its calendar is read only.</span>
<a href="#l1.142"></a><span id="l1.142">             if (oldItem.calendar.readOnly) {</span>
<a href="#l1.143"></a><span id="l1.143">                 continue;</span>
<a href="#l1.144"></a><span id="l1.144">             }</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-            if (scope == &quot;all-occurrences&quot;) {</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+            if (aScope == &quot;all-occurrences&quot;) {</span>
<a href="#l1.147"></a><span id="l1.147">                 oldItem = oldItem.parentItem;</span>
<a href="#l1.148"></a><span id="l1.148">             }</span>
<a href="#l1.149"></a><span id="l1.149">             let attendee = null;</span>
<a href="#l1.150"></a><span id="l1.150">             if (cal.isInvitation(oldItem)) {</span>
<a href="#l1.151"></a><span id="l1.151">                 // Check for the invited attendee first, this is more important</span>
<a href="#l1.152"></a><span id="l1.152">                 attendee = cal.getInvitedAttendee(oldItem);</span>
<a href="#l1.153"></a><span id="l1.153">             } else if (oldItem.organizer &amp;&amp; oldItem.getAttendees({}).length) {</span>
<a href="#l1.154"></a><span id="l1.154">                 // Now check the organizer. This should be done last.</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineat">@@ -727,25 +742,25 @@ function setContextPartstat(value, scope</span>
<a href="#l1.156"></a><span id="l1.156">                     attendee = oldItem.organizer;</span>
<a href="#l1.157"></a><span id="l1.157">                 }</span>
<a href="#l1.158"></a><span id="l1.158">             }</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160">             if (attendee) {</span>
<a href="#l1.161"></a><span id="l1.161">                 let newItem = oldItem.clone();</span>
<a href="#l1.162"></a><span id="l1.162">                 let newAttendee = attendee.clone();</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-                newAttendee.participationStatus = value;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+                newAttendee.participationStatus = aPartStat;</span>
<a href="#l1.166"></a><span id="l1.166">                 if (newAttendee.isOrganizer) {</span>
<a href="#l1.167"></a><span id="l1.167">                     newItem.organizer = newAttendee;</span>
<a href="#l1.168"></a><span id="l1.168">                 } else {</span>
<a href="#l1.169"></a><span id="l1.169">                     newItem.removeAttendee(attendee);</span>
<a href="#l1.170"></a><span id="l1.170">                     newItem.addAttendee(newAttendee);</span>
<a href="#l1.171"></a><span id="l1.171">                 }</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-                doTransaction(&quot;modify&quot;, newItem, newItem.calendar, oldItem, null);</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+                doTransaction(&quot;modify&quot;, newItem, newItem.calendar, oldItem, null, aExtResponse);</span>
<a href="#l1.175"></a><span id="l1.175">             }</span>
<a href="#l1.176"></a><span id="l1.176">         }</span>
<a href="#l1.177"></a><span id="l1.177">     } catch (e) {</span>
<a href="#l1.178"></a><span id="l1.178">         cal.ERROR(&quot;Error setting partstat: &quot; + e);</span>
<a href="#l1.179"></a><span id="l1.179">     } finally {</span>
<a href="#l1.180"></a><span id="l1.180">         endBatchTransaction();</span>
<a href="#l1.181"></a><span id="l1.181">     }</span>
<a href="#l1.182"></a><span id="l1.182"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -629,18 +629,29 @@ cal.itip = {</span>
<a href="#l2.4"></a><span id="l2.4">         }</span>
<a href="#l2.5"></a><span id="l2.5">     },</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">     /**</span>
<a href="#l2.8"></a><span id="l2.8">      * Scope: iTIP message sender</span>
<a href="#l2.9"></a><span id="l2.9">      *</span>
<a href="#l2.10"></a><span id="l2.10">      * Checks to see if e.g. attendees were added/removed or an item has been</span>
<a href="#l2.11"></a><span id="l2.11">      * deleted and sends out appropriate iTIP messages.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+     * @param {Number}             aOpType        Type of operation - (e.g. ADD, MODIFY or DELETE)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+     * @param {calIEvent|calITodo} aItem          The updated item</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+     * @param {calIEvent|calITodo} aOriginalItem  The original item</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+     * @param {Object}             aExtResponse   [optional] An object to provide additional</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+     *                                            parameters for sending itip messages as response</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+     *                                            mode, comments or a subset of recipients. Currently</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+     *                                            implemented attributes are:</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+     *                             * responseMode Response mode (long) as defined for autoResponse</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+     *                                            of calIItipItem. The default mode is USER (which</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+     *                                            will trigger displaying the previously known popup</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+     *                                            to ask the user whether to send)</span>
<a href="#l2.23"></a><span id="l2.23">      */</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    checkAndSend: function(aOpType, aItem, aOriginalItem) {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    checkAndSend: function(aOpType, aItem, aOriginalItem, aExtResponse=null) {</span>
<a href="#l2.26"></a><span id="l2.26">         // balance out parts of the modification vs delete confusion, deletion of occurrences</span>
<a href="#l2.27"></a><span id="l2.27">         // are notified as parent modifications and modifications of occurrences are notified</span>
<a href="#l2.28"></a><span id="l2.28">         // as mixed new-occurrence, old-parent (IIRC).</span>
<a href="#l2.29"></a><span id="l2.29">         if (aOriginalItem &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l2.30"></a><span id="l2.30">             if (aOriginalItem.recurrenceId &amp;&amp; !aItem.recurrenceId) {</span>
<a href="#l2.31"></a><span id="l2.31">                 // sanity check: assure aItem doesn't refer to the master</span>
<a href="#l2.32"></a><span id="l2.32">                 aItem = aItem.recurrenceInfo.getOccurrenceFor(aOriginalItem.recurrenceId);</span>
<a href="#l2.33"></a><span id="l2.33">                 cal.ASSERT(aItem, &quot;unexpected!&quot;);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineat">@@ -674,18 +685,40 @@ cal.itip = {</span>
<a href="#l2.35"></a><span id="l2.35">                         // xxx todo: support multiple</span>
<a href="#l2.36"></a><span id="l2.36">                         aItem = aOriginalItem.recurrenceInfo.getOccurrenceFor(exdates[0].date);</span>
<a href="#l2.37"></a><span id="l2.37">                         aOriginalItem = null;</span>
<a href="#l2.38"></a><span id="l2.38">                         aOpType = Components.interfaces.calIOperationListener.DELETE;</span>
<a href="#l2.39"></a><span id="l2.39">                     }</span>
<a href="#l2.40"></a><span id="l2.40">                 }</span>
<a href="#l2.41"></a><span id="l2.41">             }</span>
<a href="#l2.42"></a><span id="l2.42">         }</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-        let autoResponse = { value: false }; // controls confirm to send email only once</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+        // for backward compatibility, we assume USER mode if not set otherwise</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        let autoResponse = { mode: Ci.calIItipItem.USER };</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        if (aExtResponse &amp;&amp; aExtResponse.hasOwnProperty(&quot;responseMode&quot;)) {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+            switch (aExtResponse.responseMode) {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+                case Ci.calIItipItem.AUTO:</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+                case Ci.calIItipItem.NONE:</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                case Ci.calIItipItem.USER:</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+                    autoResponse.mode = aExtResponse.responseMode;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+                    break;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+                default:</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+                    cal.ERROR(&quot;cal.itip.checkAndSend(): Invalid value &quot; + aExtResponse.responseMode +</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                              &quot; provided for responseMode attribute in argument aExtResponse.&quot; +</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+                              &quot; Falling back to USER mode.\r\n&quot; + cal.STACK(20));</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+            }</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+        } else {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+            // let's log something useful to notify addon developers or find any missing pieces in</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+            // the conversions</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+            cal.LOG(&quot;cal.itip.checkAndSend: no response mode provided, &quot; +</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+                    &quot;falling back to USER mode.\r\n&quot; + cal.STACK(20));</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+        }</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+        if (autoResponse.mode == Ci.calIItipItem.NONE) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+            // we stop here and don't send anything if the user opted out before</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+            return;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        }</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">         let invitedAttendee = cal.isInvitation(aItem) &amp;&amp; cal.getInvitedAttendee(aItem);</span>
<a href="#l2.71"></a><span id="l2.71">         if (invitedAttendee) { // actually is an invitation copy, fix attendee list to send REPLY</span>
<a href="#l2.72"></a><span id="l2.72">             /* We check if the attendee id matches one of of the</span>
<a href="#l2.73"></a><span id="l2.73">              * userAddresses. If they aren't equal, it means that</span>
<a href="#l2.74"></a><span id="l2.74">              * someone is accepting invitations on behalf of an other user. */</span>
<a href="#l2.75"></a><span id="l2.75">             if (aItem.calendar.aclEntry) {</span>
<a href="#l2.76"></a><span id="l2.76">                 let userAddresses = aItem.calendar.aclEntry.getUserAddresses({});</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineat">@@ -949,20 +982,20 @@ cal.itip = {</span>
<a href="#l2.78"></a><span id="l2.78">         itipItem.targetCalendar = (&quot;targetCalendar&quot; in aProps) ? aProps.targetCalendar : aItipItem.targetCalendar;</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">         return itipItem;</span>
<a href="#l2.81"></a><span id="l2.81">     },</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83">     /**</span>
<a href="#l2.84"></a><span id="l2.84">      * A shortcut to send DECLINECOUNTER messages - for everything else use cal.itip.checkAndSend</span>
<a href="#l2.85"></a><span id="l2.85">      *</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-     * @param aItem iTIP item to be sent</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-     * @param aMethod iTIP method</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-     * @param aRecipientsList an array of calIAttendee objects the message should be sent to</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-     * @param aAutoResponse an inout object whether the transport should ask before sending</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+     * @param {calIItipItem} aItem            item to be sent</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+     * @param {String}       aMethod          iTIP method</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+     * @param {Array}        aRecipientsList  array of calIAttendee objects the message should be sent to</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+     * @param {Object}       aAutoResponse    JS object whether the transport should ask before sending</span>
<a href="#l2.94"></a><span id="l2.94">      */</span>
<a href="#l2.95"></a><span id="l2.95">     sendDeclineCounterMessage: function(aItem, aMethod, aRecipientsList, aAutoResponse) {</span>
<a href="#l2.96"></a><span id="l2.96">         if (aMethod == &quot;DECLINECOUNTER&quot;) {</span>
<a href="#l2.97"></a><span id="l2.97">             return sendMessage(aItem, aMethod, aRecipientsList, aAutoResponse);</span>
<a href="#l2.98"></a><span id="l2.98">         }</span>
<a href="#l2.99"></a><span id="l2.99">         return false;</span>
<a href="#l2.100"></a><span id="l2.100">     }</span>
<a href="#l2.101"></a><span id="l2.101"> };</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineat">@@ -1137,27 +1170,25 @@ function sendMessage(aItem, aMethod, aRe</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104">     let transport = aItem.calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l2.105"></a><span id="l2.105">     if (!transport) { // can only send if there's a transport for the calendar</span>
<a href="#l2.106"></a><span id="l2.106">         return false;</span>
<a href="#l2.107"></a><span id="l2.107">     }</span>
<a href="#l2.108"></a><span id="l2.108">     transport = transport.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110">     let _sendItem = function(aSendToList, aSendItem) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-        let cIII = Components.interfaces.calIItipItem;</span>
<a href="#l2.112"></a><span id="l2.112">         let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-                                 .createInstance(cIII);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+                                 .createInstance(Ci.calIItipItem);</span>
<a href="#l2.115"></a><span id="l2.115">         itipItem.init(cal.item.serialize(aSendItem));</span>
<a href="#l2.116"></a><span id="l2.116">         itipItem.responseMethod = aMethod;</span>
<a href="#l2.117"></a><span id="l2.117">         itipItem.targetCalendar = aSendItem.calendar;</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-        itipItem.autoResponse = autoResponse &amp;&amp; autoResponse.value ? cIII.AUTO : cIII.USER;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-        if (autoResponse) {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-            autoResponse.value = true; // auto every following</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-        }</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-        // XXX I don't know whether the below are used at all, since we don't use the itip processor</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+        itipItem.autoResponse = autoResponse.mode;</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+        // we switch to AUTO for each subsequent call of _sendItem()</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+        autoResponse.mode = Ci.calIItipItem.AUTO;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+        // XXX I don't know whether the below is used at all, since we don't use the itip processor</span>
<a href="#l2.127"></a><span id="l2.127">         itipItem.isSend = true;</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129">         return transport.sendItems(aSendToList.length, aSendToList, itipItem);</span>
<a href="#l2.130"></a><span id="l2.130">     };</span>
<a href="#l2.131"></a><span id="l2.131"> </span>
<a href="#l2.132"></a><span id="l2.132">     // split up transport, if attendee undisclosure is requested</span>
<a href="#l2.133"></a><span id="l2.133">     // and this is a message send by the organizer</span>
<a href="#l2.134"></a><span id="l2.134">     if (aItem.getProperty(&quot;X-MOZ-SEND-INVITATIONS-UNDISCLOSED&quot;) == &quot;TRUE&quot; &amp;&amp;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineat">@@ -1184,26 +1215,32 @@ function sendMessage(aItem, aMethod, aRe</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137"> /** local to this module file</span>
<a href="#l2.138"></a><span id="l2.138">  * An operation listener that is used on calendar operations which checks and sends further iTIP</span>
<a href="#l2.139"></a><span id="l2.139">  * messages based on the calendar action.</span>
<a href="#l2.140"></a><span id="l2.140">  *</span>
<a href="#l2.141"></a><span id="l2.141">  * @param opListener operation listener to forward</span>
<a href="#l2.142"></a><span id="l2.142">  * @param oldItem the previous item before modification (if any)</span>
<a href="#l2.143"></a><span id="l2.143">  */</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-function ItipOpListener(opListener, oldItem) {</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    this.mOpListener = opListener;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    this.mOldItem = oldItem;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+function ItipOpListener(aOpListener, aOldItem, aExtResponse=null) {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    this.mOpListener = aOpListener;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+    this.mOldItem = aOldItem;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    this.mExtResponse = aExtResponse;</span>
<a href="#l2.151"></a><span id="l2.151"> }</span>
<a href="#l2.152"></a><span id="l2.152"> ItipOpListener.prototype = {</span>
<a href="#l2.153"></a><span id="l2.153">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    mOpListener: null,</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+    mOldItem: null,</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+    mExtResponse: null,</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+</span>
<a href="#l2.159"></a><span id="l2.159">     onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l2.160"></a><span id="l2.160">         cal.ASSERT(Components.isSuccessCode(aStatus), &quot;error on iTIP processing&quot;);</span>
<a href="#l2.161"></a><span id="l2.161">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-            cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem);</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+            cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem, this.mExtResponse);</span>
<a href="#l2.164"></a><span id="l2.164">         }</span>
<a href="#l2.165"></a><span id="l2.165">         if (this.mOpListener) {</span>
<a href="#l2.166"></a><span id="l2.166">             this.mOpListener.onOperationComplete(aCalendar,</span>
<a href="#l2.167"></a><span id="l2.167">                                                  aStatus,</span>
<a href="#l2.168"></a><span id="l2.168">                                                  aOperationType,</span>
<a href="#l2.169"></a><span id="l2.169">                                                  aId,</span>
<a href="#l2.170"></a><span id="l2.170">                                                  aDetail);</span>
<a href="#l2.171"></a><span id="l2.171">         }</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineat">@@ -1402,37 +1439,42 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.173"></a><span id="l2.173">                             }</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175">                             switch (method) {</span>
<a href="#l2.176"></a><span id="l2.176">                                 case &quot;REFRESH&quot;: { // xxx todo test</span>
<a href="#l2.177"></a><span id="l2.177">                                     let attendees = itipItemItem.getAttendees({});</span>
<a href="#l2.178"></a><span id="l2.178">                                     cal.ASSERT(attendees.length == 1,</span>
<a href="#l2.179"></a><span id="l2.179">                                                &quot;invalid number of attendees in REFRESH!&quot;);</span>
<a href="#l2.180"></a><span id="l2.180">                                     if (attendees.length &gt; 0) {</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-                                        let action = function(opListener) {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+                                        let action = function(opListener, partStat, extResponse) {</span>
<a href="#l2.183"></a><span id="l2.183">                                             if (!item.organizer) {</span>
<a href="#l2.184"></a><span id="l2.184">                                                 let org = createOrganizer(item.calendar);</span>
<a href="#l2.185"></a><span id="l2.185">                                                 if (org) {</span>
<a href="#l2.186"></a><span id="l2.186">                                                     item = item.clone();</span>
<a href="#l2.187"></a><span id="l2.187">                                                     item.organizer = org;</span>
<a href="#l2.188"></a><span id="l2.188">                                                 }</span>
<a href="#l2.189"></a><span id="l2.189">                                             }</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-                                            sendMessage(item, &quot;REQUEST&quot;, attendees, true /* don't ask */);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+                                            sendMessage(</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+                                                item,</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+                                                &quot;REQUEST&quot;,</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+                                                attendees,</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+                                                { responseMode: Ci.calIItipItem.AUTO } /* don't ask */</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+                                            );</span>
<a href="#l2.197"></a><span id="l2.197">                                         };</span>
<a href="#l2.198"></a><span id="l2.198">                                         operations.push(action);</span>
<a href="#l2.199"></a><span id="l2.199">                                     }</span>
<a href="#l2.200"></a><span id="l2.200">                                     break;</span>
<a href="#l2.201"></a><span id="l2.201">                                 }</span>
<a href="#l2.202"></a><span id="l2.202">                                 case &quot;PUBLISH&quot;:</span>
<a href="#l2.203"></a><span id="l2.203">                                     cal.ASSERT(itipItemItem.getAttendees({}).length == 0,</span>
<a href="#l2.204"></a><span id="l2.204">                                                &quot;invalid number of attendees in PUBLISH!&quot;);</span>
<a href="#l2.205"></a><span id="l2.205">                                     if (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l2.206"></a><span id="l2.206">                                         cal.itip.compare(itipItemItem, item) &gt; 0) {</span>
<a href="#l2.207"></a><span id="l2.207">                                         let newItem = updateItem(item, itipItemItem);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-                                        let action = function(opListener) {</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+                                        let action = function(opListener, partStat, extResponse) {</span>
<a href="#l2.210"></a><span id="l2.210">                                             return newItem.calendar.modifyItem(newItem, item, opListener);</span>
<a href="#l2.211"></a><span id="l2.211">                                         };</span>
<a href="#l2.212"></a><span id="l2.212">                                         actionMethod = method + &quot;:UPDATE&quot;;</span>
<a href="#l2.213"></a><span id="l2.213">                                         operations.push(action);</span>
<a href="#l2.214"></a><span id="l2.214">                                     }</span>
<a href="#l2.215"></a><span id="l2.215">                                     break;</span>
<a href="#l2.216"></a><span id="l2.216">                                 case &quot;REQUEST&quot;: {</span>
<a href="#l2.217"></a><span id="l2.217">                                     let newItem = updateItem(item, itipItemItem);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineat">@@ -1452,47 +1494,47 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.219"></a><span id="l2.219">                                         // are viewing the current representation of the item, show the</span>
<a href="#l2.220"></a><span id="l2.220">                                         // accept/decline buttons. This means newer events will show the</span>
<a href="#l2.221"></a><span id="l2.221">                                         // &quot;Update&quot; button and older events will show the &quot;already</span>
<a href="#l2.222"></a><span id="l2.222">                                         // processed&quot; text.</span>
<a href="#l2.223"></a><span id="l2.223">                                         if (foundAttendee.participationStatus == &quot;NEEDS-ACTION&quot; &amp;&amp;</span>
<a href="#l2.224"></a><span id="l2.224">                                             (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l2.225"></a><span id="l2.225">                                              cal.itip.compare(itipItemItem, item) == 0)) {</span>
<a href="#l2.226"></a><span id="l2.226">                                             actionMethod = &quot;REQUEST:NEEDS-ACTION&quot;;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-                                            operations.push((opListener, partStat) =&gt; {</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+                                            operations.push((opListener, partStat, extResponse) =&gt; {</span>
<a href="#l2.229"></a><span id="l2.229">                                                 let changedItem = firstFoundItem.clone();</span>
<a href="#l2.230"></a><span id="l2.230">                                                 changedItem.removeAttendee(foundAttendee);</span>
<a href="#l2.231"></a><span id="l2.231">                                                 foundAttendee = foundAttendee.clone();</span>
<a href="#l2.232"></a><span id="l2.232">                                                 if (partStat) {</span>
<a href="#l2.233"></a><span id="l2.233">                                                     foundAttendee.participationStatus = partStat;</span>
<a href="#l2.234"></a><span id="l2.234">                                                 }</span>
<a href="#l2.235"></a><span id="l2.235">                                                 changedItem.addAttendee(foundAttendee);</span>
<a href="#l2.236"></a><span id="l2.236"> </span>
<a href="#l2.237"></a><span id="l2.237">                                                 return changedItem.calendar.modifyItem(</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-                                                    changedItem, firstFoundItem, new ItipOpListener(opListener, firstFoundItem));</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+                                                    changedItem, firstFoundItem, new ItipOpListener(opListener, firstFoundItem, extResponse));</span>
<a href="#l2.240"></a><span id="l2.240">                                             });</span>
<a href="#l2.241"></a><span id="l2.241">                                         } else if (item.calendar.getProperty(&quot;itip.disableRevisionChecks&quot;) ||</span>
<a href="#l2.242"></a><span id="l2.242">                                                    cal.itip.compare(itipItemItem, item) &gt; 0) {</span>
<a href="#l2.243"></a><span id="l2.243">                                             addScheduleAgentClient(newItem, item.calendar);</span>
<a href="#l2.244"></a><span id="l2.244"> </span>
<a href="#l2.245"></a><span id="l2.245">                                             let isMinorUpdate = cal.itip.getSequence(newItem) ==</span>
<a href="#l2.246"></a><span id="l2.246">                                                                 cal.itip.getSequence(item);</span>
<a href="#l2.247"></a><span id="l2.247">                                             actionMethod = (isMinorUpdate ? method + &quot;:UPDATE-MINOR&quot;</span>
<a href="#l2.248"></a><span id="l2.248">                                                                           : method + &quot;:UPDATE&quot;);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-                                            operations.push((opListener, partStat) =&gt; {</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+                                            operations.push((opListener, partStat, extResponse) =&gt; {</span>
<a href="#l2.251"></a><span id="l2.251">                                                 if (!partStat) { // keep PARTSTAT</span>
<a href="#l2.252"></a><span id="l2.252">                                                     let att_ = cal.getInvitedAttendee(item);</span>
<a href="#l2.253"></a><span id="l2.253">                                                     partStat = att_ ? att_.participationStatus : &quot;NEEDS-ACTION&quot;;</span>
<a href="#l2.254"></a><span id="l2.254">                                                 }</span>
<a href="#l2.255"></a><span id="l2.255">                                                 newItem.removeAttendee(att);</span>
<a href="#l2.256"></a><span id="l2.256">                                                 att = att.clone();</span>
<a href="#l2.257"></a><span id="l2.257">                                                 att.participationStatus = partStat;</span>
<a href="#l2.258"></a><span id="l2.258">                                                 newItem.addAttendee(att);</span>
<a href="#l2.259"></a><span id="l2.259">                                                 return newItem.calendar.modifyItem(</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-                                                    newItem, item, new ItipOpListener(opListener, item));</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+                                                    newItem, item, new ItipOpListener(opListener, item, extResponse));</span>
<a href="#l2.262"></a><span id="l2.262">                                             });</span>
<a href="#l2.263"></a><span id="l2.263">                                         }</span>
<a href="#l2.264"></a><span id="l2.264">                                     }</span>
<a href="#l2.265"></a><span id="l2.265">                                     break;</span>
<a href="#l2.266"></a><span id="l2.266">                                 }</span>
<a href="#l2.267"></a><span id="l2.267">                                 case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l2.268"></a><span id="l2.268">                                     // nothing to do right now, but once countering is implemented,</span>
<a href="#l2.269"></a><span id="l2.269">                                     // we probably need some action here to remove the proposal from</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineat">@@ -1541,26 +1583,26 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.271"></a><span id="l2.271">                                         let newPS = itipItemItem.getAttendeeById(replyer.id)</span>
<a href="#l2.272"></a><span id="l2.272">                                                                 .participationStatus;</span>
<a href="#l2.273"></a><span id="l2.273">                                         replyer.participationStatus = newPS;</span>
<a href="#l2.274"></a><span id="l2.274">                                         newItem.addAttendee(replyer);</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">                                         // Make sure the provider-specified properties are copied over</span>
<a href="#l2.277"></a><span id="l2.277">                                         copyProviderProperties(this.mItipItem, itipItemItem, newItem);</span>
<a href="#l2.278"></a><span id="l2.278"> </span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-                                        let action = function(opListener) {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+                                        let action = function(opListener, partStat, extResponse) {</span>
<a href="#l2.281"></a><span id="l2.281">                                             // n.b.: this will only be processed in case of reply or</span>
<a href="#l2.282"></a><span id="l2.282">                                             // declining the counter request - of sending the</span>
<a href="#l2.283"></a><span id="l2.283">                                             // appropriate reply will be taken care within the</span>
<a href="#l2.284"></a><span id="l2.284">                                             // opListener (defined in imip-bar.js)</span>
<a href="#l2.285"></a><span id="l2.285">                                             // TODO: move that from imip-bar.js to here</span>
<a href="#l2.286"></a><span id="l2.286">                                             return newItem.calendar.modifyItem(</span>
<a href="#l2.287"></a><span id="l2.287">                                                 newItem, item,</span>
<a href="#l2.288"></a><span id="l2.288">                                                 newItem.calendar.getProperty(&quot;itip.notify-replies&quot;)</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-                                                ? new ItipOpListener(opListener, item)</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+                                                ? new ItipOpListener(opListener, item, extResponse)</span>
<a href="#l2.291"></a><span id="l2.291">                                                 : opListener);</span>
<a href="#l2.292"></a><span id="l2.292">                                         };</span>
<a href="#l2.293"></a><span id="l2.293">                                         operations.push(action);</span>
<a href="#l2.294"></a><span id="l2.294">                                     }</span>
<a href="#l2.295"></a><span id="l2.295">                                     break;</span>
<a href="#l2.296"></a><span id="l2.296">                                 }</span>
<a href="#l2.297"></a><span id="l2.297">                             }</span>
<a href="#l2.298"></a><span id="l2.298">                         }</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineat">@@ -1577,25 +1619,31 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.300"></a><span id="l2.300">                                     let newItem = modifiedItems[item.id];</span>
<a href="#l2.301"></a><span id="l2.301">                                     if (!newItem) {</span>
<a href="#l2.302"></a><span id="l2.302">                                         newItem = item.clone();</span>
<a href="#l2.303"></a><span id="l2.303">                                         modifiedItems[item.id] = newItem;</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305">                                         // Make sure the provider-specified properties are copied over</span>
<a href="#l2.306"></a><span id="l2.306">                                         copyProviderProperties(this.mItipItem, itipItemItem, newItem);</span>
<a href="#l2.307"></a><span id="l2.307"> </span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-                                        operations.push(opListener =&gt; newItem.calendar.modifyItem(newItem, item, opListener));</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+                                        operations.push((opListener, partStat, extResponse) =&gt;</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+                                            newItem.calendar.modifyItem(newItem, item, opListener)</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+                                        );</span>
<a href="#l2.312"></a><span id="l2.312">                                     }</span>
<a href="#l2.313"></a><span id="l2.313">                                     newItem.recurrenceInfo.removeOccurrenceAt(rid);</span>
<a href="#l2.314"></a><span id="l2.314">                                 } else if (item.recurrenceId &amp;&amp; (item.recurrenceId.compare(rid) == 0)) {</span>
<a href="#l2.315"></a><span id="l2.315">                                     // parentless occurrence to be deleted (future)</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-                                    operations.push(opListener =&gt; item.calendar.deleteItem(item, opListener));</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+                                    operations.push((opListener, partStat, extResponse) =&gt;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+                                        item.calendar.deleteItem(item, opListener)</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+                                    );</span>
<a href="#l2.320"></a><span id="l2.320">                                 }</span>
<a href="#l2.321"></a><span id="l2.321">                             } else {</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-                                operations.push(opListener =&gt; item.calendar.deleteItem(item, opListener));</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+                                operations.push((opListener, partStat, extResponse) =&gt;</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+                                    item.calendar.deleteItem(item, opListener)</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+                                );</span>
<a href="#l2.326"></a><span id="l2.326">                             }</span>
<a href="#l2.327"></a><span id="l2.327">                         }</span>
<a href="#l2.328"></a><span id="l2.328">                     }</span>
<a href="#l2.329"></a><span id="l2.329">                     break;</span>
<a href="#l2.330"></a><span id="l2.330">                 }</span>
<a href="#l2.331"></a><span id="l2.331">                 default:</span>
<a href="#l2.332"></a><span id="l2.332">                     rc = Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.333"></a><span id="l2.333">                     break;</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineat">@@ -1607,17 +1655,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.335"></a><span id="l2.335">             // It will likely be the composite calendar, so we should update</span>
<a href="#l2.336"></a><span id="l2.336">             // if an item was added or removed</span>
<a href="#l2.337"></a><span id="l2.337">             this._observeChanges(this.mItipItem.targetCalendar);</span>
<a href="#l2.338"></a><span id="l2.338"> </span>
<a href="#l2.339"></a><span id="l2.339">             for (let itipItemItem of this.mItipItem.getItemList({})) {</span>
<a href="#l2.340"></a><span id="l2.340">                 switch (method) {</span>
<a href="#l2.341"></a><span id="l2.341">                     case &quot;REQUEST&quot;:</span>
<a href="#l2.342"></a><span id="l2.342">                     case &quot;PUBLISH&quot;: {</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-                        let action = (opListener, partStat) =&gt; {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+                        let action = (opListener, partStat, extResponse) =&gt; {</span>
<a href="#l2.345"></a><span id="l2.345">                             let newItem = itipItemItem.clone();</span>
<a href="#l2.346"></a><span id="l2.346">                             setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l2.347"></a><span id="l2.347">                             newItem.parentItem.calendar = this.mItipItem.targetCalendar;</span>
<a href="#l2.348"></a><span id="l2.348">                             addScheduleAgentClient(newItem, this.mItipItem.targetCalendar);</span>
<a href="#l2.349"></a><span id="l2.349">                             if (partStat) {</span>
<a href="#l2.350"></a><span id="l2.350">                                 if (partStat != &quot;DECLINED&quot;) {</span>
<a href="#l2.351"></a><span id="l2.351">                                     cal.alarms.setDefaultValues(newItem);</span>
<a href="#l2.352"></a><span id="l2.352">                                 }</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineat">@@ -1636,17 +1684,17 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.354"></a><span id="l2.354">                                     return null;</span>
<a href="#l2.355"></a><span id="l2.355">                                 }</span>
<a href="#l2.356"></a><span id="l2.356">                             } else {</span>
<a href="#l2.357"></a><span id="l2.357">                                 cal.ASSERT(itipItemItem.getAttendees({}).length == 0,</span>
<a href="#l2.358"></a><span id="l2.358">                                            &quot;invalid number of attendees in PUBLISH!&quot;);</span>
<a href="#l2.359"></a><span id="l2.359">                             }</span>
<a href="#l2.360"></a><span id="l2.360">                             return newItem.calendar.addItem(newItem,</span>
<a href="#l2.361"></a><span id="l2.361">                                                             method == &quot;REQUEST&quot;</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-                                                            ? new ItipOpListener(opListener, null)</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+                                                            ? new ItipOpListener(opListener, null, extResponse)</span>
<a href="#l2.364"></a><span id="l2.364">                                                             : opListener);</span>
<a href="#l2.365"></a><span id="l2.365">                         };</span>
<a href="#l2.366"></a><span id="l2.366">                         operations.push(action);</span>
<a href="#l2.367"></a><span id="l2.367">                         break;</span>
<a href="#l2.368"></a><span id="l2.368">                     }</span>
<a href="#l2.369"></a><span id="l2.369">                     case &quot;CANCEL&quot;: // has already been processed</span>
<a href="#l2.370"></a><span id="l2.370">                     case &quot;REPLY&quot;: // item has been previously removed from the calendar</span>
<a href="#l2.371"></a><span id="l2.371">                     case &quot;COUNTER&quot;: // the item has been previously removed form the calendar</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineat">@@ -1656,20 +1704,20 @@ ItipItemFinder.prototype = {</span>
<a href="#l2.373"></a><span id="l2.373">                         break;</span>
<a href="#l2.374"></a><span id="l2.374">                 }</span>
<a href="#l2.375"></a><span id="l2.375">             }</span>
<a href="#l2.376"></a><span id="l2.376">         }</span>
<a href="#l2.377"></a><span id="l2.377"> </span>
<a href="#l2.378"></a><span id="l2.378">         cal.LOG(&quot;iTIP operations: &quot; + operations.length);</span>
<a href="#l2.379"></a><span id="l2.379">         let actionFunc = null;</span>
<a href="#l2.380"></a><span id="l2.380">         if (operations.length &gt; 0) {</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-            actionFunc = function(opListener, partStat) {</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+            actionFunc = function(opListener, partStat=null, extResponse=null) {</span>
<a href="#l2.383"></a><span id="l2.383">                 for (let operation of operations) {</span>
<a href="#l2.384"></a><span id="l2.384">                     try {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-                        operation(opListener, partStat);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+                        operation(opListener, partStat, extResponse);</span>
<a href="#l2.387"></a><span id="l2.387">                     } catch (exc) {</span>
<a href="#l2.388"></a><span id="l2.388">                         cal.ERROR(exc);</span>
<a href="#l2.389"></a><span id="l2.389">                     }</span>
<a href="#l2.390"></a><span id="l2.390">                 }</span>
<a href="#l2.391"></a><span id="l2.391">             };</span>
<a href="#l2.392"></a><span id="l2.392">             actionFunc.method = actionMethod;</span>
<a href="#l2.393"></a><span id="l2.393">         }</span>
<a href="#l2.394"></a><span id="l2.394"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/public/calITransactionManager.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/public/calITransactionManager.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -9,41 +9,45 @@ interface calICalendar;</span>
<a href="#l3.4"></a><span id="l3.4"> interface calIItemBase;</span>
<a href="#l3.5"></a><span id="l3.5"> interface calIOperationListener;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> /**</span>
<a href="#l3.8"></a><span id="l3.8">  * calITransactionManager is a service designed to handle nsITransactions</span>
<a href="#l3.9"></a><span id="l3.9">  * regarding the calendar.  It is here as a service so that we can keep the</span>
<a href="#l3.10"></a><span id="l3.10">  * transactions around without holding onto the whole global js scope+window.</span>
<a href="#l3.11"></a><span id="l3.11">  */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(40a1ccf4-5f54-4815-b842-abf06f84dbfd)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(1d529847-d292-4222-b066-b8b17a794d62)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface calITransactionManager : nsISupports</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">     /**</span>
<a href="#l3.17"></a><span id="l3.17">      * @param aAction       The Action to execute. This can be one of:</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-     *                        add     Adds an item</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-     *                        modify  Modfifies an item</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-     *                        delete  Deletes an item</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-     *                        move    Move an item from one calendar to the</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+     *                      * add     Adds an item</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+     *                      * modify  Modfifies an item</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+     *                      * delete  Deletes an item</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+     *                      * move    Move an item from one calendar to the</span>
<a href="#l3.26"></a><span id="l3.26">      *                                next. With this operation, aCalendar is</span>
<a href="#l3.27"></a><span id="l3.27">      *                                the calendar that the event should be</span>
<a href="#l3.28"></a><span id="l3.28">      *                                moved to.</span>
<a href="#l3.29"></a><span id="l3.29">      * @param aCalendar     The Calendar to execute the transaction on</span>
<a href="#l3.30"></a><span id="l3.30">      * @param aItem         The changed item for this transaction. This item </span>
<a href="#l3.31"></a><span id="l3.31">      *                      should be immutable</span>
<a href="#l3.32"></a><span id="l3.32">      * @param aOldItem      The Item in its original form. Only needed for </span>
<a href="#l3.33"></a><span id="l3.33">      *                      modify.</span>
<a href="#l3.34"></a><span id="l3.34">      * @param aListener     The listener to call when the transaction has</span>
<a href="#l3.35"></a><span id="l3.35">      *                      completed. This parameter can be null.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+     * @param aExtResponse  JS object to provide additional parameters to prepare an itip message.</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+                            Valid attributes are:</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+     *                      * responseMode  A value as defined for calIItipItem.autoResponse</span>
<a href="#l3.39"></a><span id="l3.39">      */</span>
<a href="#l3.40"></a><span id="l3.40">     void createAndCommitTxn(in AUTF8String aAction,</span>
<a href="#l3.41"></a><span id="l3.41">                             in calIItemBase aItem,</span>
<a href="#l3.42"></a><span id="l3.42">                             in calICalendar aCalendar,</span>
<a href="#l3.43"></a><span id="l3.43">                             in calIItemBase aOldItem,</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-                            in calIOperationListener aListener);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+                            in calIOperationListener aListener,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+                            in jsval aExtResponse);</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">     /**</span>
<a href="#l3.49"></a><span id="l3.49">      * Signals the transaction manager that a series of transactions are going</span>
<a href="#l3.50"></a><span id="l3.50">      * to be performed, but that, for the purposes of undo and redo, they should</span>
<a href="#l3.51"></a><span id="l3.51">      * all be regarded as a single transaction. See also</span>
<a href="#l3.52"></a><span id="l3.52">      * nsITransactionManager::beginBatch</span>
<a href="#l3.53"></a><span id="l3.53">      */</span>
<a href="#l3.54"></a><span id="l3.54">     void beginBatch();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/src/calItemModule.manifest</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/src/calItemModule.manifest</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -60,16 +60,16 @@ contract @mozilla.org/calendar/relation;</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> component {2547331f-34c0-4a4b-b93c-b503538ba6d6} calItemModule.js</span>
<a href="#l4.6"></a><span id="l4.6"> contract @mozilla.org/calendar/startup-service;1 {2547331f-34c0-4a4b-b93c-b503538ba6d6}</span>
<a href="#l4.7"></a><span id="l4.7"> category profile-after-change calendar-startup-service @mozilla.org/calendar/startup-service;1</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> component {fcb54c82-2fb9-42cb-bf44-1e197a55e520} calItemModule.js</span>
<a href="#l4.10"></a><span id="l4.10"> contract @mozilla.org/calendar/transaction;1 {fcb54c82-2fb9-42cb-bf44-1e197a55e520}</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-component {40a1ccf4-5f54-4815-b842-abf06f84dbfd} calItemModule.js</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-contract @mozilla.org/calendar/transactionmanager;1 {40a1ccf4-5f54-4815-b842-abf06f84dbfd}</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+component {1d529847-d292-4222-b066-b8b17a794d62} calItemModule.js</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+contract @mozilla.org/calendar/transactionmanager;1 {1d529847-d292-4222-b066-b8b17a794d62}</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> component {7af51168-6abe-4a31-984d-6f8a3989212d} calItemModule.js</span>
<a href="#l4.18"></a><span id="l4.18"> contract @mozilla.org/calendar/todo;1 {7af51168-6abe-4a31-984d-6f8a3989212d}</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> component {6877bbdd-f336-46f5-98ce-fe86d0285cc1} calItemModule.js</span>
<a href="#l4.21"></a><span id="l4.21"> contract @mozilla.org/calendar/weekinfo-service;1 {6877bbdd-f336-46f5-98ce-fe86d0285cc1}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -10,37 +10,38 @@ function calTransactionManager() {</span>
<a href="#l5.4"></a><span id="l5.4">     this.wrappedJSObject = this;</span>
<a href="#l5.5"></a><span id="l5.5">     if (!this.transactionManager) {</span>
<a href="#l5.6"></a><span id="l5.6">         this.transactionManager =</span>
<a href="#l5.7"></a><span id="l5.7">             Components.classes[&quot;@mozilla.org/transactionmanager;1&quot;]</span>
<a href="#l5.8"></a><span id="l5.8">                       .createInstance(Components.interfaces.nsITransactionManager);</span>
<a href="#l5.9"></a><span id="l5.9">     }</span>
<a href="#l5.10"></a><span id="l5.10"> }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var calTransactionManagerClassID = Components.ID(&quot;{40a1ccf4-5f54-4815-b842-abf06f84dbfd}&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+var calTransactionManagerClassID = Components.ID(&quot;{1d529847-d292-4222-b066-b8b17a794d62}&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> var calTransactionManagerInterfaces = [Components.interfaces.calITransactionManager];</span>
<a href="#l5.15"></a><span id="l5.15"> calTransactionManager.prototype = {</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">     classID: calTransactionManagerClassID,</span>
<a href="#l5.18"></a><span id="l5.18">     QueryInterface: XPCOMUtils.generateQI(calTransactionManagerInterfaces),</span>
<a href="#l5.19"></a><span id="l5.19">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l5.20"></a><span id="l5.20">         classID: calTransactionManagerClassID,</span>
<a href="#l5.21"></a><span id="l5.21">         classDescription: &quot;Calendar Transaction Manager&quot;,</span>
<a href="#l5.22"></a><span id="l5.22">         contractID: &quot;mozilla.org/calendar/transactionmanager;1&quot;,</span>
<a href="#l5.23"></a><span id="l5.23">         interfaces: calTransactionManagerInterfaces,</span>
<a href="#l5.24"></a><span id="l5.24">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l5.25"></a><span id="l5.25">     }),</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">     transactionManager: null,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    createAndCommitTxn: function(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    createAndCommitTxn: function(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse) {</span>
<a href="#l5.30"></a><span id="l5.30">         let txn = new calTransaction(aAction,</span>
<a href="#l5.31"></a><span id="l5.31">                                      aItem,</span>
<a href="#l5.32"></a><span id="l5.32">                                      aCalendar,</span>
<a href="#l5.33"></a><span id="l5.33">                                      aOldItem,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-                                     aListener);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                                     aListener,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+                                     aExtResponse);</span>
<a href="#l5.37"></a><span id="l5.37">         this.transactionManager.doTransaction(txn);</span>
<a href="#l5.38"></a><span id="l5.38">     },</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">     beginBatch: function() {</span>
<a href="#l5.41"></a><span id="l5.41">         this.transactionManager.beginBatch(null);</span>
<a href="#l5.42"></a><span id="l5.42">     },</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">     endBatch: function() {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineat">@@ -72,23 +73,24 @@ calTransactionManager.prototype = {</span>
<a href="#l5.46"></a><span id="l5.46">     },</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">     canRedo: function() {</span>
<a href="#l5.49"></a><span id="l5.49">         return this.transactionManager.numberOfRedoItems &gt; 0 &amp;&amp;</span>
<a href="#l5.50"></a><span id="l5.50">                this.checkWritable(this.transactionManager.peekRedoStack());</span>
<a href="#l5.51"></a><span id="l5.51">     }</span>
<a href="#l5.52"></a><span id="l5.52"> };</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-function calTransaction(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+function calTransaction(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse) {</span>
<a href="#l5.56"></a><span id="l5.56">     this.wrappedJSObject = this;</span>
<a href="#l5.57"></a><span id="l5.57">     this.mAction = aAction;</span>
<a href="#l5.58"></a><span id="l5.58">     this.mItem = aItem;</span>
<a href="#l5.59"></a><span id="l5.59">     this.mCalendar = aCalendar;</span>
<a href="#l5.60"></a><span id="l5.60">     this.mOldItem = aOldItem;</span>
<a href="#l5.61"></a><span id="l5.61">     this.mListener = aListener;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    this.mExtResponse = aExtResponse;</span>
<a href="#l5.63"></a><span id="l5.63"> }</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65"> var calTransactionClassID = Components.ID(&quot;{fcb54c82-2fb9-42cb-bf44-1e197a55e520}&quot;);</span>
<a href="#l5.66"></a><span id="l5.66"> var calTransactionInterfaces = [</span>
<a href="#l5.67"></a><span id="l5.67">     Components.interfaces.nsITransaction,</span>
<a href="#l5.68"></a><span id="l5.68">     Components.interfaces.calIOperationListener</span>
<a href="#l5.69"></a><span id="l5.69"> ];</span>
<a href="#l5.70"></a><span id="l5.70"> calTransaction.prototype = {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineat">@@ -103,22 +105,24 @@ calTransaction.prototype = {</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73">     mAction: null,</span>
<a href="#l5.74"></a><span id="l5.74">     mCalendar: null,</span>
<a href="#l5.75"></a><span id="l5.75">     mItem: null,</span>
<a href="#l5.76"></a><span id="l5.76">     mOldItem: null,</span>
<a href="#l5.77"></a><span id="l5.77">     mOldCalendar: null,</span>
<a href="#l5.78"></a><span id="l5.78">     mListener: null,</span>
<a href="#l5.79"></a><span id="l5.79">     mIsDoTransaction: false,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+    mExtResponse: null,</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82">     onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l5.83"></a><span id="l5.83">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l5.84"></a><span id="l5.84">             cal.itip.checkAndSend(aOperationType,</span>
<a href="#l5.85"></a><span id="l5.85">                                   aDetail,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-                                  this.mIsDoTransaction ? this.mOldItem : this.mItem);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+                                  this.mIsDoTransaction ? this.mOldItem : this.mItem,</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+                                  this.mExtResponse);</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90">             if (aOperationType == Components.interfaces.calIOperationListener.ADD ||</span>
<a href="#l5.91"></a><span id="l5.91">                 aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l5.92"></a><span id="l5.92">                 if (this.mIsDoTransaction) {</span>
<a href="#l5.93"></a><span id="l5.93">                     this.mItem = aDetail;</span>
<a href="#l5.94"></a><span id="l5.94">                 } else {</span>
<a href="#l5.95"></a><span id="l5.95">                     this.mOldItem = aDetail;</span>
<a href="#l5.96"></a><span id="l5.96">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -12,17 +12,17 @@ ChromeUtils.import(&quot;resource://calendar/</span>
<a href="#l6.4"></a><span id="l6.4"> /**</span>
<a href="#l6.5"></a><span id="l6.5">  * Constructor of calItipEmailTransport object</span>
<a href="#l6.6"></a><span id="l6.6">  */</span>
<a href="#l6.7"></a><span id="l6.7"> function calItipEmailTransport() {</span>
<a href="#l6.8"></a><span id="l6.8">     this.wrappedJSObject = this;</span>
<a href="#l6.9"></a><span id="l6.9">     this._initEmailTransport();</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> var calItipEmailTransportClassID = Components.ID(&quot;{d4d7b59e-c9e0-4a7a-b5e8-5958f85515f0}&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-var calItipEmailTransportInterfaces = [Components.interfaces.calIItipTransport];</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+var calItipEmailTransportInterfaces = [Ci.calIItipTransport];</span>
<a href="#l6.14"></a><span id="l6.14"> calItipEmailTransport.prototype = {</span>
<a href="#l6.15"></a><span id="l6.15">     classID: calItipEmailTransportClassID,</span>
<a href="#l6.16"></a><span id="l6.16">     QueryInterface: XPCOMUtils.generateQI(calItipEmailTransportInterfaces),</span>
<a href="#l6.17"></a><span id="l6.17">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l6.18"></a><span id="l6.18">         classID: calItipEmailTransportClassID,</span>
<a href="#l6.19"></a><span id="l6.19">         contractID: &quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;,</span>
<a href="#l6.20"></a><span id="l6.20">         classDescription: &quot;Calendar iTIP Email Transport&quot;,</span>
<a href="#l6.21"></a><span id="l6.21">         interfaces: calItipEmailTransportInterfaces,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -50,17 +50,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l6.23"></a><span id="l6.23">             let items = this._prepareItems(aItipItem);</span>
<a href="#l6.24"></a><span id="l6.24">             if (items === false) {</span>
<a href="#l6.25"></a><span id="l6.25">                 return false;</span>
<a href="#l6.26"></a><span id="l6.26">             }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">             return this._sendXpcomMail(aRecipients, items.subject, items.body, aItipItem);</span>
<a href="#l6.29"></a><span id="l6.29">         } else {</span>
<a href="#l6.30"></a><span id="l6.30">             // sending xpcom mail is not available if no identity has been set</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-            throw Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+            throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l6.33"></a><span id="l6.33">         }</span>
<a href="#l6.34"></a><span id="l6.34">     },</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">     _prepareItems: function(aItipItem) {</span>
<a href="#l6.37"></a><span id="l6.37">         let item = aItipItem.getItemList({})[0];</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">         // Get ourselves some default text - when we handle organizer properly</span>
<a href="#l6.40"></a><span id="l6.40">         // We'll need a way to configure the Common Name attribute and we should</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -193,106 +193,101 @@ calItipEmailTransport.prototype = {</span>
<a href="#l6.42"></a><span id="l6.42">             this.mDefaultIdentity = this.mDefaultAccount.defaultIdentity;</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">             if (!this.mDefaultIdentity) {</span>
<a href="#l6.45"></a><span id="l6.45">                 // If there isn't a default identity (i.e Local Folders is your</span>
<a href="#l6.46"></a><span id="l6.46">                 // default identity, then go ahead and use the first available</span>
<a href="#l6.47"></a><span id="l6.47">                 // identity.</span>
<a href="#l6.48"></a><span id="l6.48">                 let allIdentities = MailServices.accounts.allIdentities;</span>
<a href="#l6.49"></a><span id="l6.49">                 if (allIdentities.length &gt; 0) {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-                    this.mDefaultIdentity = allIdentities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+                    this.mDefaultIdentity = allIdentities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l6.52"></a><span id="l6.52">                 } else {</span>
<a href="#l6.53"></a><span id="l6.53">                     // If there are no identities, then we are in the same</span>
<a href="#l6.54"></a><span id="l6.54">                     // situation as if we didn't have Xpcom Mail.</span>
<a href="#l6.55"></a><span id="l6.55">                     this.mHasXpcomMail = false;</span>
<a href="#l6.56"></a><span id="l6.56">                     cal.LOG(&quot;initEmailService: No XPCOM Mail available: &quot; + e);</span>
<a href="#l6.57"></a><span id="l6.57">                 }</span>
<a href="#l6.58"></a><span id="l6.58">             }</span>
<a href="#l6.59"></a><span id="l6.59">         } catch (ex) {</span>
<a href="#l6.60"></a><span id="l6.60">             // Then we must resort to operating system specific means</span>
<a href="#l6.61"></a><span id="l6.61">             this.mHasXpcomMail = false;</span>
<a href="#l6.62"></a><span id="l6.62">         }</span>
<a href="#l6.63"></a><span id="l6.63">     },</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    _sendXpcomMail: function(aToList, aSubject, aBody, aItem) {</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    _sendXpcomMail: function(aToList, aSubject, aBody, aItipItem) {</span>
<a href="#l6.67"></a><span id="l6.67">         let identity = null;</span>
<a href="#l6.68"></a><span id="l6.68">         let account;</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-        if (aItem.targetCalendar) {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-            identity = aItem.targetCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+        if (aItipItem.targetCalendar) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+            identity = aItipItem.targetCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l6.73"></a><span id="l6.73">             if (identity) {</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-                identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-                account = aItem.targetCalendar.getProperty(&quot;imip.account&quot;)</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-                                              .QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+                identity = identity.QueryInterface(Ci.nsIMsgIdentity);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+                account = aItipItem.targetCalendar</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+                                   .getProperty(&quot;imip.account&quot;)</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+                                   .QueryInterface(Ci.nsIMsgAccount);</span>
<a href="#l6.81"></a><span id="l6.81">             } else {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-                cal.WARN(&quot;No email identity configured for calendar &quot; + aItem.targetCalendar.name);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+                cal.WARN(&quot;No email identity configured for calendar &quot; +</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+                         aItipItem.targetCalendar.name);</span>
<a href="#l6.85"></a><span id="l6.85">             }</span>
<a href="#l6.86"></a><span id="l6.86">         }</span>
<a href="#l6.87"></a><span id="l6.87">         if (!identity) { // use some default identity/account:</span>
<a href="#l6.88"></a><span id="l6.88">             identity = this.mDefaultIdentity;</span>
<a href="#l6.89"></a><span id="l6.89">             account = this.mDefaultAccount;</span>
<a href="#l6.90"></a><span id="l6.90">         }</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-        let compatMode = 0;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-        switch (aItem.autoResponse) {</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-            case Components.interfaces.calIItipItem.USER: {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-                cal.LOG(&quot;sendXpcomMail: Found USER autoResponse type.\n&quot; +</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-                        &quot;This type is currently unsupported, the compose API will always enter a text/plain\n&quot; +</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-                        &quot;or text/html part as first part of the message.\n&quot; +</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-                        &quot;This will disable OL (up to 2003) to consume the mail as an iTIP invitation showing\n&quot; +</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-                        &quot;the usual calendar buttons.&quot;);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-                // To somehow have a last resort before sending spam, the user can choose to send the mail.</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-                let prefCompatMode = Preferences.get(&quot;calendar.itip.compatSendMode&quot;, 0);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-                let inoutCheck = { value: prefCompatMode == 1 };</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+        switch (aItipItem.autoResponse) {</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+            case Ci.calIItipItem.USER: {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+                cal.LOG(&quot;sendXpcomMail: Found USER autoResponse type.&quot;);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+                // We still need this as a last resort if a user just deletes or</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+                //  drags an invitation related event</span>
<a href="#l6.108"></a><span id="l6.108">                 let parent = Services.wm.getMostRecentWindow(null);</span>
<a href="#l6.109"></a><span id="l6.109">                 if (parent.closed) {</span>
<a href="#l6.110"></a><span id="l6.110">                     parent = cal.window.getCalendarWindow();</span>
<a href="#l6.111"></a><span id="l6.111">                 }</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-                if (Services.prompt.confirmEx(parent,</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-                                              cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.title&quot;, null, &quot;lightning&quot;),</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-                                              cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-                                              Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-                                              null,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-                                              null,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-                                              null,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-                                              cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.Outlook2000CompatMode.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-                                              inoutCheck)) {</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+                let confirmed = Services.prompt.confirmEx(</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+                    parent,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+                    cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.title&quot;, null, &quot;lightning&quot;),</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+                    cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+                    Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+                    null,</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+                    null,</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+                    null,</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+                    null,</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+                    {}</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+                );</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+                if (!confirmed) {</span>
<a href="#l6.133"></a><span id="l6.133">                     break;</span>
<a href="#l6.134"></a><span id="l6.134">                 } // else go on with auto sending for now</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-                compatMode = (inoutCheck.value ? 1 : 0);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-                if (compatMode != prefCompatMode) {</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-                    Preferences.set(&quot;calendar.itip.compatSendMode&quot;, compatMode);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-                }</span>
<a href="#l6.139"></a><span id="l6.139">             }</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-            // falls through, based on prompting above</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-            case Components.interfaces.calIItipItem.AUTO: {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+            // falls through intended</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+            case Ci.calIItipItem.AUTO: {</span>
<a href="#l6.144"></a><span id="l6.144">                 // don't show log message in case of falling through</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-                if (aItem.autoResponse == Components.interfaces.calIItipItem.AUTO) {</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+                if (aItipItem.autoResponse == Ci.calIItipItem.AUTO) {</span>
<a href="#l6.147"></a><span id="l6.147">                     cal.LOG(&quot;sendXpcomMail: Found AUTO autoResponse type.&quot;);</span>
<a href="#l6.148"></a><span id="l6.148">                 }</span>
<a href="#l6.149"></a><span id="l6.149">                 let cbEmail = function(aVal, aInd, aArr) {</span>
<a href="#l6.150"></a><span id="l6.150">                     let email = cal.getAttendeeEmail(aVal, true);</span>
<a href="#l6.151"></a><span id="l6.151">                     if (!email.length) {</span>
<a href="#l6.152"></a><span id="l6.152">                         cal.LOG(&quot;Invalid recipient for email transport: &quot; + aVal.toString());</span>
<a href="#l6.153"></a><span id="l6.153">                     }</span>
<a href="#l6.154"></a><span id="l6.154">                     return email;</span>
<a href="#l6.155"></a><span id="l6.155">                 };</span>
<a href="#l6.156"></a><span id="l6.156">                 let toMap = aToList.map(cbEmail).filter(value =&gt; value.length);</span>
<a href="#l6.157"></a><span id="l6.157">                 if (toMap.length &lt; aToList.length) {</span>
<a href="#l6.158"></a><span id="l6.158">                     // at least one invalid recipient, so we skip sending for this message</span>
<a href="#l6.159"></a><span id="l6.159">                     return false;</span>
<a href="#l6.160"></a><span id="l6.160">                 }</span>
<a href="#l6.161"></a><span id="l6.161">                 let toList = toMap.join(&quot;, &quot;);</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-                let composeUtils = Components.classes[&quot;@mozilla.org/messengercompose/computils;1&quot;]</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-                                             .createInstance(Components.interfaces.nsIMsgCompUtils);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+                let composeUtils = Cc[&quot;@mozilla.org/messengercompose/computils;1&quot;]</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+                                   .createInstance(Ci.nsIMsgCompUtils);</span>
<a href="#l6.166"></a><span id="l6.166">                 let messageId = composeUtils.msgGenerateMessageId(identity);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-                let mailFile = this._createTempImipFile(compatMode, toList, aSubject, aBody, aItem, identity, messageId);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+                let mailFile = this._createTempImipFile(toList, aSubject, aBody, aItipItem, identity, messageId);</span>
<a href="#l6.169"></a><span id="l6.169">                 if (mailFile) {</span>
<a href="#l6.170"></a><span id="l6.170">                     // compose fields for message: from/to etc need to be specified both here and in the file</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-                    let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-                                                  .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+                    let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+                                        .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l6.175"></a><span id="l6.175">                     composeFields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l6.176"></a><span id="l6.176">                     composeFields.to = toList;</span>
<a href="#l6.177"></a><span id="l6.177">                     let mailfrom = (identity.fullName.length ? identity.fullName + &quot; &lt;&quot; + identity.email + &quot;&gt;&quot; : identity.email);</span>
<a href="#l6.178"></a><span id="l6.178">                     composeFields.from = (cal.validateRecipientList(mailfrom) == mailfrom ? mailfrom : identity.email);</span>
<a href="#l6.179"></a><span id="l6.179">                     composeFields.replyTo = identity.replyTo;</span>
<a href="#l6.180"></a><span id="l6.180">                     composeFields.organization = identity.organization;</span>
<a href="#l6.181"></a><span id="l6.181">                     composeFields.messageId = messageId;</span>
<a href="#l6.182"></a><span id="l6.182">                     let validRecipients;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineat">@@ -309,115 +304,103 @@ calItipEmailTransport.prototype = {</span>
<a href="#l6.184"></a><span id="l6.184">                             composeFields.bcc = validRecipients;</span>
<a href="#l6.185"></a><span id="l6.185">                         }</span>
<a href="#l6.186"></a><span id="l6.186">                     }</span>
<a href="#l6.187"></a><span id="l6.187"> </span>
<a href="#l6.188"></a><span id="l6.188">                     // xxx todo: add send/progress UI, maybe recycle</span>
<a href="#l6.189"></a><span id="l6.189">                     //           &quot;@mozilla.org/messengercompose/composesendlistener;1&quot;</span>
<a href="#l6.190"></a><span id="l6.190">                     //           and/or &quot;chrome://messenger/content/messengercompose/sendProgress.xul&quot;</span>
<a href="#l6.191"></a><span id="l6.191">                     // i.e. bug 432662</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-                    let msgSend = Components.classes[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-                                            .createInstance(Components.interfaces.nsIMsgSend);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+                    let msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+                                  .createInstance(Ci.nsIMsgSend);</span>
<a href="#l6.196"></a><span id="l6.196">                     msgSend.sendMessageFile(identity,</span>
<a href="#l6.197"></a><span id="l6.197">                                             account.key,</span>
<a href="#l6.198"></a><span id="l6.198">                                             composeFields,</span>
<a href="#l6.199"></a><span id="l6.199">                                             mailFile,</span>
<a href="#l6.200"></a><span id="l6.200">                                             true,  // deleteSendFileOnCompletion</span>
<a href="#l6.201"></a><span id="l6.201">                                             false, // digest_p</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-                                            (Services.io.offline ? Components.interfaces.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-                                                    : Components.interfaces.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+                                            (Services.io.offline ? Ci.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+                                                    : Ci.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l6.206"></a><span id="l6.206">                                             null,  // nsIMsgDBHdr msgToReplace</span>
<a href="#l6.207"></a><span id="l6.207">                                             null,  // nsIMsgSendListener aListener</span>
<a href="#l6.208"></a><span id="l6.208">                                             null,  // nsIMsgStatusFeedback aStatusFeedback</span>
<a href="#l6.209"></a><span id="l6.209">                                             &quot;&quot;);   // password</span>
<a href="#l6.210"></a><span id="l6.210">                     return true;</span>
<a href="#l6.211"></a><span id="l6.211">                 }</span>
<a href="#l6.212"></a><span id="l6.212">                 break;</span>
<a href="#l6.213"></a><span id="l6.213">             }</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-            case Components.interfaces.calIItipItem.NONE: {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+            case Ci.calIItipItem.NONE: {</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+                // we shouldn't get here, as we stoppped processing in this case</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+                // earlier in checkAndSend in calItipUtils.jsm</span>
<a href="#l6.218"></a><span id="l6.218">                 cal.LOG(&quot;sendXpcomMail: Found NONE autoResponse type.&quot;);</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-                // No response</span>
<a href="#l6.221"></a><span id="l6.221">                 break;</span>
<a href="#l6.222"></a><span id="l6.222">             }</span>
<a href="#l6.223"></a><span id="l6.223">             default: {</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-                // Unknown autoResponse type</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+                // Also of this case should have been taken care at the same place</span>
<a href="#l6.226"></a><span id="l6.226">                 throw new Error(&quot;sendXpcomMail: &quot; +</span>
<a href="#l6.227"></a><span id="l6.227">                                 &quot;Unknown autoResponse type: &quot; +</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-                                aItem.autoResponse);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+                                aItipItem.autoResponse);</span>
<a href="#l6.230"></a><span id="l6.230">             }</span>
<a href="#l6.231"></a><span id="l6.231">         }</span>
<a href="#l6.232"></a><span id="l6.232">         return false;</span>
<a href="#l6.233"></a><span id="l6.233">     },</span>
<a href="#l6.234"></a><span id="l6.234"> </span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-    _createTempImipFile: function(compatMode, aToList, aSubject, aBody, aItem, aIdentity, aMessageId) {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+    _createTempImipFile: function(aToList, aSubject, aBody, aItipItem, aIdentity, aMessageId) {</span>
<a href="#l6.237"></a><span id="l6.237">         try {</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-            let itemList = aItem.getItemList({});</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-            let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-                                       .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+            let itemList = aItipItem.getItemList({});</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+            let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+                             .createInstance(Ci.calIIcsSerializer);</span>
<a href="#l6.244"></a><span id="l6.244">             serializer.addItems(itemList, itemList.length);</span>
<a href="#l6.245"></a><span id="l6.245">             let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-            methodProp.value = aItem.responseMethod;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+            methodProp.value = aItipItem.responseMethod;</span>
<a href="#l6.248"></a><span id="l6.248">             serializer.addProperty(methodProp);</span>
<a href="#l6.249"></a><span id="l6.249">             let calText = serializer.serializeToString();</span>
<a href="#l6.250"></a><span id="l6.250">             let utf8CalText = ltn.invitation.encodeUTF8(calText);</span>
<a href="#l6.251"></a><span id="l6.251"> </span>
<a href="#l6.252"></a><span id="l6.252">             // Home-grown mail composition; I'd love to use nsIMimeEmitter, but it's not clear to me whether</span>
<a href="#l6.253"></a><span id="l6.253">             // it can cope with nested attachments,</span>
<a href="#l6.254"></a><span id="l6.254">             // like multipart/alternative with enclosed text/calendar and text/plain.</span>
<a href="#l6.255"></a><span id="l6.255">             let mailText = ltn.invitation.getHeaderSection(aMessageId, aIdentity, aToList, aSubject);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-            switch (compatMode) {</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-                case 1:</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-                    mailText += &quot;Content-class: urn:content-classes:calendarmessage\r\n&quot; +</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-                                &quot;Content-type: text/calendar; method=&quot; + aItem.responseMethod + &quot;; charset=UTF-8\r\n&quot; +</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-                                &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-                                &quot;\r\n&quot; +</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-                                utf8CalText +</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-                                &quot;\r\n&quot;;</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-                    break;</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-                default:</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-                    mailText += &quot;Content-type: multipart/mixed; boundary=\&quot;Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)\&quot;\r\n&quot; +</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-                                &quot;\r\n\r\n&quot; +</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-                                &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)\r\n&quot; +</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-                                &quot;Content-type: multipart/alternative;\r\n&quot; +</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-                                &quot; boundary=\&quot;Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\&quot;\r\n&quot; +</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-                                &quot;\r\n\r\n&quot; +</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-                                &quot;--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n&quot; +</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-                                &quot;Content-type: text/plain; charset=UTF-8\r\n&quot; +</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-                                &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-                                &quot;\r\n&quot; +</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-                                ltn.invitation.encodeUTF8(aBody) +</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-                                &quot;\r\n\r\n\r\n&quot; +</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-                                &quot;--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n&quot; +</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-                                &quot;Content-type: text/calendar; method=&quot; + aItem.responseMethod + &quot;; charset=UTF-8\r\n&quot; +</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-                                &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-                                &quot;\r\n&quot; +</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-                                utf8CalText +</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-                                &quot;\r\n\r\n&quot; +</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-                                &quot;--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)--\r\n&quot; +</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-                                &quot;\r\n&quot; +</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-                                &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)\r\n&quot; +</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-                                &quot;Content-type: application/ics; name=invite.ics\r\n&quot; +</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-                                &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-                                &quot;Content-disposition: attachment; filename=invite.ics\r\n&quot; +</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-                                &quot;\r\n&quot; +</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-                                utf8CalText +</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-                                &quot;\r\n\r\n&quot; +</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-                                &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)--\r\n&quot;;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-                    break;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-            }</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+            mailText += &quot;Content-type: multipart/mixed; boundary=\&quot;Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)\&quot;\r\n&quot; +</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+                        &quot;\r\n\r\n&quot; +</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+                        &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)\r\n&quot; +</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+                        &quot;Content-type: multipart/alternative;\r\n&quot; +</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+                        &quot; boundary=\&quot;Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\&quot;\r\n&quot; +</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+                        &quot;\r\n\r\n&quot; +</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+                        &quot;--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n&quot; +</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+                        &quot;Content-type: text/plain; charset=UTF-8\r\n&quot; +</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+                        &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+                        &quot;\r\n&quot; +</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+                        ltn.invitation.encodeUTF8(aBody) +</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+                        &quot;\r\n\r\n\r\n&quot; +</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+                        &quot;--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)\r\n&quot; +</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+                        &quot;Content-type: text/calendar; method=&quot; + aItipItem.responseMethod + &quot;; charset=UTF-8\r\n&quot; +</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+                        &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+                        &quot;\r\n&quot; +</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+                        utf8CalText +</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+                        &quot;\r\n\r\n&quot; +</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+                        &quot;--Boundary_(ID_ryU4ZdJoASiZ+Jo21dCbwA)--\r\n&quot; +</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+                        &quot;\r\n&quot; +</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+                        &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)\r\n&quot; +</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+                        &quot;Content-type: application/ics; name=invite.ics\r\n&quot; +</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+                        &quot;Content-transfer-encoding: 8BIT\r\n&quot; +</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+                        &quot;Content-disposition: attachment; filename=invite.ics\r\n&quot; +</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+                        &quot;\r\n&quot; +</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+                        utf8CalText +</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+                        &quot;\r\n\r\n&quot; +</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+                        &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)--\r\n&quot;;</span>
<a href="#l6.324"></a><span id="l6.324">             cal.LOG(&quot;mail text:\n&quot; + mailText);</span>
<a href="#l6.325"></a><span id="l6.325"> </span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-            let tempFile = Services.dirsvc.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+            let tempFile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l6.328"></a><span id="l6.328">             tempFile.append(&quot;itipTemp&quot;);</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-            tempFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+            tempFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l6.331"></a><span id="l6.331">                                   parseInt(&quot;0600&quot;, 8));</span>
<a href="#l6.332"></a><span id="l6.332"> </span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-            let outputStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-                                         .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+            let outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+                               .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l6.337"></a><span id="l6.337">             // Let's write the file - constants from file-utils.js</span>
<a href="#l6.338"></a><span id="l6.338">             const MODE_WRONLY = 0x02;</span>
<a href="#l6.339"></a><span id="l6.339">             const MODE_CREATE = 0x08;</span>
<a href="#l6.340"></a><span id="l6.340">             const MODE_TRUNCATE = 0x20;</span>
<a href="#l6.341"></a><span id="l6.341">             outputStream.init(tempFile,</span>
<a href="#l6.342"></a><span id="l6.342">                               MODE_WRONLY | MODE_CREATE | MODE_TRUNCATE,</span>
<a href="#l6.343"></a><span id="l6.343">                               parseInt(&quot;0600&quot;, 8),</span>
<a href="#l6.344"></a><span id="l6.344">                               0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/lightning/content/lightning.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/lightning/content/lightning.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -52,22 +52,16 @@ pref(&quot;calendar.alarms.eventalarmunit&quot;, &quot;</span>
<a href="#l7.4"></a><span id="l7.4"> pref(&quot;calendar.alarms.onfortodos&quot;, 0);</span>
<a href="#l7.5"></a><span id="l7.5"> pref(&quot;calendar.alarms.todoalarmlen&quot;, 15);</span>
<a href="#l7.6"></a><span id="l7.6"> pref(&quot;calendar.alarms.todoalarmunit&quot;, &quot;minutes&quot;);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> // open invitations autorefresh settings</span>
<a href="#l7.9"></a><span id="l7.9"> pref(&quot;calendar.invitations.autorefresh.enabled&quot;, true);</span>
<a href="#l7.10"></a><span id="l7.10"> pref(&quot;calendar.invitations.autorefresh.timeout&quot;, 3);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-// iTIP compatibility send mode</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-// 0 -- Outlook 2003 and following with text/plain and application/ics (default)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-// 1 -- all Outlook, but no text/plain nor application/ics</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-// We may extend the compat mode if necessary.</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-pref(&quot;calendar.itip.compatSendMode&quot;, 0);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18"> // whether &quot;notify&quot; is checked by default when creating new events/todos with attendees</span>
<a href="#l7.19"></a><span id="l7.19"> pref(&quot;calendar.itip.notify&quot;, true);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> // whether the organizer propagates replies of attendees to all attendees</span>
<a href="#l7.22"></a><span id="l7.22"> pref(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> // whether email invitation updates are send out to all attendees if (only) adding a new attendee</span>
<a href="#l7.25"></a><span id="l7.25"> pref(&quot;calendar.itip.updateInvitationForNewAttendeesOnly&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -136,17 +136,16 @@ imipBarReplyToNotExistingItem=This messa</span>
<a href="#l8.4"></a><span id="l8.4"> # LOCALIZATION_NOTE(imipBarReplyToRecentlyRemovedItem):</span>
<a href="#l8.5"></a><span id="l8.5"> # %1$S - datetime of deletion</span>
<a href="#l8.6"></a><span id="l8.6"> imipBarReplyToRecentlyRemovedItem=This message contains a reply referring to an event that was removed from your calendar at %1$S.</span>
<a href="#l8.7"></a><span id="l8.7"> imipBarUnsupportedText=This message contains an event that this version of Lightning cannot process.</span>
<a href="#l8.8"></a><span id="l8.8"> imipBarProcessingFailed=Processing message failed. Status: %1$S.</span>
<a href="#l8.9"></a><span id="l8.9"> imipBarNotWritable=No writable calendars are configured for invitations, please check the calendar properties.</span>
<a href="#l8.10"></a><span id="l8.10"> imipSendMail.title=E-Mail Notification</span>
<a href="#l8.11"></a><span id="l8.11"> imipSendMail.text=Would you like to send out notification E-Mail now?</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-imipSendMail.Outlook2000CompatMode.text=Support Outlook 2000 and Outlook 2002/XP</span>
<a href="#l8.13"></a><span id="l8.13"> imipNoIdentity=None</span>
<a href="#l8.14"></a><span id="l8.14"> imipNoCalendarAvailable=There are no writable calendars available.</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> itipReplySubject=Event Invitation Reply: %1$S</span>
<a href="#l8.17"></a><span id="l8.17"> itipReplyBodyAccept=%1$S has accepted your event invitation.</span>
<a href="#l8.18"></a><span id="l8.18"> itipReplyBodyDecline=%1$S has declined your event invitation.</span>
<a href="#l8.19"></a><span id="l8.19"> itipReplySubjectAccept=Event Invitation Reply (Accepted): %1$S</span>
<a href="#l8.20"></a><span id="l8.20"> itipReplySubjectDecline=Event Invitation Reply (Declined): %1$S</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

