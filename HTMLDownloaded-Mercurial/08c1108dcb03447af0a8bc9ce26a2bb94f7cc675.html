<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 843:08c1108dcb03447af0a8bc9ce26a2bb94f7cc675</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 08c1108dcb03447af0a8bc9ce26a2bb94f7cc675" />
<meta property="og:url" content="/comm-central/rev/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675" />
<meta property="og:description" content="status commit: end of day." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 08c1108dcb03447af0a8bc9ce26a2bb94f7cc675 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">shortlog</a> |
<a href="/comm-central/log/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">files</a> |
changeset |
<a href="/comm-central/raw-rev/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">raw</a>  | <a href="/comm-central/archive/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
status commit: end of day.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 15 Jul 2008 21:10:46 -0700</td></tr>

<tr>
 <td>changeset 843</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">08c1108dcb03447af0a8bc9ce26a2bb94f7cc675</a></td>
</tr>



<tr>
<td>parent 842</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/65e54c7a5fe0704129c2dbb3fb46a7ba01d24629">65e54c7a5fe0704129c2dbb3fb46a7ba01d24629</a>
</td>
</tr>

<tr>
<td>child 844</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ed30d3a14e2a45617ef49bf82b958da36556f592">ed30d3a14e2a45617ef49bf82b958da36556f592</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=08c1108dcb03447af0a8bc9ce26a2bb94f7cc675">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">status commit: end of day.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/locale/en-US/gloda.properties">locale/en-US/gloda.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/locale/en-US/gloda.properties">file</a> |
<a href="/comm-central/annotate/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/locale/en-US/gloda.properties">annotate</a> |
<a href="/comm-central/diff/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/locale/en-US/gloda.properties">diff</a> |
<a href="/comm-central/comparison/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/locale/en-US/gloda.properties">comparison</a> |
<a href="/comm-central/log/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/locale/en-US/gloda.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/08c1108dcb03447af0a8bc9ce26a2bb94f7cc675/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/locale/en-US/gloda.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/locale/en-US/gloda.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,11 +1,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> prefMessage=Int Pref Value: %d</span>
<a href="#l1.5"></a><span id="l1.5"> extensions.gloda.description=Adds a global database to Thunderbird</span>
<a href="#l1.6"></a><span id="l1.6"> shutdownTaskName=Global Database Indexer</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+actionIdle=Idle</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+actionIndexing=Indexing</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+actionDeindexing=De-Indexing</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+actionMoving=Move Processing</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+messageIndexingExplanation=some messages</span>
<a href="#l1.12"></a><span id="l1.12"> attrFromExplanation=%{subject} was sent by %{object}</span>
<a href="#l1.13"></a><span id="l1.13"> attrToExplanation=%{subject} was sent to %{object}</span>
<a href="#l1.14"></a><span id="l1.14"> attrCcExplanation=%{subject} was carbon-copied to %{object}</span>
<a href="#l1.15"></a><span id="l1.15"> attrDateExplanation=%{subject} was sent on %{object}</span>
<a href="#l1.16"></a><span id="l1.16"> attrListExplanation=%{subject} was sent via %{object}</span>
<a href="#l1.17"></a><span id="l1.17"> attrTagExplanation=%{subject} was tagged %{parameter} on %{object}</span>
<a href="#l1.18"></a><span id="l1.18"> attrStarExplanation=%{subject} has a star state of %{object}</span>
<a href="#l1.19"></a><span id="l1.19"> attrReadExplanation=%{subject} has a read state of %{object}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -532,16 +532,23 @@ let GlodaDatastore = {</span>
<a href="#l2.4"></a><span id="l2.4">     this._folderURIs[aNewURI] = folderID;</span>
<a href="#l2.5"></a><span id="l2.5">     this._folderIDs[folderID] = aNewURI;</span>
<a href="#l2.6"></a><span id="l2.6">     this._updateFolderLocationStatement.params.oldFolderURI = aOldURI;</span>
<a href="#l2.7"></a><span id="l2.7">     this._updateFolderLocationStatement.params.newFolderURI = aNewURI;</span>
<a href="#l2.8"></a><span id="l2.8">     this._updateFolderLocationStatement.execute();</span>
<a href="#l2.9"></a><span id="l2.9">     delete this._folderURIs[aOldURI];</span>
<a href="#l2.10"></a><span id="l2.10">   },</span>
<a href="#l2.11"></a><span id="l2.11">   </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  deleteFolderByID: function gloda_ds_deleteFolder(aFolderID) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let statement = this._createStatement(</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      &quot;DELETE FROM folderLocations WHERE id = :id&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    statement.params.id = aFolderID;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    statement.execute();</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  },</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  </span>
<a href="#l2.19"></a><span id="l2.19">   /* ********** Conversation ********** */</span>
<a href="#l2.20"></a><span id="l2.20">   get _insertConversationStatement() {</span>
<a href="#l2.21"></a><span id="l2.21">     let statement = this._createStatement(</span>
<a href="#l2.22"></a><span id="l2.22">       &quot;INSERT INTO conversations (subject, oldestMessageDate, \</span>
<a href="#l2.23"></a><span id="l2.23">                                   newestMessageDate) \</span>
<a href="#l2.24"></a><span id="l2.24">               VALUES (:subject, :oldestMessageDate, :newestMessageDate)&quot;);</span>
<a href="#l2.25"></a><span id="l2.25">     this.__defineGetter__(&quot;_insertConversationStatement&quot;, function() statement);</span>
<a href="#l2.26"></a><span id="l2.26">     return this._insertConversationStatement; </span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -664,35 +671,29 @@ let GlodaDatastore = {</span>
<a href="#l2.28"></a><span id="l2.28">     ums.params.messageKey = aMessage.messageKey;</span>
<a href="#l2.29"></a><span id="l2.29">     ums.params.conversationID = aMessage.conversationID;</span>
<a href="#l2.30"></a><span id="l2.30">     ums.params.headerMessageID = aMessage.headerMessageID;</span>
<a href="#l2.31"></a><span id="l2.31">     ums.params.bodySnippet = aMessage.bodySnippet;</span>
<a href="#l2.32"></a><span id="l2.32">     </span>
<a href="#l2.33"></a><span id="l2.33">     ums.execute();</span>
<a href="#l2.34"></a><span id="l2.34">   },</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  get _updateMessageStatement() {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    let statement = this._createStatement(</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    this.__defineGetter__(&quot;_updateMessageStatement&quot;, function() statement);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    return this._updateMessageStatement; </span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  }, </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span>
<a href="#l2.42"></a><span id="l2.42">   updateMessageFoldersByKeyPurging:</span>
<a href="#l2.43"></a><span id="l2.43">       function gloda_ds_updateMessageFoldersByKeyPurging(aSrcFolderURI,</span>
<a href="#l2.44"></a><span id="l2.44">         aMessageKeys, aDestFolderURI) {</span>
<a href="#l2.45"></a><span id="l2.45">     let srcFolderID = this._mapFolderURI(aSrcFolderURI);</span>
<a href="#l2.46"></a><span id="l2.46">     let destFolderID = this._mapFolderURI(aDestFolderURI);</span>
<a href="#l2.47"></a><span id="l2.47">     </span>
<a href="#l2.48"></a><span id="l2.48">     let sqlStr = &quot;UPDATE messages SET folderID = :newFolderID, \</span>
<a href="#l2.49"></a><span id="l2.49">                                       messageKey = NULL, \</span>
<a href="#l2.50"></a><span id="l2.50">                    WHERE folderID = :id \</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-                     AND messageKey IN (&quot; + messageKeys.join(&quot;, &quot;) + &quot;)&quot;);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+                     AND messageKey IN (&quot; + aMessageKeys.join(&quot;, &quot;) + &quot;)&quot;;</span>
<a href="#l2.53"></a><span id="l2.53">     let statement = this._createStatement(sqlStr);</span>
<a href="#l2.54"></a><span id="l2.54">     statement.execute();</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  }</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  },</span>
<a href="#l2.57"></a><span id="l2.57">   </span>
<a href="#l2.58"></a><span id="l2.58">   _messageFromRow: function gloda_ds_messageFromRow(aRow) {</span>
<a href="#l2.59"></a><span id="l2.59">     return new GlodaMessage(this, aRow[&quot;id&quot;], aRow[&quot;folderID&quot;],</span>
<a href="#l2.60"></a><span id="l2.60">                             this._mapFolderID(aRow[&quot;folderID&quot;]),</span>
<a href="#l2.61"></a><span id="l2.61">                             aRow[&quot;messageKey&quot;],</span>
<a href="#l2.62"></a><span id="l2.62">                             aRow[&quot;conversationID&quot;], null,</span>
<a href="#l2.63"></a><span id="l2.63">                             aRow[&quot;headerMessageID&quot;], aRow[&quot;bodySnippet&quot;]);</span>
<a href="#l2.64"></a><span id="l2.64">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -110,73 +110,141 @@ function fixIterator(aEnum, aIface) {</span>
<a href="#l3.4"></a><span id="l3.4">     let iter = function () {</span>
<a href="#l3.5"></a><span id="l3.5">       while (aEnum.hasMoreElements())</span>
<a href="#l3.6"></a><span id="l3.6">         yield aEnum.getNext().QueryInterface(face);</span>
<a href="#l3.7"></a><span id="l3.7">     }</span>
<a href="#l3.8"></a><span id="l3.8">     return { __iterator__: iter };</span>
<a href="#l3.9"></a><span id="l3.9">   } catch(ex) {}</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Capture the indexing batch concept explicitly.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ *</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * @param aActionDesc ex: &quot;Indexing&quot;, &quot;De-indexing&quot; (you should pass in the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ *     localized string)</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * @param aTargetName A folder name, or other.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ */</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+function IndexingJob(aJobType, aDeltaType, aID) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  this.jobType = aJobType;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  this.deltaType = aDeltaType;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  this.id = aID;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  this.items = [];</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  this.count = 0;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  this.goal = null;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+}</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+</span>
<a href="#l3.28"></a><span id="l3.28"> let GlodaIndexer = {</span>
<a href="#l3.29"></a><span id="l3.29">   _datastore: GlodaDatastore,</span>
<a href="#l3.30"></a><span id="l3.30">   _log: Log4Moz.Service.getLogger(&quot;gloda.indexer&quot;),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  _strBundle: null,</span>
<a href="#l3.32"></a><span id="l3.32">   _msgwindow: null,</span>
<a href="#l3.33"></a><span id="l3.33">   _domWindow: null,</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">   _inited: false,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  init: function gloda_index_init(aDOMWindow, aMsgWindow) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  init: function gloda_index_init(aDOMWindow, aMsgWindow, aStrBundle) {</span>
<a href="#l3.38"></a><span id="l3.38">     if (this._inited)</span>
<a href="#l3.39"></a><span id="l3.39">       return;</span>
<a href="#l3.40"></a><span id="l3.40">     </span>
<a href="#l3.41"></a><span id="l3.41">     this._inited = true;</span>
<a href="#l3.42"></a><span id="l3.42">     </span>
<a href="#l3.43"></a><span id="l3.43">     this._domWindow = aDOMWindow;</span>
<a href="#l3.44"></a><span id="l3.44">     </span>
<a href="#l3.45"></a><span id="l3.45">     // topmostMsgWindow explodes for un-clear reasons if we have multiple</span>
<a href="#l3.46"></a><span id="l3.46">     //  windows open.  very sad.</span>
<a href="#l3.47"></a><span id="l3.47">     /*</span>
<a href="#l3.48"></a><span id="l3.48">     let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l3.49"></a><span id="l3.49">                         getService(Ci.nsIMsgMailSession);</span>
<a href="#l3.50"></a><span id="l3.50">     this._msgWindow = mailSession.topmostMsgWindow;</span>
<a href="#l3.51"></a><span id="l3.51">     */</span>
<a href="#l3.52"></a><span id="l3.52">     this._msgWindow = aMsgWindow;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    </span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    this._strBundle = aStrBundle;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  },</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  /**</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+   * Are we enabled, read: are we processing change events?</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+   */</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  _enabled: false,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  get enabled() { return this._enabled; },</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  set enabled(aEnable) {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    if (!this._enabled &amp;&amp; aEnable) {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      this._msgFolderListener.indexer = this;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+      </span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+      let notificationService =</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+        Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;].</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+        getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+      notificationService.addListener(this._msgFolderListener);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+      </span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      this._enabled = true;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    }</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    else if (this._enabled &amp;&amp; !aEnable) {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+      let notificationService =</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+        Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;].</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+        getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+      notificationService.removeListener(this._msgFolderListener);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+      </span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      this._enabled = false;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    }</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    </span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    this._log.info(&quot;Event-Driven Indexing is now &quot; + this._enabled);</span>
<a href="#l3.83"></a><span id="l3.83">   },</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">   /** Track whether indexing is active (we have timers in-flight). */</span>
<a href="#l3.86"></a><span id="l3.86">   _indexingActive: false,</span>
<a href="#l3.87"></a><span id="l3.87">   get indexing() { return this._indexingActive; },</span>
<a href="#l3.88"></a><span id="l3.88">   /** You can turn on indexing, but you can't turn it off! */</span>
<a href="#l3.89"></a><span id="l3.89">   set indexing(aShouldIndex) {</span>
<a href="#l3.90"></a><span id="l3.90">     if (!this._indexingActive &amp;&amp; aShouldIndex) {</span>
<a href="#l3.91"></a><span id="l3.91">       this._indexingActive = true;</span>
<a href="#l3.92"></a><span id="l3.92">       this._domWindow.setTimeout(this._wrapIncrementalIndex, this._indexInterval, this);</span>
<a href="#l3.93"></a><span id="l3.93">     }  </span>
<a href="#l3.94"></a><span id="l3.94">   },</span>
<a href="#l3.95"></a><span id="l3.95">   </span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-  /** The nsIMsgFolder we are indexing, or null if we aren't. */</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-  _indexingFolder: null,</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  /** The iterator we are using to traverse _indexingFolder. */</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-  _indexingIterator: null,</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  _indexingFolderCount: 0,</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  _indexingFolderGoal: 0,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  _indexingMessageCount: 0,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  _indexingMessageGoal: 0,</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  /**</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+   * Our current job number, out of _indexingJobGoal.  Although our jobs comes</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+   *  from _indexQueue, this is not an offset into that list because we forget</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+   *  jobs once we complete them.  As such, this value is strictly for progress</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+   *  tracking.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+   */ </span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  _indexingJobCount: 0,</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  /**</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+   * Total number of jobs to process in this current indexing session; may</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+   *  increase as new jobs are added to the _indexQueue.  This value won't</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+   *  decrease until the indexing session is completed (and we become idle),</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+   *  and then it will go to zero.</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+   */</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+  _indexingJobGoal: 0,</span>
<a href="#l3.118"></a><span id="l3.118">   </span>
<a href="#l3.119"></a><span id="l3.119">   /**</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-   * A list of things yet to index.  Contents will be lists matching one of the</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-   *  following patterns:</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+   * A list of IndexingJob instances to process.</span>
<a href="#l3.123"></a><span id="l3.123">    * - ['account', account object]</span>
<a href="#l3.124"></a><span id="l3.124">    * - ['folder', folder URI]</span>
<a href="#l3.125"></a><span id="l3.125">    * - ['message', delta type, message header, folder ID, message key,</span>
<a href="#l3.126"></a><span id="l3.126">    *      message ID]</span>
<a href="#l3.127"></a><span id="l3.127">    *   (we use folder ID instead of URI so that renames can't trick us)</span>
<a href="#l3.128"></a><span id="l3.128">    */</span>
<a href="#l3.129"></a><span id="l3.129">   _indexQueue: [],</span>
<a href="#l3.130"></a><span id="l3.130">   </span>
<a href="#l3.131"></a><span id="l3.131">   /**</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+   * The current indexing job.</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+   */</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  _curIndexingJob: null,</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  </span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  /**</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+   * A message addition job yet to be (completely) processed.  Since message</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+   *  addition events come to us one-by-one, in order to aggregate them into a</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+   *  job, we need something like this.  It's up to the indexing loop to</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+   *  decide when to null this out; it can either do it when it first starts</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+   *  processing it, or when it has processed the last thing.  It's really a</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+   *  question of whether we want retrograde motion in the folder progress bar</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+   *  or the message progress bar.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+   */</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  _pendingAddJob: null,</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  </span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  /**</span>
<a href="#l3.148"></a><span id="l3.148">    * The time interval, in milliseconds between performing indexing work.</span>
<a href="#l3.149"></a><span id="l3.149">    *  This may be altered by user session (in)activity.</span>
<a href="#l3.150"></a><span id="l3.150">    */ </span>
<a href="#l3.151"></a><span id="l3.151">   _indexInterval: 100,</span>
<a href="#l3.152"></a><span id="l3.152">   /**</span>
<a href="#l3.153"></a><span id="l3.153">    * Number of indexing 'tokens' we are allowed to consume before yielding for</span>
<a href="#l3.154"></a><span id="l3.154">    *  each incremental pass.  Consider a single token equal to indexing a single</span>
<a href="#l3.155"></a><span id="l3.155">    *  medium-sized message.  This may be altered by user session (in)activity.</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineat">@@ -199,17 +267,17 @@ let GlodaIndexer = {</span>
<a href="#l3.157"></a><span id="l3.157">    */</span>
<a href="#l3.158"></a><span id="l3.158">   addListener: function gloda_index_addListener(aListener) {</span>
<a href="#l3.159"></a><span id="l3.159">     // should we weakify?</span>
<a href="#l3.160"></a><span id="l3.160">     if (this._indexListeners.indexOf(aListener) == -1)</span>
<a href="#l3.161"></a><span id="l3.161">       this._indexListeners.push(aListener);</span>
<a href="#l3.162"></a><span id="l3.162">     // if we aren't indexing, give them an idle indicator, otherwise they can</span>
<a href="#l3.163"></a><span id="l3.163">     //  just be happy when we hit the next actual status point.</span>
<a href="#l3.164"></a><span id="l3.164">     if (!this.indexing)</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-      aListener(&quot;Idle&quot;, null, 0, 1, 0, 1);</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+      aListener(this._strBundle.getString(&quot;actionIdle&quot;), null, 0, 1, 0, 1);</span>
<a href="#l3.167"></a><span id="l3.167">     return aListener;</span>
<a href="#l3.168"></a><span id="l3.168">   },</span>
<a href="#l3.169"></a><span id="l3.169">   removeListener: function gloda_index_removeListener(aListener) {</span>
<a href="#l3.170"></a><span id="l3.170">     let index = this._indexListeners.indexOf(aListener);</span>
<a href="#l3.171"></a><span id="l3.171">     if (index != -1)</span>
<a href="#l3.172"></a><span id="l3.172">       this._indexListeners(index, 1);</span>
<a href="#l3.173"></a><span id="l3.173">   },</span>
<a href="#l3.174"></a><span id="l3.174">   _notifyListeners: function gloda_index_notifyListeners(aStatus, aFolderName,</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineat">@@ -217,147 +285,234 @@ let GlodaIndexer = {</span>
<a href="#l3.176"></a><span id="l3.176">     for (let iListener=this._indexListeners.length-1; iListener &gt;= 0; </span>
<a href="#l3.177"></a><span id="l3.177">          iListener--) {</span>
<a href="#l3.178"></a><span id="l3.178">       let listener = this._indexListeners[iListener];</span>
<a href="#l3.179"></a><span id="l3.179">       listener(aStatus, aFolderName, aFolderIndex, aFoldersTotal, aMessageIndex,</span>
<a href="#l3.180"></a><span id="l3.180">                aMessagesTotal);</span>
<a href="#l3.181"></a><span id="l3.181">     } </span>
<a href="#l3.182"></a><span id="l3.182">   },</span>
<a href="#l3.183"></a><span id="l3.183">   </span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  _indexingFolderID: null,</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  _indexingFolder: null,</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  _indexingDatabase: null,</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  _indexingIterator: null,</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+  </span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+  /**</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+   * Common logic that we want to deal with the given folder ID.  Besides</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+   *  cutting down on duplicate code, this ensures that we are listening on</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+   *  the folder in case it tries to go away when we are using it.</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+   */</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  _indexerEnterFolder: function gloda_index_indexerEnterFolder(aFolderID,</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+                                                               aNeedIterator) {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+    // if leave folder was't cleared first, remove the listener; everyone else</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    //  will be nulled out in the exception handler below if things go south</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+    //  on this folder.</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    if (this._indexingFolder !== null) {</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+      this._indexingDatabase.RemoveListener(this._databaseAnnouncerListener);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+    }</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+    </span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+    let folderURI = GlodaDatastore._mapFolderID(job.folderID);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+    this._log.debug(&quot;Active Folder URI: &quot; + folderURI);</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  </span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+    let rdfService = Cc['@mozilla.org/rdf/rdf-service;1'].</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+                     getService(Ci.nsIRDFService);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+    let folder = rdfService.GetResource(folderURI);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    folder.QueryInterface(Ci.nsIMsgFolder); // (we want to explode in the try</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+    // if this guy wasn't what we wanted)</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+    this._indexingFolder = folder;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+    this._indexingFolderID = aFolderID;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+    // The msf may need to be created or otherwise updated, updateFolder will</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    //  do this for us.  (GetNewMessages would also do it, but we would be</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+    //  triggering new message retrieval in that case, which we don't actually</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+    //  desire.</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+    // TODO: handle password-protected local cache potentially triggering a</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+    //  password prompt here...</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    try {</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+      //this._indexingFolder.updateFolder(this._msgWindow);</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+      // we get an nsIMsgDatabase out of this (unsurprisingly) which</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+      //  explicitly inherits from nsIDBChangeAnnouncer, which has the</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+      //  AddListener call we want.</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+      this._indexingDatabase = folder.getMsgDatabase(this._msgWindow);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+      if (aNeedIterator)</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+        this._indexingIterator = Iterator(fixIterator(</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+                                   //folder.getMessages(this._msgWindow),</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+                                   this._indexingDatabase.EnumerateMessages(),</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+                                   Ci.nsIMsgDBHdr));</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+      this._databaseAnnouncerListener.indexer = this;</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+      this._indexingDatabase.AddListener(this._databaseAnnouncerListener);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+    }</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    catch (ex) {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+      this._log.error(&quot;Problem entering folder: &quot; +</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+                      folder.prettiestName + &quot;, skipping.&quot;);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+      this._log.error(&quot;Error was: &quot; + ex);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+      this._indexingFolder = null;</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+      this._indexingFolderID = null;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+      this._indexingDatabase = null;</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+      this._indexingIterator = null;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      </span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      // re-throw, we just wanted to make sure this junk is cleaned up and</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+      //  get localized error logging...</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+      throw ex;</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+    }</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  },</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+  </span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+  _indexerLeaveFolder: function gloda_index_indexerLeaveFolder(aExpected) {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+    if (this._indexingFolder !== null) {</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+      // remove our listener!</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+      this._indexingDatabase.RemoveListener(this._databaseAnnouncerListener);</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+      // null everyone out</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+      this._indexingFolder = null;</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+      this._indexingFolderID = null;</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+      this._indexingDatabase = null;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+      this._indexingIterator = null;</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+      // ...including the active job:</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+      this._curIndexingJob = null;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+    }</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  },</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+  </span>
<a href="#l3.263"></a><span id="l3.263">   _wrapIncrementalIndex: function gloda_index_wrapIncrementalIndex(aThis) {</span>
<a href="#l3.264"></a><span id="l3.264">     aThis.incrementalIndex();</span>
<a href="#l3.265"></a><span id="l3.265">   },</span>
<a href="#l3.266"></a><span id="l3.266">   </span>
<a href="#l3.267"></a><span id="l3.267">   incrementalIndex: function gloda_index_incrementalIndex() {</span>
<a href="#l3.268"></a><span id="l3.268">     this._log.debug(&quot;index wake-up!&quot;);</span>
<a href="#l3.269"></a><span id="l3.269">   </span>
<a href="#l3.270"></a><span id="l3.270">     GlodaDatastore._beginTransaction();</span>
<a href="#l3.271"></a><span id="l3.271">     try {</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    </span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+      let job = this._curIndexingJob;</span>
<a href="#l3.274"></a><span id="l3.274">       for (let tokensLeft=this._indexTokens; tokensLeft &gt; 0; tokensLeft--) {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-        if (this._indexingFolder != null) {</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+        // --- Do we need a job?</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+        if (job === null) {</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+          // --- Are there any jobs left?</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+          if (this._indexQueue.length == 0) {</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+            this._log.info(&quot;Done indexing, disabling timer renewal.&quot;);</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+            this._indexingActive = false;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+            this._indexingJobCount = 0;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+            this._indexingJobGoal = 0;</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+            this._notifyListeners(this._strBundle(&quot;actionIdle&quot;), null,</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+                                  0, 1, 0, 1);</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+            break;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+          }</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+          </span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+          // --- Get a job</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+          else {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+            try {</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+              job = this._curIndexingJob = this._indexQueue.shift();</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+              // (Prepare for the job...)</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+              if (job.jobType == &quot;folder&quot;) {</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+                // -- FOLDER ADD</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+                if (job.deltaType &gt; 0) {</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+                  this._indexerEnterFolder(job.folderID, true)</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+                  job.goal = this._indexingFolder.getTotalMessages(false);</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+                }</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+                // -- FOLDER DELETE</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+                else {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+                  // nuke the folder id</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+                  this._datastore.deleteFolderByID(job.id);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+                }</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+              }</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+              // messages</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+              else {</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+                // not much to do here; unlink the pending add job if that's him</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+                if (job === this._pendingAddJob)</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+                  this._pendingAddJob = null;</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+                // update our goal from the items length</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+                job.goal = job.items.length;</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+              }</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+            }</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+            catch (ex) {</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+              this._log.debug(&quot;Failed to start job because: &quot; + ex);</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+              job = this._curIndexingJob = null;</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+            }</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+          }</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+        }</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+        // --- Do the job</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+        else {</span>
<a href="#l3.323"></a><span id="l3.323">           try {</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-            this._indexMessage(this._indexingIterator.next());</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-            this._indexingMessageCount++;</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-            </span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-            if (this._indexingMessageCount % 50 == 1) {</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-              this._notifyListeners(&quot;Indexing: &quot; +</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-                                    this._indexingFolder.prettiestName,</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-                                    this._indexingFolder.prettiestName,</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-                                    this._indexingFolderCount,</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-                                    this._indexingFolderGoal,</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-                                    this._indexingMessageCount,</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-                                    this._indexingMessageGoal);</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-              //this._log.debug(&quot;indexed &quot; + this._indexingCount + &quot; in &quot; +</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-              //                this._indexingFolder.prettiestName);</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+            if (job.jobType == &quot;folder&quot;) {</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+              // -- FOLDER ADD (steady state)</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+              if (job.deltaType &gt; 0) {</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+                this._indexMessage(this._indexingIterator.next());</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+                job.offset++;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+              }</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+              // there is no steady-state processing for folder deletion</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+            }</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+            else if (job.jobType == &quot;message&quot;) {</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+              let item = job.items[job.offset++];</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+              // -- MESSAGE ADD (batch steady state)</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+              if (job.deltaType &gt; 0) {</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+                // item must be [folder ID, message key]</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+                // get in the folder</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+                if (this._indexingFolderID != item[0])</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+                  this._indexerEnterFolder(item[0], false);</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+                let msgHdr = this._indexingFolder.GetMessageHeader(item[1]);</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+                if (msgHdr)</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+                  this._indexMessage(msgHdr);</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+              }</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+              // -- MESSAGE MOVE (batch steady state)</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+              else if (job.deltaType == 0) {</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+                // item must be [folder ID, header message-id]</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+                </span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+                // get in the folder</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+                if (this._indexingFolderID != item[0])</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+                  this._indexerEnterFolder(item[0], false);</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+                // process everyone with the message-id.  yeck.</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+                // uh, except nsIMsgDatabase only thinks there should be one, so</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+                //  let's pretend that this assumption is not a bad idea for now</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+                // TODO: stop pretending this assumption is not a bad idea</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+                let msgHdr = this._indexingDatabase.getMsgHdrForMessageID(item[1]);</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+                if (msgHdr)</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+                  this._indexMessage(msgHdr);</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+                // remember to eat extra tokens... when we get more than one...</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+              }</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+              // -- MESSAGE DELETE (batch steady state)</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+              else { // job.deltaType &lt; 0</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+                // item must be a message id</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+                let message = GlodaDatastore.getMessageByID(messageID);</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+                // delete the message!</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+                if (message !== null)</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+                  this._deleteMessage(message);</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+              }</span>
<a href="#l3.382"></a><span id="l3.382">             }</span>
<a href="#l3.383"></a><span id="l3.383">           }</span>
<a href="#l3.384"></a><span id="l3.384">           catch (ex) {</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-            this._log.debug(&quot;Done with indexing folder because: &quot; + ex);</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-            this._indexingFolder = null;</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-            this._indexingIterator = null;</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+            this._log.debug(&quot;Bailing on job because: &quot; + ex);</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+            this._indexerLeaveFolder();</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+            job = this._curIndexingJob = null;</span>
<a href="#l3.391"></a><span id="l3.391">           }</span>
<a href="#l3.392"></a><span id="l3.392">         }</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-        else if (this._indexQueue.length) {</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-          let item = this._indexQueue.shift();</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-          let itemType = item[0];</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-          let actionType = item[1];</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-          </span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-          // Index an account.  (can't actually happen right now)</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-          if ((itemType == &quot;account&quot;) &amp;&amp; (actionType &gt; 1)) {</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-            this.indexAccount(item[1]);</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-          }</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-          // Index an added folder (new, or just re-scanning)</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-          else if ((itemType == &quot;folder&quot;) &amp;&amp; (actionType &gt; 0)) {</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-            let folderID = item[2];</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-            let folderURI = GlodaDatastore._mapFolderID(folderID);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-            </span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-            this._log.debug(&quot;Folder URI: &quot; + folderURI);</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-  </span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-            let rdfService = Cc['@mozilla.org/rdf/rdf-service;1'].</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-                             getService(Ci.nsIRDFService);</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-            let folder = rdfService.GetResource(folderURI);</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-            if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-              this._indexingFolder = folder;</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-  </span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-              this._log.debug(&quot;Starting indexing of folder: &quot; +</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-                              folder.prettiestName);</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-  </span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-              // The msf may need to be created or otherwise updated, updateFolder will</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-              //  do this for us.  (GetNewMessages would also do it, but we would be</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-              //  triggering new message retrieval in that case, which we don't actually</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-              //  desire.</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-              // TODO: handle password-protected local cache potentially triggering a</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-              //  password prompt here...</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-              try {</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-                //this._indexingFolder.updateFolder(this._msgWindow);</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-              </span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-                let msgDatabase = folder.getMsgDatabase(this._msgWindow);</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-                this._indexingIterator = Iterator(fixIterator(</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-                                           //folder.getMessages(this._msgWindow),</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-                                           msgDatabase.EnumerateMessages(),</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-                                           Ci.nsIMsgDBHdr));</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-                this._indexingFolderCount++;</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-                this._indexingMessageCount = 0;</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-                this._indexingMessageGoal = folder.getTotalMessages(false); </span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-              }</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-              catch (ex) {</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-                this._log.error(&quot;Problem indexing folder: &quot; +</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-                                folder.prettiestName + &quot;, skipping.&quot;);</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-                this._log.error(&quot;Error was: &quot; + ex);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-                this._indexingFolder = null;</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-                this._indexingIterator = null;</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-              }</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-            }</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-          }</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-          // Delete a folder that has gone away</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-          // [&quot;folder&quot;, -1, folder ID]</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-          else if ((itemType == &quot;folder&quot;) &amp;&amp; (actionType &lt; 0)) {</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-            let folderID = item[2];</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-            // we simply convert the messages in the folder to message ids</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-            //  which we re-queue.</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-            let messageIDs = GlodaDatastore.getMessageIDsByFolderID(folderID);</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-            let delMsgsQueue = [[&quot;message&quot;, -1, msgId] for each</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-                                (msgId in messageIDs)];</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-            this._indexingFolderCount++;</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-            this._indexingMessageCount = 0;</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-            this._indexingMessageGoal = delMsgsQueue.length;</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-          }</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-          // Index a newly added message</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-          // [&quot;message&quot;, 1, folder ID, message key]</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-          else if ((itemType == &quot;message&quot;) &amp;&amp; (actionType &gt; 0)) {</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-            let folderID = item[2];</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-            let messageKey = item[3];</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-          }</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-          // Index a moved message (sadly basically adding for now)</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-          // [&quot;message&quot;, 0, folder ID, header message-id]</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-          else if ((itemType == &quot;message&quot;) &amp;&amp; (actionType === 0)) {</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-          </span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-          }</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-          // Delete a message that has gone away</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-          // [&quot;message&quot;, -1, message database ID]</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-          else if ((itemType == &quot;message&quot;) &amp;&amp; (actionType &lt; 0)) {</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-            let messageID = item[2];</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-            let message = GlodaDatastore.getMessageByID(messageID);</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-            if (message !== null)</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-              this._deleteMessage(message);</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+        </span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+        // perhaps status update</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+        if (job !== null) {</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+          if (job.offset % 50 == 0) {</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+            let actionStr;</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+            if (job.deltaType &gt; 0)</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+              actionStr = this._strBundle.getString(&quot;actionIndex&quot;);</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+            else if (job.deltaType == 0)</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+              actionStr = this._strBundle.getString(&quot;actionMoving&quot;);</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+            else</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+              actionStr = this._strBundle.getString(&quot;actionDeindexing&quot;);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+            let prettyName;</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+            if (this._indexingFolder !== null)</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+              prettyName = this._indexingFolder.prettiestName;</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+            else</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+              prettyName =</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+                this._strBundle.getString(&quot;messageIndexingExplanation&quot;);</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+            this._notifyListeners(actionStr + &quot;: &quot; +</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+                                  prettyName,</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+                                  prettyName,</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+                                  this._indexingJobCount,</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+                                  this._indexingJobGoal,</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+                                  job.offset,</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+                                  job.goal);</span>
<a href="#l3.500"></a><span id="l3.500">           }</span>
<a href="#l3.501"></a><span id="l3.501">         }</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-        else {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-          this._log.info(&quot;Done indexing, disabling timer renewal.&quot;);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-          this._indexingActive = false;</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-          this._indexingFolderCount = 0;</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-          this._indexingFolderGoal = 0;</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-          this._indexingMessageCount = 0;</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-          this._indexingMessageGoal = 0;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-          this._notifyListeners(&quot;Idle&quot;, null, 0, 1, 0, 1);</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-          break;</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-        }</span>
<a href="#l3.512"></a><span id="l3.512">       }</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-    </span>
<a href="#l3.514"></a><span id="l3.514">     }</span>
<a href="#l3.515"></a><span id="l3.515">     finally {</span>
<a href="#l3.516"></a><span id="l3.516">       GlodaDatastore._commitTransaction();</span>
<a href="#l3.517"></a><span id="l3.517">     </span>
<a href="#l3.518"></a><span id="l3.518">       if (this.indexing)</span>
<a href="#l3.519"></a><span id="l3.519">         this._domWindow.setTimeout(this._wrapIncrementalIndex, this._indexInterval,</span>
<a href="#l3.520"></a><span id="l3.520">                                 this);</span>
<a href="#l3.521"></a><span id="l3.521">     }</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineat">@@ -433,40 +588,47 @@ let GlodaIndexer = {</span>
<a href="#l3.523"></a><span id="l3.523">      *  try and index the message immediately, or hold onto a less specific</span>
<a href="#l3.524"></a><span id="l3.524">      *  form of message information than the nsIMsgDBHdr.  (If we were to</span>
<a href="#l3.525"></a><span id="l3.525">      *  process immediately, it might appropriate to consider having a</span>
<a href="#l3.526"></a><span id="l3.526">      *  transaction open that is commited by timer/sufficient activity, since it</span>
<a href="#l3.527"></a><span id="l3.527">      *  is conceivable we will see a number of these events in fairly rapid</span>
<a href="#l3.528"></a><span id="l3.528">      *  succession.)</span>
<a href="#l3.529"></a><span id="l3.529">      */</span>
<a href="#l3.530"></a><span id="l3.530">     msgAdded: function gloda_indexer_msgAdded(aMsgHdr) {</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-      this.indexer._indexQueue.push(</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-        [&quot;message&quot;, 1,</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-         GlodaDatastore._mapFolderURI(aMsgHdr.folder.URI),</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+      if (this.indexer._pendingAddJob === null) {</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+        this.indexer._pendingAddJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+        this.indexer._indexQueue.push(this._pendingAddJob);</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+        this.indexer._indexingJobGoal++;</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+      }</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+      this.indexer._pendingAddJob.items.push(</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+        [GlodaDatastore._mapFolderURI(aMsgHdr.folder.URI),</span>
<a href="#l3.541"></a><span id="l3.541">          aMsgHdr.messageKey]);</span>
<a href="#l3.542"></a><span id="l3.542">       this.indexer.indexing = true; </span>
<a href="#l3.543"></a><span id="l3.543">     },</span>
<a href="#l3.544"></a><span id="l3.544">     </span>
<a href="#l3.545"></a><span id="l3.545">     /**</span>
<a href="#l3.546"></a><span id="l3.546">      * Handle real, actual deletion (move to trash and IMAP deletion model</span>
<a href="#l3.547"></a><span id="l3.547">      *  don't count; we only see the deletion here when it becomes forever,</span>
<a href="#l3.548"></a><span id="l3.548">      *  or rather _just before_ it becomes forever.  Because the header is</span>
<a href="#l3.549"></a><span id="l3.549">      *  going away, we need to either process things immediately or extract the</span>
<a href="#l3.550"></a><span id="l3.550">      *  information required to purge it later without the header.</span>
<a href="#l3.551"></a><span id="l3.551">      *</span>
<a href="#l3.552"></a><span id="l3.552">      * We opt to process all of the headers immediately, inside a transaction.</span>
<a href="#l3.553"></a><span id="l3.553">      *  We do this because deletions may actually be a batch deletion of many,</span>
<a href="#l3.554"></a><span id="l3.554">      *  many messages, which could be a lot to queue</span>
<a href="#l3.555"></a><span id="l3.555">      */</span>
<a href="#l3.556"></a><span id="l3.556">     msgsDeleted: function gloda_indexer_msgsDeleted(aMsgHdrs) {</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-      // TODO progress indicator for here</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+      let deleteJob = new IndexingJob(&quot;message&quot;, -1, null);</span>
<a href="#l3.559"></a><span id="l3.559">       for (let iMsgHdr=0; iMsgHdr &lt; aMsgHdrs.length; iMsgHdr++) {</span>
<a href="#l3.560"></a><span id="l3.560">         let msgHdr = aMsgHdrs.queryElementAt(iMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-        this.indexer._indexQueue.push([&quot;message&quot;, -1, msgHdr]);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+        deleteJob.items.push([GlodaDatastore._mapFolderURI(msgHdr.folder.URI),</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+                              msgHdr.messageKey]);</span>
<a href="#l3.564"></a><span id="l3.564">       }</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+      this.indexer._indexQueue.push(deleteJob);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+      this.indexer._indexingJobGoal++;</span>
<a href="#l3.567"></a><span id="l3.567">       this.indexer.indexing = true;</span>
<a href="#l3.568"></a><span id="l3.568">     },</span>
<a href="#l3.569"></a><span id="l3.569">     </span>
<a href="#l3.570"></a><span id="l3.570">     /**</span>
<a href="#l3.571"></a><span id="l3.571">      * Process a move or copy.  Copies are treated as additions and accordingly</span>
<a href="#l3.572"></a><span id="l3.572">      *  queued for subsequent indexing.  Moves are annoying in that, in theory,</span>
<a href="#l3.573"></a><span id="l3.573">      *  we should be able to just alter the location information and be done</span>
<a href="#l3.574"></a><span id="l3.574">      *  with it.  Unfortunately, we have no clue what the messageKey is for</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineat">@@ -480,48 +642,65 @@ let GlodaIndexer = {</span>
<a href="#l3.576"></a><span id="l3.576">      *     has enough information to try and give this a whirl, but it's not</span>
<a href="#l3.577"></a><span id="l3.577">      *     foolproof, hence not done and this issue yet to-do.  </span>
<a href="#l3.578"></a><span id="l3.578">      */</span>
<a href="#l3.579"></a><span id="l3.579">     msgsMoveCopyCompleted: function gloda_indexer_msgsMoveCopyCompleted(aMove,</span>
<a href="#l3.580"></a><span id="l3.580">                              aSrcMsgHdrs, aDestFolder) {</span>
<a href="#l3.581"></a><span id="l3.581">       if (aMove) {</span>
<a href="#l3.582"></a><span id="l3.582">         let srcFolder = aSrcMsgHdrs.queryElementAt(0, Ci.nsIMsgDBHdr).folder;</span>
<a href="#l3.583"></a><span id="l3.583">         let messageKeys = [msgHdr.messageKey for each</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-                           (msgHdr in fixIterator(aSrcMsgHdrs, Ci.nsIMsgDBHdr)];</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+                          (msgHdr in fixIterator(aSrcMsgHdrs, Ci.nsIMsgDBHdr))];</span>
<a href="#l3.586"></a><span id="l3.586">         // quickly move them to the right folder, zeroing their message keys</span>
<a href="#l3.587"></a><span id="l3.587">         GlodaDatastore.updateMessageFoldersByKeyPurging(srcFolder.URI,</span>
<a href="#l3.588"></a><span id="l3.588">                                                         messageKeys,</span>
<a href="#l3.589"></a><span id="l3.589">                                                         aDestFolder.URI);</span>
<a href="#l3.590"></a><span id="l3.590">         // and now let us queue the re-indexings...</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+        let reindexJob = new IndexingJob(&quot;message&quot;, 0, null);</span>
<a href="#l3.592"></a><span id="l3.592">         for (let iSrcMsgHdr=0; iSrcMsgHdrs &lt; aSrcMsgHdrs.length; iSrcMsgHdr++) {</span>
<a href="#l3.593"></a><span id="l3.593">           let msgHdr = aSrcMsgHdrs.queryElementAt(iSrcMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-          this.indexer._indexQueue.push([&quot;message&quot;, 0,</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-            GlodaDatastore._mapFolderURI(msgHdr.folder.URI), msgHdr.messageId]);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+          reindexJob.items.push(</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+            [GlodaDatastore._mapFolderURI(msgHdr.folder.URI),</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+             msgHdr.messageId]);</span>
<a href="#l3.599"></a><span id="l3.599">         }</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-        // TODO progress indicator for here, also indexing flag        </span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+        this.indexer._indexQueue.push(reindexJob);</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+        this.indexer.indexingJobGoal++;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+        this.indexer.indexing = true;</span>
<a href="#l3.604"></a><span id="l3.604">       }</span>
<a href="#l3.605"></a><span id="l3.605">       else {</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-        // TODO progress indicator for here, also indexing flag</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+        let copyIndexJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+</span>
<a href="#l3.609"></a><span id="l3.609">         for (let iSrcMsgHdr=0; iSrcMsgHdrs &lt; aSrcMsgHdrs.length; iSrcMsgHdr++) {</span>
<a href="#l3.610"></a><span id="l3.610">           let msgHdr = aSrcMsgHdrs.queryElementAt(iSrcMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-          this.indexer._indexQueue.push([&quot;message&quot;, 1,</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+          copyIndexJob.items.push([</span>
<a href="#l3.613"></a><span id="l3.613">             GlodaDatastore._mapFolderURI(msgHdr.folder.URI),</span>
<a href="#l3.614"></a><span id="l3.614">             msgHdr.messageKey]);</span>
<a href="#l3.615"></a><span id="l3.615">         }</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+        this.indexer._indexingJobGoal++;</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+        this.indexer._indexQueue.push(copyIndexJob);</span>
<a href="#l3.619"></a><span id="l3.619">       }</span>
<a href="#l3.620"></a><span id="l3.620">     },</span>
<a href="#l3.621"></a><span id="l3.621">     </span>
<a href="#l3.622"></a><span id="l3.622">     /**</span>
<a href="#l3.623"></a><span id="l3.623">      * Handles folder no-longer-exists-ence.  We want to delete all messages</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-     *  located in the folder.</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+     *  located in the folder and then kill the URI/id.  To this end we create</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+     *  two jobs.  One kills all the messages, and one actually deletes the</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+     *  URI/id.</span>
<a href="#l3.628"></a><span id="l3.628">      */</span>
<a href="#l3.629"></a><span id="l3.629">     folderDeleted: function gloda_indexer_folderDeleted(aFolder) {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-      this._indexingFolderGoal++;</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-      this.indexer._indexQueue.push([&quot;folder&quot;, -1,</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-        GlodaDatastore._mapFolderURI(aFolder.URI)]);</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+      let folderID = GlodaDatastore._mapFolderURI(aFolder.URI);</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+      </span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+      let messageJob = new IndexingJob(&quot;message&quot;, -1, null);</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+      messageJob.items = GlodaDatastore.getMessageIDsByFolderID(folderID);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+      this.indexer._indexQueue.push(messageJob);</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+      </span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+      let folderJob = new IndexingJob(&quot;folder&quot;, -1, folderID);</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+      this.indexer._indexQueue.push(folderJob);</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+      this._indexingJobGoal += 2;</span>
<a href="#l3.643"></a><span id="l3.643">       this.indexing = true;</span>
<a href="#l3.644"></a><span id="l3.644">     },</span>
<a href="#l3.645"></a><span id="l3.645">     </span>
<a href="#l3.646"></a><span id="l3.646">     /**</span>
<a href="#l3.647"></a><span id="l3.647">      * Handle a folder being copied.  I do not believe the MailNews code is</span>
<a href="#l3.648"></a><span id="l3.648">      *  capable of generating a case where aMove is true, but just in case we'll</span>
<a href="#l3.649"></a><span id="l3.649">      *  dispatch to our sibling method, folderRenamed.</span>
<a href="#l3.650"></a><span id="l3.650">      *</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineat">@@ -562,19 +741,20 @@ let GlodaIndexer = {</span>
<a href="#l3.652"></a><span id="l3.652">    *  underlying database is going away.  We use other means for detecting </span>
<a href="#l3.653"></a><span id="l3.653">    *  modifications of the message (labeling, marked (un)read, starred, etc.)</span>
<a href="#l3.654"></a><span id="l3.654">    *</span>
<a href="#l3.655"></a><span id="l3.655">    * This is an nsIDBChangeListener listening to an nsIDBChangeAnnouncer.  To</span>
<a href="#l3.656"></a><span id="l3.656">    *  add ourselves, we get us a nice nsMsgDatabase, query it to the announcer,</span>
<a href="#l3.657"></a><span id="l3.657">    *  then call AddListener.</span>
<a href="#l3.658"></a><span id="l3.658">    */</span>
<a href="#l3.659"></a><span id="l3.659">   _databaseAnnouncerListener: {</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+    indexer: null,</span>
<a href="#l3.661"></a><span id="l3.661">     onAnnouncerGoingAway: function gloda_indexer_dbGoingAway(</span>
<a href="#l3.662"></a><span id="l3.662">                                          aDBChangeAnnouncer) {</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-      // TODO: work</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+      this.indexer._indexerLeaveFolder(false);</span>
<a href="#l3.665"></a><span id="l3.665">     },</span>
<a href="#l3.666"></a><span id="l3.666">     </span>
<a href="#l3.667"></a><span id="l3.667">     onHdrChange: function(aHdrChanged, aOldFlags, aNewFlags, aInstigator) {},</span>
<a href="#l3.668"></a><span id="l3.668">     onHdrDeleted: function(aHdrChanged, aParentKey, aFlags, aInstigator) {},</span>
<a href="#l3.669"></a><span id="l3.669">     onHdrAdded: function(aHdrChanged, aParentKey, aFlags, aInstigator) {},</span>
<a href="#l3.670"></a><span id="l3.670">     onParentChanged: function(aKeyChanged, aOldParent, aNewParent, </span>
<a href="#l3.671"></a><span id="l3.671">                               aInstigator) {},</span>
<a href="#l3.672"></a><span id="l3.672">     onReadChanged: function(aInstigator) {},</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineat">@@ -589,17 +769,17 @@ let GlodaIndexer = {</span>
<a href="#l3.674"></a><span id="l3.674">    *</span>
<a href="#l3.675"></a><span id="l3.675">    * We implement nsIMsgShutdownTask, served up by nsIMsgShutdownService.  We</span>
<a href="#l3.676"></a><span id="l3.676">    *  offer our services by registering ourselves as a &quot;msg-shutdown&quot; observer</span>
<a href="#l3.677"></a><span id="l3.677">    *  with the observer service.</span>
<a href="#l3.678"></a><span id="l3.678">    */</span>
<a href="#l3.679"></a><span id="l3.679">   _shutdownTask: {</span>
<a href="#l3.680"></a><span id="l3.680">     indexer: null,</span>
<a href="#l3.681"></a><span id="l3.681">     </span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-    get needsToRunTask {</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+    get needsToRunTask() {</span>
<a href="#l3.684"></a><span id="l3.684">       return this.indexer.indexing;</span>
<a href="#l3.685"></a><span id="l3.685">     },</span>
<a href="#l3.686"></a><span id="l3.686">     </span>
<a href="#l3.687"></a><span id="l3.687">     /**</span>
<a href="#l3.688"></a><span id="l3.688">      * So we could either go all out finishing our indexing, or write down what</span>
<a href="#l3.689"></a><span id="l3.689">      *  we need to index next time around.  For now, we opt to complete our</span>
<a href="#l3.690"></a><span id="l3.690">      *  indexing since it greatly simplifies our lives, but it probably would</span>
<a href="#l3.691"></a><span id="l3.691">      *  be friendly to simply persist our state.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

