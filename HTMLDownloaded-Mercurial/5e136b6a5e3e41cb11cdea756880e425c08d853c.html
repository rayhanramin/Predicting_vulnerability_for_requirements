<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20079:5e136b6a5e3e41cb11cdea756880e425c08d853c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5e136b6a5e3e41cb11cdea756880e425c08d853c" />
<meta property="og:url" content="/comm-central/rev/5e136b6a5e3e41cb11cdea756880e425c08d853c" />
<meta property="og:description" content="Bug 1280898 - Set up eslint for calendar files - enable func-names rule. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5e136b6a5e3e41cb11cdea756880e425c08d853c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5e136b6a5e3e41cb11cdea756880e425c08d853c">shortlog</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5e136b6a5e3e41cb11cdea756880e425c08d853c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c">files</a> |
changeset |
<a href="/comm-central/raw-rev/5e136b6a5e3e41cb11cdea756880e425c08d853c">raw</a>  | <a href="/comm-central/archive/5e136b6a5e3e41cb11cdea756880e425c08d853c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable func-names rule. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#101;&#115;&#108;&#105;&#110;&#116;&#32;&#60;&#101;&#115;&#108;&#105;&#110;&#116;&#64;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#46;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 08 Jul 2016 14:09:04 +0200</td></tr>

<tr>
 <td>changeset 20079</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5e136b6a5e3e41cb11cdea756880e425c08d853c">5e136b6a5e3e41cb11cdea756880e425c08d853c</a></td>
</tr>



<tr>
<td>parent 20078</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a53c49ed8ab37da97d6a5fc6f660efd9841a259b">a53c49ed8ab37da97d6a5fc6f660efd9841a259b</a>
</td>
</tr>

<tr>
<td>child 20080</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/289338a394d31814b30269ba6752035e303e04a3">289338a394d31814b30269ba6752035e303e04a3</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5e136b6a5e3e41cb11cdea756880e425c08d853c">12309</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 17 Sep 2016 23:27:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5e136b6a5e3e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5e136b6a5e3e41cb11cdea756880e425c08d853c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5e136b6a5e3e41cb11cdea756880e425c08d853c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e136b6a5e3e41cb11cdea756880e425c08d853c&newProject=comm-central&newRevision=7e687a2148febd47826bef8a486c1d7697287526&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e136b6a5e3e41cb11cdea756880e425c08d853c&newProject=comm-central&newRevision=7e687a2148febd47826bef8a486c1d7697287526&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e136b6a5e3e41cb11cdea756880e425c08d853c&newProject=comm-central&newRevision=7e687a2148febd47826bef8a486c1d7697287526&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">1280898</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable func-names rule. r=MakeMyDay

MozReview-Commit-ID: DgsK9FXLRFz</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/.eslintrc">calendar/.eslintrc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/.eslintrc">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/.eslintrc">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/.eslintrc">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/.eslintrc">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/.eslintrc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/calBackendLoader.js">calendar/base/backend/calBackendLoader.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/calBackendLoader.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/calBackendLoader.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/calBackendLoader.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/calBackendLoader.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/calBackendLoader.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService-worker.js">calendar/base/backend/icaljs/calICSService-worker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService-worker.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService-worker.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService-worker.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService-worker.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService-worker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-extract.js">calendar/base/content/calendar-extract.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-extract.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-extract.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-extract.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-extract.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-extract.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-menus.xml">calendar/base/content/calendar-menus.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-menus.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-menus.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-menus.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-menus.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-menus.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-statusbar.js">calendar/base/content/calendar-statusbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-statusbar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-statusbar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-statusbar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-statusbar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-statusbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.xml">calendar/base/content/calendar-views.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/calendar-views.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-alarm-dialog.js">calendar/base/content/dialogs/calendar-alarm-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-alarm-dialog.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-alarm-dialog.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-alarm-dialog.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-alarm-dialog.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-alarm-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-invitations-dialog.js">calendar/base/content/dialogs/calendar-invitations-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-invitations-dialog.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-invitations-dialog.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-invitations-dialog.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-invitations-dialog.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-invitations-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">calendar/base/content/dialogs/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/alarms.js">calendar/base/content/preferences/alarms.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/alarms.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/alarms.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/alarms.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/alarms.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/alarms.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/categories.js">calendar/base/content/preferences/categories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/categories.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/categories.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/categories.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/categories.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/categories.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/views.js">calendar/base/content/preferences/views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/views.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/views.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/views.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/views.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/preferences/views.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/today-pane.js">calendar/base/content/today-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/today-pane.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/today-pane.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/today-pane.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/today-pane.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/today-pane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAuthUtils.jsm">calendar/base/modules/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calExtract.jsm">calendar/base/modules/calExtract.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calExtract.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calExtract.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calExtract.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calExtract.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calExtract.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calHashedArray.jsm">calendar/base/modules/calHashedArray.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calHashedArray.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calHashedArray.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calHashedArray.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calHashedArray.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calHashedArray.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItemUtils.jsm">calendar/base/modules/calItemUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItemUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItemUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItemUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItemUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItemUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calIteratorUtils.jsm">calendar/base/modules/calIteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calIteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calIteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calIteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calIteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calIteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calPrintUtils.jsm">calendar/base/modules/calPrintUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calPrintUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calPrintUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calPrintUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calPrintUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calPrintUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calXMLUtils.jsm">calendar/base/modules/calXMLUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calXMLUtils.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calXMLUtils.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calXMLUtils.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calXMLUtils.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/modules/calXMLUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmMonitor.js">calendar/base/src/calAlarmMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmMonitor.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmMonitor.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmMonitor.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmMonitor.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarSearchService.js">calendar/base/src/calCalendarSearchService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarSearchService.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarSearchService.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarSearchService.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarSearchService.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calCalendarSearchService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDefaultACLManager.js">calendar/base/src/calDefaultACLManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDefaultACLManager.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDefaultACLManager.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDefaultACLManager.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDefaultACLManager.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDefaultACLManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDeletedItems.js">calendar/base/src/calDeletedItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDeletedItems.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDeletedItems.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDeletedItems.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDeletedItems.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calDeletedItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFilter.js">calendar/base/src/calFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFilter.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFilter.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFilter.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFilter.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFreeBusyService.js">calendar/base/src/calFreeBusyService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFreeBusyService.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFreeBusyService.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFreeBusyService.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFreeBusyService.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calFreeBusyService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsSerializer.js">calendar/base/src/calIcsSerializer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsSerializer.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsSerializer.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsSerializer.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsSerializer.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calIcsSerializer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calProtocolHandler.js">calendar/base/src/calProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceDate.js">calendar/base/src/calRecurrenceDate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceDate.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceDate.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceDate.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceDate.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceDate.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRelation.js">calendar/base/src/calRelation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRelation.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRelation.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRelation.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRelation.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calRelation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calSleepMonitor.js">calendar/base/src/calSleepMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calSleepMonitor.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calSleepMonitor.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calSleepMonitor.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calSleepMonitor.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calSleepMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calStartupService.js">calendar/base/src/calStartupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calStartupService.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calStartupService.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calStartupService.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calStartupService.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calStartupService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezone.js">calendar/base/src/calTimezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezone.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezone.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezone.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezone.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezone.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calHtmlExport.js">calendar/import-export/calHtmlExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calHtmlExport.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calHtmlExport.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calHtmlExport.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calHtmlExport.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calHtmlExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calIcsImportExport.js">calendar/import-export/calIcsImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calIcsImportExport.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calIcsImportExport.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calIcsImportExport.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calIcsImportExport.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calIcsImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calListFormatter.js">calendar/import-export/calListFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calListFormatter.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calListFormatter.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calListFormatter.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calListFormatter.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calListFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calMonthGridPrinter.js">calendar/import-export/calMonthGridPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calMonthGridPrinter.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calMonthGridPrinter.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calMonthGridPrinter.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calMonthGridPrinter.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calMonthGridPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calOutlookCSVImportExport.js">calendar/import-export/calOutlookCSVImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calOutlookCSVImportExport.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calOutlookCSVImportExport.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calOutlookCSVImportExport.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calOutlookCSVImportExport.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calOutlookCSVImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calWeekPrinter.js">calendar/import-export/calWeekPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calWeekPrinter.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calWeekPrinter.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calWeekPrinter.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calWeekPrinter.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/import-export/calWeekPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-creation.js">calendar/lightning/content/lightning-calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-creation.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-creation.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-properties.js">calendar/lightning/content/lightning-calendar-properties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-properties.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-properties.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-properties.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-properties.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-calendar-properties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-preferences.js">calendar/lightning/content/messenger-overlay-preferences.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-preferences.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-preferences.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-preferences.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-preferences.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-preferences.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/suite-overlay-sidebar.js">calendar/lightning/content/suite-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/suite-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/suite-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/suite-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/suite-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/lightning/content/suite-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/.eslintrc">calendar/test/unit/.eslintrc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/.eslintrc">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/.eslintrc">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/.eslintrc">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/.eslintrc">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/.eslintrc">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_alarmservice.js">calendar/test/unit/test_alarmservice.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_alarmservice.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_alarmservice.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_alarmservice.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_alarmservice.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_alarmservice.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_bug494140.js">calendar/test/unit/test_bug494140.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_bug494140.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_bug494140.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_bug494140.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_bug494140.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_bug494140.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_calmgr.js">calendar/test/unit/test_calmgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_calmgr.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_calmgr.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_calmgr.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_calmgr.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_calmgr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_deleted_items.js">calendar/test/unit/test_deleted_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_deleted_items.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_deleted_items.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_deleted_items.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_deleted_items.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_deleted_items.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_ics.js">calendar/test/unit/test_ics.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_ics.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_ics.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_ics.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_ics.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_ics.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_storage.js">calendar/test/unit/test_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_storage.js">file</a> |
<a href="/comm-central/annotate/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_storage.js">annotate</a> |
<a href="/comm-central/diff/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_storage.js">diff</a> |
<a href="/comm-central/comparison/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_storage.js">comparison</a> |
<a href="/comm-central/log/5e136b6a5e3e41cb11cdea756880e425c08d853c/calendar/test/unit/test_storage.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/.eslintrc</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/.eslintrc</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -383,13 +383,16 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &quot;consistent-this&quot;: [2, &quot;self&quot;],</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     // Disallow unnecessary .call() and .apply()</span>
<a href="#l1.7"></a><span id="l1.7">     &quot;no-useless-call&quot;: 2,</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     // Require dot notation when accessing properties</span>
<a href="#l1.10"></a><span id="l1.10">     &quot;dot-notation&quot;: 2,</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    // Disallow named function expressions</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &quot;func-names&quot;: [2, &quot;never&quot;],</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15">     // The following rules will not be enabled currently, but are kept here for</span>
<a href="#l1.16"></a><span id="l1.16">     // easier updates in the future.</span>
<a href="#l1.17"></a><span id="l1.17">     &quot;no-else-return&quot;: 0,</span>
<a href="#l1.18"></a><span id="l1.18">   }</span>
<a href="#l1.19"></a><span id="l1.19"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/calBackendLoader.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/calBackendLoader.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -28,17 +28,17 @@ calBackendLoader.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">     }),</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">     loaded: false,</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     observe: function() {</span>
<a href="#l2.9"></a><span id="l2.9">         // Nothing to do here, just need the entry so this is instanciated</span>
<a href="#l2.10"></a><span id="l2.10">     },</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    loadBackend: function loadBackend() {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    loadBackend: function() {</span>
<a href="#l2.14"></a><span id="l2.14">         if (this.loaded) {</span>
<a href="#l2.15"></a><span id="l2.15">             return;</span>
<a href="#l2.16"></a><span id="l2.16">         }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">         let backend = Services.prefs.getBoolPref(&quot;calendar.icaljs&quot;) ? &quot;icaljs&quot; : &quot;libical&quot;;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">         let uri = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l2.21"></a><span id="l2.21">                           .QueryInterface(Components.interfaces.nsIResProtocolHandler)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService-worker.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService-worker.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * ChromeWorker for parseICSAsync method in calICSService.js</span>
<a href="#l3.5"></a><span id="l3.5">  */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> var NS_OK = 0;</span>
<a href="#l3.8"></a><span id="l3.8"> var NS_ERROR_FAILURE = 2147500037;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> importScripts(&quot;resource://calendar/modules/ical.js&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-onmessage = function onmessage(event) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+onmessage = function(event) {</span>
<a href="#l3.14"></a><span id="l3.14">     try {</span>
<a href="#l3.15"></a><span id="l3.15">         let comp = ICAL.parse(event.data);</span>
<a href="#l3.16"></a><span id="l3.16">         postMessage({ rc: NS_OK, data: comp });</span>
<a href="#l3.17"></a><span id="l3.17">     } catch (e) {</span>
<a href="#l3.18"></a><span id="l3.18">         postMessage({ rc: NS_ERROR_FAILURE, data: &quot;Exception occurred: &quot; + e });</span>
<a href="#l3.19"></a><span id="l3.19">     }</span>
<a href="#l3.20"></a><span id="l3.20">     close();</span>
<a href="#l3.21"></a><span id="l3.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -349,17 +349,17 @@ calIcalComponent.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">     addSubcomponent: function(comp) {</span>
<a href="#l4.6"></a><span id="l4.6">         comp.getReferencedTimezones({}).forEach(this.addTimezoneReference, this);</span>
<a href="#l4.7"></a><span id="l4.7">         let jscomp = unwrapSingle(ICAL.Component, comp);</span>
<a href="#l4.8"></a><span id="l4.8">         this.innerObject.addSubcomponent(jscomp);</span>
<a href="#l4.9"></a><span id="l4.9">     },</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">     propertyIterator: null,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    getFirstProperty: function getFirstProperty(kind) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    getFirstProperty: function(kind) {</span>
<a href="#l4.14"></a><span id="l4.14">         if (kind == &quot;ANY&quot;) {</span>
<a href="#l4.15"></a><span id="l4.15">             kind = null;</span>
<a href="#l4.16"></a><span id="l4.16">         } else if (kind) {</span>
<a href="#l4.17"></a><span id="l4.17">             kind = kind.toLowerCase();</span>
<a href="#l4.18"></a><span id="l4.18">         }</span>
<a href="#l4.19"></a><span id="l4.19">         let innerObject = this.innerObject;</span>
<a href="#l4.20"></a><span id="l4.20">         this.propertyIterator = (function* () {</span>
<a href="#l4.21"></a><span id="l4.21">             let props = innerObject.getAllProperties(kind);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -382,17 +382,17 @@ calIcalComponent.prototype = {</span>
<a href="#l4.23"></a><span id="l4.23">                     yield new calIcalProperty(prop);</span>
<a href="#l4.24"></a><span id="l4.24">                 }</span>
<a href="#l4.25"></a><span id="l4.25">             }</span>
<a href="#l4.26"></a><span id="l4.26">         })();</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">         return this.getNextProperty(kind);</span>
<a href="#l4.29"></a><span id="l4.29">     },</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    getNextProperty: function getNextProperty(kind) {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    getNextProperty: function(kind) {</span>
<a href="#l4.33"></a><span id="l4.33">         if (this.propertyIterator) {</span>
<a href="#l4.34"></a><span id="l4.34">             let next = this.propertyIterator.next();</span>
<a href="#l4.35"></a><span id="l4.35">             if (next.done) {</span>
<a href="#l4.36"></a><span id="l4.36">                 this.propertyIterator = null;</span>
<a href="#l4.37"></a><span id="l4.37">             }</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">             return next.value;</span>
<a href="#l4.40"></a><span id="l4.40">         } else {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -462,24 +462,24 @@ calICSService.prototype = {</span>
<a href="#l4.42"></a><span id="l4.42">     classID: calICSServiceClassID,</span>
<a href="#l4.43"></a><span id="l4.43">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l4.44"></a><span id="l4.44">         contractID: &quot;@mozilla.org/calendar/ics-service;1&quot;,</span>
<a href="#l4.45"></a><span id="l4.45">         classDescription: &quot;ICS component and property service&quot;,</span>
<a href="#l4.46"></a><span id="l4.46">         classID: calICSServiceClassID,</span>
<a href="#l4.47"></a><span id="l4.47">         interfaces: [Components.interfaces.calIICSService]</span>
<a href="#l4.48"></a><span id="l4.48">     }),</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    parseICS: function parseICS(serialized, tzProvider) {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    parseICS: function(serialized, tzProvider) {</span>
<a href="#l4.52"></a><span id="l4.52">         // TODO ical.js doesn't support tz providers, but this is usually null</span>
<a href="#l4.53"></a><span id="l4.53">         // or our timezone service anyway.</span>
<a href="#l4.54"></a><span id="l4.54">         let comp = ICAL.parse(serialized);</span>
<a href="#l4.55"></a><span id="l4.55">         return new calIcalComponent(new ICAL.Component(comp));</span>
<a href="#l4.56"></a><span id="l4.56">     },</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-    parseICSAsync: function parseICSAsync(serialized, tzProvider, listener) {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    parseICSAsync: function(serialized, tzProvider, listener) {</span>
<a href="#l4.60"></a><span id="l4.60">         // There are way too many error checking messages here, but I had so</span>
<a href="#l4.61"></a><span id="l4.61">         // much pain with this method that I don't want it to break again.</span>
<a href="#l4.62"></a><span id="l4.62">         try {</span>
<a href="#l4.63"></a><span id="l4.63">             let worker = new ChromeWorker(&quot;resource://calendar/calendar-js/calICSService-worker.js&quot;);</span>
<a href="#l4.64"></a><span id="l4.64">             worker.onmessage = function(event) {</span>
<a href="#l4.65"></a><span id="l4.65">                 let rc = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.66"></a><span id="l4.66">                 let icalComp = null;</span>
<a href="#l4.67"></a><span id="l4.67">                 try {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineat">@@ -501,20 +501,20 @@ calICSService.prototype = {</span>
<a href="#l4.69"></a><span id="l4.69">             worker.postMessage(serialized);</span>
<a href="#l4.70"></a><span id="l4.70">         } catch (e) {</span>
<a href="#l4.71"></a><span id="l4.71">             // If an error occurs above, the calling code will hang. Catch the exception just in case</span>
<a href="#l4.72"></a><span id="l4.72">             cal.ERROR(&quot;[calICSService] Error starting parsing worker: &quot; + e);</span>
<a href="#l4.73"></a><span id="l4.73">             listener.onParsingComplete(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l4.74"></a><span id="l4.74">         }</span>
<a href="#l4.75"></a><span id="l4.75">     },</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    createIcalComponent: function createIcalComponent(kind) {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+    createIcalComponent: function(kind) {</span>
<a href="#l4.79"></a><span id="l4.79">         return new calIcalComponent(new ICAL.Component(kind.toLowerCase()));</span>
<a href="#l4.80"></a><span id="l4.80">     },</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-    createIcalProperty: function createIcalProperty(kind) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+    createIcalProperty: function(kind) {</span>
<a href="#l4.84"></a><span id="l4.84">         return new calIcalProperty(new ICAL.Property(kind.toLowerCase()));</span>
<a href="#l4.85"></a><span id="l4.85">     },</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87">     createIcalPropertyFromString: function(str) {</span>
<a href="#l4.88"></a><span id="l4.88">         return new calIcalProperty(ICAL.Property.fromString(str.trim(), ICAL.design.icalendar));</span>
<a href="#l4.89"></a><span id="l4.89">     }</span>
<a href="#l4.90"></a><span id="l4.90"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -18,58 +18,56 @@ var agendaListbox = {</span>
<a href="#l5.4"></a><span id="l5.4">     kDefaultTimezone: null,</span>
<a href="#l5.5"></a><span id="l5.5">     showsToday: false,</span>
<a href="#l5.6"></a><span id="l5.6">     soonDays: 5</span>
<a href="#l5.7"></a><span id="l5.7"> };</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> /**</span>
<a href="#l5.10"></a><span id="l5.10">  * Initialize the agenda listbox, used on window load.</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-agendaListbox.init =</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-function initAgendaListbox() {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+agendaListbox.init = function() {</span>
<a href="#l5.15"></a><span id="l5.15">     this.agendaListboxControl = document.getElementById(&quot;agenda-listbox&quot;);</span>
<a href="#l5.16"></a><span id="l5.16">     this.agendaListboxControl.removeAttribute(&quot;suppressonselect&quot;);</span>
<a href="#l5.17"></a><span id="l5.17">     let showTodayHeader = (document.getElementById(&quot;today-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l5.18"></a><span id="l5.18">     let showTomorrowHeader = (document.getElementById(&quot;tomorrow-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l5.19"></a><span id="l5.19">     let showSoonHeader = (document.getElementById(&quot;nextweek-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l5.20"></a><span id="l5.20">     this.today = new Synthetic(showTodayHeader, 1, false);</span>
<a href="#l5.21"></a><span id="l5.21">     this.addPeriodListItem(this.today, &quot;today-header&quot;);</span>
<a href="#l5.22"></a><span id="l5.22">     this.tomorrow = new Synthetic(showTomorrowHeader, 1, false);</span>
<a href="#l5.23"></a><span id="l5.23">     this.soonDays = getSoondaysPreference();</span>
<a href="#l5.24"></a><span id="l5.24">     this.soon = new Synthetic(showSoonHeader, this.soonDays, true);</span>
<a href="#l5.25"></a><span id="l5.25">     this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l5.26"></a><span id="l5.26">     this.mPendingRefreshJobs = new Map();</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">     let prefObserver = {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-        observe: function aL_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+        observe: function(aSubject, aTopic, aPrefName) {</span>
<a href="#l5.31"></a><span id="l5.31">             switch (aPrefName) {</span>
<a href="#l5.32"></a><span id="l5.32">                 case &quot;calendar.agendaListbox.soondays&quot;:</span>
<a href="#l5.33"></a><span id="l5.33">                     agendaListbox.soonDays = getSoondaysPreference();</span>
<a href="#l5.34"></a><span id="l5.34">                     agendaListbox.updateSoonSection();</span>
<a href="#l5.35"></a><span id="l5.35">                     break;</span>
<a href="#l5.36"></a><span id="l5.36">             }</span>
<a href="#l5.37"></a><span id="l5.37">         }</span>
<a href="#l5.38"></a><span id="l5.38">     };</span>
<a href="#l5.39"></a><span id="l5.39">     Services.prefs.addObserver(&quot;calendar.agendaListbox&quot;, prefObserver, false);</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">     // Make sure the agenda listbox is unloaded</span>
<a href="#l5.42"></a><span id="l5.42">     let self = this;</span>
<a href="#l5.43"></a><span id="l5.43">     window.addEventListener(&quot;unload&quot;,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                            function unload_agendaListbox() {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                            function() {</span>
<a href="#l5.46"></a><span id="l5.46">                                 Services.prefs.removeObserver(&quot;calendar.agendaListbox&quot;, prefObserver);</span>
<a href="#l5.47"></a><span id="l5.47">                                 self.uninit();</span>
<a href="#l5.48"></a><span id="l5.48">                             },</span>
<a href="#l5.49"></a><span id="l5.49">                             false);</span>
<a href="#l5.50"></a><span id="l5.50"> };</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> /**</span>
<a href="#l5.53"></a><span id="l5.53">  * Clean up the agenda listbox, used on window unload.</span>
<a href="#l5.54"></a><span id="l5.54">  */</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-agendaListbox.uninit =</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-function uninit() {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+agendaListbox.uninit = function() {</span>
<a href="#l5.58"></a><span id="l5.58">     if (this.calendar) {</span>
<a href="#l5.59"></a><span id="l5.59">         this.calendar.removeObserver(this.calendarObserver);</span>
<a href="#l5.60"></a><span id="l5.60">     }</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">     for (let period of this.periods) {</span>
<a href="#l5.63"></a><span id="l5.63">         if (period.listItem) {</span>
<a href="#l5.64"></a><span id="l5.64">             period.listItem.getCheckbox()</span>
<a href="#l5.65"></a><span id="l5.65">                   .removeEventListener(&quot;CheckboxStateChange&quot;,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -83,47 +81,44 @@ function uninit() {</span>
<a href="#l5.67"></a><span id="l5.67">  * Adds a period item to the listbox. This is a section of the today pane like</span>
<a href="#l5.68"></a><span id="l5.68">  * &quot;Today&quot;, &quot;Tomorrow&quot;, and is usually a &lt;agenda-checkbox-richlist-item&gt; tag. A</span>
<a href="#l5.69"></a><span id="l5.69">  * copy of the template node is made and added to the agenda listbox.</span>
<a href="#l5.70"></a><span id="l5.70">  *</span>
<a href="#l5.71"></a><span id="l5.71">  * @param aPeriod       The period item to add.</span>
<a href="#l5.72"></a><span id="l5.72">  * @param aItemId       The id of an &lt;agenda-checkbox-richlist-item&gt; to add to,</span>
<a href="#l5.73"></a><span id="l5.73">  *                        without the &quot;-hidden&quot; suffix.</span>
<a href="#l5.74"></a><span id="l5.74">  */</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-agendaListbox.addPeriodListItem =</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-function addPeriodListItem(aPeriod, aItemId) {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+agendaListbox.addPeriodListItem = function(aPeriod, aItemId) {</span>
<a href="#l5.78"></a><span id="l5.78">     aPeriod.listItem = document.getElementById(aItemId + &quot;-hidden&quot;).cloneNode(true);</span>
<a href="#l5.79"></a><span id="l5.79">     agendaListbox.agendaListboxControl.appendChild(aPeriod.listItem);</span>
<a href="#l5.80"></a><span id="l5.80">     aPeriod.listItem.id = aItemId;</span>
<a href="#l5.81"></a><span id="l5.81">     aPeriod.listItem.getCheckbox().setChecked(aPeriod.open);</span>
<a href="#l5.82"></a><span id="l5.82">     aPeriod.listItem.getCheckbox().addEventListener(&quot;CheckboxStateChange&quot;, this.onCheckboxChange, true);</span>
<a href="#l5.83"></a><span id="l5.83"> };</span>
<a href="#l5.84"></a><span id="l5.84"> </span>
<a href="#l5.85"></a><span id="l5.85"> /**</span>
<a href="#l5.86"></a><span id="l5.86">  * Remove a period item from the agenda listbox.</span>
<a href="#l5.87"></a><span id="l5.87">  * @see agendaListbox::addPeriodListItem</span>
<a href="#l5.88"></a><span id="l5.88">  */</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-agendaListbox.removePeriodListItem =</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-function removePeriodListItem(aPeriod) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+agendaListbox.removePeriodListItem = function(aPeriod) {</span>
<a href="#l5.92"></a><span id="l5.92">     if (aPeriod.listItem) {</span>
<a href="#l5.93"></a><span id="l5.93">         aPeriod.listItem.getCheckbox().removeEventListener(&quot;CheckboxStateChange&quot;, this.onCheckboxChange, true);</span>
<a href="#l5.94"></a><span id="l5.94">         if (aPeriod.listItem) {</span>
<a href="#l5.95"></a><span id="l5.95">             aPeriod.listItem.remove();</span>
<a href="#l5.96"></a><span id="l5.96">             aPeriod.listItem = null;</span>
<a href="#l5.97"></a><span id="l5.97">         }</span>
<a href="#l5.98"></a><span id="l5.98">     }</span>
<a href="#l5.99"></a><span id="l5.99"> };</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101"> /**</span>
<a href="#l5.102"></a><span id="l5.102">  * Handler function called when changing the checkbox state on period items.</span>
<a href="#l5.103"></a><span id="l5.103">  *</span>
<a href="#l5.104"></a><span id="l5.104">  * @param event     The DOM event that triggered the checkbox state change.</span>
<a href="#l5.105"></a><span id="l5.105">  */</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-agendaListbox.onCheckboxChange =</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-function onCheckboxChange(event) {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+agendaListbox.onCheckboxChange = function(event) {</span>
<a href="#l5.109"></a><span id="l5.109">     let periodCheckbox = event.target;</span>
<a href="#l5.110"></a><span id="l5.110">     let lopen = (periodCheckbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l5.111"></a><span id="l5.111">     let listItem = getParentNodeOrThis(periodCheckbox, &quot;agenda-checkbox-richlist-item&quot;);</span>
<a href="#l5.112"></a><span id="l5.112">     let period = listItem.getItem();</span>
<a href="#l5.113"></a><span id="l5.113">     period.open = lopen;</span>
<a href="#l5.114"></a><span id="l5.114">     // as the agenda-checkboxes are only transient we have to set the &quot;checked&quot;</span>
<a href="#l5.115"></a><span id="l5.115">     // attribute at their hidden origins to make that attribute persistent.</span>
<a href="#l5.116"></a><span id="l5.116">     document.getElementById(listItem.id + &quot;-hidden&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineat">@@ -148,48 +143,44 @@ function onCheckboxChange(event) {</span>
<a href="#l5.118"></a><span id="l5.118">     calendarController.onSelectionChanged({ detail: [] });</span>
<a href="#l5.119"></a><span id="l5.119"> };</span>
<a href="#l5.120"></a><span id="l5.120"> </span>
<a href="#l5.121"></a><span id="l5.121"> /**</span>
<a href="#l5.122"></a><span id="l5.122">  * Handler function called when an agenda listbox item is selected</span>
<a href="#l5.123"></a><span id="l5.123">  *</span>
<a href="#l5.124"></a><span id="l5.124">  * @param aListItem     The agenda-base-richlist-item that was selected.</span>
<a href="#l5.125"></a><span id="l5.125">  */</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-agendaListbox.onSelect =</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-function onSelect(aListItem) {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+agendaListbox.onSelect = function(aListItem) {</span>
<a href="#l5.129"></a><span id="l5.129">     let listbox = document.getElementById(&quot;agenda-listbox&quot;);</span>
<a href="#l5.130"></a><span id="l5.130">     let item = aListItem || listbox.selectedItem;</span>
<a href="#l5.131"></a><span id="l5.131">     if (aListItem) {</span>
<a href="#l5.132"></a><span id="l5.132">         listbox.selectedItem = item;</span>
<a href="#l5.133"></a><span id="l5.133">     }</span>
<a href="#l5.134"></a><span id="l5.134">     calendarController.onSelectionChanged({ detail: agendaListbox.getSelectedItems() });</span>
<a href="#l5.135"></a><span id="l5.135"> };</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137"> /**</span>
<a href="#l5.138"></a><span id="l5.138">  * Handler function called when the agenda listbox becomes focused</span>
<a href="#l5.139"></a><span id="l5.139">  */</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-agendaListbox.onFocus =</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-function onFocus() {</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+agendaListbox.onFocus = function() {</span>
<a href="#l5.143"></a><span id="l5.143">     calendarController.onSelectionChanged({ detail: agendaListbox.getSelectedItems() });</span>
<a href="#l5.144"></a><span id="l5.144"> };</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146"> /**</span>
<a href="#l5.147"></a><span id="l5.147">  * Handler function called when the agenda listbox loses focus.</span>
<a href="#l5.148"></a><span id="l5.148">  */</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-agendaListbox.onBlur =</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-function onBlur() {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+agendaListbox.onBlur = function() {</span>
<a href="#l5.152"></a><span id="l5.152">     calendarController.onSelectionChanged({ detail: [] });</span>
<a href="#l5.153"></a><span id="l5.153"> };</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156"> /**</span>
<a href="#l5.157"></a><span id="l5.157">  * Handler function called when a key was pressed on the agenda listbox</span>
<a href="#l5.158"></a><span id="l5.158">  */</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-agendaListbox.onKeyPress =</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-function onKeyPress(aEvent) {</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+agendaListbox.onKeyPress = function(aEvent) {</span>
<a href="#l5.162"></a><span id="l5.162">     let listItem = aEvent.target;</span>
<a href="#l5.163"></a><span id="l5.163">     if (listItem.localName == &quot;richlistbox&quot;) {</span>
<a href="#l5.164"></a><span id="l5.164">         listItem = listItem.selectedItem;</span>
<a href="#l5.165"></a><span id="l5.165">     }</span>
<a href="#l5.166"></a><span id="l5.166">     switch (aEvent.keyCode) {</span>
<a href="#l5.167"></a><span id="l5.167">         case aEvent.DOM_VK_RETURN:</span>
<a href="#l5.168"></a><span id="l5.168">             document.getElementById(&quot;agenda_edit_event_command&quot;).doCommand();</span>
<a href="#l5.169"></a><span id="l5.169">             break;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineat">@@ -209,63 +200,59 @@ function onKeyPress(aEvent) {</span>
<a href="#l5.171"></a><span id="l5.171">             }</span>
<a href="#l5.172"></a><span id="l5.172">             break;</span>
<a href="#l5.173"></a><span id="l5.173">     }</span>
<a href="#l5.174"></a><span id="l5.174"> };</span>
<a href="#l5.175"></a><span id="l5.175"> </span>
<a href="#l5.176"></a><span id="l5.176"> /**</span>
<a href="#l5.177"></a><span id="l5.177">  * Calls the event dialog to edit the currently selected item</span>
<a href="#l5.178"></a><span id="l5.178">  */</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-agendaListbox.editSelectedItem =</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-function editSelectedItem() {</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+agendaListbox.editSelectedItem = function() {</span>
<a href="#l5.182"></a><span id="l5.182">     let listItem = document.getElementById(&quot;agenda-listbox&quot;).selectedItem;</span>
<a href="#l5.183"></a><span id="l5.183">     if (listItem) {</span>
<a href="#l5.184"></a><span id="l5.184">         modifyEventWithDialog(listItem.occurrence, null, true);</span>
<a href="#l5.185"></a><span id="l5.185">     }</span>
<a href="#l5.186"></a><span id="l5.186"> };</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188"> /**</span>
<a href="#l5.189"></a><span id="l5.189">  * Finds the appropriate period for the given item, i.e finds &quot;Tomorrow&quot; if the</span>
<a href="#l5.190"></a><span id="l5.190">  * item occurrs tomorrow.</span>
<a href="#l5.191"></a><span id="l5.191">  *</span>
<a href="#l5.192"></a><span id="l5.192">  * @param aItem     The item to find the period for.</span>
<a href="#l5.193"></a><span id="l5.193">  */</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-agendaListbox.findPeriodsForItem =</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-function findPeriodsForItem(aItem) {</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+agendaListbox.findPeriodsForItem = function(aItem) {</span>
<a href="#l5.197"></a><span id="l5.197">     let retPeriods = [];</span>
<a href="#l5.198"></a><span id="l5.198">     for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l5.199"></a><span id="l5.199">         if (this.periods[i].open) {</span>
<a href="#l5.200"></a><span id="l5.200">             if (checkIfInRange(aItem, this.periods[i].start, this.periods[i].end)) {</span>
<a href="#l5.201"></a><span id="l5.201">                 retPeriods.push(this.periods[i]);</span>
<a href="#l5.202"></a><span id="l5.202">             }</span>
<a href="#l5.203"></a><span id="l5.203">         }</span>
<a href="#l5.204"></a><span id="l5.204">     }</span>
<a href="#l5.205"></a><span id="l5.205">     return retPeriods;</span>
<a href="#l5.206"></a><span id="l5.206"> };</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208"> /**</span>
<a href="#l5.209"></a><span id="l5.209">  * Gets the start of the earliest period shown in the agenda listbox</span>
<a href="#l5.210"></a><span id="l5.210">  */</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-agendaListbox.getStart =</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-function getStart() {</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+agendaListbox.getStart = function() {</span>
<a href="#l5.214"></a><span id="l5.214">     let retStart = null;</span>
<a href="#l5.215"></a><span id="l5.215">     for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l5.216"></a><span id="l5.216">         if (this.periods[i].open) {</span>
<a href="#l5.217"></a><span id="l5.217">             retStart = this.periods[i].start;</span>
<a href="#l5.218"></a><span id="l5.218">             break;</span>
<a href="#l5.219"></a><span id="l5.219">         }</span>
<a href="#l5.220"></a><span id="l5.220">     }</span>
<a href="#l5.221"></a><span id="l5.221">     return retStart;</span>
<a href="#l5.222"></a><span id="l5.222"> };</span>
<a href="#l5.223"></a><span id="l5.223"> </span>
<a href="#l5.224"></a><span id="l5.224"> /**</span>
<a href="#l5.225"></a><span id="l5.225">  * Gets the end of the latest period shown in the agenda listbox</span>
<a href="#l5.226"></a><span id="l5.226">  */</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-agendaListbox.getEnd =</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-function getEnd() {</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+agendaListbox.getEnd = function() {</span>
<a href="#l5.230"></a><span id="l5.230">     let retEnd = null;</span>
<a href="#l5.231"></a><span id="l5.231">     for (let i = this.periods.length - 1; i &gt;= 0; i--) {</span>
<a href="#l5.232"></a><span id="l5.232">         if (this.periods[i].open) {</span>
<a href="#l5.233"></a><span id="l5.233">             retEnd = this.periods[i].end;</span>
<a href="#l5.234"></a><span id="l5.234">             break;</span>
<a href="#l5.235"></a><span id="l5.235">         }</span>
<a href="#l5.236"></a><span id="l5.236">     }</span>
<a href="#l5.237"></a><span id="l5.237">     return retEnd;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineat">@@ -275,18 +262,17 @@ function getEnd() {</span>
<a href="#l5.239"></a><span id="l5.239">  * Adds an item to an agenda period before another existing item.</span>
<a href="#l5.240"></a><span id="l5.240">  *</span>
<a href="#l5.241"></a><span id="l5.241">  * @param aNewItem      The calIItemBase to add.</span>
<a href="#l5.242"></a><span id="l5.242">  * @param aAgendaItem   The existing item to insert before.</span>
<a href="#l5.243"></a><span id="l5.243">  * @param aPeriod       The period to add the item to.</span>
<a href="#l5.244"></a><span id="l5.244">  * @param visible       If true, the item should be visible.</span>
<a href="#l5.245"></a><span id="l5.245">  * @return              The newly created XUL element.</span>
<a href="#l5.246"></a><span id="l5.246">  */</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-agendaListbox.addItemBefore =</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-function addItemBefore(aNewItem, aAgendaItem, aPeriod, visible) {</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+agendaListbox.addItemBefore = function(aNewItem, aAgendaItem, aPeriod, visible) {</span>
<a href="#l5.250"></a><span id="l5.250">     let newelement = null;</span>
<a href="#l5.251"></a><span id="l5.251">     if (aNewItem.startDate.isDate) {</span>
<a href="#l5.252"></a><span id="l5.252">         newelement = createXULElement(&quot;agenda-allday-richlist-item&quot;);</span>
<a href="#l5.253"></a><span id="l5.253">     } else {</span>
<a href="#l5.254"></a><span id="l5.254">         newelement = createXULElement(&quot;agenda-richlist-item&quot;);</span>
<a href="#l5.255"></a><span id="l5.255">     }</span>
<a href="#l5.256"></a><span id="l5.256">     // set the item at the richlistItem. When the duration of the period</span>
<a href="#l5.257"></a><span id="l5.257">     // is bigger than 1 (day) the starttime of the item has to include</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineat">@@ -303,18 +289,17 @@ function addItemBefore(aNewItem, aAgenda</span>
<a href="#l5.259"></a><span id="l5.259"> </span>
<a href="#l5.260"></a><span id="l5.260"> /**</span>
<a href="#l5.261"></a><span id="l5.261">  * Adds an item to the agenda listbox. This function finds the correct period</span>
<a href="#l5.262"></a><span id="l5.262">  * for the item and inserts it correctly so the period stays sorted.</span>
<a href="#l5.263"></a><span id="l5.263">  *</span>
<a href="#l5.264"></a><span id="l5.264">  * @param aItem         The calIItemBase to add.</span>
<a href="#l5.265"></a><span id="l5.265">  * @return              The newly created XUL element.</span>
<a href="#l5.266"></a><span id="l5.266">  */</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-agendaListbox.addItem =</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-function addItem(aItem) {</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+agendaListbox.addItem = function(aItem) {</span>
<a href="#l5.270"></a><span id="l5.270">     if (!isEvent(aItem)) {</span>
<a href="#l5.271"></a><span id="l5.271">         return null;</span>
<a href="#l5.272"></a><span id="l5.272">     }</span>
<a href="#l5.273"></a><span id="l5.273">     let periods = this.findPeriodsForItem(aItem);</span>
<a href="#l5.274"></a><span id="l5.274">     if (periods.length == 0) {</span>
<a href="#l5.275"></a><span id="l5.275">         return null;</span>
<a href="#l5.276"></a><span id="l5.276">     }</span>
<a href="#l5.277"></a><span id="l5.277">     let newlistItem = null;</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineat">@@ -358,18 +343,17 @@ function addItem(aItem) {</span>
<a href="#l5.279"></a><span id="l5.279"> /**</span>
<a href="#l5.280"></a><span id="l5.280">  * Checks if the given item happens before the comparison item.</span>
<a href="#l5.281"></a><span id="l5.281">  *</span>
<a href="#l5.282"></a><span id="l5.282">  * @param aItem         The item to compare.</span>
<a href="#l5.283"></a><span id="l5.283">  * @param aCompItem     The item to compare with.</span>
<a href="#l5.284"></a><span id="l5.284">  * @param aPeriod       The period where the items are inserted.</span>
<a href="#l5.285"></a><span id="l5.285">  * @return              True, if the aItem happens before aCompItem.</span>
<a href="#l5.286"></a><span id="l5.286">  */</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-agendaListbox.isBefore =</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-function isBefore(aItem, aCompItem, aPeriod) {</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+agendaListbox.isBefore = function(aItem, aCompItem, aPeriod) {</span>
<a href="#l5.290"></a><span id="l5.290">     let itemDate = this.comparisonDate(aItem, aPeriod);</span>
<a href="#l5.291"></a><span id="l5.291">     let compItemDate = this.comparisonDate(aCompItem, aPeriod);</span>
<a href="#l5.292"></a><span id="l5.292">     let itemDateEndDate = itemDate.clone();</span>
<a href="#l5.293"></a><span id="l5.293">     itemDateEndDate.day++;</span>
<a href="#l5.294"></a><span id="l5.294"> </span>
<a href="#l5.295"></a><span id="l5.295">     if (compItemDate.day == itemDate.day) {</span>
<a href="#l5.296"></a><span id="l5.296">         // In the same day the order is:</span>
<a href="#l5.297"></a><span id="l5.297">         // - all-day events (single day);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineat">@@ -411,18 +395,17 @@ function isBefore(aItem, aCompItem, aPer</span>
<a href="#l5.299"></a><span id="l5.299"> /**</span>
<a href="#l5.300"></a><span id="l5.300">  * Returns the start or end date of an item according to which of them</span>
<a href="#l5.301"></a><span id="l5.301">  * must be displayed in a given period of the agenda</span>
<a href="#l5.302"></a><span id="l5.302">  *</span>
<a href="#l5.303"></a><span id="l5.303">  * @param aItem         The item to compare.</span>
<a href="#l5.304"></a><span id="l5.304">  * @param aPeriod       The period where the item is inserted.</span>
<a href="#l5.305"></a><span id="l5.305">  * @return              The start or end date of the item showed in the agenda.</span>
<a href="#l5.306"></a><span id="l5.306">  */</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-agendaListbox.comparisonDate =</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-function comparisonDate(aItem, aPeriod) {</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+agendaListbox.comparisonDate = function(aItem, aPeriod) {</span>
<a href="#l5.310"></a><span id="l5.310">     let periodStartDate = aPeriod.start.clone();</span>
<a href="#l5.311"></a><span id="l5.311">     periodStartDate.isDate = true;</span>
<a href="#l5.312"></a><span id="l5.312">     let periodEndDate = aPeriod.end.clone();</span>
<a href="#l5.313"></a><span id="l5.313">     periodEndDate.day--;</span>
<a href="#l5.314"></a><span id="l5.314">     let startDate = aItem.startDate.clone();</span>
<a href="#l5.315"></a><span id="l5.315">     startDate.isDate = true;</span>
<a href="#l5.316"></a><span id="l5.316">     let endDate = aItem.endDate.clone();</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318" class="difflineat">@@ -450,18 +433,17 @@ function comparisonDate(aItem, aPeriod) </span>
<a href="#l5.319"></a><span id="l5.319"> </span>
<a href="#l5.320"></a><span id="l5.320"> /**</span>
<a href="#l5.321"></a><span id="l5.321">  * Gets the listitems for a given item, possibly in a given period.</span>
<a href="#l5.322"></a><span id="l5.322">  *</span>
<a href="#l5.323"></a><span id="l5.323">  * @param aItem         The item to get the list items for.</span>
<a href="#l5.324"></a><span id="l5.324">  * @param aPeriod       (optional) the period to search in.</span>
<a href="#l5.325"></a><span id="l5.325">  * @return              An array of list items for the given item.</span>
<a href="#l5.326"></a><span id="l5.326">  */</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-agendaListbox.getListItems =</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-function getListItems(aItem, aPeriod) {</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+agendaListbox.getListItems = function(aItem, aPeriod) {</span>
<a href="#l5.330"></a><span id="l5.330">     let retlistItems = [];</span>
<a href="#l5.331"></a><span id="l5.331">     let periods = [aPeriod];</span>
<a href="#l5.332"></a><span id="l5.332">     if (!aPeriod) {</span>
<a href="#l5.333"></a><span id="l5.333">         periods = this.findPeriodsForItem(aItem);</span>
<a href="#l5.334"></a><span id="l5.334">     }</span>
<a href="#l5.335"></a><span id="l5.335">     if (periods.length &gt; 0) {</span>
<a href="#l5.336"></a><span id="l5.336">         for (let i = 0; i &lt; periods.length; i++) {</span>
<a href="#l5.337"></a><span id="l5.337">             let period = periods[i];</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineat">@@ -485,18 +467,17 @@ function getListItems(aItem, aPeriod) {</span>
<a href="#l5.339"></a><span id="l5.339"> /**</span>
<a href="#l5.340"></a><span id="l5.340">  * Removes the given item from the agenda listbox</span>
<a href="#l5.341"></a><span id="l5.341">  *</span>
<a href="#l5.342"></a><span id="l5.342">  * @param aItem             The item to remove.</span>
<a href="#l5.343"></a><span id="l5.343">  * @param aMoveSelection    If true, the selection will be moved to the next</span>
<a href="#l5.344"></a><span id="l5.344">  *                            sibling that is not an period item.</span>
<a href="#l5.345"></a><span id="l5.345">  * @return                  Returns true if the removed item was selected.</span>
<a href="#l5.346"></a><span id="l5.346">  */</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-agendaListbox.deleteItem =</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-function deleteItem(aItem, aMoveSelection) {</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+agendaListbox.deleteItem = function(aItem, aMoveSelection) {</span>
<a href="#l5.350"></a><span id="l5.350">     let isSelected = false;</span>
<a href="#l5.351"></a><span id="l5.351">     let listItems = this.getListItems(aItem);</span>
<a href="#l5.352"></a><span id="l5.352">     if (listItems.length &gt; 0) {</span>
<a href="#l5.353"></a><span id="l5.353">         for (let i = listItems.length - 1; i &gt;= 0; i--) {</span>
<a href="#l5.354"></a><span id="l5.354">             let listItem = listItems[i];</span>
<a href="#l5.355"></a><span id="l5.355">             let isSelected2 = listItem.selected;</span>
<a href="#l5.356"></a><span id="l5.356">             if (isSelected2 &amp;&amp; !isSelected) {</span>
<a href="#l5.357"></a><span id="l5.357">                 isSelected = true;</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineat">@@ -510,18 +491,17 @@ function deleteItem(aItem, aMoveSelectio</span>
<a href="#l5.359"></a><span id="l5.359">     return isSelected;</span>
<a href="#l5.360"></a><span id="l5.360"> };</span>
<a href="#l5.361"></a><span id="l5.361"> </span>
<a href="#l5.362"></a><span id="l5.362"> /**</span>
<a href="#l5.363"></a><span id="l5.363">  * Remove all items belonging to the specified calendar.</span>
<a href="#l5.364"></a><span id="l5.364">  *</span>
<a href="#l5.365"></a><span id="l5.365">  * @param aCalendar         The item to compare.</span>
<a href="#l5.366"></a><span id="l5.366">  */</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-agendaListbox.deleteItemsFromCalendar =</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-function deleteItemsFromCalendar(aCalendar) {</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+agendaListbox.deleteItemsFromCalendar = function(aCalendar) {</span>
<a href="#l5.370"></a><span id="l5.370">     let childNodes = Array.from(this.agendaListboxControl.childNodes);</span>
<a href="#l5.371"></a><span id="l5.371">     for (let childNode of childNodes) {</span>
<a href="#l5.372"></a><span id="l5.372">         if (childNode &amp;&amp; childNode.occurrence &amp;&amp;</span>
<a href="#l5.373"></a><span id="l5.373">             childNode.occurrence.calendar.id == aCalendar.id) {</span>
<a href="#l5.374"></a><span id="l5.374">             childNode.remove();</span>
<a href="#l5.375"></a><span id="l5.375">         }</span>
<a href="#l5.376"></a><span id="l5.376">     }</span>
<a href="#l5.377"></a><span id="l5.377"> };</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineat">@@ -529,80 +509,75 @@ function deleteItemsFromCalendar(aCalend</span>
<a href="#l5.379"></a><span id="l5.379"> /**</span>
<a href="#l5.380"></a><span id="l5.380">  * Compares two items to see if they have the same id and their start date</span>
<a href="#l5.381"></a><span id="l5.381">  * matches</span>
<a href="#l5.382"></a><span id="l5.382">  *</span>
<a href="#l5.383"></a><span id="l5.383">  * @param aItem         The item to compare.</span>
<a href="#l5.384"></a><span id="l5.384">  * @param aCompItem     The item to compare with.</span>
<a href="#l5.385"></a><span id="l5.385">  * @return              True, if the items match with the above noted criteria.</span>
<a href="#l5.386"></a><span id="l5.386">  */</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-agendaListbox.isSameEvent =</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-function isSameEvent(aItem, aCompItem) {</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+agendaListbox.isSameEvent = function(aItem, aCompItem) {</span>
<a href="#l5.390"></a><span id="l5.390">     return aItem.id == aCompItem.id &amp;&amp;</span>
<a href="#l5.391"></a><span id="l5.391">            aItem[calGetStartDateProp(aItem)].compare(aCompItem[calGetStartDateProp(aCompItem)]) == 0;</span>
<a href="#l5.392"></a><span id="l5.392"> };</span>
<a href="#l5.393"></a><span id="l5.393"> </span>
<a href="#l5.394"></a><span id="l5.394"> /**</span>
<a href="#l5.395"></a><span id="l5.395">  * Checks if the currently selected node in the listbox is an Event item (not a</span>
<a href="#l5.396"></a><span id="l5.396">  * period item).</span>
<a href="#l5.397"></a><span id="l5.397">  *</span>
<a href="#l5.398"></a><span id="l5.398">  * @return              True, if the node is not a period item.</span>
<a href="#l5.399"></a><span id="l5.399">  */</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-agendaListbox.isEventSelected =</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-function isEventSelected() {</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+agendaListbox.isEventSelected = function() {</span>
<a href="#l5.403"></a><span id="l5.403">     let listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l5.404"></a><span id="l5.404">     if (listItem) {</span>
<a href="#l5.405"></a><span id="l5.405">         return this.isEventListItem(listItem);</span>
<a href="#l5.406"></a><span id="l5.406">     }</span>
<a href="#l5.407"></a><span id="l5.407">     return false;</span>
<a href="#l5.408"></a><span id="l5.408"> };</span>
<a href="#l5.409"></a><span id="l5.409"> </span>
<a href="#l5.410"></a><span id="l5.410"> /**</span>
<a href="#l5.411"></a><span id="l5.411">  * Delete the selected item from its calendar (if it is an event item)</span>
<a href="#l5.412"></a><span id="l5.412">  *</span>
<a href="#l5.413"></a><span id="l5.413">  * @param aDoNotConfirm     If true, the user will not be prompted.</span>
<a href="#l5.414"></a><span id="l5.414">  */</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-agendaListbox.deleteSelectedItem =</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-function deleteSelectedItem(aDoNotConfirm) {</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+agendaListbox.deleteSelectedItem = function(aDoNotConfirm) {</span>
<a href="#l5.418"></a><span id="l5.418">     let listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l5.419"></a><span id="l5.419">     if (this.isEventListItem(listItem)) {</span>
<a href="#l5.420"></a><span id="l5.420">         let selectedItems = [listItem.occurrence];</span>
<a href="#l5.421"></a><span id="l5.421">         calendarViewController.deleteOccurrences(selectedItems.length,</span>
<a href="#l5.422"></a><span id="l5.422">                                                  selectedItems,</span>
<a href="#l5.423"></a><span id="l5.423">                                                  false,</span>
<a href="#l5.424"></a><span id="l5.424">                                                  aDoNotConfirm);</span>
<a href="#l5.425"></a><span id="l5.425">     }</span>
<a href="#l5.426"></a><span id="l5.426"> };</span>
<a href="#l5.427"></a><span id="l5.427"> </span>
<a href="#l5.428"></a><span id="l5.428"> /**</span>
<a href="#l5.429"></a><span id="l5.429">  * If a Period item is targeted by the passed DOM event, opens the event dialog</span>
<a href="#l5.430"></a><span id="l5.430">  * with the period's start date prefilled.</span>
<a href="#l5.431"></a><span id="l5.431">  *</span>
<a href="#l5.432"></a><span id="l5.432">  * @param aEvent            The DOM event that targets the period.</span>
<a href="#l5.433"></a><span id="l5.433">  */</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-agendaListbox.createNewEvent =</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-function createNewEvent(aEvent) {</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+agendaListbox.createNewEvent = function(aEvent) {</span>
<a href="#l5.437"></a><span id="l5.437">     if (!this.isEventListItem(aEvent.target)) {</span>
<a href="#l5.438"></a><span id="l5.438">         // Create new event for the date currently displayed in the agenda. Setting</span>
<a href="#l5.439"></a><span id="l5.439">         // isDate = true automatically makes the start time be the next full hour.</span>
<a href="#l5.440"></a><span id="l5.440">         let eventStart = agendaListbox.today.start.clone();</span>
<a href="#l5.441"></a><span id="l5.441">         eventStart.isDate = true;</span>
<a href="#l5.442"></a><span id="l5.442">         if (calendarController.isCommandEnabled(&quot;calendar_new_event_command&quot;)) {</span>
<a href="#l5.443"></a><span id="l5.443">             createEventWithDialog(getSelectedCalendar(), eventStart);</span>
<a href="#l5.444"></a><span id="l5.444">         }</span>
<a href="#l5.445"></a><span id="l5.445">     }</span>
<a href="#l5.446"></a><span id="l5.446"> };</span>
<a href="#l5.447"></a><span id="l5.447"> </span>
<a href="#l5.448"></a><span id="l5.448"> /**</span>
<a href="#l5.449"></a><span id="l5.449">  * Sets up the context menu for the agenda listbox</span>
<a href="#l5.450"></a><span id="l5.450">  *</span>
<a href="#l5.451"></a><span id="l5.451">  * @param popup         The &lt;menupopup&gt; element to set up.</span>
<a href="#l5.452"></a><span id="l5.452">  */</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-agendaListbox.setupContextMenu =</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-function setupContextMenu(popup) {</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+agendaListbox.setupContextMenu = function(popup) {</span>
<a href="#l5.456"></a><span id="l5.456">     let listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l5.457"></a><span id="l5.457">     let enabled = this.isEventListItem(listItem);</span>
<a href="#l5.458"></a><span id="l5.458">     let menuitems = popup.childNodes;</span>
<a href="#l5.459"></a><span id="l5.459">     for (let i = 0; i &lt; menuitems.length; i++) {</span>
<a href="#l5.460"></a><span id="l5.460">         setBooleanAttribute(menuitems[i], &quot;disabled&quot;, !enabled);</span>
<a href="#l5.461"></a><span id="l5.461">     }</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463">     let menu = document.getElementById(&quot;calendar-today-pane-menu-attendance-menu&quot;);</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineat">@@ -614,18 +589,17 @@ function setupContextMenu(popup) {</span>
<a href="#l5.465"></a><span id="l5.465">  * Refreshes the agenda listbox. If aStart or aEnd is not passed, the agenda</span>
<a href="#l5.466"></a><span id="l5.466">  * listbox's limiting dates will be used.</span>
<a href="#l5.467"></a><span id="l5.467">  *</span>
<a href="#l5.468"></a><span id="l5.468">  * @param aStart        (optional) The start date for the item query.</span>
<a href="#l5.469"></a><span id="l5.469">  * @param aEnd          (optional) The end date for the item query.</span>
<a href="#l5.470"></a><span id="l5.470">  * @param aCalendar     (optional) If specified, the single calendar from</span>
<a href="#l5.471"></a><span id="l5.471">  *                                   which the refresh will occur.</span>
<a href="#l5.472"></a><span id="l5.472">  */</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-agendaListbox.refreshCalendarQuery =</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-function refreshCalendarQuery(aStart, aEnd, aCalendar) {</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+agendaListbox.refreshCalendarQuery = function(aStart, aEnd, aCalendar) {</span>
<a href="#l5.476"></a><span id="l5.476">     let refreshJob = {</span>
<a href="#l5.477"></a><span id="l5.477">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l5.478"></a><span id="l5.478">         agendaListbox: this,</span>
<a href="#l5.479"></a><span id="l5.479">         calendar: null,</span>
<a href="#l5.480"></a><span id="l5.480">         calId: null,</span>
<a href="#l5.481"></a><span id="l5.481">         operation: null,</span>
<a href="#l5.482"></a><span id="l5.482">         cancelled: false,</span>
<a href="#l5.483"></a><span id="l5.483"> </span>
<a href="#l5.484"></a><span id="l5.484" class="difflineat">@@ -704,18 +678,17 @@ function refreshCalendarQuery(aStart, aE</span>
<a href="#l5.485"></a><span id="l5.485">     };</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487">     refreshJob.execute();</span>
<a href="#l5.488"></a><span id="l5.488"> };</span>
<a href="#l5.489"></a><span id="l5.489"> </span>
<a href="#l5.490"></a><span id="l5.490"> /**</span>
<a href="#l5.491"></a><span id="l5.491">  * Sets up the calendar for the agenda listbox.</span>
<a href="#l5.492"></a><span id="l5.492">  */</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-agendaListbox.setupCalendar =</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-function setupCalendar() {</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+agendaListbox.setupCalendar = function() {</span>
<a href="#l5.496"></a><span id="l5.496">     this.init();</span>
<a href="#l5.497"></a><span id="l5.497">     if (this.calendar == null) {</span>
<a href="#l5.498"></a><span id="l5.498">         this.calendar = getCompositeCalendar();</span>
<a href="#l5.499"></a><span id="l5.499">     }</span>
<a href="#l5.500"></a><span id="l5.500">     if (this.calendar) {</span>
<a href="#l5.501"></a><span id="l5.501">         // XXX This always gets called, does that happen on purpose?</span>
<a href="#l5.502"></a><span id="l5.502">         this.calendar.removeObserver(this.calendarObserver);</span>
<a href="#l5.503"></a><span id="l5.503">     }</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineat">@@ -729,18 +702,17 @@ function setupCalendar() {</span>
<a href="#l5.505"></a><span id="l5.505">  * Refreshes the period dates, especially when a period is showing &quot;today&quot;.</span>
<a href="#l5.506"></a><span id="l5.506">  * Usually called at midnight to update the agenda pane. Also retrieves the</span>
<a href="#l5.507"></a><span id="l5.507">  * items from the calendar.</span>
<a href="#l5.508"></a><span id="l5.508">  *</span>
<a href="#l5.509"></a><span id="l5.509">  * @see #refreshCalendarQuery</span>
<a href="#l5.510"></a><span id="l5.510">  * @param newDate       The first date to show if the agenda pane doesn't show</span>
<a href="#l5.511"></a><span id="l5.511">  *                        today.</span>
<a href="#l5.512"></a><span id="l5.512">  */</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-agendaListbox.refreshPeriodDates =</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-function refreshPeriodDates(newDate) {</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+agendaListbox.refreshPeriodDates = function(newDate) {</span>
<a href="#l5.516"></a><span id="l5.516">      this.kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l5.517"></a><span id="l5.517">     // Today: now until midnight of tonight</span>
<a href="#l5.518"></a><span id="l5.518">     let oldshowstoday = this.showstoday;</span>
<a href="#l5.519"></a><span id="l5.519">     this.showstoday = this.showsToday(newDate);</span>
<a href="#l5.520"></a><span id="l5.520">     if ((this.showstoday) &amp;&amp; (!oldshowstoday)) {</span>
<a href="#l5.521"></a><span id="l5.521">         this.addPeriodListItem(this.tomorrow, &quot;tomorrow-header&quot;);</span>
<a href="#l5.522"></a><span id="l5.522">         this.addPeriodListItem(this.soon, &quot;nextweek-header&quot;);</span>
<a href="#l5.523"></a><span id="l5.523">     } else if (!this.showstoday) {</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineat">@@ -763,30 +735,28 @@ function refreshPeriodDates(newDate) {</span>
<a href="#l5.525"></a><span id="l5.525">     this.refreshCalendarQuery();</span>
<a href="#l5.526"></a><span id="l5.526"> };</span>
<a href="#l5.527"></a><span id="l5.527"> </span>
<a href="#l5.528"></a><span id="l5.528"> /**</span>
<a href="#l5.529"></a><span id="l5.529">  * Adds a listener to this agenda listbox.</span>
<a href="#l5.530"></a><span id="l5.530">  *</span>
<a href="#l5.531"></a><span id="l5.531">  * @param aListener     The listener to add.</span>
<a href="#l5.532"></a><span id="l5.532">  */</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-agendaListbox.addListener =</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-function addListener(aListener) {</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+agendaListbox.addListener = function(aListener) {</span>
<a href="#l5.536"></a><span id="l5.536">     this.mListener = aListener;</span>
<a href="#l5.537"></a><span id="l5.537"> };</span>
<a href="#l5.538"></a><span id="l5.538"> </span>
<a href="#l5.539"></a><span id="l5.539"> /**</span>
<a href="#l5.540"></a><span id="l5.540">  * Checks if the agenda listbox is showing &quot;today&quot;. Without arguments, this</span>
<a href="#l5.541"></a><span id="l5.541">  * function assumes the today attribute of the agenda listbox.</span>
<a href="#l5.542"></a><span id="l5.542">  *</span>
<a href="#l5.543"></a><span id="l5.543">  * @param aStartDate    (optional) The day to check if its &quot;today&quot;.</span>
<a href="#l5.544"></a><span id="l5.544">  * @return              Returns true if today is shown.</span>
<a href="#l5.545"></a><span id="l5.545">  */</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineminus">-agendaListbox.showsToday =</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineminus">-function showsToday(aStartDate) {</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+agendaListbox.showsToday = function(aStartDate) {</span>
<a href="#l5.549"></a><span id="l5.549">     let lstart = aStartDate;</span>
<a href="#l5.550"></a><span id="l5.550">     if (!lstart) {</span>
<a href="#l5.551"></a><span id="l5.551">         lstart = this.today.start;</span>
<a href="#l5.552"></a><span id="l5.552">     }</span>
<a href="#l5.553"></a><span id="l5.553">     let lshowsToday = sameDay(now(), lstart);</span>
<a href="#l5.554"></a><span id="l5.554">     if (lshowsToday) {</span>
<a href="#l5.555"></a><span id="l5.555">         this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l5.556"></a><span id="l5.556">     } else {</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineat">@@ -794,65 +764,61 @@ function showsToday(aStartDate) {</span>
<a href="#l5.558"></a><span id="l5.558">     }</span>
<a href="#l5.559"></a><span id="l5.559">     return lshowsToday;</span>
<a href="#l5.560"></a><span id="l5.560"> };</span>
<a href="#l5.561"></a><span id="l5.561"> </span>
<a href="#l5.562"></a><span id="l5.562"> /**</span>
<a href="#l5.563"></a><span id="l5.563">  * Moves the selection. Moves down unless the next item is a period item, in</span>
<a href="#l5.564"></a><span id="l5.564">  * which case the selection moves up.</span>
<a href="#l5.565"></a><span id="l5.565">  */</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineminus">-agendaListbox.moveSelection =</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineminus">-function moveSelection() {</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+agendaListbox.moveSelection = function() {</span>
<a href="#l5.569"></a><span id="l5.569">     if (!this.isEventListItem(this.agendaListboxControl.selectedItem.nextSibling)) {</span>
<a href="#l5.570"></a><span id="l5.570">         this.agendaListboxControl.goUp();</span>
<a href="#l5.571"></a><span id="l5.571">     } else {</span>
<a href="#l5.572"></a><span id="l5.572">         this.agendaListboxControl.goDown();</span>
<a href="#l5.573"></a><span id="l5.573">     }</span>
<a href="#l5.574"></a><span id="l5.574"> };</span>
<a href="#l5.575"></a><span id="l5.575"> </span>
<a href="#l5.576"></a><span id="l5.576"> /**</span>
<a href="#l5.577"></a><span id="l5.577">  * Gets an array of selected items. If a period node is selected, it is not</span>
<a href="#l5.578"></a><span id="l5.578">  * included.</span>
<a href="#l5.579"></a><span id="l5.579">  *</span>
<a href="#l5.580"></a><span id="l5.580">  * @return      An array with all selected items.</span>
<a href="#l5.581"></a><span id="l5.581">  */</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineminus">-agendaListbox.getSelectedItems =</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-function getSelectedItems() {</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+agendaListbox.getSelectedItems = function() {</span>
<a href="#l5.585"></a><span id="l5.585">     let items = [];</span>
<a href="#l5.586"></a><span id="l5.586">     if (this.isEventListItem(this.agendaListboxControl.selectedItem)) {</span>
<a href="#l5.587"></a><span id="l5.587">         // If at some point we support selecting multiple items, this array can</span>
<a href="#l5.588"></a><span id="l5.588">         // be expanded.</span>
<a href="#l5.589"></a><span id="l5.589">         items = [this.agendaListboxControl.selectedItem.occurrence];</span>
<a href="#l5.590"></a><span id="l5.590">     }</span>
<a href="#l5.591"></a><span id="l5.591">     return items;</span>
<a href="#l5.592"></a><span id="l5.592"> };</span>
<a href="#l5.593"></a><span id="l5.593"> </span>
<a href="#l5.594"></a><span id="l5.594"> /**</span>
<a href="#l5.595"></a><span id="l5.595">  * Checks if the passed node in the listbox is an Event item (not a</span>
<a href="#l5.596"></a><span id="l5.596">  * period item).</span>
<a href="#l5.597"></a><span id="l5.597">  *</span>
<a href="#l5.598"></a><span id="l5.598">  * @param aListItem     The node to check for.</span>
<a href="#l5.599"></a><span id="l5.599">  * @return              True, if the node is not a period item.</span>
<a href="#l5.600"></a><span id="l5.600">  */</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-agendaListbox.isEventListItem =</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineminus">-function isEventListItem(aListItem) {</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+agendaListbox.isEventListItem = function(aListItem) {</span>
<a href="#l5.604"></a><span id="l5.604">     let isListItem = (aListItem != null);</span>
<a href="#l5.605"></a><span id="l5.605">     if (isListItem) {</span>
<a href="#l5.606"></a><span id="l5.606">         let localName = aListItem.localName;</span>
<a href="#l5.607"></a><span id="l5.607">         isListItem = (localName == &quot;agenda-richlist-item&quot; ||</span>
<a href="#l5.608"></a><span id="l5.608">                       localName == &quot;agenda-allday-richlist-item&quot;);</span>
<a href="#l5.609"></a><span id="l5.609">     }</span>
<a href="#l5.610"></a><span id="l5.610">     return isListItem;</span>
<a href="#l5.611"></a><span id="l5.611"> };</span>
<a href="#l5.612"></a><span id="l5.612"> </span>
<a href="#l5.613"></a><span id="l5.613"> /**</span>
<a href="#l5.614"></a><span id="l5.614">  * Removes all Event items, keeping the period items intact.</span>
<a href="#l5.615"></a><span id="l5.615">  */</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-agendaListbox.removeListItems =</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-function removeListItems() {</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+agendaListbox.removeListItems = function() {</span>
<a href="#l5.619"></a><span id="l5.619">     let listItem = this.agendaListboxControl.lastChild;</span>
<a href="#l5.620"></a><span id="l5.620">     if (listItem) {</span>
<a href="#l5.621"></a><span id="l5.621">         let leaveloop = false;</span>
<a href="#l5.622"></a><span id="l5.622">         do {</span>
<a href="#l5.623"></a><span id="l5.623">             let newlistItem = null;</span>
<a href="#l5.624"></a><span id="l5.624">             if (listItem) {</span>
<a href="#l5.625"></a><span id="l5.625">                 newlistItem = listItem.previousSibling;</span>
<a href="#l5.626"></a><span id="l5.626">             } else {</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineat">@@ -870,18 +836,17 @@ function removeListItems() {</span>
<a href="#l5.628"></a><span id="l5.628">     }</span>
<a href="#l5.629"></a><span id="l5.629"> };</span>
<a href="#l5.630"></a><span id="l5.630"> </span>
<a href="#l5.631"></a><span id="l5.631"> /**</span>
<a href="#l5.632"></a><span id="l5.632">  * Gets the list item node by its associated event's hashId.</span>
<a href="#l5.633"></a><span id="l5.633">  *</span>
<a href="#l5.634"></a><span id="l5.634">  * @return The XUL node if successful, otherwise null.</span>
<a href="#l5.635"></a><span id="l5.635">  */</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineminus">-agendaListbox.getListItemByHashId =</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-function getListItemByHashId(ahashId) {</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+agendaListbox.getListItemByHashId = function(ahashId) {</span>
<a href="#l5.639"></a><span id="l5.639">     let listItem = this.agendaListboxControl.firstChild;</span>
<a href="#l5.640"></a><span id="l5.640">     let leaveloop = false;</span>
<a href="#l5.641"></a><span id="l5.641">     do {</span>
<a href="#l5.642"></a><span id="l5.642">         if (this.isEventListItem(listItem)) {</span>
<a href="#l5.643"></a><span id="l5.643">             if (listItem.occurrence.hashId == ahashId) {</span>
<a href="#l5.644"></a><span id="l5.644">                 return listItem;</span>
<a href="#l5.645"></a><span id="l5.645">             }</span>
<a href="#l5.646"></a><span id="l5.646">         }</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineat">@@ -903,83 +868,77 @@ agendaListbox.calendarOpListener = {</span>
<a href="#l5.648"></a><span id="l5.648">  * Calendar and composite observer, used to keep agenda listbox up to date.</span>
<a href="#l5.649"></a><span id="l5.649">  * @see calIObserver</span>
<a href="#l5.650"></a><span id="l5.650">  * @see calICompositeObserver</span>
<a href="#l5.651"></a><span id="l5.651">  */</span>
<a href="#l5.652"></a><span id="l5.652"> agendaListbox.calendarObserver = {</span>
<a href="#l5.653"></a><span id="l5.653">     agendaListbox: agendaListbox</span>
<a href="#l5.654"></a><span id="l5.654"> };</span>
<a href="#l5.655"></a><span id="l5.655"> </span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-agendaListbox.calendarObserver.QueryInterface =</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineminus">-function agenda_QI(aIID) {</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+agendaListbox.calendarObserver.QueryInterface = function(aIID) {</span>
<a href="#l5.659"></a><span id="l5.659">     if (!aIID.equals(Components.interfaces.calIObserver) &amp;&amp;</span>
<a href="#l5.660"></a><span id="l5.660">         !aIID.equals(Components.interfaces.calICompositeObserver) &amp;&amp;</span>
<a href="#l5.661"></a><span id="l5.661">         !aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l5.662"></a><span id="l5.662">         throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l5.663"></a><span id="l5.663">     }</span>
<a href="#l5.664"></a><span id="l5.664">     return this;</span>
<a href="#l5.665"></a><span id="l5.665"> };</span>
<a href="#l5.666"></a><span id="l5.666"> </span>
<a href="#l5.667"></a><span id="l5.667"> // calIObserver:</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineminus">-agendaListbox.calendarObserver.onStartBatch = function agenda_onBatchStart() {</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+agendaListbox.calendarObserver.onStartBatch = function() {</span>
<a href="#l5.670"></a><span id="l5.670"> };</span>
<a href="#l5.671"></a><span id="l5.671"> </span>
<a href="#l5.672"></a><span id="l5.672" class="difflineminus">-agendaListbox.calendarObserver.onEndBatch =</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineminus">-function() {</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+agendaListbox.calendarObserver.onEndBatch = function() {</span>
<a href="#l5.675"></a><span id="l5.675"> };</span>
<a href="#l5.676"></a><span id="l5.676"> </span>
<a href="#l5.677"></a><span id="l5.677"> agendaListbox.calendarObserver.onLoad = function() {</span>
<a href="#l5.678"></a><span id="l5.678">     this.agendaListbox.refreshCalendarQuery();</span>
<a href="#l5.679"></a><span id="l5.679"> };</span>
<a href="#l5.680"></a><span id="l5.680"> </span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-agendaListbox.calendarObserver.onAddItem = function observer_onAddItem(item) {</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+agendaListbox.calendarObserver.onAddItem = function(item) {</span>
<a href="#l5.683"></a><span id="l5.683">     if (!isEvent(item)) {</span>
<a href="#l5.684"></a><span id="l5.684">         return;</span>
<a href="#l5.685"></a><span id="l5.685">     }</span>
<a href="#l5.686"></a><span id="l5.686">     // get all sub items if it is a recurring item</span>
<a href="#l5.687"></a><span id="l5.687">     let occs = this.getOccurrencesBetween(item);</span>
<a href="#l5.688"></a><span id="l5.688">     occs.forEach(this.agendaListbox.addItem, this.agendaListbox);</span>
<a href="#l5.689"></a><span id="l5.689">     setCurrentEvent();</span>
<a href="#l5.690"></a><span id="l5.690"> };</span>
<a href="#l5.691"></a><span id="l5.691"> </span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-agendaListbox.calendarObserver.getOccurrencesBetween =</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-function getOccurrencesBetween(aItem) {</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+agendaListbox.calendarObserver.getOccurrencesBetween = function(aItem) {</span>
<a href="#l5.695"></a><span id="l5.695">     let occs = [];</span>
<a href="#l5.696"></a><span id="l5.696">     let start = this.agendaListbox.getStart();</span>
<a href="#l5.697"></a><span id="l5.697">     let end = this.agendaListbox.getEnd();</span>
<a href="#l5.698"></a><span id="l5.698">     if (start &amp;&amp; end) {</span>
<a href="#l5.699"></a><span id="l5.699">         occs = aItem.getOccurrencesBetween(start, end, {});</span>
<a href="#l5.700"></a><span id="l5.700">     }</span>
<a href="#l5.701"></a><span id="l5.701">     return occs;</span>
<a href="#l5.702"></a><span id="l5.702"> };</span>
<a href="#l5.703"></a><span id="l5.703"> </span>
<a href="#l5.704"></a><span id="l5.704" class="difflineminus">-agendaListbox.calendarObserver.onDeleteItem =</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineminus">-function observer_onDeleteItem(item, rebuildFlag) {</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+agendaListbox.calendarObserver.onDeleteItem = function(item, rebuildFlag) {</span>
<a href="#l5.707"></a><span id="l5.707">     this.onLocalDeleteItem(item, true);</span>
<a href="#l5.708"></a><span id="l5.708"> };</span>
<a href="#l5.709"></a><span id="l5.709"> </span>
<a href="#l5.710"></a><span id="l5.710" class="difflineminus">-agendaListbox.calendarObserver.onLocalDeleteItem =</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-function observer_onLocalDeleteItem(item, moveSelection) {</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+agendaListbox.calendarObserver.onLocalDeleteItem = function(item, moveSelection) {</span>
<a href="#l5.713"></a><span id="l5.713">     if (!isEvent(item)) {</span>
<a href="#l5.714"></a><span id="l5.714">         return false;</span>
<a href="#l5.715"></a><span id="l5.715">     }</span>
<a href="#l5.716"></a><span id="l5.716">     let selectedItemHashId = -1;</span>
<a href="#l5.717"></a><span id="l5.717"> // get all sub items if it is a recurring item</span>
<a href="#l5.718"></a><span id="l5.718">     let occs = this.getOccurrencesBetween(item);</span>
<a href="#l5.719"></a><span id="l5.719">     for (let i = 0; i &lt; occs.length; i++) {</span>
<a href="#l5.720"></a><span id="l5.720">         let isSelected = this.agendaListbox.deleteItem(occs[i], moveSelection);</span>
<a href="#l5.721"></a><span id="l5.721">         if (isSelected) {</span>
<a href="#l5.722"></a><span id="l5.722">             selectedItemHashId = occs[i].hashId;</span>
<a href="#l5.723"></a><span id="l5.723">         }</span>
<a href="#l5.724"></a><span id="l5.724">     }</span>
<a href="#l5.725"></a><span id="l5.725">     return selectedItemHashId;</span>
<a href="#l5.726"></a><span id="l5.726"> };</span>
<a href="#l5.727"></a><span id="l5.727"> </span>
<a href="#l5.728"></a><span id="l5.728" class="difflineminus">-agendaListbox.calendarObserver.onModifyItem =</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineminus">-function observer_onModifyItem(newItem, oldItem) {</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+agendaListbox.calendarObserver.onModifyItem = function(newItem, oldItem) {</span>
<a href="#l5.731"></a><span id="l5.731">     let selectedItemHashId = this.onLocalDeleteItem(oldItem, false);</span>
<a href="#l5.732"></a><span id="l5.732">     if (!isEvent(newItem)) {</span>
<a href="#l5.733"></a><span id="l5.733">         return;</span>
<a href="#l5.734"></a><span id="l5.734">     }</span>
<a href="#l5.735"></a><span id="l5.735">     this.onAddItem(newItem);</span>
<a href="#l5.736"></a><span id="l5.736">     if (selectedItemHashId != -1) {</span>
<a href="#l5.737"></a><span id="l5.737">         let listItem = agendaListbox.getListItemByHashId(selectedItemHashId);</span>
<a href="#l5.738"></a><span id="l5.738">         if (listItem) {</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineat">@@ -1013,38 +972,35 @@ agendaListbox.calendarObserver.onPropert</span>
<a href="#l5.740"></a><span id="l5.740">     }</span>
<a href="#l5.741"></a><span id="l5.741"> };</span>
<a href="#l5.742"></a><span id="l5.742"> </span>
<a href="#l5.743"></a><span id="l5.743"> agendaListbox.calendarObserver.onPropertyDeleting = function(aCalendar, aName) {</span>
<a href="#l5.744"></a><span id="l5.744">     this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l5.745"></a><span id="l5.745"> };</span>
<a href="#l5.746"></a><span id="l5.746"> </span>
<a href="#l5.747"></a><span id="l5.747"> </span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-agendaListbox.calendarObserver.onCalendarRemoved =</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineminus">-function agenda_calRemoved(aCalendar) {</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+agendaListbox.calendarObserver.onCalendarRemoved = function(aCalendar) {</span>
<a href="#l5.751"></a><span id="l5.751">     if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l5.752"></a><span id="l5.752">         this.agendaListbox.deleteItemsFromCalendar(aCalendar);</span>
<a href="#l5.753"></a><span id="l5.753">     }</span>
<a href="#l5.754"></a><span id="l5.754"> };</span>
<a href="#l5.755"></a><span id="l5.755"> </span>
<a href="#l5.756"></a><span id="l5.756" class="difflineminus">-agendaListbox.calendarObserver.onCalendarAdded =</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineminus">-function agenda_calAdded(aCalendar) {</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+agendaListbox.calendarObserver.onCalendarAdded = function(aCalendar) {</span>
<a href="#l5.759"></a><span id="l5.759">     if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l5.760"></a><span id="l5.760">         this.agendaListbox.refreshCalendarQuery(null, null, aCalendar);</span>
<a href="#l5.761"></a><span id="l5.761">     }</span>
<a href="#l5.762"></a><span id="l5.762"> };</span>
<a href="#l5.763"></a><span id="l5.763"> </span>
<a href="#l5.764"></a><span id="l5.764"> agendaListbox.calendarObserver.onDefaultCalendarChanged = function(aCalendar) {</span>
<a href="#l5.765"></a><span id="l5.765"> };</span>
<a href="#l5.766"></a><span id="l5.766"> </span>
<a href="#l5.767"></a><span id="l5.767"> /**</span>
<a href="#l5.768"></a><span id="l5.768">  * Updates the &quot;Upcoming&quot; section of today pane when preference soondays changes</span>
<a href="#l5.769"></a><span id="l5.769">  **/</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineminus">-agendaListbox.updateSoonSection =</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineminus">-function updateSoonSection() {</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+agendaListbox.updateSoonSection = function() {</span>
<a href="#l5.773"></a><span id="l5.773">     this.soon.duration = this.soonDays;</span>
<a href="#l5.774"></a><span id="l5.774">     this.soon.open = true;</span>
<a href="#l5.775"></a><span id="l5.775">     let soonHeader = document.getElementById(&quot;nextweek-header&quot;);</span>
<a href="#l5.776"></a><span id="l5.776">     if (soonHeader) {</span>
<a href="#l5.777"></a><span id="l5.777">         soonHeader.setItem(this.soon, true);</span>
<a href="#l5.778"></a><span id="l5.778">         agendaListbox.refreshPeriodDates(now());</span>
<a href="#l5.779"></a><span id="l5.779">     }</span>
<a href="#l5.780"></a><span id="l5.780"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -46,17 +46,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">       ({ WorkdaysOnly:  1,</span>
<a href="#l6.5"></a><span id="l6.5">          TasksInView:   2,</span>
<a href="#l6.6"></a><span id="l6.6">          ShowCompleted: 4,</span>
<a href="#l6.7"></a><span id="l6.7">       })</span>
<a href="#l6.8"></a><span id="l6.8">       ]]&gt;&lt;/field&gt;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">       &lt;field name=&quot;mPrefObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.11"></a><span id="l6.11">       ({ calView: this,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-         observe: function calViewPrefChange(subj, topic, pref) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+         observe: function(subj, topic, pref) {</span>
<a href="#l6.14"></a><span id="l6.14">              this.calView.handlePreference(subj, topic, pref);</span>
<a href="#l6.15"></a><span id="l6.15">              return;</span>
<a href="#l6.16"></a><span id="l6.16">          }</span>
<a href="#l6.17"></a><span id="l6.17">       })</span>
<a href="#l6.18"></a><span id="l6.18">       ]]&gt;&lt;/field&gt;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">       &lt;field name=&quot;mObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.21"></a><span id="l6.21">         // the calIObserver, calICompositeObserver, and calIAlarmServiceObserver</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -64,26 +64,26 @@</span>
<a href="#l6.23"></a><span id="l6.23">             QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l6.24"></a><span id="l6.24">                 Components.interfaces.calIObserver,</span>
<a href="#l6.25"></a><span id="l6.25">                 Components.interfaces.calIAlarmServiceObserver,</span>
<a href="#l6.26"></a><span id="l6.26">                 Components.interfaces.calICompositeObserver</span>
<a href="#l6.27"></a><span id="l6.27">             ]),</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">             calView: this,</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-            onStartBatch: function onStartBatch() {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+            onStartBatch: function() {</span>
<a href="#l6.33"></a><span id="l6.33">             },</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-            onEndBatch: function onEndBatch() {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+            onEndBatch: function() {</span>
<a href="#l6.36"></a><span id="l6.36">             },</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-            onLoad: function onLoad() {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+            onLoad: function() {</span>
<a href="#l6.40"></a><span id="l6.40">                 this.calView.refresh();</span>
<a href="#l6.41"></a><span id="l6.41">             },</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-            onAddItem: function onAddItem(aItem) {</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+            onAddItem: function(aItem) {</span>
<a href="#l6.45"></a><span id="l6.45">                 if (cal.isToDo(aItem)) {</span>
<a href="#l6.46"></a><span id="l6.46">                     if (!aItem.entryDate &amp;&amp; !aItem.dueDate) {</span>
<a href="#l6.47"></a><span id="l6.47">                         return;</span>
<a href="#l6.48"></a><span id="l6.48">                     }</span>
<a href="#l6.49"></a><span id="l6.49">                     if (!this.calView.mTasksInView) {</span>
<a href="#l6.50"></a><span id="l6.50">                         return;</span>
<a href="#l6.51"></a><span id="l6.51">                     }</span>
<a href="#l6.52"></a><span id="l6.52">                     if (aItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineat">@@ -95,17 +95,17 @@</span>
<a href="#l6.54"></a><span id="l6.54">                                                        this.calView.queryEndDate,</span>
<a href="#l6.55"></a><span id="l6.55">                                                        {});</span>
<a href="#l6.56"></a><span id="l6.56">                 for (let occ of occs) {</span>
<a href="#l6.57"></a><span id="l6.57">                     this.calView.doAddItem(occ);</span>
<a href="#l6.58"></a><span id="l6.58">                 }</span>
<a href="#l6.59"></a><span id="l6.59">                 return;</span>
<a href="#l6.60"></a><span id="l6.60">             },</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-            onModifyItem: function onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+            onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l6.64"></a><span id="l6.64">                 if (cal.isToDo(aNewItem) &amp;&amp; cal.isToDo(aOldItem) &amp;&amp;</span>
<a href="#l6.65"></a><span id="l6.65">                     !this.calView.mTasksInView) {</span>
<a href="#l6.66"></a><span id="l6.66">                     return;</span>
<a href="#l6.67"></a><span id="l6.67">                 }</span>
<a href="#l6.68"></a><span id="l6.68">                 let occs;</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70">                 if (!cal.isToDo(aOldItem) || aOldItem.entryDate || aOldItem.dueDate) {</span>
<a href="#l6.71"></a><span id="l6.71">                     occs = aOldItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineat">@@ -127,17 +127,17 @@</span>
<a href="#l6.73"></a><span id="l6.73">                 occs = aNewItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l6.74"></a><span id="l6.74">                                                       this.calView.queryEndDate,</span>
<a href="#l6.75"></a><span id="l6.75">                                                       {});</span>
<a href="#l6.76"></a><span id="l6.76">                 for (let occ of occs) {</span>
<a href="#l6.77"></a><span id="l6.77">                     this.calView.doAddItem(occ);</span>
<a href="#l6.78"></a><span id="l6.78">                 }</span>
<a href="#l6.79"></a><span id="l6.79">             },</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-            onDeleteItem: function onDeleteItem(aItem) {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+            onDeleteItem: function(aItem) {</span>
<a href="#l6.83"></a><span id="l6.83">                 if (cal.isToDo(aItem)) {</span>
<a href="#l6.84"></a><span id="l6.84">                     if (!this.calView.mTasksInView) {</span>
<a href="#l6.85"></a><span id="l6.85">                         return;</span>
<a href="#l6.86"></a><span id="l6.86">                     }</span>
<a href="#l6.87"></a><span id="l6.87">                     if (!aItem.entryDate &amp;&amp; !aItem.dueDate) {</span>
<a href="#l6.88"></a><span id="l6.88">                         return;</span>
<a href="#l6.89"></a><span id="l6.89">                     }</span>
<a href="#l6.90"></a><span id="l6.90">                     if (aItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineat">@@ -148,17 +148,17 @@</span>
<a href="#l6.92"></a><span id="l6.92">                 let occs = aItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l6.93"></a><span id="l6.93">                                                        this.calView.queryEndDate,</span>
<a href="#l6.94"></a><span id="l6.94">                                                        {});</span>
<a href="#l6.95"></a><span id="l6.95">                 for (let occ of occs) {</span>
<a href="#l6.96"></a><span id="l6.96">                     this.calView.doDeleteItem(occ);</span>
<a href="#l6.97"></a><span id="l6.97">                 }</span>
<a href="#l6.98"></a><span id="l6.98">             },</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-            onError: function onError(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+            onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">             onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l6.104"></a><span id="l6.104">                 switch (aName) {</span>
<a href="#l6.105"></a><span id="l6.105">                     case &quot;suppressAlarms&quot;:</span>
<a href="#l6.106"></a><span id="l6.106">                         if (!Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true) ||</span>
<a href="#l6.107"></a><span id="l6.107">                             aCalendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false) {</span>
<a href="#l6.108"></a><span id="l6.108">                             break;</span>
<a href="#l6.109"></a><span id="l6.109">                         }</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineat">@@ -174,55 +174,54 @@</span>
<a href="#l6.111"></a><span id="l6.111">             onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l6.112"></a><span id="l6.112">                 // Values are not important here yet.</span>
<a href="#l6.113"></a><span id="l6.113">                 this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l6.114"></a><span id="l6.114">             },</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">             //</span>
<a href="#l6.117"></a><span id="l6.117">             // calIAlarmServiceObserver stuff</span>
<a href="#l6.118"></a><span id="l6.118">             //</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-            onAlarm: function onAlarm(aAlarmItem) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+            onAlarm: function(aAlarmItem) {</span>
<a href="#l6.121"></a><span id="l6.121">                 this.calView.flashAlarm(aAlarmItem, false);</span>
<a href="#l6.122"></a><span id="l6.122">             },</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-            onRemoveAlarmsByItem: function onRemoveAlarmsByItem(aItem) {</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+            onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l6.126"></a><span id="l6.126">                 // Stop the flashing for the item.</span>
<a href="#l6.127"></a><span id="l6.127">                 this.calView.flashAlarm(aItem, true);</span>
<a href="#l6.128"></a><span id="l6.128">             },</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-            onRemoveAlarmsByCalendar: function onRemoveAlarmsByCalendar(aCalendar) {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+            onRemoveAlarmsByCalendar: function(aCalendar) {</span>
<a href="#l6.132"></a><span id="l6.132">                 // Stop the flashing for all items of this calendar</span>
<a href="#l6.133"></a><span id="l6.133">                 for (let key in this.calView.mFlashingEvents) {</span>
<a href="#l6.134"></a><span id="l6.134">                     let item = this.calView.mFlashingEvents[key];</span>
<a href="#l6.135"></a><span id="l6.135">                     if (item.calendar.id == aCalendar.id) {</span>
<a href="#l6.136"></a><span id="l6.136">                         this.calView.flashAlarm(item, true);</span>
<a href="#l6.137"></a><span id="l6.137">                     }</span>
<a href="#l6.138"></a><span id="l6.138">                 }</span>
<a href="#l6.139"></a><span id="l6.139">             },</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-            onAlarmsLoaded: function _onAlarmsLoaded(aCalendar) {},</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+            onAlarmsLoaded: function(aCalendar) {},</span>
<a href="#l6.143"></a><span id="l6.143"> </span>
<a href="#l6.144"></a><span id="l6.144">             //</span>
<a href="#l6.145"></a><span id="l6.145">             // calICompositeObserver stuff</span>
<a href="#l6.146"></a><span id="l6.146">             // XXXvv we can be smarter about how we handle this stuff</span>
<a href="#l6.147"></a><span id="l6.147">             //</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-            onCalendarAdded: function onCalendarAdded(aCalendar) {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+            onCalendarAdded: function(aCalendar) {</span>
<a href="#l6.150"></a><span id="l6.150">                 if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l6.151"></a><span id="l6.151">                     this.calView.addItemsFromCalendar(aCalendar);</span>
<a href="#l6.152"></a><span id="l6.152">                 }</span>
<a href="#l6.153"></a><span id="l6.153">             },</span>
<a href="#l6.154"></a><span id="l6.154"> </span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-            onCalendarRemoved: function onCalendarRemoved(aCalendar) {</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+            onCalendarRemoved: function(aCalendar) {</span>
<a href="#l6.157"></a><span id="l6.157">                 if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l6.158"></a><span id="l6.158">                     this.calView.deleteItemsFromCalendar(aCalendar);</span>
<a href="#l6.159"></a><span id="l6.159">                 }</span>
<a href="#l6.160"></a><span id="l6.160">             },</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-            onDefaultCalendarChanged:</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-            function onDefaultCalendarChanged(aNewDefaultCalendar) {</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+            onDefaultCalendarChanged: function(aNewDefaultCalendar) {</span>
<a href="#l6.165"></a><span id="l6.165">                 // don't care, for now</span>
<a href="#l6.166"></a><span id="l6.166">             }</span>
<a href="#l6.167"></a><span id="l6.167">         })</span>
<a href="#l6.168"></a><span id="l6.168">       ]]&gt;&lt;/field&gt;</span>
<a href="#l6.169"></a><span id="l6.169"> </span>
<a href="#l6.170"></a><span id="l6.170">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l6.171"></a><span id="l6.171">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.172"></a><span id="l6.172">         Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineat">@@ -242,20 +241,19 @@</span>
<a href="#l6.174"></a><span id="l6.174">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l6.175"></a><span id="l6.175">         this.showCompleted = (document.getElementById(kShowCompleted)</span>
<a href="#l6.176"></a><span id="l6.176">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l6.177"></a><span id="l6.177"> </span>
<a href="#l6.178"></a><span id="l6.178">         this.mTimezone = calendarDefaultTimezone();</span>
<a href="#l6.179"></a><span id="l6.179">         let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l6.180"></a><span id="l6.180">                            .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l6.181"></a><span id="l6.181">         alarmService.addObserver(this.mObserver);</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-        let self = this;</span>
<a href="#l6.183"></a><span id="l6.183">         this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-        this.mResizeHandler = function resizeHandler() {</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-            self.onResize(self);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+        this.mResizeHandler = () =&gt; {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+            this.onResize(this);</span>
<a href="#l6.188"></a><span id="l6.188">         };</span>
<a href="#l6.189"></a><span id="l6.189">         this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l6.190"></a><span id="l6.190">         // add a preference observer to monitor changes</span>
<a href="#l6.191"></a><span id="l6.191">         Services.prefs.addObserver(&quot;calendar.&quot;, this.mPrefObserver, false);</span>
<a href="#l6.192"></a><span id="l6.192">         this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l6.193"></a><span id="l6.193">         this.updateDaysOffPrefs();</span>
<a href="#l6.194"></a><span id="l6.194">         this.mPendingRefreshJobs = new Map();</span>
<a href="#l6.195"></a><span id="l6.195">         this.mLog = Log4Moz.getConfiguredLogger(&quot;calBaseView&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -88,33 +88,33 @@ var calendarController = {</span>
<a href="#l7.4"></a><span id="l7.4">         &quot;calendar_in_foreground&quot;: true,</span>
<a href="#l7.5"></a><span id="l7.5">         &quot;calendar_in_background&quot;: true,</span>
<a href="#l7.6"></a><span id="l7.6">         &quot;calendar_mode_calendar&quot;: true,</span>
<a href="#l7.7"></a><span id="l7.7">         &quot;calendar_mode_task&quot;: true,</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">         &quot;cmd_selectAll&quot;: true</span>
<a href="#l7.10"></a><span id="l7.10">     },</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    updateCommands: function cC_updateCommands() {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    updateCommands: function() {</span>
<a href="#l7.14"></a><span id="l7.14">         for (let command in this.commands) {</span>
<a href="#l7.15"></a><span id="l7.15">             goUpdateCommand(command);</span>
<a href="#l7.16"></a><span id="l7.16">         }</span>
<a href="#l7.17"></a><span id="l7.17">     },</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-    supportsCommand: function cC_supportsCommand(aCommand) {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    supportsCommand: function(aCommand) {</span>
<a href="#l7.21"></a><span id="l7.21">         if (aCommand in this.commands) {</span>
<a href="#l7.22"></a><span id="l7.22">             return true;</span>
<a href="#l7.23"></a><span id="l7.23">         }</span>
<a href="#l7.24"></a><span id="l7.24">         if (this.defaultContoller) {</span>
<a href="#l7.25"></a><span id="l7.25">             return this.defaultContoller.supportsCommand(aCommand);</span>
<a href="#l7.26"></a><span id="l7.26">         }</span>
<a href="#l7.27"></a><span id="l7.27">         return false;</span>
<a href="#l7.28"></a><span id="l7.28">     },</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-    isCommandEnabled: function cC_isCommandEnabled(aCommand) {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+    isCommandEnabled: function(aCommand) {</span>
<a href="#l7.32"></a><span id="l7.32">         switch (aCommand) {</span>
<a href="#l7.33"></a><span id="l7.33">             case &quot;calendar_new_event_command&quot;:</span>
<a href="#l7.34"></a><span id="l7.34">             case &quot;calendar_new_event_context_command&quot;:</span>
<a href="#l7.35"></a><span id="l7.35">                 return CalendarNewEventsCommandEnabled;</span>
<a href="#l7.36"></a><span id="l7.36">             case &quot;calendar_modify_focused_item_command&quot;:</span>
<a href="#l7.37"></a><span id="l7.37">                 return this.item_selected;</span>
<a href="#l7.38"></a><span id="l7.38">             case &quot;calendar_modify_event_command&quot;:</span>
<a href="#l7.39"></a><span id="l7.39">                 return this.item_selected;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineat">@@ -252,17 +252,17 @@ var calendarController = {</span>
<a href="#l7.41"></a><span id="l7.41">                 if (aCommand in this.commands) {</span>
<a href="#l7.42"></a><span id="l7.42">                     // All other commands we support should be enabled by default</span>
<a href="#l7.43"></a><span id="l7.43">                     return true;</span>
<a href="#l7.44"></a><span id="l7.44">                 }</span>
<a href="#l7.45"></a><span id="l7.45">         }</span>
<a href="#l7.46"></a><span id="l7.46">         return false;</span>
<a href="#l7.47"></a><span id="l7.47">     },</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    doCommand: function cC_doCommand(aCommand) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    doCommand: function(aCommand) {</span>
<a href="#l7.51"></a><span id="l7.51">         switch (aCommand) {</span>
<a href="#l7.52"></a><span id="l7.52">             // Common Commands</span>
<a href="#l7.53"></a><span id="l7.53">             case &quot;calendar_new_event_command&quot;:</span>
<a href="#l7.54"></a><span id="l7.54">                 createEventWithDialog(getSelectedCalendar(),</span>
<a href="#l7.55"></a><span id="l7.55">                                       getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l7.56"></a><span id="l7.56">                 break;</span>
<a href="#l7.57"></a><span id="l7.57">             case &quot;calendar_new_event_context_command&quot;: {</span>
<a href="#l7.58"></a><span id="l7.58">                 let newStart = currentView().selectedDateTime;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineat">@@ -425,36 +425,36 @@ var calendarController = {</span>
<a href="#l7.60"></a><span id="l7.60">                     this.defaultController.doCommand(aCommand);</span>
<a href="#l7.61"></a><span id="l7.61">                     return;</span>
<a href="#l7.62"></a><span id="l7.62">                 }</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64">         }</span>
<a href="#l7.65"></a><span id="l7.65">         return;</span>
<a href="#l7.66"></a><span id="l7.66">     },</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    onEvent: function cC_onEvent(aEvent) {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    onEvent: function(aEvent) {</span>
<a href="#l7.70"></a><span id="l7.70">     },</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    isCalendarInForeground: function cC_isCalendarInForeground() {</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    isCalendarInForeground: function() {</span>
<a href="#l7.74"></a><span id="l7.74">         return gCurrentMode &amp;&amp; gCurrentMode != &quot;mail&quot;;</span>
<a href="#l7.75"></a><span id="l7.75">     },</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    isInMode: function cC_isInMode(mode) {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    isInMode: function(mode) {</span>
<a href="#l7.79"></a><span id="l7.79">         switch (mode) {</span>
<a href="#l7.80"></a><span id="l7.80">             case &quot;mail&quot;:</span>
<a href="#l7.81"></a><span id="l7.81">                 return !isCalendarInForeground();</span>
<a href="#l7.82"></a><span id="l7.82">             case &quot;calendar&quot;:</span>
<a href="#l7.83"></a><span id="l7.83">                 return gCurrentMode &amp;&amp; gCurrentMode == &quot;calendar&quot;;</span>
<a href="#l7.84"></a><span id="l7.84">             case &quot;task&quot;:</span>
<a href="#l7.85"></a><span id="l7.85">                 return gCurrentMode &amp;&amp; gCurrentMode == &quot;task&quot;;</span>
<a href="#l7.86"></a><span id="l7.86">         }</span>
<a href="#l7.87"></a><span id="l7.87">         return false;</span>
<a href="#l7.88"></a><span id="l7.88">     },</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-    onSelectionChanged: function cC_onSelectionChanged(aEvent) {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    onSelectionChanged: function(aEvent) {</span>
<a href="#l7.92"></a><span id="l7.92">         let selectedItems = aEvent.detail;</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">         calendarUpdateDeleteCommand(selectedItems);</span>
<a href="#l7.95"></a><span id="l7.95">         calendarController.item_selected = selectedItems &amp;&amp; (selectedItems.length &gt; 0);</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97">         let selLength = (selectedItems === undefined ? 0 : selectedItems.length);</span>
<a href="#l7.98"></a><span id="l7.98">         let selected_events_readonly = 0;</span>
<a href="#l7.99"></a><span id="l7.99">         let selected_events_requires_network = 0;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineat">@@ -669,17 +669,17 @@ var calendarController2 = {</span>
<a href="#l7.101"></a><span id="l7.101">         &quot;cmd_showQuickFilterBar&quot;: true</span>
<a href="#l7.102"></a><span id="l7.102">     },</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104">     // These functions can use the same from the calendar controller for now.</span>
<a href="#l7.105"></a><span id="l7.105">     updateCommands: calendarController.updateCommands,</span>
<a href="#l7.106"></a><span id="l7.106">     supportsCommand: calendarController.supportsCommand,</span>
<a href="#l7.107"></a><span id="l7.107">     onEvent: calendarController.onEvent,</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-    isCommandEnabled: function isCommandEnabled(aCommand) {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    isCommandEnabled: function(aCommand) {</span>
<a href="#l7.111"></a><span id="l7.111">         switch (aCommand) {</span>
<a href="#l7.112"></a><span id="l7.112">             // Thunderbird Commands</span>
<a href="#l7.113"></a><span id="l7.113">             case &quot;cmd_cut&quot;:</span>
<a href="#l7.114"></a><span id="l7.114">                 return calendarController.selected_items_writable;</span>
<a href="#l7.115"></a><span id="l7.115">             case &quot;cmd_copy&quot;:</span>
<a href="#l7.116"></a><span id="l7.116">                 return calendarController.item_selected;</span>
<a href="#l7.117"></a><span id="l7.117">             case &quot;cmd_paste&quot;:</span>
<a href="#l7.118"></a><span id="l7.118">                 return canPaste();</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineat">@@ -702,17 +702,17 @@ var calendarController2 = {</span>
<a href="#l7.120"></a><span id="l7.120">                 return false;</span>
<a href="#l7.121"></a><span id="l7.121">             case &quot;cmd_showQuickFilterBar&quot;:</span>
<a href="#l7.122"></a><span id="l7.122">                 return calendarController.isInMode(&quot;task&quot;);</span>
<a href="#l7.123"></a><span id="l7.123">             default:</span>
<a href="#l7.124"></a><span id="l7.124">                 return true;</span>
<a href="#l7.125"></a><span id="l7.125">         }</span>
<a href="#l7.126"></a><span id="l7.126">     },</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-    doCommand: function doCommand(aCommand) {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    doCommand: function(aCommand) {</span>
<a href="#l7.130"></a><span id="l7.130">         switch (aCommand) {</span>
<a href="#l7.131"></a><span id="l7.131">             case &quot;cmd_cut&quot;:</span>
<a href="#l7.132"></a><span id="l7.132">                 cutToClipboard();</span>
<a href="#l7.133"></a><span id="l7.133">                 break;</span>
<a href="#l7.134"></a><span id="l7.134">             case &quot;cmd_copy&quot;:</span>
<a href="#l7.135"></a><span id="l7.135">                 copyToClipboard();</span>
<a href="#l7.136"></a><span id="l7.136">                 break;</span>
<a href="#l7.137"></a><span id="l7.137">             case &quot;cmd_paste&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-extract.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-extract.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> Components.utils.import(&quot;resource://calendar/modules/calExtract.jsm&quot;);</span>
<a href="#l8.8"></a><span id="l8.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.9"></a><span id="l8.9"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> var calendarExtract = {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    onShowLocaleMenu: function onShowLocaleMenu(target) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    onShowLocaleMenu: function(target) {</span>
<a href="#l8.14"></a><span id="l8.14">         let localeList = document.getElementById(target.id);</span>
<a href="#l8.15"></a><span id="l8.15">         let langs = [];</span>
<a href="#l8.16"></a><span id="l8.16">         let chrome = Components.classes[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l8.17"></a><span id="l8.17">                                .getService(Components.interfaces.nsIXULChromeRegistry);</span>
<a href="#l8.18"></a><span id="l8.18">         chrome.QueryInterface(Components.interfaces.nsIToolkitChromeRegistry);</span>
<a href="#l8.19"></a><span id="l8.19">         let locales = chrome.getLocalesForPackage(&quot;calendar&quot;);</span>
<a href="#l8.20"></a><span id="l8.20">         let langRegex = /^(([^-]+)-*(.*))$/;</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -54,23 +54,23 @@ var calendarExtract = {</span>
<a href="#l8.23"></a><span id="l8.23">         });</span>
<a href="#l8.24"></a><span id="l8.24">         removeChildren(localeList);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">         for (let lang of langs) {</span>
<a href="#l8.27"></a><span id="l8.27">             addMenuItem(localeList, lang[0], lang[1], null);</span>
<a href="#l8.28"></a><span id="l8.28">         }</span>
<a href="#l8.29"></a><span id="l8.29">     },</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    extractWithLocale: function extractWithLocale(event, isEvent) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    extractWithLocale: function(event, isEvent) {</span>
<a href="#l8.33"></a><span id="l8.33">         event.stopPropagation();</span>
<a href="#l8.34"></a><span id="l8.34">         let locale = event.target.value;</span>
<a href="#l8.35"></a><span id="l8.35">         this.extractFromEmail(isEvent, true, locale);</span>
<a href="#l8.36"></a><span id="l8.36">     },</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    extractFromEmail: function extractFromEmail(isEvent, fixedLang, fixedLocale) {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    extractFromEmail: function(isEvent, fixedLang, fixedLocale) {</span>
<a href="#l8.40"></a><span id="l8.40">         // TODO would be nice to handle multiple selected messages,</span>
<a href="#l8.41"></a><span id="l8.41">         // though old conversion functionality didn't</span>
<a href="#l8.42"></a><span id="l8.42">         let message = gFolderDisplay.selectedMessage;</span>
<a href="#l8.43"></a><span id="l8.43">         let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l8.44"></a><span id="l8.44">                                   .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l8.45"></a><span id="l8.45">         let listener = Components.classes[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l8.46"></a><span id="l8.46">                                  .createInstance(Components.interfaces.nsISyncStreamListener);</span>
<a href="#l8.47"></a><span id="l8.47">         let uri = message.folder.getUriForMsg(message);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineat">@@ -204,34 +204,34 @@ var calendarExtract = {</span>
<a href="#l8.49"></a><span id="l8.49">                 createEventWithDialog(null, null, null, null, item);</span>
<a href="#l8.50"></a><span id="l8.50">             }</span>
<a href="#l8.51"></a><span id="l8.51">         }</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">         let timeSpent = (new Date()).getTime() - time;</span>
<a href="#l8.54"></a><span id="l8.54">         cal.LOG(&quot;[calExtract] Total time spent for conversion (including loading of dictionaries): &quot; + timeSpent + &quot;ms&quot;);</span>
<a href="#l8.55"></a><span id="l8.55">     },</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    addListeners: function addListeners() {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    addListeners: function() {</span>
<a href="#l8.59"></a><span id="l8.59">         if (window.top.document.location == &quot;chrome://messenger/content/messenger.xul&quot;) {</span>
<a href="#l8.60"></a><span id="l8.60">             // covers initial load and folder change</span>
<a href="#l8.61"></a><span id="l8.61">             let folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l8.62"></a><span id="l8.62">             folderTree.addEventListener(&quot;select&quot;, this.setState, false);</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">             // covers selection change in a folder</span>
<a href="#l8.65"></a><span id="l8.65">             let msgTree = window.top.GetThreadTree();</span>
<a href="#l8.66"></a><span id="l8.66">             msgTree.addEventListener(&quot;select&quot;, this.setState, false);</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">             window.addEventListener(&quot;unload&quot;, () =&gt; {</span>
<a href="#l8.69"></a><span id="l8.69">                 folderTree.removeEventListener(&quot;select&quot;, this.setState, false);</span>
<a href="#l8.70"></a><span id="l8.70">                 msgTree.removeEventListener(&quot;select&quot;, this.setState, false);</span>
<a href="#l8.71"></a><span id="l8.71">             }, false);</span>
<a href="#l8.72"></a><span id="l8.72">         }</span>
<a href="#l8.73"></a><span id="l8.73">     },</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    setState: function setState() {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    setState: function() {</span>
<a href="#l8.77"></a><span id="l8.77">         let eventButton = document.getElementById(&quot;extractEventButton&quot;);</span>
<a href="#l8.78"></a><span id="l8.78">         let taskButton = document.getElementById(&quot;extractTaskButton&quot;);</span>
<a href="#l8.79"></a><span id="l8.79">         let hdrEventButton = document.getElementById(&quot;hdrExtractEventButton&quot;);</span>
<a href="#l8.80"></a><span id="l8.80">         let hdrTaskButton = document.getElementById(&quot;hdrExtractTaskButton&quot;);</span>
<a href="#l8.81"></a><span id="l8.81">         let contextMenu = document.getElementById(&quot;mailContext-calendar-convert-menu&quot;);</span>
<a href="#l8.82"></a><span id="l8.82">         let contextMenuEvent = document.getElementById(&quot;mailContext-calendar-convert-event-menuitem&quot;);</span>
<a href="#l8.83"></a><span id="l8.83">         let contextMenuTask = document.getElementById(&quot;mailContext-calendar-convert-task-menuitem&quot;);</span>
<a href="#l8.84"></a><span id="l8.84">         let eventDisabled = (gFolderDisplay.selectedCount == 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -16,26 +16,26 @@ var gInvitationsRequestManager = {</span>
<a href="#l9.4"></a><span id="l9.4">     mRequestStatusList: {},</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">     /**</span>
<a href="#l9.7"></a><span id="l9.7">      * Add a request to the request manager.</span>
<a href="#l9.8"></a><span id="l9.8">      *</span>
<a href="#l9.9"></a><span id="l9.9">      * @param calendar    The calendar to add for.</span>
<a href="#l9.10"></a><span id="l9.10">      * @param op          The operation to add</span>
<a href="#l9.11"></a><span id="l9.11">      */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    addRequestStatus: function IRM_addRequestStatus(calendar, op) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    addRequestStatus: function(calendar, op) {</span>
<a href="#l9.14"></a><span id="l9.14">         if (op) {</span>
<a href="#l9.15"></a><span id="l9.15">             this.mRequestStatusList[calendar.id] = op;</span>
<a href="#l9.16"></a><span id="l9.16">         }</span>
<a href="#l9.17"></a><span id="l9.17">     },</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">     /**</span>
<a href="#l9.20"></a><span id="l9.20">      * Cancel all pending requests</span>
<a href="#l9.21"></a><span id="l9.21">      */</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    cancelPendingRequests: function IRM_cancelPendingRequests() {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+    cancelPendingRequests: function() {</span>
<a href="#l9.24"></a><span id="l9.24">         for (let id in this.mRequestStatusList) {</span>
<a href="#l9.25"></a><span id="l9.25">             let request = this.mRequestStatusList[id];</span>
<a href="#l9.26"></a><span id="l9.26">             if (request &amp;&amp; request.isPending) {</span>
<a href="#l9.27"></a><span id="l9.27">                 request.cancel(null);</span>
<a href="#l9.28"></a><span id="l9.28">             }</span>
<a href="#l9.29"></a><span id="l9.29">         }</span>
<a href="#l9.30"></a><span id="l9.30">         this.mRequestStatusList = {};</span>
<a href="#l9.31"></a><span id="l9.31">     }</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineat">@@ -82,48 +82,45 @@ InvitationsManager.prototype = {</span>
<a href="#l9.33"></a><span id="l9.33">     mTimer: null,</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">     /**</span>
<a href="#l9.36"></a><span id="l9.36">      * Schedule an update for the invitations manager asynchronously.</span>
<a href="#l9.37"></a><span id="l9.37">      *</span>
<a href="#l9.38"></a><span id="l9.38">      * @param firstDelay          The timeout before the operation should start.</span>
<a href="#l9.39"></a><span id="l9.39">      * @param operationListener   The calIGenericOperationListener to notify.</span>
<a href="#l9.40"></a><span id="l9.40">      */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    scheduleInvitationsUpdate: function IM_scheduleInvitationsUpdate(firstDelay,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-                                                                     operationListener) {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+    scheduleInvitationsUpdate: function(firstDelay, operationListener) {</span>
<a href="#l9.44"></a><span id="l9.44">         this.cancelInvitationsUpdate();</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-        let self = this;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-        this.mTimer = setTimeout(function startInvitationsTimer() {</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+        this.mTimer = setTimeout(() =&gt; {</span>
<a href="#l9.49"></a><span id="l9.49">             if (Preferences.get(&quot;calendar.invitations.autorefresh.enabled&quot;, true)) {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-                self.mTimer = setInterval(function repeatingInvitationsTimer() {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-                    self.getInvitations(operationListener);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+                this.mTimer = setInterval(() =&gt; {</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+                    this.getInvitations(operationListener);</span>
<a href="#l9.54"></a><span id="l9.54">                     }, Preferences.get(&quot;calendar.invitations.autorefresh.timeout&quot;, 3) * 60000);</span>
<a href="#l9.55"></a><span id="l9.55">             }</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-            self.getInvitations(operationListener);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+            this.getInvitations(operationListener);</span>
<a href="#l9.58"></a><span id="l9.58">         }, firstDelay);</span>
<a href="#l9.59"></a><span id="l9.59">     },</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61">     /**</span>
<a href="#l9.62"></a><span id="l9.62">      * Cancel pending any pending invitations update.</span>
<a href="#l9.63"></a><span id="l9.63">      */</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    cancelInvitationsUpdate: function IM_cancelInvitationsUpdate() {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+    cancelInvitationsUpdate: function() {</span>
<a href="#l9.66"></a><span id="l9.66">         clearTimeout(this.mTimer);</span>
<a href="#l9.67"></a><span id="l9.67">     },</span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69">     /**</span>
<a href="#l9.70"></a><span id="l9.70">      * Retrieve invitations from all calendars. Notify all passed</span>
<a href="#l9.71"></a><span id="l9.71">      * operation listeners.</span>
<a href="#l9.72"></a><span id="l9.72">      *</span>
<a href="#l9.73"></a><span id="l9.73">      * @param operationListener1    The first operation listener to notify.</span>
<a href="#l9.74"></a><span id="l9.74">      * @param operationListener2    (optinal) The second operation listener to</span>
<a href="#l9.75"></a><span id="l9.75">      *                                notify.</span>
<a href="#l9.76"></a><span id="l9.76">      */</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    getInvitations: function IM_getInvitations(operationListener1,</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-                                               operationListener2) {</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    getInvitations: function(operationListener1, operationListener2) {</span>
<a href="#l9.80"></a><span id="l9.80">         let listeners = [];</span>
<a href="#l9.81"></a><span id="l9.81">         if (operationListener1) {</span>
<a href="#l9.82"></a><span id="l9.82">             listeners.push(operationListener1);</span>
<a href="#l9.83"></a><span id="l9.83">         }</span>
<a href="#l9.84"></a><span id="l9.84">         if (operationListener2) {</span>
<a href="#l9.85"></a><span id="l9.85">             listeners.push(operationListener2);</span>
<a href="#l9.86"></a><span id="l9.86">         }</span>
<a href="#l9.87"></a><span id="l9.87"> </span>
<a href="#l9.88"></a><span id="l9.88" class="difflineat">@@ -234,18 +231,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.89"></a><span id="l9.89">      * sounds fishy to me. Maybe there is a more encapsulated solution.</span>
<a href="#l9.90"></a><span id="l9.90">      *</span>
<a href="#l9.91"></a><span id="l9.91">      * @param onLoadOpListener          The operation listener to notify when</span>
<a href="#l9.92"></a><span id="l9.92">      *                                    getting invitations. Should be passed</span>
<a href="#l9.93"></a><span id="l9.93">      *                                    to this.getInvitations().</span>
<a href="#l9.94"></a><span id="l9.94">      * @param finishedCallBack          A callback function to call when the</span>
<a href="#l9.95"></a><span id="l9.95">      *                                    dialog has completed.</span>
<a href="#l9.96"></a><span id="l9.96">      */</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    openInvitationsDialog: function IM_openInvitationsDialog(onLoadOpListener,</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-                                                             finishedCallBack) {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    openInvitationsDialog: function(onLoadOpListener, finishedCallBack) {</span>
<a href="#l9.100"></a><span id="l9.100">         let args = {};</span>
<a href="#l9.101"></a><span id="l9.101">         args.onLoadOperationListener = onLoadOpListener;</span>
<a href="#l9.102"></a><span id="l9.102">         args.queue = [];</span>
<a href="#l9.103"></a><span id="l9.103">         args.finishedCallBack = finishedCallBack;</span>
<a href="#l9.104"></a><span id="l9.104">         args.requestManager = gInvitationsRequestManager;</span>
<a href="#l9.105"></a><span id="l9.105">         args.invitationsManager = this;</span>
<a href="#l9.106"></a><span id="l9.106">         // the dialog will reset this to auto when it is done loading</span>
<a href="#l9.107"></a><span id="l9.107">         window.setCursor(&quot;wait&quot;);</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineat">@@ -261,18 +257,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.109"></a><span id="l9.109">      * Process the passed job queue. A job is an object that consists of an</span>
<a href="#l9.110"></a><span id="l9.110">      * action, a newItem and and oldItem. This processor only takes &quot;modify&quot;</span>
<a href="#l9.111"></a><span id="l9.111">      * operations into account.</span>
<a href="#l9.112"></a><span id="l9.112">      *</span>
<a href="#l9.113"></a><span id="l9.113">      * @param queue                         The array of objects to process.</span>
<a href="#l9.114"></a><span id="l9.114">      * @param jobQueueFinishedCallBack      A callback function called when</span>
<a href="#l9.115"></a><span id="l9.115">      *                                        job has finished.</span>
<a href="#l9.116"></a><span id="l9.116">      */</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    processJobQueue: function IM_processJobQueue(queue,</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-                                                 jobQueueFinishedCallBack) {</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    processJobQueue: function(queue, jobQueueFinishedCallBack) {</span>
<a href="#l9.120"></a><span id="l9.120">         // TODO: undo/redo</span>
<a href="#l9.121"></a><span id="l9.121">         function operationListener(mgr, queueCallback, oldItem_) {</span>
<a href="#l9.122"></a><span id="l9.122">             this.mInvitationsManager = mgr;</span>
<a href="#l9.123"></a><span id="l9.123">             this.mJobQueueFinishedCallBack = queueCallback;</span>
<a href="#l9.124"></a><span id="l9.124">             this.mOldItem = oldItem_;</span>
<a href="#l9.125"></a><span id="l9.125">         }</span>
<a href="#l9.126"></a><span id="l9.126">         operationListener.prototype = {</span>
<a href="#l9.127"></a><span id="l9.127">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineat">@@ -327,31 +322,28 @@ InvitationsManager.prototype = {</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130">     /**</span>
<a href="#l9.131"></a><span id="l9.131">      * Checks if the internal item list contains the given item</span>
<a href="#l9.132"></a><span id="l9.132">      * XXXdbo       Please document these correctly.</span>
<a href="#l9.133"></a><span id="l9.133">      *</span>
<a href="#l9.134"></a><span id="l9.134">      * @param item      The item to look for.</span>
<a href="#l9.135"></a><span id="l9.135">      * @return          A boolean value indicating if the item was found.</span>
<a href="#l9.136"></a><span id="l9.136">      */</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-    hasItem: function IM_hasItem(item) {</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    hasItem: function(item) {</span>
<a href="#l9.139"></a><span id="l9.139">         let hid = item.hashId;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-        return this.mItemList.some(</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-            function someFunc(item_) {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-                return hid == item_.hashId;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-            });</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+        return this.mItemList.some(item_ =&gt; hid == item_.hashId);</span>
<a href="#l9.145"></a><span id="l9.145">     },</span>
<a href="#l9.146"></a><span id="l9.146"> </span>
<a href="#l9.147"></a><span id="l9.147">     /**</span>
<a href="#l9.148"></a><span id="l9.148">      * Adds an item to the internal item list.</span>
<a href="#l9.149"></a><span id="l9.149">      * XXXdbo       Please document these correctly.</span>
<a href="#l9.150"></a><span id="l9.150">      *</span>
<a href="#l9.151"></a><span id="l9.151">      * @param item      The item to add.</span>
<a href="#l9.152"></a><span id="l9.152">      */</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    addItem: function IM_addItem(item) {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+    addItem: function(item) {</span>
<a href="#l9.155"></a><span id="l9.155">         let recInfo = item.recurrenceInfo;</span>
<a href="#l9.156"></a><span id="l9.156">         if (recInfo &amp;&amp; !cal.isOpenInvitation(item)) {</span>
<a href="#l9.157"></a><span id="l9.157">             // scan exceptions:</span>
<a href="#l9.158"></a><span id="l9.158">             let ids = recInfo.getExceptionIds({});</span>
<a href="#l9.159"></a><span id="l9.159">             for (let id of ids) {</span>
<a href="#l9.160"></a><span id="l9.160">                 let ex = recInfo.getExceptionFor(id);</span>
<a href="#l9.161"></a><span id="l9.161">                 if (ex &amp;&amp; this.validateItem(ex) &amp;&amp; !this.hasItem(ex)) {</span>
<a href="#l9.162"></a><span id="l9.162">                     this.mItemList.push(ex);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineat">@@ -363,52 +355,49 @@ InvitationsManager.prototype = {</span>
<a href="#l9.164"></a><span id="l9.164">     },</span>
<a href="#l9.165"></a><span id="l9.165"> </span>
<a href="#l9.166"></a><span id="l9.166">     /**</span>
<a href="#l9.167"></a><span id="l9.167">      * Removes an item from the internal item list</span>
<a href="#l9.168"></a><span id="l9.168">      * XXXdbo       Please document these correctly.</span>
<a href="#l9.169"></a><span id="l9.169">      *</span>
<a href="#l9.170"></a><span id="l9.170">      * @param item      The item to remove.</span>
<a href="#l9.171"></a><span id="l9.171">      */</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-    deleteItem: function IM_deleteItem(item) {</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+    deleteItem: function(item) {</span>
<a href="#l9.174"></a><span id="l9.174">         let id = item.id;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-        this.mItemList.filter(</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-            function filterFunc(item_) {</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-                return id != item_.id;</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-            });</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+        this.mItemList.filter(item_ =&gt; id != item_.id);</span>
<a href="#l9.180"></a><span id="l9.180">     },</span>
<a href="#l9.181"></a><span id="l9.181"> </span>
<a href="#l9.182"></a><span id="l9.182">     /**</span>
<a href="#l9.183"></a><span id="l9.183">      * Remove all items from the internal item list</span>
<a href="#l9.184"></a><span id="l9.184">      * XXXdbo       Please document these correctly.</span>
<a href="#l9.185"></a><span id="l9.185">      */</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-    deleteAllItems: function IM_deleteAllItems() {</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+    deleteAllItems: function() {</span>
<a href="#l9.188"></a><span id="l9.188">         this.mItemList = [];</span>
<a href="#l9.189"></a><span id="l9.189">     },</span>
<a href="#l9.190"></a><span id="l9.190"> </span>
<a href="#l9.191"></a><span id="l9.191">     /**</span>
<a href="#l9.192"></a><span id="l9.192">      * Helper function to create a start date to search from. This date is the</span>
<a href="#l9.193"></a><span id="l9.193">      * current time with hour/minute/second set to zero.</span>
<a href="#l9.194"></a><span id="l9.194">      *</span>
<a href="#l9.195"></a><span id="l9.195">      * @return      Potential start date.</span>
<a href="#l9.196"></a><span id="l9.196">      */</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-    getStartDate: function IM_getStartDate() {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+    getStartDate: function() {</span>
<a href="#l9.199"></a><span id="l9.199">         let date = now();</span>
<a href="#l9.200"></a><span id="l9.200">         date.second = 0;</span>
<a href="#l9.201"></a><span id="l9.201">         date.minute = 0;</span>
<a href="#l9.202"></a><span id="l9.202">         date.hour = 0;</span>
<a href="#l9.203"></a><span id="l9.203">         return date;</span>
<a href="#l9.204"></a><span id="l9.204">     },</span>
<a href="#l9.205"></a><span id="l9.205"> </span>
<a href="#l9.206"></a><span id="l9.206">     /**</span>
<a href="#l9.207"></a><span id="l9.207">      * Updates the start date for the invitations manager to the date returned</span>
<a href="#l9.208"></a><span id="l9.208">      * from this.getStartDate(), unless the previously existing start date is</span>
<a href="#l9.209"></a><span id="l9.209">      * the same or after what getStartDate() returned.</span>
<a href="#l9.210"></a><span id="l9.210">      */</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    updateStartDate: function IM_updateStartDate() {</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+    updateStartDate: function() {</span>
<a href="#l9.213"></a><span id="l9.213">         if (!this.mStartDate) {</span>
<a href="#l9.214"></a><span id="l9.214">             this.mStartDate = this.getStartDate();</span>
<a href="#l9.215"></a><span id="l9.215">         } else {</span>
<a href="#l9.216"></a><span id="l9.216">             let startDate = this.getStartDate();</span>
<a href="#l9.217"></a><span id="l9.217">             if (startDate.compare(this.mStartDate) &gt; 0) {</span>
<a href="#l9.218"></a><span id="l9.218">                 this.mStartDate = startDate;</span>
<a href="#l9.219"></a><span id="l9.219">             }</span>
<a href="#l9.220"></a><span id="l9.220">         }</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineat">@@ -417,17 +406,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.222"></a><span id="l9.222">     /**</span>
<a href="#l9.223"></a><span id="l9.223">      * Checks if the item is valid for the invitation manager. Checks if the</span>
<a href="#l9.224"></a><span id="l9.224">      * item is in the range of the invitation manager and if the item is a valid</span>
<a href="#l9.225"></a><span id="l9.225">      * invitation.</span>
<a href="#l9.226"></a><span id="l9.226">      *</span>
<a href="#l9.227"></a><span id="l9.227">      * @param item      The item to check</span>
<a href="#l9.228"></a><span id="l9.228">      * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l9.229"></a><span id="l9.229">      */</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-    validateItem: function IM_validateItem(item) {</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+    validateItem: function(item) {</span>
<a href="#l9.232"></a><span id="l9.232">         if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l9.233"></a><span id="l9.233">             !item.calendar.isInvitation(item)) {</span>
<a href="#l9.234"></a><span id="l9.234">             return false; // exclude if organizer has invited himself</span>
<a href="#l9.235"></a><span id="l9.235">         }</span>
<a href="#l9.236"></a><span id="l9.236">         let start = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l9.237"></a><span id="l9.237">         return (cal.isOpenInvitation(item) &amp;&amp;</span>
<a href="#l9.238"></a><span id="l9.238">                 start.compare(this.mStartDate) &gt;= 0);</span>
<a href="#l9.239"></a><span id="l9.239">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -373,21 +373,21 @@ function openEventDialog(calendarItem, c</span>
<a href="#l10.4"></a><span id="l10.4">     // Set up some defaults</span>
<a href="#l10.5"></a><span id="l10.5">     mode = mode || &quot;new&quot;;</span>
<a href="#l10.6"></a><span id="l10.6">     calendar = calendar || getSelectedCalendar();</span>
<a href="#l10.7"></a><span id="l10.7">     let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l10.8"></a><span id="l10.8">     calendars = calendars.filter(isCalendarWritable);</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">     let isItemSupported;</span>
<a href="#l10.11"></a><span id="l10.11">     if (isToDo(calendarItem)) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        isItemSupported = function isTodoSupported(aCalendar) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        isItemSupported = function(aCalendar) {</span>
<a href="#l10.14"></a><span id="l10.14">             return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l10.15"></a><span id="l10.15">         };</span>
<a href="#l10.16"></a><span id="l10.16">     } else if (isEvent(calendarItem)) {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-        isItemSupported = function isEventSupported(aCalendar) {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+        isItemSupported = function(aCalendar) {</span>
<a href="#l10.19"></a><span id="l10.19">             return (aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false);</span>
<a href="#l10.20"></a><span id="l10.20">         };</span>
<a href="#l10.21"></a><span id="l10.21">     }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">     // Filter out calendars that don't support the given calendar item</span>
<a href="#l10.24"></a><span id="l10.24">     calendars = calendars.filter(isItemSupported);</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">     // Filter out calendar/items that we cannot write to/modify</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -356,29 +356,29 @@ var compositeObserver = {</span>
<a href="#l11.4"></a><span id="l11.4">     onPropertyChanged: function() {},</span>
<a href="#l11.5"></a><span id="l11.5">     onPropertyDeleting: function() {},</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">     onLoad: function() {</span>
<a href="#l11.8"></a><span id="l11.8">         calendarUpdateNewItemsCommand();</span>
<a href="#l11.9"></a><span id="l11.9">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l11.10"></a><span id="l11.10">     },</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    onCalendarAdded: function cO_onCalendarAdded(aCalendar) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    onCalendarAdded: function(aCalendar) {</span>
<a href="#l11.14"></a><span id="l11.14">         // Update the calendar commands for number of remote calendars and for</span>
<a href="#l11.15"></a><span id="l11.15">         // more than one calendar</span>
<a href="#l11.16"></a><span id="l11.16">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l11.17"></a><span id="l11.17">     },</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    onCalendarRemoved: function cO_onCalendarRemoved(aCalendar) {</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    onCalendarRemoved: function(aCalendar) {</span>
<a href="#l11.21"></a><span id="l11.21">         // Update commands to disallow deleting the last calendar and only</span>
<a href="#l11.22"></a><span id="l11.22">         // allowing reload remote calendars when there are remote calendars.</span>
<a href="#l11.23"></a><span id="l11.23">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l11.24"></a><span id="l11.24">     },</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-    onDefaultCalendarChanged: function cO_onDefaultCalendarChanged(aNewCalendar) {</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+    onDefaultCalendarChanged: function(aNewCalendar) {</span>
<a href="#l11.28"></a><span id="l11.28">         // A new default calendar may mean that the new calendar has different</span>
<a href="#l11.29"></a><span id="l11.29">         // ACLs. Make sure the commands are updated.</span>
<a href="#l11.30"></a><span id="l11.30">         calendarUpdateNewItemsCommand();</span>
<a href="#l11.31"></a><span id="l11.31">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l11.32"></a><span id="l11.32">     }</span>
<a href="#l11.33"></a><span id="l11.33"> };</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35"> /**</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -395,44 +395,44 @@ function openCalendarSubscriptionsDialog</span>
<a href="#l11.37"></a><span id="l11.37"> }</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39"> /**</span>
<a href="#l11.40"></a><span id="l11.40">  * Calendar Offline Manager</span>
<a href="#l11.41"></a><span id="l11.41">  */</span>
<a href="#l11.42"></a><span id="l11.42"> var calendarOfflineManager = {</span>
<a href="#l11.43"></a><span id="l11.43">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIObserver]),</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    init: function cOM_init() {</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+    init: function() {</span>
<a href="#l11.47"></a><span id="l11.47">         if (this.initialized) {</span>
<a href="#l11.48"></a><span id="l11.48">             throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l11.49"></a><span id="l11.49">         }</span>
<a href="#l11.50"></a><span id="l11.50">         Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">         this.updateOfflineUI(!this.isOnline());</span>
<a href="#l11.53"></a><span id="l11.53">         this.initialized = true;</span>
<a href="#l11.54"></a><span id="l11.54">     },</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-    uninit: function cOM_uninit() {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+    uninit: function() {</span>
<a href="#l11.58"></a><span id="l11.58">         if (!this.initialized) {</span>
<a href="#l11.59"></a><span id="l11.59">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.60"></a><span id="l11.60">         }</span>
<a href="#l11.61"></a><span id="l11.61">         Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l11.62"></a><span id="l11.62">         this.initialized = false;</span>
<a href="#l11.63"></a><span id="l11.63">     },</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    isOnline: function cOM_isOnline() {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+    isOnline: function() {</span>
<a href="#l11.67"></a><span id="l11.67">         return !Services.io.offline;</span>
<a href="#l11.68"></a><span id="l11.68">     },</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    updateOfflineUI: function cOM_updateOfflineUI(aIsOffline) {</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    updateOfflineUI: function(aIsOffline) {</span>
<a href="#l11.72"></a><span id="l11.72">         // Refresh the current view</span>
<a href="#l11.73"></a><span id="l11.73">         currentView().goToDay(currentView().selectedDay);</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75">         // Set up disabled locks for offline</span>
<a href="#l11.76"></a><span id="l11.76">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l11.77"></a><span id="l11.77">     },</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-    observe: function cOM_observe(aSubject, aTopic, aState) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    observe: function(aSubject, aTopic, aState) {</span>
<a href="#l11.81"></a><span id="l11.81">         if (aTopic == &quot;network:offline-status-changed&quot;) {</span>
<a href="#l11.82"></a><span id="l11.82">             this.updateOfflineUI(aState == &quot;offline&quot;);</span>
<a href="#l11.83"></a><span id="l11.83">         }</span>
<a href="#l11.84"></a><span id="l11.84">     }</span>
<a href="#l11.85"></a><span id="l11.85"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-menus.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-menus.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -12,18 +12,17 @@</span>
<a href="#l12.4"></a><span id="l12.4">  xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">   &lt;binding id=&quot;task-menupopup&quot; extends=&quot;xul:menupopup&quot;&gt;</span>
<a href="#l12.7"></a><span id="l12.7">     &lt;implementation&gt;</span>
<a href="#l12.8"></a><span id="l12.8">       &lt;field name=&quot;mType&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l12.9"></a><span id="l12.9">       &lt;field name=&quot;mPopupHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l12.10"></a><span id="l12.10">       &lt;field name=&quot;mParentMenuPopup&quot;&gt;null&lt;/field&gt;</span>
<a href="#l12.11"></a><span id="l12.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        let self = this;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-        this.mPopupHandler = function popupHandler() { self.changeMenuByPropertyName(); };</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+        this.mPopupHandler = () =&gt; { this.schangeMenuByPropertyName(); };</span>
<a href="#l12.15"></a><span id="l12.15">         this.mParentMenuPopup = getParentNodeOrThis(this, &quot;menupopup&quot;);</span>
<a href="#l12.16"></a><span id="l12.16">         this.mParentMenuPopup.addEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l12.17"></a><span id="l12.17">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l12.18"></a><span id="l12.18">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l12.19"></a><span id="l12.19">         this.mParentMenuPopup.removeEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l12.20"></a><span id="l12.20">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> &lt;!-- This method checks a command which naming follows</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-statusbar.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-statusbar.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -20,36 +20,36 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l13.4"></a><span id="l13.4">      mThrobber: null,</span>
<a href="#l13.5"></a><span id="l13.5">      mProgressMode: Components.interfaces.calIStatusObserver.NO_PROGRESS,</span>
<a href="#l13.6"></a><span id="l13.6">      mCurIndex: 0,</span>
<a href="#l13.7"></a><span id="l13.7">      mInitialized: false,</span>
<a href="#l13.8"></a><span id="l13.8">      mCalendars: {},</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIStatusObserver]),</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-     initialize: function cStObs_initialize(aWindow) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+     initialize: function(aWindow) {</span>
<a href="#l13.14"></a><span id="l13.14">         if (!this.mInitialized) {</span>
<a href="#l13.15"></a><span id="l13.15">             this.mWindow = aWindow;</span>
<a href="#l13.16"></a><span id="l13.16">             this.mStatusText = this.mWindow.document.getElementById(&quot;statusText&quot;);</span>
<a href="#l13.17"></a><span id="l13.17">             this.mStatusBar = this.mWindow.document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l13.18"></a><span id="l13.18">             this.mStatusProgressPanel = this.mWindow.document.getElementById(&quot;statusbar-progresspanel&quot;);</span>
<a href="#l13.19"></a><span id="l13.19">             this.mThrobber = this.mWindow.document.getElementById(&quot;navigator-throbber&quot;);</span>
<a href="#l13.20"></a><span id="l13.20">             this.mInitialized = true;</span>
<a href="#l13.21"></a><span id="l13.21">         }</span>
<a href="#l13.22"></a><span id="l13.22">      },</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-     showStatusString: function cStObs_showStatusString(status) {</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+     showStatusString: function(status) {</span>
<a href="#l13.26"></a><span id="l13.26">          this.mStatusText.setAttribute(&quot;label&quot;, status);</span>
<a href="#l13.27"></a><span id="l13.27">      },</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">      get spinning() {</span>
<a href="#l13.30"></a><span id="l13.30">          return this.mProgressMode;</span>
<a href="#l13.31"></a><span id="l13.31">      },</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-     startMeteors: function cStObs_startMeteors(aProgressMode, aCalendarCount) {</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+     startMeteors: function(aProgressMode, aCalendarCount) {</span>
<a href="#l13.35"></a><span id="l13.35">          if (aProgressMode != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l13.36"></a><span id="l13.36">              if (!this.mInitialized) {</span>
<a href="#l13.37"></a><span id="l13.37">                 Components.utils.reportError(&quot;StatusObserver has not been initialized!&quot;);</span>
<a href="#l13.38"></a><span id="l13.38">                 return;</span>
<a href="#l13.39"></a><span id="l13.39">              }</span>
<a href="#l13.40"></a><span id="l13.40">              this.mCalendars = {};</span>
<a href="#l13.41"></a><span id="l13.41">              this.mCurIndex = 0;</span>
<a href="#l13.42"></a><span id="l13.42">              if (aCalendarCount) {</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -66,34 +66,34 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l13.44"></a><span id="l13.44">                  this.showStatusString(commonStatus);</span>
<a href="#l13.45"></a><span id="l13.45">              }</span>
<a href="#l13.46"></a><span id="l13.46">              if (this.mThrobber) {</span>
<a href="#l13.47"></a><span id="l13.47">                  this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l13.48"></a><span id="l13.48">              }</span>
<a href="#l13.49"></a><span id="l13.49">          }</span>
<a href="#l13.50"></a><span id="l13.50">      },</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-     stopMeteors: function cStObs_stopMeteors() {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+     stopMeteors: function() {</span>
<a href="#l13.54"></a><span id="l13.54">          if (!this.mInitialized) {</span>
<a href="#l13.55"></a><span id="l13.55">             return;</span>
<a href="#l13.56"></a><span id="l13.56">          }</span>
<a href="#l13.57"></a><span id="l13.57">          if (this.spinning != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l13.58"></a><span id="l13.58">              this.mProgressMode = Components.interfaces.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l13.59"></a><span id="l13.59">              this.mStatusProgressPanel.collapsed = true;</span>
<a href="#l13.60"></a><span id="l13.60">              this.mStatusBar.setAttribute(&quot;mode&quot;, &quot;normal&quot;);</span>
<a href="#l13.61"></a><span id="l13.61">              this.mStatusBar.value = 0;</span>
<a href="#l13.62"></a><span id="l13.62">              this.mCalendarCount = 0;</span>
<a href="#l13.63"></a><span id="l13.63">              this.showStatusString(&quot;&quot;);</span>
<a href="#l13.64"></a><span id="l13.64">              if (this.mThrobber) {</span>
<a href="#l13.65"></a><span id="l13.65">                  this.mThrobber.setAttribute(&quot;busy&quot;, false);</span>
<a href="#l13.66"></a><span id="l13.66">              }</span>
<a href="#l13.67"></a><span id="l13.67">          }</span>
<a href="#l13.68"></a><span id="l13.68">      },</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-     calendarCompleted: function cStObs_calendarCompleted(aCalendar) {</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+     calendarCompleted: function(aCalendar) {</span>
<a href="#l13.72"></a><span id="l13.72">          if (!this.mInitialized) {</span>
<a href="#l13.73"></a><span id="l13.73">             return;</span>
<a href="#l13.74"></a><span id="l13.74">          }</span>
<a href="#l13.75"></a><span id="l13.75">          if (this.spinning != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l13.76"></a><span id="l13.76">              if (this.spinning == Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l13.77"></a><span id="l13.77">                  if (!this.mCalendars[aCalendar.id] || this.mCalendars[aCalendar.id] === undefined) {</span>
<a href="#l13.78"></a><span id="l13.78">                      this.mCalendars[aCalendar.id] = true;</span>
<a href="#l13.79"></a><span id="l13.79">                      this.mStatusBar.value = parseInt(this.mStatusBar.value, 10) + this.mCalendarStep;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -42,28 +42,28 @@ var taskEdit = {</span>
<a href="#l14.4"></a><span id="l14.4">     /**</span>
<a href="#l14.5"></a><span id="l14.5">      * Helper function to set readonly and aria-disabled states and the value</span>
<a href="#l14.6"></a><span id="l14.6">      * for a given target.</span>
<a href="#l14.7"></a><span id="l14.7">      *</span>
<a href="#l14.8"></a><span id="l14.8">      * @param aTarget   The ID or XUL node to set the value</span>
<a href="#l14.9"></a><span id="l14.9">      * @param aDisable  A boolean if the target should be disabled.</span>
<a href="#l14.10"></a><span id="l14.10">      * @param aValue    The value that should be set on the target.</span>
<a href="#l14.11"></a><span id="l14.11">      */</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    setupTaskField: function tE_setupTaskField(aTarget, aDisable, aValue) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    setupTaskField: function(aTarget, aDisable, aValue) {</span>
<a href="#l14.14"></a><span id="l14.14">         aTarget.value = aValue;</span>
<a href="#l14.15"></a><span id="l14.15">         setElementValue(aTarget, aDisable &amp;&amp; &quot;true&quot;, &quot;readonly&quot;);</span>
<a href="#l14.16"></a><span id="l14.16">         setElementValue(aTarget, aDisable &amp;&amp; &quot;true&quot;, &quot;aria-disabled&quot;);</span>
<a href="#l14.17"></a><span id="l14.17">     },</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">     /**</span>
<a href="#l14.20"></a><span id="l14.20">      * Handler function to call when the quick-add textbox gains focus.</span>
<a href="#l14.21"></a><span id="l14.21">      *</span>
<a href="#l14.22"></a><span id="l14.22">      * @param aEvent    The DOM focus event</span>
<a href="#l14.23"></a><span id="l14.23">      */</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    onFocus: function tE_onFocus(aEvent) {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    onFocus: function(aEvent) {</span>
<a href="#l14.26"></a><span id="l14.26">         let edit = aEvent.target;</span>
<a href="#l14.27"></a><span id="l14.27">         if (edit.localName == &quot;input&quot;) {</span>
<a href="#l14.28"></a><span id="l14.28">             // For some reason, we only receive an onfocus event for the textbox</span>
<a href="#l14.29"></a><span id="l14.29">             // when debugging with venkman.</span>
<a href="#l14.30"></a><span id="l14.30">             edit = edit.parentNode.parentNode;</span>
<a href="#l14.31"></a><span id="l14.31">         }</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33">         let calendar = getSelectedCalendar();</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineat">@@ -83,17 +83,17 @@ var taskEdit = {</span>
<a href="#l14.35"></a><span id="l14.35">         }</span>
<a href="#l14.36"></a><span id="l14.36">     },</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">     /**</span>
<a href="#l14.39"></a><span id="l14.39">      * Handler function to call when the quick-add textbox loses focus.</span>
<a href="#l14.40"></a><span id="l14.40">      *</span>
<a href="#l14.41"></a><span id="l14.41">      * @param aEvent    The DOM blur event</span>
<a href="#l14.42"></a><span id="l14.42">      */</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    onBlur: function tE_onBlur(aEvent) {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+    onBlur: function(aEvent) {</span>
<a href="#l14.45"></a><span id="l14.45">         let edit = aEvent.target;</span>
<a href="#l14.46"></a><span id="l14.46">         if (edit.localName == &quot;input&quot;) {</span>
<a href="#l14.47"></a><span id="l14.47">             // For some reason, we only receive the blur event for the input</span>
<a href="#l14.48"></a><span id="l14.48">             // element. There are no targets that point to the textbox. Go up</span>
<a href="#l14.49"></a><span id="l14.49">             // the parent chain until we reach the textbox.</span>
<a href="#l14.50"></a><span id="l14.50">             edit = edit.parentNode.parentNode;</span>
<a href="#l14.51"></a><span id="l14.51">         }</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53" class="difflineat">@@ -122,17 +122,17 @@ var taskEdit = {</span>
<a href="#l14.54"></a><span id="l14.54">         edit.showsInstructions = true;</span>
<a href="#l14.55"></a><span id="l14.55">     },</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">     /**</span>
<a href="#l14.58"></a><span id="l14.58">      * Handler function to call on keypress for the quick-add textbox.</span>
<a href="#l14.59"></a><span id="l14.59">      *</span>
<a href="#l14.60"></a><span id="l14.60">      * @param aEvent    The DOM keypress event</span>
<a href="#l14.61"></a><span id="l14.61">      */</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-    onKeyPress: function tE_onKeyPress(aEvent) {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    onKeyPress: function(aEvent) {</span>
<a href="#l14.64"></a><span id="l14.64">         if (aEvent.keyCode == Components.interfaces.nsIDOMKeyEvent.DOM_VK_RETURN) {</span>
<a href="#l14.65"></a><span id="l14.65">             let edit = aEvent.target;</span>
<a href="#l14.66"></a><span id="l14.66">             if (edit.value &amp;&amp; edit.value.length &gt; 0) {</span>
<a href="#l14.67"></a><span id="l14.67">                 let item = cal.createTodo();</span>
<a href="#l14.68"></a><span id="l14.68">                 setDefaultItemValues(item);</span>
<a href="#l14.69"></a><span id="l14.69">                 item.title = edit.value;</span>
<a href="#l14.70"></a><span id="l14.70"> </span>
<a href="#l14.71"></a><span id="l14.71">                 edit.value = &quot;&quot;;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineat">@@ -140,32 +140,32 @@ var taskEdit = {</span>
<a href="#l14.73"></a><span id="l14.73">             }</span>
<a href="#l14.74"></a><span id="l14.74">         }</span>
<a href="#l14.75"></a><span id="l14.75">     },</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77">     /**</span>
<a href="#l14.78"></a><span id="l14.78">      * Window load function to set up all quick-add textboxes. The texbox must</span>
<a href="#l14.79"></a><span id="l14.79">      * have the class &quot;task-edit-field&quot;.</span>
<a href="#l14.80"></a><span id="l14.80">      */</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-    onLoad: function tE_onLoad(aEvent) {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+    onLoad: function(aEvent) {</span>
<a href="#l14.83"></a><span id="l14.83">         window.removeEventListener(&quot;load&quot;, taskEdit.onLoad, false);</span>
<a href="#l14.84"></a><span id="l14.84">         // TODO use getElementsByClassName</span>
<a href="#l14.85"></a><span id="l14.85">         let taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.86"></a><span id="l14.86">         for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.87"></a><span id="l14.87">             taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l14.88"></a><span id="l14.88">         }</span>
<a href="#l14.89"></a><span id="l14.89"> </span>
<a href="#l14.90"></a><span id="l14.90">         getCompositeCalendar().addObserver(taskEdit.compositeObserver);</span>
<a href="#l14.91"></a><span id="l14.91">         taskEdit.observedCalendar = getSelectedCalendar();</span>
<a href="#l14.92"></a><span id="l14.92">     },</span>
<a href="#l14.93"></a><span id="l14.93"> </span>
<a href="#l14.94"></a><span id="l14.94">     /**</span>
<a href="#l14.95"></a><span id="l14.95">      * Window load function to clean up all quick-add fields.</span>
<a href="#l14.96"></a><span id="l14.96">      */</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-    onUnload: function tE_onUnload() {</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+    onUnload: function() {</span>
<a href="#l14.99"></a><span id="l14.99">         getCompositeCalendar().removeObserver(taskEdit.compositeObserver);</span>
<a href="#l14.100"></a><span id="l14.100">         taskEdit.observedCalendar = null;</span>
<a href="#l14.101"></a><span id="l14.101">     },</span>
<a href="#l14.102"></a><span id="l14.102"> </span>
<a href="#l14.103"></a><span id="l14.103">     /**</span>
<a href="#l14.104"></a><span id="l14.104">      * Observer to watch for readonly, disabled and capability changes of the</span>
<a href="#l14.105"></a><span id="l14.105">      * observed calendar.</span>
<a href="#l14.106"></a><span id="l14.106">      *</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineat">@@ -178,37 +178,33 @@ var taskEdit = {</span>
<a href="#l14.108"></a><span id="l14.108">         onStartBatch: function() {},</span>
<a href="#l14.109"></a><span id="l14.109">         onEndBatch: function() {},</span>
<a href="#l14.110"></a><span id="l14.110">         onLoad: function(aCalendar) {},</span>
<a href="#l14.111"></a><span id="l14.111">         onAddItem: function(aItem) {},</span>
<a href="#l14.112"></a><span id="l14.112">         onModifyItem: function(aNewItem, aOldItem) {},</span>
<a href="#l14.113"></a><span id="l14.113">         onDeleteItem: function(aDeletedItem) {},</span>
<a href="#l14.114"></a><span id="l14.114">         onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-        onPropertyChanged: function tE_calObs_onPropertyChanged(aCalendar,</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-                                                         aName,</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-                                                         aValue,</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-                                                         aOldValue) {</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+        onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l14.121"></a><span id="l14.121">             if (aCalendar.id != getSelectedCalendar().id) {</span>
<a href="#l14.122"></a><span id="l14.122">                 // Optimization: if the given calendar isn't the default calendar,</span>
<a href="#l14.123"></a><span id="l14.123">                 // then we don't need to change any readonly/disabled states.</span>
<a href="#l14.124"></a><span id="l14.124">                 return;</span>
<a href="#l14.125"></a><span id="l14.125">             }</span>
<a href="#l14.126"></a><span id="l14.126">             switch (aName) {</span>
<a href="#l14.127"></a><span id="l14.127">                 case &quot;readOnly&quot;:</span>
<a href="#l14.128"></a><span id="l14.128">                 case &quot;disabled&quot;:</span>
<a href="#l14.129"></a><span id="l14.129">                     let taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.130"></a><span id="l14.130">                     for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.131"></a><span id="l14.131">                         taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l14.132"></a><span id="l14.132">                     }</span>
<a href="#l14.133"></a><span id="l14.133">             }</span>
<a href="#l14.134"></a><span id="l14.134">         },</span>
<a href="#l14.135"></a><span id="l14.135"> </span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-        onPropertyDeleting: function tE_calObs_onPropertyDeleting(aCalendar,</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-                                                           aName) {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+        onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l14.139"></a><span id="l14.139">             // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l14.140"></a><span id="l14.140">             // but should not be the same as the value, set it to a different</span>
<a href="#l14.141"></a><span id="l14.141">             // value.</span>
<a href="#l14.142"></a><span id="l14.142">             this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l14.143"></a><span id="l14.143">         }</span>
<a href="#l14.144"></a><span id="l14.144">     },</span>
<a href="#l14.145"></a><span id="l14.145"> </span>
<a href="#l14.146"></a><span id="l14.146">     /**</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineat">@@ -231,19 +227,19 @@ var taskEdit = {</span>
<a href="#l14.148"></a><span id="l14.148">         onAddItem: function(aItem) {},</span>
<a href="#l14.149"></a><span id="l14.149">         onModifyItem: function(aNewItem, aOldItem) {},</span>
<a href="#l14.150"></a><span id="l14.150">         onDeleteItem: function(aDeletedItem) {},</span>
<a href="#l14.151"></a><span id="l14.151">         onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l14.152"></a><span id="l14.152">         onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {},</span>
<a href="#l14.153"></a><span id="l14.153">         onPropertyDeleting: function(aCalendar, aName) {},</span>
<a href="#l14.154"></a><span id="l14.154"> </span>
<a href="#l14.155"></a><span id="l14.155">         // calICompositeObserver:</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-        onCalendarAdded: function onCalendarAdded(aCalendar) {},</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-        onCalendarRemoved: function onCalendarRemoved(aCalendar) {},</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-        onDefaultCalendarChanged: function tE_compObs_onDefaultCalendarChanged(aNewDefault) {</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+        onCalendarAdded: function(aCalendar) {},</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+        onCalendarRemoved: function(aCalendar) {},</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+        onDefaultCalendarChanged: function(aNewDefault) {</span>
<a href="#l14.162"></a><span id="l14.162">             let taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.163"></a><span id="l14.163">             for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.164"></a><span id="l14.164">                 taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l14.165"></a><span id="l14.165">             }</span>
<a href="#l14.166"></a><span id="l14.166">             taskEdit.observedCalendar = aNewDefault;</span>
<a href="#l14.167"></a><span id="l14.167">         }</span>
<a href="#l14.168"></a><span id="l14.168">     }</span>
<a href="#l14.169"></a><span id="l14.169"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -373,28 +373,28 @@</span>
<a href="#l15.4"></a><span id="l15.4">               return (this.mSelectedColumn = aCol);</span>
<a href="#l15.5"></a><span id="l15.5">           },</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">           /**</span>
<a href="#l15.8"></a><span id="l15.8">            * High-level task tree manipulation</span>
<a href="#l15.9"></a><span id="l15.9">            */</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">           // Adds an array of items to the list if they match the currently applied filter.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-          addItems: function tTV_addItems(aItems, aDontSort) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+          addItems: function(aItems, aDontSort) {</span>
<a href="#l15.14"></a><span id="l15.14">               this.modifyItems(aItems, [], aDontSort, true);</span>
<a href="#l15.15"></a><span id="l15.15">           },</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">           // Removes an array of items from the list.</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-          removeItems: function tTV_removeItems(aItems) {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+          removeItems: function(aItems) {</span>
<a href="#l15.20"></a><span id="l15.20">               this.modifyItems([], aItems, true, false);</span>
<a href="#l15.21"></a><span id="l15.21">           },</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23">           // Removes an array of old items from the list, and adds an array of new items if</span>
<a href="#l15.24"></a><span id="l15.24">           // they match the currently applied filter.</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-          modifyItems: function tTV_modifyItems(aNewItems, aOldItems, aDontSort, aSelectNew) {</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+          modifyItems: function(aNewItems, aOldItems, aDontSort, aSelectNew) {</span>
<a href="#l15.27"></a><span id="l15.27">               let selItem = this.binding.currentTask;</span>
<a href="#l15.28"></a><span id="l15.28">               let selIndex = this.tree.currentIndex;</span>
<a href="#l15.29"></a><span id="l15.29">               let firstHash = null;</span>
<a href="#l15.30"></a><span id="l15.30">               let remIndexes = [];</span>
<a href="#l15.31"></a><span id="l15.31">               aNewItems = aNewItems || [];</span>
<a href="#l15.32"></a><span id="l15.32">               aOldItems = aOldItems || [];</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">               this.treebox.beginUpdateBatch();</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineat">@@ -461,27 +461,27 @@</span>
<a href="#l15.36"></a><span id="l15.36">               if (selIndex &gt; -1) {</span>
<a href="#l15.37"></a><span id="l15.37">                   this.tree.view.selection.select(selIndex);</span>
<a href="#l15.38"></a><span id="l15.38">                   this.treebox.ensureRowIsVisible(selIndex);</span>
<a href="#l15.39"></a><span id="l15.39">               }</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">               this.treebox.endUpdateBatch();</span>
<a href="#l15.42"></a><span id="l15.42">           },</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-          clear: function tTV_clear() {</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+          clear: function() {</span>
<a href="#l15.46"></a><span id="l15.46">               let count = this.binding.mTaskArray.length;</span>
<a href="#l15.47"></a><span id="l15.47">               if (count &gt; 0) {</span>
<a href="#l15.48"></a><span id="l15.48">                   this.binding.mTaskArray = [];</span>
<a href="#l15.49"></a><span id="l15.49">                   this.binding.mHash2Index = {};</span>
<a href="#l15.50"></a><span id="l15.50">                   this.treebox.rowCountChanged(0, -count);</span>
<a href="#l15.51"></a><span id="l15.51">                   this.tree.view.selection.clearSelection();</span>
<a href="#l15.52"></a><span id="l15.52">               }</span>
<a href="#l15.53"></a><span id="l15.53">           },</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-          updateItem: function tTV_updateItem(aItem) {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+          updateItem: function(aItem) {</span>
<a href="#l15.57"></a><span id="l15.57">               let index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l15.58"></a><span id="l15.58">               if (index) {</span>
<a href="#l15.59"></a><span id="l15.59">                   this.treebox.invalidateRow(index);</span>
<a href="#l15.60"></a><span id="l15.60">               }</span>
<a href="#l15.61"></a><span id="l15.61">           },</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63">           /**</span>
<a href="#l15.64"></a><span id="l15.64">            * nsITreeView methods and properties</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineat">@@ -490,29 +490,29 @@</span>
<a href="#l15.66"></a><span id="l15.66">           get rowCount() {</span>
<a href="#l15.67"></a><span id="l15.67">               return this.binding.mTaskArray.length;</span>
<a href="#l15.68"></a><span id="l15.68">           },</span>
<a href="#l15.69"></a><span id="l15.69"> </span>
<a href="#l15.70"></a><span id="l15.70">           // TODO this code is currently identical to the unifinder. We should</span>
<a href="#l15.71"></a><span id="l15.71">           // create an itemTreeView that these tree views can inherit, that</span>
<a href="#l15.72"></a><span id="l15.72">           // contains this code, and possibly other code related to sorting and</span>
<a href="#l15.73"></a><span id="l15.73">           // storing items. See bug 432582 for more details.</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-          getCellProperties: function mTV_getCellProperties(aRow, aCol) {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+          getCellProperties: function(aRow, aCol) {</span>
<a href="#l15.76"></a><span id="l15.76">               let rowProps = this.getRowProperties(aRow);</span>
<a href="#l15.77"></a><span id="l15.77">               let colProps = this.getColumnProperties(aCol);</span>
<a href="#l15.78"></a><span id="l15.78">               return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l15.79"></a><span id="l15.79">           },</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81">           // Called to get properties to paint a column background.</span>
<a href="#l15.82"></a><span id="l15.82">           // For shading the sort column, etc.</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-          getColumnProperties: function mTV_getColumnProperties(aCol) {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+          getColumnProperties: function(aCol) {</span>
<a href="#l15.85"></a><span id="l15.85">               return aCol.element.getAttribute(&quot;anonid&quot;) || &quot;&quot;;</span>
<a href="#l15.86"></a><span id="l15.86">           },</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-          getRowProperties: function mTV_getRowProperties(aRow) {</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+          getRowProperties: function(aRow) {</span>
<a href="#l15.90"></a><span id="l15.90">               let properties = [];</span>
<a href="#l15.91"></a><span id="l15.91">               let item = this.binding.mTaskArray[aRow];</span>
<a href="#l15.92"></a><span id="l15.92">               if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l15.93"></a><span id="l15.93">                   properties.push(&quot;highpriority&quot;);</span>
<a href="#l15.94"></a><span id="l15.94">               } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l15.95"></a><span id="l15.95">                   properties.push(&quot;lowpriority&quot;);</span>
<a href="#l15.96"></a><span id="l15.96">               }</span>
<a href="#l15.97"></a><span id="l15.97">               properties.push(getProgressAtom(item));</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineat">@@ -535,17 +535,17 @@</span>
<a href="#l15.99"></a><span id="l15.99">               properties = properties.concat(item.getCategories({})</span>
<a href="#l15.100"></a><span id="l15.100">                                                  .map(formatStringForCSSRule));</span>
<a href="#l15.101"></a><span id="l15.101"> </span>
<a href="#l15.102"></a><span id="l15.102">               return properties.join(&quot; &quot;);</span>
<a href="#l15.103"></a><span id="l15.103">           },</span>
<a href="#l15.104"></a><span id="l15.104"> </span>
<a href="#l15.105"></a><span id="l15.105">           // Called on the view when a cell in a non-selectable cycling</span>
<a href="#l15.106"></a><span id="l15.106">           // column (e.g., unread/flag/etc.) is clicked.</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-          cycleCell: function mTV_cycleCell(aRow, aCol) {</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+          cycleCell: function(aRow, aCol) {</span>
<a href="#l15.109"></a><span id="l15.109">               let task = this.binding.mTaskArray[aRow];</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111">               // prevent toggling completed status for parent items of</span>
<a href="#l15.112"></a><span id="l15.112">               // repeating tasks or when the calendar is read-only.</span>
<a href="#l15.113"></a><span id="l15.113">               if (!task || task.recurrenceInfo || task.calendar.readOnly) {</span>
<a href="#l15.114"></a><span id="l15.114">                   return;</span>
<a href="#l15.115"></a><span id="l15.115">               }</span>
<a href="#l15.116"></a><span id="l15.116">               if (aCol != null) {</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineat">@@ -554,17 +554,17 @@</span>
<a href="#l15.118"></a><span id="l15.118">                       let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l15.119"></a><span id="l15.119">                       newTask.isCompleted = !task.completedDate;</span>
<a href="#l15.120"></a><span id="l15.120">                       doTransaction(&quot;modify&quot;, newTask, newTask.calendar, task, null);</span>
<a href="#l15.121"></a><span id="l15.121">                   }</span>
<a href="#l15.122"></a><span id="l15.122">               }</span>
<a href="#l15.123"></a><span id="l15.123">           },</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125">           // Called on the view when a header is clicked.</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-          cycleHeader: function mTV_cycleHeader(aCol) {</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+          cycleHeader: function(aCol) {</span>
<a href="#l15.128"></a><span id="l15.128">               if (!this.selectedColumn) {</span>
<a href="#l15.129"></a><span id="l15.129">                   this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l15.130"></a><span id="l15.130">               } else if (!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l15.131"></a><span id="l15.131">                   this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l15.132"></a><span id="l15.132">               } else {</span>
<a href="#l15.133"></a><span id="l15.133">                   this.sortDirection = &quot;descending&quot;;</span>
<a href="#l15.134"></a><span id="l15.134">               }</span>
<a href="#l15.135"></a><span id="l15.135">               this.selectedColumn = aCol.element;</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineat">@@ -576,17 +576,17 @@</span>
<a href="#l15.137"></a><span id="l15.137">                       let index = this.binding.mHash2Index[item.hashId];</span>
<a href="#l15.138"></a><span id="l15.138">                       this.tree.view.selection.toggleSelect(index);</span>
<a href="#l15.139"></a><span id="l15.139">                   }</span>
<a href="#l15.140"></a><span id="l15.140">               }</span>
<a href="#l15.141"></a><span id="l15.141">           },</span>
<a href="#l15.142"></a><span id="l15.142"> </span>
<a href="#l15.143"></a><span id="l15.143">           // The text for a given cell. If a column consists only of an</span>
<a href="#l15.144"></a><span id="l15.144">           // image, then the empty string is returned.</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-          getCellText: function mTV_getCellText(aRow, aCol) {</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+          getCellText: function(aRow, aCol) {</span>
<a href="#l15.147"></a><span id="l15.147">               let task = this.binding.mTaskArray[aRow];</span>
<a href="#l15.148"></a><span id="l15.148">               if (!task) {</span>
<a href="#l15.149"></a><span id="l15.149">                   return false;</span>
<a href="#l15.150"></a><span id="l15.150">               }</span>
<a href="#l15.151"></a><span id="l15.151"> </span>
<a href="#l15.152"></a><span id="l15.152">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l15.153"></a><span id="l15.153">                   case &quot;title&quot;:</span>
<a href="#l15.154"></a><span id="l15.154">                       // return title, or &quot;Untitled&quot; if empty/null</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineat">@@ -612,105 +612,105 @@</span>
<a href="#l15.156"></a><span id="l15.156">                   case &quot;completed&quot;:</span>
<a href="#l15.157"></a><span id="l15.157">                   case &quot;priority&quot;:</span>
<a href="#l15.158"></a><span id="l15.158">                   default:</span>
<a href="#l15.159"></a><span id="l15.159">                       return &quot;&quot;;</span>
<a href="#l15.160"></a><span id="l15.160">               }</span>
<a href="#l15.161"></a><span id="l15.161">           },</span>
<a href="#l15.162"></a><span id="l15.162"> </span>
<a href="#l15.163"></a><span id="l15.163">           // This method is only called for columns of type other than text.</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-          getCellValue: function mTV_getCellValue(aRow, aCol) {</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+          getCellValue: function(aRow, aCol) {</span>
<a href="#l15.166"></a><span id="l15.166">               let task = this.binding.mTaskArray[aRow];</span>
<a href="#l15.167"></a><span id="l15.167">               if (!task) {</span>
<a href="#l15.168"></a><span id="l15.168">                   return null;</span>
<a href="#l15.169"></a><span id="l15.169">               }</span>
<a href="#l15.170"></a><span id="l15.170">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l15.171"></a><span id="l15.171">                   case &quot;percentComplete&quot;:</span>
<a href="#l15.172"></a><span id="l15.172">                       return task.percentComplete;</span>
<a href="#l15.173"></a><span id="l15.173">               }</span>
<a href="#l15.174"></a><span id="l15.174">               return null;</span>
<a href="#l15.175"></a><span id="l15.175">           },</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177">           // SetCellValue is called when the value of the cell has been set by the user.</span>
<a href="#l15.178"></a><span id="l15.178">           // This method is only called for columns of type other than text.</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-          setCellValue: function mTV_setCellValue(aRow, aCol, aValue) {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+          setCellValue: function(aRow, aCol, aValue) {</span>
<a href="#l15.181"></a><span id="l15.181">               return null;</span>
<a href="#l15.182"></a><span id="l15.182">           },</span>
<a href="#l15.183"></a><span id="l15.183"> </span>
<a href="#l15.184"></a><span id="l15.184">           // The image path for a given cell. For defining an icon for a cell.</span>
<a href="#l15.185"></a><span id="l15.185">           // If the empty string is returned, the :moz-tree-image pseudoelement will be used.</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-          getImageSrc: function mTV_getImageSrc(aRow, aCol) {</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+          getImageSrc: function(aRow, aCol) {</span>
<a href="#l15.188"></a><span id="l15.188">              // Return the empty string in order</span>
<a href="#l15.189"></a><span id="l15.189">              // to use moz-tree-image pseudoelement :</span>
<a href="#l15.190"></a><span id="l15.190">              // it is mandatory to return &quot;&quot; and not false :-(</span>
<a href="#l15.191"></a><span id="l15.191">              return &quot;&quot;;</span>
<a href="#l15.192"></a><span id="l15.192">           },</span>
<a href="#l15.193"></a><span id="l15.193"> </span>
<a href="#l15.194"></a><span id="l15.194">           // IsEditable is called to ask the view if the cell contents are editable.</span>
<a href="#l15.195"></a><span id="l15.195">           // A value of true will result in the tree popping up a text field when the user</span>
<a href="#l15.196"></a><span id="l15.196">           // tries to inline edit the cell.</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-          isEditable: function mTV_isEditable(aRow, aCol) {</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+          isEditable: function(aRow, aCol) {</span>
<a href="#l15.199"></a><span id="l15.199">               return true;</span>
<a href="#l15.200"></a><span id="l15.200">           },</span>
<a href="#l15.201"></a><span id="l15.201"> </span>
<a href="#l15.202"></a><span id="l15.202">           // Called during initialization to link the view to the front end box object.</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-          setTree: function mTV_setTree(aTreeBox) {</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+          setTree: function(aTreeBox) {</span>
<a href="#l15.205"></a><span id="l15.205">             this.treebox = aTreeBox;</span>
<a href="#l15.206"></a><span id="l15.206">           },</span>
<a href="#l15.207"></a><span id="l15.207"> </span>
<a href="#l15.208"></a><span id="l15.208">           // Methods that can be used to test whether or not a twisty should</span>
<a href="#l15.209"></a><span id="l15.209">           // be drawn, and if so, whether an open or closed twisty should be used.</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-          isContainer: function mTV_isContainer(aRow) {</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+          isContainer: function(aRow) {</span>
<a href="#l15.212"></a><span id="l15.212">               return false;</span>
<a href="#l15.213"></a><span id="l15.213">           },</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-          isContainerOpen: function mTV_isContainerOpen(aRow) {</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+          isContainerOpen: function(aRow) {</span>
<a href="#l15.216"></a><span id="l15.216">               return false;</span>
<a href="#l15.217"></a><span id="l15.217">           },</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-          isContainerEmpty: function mTV_isContainerEmpty(aRow) {</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+          isContainerEmpty: function(aRow) {</span>
<a href="#l15.220"></a><span id="l15.220">               return false;</span>
<a href="#l15.221"></a><span id="l15.221">           },</span>
<a href="#l15.222"></a><span id="l15.222"> </span>
<a href="#l15.223"></a><span id="l15.223">           // IsSeparator is used to determine if the row at index is a separator.</span>
<a href="#l15.224"></a><span id="l15.224">           // A value of true will result in the tree drawing a horizontal separator.</span>
<a href="#l15.225"></a><span id="l15.225">           // The tree uses the ::moz-tree-separator pseudoclass to draw the separator.</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-          isSeparator: function mTV_isSeparator(aRow) {</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+          isSeparator: function(aRow) {</span>
<a href="#l15.228"></a><span id="l15.228">               return false;</span>
<a href="#l15.229"></a><span id="l15.229">           },</span>
<a href="#l15.230"></a><span id="l15.230"> </span>
<a href="#l15.231"></a><span id="l15.231">           // Specifies if there is currently a sort on any column.</span>
<a href="#l15.232"></a><span id="l15.232">           // Used mostly by drag'n'drop to affect drop feedback.</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-          isSorted: function mTV_isSorted(aRow) {</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+          isSorted: function(aRow) {</span>
<a href="#l15.235"></a><span id="l15.235">               return false;</span>
<a href="#l15.236"></a><span id="l15.236">           },</span>
<a href="#l15.237"></a><span id="l15.237"> </span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-          canDrop: function mTV_canDrop() { return false; },</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+          canDrop: function() { return false; },</span>
<a href="#l15.240"></a><span id="l15.240"> </span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-          drop: function mTV_drop(aRow, aOrientation) {},</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+          drop: function(aRow, aOrientation) {},</span>
<a href="#l15.243"></a><span id="l15.243"> </span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-          getParentIndex: function mTV_getParentIndex(aRow) {</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+          getParentIndex: function(aRow) {</span>
<a href="#l15.246"></a><span id="l15.246">               return -1;</span>
<a href="#l15.247"></a><span id="l15.247">           },</span>
<a href="#l15.248"></a><span id="l15.248"> </span>
<a href="#l15.249"></a><span id="l15.249">           // The level is an integer value that represents the level of indentation.</span>
<a href="#l15.250"></a><span id="l15.250">           // It is multiplied by the width specified in the :moz-tree-indentation</span>
<a href="#l15.251"></a><span id="l15.251">           // pseudoelement to compute the exact indendation.</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-          getLevel: function mTV_getLevel(aRow) {</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+          getLevel: function(aRow) {</span>
<a href="#l15.254"></a><span id="l15.254">               return 0;</span>
<a href="#l15.255"></a><span id="l15.255">           },</span>
<a href="#l15.256"></a><span id="l15.256"> </span>
<a href="#l15.257"></a><span id="l15.257">           // The image path for a given cell. For defining an icon for a cell.</span>
<a href="#l15.258"></a><span id="l15.258">           // If the empty string is returned, the :moz-tree-image pseudoelement</span>
<a href="#l15.259"></a><span id="l15.259">           // will be used.</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-          getImgSrc: function mTV_getImgSrc(aRow, aCol) {</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+          getImgSrc: function(aRow, aCol) {</span>
<a href="#l15.262"></a><span id="l15.262">               return null;</span>
<a href="#l15.263"></a><span id="l15.263">           },</span>
<a href="#l15.264"></a><span id="l15.264"> </span>
<a href="#l15.265"></a><span id="l15.265">           // The progress mode for a given cell. This method is only called for</span>
<a href="#l15.266"></a><span id="l15.266">           // columns of type |progressmeter|.</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-          getProgressMode: function mTV_getProgressMode(aRow, aCol) {</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+          getProgressMode: function(aRow, aCol) {</span>
<a href="#l15.269"></a><span id="l15.269">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l15.270"></a><span id="l15.270">                   case &quot;percentComplete&quot;:</span>
<a href="#l15.271"></a><span id="l15.271">                       let task = this.binding.mTaskArray[aRow];</span>
<a href="#l15.272"></a><span id="l15.272">                       if (aCol.element.boxObject.width &gt; 75 &amp;&amp;</span>
<a href="#l15.273"></a><span id="l15.273">                           task.percentComplete &gt; 0) {</span>
<a href="#l15.274"></a><span id="l15.274">                           // XXX Would be nice if we could use relative widths,</span>
<a href="#l15.275"></a><span id="l15.275">                           // i.e &quot;15ex&quot;, but there is no scriptable interface.</span>
<a href="#l15.276"></a><span id="l15.276">                           return Components.interfaces.nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineat">@@ -719,19 +719,19 @@</span>
<a href="#l15.278"></a><span id="l15.278">               }</span>
<a href="#l15.279"></a><span id="l15.279"> </span>
<a href="#l15.280"></a><span id="l15.280">               return Components.interfaces.nsITreeView.PROGRESS_NONE;</span>
<a href="#l15.281"></a><span id="l15.281">           },</span>
<a href="#l15.282"></a><span id="l15.282"> </span>
<a href="#l15.283"></a><span id="l15.283">           /**</span>
<a href="#l15.284"></a><span id="l15.284">            * Task Tree Events</span>
<a href="#l15.285"></a><span id="l15.285">            */</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-          onSelect: function tTV_onSelect(event) {},</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+          onSelect: function(event) {},</span>
<a href="#l15.288"></a><span id="l15.288"> </span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-          onDoubleClick: function tTV_onDoubleClick(event) {</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineplus">+          onDoubleClick: function(event) {</span>
<a href="#l15.291"></a><span id="l15.291">               if (event.button == 0) {</span>
<a href="#l15.292"></a><span id="l15.292">                   let initialDate = getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l15.293"></a><span id="l15.293">                   let col = {};</span>
<a href="#l15.294"></a><span id="l15.294">                   let item = this._getItemFromEvent(event, col);</span>
<a href="#l15.295"></a><span id="l15.295">                   if (item) {</span>
<a href="#l15.296"></a><span id="l15.296">                       let colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l15.297"></a><span id="l15.297">                       if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l15.298"></a><span id="l15.298">                           // item holds checkbox state toggled by first click,</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineat">@@ -741,17 +741,17 @@</span>
<a href="#l15.300"></a><span id="l15.300">                           modifyEventWithDialog(item, null, true, initialDate);</span>
<a href="#l15.301"></a><span id="l15.301">                       }</span>
<a href="#l15.302"></a><span id="l15.302">                   } else {</span>
<a href="#l15.303"></a><span id="l15.303">                       createTodoWithDialog(null, null, null, null, initialDate);</span>
<a href="#l15.304"></a><span id="l15.304">                   }</span>
<a href="#l15.305"></a><span id="l15.305">               }</span>
<a href="#l15.306"></a><span id="l15.306">           },</span>
<a href="#l15.307"></a><span id="l15.307"> </span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-          onKeyPress: function tTV_onKeyPress(event) {</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+          onKeyPress: function(event) {</span>
<a href="#l15.310"></a><span id="l15.310">               const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l15.311"></a><span id="l15.311">               switch (event.keyCode || event.which) {</span>
<a href="#l15.312"></a><span id="l15.312">                   case kKE.DOM_VK_DELETE:</span>
<a href="#l15.313"></a><span id="l15.313">                       document.popupNode = this.binding;</span>
<a href="#l15.314"></a><span id="l15.314">                       document.getElementById(&quot;calendar_delete_todo_command&quot;).doCommand();</span>
<a href="#l15.315"></a><span id="l15.315">                       event.preventDefault();</span>
<a href="#l15.316"></a><span id="l15.316">                       event.stopPropagation();</span>
<a href="#l15.317"></a><span id="l15.317">                       break;</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineat">@@ -769,42 +769,42 @@</span>
<a href="#l15.319"></a><span id="l15.319">                       if (index &gt; -1) {</span>
<a href="#l15.320"></a><span id="l15.320">                           modifyEventWithDialog(this.binding.mTaskArray[index]);</span>
<a href="#l15.321"></a><span id="l15.321">                       }</span>
<a href="#l15.322"></a><span id="l15.322">                       break;</span>
<a href="#l15.323"></a><span id="l15.323">               }</span>
<a href="#l15.324"></a><span id="l15.324">           },</span>
<a href="#l15.325"></a><span id="l15.325"> </span>
<a href="#l15.326"></a><span id="l15.326">           // Set the context menu on mousedown to change it before it is opened</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-          onMouseDown: function tTV_onMouseDown(event) {</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+          onMouseDown: function(event) {</span>
<a href="#l15.329"></a><span id="l15.329">               let tree = document.getAnonymousElementByAttribute(this.binding,</span>
<a href="#l15.330"></a><span id="l15.330">                                                                  &quot;anonid&quot;,</span>
<a href="#l15.331"></a><span id="l15.331">                                                                  &quot;calendar-task-tree&quot;);</span>
<a href="#l15.332"></a><span id="l15.332"> </span>
<a href="#l15.333"></a><span id="l15.333">               if (!this._getItemFromEvent(event)) {</span>
<a href="#l15.334"></a><span id="l15.334">                   tree.view.selection.invalidateSelection();</span>
<a href="#l15.335"></a><span id="l15.335">               }</span>
<a href="#l15.336"></a><span id="l15.336">           },</span>
<a href="#l15.337"></a><span id="l15.337"> </span>
<a href="#l15.338"></a><span id="l15.338">           /**</span>
<a href="#l15.339"></a><span id="l15.339">            * Private methods and attributes</span>
<a href="#l15.340"></a><span id="l15.340">            */</span>
<a href="#l15.341"></a><span id="l15.341"> </span>
<a href="#l15.342"></a><span id="l15.342" class="difflineminus">-          _getItemFromEvent: function tTV_getItemFromEvent(event, aCol, aRow) {</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineplus">+          _getItemFromEvent: function(event, aCol, aRow) {</span>
<a href="#l15.344"></a><span id="l15.344">             aRow = aRow || {};</span>
<a href="#l15.345"></a><span id="l15.345">             let childElt = {};</span>
<a href="#l15.346"></a><span id="l15.346">             this.treebox.getCellAt(event.clientX, event.clientY, aRow, aCol || {}, childElt);</span>
<a href="#l15.347"></a><span id="l15.347">             if (!childElt.value) {</span>
<a href="#l15.348"></a><span id="l15.348">                 return false;</span>
<a href="#l15.349"></a><span id="l15.349">             }</span>
<a href="#l15.350"></a><span id="l15.350">             return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.binding.mTaskArray[aRow.value];</span>
<a href="#l15.351"></a><span id="l15.351">           },</span>
<a href="#l15.352"></a><span id="l15.352"> </span>
<a href="#l15.353"></a><span id="l15.353">           // Helper function to display datetimes</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineminus">-          _formatDateTime: function tTV_formatDateTime(aDateTime) {</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineplus">+          _formatDateTime: function(aDateTime) {</span>
<a href="#l15.356"></a><span id="l15.356">               let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l15.357"></a><span id="l15.357">                                             .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l15.358"></a><span id="l15.358"> </span>
<a href="#l15.359"></a><span id="l15.359">               // datetime is from todo object, it is not a javascript date</span>
<a href="#l15.360"></a><span id="l15.360">               if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l15.361"></a><span id="l15.361">                   let dateTime = aDateTime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l15.362"></a><span id="l15.362">                   return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l15.363"></a><span id="l15.363">               }</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineat">@@ -824,81 +824,81 @@</span>
<a href="#l15.365"></a><span id="l15.365">           QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l15.366"></a><span id="l15.366">               Components.interfaces.calICompositeObserver,</span>
<a href="#l15.367"></a><span id="l15.367">               Components.interfaces.calIObserver</span>
<a href="#l15.368"></a><span id="l15.368">           ]),</span>
<a href="#l15.369"></a><span id="l15.369"> </span>
<a href="#l15.370"></a><span id="l15.370">           /**</span>
<a href="#l15.371"></a><span id="l15.371">            * calIObserver methods and properties</span>
<a href="#l15.372"></a><span id="l15.372">            */</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineminus">-          onStartBatch: function tTO_onStartBatch() {</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineplus">+          onStartBatch: function() {</span>
<a href="#l15.375"></a><span id="l15.375">           },</span>
<a href="#l15.376"></a><span id="l15.376"> </span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-          onEndBatch: function tTO_onEndBatch() {</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineplus">+          onEndBatch: function() {</span>
<a href="#l15.379"></a><span id="l15.379">           },</span>
<a href="#l15.380"></a><span id="l15.380"> </span>
<a href="#l15.381"></a><span id="l15.381" class="difflineminus">-          onLoad: function tTO_onLoad() {</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineplus">+          onLoad: function() {</span>
<a href="#l15.383"></a><span id="l15.383">               this.binding.refresh();</span>
<a href="#l15.384"></a><span id="l15.384">           },</span>
<a href="#l15.385"></a><span id="l15.385"> </span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-          onAddItem: function tTO_onAddItem(aItem) {</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+          onAddItem: function(aItem) {</span>
<a href="#l15.388"></a><span id="l15.388">               if (cal.isToDo(aItem)) {</span>
<a href="#l15.389"></a><span id="l15.389">                   this.binding.mTreeView.addItems(this.binding.mFilter.getOccurrences(aItem));</span>
<a href="#l15.390"></a><span id="l15.390">               }</span>
<a href="#l15.391"></a><span id="l15.391">           },</span>
<a href="#l15.392"></a><span id="l15.392"> </span>
<a href="#l15.393"></a><span id="l15.393" class="difflineminus">-          onModifyItem: function tTO_onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineminus">-              if ((cal.isToDo(aNewItem) || cal.isToDo(aOldItem))) {</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+          onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineplus">+              if (cal.isToDo(aNewItem) || cal.isToDo(aOldItem)) {</span>
<a href="#l15.397"></a><span id="l15.397">                   this.binding.mTreeView.modifyItems(this.binding.mFilter.getOccurrences(aNewItem),</span>
<a href="#l15.398"></a><span id="l15.398">                                                      this.binding.mFilter.getOccurrences(aOldItem));</span>
<a href="#l15.399"></a><span id="l15.399"> </span>
<a href="#l15.400"></a><span id="l15.400">                   // we also need to notify potential listeners.</span>
<a href="#l15.401"></a><span id="l15.401">                   let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.402"></a><span id="l15.402">                   event.initEvent(&quot;select&quot;, true, false);</span>
<a href="#l15.403"></a><span id="l15.403">                   this.binding.dispatchEvent(event);</span>
<a href="#l15.404"></a><span id="l15.404">               }</span>
<a href="#l15.405"></a><span id="l15.405">           },</span>
<a href="#l15.406"></a><span id="l15.406"> </span>
<a href="#l15.407"></a><span id="l15.407" class="difflineminus">-          onDeleteItem: function tTO_onDeleteItem(aDeletedItem) {</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineplus">+          onDeleteItem: function(aDeletedItem) {</span>
<a href="#l15.409"></a><span id="l15.409">               if (cal.isToDo(aDeletedItem)) {</span>
<a href="#l15.410"></a><span id="l15.410">                   this.binding.mTreeView.removeItems(this.binding.mFilter.getOccurrences(aDeletedItem));</span>
<a href="#l15.411"></a><span id="l15.411">               }</span>
<a href="#l15.412"></a><span id="l15.412">           },</span>
<a href="#l15.413"></a><span id="l15.413"> </span>
<a href="#l15.414"></a><span id="l15.414" class="difflineminus">-          onError: function tTO_onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-          onPropertyChanged: function tTO_onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+          onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+          onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l15.418"></a><span id="l15.418">               switch (aName) {</span>
<a href="#l15.419"></a><span id="l15.419">                   case &quot;disabled&quot;:</span>
<a href="#l15.420"></a><span id="l15.420">                       if (aValue) {</span>
<a href="#l15.421"></a><span id="l15.421">                           this.binding.onCalendarRemoved(aCalendar);</span>
<a href="#l15.422"></a><span id="l15.422">                       } else {</span>
<a href="#l15.423"></a><span id="l15.423">                           this.binding.onCalendarAdded(aCalendar);</span>
<a href="#l15.424"></a><span id="l15.424">                       }</span>
<a href="#l15.425"></a><span id="l15.425">                       break;</span>
<a href="#l15.426"></a><span id="l15.426">               }</span>
<a href="#l15.427"></a><span id="l15.427">           },</span>
<a href="#l15.428"></a><span id="l15.428"> </span>
<a href="#l15.429"></a><span id="l15.429" class="difflineminus">-          onPropertyDeleting: function tTO_onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineplus">+          onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l15.431"></a><span id="l15.431">               this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l15.432"></a><span id="l15.432">           },</span>
<a href="#l15.433"></a><span id="l15.433"> </span>
<a href="#l15.434"></a><span id="l15.434">           /**</span>
<a href="#l15.435"></a><span id="l15.435">            * calICompositeObserver methods and properties</span>
<a href="#l15.436"></a><span id="l15.436">            */</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineminus">-          onCalendarAdded: function tTO_onCalendarAdded(aCalendar) {</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineplus">+          onCalendarAdded: function(aCalendar) {</span>
<a href="#l15.439"></a><span id="l15.439">               if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l15.440"></a><span id="l15.440">                   this.binding.onCalendarAdded(aCalendar);</span>
<a href="#l15.441"></a><span id="l15.441">               }</span>
<a href="#l15.442"></a><span id="l15.442">           },</span>
<a href="#l15.443"></a><span id="l15.443"> </span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-          onCalendarRemoved: function tTO_onCalendarRemoved(aCalendar) {</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+          onCalendarRemoved: function(aCalendar) {</span>
<a href="#l15.446"></a><span id="l15.446">               this.binding.onCalendarRemoved(aCalendar);</span>
<a href="#l15.447"></a><span id="l15.447">           },</span>
<a href="#l15.448"></a><span id="l15.448"> </span>
<a href="#l15.449"></a><span id="l15.449" class="difflineminus">-          onDefaultCalendarChanged: function tTO_onDefaultCalendarChanged(aNewDefaultCalendar) {}</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+          onDefaultCalendarChanged: function(aNewDefaultCalendar) {}</span>
<a href="#l15.451"></a><span id="l15.451">       })</span>
<a href="#l15.452"></a><span id="l15.452">       ]]&gt;&lt;/field&gt;</span>
<a href="#l15.453"></a><span id="l15.453"> </span>
<a href="#l15.454"></a><span id="l15.454">       &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l15.455"></a><span id="l15.455">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l15.456"></a><span id="l15.456">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l15.457"></a><span id="l15.457">         &lt;parameter name=&quot;aPrefName&quot;/&gt;</span>
<a href="#l15.458"></a><span id="l15.458">         &lt;body&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -11,17 +11,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l16.4"></a><span id="l16.4"> var taskDetailsView = {</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">     /**</span>
<a href="#l16.7"></a><span id="l16.7">      * Task Details Events</span>
<a href="#l16.8"></a><span id="l16.8">      *</span>
<a href="#l16.9"></a><span id="l16.9">      * XXXberend Please document this function, possibly also consolidate since</span>
<a href="#l16.10"></a><span id="l16.10">      * its the only function in taskDetailsView.</span>
<a href="#l16.11"></a><span id="l16.11">      */</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    onSelect: function tDV_onSelect(event) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    onSelect: function(event) {</span>
<a href="#l16.14"></a><span id="l16.14">         function displayElement(id, flag) {</span>
<a href="#l16.15"></a><span id="l16.15">             setBooleanAttribute(id, &quot;hidden&quot;, !flag);</span>
<a href="#l16.16"></a><span id="l16.16">             return flag;</span>
<a href="#l16.17"></a><span id="l16.17">         }</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">         let dateFormatter =</span>
<a href="#l16.20"></a><span id="l16.20">             Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l16.21"></a><span id="l16.21">             .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -142,23 +142,23 @@ var taskDetailsView = {</span>
<a href="#l16.23"></a><span id="l16.23">                                           &quot;if (event.button != 2) launchBrowser(this.value);&quot;);</span>
<a href="#l16.24"></a><span id="l16.24">                     urlLabel.setAttribute(&quot;context&quot;, &quot;taskview-link-context-menu&quot;);</span>
<a href="#l16.25"></a><span id="l16.25">                     attachmentRows.appendChild(urlLabel);</span>
<a href="#l16.26"></a><span id="l16.26">                 }</span>
<a href="#l16.27"></a><span id="l16.27">             }</span>
<a href="#l16.28"></a><span id="l16.28">         }</span>
<a href="#l16.29"></a><span id="l16.29">     },</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-    loadCategories: function loadCategories(event) {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+    loadCategories: function(event) {</span>
<a href="#l16.33"></a><span id="l16.33">         let panel = event.target;</span>
<a href="#l16.34"></a><span id="l16.34">         let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l16.35"></a><span id="l16.35">         panel.loadItem(item);</span>
<a href="#l16.36"></a><span id="l16.36">     },</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-    saveCategories: function saveCategories(event) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+    saveCategories: function(event) {</span>
<a href="#l16.40"></a><span id="l16.40">         let panel = event.target;</span>
<a href="#l16.41"></a><span id="l16.41">         let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l16.42"></a><span id="l16.42">         let categoriesMap = {};</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44">         for (let cat of item.getCategories({})) {</span>
<a href="#l16.45"></a><span id="l16.45">             categoriesMap[cat] = true;</span>
<a href="#l16.46"></a><span id="l16.46">         }</span>
<a href="#l16.47"></a><span id="l16.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -58,92 +58,92 @@ function getCurrentUnifinderFilter() {</span>
<a href="#l17.4"></a><span id="l17.4"> var unifinderObserver = {</span>
<a href="#l17.5"></a><span id="l17.5">     QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l17.6"></a><span id="l17.6">         Components.interfaces.calICompositeObserver,</span>
<a href="#l17.7"></a><span id="l17.7">         Components.interfaces.nsIObserver,</span>
<a href="#l17.8"></a><span id="l17.8">         Components.interfaces.calIObserver</span>
<a href="#l17.9"></a><span id="l17.9">     ]),</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">     // calIObserver:</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    onStartBatch: function uO_onStartBatch() {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    onStartBatch: function() {</span>
<a href="#l17.14"></a><span id="l17.14">     },</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-    onEndBatch: function uO_onEndBatch() {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+    onEndBatch: function() {</span>
<a href="#l17.18"></a><span id="l17.18">         refreshEventTree();</span>
<a href="#l17.19"></a><span id="l17.19">     },</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-    onLoad: function uO_onLoad() {</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+    onLoad: function() {</span>
<a href="#l17.23"></a><span id="l17.23">         if (isUnifinderHidden() &amp;&amp; !gUnifinderNeedsRefresh) {</span>
<a href="#l17.24"></a><span id="l17.24">             // If the unifinder is hidden, all further item operations might</span>
<a href="#l17.25"></a><span id="l17.25">             // produce invalid entries in the unifinder. From now on, ignore</span>
<a href="#l17.26"></a><span id="l17.26">             // those operations and refresh as soon as the unifinder is shown</span>
<a href="#l17.27"></a><span id="l17.27">             // again.</span>
<a href="#l17.28"></a><span id="l17.28">             gUnifinderNeedsRefresh = true;</span>
<a href="#l17.29"></a><span id="l17.29">             unifinderTreeView.clearItems();</span>
<a href="#l17.30"></a><span id="l17.30">         }</span>
<a href="#l17.31"></a><span id="l17.31">     },</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    onAddItem: function uO_onAddItem(aItem) {</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    onAddItem: function(aItem) {</span>
<a href="#l17.35"></a><span id="l17.35">         if (isEvent(aItem) &amp;&amp;</span>
<a href="#l17.36"></a><span id="l17.36">             !gUnifinderNeedsRefresh &amp;&amp;</span>
<a href="#l17.37"></a><span id="l17.37">             unifinderTreeView.mFilter.isItemInFilters(aItem)</span>
<a href="#l17.38"></a><span id="l17.38">             ) {</span>
<a href="#l17.39"></a><span id="l17.39">             this.addItemToTree(aItem);</span>
<a href="#l17.40"></a><span id="l17.40">         }</span>
<a href="#l17.41"></a><span id="l17.41">     },</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    onModifyItem: function uO_onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+    onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l17.45"></a><span id="l17.45">         this.onDeleteItem(aOldItem);</span>
<a href="#l17.46"></a><span id="l17.46">         this.onAddItem(aNewItem);</span>
<a href="#l17.47"></a><span id="l17.47">     },</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    onDeleteItem: function uO_onDeleteItem(aDeletedItem) {</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    onDeleteItem: function(aDeletedItem) {</span>
<a href="#l17.51"></a><span id="l17.51">         if (isEvent(aDeletedItem) &amp;&amp; !gUnifinderNeedsRefresh) {</span>
<a href="#l17.52"></a><span id="l17.52">             this.removeItemFromTree(aDeletedItem);</span>
<a href="#l17.53"></a><span id="l17.53">         }</span>
<a href="#l17.54"></a><span id="l17.54">     },</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-    onError: function uO_onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-    onPropertyChanged: function uO_onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l17.61"></a><span id="l17.61">         switch (aName) {</span>
<a href="#l17.62"></a><span id="l17.62">             case &quot;disabled&quot;:</span>
<a href="#l17.63"></a><span id="l17.63">                 refreshEventTree();</span>
<a href="#l17.64"></a><span id="l17.64">                 break;</span>
<a href="#l17.65"></a><span id="l17.65">         }</span>
<a href="#l17.66"></a><span id="l17.66">     },</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-    onPropertyDeleting: function uO_onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l17.70"></a><span id="l17.70">       this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l17.71"></a><span id="l17.71">     },</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73">     // calICompositeObserver:</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-    onCalendarAdded: function uO_onCalendarAdded(aAddedCalendar) {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+    onCalendarAdded: function(aAddedCalendar) {</span>
<a href="#l17.76"></a><span id="l17.76">         if (!aAddedCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l17.77"></a><span id="l17.77">             addItemsFromCalendar(aAddedCalendar,</span>
<a href="#l17.78"></a><span id="l17.78">                                  addItemsFromSingleCalendarInternal);</span>
<a href="#l17.79"></a><span id="l17.79">         }</span>
<a href="#l17.80"></a><span id="l17.80">     },</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-    onCalendarRemoved: function uO_onCalendarRemoved(aDeletedCalendar) {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    onCalendarRemoved: function(aDeletedCalendar) {</span>
<a href="#l17.84"></a><span id="l17.84">         if (!aDeletedCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l17.85"></a><span id="l17.85">             deleteItemsFromCalendar(aDeletedCalendar);</span>
<a href="#l17.86"></a><span id="l17.86">         }</span>
<a href="#l17.87"></a><span id="l17.87">     },</span>
<a href="#l17.88"></a><span id="l17.88"> </span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-    onDefaultCalendarChanged: function uO_onDefaultCalendarChanged(aNewDefaultCalendar) {},</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+    onDefaultCalendarChanged: function(aNewDefaultCalendar) {},</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92">     /**</span>
<a href="#l17.93"></a><span id="l17.93">      * Add an unifinder item to the tree. It is safe to call these for any</span>
<a href="#l17.94"></a><span id="l17.94">      * event. The functions will determine whether or not anything actually</span>
<a href="#l17.95"></a><span id="l17.95">      * needs to be done to the tree.</span>
<a href="#l17.96"></a><span id="l17.96">      *</span>
<a href="#l17.97"></a><span id="l17.97">      * @return aItem        The item to add to the tree.</span>
<a href="#l17.98"></a><span id="l17.98">      */</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-    addItemToTree: function uO_addItemToTree(aItem) {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+    addItemToTree: function(aItem) {</span>
<a href="#l17.101"></a><span id="l17.101">         let items;</span>
<a href="#l17.102"></a><span id="l17.102">         let filter = unifinderTreeView.mFilter;</span>
<a href="#l17.103"></a><span id="l17.103"> </span>
<a href="#l17.104"></a><span id="l17.104">         if (filter.startDate &amp;&amp; filter.endDate) {</span>
<a href="#l17.105"></a><span id="l17.105">             items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate, {});</span>
<a href="#l17.106"></a><span id="l17.106">         } else {</span>
<a href="#l17.107"></a><span id="l17.107">             items = [aItem];</span>
<a href="#l17.108"></a><span id="l17.108">         }</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineat">@@ -152,29 +152,29 @@ var unifinderObserver = {</span>
<a href="#l17.110"></a><span id="l17.110"> </span>
<a href="#l17.111"></a><span id="l17.111">     /**</span>
<a href="#l17.112"></a><span id="l17.112">      * Remove an item from the unifinder tree. It is safe to call these for any</span>
<a href="#l17.113"></a><span id="l17.113">      * event. The functions will determine whether or not anything actually</span>
<a href="#l17.114"></a><span id="l17.114">      * needs to be done to the tree.</span>
<a href="#l17.115"></a><span id="l17.115">      *</span>
<a href="#l17.116"></a><span id="l17.116">      * @return aItem        The item to remove from the tree.</span>
<a href="#l17.117"></a><span id="l17.117">      */</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-    removeItemFromTree: function uO_removeItemFromTree(aItem) {</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+    removeItemFromTree: function(aItem) {</span>
<a href="#l17.120"></a><span id="l17.120">         let items;</span>
<a href="#l17.121"></a><span id="l17.121">         let filter = unifinderTreeView.mFilter;</span>
<a href="#l17.122"></a><span id="l17.122">         if (filter.startDate &amp;&amp; filter.endDate &amp;&amp; (aItem.parentItem == aItem)) {</span>
<a href="#l17.123"></a><span id="l17.123">             items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate, {});</span>
<a href="#l17.124"></a><span id="l17.124">         } else {</span>
<a href="#l17.125"></a><span id="l17.125">             items = [aItem];</span>
<a href="#l17.126"></a><span id="l17.126">         }</span>
<a href="#l17.127"></a><span id="l17.127">         // XXX: do we really still need this, we are always checking it in the refreshInternal</span>
<a href="#l17.128"></a><span id="l17.128">         unifinderTreeView.removeItems(items.filter(filter.isItemInFilters, filter));</span>
<a href="#l17.129"></a><span id="l17.129">     },</span>
<a href="#l17.130"></a><span id="l17.130"> </span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-    observe: function uO_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+    observe: function(aSubject, aTopic, aPrefName) {</span>
<a href="#l17.133"></a><span id="l17.133">         switch (aPrefName) {</span>
<a href="#l17.134"></a><span id="l17.134">             case &quot;calendar.date.format&quot;:</span>
<a href="#l17.135"></a><span id="l17.135">             case &quot;calendar.timezone.local&quot;:</span>
<a href="#l17.136"></a><span id="l17.136">                 refreshEventTree();</span>
<a href="#l17.137"></a><span id="l17.137">                 break;</span>
<a href="#l17.138"></a><span id="l17.138">         }</span>
<a href="#l17.139"></a><span id="l17.139">     }</span>
<a href="#l17.140"></a><span id="l17.140"> };</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineat">@@ -439,34 +439,34 @@ var unifinderTreeView = {</span>
<a href="#l17.142"></a><span id="l17.142">     eventIndexMap: {},</span>
<a href="#l17.143"></a><span id="l17.143"> </span>
<a href="#l17.144"></a><span id="l17.144">     /**</span>
<a href="#l17.145"></a><span id="l17.145">      * Add an item to the unifinder tree.</span>
<a href="#l17.146"></a><span id="l17.146">      *</span>
<a href="#l17.147"></a><span id="l17.147">      * @param aItemArray        An array of items to add.</span>
<a href="#l17.148"></a><span id="l17.148">      * @param aDontSort         If true, the items will only be appended.</span>
<a href="#l17.149"></a><span id="l17.149">      */</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-    addItems: function uTV_addItems(aItemArray, aDontSort) {</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+    addItems: function(aItemArray, aDontSort) {</span>
<a href="#l17.152"></a><span id="l17.152">         this.eventArray = this.eventArray.concat(aItemArray);</span>
<a href="#l17.153"></a><span id="l17.153">         let newCount = (this.eventArray.length - aItemArray.length - 1);</span>
<a href="#l17.154"></a><span id="l17.154">         this.tree.rowCountChanged(newCount, aItemArray.length);</span>
<a href="#l17.155"></a><span id="l17.155"> </span>
<a href="#l17.156"></a><span id="l17.156">         if (aDontSort) {</span>
<a href="#l17.157"></a><span id="l17.157">             this.calculateIndexMap();</span>
<a href="#l17.158"></a><span id="l17.158">         } else {</span>
<a href="#l17.159"></a><span id="l17.159">             this.sortItems();</span>
<a href="#l17.160"></a><span id="l17.160">         }</span>
<a href="#l17.161"></a><span id="l17.161">     },</span>
<a href="#l17.162"></a><span id="l17.162"> </span>
<a href="#l17.163"></a><span id="l17.163">     /**</span>
<a href="#l17.164"></a><span id="l17.164">      * Remove items from the unifinder tree.</span>
<a href="#l17.165"></a><span id="l17.165">      *</span>
<a href="#l17.166"></a><span id="l17.166">      * @param aItemArray        An array of items to remove.</span>
<a href="#l17.167"></a><span id="l17.167">      */</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-    removeItems: function uTV_removeItems(aItemArray) {</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+    removeItems: function(aItemArray) {</span>
<a href="#l17.170"></a><span id="l17.170">         let indexesToRemove = [];</span>
<a href="#l17.171"></a><span id="l17.171">         // Removing items is a bit tricky. Our getItemRow function takes the</span>
<a href="#l17.172"></a><span id="l17.172">         // index from a cached map, so removing an item from the array will</span>
<a href="#l17.173"></a><span id="l17.173">         // remove the wrong indexes. We don't want to just invalidate the map,</span>
<a href="#l17.174"></a><span id="l17.174">         // since this will cause O(n^2) behavior. Instead, we keep a sorted</span>
<a href="#l17.175"></a><span id="l17.175">         // array of the indexes to remove:</span>
<a href="#l17.176"></a><span id="l17.176">         for (let item of aItemArray) {</span>
<a href="#l17.177"></a><span id="l17.177">             let row = this.getItemRow(item);</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineat">@@ -495,28 +495,28 @@ var unifinderTreeView = {</span>
<a href="#l17.179"></a><span id="l17.179">         // (given that Array.unshift doesn't loop but just prepends or maps</span>
<a href="#l17.180"></a><span id="l17.180">         // memory smartly) O(3n) behavior. Lets hope its worth it.</span>
<a href="#l17.181"></a><span id="l17.181">         this.calculateIndexMap(true);</span>
<a href="#l17.182"></a><span id="l17.182">     },</span>
<a href="#l17.183"></a><span id="l17.183"> </span>
<a href="#l17.184"></a><span id="l17.184">     /**</span>
<a href="#l17.185"></a><span id="l17.185">      * Clear all items from the unifinder.</span>
<a href="#l17.186"></a><span id="l17.186">      */</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-    clearItems: function uTV_clearItems() {</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+    clearItems: function() {</span>
<a href="#l17.189"></a><span id="l17.189">         let oldCount = this.eventArray.length;</span>
<a href="#l17.190"></a><span id="l17.190">         this.eventArray = [];</span>
<a href="#l17.191"></a><span id="l17.191">         this.tree.rowCountChanged(0, -oldCount);</span>
<a href="#l17.192"></a><span id="l17.192">         this.calculateIndexMap();</span>
<a href="#l17.193"></a><span id="l17.193">     },</span>
<a href="#l17.194"></a><span id="l17.194"> </span>
<a href="#l17.195"></a><span id="l17.195">     /**</span>
<a href="#l17.196"></a><span id="l17.196">      * Sets the items that should be in the unifinder. This removes all items</span>
<a href="#l17.197"></a><span id="l17.197">      * that were previously in the unifinder.</span>
<a href="#l17.198"></a><span id="l17.198">      */</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-    setItems: function uTV_setItems(aItemArray, aDontSort) {</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+    setItems: function(aItemArray, aDontSort) {</span>
<a href="#l17.201"></a><span id="l17.201">         let oldCount = this.eventArray.length;</span>
<a href="#l17.202"></a><span id="l17.202">         this.eventArray = aItemArray.slice(0);</span>
<a href="#l17.203"></a><span id="l17.203">         this.tree.rowCountChanged(oldCount - 1, this.eventArray.length - oldCount);</span>
<a href="#l17.204"></a><span id="l17.204"> </span>
<a href="#l17.205"></a><span id="l17.205">         if (aDontSort) {</span>
<a href="#l17.206"></a><span id="l17.206">             this.calculateIndexMap();</span>
<a href="#l17.207"></a><span id="l17.207">         } else {</span>
<a href="#l17.208"></a><span id="l17.208">             this.sortItems();</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineat">@@ -527,31 +527,31 @@ var unifinderTreeView = {</span>
<a href="#l17.210"></a><span id="l17.210">      * Recalculate the index map that improves performance when accessing</span>
<a href="#l17.211"></a><span id="l17.211">      * unifinder items. This is usually done automatically when adding/removing</span>
<a href="#l17.212"></a><span id="l17.212">      * items.</span>
<a href="#l17.213"></a><span id="l17.213">      *</span>
<a href="#l17.214"></a><span id="l17.214">      * @param aDontInvalidate       (optional) Don't invalidate the tree, i.e if</span>
<a href="#l17.215"></a><span id="l17.215">      *                                you correctly issued rowCountChanged</span>
<a href="#l17.216"></a><span id="l17.216">      *                                notices.</span>
<a href="#l17.217"></a><span id="l17.217">      */</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-    calculateIndexMap: function uTV_calculateIndexMap(aDontInvalidate) {</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+    calculateIndexMap: function(aDontInvalidate) {</span>
<a href="#l17.220"></a><span id="l17.220">         this.eventIndexMap = {};</span>
<a href="#l17.221"></a><span id="l17.221">         for (let i = 0; i &lt; this.eventArray.length; i++) {</span>
<a href="#l17.222"></a><span id="l17.222">             this.eventIndexMap[this.eventArray[i].hashId] = i;</span>
<a href="#l17.223"></a><span id="l17.223">         }</span>
<a href="#l17.224"></a><span id="l17.224"> </span>
<a href="#l17.225"></a><span id="l17.225">         if (!aDontInvalidate) {</span>
<a href="#l17.226"></a><span id="l17.226">             this.tree.invalidate();</span>
<a href="#l17.227"></a><span id="l17.227">         }</span>
<a href="#l17.228"></a><span id="l17.228">     },</span>
<a href="#l17.229"></a><span id="l17.229"> </span>
<a href="#l17.230"></a><span id="l17.230">     /**</span>
<a href="#l17.231"></a><span id="l17.231">      * Sort the items in the unifinder by the currently selected column.</span>
<a href="#l17.232"></a><span id="l17.232">      */</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-    sortItems: function uTV_sortItems() {</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+    sortItems: function() {</span>
<a href="#l17.235"></a><span id="l17.235">         if (this.selectedColumn) {</span>
<a href="#l17.236"></a><span id="l17.236">             let modifier = (this.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l17.237"></a><span id="l17.237">             let sortKey = unifinderTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l17.238"></a><span id="l17.238">             let sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l17.239"></a><span id="l17.239">             // sort (key,item) entries</span>
<a href="#l17.240"></a><span id="l17.240">             cal.sortEntry.mSortKey = sortKey;</span>
<a href="#l17.241"></a><span id="l17.241">             cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l17.242"></a><span id="l17.242">             let entries = this.eventArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineat">@@ -562,54 +562,54 @@ var unifinderTreeView = {</span>
<a href="#l17.244"></a><span id="l17.244">     },</span>
<a href="#l17.245"></a><span id="l17.245"> </span>
<a href="#l17.246"></a><span id="l17.246">     /**</span>
<a href="#l17.247"></a><span id="l17.247">      * Get the index of the row associated with the passed item.</span>
<a href="#l17.248"></a><span id="l17.248">      *</span>
<a href="#l17.249"></a><span id="l17.249">      * @param item      The item to search for.</span>
<a href="#l17.250"></a><span id="l17.250">      * @return          The row index of the passed item.</span>
<a href="#l17.251"></a><span id="l17.251">      */</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-    getItemRow: function uTV_getItemRow(item) {</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+    getItemRow: function(item) {</span>
<a href="#l17.254"></a><span id="l17.254">         if (this.eventIndexMap[item.hashId] === undefined) {</span>
<a href="#l17.255"></a><span id="l17.255">             return -1;</span>
<a href="#l17.256"></a><span id="l17.256">         }</span>
<a href="#l17.257"></a><span id="l17.257">         return this.eventIndexMap[item.hashId];</span>
<a href="#l17.258"></a><span id="l17.258">     },</span>
<a href="#l17.259"></a><span id="l17.259"> </span>
<a href="#l17.260"></a><span id="l17.260">     /**</span>
<a href="#l17.261"></a><span id="l17.261">      * Get the item at the given row index.</span>
<a href="#l17.262"></a><span id="l17.262">      *</span>
<a href="#l17.263"></a><span id="l17.263">      * @param item      The row index to get the item for.</span>
<a href="#l17.264"></a><span id="l17.264">      * @return          The item at the given row.</span>
<a href="#l17.265"></a><span id="l17.265">      */</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-    getItemAt: function uTV_getItemAt(aRow) {</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+    getItemAt: function(aRow) {</span>
<a href="#l17.268"></a><span id="l17.268">         return this.eventArray[aRow];</span>
<a href="#l17.269"></a><span id="l17.269">     },</span>
<a href="#l17.270"></a><span id="l17.270"> </span>
<a href="#l17.271"></a><span id="l17.271">     /**</span>
<a href="#l17.272"></a><span id="l17.272">      * Get the calendar item from the given DOM event</span>
<a href="#l17.273"></a><span id="l17.273">      *</span>
<a href="#l17.274"></a><span id="l17.274">      * @param event     The DOM mouse event to get the item for.</span>
<a href="#l17.275"></a><span id="l17.275">      * @return          The item under the mouse position.</span>
<a href="#l17.276"></a><span id="l17.276">      */</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-    getItemFromEvent: function uTV_getItemFromEvent(event) {</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+    getItemFromEvent: function(event) {</span>
<a href="#l17.279"></a><span id="l17.279">         let row = this.tree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l17.280"></a><span id="l17.280"> </span>
<a href="#l17.281"></a><span id="l17.281">         if (row &gt; -1) {</span>
<a href="#l17.282"></a><span id="l17.282">             return this.getItemAt(row);</span>
<a href="#l17.283"></a><span id="l17.283">         }</span>
<a href="#l17.284"></a><span id="l17.284">         return null;</span>
<a href="#l17.285"></a><span id="l17.285">     },</span>
<a href="#l17.286"></a><span id="l17.286"> </span>
<a href="#l17.287"></a><span id="l17.287">     /**</span>
<a href="#l17.288"></a><span id="l17.288">      * Change the selection in the unifinder.</span>
<a href="#l17.289"></a><span id="l17.289">      *</span>
<a href="#l17.290"></a><span id="l17.290">      * @param aItemArray        An array of items to select.</span>
<a href="#l17.291"></a><span id="l17.291">      */</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-    setSelectedItems: function uTV_setSelectedItems(aItemArray) {</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+    setSelectedItems: function(aItemArray) {</span>
<a href="#l17.294"></a><span id="l17.294">         if (this.doingSelection || !this.tree || !this.tree.view) {</span>
<a href="#l17.295"></a><span id="l17.295">             return;</span>
<a href="#l17.296"></a><span id="l17.296">         }</span>
<a href="#l17.297"></a><span id="l17.297"> </span>
<a href="#l17.298"></a><span id="l17.298">         this.doingSelection = true;</span>
<a href="#l17.299"></a><span id="l17.299"> </span>
<a href="#l17.300"></a><span id="l17.300">         // If no items were passed, get the selected items from the view.</span>
<a href="#l17.301"></a><span id="l17.301">         aItemArray = aItemArray || currentView().getSelectedItems({});</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineat">@@ -646,17 +646,17 @@ var unifinderTreeView = {</span>
<a href="#l17.303"></a><span id="l17.303">         // This needs to be in a setTimeout</span>
<a href="#l17.304"></a><span id="l17.304">         setTimeout(function() { unifinderTreeView.resetAllowSelection(); }, 1);</span>
<a href="#l17.305"></a><span id="l17.305">     },</span>
<a href="#l17.306"></a><span id="l17.306"> </span>
<a href="#l17.307"></a><span id="l17.307">     /**</span>
<a href="#l17.308"></a><span id="l17.308">      * Due to a selection issue described in bug 168211 this method is needed to</span>
<a href="#l17.309"></a><span id="l17.309">      * re-add the selection listeners selection listeners.</span>
<a href="#l17.310"></a><span id="l17.310">      */</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineminus">-    resetAllowSelection: function uTV_resetAllowSelection() {</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+    resetAllowSelection: function() {</span>
<a href="#l17.313"></a><span id="l17.313">         if (!this.tree) {</span>
<a href="#l17.314"></a><span id="l17.314">             return;</span>
<a href="#l17.315"></a><span id="l17.315">         }</span>
<a href="#l17.316"></a><span id="l17.316">         /**</span>
<a href="#l17.317"></a><span id="l17.317">          * Do not change anything in the following lines, they are needed as</span>
<a href="#l17.318"></a><span id="l17.318">          * described in the selection observer above</span>
<a href="#l17.319"></a><span id="l17.319">          */</span>
<a href="#l17.320"></a><span id="l17.320">         this.doingSelection = false;</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineat">@@ -673,22 +673,22 @@ var unifinderTreeView = {</span>
<a href="#l17.322"></a><span id="l17.322">         return this.eventArray.length;</span>
<a href="#l17.323"></a><span id="l17.323">     },</span>
<a href="#l17.324"></a><span id="l17.324"> </span>
<a href="#l17.325"></a><span id="l17.325"> </span>
<a href="#l17.326"></a><span id="l17.326">     // TODO this code is currently identical to the task tree. We should create</span>
<a href="#l17.327"></a><span id="l17.327">     // an itemTreeView that these tree views can inherit, that contains this</span>
<a href="#l17.328"></a><span id="l17.328">     // code, and possibly other code related to sorting and storing items. See</span>
<a href="#l17.329"></a><span id="l17.329">     // bug 432582 for more details.</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-    getCellProperties: function uTV_getCellProperties(aRow, aCol) {</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+    getCellProperties: function(aRow, aCol) {</span>
<a href="#l17.332"></a><span id="l17.332">         let rowProps = this.getRowProperties(aRow);</span>
<a href="#l17.333"></a><span id="l17.333">         let colProps = this.getColumnProperties(aCol);</span>
<a href="#l17.334"></a><span id="l17.334">         return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l17.335"></a><span id="l17.335">     },</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineminus">-    getRowProperties: function uTV_getRowProperties(aRow) {</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+    getRowProperties: function(aRow) {</span>
<a href="#l17.338"></a><span id="l17.338">         let properties = [];</span>
<a href="#l17.339"></a><span id="l17.339">         let item = this.eventArray[aRow];</span>
<a href="#l17.340"></a><span id="l17.340">         if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l17.341"></a><span id="l17.341">             properties.push(&quot;highpriority&quot;);</span>
<a href="#l17.342"></a><span id="l17.342">         } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l17.343"></a><span id="l17.343">             properties.push(&quot;lowpriority&quot;);</span>
<a href="#l17.344"></a><span id="l17.344">         }</span>
<a href="#l17.345"></a><span id="l17.345"> </span>
<a href="#l17.346"></a><span id="l17.346" class="difflineat">@@ -706,63 +706,63 @@ var unifinderTreeView = {</span>
<a href="#l17.347"></a><span id="l17.347">         }</span>
<a href="#l17.348"></a><span id="l17.348"> </span>
<a href="#l17.349"></a><span id="l17.349">         // Task categories</span>
<a href="#l17.350"></a><span id="l17.350">         properties = properties.concat(item.getCategories({})</span>
<a href="#l17.351"></a><span id="l17.351">                                            .map(formatStringForCSSRule));</span>
<a href="#l17.352"></a><span id="l17.352"> </span>
<a href="#l17.353"></a><span id="l17.353">         return properties.join(&quot; &quot;);</span>
<a href="#l17.354"></a><span id="l17.354">     },</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineminus">-    getColumnProperties: function uTV_getColumnProperties(aCol) { return &quot;&quot;; },</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineplus">+    getColumnProperties: function(aCol) { return &quot;&quot;; },</span>
<a href="#l17.357"></a><span id="l17.357"> </span>
<a href="#l17.358"></a><span id="l17.358" class="difflineminus">-    isContainer: function uTV_isContainer() {</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineplus">+    isContainer: function() {</span>
<a href="#l17.360"></a><span id="l17.360">         return false;</span>
<a href="#l17.361"></a><span id="l17.361">     },</span>
<a href="#l17.362"></a><span id="l17.362"> </span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-    isContainerOpen: function uTV_isContainerOpen(aRow) {</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+    isContainerOpen: function(aRow) {</span>
<a href="#l17.365"></a><span id="l17.365">         return false;</span>
<a href="#l17.366"></a><span id="l17.366">     },</span>
<a href="#l17.367"></a><span id="l17.367"> </span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-    isContainerEmpty: function uTV_isContainerEmpty(aRow) {</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+    isContainerEmpty: function(aRow) {</span>
<a href="#l17.370"></a><span id="l17.370">         return false;</span>
<a href="#l17.371"></a><span id="l17.371">     },</span>
<a href="#l17.372"></a><span id="l17.372"> </span>
<a href="#l17.373"></a><span id="l17.373" class="difflineminus">-    isSeparator: function uTV_isSeparator(aRow) {</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineplus">+    isSeparator: function(aRow) {</span>
<a href="#l17.375"></a><span id="l17.375">         return false;</span>
<a href="#l17.376"></a><span id="l17.376">     },</span>
<a href="#l17.377"></a><span id="l17.377"> </span>
<a href="#l17.378"></a><span id="l17.378" class="difflineminus">-    isSorted: function uTV_isSorted(aRow) {</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineplus">+    isSorted: function(aRow) {</span>
<a href="#l17.380"></a><span id="l17.380">         return false;</span>
<a href="#l17.381"></a><span id="l17.381">     },</span>
<a href="#l17.382"></a><span id="l17.382"> </span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-    canDrop: function uTV_canDrop(aRow, aOrientation) {</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineplus">+    canDrop: function(aRow, aOrientation) {</span>
<a href="#l17.385"></a><span id="l17.385">         return false;</span>
<a href="#l17.386"></a><span id="l17.386">     },</span>
<a href="#l17.387"></a><span id="l17.387"> </span>
<a href="#l17.388"></a><span id="l17.388" class="difflineminus">-    drop: function uTV_drop(aRow, aOrientation) {},</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineplus">+    drop: function(aRow, aOrientation) {},</span>
<a href="#l17.390"></a><span id="l17.390"> </span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-    getParentIndex: function uTV_getParentIndex(aRow) {</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineplus">+    getParentIndex: function(aRow) {</span>
<a href="#l17.393"></a><span id="l17.393">         return -1;</span>
<a href="#l17.394"></a><span id="l17.394">     },</span>
<a href="#l17.395"></a><span id="l17.395"> </span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-    hasNextSibling: function uTV_hasNextSibling(aRow, aAfterIndex) {},</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineplus">+    hasNextSibling: function(aRow, aAfterIndex) {},</span>
<a href="#l17.398"></a><span id="l17.398"> </span>
<a href="#l17.399"></a><span id="l17.399" class="difflineminus">-    getLevel: function uTV_getLevel(aRow) {</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineplus">+    getLevel: function(aRow) {</span>
<a href="#l17.401"></a><span id="l17.401">         return 0;</span>
<a href="#l17.402"></a><span id="l17.402">     },</span>
<a href="#l17.403"></a><span id="l17.403"> </span>
<a href="#l17.404"></a><span id="l17.404" class="difflineminus">-    getImageSrc: function uTV_getImageSrc(aRow, aOrientation) {},</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineplus">+    getImageSrc: function(aRow, aOrientation) {},</span>
<a href="#l17.406"></a><span id="l17.406"> </span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-    getProgressMode: function uTV_getProgressMode(aRow, aCol) {},</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineplus">+    getProgressMode: function(aRow, aCol) {},</span>
<a href="#l17.409"></a><span id="l17.409"> </span>
<a href="#l17.410"></a><span id="l17.410" class="difflineminus">-    getCellValue: function uTV_getCellValue(aRow, aCol) {</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineplus">+    getCellValue: function(aRow, aCol) {</span>
<a href="#l17.412"></a><span id="l17.412">         return null;</span>
<a href="#l17.413"></a><span id="l17.413">     },</span>
<a href="#l17.414"></a><span id="l17.414"> </span>
<a href="#l17.415"></a><span id="l17.415" class="difflineminus">-    getCellText: function uTV_getCellText(row, column) {</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+    getCellText: function(row, column) {</span>
<a href="#l17.417"></a><span id="l17.417">         let calendarEvent = this.eventArray[row];</span>
<a href="#l17.418"></a><span id="l17.418"> </span>
<a href="#l17.419"></a><span id="l17.419">         switch (column.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l17.420"></a><span id="l17.420">             case &quot;title&quot;:</span>
<a href="#l17.421"></a><span id="l17.421">                 return (calendarEvent.title ? calendarEvent.title.replace(/\n/g, &quot; &quot;) : &quot;&quot;);</span>
<a href="#l17.422"></a><span id="l17.422">             case &quot;startDate&quot;:</span>
<a href="#l17.423"></a><span id="l17.423">                 return formatUnifinderEventDateTime(calendarEvent.startDate);</span>
<a href="#l17.424"></a><span id="l17.424"> </span>
<a href="#l17.425"></a><span id="l17.425" class="difflineat">@@ -788,46 +788,46 @@ var unifinderTreeView = {</span>
<a href="#l17.426"></a><span id="l17.426">             case &quot;calendar&quot;:</span>
<a href="#l17.427"></a><span id="l17.427">                 return calendarEvent.calendar.name;</span>
<a href="#l17.428"></a><span id="l17.428"> </span>
<a href="#l17.429"></a><span id="l17.429">             default:</span>
<a href="#l17.430"></a><span id="l17.430">                 return false;</span>
<a href="#l17.431"></a><span id="l17.431">         }</span>
<a href="#l17.432"></a><span id="l17.432">     },</span>
<a href="#l17.433"></a><span id="l17.433"> </span>
<a href="#l17.434"></a><span id="l17.434" class="difflineminus">-    setTree: function uTV_setTree(tree) {</span>
<a href="#l17.435"></a><span id="l17.435" class="difflineplus">+    setTree: function(tree) {</span>
<a href="#l17.436"></a><span id="l17.436">         this.tree = tree;</span>
<a href="#l17.437"></a><span id="l17.437">     },</span>
<a href="#l17.438"></a><span id="l17.438"> </span>
<a href="#l17.439"></a><span id="l17.439" class="difflineminus">-    toggleOpenState: function uTV_toggleOpenState(aRow) {},</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineplus">+    toggleOpenState: function(aRow) {},</span>
<a href="#l17.441"></a><span id="l17.441"> </span>
<a href="#l17.442"></a><span id="l17.442" class="difflineminus">-    cycleHeader: function uTV_cycleHeader(col) {</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineplus">+    cycleHeader: function(col) {</span>
<a href="#l17.444"></a><span id="l17.444">         if (!this.selectedColumn) {</span>
<a href="#l17.445"></a><span id="l17.445">             this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l17.446"></a><span id="l17.446">         } else if (!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l17.447"></a><span id="l17.447">             this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l17.448"></a><span id="l17.448">         } else {</span>
<a href="#l17.449"></a><span id="l17.449">             this.sortDirection = &quot;descending&quot;;</span>
<a href="#l17.450"></a><span id="l17.450">         }</span>
<a href="#l17.451"></a><span id="l17.451">         this.selectedColumn = col.element;</span>
<a href="#l17.452"></a><span id="l17.452">         this.sortItems();</span>
<a href="#l17.453"></a><span id="l17.453">     },</span>
<a href="#l17.454"></a><span id="l17.454"> </span>
<a href="#l17.455"></a><span id="l17.455" class="difflineminus">-    isEditable: function uTV_isEditable(aRow, aCol) {</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineplus">+    isEditable: function(aRow, aCol) {</span>
<a href="#l17.457"></a><span id="l17.457">         return false;</span>
<a href="#l17.458"></a><span id="l17.458">     },</span>
<a href="#l17.459"></a><span id="l17.459"> </span>
<a href="#l17.460"></a><span id="l17.460" class="difflineminus">-    setCellValue: function uTV_setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineminus">-    setCellText: function uTV_setCellText(aRow, aCol, aValue) {},</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineplus">+    setCellValue: function(aRow, aCol, aValue) {},</span>
<a href="#l17.463"></a><span id="l17.463" class="difflineplus">+    setCellText: function(aRow, aCol, aValue) {},</span>
<a href="#l17.464"></a><span id="l17.464"> </span>
<a href="#l17.465"></a><span id="l17.465" class="difflineminus">-    performAction: function uTV_performAction(aAction) {},</span>
<a href="#l17.466"></a><span id="l17.466" class="difflineplus">+    performAction: function(aAction) {},</span>
<a href="#l17.467"></a><span id="l17.467"> </span>
<a href="#l17.468"></a><span id="l17.468" class="difflineminus">-    performActionOnRow: function uTV_performActionOnRow(aAction, aRow) {},</span>
<a href="#l17.469"></a><span id="l17.469" class="difflineplus">+    performActionOnRow: function(aAction, aRow) {},</span>
<a href="#l17.470"></a><span id="l17.470"> </span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-    performActionOnCell: function uTV_performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineplus">+    performActionOnCell: function(aAction, aRow, aCol) {},</span>
<a href="#l17.473"></a><span id="l17.473"> </span>
<a href="#l17.474"></a><span id="l17.474">     outParameter: {} // used to obtain dates during sort</span>
<a href="#l17.475"></a><span id="l17.475"> };</span>
<a href="#l17.476"></a><span id="l17.476"> </span>
<a href="#l17.477"></a><span id="l17.477"> /**</span>
<a href="#l17.478"></a><span id="l17.478">  * Refresh the unifinder tree by getting items from the composite calendar and</span>
<a href="#l17.479"></a><span id="l17.479">  * applying the current filter.</span>
<a href="#l17.480"></a><span id="l17.480">  */</span>
<a href="#l17.481"></a><span id="l17.481" class="difflineat">@@ -877,33 +877,24 @@ function addItemsFromCalendar(aCalendar,</span>
<a href="#l17.482"></a><span id="l17.482">         // If the unifinder is hidden, don't refresh the events to reduce needed</span>
<a href="#l17.483"></a><span id="l17.483">         // getItems calls.</span>
<a href="#l17.484"></a><span id="l17.484">         return;</span>
<a href="#l17.485"></a><span id="l17.485">     }</span>
<a href="#l17.486"></a><span id="l17.486">     let refreshListener = {</span>
<a href="#l17.487"></a><span id="l17.487">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l17.488"></a><span id="l17.488">         mEventArray: [],</span>
<a href="#l17.489"></a><span id="l17.489"> </span>
<a href="#l17.490"></a><span id="l17.490" class="difflineminus">-        onOperationComplete: function rET_onOperationComplete(aOpCalendar,</span>
<a href="#l17.491"></a><span id="l17.491" class="difflineminus">-                                                              aStatus,</span>
<a href="#l17.492"></a><span id="l17.492" class="difflineminus">-                                                              aOperationType,</span>
<a href="#l17.493"></a><span id="l17.493" class="difflineminus">-                                                              aId,</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineminus">-                                                              aDateTime) {</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineplus">+        onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l17.496"></a><span id="l17.496">             let refreshTreeInternalFunc = function() {</span>
<a href="#l17.497"></a><span id="l17.497">                 aAddItemsInternalFunc(refreshListener.mEventArray);</span>
<a href="#l17.498"></a><span id="l17.498">             };</span>
<a href="#l17.499"></a><span id="l17.499">             setTimeout(refreshTreeInternalFunc, 0);</span>
<a href="#l17.500"></a><span id="l17.500">         },</span>
<a href="#l17.501"></a><span id="l17.501"> </span>
<a href="#l17.502"></a><span id="l17.502" class="difflineminus">-        onGetResult: function rET_onGetResult(aOpCalendar,</span>
<a href="#l17.503"></a><span id="l17.503" class="difflineminus">-                                              aStatus,</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineminus">-                                              aItemType,</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineminus">-                                              aDetail,</span>
<a href="#l17.506"></a><span id="l17.506" class="difflineminus">-                                              aCount,</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineminus">-                                              aItems) {</span>
<a href="#l17.508"></a><span id="l17.508" class="difflineplus">+        onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l17.509"></a><span id="l17.509">             refreshListener.mEventArray = refreshListener.mEventArray.concat(aItems);</span>
<a href="#l17.510"></a><span id="l17.510">         }</span>
<a href="#l17.511"></a><span id="l17.511">     };</span>
<a href="#l17.512"></a><span id="l17.512"> </span>
<a href="#l17.513"></a><span id="l17.513">     let filter = 0;</span>
<a href="#l17.514"></a><span id="l17.514"> </span>
<a href="#l17.515"></a><span id="l17.515">     filter |= aCalendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l17.516"></a><span id="l17.516"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -66,34 +66,33 @@</span>
<a href="#l18.4"></a><span id="l18.4">     &lt;/content&gt;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">     &lt;implementation&gt;</span>
<a href="#l18.7"></a><span id="l18.7">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.8"></a><span id="l18.8">          Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l18.9"></a><span id="l18.9">          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.10"></a><span id="l18.10">          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-         let self = this;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-         this.eventNameTextbox.onblur = function onBlur() {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-             self.stopEditing(true);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+         this.eventNameTextbox.onblur = () =&gt; {</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+             this.stopEditing(true);</span>
<a href="#l18.17"></a><span id="l18.17">          };</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-         this.eventNameTextbox.onkeypress = function onKeyPress(event) {</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+         this.eventNameTextbox.onkeypress = (event) =&gt; {</span>
<a href="#l18.20"></a><span id="l18.20">              // save on enter</span>
<a href="#l18.21"></a><span id="l18.21">              if (event.keyCode == 13) {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-                 self.stopEditing(true);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+                 this.stopEditing(true);</span>
<a href="#l18.24"></a><span id="l18.24">              // abort on escape</span>
<a href="#l18.25"></a><span id="l18.25">              } else if (event.keyCode == 27) {</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-                 self.stopEditing(false);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+                 this.stopEditing(false);</span>
<a href="#l18.28"></a><span id="l18.28">              }</span>
<a href="#l18.29"></a><span id="l18.29">          };</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-         function stopPropagationIfEditing(event) {</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-           if (self.mEditing) {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+         let stopPropagationIfEditing = (event) =&gt; {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+           if (this.mEditing) {</span>
<a href="#l18.34"></a><span id="l18.34">              event.stopPropagation();</span>
<a href="#l18.35"></a><span id="l18.35">            }</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-         }</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+         };</span>
<a href="#l18.38"></a><span id="l18.38">          // while editing, single click positions cursor, so don't propagate.</span>
<a href="#l18.39"></a><span id="l18.39">          this.eventNameTextbox.onclick = stopPropagationIfEditing;</span>
<a href="#l18.40"></a><span id="l18.40">          // while editing, double click selects words, so don't propagate.</span>
<a href="#l18.41"></a><span id="l18.41">          this.eventNameTextbox.ondblclick = stopPropagationIfEditing;</span>
<a href="#l18.42"></a><span id="l18.42">          // while editing, don't propagate mousedown/up (selects calEvent).</span>
<a href="#l18.43"></a><span id="l18.43">          this.eventNameTextbox.onmousedown = stopPropagationIfEditing;</span>
<a href="#l18.44"></a><span id="l18.44">          this.eventNameTextbox.onmouseup = stopPropagationIfEditing;</span>
<a href="#l18.45"></a><span id="l18.45">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineat">@@ -322,21 +321,20 @@</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48">         // If the left button was used and the item is already selected</span>
<a href="#l18.49"></a><span id="l18.49">         // and there are no multiple items selected start</span>
<a href="#l18.50"></a><span id="l18.50">         // the 'single click edit' timeout. Otherwise select the item too.</span>
<a href="#l18.51"></a><span id="l18.51">         // Also, check if the calendar is readOnly or we are offline.</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53">         if (this.selected &amp;&amp; !(event.ctrlKey || event.metaKey) &amp;&amp;</span>
<a href="#l18.54"></a><span id="l18.54">               isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-            let self = this;</span>
<a href="#l18.56"></a><span id="l18.56">             if (this.editingTimer) {</span>
<a href="#l18.57"></a><span id="l18.57">                 clearTimeout(this.editingTimer);</span>
<a href="#l18.58"></a><span id="l18.58">             }</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-            this.editingTimer = setTimeout(function editingTimeout() { self.startEditing(); }, 350);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+            this.editingTimer = setTimeout(() =&gt; this.startEditing(), 350);</span>
<a href="#l18.61"></a><span id="l18.61">         } else {</span>
<a href="#l18.62"></a><span id="l18.62">             this.select(event);</span>
<a href="#l18.63"></a><span id="l18.63">             event.stopPropagation();</span>
<a href="#l18.64"></a><span id="l18.64">         }</span>
<a href="#l18.65"></a><span id="l18.65">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67">       &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.68"></a><span id="l18.68">         event.stopPropagation();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -400,17 +400,17 @@ function updateStyleSheetForViews(aCalen</span>
<a href="#l19.4"></a><span id="l19.4">  * Note we need to keep the categoryPrefBranch variable outside of</span>
<a href="#l19.5"></a><span id="l19.5">  * initCategories since branch observers only live as long as the branch object</span>
<a href="#l19.6"></a><span id="l19.6">  * is alive, and out of categoryManagement to avoid cyclic references.</span>
<a href="#l19.7"></a><span id="l19.7">  */</span>
<a href="#l19.8"></a><span id="l19.8"> var categoryPrefBranch;</span>
<a href="#l19.9"></a><span id="l19.9"> var categoryManagement = {</span>
<a href="#l19.10"></a><span id="l19.10">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIObserver]),</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    initCategories: function cM_initCategories() {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    initCategories: function() {</span>
<a href="#l19.14"></a><span id="l19.14">       categoryPrefBranch = Services.prefs.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l19.15"></a><span id="l19.15">       let categories = categoryPrefBranch.getChildList(&quot;&quot;);</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">       // Fix illegally formatted category prefs.</span>
<a href="#l19.18"></a><span id="l19.18">       for (let i in categories) {</span>
<a href="#l19.19"></a><span id="l19.19">           let category = categories[i];</span>
<a href="#l19.20"></a><span id="l19.20">           if (category.search(/[^_0-9a-z-]/) != -1) {</span>
<a href="#l19.21"></a><span id="l19.21">               let categoryFix = formatStringForCSSRule(category);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -426,33 +426,33 @@ var categoryManagement = {</span>
<a href="#l19.23"></a><span id="l19.23">       }</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">       // Add color information to the stylesheets.</span>
<a href="#l19.26"></a><span id="l19.26">       categories.forEach(categoryManagement.updateStyleSheetForCategory,</span>
<a href="#l19.27"></a><span id="l19.27">                          categoryManagement);</span>
<a href="#l19.28"></a><span id="l19.28">       categoryPrefBranch.addObserver(&quot;&quot;, categoryManagement, false);</span>
<a href="#l19.29"></a><span id="l19.29">     },</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    cleanupCategories: function cM_cleanupCategories() {</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    cleanupCategories: function() {</span>
<a href="#l19.33"></a><span id="l19.33">       categoryPrefBranch = Services.prefs.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l19.34"></a><span id="l19.34">       categoryPrefBranch.removeObserver(&quot;&quot;, categoryManagement);</span>
<a href="#l19.35"></a><span id="l19.35">     },</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-    observe: function cM_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    observe: function(aSubject, aTopic, aPrefName) {</span>
<a href="#l19.39"></a><span id="l19.39">         this.updateStyleSheetForCategory(aPrefName);</span>
<a href="#l19.40"></a><span id="l19.40">         // TODO Currently, the only way to find out if categories are removed is</span>
<a href="#l19.41"></a><span id="l19.41">         // to initially grab the calendar.categories.names preference and then</span>
<a href="#l19.42"></a><span id="l19.42">         // observe changes to it. it would be better if we had hooks for this,</span>
<a href="#l19.43"></a><span id="l19.43">         // so we could delete the rule from our style cache and also remove its</span>
<a href="#l19.44"></a><span id="l19.44">         // color preference.</span>
<a href="#l19.45"></a><span id="l19.45">     },</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47">     categoryStyleCache: {},</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-    updateStyleSheetForCategory: function cM_updateStyleSheetForCategory(aCatName) {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+    updateStyleSheetForCategory: function(aCatName) {</span>
<a href="#l19.51"></a><span id="l19.51">         if (!(aCatName in this.categoryStyleCache)) {</span>
<a href="#l19.52"></a><span id="l19.52">             // We haven't created a rule for this category yet, do so now.</span>
<a href="#l19.53"></a><span id="l19.53">             let sheet = getViewStyleSheet();</span>
<a href="#l19.54"></a><span id="l19.54">             let ruleString = '.category-color-box[categories~=&quot;' + aCatName + '&quot;] {} ';</span>
<a href="#l19.55"></a><span id="l19.55">             let ruleIndex = sheet.insertRule(ruleString, sheet.cssRules.length);</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57">             this.categoryStyleCache[aCatName] = sheet.cssRules[ruleIndex];</span>
<a href="#l19.58"></a><span id="l19.58">         }</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineat">@@ -637,23 +637,20 @@ function editSelectedEvents() {</span>
<a href="#l19.60"></a><span id="l19.60"> </span>
<a href="#l19.61"></a><span id="l19.61"> /**</span>
<a href="#l19.62"></a><span id="l19.62">  * Select all events from all calendars. Use with care.</span>
<a href="#l19.63"></a><span id="l19.63">  */</span>
<a href="#l19.64"></a><span id="l19.64"> function selectAllEvents() {</span>
<a href="#l19.65"></a><span id="l19.65">     let items = [];</span>
<a href="#l19.66"></a><span id="l19.66">     let listener = {</span>
<a href="#l19.67"></a><span id="l19.67">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-        onOperationComplete: function selectAll_ooc(aCalendar, aStatus,</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-                                                    aOperationType, aId,</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-                                                    aDetail) {</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+        onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l19.72"></a><span id="l19.72">             currentView().setSelectedItems(items.length, items, false);</span>
<a href="#l19.73"></a><span id="l19.73">         },</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-        onGetResult: function selectAll_ogr(aCalendar, aStatus, aItemType,</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-                                            aDetail, aCount, aItems) {</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+        onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l19.77"></a><span id="l19.77">             for (let item of aItems) {</span>
<a href="#l19.78"></a><span id="l19.78">                 items.push(item);</span>
<a href="#l19.79"></a><span id="l19.79">             }</span>
<a href="#l19.80"></a><span id="l19.80">         }</span>
<a href="#l19.81"></a><span id="l19.81">     };</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83">     let composite = getCompositeCalendar();</span>
<a href="#l19.84"></a><span id="l19.84">     let filter = composite.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineat">@@ -673,17 +670,17 @@ function selectAllEvents() {</span>
<a href="#l19.86"></a><span id="l19.86">     let end = currentView().endDay.clone();</span>
<a href="#l19.87"></a><span id="l19.87">     end.day += 1;</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89">     composite.getItems(filter, 0, currentView().startDay, end, listener);</span>
<a href="#l19.90"></a><span id="l19.90"> }</span>
<a href="#l19.91"></a><span id="l19.91"> </span>
<a href="#l19.92"></a><span id="l19.92"> var cal = cal || {};</span>
<a href="#l19.93"></a><span id="l19.93"> cal.navigationBar = {</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-    setDateRange: function setDateRange(aStartDate, aEndDate) {</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    setDateRange: function(aStartDate, aEndDate) {</span>
<a href="#l19.96"></a><span id="l19.96">         let docTitle = &quot;&quot;;</span>
<a href="#l19.97"></a><span id="l19.97">         if (aStartDate) {</span>
<a href="#l19.98"></a><span id="l19.98">             let intervalLabel = document.getElementById(&quot;intervalDescription&quot;);</span>
<a href="#l19.99"></a><span id="l19.99">             let firstWeekNo = getWeekInfoService().getWeekTitle(aStartDate);</span>
<a href="#l19.100"></a><span id="l19.100">             let secondWeekNo = firstWeekNo;</span>
<a href="#l19.101"></a><span id="l19.101">             let weekLabel = document.getElementById(&quot;calendarWeek&quot;);</span>
<a href="#l19.102"></a><span id="l19.102">             if (aStartDate.nativeTime == aEndDate.nativeTime) {</span>
<a href="#l19.103"></a><span id="l19.103">                 intervalLabel.value = getDateFormatter().formatDate(aStartDate);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/calendar-views.xml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.xml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -51,20 +51,19 @@</span>
<a href="#l20.4"></a><span id="l20.4">         &lt;/implementation&gt;</span>
<a href="#l20.5"></a><span id="l20.5">     &lt;/binding&gt;</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">     &lt;binding id=&quot;calendar-week-view&quot;</span>
<a href="#l20.8"></a><span id="l20.8">              extends=&quot;chrome://calendar/content/calendar-multiday-view.xml#calendar-multiday-view&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9">         &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l20.10"></a><span id="l20.10">             &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.11"></a><span id="l20.11">                 // add a listener for the mode change</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-                let self = this;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-                this.mModeHandler = function modeHandler(event) {</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+                this.mModeHandler = (event) =&gt; {</span>
<a href="#l20.15"></a><span id="l20.15">                     if (event.attrName == &quot;mode&quot;) {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-                        self.onModeChanged(event);</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+                        this.onModeChanged(event);</span>
<a href="#l20.18"></a><span id="l20.18">                     }</span>
<a href="#l20.19"></a><span id="l20.19">                 };</span>
<a href="#l20.20"></a><span id="l20.20">                 document.getElementById(&quot;modeBroadcaster&quot;).addEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l20.21"></a><span id="l20.21">             ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.22"></a><span id="l20.22">             &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l20.23"></a><span id="l20.23">                 document.getElementById(&quot;modeBroadcaster&quot;).removeEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l20.24"></a><span id="l20.24">             ]]&gt;&lt;/destructor&gt;</span>
<a href="#l20.25"></a><span id="l20.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -94,17 +94,17 @@ var gRelativeDateUpdateTimer;</span>
<a href="#l21.4"></a><span id="l21.4"> function setupWindow() {</span>
<a href="#l21.5"></a><span id="l21.5">     // We want to update when we are at 0 seconds past the minute. To do so, use</span>
<a href="#l21.6"></a><span id="l21.6">     // setTimeout to wait until we are there, then setInterval to execute every</span>
<a href="#l21.7"></a><span id="l21.7">     // minute. Since setInterval is not totally exact, we may run into problems</span>
<a href="#l21.8"></a><span id="l21.8">     // here. I hope not!</span>
<a href="#l21.9"></a><span id="l21.9">     let current = new Date();</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11">     let timeout = (60 - current.getSeconds()) * 1000;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    gRelativeDateUpdateTimer = setTimeout(function wait_until_next_minute() {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    gRelativeDateUpdateTimer = setTimeout(() =&gt; {</span>
<a href="#l21.14"></a><span id="l21.14">         updateRelativeDates();</span>
<a href="#l21.15"></a><span id="l21.15">         gRelativeDateUpdateTimer = setInterval(updateRelativeDates, 60 * 1000);</span>
<a href="#l21.16"></a><span id="l21.16">     }, timeout);</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18">     // Give focus to the alarm richlist after onload completes. See bug 103197</span>
<a href="#l21.19"></a><span id="l21.19">     setTimeout(onFocusWindow, 0);</span>
<a href="#l21.20"></a><span id="l21.20"> }</span>
<a href="#l21.21"></a><span id="l21.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -104,17 +104,17 @@ function onLoad() {</span>
<a href="#l22.4"></a><span id="l22.4">                                   scrollbar.boxObject.height + &quot;px; }&quot;, 0);</span>
<a href="#l22.5"></a><span id="l22.5">             break;</span>
<a href="#l22.6"></a><span id="l22.6">         }</span>
<a href="#l22.7"></a><span id="l22.7">     }</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">     // attach an observer to get notified of changes</span>
<a href="#l22.10"></a><span id="l22.10">     // that are relevant to this dialog.</span>
<a href="#l22.11"></a><span id="l22.11">     let prefObserver = {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-        observe: function aD_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+        observe: function(aSubject, aTopic, aPrefName) {</span>
<a href="#l22.14"></a><span id="l22.14">             switch (aPrefName) {</span>
<a href="#l22.15"></a><span id="l22.15">                 case &quot;calendar.view.daystarthour&quot;:</span>
<a href="#l22.16"></a><span id="l22.16">                 case &quot;calendar.view.dayendhour&quot;:</span>
<a href="#l22.17"></a><span id="l22.17">                     initTimeRange();</span>
<a href="#l22.18"></a><span id="l22.18">                     propagateDateTime();</span>
<a href="#l22.19"></a><span id="l22.19">                     break;</span>
<a href="#l22.20"></a><span id="l22.20">             }</span>
<a href="#l22.21"></a><span id="l22.21">         }</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -989,17 +989,17 @@ function onTimeChange(event) {</span>
<a href="#l22.23"></a><span id="l22.23">  * binding. It has been taken out of the binding to prevent leaks.</span>
<a href="#l22.24"></a><span id="l22.24">  */</span>
<a href="#l22.25"></a><span id="l22.25"> function calFreeBusyListener(aFbElement, aBinding) {</span>
<a href="#l22.26"></a><span id="l22.26">     this.mFbElement = aFbElement;</span>
<a href="#l22.27"></a><span id="l22.27">     this.mBinding = aBinding;</span>
<a href="#l22.28"></a><span id="l22.28"> }</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30"> calFreeBusyListener.prototype = {</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    onResult: function cFBL_onResult(aRequest, aEntries) {</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    onResult: function(aRequest, aEntries) {</span>
<a href="#l22.33"></a><span id="l22.33">         if (aRequest &amp;&amp; !aRequest.isPending) {</span>
<a href="#l22.34"></a><span id="l22.34">             // Find request in list of pending requests and remove from queue:</span>
<a href="#l22.35"></a><span id="l22.35">             this.mBinding.mPendingRequests = this.mBinding.mPendingRequests.filter(aOp =&gt; aRequest.id != aOp.id);</span>
<a href="#l22.36"></a><span id="l22.36">         }</span>
<a href="#l22.37"></a><span id="l22.37">         if (aEntries) {</span>
<a href="#l22.38"></a><span id="l22.38">             this.mFbElement.onFreeBusy(aEntries);</span>
<a href="#l22.39"></a><span id="l22.39">         }</span>
<a href="#l22.40"></a><span id="l22.40">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -66,21 +66,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l23.6"></a><span id="l23.6">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l23.7"></a><span id="l23.7">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.8"></a><span id="l23.8">         Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10">         this.mMaxAttendees = 0;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-        let self = this;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-        let load = function loadHandler() {</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-            self.onLoad();</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-        };</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-        window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+        window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l23.18"></a><span id="l23.18">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l23.21"></a><span id="l23.21">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.22"></a><span id="l23.22">           this.onInitialize();</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">           // this trigger the continous update chain, which</span>
<a href="#l23.25"></a><span id="l23.25">           // effectively calls this.onModify() on predefined</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineat">@@ -703,22 +699,20 @@</span>
<a href="#l23.27"></a><span id="l23.27">       &lt;property name=&quot;documentSize&quot;&gt;</span>
<a href="#l23.28"></a><span id="l23.28">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l23.29"></a><span id="l23.29">             return this.mRowHeight * this.mMaxAttendees;</span>
<a href="#l23.30"></a><span id="l23.30">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l23.31"></a><span id="l23.31">       &lt;/property&gt;</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33">       &lt;method name=&quot;fitDummyRows&quot;&gt;</span>
<a href="#l23.34"></a><span id="l23.34">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-          let self = this;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-          let func = function attendees_list_fitDummyRows() {</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-              self.calcContentHeight();</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-              self.createOrRemoveDummyRows();</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-          };</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-          setTimeout(func, 0);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+          setTimeout(() =&gt; {</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+              this.calcContentHeight();</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+              this.createOrRemoveDummyRows();</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+          }, 0);</span>
<a href="#l23.45"></a><span id="l23.45">         ]]&gt;&lt;/body&gt;</span>
<a href="#l23.46"></a><span id="l23.46">       &lt;/method&gt;</span>
<a href="#l23.47"></a><span id="l23.47"> </span>
<a href="#l23.48"></a><span id="l23.48">       &lt;method name=&quot;calcContentHeight&quot;&gt;</span>
<a href="#l23.49"></a><span id="l23.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.50"></a><span id="l23.50">           let listbox =</span>
<a href="#l23.51"></a><span id="l23.51">               document.getAnonymousElementByAttribute(</span>
<a href="#l23.52"></a><span id="l23.52">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -436,21 +436,17 @@</span>
<a href="#l24.4"></a><span id="l24.4">         // of the timebar starts. The range is the number of days</span>
<a href="#l24.5"></a><span id="l24.5">         // we should be able to show. The start- and enddate</span>
<a href="#l24.6"></a><span id="l24.6">         // is the time the event is scheduled for.</span>
<a href="#l24.7"></a><span id="l24.7">         let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.8"></a><span id="l24.8">         this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.9"></a><span id="l24.9">         this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.10"></a><span id="l24.10">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-        let self = this;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-        let load = function loadHandler() {</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-            self.onLoad();</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-        };</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-        window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+        window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l24.18"></a><span id="l24.18">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l24.21"></a><span id="l24.21">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l24.22"></a><span id="l24.22">           let date = this.mStartDate.clone();</span>
<a href="#l24.23"></a><span id="l24.23">           let template =</span>
<a href="#l24.24"></a><span id="l24.24">               document.getAnonymousElementByAttribute(</span>
<a href="#l24.25"></a><span id="l24.25">                   this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineat">@@ -1081,25 +1077,18 @@</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">         this.initTimeRange();</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32">         this.mMaxFreeBusy = 0;</span>
<a href="#l24.33"></a><span id="l24.33">         this.mPendingRequests = [];</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-        let self = this;</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-        let load = function freebusy_grid_loadHandler() {</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-            self.onLoad();</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-        };</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-        window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-        let unload = function freebusy_grid_unloadHandler() {</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-            self.onUnload();</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-        };</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-        window.addEventListener(&quot;unload&quot;, unload, true);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+        window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+        window.addEventListener(&quot;unload&quot;, this.onUnload.bind(this), true);</span>
<a href="#l24.46"></a><span id="l24.46">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l24.49"></a><span id="l24.49">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l24.50"></a><span id="l24.50">           return this.mStartDate;</span>
<a href="#l24.51"></a><span id="l24.51">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l24.52"></a><span id="l24.52">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l24.53"></a><span id="l24.53">           this.mStartDate = val.clone();</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineat">@@ -1497,22 +1486,20 @@</span>
<a href="#l24.55"></a><span id="l24.55">               }</span>
<a href="#l24.56"></a><span id="l24.56">           }</span>
<a href="#l24.57"></a><span id="l24.57">           return null;</span>
<a href="#l24.58"></a><span id="l24.58">         ]]&gt;&lt;/body&gt;</span>
<a href="#l24.59"></a><span id="l24.59">       &lt;/method&gt;</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61">       &lt;method name=&quot;fitDummyRows&quot;&gt;</span>
<a href="#l24.62"></a><span id="l24.62">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-          let self = this;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-          let func = function func() {</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-              self.calcContentHeight();</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-              self.createOrRemoveDummyRows();</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-          };</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-          setTimeout(func, 0);</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+          setTimeout(() =&gt; {</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+              this.calcContentHeight();</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+              this.createOrRemoveDummyRows();</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+          }, 0);</span>
<a href="#l24.73"></a><span id="l24.73">         ]]&gt;&lt;/body&gt;</span>
<a href="#l24.74"></a><span id="l24.74">       &lt;/method&gt;</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76">       &lt;method name=&quot;calcContentHeight&quot;&gt;</span>
<a href="#l24.77"></a><span id="l24.77">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l24.78"></a><span id="l24.78">           let listbox =</span>
<a href="#l24.79"></a><span id="l24.79">               document.getAnonymousElementByAttribute(</span>
<a href="#l24.80"></a><span id="l24.80">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -32,20 +32,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5">     &lt;implementation&gt;</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7">       &lt;field name=&quot;mRecurrenceInfo&quot;&gt;null&lt;/field&gt;</span>
<a href="#l25.8"></a><span id="l25.8">       &lt;field name=&quot;mResizeHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l25.9"></a><span id="l25.9">       &lt;field name=&quot;mDateTime&quot;&gt;null&lt;/field&gt;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-        let self = this;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-        this.mResizeHandler = function recurrence_preview_resizeHandler() {</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-            self.onResize();</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-        };</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+        this.mResizeHandler = this.onResize.bind(this);</span>
<a href="#l25.17"></a><span id="l25.17">         window.addEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l25.18"></a><span id="l25.18">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l25.21"></a><span id="l25.21">         window.removeEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l25.22"></a><span id="l25.22">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24">       &lt;property name=&quot;dateTime&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -10,38 +10,29 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5"> /**</span>
<a href="#l26.6"></a><span id="l26.6">  * Sets up the invitations dialog from the window arguments, retrieves the</span>
<a href="#l26.7"></a><span id="l26.7">  * invitations from the invitations manager.</span>
<a href="#l26.8"></a><span id="l26.8">  */</span>
<a href="#l26.9"></a><span id="l26.9"> function onLoad() {</span>
<a href="#l26.10"></a><span id="l26.10">     let operationListener = {</span>
<a href="#l26.11"></a><span id="l26.11">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-        onOperationComplete: function oL_onOperationComplete(aCalendar,</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-                                                             aStatus,</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-                                                             aOperationType,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-                                                             aId,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-                                                             aDetail) {</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+        onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l26.18"></a><span id="l26.18">             let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l26.19"></a><span id="l26.19">             updatingBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l26.20"></a><span id="l26.20">             let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l26.21"></a><span id="l26.21">             if (richListBox.getRowCount() &gt; 0) {</span>
<a href="#l26.22"></a><span id="l26.22">                 richListBox.selectedIndex = 0;</span>
<a href="#l26.23"></a><span id="l26.23">             } else {</span>
<a href="#l26.24"></a><span id="l26.24">                 let noInvitationsBox =</span>
<a href="#l26.25"></a><span id="l26.25">                     document.getElementById(&quot;noinvitations-box&quot;);</span>
<a href="#l26.26"></a><span id="l26.26">                 noInvitationsBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l26.27"></a><span id="l26.27">             }</span>
<a href="#l26.28"></a><span id="l26.28">         },</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-        onGetResult: function oL_onGetResult(aCalendar,</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-                                             aStatus,</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-                                             aItemType,</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-                                             aDetail,</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-                                             aCount,</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-                                             aItems) {</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+        onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l26.36"></a><span id="l26.36">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l26.37"></a><span id="l26.37">                 return;</span>
<a href="#l26.38"></a><span id="l26.38">             }</span>
<a href="#l26.39"></a><span id="l26.39">             document.title = invitationsText + &quot; (&quot; + aCount + &quot;)&quot;;</span>
<a href="#l26.40"></a><span id="l26.40">             let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l26.41"></a><span id="l26.41">             updatingBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l26.42"></a><span id="l26.42">             let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l26.43"></a><span id="l26.43">             for (let item of aItems) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -134,22 +134,20 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l27.4"></a><span id="l27.4">         dump(&quot;Error : no case in printDialog.js::printCalendar()&quot;);</span>
<a href="#l27.5"></a><span id="l27.5">     }</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7">     // Some filters above might have filled the events list themselves. If not,</span>
<a href="#l27.8"></a><span id="l27.8">     // then fetch the items here.</span>
<a href="#l27.9"></a><span id="l27.9">     if (requiresFetch) {</span>
<a href="#l27.10"></a><span id="l27.10">         let listener = {</span>
<a href="#l27.11"></a><span id="l27.11">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-            onOperationComplete:</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-            function onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l27.15"></a><span id="l27.15">                 receiverFunc(settings);</span>
<a href="#l27.16"></a><span id="l27.16">             },</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-            onGetResult:</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-            function onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l27.20"></a><span id="l27.20">                 settings.eventList = settings.eventList.concat(aItems);</span>
<a href="#l27.21"></a><span id="l27.21">                 if (!settings.printTasksWithNoDueDate) {</span>
<a href="#l27.22"></a><span id="l27.22">                     eventWithDueDate = [];</span>
<a href="#l27.23"></a><span id="l27.23">                     for (let item of settings.eventList) {</span>
<a href="#l27.24"></a><span id="l27.24">                         if (item.dueDate || item.endDate) {</span>
<a href="#l27.25"></a><span id="l27.25">                             eventWithDueDate.push(item);</span>
<a href="#l27.26"></a><span id="l27.26">                         }</span>
<a href="#l27.27"></a><span id="l27.27">                     }</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineat">@@ -194,17 +192,17 @@ function getFilter(settings) {</span>
<a href="#l27.29"></a><span id="l27.29"> }</span>
<a href="#l27.30"></a><span id="l27.30"> </span>
<a href="#l27.31"></a><span id="l27.31"> /**</span>
<a href="#l27.32"></a><span id="l27.32">  * Looks at the selections the user has made (start date, layout, etc.), and</span>
<a href="#l27.33"></a><span id="l27.33">  * updates the HTML in the iframe accordingly. This is also called when a</span>
<a href="#l27.34"></a><span id="l27.34">  * dialog UI element has changed, since we'll want to refresh the preview.</span>
<a href="#l27.35"></a><span id="l27.35">  */</span>
<a href="#l27.36"></a><span id="l27.36"> function refreshHtml(finishFunc) {</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-    getPrintSettings(function getSettingsResponse(settings) {</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+    getPrintSettings((settings) =&gt; {</span>
<a href="#l27.39"></a><span id="l27.39">             document.title = calGetString(&quot;calendar&quot;, &quot;PrintPreviewWindowTitle&quot;, [settings.title]);</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41">             let printformatter = Components.classes[settings.layoutCId]</span>
<a href="#l27.42"></a><span id="l27.42">                                            .createInstance(Components.interfaces.calIPrintFormatter);</span>
<a href="#l27.43"></a><span id="l27.43">             let html = &quot;&quot;;</span>
<a href="#l27.44"></a><span id="l27.44">             try {</span>
<a href="#l27.45"></a><span id="l27.45">                 let pipe = Components.classes[&quot;@mozilla.org/pipe;1&quot;]</span>
<a href="#l27.46"></a><span id="l27.46">                                      .createInstance(Components.interfaces.nsIPipe);</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineat">@@ -245,61 +243,60 @@ function refreshHtml(finishFunc) {</span>
<a href="#l27.48"></a><span id="l27.48">     );</span>
<a href="#l27.49"></a><span id="l27.49"> }</span>
<a href="#l27.50"></a><span id="l27.50"> </span>
<a href="#l27.51"></a><span id="l27.51"> /**</span>
<a href="#l27.52"></a><span id="l27.52">  * This is a nsIWebProgressListener that closes the dialog on completion, makes</span>
<a href="#l27.53"></a><span id="l27.53">  * sure printing works without issues</span>
<a href="#l27.54"></a><span id="l27.54">  */</span>
<a href="#l27.55"></a><span id="l27.55"> var closeOnComplete = {</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-    onStateChange: function onStateChange(aProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+    onStateChange: function(aProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l27.58"></a><span id="l27.58">         if (aStateFlags &amp; Components.interfaces.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l27.59"></a><span id="l27.59">             // The request is complete, close the window.</span>
<a href="#l27.60"></a><span id="l27.60">             document.documentElement.cancelDialog();</span>
<a href="#l27.61"></a><span id="l27.61">         }</span>
<a href="#l27.62"></a><span id="l27.62">     },</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64">     onProgressChange: function() {},</span>
<a href="#l27.65"></a><span id="l27.65">     onLocationChange: function() {},</span>
<a href="#l27.66"></a><span id="l27.66">     onStatusChange: function() {},</span>
<a href="#l27.67"></a><span id="l27.67">     onSecurityChange: function() {}</span>
<a href="#l27.68"></a><span id="l27.68"> };</span>
<a href="#l27.69"></a><span id="l27.69"> </span>
<a href="#l27.70"></a><span id="l27.70"> /**</span>
<a href="#l27.71"></a><span id="l27.71">  * Prints the document and then closes the window</span>
<a href="#l27.72"></a><span id="l27.72">  */</span>
<a href="#l27.73"></a><span id="l27.73"> function printAndClose() {</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-    refreshHtml(</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-        function finish() {</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-            let webBrowserPrint = PrintUtils.getWebBrowserPrint();</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineminus">-            let printSettings = PrintUtils.getPrintSettings();</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+    refreshHtml(() =&gt; {</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+        let webBrowserPrint = PrintUtils.getWebBrowserPrint();</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+        let printSettings = PrintUtils.getPrintSettings();</span>
<a href="#l27.81"></a><span id="l27.81"> </span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-            // Evicts &quot;about:blank&quot; header</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-            printSettings.docURL = &quot; &quot;;</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+        // Evicts &quot;about:blank&quot; header</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+        printSettings.docURL = &quot; &quot;;</span>
<a href="#l27.86"></a><span id="l27.86"> </span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-            // Start the printing, this is just what PrintUtils does, but we</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-            // apply our own settings.</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineminus">-            try {</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-                webBrowserPrint.print(printSettings, closeOnComplete);</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-                if (gPrintSettingsAreGlobal &amp;&amp; gSavePrintSettings) {</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-                    let PSSVC = Components.classes[&quot;@mozilla.org/gfx/printsettings-service;1&quot;]</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-                                          .getService(Components.interfaces.nsIPrintSettingsService);</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-                    PSSVC.savePrintSettingsToPrefs(printSettings, true,</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineminus">-                                                        printSettings.kInitSaveAll);</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-                    PSSVC.savePrintSettingsToPrefs(printSettings, false,</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-                                                   printSettings.kInitSavePrinterName);</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-                }</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-            } catch (e) {</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-                // Pressing cancel is expressed as an NS_ERROR_ABORT return value,</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-                // causing an exception to be thrown which we catch here.</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-                if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-                    throw e;</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-                }</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+        // Start the printing, this is just what PrintUtils does, but we</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+        // apply our own settings.</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+        try {</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+            webBrowserPrint.print(printSettings, closeOnComplete);</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+            if (gPrintSettingsAreGlobal &amp;&amp; gSavePrintSettings) {</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+                let PSSVC = Components.classes[&quot;@mozilla.org/gfx/printsettings-service;1&quot;]</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+                                      .getService(Components.interfaces.nsIPrintSettingsService);</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+                PSSVC.savePrintSettingsToPrefs(printSettings, true,</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+                                                    printSettings.kInitSaveAll);</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+                PSSVC.savePrintSettingsToPrefs(printSettings, false,</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+                                               printSettings.kInitSavePrinterName);</span>
<a href="#l27.116"></a><span id="l27.116">             }</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-        });</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+        } catch (e) {</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+            // Pressing cancel is expressed as an NS_ERROR_ABORT return value,</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+            // causing an exception to be thrown which we catch here.</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+            if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineplus">+                throw e;</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+            }</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+        }</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+    });</span>
<a href="#l27.126"></a><span id="l27.126">     return false; // leave open</span>
<a href="#l27.127"></a><span id="l27.127"> }</span>
<a href="#l27.128"></a><span id="l27.128"> </span>
<a href="#l27.129"></a><span id="l27.129"> /**</span>
<a href="#l27.130"></a><span id="l27.130">  * Called when once a date has been selected in the datepicker.</span>
<a href="#l27.131"></a><span id="l27.131">  */</span>
<a href="#l27.132"></a><span id="l27.132"> function onDatePick() {</span>
<a href="#l27.133"></a><span id="l27.133">     calRadioGroupSelectItem(&quot;view-field&quot;, &quot;custom-range&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -101,17 +101,17 @@ function onSearch() {</span>
<a href="#l28.4"></a><span id="l28.4">     richListBox.clear();</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6">     let registeredCals = {};</span>
<a href="#l28.7"></a><span id="l28.7">     for (let calendar of getCalendarManager().getCalendars({})) {</span>
<a href="#l28.8"></a><span id="l28.8">         registeredCals[calendar.id] = true;</span>
<a href="#l28.9"></a><span id="l28.9">     }</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">     let opListener = {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-        onResult: function search_onResult(op, result) {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+        onResult: function(op, result) {</span>
<a href="#l28.14"></a><span id="l28.14">             if (result) {</span>
<a href="#l28.15"></a><span id="l28.15">                 for (let calendar of result) {</span>
<a href="#l28.16"></a><span id="l28.16">                     richListBox.addCalendar(calendar, registeredCals[calendar.id]);</span>
<a href="#l28.17"></a><span id="l28.17">                 }</span>
<a href="#l28.18"></a><span id="l28.18">             }</span>
<a href="#l28.19"></a><span id="l28.19">             if (!op.isPending) {</span>
<a href="#l28.20"></a><span id="l28.20">                 let statusDeck = document.getElementById(&quot;status-deck&quot;);</span>
<a href="#l28.21"></a><span id="l28.21">                 if (richListBox.getRowCount() &gt; 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -23,23 +23,20 @@ function onLoad() {</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5">     // the calling entity provides us with an object that is responsible</span>
<a href="#l29.6"></a><span id="l29.6">     // for recording details about the initiated modification. the 'finalize'-property</span>
<a href="#l29.7"></a><span id="l29.7">     // is our hook in order to receive a notification in case the operation needs</span>
<a href="#l29.8"></a><span id="l29.8">     // to be terminated prematurely. this function will be called if the calling</span>
<a href="#l29.9"></a><span id="l29.9">     // entity needs to immediately terminate the pending modification. in this</span>
<a href="#l29.10"></a><span id="l29.10">     // case we serialize the item and close the window.</span>
<a href="#l29.11"></a><span id="l29.11">     if (args.job) {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-        // keep this context...</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-        let self = this;</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-</span>
<a href="#l29.15"></a><span id="l29.15">         // store the 'finalize'-functor in the provided job-object.</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-        args.job.finalize = function finalize() {</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+        args.job.finalize = () =&gt; {</span>
<a href="#l29.18"></a><span id="l29.18">             // store any pending modifications...</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-            self.onAccept();</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+            this.onAccept();</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22">             let calendarItem = window.calendarItem;</span>
<a href="#l29.23"></a><span id="l29.23"> </span>
<a href="#l29.24"></a><span id="l29.24">             // ...and close the window.</span>
<a href="#l29.25"></a><span id="l29.25">             window.close();</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27">             return calendarItem;</span>
<a href="#l29.28"></a><span id="l29.28">         };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -107,17 +107,17 @@ function loadEventsFromFile(aCalendar) {</span>
<a href="#l30.4"></a><span id="l30.4">             return;</span>
<a href="#l30.5"></a><span id="l30.5">         } else if (calendars.length == 1) {</span>
<a href="#l30.6"></a><span id="l30.6">             // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l30.7"></a><span id="l30.7">             // the user wants to import into.</span>
<a href="#l30.8"></a><span id="l30.8">             putItemsIntoCal(calendars[0], items, filePath);</span>
<a href="#l30.9"></a><span id="l30.9">         } else {</span>
<a href="#l30.10"></a><span id="l30.10">             // Ask what calendar to import into</span>
<a href="#l30.11"></a><span id="l30.11">             let args = {};</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-            args.onOk = function putItems(aCal) { putItemsIntoCal(aCal, items, filePath); };</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+            args.onOk = (aCal) =&gt; { putItemsIntoCal(aCal, items, filePath); };</span>
<a href="#l30.14"></a><span id="l30.14">             args.calendars = calendars;</span>
<a href="#l30.15"></a><span id="l30.15">             args.promptText = calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l30.16"></a><span id="l30.16">             openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l30.17"></a><span id="l30.17">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l30.18"></a><span id="l30.18">         }</span>
<a href="#l30.19"></a><span id="l30.19">     }</span>
<a href="#l30.20"></a><span id="l30.20"> }</span>
<a href="#l30.21"></a><span id="l30.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/content/preferences/alarms.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/content/preferences/alarms.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -10,74 +10,74 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l31.4"></a><span id="l31.4"> /**</span>
<a href="#l31.5"></a><span id="l31.5">  * Global Object to hold methods for the alarms pref pane</span>
<a href="#l31.6"></a><span id="l31.6">  */</span>
<a href="#l31.7"></a><span id="l31.7"> var gAlarmsPane = {</span>
<a href="#l31.8"></a><span id="l31.8">     /**</span>
<a href="#l31.9"></a><span id="l31.9">      * Initialize the alarms pref pane. Sets up dialog controls to match the</span>
<a href="#l31.10"></a><span id="l31.10">      * values set in prefs.</span>
<a href="#l31.11"></a><span id="l31.11">      */</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    init: function gAP_init() {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    init: function() {</span>
<a href="#l31.14"></a><span id="l31.14">         // Enable/disable the alarm sound URL box and buttons</span>
<a href="#l31.15"></a><span id="l31.15">         this.alarmsPlaySoundPrefChanged();</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">         // Set the correct singular/plural for the time units</span>
<a href="#l31.18"></a><span id="l31.18">         updateMenuLabelsPlural(&quot;eventdefalarmlen&quot;, &quot;eventdefalarmunit&quot;);</span>
<a href="#l31.19"></a><span id="l31.19">         updateMenuLabelsPlural(&quot;tododefalarmlen&quot;, &quot;tododefalarmunit&quot;);</span>
<a href="#l31.20"></a><span id="l31.20">         updateUnitLabelPlural(&quot;defaultsnoozelength&quot;, &quot;defaultsnoozelengthunit&quot;, &quot;minutes&quot;);</span>
<a href="#l31.21"></a><span id="l31.21">     },</span>
<a href="#l31.22"></a><span id="l31.22"> </span>
<a href="#l31.23"></a><span id="l31.23">     /**</span>
<a href="#l31.24"></a><span id="l31.24">      * Converts the given file url to a nsILocalFile</span>
<a href="#l31.25"></a><span id="l31.25">      *</span>
<a href="#l31.26"></a><span id="l31.26">      * @param aFileURL    A string with a file:// url.</span>
<a href="#l31.27"></a><span id="l31.27">      * @return            The corresponding nsILocalFile.</span>
<a href="#l31.28"></a><span id="l31.28">      */</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-    convertURLToLocalFile: function gAP_convertURLToLocalFile(aFileURL) {</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+    convertURLToLocalFile: function(aFileURL) {</span>
<a href="#l31.31"></a><span id="l31.31">         // Convert the file url into a nsILocalFile</span>
<a href="#l31.32"></a><span id="l31.32">         if (aFileURL) {</span>
<a href="#l31.33"></a><span id="l31.33">             let fph = Services.io</span>
<a href="#l31.34"></a><span id="l31.34">                          .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l31.35"></a><span id="l31.35">                          .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l31.36"></a><span id="l31.36">             return fph.getFileFromURLSpec(aFileURL);</span>
<a href="#l31.37"></a><span id="l31.37">         } else {</span>
<a href="#l31.38"></a><span id="l31.38">             return null;</span>
<a href="#l31.39"></a><span id="l31.39">         }</span>
<a href="#l31.40"></a><span id="l31.40">     },</span>
<a href="#l31.41"></a><span id="l31.41"> </span>
<a href="#l31.42"></a><span id="l31.42">     /**</span>
<a href="#l31.43"></a><span id="l31.43">      * Handler function to be called when the calendar.alarms.soundURL pref has</span>
<a href="#l31.44"></a><span id="l31.44">      * changed. Updates the label in the dialog.</span>
<a href="#l31.45"></a><span id="l31.45">      */</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-    readSoundLocation: function gAP_readSoundLocation() {</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+    readSoundLocation: function() {</span>
<a href="#l31.48"></a><span id="l31.48">         let soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;);</span>
<a href="#l31.49"></a><span id="l31.49">         soundUrl.value = document.getElementById(&quot;calendar.alarms.soundURL&quot;).value;</span>
<a href="#l31.50"></a><span id="l31.50">         if (soundUrl.value.startsWith(&quot;file://&quot;)) {</span>
<a href="#l31.51"></a><span id="l31.51">             soundUrl.label = this.convertURLToLocalFile(soundUrl.value).leafName;</span>
<a href="#l31.52"></a><span id="l31.52">         } else {</span>
<a href="#l31.53"></a><span id="l31.53">             soundUrl.label = soundUrl.value;</span>
<a href="#l31.54"></a><span id="l31.54">         }</span>
<a href="#l31.55"></a><span id="l31.55">         soundUrl.image = &quot;moz-icon://&quot; + soundUrl.label + &quot;?size=16&quot;;</span>
<a href="#l31.56"></a><span id="l31.56">         return undefined;</span>
<a href="#l31.57"></a><span id="l31.57">     },</span>
<a href="#l31.58"></a><span id="l31.58"> </span>
<a href="#l31.59"></a><span id="l31.59">     /**</span>
<a href="#l31.60"></a><span id="l31.60">      * Causes the default sound to be selected in the dialog controls</span>
<a href="#l31.61"></a><span id="l31.61">      */</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-    useDefaultSound: function gAP_useDefaultSound() {</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+    useDefaultSound: function() {</span>
<a href="#l31.64"></a><span id="l31.64">         let defaultSoundUrl = &quot;chrome://calendar/content/sound.wav&quot;;</span>
<a href="#l31.65"></a><span id="l31.65">         document.getElementById(&quot;calendar.alarms.soundURL&quot;).value = defaultSoundUrl;</span>
<a href="#l31.66"></a><span id="l31.66">         document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l31.67"></a><span id="l31.67">         this.readSoundLocation();</span>
<a href="#l31.68"></a><span id="l31.68">     },</span>
<a href="#l31.69"></a><span id="l31.69"> </span>
<a href="#l31.70"></a><span id="l31.70">     /**</span>
<a href="#l31.71"></a><span id="l31.71">      * Opens a filepicker to open a local sound for the alarm.</span>
<a href="#l31.72"></a><span id="l31.72">      */</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-    browseAlarm: function gAP_browseAlarm() {</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+    browseAlarm: function() {</span>
<a href="#l31.75"></a><span id="l31.75">         const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l31.76"></a><span id="l31.76">         let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l31.77"></a><span id="l31.77">                     .createInstance(nsIFilePicker);</span>
<a href="#l31.78"></a><span id="l31.78"> </span>
<a href="#l31.79"></a><span id="l31.79">         let bundlePreferences = document.getElementById(&quot;bundleCalendarPreferences&quot;);</span>
<a href="#l31.80"></a><span id="l31.80">         let title = bundlePreferences.getString(&quot;Open&quot;);</span>
<a href="#l31.81"></a><span id="l31.81">         let wildmat = &quot;*.wav&quot;;</span>
<a href="#l31.82"></a><span id="l31.82">         let label = bundlePreferences.getFormattedString(&quot;filterWav&quot;, [wildmat], 1);</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineat">@@ -93,17 +93,17 @@ var gAlarmsPane = {</span>
<a href="#l31.84"></a><span id="l31.84">             document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l31.85"></a><span id="l31.85">             this.readSoundLocation();</span>
<a href="#l31.86"></a><span id="l31.86">         }</span>
<a href="#l31.87"></a><span id="l31.87">     },</span>
<a href="#l31.88"></a><span id="l31.88"> </span>
<a href="#l31.89"></a><span id="l31.89">     /**</span>
<a href="#l31.90"></a><span id="l31.90">      * Plays the alarm sound currently selected.</span>
<a href="#l31.91"></a><span id="l31.91">      */</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-    previewAlarm: function gAP_previewAlarm() {</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+    previewAlarm: function() {</span>
<a href="#l31.94"></a><span id="l31.94">         let soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;).value;</span>
<a href="#l31.95"></a><span id="l31.95">         let soundIfc = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l31.96"></a><span id="l31.96">                             .createInstance(Components.interfaces.nsISound);</span>
<a href="#l31.97"></a><span id="l31.97">         let url;</span>
<a href="#l31.98"></a><span id="l31.98">         try {</span>
<a href="#l31.99"></a><span id="l31.99">             soundIfc.init();</span>
<a href="#l31.100"></a><span id="l31.100">             if (soundUrl &amp;&amp; soundUrl.length &amp;&amp; soundUrl.length &gt; 0) {</span>
<a href="#l31.101"></a><span id="l31.101">                 url = Services.io.newURI(soundUrl, null, null);</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineat">@@ -116,17 +116,17 @@ var gAlarmsPane = {</span>
<a href="#l31.103"></a><span id="l31.103">         }</span>
<a href="#l31.104"></a><span id="l31.104">     },</span>
<a href="#l31.105"></a><span id="l31.105"> </span>
<a href="#l31.106"></a><span id="l31.106">     /**</span>
<a href="#l31.107"></a><span id="l31.107">      * Handler function to call when the calendar.alarms.playsound preference</span>
<a href="#l31.108"></a><span id="l31.108">      * has been changed. Updates the disabled state of fields that depend on</span>
<a href="#l31.109"></a><span id="l31.109">      * playing a sound.</span>
<a href="#l31.110"></a><span id="l31.110">      */</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-    alarmsPlaySoundPrefChanged: function gAP_alarmsPlaySoundPrefChanged() {</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+    alarmsPlaySoundPrefChanged: function() {</span>
<a href="#l31.113"></a><span id="l31.113">         let alarmsPlaySoundPref =</span>
<a href="#l31.114"></a><span id="l31.114">             document.getElementById(&quot;calendar.alarms.playsound&quot;);</span>
<a href="#l31.115"></a><span id="l31.115"> </span>
<a href="#l31.116"></a><span id="l31.116">         let items = [document.getElementById(&quot;alarmSoundFileField&quot;),</span>
<a href="#l31.117"></a><span id="l31.117">                      document.getElementById(&quot;calendar.prefs.alarm.sound.useDefault&quot;),</span>
<a href="#l31.118"></a><span id="l31.118">                      document.getElementById(&quot;calendar.prefs.alarm.sound.browse&quot;),</span>
<a href="#l31.119"></a><span id="l31.119">                      document.getElementById(&quot;calendar.prefs.alarm.sound.play&quot;)];</span>
<a href="#l31.120"></a><span id="l31.120"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/content/preferences/categories.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/content/preferences/categories.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -15,17 +15,17 @@ var categoryPrefBranch = Services.prefs.</span>
<a href="#l32.4"></a><span id="l32.4">  * Global Object to hold methods for the categories pref pane</span>
<a href="#l32.5"></a><span id="l32.5">  */</span>
<a href="#l32.6"></a><span id="l32.6"> var gCategoriesPane = {</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8">     /**</span>
<a href="#l32.9"></a><span id="l32.9">      * Initialize the categories pref pane. Sets up dialog controls to show the</span>
<a href="#l32.10"></a><span id="l32.10">      * categories saved in preferences.</span>
<a href="#l32.11"></a><span id="l32.11">      */</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    init: function gCP_init() {</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+    init: function() {</span>
<a href="#l32.14"></a><span id="l32.14">         // On non-instant-apply platforms, once this pane has been loaded,</span>
<a href="#l32.15"></a><span id="l32.15">         // attach our &quot;revert all changes&quot; function to the parent prefwindow's</span>
<a href="#l32.16"></a><span id="l32.16">         // &quot;ondialogcancel&quot; event.</span>
<a href="#l32.17"></a><span id="l32.17">         let parentPrefWindow = document.documentElement;</span>
<a href="#l32.18"></a><span id="l32.18">         if (!parentPrefWindow.instantApply) {</span>
<a href="#l32.19"></a><span id="l32.19">             let existingOnDialogCancel = parentPrefWindow.getAttribute(&quot;ondialogcancel&quot;);</span>
<a href="#l32.20"></a><span id="l32.20">             parentPrefWindow.setAttribute(&quot;ondialogcancel&quot;,</span>
<a href="#l32.21"></a><span id="l32.21">                                           &quot;gCategoriesPane.panelOnCancel(); &quot; +</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -58,23 +58,23 @@ var gCategoriesPane = {</span>
<a href="#l32.23"></a><span id="l32.23">         this.updateCategoryList();</span>
<a href="#l32.24"></a><span id="l32.24">     },</span>
<a href="#l32.25"></a><span id="l32.25"> </span>
<a href="#l32.26"></a><span id="l32.26">     /**</span>
<a href="#l32.27"></a><span id="l32.27">      * Updates the listbox containing the categories from the categories saved</span>
<a href="#l32.28"></a><span id="l32.28">      * in preferences.</span>
<a href="#l32.29"></a><span id="l32.29">      */</span>
<a href="#l32.30"></a><span id="l32.30"> </span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-    updatePrefs: function gCP_updatePrefs() {</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+    updatePrefs: function() {</span>
<a href="#l32.33"></a><span id="l32.33">         cal.sortArrayByLocaleCollator(gCategoryList);</span>
<a href="#l32.34"></a><span id="l32.34">         document.getElementById(&quot;calendar.categories.names&quot;).value =</span>
<a href="#l32.35"></a><span id="l32.35">             categoriesArrayToString(gCategoryList);</span>
<a href="#l32.36"></a><span id="l32.36">     },</span>
<a href="#l32.37"></a><span id="l32.37"> </span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-    updateCategoryList: function gCP_updateCategoryList() {</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+    updateCategoryList: function() {</span>
<a href="#l32.40"></a><span id="l32.40">         this.updatePrefs();</span>
<a href="#l32.41"></a><span id="l32.41">         let listbox = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l32.42"></a><span id="l32.42"> </span>
<a href="#l32.43"></a><span id="l32.43">         listbox.clearSelection();</span>
<a href="#l32.44"></a><span id="l32.44">         this.updateButtons();</span>
<a href="#l32.45"></a><span id="l32.45"> </span>
<a href="#l32.46"></a><span id="l32.46"> </span>
<a href="#l32.47"></a><span id="l32.47">         while (listbox.lastChild.id != &quot;categoryColumns&quot;) {</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineat">@@ -101,34 +101,34 @@ var gCategoriesPane = {</span>
<a href="#l32.49"></a><span id="l32.49">             listbox.appendChild(newListItem);</span>
<a href="#l32.50"></a><span id="l32.50">         }</span>
<a href="#l32.51"></a><span id="l32.51">     },</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53">     /**</span>
<a href="#l32.54"></a><span id="l32.54">      * Adds a category, opening the edit category dialog to prompt the user to</span>
<a href="#l32.55"></a><span id="l32.55">      * set up the category.</span>
<a href="#l32.56"></a><span id="l32.56">      */</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-    addCategory: function gCP_addCategory() {</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+    addCategory: function() {</span>
<a href="#l32.59"></a><span id="l32.59">         let listbox = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l32.60"></a><span id="l32.60">         listbox.clearSelection();</span>
<a href="#l32.61"></a><span id="l32.61">         this.updateButtons();</span>
<a href="#l32.62"></a><span id="l32.62">         window.openDialog(&quot;chrome://calendar/content/preferences/editCategory.xul&quot;,</span>
<a href="#l32.63"></a><span id="l32.63">                           &quot;addCategory&quot;,</span>
<a href="#l32.64"></a><span id="l32.64">                           // Workaround for Bug 1151440 - the HTML color picker won't work</span>
<a href="#l32.65"></a><span id="l32.65">                           // in linux when opened from modal dialog</span>
<a href="#l32.66"></a><span id="l32.66">                           AppConstants.platform == &quot;linux&quot;</span>
<a href="#l32.67"></a><span id="l32.67">                               ? &quot;centerscreen,chrome,resizable=no&quot;</span>
<a href="#l32.68"></a><span id="l32.68">                               : &quot;modal,centerscreen,chrome,resizable=no&quot;,</span>
<a href="#l32.69"></a><span id="l32.69">                           &quot;&quot;, null, addTitle);</span>
<a href="#l32.70"></a><span id="l32.70">     },</span>
<a href="#l32.71"></a><span id="l32.71"> </span>
<a href="#l32.72"></a><span id="l32.72">     /**</span>
<a href="#l32.73"></a><span id="l32.73">      * Edits the currently selected category using the edit category dialog.</span>
<a href="#l32.74"></a><span id="l32.74">      */</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-    editCategory: function gCP_editCategory() {</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+    editCategory: function() {</span>
<a href="#l32.77"></a><span id="l32.77">         let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l32.78"></a><span id="l32.78">         let categoryNameFix = formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l32.79"></a><span id="l32.79">         let currentColor = null;</span>
<a href="#l32.80"></a><span id="l32.80">         try {</span>
<a href="#l32.81"></a><span id="l32.81">             currentColor = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l32.82"></a><span id="l32.82">         } catch (ex) {</span>
<a href="#l32.83"></a><span id="l32.83">             // If the pref doesn't exist, don't bail out here.</span>
<a href="#l32.84"></a><span id="l32.84">         }</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineat">@@ -143,17 +143,17 @@ var gCategoriesPane = {</span>
<a href="#l32.86"></a><span id="l32.86">                                   : &quot;modal,centerscreen,chrome,resizable=no&quot;,</span>
<a href="#l32.87"></a><span id="l32.87">                               gCategoryList[list.selectedIndex], currentColor, editTitle);</span>
<a href="#l32.88"></a><span id="l32.88">         }</span>
<a href="#l32.89"></a><span id="l32.89">     },</span>
<a href="#l32.90"></a><span id="l32.90"> </span>
<a href="#l32.91"></a><span id="l32.91">     /**</span>
<a href="#l32.92"></a><span id="l32.92">      * Removes the selected category.</span>
<a href="#l32.93"></a><span id="l32.93">      */</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-    deleteCategory: function gCP_deleteCategory() {</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+    deleteCategory: function() {</span>
<a href="#l32.96"></a><span id="l32.96">         let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l32.97"></a><span id="l32.97">         if (list.selectedCount &lt; 1) {</span>
<a href="#l32.98"></a><span id="l32.98">             return;</span>
<a href="#l32.99"></a><span id="l32.99">         }</span>
<a href="#l32.100"></a><span id="l32.100"> </span>
<a href="#l32.101"></a><span id="l32.101">         let categoryNameFix = formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l32.102"></a><span id="l32.102">         this.backupData(categoryNameFix);</span>
<a href="#l32.103"></a><span id="l32.103">         try {</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineat">@@ -183,17 +183,17 @@ var gCategoriesPane = {</span>
<a href="#l32.105"></a><span id="l32.105">     },</span>
<a href="#l32.106"></a><span id="l32.106"> </span>
<a href="#l32.107"></a><span id="l32.107">     /**</span>
<a href="#l32.108"></a><span id="l32.108">      * Saves the given category to the preferences.</span>
<a href="#l32.109"></a><span id="l32.109">      *</span>
<a href="#l32.110"></a><span id="l32.110">      * @param categoryName      The name of the category.</span>
<a href="#l32.111"></a><span id="l32.111">      * @param categoryColor     The color of the category</span>
<a href="#l32.112"></a><span id="l32.112">      */</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-    saveCategory: function gCP_saveCateogry(categoryName, categoryColor) {</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+    saveCategory: function(categoryName, categoryColor) {</span>
<a href="#l32.115"></a><span id="l32.115">         let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l32.116"></a><span id="l32.116">         // Check to make sure another category doesn't have the same name</span>
<a href="#l32.117"></a><span id="l32.117">         let toBeDeleted = -1;</span>
<a href="#l32.118"></a><span id="l32.118">         for (let i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l32.119"></a><span id="l32.119">             if (i == list.selectedIndex) {</span>
<a href="#l32.120"></a><span id="l32.120">                 continue;</span>
<a href="#l32.121"></a><span id="l32.121">             }</span>
<a href="#l32.122"></a><span id="l32.122"> </span>
<a href="#l32.123"></a><span id="l32.123" class="difflineat">@@ -247,29 +247,29 @@ var gCategoriesPane = {</span>
<a href="#l32.124"></a><span id="l32.124">         let updatedCategory = gCategoryList.indexOf(categoryName);</span>
<a href="#l32.125"></a><span id="l32.125">         list.ensureIndexIsVisible(updatedCategory);</span>
<a href="#l32.126"></a><span id="l32.126">         list.selectedIndex = updatedCategory;</span>
<a href="#l32.127"></a><span id="l32.127">     },</span>
<a href="#l32.128"></a><span id="l32.128"> </span>
<a href="#l32.129"></a><span id="l32.129">     /**</span>
<a href="#l32.130"></a><span id="l32.130">      * Enable the edit and delete category buttons.</span>
<a href="#l32.131"></a><span id="l32.131">      */</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-    updateButtons: function gCP_updateButtons() {</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+    updateButtons: function() {</span>
<a href="#l32.134"></a><span id="l32.134">         let categoriesList = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l32.135"></a><span id="l32.135">         document.getElementById(&quot;deleteCButton&quot;).disabled = (categoriesList.selectedCount &lt;= 0);</span>
<a href="#l32.136"></a><span id="l32.136">         document.getElementById(&quot;editCButton&quot;).disabled = (categoriesList.selectedCount != 1);</span>
<a href="#l32.137"></a><span id="l32.137">     },</span>
<a href="#l32.138"></a><span id="l32.138"> </span>
<a href="#l32.139"></a><span id="l32.139">     /**</span>
<a href="#l32.140"></a><span id="l32.140">      * Backs up the category name in case the dialog is canceled.</span>
<a href="#l32.141"></a><span id="l32.141">      *</span>
<a href="#l32.142"></a><span id="l32.142">      * @see formatStringForCSSRule</span>
<a href="#l32.143"></a><span id="l32.143">      * @param categoryNameFix     The formatted category name.</span>
<a href="#l32.144"></a><span id="l32.144">      */</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineminus">-    backupData: function gCP_backupData(categoryNameFix) {</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+    backupData: function(categoryNameFix) {</span>
<a href="#l32.147"></a><span id="l32.147">         let currentColor;</span>
<a href="#l32.148"></a><span id="l32.148">         try {</span>
<a href="#l32.149"></a><span id="l32.149">             currentColor = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l32.150"></a><span id="l32.150">         } catch (ex) {</span>
<a href="#l32.151"></a><span id="l32.151">             dump(&quot;Exception caught in 'backupData': &quot; + ex + &quot;\n&quot;);</span>
<a href="#l32.152"></a><span id="l32.152">             currentColor = &quot;##NEW&quot;;</span>
<a href="#l32.153"></a><span id="l32.153">         }</span>
<a href="#l32.154"></a><span id="l32.154"> </span>
<a href="#l32.155"></a><span id="l32.155" class="difflineat">@@ -282,27 +282,27 @@ var gCategoriesPane = {</span>
<a href="#l32.156"></a><span id="l32.156">             { name: categoryNameFix, color: currentColor };</span>
<a href="#l32.157"></a><span id="l32.157">     },</span>
<a href="#l32.158"></a><span id="l32.158"> </span>
<a href="#l32.159"></a><span id="l32.159">     /**</span>
<a href="#l32.160"></a><span id="l32.160">      * Event Handler function to be called on doubleclick of the categories</span>
<a href="#l32.161"></a><span id="l32.161">      * list. If the edit function is enabled and the user doubleclicked on a</span>
<a href="#l32.162"></a><span id="l32.162">      * list item, then edit the selected category.</span>
<a href="#l32.163"></a><span id="l32.163">      */</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineminus">-    listOnDblClick: function gCP_listOnDblClick(event) {</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineplus">+    listOnDblClick: function(event) {</span>
<a href="#l32.166"></a><span id="l32.166">         if (event.target.localName == &quot;listitem&quot; &amp;&amp;</span>
<a href="#l32.167"></a><span id="l32.167">             !document.getElementById(&quot;editCButton&quot;).disabled) {</span>
<a href="#l32.168"></a><span id="l32.168">             this.editCategory();</span>
<a href="#l32.169"></a><span id="l32.169">         }</span>
<a href="#l32.170"></a><span id="l32.170">     },</span>
<a href="#l32.171"></a><span id="l32.171"> </span>
<a href="#l32.172"></a><span id="l32.172">     /**</span>
<a href="#l32.173"></a><span id="l32.173">      * Reverts category preferences in case the cancel button is pressed.</span>
<a href="#l32.174"></a><span id="l32.174">      */</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-    panelOnCancel: function gCP_panelOnCancel() {</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+    panelOnCancel: function() {</span>
<a href="#l32.177"></a><span id="l32.177">         for (let i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l32.178"></a><span id="l32.178">             if (parent.backupPrefList[i].color == &quot;##NEW&quot;) {</span>
<a href="#l32.179"></a><span id="l32.179">                 try {</span>
<a href="#l32.180"></a><span id="l32.180">                    categoryPrefBranch.clearUserPref(parent.backupPrefList[i].name);</span>
<a href="#l32.181"></a><span id="l32.181">                 } catch (ex) {</span>
<a href="#l32.182"></a><span id="l32.182">                     dump(&quot;Exception caught in 'panelOnCancel': &quot; + ex + &quot;\n&quot;);</span>
<a href="#l32.183"></a><span id="l32.183">                 }</span>
<a href="#l32.184"></a><span id="l32.184">             } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -9,17 +9,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l33.4"></a><span id="l33.4"> /**</span>
<a href="#l33.5"></a><span id="l33.5">  * Global Object to hold methods for the general pref pane</span>
<a href="#l33.6"></a><span id="l33.6">  */</span>
<a href="#l33.7"></a><span id="l33.7"> var gCalendarGeneralPane = {</span>
<a href="#l33.8"></a><span id="l33.8">     /**</span>
<a href="#l33.9"></a><span id="l33.9">      * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l33.10"></a><span id="l33.10">      * values set in prefs.</span>
<a href="#l33.11"></a><span id="l33.11">      */</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    init: function gCGP_init() {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+    init: function() {</span>
<a href="#l33.14"></a><span id="l33.14">         let df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l33.15"></a><span id="l33.15">                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17">         let dateFormattedLong = df.formatDateLong(now());</span>
<a href="#l33.18"></a><span id="l33.18">         let dateFormattedShort = df.formatDateShort(now());</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20">         // menu items include examples of current date formats.</span>
<a href="#l33.21"></a><span id="l33.21">         document.getElementById(&quot;dateformat-long-menuitem&quot;)</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -59,17 +59,17 @@ var gCalendarGeneralPane = {</span>
<a href="#l33.23"></a><span id="l33.23">             prefValue = calendarDefaultTimezone().tzid;</span>
<a href="#l33.24"></a><span id="l33.24">         }</span>
<a href="#l33.25"></a><span id="l33.25">         tzMenuList.value = prefValue;</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27">         // Set the soondays menulist preference</span>
<a href="#l33.28"></a><span id="l33.28">         this.initializeTodaypaneMenu();</span>
<a href="#l33.29"></a><span id="l33.29">     },</span>
<a href="#l33.30"></a><span id="l33.30"> </span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-    updateDefaultTodoDates: function gCGP_updateDefaultTodoDates() {</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+    updateDefaultTodoDates: function() {</span>
<a href="#l33.33"></a><span id="l33.33">         let defaultDue = document.getElementById(&quot;default_task_due&quot;).value;</span>
<a href="#l33.34"></a><span id="l33.34">         let defaultStart = document.getElementById(&quot;default_task_start&quot;).value;</span>
<a href="#l33.35"></a><span id="l33.35">         let offsetValues = [&quot;offsetcurrent&quot;, &quot;offsetnexthour&quot;];</span>
<a href="#l33.36"></a><span id="l33.36"> </span>
<a href="#l33.37"></a><span id="l33.37">         document.getElementById(&quot;default_task_due_offset&quot;)</span>
<a href="#l33.38"></a><span id="l33.38">                 .style.visibility = offsetValues.includes(defaultDue) ? &quot;&quot; : &quot;hidden&quot;;</span>
<a href="#l33.39"></a><span id="l33.39">         document.getElementById(&quot;default_task_start_offset&quot;)</span>
<a href="#l33.40"></a><span id="l33.40">                 .style.visibility = offsetValues.includes(defaultStart) ? &quot;&quot; : &quot;hidden&quot;;</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineat">@@ -79,17 +79,17 @@ var gCalendarGeneralPane = {</span>
<a href="#l33.42"></a><span id="l33.42">     },</span>
<a href="#l33.43"></a><span id="l33.43"> </span>
<a href="#l33.44"></a><span id="l33.44">     updateItemtypeDeck: function() {</span>
<a href="#l33.45"></a><span id="l33.45">         let panelId = document.getElementById(&quot;defaults-itemtype-menulist&quot;).value;</span>
<a href="#l33.46"></a><span id="l33.46">         let panel = document.getElementById(panelId);</span>
<a href="#l33.47"></a><span id="l33.47">         document.getElementById(&quot;defaults-itemtype-deck&quot;).selectedPanel = panel;</span>
<a href="#l33.48"></a><span id="l33.48">     },</span>
<a href="#l33.49"></a><span id="l33.49"> </span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-    initializeTodaypaneMenu: function gCGP_initializeTodaypaneMenu() {</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+    initializeTodaypaneMenu: function() {</span>
<a href="#l33.52"></a><span id="l33.52">         // Assign the labels for the menuitem</span>
<a href="#l33.53"></a><span id="l33.53">         let soondaysMenu = document.getElementById(&quot;soondays-menulist&quot;);</span>
<a href="#l33.54"></a><span id="l33.54">         let items = soondaysMenu.getElementsByTagName(&quot;menuitem&quot;);</span>
<a href="#l33.55"></a><span id="l33.55">         for (let menuItem of items) {</span>
<a href="#l33.56"></a><span id="l33.56">             let menuitemValue = Number(menuItem.value);</span>
<a href="#l33.57"></a><span id="l33.57">             if (menuitemValue &gt; 7) {</span>
<a href="#l33.58"></a><span id="l33.58">                 menuItem.label = unitPluralForm(menuitemValue / 7, &quot;weeks&quot;);</span>
<a href="#l33.59"></a><span id="l33.59">             } else {</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineat">@@ -110,13 +110,13 @@ var gCalendarGeneralPane = {</span>
<a href="#l33.61"></a><span id="l33.61">         } else {</span>
<a href="#l33.62"></a><span id="l33.62">             soonpref = soonpref &gt; 28 ? 28 : 1;</span>
<a href="#l33.63"></a><span id="l33.63">             Preferences.set(prefName, soonpref, &quot;INT&quot;);</span>
<a href="#l33.64"></a><span id="l33.64">         }</span>
<a href="#l33.65"></a><span id="l33.65"> </span>
<a href="#l33.66"></a><span id="l33.66">         document.getElementById(&quot;soondays-menulist&quot;).value = soonpref;</span>
<a href="#l33.67"></a><span id="l33.67">     },</span>
<a href="#l33.68"></a><span id="l33.68"> </span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-    updateTodaypaneMenu: function gCGP_updateTodaypaneMenu() {</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+    updateTodaypaneMenu: function() {</span>
<a href="#l33.71"></a><span id="l33.71">         let soonpref = Number(document.getElementById(&quot;soondays-menulist&quot;).value);</span>
<a href="#l33.72"></a><span id="l33.72">         Preferences.set(&quot;calendar.agendaListbox.soondays&quot;, soonpref);</span>
<a href="#l33.73"></a><span id="l33.73">     }</span>
<a href="#l33.74"></a><span id="l33.74"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/content/preferences/views.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/content/preferences/views.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -7,28 +7,28 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /**</span>
<a href="#l34.5"></a><span id="l34.5">  * Global Object to hold methods for the views pref pane</span>
<a href="#l34.6"></a><span id="l34.6">  */</span>
<a href="#l34.7"></a><span id="l34.7"> var gViewsPane = {</span>
<a href="#l34.8"></a><span id="l34.8">     /**</span>
<a href="#l34.9"></a><span id="l34.9">      * Initialize the views pref pane. Sets up dialog controls to match the</span>
<a href="#l34.10"></a><span id="l34.10">      * values set in prefs.</span>
<a href="#l34.11"></a><span id="l34.11">      */</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-    init: function gVP_init() {</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+    init: function() {</span>
<a href="#l34.14"></a><span id="l34.14">         this.updateViewEndMenu(document.getElementById(&quot;daystarthour&quot;).value);</span>
<a href="#l34.15"></a><span id="l34.15">         this.updateViewStartMenu(document.getElementById(&quot;dayendhour&quot;).value);</span>
<a href="#l34.16"></a><span id="l34.16">         this.updateViewWorkDayCheckboxes(document.getElementById(&quot;weekstarts&quot;).value);</span>
<a href="#l34.17"></a><span id="l34.17">         this.initializeViewStartEndMenus();</span>
<a href="#l34.18"></a><span id="l34.18">     },</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20">     /**</span>
<a href="#l34.21"></a><span id="l34.21">      * Initialize the strings for the  &quot;day starts at&quot; and &quot;day ends at&quot;</span>
<a href="#l34.22"></a><span id="l34.22">      * menulists. This is needed to respect locales that use AM/PM.</span>
<a href="#l34.23"></a><span id="l34.23">      */</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-    initializeViewStartEndMenus: function gVP_initializeViewStartEndMenus() {</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+    initializeViewStartEndMenus: function() {</span>
<a href="#l34.26"></a><span id="l34.26">         let labelIdStart;</span>
<a href="#l34.27"></a><span id="l34.27">         let labelIdEnd;</span>
<a href="#l34.28"></a><span id="l34.28">         let timeFormatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l34.29"></a><span id="l34.29">                                       .getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l34.30"></a><span id="l34.30">         // 1 to 23 instead of 0 to 24 to keep midnight &amp; noon as the localized strings</span>
<a href="#l34.31"></a><span id="l34.31">         for (let theHour = 1; theHour &lt;= 23; theHour++) {</span>
<a href="#l34.32"></a><span id="l34.32">             let time = timeFormatter.FormatTime(&quot;&quot;, Components.interfaces.nsIScriptableDateFormat</span>
<a href="#l34.33"></a><span id="l34.33">                                     .timeFormatNoSeconds, theHour, 0, 0);</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineat">@@ -48,17 +48,17 @@ var gViewsPane = {</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37">     /**</span>
<a href="#l34.38"></a><span id="l34.38">      * Updates the view end menu to only display hours after the selected view</span>
<a href="#l34.39"></a><span id="l34.39">      * start.</span>
<a href="#l34.40"></a><span id="l34.40">      *</span>
<a href="#l34.41"></a><span id="l34.41">      * @param aStartValue       The value selected for view start.</span>
<a href="#l34.42"></a><span id="l34.42">      */</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-    updateViewEndMenu: function gVP_updateViewEndMenu(aStartValue) {</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+    updateViewEndMenu: function(aStartValue) {</span>
<a href="#l34.45"></a><span id="l34.45">         let endMenuKids = document.getElementById(&quot;dayendhourpopup&quot;)</span>
<a href="#l34.46"></a><span id="l34.46">                                   .childNodes;</span>
<a href="#l34.47"></a><span id="l34.47">         for (let i = 0; i &lt; endMenuKids.length; i++) {</span>
<a href="#l34.48"></a><span id="l34.48">             if (Number(endMenuKids[i].value) &lt;= Number(aStartValue)) {</span>
<a href="#l34.49"></a><span id="l34.49">                 endMenuKids[i].setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l34.50"></a><span id="l34.50">             } else {</span>
<a href="#l34.51"></a><span id="l34.51">                 endMenuKids[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.52"></a><span id="l34.52">             }</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineat">@@ -66,17 +66,17 @@ var gViewsPane = {</span>
<a href="#l34.54"></a><span id="l34.54">     },</span>
<a href="#l34.55"></a><span id="l34.55"> </span>
<a href="#l34.56"></a><span id="l34.56">     /**</span>
<a href="#l34.57"></a><span id="l34.57">      * Updates the view start menu to only display hours before the selected view</span>
<a href="#l34.58"></a><span id="l34.58">      * end.</span>
<a href="#l34.59"></a><span id="l34.59">      *</span>
<a href="#l34.60"></a><span id="l34.60">      * @param aEndValue         The value selected for view end.</span>
<a href="#l34.61"></a><span id="l34.61">      */</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-    updateViewStartMenu: function gVP_updateViewStartMenu(aEndValue) {</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+    updateViewStartMenu: function(aEndValue) {</span>
<a href="#l34.64"></a><span id="l34.64">         let startMenuKids = document.getElementById(&quot;daystarthourpopup&quot;)</span>
<a href="#l34.65"></a><span id="l34.65">                                   .childNodes;</span>
<a href="#l34.66"></a><span id="l34.66">         for (let i = 0; i &lt; startMenuKids.length; i++) {</span>
<a href="#l34.67"></a><span id="l34.67">             if (Number(startMenuKids[i].value) &gt;= Number(aEndValue)) {</span>
<a href="#l34.68"></a><span id="l34.68">                 startMenuKids[i].setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l34.69"></a><span id="l34.69">             } else {</span>
<a href="#l34.70"></a><span id="l34.70">                 startMenuKids[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.71"></a><span id="l34.71">             }</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineat">@@ -84,16 +84,16 @@ var gViewsPane = {</span>
<a href="#l34.73"></a><span id="l34.73">     },</span>
<a href="#l34.74"></a><span id="l34.74"> </span>
<a href="#l34.75"></a><span id="l34.75">     /**</span>
<a href="#l34.76"></a><span id="l34.76">      * Update the workday checkboxes based on the start of the week.</span>
<a href="#l34.77"></a><span id="l34.77">      *</span>
<a href="#l34.78"></a><span id="l34.78">      * @Param weekStart         The (0-based) index of the weekday the week</span>
<a href="#l34.79"></a><span id="l34.79">      *                            should start at.</span>
<a href="#l34.80"></a><span id="l34.80">      */</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-    updateViewWorkDayCheckboxes: function gVP_updateViewWorkDayCheckboxes(weekStart) {</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+    updateViewWorkDayCheckboxes: function(weekStart) {</span>
<a href="#l34.83"></a><span id="l34.83">         weekStart = Number(weekStart);</span>
<a href="#l34.84"></a><span id="l34.84">         for (let i = weekStart; i &lt; weekStart + 7; i++) {</span>
<a href="#l34.85"></a><span id="l34.85">             let checkbox = document.getElementById(&quot;dayoff&quot; + (i % 7));</span>
<a href="#l34.86"></a><span id="l34.86">             checkbox.parentNode.appendChild(checkbox);</span>
<a href="#l34.87"></a><span id="l34.87">         }</span>
<a href="#l34.88"></a><span id="l34.88">     }</span>
<a href="#l34.89"></a><span id="l34.89"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/content/today-pane.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/content/today-pane.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -19,17 +19,17 @@ var TodayPane = {</span>
<a href="#l35.4"></a><span id="l35.4">         startY: 0,</span>
<a href="#l35.5"></a><span id="l35.5">         distance: 0,</span>
<a href="#l35.6"></a><span id="l35.6">         session: false</span>
<a href="#l35.7"></a><span id="l35.7">     },</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9">     /**</span>
<a href="#l35.10"></a><span id="l35.10">      * Load Handler, sets up the today pane controls.</span>
<a href="#l35.11"></a><span id="l35.11">      */</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    onLoad: function onLoad() {</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+    onLoad: function() {</span>
<a href="#l35.14"></a><span id="l35.14">         TodayPane.paneViews = [cal.calGetString(&quot;calendar&quot;, &quot;eventsandtasks&quot;),</span>
<a href="#l35.15"></a><span id="l35.15">                                cal.calGetString(&quot;calendar&quot;, &quot;tasksonly&quot;),</span>
<a href="#l35.16"></a><span id="l35.16">                                cal.calGetString(&quot;calendar&quot;, &quot;eventsonly&quot;)];</span>
<a href="#l35.17"></a><span id="l35.17">         agendaListbox.setupCalendar();</span>
<a href="#l35.18"></a><span id="l35.18">         TodayPane.initializeMiniday();</span>
<a href="#l35.19"></a><span id="l35.19">         TodayPane.setShortWeekdays();</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21">         document.getElementById(&quot;modeBroadcaster&quot;).addEventListener(&quot;DOMAttrModified&quot;, TodayPane.onModeModified, false);</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -38,26 +38,26 @@ var TodayPane = {</span>
<a href="#l35.23"></a><span id="l35.23">         document.getElementById(&quot;today-splitter&quot;).addEventListener(&quot;command&quot;, onCalendarViewResize, false);</span>
<a href="#l35.24"></a><span id="l35.24">         TodayPane.updateSplitterState();</span>
<a href="#l35.25"></a><span id="l35.25">         TodayPane.previousMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l35.26"></a><span id="l35.26">     },</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28">     /**</span>
<a href="#l35.29"></a><span id="l35.29">      * Unload handler, cleans up the today pane on window unload.</span>
<a href="#l35.30"></a><span id="l35.30">      */</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-    onUnload: function onUnload() {</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+    onUnload: function() {</span>
<a href="#l35.33"></a><span id="l35.33">         document.getElementById(&quot;modeBroadcaster&quot;).removeEventListener(&quot;DOMAttrModified&quot;, TodayPane.onModeModified, false);</span>
<a href="#l35.34"></a><span id="l35.34">         document.getElementById(&quot;today-splitter&quot;).removeEventListener(&quot;command&quot;, onCalendarViewResize, false);</span>
<a href="#l35.35"></a><span id="l35.35">     },</span>
<a href="#l35.36"></a><span id="l35.36"> </span>
<a href="#l35.37"></a><span id="l35.37">     /**</span>
<a href="#l35.38"></a><span id="l35.38">      * Sets up the label for the switcher that allows switching between today pane</span>
<a href="#l35.39"></a><span id="l35.39">      * views. (event+task, task only, event only)</span>
<a href="#l35.40"></a><span id="l35.40">      */</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-    setTodayHeader: function setTodayHeader() {</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+    setTodayHeader: function() {</span>
<a href="#l35.43"></a><span id="l35.43">         let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l35.44"></a><span id="l35.44">         let agendaIsVisible = document.getElementById(&quot;agenda-panel&quot;).isVisible(currentMode);</span>
<a href="#l35.45"></a><span id="l35.45">         let todoIsVisible = document.getElementById(&quot;todo-tab-panel&quot;).isVisible(currentMode);</span>
<a href="#l35.46"></a><span id="l35.46">         let index = 2;</span>
<a href="#l35.47"></a><span id="l35.47">         if (agendaIsVisible &amp;&amp; todoIsVisible) {</span>
<a href="#l35.48"></a><span id="l35.48">             index = 0;</span>
<a href="#l35.49"></a><span id="l35.49">         } else if (!agendaIsVisible &amp;&amp; todoIsVisible) {</span>
<a href="#l35.50"></a><span id="l35.50">             index = 1;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineat">@@ -86,17 +86,17 @@ var TodayPane = {</span>
<a href="#l35.52"></a><span id="l35.52">         }</span>
<a href="#l35.53"></a><span id="l35.53"> </span>
<a href="#l35.54"></a><span id="l35.54">         onCalendarViewResize();</span>
<a href="#l35.55"></a><span id="l35.55">     },</span>
<a href="#l35.56"></a><span id="l35.56"> </span>
<a href="#l35.57"></a><span id="l35.57">     /**</span>
<a href="#l35.58"></a><span id="l35.58">      * Sets up the miniday display in the today pane.</span>
<a href="#l35.59"></a><span id="l35.59">      */</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-    initializeMiniday: function initializeMiniday() {</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+    initializeMiniday: function() {</span>
<a href="#l35.62"></a><span id="l35.62">         // initialize the label denoting the current month, year and calendarweek</span>
<a href="#l35.63"></a><span id="l35.63">         // with numbers that are supposed to consume the largest width</span>
<a href="#l35.64"></a><span id="l35.64">         // in order to guarantee that the text will not be cropped when modified</span>
<a href="#l35.65"></a><span id="l35.65">         // during runtime</span>
<a href="#l35.66"></a><span id="l35.66">         const kYEARINIT = &quot;5555&quot;;</span>
<a href="#l35.67"></a><span id="l35.67">         const kCALWEEKINIT = &quot;55&quot;;</span>
<a href="#l35.68"></a><span id="l35.68">         let monthdisplaydeck = document.getElementById(&quot;monthNameContainer&quot;);</span>
<a href="#l35.69"></a><span id="l35.69">         let childNodes = monthdisplaydeck.childNodes;</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineat">@@ -113,17 +113,17 @@ var TodayPane = {</span>
<a href="#l35.71"></a><span id="l35.71"> </span>
<a href="#l35.72"></a><span id="l35.72">         agendaListbox.addListener(this);</span>
<a href="#l35.73"></a><span id="l35.73">         this.setDay(now);</span>
<a href="#l35.74"></a><span id="l35.74">     },</span>
<a href="#l35.75"></a><span id="l35.75"> </span>
<a href="#l35.76"></a><span id="l35.76">     /**</span>
<a href="#l35.77"></a><span id="l35.77">      * Go to month/week/day views when double-clicking a label inside miniday</span>
<a href="#l35.78"></a><span id="l35.78">      */</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineminus">-    onDoubleClick: function md_onDoubleClick(aEvent) {</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+    onDoubleClick: function(aEvent) {</span>
<a href="#l35.81"></a><span id="l35.81">         if (aEvent.button == 0) {</span>
<a href="#l35.82"></a><span id="l35.82">             if (aEvent.target.id == &quot;datevalue-label&quot;) {</span>
<a href="#l35.83"></a><span id="l35.83">                 switchCalendarView(&quot;day&quot;, true);</span>
<a href="#l35.84"></a><span id="l35.84">             } else if (aEvent.target.parentNode.id == &quot;weekdayNameContainer&quot;) {</span>
<a href="#l35.85"></a><span id="l35.85">                 switchCalendarView(&quot;day&quot;, true);</span>
<a href="#l35.86"></a><span id="l35.86">             } else if (aEvent.target.id == &quot;currentWeek-label&quot;) {</span>
<a href="#l35.87"></a><span id="l35.87">                 switchCalendarView(&quot;week&quot;, true);</span>
<a href="#l35.88"></a><span id="l35.88">             } else if (aEvent.target.parentNode.id == &quot;monthNameContainer&quot;) {</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineat">@@ -137,17 +137,17 @@ var TodayPane = {</span>
<a href="#l35.90"></a><span id="l35.90">             currentView().goToDay(agendaListbox.today.start);</span>
<a href="#l35.91"></a><span id="l35.91">         }</span>
<a href="#l35.92"></a><span id="l35.92">     },</span>
<a href="#l35.93"></a><span id="l35.93"> </span>
<a href="#l35.94"></a><span id="l35.94">     /**</span>
<a href="#l35.95"></a><span id="l35.95">      * Set conditions about start dragging on day-label or start switching</span>
<a href="#l35.96"></a><span id="l35.96">      * with time on navigation buttons.</span>
<a href="#l35.97"></a><span id="l35.97">      */</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineminus">-    onMousedown: function md_onMousedown(aEvent, aDir) {</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+    onMousedown: function(aEvent, aDir) {</span>
<a href="#l35.100"></a><span id="l35.100">         if (aEvent.button != 0) {</span>
<a href="#l35.101"></a><span id="l35.101">             return;</span>
<a href="#l35.102"></a><span id="l35.102">         }</span>
<a href="#l35.103"></a><span id="l35.103">         let element = aEvent.target;</span>
<a href="#l35.104"></a><span id="l35.104">         if (element.id == &quot;previous-day-button&quot; ||</span>
<a href="#l35.105"></a><span id="l35.105">              element.id == &quot;next-day-button&quot;) {</span>
<a href="#l35.106"></a><span id="l35.106">             // Start switching days by pressing, without release, the navigation buttons</span>
<a href="#l35.107"></a><span id="l35.107">             element.addEventListener(&quot;mouseout&quot;, TodayPane.stopSwitching, false);</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineat">@@ -163,17 +163,17 @@ var TodayPane = {</span>
<a href="#l35.109"></a><span id="l35.109">     },</span>
<a href="#l35.110"></a><span id="l35.110"> </span>
<a href="#l35.111"></a><span id="l35.111">     /**</span>
<a href="#l35.112"></a><span id="l35.112">      * Figure out the mouse distance from the center of the day's label</span>
<a href="#l35.113"></a><span id="l35.113">      * to the current position.</span>
<a href="#l35.114"></a><span id="l35.114">      *</span>
<a href="#l35.115"></a><span id="l35.115">      * NOTE: This function is usually called without the correct this pointer.</span>
<a href="#l35.116"></a><span id="l35.116">      */</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineminus">-    onMousemove: function md_onMousemove(aEvent) {</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+    onMousemove: function(aEvent) {</span>
<a href="#l35.119"></a><span id="l35.119">         const MIN_DRAG_DISTANCE_SQ = 49;</span>
<a href="#l35.120"></a><span id="l35.120">         let x = aEvent.clientX - TodayPane.minidayDrag.startX;</span>
<a href="#l35.121"></a><span id="l35.121">         let y = aEvent.clientY - TodayPane.minidayDrag.startY;</span>
<a href="#l35.122"></a><span id="l35.122">         if (TodayPane.minidayDrag.session) {</span>
<a href="#l35.123"></a><span id="l35.123">             if (x * x + y * y &gt;= MIN_DRAG_DISTANCE_SQ) {</span>
<a href="#l35.124"></a><span id="l35.124">                 let distance = Math.floor(Math.sqrt(x * x + y * y) - Math.sqrt(MIN_DRAG_DISTANCE_SQ));</span>
<a href="#l35.125"></a><span id="l35.125">                 // Dragging on the left/right side, the day date decrease/increase</span>
<a href="#l35.126"></a><span id="l35.126">                 TodayPane.minidayDrag.distance = (x &gt; 0) ? distance : -distance;</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineat">@@ -195,17 +195,17 @@ var TodayPane = {</span>
<a href="#l35.128"></a><span id="l35.128">             TodayPane.updateAdvanceTimer();</span>
<a href="#l35.129"></a><span id="l35.129">         }</span>
<a href="#l35.130"></a><span id="l35.130">     },</span>
<a href="#l35.131"></a><span id="l35.131"> </span>
<a href="#l35.132"></a><span id="l35.132">     /**</span>
<a href="#l35.133"></a><span id="l35.133">      * Figure out the days switching speed according to the position (when</span>
<a href="#l35.134"></a><span id="l35.134">      * dragging) or time elapsed (when pressing buttons).</span>
<a href="#l35.135"></a><span id="l35.135">      */</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-    updateAdvanceTimer: function md_updateAdvanceTimer(aEvent, aDir) {</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+    updateAdvanceTimer: function(aEvent, aDir) {</span>
<a href="#l35.138"></a><span id="l35.138">         const INITIAL_TIME = 400;</span>
<a href="#l35.139"></a><span id="l35.139">         const REL_DISTANCE = 8;</span>
<a href="#l35.140"></a><span id="l35.140">         const MINIMUM_TIME = 100;</span>
<a href="#l35.141"></a><span id="l35.141">         const ACCELERATE_COUNT_LIMIT = 7;</span>
<a href="#l35.142"></a><span id="l35.142">         const SECOND_STEP_TIME = 200;</span>
<a href="#l35.143"></a><span id="l35.143">         if (TodayPane.minidayDrag.session) {</span>
<a href="#l35.144"></a><span id="l35.144">             // Dragging the day label: days switch with cursor distance and time.</span>
<a href="#l35.145"></a><span id="l35.145">             let dir = (TodayPane.minidayDrag.distance &gt; 0) - (TodayPane.minidayDrag.distance &lt; 0);</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineat">@@ -230,17 +230,17 @@ var TodayPane = {</span>
<a href="#l35.147"></a><span id="l35.147">     },</span>
<a href="#l35.148"></a><span id="l35.148"> </span>
<a href="#l35.149"></a><span id="l35.149">     /**</span>
<a href="#l35.150"></a><span id="l35.150">      * Stop automatic days switching when releasing the mouse button or the</span>
<a href="#l35.151"></a><span id="l35.151">      * position is outside the window.</span>
<a href="#l35.152"></a><span id="l35.152">      *</span>
<a href="#l35.153"></a><span id="l35.153">      * NOTE: This function is usually called without the correct this pointer.</span>
<a href="#l35.154"></a><span id="l35.154">      */</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineminus">-    stopSwitching: function stopSwitching(aEvent) {</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    stopSwitching: function(aEvent) {</span>
<a href="#l35.157"></a><span id="l35.157">         let element = aEvent.target;</span>
<a href="#l35.158"></a><span id="l35.158">         if (TodayPane.minidayDrag.session &amp;&amp;</span>
<a href="#l35.159"></a><span id="l35.159">             aEvent.type == &quot;mouseout&quot; &amp;&amp;</span>
<a href="#l35.160"></a><span id="l35.160">              element.id != &quot;messengerWindow&quot;) {</span>
<a href="#l35.161"></a><span id="l35.161">             return;</span>
<a href="#l35.162"></a><span id="l35.162">         }</span>
<a href="#l35.163"></a><span id="l35.163">         if (TodayPane.minidayTimer) {</span>
<a href="#l35.164"></a><span id="l35.164">             clearTimeout(TodayPane.minidayTimer);</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineat">@@ -270,32 +270,32 @@ var TodayPane = {</span>
<a href="#l35.166"></a><span id="l35.166">      * Helper function to set the month description on the today pane header.</span>
<a href="#l35.167"></a><span id="l35.167">      *</span>
<a href="#l35.168"></a><span id="l35.168">      * @param aMonthLabel       The XUL node to set the month label on.</span>
<a href="#l35.169"></a><span id="l35.169">      * @param aIndex            The month number, 0-based.</span>
<a href="#l35.170"></a><span id="l35.170">      * @param aYear             The year this month should be displayed with</span>
<a href="#l35.171"></a><span id="l35.171">      * @param aCalWeek          The calendar week that should be shown.</span>
<a href="#l35.172"></a><span id="l35.172">      * @return                  The value set on aMonthLabel.</span>
<a href="#l35.173"></a><span id="l35.173">      */</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-    setMonthDescription: function setMonthDescription(aMonthLabel, aIndex, aYear, aCalWeek) {</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+    setMonthDescription: function(aMonthLabel, aIndex, aYear, aCalWeek) {</span>
<a href="#l35.176"></a><span id="l35.176">         if (this.cwlabel == null) {</span>
<a href="#l35.177"></a><span id="l35.177">             this.cwlabel = cal.calGetString(&quot;calendar&quot;, &quot;shortcalendarweek&quot;);</span>
<a href="#l35.178"></a><span id="l35.178">         }</span>
<a href="#l35.179"></a><span id="l35.179">         document.getElementById(&quot;currentWeek-label&quot;).value = this.cwlabel + &quot; &quot; + aCalWeek;</span>
<a href="#l35.180"></a><span id="l35.180">         aMonthLabel.value = cal.getDateFormatter().shortMonthName(aIndex) + &quot; &quot; + aYear;</span>
<a href="#l35.181"></a><span id="l35.181">         return aMonthLabel.value;</span>
<a href="#l35.182"></a><span id="l35.182">     },</span>
<a href="#l35.183"></a><span id="l35.183"> </span>
<a href="#l35.184"></a><span id="l35.184">     /**</span>
<a href="#l35.185"></a><span id="l35.185">      * Cycle the view shown in the today pane (event+task, event, task).</span>
<a href="#l35.186"></a><span id="l35.186">      *</span>
<a href="#l35.187"></a><span id="l35.187">      * @param aCycleForward     If true, the views are cycled in the forward</span>
<a href="#l35.188"></a><span id="l35.188">      *                            direction, otherwise in the opposite direction</span>
<a href="#l35.189"></a><span id="l35.189">      */</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-    cyclePaneView: function cyclePaneView(aCycleForward) {</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+    cyclePaneView: function(aCycleForward) {</span>
<a href="#l35.192"></a><span id="l35.192">         if (this.paneViews == null) {</span>
<a href="#l35.193"></a><span id="l35.193">             return;</span>
<a href="#l35.194"></a><span id="l35.194">         }</span>
<a href="#l35.195"></a><span id="l35.195">         let index = parseInt(document.getElementById(&quot;today-pane-header&quot;).getAttribute(&quot;index&quot;), 10);</span>
<a href="#l35.196"></a><span id="l35.196">         index = index + aCycleForward;</span>
<a href="#l35.197"></a><span id="l35.197">         let nViewLen = this.paneViews.length;</span>
<a href="#l35.198"></a><span id="l35.198">         if (index &gt;= nViewLen) {</span>
<a href="#l35.199"></a><span id="l35.199">             index = 0;</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineat">@@ -310,17 +310,17 @@ var TodayPane = {</span>
<a href="#l35.201"></a><span id="l35.201">         todoPanel.setVisible(isTodoPanelVisible);</span>
<a href="#l35.202"></a><span id="l35.202">         agendaPanel.setVisible(isAgendaPanelVisible);</span>
<a href="#l35.203"></a><span id="l35.203">         this.setTodayHeader();</span>
<a href="#l35.204"></a><span id="l35.204">     },</span>
<a href="#l35.205"></a><span id="l35.205"> </span>
<a href="#l35.206"></a><span id="l35.206">     /**</span>
<a href="#l35.207"></a><span id="l35.207">      * Shows short weekday names in the weekdayNameContainer</span>
<a href="#l35.208"></a><span id="l35.208">      */</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineminus">-    setShortWeekdays: function setShortWeekdays() {</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+    setShortWeekdays: function() {</span>
<a href="#l35.211"></a><span id="l35.211">         let weekdisplaydeck = document.getElementById(&quot;weekdayNameContainer&quot;);</span>
<a href="#l35.212"></a><span id="l35.212">         let childNodes = weekdisplaydeck.childNodes;</span>
<a href="#l35.213"></a><span id="l35.213"> </span>
<a href="#l35.214"></a><span id="l35.214">         // Workaround for bug 1070491. Show the correct weekday after</span>
<a href="#l35.215"></a><span id="l35.215">         // startup even if deck's selectedIndex is reset to 0.</span>
<a href="#l35.216"></a><span id="l35.216">         let weekday = cal.now().weekday + 1;</span>
<a href="#l35.217"></a><span id="l35.217">         childNodes[0].setAttribute(&quot;value&quot;, cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + weekday + &quot;.Mmm&quot;));</span>
<a href="#l35.218"></a><span id="l35.218"> </span>
<a href="#l35.219"></a><span id="l35.219" class="difflineat">@@ -329,30 +329,30 @@ var TodayPane = {</span>
<a href="#l35.220"></a><span id="l35.220">         }</span>
<a href="#l35.221"></a><span id="l35.221">     },</span>
<a href="#l35.222"></a><span id="l35.222"> </span>
<a href="#l35.223"></a><span id="l35.223">     /**</span>
<a href="#l35.224"></a><span id="l35.224">      * Sets the shown date from a JSDate.</span>
<a href="#l35.225"></a><span id="l35.225">      *</span>
<a href="#l35.226"></a><span id="l35.226">      * @param aNewDate      The date to show.</span>
<a href="#l35.227"></a><span id="l35.227">      */</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineminus">-    setDaywithjsDate: function setDaywithjsDate(aNewDate) {</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+    setDaywithjsDate: function(aNewDate) {</span>
<a href="#l35.230"></a><span id="l35.230">         let newdatetime = cal.jsDateToDateTime(aNewDate, cal.floating());</span>
<a href="#l35.231"></a><span id="l35.231">         newdatetime = newdatetime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l35.232"></a><span id="l35.232">         this.setDay(newdatetime, true);</span>
<a href="#l35.233"></a><span id="l35.233">     },</span>
<a href="#l35.234"></a><span id="l35.234"> </span>
<a href="#l35.235"></a><span id="l35.235">     /**</span>
<a href="#l35.236"></a><span id="l35.236">      * Sets the first day shown in the today pane.</span>
<a href="#l35.237"></a><span id="l35.237">      *</span>
<a href="#l35.238"></a><span id="l35.238">      * @param aNewDate                  The calIDateTime to set.</span>
<a href="#l35.239"></a><span id="l35.239">      * @param aDontUpdateMinimonth      If true, the minimonth will not be</span>
<a href="#l35.240"></a><span id="l35.240">      *                                    updated to show the same date.</span>
<a href="#l35.241"></a><span id="l35.241">      */</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineminus">-    setDay: function setDay(aNewDate, aDontUpdateMinimonth) {</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+    setDay: function(aNewDate, aDontUpdateMinimonth) {</span>
<a href="#l35.244"></a><span id="l35.244">         this.start = aNewDate.clone();</span>
<a href="#l35.245"></a><span id="l35.245"> </span>
<a href="#l35.246"></a><span id="l35.246">         let daylabel = document.getElementById(&quot;datevalue-label&quot;);</span>
<a href="#l35.247"></a><span id="l35.247">         daylabel.value = this.start.day;</span>
<a href="#l35.248"></a><span id="l35.248"> </span>
<a href="#l35.249"></a><span id="l35.249">         let weekdaylabel = document.getElementById(&quot;weekdayNameContainer&quot;);</span>
<a href="#l35.250"></a><span id="l35.250">         weekdaylabel.selectedIndex = this.start.weekday + 1;</span>
<a href="#l35.251"></a><span id="l35.251"> </span>
<a href="#l35.252"></a><span id="l35.252" class="difflineat">@@ -371,58 +371,58 @@ var TodayPane = {</span>
<a href="#l35.253"></a><span id="l35.253">     },</span>
<a href="#l35.254"></a><span id="l35.254"> </span>
<a href="#l35.255"></a><span id="l35.255">     /**</span>
<a href="#l35.256"></a><span id="l35.256">      * Advance by a given number of days in the today pane.</span>
<a href="#l35.257"></a><span id="l35.257">      *</span>
<a href="#l35.258"></a><span id="l35.258">      * @param aDir      The number of days to advance. Negative numbers advance</span>
<a href="#l35.259"></a><span id="l35.259">      *                    backwards in time.</span>
<a href="#l35.260"></a><span id="l35.260">      */</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineminus">-    advance: function advance(aDir) {</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+    advance: function(aDir) {</span>
<a href="#l35.263"></a><span id="l35.263">         if (aDir != 0) {</span>
<a href="#l35.264"></a><span id="l35.264">             this.start.day += aDir;</span>
<a href="#l35.265"></a><span id="l35.265">             this.setDay(this.start);</span>
<a href="#l35.266"></a><span id="l35.266">         }</span>
<a href="#l35.267"></a><span id="l35.267">     },</span>
<a href="#l35.268"></a><span id="l35.268"> </span>
<a href="#l35.269"></a><span id="l35.269">     /**</span>
<a href="#l35.270"></a><span id="l35.270">      * Checks if the today pane is showing today's date.</span>
<a href="#l35.271"></a><span id="l35.271">      */</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineminus">-    showsToday: function showsToday() {</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+    showsToday: function() {</span>
<a href="#l35.274"></a><span id="l35.274">         return cal.sameDay(cal.now(), this.start);</span>
<a href="#l35.275"></a><span id="l35.275">     },</span>
<a href="#l35.276"></a><span id="l35.276"> </span>
<a href="#l35.277"></a><span id="l35.277">     /**</span>
<a href="#l35.278"></a><span id="l35.278">      * Update the period headers in the agenda listbox using the today pane's</span>
<a href="#l35.279"></a><span id="l35.279">      * start date.</span>
<a href="#l35.280"></a><span id="l35.280">      */</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineminus">-    updatePeriod: function updatePeriod() {</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+    updatePeriod: function() {</span>
<a href="#l35.283"></a><span id="l35.283">         agendaListbox.refreshPeriodDates(this.start.clone());</span>
<a href="#l35.284"></a><span id="l35.284">         updateCalendarToDoUnifinder();</span>
<a href="#l35.285"></a><span id="l35.285">     },</span>
<a href="#l35.286"></a><span id="l35.286"> </span>
<a href="#l35.287"></a><span id="l35.287">     /**</span>
<a href="#l35.288"></a><span id="l35.288">      * Display a certain section in the minday/minimonth part of the todaypane.</span>
<a href="#l35.289"></a><span id="l35.289">      *</span>
<a href="#l35.290"></a><span id="l35.290">      * @param aSection      The section to display</span>
<a href="#l35.291"></a><span id="l35.291">      */</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineminus">-    displayMiniSection: function displayMiniSection(aSection) {</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+    displayMiniSection: function(aSection) {</span>
<a href="#l35.294"></a><span id="l35.294">         document.getElementById(&quot;today-minimonth-box&quot;).setVisible(aSection == &quot;minimonth&quot;);</span>
<a href="#l35.295"></a><span id="l35.295">         document.getElementById(&quot;mini-day-box&quot;).setVisible(aSection == &quot;miniday&quot;);</span>
<a href="#l35.296"></a><span id="l35.296">         document.getElementById(&quot;today-none-box&quot;).setVisible(aSection == &quot;none&quot;);</span>
<a href="#l35.297"></a><span id="l35.297">         setBooleanAttribute(document.getElementById(&quot;today-Minimonth&quot;), &quot;freebusy&quot;, aSection == &quot;minimonth&quot;);</span>
<a href="#l35.298"></a><span id="l35.298">     },</span>
<a href="#l35.299"></a><span id="l35.299"> </span>
<a href="#l35.300"></a><span id="l35.300">     /**</span>
<a href="#l35.301"></a><span id="l35.301">      * Handler function for the DOMAttrModified event used to observe the</span>
<a href="#l35.302"></a><span id="l35.302">      * todaypane-splitter.</span>
<a href="#l35.303"></a><span id="l35.303">      *</span>
<a href="#l35.304"></a><span id="l35.304">      * @param aEvent        The DOM event occurring on attribute modification.</span>
<a href="#l35.305"></a><span id="l35.305">      */</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineminus">-    onModeModified: function onModeModified(aEvent) {</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+    onModeModified: function(aEvent) {</span>
<a href="#l35.308"></a><span id="l35.308">         if (aEvent.attrName == &quot;mode&quot;) {</span>
<a href="#l35.309"></a><span id="l35.309">             let todaypane = document.getElementById(&quot;today-pane-panel&quot;);</span>
<a href="#l35.310"></a><span id="l35.310">             // Store the previous mode panel's width.</span>
<a href="#l35.311"></a><span id="l35.311">             todaypane.setModeAttribute(&quot;modewidths&quot;, todaypane.width, TodayPane.previousMode);</span>
<a href="#l35.312"></a><span id="l35.312"> </span>
<a href="#l35.313"></a><span id="l35.313">             TodayPane.setTodayHeader();</span>
<a href="#l35.314"></a><span id="l35.314">             TodayPane.updateSplitterState();</span>
<a href="#l35.315"></a><span id="l35.315">             todaypane.width = todaypane.getModeAttribute(&quot;modewidths&quot;, &quot;width&quot;);</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineat">@@ -430,40 +430,40 @@ var TodayPane = {</span>
<a href="#l35.317"></a><span id="l35.317">         }</span>
<a href="#l35.318"></a><span id="l35.318">     },</span>
<a href="#l35.319"></a><span id="l35.319"> </span>
<a href="#l35.320"></a><span id="l35.320">     /**</span>
<a href="#l35.321"></a><span id="l35.321">      * Toggle the today-pane and update its visual appearance.</span>
<a href="#l35.322"></a><span id="l35.322">      *</span>
<a href="#l35.323"></a><span id="l35.323">      * @param aEvent        The DOM event occurring on activated command.</span>
<a href="#l35.324"></a><span id="l35.324">      */</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineminus">-    toggleVisibility: function toggleVisbility(aEvent) {</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineplus">+    toggleVisibility: function(aEvent) {</span>
<a href="#l35.327"></a><span id="l35.327">         document.getElementById(&quot;today-pane-panel&quot;).togglePane(aEvent);</span>
<a href="#l35.328"></a><span id="l35.328">         TodayPane.setTodayHeader();</span>
<a href="#l35.329"></a><span id="l35.329">         TodayPane.updateSplitterState();</span>
<a href="#l35.330"></a><span id="l35.330">     },</span>
<a href="#l35.331"></a><span id="l35.331"> </span>
<a href="#l35.332"></a><span id="l35.332">     /**</span>
<a href="#l35.333"></a><span id="l35.333">      * Update the today-splitter state and today-pane width with saved</span>
<a href="#l35.334"></a><span id="l35.334">      * mode-dependent values.</span>
<a href="#l35.335"></a><span id="l35.335">      */</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineminus">-    updateSplitterState: function updateSplitterState() {</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineplus">+    updateSplitterState: function() {</span>
<a href="#l35.338"></a><span id="l35.338">         let splitter = document.getElementById(&quot;today-splitter&quot;);</span>
<a href="#l35.339"></a><span id="l35.339">         let todaypaneVisible = document.getElementById(&quot;today-pane-panel&quot;).isVisible();</span>
<a href="#l35.340"></a><span id="l35.340">         setElementValue(splitter, !todaypaneVisible &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l35.341"></a><span id="l35.341">         if (todaypaneVisible) {</span>
<a href="#l35.342"></a><span id="l35.342">             splitter.setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l35.343"></a><span id="l35.343">         }</span>
<a href="#l35.344"></a><span id="l35.344">     },</span>
<a href="#l35.345"></a><span id="l35.345"> </span>
<a href="#l35.346"></a><span id="l35.346">     /**</span>
<a href="#l35.347"></a><span id="l35.347">      * Generates the todaypane toggle command when the today-splitter</span>
<a href="#l35.348"></a><span id="l35.348">      * is being collapsed or uncollapsed.</span>
<a href="#l35.349"></a><span id="l35.349">      */</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineminus">-    onCommandTodaySplitter: function onCommandTodaySplitter() {</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineplus">+    onCommandTodaySplitter: function() {</span>
<a href="#l35.352"></a><span id="l35.352">         let todaypane = document.getElementById(&quot;today-pane-panel&quot;);</span>
<a href="#l35.353"></a><span id="l35.353">         let splitterState = document.getElementById(&quot;today-splitter&quot;).getAttribute(&quot;state&quot;);</span>
<a href="#l35.354"></a><span id="l35.354">         if (splitterState == &quot;collapsed&quot; &amp;&amp; todaypane.isVisible() ||</span>
<a href="#l35.355"></a><span id="l35.355">             splitterState != &quot;collapsed&quot; &amp;&amp; !todaypane.isVisible()) {</span>
<a href="#l35.356"></a><span id="l35.356">               document.getElementById(&quot;calendar_toggle_todaypane_command&quot;).doCommand();</span>
<a href="#l35.357"></a><span id="l35.357">         }</span>
<a href="#l35.358"></a><span id="l35.358">     }</span>
<a href="#l35.359"></a><span id="l35.359"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -65,91 +65,87 @@</span>
<a href="#l36.4"></a><span id="l36.4">       &lt;/property&gt;</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6">       &lt;field name=&quot;calMgrObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l36.7"></a><span id="l36.7">       ({</span>
<a href="#l36.8"></a><span id="l36.8">         listTree: this,</span>
<a href="#l36.9"></a><span id="l36.9">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarManagerObserver]),</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">         // calICalendarManagerObserver</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-        onCalendarRegistered: function cMO_onCalendarRegistered(aCalendar) {</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+        onCalendarRegistered: function(aCalendar) {</span>
<a href="#l36.14"></a><span id="l36.14">             this.listTree.addCalendar(aCalendar);</span>
<a href="#l36.15"></a><span id="l36.15">             let composite = this.listTree.compositeCalendar;</span>
<a href="#l36.16"></a><span id="l36.16">             let inComposite = aCalendar.getProperty(composite.prefPrefix +</span>
<a href="#l36.17"></a><span id="l36.17">                                                     &quot;-in-composite&quot;);</span>
<a href="#l36.18"></a><span id="l36.18">             if ((inComposite === null) || inComposite) {</span>
<a href="#l36.19"></a><span id="l36.19">                 composite.addCalendar(aCalendar);</span>
<a href="#l36.20"></a><span id="l36.20">             }</span>
<a href="#l36.21"></a><span id="l36.21">         },</span>
<a href="#l36.22"></a><span id="l36.22"> </span>
<a href="#l36.23"></a><span id="l36.23" class="difflineminus">-        onCalendarUnregistering: function cMO_onCalendarUnregistering(aCalendar) {</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+        onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l36.25"></a><span id="l36.25">             this.listTree.removeCalendar(aCalendar);</span>
<a href="#l36.26"></a><span id="l36.26">         },</span>
<a href="#l36.27"></a><span id="l36.27"> </span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-        onCalendarDeleting: function cMO_onCalendarDeleting(aCalendar) {</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+        onCalendarDeleting: function(aCalendar) {</span>
<a href="#l36.30"></a><span id="l36.30">             // Now that the calendar is unregistered, update the commands to</span>
<a href="#l36.31"></a><span id="l36.31">             // make sure that New Event/Task commands are correctly</span>
<a href="#l36.32"></a><span id="l36.32">             // enabled/disabled.</span>
<a href="#l36.33"></a><span id="l36.33">             document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l36.34"></a><span id="l36.34">         }</span>
<a href="#l36.35"></a><span id="l36.35">       })</span>
<a href="#l36.36"></a><span id="l36.36">       ]]&gt;&lt;/field&gt;</span>
<a href="#l36.37"></a><span id="l36.37">       &lt;field name=&quot;compositeObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l36.38"></a><span id="l36.38">       ({</span>
<a href="#l36.39"></a><span id="l36.39">         listTree: this,</span>
<a href="#l36.40"></a><span id="l36.40">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICompositeObserver,</span>
<a href="#l36.41"></a><span id="l36.41">                                                Components.interfaces.calIObserver]),</span>
<a href="#l36.42"></a><span id="l36.42"> </span>
<a href="#l36.43"></a><span id="l36.43">         // calICompositeObserver</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-        onCalendarAdded: function onCalendarAdded(aCalendar) {</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+        onCalendarAdded: function(aCalendar) {</span>
<a href="#l36.46"></a><span id="l36.46">             // Make sure the checkbox state is updated</span>
<a href="#l36.47"></a><span id="l36.47">             this.listTree.updateCalendar(aCalendar);</span>
<a href="#l36.48"></a><span id="l36.48">         },</span>
<a href="#l36.49"></a><span id="l36.49"> </span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-        onCalendarRemoved: function onCalendarRemoved(aCalendar) {</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+        onCalendarRemoved: function(aCalendar) {</span>
<a href="#l36.52"></a><span id="l36.52">             // Make sure the checkbox state is updated</span>
<a href="#l36.53"></a><span id="l36.53">             this.listTree.updateCalendar(aCalendar);</span>
<a href="#l36.54"></a><span id="l36.54">         },</span>
<a href="#l36.55"></a><span id="l36.55"> </span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-        onDefaultCalendarChanged: function cMO_onDefaultCalendarChanged(aCalendar) {</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+        onDefaultCalendarChanged: function(aCalendar) {</span>
<a href="#l36.58"></a><span id="l36.58">         },</span>
<a href="#l36.59"></a><span id="l36.59"> </span>
<a href="#l36.60"></a><span id="l36.60">         // calIObserver</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-        onStartBatch: function cO_onStartBatch() { },</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-        onEndBatch: function cO_onEndBatch() { },</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-        onLoad: function cO_onLoad() { },</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+        onStartBatch: function() { },</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+        onEndBatch: function() { },</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+        onLoad: function() { },</span>
<a href="#l36.67"></a><span id="l36.67"> </span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-        onAddItem: function cO_onAddItem(aItem) {</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+        onAddItem: function(aItem) {</span>
<a href="#l36.70"></a><span id="l36.70">             if (aItem.calendar.type != &quot;caldav&quot;) {</span>
<a href="#l36.71"></a><span id="l36.71">                 this.listTree.ensureCalendarVisible(aItem.calendar);</span>
<a href="#l36.72"></a><span id="l36.72">             }</span>
<a href="#l36.73"></a><span id="l36.73">         },</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-        onModifyItem: function cO_onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+        onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l36.76"></a><span id="l36.76">             if (aNewItem.calendar.type != &quot;caldav&quot;) {</span>
<a href="#l36.77"></a><span id="l36.77">                 this.listTree.ensureCalendarVisible(aNewItem.calendar);</span>
<a href="#l36.78"></a><span id="l36.78">             }</span>
<a href="#l36.79"></a><span id="l36.79">         },</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-        onDeleteItem: function cO_onDeleteItem(aDeletedItem) { },</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-        onError: function cO_onError(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+        onDeleteItem: function(aDeletedItem) { },</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+        onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l36.84"></a><span id="l36.84"> </span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-        onPropertyChanged: function cO_onPropertyChanged(aCalendar,</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-                                                         aName,</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-                                                         aValue,</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-                                                         aOldValue) {</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+        onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l36.90"></a><span id="l36.90">             switch (aName) {</span>
<a href="#l36.91"></a><span id="l36.91">                 case &quot;disabled&quot;:</span>
<a href="#l36.92"></a><span id="l36.92">                 case &quot;readOnly&quot;:</span>
<a href="#l36.93"></a><span id="l36.93">                     calendarUpdateNewItemsCommand();</span>
<a href="#l36.94"></a><span id="l36.94">                     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l36.95"></a><span id="l36.95">                     break;</span>
<a href="#l36.96"></a><span id="l36.96">             }</span>
<a href="#l36.97"></a><span id="l36.97">         },</span>
<a href="#l36.98"></a><span id="l36.98"> </span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-        onPropertyDeleting: function cO_onPropertyDeleting(aCalendar,</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-                                                            aName) {</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+        onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l36.102"></a><span id="l36.102">         }</span>
<a href="#l36.103"></a><span id="l36.103">       })</span>
<a href="#l36.104"></a><span id="l36.104">       ]]&gt;&lt;/field&gt;</span>
<a href="#l36.105"></a><span id="l36.105">     &lt;/implementation&gt;</span>
<a href="#l36.106"></a><span id="l36.106">     &lt;handlers&gt;</span>
<a href="#l36.107"></a><span id="l36.107">       &lt;handler event=&quot;dblclick&quot;&gt;&lt;![CDATA[</span>
<a href="#l36.108"></a><span id="l36.108">         let col = {};</span>
<a href="#l36.109"></a><span id="l36.109">         let calendar = this.getCalendarFromEvent(event, col);</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineat">@@ -253,29 +249,26 @@</span>
<a href="#l36.111"></a><span id="l36.111">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113">       &lt;field name=&quot;calObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l36.114"></a><span id="l36.114">       ({</span>
<a href="#l36.115"></a><span id="l36.115">         listTree: this,</span>
<a href="#l36.116"></a><span id="l36.116">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l36.117"></a><span id="l36.117"> </span>
<a href="#l36.118"></a><span id="l36.118">         // calIObserver. Note that each registered calendar uses this observer</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineminus">-        onStartBatch: function cMO_onStartBatch() { },</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineminus">-        onEndBatch: function cMO_onEndBatch() { },</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineminus">-        onLoad: function cMO_onLoad() { },</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+        onStartBatch: function() { },</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+        onEndBatch: function() { },</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+        onLoad: function() { },</span>
<a href="#l36.125"></a><span id="l36.125"> </span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-        onAddItem: function cMO_onAddItem(aItem) { },</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineminus">-        onModifyItem: function cMO_onModifyItem(aNewItem, aOldItem) { },</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineminus">-        onDeleteItem: function cMO_onDeleteItem(aDeletedItem) { },</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineminus">-        onError: function cMO_onError(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+        onAddItem: function(aItem) { },</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+        onModifyItem: function(aNewItem, aOldItem) { },</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+        onDeleteItem: function(aDeletedItem) { },</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+        onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l36.134"></a><span id="l36.134"> </span>
<a href="#l36.135"></a><span id="l36.135" class="difflineminus">-        onPropertyChanged: function cMO_onPropertyChanged(aCalendar,</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineminus">-                                                          aName,</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-                                                          aValue,</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineminus">-                                                          aOldValue) {</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+        onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l36.140"></a><span id="l36.140">             switch (aName) {</span>
<a href="#l36.141"></a><span id="l36.141">                 case &quot;color&quot;:</span>
<a href="#l36.142"></a><span id="l36.142">                     // TODO See other TODO in this file about updateStyleSheetForViews</span>
<a href="#l36.143"></a><span id="l36.143">                     if (&quot;updateStyleSheetForViews&quot; in window) {</span>
<a href="#l36.144"></a><span id="l36.144">                         updateStyleSheetForViews(aCalendar);</span>
<a href="#l36.145"></a><span id="l36.145">                     }</span>
<a href="#l36.146"></a><span id="l36.146">                     this.listTree.updateCalendarColor(aCalendar);</span>
<a href="#l36.147"></a><span id="l36.147">                     // Fall through, update item in any case</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineat">@@ -283,43 +276,42 @@</span>
<a href="#l36.149"></a><span id="l36.149">                 case &quot;currentStatus&quot;:</span>
<a href="#l36.150"></a><span id="l36.150">                 case &quot;readOnly&quot;:</span>
<a href="#l36.151"></a><span id="l36.151">                 case &quot;disabled&quot;:</span>
<a href="#l36.152"></a><span id="l36.152">                     this.listTree.updateCalendar(aCalendar);</span>
<a href="#l36.153"></a><span id="l36.153">                     // Fall through, update commands in any cases.</span>
<a href="#l36.154"></a><span id="l36.154">             }</span>
<a href="#l36.155"></a><span id="l36.155">         },</span>
<a href="#l36.156"></a><span id="l36.156"> </span>
<a href="#l36.157"></a><span id="l36.157" class="difflineminus">-        onPropertyDeleting: function cMO_onPropertyDeleting(aCalendar,</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineminus">-                                                            aName) {</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+        onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l36.160"></a><span id="l36.160">             // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l36.161"></a><span id="l36.161">             // but should not be the same as the value, set it to a different</span>
<a href="#l36.162"></a><span id="l36.162">             // value.</span>
<a href="#l36.163"></a><span id="l36.163">             this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l36.164"></a><span id="l36.164">         }</span>
<a href="#l36.165"></a><span id="l36.165">       })</span>
<a href="#l36.166"></a><span id="l36.166">       ]]&gt;&lt;/field&gt;</span>
<a href="#l36.167"></a><span id="l36.167"> </span>
<a href="#l36.168"></a><span id="l36.168">       &lt;field name=&quot;compositeObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l36.169"></a><span id="l36.169">       ({</span>
<a href="#l36.170"></a><span id="l36.170">         listTree: this,</span>
<a href="#l36.171"></a><span id="l36.171">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICompositeObserver]),</span>
<a href="#l36.172"></a><span id="l36.172"> </span>
<a href="#l36.173"></a><span id="l36.173">         // calICompositeObserver</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineminus">-        onCalendarAdded: function onCalendarAdded(aCalendar) {</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+        onCalendarAdded: function(aCalendar) {</span>
<a href="#l36.176"></a><span id="l36.176">             // Make sure the checkbox state is updated</span>
<a href="#l36.177"></a><span id="l36.177">             this.listTree.updateCalendar(aCalendar);</span>
<a href="#l36.178"></a><span id="l36.178">         },</span>
<a href="#l36.179"></a><span id="l36.179"> </span>
<a href="#l36.180"></a><span id="l36.180" class="difflineminus">-        onCalendarRemoved: function onCalendarRemoved(aCalendar) {</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+        onCalendarRemoved: function(aCalendar) {</span>
<a href="#l36.182"></a><span id="l36.182">             // Make sure the checkbox state is updated</span>
<a href="#l36.183"></a><span id="l36.183">             this.listTree.updateCalendar(aCalendar);</span>
<a href="#l36.184"></a><span id="l36.184">         },</span>
<a href="#l36.185"></a><span id="l36.185"> </span>
<a href="#l36.186"></a><span id="l36.186" class="difflineminus">-        onDefaultCalendarChanged: function cMO_onDefaultCalendarChanged(aCalendar) {</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineplus">+        onDefaultCalendarChanged: function(aCalendar) {</span>
<a href="#l36.188"></a><span id="l36.188">         }</span>
<a href="#l36.189"></a><span id="l36.189">       })</span>
<a href="#l36.190"></a><span id="l36.190">       ]]&gt;&lt;/field&gt;</span>
<a href="#l36.191"></a><span id="l36.191"> </span>
<a href="#l36.192"></a><span id="l36.192">       &lt;property name=&quot;treechildren&quot;</span>
<a href="#l36.193"></a><span id="l36.193">                 readonly=&quot;true&quot;</span>
<a href="#l36.194"></a><span id="l36.194">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'treechildren')&quot;/&gt;</span>
<a href="#l36.195"></a><span id="l36.195">       &lt;property name=&quot;tree&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -9,17 +9,17 @@ this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even</span>
<a href="#l37.4"></a><span id="l37.4"> cal.alarms = {</span>
<a href="#l37.5"></a><span id="l37.5">     /**</span>
<a href="#l37.6"></a><span id="l37.6">      * Read default alarm settings from user preferences and apply them to the</span>
<a href="#l37.7"></a><span id="l37.7">      * event/todo passed in. The item's calendar should be set to ensure the</span>
<a href="#l37.8"></a><span id="l37.8">      * correct alarm type is set.</span>
<a href="#l37.9"></a><span id="l37.9">      *</span>
<a href="#l37.10"></a><span id="l37.10">      * @param aItem     The item to apply the default alarm values to.</span>
<a href="#l37.11"></a><span id="l37.11">      */</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-    setDefaultValues: function cal_alarm_setDefaultValues(aItem) {</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+    setDefaultValues: function(aItem) {</span>
<a href="#l37.14"></a><span id="l37.14">         let type = cal.isEvent(aItem) ? &quot;event&quot; : &quot;todo&quot;;</span>
<a href="#l37.15"></a><span id="l37.15">         if (Preferences.get(&quot;calendar.alarms.onfor&quot; + type + &quot;s&quot;, 0) == 1) {</span>
<a href="#l37.16"></a><span id="l37.16">             let alarmOffset = cal.createDuration();</span>
<a href="#l37.17"></a><span id="l37.17">             let alarm = cal.createAlarm();</span>
<a href="#l37.18"></a><span id="l37.18">             let units = Preferences.get(&quot;calendar.alarms.&quot; + type + &quot;alarmunit&quot;, &quot;minutes&quot;);</span>
<a href="#l37.19"></a><span id="l37.19"> </span>
<a href="#l37.20"></a><span id="l37.20">             // Make sure the alarm pref is valid, default to minutes otherwise</span>
<a href="#l37.21"></a><span id="l37.21">             if (![&quot;weeks&quot;, &quot;days&quot;, &quot;hours&quot;, &quot;minutes&quot;, &quot;seconds&quot;].includes(units)) {</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -49,17 +49,17 @@ cal.alarms = {</span>
<a href="#l37.23"></a><span id="l37.23"> </span>
<a href="#l37.24"></a><span id="l37.24">     /**</span>
<a href="#l37.25"></a><span id="l37.25">      * Calculate the alarm date for a calIAlarm.</span>
<a href="#l37.26"></a><span id="l37.26">      *</span>
<a href="#l37.27"></a><span id="l37.27">      * @param aItem     The item used to calculate the alarm date.</span>
<a href="#l37.28"></a><span id="l37.28">      * @param aAlarm    The alarm to calculate the date for.</span>
<a href="#l37.29"></a><span id="l37.29">      * @return          The alarm date.</span>
<a href="#l37.30"></a><span id="l37.30">      */</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-    calculateAlarmDate: function cal_alarm_calculateAlarmDate(aItem, aAlarm) {</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+    calculateAlarmDate: function(aItem, aAlarm) {</span>
<a href="#l37.33"></a><span id="l37.33">         if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l37.34"></a><span id="l37.34">             return aAlarm.alarmDate;</span>
<a href="#l37.35"></a><span id="l37.35">         } else {</span>
<a href="#l37.36"></a><span id="l37.36">             let returnDate;</span>
<a href="#l37.37"></a><span id="l37.37">             if (aAlarm.related == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l37.38"></a><span id="l37.38">                 returnDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l37.39"></a><span id="l37.39">             } else if (aAlarm.related == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l37.40"></a><span id="l37.40">                 returnDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineat">@@ -92,17 +92,17 @@ cal.alarms = {</span>
<a href="#l37.42"></a><span id="l37.42">      * parameter.</span>
<a href="#l37.43"></a><span id="l37.43">      *</span>
<a href="#l37.44"></a><span id="l37.44">      * @param aItem     The item to calculate the offset for.</span>
<a href="#l37.45"></a><span id="l37.45">      * @param aAlarm    The alarm to calculate the offset for.</span>
<a href="#l37.46"></a><span id="l37.46">      * @param aRelated  (optional) A relation constant from calIAlarm. If not</span>
<a href="#l37.47"></a><span id="l37.47">      *                    passed, ALARM_RELATED_START will be assumed.</span>
<a href="#l37.48"></a><span id="l37.48">      * @return          The alarm offset.</span>
<a href="#l37.49"></a><span id="l37.49">      */</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-    calculateAlarmOffset: function cal_alarms_calculateAlarmOffset(aItem, aAlarm, aRelated) {</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+    calculateAlarmOffset: function(aItem, aAlarm, aRelated) {</span>
<a href="#l37.52"></a><span id="l37.52">         let offset = aAlarm.offset;</span>
<a href="#l37.53"></a><span id="l37.53">         if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l37.54"></a><span id="l37.54">             let returnDate;</span>
<a href="#l37.55"></a><span id="l37.55">             if (aRelated === undefined || aRelated == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l37.56"></a><span id="l37.56">                 returnDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l37.57"></a><span id="l37.57">             } else if (aRelated == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l37.58"></a><span id="l37.58">                 returnDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l37.59"></a><span id="l37.59">             }</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineat">@@ -116,17 +116,17 @@ cal.alarms = {</span>
<a href="#l37.61"></a><span id="l37.61"> </span>
<a href="#l37.62"></a><span id="l37.62">     /**</span>
<a href="#l37.63"></a><span id="l37.63">      * Adds reminder images to a given node, making sure only one icon per alarm</span>
<a href="#l37.64"></a><span id="l37.64">      * action is added.</span>
<a href="#l37.65"></a><span id="l37.65">      *</span>
<a href="#l37.66"></a><span id="l37.66">      * @param aElement    The element to add the images to.</span>
<a href="#l37.67"></a><span id="l37.67">      * @param aReminders  The set of reminders to add images for.</span>
<a href="#l37.68"></a><span id="l37.68">      */</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-    addReminderImages: function cal_alarms_addReminderImages(aElement, aReminders) {</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+    addReminderImages: function(aElement, aReminders) {</span>
<a href="#l37.71"></a><span id="l37.71">         function createOwnedXULNode(el) {</span>
<a href="#l37.72"></a><span id="l37.72">             const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l37.73"></a><span id="l37.73">             return aElement.ownerDocument.createElementNS(XUL_NS, el);</span>
<a href="#l37.74"></a><span id="l37.74">         }</span>
<a href="#l37.75"></a><span id="l37.75"> </span>
<a href="#l37.76"></a><span id="l37.76">         function setupActionImage(node, reminder) {</span>
<a href="#l37.77"></a><span id="l37.77">             let image = node || createOwnedXULNode(&quot;image&quot;);</span>
<a href="#l37.78"></a><span id="l37.78">             image.setAttribute(&quot;class&quot;, &quot;reminder-icon&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -10,39 +10,35 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l38.4"></a><span id="l38.4">  * Authentication helper code</span>
<a href="#l38.5"></a><span id="l38.5">  */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l38.8"></a><span id="l38.8"> cal.auth = {</span>
<a href="#l38.9"></a><span id="l38.9">     /**</span>
<a href="#l38.10"></a><span id="l38.10">      * Auth prompt implementation - Uses password manager if at all possible.</span>
<a href="#l38.11"></a><span id="l38.11">      */</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    Prompt: function calPrompt() {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    Prompt: function() {</span>
<a href="#l38.14"></a><span id="l38.14">         this.mWindow = cal.getCalendarWindow();</span>
<a href="#l38.15"></a><span id="l38.15">         this.mReturnedLogins = {};</span>
<a href="#l38.16"></a><span id="l38.16">     },</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18">     /**</span>
<a href="#l38.19"></a><span id="l38.19">      * Tries to get the username/password combination of a specific calendar name</span>
<a href="#l38.20"></a><span id="l38.20">      * from the password manager or asks the user.</span>
<a href="#l38.21"></a><span id="l38.21">      *</span>
<a href="#l38.22"></a><span id="l38.22">      * @param   in aTitle           The dialog title.</span>
<a href="#l38.23"></a><span id="l38.23">      * @param   in aCalendarName    The calendar name or url to look up. Can be null.</span>
<a href="#l38.24"></a><span id="l38.24">      * @param   inout aUsername     The username that belongs to the calendar.</span>
<a href="#l38.25"></a><span id="l38.25">      * @param   inout aPassword     The password that belongs to the calendar.</span>
<a href="#l38.26"></a><span id="l38.26">      * @param   inout aSavePassword Should the password be saved?</span>
<a href="#l38.27"></a><span id="l38.27">      * @param   in aFixedUsername   Whether the user name is fixed or editable</span>
<a href="#l38.28"></a><span id="l38.28">      * @return  Could a password be retrieved?</span>
<a href="#l38.29"></a><span id="l38.29">      */</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-    getCredentials: function calGetCredentials(aTitle,</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-                                               aCalendarName,</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-                                               aUsername,</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-                                               aPassword,</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-                                               aSavePassword,</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-                                               aFixedUsername) {</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+    getCredentials: function(aTitle, aCalendarName, aUsername, aPassword,</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+                             aSavePassword, aFixedUsername) {</span>
<a href="#l38.38"></a><span id="l38.38">         if (typeof aUsername != &quot;object&quot; ||</span>
<a href="#l38.39"></a><span id="l38.39">             typeof aPassword != &quot;object&quot; ||</span>
<a href="#l38.40"></a><span id="l38.40">             typeof aSavePassword != &quot;object&quot;) {</span>
<a href="#l38.41"></a><span id="l38.41">             throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l38.42"></a><span id="l38.42">         }</span>
<a href="#l38.43"></a><span id="l38.43"> </span>
<a href="#l38.44"></a><span id="l38.44">         let prompter = Services.ww.getNewPrompter(null);</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46" class="difflineat">@@ -74,17 +70,17 @@ cal.auth = {</span>
<a href="#l38.47"></a><span id="l38.47">     /**</span>
<a href="#l38.48"></a><span id="l38.48">      * Helper to insert/update an entry to the password manager.</span>
<a href="#l38.49"></a><span id="l38.49">      *</span>
<a href="#l38.50"></a><span id="l38.50">      * @param aUserName     The username</span>
<a href="#l38.51"></a><span id="l38.51">      * @param aPassword     The corresponding password</span>
<a href="#l38.52"></a><span id="l38.52">      * @param aHostName     The corresponding hostname</span>
<a href="#l38.53"></a><span id="l38.53">      * @param aRealm        The password realm (unused on branch)</span>
<a href="#l38.54"></a><span id="l38.54">      */</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-    passwordManagerSave: function calPasswordManagerSave(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+    passwordManagerSave: function(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l38.57"></a><span id="l38.57">         cal.ASSERT(aUsername);</span>
<a href="#l38.58"></a><span id="l38.58">         cal.ASSERT(aPassword);</span>
<a href="#l38.59"></a><span id="l38.59"> </span>
<a href="#l38.60"></a><span id="l38.60">         try {</span>
<a href="#l38.61"></a><span id="l38.61">             let logins = Services.logins.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l38.62"></a><span id="l38.62"> </span>
<a href="#l38.63"></a><span id="l38.63">             let newLoginInfo = Components.classes[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l38.64"></a><span id="l38.64">                                          .createInstance(Components.interfaces.nsILoginInfo);</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineat">@@ -105,17 +101,17 @@ cal.auth = {</span>
<a href="#l38.66"></a><span id="l38.66">      * Helper to retrieve an entry from the password manager.</span>
<a href="#l38.67"></a><span id="l38.67">      *</span>
<a href="#l38.68"></a><span id="l38.68">      * @param in  aUsername     The username to search</span>
<a href="#l38.69"></a><span id="l38.69">      * @param out aPassword     The corresponding password</span>
<a href="#l38.70"></a><span id="l38.70">      * @param aHostName         The corresponding hostname</span>
<a href="#l38.71"></a><span id="l38.71">      * @param aRealm            The password realm (unused on branch)</span>
<a href="#l38.72"></a><span id="l38.72">      * @return                  Does an entry exist in the password manager</span>
<a href="#l38.73"></a><span id="l38.73">      */</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-    passwordManagerGet: function calPasswordManagerGet(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+    passwordManagerGet: function(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l38.76"></a><span id="l38.76">         cal.ASSERT(aUsername);</span>
<a href="#l38.77"></a><span id="l38.77"> </span>
<a href="#l38.78"></a><span id="l38.78">         if (typeof aPassword != &quot;object&quot;) {</span>
<a href="#l38.79"></a><span id="l38.79">             throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l38.80"></a><span id="l38.80">         }</span>
<a href="#l38.81"></a><span id="l38.81"> </span>
<a href="#l38.82"></a><span id="l38.82">         try {</span>
<a href="#l38.83"></a><span id="l38.83">             if (!Services.logins.getLoginSavingEnabled(aUsername)) {</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineat">@@ -138,17 +134,17 @@ cal.auth = {</span>
<a href="#l38.85"></a><span id="l38.85">     /**</span>
<a href="#l38.86"></a><span id="l38.86">      * Helper to remove an entry from the password manager</span>
<a href="#l38.87"></a><span id="l38.87">      *</span>
<a href="#l38.88"></a><span id="l38.88">      * @param aUsername     The username to remove.</span>
<a href="#l38.89"></a><span id="l38.89">      * @param aHostName     The corresponding hostname</span>
<a href="#l38.90"></a><span id="l38.90">      * @param aRealm        The password realm (unused on branch)</span>
<a href="#l38.91"></a><span id="l38.91">      * @return              Could the user be removed?</span>
<a href="#l38.92"></a><span id="l38.92">      */</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-    passwordManagerRemove: function calPasswordManagerRemove(aUsername, aHostName, aRealm) {</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+    passwordManagerRemove: function(aUsername, aHostName, aRealm) {</span>
<a href="#l38.95"></a><span id="l38.95">         cal.ASSERT(aUsername);</span>
<a href="#l38.96"></a><span id="l38.96"> </span>
<a href="#l38.97"></a><span id="l38.97">         try {</span>
<a href="#l38.98"></a><span id="l38.98">             let logins = Services.logins.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l38.99"></a><span id="l38.99">             for (let loginInfo of logins) {</span>
<a href="#l38.100"></a><span id="l38.100">                 if (loginInfo.username == aUsername) {</span>
<a href="#l38.101"></a><span id="l38.101">                     Services.logins.removeLogin(loginInfo);</span>
<a href="#l38.102"></a><span id="l38.102">                     return true;</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineat">@@ -169,17 +165,17 @@ cal.auth = {</span>
<a href="#l38.104"></a><span id="l38.104">  * This implementation guarantees there are no request loops when an invalid</span>
<a href="#l38.105"></a><span id="l38.105">  * password is stored in the login-manager.</span>
<a href="#l38.106"></a><span id="l38.106">  *</span>
<a href="#l38.107"></a><span id="l38.107">  * There is one instance of that object per calendar provider.</span>
<a href="#l38.108"></a><span id="l38.108">  */</span>
<a href="#l38.109"></a><span id="l38.109"> cal.auth.Prompt.prototype = {</span>
<a href="#l38.110"></a><span id="l38.110">     mProvider: null,</span>
<a href="#l38.111"></a><span id="l38.111"> </span>
<a href="#l38.112"></a><span id="l38.112" class="difflineminus">-    getPasswordInfo: function capGPI(aPasswordRealm) {</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+    getPasswordInfo: function(aPasswordRealm) {</span>
<a href="#l38.114"></a><span id="l38.114">         let username;</span>
<a href="#l38.115"></a><span id="l38.115">         let password;</span>
<a href="#l38.116"></a><span id="l38.116">         let found = false;</span>
<a href="#l38.117"></a><span id="l38.117"> </span>
<a href="#l38.118"></a><span id="l38.118">         let logins = Services.logins.findLogins({}, aPasswordRealm.prePath, null, aPasswordRealm.realm);</span>
<a href="#l38.119"></a><span id="l38.119">         if (logins.length) {</span>
<a href="#l38.120"></a><span id="l38.120">             username = logins[0].username;</span>
<a href="#l38.121"></a><span id="l38.121">             password = logins[0].password;</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineat">@@ -228,17 +224,17 @@ cal.auth.Prompt.prototype = {</span>
<a href="#l38.123"></a><span id="l38.123">      *         object.</span>
<a href="#l38.124"></a><span id="l38.124">      * @retval false</span>
<a href="#l38.125"></a><span id="l38.125">      *         Authentication should be cancelled, usually because the user did</span>
<a href="#l38.126"></a><span id="l38.126">      *         not provide username/password.</span>
<a href="#l38.127"></a><span id="l38.127">      *</span>
<a href="#l38.128"></a><span id="l38.128">      * @note   Exceptions thrown from this function will be treated like a</span>
<a href="#l38.129"></a><span id="l38.129">      *         return value of false.</span>
<a href="#l38.130"></a><span id="l38.130">      */</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-    promptAuth: function capPA(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+    promptAuth: function(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l38.133"></a><span id="l38.133">         let hostRealm = {};</span>
<a href="#l38.134"></a><span id="l38.134">         hostRealm.prePath = aChannel.URI.prePath;</span>
<a href="#l38.135"></a><span id="l38.135">         hostRealm.realm = aAuthInfo.realm;</span>
<a href="#l38.136"></a><span id="l38.136">         let port = aChannel.URI.port;</span>
<a href="#l38.137"></a><span id="l38.137">         if (port == -1) {</span>
<a href="#l38.138"></a><span id="l38.138">             let handler = Services.io.getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l38.139"></a><span id="l38.139">                                      .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l38.140"></a><span id="l38.140">             port = handler.defaultPort;</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineat">@@ -270,22 +266,21 @@ cal.auth.Prompt.prototype = {</span>
<a href="#l38.142"></a><span id="l38.142">      * Calling nsICancelable::cancel on the returned object SHOULD close the</span>
<a href="#l38.143"></a><span id="l38.143">      * dialog and MUST call nsIAuthPromptCallback::onAuthCancelled on the provided</span>
<a href="#l38.144"></a><span id="l38.144">      * callback.</span>
<a href="#l38.145"></a><span id="l38.145">      *</span>
<a href="#l38.146"></a><span id="l38.146">      * @throw NS_ERROR_NOT_IMPLEMENTED</span>
<a href="#l38.147"></a><span id="l38.147">      *        Asynchronous authentication prompts are not supported;</span>
<a href="#l38.148"></a><span id="l38.148">      *        the caller should fall back to promptUsernameAndPassword().</span>
<a href="#l38.149"></a><span id="l38.149">      */</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineminus">-    asyncPromptAuth: function capAPA(aChannel,   // nsIChannel</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineminus">-                                     aCallback,  // nsIAuthPromptCallback</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineminus">-                                     aContext,   // nsISupports</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineminus">-                                     aLevel,     // PRUint32</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineminus">-                                     aAuthInfo   // nsIAuthInformation</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-                                ) {</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineplus">+    asyncPromptAuth: function(aChannel,     // nsIChannel</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineplus">+                              aCallback,    // nsIAuthPromptCallback</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+                              aContext,     // nsISupports</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+                              aLevel,       // PRUint32</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineplus">+                              aAuthInfo) {  // nsIAuthInformation</span>
<a href="#l38.161"></a><span id="l38.161">         let self = this;</span>
<a href="#l38.162"></a><span id="l38.162">         let promptlistener = {</span>
<a href="#l38.163"></a><span id="l38.163">             onPromptStart: function() {</span>
<a href="#l38.164"></a><span id="l38.164">                 res = self.promptAuth(aChannel, aLevel, aAuthInfo);</span>
<a href="#l38.165"></a><span id="l38.165"> </span>
<a href="#l38.166"></a><span id="l38.166">                 if (res) {</span>
<a href="#l38.167"></a><span id="l38.167">                     gAuthCache.setAuthInfo(hostKey, aAuthInfo);</span>
<a href="#l38.168"></a><span id="l38.168">                     this.onPromptAuthAvailable();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/modules/calExtract.jsm</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/modules/calExtract.jsm</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -53,17 +53,17 @@ function Extractor(fallbackLocale, daySt</span>
<a href="#l39.4"></a><span id="l39.4">     }</span>
<a href="#l39.5"></a><span id="l39.5"> }</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7"> Extractor.prototype = {</span>
<a href="#l39.8"></a><span id="l39.8">     /**</span>
<a href="#l39.9"></a><span id="l39.9">     * Removes confusing data like urls, timezones and phone numbers from email</span>
<a href="#l39.10"></a><span id="l39.10">     * Also removes standard signatures and quoted content from previous emails</span>
<a href="#l39.11"></a><span id="l39.11">     */</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-    cleanup: function cleanup() {</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+    cleanup: function() {</span>
<a href="#l39.14"></a><span id="l39.14">         // XXX remove earlier correspondence</span>
<a href="#l39.15"></a><span id="l39.15">         // ideally this should be considered with lower certainty to fill in</span>
<a href="#l39.16"></a><span id="l39.16">         // missing information</span>
<a href="#l39.17"></a><span id="l39.17"> </span>
<a href="#l39.18"></a><span id="l39.18">         // remove last line preceeding quoted message and first line of the quote</span>
<a href="#l39.19"></a><span id="l39.19">         this.email = this.email.replace(/\r?\n[^&gt;].*\r?\n&gt;+.*$/m, &quot;&quot;);</span>
<a href="#l39.20"></a><span id="l39.20">         // remove the rest of quoted content</span>
<a href="#l39.21"></a><span id="l39.21">         this.email = this.email.replace(/^&gt;+.*$/gm, &quot;&quot;);</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineat">@@ -78,46 +78,46 @@ Extractor.prototype = {</span>
<a href="#l39.23"></a><span id="l39.23"> </span>
<a href="#l39.24"></a><span id="l39.24">         // remove standard signature</span>
<a href="#l39.25"></a><span id="l39.25">         this.email = this.email.replace(/\r?\n-- \r?\n[\S\s]+$/, &quot;&quot;);</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27">         // XXX remove timezone info, for now</span>
<a href="#l39.28"></a><span id="l39.28">         this.email = this.email.replace(/gmt[+-]\d{2}:\d{2}/gi, &quot;&quot;);</span>
<a href="#l39.29"></a><span id="l39.29">     },</span>
<a href="#l39.30"></a><span id="l39.30"> </span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-    checkBundle: function checkBundle(locale) {</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+    checkBundle: function(locale) {</span>
<a href="#l39.33"></a><span id="l39.33">         let path = this.bundleUrl.replace(/LOCALE/g, locale);</span>
<a href="#l39.34"></a><span id="l39.34">         let bundle = Services.strings.createBundle(path);</span>
<a href="#l39.35"></a><span id="l39.35"> </span>
<a href="#l39.36"></a><span id="l39.36">         try {</span>
<a href="#l39.37"></a><span id="l39.37">             bundle.GetStringFromName(&quot;from.today&quot;);</span>
<a href="#l39.38"></a><span id="l39.38">             return true;</span>
<a href="#l39.39"></a><span id="l39.39">         } catch (ex) {</span>
<a href="#l39.40"></a><span id="l39.40">             return false;</span>
<a href="#l39.41"></a><span id="l39.41">         }</span>
<a href="#l39.42"></a><span id="l39.42">     },</span>
<a href="#l39.43"></a><span id="l39.43"> </span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-    avgNonAsciiCharCode: function avgNonAsciiCharCode() {</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+    avgNonAsciiCharCode: function() {</span>
<a href="#l39.46"></a><span id="l39.46">         let sum = 0;</span>
<a href="#l39.47"></a><span id="l39.47">         let cnt = 0;</span>
<a href="#l39.48"></a><span id="l39.48"> </span>
<a href="#l39.49"></a><span id="l39.49">         for (let i = 0; i &lt; this.email.length; i++) {</span>
<a href="#l39.50"></a><span id="l39.50">             let ch = this.email.charCodeAt(i);</span>
<a href="#l39.51"></a><span id="l39.51">             if (ch &gt; 128) {</span>
<a href="#l39.52"></a><span id="l39.52">                 sum += ch;</span>
<a href="#l39.53"></a><span id="l39.53">                 cnt++;</span>
<a href="#l39.54"></a><span id="l39.54">             }</span>
<a href="#l39.55"></a><span id="l39.55">         }</span>
<a href="#l39.56"></a><span id="l39.56"> </span>
<a href="#l39.57"></a><span id="l39.57">         let nonAscii = sum / cnt || 0;</span>
<a href="#l39.58"></a><span id="l39.58">         cal.LOG(&quot;[calExtract] Average non-ascii charcode: &quot; + nonAscii);</span>
<a href="#l39.59"></a><span id="l39.59">         return nonAscii;</span>
<a href="#l39.60"></a><span id="l39.60">     },</span>
<a href="#l39.61"></a><span id="l39.61"> </span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-    setLanguage: function setLanguage() {</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+    setLanguage: function() {</span>
<a href="#l39.64"></a><span id="l39.64">         let path;</span>
<a href="#l39.65"></a><span id="l39.65"> </span>
<a href="#l39.66"></a><span id="l39.66">         if (this.fixedLang == true) {</span>
<a href="#l39.67"></a><span id="l39.67">             if (this.checkBundle(this.fallbackLocale)) {</span>
<a href="#l39.68"></a><span id="l39.68">                 cal.LOG(&quot;[calExtract] Fixed locale was used to choose &quot; +</span>
<a href="#l39.69"></a><span id="l39.69">                         this.fallbackLocale + &quot; patterns.&quot;);</span>
<a href="#l39.70"></a><span id="l39.70">             } else {</span>
<a href="#l39.71"></a><span id="l39.71">                 cal.LOG(&quot;[calExtract] &quot; + this.fallbackLocale +</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineat">@@ -252,17 +252,17 @@ Extractor.prototype = {</span>
<a href="#l39.73"></a><span id="l39.73">     * @param body  email body</span>
<a href="#l39.74"></a><span id="l39.74">     * @param now   reference time against which relative times are interpreted,</span>
<a href="#l39.75"></a><span id="l39.75">     *                  when null current time is used</span>
<a href="#l39.76"></a><span id="l39.76">     * @param sel   selection object of email content, when defined times</span>
<a href="#l39.77"></a><span id="l39.77">     *                  outside selection are disgarded</span>
<a href="#l39.78"></a><span id="l39.78">     * @param title email title</span>
<a href="#l39.79"></a><span id="l39.79">     * @return      sorted list of extracted datetime objects</span>
<a href="#l39.80"></a><span id="l39.80">     */</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-    extract: function extract(title, body, now, sel) {</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+    extract: function(title, body, now, sel) {</span>
<a href="#l39.83"></a><span id="l39.83">         let initial = {};</span>
<a href="#l39.84"></a><span id="l39.84">         this.collected = [];</span>
<a href="#l39.85"></a><span id="l39.85">         this.email = title + &quot;\r\n&quot; + body;</span>
<a href="#l39.86"></a><span id="l39.86">         if (now != null) {</span>
<a href="#l39.87"></a><span id="l39.87">             this.now = now;</span>
<a href="#l39.88"></a><span id="l39.88">         }</span>
<a href="#l39.89"></a><span id="l39.89"> </span>
<a href="#l39.90"></a><span id="l39.90">         initial.year = now.getFullYear();</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineat">@@ -355,17 +355,17 @@ Extractor.prototype = {</span>
<a href="#l39.92"></a><span id="l39.92">             this.markSelected(sel, title);</span>
<a href="#l39.93"></a><span id="l39.93">         }</span>
<a href="#l39.94"></a><span id="l39.94">         this.markContained();</span>
<a href="#l39.95"></a><span id="l39.95">         this.collected = this.collected.sort(this.sort);</span>
<a href="#l39.96"></a><span id="l39.96"> </span>
<a href="#l39.97"></a><span id="l39.97">         return this.collected;</span>
<a href="#l39.98"></a><span id="l39.98">     },</span>
<a href="#l39.99"></a><span id="l39.99"> </span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-    extractDayMonthYear: function extractDayMonthYear(pattern, relation) {</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+    extractDayMonthYear: function(pattern, relation) {</span>
<a href="#l39.102"></a><span id="l39.102">         let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;, &quot;(\\d{1,2})&quot;,</span>
<a href="#l39.103"></a><span id="l39.103">                                                  &quot;(\\d{2,4})&quot;]);</span>
<a href="#l39.104"></a><span id="l39.104">         let res;</span>
<a href="#l39.105"></a><span id="l39.105">         for (let alt in alts) {</span>
<a href="#l39.106"></a><span id="l39.106">             let positions = alts[alt].positions;</span>
<a href="#l39.107"></a><span id="l39.107">             let re = new RegExp(alts[alt].pattern, &quot;ig&quot;);</span>
<a href="#l39.108"></a><span id="l39.108"> </span>
<a href="#l39.109"></a><span id="l39.109">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineat">@@ -380,17 +380,17 @@ Extractor.prototype = {</span>
<a href="#l39.111"></a><span id="l39.111">                         this.guess(year, month, day, null, null,</span>
<a href="#l39.112"></a><span id="l39.112">                                    rev.start, rev.end, rev.pattern, rev.relation, pattern);</span>
<a href="#l39.113"></a><span id="l39.113">                     }</span>
<a href="#l39.114"></a><span id="l39.114">                 }</span>
<a href="#l39.115"></a><span id="l39.115">             }</span>
<a href="#l39.116"></a><span id="l39.116">         }</span>
<a href="#l39.117"></a><span id="l39.117">     },</span>
<a href="#l39.118"></a><span id="l39.118"> </span>
<a href="#l39.119"></a><span id="l39.119" class="difflineminus">-    extractDayMonthNameYear: function extractDayMonthNameYear(pattern, relation) {</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+    extractDayMonthNameYear: function(pattern, relation) {</span>
<a href="#l39.121"></a><span id="l39.121">         let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;,</span>
<a href="#l39.122"></a><span id="l39.122">                                                  &quot;(&quot; + this.allMonths + &quot;)&quot;,</span>
<a href="#l39.123"></a><span id="l39.123">                                                  &quot;(\\d{2,4})&quot;]);</span>
<a href="#l39.124"></a><span id="l39.124">         let res;</span>
<a href="#l39.125"></a><span id="l39.125">         for (let alt in alts) {</span>
<a href="#l39.126"></a><span id="l39.126">             let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l39.127"></a><span id="l39.127">             let positions = alts[alt].positions;</span>
<a href="#l39.128"></a><span id="l39.128">             let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineat">@@ -411,31 +411,31 @@ Extractor.prototype = {</span>
<a href="#l39.130"></a><span id="l39.130">                             }</span>
<a href="#l39.131"></a><span id="l39.131">                         }</span>
<a href="#l39.132"></a><span id="l39.132">                     }</span>
<a href="#l39.133"></a><span id="l39.133">                 }</span>
<a href="#l39.134"></a><span id="l39.134">             }</span>
<a href="#l39.135"></a><span id="l39.135">         }</span>
<a href="#l39.136"></a><span id="l39.136">     },</span>
<a href="#l39.137"></a><span id="l39.137"> </span>
<a href="#l39.138"></a><span id="l39.138" class="difflineminus">-    extractRelativeDay: function extractRelativeDay(pattern, relation, offset) {</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+    extractRelativeDay: function(pattern, relation, offset) {</span>
<a href="#l39.140"></a><span id="l39.140">         let re = new RegExp(this.getPatterns(pattern), &quot;ig&quot;);</span>
<a href="#l39.141"></a><span id="l39.141">         let res;</span>
<a href="#l39.142"></a><span id="l39.142">         if ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.143"></a><span id="l39.143">             if (!this.limitChars(res, this.email)) {</span>
<a href="#l39.144"></a><span id="l39.144">                 let item = new Date(this.now.getTime() + 60 * 60 * 24 * 1000 * offset);</span>
<a href="#l39.145"></a><span id="l39.145">                 let rev = this.prefixSuffixStartEnd(res, relation, this.email);</span>
<a href="#l39.146"></a><span id="l39.146">                 this.guess(item.getFullYear(), item.getMonth() + 1, item.getDate(),</span>
<a href="#l39.147"></a><span id="l39.147">                            null, null,</span>
<a href="#l39.148"></a><span id="l39.148">                            rev.start, rev.end, rev.pattern, rev.relation, pattern);</span>
<a href="#l39.149"></a><span id="l39.149">             }</span>
<a href="#l39.150"></a><span id="l39.150">         }</span>
<a href="#l39.151"></a><span id="l39.151">     },</span>
<a href="#l39.152"></a><span id="l39.152"> </span>
<a href="#l39.153"></a><span id="l39.153" class="difflineminus">-    extractDayMonthName: function extractDayMonthName(pattern, relation) {</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+    extractDayMonthName: function(pattern, relation) {</span>
<a href="#l39.155"></a><span id="l39.155">         let alts = this.getRepPatterns(pattern,</span>
<a href="#l39.156"></a><span id="l39.156">                                        [&quot;(\\d{1,2}&quot; + this.marker + this.dailyNumbers + &quot;)&quot;,</span>
<a href="#l39.157"></a><span id="l39.157">                                        &quot;(&quot; + this.allMonths + &quot;)&quot;]);</span>
<a href="#l39.158"></a><span id="l39.158">         let res;</span>
<a href="#l39.159"></a><span id="l39.159">         for (let alt in alts) {</span>
<a href="#l39.160"></a><span id="l39.160">             let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l39.161"></a><span id="l39.161">             let positions = alts[alt].positions;</span>
<a href="#l39.162"></a><span id="l39.162">             let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineat">@@ -470,17 +470,17 @@ Extractor.prototype = {</span>
<a href="#l39.164"></a><span id="l39.164">                             }</span>
<a href="#l39.165"></a><span id="l39.165">                         }</span>
<a href="#l39.166"></a><span id="l39.166">                     }</span>
<a href="#l39.167"></a><span id="l39.167">                 }</span>
<a href="#l39.168"></a><span id="l39.168">             }</span>
<a href="#l39.169"></a><span id="l39.169">         }</span>
<a href="#l39.170"></a><span id="l39.170">     },</span>
<a href="#l39.171"></a><span id="l39.171"> </span>
<a href="#l39.172"></a><span id="l39.172" class="difflineminus">-    extractDayMonth: function extractDayMonth(pattern, relation) {</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineplus">+    extractDayMonth: function(pattern, relation) {</span>
<a href="#l39.174"></a><span id="l39.174">         let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;, &quot;(\\d{1,2})&quot;]);</span>
<a href="#l39.175"></a><span id="l39.175">         let res;</span>
<a href="#l39.176"></a><span id="l39.176">         for (let alt in alts) {</span>
<a href="#l39.177"></a><span id="l39.177">             let re = new RegExp(alts[alt].pattern, &quot;ig&quot;);</span>
<a href="#l39.178"></a><span id="l39.178">             let positions = alts[alt].positions;</span>
<a href="#l39.179"></a><span id="l39.179"> </span>
<a href="#l39.180"></a><span id="l39.180">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.181"></a><span id="l39.181">                 if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l39.182"></a><span id="l39.182" class="difflineat">@@ -507,17 +507,17 @@ Extractor.prototype = {</span>
<a href="#l39.183"></a><span id="l39.183">                         this.guess(date.year, date.month, date.day, null, null,</span>
<a href="#l39.184"></a><span id="l39.184">                                    rev.start, rev.end, rev.pattern, rev.relation, pattern);</span>
<a href="#l39.185"></a><span id="l39.185">                     }</span>
<a href="#l39.186"></a><span id="l39.186">                 }</span>
<a href="#l39.187"></a><span id="l39.187">             }</span>
<a href="#l39.188"></a><span id="l39.188">         }</span>
<a href="#l39.189"></a><span id="l39.189">     },</span>
<a href="#l39.190"></a><span id="l39.190"> </span>
<a href="#l39.191"></a><span id="l39.191" class="difflineminus">-    extractDate: function extractDate(pattern, relation) {</span>
<a href="#l39.192"></a><span id="l39.192" class="difflineplus">+    extractDate: function(pattern, relation) {</span>
<a href="#l39.193"></a><span id="l39.193">         let alts = this.getRepPatterns(pattern,</span>
<a href="#l39.194"></a><span id="l39.194">                                        [&quot;(\\d{1,2}&quot; + this.marker + this.dailyNumbers + &quot;)&quot;]);</span>
<a href="#l39.195"></a><span id="l39.195">         let res;</span>
<a href="#l39.196"></a><span id="l39.196">         for (let alt in alts) {</span>
<a href="#l39.197"></a><span id="l39.197">             let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l39.198"></a><span id="l39.198">             let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l39.199"></a><span id="l39.199"> </span>
<a href="#l39.200"></a><span id="l39.200">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.201"></a><span id="l39.201" class="difflineat">@@ -541,17 +541,17 @@ Extractor.prototype = {</span>
<a href="#l39.202"></a><span id="l39.202">                                    rev.start, rev.end,</span>
<a href="#l39.203"></a><span id="l39.203">                                    rev.pattern, rev.relation, pattern, true);</span>
<a href="#l39.204"></a><span id="l39.204">                     }</span>
<a href="#l39.205"></a><span id="l39.205">                 }</span>
<a href="#l39.206"></a><span id="l39.206">             }</span>
<a href="#l39.207"></a><span id="l39.207">         }</span>
<a href="#l39.208"></a><span id="l39.208">     },</span>
<a href="#l39.209"></a><span id="l39.209"> </span>
<a href="#l39.210"></a><span id="l39.210" class="difflineminus">-    extractWeekDay: function extractWeekDay(pattern, relation) {</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineplus">+    extractWeekDay: function(pattern, relation) {</span>
<a href="#l39.212"></a><span id="l39.212">         let days = [];</span>
<a href="#l39.213"></a><span id="l39.213">         for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l39.214"></a><span id="l39.214">             days[i] = this.getPatterns(pattern + i);</span>
<a href="#l39.215"></a><span id="l39.215">             let re = new RegExp(days[i], &quot;ig&quot;);</span>
<a href="#l39.216"></a><span id="l39.216">             let res = re.exec(this.email);</span>
<a href="#l39.217"></a><span id="l39.217">             if (res) {</span>
<a href="#l39.218"></a><span id="l39.218">                 if (!this.limitChars(res, this.email)) {</span>
<a href="#l39.219"></a><span id="l39.219">                     let date = new Date();</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineat">@@ -567,17 +567,17 @@ Extractor.prototype = {</span>
<a href="#l39.221"></a><span id="l39.221">                                null, null,</span>
<a href="#l39.222"></a><span id="l39.222">                                rev.start, rev.end,</span>
<a href="#l39.223"></a><span id="l39.223">                                rev.pattern, rev.relation, pattern + i, true);</span>
<a href="#l39.224"></a><span id="l39.224">                 }</span>
<a href="#l39.225"></a><span id="l39.225">             }</span>
<a href="#l39.226"></a><span id="l39.226">         }</span>
<a href="#l39.227"></a><span id="l39.227">     },</span>
<a href="#l39.228"></a><span id="l39.228"> </span>
<a href="#l39.229"></a><span id="l39.229" class="difflineminus">-    extractHour: function extractHour(pattern, relation, meridiem) {</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineplus">+    extractHour: function(pattern, relation, meridiem) {</span>
<a href="#l39.231"></a><span id="l39.231">         let alts = this.getRepPatterns(pattern,</span>
<a href="#l39.232"></a><span id="l39.232">                                        [&quot;(\\d{1,2}&quot; + this.marker + this.hourlyNumbers + &quot;)&quot;]);</span>
<a href="#l39.233"></a><span id="l39.233">         let res;</span>
<a href="#l39.234"></a><span id="l39.234">         for (let alt in alts) {</span>
<a href="#l39.235"></a><span id="l39.235">             let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l39.236"></a><span id="l39.236">             let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l39.237"></a><span id="l39.237"> </span>
<a href="#l39.238"></a><span id="l39.238">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.239"></a><span id="l39.239" class="difflineat">@@ -597,17 +597,17 @@ Extractor.prototype = {</span>
<a href="#l39.240"></a><span id="l39.240">                         this.guess(null, null, null, hour, 0,</span>
<a href="#l39.241"></a><span id="l39.241">                                    rev.start, rev.end, rev.pattern, rev.relation, pattern, true);</span>
<a href="#l39.242"></a><span id="l39.242">                     }</span>
<a href="#l39.243"></a><span id="l39.243">                 }</span>
<a href="#l39.244"></a><span id="l39.244">             }</span>
<a href="#l39.245"></a><span id="l39.245">         }</span>
<a href="#l39.246"></a><span id="l39.246">     },</span>
<a href="#l39.247"></a><span id="l39.247"> </span>
<a href="#l39.248"></a><span id="l39.248" class="difflineminus">-    extractHalfHour: function extractHalfHour(pattern, relation, direction) {</span>
<a href="#l39.249"></a><span id="l39.249" class="difflineplus">+    extractHalfHour: function(pattern, relation, direction) {</span>
<a href="#l39.250"></a><span id="l39.250">         let alts = this.getRepPatterns(pattern,</span>
<a href="#l39.251"></a><span id="l39.251">                                        [&quot;(\\d{1,2}&quot; + this.marker + this.hourlyNumbers + &quot;)&quot;]);</span>
<a href="#l39.252"></a><span id="l39.252">         let res;</span>
<a href="#l39.253"></a><span id="l39.253">         for (let alt in alts) {</span>
<a href="#l39.254"></a><span id="l39.254">             let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l39.255"></a><span id="l39.255">             let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l39.256"></a><span id="l39.256"> </span>
<a href="#l39.257"></a><span id="l39.257">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineat">@@ -628,17 +628,17 @@ Extractor.prototype = {</span>
<a href="#l39.259"></a><span id="l39.259">                         this.guess(null, null, null, hour, 30,</span>
<a href="#l39.260"></a><span id="l39.260">                                    rev.start, rev.end, rev.pattern, rev.relation, pattern, true);</span>
<a href="#l39.261"></a><span id="l39.261">                     }</span>
<a href="#l39.262"></a><span id="l39.262">                 }</span>
<a href="#l39.263"></a><span id="l39.263">             }</span>
<a href="#l39.264"></a><span id="l39.264">         }</span>
<a href="#l39.265"></a><span id="l39.265">     },</span>
<a href="#l39.266"></a><span id="l39.266"> </span>
<a href="#l39.267"></a><span id="l39.267" class="difflineminus">-    extractHourMinutes: function extractHourMinutes(pattern, relation, meridiem) {</span>
<a href="#l39.268"></a><span id="l39.268" class="difflineplus">+    extractHourMinutes: function(pattern, relation, meridiem) {</span>
<a href="#l39.269"></a><span id="l39.269">         let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;, &quot;(\\d{2})&quot;]);</span>
<a href="#l39.270"></a><span id="l39.270">         let res;</span>
<a href="#l39.271"></a><span id="l39.271">         for (let alt in alts) {</span>
<a href="#l39.272"></a><span id="l39.272">             let positions = alts[alt].positions;</span>
<a href="#l39.273"></a><span id="l39.273">             let re = new RegExp(alts[alt].pattern, &quot;ig&quot;);</span>
<a href="#l39.274"></a><span id="l39.274"> </span>
<a href="#l39.275"></a><span id="l39.275">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.276"></a><span id="l39.276">                 if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l39.277"></a><span id="l39.277" class="difflineat">@@ -658,29 +658,29 @@ Extractor.prototype = {</span>
<a href="#l39.278"></a><span id="l39.278">                         this.guess(null, null, null, hour, minute,</span>
<a href="#l39.279"></a><span id="l39.279">                                    rev.start, rev.end, rev.pattern, rev.relation, pattern);</span>
<a href="#l39.280"></a><span id="l39.280">                     }</span>
<a href="#l39.281"></a><span id="l39.281">                 }</span>
<a href="#l39.282"></a><span id="l39.282">             }</span>
<a href="#l39.283"></a><span id="l39.283">         }</span>
<a href="#l39.284"></a><span id="l39.284">     },</span>
<a href="#l39.285"></a><span id="l39.285"> </span>
<a href="#l39.286"></a><span id="l39.286" class="difflineminus">-    extractTime: function extractTime(pattern, relation, hour, minute) {</span>
<a href="#l39.287"></a><span id="l39.287" class="difflineplus">+    extractTime: function(pattern, relation, hour, minute) {</span>
<a href="#l39.288"></a><span id="l39.288">         let re = new RegExp(this.getPatterns(pattern), &quot;ig&quot;);</span>
<a href="#l39.289"></a><span id="l39.289">         let res;</span>
<a href="#l39.290"></a><span id="l39.290">         if ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.291"></a><span id="l39.291">             if (!this.limitChars(res, this.email)) {</span>
<a href="#l39.292"></a><span id="l39.292">                 let rev = this.prefixSuffixStartEnd(res, relation, this.email);</span>
<a href="#l39.293"></a><span id="l39.293">                 this.guess(null, null, null, hour, minute,</span>
<a href="#l39.294"></a><span id="l39.294">                            rev.start, rev.end, rev.pattern, rev.relation, pattern);</span>
<a href="#l39.295"></a><span id="l39.295">             }</span>
<a href="#l39.296"></a><span id="l39.296">         }</span>
<a href="#l39.297"></a><span id="l39.297">     },</span>
<a href="#l39.298"></a><span id="l39.298"> </span>
<a href="#l39.299"></a><span id="l39.299" class="difflineminus">-    extractDuration: function extractDuration(pattern, unit) {</span>
<a href="#l39.300"></a><span id="l39.300" class="difflineplus">+    extractDuration: function(pattern, unit) {</span>
<a href="#l39.301"></a><span id="l39.301">         let alts = this.getRepPatterns(pattern,</span>
<a href="#l39.302"></a><span id="l39.302">                                        [&quot;(\\d{1,2}&quot; + this.marker + this.dailyNumbers + &quot;)&quot;]);</span>
<a href="#l39.303"></a><span id="l39.303">         let res;</span>
<a href="#l39.304"></a><span id="l39.304">         for (let alt in alts) {</span>
<a href="#l39.305"></a><span id="l39.305">             let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l39.306"></a><span id="l39.306">             let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l39.307"></a><span id="l39.307"> </span>
<a href="#l39.308"></a><span id="l39.308">             while ((res = re.exec(this.email)) != null) {</span>
<a href="#l39.309"></a><span id="l39.309" class="difflineat">@@ -695,17 +695,17 @@ Extractor.prototype = {</span>
<a href="#l39.310"></a><span id="l39.310">                     guess.relation = rev.relation;</span>
<a href="#l39.311"></a><span id="l39.311">                     guess.pattern = pattern;</span>
<a href="#l39.312"></a><span id="l39.312">                     this.collected.push(guess);</span>
<a href="#l39.313"></a><span id="l39.313">                 }</span>
<a href="#l39.314"></a><span id="l39.314">             }</span>
<a href="#l39.315"></a><span id="l39.315">         }</span>
<a href="#l39.316"></a><span id="l39.316">     },</span>
<a href="#l39.317"></a><span id="l39.317"> </span>
<a href="#l39.318"></a><span id="l39.318" class="difflineminus">-    markContained: function markContained() {</span>
<a href="#l39.319"></a><span id="l39.319" class="difflineplus">+    markContained: function() {</span>
<a href="#l39.320"></a><span id="l39.320">         for (let outer = 0; outer &lt; this.collected.length; outer++) {</span>
<a href="#l39.321"></a><span id="l39.321">             for (let inner = 0; inner &lt; this.collected.length; inner++) {</span>
<a href="#l39.322"></a><span id="l39.322">                 // included but not exactly the same</span>
<a href="#l39.323"></a><span id="l39.323">                 if (outer != inner &amp;&amp;</span>
<a href="#l39.324"></a><span id="l39.324">                     this.collected[outer].start &amp;&amp; this.collected[outer].end &amp;&amp;</span>
<a href="#l39.325"></a><span id="l39.325">                     this.collected[inner].start &amp;&amp; this.collected[inner].end &amp;&amp;</span>
<a href="#l39.326"></a><span id="l39.326">                     this.collected[inner].start &gt;= this.collected[outer].start &amp;&amp;</span>
<a href="#l39.327"></a><span id="l39.327">                     this.collected[inner].end &lt;= this.collected[outer].end &amp;&amp;</span>
<a href="#l39.328"></a><span id="l39.328" class="difflineat">@@ -713,17 +713,17 @@ Extractor.prototype = {</span>
<a href="#l39.329"></a><span id="l39.329">                         this.collected[inner].end == this.collected[outer].end)) {</span>
<a href="#l39.330"></a><span id="l39.330">                         cal.LOG(&quot;[calExtract] &quot; + this.collected[outer].str + &quot; found as well, disgarding &quot; + this.collected[inner].str);</span>
<a href="#l39.331"></a><span id="l39.331">                         this.collected[inner].relation = &quot;notadatetime&quot;;</span>
<a href="#l39.332"></a><span id="l39.332">                 }</span>
<a href="#l39.333"></a><span id="l39.333">             }</span>
<a href="#l39.334"></a><span id="l39.334">         }</span>
<a href="#l39.335"></a><span id="l39.335">     },</span>
<a href="#l39.336"></a><span id="l39.336"> </span>
<a href="#l39.337"></a><span id="l39.337" class="difflineminus">-    markSelected: function markSelected(sel, title) {</span>
<a href="#l39.338"></a><span id="l39.338" class="difflineplus">+    markSelected: function(sel, title) {</span>
<a href="#l39.339"></a><span id="l39.339">         if (sel.rangeCount &gt; 0) {</span>
<a href="#l39.340"></a><span id="l39.340">             // mark the ones to not use</span>
<a href="#l39.341"></a><span id="l39.341">             for (let i = 0; i &lt; sel.rangeCount; i++) {</span>
<a href="#l39.342"></a><span id="l39.342">                 cal.LOG(&quot;[calExtract] Selection &quot; + i + &quot; is &quot; + sel);</span>
<a href="#l39.343"></a><span id="l39.343">                 for (let j = 0; j &lt; this.collected.length; j++) {</span>
<a href="#l39.344"></a><span id="l39.344">                     let selection = sel.getRangeAt(i).toString();</span>
<a href="#l39.345"></a><span id="l39.345"> </span>
<a href="#l39.346"></a><span id="l39.346">                     if (!selection.includes(this.collected[j].str) &amp;&amp;</span>
<a href="#l39.347"></a><span id="l39.347" class="difflineat">@@ -732,17 +732,17 @@ Extractor.prototype = {</span>
<a href="#l39.348"></a><span id="l39.348">                         cal.LOG(&quot;[calExtract] Marking &quot; + JSON.stringify(this.collected[j]) + &quot; as notadatetime&quot;);</span>
<a href="#l39.349"></a><span id="l39.349">                         this.collected[j].relation = &quot;notadatetime&quot;;</span>
<a href="#l39.350"></a><span id="l39.350">                     }</span>
<a href="#l39.351"></a><span id="l39.351">                 }</span>
<a href="#l39.352"></a><span id="l39.352">             }</span>
<a href="#l39.353"></a><span id="l39.353">         }</span>
<a href="#l39.354"></a><span id="l39.354">     },</span>
<a href="#l39.355"></a><span id="l39.355"> </span>
<a href="#l39.356"></a><span id="l39.356" class="difflineminus">-    sort: function sort(one, two) {</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineplus">+    sort: function(one, two) {</span>
<a href="#l39.358"></a><span id="l39.358">         let rc;</span>
<a href="#l39.359"></a><span id="l39.359">         // sort the guess from email date as the last one</span>
<a href="#l39.360"></a><span id="l39.360">         if (one.start == null &amp;&amp; two.start != null) {</span>
<a href="#l39.361"></a><span id="l39.361">             return 1;</span>
<a href="#l39.362"></a><span id="l39.362">         } else if (one.start != null &amp;&amp; two.start == null) {</span>
<a href="#l39.363"></a><span id="l39.363">             return -1;</span>
<a href="#l39.364"></a><span id="l39.364">         } else if (one.start == null &amp;&amp; two.start == null) {</span>
<a href="#l39.365"></a><span id="l39.365">             return 0;</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineat">@@ -776,17 +776,17 @@ Extractor.prototype = {</span>
<a href="#l39.367"></a><span id="l39.367">     },</span>
<a href="#l39.368"></a><span id="l39.368"> </span>
<a href="#l39.369"></a><span id="l39.369">     /**</span>
<a href="#l39.370"></a><span id="l39.370">     * Guesses start time from list of guessed datetimes</span>
<a href="#l39.371"></a><span id="l39.371">     *</span>
<a href="#l39.372"></a><span id="l39.372">     * @param isTask    whether start time should be guessed for task or event</span>
<a href="#l39.373"></a><span id="l39.373">     * @return          datetime object for start time</span>
<a href="#l39.374"></a><span id="l39.374">     */</span>
<a href="#l39.375"></a><span id="l39.375" class="difflineminus">-    guessStart: function guessStart(isTask) {</span>
<a href="#l39.376"></a><span id="l39.376" class="difflineplus">+    guessStart: function(isTask) {</span>
<a href="#l39.377"></a><span id="l39.377">         let startTimes = this.collected.filter(val =&gt; val.relation == &quot;start&quot;);</span>
<a href="#l39.378"></a><span id="l39.378">         if (startTimes.length == 0) {</span>
<a href="#l39.379"></a><span id="l39.379">             return {};</span>
<a href="#l39.380"></a><span id="l39.380">         }</span>
<a href="#l39.381"></a><span id="l39.381"> </span>
<a href="#l39.382"></a><span id="l39.382">         for (let val in startTimes) {</span>
<a href="#l39.383"></a><span id="l39.383">             cal.LOG(&quot;[calExtract] Start: &quot; + JSON.stringify(startTimes[val]));</span>
<a href="#l39.384"></a><span id="l39.384">         }</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineat">@@ -851,17 +851,17 @@ Extractor.prototype = {</span>
<a href="#l39.386"></a><span id="l39.386"> </span>
<a href="#l39.387"></a><span id="l39.387">     /**</span>
<a href="#l39.388"></a><span id="l39.388">     * Guesses end time from list of guessed datetimes relative to start time</span>
<a href="#l39.389"></a><span id="l39.389">     *</span>
<a href="#l39.390"></a><span id="l39.390">     * @param start     start time to consider when guessing</span>
<a href="#l39.391"></a><span id="l39.391">     * @param isTask    whether start time should be guessed for task or event</span>
<a href="#l39.392"></a><span id="l39.392">     * @return          datetime object for end time</span>
<a href="#l39.393"></a><span id="l39.393">     */</span>
<a href="#l39.394"></a><span id="l39.394" class="difflineminus">-    guessEnd: function guessEnd(start, isTask) {</span>
<a href="#l39.395"></a><span id="l39.395" class="difflineplus">+    guessEnd: function(start, isTask) {</span>
<a href="#l39.396"></a><span id="l39.396">         let guess = {};</span>
<a href="#l39.397"></a><span id="l39.397">         let endTimes = this.collected.filter(val =&gt; val.relation == &quot;end&quot;);</span>
<a href="#l39.398"></a><span id="l39.398">         let durations = this.collected.filter(val =&gt; val.relation == &quot;duration&quot;);</span>
<a href="#l39.399"></a><span id="l39.399">         if (endTimes.length == 0 &amp;&amp; durations.length == 0) {</span>
<a href="#l39.400"></a><span id="l39.400">             return {};</span>
<a href="#l39.401"></a><span id="l39.401">         } else {</span>
<a href="#l39.402"></a><span id="l39.402">             for (let val in endTimes) {</span>
<a href="#l39.403"></a><span id="l39.403">                 cal.LOG(&quot;[calExtract] End: &quot; + JSON.stringify(endTimes[val]));</span>
<a href="#l39.404"></a><span id="l39.404" class="difflineat">@@ -975,17 +975,17 @@ Extractor.prototype = {</span>
<a href="#l39.405"></a><span id="l39.405">                 guess.minute = 0;</span>
<a href="#l39.406"></a><span id="l39.406">             }</span>
<a href="#l39.407"></a><span id="l39.407"> </span>
<a href="#l39.408"></a><span id="l39.408">             cal.LOG(&quot;[calExtract] End picked: &quot; + JSON.stringify(guess));</span>
<a href="#l39.409"></a><span id="l39.409">             return guess;</span>
<a href="#l39.410"></a><span id="l39.410">         }</span>
<a href="#l39.411"></a><span id="l39.411">     },</span>
<a href="#l39.412"></a><span id="l39.412"> </span>
<a href="#l39.413"></a><span id="l39.413" class="difflineminus">-    getPatterns: function getPatterns(name) {</span>
<a href="#l39.414"></a><span id="l39.414" class="difflineplus">+    getPatterns: function(name) {</span>
<a href="#l39.415"></a><span id="l39.415">         let value;</span>
<a href="#l39.416"></a><span id="l39.416">         try {</span>
<a href="#l39.417"></a><span id="l39.417">             value = this.bundle.GetStringFromName(name);</span>
<a href="#l39.418"></a><span id="l39.418">             if (value.trim() == &quot;&quot;) {</span>
<a href="#l39.419"></a><span id="l39.419">                 cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l39.420"></a><span id="l39.420">                 return this.defPattern;</span>
<a href="#l39.421"></a><span id="l39.421">             }</span>
<a href="#l39.422"></a><span id="l39.422"> </span>
<a href="#l39.423"></a><span id="l39.423" class="difflineat">@@ -1026,17 +1026,17 @@ Extractor.prototype = {</span>
<a href="#l39.424"></a><span id="l39.424">         } catch (ex) {</span>
<a href="#l39.425"></a><span id="l39.425">             cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l39.426"></a><span id="l39.426"> </span>
<a href="#l39.427"></a><span id="l39.427">             // fake a value to avoid empty regexes creating endless loops</span>
<a href="#l39.428"></a><span id="l39.428">             return this.defPattern;</span>
<a href="#l39.429"></a><span id="l39.429">         }</span>
<a href="#l39.430"></a><span id="l39.430">     },</span>
<a href="#l39.431"></a><span id="l39.431"> </span>
<a href="#l39.432"></a><span id="l39.432" class="difflineminus">-    getRepPatterns: function getRepPatterns(name, replaceables) {</span>
<a href="#l39.433"></a><span id="l39.433" class="difflineplus">+    getRepPatterns: function(name, replaceables) {</span>
<a href="#l39.434"></a><span id="l39.434">         let alts = [];</span>
<a href="#l39.435"></a><span id="l39.435">         let patterns = [];</span>
<a href="#l39.436"></a><span id="l39.436"> </span>
<a href="#l39.437"></a><span id="l39.437">         try {</span>
<a href="#l39.438"></a><span id="l39.438">             let value = this.bundle.GetStringFromName(name);</span>
<a href="#l39.439"></a><span id="l39.439">             if (value.trim() == &quot;&quot;) {</span>
<a href="#l39.440"></a><span id="l39.440">                 cal.LOG(&quot;[calExtract] Pattern empty: &quot; + name);</span>
<a href="#l39.441"></a><span id="l39.441">                 return alts;</span>
<a href="#l39.442"></a><span id="l39.442" class="difflineat">@@ -1093,17 +1093,17 @@ Extractor.prototype = {</span>
<a href="#l39.443"></a><span id="l39.443">                 alts[val] = { pattern: patterns[val], positions: positions };</span>
<a href="#l39.444"></a><span id="l39.444">             }</span>
<a href="#l39.445"></a><span id="l39.445">         } catch (ex) {</span>
<a href="#l39.446"></a><span id="l39.446">             cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l39.447"></a><span id="l39.447">         }</span>
<a href="#l39.448"></a><span id="l39.448">         return alts;</span>
<a href="#l39.449"></a><span id="l39.449">     },</span>
<a href="#l39.450"></a><span id="l39.450"> </span>
<a href="#l39.451"></a><span id="l39.451" class="difflineminus">-    getPositionsFor: function getPositionsFor(s, name, count) {</span>
<a href="#l39.452"></a><span id="l39.452" class="difflineplus">+    getPositionsFor: function(s, name, count) {</span>
<a href="#l39.453"></a><span id="l39.453">         let positions = [];</span>
<a href="#l39.454"></a><span id="l39.454">         let re = /#(\d)/g;</span>
<a href="#l39.455"></a><span id="l39.455">         let match;</span>
<a href="#l39.456"></a><span id="l39.456">         let i = 0;</span>
<a href="#l39.457"></a><span id="l39.457">         while ((match = re.exec(s))) {</span>
<a href="#l39.458"></a><span id="l39.458">             i++;</span>
<a href="#l39.459"></a><span id="l39.459">             positions[parseInt(match[1], 10)] = i;</span>
<a href="#l39.460"></a><span id="l39.460">         }</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineat">@@ -1113,95 +1113,95 @@ Extractor.prototype = {</span>
<a href="#l39.462"></a><span id="l39.462">             if (positions[i] === undefined) {</span>
<a href="#l39.463"></a><span id="l39.463">                 Components.utils.reportError(&quot;[calExtract] Faulty extraction pattern &quot; + name +</span>
<a href="#l39.464"></a><span id="l39.464">                                              &quot;, missing parameter #&quot; + i);</span>
<a href="#l39.465"></a><span id="l39.465">             }</span>
<a href="#l39.466"></a><span id="l39.466">         }</span>
<a href="#l39.467"></a><span id="l39.467">         return positions;</span>
<a href="#l39.468"></a><span id="l39.468">     },</span>
<a href="#l39.469"></a><span id="l39.469"> </span>
<a href="#l39.470"></a><span id="l39.470" class="difflineminus">-    cleanPatterns: function cleanPatterns(pattern) {</span>
<a href="#l39.471"></a><span id="l39.471" class="difflineplus">+    cleanPatterns: function(pattern) {</span>
<a href="#l39.472"></a><span id="l39.472">         // remove whitespace around | if present</span>
<a href="#l39.473"></a><span id="l39.473">         let value = pattern.replace(/\s*\|\s*/g, &quot;|&quot;);</span>
<a href="#l39.474"></a><span id="l39.474">         // allow matching for patterns with missing or excessive whitespace</span>
<a href="#l39.475"></a><span id="l39.475">         return this.sanitize(value).replace(/\s+/g, &quot;\\s*&quot;);</span>
<a href="#l39.476"></a><span id="l39.476">     },</span>
<a href="#l39.477"></a><span id="l39.477"> </span>
<a href="#l39.478"></a><span id="l39.478" class="difflineminus">-    isValidYear: function isValidYear(year) {</span>
<a href="#l39.479"></a><span id="l39.479" class="difflineplus">+    isValidYear: function(year) {</span>
<a href="#l39.480"></a><span id="l39.480">         return (year &gt;= 2000 &amp;&amp; year &lt;= 2050);</span>
<a href="#l39.481"></a><span id="l39.481">     },</span>
<a href="#l39.482"></a><span id="l39.482"> </span>
<a href="#l39.483"></a><span id="l39.483" class="difflineminus">-    isValidMonth: function isValidMonth(month) {</span>
<a href="#l39.484"></a><span id="l39.484" class="difflineplus">+    isValidMonth: function(month) {</span>
<a href="#l39.485"></a><span id="l39.485">         return (month &gt;= 1 &amp;&amp; month &lt;= 12);</span>
<a href="#l39.486"></a><span id="l39.486">     },</span>
<a href="#l39.487"></a><span id="l39.487"> </span>
<a href="#l39.488"></a><span id="l39.488" class="difflineminus">-    isValidDay: function isValidDay(day) {</span>
<a href="#l39.489"></a><span id="l39.489" class="difflineplus">+    isValidDay: function(day) {</span>
<a href="#l39.490"></a><span id="l39.490">         return (day &gt;= 1 &amp;&amp; day &lt;= 31);</span>
<a href="#l39.491"></a><span id="l39.491">     },</span>
<a href="#l39.492"></a><span id="l39.492"> </span>
<a href="#l39.493"></a><span id="l39.493" class="difflineminus">-    isValidHour: function isValidHour(hour) {</span>
<a href="#l39.494"></a><span id="l39.494" class="difflineplus">+    isValidHour: function(hour) {</span>
<a href="#l39.495"></a><span id="l39.495">         return (hour &gt;= 0 &amp;&amp; hour &lt;= 23);</span>
<a href="#l39.496"></a><span id="l39.496">     },</span>
<a href="#l39.497"></a><span id="l39.497"> </span>
<a href="#l39.498"></a><span id="l39.498" class="difflineminus">-    isValidMinute: function isValidMinute(minute) {</span>
<a href="#l39.499"></a><span id="l39.499" class="difflineplus">+    isValidMinute: function(minute) {</span>
<a href="#l39.500"></a><span id="l39.500">         return (minute &gt;= 0 &amp;&amp; minute &lt;= 59);</span>
<a href="#l39.501"></a><span id="l39.501">     },</span>
<a href="#l39.502"></a><span id="l39.502"> </span>
<a href="#l39.503"></a><span id="l39.503" class="difflineminus">-    isPastDate: function isPastDate(date, referenceDate) {</span>
<a href="#l39.504"></a><span id="l39.504" class="difflineplus">+    isPastDate: function(date, referenceDate) {</span>
<a href="#l39.505"></a><span id="l39.505">         // avoid changing original refDate</span>
<a href="#l39.506"></a><span id="l39.506">         let refDate = new Date(referenceDate.getTime());</span>
<a href="#l39.507"></a><span id="l39.507">         refDate.setHours(0);</span>
<a href="#l39.508"></a><span id="l39.508">         refDate.setMinutes(0);</span>
<a href="#l39.509"></a><span id="l39.509">         refDate.setSeconds(0);</span>
<a href="#l39.510"></a><span id="l39.510">         refDate.setMilliseconds(0);</span>
<a href="#l39.511"></a><span id="l39.511">         let jsDate;</span>
<a href="#l39.512"></a><span id="l39.512">         if (date.day != null) {</span>
<a href="#l39.513"></a><span id="l39.513">             jsDate = new Date(date.year, date.month - 1, date.day);</span>
<a href="#l39.514"></a><span id="l39.514">         }</span>
<a href="#l39.515"></a><span id="l39.515">         return jsDate &lt; refDate;</span>
<a href="#l39.516"></a><span id="l39.516">     },</span>
<a href="#l39.517"></a><span id="l39.517"> </span>
<a href="#l39.518"></a><span id="l39.518" class="difflineminus">-    normalizeHour: function normalizeHour(hour) {</span>
<a href="#l39.519"></a><span id="l39.519" class="difflineplus">+    normalizeHour: function(hour) {</span>
<a href="#l39.520"></a><span id="l39.520">         if (hour &lt; this.dayStart &amp;&amp; hour &lt;= 11) {</span>
<a href="#l39.521"></a><span id="l39.521">             return hour + 12;</span>
<a href="#l39.522"></a><span id="l39.522">         }</span>
<a href="#l39.523"></a><span id="l39.523">         return hour;</span>
<a href="#l39.524"></a><span id="l39.524">     },</span>
<a href="#l39.525"></a><span id="l39.525"> </span>
<a href="#l39.526"></a><span id="l39.526" class="difflineminus">-    normalizeYear: function normalizeYear(year) {</span>
<a href="#l39.527"></a><span id="l39.527" class="difflineplus">+    normalizeYear: function(year) {</span>
<a href="#l39.528"></a><span id="l39.528">         return (year.length == 2) ? &quot;20&quot; + year : year;</span>
<a href="#l39.529"></a><span id="l39.529">     },</span>
<a href="#l39.530"></a><span id="l39.530"> </span>
<a href="#l39.531"></a><span id="l39.531" class="difflineminus">-    limitNums: function limitNums(res, email) {</span>
<a href="#l39.532"></a><span id="l39.532" class="difflineplus">+    limitNums: function(res, email) {</span>
<a href="#l39.533"></a><span id="l39.533">         let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l39.534"></a><span id="l39.534">         let before = email.charAt(res.index - 1);</span>
<a href="#l39.535"></a><span id="l39.535">         let after = email.charAt(res.index + res[0].length);</span>
<a href="#l39.536"></a><span id="l39.536">         let result = (/\d/.exec(before) &amp;&amp; /\d/.exec(pattern.charAt(0))) ||</span>
<a href="#l39.537"></a><span id="l39.537">                      (/\d/.exec(pattern.charAt(pattern.length - 1)) &amp;&amp; /\d/.exec(after));</span>
<a href="#l39.538"></a><span id="l39.538">         return result != null;</span>
<a href="#l39.539"></a><span id="l39.539">     },</span>
<a href="#l39.540"></a><span id="l39.540"> </span>
<a href="#l39.541"></a><span id="l39.541" class="difflineminus">-    limitChars: function limitChars(res, email) {</span>
<a href="#l39.542"></a><span id="l39.542" class="difflineplus">+    limitChars: function(res, email) {</span>
<a href="#l39.543"></a><span id="l39.543">         let alphabet = this.getPatterns(&quot;alphabet&quot;);</span>
<a href="#l39.544"></a><span id="l39.544">         // for languages without regular alphabet surrounding characters are ignored</span>
<a href="#l39.545"></a><span id="l39.545">         if (alphabet == this.defPattern) {</span>
<a href="#l39.546"></a><span id="l39.546">             return false;</span>
<a href="#l39.547"></a><span id="l39.547">         }</span>
<a href="#l39.548"></a><span id="l39.548"> </span>
<a href="#l39.549"></a><span id="l39.549">         let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l39.550"></a><span id="l39.550">         let before = email.charAt(res.index - 1);</span>
<a href="#l39.551"></a><span id="l39.551">         let after = email.charAt(res.index + res[0].length);</span>
<a href="#l39.552"></a><span id="l39.552"> </span>
<a href="#l39.553"></a><span id="l39.553">         let w = new RegExp(&quot;[&quot; + alphabet + &quot;]&quot;);</span>
<a href="#l39.554"></a><span id="l39.554">         let result = (w.exec(before) &amp;&amp; w.exec(pattern.charAt(0))) ||</span>
<a href="#l39.555"></a><span id="l39.555">                      (w.exec(pattern.charAt(pattern.length - 1)) &amp;&amp; w.exec(after));</span>
<a href="#l39.556"></a><span id="l39.556">         return result != null;</span>
<a href="#l39.557"></a><span id="l39.557">     },</span>
<a href="#l39.558"></a><span id="l39.558"> </span>
<a href="#l39.559"></a><span id="l39.559" class="difflineminus">-    prefixSuffixStartEnd: function prefixSuffixStart(res, relation, email) {</span>
<a href="#l39.560"></a><span id="l39.560" class="difflineplus">+    prefixSuffixStartEnd: function(res, relation, email) {</span>
<a href="#l39.561"></a><span id="l39.561">         let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l39.562"></a><span id="l39.562">         let prev = email.substring(0, res.index);</span>
<a href="#l39.563"></a><span id="l39.563">         let next = email.substring(res.index + res[0].length);</span>
<a href="#l39.564"></a><span id="l39.564">         let prefixSuffix = { start: res.index, end: res.index + res[0].length,</span>
<a href="#l39.565"></a><span id="l39.565">                              pattern: pattern, relation: relation };</span>
<a href="#l39.566"></a><span id="l39.566">         let ch = &quot;\\s*&quot;;</span>
<a href="#l39.567"></a><span id="l39.567">         let psres;</span>
<a href="#l39.568"></a><span id="l39.568"> </span>
<a href="#l39.569"></a><span id="l39.569" class="difflineat">@@ -1242,17 +1242,17 @@ Extractor.prototype = {</span>
<a href="#l39.570"></a><span id="l39.570">         re = new RegExp(&quot;^&quot; + ch + &quot;(&quot; + this.getPatterns(&quot;no.datetime.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l39.571"></a><span id="l39.571">         if ((psres = re.exec(next)) != null) {</span>
<a href="#l39.572"></a><span id="l39.572">             prefixSuffix.relation = &quot;notadatetime&quot;;</span>
<a href="#l39.573"></a><span id="l39.573">         }</span>
<a href="#l39.574"></a><span id="l39.574"> </span>
<a href="#l39.575"></a><span id="l39.575">         return prefixSuffix;</span>
<a href="#l39.576"></a><span id="l39.576">     },</span>
<a href="#l39.577"></a><span id="l39.577"> </span>
<a href="#l39.578"></a><span id="l39.578" class="difflineminus">-    parseNumber: function parseNumber(number, numbers) {</span>
<a href="#l39.579"></a><span id="l39.579" class="difflineplus">+    parseNumber: function(number, numbers) {</span>
<a href="#l39.580"></a><span id="l39.580">         let r = parseInt(number, 10);</span>
<a href="#l39.581"></a><span id="l39.581">         // number comes in as plain text, numbers are already adjusted for usage</span>
<a href="#l39.582"></a><span id="l39.582">         // in regular expression</span>
<a href="#l39.583"></a><span id="l39.583">         number = this.cleanPatterns(number);</span>
<a href="#l39.584"></a><span id="l39.584">         if (isNaN(r)) {</span>
<a href="#l39.585"></a><span id="l39.585">             for (let i = 0; i &lt;= 31; i++) {</span>
<a href="#l39.586"></a><span id="l39.586">                 let ns = numbers[i].split(&quot;|&quot;);</span>
<a href="#l39.587"></a><span id="l39.587">                 if (ns.includes(number.toLowerCase())) {</span>
<a href="#l39.588"></a><span id="l39.588" class="difflineat">@@ -1260,18 +1260,18 @@ Extractor.prototype = {</span>
<a href="#l39.589"></a><span id="l39.589">                 }</span>
<a href="#l39.590"></a><span id="l39.590">             }</span>
<a href="#l39.591"></a><span id="l39.591">             return -1;</span>
<a href="#l39.592"></a><span id="l39.592">         } else {</span>
<a href="#l39.593"></a><span id="l39.593">             return r;</span>
<a href="#l39.594"></a><span id="l39.594">         }</span>
<a href="#l39.595"></a><span id="l39.595">     },</span>
<a href="#l39.596"></a><span id="l39.596"> </span>
<a href="#l39.597"></a><span id="l39.597" class="difflineminus">-    guess: function guess(year, month, day, hour, minute, start, end, str,</span>
<a href="#l39.598"></a><span id="l39.598" class="difflineminus">-                          relation, pattern, ambiguous) {</span>
<a href="#l39.599"></a><span id="l39.599" class="difflineplus">+    guess: function(year, month, day, hour, minute, start, end, str,</span>
<a href="#l39.600"></a><span id="l39.600" class="difflineplus">+                    relation, pattern, ambiguous) {</span>
<a href="#l39.601"></a><span id="l39.601">         let dateGuess = {</span>
<a href="#l39.602"></a><span id="l39.602">             year: year, month: month, day: day, hour: hour, minute: minute,</span>
<a href="#l39.603"></a><span id="l39.603">             start: start, end: end, str: str, relation: relation,</span>
<a href="#l39.604"></a><span id="l39.604">             pattern: pattern, ambiguous: ambiguous</span>
<a href="#l39.605"></a><span id="l39.605">         };</span>
<a href="#l39.606"></a><span id="l39.606">         // past dates are kept for containment checks</span>
<a href="#l39.607"></a><span id="l39.607">         if (this.isPastDate(dateGuess, this.now)) {</span>
<a href="#l39.608"></a><span id="l39.608">             guess.relation = &quot;notadatetime&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/modules/calHashedArray.jsm</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/modules/calHashedArray.jsm</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -11,17 +11,17 @@ var EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even </span>
<a href="#l40.4"></a><span id="l40.4">  * retrieve the item by its hash id.</span>
<a href="#l40.5"></a><span id="l40.5">  *</span>
<a href="#l40.6"></a><span id="l40.6">  * Performance Considerations:</span>
<a href="#l40.7"></a><span id="l40.7">  *  - Accessing items is fast</span>
<a href="#l40.8"></a><span id="l40.8">  *  - Adding items is fast (they are added to the end)</span>
<a href="#l40.9"></a><span id="l40.9">  *  - Deleting items is O(n)</span>
<a href="#l40.10"></a><span id="l40.10">  *  - Modifying items is fast.</span>
<a href="#l40.11"></a><span id="l40.11">  */</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-cal.HashedArray = function HashedArray() {</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+cal.HashedArray = function() {</span>
<a href="#l40.14"></a><span id="l40.14">     this.clear();</span>
<a href="#l40.15"></a><span id="l40.15"> };</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17"> cal.HashedArray.prototype = {</span>
<a href="#l40.18"></a><span id="l40.18">     mArray: null,</span>
<a href="#l40.19"></a><span id="l40.19">     mHash: null,</span>
<a href="#l40.20"></a><span id="l40.20"> </span>
<a href="#l40.21"></a><span id="l40.21">     mBatch: 0,</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineat">@@ -47,106 +47,106 @@ cal.HashedArray.prototype = {</span>
<a href="#l40.23"></a><span id="l40.23">     },</span>
<a href="#l40.24"></a><span id="l40.24"> </span>
<a href="#l40.25"></a><span id="l40.25">     /**</span>
<a href="#l40.26"></a><span id="l40.26">      * Returns the item, given its index in the array</span>
<a href="#l40.27"></a><span id="l40.27">      *</span>
<a href="#l40.28"></a><span id="l40.28">      * @param index         The index of the item to retrieve.</span>
<a href="#l40.29"></a><span id="l40.29">      * @return              The retrieved item.</span>
<a href="#l40.30"></a><span id="l40.30">      */</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-    itemByIndex: function itemByIndex(index) {</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+    itemByIndex: function(index) {</span>
<a href="#l40.33"></a><span id="l40.33">         return this.mArray[index];</span>
<a href="#l40.34"></a><span id="l40.34">     },</span>
<a href="#l40.35"></a><span id="l40.35"> </span>
<a href="#l40.36"></a><span id="l40.36">     /**</span>
<a href="#l40.37"></a><span id="l40.37">      * Returns the item, given its hashId</span>
<a href="#l40.38"></a><span id="l40.38">      *</span>
<a href="#l40.39"></a><span id="l40.39">      * @param id            The hashId of the item to retrieve.</span>
<a href="#l40.40"></a><span id="l40.40">      * @return              The retrieved item.</span>
<a href="#l40.41"></a><span id="l40.41">      */</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-    itemById: function itemById(id) {</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+    itemById: function(id) {</span>
<a href="#l40.44"></a><span id="l40.44">         if (this.mBatch &gt; 0) {</span>
<a href="#l40.45"></a><span id="l40.45">             throw &quot;Accessing Array by ID not supported in batch mode &quot;;</span>
<a href="#l40.46"></a><span id="l40.46">         }</span>
<a href="#l40.47"></a><span id="l40.47">         return (id in this.mHash ? this.mArray[this.mHash[id]] : null);</span>
<a href="#l40.48"></a><span id="l40.48">     },</span>
<a href="#l40.49"></a><span id="l40.49"> </span>
<a href="#l40.50"></a><span id="l40.50">     /**</span>
<a href="#l40.51"></a><span id="l40.51">      * Returns the index of the given item. This function is cheap performance</span>
<a href="#l40.52"></a><span id="l40.52">      * wise, since it uses the hash</span>
<a href="#l40.53"></a><span id="l40.53">      *</span>
<a href="#l40.54"></a><span id="l40.54">      * @param item          The item to search for.</span>
<a href="#l40.55"></a><span id="l40.55">      * @return              The index of the item.</span>
<a href="#l40.56"></a><span id="l40.56">      */</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineminus">-    indexOf: function indexOf(item) {</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+    indexOf: function(item) {</span>
<a href="#l40.59"></a><span id="l40.59">         if (this.mBatch &gt; 0) {</span>
<a href="#l40.60"></a><span id="l40.60">             throw &quot;Accessing Array Indexes not supported in batch mode&quot;;</span>
<a href="#l40.61"></a><span id="l40.61">         }</span>
<a href="#l40.62"></a><span id="l40.62">         let hashId = this.hashAccessor(item);</span>
<a href="#l40.63"></a><span id="l40.63">         return (hashId in this.mHash ? this.mHash[hashId] : -1);</span>
<a href="#l40.64"></a><span id="l40.64">     },</span>
<a href="#l40.65"></a><span id="l40.65"> </span>
<a href="#l40.66"></a><span id="l40.66">     /**</span>
<a href="#l40.67"></a><span id="l40.67">      * Remove the item with the given hashId.</span>
<a href="#l40.68"></a><span id="l40.68">      *</span>
<a href="#l40.69"></a><span id="l40.69">      * @param id            The id of the item to be removed</span>
<a href="#l40.70"></a><span id="l40.70">      */</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">-    removeById: function removeById(id) {</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+    removeById: function(id) {</span>
<a href="#l40.73"></a><span id="l40.73">         if (this.mBatch &gt; 0) {</span>
<a href="#l40.74"></a><span id="l40.74">             throw &quot;Remvoing by ID in batch mode is not supported&quot;; /* TODO */</span>
<a href="#l40.75"></a><span id="l40.75">         }</span>
<a href="#l40.76"></a><span id="l40.76">         let index = this.mHash[id];</span>
<a href="#l40.77"></a><span id="l40.77">         delete this.mHash[id];</span>
<a href="#l40.78"></a><span id="l40.78">         this.mArray.splice(index, 1);</span>
<a href="#l40.79"></a><span id="l40.79">         this.reindex(index);</span>
<a href="#l40.80"></a><span id="l40.80">     },</span>
<a href="#l40.81"></a><span id="l40.81"> </span>
<a href="#l40.82"></a><span id="l40.82">     /**</span>
<a href="#l40.83"></a><span id="l40.83">      * Remove the item at the given index.</span>
<a href="#l40.84"></a><span id="l40.84">      *</span>
<a href="#l40.85"></a><span id="l40.85">      * @param index         The index of the item to remove.</span>
<a href="#l40.86"></a><span id="l40.86">      */</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineminus">-    removeByIndex: function removeByIndex(index) {</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineplus">+    removeByIndex: function(index) {</span>
<a href="#l40.89"></a><span id="l40.89">         delete this.mHash[this.hashAccessor(this.mArray[index])];</span>
<a href="#l40.90"></a><span id="l40.90">         this.mArray.splice(index, 1);</span>
<a href="#l40.91"></a><span id="l40.91">         this.reindex(index);</span>
<a href="#l40.92"></a><span id="l40.92">     },</span>
<a href="#l40.93"></a><span id="l40.93"> </span>
<a href="#l40.94"></a><span id="l40.94">     /**</span>
<a href="#l40.95"></a><span id="l40.95">      * Clear the whole array, removing all items. This also resets batch mode.</span>
<a href="#l40.96"></a><span id="l40.96">      */</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineminus">-     clear: function clear() {</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+     clear: function() {</span>
<a href="#l40.99"></a><span id="l40.99">         this.mHash = {};</span>
<a href="#l40.100"></a><span id="l40.100">         this.mArray = [];</span>
<a href="#l40.101"></a><span id="l40.101">         this.mFirstDirty = -1;</span>
<a href="#l40.102"></a><span id="l40.102">         this.mBatch = 0;</span>
<a href="#l40.103"></a><span id="l40.103">      },</span>
<a href="#l40.104"></a><span id="l40.104"> </span>
<a href="#l40.105"></a><span id="l40.105">     /**</span>
<a href="#l40.106"></a><span id="l40.106">      * Add the item to the array</span>
<a href="#l40.107"></a><span id="l40.107">      *</span>
<a href="#l40.108"></a><span id="l40.108">      * @param item          The item to add.</span>
<a href="#l40.109"></a><span id="l40.109">      * @return              The index of the added item.</span>
<a href="#l40.110"></a><span id="l40.110">      */</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineminus">-    addItem: function addItem(item) {</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+    addItem: function(item) {</span>
<a href="#l40.113"></a><span id="l40.113">         let index = this.mArray.length;</span>
<a href="#l40.114"></a><span id="l40.114">         this.mArray.push(item);</span>
<a href="#l40.115"></a><span id="l40.115">         this.reindex(index);</span>
<a href="#l40.116"></a><span id="l40.116">         return index;</span>
<a href="#l40.117"></a><span id="l40.117">     },</span>
<a href="#l40.118"></a><span id="l40.118"> </span>
<a href="#l40.119"></a><span id="l40.119">     /**</span>
<a href="#l40.120"></a><span id="l40.120">      * Modifies the item in the array. If the item is already in the array, then</span>
<a href="#l40.121"></a><span id="l40.121">      * it is replaced by the passed item. Otherwise, the item is added to the</span>
<a href="#l40.122"></a><span id="l40.122">      * array.</span>
<a href="#l40.123"></a><span id="l40.123">      *</span>
<a href="#l40.124"></a><span id="l40.124">      * @param item          The item to modify.</span>
<a href="#l40.125"></a><span id="l40.125">      * @return              The (new) index.</span>
<a href="#l40.126"></a><span id="l40.126">      */</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-    modifyItem: function modifyItem(item) {</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+    modifyItem: function(item) {</span>
<a href="#l40.129"></a><span id="l40.129">         let hashId = this.hashAccessor(item);</span>
<a href="#l40.130"></a><span id="l40.130">         if (hashId in this.mHash) {</span>
<a href="#l40.131"></a><span id="l40.131">             let index = this.mHash[this.hashAccessor(item)];</span>
<a href="#l40.132"></a><span id="l40.132">             this.mArray[index] = item;</span>
<a href="#l40.133"></a><span id="l40.133">             return index;</span>
<a href="#l40.134"></a><span id="l40.134">         } else {</span>
<a href="#l40.135"></a><span id="l40.135">             return this.addItem(item);</span>
<a href="#l40.136"></a><span id="l40.136">         }</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineat">@@ -157,17 +157,17 @@ cal.HashedArray.prototype = {</span>
<a href="#l40.138"></a><span id="l40.138">      * internally. All parameters are inclusive. The ranges are automatically</span>
<a href="#l40.139"></a><span id="l40.139">      * swapped if from &gt; to.</span>
<a href="#l40.140"></a><span id="l40.140">      *</span>
<a href="#l40.141"></a><span id="l40.141">      * @param from      (optional) The index to start indexing from. If left</span>
<a href="#l40.142"></a><span id="l40.142">      *                    out, defaults to 0.</span>
<a href="#l40.143"></a><span id="l40.143">      * @param to        (optional) The index to end indexing on. If left out,</span>
<a href="#l40.144"></a><span id="l40.144">      *                    defaults to the array length.</span>
<a href="#l40.145"></a><span id="l40.145">      */</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineminus">-    reindex: function reindex(from, to) {</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+    reindex: function(from, to) {</span>
<a href="#l40.148"></a><span id="l40.148">         if (this.mArray.length == 0) {</span>
<a href="#l40.149"></a><span id="l40.149">             return;</span>
<a href="#l40.150"></a><span id="l40.150">         }</span>
<a href="#l40.151"></a><span id="l40.151"> </span>
<a href="#l40.152"></a><span id="l40.152">         from = (from === undefined ? 0 : from);</span>
<a href="#l40.153"></a><span id="l40.153">         to = (to === undefined ? this.mArray.length - 1 : to);</span>
<a href="#l40.154"></a><span id="l40.154"> </span>
<a href="#l40.155"></a><span id="l40.155">         from = Math.min(this.mArray.length - 1, Math.max(0, from));</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineat">@@ -185,65 +185,65 @@ cal.HashedArray.prototype = {</span>
<a href="#l40.157"></a><span id="l40.157">             return;</span>
<a href="#l40.158"></a><span id="l40.158">         }</span>
<a href="#l40.159"></a><span id="l40.159"> </span>
<a href="#l40.160"></a><span id="l40.160">         for (let idx = from; idx &lt;= to; idx++) {</span>
<a href="#l40.161"></a><span id="l40.161">             this.mHash[this.hashAccessor(this.mArray[idx])] = idx;</span>
<a href="#l40.162"></a><span id="l40.162">         }</span>
<a href="#l40.163"></a><span id="l40.163">     },</span>
<a href="#l40.164"></a><span id="l40.164"> </span>
<a href="#l40.165"></a><span id="l40.165" class="difflineminus">-    startBatch: function startBatch() {</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+    startBatch: function() {</span>
<a href="#l40.167"></a><span id="l40.167">         this.mBatch++;</span>
<a href="#l40.168"></a><span id="l40.168">     },</span>
<a href="#l40.169"></a><span id="l40.169"> </span>
<a href="#l40.170"></a><span id="l40.170" class="difflineminus">-    endBatch: function endBatch() {</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineplus">+    endBatch: function() {</span>
<a href="#l40.172"></a><span id="l40.172">         this.mBatch = Math.max(0, this.mBatch - 1);</span>
<a href="#l40.173"></a><span id="l40.173"> </span>
<a href="#l40.174"></a><span id="l40.174">         if (this.mBatch == 0 &amp;&amp; this.mFirstDirty &gt; -1) {</span>
<a href="#l40.175"></a><span id="l40.175">             this.reindex(this.mFirstDirty);</span>
<a href="#l40.176"></a><span id="l40.176">             this.mFirstDirty = -1;</span>
<a href="#l40.177"></a><span id="l40.177">         }</span>
<a href="#l40.178"></a><span id="l40.178">     },</span>
<a href="#l40.179"></a><span id="l40.179"> </span>
<a href="#l40.180"></a><span id="l40.180">     /**</span>
<a href="#l40.181"></a><span id="l40.181">      * Iterator to allow iterating the hashed array object.</span>
<a href="#l40.182"></a><span id="l40.182">      */</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineminus">-    [Symbol.iterator]: function* iterator() {</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineplus">+    [Symbol.iterator]: function* () {</span>
<a href="#l40.185"></a><span id="l40.185">         yield* this.mArray;</span>
<a href="#l40.186"></a><span id="l40.186">     }</span>
<a href="#l40.187"></a><span id="l40.187"> };</span>
<a href="#l40.188"></a><span id="l40.188"> </span>
<a href="#l40.189"></a><span id="l40.189"> /**</span>
<a href="#l40.190"></a><span id="l40.190">  * Sorted hashed array. The array always stays sorted.</span>
<a href="#l40.191"></a><span id="l40.191">  *</span>
<a href="#l40.192"></a><span id="l40.192">  * Performance Considerations:</span>
<a href="#l40.193"></a><span id="l40.193">  *  - Accessing items is fast</span>
<a href="#l40.194"></a><span id="l40.194">  *  - Adding and deleting items is O(n)</span>
<a href="#l40.195"></a><span id="l40.195">  *  - Modifying items is fast.</span>
<a href="#l40.196"></a><span id="l40.196">  */</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineminus">-cal.SortedHashedArray = function SortedHashedArray(comparator) {</span>
<a href="#l40.198"></a><span id="l40.198" class="difflineplus">+cal.SortedHashedArray = function(comparator) {</span>
<a href="#l40.199"></a><span id="l40.199">     cal.HashedArray.apply(this, arguments);</span>
<a href="#l40.200"></a><span id="l40.200">     if (!comparator) {</span>
<a href="#l40.201"></a><span id="l40.201">         throw &quot;Sorted Hashed Array needs a comparator&quot;;</span>
<a href="#l40.202"></a><span id="l40.202">     }</span>
<a href="#l40.203"></a><span id="l40.203">     this.mCompFunc = comparator;</span>
<a href="#l40.204"></a><span id="l40.204"> };</span>
<a href="#l40.205"></a><span id="l40.205"> </span>
<a href="#l40.206"></a><span id="l40.206"> cal.SortedHashedArray.prototype = {</span>
<a href="#l40.207"></a><span id="l40.207">     __proto__: cal.HashedArray.prototype,</span>
<a href="#l40.208"></a><span id="l40.208"> </span>
<a href="#l40.209"></a><span id="l40.209">     mCompFunc: null,</span>
<a href="#l40.210"></a><span id="l40.210"> </span>
<a href="#l40.211"></a><span id="l40.211" class="difflineminus">-    addItem: function addItem(item) {</span>
<a href="#l40.212"></a><span id="l40.212" class="difflineplus">+    addItem: function(item) {</span>
<a href="#l40.213"></a><span id="l40.213">         let newIndex = cal.binaryInsert(this.mArray, item, this.mCompFunc, false);</span>
<a href="#l40.214"></a><span id="l40.214">         this.reindex(newIndex);</span>
<a href="#l40.215"></a><span id="l40.215">         return newIndex;</span>
<a href="#l40.216"></a><span id="l40.216">     },</span>
<a href="#l40.217"></a><span id="l40.217"> </span>
<a href="#l40.218"></a><span id="l40.218" class="difflineminus">-    modifyItem: function modifyItem(item) {</span>
<a href="#l40.219"></a><span id="l40.219" class="difflineplus">+    modifyItem: function(item) {</span>
<a href="#l40.220"></a><span id="l40.220">         let hashId = this.hashAccessor(item);</span>
<a href="#l40.221"></a><span id="l40.221">         if (hashId in this.mHash) {</span>
<a href="#l40.222"></a><span id="l40.222">             let cmp = this.mCompFunc(item, this.mArray[this.mHash[hashId]]);</span>
<a href="#l40.223"></a><span id="l40.223">             if (cmp == 0) {</span>
<a href="#l40.224"></a><span id="l40.224">                 // The item will be at the same index, we just need to replace it</span>
<a href="#l40.225"></a><span id="l40.225">                 this.mArray[this.mHash[hashId]] = item;</span>
<a href="#l40.226"></a><span id="l40.226">                 return this.mHash[hashId];</span>
<a href="#l40.227"></a><span id="l40.227">             } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/modules/calItemUtils.jsm</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/modules/calItemUtils.jsm</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -39,64 +39,64 @@ itemDiff.prototype = {</span>
<a href="#l41.4"></a><span id="l41.4">     mDeletedItems: null,</span>
<a href="#l41.5"></a><span id="l41.5"> </span>
<a href="#l41.6"></a><span id="l41.6">     /**</span>
<a href="#l41.7"></a><span id="l41.7">      * Expect the difference engine to be in the given state.</span>
<a href="#l41.8"></a><span id="l41.8">      *</span>
<a href="#l41.9"></a><span id="l41.9">      * @param aState    The state to be in</span>
<a href="#l41.10"></a><span id="l41.10">      * @param aMethod   The method name expecting the state</span>
<a href="#l41.11"></a><span id="l41.11">      */</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-    _expectState: function _expectState(aState, aMethod) {</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+    _expectState: function(aState, aMethod) {</span>
<a href="#l41.14"></a><span id="l41.14">         if ((this.state &amp; aState) == 0) {</span>
<a href="#l41.15"></a><span id="l41.15">             throw new Error(&quot;itemDiff method &quot; + aMethod +</span>
<a href="#l41.16"></a><span id="l41.16">                             &quot; called while in unexpected state &quot; + this.state);</span>
<a href="#l41.17"></a><span id="l41.17">         }</span>
<a href="#l41.18"></a><span id="l41.18">     },</span>
<a href="#l41.19"></a><span id="l41.19"> </span>
<a href="#l41.20"></a><span id="l41.20">     /**</span>
<a href="#l41.21"></a><span id="l41.21">      * Load the difference engine with one item, see load.</span>
<a href="#l41.22"></a><span id="l41.22">      *</span>
<a href="#l41.23"></a><span id="l41.23">      * @param item      The item to load</span>
<a href="#l41.24"></a><span id="l41.24">      */</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-    load1: function load1(item) {</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+    load1: function(item) {</span>
<a href="#l41.27"></a><span id="l41.27">         this.load([item]);</span>
<a href="#l41.28"></a><span id="l41.28">     },</span>
<a href="#l41.29"></a><span id="l41.29"> </span>
<a href="#l41.30"></a><span id="l41.30">     /**</span>
<a href="#l41.31"></a><span id="l41.31">      * Loads an array of items. This step cannot be executed</span>
<a href="#l41.32"></a><span id="l41.32">      * after calling the difference methods.</span>
<a href="#l41.33"></a><span id="l41.33">      *</span>
<a href="#l41.34"></a><span id="l41.34">      * @param items     The array of items to load</span>
<a href="#l41.35"></a><span id="l41.35">      */</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-    load: function load(items) {</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+    load: function(items) {</span>
<a href="#l41.38"></a><span id="l41.38">         this._expectState(this.STATE_INITIAL | this.STATE_LOADING, &quot;load&quot;);</span>
<a href="#l41.39"></a><span id="l41.39"> </span>
<a href="#l41.40"></a><span id="l41.40">         for (let item of items) {</span>
<a href="#l41.41"></a><span id="l41.41">             this.mInitialItems[item.hashId] = item;</span>
<a href="#l41.42"></a><span id="l41.42">         }</span>
<a href="#l41.43"></a><span id="l41.43"> </span>
<a href="#l41.44"></a><span id="l41.44">         this.state = this.STATE_LOADING;</span>
<a href="#l41.45"></a><span id="l41.45">     },</span>
<a href="#l41.46"></a><span id="l41.46"> </span>
<a href="#l41.47"></a><span id="l41.47">     /**</span>
<a href="#l41.48"></a><span id="l41.48">      * Calculates the difference for the passed item, see difference.</span>
<a href="#l41.49"></a><span id="l41.49">      *</span>
<a href="#l41.50"></a><span id="l41.50">      * @param item      The item to calculate difference with</span>
<a href="#l41.51"></a><span id="l41.51">      */</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-    difference1: function difference1(item) {</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+    difference1: function(item) {</span>
<a href="#l41.54"></a><span id="l41.54">         this.difference([item]);</span>
<a href="#l41.55"></a><span id="l41.55">     },</span>
<a href="#l41.56"></a><span id="l41.56"> </span>
<a href="#l41.57"></a><span id="l41.57">     /**</span>
<a href="#l41.58"></a><span id="l41.58">      * Calculate the difference for the array of items. This method should be</span>
<a href="#l41.59"></a><span id="l41.59">      * called after all load methods and before the complete method.</span>
<a href="#l41.60"></a><span id="l41.60">      *</span>
<a href="#l41.61"></a><span id="l41.61">      * @param items     The array of items to calculate difference with</span>
<a href="#l41.62"></a><span id="l41.62">      */</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineminus">-    difference: function difference(items) {</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+    difference: function(items) {</span>
<a href="#l41.65"></a><span id="l41.65">         this._expectState(this.STATE_INITIAL | this.STATE_LOADING | this.STATE_DIFFERING, &quot;difference&quot;);</span>
<a href="#l41.66"></a><span id="l41.66"> </span>
<a href="#l41.67"></a><span id="l41.67">         this.mModifiedOldItems.startBatch();</span>
<a href="#l41.68"></a><span id="l41.68">         this.mModifiedItems.startBatch();</span>
<a href="#l41.69"></a><span id="l41.69">         this.mAddedItems.startBatch();</span>
<a href="#l41.70"></a><span id="l41.70"> </span>
<a href="#l41.71"></a><span id="l41.71">         for (let item of items) {</span>
<a href="#l41.72"></a><span id="l41.72">             if (item.hashId in this.mInitialItems) {</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineat">@@ -115,17 +115,17 @@ itemDiff.prototype = {</span>
<a href="#l41.74"></a><span id="l41.74"> </span>
<a href="#l41.75"></a><span id="l41.75">         this.state = this.STATE_DIFFERING;</span>
<a href="#l41.76"></a><span id="l41.76">     },</span>
<a href="#l41.77"></a><span id="l41.77"> </span>
<a href="#l41.78"></a><span id="l41.78">     /**</span>
<a href="#l41.79"></a><span id="l41.79">      * Tell the engine that all load and difference calls have been made, this</span>
<a href="#l41.80"></a><span id="l41.80">      * makes sure that all item states are correctly returned.</span>
<a href="#l41.81"></a><span id="l41.81">      */</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-    complete: function complete() {</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+    complete: function() {</span>
<a href="#l41.84"></a><span id="l41.84">         this._expectState(this.STATE_INITIAL | this.STATE_LOADING | this.STATE_DIFFERING, &quot;complete&quot;);</span>
<a href="#l41.85"></a><span id="l41.85"> </span>
<a href="#l41.86"></a><span id="l41.86">         this.mDeletedItems.startBatch();</span>
<a href="#l41.87"></a><span id="l41.87"> </span>
<a href="#l41.88"></a><span id="l41.88">         for (let hashId in this.mInitialItems) {</span>
<a href="#l41.89"></a><span id="l41.89">             let item = this.mInitialItems[hashId];</span>
<a href="#l41.90"></a><span id="l41.90">             this.mDeletedItems.addItem(item);</span>
<a href="#l41.91"></a><span id="l41.91">         }</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineat">@@ -163,17 +163,17 @@ itemDiff.prototype = {</span>
<a href="#l41.93"></a><span id="l41.93">     /** @return the number of loaded items */</span>
<a href="#l41.94"></a><span id="l41.94">     get count() {</span>
<a href="#l41.95"></a><span id="l41.95">         return Object.keys(this.mInitialItems).length;</span>
<a href="#l41.96"></a><span id="l41.96">     },</span>
<a href="#l41.97"></a><span id="l41.97"> </span>
<a href="#l41.98"></a><span id="l41.98">     /**</span>
<a href="#l41.99"></a><span id="l41.99">      * Resets the difference engine to its initial state.</span>
<a href="#l41.100"></a><span id="l41.100">      */</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-    reset: function reset() {</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+    reset: function() {</span>
<a href="#l41.103"></a><span id="l41.103">         this.mInitialItems = {};</span>
<a href="#l41.104"></a><span id="l41.104">         this.mModifiedItems = new cal.HashedArray();</span>
<a href="#l41.105"></a><span id="l41.105">         this.mModifiedOldItems = new cal.HashedArray();</span>
<a href="#l41.106"></a><span id="l41.106">         this.mAddedItems = new cal.HashedArray();</span>
<a href="#l41.107"></a><span id="l41.107">         this.mDeletedItems = new cal.HashedArray();</span>
<a href="#l41.108"></a><span id="l41.108">         this.state = this.STATE_INITIAL;</span>
<a href="#l41.109"></a><span id="l41.109">     }</span>
<a href="#l41.110"></a><span id="l41.110"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/modules/calIteratorUtils.jsm</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -9,17 +9,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l42.4"></a><span id="l42.4"> this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> /**</span>
<a href="#l42.7"></a><span id="l42.7">  * Iterates an array of items, i.e. the passed item including all</span>
<a href="#l42.8"></a><span id="l42.8">  * overridden instances of a recurring series.</span>
<a href="#l42.9"></a><span id="l42.9">  *</span>
<a href="#l42.10"></a><span id="l42.10">  * @param items array of items</span>
<a href="#l42.11"></a><span id="l42.11">  */</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-cal.itemIterator = function* cal_itemIterator(items) {</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+cal.itemIterator = function* (items) {</span>
<a href="#l42.14"></a><span id="l42.14">     for (let item of items) {</span>
<a href="#l42.15"></a><span id="l42.15">         yield item;</span>
<a href="#l42.16"></a><span id="l42.16">         let rec = item.recurrenceInfo;</span>
<a href="#l42.17"></a><span id="l42.17">         if (rec) {</span>
<a href="#l42.18"></a><span id="l42.18">             for (let exid of rec.getExceptionIds({})) {</span>
<a href="#l42.19"></a><span id="l42.19">                 yield rec.getExceptionFor(exid);</span>
<a href="#l42.20"></a><span id="l42.20">             }</span>
<a href="#l42.21"></a><span id="l42.21">         }</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -40,31 +40,31 @@ cal.itemIterator = function* cal_itemIte</span>
<a href="#l42.23"></a><span id="l42.23">  * for each loop, use the optional completed() function.</span>
<a href="#l42.24"></a><span id="l42.24">  *</span>
<a href="#l42.25"></a><span id="l42.25">  * @param iter          The Iterator or the plain Object to go through in this</span>
<a href="#l42.26"></a><span id="l42.26">  *                      loop.</span>
<a href="#l42.27"></a><span id="l42.27">  * @param body          The function called for each iteration. Its parameter is</span>
<a href="#l42.28"></a><span id="l42.28">  *                          the single item from the iterator.</span>
<a href="#l42.29"></a><span id="l42.29">  * @param completed     [optional] The function called after the loop completes.</span>
<a href="#l42.30"></a><span id="l42.30">  */</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-cal.forEach = function cal_forEach(iterable, body, completed) {</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+cal.forEach = function(iterable, body, completed) {</span>
<a href="#l42.33"></a><span id="l42.33">     // This should be a const one day, lets keep it a pref for now though until we</span>
<a href="#l42.34"></a><span id="l42.34">     // find a sane value.</span>
<a href="#l42.35"></a><span id="l42.35">     let LATENCY = Preferences.get(&quot;calendar.threading.latency&quot;, 250);</span>
<a href="#l42.36"></a><span id="l42.36"> </span>
<a href="#l42.37"></a><span id="l42.37">     if (typeof iterable == &quot;object&quot; &amp;&amp; !iterable[Symbol.iterator]) {</span>
<a href="#l42.38"></a><span id="l42.38">         iterable = Object.entries(iterable);</span>
<a href="#l42.39"></a><span id="l42.39">     }</span>
<a href="#l42.40"></a><span id="l42.40"> </span>
<a href="#l42.41"></a><span id="l42.41">     let ourIter = iterable[Symbol.iterator]();</span>
<a href="#l42.42"></a><span id="l42.42">     let currentThread = Services.tm.currentThread;</span>
<a href="#l42.43"></a><span id="l42.43"> </span>
<a href="#l42.44"></a><span id="l42.44">     // This is our dispatcher, it will be used for the iterations</span>
<a href="#l42.45"></a><span id="l42.45">     let dispatcher = {</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineminus">-        run: function run() {</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+        run: function() {</span>
<a href="#l42.48"></a><span id="l42.48">             let startTime = (new Date()).getTime();</span>
<a href="#l42.49"></a><span id="l42.49">             while (((new Date()).getTime() - startTime) &lt; LATENCY) {</span>
<a href="#l42.50"></a><span id="l42.50">                 let next = ourIter.next();</span>
<a href="#l42.51"></a><span id="l42.51">                 let done = next.done;</span>
<a href="#l42.52"></a><span id="l42.52"> </span>
<a href="#l42.53"></a><span id="l42.53">                 if (!done) {</span>
<a href="#l42.54"></a><span id="l42.54">                     let rc = body(next.value);</span>
<a href="#l42.55"></a><span id="l42.55">                     if (rc == cal.forEach.BREAK) {</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineat">@@ -106,17 +106,17 @@ cal.ical = {</span>
<a href="#l42.57"></a><span id="l42.57">      *</span>
<a href="#l42.58"></a><span id="l42.58">      * This iterator can only be used in a for..of block:</span>
<a href="#l42.59"></a><span id="l42.59">      *   for (let component of cal.ical.calendarComponentIterator(aComp)) { ... }</span>
<a href="#l42.60"></a><span id="l42.60">      *</span>
<a href="#l42.61"></a><span id="l42.61">      *  @param aComponent       The component to iterate given the above rules.</span>
<a href="#l42.62"></a><span id="l42.62">      *  @param aCompType        The type of item to iterate.</span>
<a href="#l42.63"></a><span id="l42.63">      *  @return                 The iterator that yields all items.</span>
<a href="#l42.64"></a><span id="l42.64">      */</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-    calendarComponentIterator: function* cal_ical_calendarComponentIterator(aComponent, aCompType) {</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+    calendarComponentIterator: function* (aComponent, aCompType) {</span>
<a href="#l42.67"></a><span id="l42.67">         let compType = (aCompType || &quot;ANY&quot;);</span>
<a href="#l42.68"></a><span id="l42.68">         if (aComponent &amp;&amp; aComponent.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l42.69"></a><span id="l42.69">             yield* cal.ical.subcomponentIterator(aComponent, compType);</span>
<a href="#l42.70"></a><span id="l42.70">         } else if (aComponent &amp;&amp; aComponent.componentType == &quot;XROOT&quot;) {</span>
<a href="#l42.71"></a><span id="l42.71">             for (let calComp of cal.ical.subcomponentIterator(aComponent, &quot;VCALENDAR&quot;)) {</span>
<a href="#l42.72"></a><span id="l42.72">                 yield* cal.ical.subcomponentIterator(calComp, compType);</span>
<a href="#l42.73"></a><span id="l42.73">             }</span>
<a href="#l42.74"></a><span id="l42.74">         } else if (aComponent &amp;&amp; (compType == &quot;ANY&quot; || compType == aComponent.componentType)) {</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineat">@@ -131,17 +131,17 @@ cal.ical = {</span>
<a href="#l42.76"></a><span id="l42.76">      * This iterator can only be used in a for() block:</span>
<a href="#l42.77"></a><span id="l42.77">      *   for (let component in cal.ical.subcomponentIterator(aComp)) { ... }</span>
<a href="#l42.78"></a><span id="l42.78">      *</span>
<a href="#l42.79"></a><span id="l42.79">      * @param aComponent        The component who's subcomponents to iterate.</span>
<a href="#l42.80"></a><span id="l42.80">      * @param aSubcomp          (optional) the specific subcomponent to</span>
<a href="#l42.81"></a><span id="l42.81">      *                            enumerate. If not given, &quot;ANY&quot; will be used.</span>
<a href="#l42.82"></a><span id="l42.82">      * @return                  An iterator object to iterate the properties.</span>
<a href="#l42.83"></a><span id="l42.83">      */</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-    subcomponentIterator: function* cal_ical_subcomponentIterator(aComponent, aSubcomp) {</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+    subcomponentIterator: function* (aComponent, aSubcomp) {</span>
<a href="#l42.86"></a><span id="l42.86">         let subcompName = (aSubcomp || &quot;ANY&quot;);</span>
<a href="#l42.87"></a><span id="l42.87">         for (let subcomp = aComponent.getFirstSubcomponent(subcompName);</span>
<a href="#l42.88"></a><span id="l42.88">              subcomp;</span>
<a href="#l42.89"></a><span id="l42.89">              subcomp = aComponent.getNextSubcomponent(subcompName)) {</span>
<a href="#l42.90"></a><span id="l42.90">             yield subcomp;</span>
<a href="#l42.91"></a><span id="l42.91">         }</span>
<a href="#l42.92"></a><span id="l42.92">     },</span>
<a href="#l42.93"></a><span id="l42.93"> </span>
<a href="#l42.94"></a><span id="l42.94" class="difflineat">@@ -150,17 +150,17 @@ cal.ical = {</span>
<a href="#l42.95"></a><span id="l42.95">      * This iterator can only be used in a for() block:</span>
<a href="#l42.96"></a><span id="l42.96">      *   for (let property in cal.ical.propertyIterator(aComp)) { ... }</span>
<a href="#l42.97"></a><span id="l42.97">      *</span>
<a href="#l42.98"></a><span id="l42.98">      * @param aComponent        The component to iterate.</span>
<a href="#l42.99"></a><span id="l42.99">      * @param aProperty         (optional) the specific property to enumerate.</span>
<a href="#l42.100"></a><span id="l42.100">      *                            If not given, &quot;ANY&quot; will be used.</span>
<a href="#l42.101"></a><span id="l42.101">      * @return                  An iterator object to iterate the properties.</span>
<a href="#l42.102"></a><span id="l42.102">      */</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-    propertyIterator: function* cal_ical_propertyIterator(aComponent, aProperty) {</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+    propertyIterator: function* (aComponent, aProperty) {</span>
<a href="#l42.105"></a><span id="l42.105">         let propertyName = (aProperty || &quot;ANY&quot;);</span>
<a href="#l42.106"></a><span id="l42.106">         for (let prop = aComponent.getFirstProperty(propertyName);</span>
<a href="#l42.107"></a><span id="l42.107">              prop;</span>
<a href="#l42.108"></a><span id="l42.108">              prop = aComponent.getNextProperty(propertyName)) {</span>
<a href="#l42.109"></a><span id="l42.109">             yield prop;</span>
<a href="#l42.110"></a><span id="l42.110">         }</span>
<a href="#l42.111"></a><span id="l42.111">     },</span>
<a href="#l42.112"></a><span id="l42.112"> </span>
<a href="#l42.113"></a><span id="l42.113" class="difflineat">@@ -169,17 +169,17 @@ cal.ical = {</span>
<a href="#l42.114"></a><span id="l42.114">      * This iterator behaves similar to the object iterator. Possible uses:</span>
<a href="#l42.115"></a><span id="l42.115">      *   for (let paramName in cal.ical.paramIterator(prop)) { ... }</span>
<a href="#l42.116"></a><span id="l42.116">      * or:</span>
<a href="#l42.117"></a><span id="l42.117">      *   for (let [paramName, paramValue] of cal.ical.paramIterator(prop)) { ... }</span>
<a href="#l42.118"></a><span id="l42.118">      *</span>
<a href="#l42.119"></a><span id="l42.119">      * @param aProperty         The property to iterate.</span>
<a href="#l42.120"></a><span id="l42.120">      * @return                  An iterator object to iterate the properties.</span>
<a href="#l42.121"></a><span id="l42.121">      */</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineminus">-    paramIterator: function* cal_ical_paramIterator(aProperty) {</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    paramIterator: function* (aProperty) {</span>
<a href="#l42.124"></a><span id="l42.124">         let paramSet = new Set();</span>
<a href="#l42.125"></a><span id="l42.125">         for (let paramName = aProperty.getFirstParameterName();</span>
<a href="#l42.126"></a><span id="l42.126">              paramName;</span>
<a href="#l42.127"></a><span id="l42.127">              paramName = aProperty.getNextParameterName()) {</span>
<a href="#l42.128"></a><span id="l42.128">             // Workaround to avoid infinite loop when the property</span>
<a href="#l42.129"></a><span id="l42.129">             // contains duplicate parameters (bug 875739 for libical)</span>
<a href="#l42.130"></a><span id="l42.130">             if (!paramSet.has(paramName)) {</span>
<a href="#l42.131"></a><span id="l42.131">                 yield [paramName, aProperty.getParameter(paramName)];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -14,17 +14,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l43.4"></a><span id="l43.4">  */</span>
<a href="#l43.5"></a><span id="l43.5"> this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l43.6"></a><span id="l43.6"> cal.itip = {</span>
<a href="#l43.7"></a><span id="l43.7">     /**</span>
<a href="#l43.8"></a><span id="l43.8">      * Gets the sequence/revision number, either of the passed item or</span>
<a href="#l43.9"></a><span id="l43.9">      * the last received one of an attendee; see</span>
<a href="#l43.10"></a><span id="l43.10">      * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.1&gt;.</span>
<a href="#l43.11"></a><span id="l43.11">      */</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-     getSequence: function cal_itip_getSequence(item) {</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+     getSequence: function(item) {</span>
<a href="#l43.14"></a><span id="l43.14">         let seq = null;</span>
<a href="#l43.15"></a><span id="l43.15"> </span>
<a href="#l43.16"></a><span id="l43.16">         let wrappedItem = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l43.17"></a><span id="l43.17">         if (wrappedItem) {</span>
<a href="#l43.18"></a><span id="l43.18">             seq = wrappedItem.getProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l43.19"></a><span id="l43.19">         } else if (item) {</span>
<a href="#l43.20"></a><span id="l43.20">             // Unless the below is standardized, we store the last original</span>
<a href="#l43.21"></a><span id="l43.21">             // REQUEST/PUBLISH SEQUENCE in X-MOZ-RECEIVED-SEQUENCE to test against it</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineat">@@ -49,17 +49,17 @@ cal.itip = {</span>
<a href="#l43.23"></a><span id="l43.23">         }</span>
<a href="#l43.24"></a><span id="l43.24">     },</span>
<a href="#l43.25"></a><span id="l43.25"> </span>
<a href="#l43.26"></a><span id="l43.26">     /**</span>
<a href="#l43.27"></a><span id="l43.27">      * Gets the stamp date-time, either of the passed item or</span>
<a href="#l43.28"></a><span id="l43.28">      * the last received one of an attendee; see</span>
<a href="#l43.29"></a><span id="l43.29">      * &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.2&gt;.</span>
<a href="#l43.30"></a><span id="l43.30">      */</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-    getStamp: function cal_itip_getStamp(item) {</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+    getStamp: function(item) {</span>
<a href="#l43.33"></a><span id="l43.33">         let dtstamp = null;</span>
<a href="#l43.34"></a><span id="l43.34"> </span>
<a href="#l43.35"></a><span id="l43.35">         let wrappedItem = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l43.36"></a><span id="l43.36">         if (wrappedItem) {</span>
<a href="#l43.37"></a><span id="l43.37">             let st = wrappedItem.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l43.38"></a><span id="l43.38">             if (st) {</span>
<a href="#l43.39"></a><span id="l43.39">                 dtstamp = cal.createDateTime(st);</span>
<a href="#l43.40"></a><span id="l43.40">             }</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineat">@@ -77,17 +77,17 @@ cal.itip = {</span>
<a href="#l43.42"></a><span id="l43.42">         }</span>
<a href="#l43.43"></a><span id="l43.43"> </span>
<a href="#l43.44"></a><span id="l43.44">         return dtstamp;</span>
<a href="#l43.45"></a><span id="l43.45">     },</span>
<a href="#l43.46"></a><span id="l43.46"> </span>
<a href="#l43.47"></a><span id="l43.47">     /**</span>
<a href="#l43.48"></a><span id="l43.48">      * Compares sequences and/or stamps of two parties; returns -1, 0, +1.</span>
<a href="#l43.49"></a><span id="l43.49">      */</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-    compare: function cal_itip_compare(item1, item2) {</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+    compare: function(item1, item2) {</span>
<a href="#l43.52"></a><span id="l43.52">         let seq1 = cal.itip.getSequence(item1);</span>
<a href="#l43.53"></a><span id="l43.53">         let seq2 = cal.itip.getSequence(item2);</span>
<a href="#l43.54"></a><span id="l43.54">         if (seq1 &gt; seq2) {</span>
<a href="#l43.55"></a><span id="l43.55">             return 1;</span>
<a href="#l43.56"></a><span id="l43.56">         } else if (seq1 &lt; seq2) {</span>
<a href="#l43.57"></a><span id="l43.57">             return -1;</span>
<a href="#l43.58"></a><span id="l43.58">         } else {</span>
<a href="#l43.59"></a><span id="l43.59">             let st1 = cal.itip.getStamp(item1);</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineat">@@ -106,32 +106,32 @@ cal.itip = {</span>
<a href="#l43.61"></a><span id="l43.61"> </span>
<a href="#l43.62"></a><span id="l43.62">     /**</span>
<a href="#l43.63"></a><span id="l43.63">      * Checks if the given calendar is a scheduling calendar. This means it</span>
<a href="#l43.64"></a><span id="l43.64">      * needs an organizer id and an itip transport. It should also be writable.</span>
<a href="#l43.65"></a><span id="l43.65">      *</span>
<a href="#l43.66"></a><span id="l43.66">      * @param calendar    The calendar to check</span>
<a href="#l43.67"></a><span id="l43.67">      * @return            True, if its a scheduling calendar.</span>
<a href="#l43.68"></a><span id="l43.68">      */</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineminus">-    isSchedulingCalendar: function isSchedulingCalendar(calendar) {</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+    isSchedulingCalendar: function(calendar) {</span>
<a href="#l43.71"></a><span id="l43.71">         return cal.isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l43.72"></a><span id="l43.72">                calendar.getProperty(&quot;organizerId&quot;) &amp;&amp;</span>
<a href="#l43.73"></a><span id="l43.73">                calendar.getProperty(&quot;itip.transport&quot;);</span>
<a href="#l43.74"></a><span id="l43.74">     },</span>
<a href="#l43.75"></a><span id="l43.75"> </span>
<a href="#l43.76"></a><span id="l43.76">     /**</span>
<a href="#l43.77"></a><span id="l43.77">      * Scope: iTIP message receiver</span>
<a href="#l43.78"></a><span id="l43.78">      *</span>
<a href="#l43.79"></a><span id="l43.79">      * Given an nsIMsgDBHdr and an imipMethod, set up the given itip item.</span>
<a href="#l43.80"></a><span id="l43.80">      *</span>
<a href="#l43.81"></a><span id="l43.81">      * @param itipItem    The item to set up</span>
<a href="#l43.82"></a><span id="l43.82">      * @param imipMethod  The received imip method</span>
<a href="#l43.83"></a><span id="l43.83">      * @param aMsgHdr     Information about the received email</span>
<a href="#l43.84"></a><span id="l43.84">      */</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineminus">-    initItemFromMsgData: function initItemFromMsgData(itipItem, imipMethod, aMsgHdr) {</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+    initItemFromMsgData: function(itipItem, imipMethod, aMsgHdr) {</span>
<a href="#l43.87"></a><span id="l43.87">         // Get the recipient identity and save it with the itip item.</span>
<a href="#l43.88"></a><span id="l43.88">         itipItem.identity = cal.itip.getMessageRecipient(aMsgHdr);</span>
<a href="#l43.89"></a><span id="l43.89"> </span>
<a href="#l43.90"></a><span id="l43.90">         // We are only called upon receipt of an invite, so ensure that isSend</span>
<a href="#l43.91"></a><span id="l43.91">         // is false.</span>
<a href="#l43.92"></a><span id="l43.92">         itipItem.isSend = false;</span>
<a href="#l43.93"></a><span id="l43.93"> </span>
<a href="#l43.94"></a><span id="l43.94">         // XXX Get these from preferences</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineat">@@ -165,17 +165,17 @@ cal.itip = {</span>
<a href="#l43.96"></a><span id="l43.96">      *</span>
<a href="#l43.97"></a><span id="l43.97">      * Gets the suggested text to be shown when an imip item has been processed.</span>
<a href="#l43.98"></a><span id="l43.98">      * This text is ready localized and can be displayed to the user.</span>
<a href="#l43.99"></a><span id="l43.99">      *</span>
<a href="#l43.100"></a><span id="l43.100">      * @param aStatus         The status of the processing (i.e NS_OK, an error code)</span>
<a href="#l43.101"></a><span id="l43.101">      * @param aOperationType  An operation type from calIOperationListener</span>
<a href="#l43.102"></a><span id="l43.102">      * @return                The suggested text.</span>
<a href="#l43.103"></a><span id="l43.103">      */</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineminus">-    getCompleteText: function getCompleteText(aStatus, aOperationType) {</span>
<a href="#l43.105"></a><span id="l43.105" class="difflineplus">+    getCompleteText: function(aStatus, aOperationType) {</span>
<a href="#l43.106"></a><span id="l43.106">         function _gs(strName, param) {</span>
<a href="#l43.107"></a><span id="l43.107">             return cal.calGetString(&quot;lightning&quot;, strName, param, &quot;lightning&quot;);</span>
<a href="#l43.108"></a><span id="l43.108">         }</span>
<a href="#l43.109"></a><span id="l43.109"> </span>
<a href="#l43.110"></a><span id="l43.110">         let text = &quot;&quot;;</span>
<a href="#l43.111"></a><span id="l43.111">         const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l43.112"></a><span id="l43.112">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l43.113"></a><span id="l43.113">             switch (aOperationType) {</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineat">@@ -193,17 +193,17 @@ cal.itip = {</span>
<a href="#l43.115"></a><span id="l43.115">      * Scope: iTIP message receiver</span>
<a href="#l43.116"></a><span id="l43.116">      *</span>
<a href="#l43.117"></a><span id="l43.117">      * Gets a text describing the given itip method. The text is of the form</span>
<a href="#l43.118"></a><span id="l43.118">      * &quot;This Message contains a ... &quot;.</span>
<a href="#l43.119"></a><span id="l43.119">      *</span>
<a href="#l43.120"></a><span id="l43.120">      * @param method      The method to describe.</span>
<a href="#l43.121"></a><span id="l43.121">      * @return            The localized text about the method.</span>
<a href="#l43.122"></a><span id="l43.122">      */</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineminus">-    getMethodText: function getMethodtext(method) {</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+    getMethodText: function(method) {</span>
<a href="#l43.125"></a><span id="l43.125">         function _gs(strName) {</span>
<a href="#l43.126"></a><span id="l43.126">             return cal.calGetString(&quot;lightning&quot;, strName, null, &quot;lightning&quot;);</span>
<a href="#l43.127"></a><span id="l43.127">         }</span>
<a href="#l43.128"></a><span id="l43.128"> </span>
<a href="#l43.129"></a><span id="l43.129">         switch (method) {</span>
<a href="#l43.130"></a><span id="l43.130">             case &quot;REFRESH&quot;: return _gs(&quot;imipBarRefreshText&quot;);</span>
<a href="#l43.131"></a><span id="l43.131">             case &quot;REQUEST&quot;: return _gs(&quot;imipBarRequestText&quot;);</span>
<a href="#l43.132"></a><span id="l43.132">             case &quot;PUBLISH&quot;: return _gs(&quot;imipBarPublishText&quot;);</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineat">@@ -227,17 +227,17 @@ cal.itip = {</span>
<a href="#l43.134"></a><span id="l43.134">      *    hideMenuItem: [&quot;imipXXXButton_Option&quot;, ...]</span>
<a href="#l43.135"></a><span id="l43.135">      * }</span>
<a href="#l43.136"></a><span id="l43.136">      *</span>
<a href="#l43.137"></a><span id="l43.137">      * @see processItipItem   This takes the same parameters as its optionFunc.</span>
<a href="#l43.138"></a><span id="l43.138">      * @param itipItem        The itipItem to query.</span>
<a href="#l43.139"></a><span id="l43.139">      * @param rc              The result of retrieving the item</span>
<a href="#l43.140"></a><span id="l43.140">      * @param actionFunc      The action function.</span>
<a href="#l43.141"></a><span id="l43.141">      */</span>
<a href="#l43.142"></a><span id="l43.142" class="difflineminus">-    getOptionsText: function getOptionsText(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l43.143"></a><span id="l43.143" class="difflineplus">+    getOptionsText: function(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l43.144"></a><span id="l43.144">         function _gs(strName) {</span>
<a href="#l43.145"></a><span id="l43.145">             return cal.calGetString(&quot;lightning&quot;, strName, null, &quot;lightning&quot;);</span>
<a href="#l43.146"></a><span id="l43.146">         }</span>
<a href="#l43.147"></a><span id="l43.147">         let imipLabel = null;</span>
<a href="#l43.148"></a><span id="l43.148">         if (itipItem.receivedMethod) {</span>
<a href="#l43.149"></a><span id="l43.149">             imipLabel = cal.itip.getMethodText(itipItem.receivedMethod);</span>
<a href="#l43.150"></a><span id="l43.150">         }</span>
<a href="#l43.151"></a><span id="l43.151">         let data = { label: imipLabel, buttons: [], hideMenuItems: [] };</span>
<a href="#l43.152"></a><span id="l43.152" class="difflineat">@@ -333,17 +333,17 @@ cal.itip = {</span>
<a href="#l43.153"></a><span id="l43.153">     /**</span>
<a href="#l43.154"></a><span id="l43.154">      * Scope: iTIP message receiver</span>
<a href="#l43.155"></a><span id="l43.155">      *</span>
<a href="#l43.156"></a><span id="l43.156">      * Retrieves the intended recipient for this message.</span>
<a href="#l43.157"></a><span id="l43.157">      *</span>
<a href="#l43.158"></a><span id="l43.158">      * @param aMsgHdr     The message to check.</span>
<a href="#l43.159"></a><span id="l43.159">      * @return            The email of the intended recipient.</span>
<a href="#l43.160"></a><span id="l43.160">      */</span>
<a href="#l43.161"></a><span id="l43.161" class="difflineminus">-    getMessageRecipient: function getMessageRecipient(aMsgHdr) {</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineplus">+    getMessageRecipient: function(aMsgHdr) {</span>
<a href="#l43.163"></a><span id="l43.163">         if (!aMsgHdr) {</span>
<a href="#l43.164"></a><span id="l43.164">             return null;</span>
<a href="#l43.165"></a><span id="l43.165">         }</span>
<a href="#l43.166"></a><span id="l43.166"> </span>
<a href="#l43.167"></a><span id="l43.167">         let identities;</span>
<a href="#l43.168"></a><span id="l43.168">         let actMgr = MailServices.accounts;</span>
<a href="#l43.169"></a><span id="l43.169">         if (aMsgHdr.accountKey) {</span>
<a href="#l43.170"></a><span id="l43.170">             // First, check if the message has an account key. If so, we can use the</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineat">@@ -409,17 +409,17 @@ cal.itip = {</span>
<a href="#l43.172"></a><span id="l43.172">      * calendar will be set on the passed itip item.</span>
<a href="#l43.173"></a><span id="l43.173">      *</span>
<a href="#l43.174"></a><span id="l43.174">      * @param aMethod       The method to check.</span>
<a href="#l43.175"></a><span id="l43.175">      * @param aItipItem     The itip item to set the target calendar on.</span>
<a href="#l43.176"></a><span id="l43.176">      * @param aWindow       The window to open the dialog on.</span>
<a href="#l43.177"></a><span id="l43.177">      * @return              True, if a calendar was selected or no selection is</span>
<a href="#l43.178"></a><span id="l43.178">      *                        needed.</span>
<a href="#l43.179"></a><span id="l43.179">      */</span>
<a href="#l43.180"></a><span id="l43.180" class="difflineminus">-    promptCalendar: function promptCalendar(aMethod, aItipItem, aWindow) {</span>
<a href="#l43.181"></a><span id="l43.181" class="difflineplus">+    promptCalendar: function(aMethod, aItipItem, aWindow) {</span>
<a href="#l43.182"></a><span id="l43.182">         let needsCalendar = false;</span>
<a href="#l43.183"></a><span id="l43.183">         let targetCalendar = null;</span>
<a href="#l43.184"></a><span id="l43.184">         switch (aMethod) {</span>
<a href="#l43.185"></a><span id="l43.185">             // methods that don't require the calendar chooser:</span>
<a href="#l43.186"></a><span id="l43.186">             case &quot;REFRESH&quot;:</span>
<a href="#l43.187"></a><span id="l43.187">             case &quot;REQUEST:UPDATE&quot;:</span>
<a href="#l43.188"></a><span id="l43.188">             case &quot;REQUEST:UPDATE-MINOR&quot;:</span>
<a href="#l43.189"></a><span id="l43.189">             case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineat">@@ -455,17 +455,17 @@ cal.itip = {</span>
<a href="#l43.191"></a><span id="l43.191">             } else if (calendars.length == 1) {</span>
<a href="#l43.192"></a><span id="l43.192">                 // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l43.193"></a><span id="l43.193">                 // the user wants to import into.</span>
<a href="#l43.194"></a><span id="l43.194">                 targetCalendar = calendars[0];</span>
<a href="#l43.195"></a><span id="l43.195">             } else {</span>
<a href="#l43.196"></a><span id="l43.196">                 // Ask what calendar to import into</span>
<a href="#l43.197"></a><span id="l43.197">                 let args = {};</span>
<a href="#l43.198"></a><span id="l43.198">                 args.calendars = calendars;</span>
<a href="#l43.199"></a><span id="l43.199" class="difflineminus">-                args.onOk = function selectCalendar(aCal) { targetCalendar = aCal; };</span>
<a href="#l43.200"></a><span id="l43.200" class="difflineplus">+                args.onOk = (aCal) =&gt; { targetCalendar = aCal; };</span>
<a href="#l43.201"></a><span id="l43.201">                 args.promptText = cal.calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l43.202"></a><span id="l43.202">                 aWindow.openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l43.203"></a><span id="l43.203">                                    &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l43.204"></a><span id="l43.204">             }</span>
<a href="#l43.205"></a><span id="l43.205"> </span>
<a href="#l43.206"></a><span id="l43.206">             if (targetCalendar) {</span>
<a href="#l43.207"></a><span id="l43.207">                 aItipItem.targetCalendar = targetCalendar;</span>
<a href="#l43.208"></a><span id="l43.208">             }</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineat">@@ -476,17 +476,17 @@ cal.itip = {</span>
<a href="#l43.210"></a><span id="l43.210"> </span>
<a href="#l43.211"></a><span id="l43.211">     /**</span>
<a href="#l43.212"></a><span id="l43.212">      * Clean up after the given iTIP item. This needs to be called once for each</span>
<a href="#l43.213"></a><span id="l43.213">      * time processItipItem is called. May be called with a null itipItem in</span>
<a href="#l43.214"></a><span id="l43.214">      * which case it will do nothing.</span>
<a href="#l43.215"></a><span id="l43.215">      *</span>
<a href="#l43.216"></a><span id="l43.216">      * @param itipItem      The iTIP item to clean up for.</span>
<a href="#l43.217"></a><span id="l43.217">      */</span>
<a href="#l43.218"></a><span id="l43.218" class="difflineminus">-    cleanupItipItem: function cleanupItipItem(itipItem) {</span>
<a href="#l43.219"></a><span id="l43.219" class="difflineplus">+    cleanupItipItem: function(itipItem) {</span>
<a href="#l43.220"></a><span id="l43.220">         if (itipItem) {</span>
<a href="#l43.221"></a><span id="l43.221">             let itemList = itipItem.getItemList({});</span>
<a href="#l43.222"></a><span id="l43.222">             if (itemList.length &gt; 0) {</span>
<a href="#l43.223"></a><span id="l43.223">                 // Again, we can assume the id is the same over all items per spec</span>
<a href="#l43.224"></a><span id="l43.224">                 ItipItemFinderFactory.cleanup(itemList[0].id);</span>
<a href="#l43.225"></a><span id="l43.225">             }</span>
<a href="#l43.226"></a><span id="l43.226">         }</span>
<a href="#l43.227"></a><span id="l43.227">     },</span>
<a href="#l43.228"></a><span id="l43.228" class="difflineat">@@ -504,17 +504,17 @@ cal.itip = {</span>
<a href="#l43.229"></a><span id="l43.229">      *                    * PUBLISH -- initial publish, no reply (sent by organizer)</span>
<a href="#l43.230"></a><span id="l43.230">      *                    * PUBLISH:UPDATE -- update of a published item (sent by organizer)</span>
<a href="#l43.231"></a><span id="l43.231">      *                    * REQUEST -- initial invitation (sent by organizer)</span>
<a href="#l43.232"></a><span id="l43.232">      *                    * REQUEST:UPDATE -- rescheduling invitation, has major change (sent by organizer)</span>
<a href="#l43.233"></a><span id="l43.233">      *                    * REQUEST:UPDATE-MINOR -- update of invitation, minor change (sent by organizer)</span>
<a href="#l43.234"></a><span id="l43.234">      *                    * REPLY -- invitation reply (sent by attendee(s))</span>
<a href="#l43.235"></a><span id="l43.235">      *                    * CANCEL -- invitation cancel (sent by organizer)</span>
<a href="#l43.236"></a><span id="l43.236">      */</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineminus">-    processItipItem: function cal_itip_processItipItem(itipItem, optionsFunc) {</span>
<a href="#l43.238"></a><span id="l43.238" class="difflineplus">+    processItipItem: function(itipItem, optionsFunc) {</span>
<a href="#l43.239"></a><span id="l43.239">         switch (itipItem.receivedMethod.toUpperCase()) {</span>
<a href="#l43.240"></a><span id="l43.240">             case &quot;REFRESH&quot;:</span>
<a href="#l43.241"></a><span id="l43.241">             case &quot;PUBLISH&quot;:</span>
<a href="#l43.242"></a><span id="l43.242">             case &quot;REQUEST&quot;:</span>
<a href="#l43.243"></a><span id="l43.243">             case &quot;CANCEL&quot;:</span>
<a href="#l43.244"></a><span id="l43.244">             case &quot;REPLY&quot;: {</span>
<a href="#l43.245"></a><span id="l43.245">                 // Per iTIP spec (new Draft 4), multiple items in an iTIP message MUST have</span>
<a href="#l43.246"></a><span id="l43.246">                 // same ID, this simplifies our searching, we can just look for Item[0].id</span>
<a href="#l43.247"></a><span id="l43.247" class="difflineat">@@ -538,17 +538,17 @@ cal.itip = {</span>
<a href="#l43.248"></a><span id="l43.248">     },</span>
<a href="#l43.249"></a><span id="l43.249"> </span>
<a href="#l43.250"></a><span id="l43.250">     /**</span>
<a href="#l43.251"></a><span id="l43.251">      * Scope: iTIP message sender</span>
<a href="#l43.252"></a><span id="l43.252">      *</span>
<a href="#l43.253"></a><span id="l43.253">      * Checks to see if e.g. attendees were added/removed or an item has been</span>
<a href="#l43.254"></a><span id="l43.254">      * deleted and sends out appropriate iTIP messages.</span>
<a href="#l43.255"></a><span id="l43.255">      */</span>
<a href="#l43.256"></a><span id="l43.256" class="difflineminus">-    checkAndSend: function cal_itip_checkAndSend(aOpType, aItem, aOriginalItem) {</span>
<a href="#l43.257"></a><span id="l43.257" class="difflineplus">+    checkAndSend: function(aOpType, aItem, aOriginalItem) {</span>
<a href="#l43.258"></a><span id="l43.258">         // balance out parts of the modification vs delete confusion, deletion of occurrences</span>
<a href="#l43.259"></a><span id="l43.259">         // are notified as parent modifications and modifications of occurrences are notified</span>
<a href="#l43.260"></a><span id="l43.260">         // as mixed new-occurrence, old-parent (IIRC).</span>
<a href="#l43.261"></a><span id="l43.261">         if (aOriginalItem &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l43.262"></a><span id="l43.262">             if (aOriginalItem.recurrenceId &amp;&amp; !aItem.recurrenceId) {</span>
<a href="#l43.263"></a><span id="l43.263">                 // sanity check: assure aItem doesn't refer to the master</span>
<a href="#l43.264"></a><span id="l43.264">                 aItem = aItem.recurrenceInfo.getOccurrenceFor(aOriginalItem.recurrenceId);</span>
<a href="#l43.265"></a><span id="l43.265">                 cal.ASSERT(aItem, &quot;unexpected!&quot;);</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineat">@@ -773,17 +773,17 @@ cal.itip = {</span>
<a href="#l43.267"></a><span id="l43.267">                 sendMessage(cancelItem, &quot;CANCEL&quot;, canceledAttendees, autoResponse);</span>
<a href="#l43.268"></a><span id="l43.268">             }</span>
<a href="#l43.269"></a><span id="l43.269">         }</span>
<a href="#l43.270"></a><span id="l43.270">     },</span>
<a href="#l43.271"></a><span id="l43.271"> </span>
<a href="#l43.272"></a><span id="l43.272">     /**</span>
<a href="#l43.273"></a><span id="l43.273">      * Bumps the SEQUENCE in case of a major change; XXX todo may need more fine-tuning.</span>
<a href="#l43.274"></a><span id="l43.274">      */</span>
<a href="#l43.275"></a><span id="l43.275" class="difflineminus">-    prepareSequence: function cal_itip_prepareSequence(newItem, oldItem) {</span>
<a href="#l43.276"></a><span id="l43.276" class="difflineplus">+    prepareSequence: function(newItem, oldItem) {</span>
<a href="#l43.277"></a><span id="l43.277">         if (cal.isInvitation(newItem)) {</span>
<a href="#l43.278"></a><span id="l43.278">             return newItem; // invitation copies don't bump the SEQUENCE</span>
<a href="#l43.279"></a><span id="l43.279">         }</span>
<a href="#l43.280"></a><span id="l43.280"> </span>
<a href="#l43.281"></a><span id="l43.281">         if (newItem.recurrenceId &amp;&amp; !oldItem.recurrenceId &amp;&amp; oldItem.recurrenceInfo) {</span>
<a href="#l43.282"></a><span id="l43.282">             // XXX todo: there's still the bug that modifyItem is called with mixed occurrence/parent,</span>
<a href="#l43.283"></a><span id="l43.283">             //           find original occurrence</span>
<a href="#l43.284"></a><span id="l43.284">             oldItem = oldItem.recurrenceInfo.getOccurrenceFor(newItem.recurrenceId);</span>
<a href="#l43.285"></a><span id="l43.285" class="difflineat">@@ -834,17 +834,17 @@ cal.itip = {</span>
<a href="#l43.286"></a><span id="l43.286">     /**</span>
<a href="#l43.287"></a><span id="l43.287">      * Returns a copy of an itipItem with modified properties and items build from scratch</span>
<a href="#l43.288"></a><span id="l43.288">      * Use itipItem.clone() instead if only a simple copy is required</span>
<a href="#l43.289"></a><span id="l43.289">      *</span>
<a href="#l43.290"></a><span id="l43.290">      * @param aItipItem     ItipItem to derive a new one from</span>
<a href="#l43.291"></a><span id="l43.291">      * @param aItems        List of items to be contained in the new itipItem</span>
<a href="#l43.292"></a><span id="l43.292">      * @param aProps        List of properties to be different in the new itipItem</span>
<a href="#l43.293"></a><span id="l43.293">      */</span>
<a href="#l43.294"></a><span id="l43.294" class="difflineminus">-    getModifiedItipItem: function cal_getModifiedItipItem(aItipItem, aItems=[], aProps={}) {</span>
<a href="#l43.295"></a><span id="l43.295" class="difflineplus">+    getModifiedItipItem: function(aItipItem, aItems=[], aProps={}) {</span>
<a href="#l43.296"></a><span id="l43.296">         let itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l43.297"></a><span id="l43.297">                                  .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l43.298"></a><span id="l43.298">         let serializedItems = &quot;&quot;;</span>
<a href="#l43.299"></a><span id="l43.299">         for (let item of aItems) {</span>
<a href="#l43.300"></a><span id="l43.300">             serializedItems += cal.getSerializedItem(item);</span>
<a href="#l43.301"></a><span id="l43.301">         }</span>
<a href="#l43.302"></a><span id="l43.302">         itipItem.init(serializedItems);</span>
<a href="#l43.303"></a><span id="l43.303"> </span>
<a href="#l43.304"></a><span id="l43.304" class="difflineat">@@ -1073,39 +1073,30 @@ function sendMessage(aItem, aMethod, aRe</span>
<a href="#l43.305"></a><span id="l43.305">  * @param oldItem the previous item before modification (if any)</span>
<a href="#l43.306"></a><span id="l43.306">  */</span>
<a href="#l43.307"></a><span id="l43.307"> function ItipOpListener(opListener, oldItem) {</span>
<a href="#l43.308"></a><span id="l43.308">     this.mOpListener = opListener;</span>
<a href="#l43.309"></a><span id="l43.309">     this.mOldItem = oldItem;</span>
<a href="#l43.310"></a><span id="l43.310"> }</span>
<a href="#l43.311"></a><span id="l43.311"> ItipOpListener.prototype = {</span>
<a href="#l43.312"></a><span id="l43.312">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l43.313"></a><span id="l43.313" class="difflineminus">-    onOperationComplete: function ItipOpListener_onOperationComplete(aCalendar,</span>
<a href="#l43.314"></a><span id="l43.314" class="difflineminus">-                                                                     aStatus,</span>
<a href="#l43.315"></a><span id="l43.315" class="difflineminus">-                                                                     aOperationType,</span>
<a href="#l43.316"></a><span id="l43.316" class="difflineminus">-                                                                     aId,</span>
<a href="#l43.317"></a><span id="l43.317" class="difflineminus">-                                                                     aDetail) {</span>
<a href="#l43.318"></a><span id="l43.318" class="difflineplus">+    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l43.319"></a><span id="l43.319">         cal.ASSERT(Components.isSuccessCode(aStatus), &quot;error on iTIP processing&quot;);</span>
<a href="#l43.320"></a><span id="l43.320">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l43.321"></a><span id="l43.321">             cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem);</span>
<a href="#l43.322"></a><span id="l43.322">         }</span>
<a href="#l43.323"></a><span id="l43.323">         if (this.mOpListener) {</span>
<a href="#l43.324"></a><span id="l43.324">             this.mOpListener.onOperationComplete(aCalendar,</span>
<a href="#l43.325"></a><span id="l43.325">                                                  aStatus,</span>
<a href="#l43.326"></a><span id="l43.326">                                                  aOperationType,</span>
<a href="#l43.327"></a><span id="l43.327">                                                  aId,</span>
<a href="#l43.328"></a><span id="l43.328">                                                  aDetail);</span>
<a href="#l43.329"></a><span id="l43.329">         }</span>
<a href="#l43.330"></a><span id="l43.330">     },</span>
<a href="#l43.331"></a><span id="l43.331" class="difflineminus">-    onGetResult: function ItipOpListener_onGetResult(aCalendar,</span>
<a href="#l43.332"></a><span id="l43.332" class="difflineminus">-                                                     aStatus,</span>
<a href="#l43.333"></a><span id="l43.333" class="difflineminus">-                                                     aItemType,</span>
<a href="#l43.334"></a><span id="l43.334" class="difflineminus">-                                                     aDetail,</span>
<a href="#l43.335"></a><span id="l43.335" class="difflineminus">-                                                     aCount,</span>
<a href="#l43.336"></a><span id="l43.336" class="difflineminus">-                                                     aItems) {</span>
<a href="#l43.337"></a><span id="l43.337" class="difflineplus">+    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l43.338"></a><span id="l43.338">     }</span>
<a href="#l43.339"></a><span id="l43.339"> };</span>
<a href="#l43.340"></a><span id="l43.340"> </span>
<a href="#l43.341"></a><span id="l43.341"> /** local to this module file</span>
<a href="#l43.342"></a><span id="l43.342">  * Add a parameter SCHEDULE-AGENT=CLIENT to the item before it is</span>
<a href="#l43.343"></a><span id="l43.343">  * created or updated so that the providers knows scheduling will</span>
<a href="#l43.344"></a><span id="l43.344">  * be handled by the client.</span>
<a href="#l43.345"></a><span id="l43.345">  *</span>
<a href="#l43.346"></a><span id="l43.346" class="difflineat">@@ -1127,30 +1118,30 @@ var ItipItemFinderFactory = {</span>
<a href="#l43.347"></a><span id="l43.347">     /**</span>
<a href="#l43.348"></a><span id="l43.348">      * Create an item finder and track its progress. Be sure to clean up the</span>
<a href="#l43.349"></a><span id="l43.349">      * finder for this id at some point.</span>
<a href="#l43.350"></a><span id="l43.350">      *</span>
<a href="#l43.351"></a><span id="l43.351">      * @param aId           The item id to search for</span>
<a href="#l43.352"></a><span id="l43.352">      * @param aItipItem     The iTIP item used for processing</span>
<a href="#l43.353"></a><span id="l43.353">      * @param aOptionsFunc  The options function used for processing the found item</span>
<a href="#l43.354"></a><span id="l43.354">      */</span>
<a href="#l43.355"></a><span id="l43.355" class="difflineminus">-    findItem: function findItem(aId, aItipItem, aOptionsFunc) {</span>
<a href="#l43.356"></a><span id="l43.356" class="difflineplus">+    findItem: function(aId, aItipItem, aOptionsFunc) {</span>
<a href="#l43.357"></a><span id="l43.357">         this.cleanup(aId);</span>
<a href="#l43.358"></a><span id="l43.358">         let finder = new ItipItemFinder(aId, aItipItem, aOptionsFunc);</span>
<a href="#l43.359"></a><span id="l43.359">         this._findMap[aId] = finder;</span>
<a href="#l43.360"></a><span id="l43.360">         finder.findItem();</span>
<a href="#l43.361"></a><span id="l43.361">     },</span>
<a href="#l43.362"></a><span id="l43.362"> </span>
<a href="#l43.363"></a><span id="l43.363">     /**</span>
<a href="#l43.364"></a><span id="l43.364">      * Clean up tracking for the given id. This needs to be called once for</span>
<a href="#l43.365"></a><span id="l43.365">      * every time findItem is called.</span>
<a href="#l43.366"></a><span id="l43.366">      *</span>
<a href="#l43.367"></a><span id="l43.367">      * @param aId           The item id to clean up for</span>
<a href="#l43.368"></a><span id="l43.368">      */</span>
<a href="#l43.369"></a><span id="l43.369" class="difflineminus">-    cleanup: function cleanup(aId) {</span>
<a href="#l43.370"></a><span id="l43.370" class="difflineplus">+    cleanup: function(aId) {</span>
<a href="#l43.371"></a><span id="l43.371">         if (aId in this._findMap) {</span>
<a href="#l43.372"></a><span id="l43.372">             let finder = this._findMap[aId];</span>
<a href="#l43.373"></a><span id="l43.373">             finder.destroy();</span>
<a href="#l43.374"></a><span id="l43.374">             delete this._findMap[aId];</span>
<a href="#l43.375"></a><span id="l43.375">         }</span>
<a href="#l43.376"></a><span id="l43.376">     }</span>
<a href="#l43.377"></a><span id="l43.377"> };</span>
<a href="#l43.378"></a><span id="l43.378"> </span>
<a href="#l43.379"></a><span id="l43.379" class="difflineat">@@ -1173,49 +1164,49 @@ ItipItemFinder.prototype = {</span>
<a href="#l43.380"></a><span id="l43.380">         Components.interfaces.calIOperationListener</span>
<a href="#l43.381"></a><span id="l43.381">     ]),</span>
<a href="#l43.382"></a><span id="l43.382"> </span>
<a href="#l43.383"></a><span id="l43.383">     mSearchId: null,</span>
<a href="#l43.384"></a><span id="l43.384">     mItipItem: null,</span>
<a href="#l43.385"></a><span id="l43.385">     mOptionsFunc: null,</span>
<a href="#l43.386"></a><span id="l43.386">     mFoundItems: null,</span>
<a href="#l43.387"></a><span id="l43.387"> </span>
<a href="#l43.388"></a><span id="l43.388" class="difflineminus">-    findItem: function findItem() {</span>
<a href="#l43.389"></a><span id="l43.389" class="difflineplus">+    findItem: function() {</span>
<a href="#l43.390"></a><span id="l43.390">         this.mFoundItems = [];</span>
<a href="#l43.391"></a><span id="l43.391">         this._unobserveChanges();</span>
<a href="#l43.392"></a><span id="l43.392">         this.mItipItem.targetCalendar.getItem(this.mSearchId, this);</span>
<a href="#l43.393"></a><span id="l43.393">     },</span>
<a href="#l43.394"></a><span id="l43.394"> </span>
<a href="#l43.395"></a><span id="l43.395" class="difflineminus">-    _observeChanges: function _observeChanges(aCalendar) {</span>
<a href="#l43.396"></a><span id="l43.396" class="difflineplus">+    _observeChanges: function(aCalendar) {</span>
<a href="#l43.397"></a><span id="l43.397">         this._unobserveChanges();</span>
<a href="#l43.398"></a><span id="l43.398">         this.mObservedCalendar = aCalendar;</span>
<a href="#l43.399"></a><span id="l43.399"> </span>
<a href="#l43.400"></a><span id="l43.400">         if (this.mObservedCalendar) {</span>
<a href="#l43.401"></a><span id="l43.401">             this.mObservedCalendar.addObserver(this);</span>
<a href="#l43.402"></a><span id="l43.402">         }</span>
<a href="#l43.403"></a><span id="l43.403">     },</span>
<a href="#l43.404"></a><span id="l43.404" class="difflineminus">-    _unobserveChanges: function _unobserveChanges() {</span>
<a href="#l43.405"></a><span id="l43.405" class="difflineplus">+    _unobserveChanges: function() {</span>
<a href="#l43.406"></a><span id="l43.406">         if (this.mObservedCalendar) {</span>
<a href="#l43.407"></a><span id="l43.407">             this.mObservedCalendar.removeObserver(this);</span>
<a href="#l43.408"></a><span id="l43.408">             this.mObservedCalendar = null;</span>
<a href="#l43.409"></a><span id="l43.409">         }</span>
<a href="#l43.410"></a><span id="l43.410">     },</span>
<a href="#l43.411"></a><span id="l43.411"> </span>
<a href="#l43.412"></a><span id="l43.412">     onStartBatch: function() {},</span>
<a href="#l43.413"></a><span id="l43.413">     onEndBatch: function() {},</span>
<a href="#l43.414"></a><span id="l43.414">     onError: function() {},</span>
<a href="#l43.415"></a><span id="l43.415">     onPropertyChanged: function() {},</span>
<a href="#l43.416"></a><span id="l43.416">     onPropertyDeleting: function() {},</span>
<a href="#l43.417"></a><span id="l43.417" class="difflineminus">-    onLoad: function onLoad(aCalendar) {</span>
<a href="#l43.418"></a><span id="l43.418" class="difflineplus">+    onLoad: function(aCalendar) {</span>
<a href="#l43.419"></a><span id="l43.419">         // Its possible that the item was updated. We need to re-retrieve the</span>
<a href="#l43.420"></a><span id="l43.420">         // items now.</span>
<a href="#l43.421"></a><span id="l43.421">         this.findItem();</span>
<a href="#l43.422"></a><span id="l43.422">     },</span>
<a href="#l43.423"></a><span id="l43.423"> </span>
<a href="#l43.424"></a><span id="l43.424" class="difflineminus">-    onModifyItem: function onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l43.425"></a><span id="l43.425" class="difflineplus">+    onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l43.426"></a><span id="l43.426">         let refItem = aOldItem || aNewItem;</span>
<a href="#l43.427"></a><span id="l43.427">         if (refItem.id == this.mSearchId) {</span>
<a href="#l43.428"></a><span id="l43.428">             // Check existing found items to see if it already exists</span>
<a href="#l43.429"></a><span id="l43.429">             let found = false;</span>
<a href="#l43.430"></a><span id="l43.430">             for (let [idx, item] in Iterator(this.mFoundItems)) {</span>
<a href="#l43.431"></a><span id="l43.431">                 if (item.id == refItem.id &amp;&amp; item.calendar.id == refItem.calendar.id) {</span>
<a href="#l43.432"></a><span id="l43.432">                     if (aNewItem) {</span>
<a href="#l43.433"></a><span id="l43.433">                         this.mFoundItems.splice(idx, 1, aNewItem);</span>
<a href="#l43.434"></a><span id="l43.434" class="difflineat">@@ -1230,39 +1221,35 @@ ItipItemFinder.prototype = {</span>
<a href="#l43.435"></a><span id="l43.435">             // If it hasn't been found and there isto add a item, add it to the end</span>
<a href="#l43.436"></a><span id="l43.436">             if (!found &amp;&amp; aNewItem) {</span>
<a href="#l43.437"></a><span id="l43.437">                 this.mFoundItems.push(aNewItem);</span>
<a href="#l43.438"></a><span id="l43.438">             }</span>
<a href="#l43.439"></a><span id="l43.439">             this.processFoundItems();</span>
<a href="#l43.440"></a><span id="l43.440">         }</span>
<a href="#l43.441"></a><span id="l43.441">     },</span>
<a href="#l43.442"></a><span id="l43.442"> </span>
<a href="#l43.443"></a><span id="l43.443" class="difflineminus">-    onAddItem: function onAddItem(aItem) {</span>
<a href="#l43.444"></a><span id="l43.444" class="difflineplus">+    onAddItem: function(aItem) {</span>
<a href="#l43.445"></a><span id="l43.445">         // onModifyItem is set up to also handle additions</span>
<a href="#l43.446"></a><span id="l43.446">         this.onModifyItem(aItem, null);</span>
<a href="#l43.447"></a><span id="l43.447">     },</span>
<a href="#l43.448"></a><span id="l43.448"> </span>
<a href="#l43.449"></a><span id="l43.449" class="difflineminus">-    onDeleteItem: function onDeleteItem(aItem) {</span>
<a href="#l43.450"></a><span id="l43.450" class="difflineplus">+    onDeleteItem: function(aItem) {</span>
<a href="#l43.451"></a><span id="l43.451">         // onModifyItem is set up to also handle deletions</span>
<a href="#l43.452"></a><span id="l43.452">         this.onModifyItem(null, aItem);</span>
<a href="#l43.453"></a><span id="l43.453">     },</span>
<a href="#l43.454"></a><span id="l43.454"> </span>
<a href="#l43.455"></a><span id="l43.455" class="difflineminus">-    onOperationComplete: function onOperationComplete(aCalendar,</span>
<a href="#l43.456"></a><span id="l43.456" class="difflineminus">-                                                      aStatus,</span>
<a href="#l43.457"></a><span id="l43.457" class="difflineminus">-                                                      aOperationType,</span>
<a href="#l43.458"></a><span id="l43.458" class="difflineminus">-                                                      aId,</span>
<a href="#l43.459"></a><span id="l43.459" class="difflineminus">-                                                      aDetail) {</span>
<a href="#l43.460"></a><span id="l43.460" class="difflineplus">+    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l43.461"></a><span id="l43.461">         this.processFoundItems();</span>
<a href="#l43.462"></a><span id="l43.462">     },</span>
<a href="#l43.463"></a><span id="l43.463"> </span>
<a href="#l43.464"></a><span id="l43.464" class="difflineminus">-    destroy: function destroy() {</span>
<a href="#l43.465"></a><span id="l43.465" class="difflineplus">+    destroy: function() {</span>
<a href="#l43.466"></a><span id="l43.466">         this._unobserveChanges();</span>
<a href="#l43.467"></a><span id="l43.467">     },</span>
<a href="#l43.468"></a><span id="l43.468"> </span>
<a href="#l43.469"></a><span id="l43.469" class="difflineminus">-    processFoundItems: function processFoundItems() {</span>
<a href="#l43.470"></a><span id="l43.470" class="difflineplus">+    processFoundItems: function() {</span>
<a href="#l43.471"></a><span id="l43.471">         let rc = Components.results.NS_OK;</span>
<a href="#l43.472"></a><span id="l43.472">         const method = this.mItipItem.receivedMethod.toUpperCase();</span>
<a href="#l43.473"></a><span id="l43.473">         let actionMethod = method;</span>
<a href="#l43.474"></a><span id="l43.474">         let operations = [];</span>
<a href="#l43.475"></a><span id="l43.475"> </span>
<a href="#l43.476"></a><span id="l43.476">         if (this.mFoundItems.length &gt; 0) {</span>
<a href="#l43.477"></a><span id="l43.477">             // Save the target calendar on the itip item</span>
<a href="#l43.478"></a><span id="l43.478">             this.mItipItem.targetCalendar = this.mFoundItems[0].calendar;</span>
<a href="#l43.479"></a><span id="l43.479" class="difflineat">@@ -1517,34 +1504,29 @@ ItipItemFinder.prototype = {</span>
<a href="#l43.480"></a><span id="l43.480">                         break;</span>
<a href="#l43.481"></a><span id="l43.481">                 }</span>
<a href="#l43.482"></a><span id="l43.482">             }</span>
<a href="#l43.483"></a><span id="l43.483">         }</span>
<a href="#l43.484"></a><span id="l43.484"> </span>
<a href="#l43.485"></a><span id="l43.485">         cal.LOG(&quot;iTIP operations: &quot; + operations.length);</span>
<a href="#l43.486"></a><span id="l43.486">         let actionFunc = null;</span>
<a href="#l43.487"></a><span id="l43.487">         if (operations.length &gt; 0) {</span>
<a href="#l43.488"></a><span id="l43.488" class="difflineminus">-            actionFunc = function execOperations(opListener, partStat) {</span>
<a href="#l43.489"></a><span id="l43.489" class="difflineplus">+            actionFunc = function(opListener, partStat) {</span>
<a href="#l43.490"></a><span id="l43.490">                 for (let op of operations) {</span>
<a href="#l43.491"></a><span id="l43.491">                     try {</span>
<a href="#l43.492"></a><span id="l43.492">                         op(opListener, partStat);</span>
<a href="#l43.493"></a><span id="l43.493">                     } catch (exc) {</span>
<a href="#l43.494"></a><span id="l43.494">                         cal.ERROR(exc);</span>
<a href="#l43.495"></a><span id="l43.495">                     }</span>
<a href="#l43.496"></a><span id="l43.496">                 }</span>
<a href="#l43.497"></a><span id="l43.497">             };</span>
<a href="#l43.498"></a><span id="l43.498">             actionFunc.method = actionMethod;</span>
<a href="#l43.499"></a><span id="l43.499">         }</span>
<a href="#l43.500"></a><span id="l43.500"> </span>
<a href="#l43.501"></a><span id="l43.501">         this.mOptionsFunc(this.mItipItem, rc, actionFunc, this.mFoundItems);</span>
<a href="#l43.502"></a><span id="l43.502">     },</span>
<a href="#l43.503"></a><span id="l43.503"> </span>
<a href="#l43.504"></a><span id="l43.504" class="difflineminus">-    onGetResult: function onGetResult(aCalendar,</span>
<a href="#l43.505"></a><span id="l43.505" class="difflineminus">-                                      aStatus,</span>
<a href="#l43.506"></a><span id="l43.506" class="difflineminus">-                                      aItemType,</span>
<a href="#l43.507"></a><span id="l43.507" class="difflineminus">-                                      aDetail,</span>
<a href="#l43.508"></a><span id="l43.508" class="difflineminus">-                                      aCount,</span>
<a href="#l43.509"></a><span id="l43.509" class="difflineminus">-                                      aItems) {</span>
<a href="#l43.510"></a><span id="l43.510" class="difflineplus">+    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l43.511"></a><span id="l43.511">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l43.512"></a><span id="l43.512">             this.mFoundItems = this.mFoundItems.concat(aItems);</span>
<a href="#l43.513"></a><span id="l43.513">         }</span>
<a href="#l43.514"></a><span id="l43.514">     }</span>
<a href="#l43.515"></a><span id="l43.515"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -10,30 +10,30 @@ this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even</span>
<a href="#l44.4"></a><span id="l44.4"> cal.print = {</span>
<a href="#l44.5"></a><span id="l44.5">     /**</span>
<a href="#l44.6"></a><span id="l44.6">      * Returns a simple key in the format YYYY-MM-DD for use in the table of</span>
<a href="#l44.7"></a><span id="l44.7">      * dates to day boxes</span>
<a href="#l44.8"></a><span id="l44.8">      *</span>
<a href="#l44.9"></a><span id="l44.9">      * @param dt    The date to translate</span>
<a href="#l44.10"></a><span id="l44.10">      * @return      YYYY-MM-DD</span>
<a href="#l44.11"></a><span id="l44.11">      */</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    getDateKey: function getDateKey(dt) {</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+    getDateKey: function(dt) {</span>
<a href="#l44.14"></a><span id="l44.14">         return dt.year + &quot;-&quot; + dt.month + &quot;-&quot; + dt.day;</span>
<a href="#l44.15"></a><span id="l44.15">     },</span>
<a href="#l44.16"></a><span id="l44.16"> </span>
<a href="#l44.17"></a><span id="l44.17">     /**</span>
<a href="#l44.18"></a><span id="l44.18">      * Add category styles to the document's &quot;sheet&quot; element. This is needed</span>
<a href="#l44.19"></a><span id="l44.19">      * since the HTML created is serialized, so we can't dynamically set the</span>
<a href="#l44.20"></a><span id="l44.20">      * styles and can be changed if the print formatter decides to return a</span>
<a href="#l44.21"></a><span id="l44.21">      * DOM document instead.</span>
<a href="#l44.22"></a><span id="l44.22">      *</span>
<a href="#l44.23"></a><span id="l44.23">      * @param document      The document that contains &lt;style id=&quot;sheet&quot;/&gt;.</span>
<a href="#l44.24"></a><span id="l44.24">      * @param categories    Array of categories to insert rules for.</span>
<a href="#l44.25"></a><span id="l44.25">      */</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineminus">-    insertCategoryRules: function insertCategoryRules(document, categories) {</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+    insertCategoryRules: function(document, categories) {</span>
<a href="#l44.28"></a><span id="l44.28">         let sheet = document.getElementById(&quot;sheet&quot;);</span>
<a href="#l44.29"></a><span id="l44.29">         sheet.insertedCategoryRules = sheet.insertedCategoryRules || {};</span>
<a href="#l44.30"></a><span id="l44.30"> </span>
<a href="#l44.31"></a><span id="l44.31">         for (let category of categories) {</span>
<a href="#l44.32"></a><span id="l44.32">             let prefName = cal.formatStringForCSSRule(category);</span>
<a href="#l44.33"></a><span id="l44.33">             let color = Preferences.get(&quot;calendar.category.color.&quot; + prefName) || &quot;transparent&quot;;</span>
<a href="#l44.34"></a><span id="l44.34">             if (!(prefName in sheet.insertedCategoryRules)) {</span>
<a href="#l44.35"></a><span id="l44.35">                 sheet.insertedCategoryRules[prefName] = true;</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineat">@@ -48,17 +48,17 @@ cal.print = {</span>
<a href="#l44.37"></a><span id="l44.37">      * Add calendar styles to the document's &quot;sheet&quot; element. This is needed</span>
<a href="#l44.38"></a><span id="l44.38">      * since the HTML created is serialized, so we can't dynamically set the</span>
<a href="#l44.39"></a><span id="l44.39">      * styles and can be changed if the print formatter decides to return a</span>
<a href="#l44.40"></a><span id="l44.40">      * DOM document instead.</span>
<a href="#l44.41"></a><span id="l44.41">      *</span>
<a href="#l44.42"></a><span id="l44.42">      * @param document      The document that contains &lt;style id=&quot;sheet&quot;/&gt;.</span>
<a href="#l44.43"></a><span id="l44.43">      * @param categories    The calendar to insert a rule for.</span>
<a href="#l44.44"></a><span id="l44.44">      */</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineminus">-    insertCalendarRules: function insertCalendarRules(document, calendar) {</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+    insertCalendarRules: function(document, calendar) {</span>
<a href="#l44.47"></a><span id="l44.47">         let sheet = document.getElementById(&quot;sheet&quot;);</span>
<a href="#l44.48"></a><span id="l44.48">         let color = calendar.getProperty(&quot;color&quot;) || &quot;#A8C2E1&quot;;</span>
<a href="#l44.49"></a><span id="l44.49">         sheet.insertedCalendarRules = sheet.insertedCalendarRules || {};</span>
<a href="#l44.50"></a><span id="l44.50"> </span>
<a href="#l44.51"></a><span id="l44.51">         if (!(calendar.id in sheet.insertedCalendarRules)) {</span>
<a href="#l44.52"></a><span id="l44.52">             sheet.insertedCalendarRules[calendar.id] = true;</span>
<a href="#l44.53"></a><span id="l44.53">             let formattedId = cal.formatStringForCSSRule(calendar.id);</span>
<a href="#l44.54"></a><span id="l44.54">             let ruleAdd = ' .calendar-color-box[calendar-id=&quot;' + formattedId + '&quot;] { ' +</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineat">@@ -78,17 +78,17 @@ cal.print = {</span>
<a href="#l44.56"></a><span id="l44.56">      *   - .item-title gets the item title</span>
<a href="#l44.57"></a><span id="l44.57">      *   - .category-color-box gets a 2px solid border in category color</span>
<a href="#l44.58"></a><span id="l44.58">      *   - .calendar-color-box gets background color of the calendar</span>
<a href="#l44.59"></a><span id="l44.59">      *</span>
<a href="#l44.60"></a><span id="l44.60">      * @param document          The DOM Document to set things on</span>
<a href="#l44.61"></a><span id="l44.61">      * @param item              The item to serialize</span>
<a href="#l44.62"></a><span id="l44.62">      * @param dayContainer      The DOM Node to insert the container in</span>
<a href="#l44.63"></a><span id="l44.63">      */</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineminus">-    addItemToDaybox: function addItemToDaybox(document, item, boxDate, dayContainer) {</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+    addItemToDaybox: function(document, item, boxDate, dayContainer) {</span>
<a href="#l44.66"></a><span id="l44.66">         // Clone our template</span>
<a href="#l44.67"></a><span id="l44.67">         let itemNode = document.getElementById(&quot;item-template&quot;).cloneNode(true);</span>
<a href="#l44.68"></a><span id="l44.68">         itemNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l44.69"></a><span id="l44.69">         itemNode.item = item;</span>
<a href="#l44.70"></a><span id="l44.70"> </span>
<a href="#l44.71"></a><span id="l44.71">         // Fill in details of the item</span>
<a href="#l44.72"></a><span id="l44.72">         let itemInterval = cal.print.getItemIntervalString(item, boxDate);</span>
<a href="#l44.73"></a><span id="l44.73">         itemNode.querySelector(&quot;.item-interval&quot;).textContent = itemInterval;</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineat">@@ -123,17 +123,17 @@ cal.print = {</span>
<a href="#l44.75"></a><span id="l44.75">      * - #task-list-box will have the &quot;hidden&quot; attribute removed.</span>
<a href="#l44.76"></a><span id="l44.76">      * - #task-template will be cloned and filled, and modified:</span>
<a href="#l44.77"></a><span id="l44.77">      *   - .task-checkbox gets the &quot;checked&quot; attribute set, if completed</span>
<a href="#l44.78"></a><span id="l44.78">      *   - .task-title gets the item title.</span>
<a href="#l44.79"></a><span id="l44.79">      *</span>
<a href="#l44.80"></a><span id="l44.80">      * @param document          The DOM Document to set things on</span>
<a href="#l44.81"></a><span id="l44.81">      * @param item              The item to serialize</span>
<a href="#l44.82"></a><span id="l44.82">      */</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineminus">-    addItemToDayboxNodate: function addItemToDayboxNodate(document, item) {</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+    addItemToDayboxNodate: function(document, item) {</span>
<a href="#l44.85"></a><span id="l44.85">         let taskContainer = document.getElementById(&quot;task-container&quot;);</span>
<a href="#l44.86"></a><span id="l44.86">         let taskNode = document.getElementById(&quot;task-template&quot;).cloneNode(true);</span>
<a href="#l44.87"></a><span id="l44.87">         taskNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l44.88"></a><span id="l44.88">         taskNode.item = item;</span>
<a href="#l44.89"></a><span id="l44.89"> </span>
<a href="#l44.90"></a><span id="l44.90">         let taskListBox = document.getElementById(&quot;tasks-list-box&quot;);</span>
<a href="#l44.91"></a><span id="l44.91">         if (taskListBox.hasAttribute(&quot;hidden&quot;)) {</span>
<a href="#l44.92"></a><span id="l44.92">             let tasksTitle = document.getElementById(&quot;tasks-title&quot;);</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineat">@@ -153,17 +153,17 @@ cal.print = {</span>
<a href="#l44.94"></a><span id="l44.94">     },</span>
<a href="#l44.95"></a><span id="l44.95"> </span>
<a href="#l44.96"></a><span id="l44.96">     /**</span>
<a href="#l44.97"></a><span id="l44.97">      * Get time interval string for the given item. Returns an empty string for all-day items.</span>
<a href="#l44.98"></a><span id="l44.98">      *</span>
<a href="#l44.99"></a><span id="l44.99">      * @param aItem     The item providing the interval</span>
<a href="#l44.100"></a><span id="l44.100">      * @return          The string describing the interval</span>
<a href="#l44.101"></a><span id="l44.101">      */</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineminus">-    getItemIntervalString: function getItemIntervalString(aItem, aBoxDate) {</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+    getItemIntervalString: function(aItem, aBoxDate) {</span>
<a href="#l44.104"></a><span id="l44.104">         // omit time label for all-day items</span>
<a href="#l44.105"></a><span id="l44.105">         let startDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l44.106"></a><span id="l44.106">         let endDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l44.107"></a><span id="l44.107">         if ((startDate &amp;&amp; startDate.isDate) || (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l44.108"></a><span id="l44.108">             return &quot;&quot;;</span>
<a href="#l44.109"></a><span id="l44.109">         }</span>
<a href="#l44.110"></a><span id="l44.110"> </span>
<a href="#l44.111"></a><span id="l44.111">         // check for tasks without start and/or due date</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -24,17 +24,17 @@ this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even</span>
<a href="#l45.4"></a><span id="l45.4">  * @param aUploadData                Data to be uploaded, if any. This may be a</span>
<a href="#l45.5"></a><span id="l45.5">  *                                     nsIInputStream or string data. In the</span>
<a href="#l45.6"></a><span id="l45.6">  *                                     latter case the string will be converted</span>
<a href="#l45.7"></a><span id="l45.7">  *                                     to an input stream.</span>
<a href="#l45.8"></a><span id="l45.8">  * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l45.9"></a><span id="l45.9">  * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l45.10"></a><span id="l45.10">  * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l45.11"></a><span id="l45.11">  */</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-cal.prepHttpChannel = function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+cal.prepHttpChannel = function(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l45.14"></a><span id="l45.14">     let channel = aExisting || Services.io.newChannelFromURI2(aUri,</span>
<a href="#l45.15"></a><span id="l45.15">                                                               null,</span>
<a href="#l45.16"></a><span id="l45.16">                                                               Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l45.17"></a><span id="l45.17">                                                               null,</span>
<a href="#l45.18"></a><span id="l45.18">                                                               Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l45.19"></a><span id="l45.19">                                                               Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l45.20"></a><span id="l45.20">     let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l45.21"></a><span id="l45.21"> </span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -66,27 +66,27 @@ cal.prepHttpChannel = function calPrepHt</span>
<a href="#l45.23"></a><span id="l45.23"> </span>
<a href="#l45.24"></a><span id="l45.24"> /**</span>
<a href="#l45.25"></a><span id="l45.25">  * calSendHttpRequest; send prepared HTTP request</span>
<a href="#l45.26"></a><span id="l45.26">  *</span>
<a href="#l45.27"></a><span id="l45.27">  * @param aStreamLoader     streamLoader for request</span>
<a href="#l45.28"></a><span id="l45.28">  * @param aChannel          channel for request</span>
<a href="#l45.29"></a><span id="l45.29">  * @param aListener         listener for method completion</span>
<a href="#l45.30"></a><span id="l45.30">  */</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-cal.sendHttpRequest = function calSendHttpRequest(aStreamLoader, aChannel, aListener) {</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+cal.sendHttpRequest = function(aStreamLoader, aChannel, aListener) {</span>
<a href="#l45.33"></a><span id="l45.33">     aStreamLoader.init(aListener);</span>
<a href="#l45.34"></a><span id="l45.34">     aChannel.asyncOpen(aStreamLoader, aChannel);</span>
<a href="#l45.35"></a><span id="l45.35"> };</span>
<a href="#l45.36"></a><span id="l45.36"> </span>
<a href="#l45.37"></a><span id="l45.37" class="difflineminus">-cal.createStreamLoader = function calCreateStreamLoader() {</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+cal.createStreamLoader = function() {</span>
<a href="#l45.39"></a><span id="l45.39">     return Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l45.40"></a><span id="l45.40">                      .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l45.41"></a><span id="l45.41"> };</span>
<a href="#l45.42"></a><span id="l45.42"> </span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-cal.convertByteArray = function calConvertByteArray(aResult, aResultLength, aCharset, aThrow) {</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+cal.convertByteArray = function(aResult, aResultLength, aCharset, aThrow) {</span>
<a href="#l45.45"></a><span id="l45.45">     try {</span>
<a href="#l45.46"></a><span id="l45.46">         let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l45.47"></a><span id="l45.47">                                         .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l45.48"></a><span id="l45.48">         resultConverter.charset = aCharset || &quot;UTF-8&quot;;</span>
<a href="#l45.49"></a><span id="l45.49">         return resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l45.50"></a><span id="l45.50">     } catch (e) {</span>
<a href="#l45.51"></a><span id="l45.51">         if (aThrow) {</span>
<a href="#l45.52"></a><span id="l45.52">             throw e;</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineat">@@ -108,17 +108,17 @@ cal.convertByteArray = function calConve</span>
<a href="#l45.54"></a><span id="l45.54">  *</span>
<a href="#l45.55"></a><span id="l45.55">  * NOTE: If the server only provides one realm for all calendars, be sure that</span>
<a href="#l45.56"></a><span id="l45.56">  * the |this| object implements calICalendar. In this case the calendar name</span>
<a href="#l45.57"></a><span id="l45.57">  * will be appended to the realm. If you need that feature disabled, see the</span>
<a href="#l45.58"></a><span id="l45.58">  * capabilities section of calICalendar.idl</span>
<a href="#l45.59"></a><span id="l45.59">  *</span>
<a href="#l45.60"></a><span id="l45.60">  * @param aIID      The interface ID to return</span>
<a href="#l45.61"></a><span id="l45.61">  */</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineminus">-cal.InterfaceRequestor_getInterface = function calInterfaceRequestor_getInterface(aIID) {</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineplus">+cal.InterfaceRequestor_getInterface = function(aIID) {</span>
<a href="#l45.64"></a><span id="l45.64">     try {</span>
<a href="#l45.65"></a><span id="l45.65">         // Try to query the this object for the requested interface but don't</span>
<a href="#l45.66"></a><span id="l45.66">         // throw if it fails since that borks the network code.</span>
<a href="#l45.67"></a><span id="l45.67">         return this.QueryInterface(aIID);</span>
<a href="#l45.68"></a><span id="l45.68">     } catch (e) {</span>
<a href="#l45.69"></a><span id="l45.69">         // Support Auth Prompt Interfaces</span>
<a href="#l45.70"></a><span id="l45.70">         if (aIID.equals(Components.interfaces.nsIAuthPrompt2)) {</span>
<a href="#l45.71"></a><span id="l45.71">             if (!this.calAuthPrompt) {</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineat">@@ -139,23 +139,23 @@ cal.InterfaceRequestor_getInterface = fu</span>
<a href="#l45.73"></a><span id="l45.73">     }</span>
<a href="#l45.74"></a><span id="l45.74">     return null;</span>
<a href="#l45.75"></a><span id="l45.75"> };</span>
<a href="#l45.76"></a><span id="l45.76"> </span>
<a href="#l45.77"></a><span id="l45.77"> /**</span>
<a href="#l45.78"></a><span id="l45.78">  * Bad Certificate Handler for Network Requests. Shows the Network Exception</span>
<a href="#l45.79"></a><span id="l45.79">  * Dialog if a certificate Problem occurs.</span>
<a href="#l45.80"></a><span id="l45.80">  */</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineminus">-cal.BadCertHandler = function calBadCertHandler(thisProvider) {</span>
<a href="#l45.82"></a><span id="l45.82" class="difflineplus">+cal.BadCertHandler = function(thisProvider) {</span>
<a href="#l45.83"></a><span id="l45.83">     this.thisProvider = thisProvider;</span>
<a href="#l45.84"></a><span id="l45.84"> };</span>
<a href="#l45.85"></a><span id="l45.85"> cal.BadCertHandler.prototype = {</span>
<a href="#l45.86"></a><span id="l45.86">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIBadCertListener2]),</span>
<a href="#l45.87"></a><span id="l45.87"> </span>
<a href="#l45.88"></a><span id="l45.88" class="difflineminus">-    notifyCertProblem: function cBCL_notifyCertProblem(socketInfo, status, targetSite) {</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+    notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l45.90"></a><span id="l45.90">         // Unfortunately we can't pass js objects using the window watcher, so</span>
<a href="#l45.91"></a><span id="l45.91">         // we'll just take the first available calendar window. We also need to</span>
<a href="#l45.92"></a><span id="l45.92">         // do this on a timer so that the modal window doesn't block the</span>
<a href="#l45.93"></a><span id="l45.93">         // network request.</span>
<a href="#l45.94"></a><span id="l45.94">         let calWindow = cal.getCalendarWindow();</span>
<a href="#l45.95"></a><span id="l45.95"> </span>
<a href="#l45.96"></a><span id="l45.96">         let timerCallback = {</span>
<a href="#l45.97"></a><span id="l45.97">             thisProvider: this.thisProvider,</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineat">@@ -191,17 +191,17 @@ cal.BadCertHandler.prototype = {</span>
<a href="#l45.99"></a><span id="l45.99">  * Freebusy interval implementation. All parameters are optional.</span>
<a href="#l45.100"></a><span id="l45.100">  *</span>
<a href="#l45.101"></a><span id="l45.101">  * @param aCalId         The calendar id to set up with.</span>
<a href="#l45.102"></a><span id="l45.102">  * @param aFreeBusyType  The type from calIFreeBusyInterval.</span>
<a href="#l45.103"></a><span id="l45.103">  * @param aStart         The start of the interval.</span>
<a href="#l45.104"></a><span id="l45.104">  * @param aEnd           The end of the interval.</span>
<a href="#l45.105"></a><span id="l45.105">  * @return               The fresh calIFreeBusyInterval.</span>
<a href="#l45.106"></a><span id="l45.106">  */</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineminus">-cal.FreeBusyInterval = function calFreeBusyInterval(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineplus">+cal.FreeBusyInterval = function(aCalId, aFreeBusyType, aStart, aEnd) {</span>
<a href="#l45.109"></a><span id="l45.109">     this.calId = aCalId;</span>
<a href="#l45.110"></a><span id="l45.110">     this.interval = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l45.111"></a><span id="l45.111">                               .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l45.112"></a><span id="l45.112">     this.interval.start = aStart;</span>
<a href="#l45.113"></a><span id="l45.113">     this.interval.end = aEnd;</span>
<a href="#l45.114"></a><span id="l45.114"> </span>
<a href="#l45.115"></a><span id="l45.115">     this.freeBusyType = aFreeBusyType || Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l45.116"></a><span id="l45.116"> };</span>
<a href="#l45.117"></a><span id="l45.117" class="difflineat">@@ -210,32 +210,32 @@ cal.FreeBusyInterval.prototype = {</span>
<a href="#l45.118"></a><span id="l45.118">     calId: null,</span>
<a href="#l45.119"></a><span id="l45.119">     interval: null,</span>
<a href="#l45.120"></a><span id="l45.120">     freeBusyType: Components.interfaces.calIFreeBusyInterval.UNKNOWN</span>
<a href="#l45.121"></a><span id="l45.121"> };</span>
<a href="#l45.122"></a><span id="l45.122"> </span>
<a href="#l45.123"></a><span id="l45.123"> /**</span>
<a href="#l45.124"></a><span id="l45.124">  * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l45.125"></a><span id="l45.125">  */</span>
<a href="#l45.126"></a><span id="l45.126" class="difflineminus">-cal.getImipTransport = function calGetImipTransport(aCalendar) {</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineplus">+cal.getImipTransport = function(aCalendar) {</span>
<a href="#l45.128"></a><span id="l45.128">     // assure an identity is configured for the calendar</span>
<a href="#l45.129"></a><span id="l45.129">     return (aCalendar.getProperty(&quot;imip.identity&quot;)</span>
<a href="#l45.130"></a><span id="l45.130">             ? Components.classes[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;]</span>
<a href="#l45.131"></a><span id="l45.131">                         .getService(Components.interfaces.calIItipTransport)</span>
<a href="#l45.132"></a><span id="l45.132">             : null);</span>
<a href="#l45.133"></a><span id="l45.133"> };</span>
<a href="#l45.134"></a><span id="l45.134"> </span>
<a href="#l45.135"></a><span id="l45.135"> /**</span>
<a href="#l45.136"></a><span id="l45.136">  * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l45.137"></a><span id="l45.137">  *</span>
<a href="#l45.138"></a><span id="l45.138">  * @param aCalendar     Calendar instance</span>
<a href="#l45.139"></a><span id="l45.139">  * @param outAccount    Optional out value for account</span>
<a href="#l45.140"></a><span id="l45.140">  * @return              The configured identity</span>
<a href="#l45.141"></a><span id="l45.141">  */</span>
<a href="#l45.142"></a><span id="l45.142" class="difflineminus">-cal.getEmailIdentityOfCalendar = function calGetEmailIdentityOfCalendar(aCalendar, outAccount) {</span>
<a href="#l45.143"></a><span id="l45.143" class="difflineplus">+cal.getEmailIdentityOfCalendar = function(aCalendar, outAccount) {</span>
<a href="#l45.144"></a><span id="l45.144">     cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l45.145"></a><span id="l45.145">     let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l45.146"></a><span id="l45.146">     if (key !== null) {</span>
<a href="#l45.147"></a><span id="l45.147">         if (key.length == 0) { // i.e. &quot;None&quot;</span>
<a href="#l45.148"></a><span id="l45.148">             return null;</span>
<a href="#l45.149"></a><span id="l45.149">         }</span>
<a href="#l45.150"></a><span id="l45.150">         let identity = null;</span>
<a href="#l45.151"></a><span id="l45.151">         cal.calIterateEmailIdentities(</span>
<a href="#l45.152"></a><span id="l45.152" class="difflineat">@@ -299,17 +299,17 @@ cal.getEmailIdentityOfCalendar = functio</span>
<a href="#l45.153"></a><span id="l45.153"> /**</span>
<a href="#l45.154"></a><span id="l45.154">  * fromRFC3339</span>
<a href="#l45.155"></a><span id="l45.155">  * Convert a RFC3339 compliant Date string to a calIDateTime.</span>
<a href="#l45.156"></a><span id="l45.156">  *</span>
<a href="#l45.157"></a><span id="l45.157">  * @param aStr          The RFC3339 compliant Date String</span>
<a href="#l45.158"></a><span id="l45.158">  * @param aTimezone     The timezone this date string is most likely in</span>
<a href="#l45.159"></a><span id="l45.159">  * @return              A calIDateTime object</span>
<a href="#l45.160"></a><span id="l45.160">  */</span>
<a href="#l45.161"></a><span id="l45.161" class="difflineminus">-cal.fromRFC3339 = function fromRFC3339(aStr, aTimezone) {</span>
<a href="#l45.162"></a><span id="l45.162" class="difflineplus">+cal.fromRFC3339 = function(aStr, aTimezone) {</span>
<a href="#l45.163"></a><span id="l45.163">     // XXX I have not covered leapseconds (matches[8]), this might need to</span>
<a href="#l45.164"></a><span id="l45.164">     // be done. The only reference to leap seconds I found is bug 227329.</span>
<a href="#l45.165"></a><span id="l45.165">     //</span>
<a href="#l45.166"></a><span id="l45.166"> </span>
<a href="#l45.167"></a><span id="l45.167">     // Create a DateTime instance (calUtils.js)</span>
<a href="#l45.168"></a><span id="l45.168">     let dateTime = cal.createDateTime();</span>
<a href="#l45.169"></a><span id="l45.169"> </span>
<a href="#l45.170"></a><span id="l45.170">     // Killer regex to parse RFC3339 dates</span>
<a href="#l45.171"></a><span id="l45.171" class="difflineat">@@ -384,17 +384,17 @@ cal.fromRFC3339 = function fromRFC3339(a</span>
<a href="#l45.172"></a><span id="l45.172"> </span>
<a href="#l45.173"></a><span id="l45.173"> /**</span>
<a href="#l45.174"></a><span id="l45.174">  * toRFC3339</span>
<a href="#l45.175"></a><span id="l45.175">  * Convert a calIDateTime to a RFC3339 compliant Date string</span>
<a href="#l45.176"></a><span id="l45.176">  *</span>
<a href="#l45.177"></a><span id="l45.177">  * @param aDateTime     The calIDateTime object</span>
<a href="#l45.178"></a><span id="l45.178">  * @return              The RFC3339 compliant date string</span>
<a href="#l45.179"></a><span id="l45.179">  */</span>
<a href="#l45.180"></a><span id="l45.180" class="difflineminus">-cal.toRFC3339 = function toRFC3339(aDateTime) {</span>
<a href="#l45.181"></a><span id="l45.181" class="difflineplus">+cal.toRFC3339 = function(aDateTime) {</span>
<a href="#l45.182"></a><span id="l45.182">     if (!aDateTime) {</span>
<a href="#l45.183"></a><span id="l45.183">         return &quot;&quot;;</span>
<a href="#l45.184"></a><span id="l45.184">     }</span>
<a href="#l45.185"></a><span id="l45.185"> </span>
<a href="#l45.186"></a><span id="l45.186">     let full_tzoffset = aDateTime.timezoneOffset;</span>
<a href="#l45.187"></a><span id="l45.187">     let tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l45.188"></a><span id="l45.188"> </span>
<a href="#l45.189"></a><span id="l45.189">     let tzoffset_mn = ((Math.abs(full_tzoffset) / 3600).toFixed(2) -</span>
<a href="#l45.190"></a><span id="l45.190" class="difflineat">@@ -420,69 +420,69 @@ cal.toRFC3339 = function toRFC3339(aDate</span>
<a href="#l45.191"></a><span id="l45.191">         } else {</span>
<a href="#l45.192"></a><span id="l45.192">             // ZULU Time, according to ISO8601's timezone-offset</span>
<a href="#l45.193"></a><span id="l45.193">             str += &quot;Z&quot;;</span>
<a href="#l45.194"></a><span id="l45.194">         }</span>
<a href="#l45.195"></a><span id="l45.195">     }</span>
<a href="#l45.196"></a><span id="l45.196">     return str;</span>
<a href="#l45.197"></a><span id="l45.197"> };</span>
<a href="#l45.198"></a><span id="l45.198"> </span>
<a href="#l45.199"></a><span id="l45.199" class="difflineminus">-cal.promptOverwrite = function cal_promptOverwrite(aMode, aItem) {</span>
<a href="#l45.200"></a><span id="l45.200" class="difflineplus">+cal.promptOverwrite = function(aMode, aItem) {</span>
<a href="#l45.201"></a><span id="l45.201">     let window = cal.getCalendarWindow();</span>
<a href="#l45.202"></a><span id="l45.202">     let args = { item: aItem,</span>
<a href="#l45.203"></a><span id="l45.203">                  mode: aMode,</span>
<a href="#l45.204"></a><span id="l45.204">                  overwrite: false };</span>
<a href="#l45.205"></a><span id="l45.205"> </span>
<a href="#l45.206"></a><span id="l45.206">     window.openDialog(&quot;chrome://calendar/content/calendar-conflicts-dialog.xul&quot;,</span>
<a href="#l45.207"></a><span id="l45.207">                       &quot;calendarConflictsDialog&quot;,</span>
<a href="#l45.208"></a><span id="l45.208">                       &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l45.209"></a><span id="l45.209">                       args);</span>
<a href="#l45.210"></a><span id="l45.210"> </span>
<a href="#l45.211"></a><span id="l45.211">     return args.overwrite;</span>
<a href="#l45.212"></a><span id="l45.212"> };</span>
<a href="#l45.213"></a><span id="l45.213"> </span>
<a href="#l45.214"></a><span id="l45.214"> /**</span>
<a href="#l45.215"></a><span id="l45.215">  * Observer bag implementation taking care to replay open batch notifications.</span>
<a href="#l45.216"></a><span id="l45.216">  */</span>
<a href="#l45.217"></a><span id="l45.217" class="difflineminus">-cal.ObserverBag = function calObserverBag(iid) {</span>
<a href="#l45.218"></a><span id="l45.218" class="difflineplus">+cal.ObserverBag = function(iid) {</span>
<a href="#l45.219"></a><span id="l45.219">     this.init(iid);</span>
<a href="#l45.220"></a><span id="l45.220"> };</span>
<a href="#l45.221"></a><span id="l45.221"> cal.ObserverBag.prototype = {</span>
<a href="#l45.222"></a><span id="l45.222">     __proto__: cal.calListenerBag.prototype,</span>
<a href="#l45.223"></a><span id="l45.223"> </span>
<a href="#l45.224"></a><span id="l45.224">     mBatchCount: 0,</span>
<a href="#l45.225"></a><span id="l45.225" class="difflineminus">-    notify: function calObserverBag_notify(func, args) {</span>
<a href="#l45.226"></a><span id="l45.226" class="difflineplus">+    notify: function(func, args) {</span>
<a href="#l45.227"></a><span id="l45.227">         switch (func) {</span>
<a href="#l45.228"></a><span id="l45.228">             case &quot;onStartBatch&quot;:</span>
<a href="#l45.229"></a><span id="l45.229">                  ++this.mBatchCount;</span>
<a href="#l45.230"></a><span id="l45.230">                  break;</span>
<a href="#l45.231"></a><span id="l45.231">             case &quot;onEndBatch&quot;:</span>
<a href="#l45.232"></a><span id="l45.232">                  --this.mBatchCount;</span>
<a href="#l45.233"></a><span id="l45.233">                  break;</span>
<a href="#l45.234"></a><span id="l45.234">         }</span>
<a href="#l45.235"></a><span id="l45.235">         return this.__proto__.__proto__.notify.apply(this, arguments);</span>
<a href="#l45.236"></a><span id="l45.236">     },</span>
<a href="#l45.237"></a><span id="l45.237"> </span>
<a href="#l45.238"></a><span id="l45.238" class="difflineminus">-    add: function calObserverBag_add(iface) {</span>
<a href="#l45.239"></a><span id="l45.239" class="difflineplus">+    add: function(iface) {</span>
<a href="#l45.240"></a><span id="l45.240">         if (this.__proto__.__proto__.add.apply(this, arguments) &amp;&amp; (this.mBatchCount &gt; 0)) {</span>
<a href="#l45.241"></a><span id="l45.241">             // Replay batch notifications, because the onEndBatch notifications are yet to come.</span>
<a href="#l45.242"></a><span id="l45.242">             // We may think about doing the reverse on remove, though I currently see no need:</span>
<a href="#l45.243"></a><span id="l45.243">             for (let i = this.mBatchCount; i--;) {</span>
<a href="#l45.244"></a><span id="l45.244">                 iface.onStartBatch();</span>
<a href="#l45.245"></a><span id="l45.245">             }</span>
<a href="#l45.246"></a><span id="l45.246">         }</span>
<a href="#l45.247"></a><span id="l45.247">     }</span>
<a href="#l45.248"></a><span id="l45.248"> };</span>
<a href="#l45.249"></a><span id="l45.249"> </span>
<a href="#l45.250"></a><span id="l45.250"> /**</span>
<a href="#l45.251"></a><span id="l45.251">  * Base prototype to be used implementing a provider.</span>
<a href="#l45.252"></a><span id="l45.252">  *</span>
<a href="#l45.253"></a><span id="l45.253">  * @see e.g. providers/gdata</span>
<a href="#l45.254"></a><span id="l45.254">  */</span>
<a href="#l45.255"></a><span id="l45.255" class="difflineminus">-cal.ProviderBase = function calProviderBase() {</span>
<a href="#l45.256"></a><span id="l45.256" class="difflineplus">+cal.ProviderBase = function() {</span>
<a href="#l45.257"></a><span id="l45.257">     cal.ASSERT(&quot;This prototype should only be inherited!&quot;);</span>
<a href="#l45.258"></a><span id="l45.258"> };</span>
<a href="#l45.259"></a><span id="l45.259"> cal.ProviderBase.mTransientProperties = {</span>
<a href="#l45.260"></a><span id="l45.260">     &quot;cache.uncachedCalendar&quot;: true,</span>
<a href="#l45.261"></a><span id="l45.261">     &quot;currentStatus&quot;: true,</span>
<a href="#l45.262"></a><span id="l45.262">     &quot;itip.transport&quot;: true,</span>
<a href="#l45.263"></a><span id="l45.263">     &quot;imip.identity&quot;: true,</span>
<a href="#l45.264"></a><span id="l45.264">     &quot;imip.account&quot;: true,</span>
<a href="#l45.265"></a><span id="l45.265" class="difflineat">@@ -497,17 +497,17 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.266"></a><span id="l45.266">     ]),</span>
<a href="#l45.267"></a><span id="l45.267"> </span>
<a href="#l45.268"></a><span id="l45.268">     mID: null,</span>
<a href="#l45.269"></a><span id="l45.269">     mUri: null,</span>
<a href="#l45.270"></a><span id="l45.270">     mACLEntry: null,</span>
<a href="#l45.271"></a><span id="l45.271">     mObservers: null,</span>
<a href="#l45.272"></a><span id="l45.272">     mProperties: null,</span>
<a href="#l45.273"></a><span id="l45.273"> </span>
<a href="#l45.274"></a><span id="l45.274" class="difflineminus">-    initProviderBase: function cPB_initProviderBase() {</span>
<a href="#l45.275"></a><span id="l45.275" class="difflineplus">+    initProviderBase: function() {</span>
<a href="#l45.276"></a><span id="l45.276">         this.wrappedJSObject = this;</span>
<a href="#l45.277"></a><span id="l45.277">         this.mObservers = new cal.ObserverBag(Components.interfaces.calIObserver);</span>
<a href="#l45.278"></a><span id="l45.278">         this.mProperties = {};</span>
<a href="#l45.279"></a><span id="l45.279">         this.mProperties.currentStatus = Components.results.NS_OK;</span>
<a href="#l45.280"></a><span id="l45.280">     },</span>
<a href="#l45.281"></a><span id="l45.281"> </span>
<a href="#l45.282"></a><span id="l45.282">     get observers() {</span>
<a href="#l45.283"></a><span id="l45.283">         return this.mObservers;</span>
<a href="#l45.284"></a><span id="l45.284" class="difflineat">@@ -605,52 +605,43 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.285"></a><span id="l45.285"> </span>
<a href="#l45.286"></a><span id="l45.286">     // readonly attribute boolean canRefresh;</span>
<a href="#l45.287"></a><span id="l45.287">     get canRefresh() {</span>
<a href="#l45.288"></a><span id="l45.288">         return false;</span>
<a href="#l45.289"></a><span id="l45.289">     },</span>
<a href="#l45.290"></a><span id="l45.290"> </span>
<a href="#l45.291"></a><span id="l45.291">     // void startBatch();</span>
<a href="#l45.292"></a><span id="l45.292">     mBatchCount: 0,</span>
<a href="#l45.293"></a><span id="l45.293" class="difflineminus">-    startBatch: function cPB_startBatch() {</span>
<a href="#l45.294"></a><span id="l45.294" class="difflineplus">+    startBatch: function() {</span>
<a href="#l45.295"></a><span id="l45.295">         if (this.mBatchCount++ == 0) {</span>
<a href="#l45.296"></a><span id="l45.296">             this.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l45.297"></a><span id="l45.297">         }</span>
<a href="#l45.298"></a><span id="l45.298">     },</span>
<a href="#l45.299"></a><span id="l45.299"> </span>
<a href="#l45.300"></a><span id="l45.300" class="difflineminus">-    endBatch: function cPB_endBatch() {</span>
<a href="#l45.301"></a><span id="l45.301" class="difflineplus">+    endBatch: function() {</span>
<a href="#l45.302"></a><span id="l45.302">         if (this.mBatchCount &gt; 0) {</span>
<a href="#l45.303"></a><span id="l45.303">             if (--this.mBatchCount == 0) {</span>
<a href="#l45.304"></a><span id="l45.304">                 this.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l45.305"></a><span id="l45.305">             }</span>
<a href="#l45.306"></a><span id="l45.306">         } else {</span>
<a href="#l45.307"></a><span id="l45.307">             cal.ASSERT(this.mBatchCount &gt; 0, &quot;unexepcted endBatch!&quot;);</span>
<a href="#l45.308"></a><span id="l45.308">         }</span>
<a href="#l45.309"></a><span id="l45.309">     },</span>
<a href="#l45.310"></a><span id="l45.310"> </span>
<a href="#l45.311"></a><span id="l45.311" class="difflineminus">-    notifyPureOperationComplete: function cPB_notifyPureOperationComplete(aListener,</span>
<a href="#l45.312"></a><span id="l45.312" class="difflineminus">-                                                                          aStatus,</span>
<a href="#l45.313"></a><span id="l45.313" class="difflineminus">-                                                                          aOperationType,</span>
<a href="#l45.314"></a><span id="l45.314" class="difflineminus">-                                                                          aId,</span>
<a href="#l45.315"></a><span id="l45.315" class="difflineminus">-                                                                          aDetail) {</span>
<a href="#l45.316"></a><span id="l45.316" class="difflineplus">+    notifyPureOperationComplete: function(aListener, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l45.317"></a><span id="l45.317">         if (aListener) {</span>
<a href="#l45.318"></a><span id="l45.318">             try {</span>
<a href="#l45.319"></a><span id="l45.319">                 aListener.onOperationComplete(this.superCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l45.320"></a><span id="l45.320">             } catch (exc) {</span>
<a href="#l45.321"></a><span id="l45.321">                 cal.ERROR(exc);</span>
<a href="#l45.322"></a><span id="l45.322">             }</span>
<a href="#l45.323"></a><span id="l45.323">         }</span>
<a href="#l45.324"></a><span id="l45.324">     },</span>
<a href="#l45.325"></a><span id="l45.325"> </span>
<a href="#l45.326"></a><span id="l45.326" class="difflineminus">-    notifyOperationComplete: function cPB_notifyOperationComplete(aListener,</span>
<a href="#l45.327"></a><span id="l45.327" class="difflineminus">-                                                                  aStatus,</span>
<a href="#l45.328"></a><span id="l45.328" class="difflineminus">-                                                                  aOperationType,</span>
<a href="#l45.329"></a><span id="l45.329" class="difflineminus">-                                                                  aId,</span>
<a href="#l45.330"></a><span id="l45.330" class="difflineminus">-                                                                  aDetail,</span>
<a href="#l45.331"></a><span id="l45.331" class="difflineminus">-                                                                  aExtraMessage) {</span>
<a href="#l45.332"></a><span id="l45.332" class="difflineplus">+    notifyOperationComplete: function(aListener, aStatus, aOperationType, aId, aDetail, aExtraMessage) {</span>
<a href="#l45.333"></a><span id="l45.333">         this.notifyPureOperationComplete(aListener, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l45.334"></a><span id="l45.334"> </span>
<a href="#l45.335"></a><span id="l45.335">         if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l45.336"></a><span id="l45.336">             return; // cancellation doesn't change current status, no notification</span>
<a href="#l45.337"></a><span id="l45.337">         }</span>
<a href="#l45.338"></a><span id="l45.338">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l45.339"></a><span id="l45.339">             this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l45.340"></a><span id="l45.340">         } else {</span>
<a href="#l45.341"></a><span id="l45.341" class="difflineat">@@ -662,17 +653,17 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.342"></a><span id="l45.342">             this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l45.343"></a><span id="l45.343">                              ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l45.344"></a><span id="l45.344">                              : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l45.345"></a><span id="l45.345">                              aExtraMessage || &quot;&quot;);</span>
<a href="#l45.346"></a><span id="l45.346">         }</span>
<a href="#l45.347"></a><span id="l45.347">     },</span>
<a href="#l45.348"></a><span id="l45.348"> </span>
<a href="#l45.349"></a><span id="l45.349">     // for convenience also callable with just an exception</span>
<a href="#l45.350"></a><span id="l45.350" class="difflineminus">-    notifyError: function cPB_notifyError(aErrNo, aMessage) {</span>
<a href="#l45.351"></a><span id="l45.351" class="difflineplus">+    notifyError: function(aErrNo, aMessage) {</span>
<a href="#l45.352"></a><span id="l45.352">         if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l45.353"></a><span id="l45.353">             return; // cancellation doesn't change current status, no notification</span>
<a href="#l45.354"></a><span id="l45.354">         }</span>
<a href="#l45.355"></a><span id="l45.355">         if (aErrNo instanceof Components.interfaces.nsIException) {</span>
<a href="#l45.356"></a><span id="l45.356">             if (!aMessage) {</span>
<a href="#l45.357"></a><span id="l45.357">                 aMessage = aErrNo.message;</span>
<a href="#l45.358"></a><span id="l45.358">             }</span>
<a href="#l45.359"></a><span id="l45.359">             aErrNo = aErrNo.result;</span>
<a href="#l45.360"></a><span id="l45.360" class="difflineat">@@ -685,17 +676,17 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.361"></a><span id="l45.361">     get transientProperties() {</span>
<a href="#l45.362"></a><span id="l45.362">         return this.mTransientPropertiesMode;</span>
<a href="#l45.363"></a><span id="l45.363">     },</span>
<a href="#l45.364"></a><span id="l45.364">     set transientProperties(value) {</span>
<a href="#l45.365"></a><span id="l45.365">         return (this.mTransientPropertiesMode = value);</span>
<a href="#l45.366"></a><span id="l45.366">     },</span>
<a href="#l45.367"></a><span id="l45.367"> </span>
<a href="#l45.368"></a><span id="l45.368">     // nsIVariant getProperty(in AUTF8String aName);</span>
<a href="#l45.369"></a><span id="l45.369" class="difflineminus">-    getProperty: function cPB_getProperty(aName) {</span>
<a href="#l45.370"></a><span id="l45.370" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l45.371"></a><span id="l45.371">         switch (aName) {</span>
<a href="#l45.372"></a><span id="l45.372">             case &quot;itip.transport&quot;: // iTIP/iMIP default:</span>
<a href="#l45.373"></a><span id="l45.373">                 return cal.getImipTransport(this);</span>
<a href="#l45.374"></a><span id="l45.374">             case &quot;itip.notify-replies&quot;: // iTIP/iMIP default:</span>
<a href="#l45.375"></a><span id="l45.375">                  return Preferences.get(&quot;calendar.itip.notify-replies&quot;, false);</span>
<a href="#l45.376"></a><span id="l45.376">             // temporary hack to get the uncached calendar instance:</span>
<a href="#l45.377"></a><span id="l45.377">             case &quot;cache.uncachedCalendar&quot;:</span>
<a href="#l45.378"></a><span id="l45.378">                 return this;</span>
<a href="#l45.379"></a><span id="l45.379" class="difflineat">@@ -749,17 +740,17 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.380"></a><span id="l45.380">             }</span>
<a href="#l45.381"></a><span id="l45.381">             this.mProperties[aName] = ret;</span>
<a href="#l45.382"></a><span id="l45.382">         }</span>
<a href="#l45.383"></a><span id="l45.383"> //         cal.LOG(&quot;getProperty(\&quot;&quot; + aName + &quot;\&quot;): &quot; + ret);</span>
<a href="#l45.384"></a><span id="l45.384">         return ret;</span>
<a href="#l45.385"></a><span id="l45.385">     },</span>
<a href="#l45.386"></a><span id="l45.386"> </span>
<a href="#l45.387"></a><span id="l45.387">     // void setProperty(in AUTF8String aName, in nsIVariant aValue);</span>
<a href="#l45.388"></a><span id="l45.388" class="difflineminus">-    setProperty: function cPB_setProperty(aName, aValue) {</span>
<a href="#l45.389"></a><span id="l45.389" class="difflineplus">+    setProperty: function(aName, aValue) {</span>
<a href="#l45.390"></a><span id="l45.390">         let oldValue = this.getProperty(aName);</span>
<a href="#l45.391"></a><span id="l45.391">         if (oldValue != aValue) {</span>
<a href="#l45.392"></a><span id="l45.392">             this.mProperties[aName] = aValue;</span>
<a href="#l45.393"></a><span id="l45.393">             switch (aName) {</span>
<a href="#l45.394"></a><span id="l45.394">                 case &quot;imip.identity.key&quot;: // invalidate identity and account object if key is set:</span>
<a href="#l45.395"></a><span id="l45.395">                     delete this.mProperties[&quot;imip.identity&quot;];</span>
<a href="#l45.396"></a><span id="l45.396">                     delete this.mProperties[&quot;imip.account&quot;];</span>
<a href="#l45.397"></a><span id="l45.397">                     delete this.mProperties.organizerId;</span>
<a href="#l45.398"></a><span id="l45.398" class="difflineat">@@ -773,39 +764,39 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.399"></a><span id="l45.399">             }</span>
<a href="#l45.400"></a><span id="l45.400">             this.mObservers.notify(&quot;onPropertyChanged&quot;,</span>
<a href="#l45.401"></a><span id="l45.401">                                    [this.superCalendar, aName, aValue, oldValue]);</span>
<a href="#l45.402"></a><span id="l45.402">         }</span>
<a href="#l45.403"></a><span id="l45.403">         return aValue;</span>
<a href="#l45.404"></a><span id="l45.404">     },</span>
<a href="#l45.405"></a><span id="l45.405"> </span>
<a href="#l45.406"></a><span id="l45.406">     // void deleteProperty(in AUTF8String aName);</span>
<a href="#l45.407"></a><span id="l45.407" class="difflineminus">-    deleteProperty: function cPB_deleteProperty(aName) {</span>
<a href="#l45.408"></a><span id="l45.408" class="difflineplus">+    deleteProperty: function(aName) {</span>
<a href="#l45.409"></a><span id="l45.409">         this.mObservers.notify(&quot;onPropertyDeleting&quot;, [this.superCalendar, aName]);</span>
<a href="#l45.410"></a><span id="l45.410">         delete this.mProperties[aName];</span>
<a href="#l45.411"></a><span id="l45.411">         cal.getCalendarManager().deleteCalendarPref_(this, aName);</span>
<a href="#l45.412"></a><span id="l45.412">     },</span>
<a href="#l45.413"></a><span id="l45.413"> </span>
<a href="#l45.414"></a><span id="l45.414">     // calIOperation refresh</span>
<a href="#l45.415"></a><span id="l45.415" class="difflineminus">-    refresh: function cPB_refresh() {</span>
<a href="#l45.416"></a><span id="l45.416" class="difflineplus">+    refresh: function() {</span>
<a href="#l45.417"></a><span id="l45.417">         return null;</span>
<a href="#l45.418"></a><span id="l45.418">     },</span>
<a href="#l45.419"></a><span id="l45.419"> </span>
<a href="#l45.420"></a><span id="l45.420">     // void addObserver( in calIObserver observer );</span>
<a href="#l45.421"></a><span id="l45.421" class="difflineminus">-    addObserver: function cPB_addObserver(aObserver) {</span>
<a href="#l45.422"></a><span id="l45.422" class="difflineplus">+    addObserver: function(aObserver) {</span>
<a href="#l45.423"></a><span id="l45.423">         this.mObservers.add(aObserver);</span>
<a href="#l45.424"></a><span id="l45.424">     },</span>
<a href="#l45.425"></a><span id="l45.425"> </span>
<a href="#l45.426"></a><span id="l45.426">     // void removeObserver( in calIObserver observer );</span>
<a href="#l45.427"></a><span id="l45.427" class="difflineminus">-    removeObserver: function cPB_removeObserver(aObserver) {</span>
<a href="#l45.428"></a><span id="l45.428" class="difflineplus">+    removeObserver: function(aObserver) {</span>
<a href="#l45.429"></a><span id="l45.429">         this.mObservers.remove(aObserver);</span>
<a href="#l45.430"></a><span id="l45.430">     },</span>
<a href="#l45.431"></a><span id="l45.431"> </span>
<a href="#l45.432"></a><span id="l45.432">     // calISchedulingSupport: Implementation corresponding to our iTIP/iMIP support</span>
<a href="#l45.433"></a><span id="l45.433" class="difflineminus">-    isInvitation: function cPB_isInvitation(aItem) {</span>
<a href="#l45.434"></a><span id="l45.434" class="difflineplus">+    isInvitation: function(aItem) {</span>
<a href="#l45.435"></a><span id="l45.435">         if (!this.mACLEntry || !this.mACLEntry.hasAccessControl) {</span>
<a href="#l45.436"></a><span id="l45.436">             // No ACL support - fallback to the old method</span>
<a href="#l45.437"></a><span id="l45.437">             let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l45.438"></a><span id="l45.438">             if (id) {</span>
<a href="#l45.439"></a><span id="l45.439">                 let org = aItem.organizer;</span>
<a href="#l45.440"></a><span id="l45.440">                 if (!org || !org.id || (org.id.toLowerCase() == id.toLowerCase())) {</span>
<a href="#l45.441"></a><span id="l45.441">                     return false;</span>
<a href="#l45.442"></a><span id="l45.442">                 }</span>
<a href="#l45.443"></a><span id="l45.443" class="difflineat">@@ -842,17 +833,17 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.444"></a><span id="l45.444">             if (aItem.getAttendeeById(identity) != null) {</span>
<a href="#l45.445"></a><span id="l45.445">                 return true;</span>
<a href="#l45.446"></a><span id="l45.446">             }</span>
<a href="#l45.447"></a><span id="l45.447">         }</span>
<a href="#l45.448"></a><span id="l45.448"> </span>
<a href="#l45.449"></a><span id="l45.449">         return false;</span>
<a href="#l45.450"></a><span id="l45.450">     },</span>
<a href="#l45.451"></a><span id="l45.451"> </span>
<a href="#l45.452"></a><span id="l45.452" class="difflineminus">-    getInvitedAttendee: function cPB_getInvitedAttendee(aItem) {</span>
<a href="#l45.453"></a><span id="l45.453" class="difflineplus">+    getInvitedAttendee: function(aItem) {</span>
<a href="#l45.454"></a><span id="l45.454">         let id = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l45.455"></a><span id="l45.455">         let attendee = (id ? aItem.getAttendeeById(id) : null);</span>
<a href="#l45.456"></a><span id="l45.456"> </span>
<a href="#l45.457"></a><span id="l45.457">         if (!attendee &amp;&amp; this.mACLEntry &amp;&amp; this.mACLEntry.hasAccessControl) {</span>
<a href="#l45.458"></a><span id="l45.458">             let ownerIdentities = this.mACLEntry.getOwnerIdentities({});</span>
<a href="#l45.459"></a><span id="l45.459">             if (ownerIdentities.length &gt; 0) {</span>
<a href="#l45.460"></a><span id="l45.460">                 let identity;</span>
<a href="#l45.461"></a><span id="l45.461">                 for (let i = 0; !attendee &amp;&amp; i &lt; ownerIdentities.length; i++) {</span>
<a href="#l45.462"></a><span id="l45.462" class="difflineat">@@ -860,12 +851,12 @@ cal.ProviderBase.prototype = {</span>
<a href="#l45.463"></a><span id="l45.463">                     attendee = aItem.getAttendeeById(identity);</span>
<a href="#l45.464"></a><span id="l45.464">                 }</span>
<a href="#l45.465"></a><span id="l45.465">             }</span>
<a href="#l45.466"></a><span id="l45.466">         }</span>
<a href="#l45.467"></a><span id="l45.467"> </span>
<a href="#l45.468"></a><span id="l45.468">         return attendee;</span>
<a href="#l45.469"></a><span id="l45.469">     },</span>
<a href="#l45.470"></a><span id="l45.470"> </span>
<a href="#l45.471"></a><span id="l45.471" class="difflineminus">-    canNotify: function cPB_canNotify(aMethod, aItem) {</span>
<a href="#l45.472"></a><span id="l45.472" class="difflineplus">+    canNotify: function(aMethod, aItem) {</span>
<a href="#l45.473"></a><span id="l45.473">         return false; // use outbound iTIP for all</span>
<a href="#l45.474"></a><span id="l45.474">     }</span>
<a href="#l45.475"></a><span id="l45.475"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -26,17 +26,17 @@ var cal = {</span>
<a href="#l46.4"></a><span id="l46.4"> </span>
<a href="#l46.5"></a><span id="l46.5">     /**</span>
<a href="#l46.6"></a><span id="l46.6">      * Loads an array of calendar scripts into the passed scope.</span>
<a href="#l46.7"></a><span id="l46.7">      *</span>
<a href="#l46.8"></a><span id="l46.8">      * @param scriptNames an array of calendar script names</span>
<a href="#l46.9"></a><span id="l46.9">      * @param scope       scope to load into</span>
<a href="#l46.10"></a><span id="l46.10">      * @param baseDir     base dir; defaults to calendar-js/</span>
<a href="#l46.11"></a><span id="l46.11">      */</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-    loadScripts: function cal_loadScripts(scriptNames, scope, baseDir) {</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+    loadScripts: function(scriptNames, scope, baseDir) {</span>
<a href="#l46.14"></a><span id="l46.14">         if (!baseDir) {</span>
<a href="#l46.15"></a><span id="l46.15">             baseDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l46.16"></a><span id="l46.16">             baseDir.append(&quot;calendar-js&quot;);</span>
<a href="#l46.17"></a><span id="l46.17">         }</span>
<a href="#l46.18"></a><span id="l46.18"> </span>
<a href="#l46.19"></a><span id="l46.19">         for (let script of scriptNames) {</span>
<a href="#l46.20"></a><span id="l46.20">             if (!script) {</span>
<a href="#l46.21"></a><span id="l46.21">                 // If the array element is null, then just skip this script.</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineat">@@ -49,33 +49,33 @@ var cal = {</span>
<a href="#l46.23"></a><span id="l46.23">                 Services.scriptloader.loadSubScript(scriptUrlSpec, scope);</span>
<a href="#l46.24"></a><span id="l46.24">             } catch (exc) {</span>
<a href="#l46.25"></a><span id="l46.25">                 Components.utils.reportError(exc + &quot; (&quot; + scriptUrlSpec + &quot;)&quot;);</span>
<a href="#l46.26"></a><span id="l46.26">             }</span>
<a href="#l46.27"></a><span id="l46.27">         }</span>
<a href="#l46.28"></a><span id="l46.28">     },</span>
<a href="#l46.29"></a><span id="l46.29"> </span>
<a href="#l46.30"></a><span id="l46.30">     loadingNSGetFactory: function(scriptNames, components, scope) {</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-        return function NSGetFactory(cid) {</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+        return function(cid) {</span>
<a href="#l46.33"></a><span id="l46.33">             if (!this.inner) {</span>
<a href="#l46.34"></a><span id="l46.34">                 let global = Components.utils.getGlobalForObject(scope);</span>
<a href="#l46.35"></a><span id="l46.35">                 cal.loadScripts(scriptNames, global);</span>
<a href="#l46.36"></a><span id="l46.36">                 if (typeof components == &quot;function&quot;) {</span>
<a href="#l46.37"></a><span id="l46.37">                     components = components.call(global);</span>
<a href="#l46.38"></a><span id="l46.38">                 }</span>
<a href="#l46.39"></a><span id="l46.39">                 this.inner = XPCOMUtils.generateNSGetFactory(components);</span>
<a href="#l46.40"></a><span id="l46.40">             }</span>
<a href="#l46.41"></a><span id="l46.41">             return this.inner(cid);</span>
<a href="#l46.42"></a><span id="l46.42">         };</span>
<a href="#l46.43"></a><span id="l46.43">     },</span>
<a href="#l46.44"></a><span id="l46.44"> </span>
<a href="#l46.45"></a><span id="l46.45">     /**</span>
<a href="#l46.46"></a><span id="l46.46">      * Schedules execution of the passed function to the current thread's queue.</span>
<a href="#l46.47"></a><span id="l46.47">      */</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineminus">-    postPone: function cal_postPone(func) {</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+    postPone: function(func) {</span>
<a href="#l46.50"></a><span id="l46.50">         if (this.threadingEnabled) {</span>
<a href="#l46.51"></a><span id="l46.51">             Services.tm.currentThread.dispatch({ run: func },</span>
<a href="#l46.52"></a><span id="l46.52">                                                Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l46.53"></a><span id="l46.53">         } else {</span>
<a href="#l46.54"></a><span id="l46.54">             func();</span>
<a href="#l46.55"></a><span id="l46.55">         }</span>
<a href="#l46.56"></a><span id="l46.56">     },</span>
<a href="#l46.57"></a><span id="l46.57"> </span>
<a href="#l46.58"></a><span id="l46.58" class="difflineat">@@ -90,17 +90,17 @@ var cal = {</span>
<a href="#l46.59"></a><span id="l46.59">      *                    clean adapter.</span>
<a href="#l46.60"></a><span id="l46.60">      *</span>
<a href="#l46.61"></a><span id="l46.61">      * Currently supported interfaces are:</span>
<a href="#l46.62"></a><span id="l46.62">      *  - calIObserver</span>
<a href="#l46.63"></a><span id="l46.63">      *  - calICalendarManagerObserver</span>
<a href="#l46.64"></a><span id="l46.64">      *  - calIOperationListener</span>
<a href="#l46.65"></a><span id="l46.65">      *  - calICompositeObserver</span>
<a href="#l46.66"></a><span id="l46.66">      */</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineminus">-    createAdapter: function createAdapter(iface, template) {</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineplus">+    createAdapter: function(iface, template) {</span>
<a href="#l46.69"></a><span id="l46.69">         let methods;</span>
<a href="#l46.70"></a><span id="l46.70">         let adapter = template || {};</span>
<a href="#l46.71"></a><span id="l46.71">         switch (iface.name || iface) {</span>
<a href="#l46.72"></a><span id="l46.72">             case &quot;calIObserver&quot;:</span>
<a href="#l46.73"></a><span id="l46.73">                 methods = [&quot;onStartBatch&quot;, &quot;onEndBatch&quot;, &quot;onLoad&quot;, &quot;onAddItem&quot;,</span>
<a href="#l46.74"></a><span id="l46.74">                            &quot;onModifyItem&quot;, &quot;onDeleteItem&quot;, &quot;onError&quot;,</span>
<a href="#l46.75"></a><span id="l46.75">                            &quot;onPropertyChanged&quot;, &quot;onPropertyDeleting&quot;];</span>
<a href="#l46.76"></a><span id="l46.76">                 break;</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineat">@@ -137,43 +137,43 @@ var cal = {</span>
<a href="#l46.78"></a><span id="l46.78">         return gCalThreadingEnabled;</span>
<a href="#l46.79"></a><span id="l46.79">     },</span>
<a href="#l46.80"></a><span id="l46.80"> </span>
<a href="#l46.81"></a><span id="l46.81">     /*</span>
<a href="#l46.82"></a><span id="l46.82">      * Checks whether a calendar supports events</span>
<a href="#l46.83"></a><span id="l46.83">      *</span>
<a href="#l46.84"></a><span id="l46.84">      * @param aCalendar</span>
<a href="#l46.85"></a><span id="l46.85">      */</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineminus">-    isEventCalendar: function cal_isEventCalendar(aCalendar) {</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineplus">+    isEventCalendar: function(aCalendar) {</span>
<a href="#l46.88"></a><span id="l46.88">         return (aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false);</span>
<a href="#l46.89"></a><span id="l46.89">     },</span>
<a href="#l46.90"></a><span id="l46.90"> </span>
<a href="#l46.91"></a><span id="l46.91">     /*</span>
<a href="#l46.92"></a><span id="l46.92">      * Checks whether a calendar supports tasks</span>
<a href="#l46.93"></a><span id="l46.93">      *</span>
<a href="#l46.94"></a><span id="l46.94">      * @param aCalendar</span>
<a href="#l46.95"></a><span id="l46.95">      */</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineminus">-    isTaskCalendar: function cal_isTaskCalendar(aCalendar) {</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+    isTaskCalendar: function(aCalendar) {</span>
<a href="#l46.98"></a><span id="l46.98">         return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l46.99"></a><span id="l46.99">     },</span>
<a href="#l46.100"></a><span id="l46.100"> </span>
<a href="#l46.101"></a><span id="l46.101">     /**</span>
<a href="#l46.102"></a><span id="l46.102">      * Checks whether a timezone lacks a definition.</span>
<a href="#l46.103"></a><span id="l46.103">      */</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineminus">-    isPhantomTimezone: function cal_isPhantomTimezone(tz) {</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineplus">+    isPhantomTimezone: function(tz) {</span>
<a href="#l46.106"></a><span id="l46.106">         return (!tz.icalComponent &amp;&amp; !tz.isUTC &amp;&amp; !tz.isFloating);</span>
<a href="#l46.107"></a><span id="l46.107">     },</span>
<a href="#l46.108"></a><span id="l46.108"> </span>
<a href="#l46.109"></a><span id="l46.109">     /**</span>
<a href="#l46.110"></a><span id="l46.110">      * Shifts an item by the given timely offset.</span>
<a href="#l46.111"></a><span id="l46.111">      *</span>
<a href="#l46.112"></a><span id="l46.112">      * @param item an item</span>
<a href="#l46.113"></a><span id="l46.113">      * @param offset an offset (calIDuration)</span>
<a href="#l46.114"></a><span id="l46.114">      */</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineminus">-    shiftItem: function cal_shiftItem(item, offset) {</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineplus">+    shiftItem: function(item, offset) {</span>
<a href="#l46.117"></a><span id="l46.117">         // When modifying dates explicitly using the setters is important</span>
<a href="#l46.118"></a><span id="l46.118">         // since those may triggers e.g. calIRecurrenceInfo::onStartDateChange</span>
<a href="#l46.119"></a><span id="l46.119">         // or invalidate other properties. Moreover don't modify the date-time objects</span>
<a href="#l46.120"></a><span id="l46.120">         // without cloning, because changes cannot be calculated if doing so.</span>
<a href="#l46.121"></a><span id="l46.121">         if (cal.isEvent(item)) {</span>
<a href="#l46.122"></a><span id="l46.122">             let date = item.startDate.clone();</span>
<a href="#l46.123"></a><span id="l46.123">             date.addDuration(offset);</span>
<a href="#l46.124"></a><span id="l46.124">             item.startDate = date;</span>
<a href="#l46.125"></a><span id="l46.125" class="difflineat">@@ -221,27 +221,27 @@ var cal = {</span>
<a href="#l46.126"></a><span id="l46.126">             item = item.makeImmutable();</span>
<a href="#l46.127"></a><span id="l46.127">         }</span>
<a href="#l46.128"></a><span id="l46.128">         return item;</span>
<a href="#l46.129"></a><span id="l46.129">     },</span>
<a href="#l46.130"></a><span id="l46.130"> </span>
<a href="#l46.131"></a><span id="l46.131">     /**</span>
<a href="#l46.132"></a><span id="l46.132">      * Shortcut function to serialize an item (including all overridden items).</span>
<a href="#l46.133"></a><span id="l46.133">      */</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineminus">-    getSerializedItem: function cal_getSerializedItem(aItem) {</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineplus">+    getSerializedItem: function(aItem) {</span>
<a href="#l46.136"></a><span id="l46.136">         let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l46.137"></a><span id="l46.137">                                    .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l46.138"></a><span id="l46.138">         serializer.addItems([aItem], 1);</span>
<a href="#l46.139"></a><span id="l46.139">         return serializer.serializeToString();</span>
<a href="#l46.140"></a><span id="l46.140">     },</span>
<a href="#l46.141"></a><span id="l46.141"> </span>
<a href="#l46.142"></a><span id="l46.142">     /**</span>
<a href="#l46.143"></a><span id="l46.143">      * Shortcut function to check whether an item is an invitation copy.</span>
<a href="#l46.144"></a><span id="l46.144">      */</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineminus">-    isInvitation: function cal_isInvitation(aItem) {</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+    isInvitation: function(aItem) {</span>
<a href="#l46.147"></a><span id="l46.147">         let isInvitation = false;</span>
<a href="#l46.148"></a><span id="l46.148">         let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l46.149"></a><span id="l46.149">         if (calendar) {</span>
<a href="#l46.150"></a><span id="l46.150">             isInvitation = calendar.isInvitation(aItem);</span>
<a href="#l46.151"></a><span id="l46.151">         }</span>
<a href="#l46.152"></a><span id="l46.152">         return isInvitation;</span>
<a href="#l46.153"></a><span id="l46.153">     },</span>
<a href="#l46.154"></a><span id="l46.154"> </span>
<a href="#l46.155"></a><span id="l46.155" class="difflineat">@@ -301,17 +301,17 @@ var cal = {</span>
<a href="#l46.156"></a><span id="l46.156">     },</span>
<a href="#l46.157"></a><span id="l46.157"> </span>
<a href="#l46.158"></a><span id="l46.158">     /**</span>
<a href="#l46.159"></a><span id="l46.159">      * Shortcut function to check whether an item is an invitation copy and</span>
<a href="#l46.160"></a><span id="l46.160">      * has a participation status of either NEEDS-ACTION or TENTATIVE.</span>
<a href="#l46.161"></a><span id="l46.161">      *</span>
<a href="#l46.162"></a><span id="l46.162">      * @param aItem either calIAttendee or calIItemBase</span>
<a href="#l46.163"></a><span id="l46.163">      */</span>
<a href="#l46.164"></a><span id="l46.164" class="difflineminus">-    isOpenInvitation: function cal_isOpenInvitation(aItem) {</span>
<a href="#l46.165"></a><span id="l46.165" class="difflineplus">+    isOpenInvitation: function(aItem) {</span>
<a href="#l46.166"></a><span id="l46.166">         let wrappedItem = cal.wrapInstance(aItem, Components.interfaces.calIAttendee);</span>
<a href="#l46.167"></a><span id="l46.167">         if (!wrappedItem) {</span>
<a href="#l46.168"></a><span id="l46.168">             aItem = cal.getInvitedAttendee(aItem);</span>
<a href="#l46.169"></a><span id="l46.169">         }</span>
<a href="#l46.170"></a><span id="l46.170">         if (aItem) {</span>
<a href="#l46.171"></a><span id="l46.171">             switch (aItem.participationStatus) {</span>
<a href="#l46.172"></a><span id="l46.172">                 case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l46.173"></a><span id="l46.173">                 case &quot;TENTATIVE&quot;:</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineat">@@ -377,17 +377,17 @@ var cal = {</span>
<a href="#l46.175"></a><span id="l46.175">             delegatees: delegatees.join(&quot;, &quot;),</span>
<a href="#l46.176"></a><span id="l46.176">             delegators: delegators.join(&quot;, &quot;)</span>
<a href="#l46.177"></a><span id="l46.177">         };</span>
<a href="#l46.178"></a><span id="l46.178">     },</span>
<a href="#l46.179"></a><span id="l46.179"> </span>
<a href="#l46.180"></a><span id="l46.180">     /**</span>
<a href="#l46.181"></a><span id="l46.181">      * Shortcut function to get the invited attendee of an item.</span>
<a href="#l46.182"></a><span id="l46.182">      */</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineminus">-    getInvitedAttendee: function cal_getInvitedAttendee(aItem, aCalendar) {</span>
<a href="#l46.184"></a><span id="l46.184" class="difflineplus">+    getInvitedAttendee: function(aItem, aCalendar) {</span>
<a href="#l46.185"></a><span id="l46.185">         if (!aCalendar) {</span>
<a href="#l46.186"></a><span id="l46.186">             aCalendar = aItem.calendar;</span>
<a href="#l46.187"></a><span id="l46.187">         }</span>
<a href="#l46.188"></a><span id="l46.188">         let invitedAttendee = null;</span>
<a href="#l46.189"></a><span id="l46.189">         let calendar = cal.wrapInstance(aCalendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l46.190"></a><span id="l46.190">         if (calendar) {</span>
<a href="#l46.191"></a><span id="l46.191">             invitedAttendee = calendar.getInvitedAttendee(aItem);</span>
<a href="#l46.192"></a><span id="l46.192">         }</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineat">@@ -458,116 +458,116 @@ var cal = {</span>
<a href="#l46.194"></a><span id="l46.194">                      : &quot;OPAQUE&quot;;</span>
<a href="#l46.195"></a><span id="l46.195">         }</span>
<a href="#l46.196"></a><span id="l46.196">         return transp;</span>
<a href="#l46.197"></a><span id="l46.197">     },</span>
<a href="#l46.198"></a><span id="l46.198"> </span>
<a href="#l46.199"></a><span id="l46.199">     // The below functions will move to some different place once the</span>
<a href="#l46.200"></a><span id="l46.200">     // unifinder tress are consolidated.</span>
<a href="#l46.201"></a><span id="l46.201"> </span>
<a href="#l46.202"></a><span id="l46.202" class="difflineminus">-    compareNativeTime: function cal_compareNativeTime(a, b) {</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineplus">+    compareNativeTime: function(a, b) {</span>
<a href="#l46.204"></a><span id="l46.204">       if (a &lt; b) {</span>
<a href="#l46.205"></a><span id="l46.205">         return -1;</span>
<a href="#l46.206"></a><span id="l46.206">       } else if (a &gt; b) {</span>
<a href="#l46.207"></a><span id="l46.207">         return 1;</span>
<a href="#l46.208"></a><span id="l46.208">       } else {</span>
<a href="#l46.209"></a><span id="l46.209">         return 0;</span>
<a href="#l46.210"></a><span id="l46.210">       }</span>
<a href="#l46.211"></a><span id="l46.211">     },</span>
<a href="#l46.212"></a><span id="l46.212"> </span>
<a href="#l46.213"></a><span id="l46.213" class="difflineminus">-    compareNativeTimeFilledAsc: function cal_compareNativeTimeFilledAsc(a, b) {</span>
<a href="#l46.214"></a><span id="l46.214" class="difflineplus">+    compareNativeTimeFilledAsc: function(a, b) {</span>
<a href="#l46.215"></a><span id="l46.215">       if (a == b) {</span>
<a href="#l46.216"></a><span id="l46.216">         return 0;</span>
<a href="#l46.217"></a><span id="l46.217">       }</span>
<a href="#l46.218"></a><span id="l46.218"> </span>
<a href="#l46.219"></a><span id="l46.219">       // In this filter, a zero time (not set) is always at the end.</span>
<a href="#l46.220"></a><span id="l46.220">       if (a == -62168601600000000) { // value for (0000/00/00 00:00:00)</span>
<a href="#l46.221"></a><span id="l46.221">         return 1;</span>
<a href="#l46.222"></a><span id="l46.222">       }</span>
<a href="#l46.223"></a><span id="l46.223">       if (b == -62168601600000000) { // value for (0000/00/00 00:00:00)</span>
<a href="#l46.224"></a><span id="l46.224">         return -1;</span>
<a href="#l46.225"></a><span id="l46.225">       }</span>
<a href="#l46.226"></a><span id="l46.226"> </span>
<a href="#l46.227"></a><span id="l46.227">       return (a &lt; b ? -1 : 1);</span>
<a href="#l46.228"></a><span id="l46.228">     },</span>
<a href="#l46.229"></a><span id="l46.229"> </span>
<a href="#l46.230"></a><span id="l46.230" class="difflineminus">-    compareNativeTimeFilledDesc: function cal_compareNativeTimeFilledDesc(a, b) {</span>
<a href="#l46.231"></a><span id="l46.231" class="difflineplus">+    compareNativeTimeFilledDesc: function(a, b) {</span>
<a href="#l46.232"></a><span id="l46.232">       if (a == b) {</span>
<a href="#l46.233"></a><span id="l46.233">         return 0;</span>
<a href="#l46.234"></a><span id="l46.234">       }</span>
<a href="#l46.235"></a><span id="l46.235"> </span>
<a href="#l46.236"></a><span id="l46.236">       // In this filter, a zero time (not set) is always at the end.</span>
<a href="#l46.237"></a><span id="l46.237">       if (a == -62168601600000000) { // value for (0000/00/00 00:00:00)</span>
<a href="#l46.238"></a><span id="l46.238">         return 1;</span>
<a href="#l46.239"></a><span id="l46.239">       }</span>
<a href="#l46.240"></a><span id="l46.240">       if (b == -62168601600000000) { // value for (0000/00/00 00:00:00)</span>
<a href="#l46.241"></a><span id="l46.241">         return -1;</span>
<a href="#l46.242"></a><span id="l46.242">       }</span>
<a href="#l46.243"></a><span id="l46.243"> </span>
<a href="#l46.244"></a><span id="l46.244">       return (a &lt; b ? 1 : -1);</span>
<a href="#l46.245"></a><span id="l46.245">     },</span>
<a href="#l46.246"></a><span id="l46.246"> </span>
<a href="#l46.247"></a><span id="l46.247" class="difflineminus">-    compareNumber: function cal_compareNumber(a, b) {</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineplus">+    compareNumber: function(a, b) {</span>
<a href="#l46.249"></a><span id="l46.249">       a = Number(a);</span>
<a href="#l46.250"></a><span id="l46.250">       b = Number(b);</span>
<a href="#l46.251"></a><span id="l46.251">       if (a &lt; b) {</span>
<a href="#l46.252"></a><span id="l46.252">         return -1;</span>
<a href="#l46.253"></a><span id="l46.253">       } else if (a &gt; b) {</span>
<a href="#l46.254"></a><span id="l46.254">         return 1;</span>
<a href="#l46.255"></a><span id="l46.255">       } else {</span>
<a href="#l46.256"></a><span id="l46.256">         return 0;</span>
<a href="#l46.257"></a><span id="l46.257">       }</span>
<a href="#l46.258"></a><span id="l46.258">     },</span>
<a href="#l46.259"></a><span id="l46.259"> </span>
<a href="#l46.260"></a><span id="l46.260" class="difflineminus">-    sortEntryComparer: function cal_sortEntryComparer(sortType, modifier) {</span>
<a href="#l46.261"></a><span id="l46.261" class="difflineplus">+    sortEntryComparer: function(sortType, modifier) {</span>
<a href="#l46.262"></a><span id="l46.262">       switch (sortType) {</span>
<a href="#l46.263"></a><span id="l46.263">         case &quot;number&quot;:</span>
<a href="#l46.264"></a><span id="l46.264" class="difflineminus">-          return function compareNumbers(sortEntryA, sortEntryB) {</span>
<a href="#l46.265"></a><span id="l46.265" class="difflineplus">+          return function(sortEntryA, sortEntryB) {</span>
<a href="#l46.266"></a><span id="l46.266">             let nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l46.267"></a><span id="l46.267">             let nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l46.268"></a><span id="l46.268">             return cal.compareNumber(nsA, nsB) * modifier;</span>
<a href="#l46.269"></a><span id="l46.269">           };</span>
<a href="#l46.270"></a><span id="l46.270">         case &quot;date&quot;:</span>
<a href="#l46.271"></a><span id="l46.271" class="difflineminus">-          return function compareTimes(sortEntryA, sortEntryB) {</span>
<a href="#l46.272"></a><span id="l46.272" class="difflineplus">+          return function(sortEntryA, sortEntryB) {</span>
<a href="#l46.273"></a><span id="l46.273">             let nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l46.274"></a><span id="l46.274">             let nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l46.275"></a><span id="l46.275">             return cal.compareNativeTime(nsA, nsB) * modifier;</span>
<a href="#l46.276"></a><span id="l46.276">           };</span>
<a href="#l46.277"></a><span id="l46.277">         case &quot;date_filled&quot;:</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineminus">-          return function compareTimesFilled(sortEntryA, sortEntryB) {</span>
<a href="#l46.279"></a><span id="l46.279" class="difflineplus">+          return function(sortEntryA, sortEntryB) {</span>
<a href="#l46.280"></a><span id="l46.280">             let nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l46.281"></a><span id="l46.281">             let nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l46.282"></a><span id="l46.282">             if (modifier == 1) {</span>
<a href="#l46.283"></a><span id="l46.283">               return cal.compareNativeTimeFilledAsc(nsA, nsB);</span>
<a href="#l46.284"></a><span id="l46.284">             } else {</span>
<a href="#l46.285"></a><span id="l46.285">               return cal.compareNativeTimeFilledDesc(nsA, nsB);</span>
<a href="#l46.286"></a><span id="l46.286">             }</span>
<a href="#l46.287"></a><span id="l46.287">           };</span>
<a href="#l46.288"></a><span id="l46.288">         case &quot;string&quot;:</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineminus">-          return function compareStrings(sortEntryA, sortEntryB) {</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineplus">+          return function(sortEntryA, sortEntryB) {</span>
<a href="#l46.291"></a><span id="l46.291">             let sA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l46.292"></a><span id="l46.292">             let sB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l46.293"></a><span id="l46.293">             if (sA.length == 0 || sB.length == 0) {</span>
<a href="#l46.294"></a><span id="l46.294">               // sort empty values to end (so when users first sort by a</span>
<a href="#l46.295"></a><span id="l46.295">               // column, they can see and find the desired values in that</span>
<a href="#l46.296"></a><span id="l46.296">               // column without scrolling past all the empty values).</span>
<a href="#l46.297"></a><span id="l46.297">               return -(sA.length - sB.length) * modifier;</span>
<a href="#l46.298"></a><span id="l46.298">             }</span>
<a href="#l46.299"></a><span id="l46.299">             let collator = cal.createLocaleCollator();</span>
<a href="#l46.300"></a><span id="l46.300">             let comparison = collator.compareString(0, sA, sB);</span>
<a href="#l46.301"></a><span id="l46.301">             return comparison * modifier;</span>
<a href="#l46.302"></a><span id="l46.302">           };</span>
<a href="#l46.303"></a><span id="l46.303">         default:</span>
<a href="#l46.304"></a><span id="l46.304" class="difflineminus">-          return function compareOther(sortEntryA, sortEntryB) {</span>
<a href="#l46.305"></a><span id="l46.305" class="difflineplus">+          return function(sortEntryA, sortEntryB) {</span>
<a href="#l46.306"></a><span id="l46.306">             return 0;</span>
<a href="#l46.307"></a><span id="l46.307">           };</span>
<a href="#l46.308"></a><span id="l46.308">       }</span>
<a href="#l46.309"></a><span id="l46.309">     },</span>
<a href="#l46.310"></a><span id="l46.310"> </span>
<a href="#l46.311"></a><span id="l46.311" class="difflineminus">-    getItemSortKey: function cal_getItemSortKey(aItem, aKey, aStartTime) {</span>
<a href="#l46.312"></a><span id="l46.312" class="difflineplus">+    getItemSortKey: function(aItem, aKey, aStartTime) {</span>
<a href="#l46.313"></a><span id="l46.313">       switch (aKey) {</span>
<a href="#l46.314"></a><span id="l46.314">         case &quot;priority&quot;:</span>
<a href="#l46.315"></a><span id="l46.315">           return aItem.priority || 5;</span>
<a href="#l46.316"></a><span id="l46.316"> </span>
<a href="#l46.317"></a><span id="l46.317">         case &quot;title&quot;:</span>
<a href="#l46.318"></a><span id="l46.318">           return aItem.title || &quot;&quot;;</span>
<a href="#l46.319"></a><span id="l46.319"> </span>
<a href="#l46.320"></a><span id="l46.320">         case &quot;entryDate&quot;:</span>
<a href="#l46.321"></a><span id="l46.321" class="difflineat">@@ -603,17 +603,17 @@ var cal = {</span>
<a href="#l46.322"></a><span id="l46.322">         case &quot;calendar&quot;:</span>
<a href="#l46.323"></a><span id="l46.323">           return aItem.calendar.name || &quot;&quot;;</span>
<a href="#l46.324"></a><span id="l46.324"> </span>
<a href="#l46.325"></a><span id="l46.325">         default:</span>
<a href="#l46.326"></a><span id="l46.326">           return null;</span>
<a href="#l46.327"></a><span id="l46.327">       }</span>
<a href="#l46.328"></a><span id="l46.328">     },</span>
<a href="#l46.329"></a><span id="l46.329"> </span>
<a href="#l46.330"></a><span id="l46.330" class="difflineminus">-    getSortTypeForSortKey: function cal_getSortTypeForSortKey(aSortKey) {</span>
<a href="#l46.331"></a><span id="l46.331" class="difflineplus">+    getSortTypeForSortKey: function(aSortKey) {</span>
<a href="#l46.332"></a><span id="l46.332">       switch (aSortKey) {</span>
<a href="#l46.333"></a><span id="l46.333">         case &quot;title&quot;:</span>
<a href="#l46.334"></a><span id="l46.334">         case &quot;categories&quot;:</span>
<a href="#l46.335"></a><span id="l46.335">         case &quot;location&quot;:</span>
<a href="#l46.336"></a><span id="l46.336">         case &quot;calendar&quot;:</span>
<a href="#l46.337"></a><span id="l46.337">           return &quot;string&quot;;</span>
<a href="#l46.338"></a><span id="l46.338"> </span>
<a href="#l46.339"></a><span id="l46.339">         // All dates use &quot;date_filled&quot;</span>
<a href="#l46.340"></a><span id="l46.340" class="difflineat">@@ -628,30 +628,30 @@ var cal = {</span>
<a href="#l46.341"></a><span id="l46.341">         case &quot;percentComplete&quot;:</span>
<a href="#l46.342"></a><span id="l46.342">         case &quot;status&quot;:</span>
<a href="#l46.343"></a><span id="l46.343">           return &quot;number&quot;;</span>
<a href="#l46.344"></a><span id="l46.344">         default:</span>
<a href="#l46.345"></a><span id="l46.345">           return &quot;unknown&quot;;</span>
<a href="#l46.346"></a><span id="l46.346">       }</span>
<a href="#l46.347"></a><span id="l46.347">     },</span>
<a href="#l46.348"></a><span id="l46.348"> </span>
<a href="#l46.349"></a><span id="l46.349" class="difflineminus">-    nativeTimeOrNow: function cal_nativeTimeOrNow(calDateTime, sortStartedTime) {</span>
<a href="#l46.350"></a><span id="l46.350" class="difflineplus">+    nativeTimeOrNow: function(calDateTime, sortStartedTime) {</span>
<a href="#l46.351"></a><span id="l46.351">         // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l46.352"></a><span id="l46.352">         // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l46.353"></a><span id="l46.353">         if (calDateTime == null) {</span>
<a href="#l46.354"></a><span id="l46.354">             return sortStartedTime.nativeTime;</span>
<a href="#l46.355"></a><span id="l46.355">         }</span>
<a href="#l46.356"></a><span id="l46.356">         let ns = calDateTime.nativeTime;</span>
<a href="#l46.357"></a><span id="l46.357">         if (ns == -62168601600000000) { // ns value for (0000/00/00 00:00:00)</span>
<a href="#l46.358"></a><span id="l46.358">             return sortStartedTime;</span>
<a href="#l46.359"></a><span id="l46.359">         }</span>
<a href="#l46.360"></a><span id="l46.360">         return ns;</span>
<a href="#l46.361"></a><span id="l46.361">     },</span>
<a href="#l46.362"></a><span id="l46.362"> </span>
<a href="#l46.363"></a><span id="l46.363" class="difflineminus">-    nativeTime: function cal_nativeTime(calDateTime) {</span>
<a href="#l46.364"></a><span id="l46.364" class="difflineplus">+    nativeTime: function(calDateTime) {</span>
<a href="#l46.365"></a><span id="l46.365">         if (calDateTime == null) {</span>
<a href="#l46.366"></a><span id="l46.366">             return -62168601600000000; // ns value for (0000/00/00 00:00:00)</span>
<a href="#l46.367"></a><span id="l46.367">         }</span>
<a href="#l46.368"></a><span id="l46.368">         return calDateTime.nativeTime;</span>
<a href="#l46.369"></a><span id="l46.369">     },</span>
<a href="#l46.370"></a><span id="l46.370"> </span>
<a href="#l46.371"></a><span id="l46.371">     /**</span>
<a href="#l46.372"></a><span id="l46.372">      * Returns a calIDateTime corresponding to a javascript Date.</span>
<a href="#l46.373"></a><span id="l46.373" class="difflineat">@@ -660,17 +660,17 @@ var cal = {</span>
<a href="#l46.374"></a><span id="l46.374">      * @param aTimezone (optional) a timezone that should be enforced</span>
<a href="#l46.375"></a><span id="l46.375">      * @returns         a calIDateTime</span>
<a href="#l46.376"></a><span id="l46.376">      *</span>
<a href="#l46.377"></a><span id="l46.377">      * @warning  Use of this function is strongly discouraged.  calIDateTime should</span>
<a href="#l46.378"></a><span id="l46.378">      *           be used directly whenever possible.</span>
<a href="#l46.379"></a><span id="l46.379">      *           If you pass a timezone, then the passed jsDate's timezone will be ignored,</span>
<a href="#l46.380"></a><span id="l46.380">      *           but only its local time portions are be taken.</span>
<a href="#l46.381"></a><span id="l46.381">      */</span>
<a href="#l46.382"></a><span id="l46.382" class="difflineminus">-    jsDateToDateTime: function jsDateToDateTime(aDate, aTimezone) {</span>
<a href="#l46.383"></a><span id="l46.383" class="difflineplus">+    jsDateToDateTime: function(aDate, aTimezone) {</span>
<a href="#l46.384"></a><span id="l46.384">         let newDate = cal.createDateTime();</span>
<a href="#l46.385"></a><span id="l46.385">         if (aTimezone) {</span>
<a href="#l46.386"></a><span id="l46.386">             newDate.resetTo(aDate.getFullYear(),</span>
<a href="#l46.387"></a><span id="l46.387">                             aDate.getMonth(),</span>
<a href="#l46.388"></a><span id="l46.388">                             aDate.getDate(),</span>
<a href="#l46.389"></a><span id="l46.389">                             aDate.getHours(),</span>
<a href="#l46.390"></a><span id="l46.390">                             aDate.getMinutes(),</span>
<a href="#l46.391"></a><span id="l46.391">                             aDate.getSeconds(),</span>
<a href="#l46.392"></a><span id="l46.392" class="difflineat">@@ -692,54 +692,54 @@ var cal = {</span>
<a href="#l46.393"></a><span id="l46.393">         if (cdt.timezone.isFloating) {</span>
<a href="#l46.394"></a><span id="l46.394">             return new Date(cdt.year, cdt.month, cdt.day,</span>
<a href="#l46.395"></a><span id="l46.395">                             cdt.hour, cdt.minute, cdt.second);</span>
<a href="#l46.396"></a><span id="l46.396">         } else {</span>
<a href="#l46.397"></a><span id="l46.397">             return new Date(cdt.nativeTime / 1000);</span>
<a href="#l46.398"></a><span id="l46.398">         }</span>
<a href="#l46.399"></a><span id="l46.399">     },</span>
<a href="#l46.400"></a><span id="l46.400"> </span>
<a href="#l46.401"></a><span id="l46.401" class="difflineminus">-    sortEntry: function cal_sortEntry(aItem) {</span>
<a href="#l46.402"></a><span id="l46.402" class="difflineplus">+    sortEntry: function(aItem) {</span>
<a href="#l46.403"></a><span id="l46.403">         let key = cal.getItemSortKey(aItem, this.mSortKey, this.mSortStartedDate);</span>
<a href="#l46.404"></a><span id="l46.404">         return { mSortKey: key, mItem: aItem };</span>
<a href="#l46.405"></a><span id="l46.405">     },</span>
<a href="#l46.406"></a><span id="l46.406"> </span>
<a href="#l46.407"></a><span id="l46.407" class="difflineminus">-    sortEntryItem: function cal_sortEntryItem(sortEntry) {</span>
<a href="#l46.408"></a><span id="l46.408" class="difflineplus">+    sortEntryItem: function(sortEntry) {</span>
<a href="#l46.409"></a><span id="l46.409">         return sortEntry.mItem;</span>
<a href="#l46.410"></a><span id="l46.410">     },</span>
<a href="#l46.411"></a><span id="l46.411"> </span>
<a href="#l46.412"></a><span id="l46.412" class="difflineminus">-    sortEntryKey: function cal_sortEntryKey(sortEntry) {</span>
<a href="#l46.413"></a><span id="l46.413" class="difflineplus">+    sortEntryKey: function(sortEntry) {</span>
<a href="#l46.414"></a><span id="l46.414">         return sortEntry.mSortKey;</span>
<a href="#l46.415"></a><span id="l46.415">     },</span>
<a href="#l46.416"></a><span id="l46.416"> </span>
<a href="#l46.417"></a><span id="l46.417" class="difflineminus">-    createLocaleCollator: function cal_createLocaleCollator() {</span>
<a href="#l46.418"></a><span id="l46.418" class="difflineplus">+    createLocaleCollator: function() {</span>
<a href="#l46.419"></a><span id="l46.419">         return Components.classes[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l46.420"></a><span id="l46.420">                          .getService(Components.interfaces.nsICollationFactory)</span>
<a href="#l46.421"></a><span id="l46.421">                          .CreateCollation(Services.locale.getApplicationLocale());</span>
<a href="#l46.422"></a><span id="l46.422">      },</span>
<a href="#l46.423"></a><span id="l46.423"> </span>
<a href="#l46.424"></a><span id="l46.424">     /**</span>
<a href="#l46.425"></a><span id="l46.425">      * Sort an array of strings according to the current locale.</span>
<a href="#l46.426"></a><span id="l46.426">      * Modifies aStringArray, returning it sorted.</span>
<a href="#l46.427"></a><span id="l46.427">      */</span>
<a href="#l46.428"></a><span id="l46.428" class="difflineminus">-    sortArrayByLocaleCollator: function cal_sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l46.429"></a><span id="l46.429" class="difflineplus">+    sortArrayByLocaleCollator: function(aStringArray) {</span>
<a href="#l46.430"></a><span id="l46.430">         let localeCollator = cal.createLocaleCollator();</span>
<a href="#l46.431"></a><span id="l46.431">         function compare(a, b) { return localeCollator.compareString(0, a, b); }</span>
<a href="#l46.432"></a><span id="l46.432">         aStringArray.sort(compare);</span>
<a href="#l46.433"></a><span id="l46.433">         return aStringArray;</span>
<a href="#l46.434"></a><span id="l46.434">     },</span>
<a href="#l46.435"></a><span id="l46.435"> </span>
<a href="#l46.436"></a><span id="l46.436">     /**</span>
<a href="#l46.437"></a><span id="l46.437">      * Gets the month name string in the right form depending on a base string.</span>
<a href="#l46.438"></a><span id="l46.438">      *</span>
<a href="#l46.439"></a><span id="l46.439">      * @param aMonthNum     The month numer to get, 1-based.</span>
<a href="#l46.440"></a><span id="l46.440">      * @param aBundleName   The Bundle to get the string from</span>
<a href="#l46.441"></a><span id="l46.441">      * @param aStringBase   The base string name, .monthFormat will be appended</span>
<a href="#l46.442"></a><span id="l46.442">      */</span>
<a href="#l46.443"></a><span id="l46.443" class="difflineminus">-    formatMonth: function formatMonth(aMonthNum, aBundleName, aStringBase) {</span>
<a href="#l46.444"></a><span id="l46.444" class="difflineplus">+    formatMonth: function(aMonthNum, aBundleName, aStringBase) {</span>
<a href="#l46.445"></a><span id="l46.445">         let monthForm = cal.calGetString(aBundleName, aStringBase + &quot;.monthFormat&quot;) || &quot;nominative&quot;;</span>
<a href="#l46.446"></a><span id="l46.446"> </span>
<a href="#l46.447"></a><span id="l46.447">         if (monthForm == &quot;nominative&quot;) {</span>
<a href="#l46.448"></a><span id="l46.448">             // Fall back to the default name format</span>
<a href="#l46.449"></a><span id="l46.449">             monthForm = &quot;name&quot;;</span>
<a href="#l46.450"></a><span id="l46.450">         }</span>
<a href="#l46.451"></a><span id="l46.451"> </span>
<a href="#l46.452"></a><span id="l46.452">         return cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + aMonthNum + &quot;.&quot; + monthForm);</span>
<a href="#l46.453"></a><span id="l46.453" class="difflineat">@@ -747,17 +747,17 @@ var cal = {</span>
<a href="#l46.454"></a><span id="l46.454"> </span>
<a href="#l46.455"></a><span id="l46.455">     /**</span>
<a href="#l46.456"></a><span id="l46.456">      * moves an item to another startDate</span>
<a href="#l46.457"></a><span id="l46.457">      *</span>
<a href="#l46.458"></a><span id="l46.458">      * @param aOldItem             The Item to be modified</span>
<a href="#l46.459"></a><span id="l46.459">      * @param aNewDate             The date at which the new item is going to start</span>
<a href="#l46.460"></a><span id="l46.460">      * @return                     The modified item</span>
<a href="#l46.461"></a><span id="l46.461">      */</span>
<a href="#l46.462"></a><span id="l46.462" class="difflineminus">-    moveItem: function cal_moveItem(aOldItem, aNewDate) {</span>
<a href="#l46.463"></a><span id="l46.463" class="difflineplus">+    moveItem: function(aOldItem, aNewDate) {</span>
<a href="#l46.464"></a><span id="l46.464">         let newItem = aOldItem.clone();</span>
<a href="#l46.465"></a><span id="l46.465">         let start = (aOldItem[calGetStartDateProp(aOldItem)] ||</span>
<a href="#l46.466"></a><span id="l46.466">                      aOldItem[calGetEndDateProp(aOldItem)]).clone();</span>
<a href="#l46.467"></a><span id="l46.467">         let isDate = start.isDate;</span>
<a href="#l46.468"></a><span id="l46.468">         start.resetTo(aNewDate.year, aNewDate.month, aNewDate.day,</span>
<a href="#l46.469"></a><span id="l46.469">                       start.hour, start.minute, start.second,</span>
<a href="#l46.470"></a><span id="l46.470">                       start.timezone);</span>
<a href="#l46.471"></a><span id="l46.471">         start.isDate = isDate;</span>
<a href="#l46.472"></a><span id="l46.472" class="difflineat">@@ -779,17 +779,17 @@ var cal = {</span>
<a href="#l46.473"></a><span id="l46.473"> </span>
<a href="#l46.474"></a><span id="l46.474">     /**</span>
<a href="#l46.475"></a><span id="l46.475">      * sets the 'isDate' property of an item</span>
<a href="#l46.476"></a><span id="l46.476">      *</span>
<a href="#l46.477"></a><span id="l46.477">      * @param aItem         The Item to be modified</span>
<a href="#l46.478"></a><span id="l46.478">      * @param aIsDate       True or false indicating the new value of 'isDate'</span>
<a href="#l46.479"></a><span id="l46.479">      * @return              The modified item</span>
<a href="#l46.480"></a><span id="l46.480">      */</span>
<a href="#l46.481"></a><span id="l46.481" class="difflineminus">-    setItemToAllDay: function cal_setItemToAllDay(aItem, aIsDate) {</span>
<a href="#l46.482"></a><span id="l46.482" class="difflineplus">+    setItemToAllDay: function(aItem, aIsDate) {</span>
<a href="#l46.483"></a><span id="l46.483">         let start = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l46.484"></a><span id="l46.484">         let end = aItem[calGetEndDateProp(aItem)];</span>
<a href="#l46.485"></a><span id="l46.485">         if (start || end) {</span>
<a href="#l46.486"></a><span id="l46.486">             let item = aItem.clone();</span>
<a href="#l46.487"></a><span id="l46.487">             if (start &amp;&amp; (start.isDate != aIsDate)) {</span>
<a href="#l46.488"></a><span id="l46.488">                start = start.clone();</span>
<a href="#l46.489"></a><span id="l46.489">                start.isDate = aIsDate;</span>
<a href="#l46.490"></a><span id="l46.490">                item[calGetStartDateProp(item)] = start;</span>
<a href="#l46.491"></a><span id="l46.491" class="difflineat">@@ -808,17 +808,17 @@ var cal = {</span>
<a href="#l46.492"></a><span id="l46.492">     /**</span>
<a href="#l46.493"></a><span id="l46.493">      * checks if the mousepointer of an event resides over a XULBox during an event</span>
<a href="#l46.494"></a><span id="l46.494">      *</span>
<a href="#l46.495"></a><span id="l46.495">      * @param aMouseEvent   The event eg. a 'mouseout' or 'mousedown' event</span>
<a href="#l46.496"></a><span id="l46.496">      * @param aXULBox       The xul element</span>
<a href="#l46.497"></a><span id="l46.497">      * @return              true or false depending on whether the mouse pointer</span>
<a href="#l46.498"></a><span id="l46.498">      *                      resides over the xulelement</span>
<a href="#l46.499"></a><span id="l46.499">      */</span>
<a href="#l46.500"></a><span id="l46.500" class="difflineminus">-    isMouseOverBox: function cal_isMouseOverBox(aMouseEvent, aXULElement) {</span>
<a href="#l46.501"></a><span id="l46.501" class="difflineplus">+    isMouseOverBox: function(aMouseEvent, aXULElement) {</span>
<a href="#l46.502"></a><span id="l46.502">         let boxObject = aXULElement.boxObject;</span>
<a href="#l46.503"></a><span id="l46.503">         let boxWidth = boxObject.width;</span>
<a href="#l46.504"></a><span id="l46.504">         let boxHeight = boxObject.height;</span>
<a href="#l46.505"></a><span id="l46.505">         let boxScreenX = boxObject.screenX;</span>
<a href="#l46.506"></a><span id="l46.506">         let boxScreenY = boxObject.screenY;</span>
<a href="#l46.507"></a><span id="l46.507">         let mouseX = aMouseEvent.screenX;</span>
<a href="#l46.508"></a><span id="l46.508">         let mouseY = aMouseEvent.screenY;</span>
<a href="#l46.509"></a><span id="l46.509">         let xIsWithin = (mouseX &gt;= boxScreenX) &amp;&amp;</span>
<a href="#l46.510"></a><span id="l46.510" class="difflineat">@@ -830,17 +830,17 @@ var cal = {</span>
<a href="#l46.511"></a><span id="l46.511"> </span>
<a href="#l46.512"></a><span id="l46.512">     /**</span>
<a href="#l46.513"></a><span id="l46.513">      * removes those childnodes from a node that contain a specified attribute</span>
<a href="#l46.514"></a><span id="l46.514">      * and where the value of this attribute matches a passed value</span>
<a href="#l46.515"></a><span id="l46.515">      * @param aParentNode   The parent node that contains the child nodes in question</span>
<a href="#l46.516"></a><span id="l46.516">      * @param aAttribute    The name of the attribute</span>
<a href="#l46.517"></a><span id="l46.517">      * @param aAttribute    The value of the attribute</span>
<a href="#l46.518"></a><span id="l46.518">      */</span>
<a href="#l46.519"></a><span id="l46.519" class="difflineminus">-    removeChildElementsByAttribute: function removeChildElementsByAttribute(aParentNode, aAttribute, aValue) {</span>
<a href="#l46.520"></a><span id="l46.520" class="difflineplus">+    removeChildElementsByAttribute: function(aParentNode, aAttribute, aValue) {</span>
<a href="#l46.521"></a><span id="l46.521">         let childNode = aParentNode.lastChild;</span>
<a href="#l46.522"></a><span id="l46.522">         while (childNode) {</span>
<a href="#l46.523"></a><span id="l46.523">             let prevChildNode = childNode.previousSibling;</span>
<a href="#l46.524"></a><span id="l46.524">             if (!aAttribute || aAttribute === undefined) {</span>
<a href="#l46.525"></a><span id="l46.525">                 childNode.remove();</span>
<a href="#l46.526"></a><span id="l46.526">              } else if (!aValue || aValue === undefined) {</span>
<a href="#l46.527"></a><span id="l46.527">                 childNode.remove();</span>
<a href="#l46.528"></a><span id="l46.528">             } else if (childNode &amp;&amp; childNode.hasAttribute(aAttribute) &amp;&amp;</span>
<a href="#l46.529"></a><span id="l46.529" class="difflineat">@@ -849,31 +849,31 @@ var cal = {</span>
<a href="#l46.530"></a><span id="l46.530">             }</span>
<a href="#l46.531"></a><span id="l46.531">             childNode = prevChildNode;</span>
<a href="#l46.532"></a><span id="l46.532">         }</span>
<a href="#l46.533"></a><span id="l46.533">     },</span>
<a href="#l46.534"></a><span id="l46.534"> </span>
<a href="#l46.535"></a><span id="l46.535">     /**</span>
<a href="#l46.536"></a><span id="l46.536">      * Returns the most recent calendar window in an application independent way</span>
<a href="#l46.537"></a><span id="l46.537">      */</span>
<a href="#l46.538"></a><span id="l46.538" class="difflineminus">-    getCalendarWindow: function cal_getCalendarWindow() {</span>
<a href="#l46.539"></a><span id="l46.539" class="difflineplus">+    getCalendarWindow: function() {</span>
<a href="#l46.540"></a><span id="l46.540">         return Services.wm.getMostRecentWindow(&quot;calendarMainWindow&quot;) ||</span>
<a href="#l46.541"></a><span id="l46.541">                Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l46.542"></a><span id="l46.542">     },</span>
<a href="#l46.543"></a><span id="l46.543"> </span>
<a href="#l46.544"></a><span id="l46.544">     /**</span>
<a href="#l46.545"></a><span id="l46.545">      * Adds an observer listening for the topic.</span>
<a href="#l46.546"></a><span id="l46.546">      *</span>
<a href="#l46.547"></a><span id="l46.547">      * @param func function to execute on topic</span>
<a href="#l46.548"></a><span id="l46.548">      * @param topic topic to listen for</span>
<a href="#l46.549"></a><span id="l46.549">      * @param oneTime whether to listen only once</span>
<a href="#l46.550"></a><span id="l46.550">      */</span>
<a href="#l46.551"></a><span id="l46.551" class="difflineminus">-    addObserver: function cal_addObserver(func, topic, oneTime) {</span>
<a href="#l46.552"></a><span id="l46.552" class="difflineplus">+    addObserver: function(func, topic, oneTime) {</span>
<a href="#l46.553"></a><span id="l46.553">         let observer = { // nsIObserver:</span>
<a href="#l46.554"></a><span id="l46.554" class="difflineminus">-            observe: function cal_addObserver_observe(subject, topic_, data) {</span>
<a href="#l46.555"></a><span id="l46.555" class="difflineplus">+            observe: function(subject, topic_, data) {</span>
<a href="#l46.556"></a><span id="l46.556">                 if (topic == topic_) {</span>
<a href="#l46.557"></a><span id="l46.557">                     if (oneTime) {</span>
<a href="#l46.558"></a><span id="l46.558">                         Services.obs.removeObserver(this, topic);</span>
<a href="#l46.559"></a><span id="l46.559">                     }</span>
<a href="#l46.560"></a><span id="l46.560">                     func(subject, topic, data);</span>
<a href="#l46.561"></a><span id="l46.561">                 }</span>
<a href="#l46.562"></a><span id="l46.562">             }</span>
<a href="#l46.563"></a><span id="l46.563">         };</span>
<a href="#l46.564"></a><span id="l46.564" class="difflineat">@@ -895,34 +895,34 @@ var cal = {</span>
<a href="#l46.565"></a><span id="l46.565">      * }</span>
<a href="#l46.566"></a><span id="l46.566">      * // GOOD USAGE:</span>
<a href="#l46.567"></a><span id="l46.567">      * foo = cal.wrapInstance(foo, Ci.nsIBar);</span>
<a href="#l46.568"></a><span id="l46.568">      * if (foo) {</span>
<a href="#l46.569"></a><span id="l46.569">      *   foo.barMethod();</span>
<a href="#l46.570"></a><span id="l46.570">      *   }</span>
<a href="#l46.571"></a><span id="l46.571">      *</span>
<a href="#l46.572"></a><span id="l46.572">      */</span>
<a href="#l46.573"></a><span id="l46.573" class="difflineminus">-    wrapInstance: function wrapInstance(aObj, aInterface) {</span>
<a href="#l46.574"></a><span id="l46.574" class="difflineplus">+    wrapInstance: function(aObj, aInterface) {</span>
<a href="#l46.575"></a><span id="l46.575">         if (!aObj) {</span>
<a href="#l46.576"></a><span id="l46.576">             return null;</span>
<a href="#l46.577"></a><span id="l46.577">         }</span>
<a href="#l46.578"></a><span id="l46.578"> </span>
<a href="#l46.579"></a><span id="l46.579">         try {</span>
<a href="#l46.580"></a><span id="l46.580">             return aObj.QueryInterface(aInterface);</span>
<a href="#l46.581"></a><span id="l46.581">         } catch (e) {</span>
<a href="#l46.582"></a><span id="l46.582">             return null;</span>
<a href="#l46.583"></a><span id="l46.583">         }</span>
<a href="#l46.584"></a><span id="l46.584">     },</span>
<a href="#l46.585"></a><span id="l46.585"> </span>
<a href="#l46.586"></a><span id="l46.586">     /**</span>
<a href="#l46.587"></a><span id="l46.587">      * Adds an xpcom shutdown observer.</span>
<a href="#l46.588"></a><span id="l46.588">      *</span>
<a href="#l46.589"></a><span id="l46.589">      * @param func function to execute</span>
<a href="#l46.590"></a><span id="l46.590">      */</span>
<a href="#l46.591"></a><span id="l46.591" class="difflineminus">-    addShutdownObserver: function cal_addShutdownObserver(func) {</span>
<a href="#l46.592"></a><span id="l46.592" class="difflineplus">+    addShutdownObserver: function(func) {</span>
<a href="#l46.593"></a><span id="l46.593">         cal.addObserver(func, &quot;xpcom-shutdown&quot;, true /* one time */);</span>
<a href="#l46.594"></a><span id="l46.594">     },</span>
<a href="#l46.595"></a><span id="l46.595"> </span>
<a href="#l46.596"></a><span id="l46.596">     /**</span>
<a href="#l46.597"></a><span id="l46.597">      * Due to wrapped js objects, some objects may have cyclic references.</span>
<a href="#l46.598"></a><span id="l46.598">      * You can register properties of objects to be cleaned up on xpcom-shutdown.</span>
<a href="#l46.599"></a><span id="l46.599">      *</span>
<a href="#l46.600"></a><span id="l46.600">      * @param obj    object</span>
<a href="#l46.601"></a><span id="l46.601" class="difflineat">@@ -950,16 +950,17 @@ function shutdownCleanup(obj, prop) {</span>
<a href="#l46.602"></a><span id="l46.602">             });</span>
<a href="#l46.603"></a><span id="l46.603">     }</span>
<a href="#l46.604"></a><span id="l46.604">     shutdownCleanup.mEntries.push({ mObj: obj, mProp: prop });</span>
<a href="#l46.605"></a><span id="l46.605"> }</span>
<a href="#l46.606"></a><span id="l46.606"> </span>
<a href="#l46.607"></a><span id="l46.607"> // local to this module;</span>
<a href="#l46.608"></a><span id="l46.608"> // will be used to generate service accessor functions</span>
<a href="#l46.609"></a><span id="l46.609"> function generateServiceAccessor(id, iface) {</span>
<a href="#l46.610"></a><span id="l46.610" class="difflineplus">+    // eslint-disable-next-line func-names</span>
<a href="#l46.611"></a><span id="l46.611">     return function this_() {</span>
<a href="#l46.612"></a><span id="l46.612">         if (!(&quot;mService&quot; in this_)) {</span>
<a href="#l46.613"></a><span id="l46.613">             this_.mService = Components.classes[id].getService(iface);</span>
<a href="#l46.614"></a><span id="l46.614">             shutdownCleanup(this_, &quot;mService&quot;);</span>
<a href="#l46.615"></a><span id="l46.615">         }</span>
<a href="#l46.616"></a><span id="l46.616">         return this_.mService;</span>
<a href="#l46.617"></a><span id="l46.617">     };</span>
<a href="#l46.618"></a><span id="l46.618"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/modules/calXMLUtils.jsm</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/modules/calXMLUtils.jsm</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -18,17 +18,17 @@ cal.xml = {} || cal.xml;</span>
<a href="#l47.4"></a><span id="l47.4">  * - an array of strings or DOM elements</span>
<a href="#l47.5"></a><span id="l47.5">  *</span>
<a href="#l47.6"></a><span id="l47.6">  * @param aNode     The context node to search from</span>
<a href="#l47.7"></a><span id="l47.7">  * @param aExpr     The XPath expression to search for</span>
<a href="#l47.8"></a><span id="l47.8">  * @param aResolver (optional) The namespace resolver to use for the expression</span>
<a href="#l47.9"></a><span id="l47.9">  * @param aType     (optional) Force a result type, must be an XPathResult constant</span>
<a href="#l47.10"></a><span id="l47.10">  * @return          The result, see above for details.</span>
<a href="#l47.11"></a><span id="l47.11">  */</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-cal.xml.evalXPath = function evaluateXPath(aNode, aExpr, aResolver, aType) {</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+cal.xml.evalXPath = function(aNode, aExpr, aResolver, aType) {</span>
<a href="#l47.14"></a><span id="l47.14">     const XPR = Components.interfaces.nsIDOMXPathResult;</span>
<a href="#l47.15"></a><span id="l47.15">     let doc = (aNode.ownerDocument ? aNode.ownerDocument : aNode);</span>
<a href="#l47.16"></a><span id="l47.16">     let resolver = aResolver || doc.createNSResolver(doc.documentElement);</span>
<a href="#l47.17"></a><span id="l47.17">     let resultType = aType || XPR.ANY_TYPE;</span>
<a href="#l47.18"></a><span id="l47.18"> </span>
<a href="#l47.19"></a><span id="l47.19">     let result = doc.evaluate(aExpr, aNode, resolver, resultType, null);</span>
<a href="#l47.20"></a><span id="l47.20">     let returnResult, next;</span>
<a href="#l47.21"></a><span id="l47.21">     switch (result.resultType) {</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineat">@@ -93,17 +93,17 @@ cal.xml.evalXPath = function evaluateXPa</span>
<a href="#l47.23"></a><span id="l47.23">  * - A string, number, boolean or DOM Element value</span>
<a href="#l47.24"></a><span id="l47.24">  *</span>
<a href="#l47.25"></a><span id="l47.25">  * @param aNode     The context node to search from</span>
<a href="#l47.26"></a><span id="l47.26">  * @param aExpr     The XPath expression to search for</span>
<a href="#l47.27"></a><span id="l47.27">  * @param aResolver (optional) The namespace resolver to use for the expression</span>
<a href="#l47.28"></a><span id="l47.28">  * @param aType     (optional) Force a result type, must be an XPathResult constant</span>
<a href="#l47.29"></a><span id="l47.29">  * @return          The result, see above for details.</span>
<a href="#l47.30"></a><span id="l47.30">  */</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-cal.xml.evalXPathFirst = function evalXPathFirst(aNode, aExpr, aResolver, aType) {</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineplus">+cal.xml.evalXPathFirst = function(aNode, aExpr, aResolver, aType) {</span>
<a href="#l47.33"></a><span id="l47.33">     let result = cal.xml.evalXPath(aNode, aExpr, aResolver, aType);</span>
<a href="#l47.34"></a><span id="l47.34"> </span>
<a href="#l47.35"></a><span id="l47.35">     if (Array.isArray(result)) {</span>
<a href="#l47.36"></a><span id="l47.36">         return result[0];</span>
<a href="#l47.37"></a><span id="l47.37">     } else {</span>
<a href="#l47.38"></a><span id="l47.38">         return result;</span>
<a href="#l47.39"></a><span id="l47.39">     }</span>
<a href="#l47.40"></a><span id="l47.40"> };</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineat">@@ -155,17 +155,17 @@ cal.xml.serializeDOM = function(doc) {</span>
<a href="#l47.42"></a><span id="l47.42"> </span>
<a href="#l47.43"></a><span id="l47.43"> /**</span>
<a href="#l47.44"></a><span id="l47.44">  * Escape a string for use in XML</span>
<a href="#l47.45"></a><span id="l47.45">  *</span>
<a href="#l47.46"></a><span id="l47.46">  * @param str           The string to escape</span>
<a href="#l47.47"></a><span id="l47.47">  * @param isAttribute   If true, &quot; and ' are also escaped</span>
<a href="#l47.48"></a><span id="l47.48">  * @return              The escaped string</span>
<a href="#l47.49"></a><span id="l47.49">  */</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-cal.xml.escapeString = function escapeString(str, isAttribute) {</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+cal.xml.escapeString = function(str, isAttribute) {</span>
<a href="#l47.52"></a><span id="l47.52">     return str.replace(/[&amp;&lt;&gt;'&quot;]/g, function(chr) {</span>
<a href="#l47.53"></a><span id="l47.53">         switch (chr) {</span>
<a href="#l47.54"></a><span id="l47.54">             case &quot;&amp;&quot;: return &quot;&amp;amp;&quot;;</span>
<a href="#l47.55"></a><span id="l47.55">             case &quot;&lt;&quot;: return &quot;&amp;lt;&quot;;</span>
<a href="#l47.56"></a><span id="l47.56">             case &quot;&gt;&quot;: return &quot;&amp;gt;&quot;;</span>
<a href="#l47.57"></a><span id="l47.57">             case '&quot;': return (isAttribute ? &quot;&amp;quot;&quot; : chr);</span>
<a href="#l47.58"></a><span id="l47.58">             case &quot;'&quot;: return (isAttribute ? &quot;&amp;apos;&quot; : chr);</span>
<a href="#l47.59"></a><span id="l47.59">             default: return chr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -45,27 +45,27 @@ calAlarm.prototype = {</span>
<a href="#l48.4"></a><span id="l48.4">         classDescription: &quot;Describes a VALARM&quot;,</span>
<a href="#l48.5"></a><span id="l48.5">         interfaces: calAlarmInterfaces</span>
<a href="#l48.6"></a><span id="l48.6">     }),</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8">     /**</span>
<a href="#l48.9"></a><span id="l48.9">      * calIAlarm</span>
<a href="#l48.10"></a><span id="l48.10">      */</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-    ensureMutable: function cA_ensureMutable() {</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+    ensureMutable: function() {</span>
<a href="#l48.14"></a><span id="l48.14">         if (this.mImmutable) {</span>
<a href="#l48.15"></a><span id="l48.15">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l48.16"></a><span id="l48.16">         }</span>
<a href="#l48.17"></a><span id="l48.17">     },</span>
<a href="#l48.18"></a><span id="l48.18"> </span>
<a href="#l48.19"></a><span id="l48.19">     get isMutable() {</span>
<a href="#l48.20"></a><span id="l48.20">         return !this.mImmutable;</span>
<a href="#l48.21"></a><span id="l48.21">     },</span>
<a href="#l48.22"></a><span id="l48.22"> </span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-    makeImmutable: function cA_makeImmutable() {</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+    makeImmutable: function() {</span>
<a href="#l48.25"></a><span id="l48.25">         if (this.mImmutable) {</span>
<a href="#l48.26"></a><span id="l48.26">             return;</span>
<a href="#l48.27"></a><span id="l48.27">         }</span>
<a href="#l48.28"></a><span id="l48.28"> </span>
<a href="#l48.29"></a><span id="l48.29">         const objectMembers = [&quot;mAbsoluteDate&quot;,</span>
<a href="#l48.30"></a><span id="l48.30">                                &quot;mOffset&quot;,</span>
<a href="#l48.31"></a><span id="l48.31">                                &quot;mDuration&quot;,</span>
<a href="#l48.32"></a><span id="l48.32">                                &quot;mLastAck&quot;];</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineat">@@ -85,17 +85,17 @@ calAlarm.prototype = {</span>
<a href="#l48.34"></a><span id="l48.34">                     prop.value.makeImmutable();</span>
<a href="#l48.35"></a><span id="l48.35">                 }</span>
<a href="#l48.36"></a><span id="l48.36">             }</span>
<a href="#l48.37"></a><span id="l48.37">         }</span>
<a href="#l48.38"></a><span id="l48.38"> </span>
<a href="#l48.39"></a><span id="l48.39">         this.mImmutable = true;</span>
<a href="#l48.40"></a><span id="l48.40">     },</span>
<a href="#l48.41"></a><span id="l48.41"> </span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-    clone: function cA_clone() {</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+    clone: function() {</span>
<a href="#l48.44"></a><span id="l48.44">         let m = new calAlarm();</span>
<a href="#l48.45"></a><span id="l48.45"> </span>
<a href="#l48.46"></a><span id="l48.46">         m.mImmutable = false;</span>
<a href="#l48.47"></a><span id="l48.47"> </span>
<a href="#l48.48"></a><span id="l48.48">         const simpleMembers = [&quot;mAction&quot;,</span>
<a href="#l48.49"></a><span id="l48.49">                                &quot;mSummary&quot;,</span>
<a href="#l48.50"></a><span id="l48.50">                                &quot;mDescription&quot;,</span>
<a href="#l48.51"></a><span id="l48.51">                                &quot;mRelated&quot;,</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineat">@@ -274,93 +274,93 @@ calAlarm.prototype = {</span>
<a href="#l48.53"></a><span id="l48.53">         let alarmDate = this.mAbsoluteDate.clone();</span>
<a href="#l48.54"></a><span id="l48.54"> </span>
<a href="#l48.55"></a><span id="l48.55">         // All Day events are handled as 00:00:00</span>
<a href="#l48.56"></a><span id="l48.56">         alarmDate.isDate = false;</span>
<a href="#l48.57"></a><span id="l48.57">         alarmDate.addDuration(this.mDuration);</span>
<a href="#l48.58"></a><span id="l48.58">         return alarmDate;</span>
<a href="#l48.59"></a><span id="l48.59">     },</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61" class="difflineminus">-    getAttendees: function getAttendees(aCount) {</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+    getAttendees: function(aCount) {</span>
<a href="#l48.63"></a><span id="l48.63">         let attendees;</span>
<a href="#l48.64"></a><span id="l48.64">         if (this.action == &quot;AUDIO&quot; || this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l48.65"></a><span id="l48.65">             attendees = [];</span>
<a href="#l48.66"></a><span id="l48.66">         } else {</span>
<a href="#l48.67"></a><span id="l48.67">             attendees = this.mAttendees.concat([]);</span>
<a href="#l48.68"></a><span id="l48.68">         }</span>
<a href="#l48.69"></a><span id="l48.69">         aCount.value = attendees.length;</span>
<a href="#l48.70"></a><span id="l48.70">         return attendees;</span>
<a href="#l48.71"></a><span id="l48.71">     },</span>
<a href="#l48.72"></a><span id="l48.72"> </span>
<a href="#l48.73"></a><span id="l48.73" class="difflineminus">-    addAttendee: function addAttendee(aAttendee) {</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+    addAttendee: function(aAttendee) {</span>
<a href="#l48.75"></a><span id="l48.75">         // Make sure its not duplicate</span>
<a href="#l48.76"></a><span id="l48.76">         this.deleteAttendee(aAttendee);</span>
<a href="#l48.77"></a><span id="l48.77"> </span>
<a href="#l48.78"></a><span id="l48.78">         // Now check if its valid</span>
<a href="#l48.79"></a><span id="l48.79">         if (this.action == &quot;AUDIO&quot; || this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l48.80"></a><span id="l48.80">             throw new Error(&quot;Alarm type AUDIO/DISPLAY may not have attendees&quot;);</span>
<a href="#l48.81"></a><span id="l48.81">         }</span>
<a href="#l48.82"></a><span id="l48.82"> </span>
<a href="#l48.83"></a><span id="l48.83">         // And add it (again)</span>
<a href="#l48.84"></a><span id="l48.84">         this.mAttendees.push(aAttendee);</span>
<a href="#l48.85"></a><span id="l48.85">     },</span>
<a href="#l48.86"></a><span id="l48.86"> </span>
<a href="#l48.87"></a><span id="l48.87" class="difflineminus">-    deleteAttendee: function deleteAttendee(aAttendee) {</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+    deleteAttendee: function(aAttendee) {</span>
<a href="#l48.89"></a><span id="l48.89">         let deleteId = aAttendee.id;</span>
<a href="#l48.90"></a><span id="l48.90">         for (let i = 0; i &lt; this.mAttendees.length; i++) {</span>
<a href="#l48.91"></a><span id="l48.91">             if (this.mAttendees[i].id == deleteId) {</span>
<a href="#l48.92"></a><span id="l48.92">                 this.mAttendees.splice(i, 1);</span>
<a href="#l48.93"></a><span id="l48.93">                 break;</span>
<a href="#l48.94"></a><span id="l48.94">             }</span>
<a href="#l48.95"></a><span id="l48.95">         }</span>
<a href="#l48.96"></a><span id="l48.96">     },</span>
<a href="#l48.97"></a><span id="l48.97"> </span>
<a href="#l48.98"></a><span id="l48.98" class="difflineminus">-    clearAttendees: function clearAttendees() {</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+    clearAttendees: function() {</span>
<a href="#l48.100"></a><span id="l48.100">         this.mAttendees = [];</span>
<a href="#l48.101"></a><span id="l48.101">     },</span>
<a href="#l48.102"></a><span id="l48.102"> </span>
<a href="#l48.103"></a><span id="l48.103" class="difflineminus">-    getAttachments: function getAttachments(aCount) {</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+    getAttachments: function(aCount) {</span>
<a href="#l48.105"></a><span id="l48.105">         let attachments;</span>
<a href="#l48.106"></a><span id="l48.106">         if (this.action == &quot;AUDIO&quot;) {</span>
<a href="#l48.107"></a><span id="l48.107">             attachments = (this.mAttachments.length ? [this.mAttachments[0]] : []);</span>
<a href="#l48.108"></a><span id="l48.108">         } else if (this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l48.109"></a><span id="l48.109">             attachments = [];</span>
<a href="#l48.110"></a><span id="l48.110">         } else {</span>
<a href="#l48.111"></a><span id="l48.111">             attachments = this.mAttachments.concat([]);</span>
<a href="#l48.112"></a><span id="l48.112">         }</span>
<a href="#l48.113"></a><span id="l48.113">         aCount.value = attachments.length;</span>
<a href="#l48.114"></a><span id="l48.114">         return attachments;</span>
<a href="#l48.115"></a><span id="l48.115">     },</span>
<a href="#l48.116"></a><span id="l48.116"> </span>
<a href="#l48.117"></a><span id="l48.117" class="difflineminus">-    addAttachment: function addAttachment(aAttachment) {</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineplus">+    addAttachment: function(aAttachment) {</span>
<a href="#l48.119"></a><span id="l48.119">         // Make sure its not duplicate</span>
<a href="#l48.120"></a><span id="l48.120">         this.deleteAttachment(aAttachment);</span>
<a href="#l48.121"></a><span id="l48.121"> </span>
<a href="#l48.122"></a><span id="l48.122">         // Now check if its valid</span>
<a href="#l48.123"></a><span id="l48.123">         if (this.action == &quot;AUDIO&quot; &amp;&amp; this.mAttachments.length) {</span>
<a href="#l48.124"></a><span id="l48.124">             throw new Error(&quot;Alarm type AUDIO may only have one attachment&quot;);</span>
<a href="#l48.125"></a><span id="l48.125">         } else if (this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l48.126"></a><span id="l48.126">             throw new Error(&quot;Alarm type DISPLAY may not have attachments&quot;);</span>
<a href="#l48.127"></a><span id="l48.127">         }</span>
<a href="#l48.128"></a><span id="l48.128"> </span>
<a href="#l48.129"></a><span id="l48.129">         // And add it (again)</span>
<a href="#l48.130"></a><span id="l48.130">         this.mAttachments.push(aAttachment);</span>
<a href="#l48.131"></a><span id="l48.131">     },</span>
<a href="#l48.132"></a><span id="l48.132"> </span>
<a href="#l48.133"></a><span id="l48.133" class="difflineminus">-    deleteAttachment: function deleteAttachment(aAttachment) {</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+    deleteAttachment: function(aAttachment) {</span>
<a href="#l48.135"></a><span id="l48.135">         let deleteHash = aAttachment.hashId;</span>
<a href="#l48.136"></a><span id="l48.136">         for (let i = 0; i &lt; this.mAttachments.length; i++) {</span>
<a href="#l48.137"></a><span id="l48.137">             if (this.mAttachments[i].hashId == deleteHash) {</span>
<a href="#l48.138"></a><span id="l48.138">                 this.mAttachments.splice(i, 1);</span>
<a href="#l48.139"></a><span id="l48.139">                 break;</span>
<a href="#l48.140"></a><span id="l48.140">             }</span>
<a href="#l48.141"></a><span id="l48.141">         }</span>
<a href="#l48.142"></a><span id="l48.142">     },</span>
<a href="#l48.143"></a><span id="l48.143"> </span>
<a href="#l48.144"></a><span id="l48.144" class="difflineminus">-    clearAttachments: function clearAttachments() {</span>
<a href="#l48.145"></a><span id="l48.145" class="difflineplus">+    clearAttachments: function() {</span>
<a href="#l48.146"></a><span id="l48.146">         this.mAttachments = [];</span>
<a href="#l48.147"></a><span id="l48.147">     },</span>
<a href="#l48.148"></a><span id="l48.148"> </span>
<a href="#l48.149"></a><span id="l48.149">     get icalString() {</span>
<a href="#l48.150"></a><span id="l48.150">         let comp = this.icalComponent;</span>
<a href="#l48.151"></a><span id="l48.151">         return (comp ? comp.serializeToICS() : &quot;&quot;);</span>
<a href="#l48.152"></a><span id="l48.152">     },</span>
<a href="#l48.153"></a><span id="l48.153">     set icalString(val) {</span>
<a href="#l48.154"></a><span id="l48.154" class="difflineat">@@ -577,55 +577,55 @@ calAlarm.prototype = {</span>
<a href="#l48.155"></a><span id="l48.155">                     }</span>
<a href="#l48.156"></a><span id="l48.156">                     this.mPropertyParams[prop.propertyName][paramName] = param;</span>
<a href="#l48.157"></a><span id="l48.157">                 }</span>
<a href="#l48.158"></a><span id="l48.158">             }</span>
<a href="#l48.159"></a><span id="l48.159">         }</span>
<a href="#l48.160"></a><span id="l48.160">         return aComp;</span>
<a href="#l48.161"></a><span id="l48.161">     },</span>
<a href="#l48.162"></a><span id="l48.162"> </span>
<a href="#l48.163"></a><span id="l48.163" class="difflineminus">-    hasProperty: function cA_hasProperty(aName) {</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineplus">+    hasProperty: function(aName) {</span>
<a href="#l48.165"></a><span id="l48.165">         return (this.getProperty(aName.toUpperCase()) != null);</span>
<a href="#l48.166"></a><span id="l48.166">     },</span>
<a href="#l48.167"></a><span id="l48.167"> </span>
<a href="#l48.168"></a><span id="l48.168" class="difflineminus">-    getProperty: function cA_getProperty(aName) {</span>
<a href="#l48.169"></a><span id="l48.169" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l48.170"></a><span id="l48.170">         let name = aName.toUpperCase();</span>
<a href="#l48.171"></a><span id="l48.171">         if (name in this.promotedProps) {</span>
<a href="#l48.172"></a><span id="l48.172">             return this[this.promotedProps[name]];</span>
<a href="#l48.173"></a><span id="l48.173">         } else {</span>
<a href="#l48.174"></a><span id="l48.174">             return this.mProperties.getProperty(name);</span>
<a href="#l48.175"></a><span id="l48.175">         }</span>
<a href="#l48.176"></a><span id="l48.176">     },</span>
<a href="#l48.177"></a><span id="l48.177"> </span>
<a href="#l48.178"></a><span id="l48.178" class="difflineminus">-    setProperty: function cA_setProperty(aName, aValue) {</span>
<a href="#l48.179"></a><span id="l48.179" class="difflineplus">+    setProperty: function(aName, aValue) {</span>
<a href="#l48.180"></a><span id="l48.180">         this.ensureMutable();</span>
<a href="#l48.181"></a><span id="l48.181">         let name = aName.toUpperCase();</span>
<a href="#l48.182"></a><span id="l48.182">         if (name in this.promotedProps) {</span>
<a href="#l48.183"></a><span id="l48.183">             this[this.promotedProps[name]] = aValue;</span>
<a href="#l48.184"></a><span id="l48.184">         } else {</span>
<a href="#l48.185"></a><span id="l48.185">             this.mProperties.setProperty(name, aValue);</span>
<a href="#l48.186"></a><span id="l48.186">         }</span>
<a href="#l48.187"></a><span id="l48.187">         return aValue;</span>
<a href="#l48.188"></a><span id="l48.188">     },</span>
<a href="#l48.189"></a><span id="l48.189"> </span>
<a href="#l48.190"></a><span id="l48.190" class="difflineminus">-    deleteProperty: function cA_deleteProperty(aName) {</span>
<a href="#l48.191"></a><span id="l48.191" class="difflineplus">+    deleteProperty: function(aName) {</span>
<a href="#l48.192"></a><span id="l48.192">         this.ensureMutable();</span>
<a href="#l48.193"></a><span id="l48.193">         let name = aName.toUpperCase();</span>
<a href="#l48.194"></a><span id="l48.194">         if (name in this.promotedProps) {</span>
<a href="#l48.195"></a><span id="l48.195">             this[this.promotedProps[name]] = null;</span>
<a href="#l48.196"></a><span id="l48.196">         } else {</span>
<a href="#l48.197"></a><span id="l48.197">             this.mProperties.deleteProperty(name);</span>
<a href="#l48.198"></a><span id="l48.198">         }</span>
<a href="#l48.199"></a><span id="l48.199">     },</span>
<a href="#l48.200"></a><span id="l48.200"> </span>
<a href="#l48.201"></a><span id="l48.201">     get propertyEnumerator() {</span>
<a href="#l48.202"></a><span id="l48.202">         return this.mProperties.enumerator;</span>
<a href="#l48.203"></a><span id="l48.203">     },</span>
<a href="#l48.204"></a><span id="l48.204"> </span>
<a href="#l48.205"></a><span id="l48.205" class="difflineminus">-    toString: function cA_toString(aItem) {</span>
<a href="#l48.206"></a><span id="l48.206" class="difflineplus">+    toString: function(aItem) {</span>
<a href="#l48.207"></a><span id="l48.207">         function getItemBundleStringName(aPrefix) {</span>
<a href="#l48.208"></a><span id="l48.208">             if (!aItem || isEvent(aItem)) {</span>
<a href="#l48.209"></a><span id="l48.209">                 return aPrefix + &quot;Event&quot;;</span>
<a href="#l48.210"></a><span id="l48.210">             } else if (isToDo(aItem)) {</span>
<a href="#l48.211"></a><span id="l48.211">                 return aPrefix + &quot;Task&quot;;</span>
<a href="#l48.212"></a><span id="l48.212">             } else {</span>
<a href="#l48.213"></a><span id="l48.213">                 return aPrefix;</span>
<a href="#l48.214"></a><span id="l48.214">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -48,33 +48,33 @@ calAlarmMonitor.prototype = {</span>
<a href="#l49.4"></a><span id="l49.4">         classID: calAlarmMonitorClassID,</span>
<a href="#l49.5"></a><span id="l49.5">         interfaces: calAlarmMonitorInterfaces,</span>
<a href="#l49.6"></a><span id="l49.6">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l49.7"></a><span id="l49.7">     }),</span>
<a href="#l49.8"></a><span id="l49.8"> </span>
<a href="#l49.9"></a><span id="l49.9">     /**</span>
<a href="#l49.10"></a><span id="l49.10">      * nsIObserver</span>
<a href="#l49.11"></a><span id="l49.11">      */</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-    observe: function cAM_observe(aSubject, aTopic, aData) {</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l49.14"></a><span id="l49.14">         let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l49.15"></a><span id="l49.15">                                      .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l49.16"></a><span id="l49.16">         switch (aTopic) {</span>
<a href="#l49.17"></a><span id="l49.17">             case &quot;alarm-service-startup&quot;:</span>
<a href="#l49.18"></a><span id="l49.18">                 alarmService.addObserver(this);</span>
<a href="#l49.19"></a><span id="l49.19">                 break;</span>
<a href="#l49.20"></a><span id="l49.20">             case &quot;alarm-service-shutdown&quot;:</span>
<a href="#l49.21"></a><span id="l49.21">                 alarmService.removeObserver(this);</span>
<a href="#l49.22"></a><span id="l49.22">                 break;</span>
<a href="#l49.23"></a><span id="l49.23">         }</span>
<a href="#l49.24"></a><span id="l49.24">     },</span>
<a href="#l49.25"></a><span id="l49.25"> </span>
<a href="#l49.26"></a><span id="l49.26">     /**</span>
<a href="#l49.27"></a><span id="l49.27">      * calIAlarmServiceObserver</span>
<a href="#l49.28"></a><span id="l49.28">      */</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineminus">-    onAlarm: function cAM_onAlarm(aItem, aAlarm) {</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+    onAlarm: function(aItem, aAlarm) {</span>
<a href="#l49.31"></a><span id="l49.31">         if (aAlarm.action != &quot;DISPLAY&quot;) {</span>
<a href="#l49.32"></a><span id="l49.32">             // This monitor only looks for DISPLAY alarms.</span>
<a href="#l49.33"></a><span id="l49.33">             return;</span>
<a href="#l49.34"></a><span id="l49.34">         }</span>
<a href="#l49.35"></a><span id="l49.35"> </span>
<a href="#l49.36"></a><span id="l49.36">         this.mAlarms.push([aItem, aAlarm]);</span>
<a href="#l49.37"></a><span id="l49.37"> </span>
<a href="#l49.38"></a><span id="l49.38">         if (Preferences.get(&quot;calendar.alarms.playsound&quot;, true)) {</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineat">@@ -127,55 +127,55 @@ calAlarmMonitor.prototype = {</span>
<a href="#l49.40"></a><span id="l49.40">                 &quot;chrome,dialog=yes,all,resizable&quot;,</span>
<a href="#l49.41"></a><span id="l49.41">                 this);</span>
<a href="#l49.42"></a><span id="l49.42">         }</span>
<a href="#l49.43"></a><span id="l49.43">         if (!this.mWindowOpening) {</span>
<a href="#l49.44"></a><span id="l49.44">             calAlarmWindow.addWidgetFor(aItem, aAlarm);</span>
<a href="#l49.45"></a><span id="l49.45">         }</span>
<a href="#l49.46"></a><span id="l49.46">     },</span>
<a href="#l49.47"></a><span id="l49.47"> </span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-    window_onLoad: function cAM_window_onLoad() {</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+    window_onLoad: function() {</span>
<a href="#l49.50"></a><span id="l49.50">         let calAlarmWindow = this.mWindowOpening;</span>
<a href="#l49.51"></a><span id="l49.51">         this.mWindowOpening = null;</span>
<a href="#l49.52"></a><span id="l49.52">         if (this.mAlarms.length &gt; 0) {</span>
<a href="#l49.53"></a><span id="l49.53">             for (let [item, alarm] of this.mAlarms) {</span>
<a href="#l49.54"></a><span id="l49.54">                 calAlarmWindow.addWidgetFor(item, alarm);</span>
<a href="#l49.55"></a><span id="l49.55">             }</span>
<a href="#l49.56"></a><span id="l49.56">         } else {</span>
<a href="#l49.57"></a><span id="l49.57">             // Uh oh, it seems the alarms were removed even before the window</span>
<a href="#l49.58"></a><span id="l49.58">             // finished loading. Looks like we can close it again</span>
<a href="#l49.59"></a><span id="l49.59">             calAlarmWindow.closeIfEmpty();</span>
<a href="#l49.60"></a><span id="l49.60">         }</span>
<a href="#l49.61"></a><span id="l49.61">     },</span>
<a href="#l49.62"></a><span id="l49.62"> </span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-    onRemoveAlarmsByItem: function cAM_onRemoveAlarmsByItem(aItem) {</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+    onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l49.65"></a><span id="l49.65">         let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l49.66"></a><span id="l49.66">         this.mAlarms = this.mAlarms.filter(function(itemAlarm) {</span>
<a href="#l49.67"></a><span id="l49.67">             let [thisItem, alarm] = itemAlarm;</span>
<a href="#l49.68"></a><span id="l49.68">             let ret = (aItem.hashId != thisItem.hashId);</span>
<a href="#l49.69"></a><span id="l49.69">             if (!ret &amp;&amp; calAlarmWindow) { // window is open</span>
<a href="#l49.70"></a><span id="l49.70">                 calAlarmWindow.removeWidgetFor(thisItem, alarm);</span>
<a href="#l49.71"></a><span id="l49.71">             }</span>
<a href="#l49.72"></a><span id="l49.72">             return ret;</span>
<a href="#l49.73"></a><span id="l49.73">         });</span>
<a href="#l49.74"></a><span id="l49.74">     },</span>
<a href="#l49.75"></a><span id="l49.75"> </span>
<a href="#l49.76"></a><span id="l49.76" class="difflineminus">-    onRemoveAlarmsByCalendar: function cAM_onRemoveAlarmsByCalendar(calendar) {</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineplus">+    onRemoveAlarmsByCalendar: function(calendar) {</span>
<a href="#l49.78"></a><span id="l49.78">         let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l49.79"></a><span id="l49.79">         this.mAlarms = this.mAlarms.filter(function(itemAlarm) {</span>
<a href="#l49.80"></a><span id="l49.80">             let [thisItem, alarm] = itemAlarm;</span>
<a href="#l49.81"></a><span id="l49.81">             let ret = (calendar.id != thisItem.calendar.id);</span>
<a href="#l49.82"></a><span id="l49.82"> </span>
<a href="#l49.83"></a><span id="l49.83">             if (!ret &amp;&amp; calAlarmWindow) { // window is open</span>
<a href="#l49.84"></a><span id="l49.84">                 calAlarmWindow.removeWidgetFor(thisItem, alarm);</span>
<a href="#l49.85"></a><span id="l49.85">             }</span>
<a href="#l49.86"></a><span id="l49.86">             return ret;</span>
<a href="#l49.87"></a><span id="l49.87">         });</span>
<a href="#l49.88"></a><span id="l49.88">     },</span>
<a href="#l49.89"></a><span id="l49.89"> </span>
<a href="#l49.90"></a><span id="l49.90" class="difflineminus">-    onAlarmsLoaded: function cAM_onAlarmsLoaded(aCalendar) {</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+    onAlarmsLoaded: function(aCalendar) {</span>
<a href="#l49.92"></a><span id="l49.92">         // the alarm dialog won't close while alarms are loading, check again now</span>
<a href="#l49.93"></a><span id="l49.93">         let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l49.94"></a><span id="l49.94">         if (calAlarmWindow &amp;&amp; this.mAlarms.length == 0) {</span>
<a href="#l49.95"></a><span id="l49.95">             calAlarmWindow.closeIfEmpty();</span>
<a href="#l49.96"></a><span id="l49.96">         }</span>
<a href="#l49.97"></a><span id="l49.97">     }</span>
<a href="#l49.98"></a><span id="l49.98"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -36,17 +36,17 @@ function calAlarmService() {</span>
<a href="#l50.4"></a><span id="l50.4">     this.calendarObserver = {</span>
<a href="#l50.5"></a><span id="l50.5">         alarmService: this,</span>
<a href="#l50.6"></a><span id="l50.6"> </span>
<a href="#l50.7"></a><span id="l50.7">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9">         // calIObserver:</span>
<a href="#l50.10"></a><span id="l50.10">         onStartBatch: function() { },</span>
<a href="#l50.11"></a><span id="l50.11">         onEndBatch: function() { },</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-        onLoad: function co_onLoad(calendar) {</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+        onLoad: function(calendar) {</span>
<a href="#l50.14"></a><span id="l50.14">             // ignore any onLoad events until initial getItems() call of startup has finished:</span>
<a href="#l50.15"></a><span id="l50.15">             if (calendar &amp;&amp; this.alarmService.mLoadedCalendars[calendar.id]) {</span>
<a href="#l50.16"></a><span id="l50.16">                 // a refreshed calendar signals that it has been reloaded</span>
<a href="#l50.17"></a><span id="l50.17">                 // (and cannot notify detailed changes), thus reget all alarms of it:</span>
<a href="#l50.18"></a><span id="l50.18">                 this.alarmService.initAlarms([calendar]);</span>
<a href="#l50.19"></a><span id="l50.19">             }</span>
<a href="#l50.20"></a><span id="l50.20">         },</span>
<a href="#l50.21"></a><span id="l50.21"> </span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -121,17 +121,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.23"></a><span id="l50.23">         classDescription: &quot;Calendar Alarm Service&quot;,</span>
<a href="#l50.24"></a><span id="l50.24">         interfaces: calAlarmServiceInterfaces,</span>
<a href="#l50.25"></a><span id="l50.25">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l50.26"></a><span id="l50.26">     }),</span>
<a href="#l50.27"></a><span id="l50.27"> </span>
<a href="#l50.28"></a><span id="l50.28">     /**</span>
<a href="#l50.29"></a><span id="l50.29">      * nsIObserver</span>
<a href="#l50.30"></a><span id="l50.30">      */</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-    observe: function cAS_observe(aSubject, aTopic, aData) {</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l50.33"></a><span id="l50.33">         // This will also be called on app-startup, but nothing is done yet, to</span>
<a href="#l50.34"></a><span id="l50.34">         // prevent unwanted dialogs etc. See bug 325476 and 413296</span>
<a href="#l50.35"></a><span id="l50.35">         if (aTopic == &quot;profile-after-change&quot; || aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l50.36"></a><span id="l50.36">             this.shutdown();</span>
<a href="#l50.37"></a><span id="l50.37">             this.startup();</span>
<a href="#l50.38"></a><span id="l50.38">         }</span>
<a href="#l50.39"></a><span id="l50.39">         if (aTopic == &quot;xpcom-shutdown&quot;) {</span>
<a href="#l50.40"></a><span id="l50.40">             this.shutdown();</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineat">@@ -146,17 +146,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.42"></a><span id="l50.42">         // different than the default timezone?</span>
<a href="#l50.43"></a><span id="l50.43">         return this.mTimezone || calendarDefaultTimezone();</span>
<a href="#l50.44"></a><span id="l50.44">     },</span>
<a href="#l50.45"></a><span id="l50.45"> </span>
<a href="#l50.46"></a><span id="l50.46">     set timezone(aTimezone) {</span>
<a href="#l50.47"></a><span id="l50.47">         return (this.mTimezone = aTimezone);</span>
<a href="#l50.48"></a><span id="l50.48">     },</span>
<a href="#l50.49"></a><span id="l50.49"> </span>
<a href="#l50.50"></a><span id="l50.50" class="difflineminus">-    snoozeAlarm: function cAS_snoozeAlarm(aItem, aAlarm, aDuration) {</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+    snoozeAlarm: function(aItem, aAlarm, aDuration) {</span>
<a href="#l50.52"></a><span id="l50.52">         // Right now we only support snoozing all alarms for the given item for</span>
<a href="#l50.53"></a><span id="l50.53">         // aDuration.</span>
<a href="#l50.54"></a><span id="l50.54"> </span>
<a href="#l50.55"></a><span id="l50.55">         // Make sure we're working with the parent, otherwise we'll accidentally</span>
<a href="#l50.56"></a><span id="l50.56">         // create an exception</span>
<a href="#l50.57"></a><span id="l50.57">         let newEvent = aItem.parentItem.clone();</span>
<a href="#l50.58"></a><span id="l50.58">         let alarmTime = nowUTC();</span>
<a href="#l50.59"></a><span id="l50.59"> </span>
<a href="#l50.60"></a><span id="l50.60" class="difflineat">@@ -176,42 +176,42 @@ calAlarmService.prototype = {</span>
<a href="#l50.61"></a><span id="l50.61">         } else {</span>
<a href="#l50.62"></a><span id="l50.62">             newEvent.setProperty(&quot;X-MOZ-SNOOZE-TIME&quot;, alarmTime.icalString);</span>
<a href="#l50.63"></a><span id="l50.63">         }</span>
<a href="#l50.64"></a><span id="l50.64">         // calling modifyItem will cause us to get the right callback</span>
<a href="#l50.65"></a><span id="l50.65">         // and update the alarm properly</span>
<a href="#l50.66"></a><span id="l50.66">         return newEvent.calendar.modifyItem(newEvent, aItem.parentItem, null);</span>
<a href="#l50.67"></a><span id="l50.67">     },</span>
<a href="#l50.68"></a><span id="l50.68"> </span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-    dismissAlarm: function cAS_dismissAlarm(aItem, aAlarm) {</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+    dismissAlarm: function(aItem, aAlarm) {</span>
<a href="#l50.71"></a><span id="l50.71">         let now = nowUTC();</span>
<a href="#l50.72"></a><span id="l50.72">         // We want the parent item, otherwise we're going to accidentally create an</span>
<a href="#l50.73"></a><span id="l50.73">         // exception.  We've relnoted (for 0.1) the slightly odd behavior this can</span>
<a href="#l50.74"></a><span id="l50.74">         // cause if you move an event after dismissing an alarm</span>
<a href="#l50.75"></a><span id="l50.75">         let oldParent = aItem.parentItem;</span>
<a href="#l50.76"></a><span id="l50.76">         let newParent = oldParent.clone();</span>
<a href="#l50.77"></a><span id="l50.77">         newParent.alarmLastAck = now;</span>
<a href="#l50.78"></a><span id="l50.78">         // Make sure to clear out any snoozes that were here.</span>
<a href="#l50.79"></a><span id="l50.79">         if (aItem.recurrenceId) {</span>
<a href="#l50.80"></a><span id="l50.80">             newParent.deleteProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime);</span>
<a href="#l50.81"></a><span id="l50.81">         } else {</span>
<a href="#l50.82"></a><span id="l50.82">             newParent.deleteProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l50.83"></a><span id="l50.83">         }</span>
<a href="#l50.84"></a><span id="l50.84">         return newParent.calendar.modifyItem(newParent, oldParent, null);</span>
<a href="#l50.85"></a><span id="l50.85">     },</span>
<a href="#l50.86"></a><span id="l50.86"> </span>
<a href="#l50.87"></a><span id="l50.87" class="difflineminus">-    addObserver: function cAS_addObserver(aObserver) {</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineplus">+    addObserver: function(aObserver) {</span>
<a href="#l50.89"></a><span id="l50.89">         this.mObservers.add(aObserver);</span>
<a href="#l50.90"></a><span id="l50.90">     },</span>
<a href="#l50.91"></a><span id="l50.91"> </span>
<a href="#l50.92"></a><span id="l50.92" class="difflineminus">-    removeObserver: function cAS_removeObserver(aObserver) {</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineplus">+    removeObserver: function(aObserver) {</span>
<a href="#l50.94"></a><span id="l50.94">         this.mObservers.remove(aObserver);</span>
<a href="#l50.95"></a><span id="l50.95">     },</span>
<a href="#l50.96"></a><span id="l50.96"> </span>
<a href="#l50.97"></a><span id="l50.97" class="difflineminus">-    startup: function cAS_startup() {</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineplus">+    startup: function() {</span>
<a href="#l50.99"></a><span id="l50.99">         if (this.mStarted) {</span>
<a href="#l50.100"></a><span id="l50.100">             return;</span>
<a href="#l50.101"></a><span id="l50.101">         }</span>
<a href="#l50.102"></a><span id="l50.102"> </span>
<a href="#l50.103"></a><span id="l50.103">         Services.obs.addObserver(this, &quot;profile-after-change&quot;, false);</span>
<a href="#l50.104"></a><span id="l50.104">         Services.obs.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l50.105"></a><span id="l50.105">         Services.obs.addObserver(this, &quot;wake_notification&quot;, false);</span>
<a href="#l50.106"></a><span id="l50.106"> </span>
<a href="#l50.107"></a><span id="l50.107" class="difflineat">@@ -225,17 +225,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.108"></a><span id="l50.108"> </span>
<a href="#l50.109"></a><span id="l50.109">         for (let calendar of getCalendarManager().getCalendars({})) {</span>
<a href="#l50.110"></a><span id="l50.110">             this.observeCalendar(calendar);</span>
<a href="#l50.111"></a><span id="l50.111">         }</span>
<a href="#l50.112"></a><span id="l50.112"> </span>
<a href="#l50.113"></a><span id="l50.113">         /* set up a timer to update alarms every N hours */</span>
<a href="#l50.114"></a><span id="l50.114">         let timerCallback = {</span>
<a href="#l50.115"></a><span id="l50.115">             alarmService: this,</span>
<a href="#l50.116"></a><span id="l50.116" class="difflineminus">-            notify: function timer_notify() {</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineplus">+            notify: function() {</span>
<a href="#l50.118"></a><span id="l50.118">                 let now = nowUTC();</span>
<a href="#l50.119"></a><span id="l50.119">                 let start;</span>
<a href="#l50.120"></a><span id="l50.120">                 if (!this.alarmService.mRangeEnd) {</span>
<a href="#l50.121"></a><span id="l50.121">                     // This is our first search for alarms.  We're going to look for</span>
<a href="#l50.122"></a><span id="l50.122">                     // alarms +/- 1 month from now.  If someone sets an alarm more than</span>
<a href="#l50.123"></a><span id="l50.123">                     // a month ahead of an event, or doesn't start Lightning</span>
<a href="#l50.124"></a><span id="l50.124">                     // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l50.125"></a><span id="l50.125">                     start = now.clone();</span>
<a href="#l50.126"></a><span id="l50.126" class="difflineat">@@ -259,17 +259,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.127"></a><span id="l50.127">         };</span>
<a href="#l50.128"></a><span id="l50.128">         timerCallback.notify();</span>
<a href="#l50.129"></a><span id="l50.129"> </span>
<a href="#l50.130"></a><span id="l50.130">         this.mUpdateTimer = newTimerWithCallback(timerCallback, kHoursBetweenUpdates * 3600000, true);</span>
<a href="#l50.131"></a><span id="l50.131"> </span>
<a href="#l50.132"></a><span id="l50.132">         this.mStarted = true;</span>
<a href="#l50.133"></a><span id="l50.133">     },</span>
<a href="#l50.134"></a><span id="l50.134"> </span>
<a href="#l50.135"></a><span id="l50.135" class="difflineminus">-    shutdown: function cAS_shutdown() {</span>
<a href="#l50.136"></a><span id="l50.136" class="difflineplus">+    shutdown: function() {</span>
<a href="#l50.137"></a><span id="l50.137">         if (!this.mStarted) {</span>
<a href="#l50.138"></a><span id="l50.138">             return;</span>
<a href="#l50.139"></a><span id="l50.139">         }</span>
<a href="#l50.140"></a><span id="l50.140"> </span>
<a href="#l50.141"></a><span id="l50.141">         /* tell people that we're no longer running */</span>
<a href="#l50.142"></a><span id="l50.142">         let notifier = Components.classes[&quot;@mozilla.org/embedcomp/appstartup-notifier;1&quot;]</span>
<a href="#l50.143"></a><span id="l50.143">                                  .getService(Components.interfaces.nsIObserver);</span>
<a href="#l50.144"></a><span id="l50.144">         notifier.observe(null, &quot;alarm-service-shutdown&quot;, null);</span>
<a href="#l50.145"></a><span id="l50.145" class="difflineat">@@ -291,27 +291,27 @@ calAlarmService.prototype = {</span>
<a href="#l50.146"></a><span id="l50.146"> </span>
<a href="#l50.147"></a><span id="l50.147">         Services.obs.removeObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l50.148"></a><span id="l50.148">         Services.obs.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l50.149"></a><span id="l50.149">         Services.obs.removeObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l50.150"></a><span id="l50.150"> </span>
<a href="#l50.151"></a><span id="l50.151">         this.mStarted = false;</span>
<a href="#l50.152"></a><span id="l50.152">     },</span>
<a href="#l50.153"></a><span id="l50.153"> </span>
<a href="#l50.154"></a><span id="l50.154" class="difflineminus">-    observeCalendar: function cAS_observeCalendar(calendar) {</span>
<a href="#l50.155"></a><span id="l50.155" class="difflineplus">+    observeCalendar: function(calendar) {</span>
<a href="#l50.156"></a><span id="l50.156">         calendar.addObserver(this.calendarObserver);</span>
<a href="#l50.157"></a><span id="l50.157">     },</span>
<a href="#l50.158"></a><span id="l50.158"> </span>
<a href="#l50.159"></a><span id="l50.159" class="difflineminus">-    unobserveCalendar: function cAS_unobserveCalendar(calendar) {</span>
<a href="#l50.160"></a><span id="l50.160" class="difflineplus">+    unobserveCalendar: function(calendar) {</span>
<a href="#l50.161"></a><span id="l50.161">         calendar.removeObserver(this.calendarObserver);</span>
<a href="#l50.162"></a><span id="l50.162">         this.disposeCalendarTimers([calendar]);</span>
<a href="#l50.163"></a><span id="l50.163">         this.mObservers.notify(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l50.164"></a><span id="l50.164">     },</span>
<a href="#l50.165"></a><span id="l50.165"> </span>
<a href="#l50.166"></a><span id="l50.166" class="difflineminus">-    addAlarmsForItem: function cAS_addAlarmsForItem(aItem) {</span>
<a href="#l50.167"></a><span id="l50.167" class="difflineplus">+    addAlarmsForItem: function(aItem) {</span>
<a href="#l50.168"></a><span id="l50.168">         if (cal.isToDo(aItem) &amp;&amp; aItem.isCompleted) {</span>
<a href="#l50.169"></a><span id="l50.169">             // If this is a task and it is completed, don't add the alarm.</span>
<a href="#l50.170"></a><span id="l50.170">             return;</span>
<a href="#l50.171"></a><span id="l50.171">         }</span>
<a href="#l50.172"></a><span id="l50.172"> </span>
<a href="#l50.173"></a><span id="l50.173">         let showMissed = Preferences.get(&quot;calendar.alarms.showmissed&quot;, true);</span>
<a href="#l50.174"></a><span id="l50.174"> </span>
<a href="#l50.175"></a><span id="l50.175">         let alarms = aItem.getAlarms({});</span>
<a href="#l50.176"></a><span id="l50.176" class="difflineat">@@ -379,70 +379,70 @@ calAlarmService.prototype = {</span>
<a href="#l50.177"></a><span id="l50.177">                 } else {</span>
<a href="#l50.178"></a><span id="l50.178">                     // The alarm was not snoozed or dismissed, fire it now.</span>
<a href="#l50.179"></a><span id="l50.179">                     this.alarmFired(aItem, alarm);</span>
<a href="#l50.180"></a><span id="l50.180">                 }</span>
<a href="#l50.181"></a><span id="l50.181">             }</span>
<a href="#l50.182"></a><span id="l50.182">         }</span>
<a href="#l50.183"></a><span id="l50.183">     },</span>
<a href="#l50.184"></a><span id="l50.184"> </span>
<a href="#l50.185"></a><span id="l50.185" class="difflineminus">-    removeAlarmsForItem: function cAS_removeAlarmsForItem(aItem) {</span>
<a href="#l50.186"></a><span id="l50.186" class="difflineplus">+    removeAlarmsForItem: function(aItem) {</span>
<a href="#l50.187"></a><span id="l50.187">         // make sure already fired alarms are purged out of the alarm window:</span>
<a href="#l50.188"></a><span id="l50.188">         this.mObservers.notify(&quot;onRemoveAlarmsByItem&quot;, [aItem]);</span>
<a href="#l50.189"></a><span id="l50.189">         // Purge alarms specifically for this item (i.e exception)</span>
<a href="#l50.190"></a><span id="l50.190">         for (let alarm of aItem.getAlarms({})) {</span>
<a href="#l50.191"></a><span id="l50.191">             this.removeTimer(aItem, alarm);</span>
<a href="#l50.192"></a><span id="l50.192">         }</span>
<a href="#l50.193"></a><span id="l50.193">     },</span>
<a href="#l50.194"></a><span id="l50.194"> </span>
<a href="#l50.195"></a><span id="l50.195" class="difflineminus">-    getOccurrencesInRange: function cAS_getOccurrencesInRange(aItem) {</span>
<a href="#l50.196"></a><span id="l50.196" class="difflineplus">+    getOccurrencesInRange: function(aItem) {</span>
<a href="#l50.197"></a><span id="l50.197">         // We search 1 month in each direction for alarms.  Therefore,</span>
<a href="#l50.198"></a><span id="l50.198">         // we need occurrences between initial start date and 1 month from now</span>
<a href="#l50.199"></a><span id="l50.199">         let until = nowUTC();</span>
<a href="#l50.200"></a><span id="l50.200">         until.month += 1;</span>
<a href="#l50.201"></a><span id="l50.201"> </span>
<a href="#l50.202"></a><span id="l50.202">         if (aItem &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l50.203"></a><span id="l50.203">             return aItem.recurrenceInfo.getOccurrences(this.mRangeStart, until, 0, {});</span>
<a href="#l50.204"></a><span id="l50.204">         } else {</span>
<a href="#l50.205"></a><span id="l50.205">             return cal.checkIfInRange(aItem, this.mRangeStart, until) ? [aItem] : [];</span>
<a href="#l50.206"></a><span id="l50.206">         }</span>
<a href="#l50.207"></a><span id="l50.207">     },</span>
<a href="#l50.208"></a><span id="l50.208"> </span>
<a href="#l50.209"></a><span id="l50.209" class="difflineminus">-    addAlarmsForOccurrences: function cAS_addAlarmsForOccurrences(aParentItem) {</span>
<a href="#l50.210"></a><span id="l50.210" class="difflineplus">+    addAlarmsForOccurrences: function(aParentItem) {</span>
<a href="#l50.211"></a><span id="l50.211">         let occs = this.getOccurrencesInRange(aParentItem);</span>
<a href="#l50.212"></a><span id="l50.212"> </span>
<a href="#l50.213"></a><span id="l50.213">         // Add an alarm for each occurrence</span>
<a href="#l50.214"></a><span id="l50.214">         occs.forEach(this.addAlarmsForItem, this);</span>
<a href="#l50.215"></a><span id="l50.215">     },</span>
<a href="#l50.216"></a><span id="l50.216"> </span>
<a href="#l50.217"></a><span id="l50.217" class="difflineminus">-    removeAlarmsForOccurrences: function cAS_removeAlarmsForOccurrences(aParentItem) {</span>
<a href="#l50.218"></a><span id="l50.218" class="difflineplus">+    removeAlarmsForOccurrences: function(aParentItem) {</span>
<a href="#l50.219"></a><span id="l50.219">         let occs = this.getOccurrencesInRange(aParentItem);</span>
<a href="#l50.220"></a><span id="l50.220"> </span>
<a href="#l50.221"></a><span id="l50.221">         // Remove alarm for each occurrence</span>
<a href="#l50.222"></a><span id="l50.222">         occs.forEach(this.removeAlarmsForItem, this);</span>
<a href="#l50.223"></a><span id="l50.223">     },</span>
<a href="#l50.224"></a><span id="l50.224"> </span>
<a href="#l50.225"></a><span id="l50.225" class="difflineminus">-    addTimer: function cAS_addTimer(aItem, aAlarm, aTimeout) {</span>
<a href="#l50.226"></a><span id="l50.226" class="difflineplus">+    addTimer: function(aItem, aAlarm, aTimeout) {</span>
<a href="#l50.227"></a><span id="l50.227">         this.mTimerMap[aItem.calendar.id] =</span>
<a href="#l50.228"></a><span id="l50.228">             this.mTimerMap[aItem.calendar.id] || {};</span>
<a href="#l50.229"></a><span id="l50.229">         this.mTimerMap[aItem.calendar.id][aItem.hashId] =</span>
<a href="#l50.230"></a><span id="l50.230">             this.mTimerMap[aItem.calendar.id][aItem.hashId] || {};</span>
<a href="#l50.231"></a><span id="l50.231"> </span>
<a href="#l50.232"></a><span id="l50.232">         let self = this;</span>
<a href="#l50.233"></a><span id="l50.233">         let alarmTimerCallback = {</span>
<a href="#l50.234"></a><span id="l50.234" class="difflineminus">-            notify: function aTC_notify() {</span>
<a href="#l50.235"></a><span id="l50.235" class="difflineplus">+            notify: function() {</span>
<a href="#l50.236"></a><span id="l50.236">                 self.alarmFired(aItem, aAlarm);</span>
<a href="#l50.237"></a><span id="l50.237">             }</span>
<a href="#l50.238"></a><span id="l50.238">         };</span>
<a href="#l50.239"></a><span id="l50.239"> </span>
<a href="#l50.240"></a><span id="l50.240">         let timer = newTimerWithCallback(alarmTimerCallback, aTimeout, false);</span>
<a href="#l50.241"></a><span id="l50.241">         this.mTimerMap[aItem.calendar.id][aItem.hashId][aAlarm.icalString] = timer;</span>
<a href="#l50.242"></a><span id="l50.242">     },</span>
<a href="#l50.243"></a><span id="l50.243"> </span>
<a href="#l50.244"></a><span id="l50.244" class="difflineminus">-    removeTimer: function cAS_removeTimers(aItem, aAlarm) {</span>
<a href="#l50.245"></a><span id="l50.245" class="difflineplus">+    removeTimer: function(aItem, aAlarm) {</span>
<a href="#l50.246"></a><span id="l50.246">             /* Is the calendar in the timer map */</span>
<a href="#l50.247"></a><span id="l50.247">         if (aItem.calendar.id in this.mTimerMap &amp;&amp;</span>
<a href="#l50.248"></a><span id="l50.248">             /* ...and is the item in the calendar map */</span>
<a href="#l50.249"></a><span id="l50.249">             aItem.hashId in this.mTimerMap[aItem.calendar.id] &amp;&amp;</span>
<a href="#l50.250"></a><span id="l50.250">             /* ...and is the alarm in the item map ? */</span>
<a href="#l50.251"></a><span id="l50.251">             aAlarm.icalString in this.mTimerMap[aItem.calendar.id][aItem.hashId]) {</span>
<a href="#l50.252"></a><span id="l50.252">             // First cancel the existing timer</span>
<a href="#l50.253"></a><span id="l50.253">             let timer = this.mTimerMap[aItem.calendar.id][aItem.hashId][aAlarm.icalString];</span>
<a href="#l50.254"></a><span id="l50.254" class="difflineat">@@ -458,43 +458,39 @@ calAlarmService.prototype = {</span>
<a href="#l50.255"></a><span id="l50.255"> </span>
<a href="#l50.256"></a><span id="l50.256">             // If the calendar map is empty, remove it from the timer map</span>
<a href="#l50.257"></a><span id="l50.257">             if (this.mTimerMap[aItem.calendar.id].toSource() == &quot;({})&quot;) {</span>
<a href="#l50.258"></a><span id="l50.258">                 delete this.mTimerMap[aItem.calendar.id];</span>
<a href="#l50.259"></a><span id="l50.259">             }</span>
<a href="#l50.260"></a><span id="l50.260">         }</span>
<a href="#l50.261"></a><span id="l50.261">     },</span>
<a href="#l50.262"></a><span id="l50.262"> </span>
<a href="#l50.263"></a><span id="l50.263" class="difflineminus">-    disposeCalendarTimers: function cAS_removeCalendarTimers(aCalendars) {</span>
<a href="#l50.264"></a><span id="l50.264" class="difflineplus">+    disposeCalendarTimers: function(aCalendars) {</span>
<a href="#l50.265"></a><span id="l50.265">         for (let calendar of aCalendars) {</span>
<a href="#l50.266"></a><span id="l50.266">             if (calendar.id in this.mTimerMap) {</span>
<a href="#l50.267"></a><span id="l50.267">                 for (let hashId in this.mTimerMap[calendar.id]) {</span>
<a href="#l50.268"></a><span id="l50.268">                     let itemTimerMap = this.mTimerMap[calendar.id][hashId];</span>
<a href="#l50.269"></a><span id="l50.269">                     for (let icalString in itemTimerMap) {</span>
<a href="#l50.270"></a><span id="l50.270">                         let timer = itemTimerMap[icalString];</span>
<a href="#l50.271"></a><span id="l50.271">                         timer.cancel();</span>
<a href="#l50.272"></a><span id="l50.272">                     }</span>
<a href="#l50.273"></a><span id="l50.273">                 }</span>
<a href="#l50.274"></a><span id="l50.274">                 delete this.mTimerMap[calendar.id];</span>
<a href="#l50.275"></a><span id="l50.275">             }</span>
<a href="#l50.276"></a><span id="l50.276">         }</span>
<a href="#l50.277"></a><span id="l50.277">     },</span>
<a href="#l50.278"></a><span id="l50.278"> </span>
<a href="#l50.279"></a><span id="l50.279" class="difflineminus">-    findAlarms: function cAS_findAlarms(aCalendars, aStart, aUntil) {</span>
<a href="#l50.280"></a><span id="l50.280" class="difflineplus">+    findAlarms: function(aCalendars, aStart, aUntil) {</span>
<a href="#l50.281"></a><span id="l50.281">         let getListener = {</span>
<a href="#l50.282"></a><span id="l50.282">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l50.283"></a><span id="l50.283">             alarmService: this,</span>
<a href="#l50.284"></a><span id="l50.284">             addRemovePromise: PromiseUtils.defer(),</span>
<a href="#l50.285"></a><span id="l50.285">             batchCount: 0,</span>
<a href="#l50.286"></a><span id="l50.286">             results: false,</span>
<a href="#l50.287"></a><span id="l50.287" class="difflineminus">-            onOperationComplete: function cAS_fA_onOperationComplete(aCalendar,</span>
<a href="#l50.288"></a><span id="l50.288" class="difflineminus">-                                                                     aStatus,</span>
<a href="#l50.289"></a><span id="l50.289" class="difflineminus">-                                                                     aOperationType,</span>
<a href="#l50.290"></a><span id="l50.290" class="difflineminus">-                                                                     aId,</span>
<a href="#l50.291"></a><span id="l50.291" class="difflineminus">-                                                                     aDetail) {</span>
<a href="#l50.292"></a><span id="l50.292" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l50.293"></a><span id="l50.293">                 this.addRemovePromise.promise.then((aValue) =&gt; {</span>
<a href="#l50.294"></a><span id="l50.294">                     // calendar has been loaded, so until now, onLoad events can be ignored:</span>
<a href="#l50.295"></a><span id="l50.295">                     this.alarmService.mLoadedCalendars[aCalendar.id] = true;</span>
<a href="#l50.296"></a><span id="l50.296"> </span>
<a href="#l50.297"></a><span id="l50.297">                     // notify observers that the alarms for the calendar have been loaded</span>
<a href="#l50.298"></a><span id="l50.298">                     this.alarmService.mObservers.notify(&quot;onAlarmsLoaded&quot;, [aCalendar]);</span>
<a href="#l50.299"></a><span id="l50.299">                 }, (aReason) =&gt; {</span>
<a href="#l50.300"></a><span id="l50.300">                     Components.utils.reportError(&quot;Promise was rejected: &quot; + aReason);</span>
<a href="#l50.301"></a><span id="l50.301" class="difflineat">@@ -502,22 +498,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.302"></a><span id="l50.302">                     this.alarmService.mObservers.notify(&quot;onAlarmsLoaded&quot;, [aCalendar]);</span>
<a href="#l50.303"></a><span id="l50.303">                 });</span>
<a href="#l50.304"></a><span id="l50.304"> </span>
<a href="#l50.305"></a><span id="l50.305">                 // if no results were returned we still need to resolve the promise</span>
<a href="#l50.306"></a><span id="l50.306">                 if (!this.results) {</span>
<a href="#l50.307"></a><span id="l50.307">                     this.addRemovePromise.resolve();</span>
<a href="#l50.308"></a><span id="l50.308">                 }</span>
<a href="#l50.309"></a><span id="l50.309">             },</span>
<a href="#l50.310"></a><span id="l50.310" class="difflineminus">-            onGetResult: function cAS_fA_onGetResult(aCalendar,</span>
<a href="#l50.311"></a><span id="l50.311" class="difflineminus">-                                                     aStatus,</span>
<a href="#l50.312"></a><span id="l50.312" class="difflineminus">-                                                     aItemType,</span>
<a href="#l50.313"></a><span id="l50.313" class="difflineminus">-                                                     aDetail,</span>
<a href="#l50.314"></a><span id="l50.314" class="difflineminus">-                                                     aCount,</span>
<a href="#l50.315"></a><span id="l50.315" class="difflineminus">-                                                     aItems) {</span>
<a href="#l50.316"></a><span id="l50.316" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l50.317"></a><span id="l50.317">                 let promise = this.addRemovePromise;</span>
<a href="#l50.318"></a><span id="l50.318">                 this.batchCount++;</span>
<a href="#l50.319"></a><span id="l50.319">                 this.results = true;</span>
<a href="#l50.320"></a><span id="l50.320"> </span>
<a href="#l50.321"></a><span id="l50.321">                 cal.forEach(aItems, (item) =&gt; {</span>
<a href="#l50.322"></a><span id="l50.322">                     try {</span>
<a href="#l50.323"></a><span id="l50.323">                         this.alarmService.removeAlarmsForItem(item);</span>
<a href="#l50.324"></a><span id="l50.324">                         this.alarmService.addAlarmsForItem(item);</span>
<a href="#l50.325"></a><span id="l50.325" class="difflineat">@@ -545,17 +536,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.326"></a><span id="l50.326">                 calendar.getItems(filter, 0, aStart, aUntil, getListener);</span>
<a href="#l50.327"></a><span id="l50.327">             } else {</span>
<a href="#l50.328"></a><span id="l50.328">                 this.mLoadedCalendars[calendar.id] = true;</span>
<a href="#l50.329"></a><span id="l50.329">                 this.mObservers.notify(&quot;onAlarmsLoaded&quot;, [calendar]);</span>
<a href="#l50.330"></a><span id="l50.330">             }</span>
<a href="#l50.331"></a><span id="l50.331">         }</span>
<a href="#l50.332"></a><span id="l50.332">     },</span>
<a href="#l50.333"></a><span id="l50.333"> </span>
<a href="#l50.334"></a><span id="l50.334" class="difflineminus">-    initAlarms: function cAS_initAlarms(aCalendars) {</span>
<a href="#l50.335"></a><span id="l50.335" class="difflineplus">+    initAlarms: function(aCalendars) {</span>
<a href="#l50.336"></a><span id="l50.336">         // Purge out all alarm timers belonging to the refreshed/loaded calendars</span>
<a href="#l50.337"></a><span id="l50.337">         this.disposeCalendarTimers(aCalendars);</span>
<a href="#l50.338"></a><span id="l50.338"> </span>
<a href="#l50.339"></a><span id="l50.339">         // Purge out all alarms from dialog belonging to the refreshed/loaded calendars</span>
<a href="#l50.340"></a><span id="l50.340">         for (let calendar of aCalendars) {</span>
<a href="#l50.341"></a><span id="l50.341">             this.mLoadedCalendars[calendar.id] = false;</span>
<a href="#l50.342"></a><span id="l50.342">             this.mObservers.notify(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l50.343"></a><span id="l50.343">         }</span>
<a href="#l50.344"></a><span id="l50.344" class="difflineat">@@ -566,17 +557,17 @@ calAlarmService.prototype = {</span>
<a href="#l50.345"></a><span id="l50.345">         // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l50.346"></a><span id="l50.346">         let start = nowUTC();</span>
<a href="#l50.347"></a><span id="l50.347">         let until = start.clone();</span>
<a href="#l50.348"></a><span id="l50.348">         start.month -= Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l50.349"></a><span id="l50.349">         until.month += Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l50.350"></a><span id="l50.350">         this.findAlarms(aCalendars, start, until);</span>
<a href="#l50.351"></a><span id="l50.351">     },</span>
<a href="#l50.352"></a><span id="l50.352"> </span>
<a href="#l50.353"></a><span id="l50.353" class="difflineminus">-    alarmFired: function cAS_alarmFired(aItem, aAlarm) {</span>
<a href="#l50.354"></a><span id="l50.354" class="difflineplus">+    alarmFired: function(aItem, aAlarm) {</span>
<a href="#l50.355"></a><span id="l50.355">         if (!aItem.calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l50.356"></a><span id="l50.356">             !aItem.calendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l50.357"></a><span id="l50.357">             aItem.getProperty(&quot;STATUS&quot;) != &quot;CANCELLED&quot;) {</span>
<a href="#l50.358"></a><span id="l50.358">             this.mObservers.notify(&quot;onAlarm&quot;, [aItem, aAlarm]);</span>
<a href="#l50.359"></a><span id="l50.359">         }</span>
<a href="#l50.360"></a><span id="l50.360">     },</span>
<a href="#l50.361"></a><span id="l50.361"> </span>
<a href="#l50.362"></a><span id="l50.362">     get isLoading() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -155,25 +155,25 @@ calAttachment.prototype = {</span>
<a href="#l51.4"></a><span id="l51.4">             return this.mProperties.deleteProperty(aName);</span>
<a href="#l51.5"></a><span id="l51.5">         }</span>
<a href="#l51.6"></a><span id="l51.6">     },</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8">     deleteParameter: function(aName) {</span>
<a href="#l51.9"></a><span id="l51.9">         this.mProperties.deleteProperty(aName);</span>
<a href="#l51.10"></a><span id="l51.10">     },</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-    clone: function cA_clone() {</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+    clone: function() {</span>
<a href="#l51.14"></a><span id="l51.14">         let newAttachment = new calAttachment();</span>
<a href="#l51.15"></a><span id="l51.15">         newAttachment.mData = this.mData;</span>
<a href="#l51.16"></a><span id="l51.16">         newAttachment.mHashId = this.mHashId;</span>
<a href="#l51.17"></a><span id="l51.17">         for (let [name, value] of this.mProperties) {</span>
<a href="#l51.18"></a><span id="l51.18">             newAttachment.mProperties.setProperty(name, value);</span>
<a href="#l51.19"></a><span id="l51.19">         }</span>
<a href="#l51.20"></a><span id="l51.20">         return newAttachment;</span>
<a href="#l51.21"></a><span id="l51.21">     },</span>
<a href="#l51.22"></a><span id="l51.22"> </span>
<a href="#l51.23"></a><span id="l51.23" class="difflineminus">-    setData: function setData(aData) {</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+    setData: function(aData) {</span>
<a href="#l51.25"></a><span id="l51.25">         // Sets the data and invalidates the hash so it will be recalculated</span>
<a href="#l51.26"></a><span id="l51.26">         this.mHashId = null;</span>
<a href="#l51.27"></a><span id="l51.27">         this.mData = aData;</span>
<a href="#l51.28"></a><span id="l51.28">         return this.mData;</span>
<a href="#l51.29"></a><span id="l51.29">     }</span>
<a href="#l51.30"></a><span id="l51.30"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -176,17 +176,17 @@ calAttendee.prototype = {</span>
<a href="#l52.4"></a><span id="l52.4">     },</span>
<a href="#l52.5"></a><span id="l52.5">     set id(aId) {</span>
<a href="#l52.6"></a><span id="l52.6">         this.modify();</span>
<a href="#l52.7"></a><span id="l52.7">         // RFC 1738 para 2.1 says we should be using lowercase mailto: urls</span>
<a href="#l52.8"></a><span id="l52.8">         // we enforce prepending the mailto prefix for email type ids as migration code bug 1199942</span>
<a href="#l52.9"></a><span id="l52.9">         return (this.mId = (aId ? cal.prependMailTo(aId) : null));</span>
<a href="#l52.10"></a><span id="l52.10">     },</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    toString: function calAttendee_toString() {</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+    toString: function() {</span>
<a href="#l52.14"></a><span id="l52.14">         const emailRE = new RegExp(&quot;^mailto:&quot;, &quot;i&quot;);</span>
<a href="#l52.15"></a><span id="l52.15">         let stringRep = (this.id || &quot;&quot;).replace(emailRE, &quot;&quot;);</span>
<a href="#l52.16"></a><span id="l52.16">         let commonName = this.commonName;</span>
<a href="#l52.17"></a><span id="l52.17"> </span>
<a href="#l52.18"></a><span id="l52.18">         if (commonName) {</span>
<a href="#l52.19"></a><span id="l52.19">             stringRep = commonName + &quot; &lt;&quot; + stringRep + &quot;&gt;&quot;;</span>
<a href="#l52.20"></a><span id="l52.20">         }</span>
<a href="#l52.21"></a><span id="l52.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -127,17 +127,17 @@ function calCachedCalendar(uncachedCalen</span>
<a href="#l53.4"></a><span id="l53.4">     this.setupCachedCalendar();</span>
<a href="#l53.5"></a><span id="l53.5">     if (this.supportsChangeLog) {</span>
<a href="#l53.6"></a><span id="l53.6">         uncachedCalendar.offlineStorage = this.mCachedCalendar;</span>
<a href="#l53.7"></a><span id="l53.7">     }</span>
<a href="#l53.8"></a><span id="l53.8">     this.offlineCachedItems = {};</span>
<a href="#l53.9"></a><span id="l53.9">     this.offlineCachedItemFlags = {};</span>
<a href="#l53.10"></a><span id="l53.10"> }</span>
<a href="#l53.11"></a><span id="l53.11"> calCachedCalendar.prototype = {</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-    QueryInterface: function cCC_QueryInterface(aIID) {</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+    QueryInterface: function(aIID) {</span>
<a href="#l53.14"></a><span id="l53.14">         if (aIID.equals(Components.interfaces.calISchedulingSupport) &amp;&amp;</span>
<a href="#l53.15"></a><span id="l53.15">             this.mUncachedCalendar.QueryInterface(aIID)) {</span>
<a href="#l53.16"></a><span id="l53.16">             // check whether uncached calendar supports it:</span>
<a href="#l53.17"></a><span id="l53.17">             return this;</span>
<a href="#l53.18"></a><span id="l53.18">         } else if (aIID.equals(Components.interfaces.calICalendar) ||</span>
<a href="#l53.19"></a><span id="l53.19">                    aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l53.20"></a><span id="l53.20">             return this;</span>
<a href="#l53.21"></a><span id="l53.21">         } else {</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineat">@@ -166,17 +166,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l53.23"></a><span id="l53.23">                 }</span>
<a href="#l53.24"></a><span id="l53.24">             };</span>
<a href="#l53.25"></a><span id="l53.25"> </span>
<a href="#l53.26"></a><span id="l53.26">             this.mCachedCalendar.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l53.27"></a><span id="l53.27">                                 .deleteCalendar(this.mCachedCalendar, listener);</span>
<a href="#l53.28"></a><span id="l53.28">         }</span>
<a href="#l53.29"></a><span id="l53.29">     },</span>
<a href="#l53.30"></a><span id="l53.30"> </span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-    setupCachedCalendar: function cCC_setupCachedCalendar() {</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+    setupCachedCalendar: function() {</span>
<a href="#l53.33"></a><span id="l53.33">         try {</span>
<a href="#l53.34"></a><span id="l53.34">             if (this.mCachedCalendar) { // this is actually a resetupCachedCalendar:</span>
<a href="#l53.35"></a><span id="l53.35">                 // Although this doesn't really follow the spec, we know the</span>
<a href="#l53.36"></a><span id="l53.36">                 // storage calendar's deleteCalendar method is synchronous.</span>
<a href="#l53.37"></a><span id="l53.37">                 // TODO put changes into a different calendar and delete</span>
<a href="#l53.38"></a><span id="l53.38">                 // afterwards.</span>
<a href="#l53.39"></a><span id="l53.39">                 this.mCachedCalendar.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l53.40"></a><span id="l53.40">                                     .deleteCalendar(this.mCachedCalendar, null);</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineat">@@ -217,79 +217,79 @@ calCachedCalendar.prototype = {</span>
<a href="#l53.42"></a><span id="l53.42">                 cachedCalendar.addObserver(this.mCachedObserver);</span>
<a href="#l53.43"></a><span id="l53.43">                 this.mCachedCalendar = cachedCalendar;</span>
<a href="#l53.44"></a><span id="l53.44">             }</span>
<a href="#l53.45"></a><span id="l53.45">         } catch (exc) {</span>
<a href="#l53.46"></a><span id="l53.46">             Components.utils.reportError(exc);</span>
<a href="#l53.47"></a><span id="l53.47">         }</span>
<a href="#l53.48"></a><span id="l53.48">     },</span>
<a href="#l53.49"></a><span id="l53.49"> </span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-    getOfflineAddedItems: function cCC_getOfflineAddedItems(callbackFunc) {</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+    getOfflineAddedItems: function(callbackFunc) {</span>
<a href="#l53.52"></a><span id="l53.52">         let self = this;</span>
<a href="#l53.53"></a><span id="l53.53">         self.offlineCachedItems = {};</span>
<a href="#l53.54"></a><span id="l53.54">         let getListener = {</span>
<a href="#l53.55"></a><span id="l53.55">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineminus">-            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.58"></a><span id="l53.58">                 for (let item of aItems) {</span>
<a href="#l53.59"></a><span id="l53.59">                     self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l53.60"></a><span id="l53.60">                     self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l53.61"></a><span id="l53.61">                 }</span>
<a href="#l53.62"></a><span id="l53.62">             },</span>
<a href="#l53.63"></a><span id="l53.63"> </span>
<a href="#l53.64"></a><span id="l53.64" class="difflineminus">-            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.66"></a><span id="l53.66">                 self.getOfflineModifiedItems(callbackFunc);</span>
<a href="#l53.67"></a><span id="l53.67">             }</span>
<a href="#l53.68"></a><span id="l53.68">         };</span>
<a href="#l53.69"></a><span id="l53.69">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS | calICalendar.ITEM_FILTER_OFFLINE_CREATED,</span>
<a href="#l53.70"></a><span id="l53.70">                                       0, null, null, getListener);</span>
<a href="#l53.71"></a><span id="l53.71">     },</span>
<a href="#l53.72"></a><span id="l53.72"> </span>
<a href="#l53.73"></a><span id="l53.73" class="difflineminus">-    getOfflineModifiedItems: function cCC_getOfflineModifiedItems(callbackFunc) {</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+    getOfflineModifiedItems: function(callbackFunc) {</span>
<a href="#l53.75"></a><span id="l53.75">         let self = this;</span>
<a href="#l53.76"></a><span id="l53.76">         let getListener = {</span>
<a href="#l53.77"></a><span id="l53.77">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineminus">-            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.80"></a><span id="l53.80">                 for (let item of aItems) {</span>
<a href="#l53.81"></a><span id="l53.81">                     self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l53.82"></a><span id="l53.82">                     self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l53.83"></a><span id="l53.83">                 }</span>
<a href="#l53.84"></a><span id="l53.84">             },</span>
<a href="#l53.85"></a><span id="l53.85"> </span>
<a href="#l53.86"></a><span id="l53.86" class="difflineminus">-            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.88"></a><span id="l53.88">                 self.getOfflineDeletedItems(callbackFunc);</span>
<a href="#l53.89"></a><span id="l53.89">             }</span>
<a href="#l53.90"></a><span id="l53.90">         };</span>
<a href="#l53.91"></a><span id="l53.91">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_MODIFIED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l53.92"></a><span id="l53.92">                                       0, null, null, getListener);</span>
<a href="#l53.93"></a><span id="l53.93">     },</span>
<a href="#l53.94"></a><span id="l53.94"> </span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-    getOfflineDeletedItems: function cCC_getOfflineDeletedItems(callbackFunc) {</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineplus">+    getOfflineDeletedItems: function(callbackFunc) {</span>
<a href="#l53.97"></a><span id="l53.97">         let self = this;</span>
<a href="#l53.98"></a><span id="l53.98">         let getListener = {</span>
<a href="#l53.99"></a><span id="l53.99">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineminus">-            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.102"></a><span id="l53.102">                 for (let item of aItems) {</span>
<a href="#l53.103"></a><span id="l53.103">                     self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l53.104"></a><span id="l53.104">                     self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l53.105"></a><span id="l53.105">                 }</span>
<a href="#l53.106"></a><span id="l53.106">             },</span>
<a href="#l53.107"></a><span id="l53.107"> </span>
<a href="#l53.108"></a><span id="l53.108" class="difflineminus">-            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.110"></a><span id="l53.110">                 if (callbackFunc) {</span>
<a href="#l53.111"></a><span id="l53.111">                     callbackFunc();</span>
<a href="#l53.112"></a><span id="l53.112">                 }</span>
<a href="#l53.113"></a><span id="l53.113">             }</span>
<a href="#l53.114"></a><span id="l53.114">         };</span>
<a href="#l53.115"></a><span id="l53.115">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_DELETED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l53.116"></a><span id="l53.116">                                       0, null, null, getListener);</span>
<a href="#l53.117"></a><span id="l53.117">     },</span>
<a href="#l53.118"></a><span id="l53.118"> </span>
<a href="#l53.119"></a><span id="l53.119">     mPendingSync: null,</span>
<a href="#l53.120"></a><span id="l53.120">     mSyncQueue: null,</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineminus">-    synchronize: function cCC_synchronize(respFunc) {</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineplus">+    synchronize: function(respFunc) {</span>
<a href="#l53.123"></a><span id="l53.123">         let self = this;</span>
<a href="#l53.124"></a><span id="l53.124">         if (this.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l53.125"></a><span id="l53.125">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l53.126"></a><span id="l53.126">         }</span>
<a href="#l53.127"></a><span id="l53.127"> </span>
<a href="#l53.128"></a><span id="l53.128">         this.mSyncQueue.push(respFunc);</span>
<a href="#l53.129"></a><span id="l53.129">         if (this.mSyncQueue.length &gt; 1) { // don't use mPendingSync here</span>
<a href="#l53.130"></a><span id="l53.130">             cal.LOG(&quot;[calCachedCalendar] sync in action/pending.&quot;);</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineat">@@ -342,53 +342,44 @@ calCachedCalendar.prototype = {</span>
<a href="#l53.132"></a><span id="l53.132">         let completeListener = {</span>
<a href="#l53.133"></a><span id="l53.133">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l53.134"></a><span id="l53.134">             modifiedTimes: {},</span>
<a href="#l53.135"></a><span id="l53.135">             hasRenewedCalendar: false,</span>
<a href="#l53.136"></a><span id="l53.136">             getsCompleted: 0,</span>
<a href="#l53.137"></a><span id="l53.137">             getsReceived: 0,</span>
<a href="#l53.138"></a><span id="l53.138">             opCompleted: false,</span>
<a href="#l53.139"></a><span id="l53.139"> </span>
<a href="#l53.140"></a><span id="l53.140" class="difflineminus">-            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar,</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineminus">-                                                         aStatus,</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineminus">-                                                         aItemType,</span>
<a href="#l53.143"></a><span id="l53.143" class="difflineminus">-                                                         aDetail,</span>
<a href="#l53.144"></a><span id="l53.144" class="difflineminus">-                                                         aCount,</span>
<a href="#l53.145"></a><span id="l53.145" class="difflineminus">-                                                         aItems) {</span>
<a href="#l53.146"></a><span id="l53.146" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l53.147"></a><span id="l53.147">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l53.148"></a><span id="l53.148">                     if (!this.hasRenewedCalendar) {</span>
<a href="#l53.149"></a><span id="l53.149">                         // TODO instead of deleting the calendar and creating a new</span>
<a href="#l53.150"></a><span id="l53.150">                         // one, maybe we want to do a &quot;real&quot; sync between the</span>
<a href="#l53.151"></a><span id="l53.151">                         // existing local calendar and the remote calendar.</span>
<a href="#l53.152"></a><span id="l53.152">                         self.setupCachedCalendar();</span>
<a href="#l53.153"></a><span id="l53.153">                         this.hasRenewedCalendar = true;</span>
<a href="#l53.154"></a><span id="l53.154">                     }</span>
<a href="#l53.155"></a><span id="l53.155"> </span>
<a href="#l53.156"></a><span id="l53.156">                     this.getsReceived++;</span>
<a href="#l53.157"></a><span id="l53.157">                     cal.forEach(aItems, function(item) {</span>
<a href="#l53.158"></a><span id="l53.158">                         // Adding items recd from the Memory Calendar</span>
<a href="#l53.159"></a><span id="l53.159">                         // These may be different than what the cache has</span>
<a href="#l53.160"></a><span id="l53.160">                         completeListener.modifiedTimes[item.id] = item.lastModifiedTime;</span>
<a href="#l53.161"></a><span id="l53.161">                         self.mCachedCalendar.addItem(item, null);</span>
<a href="#l53.162"></a><span id="l53.162" class="difflineminus">-                    }, function completed() {</span>
<a href="#l53.163"></a><span id="l53.163" class="difflineplus">+                    }, function() {</span>
<a href="#l53.164"></a><span id="l53.164">                         completeListener.getsCompleted++;</span>
<a href="#l53.165"></a><span id="l53.165">                         if (completeListener.opCompleted) {</span>
<a href="#l53.166"></a><span id="l53.166">                             // onOperationComplete was called, but we were not ready yet. call it now.</span>
<a href="#l53.167"></a><span id="l53.167">                             completeListener.onOperationComplete.apply(completeListener, completeListener.opCompleted);</span>
<a href="#l53.168"></a><span id="l53.168">                             completeListener.opCompleted = false;</span>
<a href="#l53.169"></a><span id="l53.169">                         }</span>
<a href="#l53.170"></a><span id="l53.170">                     });</span>
<a href="#l53.171"></a><span id="l53.171">                 }</span>
<a href="#l53.172"></a><span id="l53.172">             },</span>
<a href="#l53.173"></a><span id="l53.173"> </span>
<a href="#l53.174"></a><span id="l53.174" class="difflineminus">-            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar,</span>
<a href="#l53.175"></a><span id="l53.175" class="difflineminus">-                                                                         aStatus,</span>
<a href="#l53.176"></a><span id="l53.176" class="difflineminus">-                                                                         aOpType,</span>
<a href="#l53.177"></a><span id="l53.177" class="difflineminus">-                                                                         aId,</span>
<a href="#l53.178"></a><span id="l53.178" class="difflineminus">-                                                                         aDetail) {</span>
<a href="#l53.179"></a><span id="l53.179" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l53.180"></a><span id="l53.180">                 if (this.getsCompleted &lt; this.getsReceived) {</span>
<a href="#l53.181"></a><span id="l53.181">                     // If not all of our gets have been processed, then save the</span>
<a href="#l53.182"></a><span id="l53.182">                     // arguments and finish processing later.</span>
<a href="#l53.183"></a><span id="l53.183">                     this.opCompleted = Array.slice(arguments);</span>
<a href="#l53.184"></a><span id="l53.184">                     return;</span>
<a href="#l53.185"></a><span id="l53.185">                 }</span>
<a href="#l53.186"></a><span id="l53.186"> </span>
<a href="#l53.187"></a><span id="l53.187">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l53.188"></a><span id="l53.188" class="difflineat">@@ -429,18 +420,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l53.189"></a><span id="l53.189">                                         // ...and has not been modified. Delete it now.</span>
<a href="#l53.190"></a><span id="l53.190">                                         self.deleteOfflineItem(item, null);</span>
<a href="#l53.191"></a><span id="l53.191">                                     }</span>
<a href="#l53.192"></a><span id="l53.192">                                 } else {</span>
<a href="#l53.193"></a><span id="l53.193">                                     // Item has already been deleted from the server, no need to change anything.</span>
<a href="#l53.194"></a><span id="l53.194">                                 }</span>
<a href="#l53.195"></a><span id="l53.195">                                 break;</span>
<a href="#l53.196"></a><span id="l53.196">                         }</span>
<a href="#l53.197"></a><span id="l53.197" class="difflineminus">-                    },</span>
<a href="#l53.198"></a><span id="l53.198" class="difflineminus">-                    function completed() {</span>
<a href="#l53.199"></a><span id="l53.199" class="difflineplus">+                    }, function() {</span>
<a href="#l53.200"></a><span id="l53.200">                         self.offlineCachedItems = {};</span>
<a href="#l53.201"></a><span id="l53.201">                         self.offlineCachedItemFlags = {};</span>
<a href="#l53.202"></a><span id="l53.202">                         self.playbackOfflineItems(() =&gt; emptyQueue(aStatus));</span>
<a href="#l53.203"></a><span id="l53.203">                     });</span>
<a href="#l53.204"></a><span id="l53.204">                 } else {</span>
<a href="#l53.205"></a><span id="l53.205">                     self.playbackOfflineItems(function() { self.mCachedObserver.onLoad(self.mCachedCalendar); });</span>
<a href="#l53.206"></a><span id="l53.206">                     emptyQueue(aStatus);</span>
<a href="#l53.207"></a><span id="l53.207">                 }</span>
<a href="#l53.208"></a><span id="l53.208" class="difflineat">@@ -449,27 +439,27 @@ calCachedCalendar.prototype = {</span>
<a href="#l53.209"></a><span id="l53.209"> </span>
<a href="#l53.210"></a><span id="l53.210">         this.getOfflineAddedItems(() =&gt; {</span>
<a href="#l53.211"></a><span id="l53.211">             this.mPendingSync = this.mUncachedCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l53.212"></a><span id="l53.212">                                                                     0, null, null, completeListener);</span>
<a href="#l53.213"></a><span id="l53.213">         });</span>
<a href="#l53.214"></a><span id="l53.214">         return this.mPendingSync;</span>
<a href="#l53.215"></a><span id="l53.215">     },</span>
<a href="#l53.216"></a><span id="l53.216"> </span>
<a href="#l53.217"></a><span id="l53.217" class="difflineminus">-    onOfflineStatusChanged: function cCC_onOfflineStatusChanged(aNewState) {</span>
<a href="#l53.218"></a><span id="l53.218" class="difflineplus">+    onOfflineStatusChanged: function(aNewState) {</span>
<a href="#l53.219"></a><span id="l53.219">         if (aNewState) {</span>
<a href="#l53.220"></a><span id="l53.220">             // Going offline: (XXX get items before going offline?) =&gt; we may ask the user to stay online a bit longer</span>
<a href="#l53.221"></a><span id="l53.221">         } else {</span>
<a href="#l53.222"></a><span id="l53.222">             // Going online (start replaying changes to the remote calendar)</span>
<a href="#l53.223"></a><span id="l53.223">             this.refresh();</span>
<a href="#l53.224"></a><span id="l53.224">         }</span>
<a href="#l53.225"></a><span id="l53.225">     },</span>
<a href="#l53.226"></a><span id="l53.226"> </span>
<a href="#l53.227"></a><span id="l53.227">     // aOldItem is already in the cache</span>
<a href="#l53.228"></a><span id="l53.228" class="difflineminus">-    promptOverwrite: function cCC_promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l53.229"></a><span id="l53.229" class="difflineplus">+    promptOverwrite: function(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l53.230"></a><span id="l53.230">         let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l53.231"></a><span id="l53.231">         if (overwrite) {</span>
<a href="#l53.232"></a><span id="l53.232">             if (aMethod == &quot;modify&quot;) {</span>
<a href="#l53.233"></a><span id="l53.233">                 this.modifyOfflineItem(aItem, aOldItem, aListener);</span>
<a href="#l53.234"></a><span id="l53.234">             } else {</span>
<a href="#l53.235"></a><span id="l53.235">                 this.deleteOfflineItem(aItem, aListener);</span>
<a href="#l53.236"></a><span id="l53.236">             }</span>
<a href="#l53.237"></a><span id="l53.237">         }</span>
<a href="#l53.238"></a><span id="l53.238" class="difflineat">@@ -480,17 +470,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l53.239"></a><span id="l53.239">      *</span>
<a href="#l53.240"></a><span id="l53.240">      * @param aCallback         (optional) The function to be callled when playback is complete.</span>
<a href="#l53.241"></a><span id="l53.241">      * @param aPlaybackType     (optional) The starting operation type. This function will be</span>
<a href="#l53.242"></a><span id="l53.242">      *                          called recursively through playback operations in the order of</span>
<a href="#l53.243"></a><span id="l53.243">      *                          add, modify, delete. By default playback will start with the add</span>
<a href="#l53.244"></a><span id="l53.244">      *                          operation. Valid values for this parameter are defined as</span>
<a href="#l53.245"></a><span id="l53.245">      *                          OFFLINE_FLAG_XXX constants in the calIChangeLog interface.</span>
<a href="#l53.246"></a><span id="l53.246">      */</span>
<a href="#l53.247"></a><span id="l53.247" class="difflineminus">-    playbackOfflineItems: function cCC_playbackOfflineItems(aCallback, aPlaybackType) {</span>
<a href="#l53.248"></a><span id="l53.248" class="difflineplus">+    playbackOfflineItems: function(aCallback, aPlaybackType) {</span>
<a href="#l53.249"></a><span id="l53.249">         let self = this;</span>
<a href="#l53.250"></a><span id="l53.250">         let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l53.251"></a><span id="l53.251"> </span>
<a href="#l53.252"></a><span id="l53.252">         let resetListener = gNoOpListener;</span>
<a href="#l53.253"></a><span id="l53.253">         let itemQueue = [];</span>
<a href="#l53.254"></a><span id="l53.254">         let debugOp;</span>
<a href="#l53.255"></a><span id="l53.255">         let nextCallback;</span>
<a href="#l53.256"></a><span id="l53.256">         let uncachedOp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -36,17 +36,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.4"></a><span id="l54.4">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l54.5"></a><span id="l54.5">     }),</span>
<a href="#l54.6"></a><span id="l54.6"> </span>
<a href="#l54.7"></a><span id="l54.7">     get networkCalendarCount() { return this.mNetworkCalendarCount; },</span>
<a href="#l54.8"></a><span id="l54.8">     get readOnlyCalendarCount() { return this.mReadonlyCalendarCount; },</span>
<a href="#l54.9"></a><span id="l54.9">     get calendarCount() { return this.mCalendarCount; },</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11">     // calIStartupService:</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-    startup: function ccm_startup(aCompleteListener) {</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+    startup: function(aCompleteListener) {</span>
<a href="#l54.14"></a><span id="l54.14">         AddonManager.addAddonListener(gCalendarManagerAddonListener);</span>
<a href="#l54.15"></a><span id="l54.15">         this.checkAndMigrateDB();</span>
<a href="#l54.16"></a><span id="l54.16">         this.mCache = null;</span>
<a href="#l54.17"></a><span id="l54.17">         this.mCalObservers = null;</span>
<a href="#l54.18"></a><span id="l54.18">         this.mRefreshTimer = {};</span>
<a href="#l54.19"></a><span id="l54.19">         this.setupOfflineObservers();</span>
<a href="#l54.20"></a><span id="l54.20">         this.mNetworkCalendarCount = 0;</span>
<a href="#l54.21"></a><span id="l54.21">         this.mReadonlyCalendarCount = 0;</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineat">@@ -58,17 +58,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.23"></a><span id="l54.23">         // pref on startup to avoid checking for every http request</span>
<a href="#l54.24"></a><span id="l54.24">         if (Preferences.get(&quot;calendar.network.multirealm&quot;, false)) {</span>
<a href="#l54.25"></a><span id="l54.25">             Services.obs.addObserver(this, &quot;http-on-examine-response&quot;, false);</span>
<a href="#l54.26"></a><span id="l54.26">         }</span>
<a href="#l54.27"></a><span id="l54.27"> </span>
<a href="#l54.28"></a><span id="l54.28">         aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l54.29"></a><span id="l54.29">     },</span>
<a href="#l54.30"></a><span id="l54.30"> </span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-    shutdown: function ccm_shutdown(aCompleteListener) {</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+    shutdown: function(aCompleteListener) {</span>
<a href="#l54.33"></a><span id="l54.33">         for (let id in this.mCache) {</span>
<a href="#l54.34"></a><span id="l54.34">             let calendar = this.mCache[id];</span>
<a href="#l54.35"></a><span id="l54.35">             calendar.removeObserver(this.mCalObservers[calendar.id]);</span>
<a href="#l54.36"></a><span id="l54.36">         }</span>
<a href="#l54.37"></a><span id="l54.37"> </span>
<a href="#l54.38"></a><span id="l54.38">         this.cleanupOfflineObservers();</span>
<a href="#l54.39"></a><span id="l54.39"> </span>
<a href="#l54.40"></a><span id="l54.40">         Services.obs.removeObserver(this, &quot;http-on-modify-request&quot;);</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineat">@@ -81,25 +81,25 @@ calCalendarManager.prototype = {</span>
<a href="#l54.42"></a><span id="l54.42">         if (Preferences.get(&quot;calendar.network.multirealm&quot;, false)) {</span>
<a href="#l54.43"></a><span id="l54.43">             Services.obs.removeObserver(this, &quot;http-on-examine-response&quot;);</span>
<a href="#l54.44"></a><span id="l54.44">         }</span>
<a href="#l54.45"></a><span id="l54.45"> </span>
<a href="#l54.46"></a><span id="l54.46">         aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l54.47"></a><span id="l54.47">     },</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49"> </span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">-    setupOfflineObservers: function ccm_setupOfflineObservers() {</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineplus">+    setupOfflineObservers: function() {</span>
<a href="#l54.52"></a><span id="l54.52">         Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l54.53"></a><span id="l54.53">     },</span>
<a href="#l54.54"></a><span id="l54.54"> </span>
<a href="#l54.55"></a><span id="l54.55" class="difflineminus">-    cleanupOfflineObservers: function ccm_cleanupOfflineObservers() {</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineplus">+    cleanupOfflineObservers: function() {</span>
<a href="#l54.57"></a><span id="l54.57">         Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l54.58"></a><span id="l54.58">     },</span>
<a href="#l54.59"></a><span id="l54.59"> </span>
<a href="#l54.60"></a><span id="l54.60" class="difflineminus">-    observe: function ccm_observe(aSubject, aTopic, aData) {</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l54.62"></a><span id="l54.62">         switch (aTopic) {</span>
<a href="#l54.63"></a><span id="l54.63">             case &quot;timer-callback&quot;:</span>
<a href="#l54.64"></a><span id="l54.64">                 // Refresh all the calendars that can be refreshed.</span>
<a href="#l54.65"></a><span id="l54.65">                 for (let calendar of this.getCalendars({})) {</span>
<a href="#l54.66"></a><span id="l54.66">                     if (!calendar.getProperty(&quot;disabled&quot;) &amp;&amp; calendar.canRefresh) {</span>
<a href="#l54.67"></a><span id="l54.67">                         calendar.refresh();</span>
<a href="#l54.68"></a><span id="l54.68">                     }</span>
<a href="#l54.69"></a><span id="l54.69">                 }</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineat">@@ -247,17 +247,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.71"></a><span id="l54.71">                 // - Decouple schema version from storage calendar</span>
<a href="#l54.72"></a><span id="l54.72">                 // Create the new tables.</span>
<a href="#l54.73"></a><span id="l54.73">                 db.executeSimpleSQL(&quot;CREATE TABLE cal_calmgr_schema_version (version INTEGER);&quot;);</span>
<a href="#l54.74"></a><span id="l54.74">                 db.executeSimpleSQL(&quot;INSERT INTO cal_calmgr_schema_version VALUES(&quot; + DB_SCHEMA_VERSION + &quot;)&quot;);</span>
<a href="#l54.75"></a><span id="l54.75">             }</span>
<a href="#l54.76"></a><span id="l54.76">         }</span>
<a href="#l54.77"></a><span id="l54.77">     },</span>
<a href="#l54.78"></a><span id="l54.78"> </span>
<a href="#l54.79"></a><span id="l54.79" class="difflineminus">-    migrateDB: function calmgr_migrateDB(db) {</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+    migrateDB: function(db) {</span>
<a href="#l54.81"></a><span id="l54.81">         let selectCalendars = db.createStatement(&quot;SELECT * FROM cal_calendars&quot;);</span>
<a href="#l54.82"></a><span id="l54.82">         let selectPrefs = db.createStatement(&quot;SELECT name, value FROM cal_calendars_prefs WHERE calendar = :calendar&quot;);</span>
<a href="#l54.83"></a><span id="l54.83">         try {</span>
<a href="#l54.84"></a><span id="l54.84">             let sortOrder = {};</span>
<a href="#l54.85"></a><span id="l54.85"> </span>
<a href="#l54.86"></a><span id="l54.86">             while (selectCalendars.executeStep()) {</span>
<a href="#l54.87"></a><span id="l54.87">                 let id = cal.getUUID(); // use fresh uuids</span>
<a href="#l54.88"></a><span id="l54.88">                 Preferences.set(getPrefBranchFor(id) + &quot;type&quot;, selectCalendars.row.type);</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineat">@@ -310,17 +310,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.90"></a><span id="l54.90">             Preferences.set(&quot;calendar.list.sortOrder&quot;, sortOrderAr.join(&quot; &quot;));</span>
<a href="#l54.91"></a><span id="l54.91">             flushPrefs();</span>
<a href="#l54.92"></a><span id="l54.92">         } finally {</span>
<a href="#l54.93"></a><span id="l54.93">             selectPrefs.reset();</span>
<a href="#l54.94"></a><span id="l54.94">             selectCalendars.reset();</span>
<a href="#l54.95"></a><span id="l54.95">         }</span>
<a href="#l54.96"></a><span id="l54.96">     },</span>
<a href="#l54.97"></a><span id="l54.97"> </span>
<a href="#l54.98"></a><span id="l54.98" class="difflineminus">-    checkAndMigrateDB: function calmgr_checkAndMigrateDB() {</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+    checkAndMigrateDB: function() {</span>
<a href="#l54.100"></a><span id="l54.100">         let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l54.101"></a><span id="l54.101">         storageSdb.append(&quot;storage.sdb&quot;);</span>
<a href="#l54.102"></a><span id="l54.102">         let db = Services.storage.openDatabase(storageSdb);</span>
<a href="#l54.103"></a><span id="l54.103"> </span>
<a href="#l54.104"></a><span id="l54.104">         db.beginTransactionAs(Components.interfaces.mozIStorageConnection.TRANSACTION_EXCLUSIVE);</span>
<a href="#l54.105"></a><span id="l54.105">         try {</span>
<a href="#l54.106"></a><span id="l54.106">             if (db.tableExists(&quot;cal_calendars_prefs&quot;)) {</span>
<a href="#l54.107"></a><span id="l54.107">                 // Check if we need to upgrade:</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineat">@@ -353,17 +353,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.109"></a><span id="l54.109">             db.close();</span>
<a href="#l54.110"></a><span id="l54.110">         }</span>
<a href="#l54.111"></a><span id="l54.111">     },</span>
<a href="#l54.112"></a><span id="l54.112"> </span>
<a href="#l54.113"></a><span id="l54.113">     /**</span>
<a href="#l54.114"></a><span id="l54.114">      * @return      db schema version</span>
<a href="#l54.115"></a><span id="l54.115">      * @exception   various, depending on error</span>
<a href="#l54.116"></a><span id="l54.116">      */</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineminus">-    getSchemaVersion: function calMgrGetSchemaVersion(db) {</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineplus">+    getSchemaVersion: function(db) {</span>
<a href="#l54.119"></a><span id="l54.119">         let stmt;</span>
<a href="#l54.120"></a><span id="l54.120">         let version = null;</span>
<a href="#l54.121"></a><span id="l54.121"> </span>
<a href="#l54.122"></a><span id="l54.122">         let table;</span>
<a href="#l54.123"></a><span id="l54.123">         if (db.tableExists(&quot;cal_calmgr_schema_version&quot;)) {</span>
<a href="#l54.124"></a><span id="l54.124">             table = &quot;cal_calmgr_schema_version&quot;;</span>
<a href="#l54.125"></a><span id="l54.125">         } else {</span>
<a href="#l54.126"></a><span id="l54.126">             // Fall back to the old schema table</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineat">@@ -392,17 +392,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.128"></a><span id="l54.128"> </span>
<a href="#l54.129"></a><span id="l54.129">         throw table + &quot; SELECT returned no results&quot;;</span>
<a href="#l54.130"></a><span id="l54.130">     },</span>
<a href="#l54.131"></a><span id="l54.131"> </span>
<a href="#l54.132"></a><span id="l54.132">     //</span>
<a href="#l54.133"></a><span id="l54.133">     // / DB migration code ends here</span>
<a href="#l54.134"></a><span id="l54.134">     //</span>
<a href="#l54.135"></a><span id="l54.135"> </span>
<a href="#l54.136"></a><span id="l54.136" class="difflineminus">-    alertAndQuit: function cmgr_alertAndQuit() {</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineplus">+    alertAndQuit: function() {</span>
<a href="#l54.138"></a><span id="l54.138">         // We want to include the extension name in the error message rather</span>
<a href="#l54.139"></a><span id="l54.139">         // than blaming Thunderbird.</span>
<a href="#l54.140"></a><span id="l54.140">         let hostAppName = calGetString(&quot;brand&quot;, &quot;brandShortName&quot;, null, &quot;branding&quot;);</span>
<a href="#l54.141"></a><span id="l54.141">         let calAppName = calGetString(&quot;lightning&quot;, &quot;brandShortName&quot;, null, &quot;lightning&quot;);</span>
<a href="#l54.142"></a><span id="l54.142">         let errorBoxTitle = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l54.143"></a><span id="l54.143">         let errorBoxText = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTextLightning&quot;, [calAppName, hostAppName]);</span>
<a href="#l54.144"></a><span id="l54.144">         let errorBoxButtonLabel = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonRestart&quot;, [hostAppName]);</span>
<a href="#l54.145"></a><span id="l54.145"> </span>
<a href="#l54.146"></a><span id="l54.146" class="difflineat">@@ -418,27 +418,27 @@ calCalendarManager.prototype = {</span>
<a href="#l54.147"></a><span id="l54.147">                             errorBoxButtonFlags,</span>
<a href="#l54.148"></a><span id="l54.148">                             errorBoxButtonLabel,</span>
<a href="#l54.149"></a><span id="l54.149">                             null, // No second button text</span>
<a href="#l54.150"></a><span id="l54.150">                             null, // No third button text</span>
<a href="#l54.151"></a><span id="l54.151">                             null, // No checkbox</span>
<a href="#l54.152"></a><span id="l54.152">                             { value: false }); // Unnecessary checkbox state</span>
<a href="#l54.153"></a><span id="l54.153"> </span>
<a href="#l54.154"></a><span id="l54.154">         // Disable Lightning</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineminus">-        AddonManager.getAddonByID(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;, function getLightningExt(aAddon) {</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineplus">+        AddonManager.getAddonByID(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;, function(aAddon) {</span>
<a href="#l54.157"></a><span id="l54.157">             aAddon.userDisabled = true;</span>
<a href="#l54.158"></a><span id="l54.158">             Services.startup.quit(Components.interfaces.nsIAppStartup.eRestart |</span>
<a href="#l54.159"></a><span id="l54.159">                 Components.interfaces.nsIAppStartup.eForceQuit);</span>
<a href="#l54.160"></a><span id="l54.160">         });</span>
<a href="#l54.161"></a><span id="l54.161">     },</span>
<a href="#l54.162"></a><span id="l54.162"> </span>
<a href="#l54.163"></a><span id="l54.163">     /**</span>
<a href="#l54.164"></a><span id="l54.164">      * calICalendarManager interface</span>
<a href="#l54.165"></a><span id="l54.165">      */</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineminus">-    createCalendar: function cmgr_createCalendar(type, uri) {</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineplus">+    createCalendar: function(type, uri) {</span>
<a href="#l54.168"></a><span id="l54.168">         try {</span>
<a href="#l54.169"></a><span id="l54.169">             if (!Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]) {</span>
<a href="#l54.170"></a><span id="l54.170">                 // Don't notify the user with an extra dialog if the provider</span>
<a href="#l54.171"></a><span id="l54.171">                 // interface is missing.</span>
<a href="#l54.172"></a><span id="l54.172">                 return null;</span>
<a href="#l54.173"></a><span id="l54.173">             }</span>
<a href="#l54.174"></a><span id="l54.174">             let calendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]</span>
<a href="#l54.175"></a><span id="l54.175">                                      .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l54.176"></a><span id="l54.176" class="difflineat">@@ -508,17 +508,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.177"></a><span id="l54.177"> </span>
<a href="#l54.178"></a><span id="l54.178">         if (!calendar.getProperty(&quot;disabled&quot;) &amp;&amp; calendar.canRefresh) {</span>
<a href="#l54.179"></a><span id="l54.179">             calendar.refresh();</span>
<a href="#l54.180"></a><span id="l54.180">         }</span>
<a href="#l54.181"></a><span id="l54.181"> </span>
<a href="#l54.182"></a><span id="l54.182">         this.notifyObservers(&quot;onCalendarRegistered&quot;, [calendar]);</span>
<a href="#l54.183"></a><span id="l54.183">     },</span>
<a href="#l54.184"></a><span id="l54.184"> </span>
<a href="#l54.185"></a><span id="l54.185" class="difflineminus">-    setupCalendar: function cmgr_setupCalendar(calendar) {</span>
<a href="#l54.186"></a><span id="l54.186" class="difflineplus">+    setupCalendar: function(calendar) {</span>
<a href="#l54.187"></a><span id="l54.187">         this.mCache[calendar.id] = calendar;</span>
<a href="#l54.188"></a><span id="l54.188"> </span>
<a href="#l54.189"></a><span id="l54.189">         // Add an observer to track readonly-mode triggers</span>
<a href="#l54.190"></a><span id="l54.190">         let newObserver = new calMgrCalendarObserver(calendar, this);</span>
<a href="#l54.191"></a><span id="l54.191">         calendar.addObserver(newObserver);</span>
<a href="#l54.192"></a><span id="l54.192">         this.mCalObservers[calendar.id] = newObserver;</span>
<a href="#l54.193"></a><span id="l54.193"> </span>
<a href="#l54.194"></a><span id="l54.194">         // Set up statistics</span>
<a href="#l54.195"></a><span id="l54.195" class="difflineat">@@ -529,17 +529,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.196"></a><span id="l54.196">             this.mReadonlyCalendarCount++;</span>
<a href="#l54.197"></a><span id="l54.197">         }</span>
<a href="#l54.198"></a><span id="l54.198">         this.mCalendarCount++;</span>
<a href="#l54.199"></a><span id="l54.199"> </span>
<a href="#l54.200"></a><span id="l54.200">         // Set up the refresh timer</span>
<a href="#l54.201"></a><span id="l54.201">         this.setupRefreshTimer(calendar);</span>
<a href="#l54.202"></a><span id="l54.202">     },</span>
<a href="#l54.203"></a><span id="l54.203"> </span>
<a href="#l54.204"></a><span id="l54.204" class="difflineminus">-    setupRefreshTimer: function setupRefreshTimer(aCalendar) {</span>
<a href="#l54.205"></a><span id="l54.205" class="difflineplus">+    setupRefreshTimer: function(aCalendar) {</span>
<a href="#l54.206"></a><span id="l54.206">         // Add the refresh timer for this calendar</span>
<a href="#l54.207"></a><span id="l54.207">         let refreshInterval = aCalendar.getProperty(&quot;refreshInterval&quot;);</span>
<a href="#l54.208"></a><span id="l54.208">         if (refreshInterval === null) {</span>
<a href="#l54.209"></a><span id="l54.209">             // Default to 30 minutes, in case the value is missing</span>
<a href="#l54.210"></a><span id="l54.210">             refreshInterval = 30;</span>
<a href="#l54.211"></a><span id="l54.211">         }</span>
<a href="#l54.212"></a><span id="l54.212"> </span>
<a href="#l54.213"></a><span id="l54.213">         this.clearRefreshTimer(aCalendar);</span>
<a href="#l54.214"></a><span id="l54.214" class="difflineat">@@ -551,17 +551,17 @@ calCalendarManager.prototype = {</span>
<a href="#l54.215"></a><span id="l54.215"> </span>
<a href="#l54.216"></a><span id="l54.216">             this.mRefreshTimer[aCalendar.id]</span>
<a href="#l54.217"></a><span id="l54.217">                 .initWithCallback(new timerCallback(aCalendar),</span>
<a href="#l54.218"></a><span id="l54.218">                                   refreshInterval * 60000,</span>
<a href="#l54.219"></a><span id="l54.219">                                   Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l54.220"></a><span id="l54.220">         }</span>
<a href="#l54.221"></a><span id="l54.221">     },</span>
<a href="#l54.222"></a><span id="l54.222"> </span>
<a href="#l54.223"></a><span id="l54.223" class="difflineminus">-    clearRefreshTimer: function clearRefreshTimer(aCalendar) {</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineplus">+    clearRefreshTimer: function(aCalendar) {</span>
<a href="#l54.225"></a><span id="l54.225">         if (aCalendar.id in this.mRefreshTimer &amp;&amp;</span>
<a href="#l54.226"></a><span id="l54.226">             this.mRefreshTimer[aCalendar.id]) {</span>
<a href="#l54.227"></a><span id="l54.227">             this.mRefreshTimer[aCalendar.id].cancel();</span>
<a href="#l54.228"></a><span id="l54.228">             delete this.mRefreshTimer[aCalendar.id];</span>
<a href="#l54.229"></a><span id="l54.229">         }</span>
<a href="#l54.230"></a><span id="l54.230">     },</span>
<a href="#l54.231"></a><span id="l54.231"> </span>
<a href="#l54.232"></a><span id="l54.232">     unregisterCalendar: function(calendar) {</span>
<a href="#l54.233"></a><span id="l54.233" class="difflineat">@@ -631,36 +631,36 @@ calCalendarManager.prototype = {</span>
<a href="#l54.234"></a><span id="l54.234">             if (!wrappedCalendar) {</span>
<a href="#l54.235"></a><span id="l54.235">                 throw new Components.Exception(&quot;Calendar is missing a provider implementation for delete&quot;);</span>
<a href="#l54.236"></a><span id="l54.236">             }</span>
<a href="#l54.237"></a><span id="l54.237"> </span>
<a href="#l54.238"></a><span id="l54.238">             wrappedCalendar.deleteCalendar(calendar, null);</span>
<a href="#l54.239"></a><span id="l54.239">         }</span>
<a href="#l54.240"></a><span id="l54.240">     },</span>
<a href="#l54.241"></a><span id="l54.241"> </span>
<a href="#l54.242"></a><span id="l54.242" class="difflineminus">-    getCalendarById: function cmgr_getCalendarById(aId) {</span>
<a href="#l54.243"></a><span id="l54.243" class="difflineplus">+    getCalendarById: function(aId) {</span>
<a href="#l54.244"></a><span id="l54.244">         if (aId in this.mCache) {</span>
<a href="#l54.245"></a><span id="l54.245">             return this.mCache[aId];</span>
<a href="#l54.246"></a><span id="l54.246">         } else {</span>
<a href="#l54.247"></a><span id="l54.247">             return null;</span>
<a href="#l54.248"></a><span id="l54.248">         }</span>
<a href="#l54.249"></a><span id="l54.249">     },</span>
<a href="#l54.250"></a><span id="l54.250"> </span>
<a href="#l54.251"></a><span id="l54.251" class="difflineminus">-    getCalendars: function cmgr_getCalendars(count) {</span>
<a href="#l54.252"></a><span id="l54.252" class="difflineplus">+    getCalendars: function(count) {</span>
<a href="#l54.253"></a><span id="l54.253">         this.assureCache();</span>
<a href="#l54.254"></a><span id="l54.254">         let calendars = [];</span>
<a href="#l54.255"></a><span id="l54.255">         for (let id in this.mCache) {</span>
<a href="#l54.256"></a><span id="l54.256">             let calendar = this.mCache[id];</span>
<a href="#l54.257"></a><span id="l54.257">             calendars.push(calendar);</span>
<a href="#l54.258"></a><span id="l54.258">         }</span>
<a href="#l54.259"></a><span id="l54.259">         count.value = calendars.length;</span>
<a href="#l54.260"></a><span id="l54.260">         return calendars;</span>
<a href="#l54.261"></a><span id="l54.261">     },</span>
<a href="#l54.262"></a><span id="l54.262"> </span>
<a href="#l54.263"></a><span id="l54.263" class="difflineminus">-    assureCache: function cmgr_assureCache() {</span>
<a href="#l54.264"></a><span id="l54.264" class="difflineplus">+    assureCache: function() {</span>
<a href="#l54.265"></a><span id="l54.265">         if (!this.mCache) {</span>
<a href="#l54.266"></a><span id="l54.266">             this.mCache = {};</span>
<a href="#l54.267"></a><span id="l54.267">             this.mCalObservers = {};</span>
<a href="#l54.268"></a><span id="l54.268"> </span>
<a href="#l54.269"></a><span id="l54.269">             let allCals = {};</span>
<a href="#l54.270"></a><span id="l54.270">             for (let key of Services.prefs.getChildList(REGISTRY_BRANCH)) { // merge down all keys</span>
<a href="#l54.271"></a><span id="l54.271">                 allCals[key.substring(0, key.indexOf(&quot;.&quot;, REGISTRY_BRANCH.length))] = true;</span>
<a href="#l54.272"></a><span id="l54.272">             }</span>
<a href="#l54.273"></a><span id="l54.273" class="difflineat">@@ -1012,17 +1012,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l54.274"></a><span id="l54.274"> </span>
<a href="#l54.275"></a><span id="l54.275"> function calDummyCalendar(type) {</span>
<a href="#l54.276"></a><span id="l54.276">     this.initProviderBase();</span>
<a href="#l54.277"></a><span id="l54.277">     this.type = type;</span>
<a href="#l54.278"></a><span id="l54.278"> }</span>
<a href="#l54.279"></a><span id="l54.279"> calDummyCalendar.prototype = {</span>
<a href="#l54.280"></a><span id="l54.280">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l54.281"></a><span id="l54.281"> </span>
<a href="#l54.282"></a><span id="l54.282" class="difflineminus">-    getProperty: function calDummyCalendar_getProperty(aName) {</span>
<a href="#l54.283"></a><span id="l54.283" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l54.284"></a><span id="l54.284">         switch (aName) {</span>
<a href="#l54.285"></a><span id="l54.285">             case &quot;force-disabled&quot;:</span>
<a href="#l54.286"></a><span id="l54.286">                 return true;</span>
<a href="#l54.287"></a><span id="l54.287">             default:</span>
<a href="#l54.288"></a><span id="l54.288">                 return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l54.289"></a><span id="l54.289">         }</span>
<a href="#l54.290"></a><span id="l54.290">     }</span>
<a href="#l54.291"></a><span id="l54.291"> };</span>
<a href="#l54.292"></a><span id="l54.292" class="difflineat">@@ -1042,17 +1042,17 @@ function flushPrefs() {</span>
<a href="#l54.293"></a><span id="l54.293"> </span>
<a href="#l54.294"></a><span id="l54.294"> /**</span>
<a href="#l54.295"></a><span id="l54.295">  * Callback object for the refresh timer. Should be called as an object, i.e</span>
<a href="#l54.296"></a><span id="l54.296">  * let foo = new timerCallback(calendar);</span>
<a href="#l54.297"></a><span id="l54.297">  *</span>
<a href="#l54.298"></a><span id="l54.298">  * @param aCalendar     The calendar to refresh on notification</span>
<a href="#l54.299"></a><span id="l54.299">  */</span>
<a href="#l54.300"></a><span id="l54.300"> function timerCallback(aCalendar) {</span>
<a href="#l54.301"></a><span id="l54.301" class="difflineminus">-    this.notify = function refreshNotify(aTimer) {</span>
<a href="#l54.302"></a><span id="l54.302" class="difflineplus">+    this.notify = function(aTimer) {</span>
<a href="#l54.303"></a><span id="l54.303">         if (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l54.304"></a><span id="l54.304">             aCalendar.refresh();</span>
<a href="#l54.305"></a><span id="l54.305">         }</span>
<a href="#l54.306"></a><span id="l54.306">     };</span>
<a href="#l54.307"></a><span id="l54.307"> }</span>
<a href="#l54.308"></a><span id="l54.308"> </span>
<a href="#l54.309"></a><span id="l54.309"> var gCalendarManagerAddonListener = {</span>
<a href="#l54.310"></a><span id="l54.310">     onDisabling: function(aAddon, aNeedsRestart) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -11,28 +11,28 @@ function calCalendarSearchListener(numOp</span>
<a href="#l55.4"></a><span id="l55.4">         this.notifyResult(null);</span>
<a href="#l55.5"></a><span id="l55.5">     });</span>
<a href="#l55.6"></a><span id="l55.6"> }</span>
<a href="#l55.7"></a><span id="l55.7"> calCalendarSearchListener.prototype = {</span>
<a href="#l55.8"></a><span id="l55.8">     mFinalListener: null,</span>
<a href="#l55.9"></a><span id="l55.9">     mNumOperations: 0,</span>
<a href="#l55.10"></a><span id="l55.10">     opGroup: null,</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-    notifyResult: function calCalendarSearchListener_notifyResult(result) {</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+    notifyResult: function(result) {</span>
<a href="#l55.14"></a><span id="l55.14">         let listener = this.mFinalListener;</span>
<a href="#l55.15"></a><span id="l55.15">         if (listener) {</span>
<a href="#l55.16"></a><span id="l55.16">             if (!this.opGroup.isPending) {</span>
<a href="#l55.17"></a><span id="l55.17">                 this.mFinalListener = null;</span>
<a href="#l55.18"></a><span id="l55.18">             }</span>
<a href="#l55.19"></a><span id="l55.19">             listener.onResult(this.opGroup, result);</span>
<a href="#l55.20"></a><span id="l55.20">         }</span>
<a href="#l55.21"></a><span id="l55.21">     },</span>
<a href="#l55.22"></a><span id="l55.22"> </span>
<a href="#l55.23"></a><span id="l55.23">     // calIGenericOperationListener:</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-    onResult: function calCalendarSearchListener_onResult(aOperation, aResult) {</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+    onResult: function(aOperation, aResult) {</span>
<a href="#l55.26"></a><span id="l55.26">         if (this.mFinalListener) {</span>
<a href="#l55.27"></a><span id="l55.27">             if (!aOperation || !aOperation.isPending) {</span>
<a href="#l55.28"></a><span id="l55.28">                 --this.mNumOperations;</span>
<a href="#l55.29"></a><span id="l55.29">                 if (this.mNumOperations == 0) {</span>
<a href="#l55.30"></a><span id="l55.30">                     this.opGroup.notifyCompleted();</span>
<a href="#l55.31"></a><span id="l55.31">                 }</span>
<a href="#l55.32"></a><span id="l55.32">             }</span>
<a href="#l55.33"></a><span id="l55.33">             if (aResult) {</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineat">@@ -60,20 +60,17 @@ calCalendarSearchService.prototype = {</span>
<a href="#l55.35"></a><span id="l55.35">         classID: calCalendarSearchServiceClassID,</span>
<a href="#l55.36"></a><span id="l55.36">         contractID: &quot;@mozilla.org/calendar/calendarsearch-service;1&quot;,</span>
<a href="#l55.37"></a><span id="l55.37">         classDescription: &quot;Calendar Search Service&quot;,</span>
<a href="#l55.38"></a><span id="l55.38">         interfaces: calCalendarSearchServiceInterfaces,</span>
<a href="#l55.39"></a><span id="l55.39">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l55.40"></a><span id="l55.40">     }),</span>
<a href="#l55.41"></a><span id="l55.41"> </span>
<a href="#l55.42"></a><span id="l55.42">     // calICalendarSearchProvider:</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineminus">-    searchForCalendars: function calCalendarSearchService_searchForCalendars(aString,</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineminus">-                                                                             aHints,</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineminus">-                                                                             aMaxResults,</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineminus">-                                                                             aListener) {</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+    searchForCalendars: function(aString, aHints, aMaxResults, aListener) {</span>
<a href="#l55.48"></a><span id="l55.48">         let groupListener = new calCalendarSearchListener(this.mProviders.size, aListener);</span>
<a href="#l55.49"></a><span id="l55.49">         function searchForCalendars_(provider) {</span>
<a href="#l55.50"></a><span id="l55.50">             try {</span>
<a href="#l55.51"></a><span id="l55.51">                 groupListener.opGroup.add(provider.searchForCalendars(aString,</span>
<a href="#l55.52"></a><span id="l55.52">                                                                       aHints,</span>
<a href="#l55.53"></a><span id="l55.53">                                                                       aMaxResults,</span>
<a href="#l55.54"></a><span id="l55.54">                                                                       groupListener));</span>
<a href="#l55.55"></a><span id="l55.55">             } catch (exc) {</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineat">@@ -81,20 +78,20 @@ calCalendarSearchService.prototype = {</span>
<a href="#l55.57"></a><span id="l55.57">                 groupListener.onResult(null, []); // dummy to adopt mNumOperations</span>
<a href="#l55.58"></a><span id="l55.58">             }</span>
<a href="#l55.59"></a><span id="l55.59">         }</span>
<a href="#l55.60"></a><span id="l55.60">         this.mProviders.forEach(searchForCalendars_);</span>
<a href="#l55.61"></a><span id="l55.61">         return groupListener.opGroup;</span>
<a href="#l55.62"></a><span id="l55.62">     },</span>
<a href="#l55.63"></a><span id="l55.63"> </span>
<a href="#l55.64"></a><span id="l55.64">     // calICalendarSearchService:</span>
<a href="#l55.65"></a><span id="l55.65" class="difflineminus">-    getProviders: function calCalendarSearchService_getProviders(out_aCount) {</span>
<a href="#l55.66"></a><span id="l55.66" class="difflineplus">+    getProviders: function(out_aCount) {</span>
<a href="#l55.67"></a><span id="l55.67">         let ret = this.mProviders.interfaceArray;</span>
<a href="#l55.68"></a><span id="l55.68">         out_aCount.value = ret.length;</span>
<a href="#l55.69"></a><span id="l55.69">         return ret;</span>
<a href="#l55.70"></a><span id="l55.70">     },</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineminus">-    addProvider: function calCalendarSearchService_addProvider(aProvider) {</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+    addProvider: function(aProvider) {</span>
<a href="#l55.73"></a><span id="l55.73">         this.mProviders.add(aProvider);</span>
<a href="#l55.74"></a><span id="l55.74">     },</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineminus">-    removeProvider: function calCalendarSearchService_removeProvider(aProvider) {</span>
<a href="#l55.76"></a><span id="l55.76" class="difflineplus">+    removeProvider: function(aProvider) {</span>
<a href="#l55.77"></a><span id="l55.77">         this.mProviders.remove(aProvider);</span>
<a href="#l55.78"></a><span id="l55.78">     }</span>
<a href="#l55.79"></a><span id="l55.79"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -73,31 +73,31 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l56.4"></a><span id="l56.4">     QueryInterface: XPCOMUtils.generateQI(calDateTimeFormatterInterfaces),</span>
<a href="#l56.5"></a><span id="l56.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l56.6"></a><span id="l56.6">         classID: calDateTimeFormatterClassID,</span>
<a href="#l56.7"></a><span id="l56.7">         contractID: &quot;@mozilla.org/calendar/datetime-formatter;1&quot;,</span>
<a href="#l56.8"></a><span id="l56.8">         classDescription: &quot;Formats Dates and Times&quot;,</span>
<a href="#l56.9"></a><span id="l56.9">         interfaces: calDateTimeFormatterInterfaces,</span>
<a href="#l56.10"></a><span id="l56.10">     }),</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-    formatDate: function formatDate(aDate) {</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+    formatDate: function(aDate) {</span>
<a href="#l56.14"></a><span id="l56.14">         // Format the date using user's format preference (long or short)</span>
<a href="#l56.15"></a><span id="l56.15">         let format = Preferences.get(&quot;calendar.date.format&quot;, 0);</span>
<a href="#l56.16"></a><span id="l56.16">         return (format == 0 ? this.formatDateLong(aDate) : this.formatDateShort(aDate));</span>
<a href="#l56.17"></a><span id="l56.17">     },</span>
<a href="#l56.18"></a><span id="l56.18"> </span>
<a href="#l56.19"></a><span id="l56.19" class="difflineminus">-    formatDateShort: function formatDateShort(aDate) {</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineplus">+    formatDateShort: function(aDate) {</span>
<a href="#l56.21"></a><span id="l56.21">         return this.mDateService.FormatDate(&quot;&quot;,</span>
<a href="#l56.22"></a><span id="l56.22">                                             nsIScriptableDateFormat.dateFormatShort,</span>
<a href="#l56.23"></a><span id="l56.23">                                             aDate.year,</span>
<a href="#l56.24"></a><span id="l56.24">                                             aDate.month + 1,</span>
<a href="#l56.25"></a><span id="l56.25">                                             aDate.day);</span>
<a href="#l56.26"></a><span id="l56.26">     },</span>
<a href="#l56.27"></a><span id="l56.27"> </span>
<a href="#l56.28"></a><span id="l56.28" class="difflineminus">-    formatDateLong: function formatDateLong(aDate) {</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineplus">+    formatDateLong: function(aDate) {</span>
<a href="#l56.30"></a><span id="l56.30">         let longDate;</span>
<a href="#l56.31"></a><span id="l56.31">         if (this.mUseLongDateService) {</span>
<a href="#l56.32"></a><span id="l56.32">             longDate = this.mDateService.FormatDate(&quot;&quot;,</span>
<a href="#l56.33"></a><span id="l56.33">                                                     nsIScriptableDateFormat.dateFormatLong,</span>
<a href="#l56.34"></a><span id="l56.34">                                                     aDate.year,</span>
<a href="#l56.35"></a><span id="l56.35">                                                     aDate.month + 1,</span>
<a href="#l56.36"></a><span id="l56.36">                                                     aDate.day);</span>
<a href="#l56.37"></a><span id="l56.37">             // check whether weekday name appears as in Lightning localization. if not, this is</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineat">@@ -117,68 +117,68 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l56.39"></a><span id="l56.39">                                         [this.shortDayName(aDate.weekday),</span>
<a href="#l56.40"></a><span id="l56.40">                                          this.formatDayWithOrdinal(aDate.day),</span>
<a href="#l56.41"></a><span id="l56.41">                                          this.shortMonthName(aDate.month),</span>
<a href="#l56.42"></a><span id="l56.42">                                          aDate.year]);</span>
<a href="#l56.43"></a><span id="l56.43">         }</span>
<a href="#l56.44"></a><span id="l56.44">         return longDate;</span>
<a href="#l56.45"></a><span id="l56.45">     },</span>
<a href="#l56.46"></a><span id="l56.46"> </span>
<a href="#l56.47"></a><span id="l56.47" class="difflineminus">-    formatDateWithoutYear: function formatDateWithoutYear(aDate) {</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineplus">+    formatDateWithoutYear: function(aDate) {</span>
<a href="#l56.49"></a><span id="l56.49">         // Doing this the hard way, because nsIScriptableDateFormat doesn't</span>
<a href="#l56.50"></a><span id="l56.50">         // have a way to not include the year.</span>
<a href="#l56.51"></a><span id="l56.51">         if (this.mMonthFirst) {</span>
<a href="#l56.52"></a><span id="l56.52">             return this.shortMonthName(aDate.month) + &quot; &quot; + this.formatDayWithOrdinal(aDate.day);</span>
<a href="#l56.53"></a><span id="l56.53">         } else {</span>
<a href="#l56.54"></a><span id="l56.54">             return this.formatDayWithOrdinal(aDate.day) + &quot; &quot; + this.shortMonthName(aDate.month);</span>
<a href="#l56.55"></a><span id="l56.55">         }</span>
<a href="#l56.56"></a><span id="l56.56">     },</span>
<a href="#l56.57"></a><span id="l56.57"> </span>
<a href="#l56.58"></a><span id="l56.58" class="difflineminus">-    formatTime: function formatTime(aDate) {</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineplus">+    formatTime: function(aDate) {</span>
<a href="#l56.60"></a><span id="l56.60">         if (aDate.isDate) {</span>
<a href="#l56.61"></a><span id="l56.61">             return this.mDateStringBundle.GetStringFromName(&quot;AllDay&quot;);</span>
<a href="#l56.62"></a><span id="l56.62">         }</span>
<a href="#l56.63"></a><span id="l56.63"> </span>
<a href="#l56.64"></a><span id="l56.64">         return this.mDateService.FormatTime(&quot;&quot;,</span>
<a href="#l56.65"></a><span id="l56.65">                                             nsIScriptableDateFormat.timeFormatNoSeconds,</span>
<a href="#l56.66"></a><span id="l56.66">                                             aDate.hour,</span>
<a href="#l56.67"></a><span id="l56.67">                                             aDate.minute,</span>
<a href="#l56.68"></a><span id="l56.68">                                             0);</span>
<a href="#l56.69"></a><span id="l56.69">     },</span>
<a href="#l56.70"></a><span id="l56.70"> </span>
<a href="#l56.71"></a><span id="l56.71" class="difflineminus">-    formatDateTime: function formatDateTime(aDate) {</span>
<a href="#l56.72"></a><span id="l56.72" class="difflineplus">+    formatDateTime: function(aDate) {</span>
<a href="#l56.73"></a><span id="l56.73">         let formattedDate = this.formatDate(aDate);</span>
<a href="#l56.74"></a><span id="l56.74">         let formattedTime = this.formatTime(aDate);</span>
<a href="#l56.75"></a><span id="l56.75"> </span>
<a href="#l56.76"></a><span id="l56.76">         let timeBeforeDate = Preferences.get(&quot;calendar.date.formatTimeBeforeDate&quot;, false);</span>
<a href="#l56.77"></a><span id="l56.77">         if (timeBeforeDate) {</span>
<a href="#l56.78"></a><span id="l56.78">             return formattedTime + &quot; &quot; + formattedDate;</span>
<a href="#l56.79"></a><span id="l56.79">         } else {</span>
<a href="#l56.80"></a><span id="l56.80">             return formattedDate + &quot; &quot; + formattedTime;</span>
<a href="#l56.81"></a><span id="l56.81">         }</span>
<a href="#l56.82"></a><span id="l56.82">     },</span>
<a href="#l56.83"></a><span id="l56.83"> </span>
<a href="#l56.84"></a><span id="l56.84" class="difflineminus">-    formatTimeInterval: function formatTimeInterval(aStartDate, aEndDate) {</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineplus">+    formatTimeInterval: function(aStartDate, aEndDate) {</span>
<a href="#l56.86"></a><span id="l56.86">         if (!aStartDate &amp;&amp; aEndDate) {</span>
<a href="#l56.87"></a><span id="l56.87">             return this.formatTime(aEndDate);</span>
<a href="#l56.88"></a><span id="l56.88">         }</span>
<a href="#l56.89"></a><span id="l56.89">         if (!aEndDate &amp;&amp; aStartDate) {</span>
<a href="#l56.90"></a><span id="l56.90">             return this.formatTime(aStartDate);</span>
<a href="#l56.91"></a><span id="l56.91">         }</span>
<a href="#l56.92"></a><span id="l56.92">         if (!aStartDate &amp;&amp; !aEndDate) {</span>
<a href="#l56.93"></a><span id="l56.93">             return &quot;&quot;;</span>
<a href="#l56.94"></a><span id="l56.94">         }</span>
<a href="#l56.95"></a><span id="l56.95"> </span>
<a href="#l56.96"></a><span id="l56.96">         // TODO do we need l10n for this?</span>
<a href="#l56.97"></a><span id="l56.97">         // TODO should we check for the same day? The caller should know what</span>
<a href="#l56.98"></a><span id="l56.98">         // he is doing...</span>
<a href="#l56.99"></a><span id="l56.99">         return this.formatTime(aStartDate) + &quot;\u2013&quot; + this.formatTime(aEndDate);</span>
<a href="#l56.100"></a><span id="l56.100">     },</span>
<a href="#l56.101"></a><span id="l56.101"> </span>
<a href="#l56.102"></a><span id="l56.102" class="difflineminus">-    formatInterval: function formatInterval(aStartDate, aEndDate) {</span>
<a href="#l56.103"></a><span id="l56.103" class="difflineplus">+    formatInterval: function(aStartDate, aEndDate) {</span>
<a href="#l56.104"></a><span id="l56.104">         // Check for tasks without start and/or due date</span>
<a href="#l56.105"></a><span id="l56.105">         if (aEndDate == null &amp;&amp; aStartDate == null) {</span>
<a href="#l56.106"></a><span id="l56.106">             return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDate&quot;);</span>
<a href="#l56.107"></a><span id="l56.107">         } else if (aEndDate == null) {</span>
<a href="#l56.108"></a><span id="l56.108">             let startDateString = this.formatDate(aStartDate);</span>
<a href="#l56.109"></a><span id="l56.109">             let startTime = this.formatTime(aStartDate);</span>
<a href="#l56.110"></a><span id="l56.110">             return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDueDate&quot;, [startDateString, startTime]);</span>
<a href="#l56.111"></a><span id="l56.111">         } else if (aStartDate == null) {</span>
<a href="#l56.112"></a><span id="l56.112" class="difflineat">@@ -235,23 +235,23 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l56.113"></a><span id="l56.113">                 // Spanning multiple days, so need to include date and time</span>
<a href="#l56.114"></a><span id="l56.114">                 // for start and end</span>
<a href="#l56.115"></a><span id="l56.115">                 // &quot;5 Jan 2006 13:00 - 7 Jan 2006 9:00&quot;</span>
<a href="#l56.116"></a><span id="l56.116">                 return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSeveralDays&quot;, [startDateString, startTime, endDateString, endTime]);</span>
<a href="#l56.117"></a><span id="l56.117">             }</span>
<a href="#l56.118"></a><span id="l56.118">         }</span>
<a href="#l56.119"></a><span id="l56.119">     },</span>
<a href="#l56.120"></a><span id="l56.120"> </span>
<a href="#l56.121"></a><span id="l56.121" class="difflineminus">-    formatDayWithOrdinal: function formatDayWithOrdinal(aDay) {</span>
<a href="#l56.122"></a><span id="l56.122" class="difflineplus">+    formatDayWithOrdinal: function(aDay) {</span>
<a href="#l56.123"></a><span id="l56.123">         let ordinalSymbols = this.mDateStringBundle.GetStringFromName(&quot;dayOrdinalSymbol&quot;).split(&quot;,&quot;);</span>
<a href="#l56.124"></a><span id="l56.124">         let dayOrdinalSymbol = ordinalSymbols[aDay - 1] || ordinalSymbols[0];</span>
<a href="#l56.125"></a><span id="l56.125">         return aDay + dayOrdinalSymbol;</span>
<a href="#l56.126"></a><span id="l56.126">     },</span>
<a href="#l56.127"></a><span id="l56.127"> </span>
<a href="#l56.128"></a><span id="l56.128" class="difflineminus">-    _getItemDates: function _getItemDates(aItem) {</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineplus">+    _getItemDates: function(aItem) {</span>
<a href="#l56.130"></a><span id="l56.130">         let start = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l56.131"></a><span id="l56.131">         let end = aItem[calGetEndDateProp(aItem)];</span>
<a href="#l56.132"></a><span id="l56.132">         let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l56.133"></a><span id="l56.133">         // Check for tasks without start and/or due date</span>
<a href="#l56.134"></a><span id="l56.134">         if (start) {</span>
<a href="#l56.135"></a><span id="l56.135">             start = start.getInTimezone(kDefaultTimezone);</span>
<a href="#l56.136"></a><span id="l56.136">         }</span>
<a href="#l56.137"></a><span id="l56.137">         if (end) {</span>
<a href="#l56.138"></a><span id="l56.138" class="difflineat">@@ -261,36 +261,36 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l56.139"></a><span id="l56.139">         // to get into a format that's understandable.</span>
<a href="#l56.140"></a><span id="l56.140">         if (start &amp;&amp; start.isDate &amp;&amp; end) {</span>
<a href="#l56.141"></a><span id="l56.141">             end.day -= 1;</span>
<a href="#l56.142"></a><span id="l56.142">         }</span>
<a href="#l56.143"></a><span id="l56.143"> </span>
<a href="#l56.144"></a><span id="l56.144">         return [start, end];</span>
<a href="#l56.145"></a><span id="l56.145">     },</span>
<a href="#l56.146"></a><span id="l56.146"> </span>
<a href="#l56.147"></a><span id="l56.147" class="difflineminus">-    formatItemInterval: function formatItemInterval(aItem) {</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineplus">+    formatItemInterval: function(aItem) {</span>
<a href="#l56.149"></a><span id="l56.149">         return this.formatInterval.apply(this, this._getItemDates(aItem));</span>
<a href="#l56.150"></a><span id="l56.150">     },</span>
<a href="#l56.151"></a><span id="l56.151"> </span>
<a href="#l56.152"></a><span id="l56.152" class="difflineminus">-    formatItemTimeInterval: function formatItemTimeInterval(aItem) {</span>
<a href="#l56.153"></a><span id="l56.153" class="difflineplus">+    formatItemTimeInterval: function(aItem) {</span>
<a href="#l56.154"></a><span id="l56.154">         return this.formatTimeInterval.apply(this, this._getItemDates(aItem));</span>
<a href="#l56.155"></a><span id="l56.155">     },</span>
<a href="#l56.156"></a><span id="l56.156"> </span>
<a href="#l56.157"></a><span id="l56.157" class="difflineminus">-    monthName: function monthName(aMonthIndex) {</span>
<a href="#l56.158"></a><span id="l56.158" class="difflineplus">+    monthName: function(aMonthIndex) {</span>
<a href="#l56.159"></a><span id="l56.159">         let oneBasedMonthIndex = aMonthIndex + 1;</span>
<a href="#l56.160"></a><span id="l56.160">         return this.mDateStringBundle.GetStringFromName(&quot;month.&quot; + oneBasedMonthIndex + &quot;.name&quot;);</span>
<a href="#l56.161"></a><span id="l56.161">     },</span>
<a href="#l56.162"></a><span id="l56.162"> </span>
<a href="#l56.163"></a><span id="l56.163" class="difflineminus">-    shortMonthName: function shortMonthName(aMonthIndex) {</span>
<a href="#l56.164"></a><span id="l56.164" class="difflineplus">+    shortMonthName: function(aMonthIndex) {</span>
<a href="#l56.165"></a><span id="l56.165">         let oneBasedMonthIndex = aMonthIndex + 1;</span>
<a href="#l56.166"></a><span id="l56.166">         return this.mDateStringBundle.GetStringFromName(&quot;month.&quot; + oneBasedMonthIndex + &quot;.Mmm&quot;);</span>
<a href="#l56.167"></a><span id="l56.167">     },</span>
<a href="#l56.168"></a><span id="l56.168"> </span>
<a href="#l56.169"></a><span id="l56.169" class="difflineminus">-    dayName: function dayName(aDayIndex) {</span>
<a href="#l56.170"></a><span id="l56.170" class="difflineplus">+    dayName: function(aDayIndex) {</span>
<a href="#l56.171"></a><span id="l56.171">         let oneBasedDayIndex = aDayIndex + 1;</span>
<a href="#l56.172"></a><span id="l56.172">         return this.mDateStringBundle.GetStringFromName(&quot;day.&quot; + oneBasedDayIndex + &quot;.name&quot;);</span>
<a href="#l56.173"></a><span id="l56.173">     },</span>
<a href="#l56.174"></a><span id="l56.174"> </span>
<a href="#l56.175"></a><span id="l56.175" class="difflineminus">-    shortDayName: function shortDayName(aDayIndex) {</span>
<a href="#l56.176"></a><span id="l56.176" class="difflineplus">+    shortDayName: function(aDayIndex) {</span>
<a href="#l56.177"></a><span id="l56.177">         let oneBasedDayIndex = aDayIndex + 1;</span>
<a href="#l56.178"></a><span id="l56.178">         return this.mDateStringBundle.GetStringFromName(&quot;day.&quot; + oneBasedDayIndex + &quot;.Mmm&quot;);</span>
<a href="#l56.179"></a><span id="l56.179">     }</span>
<a href="#l56.180"></a><span id="l56.180"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -24,32 +24,32 @@ calDefaultACLManager.prototype = {</span>
<a href="#l57.4"></a><span id="l57.4">         classID: calDefaultACLManagerClassID,</span>
<a href="#l57.5"></a><span id="l57.5">         contractID: &quot;@mozilla.org/calendar/acl-manager;1?type=default&quot;,</span>
<a href="#l57.6"></a><span id="l57.6">         classDescription: &quot;Default Calendar ACL Provider&quot;,</span>
<a href="#l57.7"></a><span id="l57.7">         interfaces: calDefaultACLManagerInterfaces,</span>
<a href="#l57.8"></a><span id="l57.8">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l57.9"></a><span id="l57.9">     }),</span>
<a href="#l57.10"></a><span id="l57.10"> </span>
<a href="#l57.11"></a><span id="l57.11">     /* calICalendarACLManager */</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-    _getCalendarEntryCached: function cDACLM__getCalendarEntryCached(aCalendar) {</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+    _getCalendarEntryCached: function(aCalendar) {</span>
<a href="#l57.14"></a><span id="l57.14">         let calUri = aCalendar.uri.spec;</span>
<a href="#l57.15"></a><span id="l57.15">         if (!(calUri in this.mCalendarEntries)) {</span>
<a href="#l57.16"></a><span id="l57.16">             this.mCalendarEntries[calUri] = new calDefaultCalendarACLEntry(this, aCalendar);</span>
<a href="#l57.17"></a><span id="l57.17">         }</span>
<a href="#l57.18"></a><span id="l57.18"> </span>
<a href="#l57.19"></a><span id="l57.19">         return this.mCalendarEntries[calUri];</span>
<a href="#l57.20"></a><span id="l57.20">     },</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineminus">-    getCalendarEntry: function cDACLM_getCalendarEntry(aCalendar, aListener) {</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+    getCalendarEntry: function(aCalendar, aListener) {</span>
<a href="#l57.23"></a><span id="l57.23">         let entry = this._getCalendarEntryCached(aCalendar);</span>
<a href="#l57.24"></a><span id="l57.24">         aListener.onOperationComplete(aCalendar, Components.results.NS_OK,</span>
<a href="#l57.25"></a><span id="l57.25">                                       Components.interfaces.calIOperationListener.GET,</span>
<a href="#l57.26"></a><span id="l57.26">                                       null,</span>
<a href="#l57.27"></a><span id="l57.27">                                       entry);</span>
<a href="#l57.28"></a><span id="l57.28">     },</span>
<a href="#l57.29"></a><span id="l57.29" class="difflineminus">-    getItemEntry: function cDACLM_getItemEntry(aItem) {</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineplus">+    getItemEntry: function(aItem) {</span>
<a href="#l57.31"></a><span id="l57.31">         let calEntry = this._getCalendarEntryCached(aItem.calendar);</span>
<a href="#l57.32"></a><span id="l57.32">         return new calDefaultItemACLEntry(calEntry);</span>
<a href="#l57.33"></a><span id="l57.33">     },</span>
<a href="#l57.34"></a><span id="l57.34"> </span>
<a href="#l57.35"></a><span id="l57.35"> };</span>
<a href="#l57.36"></a><span id="l57.36"> </span>
<a href="#l57.37"></a><span id="l57.37"> function calDefaultCalendarACLEntry(aMgr, aCalendar) {</span>
<a href="#l57.38"></a><span id="l57.38">     this.mACLManager = aMgr;</span>
<a href="#l57.39"></a><span id="l57.39" class="difflineat">@@ -67,43 +67,43 @@ calDefaultCalendarACLEntry.prototype = {</span>
<a href="#l57.40"></a><span id="l57.40">         return this.mACLManager;</span>
<a href="#l57.41"></a><span id="l57.41">     },</span>
<a href="#l57.42"></a><span id="l57.42"> </span>
<a href="#l57.43"></a><span id="l57.43">     hasAccessControl: false,</span>
<a href="#l57.44"></a><span id="l57.44">     userIsOwner: true,</span>
<a href="#l57.45"></a><span id="l57.45">     userCanAddItems: true,</span>
<a href="#l57.46"></a><span id="l57.46">     userCanDeleteItems: true,</span>
<a href="#l57.47"></a><span id="l57.47"> </span>
<a href="#l57.48"></a><span id="l57.48" class="difflineminus">-    _getIdentities: function calDefaultCalendarACLEntry_getUserAddresses(aCount) {</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineplus">+    _getIdentities: function(aCount) {</span>
<a href="#l57.50"></a><span id="l57.50">         let identities = [];</span>
<a href="#l57.51"></a><span id="l57.51">         cal.calIterateEmailIdentities(function(id, ac) { identities.push(id); });</span>
<a href="#l57.52"></a><span id="l57.52">         aCount.value = identities.length;</span>
<a href="#l57.53"></a><span id="l57.53">         return identities;</span>
<a href="#l57.54"></a><span id="l57.54">     },</span>
<a href="#l57.55"></a><span id="l57.55"> </span>
<a href="#l57.56"></a><span id="l57.56" class="difflineminus">-    getUserAddresses: function calDefaultCalendarACLEntry_getUserAddresses(aCount) {</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+    getUserAddresses: function(aCount) {</span>
<a href="#l57.58"></a><span id="l57.58">         let identities = this.getUserIdentities(aCount);</span>
<a href="#l57.59"></a><span id="l57.59">         let addresses = identities.map(id =&gt; id.email);</span>
<a href="#l57.60"></a><span id="l57.60">         return addresses;</span>
<a href="#l57.61"></a><span id="l57.61">     },</span>
<a href="#l57.62"></a><span id="l57.62"> </span>
<a href="#l57.63"></a><span id="l57.63" class="difflineminus">-    getUserIdentities: function calDefaultCalendarACLEntry_getUserIdentities(aCount) {</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineplus">+    getUserIdentities: function(aCount) {</span>
<a href="#l57.65"></a><span id="l57.65">         let identity = cal.getEmailIdentityOfCalendar(this.mCalendar);</span>
<a href="#l57.66"></a><span id="l57.66">         if (identity) {</span>
<a href="#l57.67"></a><span id="l57.67">             aCount.value = 1;</span>
<a href="#l57.68"></a><span id="l57.68">             return [identity];</span>
<a href="#l57.69"></a><span id="l57.69">         } else {</span>
<a href="#l57.70"></a><span id="l57.70">             return this._getIdentities(aCount);</span>
<a href="#l57.71"></a><span id="l57.71">         }</span>
<a href="#l57.72"></a><span id="l57.72">     },</span>
<a href="#l57.73"></a><span id="l57.73" class="difflineminus">-    getOwnerIdentities: function calDefaultCalendarACLEntry_getOwnerIdentities(aCount) {</span>
<a href="#l57.74"></a><span id="l57.74" class="difflineplus">+    getOwnerIdentities: function(aCount) {</span>
<a href="#l57.75"></a><span id="l57.75">         return this._getIdentities(aCount);</span>
<a href="#l57.76"></a><span id="l57.76">     },</span>
<a href="#l57.77"></a><span id="l57.77"> </span>
<a href="#l57.78"></a><span id="l57.78" class="difflineminus">-    refresh: function calDefaultCalendarACLEntry_refresh() {</span>
<a href="#l57.79"></a><span id="l57.79" class="difflineplus">+    refresh: function() {</span>
<a href="#l57.80"></a><span id="l57.80">     }</span>
<a href="#l57.81"></a><span id="l57.81"> };</span>
<a href="#l57.82"></a><span id="l57.82"> </span>
<a href="#l57.83"></a><span id="l57.83"> function calDefaultItemACLEntry(aCalendarEntry) {</span>
<a href="#l57.84"></a><span id="l57.84">     this.calendarEntry = aCalendarEntry;</span>
<a href="#l57.85"></a><span id="l57.85"> }</span>
<a href="#l57.86"></a><span id="l57.86"> </span>
<a href="#l57.87"></a><span id="l57.87"> calDefaultItemACLEntry.prototype = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/base/src/calDeletedItems.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/base/src/calDeletedItems.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -44,23 +44,23 @@ calDeletedItems.prototype = {</span>
<a href="#l58.4"></a><span id="l58.4">     DB_SCHEMA_VERSION: 1,</span>
<a href="#l58.5"></a><span id="l58.5">     STALE_TIME: 30 * 24 * 60 * 60 / 1000, /* 30 days */</span>
<a href="#l58.6"></a><span id="l58.6"> </span>
<a href="#l58.7"></a><span id="l58.7">     // To make the tests more failsafe, we have an internal notifier function.</span>
<a href="#l58.8"></a><span id="l58.8">     // As the deleted items store is just meant to be a hint, this should not</span>
<a href="#l58.9"></a><span id="l58.9">     // be used in real code.</span>
<a href="#l58.10"></a><span id="l58.10">     completedNotifier: null,</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-    flush: function flush() {</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+    flush: function() {</span>
<a href="#l58.14"></a><span id="l58.14">         this.ensureStatements();</span>
<a href="#l58.15"></a><span id="l58.15">         this.stmtFlush.params.stale_time = cal.now().nativeTime - this.STALE_TIME;</span>
<a href="#l58.16"></a><span id="l58.16">         this.stmtFlush.executeAsync(this.completedNotifier);</span>
<a href="#l58.17"></a><span id="l58.17">     },</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-    getDeletedDate: function calDeletedItems_getDeleted(aId, aCalId) {</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineplus">+    getDeletedDate: function(aId, aCalId) {</span>
<a href="#l58.21"></a><span id="l58.21">         this.ensureStatements();</span>
<a href="#l58.22"></a><span id="l58.22">         let stmt;</span>
<a href="#l58.23"></a><span id="l58.23">         if (aCalId) {</span>
<a href="#l58.24"></a><span id="l58.24">             stmt = this.stmtGetWithCal;</span>
<a href="#l58.25"></a><span id="l58.25">             stmt.params.calId = aCalId;</span>
<a href="#l58.26"></a><span id="l58.26">         } else {</span>
<a href="#l58.27"></a><span id="l58.27">             stmt = this.stmtGet;</span>
<a href="#l58.28"></a><span id="l58.28">         }</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineat">@@ -75,32 +75,32 @@ calDeletedItems.prototype = {</span>
<a href="#l58.30"></a><span id="l58.30">         } catch (e) {</span>
<a href="#l58.31"></a><span id="l58.31">             cal.ERROR(e);</span>
<a href="#l58.32"></a><span id="l58.32">         } finally {</span>
<a href="#l58.33"></a><span id="l58.33">             stmt.reset();</span>
<a href="#l58.34"></a><span id="l58.34">         }</span>
<a href="#l58.35"></a><span id="l58.35">         return null;</span>
<a href="#l58.36"></a><span id="l58.36">     },</span>
<a href="#l58.37"></a><span id="l58.37"> </span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-    markDeleted: function calDeletedItems_markDeleted(aItem) {</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+    markDeleted: function(aItem) {</span>
<a href="#l58.40"></a><span id="l58.40">         this.ensureStatements();</span>
<a href="#l58.41"></a><span id="l58.41">         this.stmtMarkDelete.params.calId = aItem.calendar.id;</span>
<a href="#l58.42"></a><span id="l58.42">         this.stmtMarkDelete.params.id = aItem.id;</span>
<a href="#l58.43"></a><span id="l58.43">         this.stmtMarkDelete.params.time = cal.now().nativeTime;</span>
<a href="#l58.44"></a><span id="l58.44">         this.stmtMarkDelete.params.rid = (aItem.recurrenceId &amp;&amp; aItem.recurrenceId.nativeTime) || &quot;&quot;;</span>
<a href="#l58.45"></a><span id="l58.45">         this.stmtMarkDelete.executeAsync(this.completedNotifier);</span>
<a href="#l58.46"></a><span id="l58.46">     },</span>
<a href="#l58.47"></a><span id="l58.47"> </span>
<a href="#l58.48"></a><span id="l58.48" class="difflineminus">-    unmarkDeleted: function calDeletedItems_unmarkDeleted(aItem) {</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineplus">+    unmarkDeleted: function(aItem) {</span>
<a href="#l58.50"></a><span id="l58.50">         this.ensureStatements();</span>
<a href="#l58.51"></a><span id="l58.51">         this.stmtUnmarkDelete.params.id = aItem.id;</span>
<a href="#l58.52"></a><span id="l58.52">         this.stmtUnmarkDelete.executeAsync(this.completedNotifier);</span>
<a href="#l58.53"></a><span id="l58.53">     },</span>
<a href="#l58.54"></a><span id="l58.54"> </span>
<a href="#l58.55"></a><span id="l58.55" class="difflineminus">-    initDB: function initDB() {</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineplus">+    initDB: function() {</span>
<a href="#l58.57"></a><span id="l58.57">         if (this.mDB) {</span>
<a href="#l58.58"></a><span id="l58.58">             // Looks like we've already initialized, exit early</span>
<a href="#l58.59"></a><span id="l58.59">             return;</span>
<a href="#l58.60"></a><span id="l58.60">         }</span>
<a href="#l58.61"></a><span id="l58.61"> </span>
<a href="#l58.62"></a><span id="l58.62">         let file = FileUtils.getFile(&quot;ProfD&quot;, [&quot;calendar-data&quot;, &quot;deleted.sqlite&quot;]);</span>
<a href="#l58.63"></a><span id="l58.63">         this.mDB = Services.storage.openDatabase(file);</span>
<a href="#l58.64"></a><span id="l58.64"> </span>
<a href="#l58.65"></a><span id="l58.65" class="difflineat">@@ -116,25 +116,25 @@ calDeletedItems.prototype = {</span>
<a href="#l58.66"></a><span id="l58.66">         }</span>
<a href="#l58.67"></a><span id="l58.67"> </span>
<a href="#l58.68"></a><span id="l58.68">         // We will not init the statements now, we can still do that the</span>
<a href="#l58.69"></a><span id="l58.69">         // first time this interface is used. What we should do though is</span>
<a href="#l58.70"></a><span id="l58.70">         // to clean up at shutdown</span>
<a href="#l58.71"></a><span id="l58.71">         cal.addShutdownObserver(this.shutdown.bind(this));</span>
<a href="#l58.72"></a><span id="l58.72">     },</span>
<a href="#l58.73"></a><span id="l58.73"> </span>
<a href="#l58.74"></a><span id="l58.74" class="difflineminus">-    observe: function observe(aSubject, aTopic, aData) {</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l58.76"></a><span id="l58.76">         if (aTopic == &quot;profile-after-change&quot;) {</span>
<a href="#l58.77"></a><span id="l58.77">             // Make sure to observe calendar changes so we know when things are</span>
<a href="#l58.78"></a><span id="l58.78">             // deleted. We don't initialize the statements until first use.</span>
<a href="#l58.79"></a><span id="l58.79">             cal.getCalendarManager().addCalendarObserver(this);</span>
<a href="#l58.80"></a><span id="l58.80">         }</span>
<a href="#l58.81"></a><span id="l58.81">     },</span>
<a href="#l58.82"></a><span id="l58.82"> </span>
<a href="#l58.83"></a><span id="l58.83" class="difflineminus">-    ensureStatements: function ensureStatements() {</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineplus">+    ensureStatements: function() {</span>
<a href="#l58.85"></a><span id="l58.85">         if (!this.mDB) {</span>
<a href="#l58.86"></a><span id="l58.86">             this.initDB();</span>
<a href="#l58.87"></a><span id="l58.87">         }</span>
<a href="#l58.88"></a><span id="l58.88"> </span>
<a href="#l58.89"></a><span id="l58.89">         if (!this.stmtMarkDelete) {</span>
<a href="#l58.90"></a><span id="l58.90">             let stmt = &quot;INSERT OR REPLACE INTO cal_deleted_items (cal_id, id, time_deleted, recurrence_id) VALUES(:calId, :id, :time, :rid)&quot;;</span>
<a href="#l58.91"></a><span id="l58.91">             this.stmtMarkDelete = this.mDB.createStatement(stmt);</span>
<a href="#l58.92"></a><span id="l58.92">         }</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineat">@@ -151,17 +151,17 @@ calDeletedItems.prototype = {</span>
<a href="#l58.94"></a><span id="l58.94">             this.stmtGet = this.mDB.createStatement(stmt);</span>
<a href="#l58.95"></a><span id="l58.95">         }</span>
<a href="#l58.96"></a><span id="l58.96">         if (!this.stmtFlush) {</span>
<a href="#l58.97"></a><span id="l58.97">             let stmt = &quot;DELETE FROM cal_deleted_items WHERE time_deleted &lt; :stale_time&quot;;</span>
<a href="#l58.98"></a><span id="l58.98">             this.stmtFlush = this.mDB.createStatement(stmt);</span>
<a href="#l58.99"></a><span id="l58.99">         }</span>
<a href="#l58.100"></a><span id="l58.100">     },</span>
<a href="#l58.101"></a><span id="l58.101"> </span>
<a href="#l58.102"></a><span id="l58.102" class="difflineminus">-    shutdown: function shutdown() {</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+    shutdown: function() {</span>
<a href="#l58.104"></a><span id="l58.104">         try {</span>
<a href="#l58.105"></a><span id="l58.105">             let stmts = [</span>
<a href="#l58.106"></a><span id="l58.106">                 this.stmtMarkDelete, this.stmtUnmarkDelete, this.stmtGet,</span>
<a href="#l58.107"></a><span id="l58.107">                 this.stmtGetWithCal, this.stmtFlush</span>
<a href="#l58.108"></a><span id="l58.108">             ];</span>
<a href="#l58.109"></a><span id="l58.109">             for (let stmt of stmts) {</span>
<a href="#l58.110"></a><span id="l58.110">                 stmt.finalize();</span>
<a href="#l58.111"></a><span id="l58.111">             }</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineat">@@ -181,16 +181,16 @@ calDeletedItems.prototype = {</span>
<a href="#l58.113"></a><span id="l58.113">     onError: function() {},</span>
<a href="#l58.114"></a><span id="l58.114">     onPropertyChanged: function() {},</span>
<a href="#l58.115"></a><span id="l58.115">     onPropertyDeleting: function() {},</span>
<a href="#l58.116"></a><span id="l58.116"> </span>
<a href="#l58.117"></a><span id="l58.117">     onAddItem: function(aItem) {</span>
<a href="#l58.118"></a><span id="l58.118">         this.unmarkDeleted(aItem);</span>
<a href="#l58.119"></a><span id="l58.119">     },</span>
<a href="#l58.120"></a><span id="l58.120"> </span>
<a href="#l58.121"></a><span id="l58.121" class="difflineminus">-    onDeleteItem: function onDeleteItem(aItem) {</span>
<a href="#l58.122"></a><span id="l58.122" class="difflineplus">+    onDeleteItem: function(aItem) {</span>
<a href="#l58.123"></a><span id="l58.123">         this.markDeleted(aItem);</span>
<a href="#l58.124"></a><span id="l58.124">     },</span>
<a href="#l58.125"></a><span id="l58.125"> </span>
<a href="#l58.126"></a><span id="l58.126" class="difflineminus">-    onLoad: function onLoad() {</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineplus">+    onLoad: function() {</span>
<a href="#l58.128"></a><span id="l58.128">         this.flush();</span>
<a href="#l58.129"></a><span id="l58.129">     }</span>
<a href="#l58.130"></a><span id="l58.130"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -36,17 +36,17 @@ calEvent.prototype = {</span>
<a href="#l59.4"></a><span id="l59.4">     }),</span>
<a href="#l59.5"></a><span id="l59.5"> </span>
<a href="#l59.6"></a><span id="l59.6">     cloneShallow: function(aNewParent) {</span>
<a href="#l59.7"></a><span id="l59.7">         let m = new calEvent();</span>
<a href="#l59.8"></a><span id="l59.8">         this.cloneItemBaseInto(m, aNewParent);</span>
<a href="#l59.9"></a><span id="l59.9">         return m;</span>
<a href="#l59.10"></a><span id="l59.10">     },</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-    createProxy: function calEvent_createProxy(aRecurrenceId) {</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+    createProxy: function(aRecurrenceId) {</span>
<a href="#l59.14"></a><span id="l59.14">         cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l59.15"></a><span id="l59.15"> </span>
<a href="#l59.16"></a><span id="l59.16">         let m = new calEvent();</span>
<a href="#l59.17"></a><span id="l59.17"> </span>
<a href="#l59.18"></a><span id="l59.18">         // override proxy's DTSTART/DTEND/RECURRENCE-ID</span>
<a href="#l59.19"></a><span id="l59.19">         // before master is set (and item might get immutable):</span>
<a href="#l59.20"></a><span id="l59.20">         let endDate = aRecurrenceId.clone();</span>
<a href="#l59.21"></a><span id="l59.21">         endDate.addDuration(this.duration);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/base/src/calFilter.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/base/src/calFilter.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -118,37 +118,37 @@ calFilterProperties.prototype = {</span>
<a href="#l60.4"></a><span id="l60.4">     end: null,</span>
<a href="#l60.5"></a><span id="l60.5">     due: null,</span>
<a href="#l60.6"></a><span id="l60.6">     status: null,</span>
<a href="#l60.7"></a><span id="l60.7">     category: null,</span>
<a href="#l60.8"></a><span id="l60.8">     occurrences: null,</span>
<a href="#l60.9"></a><span id="l60.9"> </span>
<a href="#l60.10"></a><span id="l60.10">     onfilter: null,</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-    equals: function cFP_equals(aFilterProps) {</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+    equals: function(aFilterProps) {</span>
<a href="#l60.14"></a><span id="l60.14">         if (!(aFilterProps instanceof calFilterProperties)) {</span>
<a href="#l60.15"></a><span id="l60.15">             return false;</span>
<a href="#l60.16"></a><span id="l60.16">         }</span>
<a href="#l60.17"></a><span id="l60.17">         let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;occurrences&quot;, &quot;onfilter&quot;];</span>
<a href="#l60.18"></a><span id="l60.18">         return props.every(function(prop) {</span>
<a href="#l60.19"></a><span id="l60.19">             return (this[prop] == aFilterProps[prop]);</span>
<a href="#l60.20"></a><span id="l60.20">         }, this);</span>
<a href="#l60.21"></a><span id="l60.21">     },</span>
<a href="#l60.22"></a><span id="l60.22"> </span>
<a href="#l60.23"></a><span id="l60.23" class="difflineminus">-    clone: function cFP_clone() {</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+    clone: function() {</span>
<a href="#l60.25"></a><span id="l60.25">         let cl = new calFilterProperties();</span>
<a href="#l60.26"></a><span id="l60.26">         let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;occurrences&quot;, &quot;onfilter&quot;];</span>
<a href="#l60.27"></a><span id="l60.27">         props.forEach(function(prop) {</span>
<a href="#l60.28"></a><span id="l60.28">             cl[prop] = this[prop];</span>
<a href="#l60.29"></a><span id="l60.29">         }, this);</span>
<a href="#l60.30"></a><span id="l60.30"> </span>
<a href="#l60.31"></a><span id="l60.31">         return cl;</span>
<a href="#l60.32"></a><span id="l60.32">     },</span>
<a href="#l60.33"></a><span id="l60.33"> </span>
<a href="#l60.34"></a><span id="l60.34" class="difflineminus">-    LOG: function cFP_LOG(aString) {</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+    LOG: function(aString) {</span>
<a href="#l60.36"></a><span id="l60.36">         cal.LOG(&quot;[calFilterProperties] &quot; +</span>
<a href="#l60.37"></a><span id="l60.37">                 (aString || &quot;&quot;) +</span>
<a href="#l60.38"></a><span id="l60.38">                 &quot; start=&quot; + this.start +</span>
<a href="#l60.39"></a><span id="l60.39">                 &quot; end=&quot; + this.end +</span>
<a href="#l60.40"></a><span id="l60.40">                 &quot; status=&quot; + this.status +</span>
<a href="#l60.41"></a><span id="l60.41">                 &quot; due=&quot; + this.due +</span>
<a href="#l60.42"></a><span id="l60.42">                 &quot; category=&quot; + this.category);</span>
<a href="#l60.43"></a><span id="l60.43">     }</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineat">@@ -175,17 +175,17 @@ calFilter.prototype = {</span>
<a href="#l60.45"></a><span id="l60.45">     mFilterProperties: null,</span>
<a href="#l60.46"></a><span id="l60.46">     mToday: null,</span>
<a href="#l60.47"></a><span id="l60.47">     mTomorrow: null,</span>
<a href="#l60.48"></a><span id="l60.48">     mMaxIterations: 50,</span>
<a href="#l60.49"></a><span id="l60.49"> </span>
<a href="#l60.50"></a><span id="l60.50">     /**</span>
<a href="#l60.51"></a><span id="l60.51">      * Initializes the predefined filters.</span>
<a href="#l60.52"></a><span id="l60.52">      */</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineminus">-    initDefinedFilters: function cF_initDefinedFilters() {</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineplus">+    initDefinedFilters: function() {</span>
<a href="#l60.55"></a><span id="l60.55">         let filters = [&quot;all&quot;, &quot;notstarted&quot;, &quot;overdue&quot;, &quot;open&quot;, &quot;completed&quot;, &quot;throughcurrent&quot;,</span>
<a href="#l60.56"></a><span id="l60.56">                        &quot;throughtoday&quot;, &quot;throughsevendays&quot;, &quot;today&quot;, &quot;thisCalendarMonth&quot;,</span>
<a href="#l60.57"></a><span id="l60.57">                        &quot;future&quot;, &quot;current&quot;, &quot;currentview&quot;];</span>
<a href="#l60.58"></a><span id="l60.58">         filters.forEach(function(filter) {</span>
<a href="#l60.59"></a><span id="l60.59">             if (!(filter in this.mDefinedFilters)) {</span>
<a href="#l60.60"></a><span id="l60.60">                 this.defineFilter(filter, this.getPreDefinedFilterProperties(filter));</span>
<a href="#l60.61"></a><span id="l60.61">             }</span>
<a href="#l60.62"></a><span id="l60.62">         }, this);</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineat">@@ -193,17 +193,17 @@ calFilter.prototype = {</span>
<a href="#l60.64"></a><span id="l60.64"> </span>
<a href="#l60.65"></a><span id="l60.65">     /**</span>
<a href="#l60.66"></a><span id="l60.66">      * Gets the filter properties for a predefined filter.</span>
<a href="#l60.67"></a><span id="l60.67">      *</span>
<a href="#l60.68"></a><span id="l60.68">      * @param aFilter   The name of the filter to retrieve the filter properties for.</span>
<a href="#l60.69"></a><span id="l60.69">      * @result          The filter properties for the specified filter, or null if the filter</span>
<a href="#l60.70"></a><span id="l60.70">      *                  not predefined.</span>
<a href="#l60.71"></a><span id="l60.71">      */</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineminus">-    getPreDefinedFilterProperties: function cF_getPreDefinedFilterProperties(aFilter) {</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+    getPreDefinedFilterProperties: function(aFilter) {</span>
<a href="#l60.74"></a><span id="l60.74">         let props = new calFilterProperties();</span>
<a href="#l60.75"></a><span id="l60.75"> </span>
<a href="#l60.76"></a><span id="l60.76">         if (!aFilter) {</span>
<a href="#l60.77"></a><span id="l60.77">             return props;</span>
<a href="#l60.78"></a><span id="l60.78">         }</span>
<a href="#l60.79"></a><span id="l60.79"> </span>
<a href="#l60.80"></a><span id="l60.80">         switch (aFilter) {</span>
<a href="#l60.81"></a><span id="l60.81"> </span>
<a href="#l60.82"></a><span id="l60.82" class="difflineat">@@ -291,64 +291,64 @@ calFilter.prototype = {</span>
<a href="#l60.83"></a><span id="l60.83">     /**</span>
<a href="#l60.84"></a><span id="l60.84">      * Defines a set of filter properties so that they may be applied by the filter name. If</span>
<a href="#l60.85"></a><span id="l60.85">      * the specified filter name is already defined, it's associated filter properties will be</span>
<a href="#l60.86"></a><span id="l60.86">      * replaced.</span>
<a href="#l60.87"></a><span id="l60.87">      *</span>
<a href="#l60.88"></a><span id="l60.88">      * @param aFilterName         The name to define the filter properties as.</span>
<a href="#l60.89"></a><span id="l60.89">      * @param aFilterProperties   The filter properties to define.</span>
<a href="#l60.90"></a><span id="l60.90">      */</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineminus">-    defineFilter: function cF_defineFilter(aFilterName, aFilterProperties) {</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineplus">+    defineFilter: function(aFilterName, aFilterProperties) {</span>
<a href="#l60.93"></a><span id="l60.93">         if (!(aFilterProperties instanceof calFilterProperties)) {</span>
<a href="#l60.94"></a><span id="l60.94">             return;</span>
<a href="#l60.95"></a><span id="l60.95">         }</span>
<a href="#l60.96"></a><span id="l60.96"> </span>
<a href="#l60.97"></a><span id="l60.97">         this.mDefinedFilters[aFilterName] = aFilterProperties;</span>
<a href="#l60.98"></a><span id="l60.98">     },</span>
<a href="#l60.99"></a><span id="l60.99"> </span>
<a href="#l60.100"></a><span id="l60.100">     /**</span>
<a href="#l60.101"></a><span id="l60.101">      * Returns the set of filter properties that were previously defined by a filter name.</span>
<a href="#l60.102"></a><span id="l60.102">      *</span>
<a href="#l60.103"></a><span id="l60.103">      * @param aFilter             The filter name of the defined filter properties.</span>
<a href="#l60.104"></a><span id="l60.104">      * @return                    The properties defined by the filter name, or null if</span>
<a href="#l60.105"></a><span id="l60.105">      *                            the filter name was not previously defined.</span>
<a href="#l60.106"></a><span id="l60.106">      */</span>
<a href="#l60.107"></a><span id="l60.107" class="difflineminus">-    getDefinedFilterProperties: function cF_getDefinedFilterProperties(aFilter) {</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineplus">+    getDefinedFilterProperties: function(aFilter) {</span>
<a href="#l60.109"></a><span id="l60.109">         if (aFilter in this.mDefinedFilters) {</span>
<a href="#l60.110"></a><span id="l60.110">             return this.mDefinedFilters[aFilter].clone();</span>
<a href="#l60.111"></a><span id="l60.111">         } else {</span>
<a href="#l60.112"></a><span id="l60.112">             return null;</span>
<a href="#l60.113"></a><span id="l60.113">         }</span>
<a href="#l60.114"></a><span id="l60.114">     },</span>
<a href="#l60.115"></a><span id="l60.115"> </span>
<a href="#l60.116"></a><span id="l60.116">     /**</span>
<a href="#l60.117"></a><span id="l60.117">      * Returns the filter name that a set of filter properties were previously defined as.</span>
<a href="#l60.118"></a><span id="l60.118">      *</span>
<a href="#l60.119"></a><span id="l60.119">      * @param aFilterProperties   The filter properties previously defined.</span>
<a href="#l60.120"></a><span id="l60.120">      * @return                    The name of the first filter name that the properties</span>
<a href="#l60.121"></a><span id="l60.121">      *                            were defined as, or null if the filter properties were</span>
<a href="#l60.122"></a><span id="l60.122">      *                            not previously defined.</span>
<a href="#l60.123"></a><span id="l60.123">      */</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineminus">-    getDefinedFilterName: function cF_getDefinedFilterName(aFilterProperties) {</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineplus">+    getDefinedFilterName: function(aFilterProperties) {</span>
<a href="#l60.126"></a><span id="l60.126">         for (filter in this.mDefinedFilters) {</span>
<a href="#l60.127"></a><span id="l60.127">             if (this.mDefinedFilters[filter].equals(aFilterProperties)) {</span>
<a href="#l60.128"></a><span id="l60.128">                 return filter;</span>
<a href="#l60.129"></a><span id="l60.129">             }</span>
<a href="#l60.130"></a><span id="l60.130">         }</span>
<a href="#l60.131"></a><span id="l60.131">         return null;</span>
<a href="#l60.132"></a><span id="l60.132">     },</span>
<a href="#l60.133"></a><span id="l60.133"> </span>
<a href="#l60.134"></a><span id="l60.134">     /**</span>
<a href="#l60.135"></a><span id="l60.135">      * Checks if the item matches the current filter text</span>
<a href="#l60.136"></a><span id="l60.136">      *</span>
<a href="#l60.137"></a><span id="l60.137">      * @param aItem               The item to check.</span>
<a href="#l60.138"></a><span id="l60.138">      * @return                    Returns true if the item matches the filter text or no</span>
<a href="#l60.139"></a><span id="l60.139">      *                            filter text has been set, false otherwise.</span>
<a href="#l60.140"></a><span id="l60.140">      */</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineminus">-    textFilter: function cF_filterByText(aItem) {</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineplus">+    textFilter: function(aItem) {</span>
<a href="#l60.143"></a><span id="l60.143">         if (!this.mFilterText) {</span>
<a href="#l60.144"></a><span id="l60.144">             return true;</span>
<a href="#l60.145"></a><span id="l60.145">         }</span>
<a href="#l60.146"></a><span id="l60.146"> </span>
<a href="#l60.147"></a><span id="l60.147">         let searchText = this.mFilterText.toLowerCase();</span>
<a href="#l60.148"></a><span id="l60.148"> </span>
<a href="#l60.149"></a><span id="l60.149">         if (!searchText.length || searchText.match(/^\s*$/)) {</span>
<a href="#l60.150"></a><span id="l60.150">             return true;</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineat">@@ -369,29 +369,29 @@ calFilter.prototype = {</span>
<a href="#l60.152"></a><span id="l60.152"> </span>
<a href="#l60.153"></a><span id="l60.153">     /**</span>
<a href="#l60.154"></a><span id="l60.154">      * Checks if the item matches the current filter date range.</span>
<a href="#l60.155"></a><span id="l60.155">      *</span>
<a href="#l60.156"></a><span id="l60.156">      * @param aItem               The item to check.</span>
<a href="#l60.157"></a><span id="l60.157">      * @return                    Returns true if the item falls within the date range</span>
<a href="#l60.158"></a><span id="l60.158">      *                            specified by mStartDate and mEndDate, false otherwise.</span>
<a href="#l60.159"></a><span id="l60.159">      */</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineminus">-    dateRangeFilter: function cF_dateRangeFilter(aItem) {</span>
<a href="#l60.161"></a><span id="l60.161" class="difflineplus">+    dateRangeFilter: function(aItem) {</span>
<a href="#l60.162"></a><span id="l60.162">         return checkIfInRange(aItem, this.mStartDate, this.mEndDate);</span>
<a href="#l60.163"></a><span id="l60.163">     },</span>
<a href="#l60.164"></a><span id="l60.164"> </span>
<a href="#l60.165"></a><span id="l60.165">     /**</span>
<a href="#l60.166"></a><span id="l60.166">      * Checks if the item matches the currently applied filter properties. Filter properties</span>
<a href="#l60.167"></a><span id="l60.167">      * with a value of null or that are not applicable to the item's type are not tested.</span>
<a href="#l60.168"></a><span id="l60.168">      *</span>
<a href="#l60.169"></a><span id="l60.169">      * @param aItem               The item to check.</span>
<a href="#l60.170"></a><span id="l60.170">      * @return                    Returns true if the item matches the filter properties</span>
<a href="#l60.171"></a><span id="l60.171">      *                            currently applied, false otherwise.</span>
<a href="#l60.172"></a><span id="l60.172">      */</span>
<a href="#l60.173"></a><span id="l60.173" class="difflineminus">-    propertyFilter: function cF_propertyFilter(aItem) {</span>
<a href="#l60.174"></a><span id="l60.174" class="difflineplus">+    propertyFilter: function(aItem) {</span>
<a href="#l60.175"></a><span id="l60.175">         let result;</span>
<a href="#l60.176"></a><span id="l60.176">         let props = this.mFilterProperties;</span>
<a href="#l60.177"></a><span id="l60.177">         if (!props) {</span>
<a href="#l60.178"></a><span id="l60.178">             return false;</span>
<a href="#l60.179"></a><span id="l60.179">         }</span>
<a href="#l60.180"></a><span id="l60.180"> </span>
<a href="#l60.181"></a><span id="l60.181">         // the today and tomorrow properties are precalculated in the updateFilterDates function</span>
<a href="#l60.182"></a><span id="l60.182">         // for better performance when filtering batches of items.</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineat">@@ -471,17 +471,17 @@ calFilter.prototype = {</span>
<a href="#l60.184"></a><span id="l60.184">      * @param prop                The value of the date filter property to calculate for. May</span>
<a href="#l60.185"></a><span id="l60.185">      *                            be a constant specifying a relative date range, or a string</span>
<a href="#l60.186"></a><span id="l60.186">      *                            representing a duration offset from the current date time.</span>
<a href="#l60.187"></a><span id="l60.187">      * @param start               If true, the function will return the date value for the</span>
<a href="#l60.188"></a><span id="l60.188">      *                            start of the relative date range, otherwise it will return the</span>
<a href="#l60.189"></a><span id="l60.189">      *                            date value for the end of the date range.</span>
<a href="#l60.190"></a><span id="l60.190">      * @return                    The calculated date for the property.</span>
<a href="#l60.191"></a><span id="l60.191">      */</span>
<a href="#l60.192"></a><span id="l60.192" class="difflineminus">-    getDateForProperty: function cF_getDateForProperty(prop, start) {</span>
<a href="#l60.193"></a><span id="l60.193" class="difflineplus">+    getDateForProperty: function(prop, start) {</span>
<a href="#l60.194"></a><span id="l60.194">         let props = this.mFilterProperties || new calFilterProperties();</span>
<a href="#l60.195"></a><span id="l60.195">         let result = null;</span>
<a href="#l60.196"></a><span id="l60.196">         let selectedDate = this.mSelectedDate || currentView().selectedDay || cal.now();</span>
<a href="#l60.197"></a><span id="l60.197">         let nowDate = cal.now();</span>
<a href="#l60.198"></a><span id="l60.198"> </span>
<a href="#l60.199"></a><span id="l60.199">         if (typeof prop == &quot;string&quot;) {</span>
<a href="#l60.200"></a><span id="l60.200">             let duration = cal.createDuration(prop);</span>
<a href="#l60.201"></a><span id="l60.201">             if (duration) {</span>
<a href="#l60.202"></a><span id="l60.202" class="difflineat">@@ -539,17 +539,17 @@ calFilter.prototype = {</span>
<a href="#l60.203"></a><span id="l60.203">         return result;</span>
<a href="#l60.204"></a><span id="l60.204">     },</span>
<a href="#l60.205"></a><span id="l60.205"> </span>
<a href="#l60.206"></a><span id="l60.206">     /**</span>
<a href="#l60.207"></a><span id="l60.207">      * Calculates the current start and end dates for the currently applied filter.</span>
<a href="#l60.208"></a><span id="l60.208">      *</span>
<a href="#l60.209"></a><span id="l60.209">      * @return                    The current [startDate, endDate] for the applied filter.</span>
<a href="#l60.210"></a><span id="l60.210">      */</span>
<a href="#l60.211"></a><span id="l60.211" class="difflineminus">-    getDatesForFilter: function cfp_getDatesForFilter() {</span>
<a href="#l60.212"></a><span id="l60.212" class="difflineplus">+    getDatesForFilter: function() {</span>
<a href="#l60.213"></a><span id="l60.213">         let startDate = null;</span>
<a href="#l60.214"></a><span id="l60.214">         let endDate = null;</span>
<a href="#l60.215"></a><span id="l60.215"> </span>
<a href="#l60.216"></a><span id="l60.216">         if (this.mFilterProperties) {</span>
<a href="#l60.217"></a><span id="l60.217">             startDate = this.getDateForProperty(this.mFilterProperties.start, true);</span>
<a href="#l60.218"></a><span id="l60.218">             endDate = this.getDateForProperty(this.mFilterProperties.end, false);</span>
<a href="#l60.219"></a><span id="l60.219"> </span>
<a href="#l60.220"></a><span id="l60.220">             // swap the start and end dates if necessary</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineat">@@ -659,17 +659,17 @@ calFilter.prototype = {</span>
<a href="#l60.222"></a><span id="l60.222">      * Applies the specified filter.</span>
<a href="#l60.223"></a><span id="l60.223">      *</span>
<a href="#l60.224"></a><span id="l60.224">      * @param aFilter           The filter to apply. May be one of the following types:</span>
<a href="#l60.225"></a><span id="l60.225">      *                          - a calFilterProperties object specifying the filter properties</span>
<a href="#l60.226"></a><span id="l60.226">      *                          - a String representing a previously defined filter name</span>
<a href="#l60.227"></a><span id="l60.227">      *                          - a String representing a duration offset from now</span>
<a href="#l60.228"></a><span id="l60.228">      *                          - a Function to use for the onfilter callback for a custom filter</span>
<a href="#l60.229"></a><span id="l60.229">      */</span>
<a href="#l60.230"></a><span id="l60.230" class="difflineminus">-    applyFilter: function cF_applyFilter(aFilter) {</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+    applyFilter: function(aFilter) {</span>
<a href="#l60.232"></a><span id="l60.232">         this.mFilterProperties = null;</span>
<a href="#l60.233"></a><span id="l60.233"> </span>
<a href="#l60.234"></a><span id="l60.234">         if (typeof aFilter == &quot;string&quot;) {</span>
<a href="#l60.235"></a><span id="l60.235">             if (aFilter in this.mDefinedFilters) {</span>
<a href="#l60.236"></a><span id="l60.236">                 this.mFilterProperties = this.getDefinedFilterProperties(aFilter);</span>
<a href="#l60.237"></a><span id="l60.237">             } else {</span>
<a href="#l60.238"></a><span id="l60.238">                 let dur = cal.createDuration(aFilter);</span>
<a href="#l60.239"></a><span id="l60.239">                 if (dur.inSeconds &gt; 0) {</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineat">@@ -697,17 +697,17 @@ calFilter.prototype = {</span>
<a href="#l60.241"></a><span id="l60.241"> </span>
<a href="#l60.242"></a><span id="l60.242">     /**</span>
<a href="#l60.243"></a><span id="l60.243">      * Calculates the current start and end dates for the currently applied filter, and updates</span>
<a href="#l60.244"></a><span id="l60.244">      * the current filter start and end dates. This function can be used to update the date range</span>
<a href="#l60.245"></a><span id="l60.245">      * for date range filters that are relative to the selected date or current date and time.</span>
<a href="#l60.246"></a><span id="l60.246">      *</span>
<a href="#l60.247"></a><span id="l60.247">      * @return                    The current [startDate, endDate] for the applied filter.</span>
<a href="#l60.248"></a><span id="l60.248">      */</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineminus">-    updateFilterDates: function cF_updateFilterDates() {</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+    updateFilterDates: function() {</span>
<a href="#l60.251"></a><span id="l60.251">         let [startDate, endDate] = this.getDatesForFilter();</span>
<a href="#l60.252"></a><span id="l60.252">         this.mStartDate = startDate;</span>
<a href="#l60.253"></a><span id="l60.253">         this.mEndDate = endDate;</span>
<a href="#l60.254"></a><span id="l60.254"> </span>
<a href="#l60.255"></a><span id="l60.255">         // the today and tomorrow properties are precalculated here</span>
<a href="#l60.256"></a><span id="l60.256">         // for better performance when filtering batches of items.</span>
<a href="#l60.257"></a><span id="l60.257">         this.mToday = cal.now();</span>
<a href="#l60.258"></a><span id="l60.258">         this.mToday.isDate = true;</span>
<a href="#l60.259"></a><span id="l60.259" class="difflineat">@@ -723,17 +723,17 @@ calFilter.prototype = {</span>
<a href="#l60.260"></a><span id="l60.260">      * the currently applied filter properties and text filter.</span>
<a href="#l60.261"></a><span id="l60.261">      *</span>
<a href="#l60.262"></a><span id="l60.262">      * @param aItems              The array of items to check.</span>
<a href="#l60.263"></a><span id="l60.263">      * @param aCallback           An optional callback function to be called with each item and</span>
<a href="#l60.264"></a><span id="l60.264">      *                            the result of it's filter test.</span>
<a href="#l60.265"></a><span id="l60.265">      * @return                    A new array containing the items that match the filters, or</span>
<a href="#l60.266"></a><span id="l60.266">      *                            null if no filter has been applied.</span>
<a href="#l60.267"></a><span id="l60.267">      */</span>
<a href="#l60.268"></a><span id="l60.268" class="difflineminus">-    filterItems: function cF_filterItems(aItems, aCallback) {</span>
<a href="#l60.269"></a><span id="l60.269" class="difflineplus">+    filterItems: function(aItems, aCallback) {</span>
<a href="#l60.270"></a><span id="l60.270">         if (!this.mFilterProperties) {</span>
<a href="#l60.271"></a><span id="l60.271">             return null;</span>
<a href="#l60.272"></a><span id="l60.272">         }</span>
<a href="#l60.273"></a><span id="l60.273"> </span>
<a href="#l60.274"></a><span id="l60.274">         return aItems.filter(function(aItem) {</span>
<a href="#l60.275"></a><span id="l60.275">             let result = this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem);</span>
<a href="#l60.276"></a><span id="l60.276"> </span>
<a href="#l60.277"></a><span id="l60.277">             if (aCallback &amp;&amp; typeof aCallback == &quot;function&quot;) {</span>
<a href="#l60.278"></a><span id="l60.278" class="difflineat">@@ -746,29 +746,29 @@ calFilter.prototype = {</span>
<a href="#l60.279"></a><span id="l60.279"> </span>
<a href="#l60.280"></a><span id="l60.280">     /**</span>
<a href="#l60.281"></a><span id="l60.281">      * Checks if the item matches the currently applied filter properties and text filter.</span>
<a href="#l60.282"></a><span id="l60.282">      *</span>
<a href="#l60.283"></a><span id="l60.283">      * @param aItem               The item to check.</span>
<a href="#l60.284"></a><span id="l60.284">      * @return                    Returns true if the item matches the filters,</span>
<a href="#l60.285"></a><span id="l60.285">      *                            false otherwise.</span>
<a href="#l60.286"></a><span id="l60.286">      */</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineminus">-    isItemInFilters: function cF_isItemInFilters(aItem) {</span>
<a href="#l60.288"></a><span id="l60.288" class="difflineplus">+    isItemInFilters: function(aItem) {</span>
<a href="#l60.289"></a><span id="l60.289">         return this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem);</span>
<a href="#l60.290"></a><span id="l60.290">     },</span>
<a href="#l60.291"></a><span id="l60.291"> </span>
<a href="#l60.292"></a><span id="l60.292">     /**</span>
<a href="#l60.293"></a><span id="l60.293">      * Finds the next occurrence of a repeating item that matches the currently applied</span>
<a href="#l60.294"></a><span id="l60.294">      * filter properties.</span>
<a href="#l60.295"></a><span id="l60.295">      *</span>
<a href="#l60.296"></a><span id="l60.296">      * @param aItem               The parent item to find the next occurrence of.</span>
<a href="#l60.297"></a><span id="l60.297">      * @return                    Returns the next occurrence that matches the filters,</span>
<a href="#l60.298"></a><span id="l60.298">      *                            or null if no match is found.</span>
<a href="#l60.299"></a><span id="l60.299">      */</span>
<a href="#l60.300"></a><span id="l60.300" class="difflineminus">-    getNextOccurrence: function cF_getNextOccurrence(aItem) {</span>
<a href="#l60.301"></a><span id="l60.301" class="difflineplus">+    getNextOccurrence: function(aItem) {</span>
<a href="#l60.302"></a><span id="l60.302">         if (!aItem.recurrenceInfo) {</span>
<a href="#l60.303"></a><span id="l60.303">             return this.isItemInFilters(aItem) ? aItem : null;</span>
<a href="#l60.304"></a><span id="l60.304">         }</span>
<a href="#l60.305"></a><span id="l60.305"> </span>
<a href="#l60.306"></a><span id="l60.306">         let count = 0;</span>
<a href="#l60.307"></a><span id="l60.307">         let start = cal.now();</span>
<a href="#l60.308"></a><span id="l60.308"> </span>
<a href="#l60.309"></a><span id="l60.309">         // If the base item matches the filter, we need to check each future occurrence.</span>
<a href="#l60.310"></a><span id="l60.310" class="difflineat">@@ -808,17 +808,17 @@ calFilter.prototype = {</span>
<a href="#l60.311"></a><span id="l60.311">      * Gets the occurrences of a repeating item that match the currently applied</span>
<a href="#l60.312"></a><span id="l60.312">      * filter properties and date range.</span>
<a href="#l60.313"></a><span id="l60.313">      *</span>
<a href="#l60.314"></a><span id="l60.314">      * @param aItem               The parent item to find occurrence of.</span>
<a href="#l60.315"></a><span id="l60.315">      * @return                    Returns an array containing the occurrences that</span>
<a href="#l60.316"></a><span id="l60.316">      *                            match the filters, an empty array if there are no</span>
<a href="#l60.317"></a><span id="l60.317">      *                            matches, or null if the filter is not initialized.</span>
<a href="#l60.318"></a><span id="l60.318">      */</span>
<a href="#l60.319"></a><span id="l60.319" class="difflineminus">-    getOccurrences: function cF_getOccurrences(aItem) {</span>
<a href="#l60.320"></a><span id="l60.320" class="difflineplus">+    getOccurrences: function(aItem) {</span>
<a href="#l60.321"></a><span id="l60.321">         if (!this.mFilterProperties) {</span>
<a href="#l60.322"></a><span id="l60.322">             return null;</span>
<a href="#l60.323"></a><span id="l60.323">         }</span>
<a href="#l60.324"></a><span id="l60.324">         let props = this.mFilterProperties;</span>
<a href="#l60.325"></a><span id="l60.325">         let occs;</span>
<a href="#l60.326"></a><span id="l60.326"> </span>
<a href="#l60.327"></a><span id="l60.327">         if (!aItem.recurrenceInfo || (!props.occurrences &amp;&amp; !this.mEndDate) ||</span>
<a href="#l60.328"></a><span id="l60.328">             props.occurrences == props.FILTER_OCCURRENCES_NONE) {</span>
<a href="#l60.329"></a><span id="l60.329" class="difflineat">@@ -848,17 +848,17 @@ calFilter.prototype = {</span>
<a href="#l60.330"></a><span id="l60.330">      * This function is asynchronous, and returns results to a calIOperationListener object.</span>
<a href="#l60.331"></a><span id="l60.331">      *</span>
<a href="#l60.332"></a><span id="l60.332">      * @param aCalendar           The calendar to get items from.</span>
<a href="#l60.333"></a><span id="l60.333">      * @param aItemType           The type of items to get, as defined by the calICalendar</span>
<a href="#l60.334"></a><span id="l60.334">      *                            interface ITEM_FILTER_TYPE_XXX constants.</span>
<a href="#l60.335"></a><span id="l60.335">      * @param aListener           The calIOperationListener object to return results to.</span>
<a href="#l60.336"></a><span id="l60.336">      * @return                    the calIOperation handle to track the operation.</span>
<a href="#l60.337"></a><span id="l60.337">      */</span>
<a href="#l60.338"></a><span id="l60.338" class="difflineminus">-    getItems: function cF_getItems(aCalendar, aItemType, aListener) {</span>
<a href="#l60.339"></a><span id="l60.339" class="difflineplus">+    getItems: function(aCalendar, aItemType, aListener) {</span>
<a href="#l60.340"></a><span id="l60.340">         if (!this.mFilterProperties) {</span>
<a href="#l60.341"></a><span id="l60.341">             return null;</span>
<a href="#l60.342"></a><span id="l60.342">         }</span>
<a href="#l60.343"></a><span id="l60.343">         let props = this.mFilterProperties;</span>
<a href="#l60.344"></a><span id="l60.344"> </span>
<a href="#l60.345"></a><span id="l60.345">         // we use a local proxy listener for the calICalendar.getItems() call, and use it</span>
<a href="#l60.346"></a><span id="l60.346">         // to handle occurrence expansion and filter the results before forwarding them to</span>
<a href="#l60.347"></a><span id="l60.347">         // the listener passed in the aListener argument.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/base/src/calFreeBusyService.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/base/src/calFreeBusyService.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -14,28 +14,28 @@ function calFreeBusyListener(numOperatio</span>
<a href="#l61.4"></a><span id="l61.4"> }</span>
<a href="#l61.5"></a><span id="l61.5"> calFreeBusyListener.prototype = {</span>
<a href="#l61.6"></a><span id="l61.6">     mFinalListener: null,</span>
<a href="#l61.7"></a><span id="l61.7">     mNumOperations: 0,</span>
<a href="#l61.8"></a><span id="l61.8">     opGroup: null,</span>
<a href="#l61.9"></a><span id="l61.9"> </span>
<a href="#l61.10"></a><span id="l61.10">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIGenericOperationListener]),</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-    notifyResult: function calFreeBusyListener_notifyResult(result) {</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+    notifyResult: function(result) {</span>
<a href="#l61.14"></a><span id="l61.14">         let listener = this.mFinalListener;</span>
<a href="#l61.15"></a><span id="l61.15">         if (listener) {</span>
<a href="#l61.16"></a><span id="l61.16">             if (!this.opGroup.isPending) {</span>
<a href="#l61.17"></a><span id="l61.17">                 this.mFinalListener = null;</span>
<a href="#l61.18"></a><span id="l61.18">             }</span>
<a href="#l61.19"></a><span id="l61.19">             listener.onResult(this.opGroup, result);</span>
<a href="#l61.20"></a><span id="l61.20">         }</span>
<a href="#l61.21"></a><span id="l61.21">     },</span>
<a href="#l61.22"></a><span id="l61.22"> </span>
<a href="#l61.23"></a><span id="l61.23">     // calIGenericOperationListener:</span>
<a href="#l61.24"></a><span id="l61.24" class="difflineminus">-    onResult: function calFreeBusyListener_onResult(aOperation, aResult) {</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineplus">+    onResult: function(aOperation, aResult) {</span>
<a href="#l61.26"></a><span id="l61.26">         if (this.mFinalListener) {</span>
<a href="#l61.27"></a><span id="l61.27">             if (!aOperation || !aOperation.isPending) {</span>
<a href="#l61.28"></a><span id="l61.28">                 --this.mNumOperations;</span>
<a href="#l61.29"></a><span id="l61.29">                 if (this.mNumOperations == 0) {</span>
<a href="#l61.30"></a><span id="l61.30">                     this.opGroup.notifyCompleted();</span>
<a href="#l61.31"></a><span id="l61.31">                 }</span>
<a href="#l61.32"></a><span id="l61.32">             }</span>
<a href="#l61.33"></a><span id="l61.33">             let opStatus = aOperation ? aOperation.status : Components.results.NS_OK;</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineat">@@ -67,32 +67,28 @@ calFreeBusyService.prototype = {</span>
<a href="#l61.35"></a><span id="l61.35">         classID: calFreeBusyServiceClassID,</span>
<a href="#l61.36"></a><span id="l61.36">         contractID: &quot;@mozilla.org/calendar/freebusy-service;1&quot;,</span>
<a href="#l61.37"></a><span id="l61.37">         classDescription: &quot;Calendar FreeBusy Service&quot;,</span>
<a href="#l61.38"></a><span id="l61.38">         interfaces: calFreeBusyServiceInterfaces,</span>
<a href="#l61.39"></a><span id="l61.39">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l61.40"></a><span id="l61.40">     }),</span>
<a href="#l61.41"></a><span id="l61.41"> </span>
<a href="#l61.42"></a><span id="l61.42">     // calIFreeBusyProvider:</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineminus">-    getFreeBusyIntervals: function calFreeBusyService_getFreeBusyIntervals(aCalId,</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineminus">-                                                                           aRangeStart,</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineminus">-                                                                           aRangeEnd,</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineminus">-                                                                           aBusyTypes,</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineminus">-                                                                           aListener) {</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineplus">+    getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l61.49"></a><span id="l61.49">         let groupListener = new calFreeBusyListener(this.mProviders.size, aListener);</span>
<a href="#l61.50"></a><span id="l61.50">         for (let provider of this.mProviders) {</span>
<a href="#l61.51"></a><span id="l61.51">             let operation = provider.getFreeBusyIntervals(aCalId, aRangeStart,</span>
<a href="#l61.52"></a><span id="l61.52">                                                           aRangeEnd,</span>
<a href="#l61.53"></a><span id="l61.53">                                                           aBusyTypes,</span>
<a href="#l61.54"></a><span id="l61.54">                                                           groupListener);</span>
<a href="#l61.55"></a><span id="l61.55">             groupListener.opGroup.add(operation);</span>
<a href="#l61.56"></a><span id="l61.56">         }</span>
<a href="#l61.57"></a><span id="l61.57">         return groupListener.opGroup;</span>
<a href="#l61.58"></a><span id="l61.58">     },</span>
<a href="#l61.59"></a><span id="l61.59"> </span>
<a href="#l61.60"></a><span id="l61.60">     // calIFreeBusyService:</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineminus">-    addProvider: function calFreeBusyListener_addProvider(aProvider) {</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+    addProvider: function(aProvider) {</span>
<a href="#l61.63"></a><span id="l61.63">         this.mProviders.add(aProvider);</span>
<a href="#l61.64"></a><span id="l61.64">     },</span>
<a href="#l61.65"></a><span id="l61.65" class="difflineminus">-    removeProvider: function calFreeBusyListener_removeProvider(aProvider) {</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineplus">+    removeProvider: function(aProvider) {</span>
<a href="#l61.67"></a><span id="l61.67">         this.mProviders.remove(aProvider);</span>
<a href="#l61.68"></a><span id="l61.68">     }</span>
<a href="#l61.69"></a><span id="l61.69"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -21,17 +21,17 @@ calIcsParser.prototype = {</span>
<a href="#l62.4"></a><span id="l62.4">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l62.5"></a><span id="l62.5">         classID: calIcsParserClassID,</span>
<a href="#l62.6"></a><span id="l62.6">         contractID: &quot;@mozilla.org/calendar/ics-parser;1&quot;,</span>
<a href="#l62.7"></a><span id="l62.7">         classDescription: &quot;Calendar ICS Parser&quot;,</span>
<a href="#l62.8"></a><span id="l62.8">         interfaces: calIcsParserInterfaces,</span>
<a href="#l62.9"></a><span id="l62.9">         flags: Components.interfaces.nsIClassInfo.THREADSAFE</span>
<a href="#l62.10"></a><span id="l62.10">     }),</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-    processIcalComponent: function ip_processIcalComponent(rootComp, aAsyncParsing) {</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+    processIcalComponent: function(rootComp, aAsyncParsing) {</span>
<a href="#l62.14"></a><span id="l62.14">         let calComp;</span>
<a href="#l62.15"></a><span id="l62.15">         // libical returns the vcalendar component if there is just one vcalendar.</span>
<a href="#l62.16"></a><span id="l62.16">         // If there are multiple vcalendars, it returns an xroot component, with</span>
<a href="#l62.17"></a><span id="l62.17">         // vcalendar children. We need to handle both cases.</span>
<a href="#l62.18"></a><span id="l62.18">         if (rootComp) {</span>
<a href="#l62.19"></a><span id="l62.19">             if (rootComp.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l62.20"></a><span id="l62.20">                 calComp = rootComp;</span>
<a href="#l62.21"></a><span id="l62.21">             } else {</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -110,17 +110,17 @@ calIcsParser.prototype = {</span>
<a href="#l62.23"></a><span id="l62.23">             self.mComponents = self.mComponents.concat(state.extraComponents);</span>
<a href="#l62.24"></a><span id="l62.24"> </span>
<a href="#l62.25"></a><span id="l62.25">             if (aAsyncParsing) {</span>
<a href="#l62.26"></a><span id="l62.26">                 aAsyncParsing.onParsingComplete(Components.results.NS_OK, self);</span>
<a href="#l62.27"></a><span id="l62.27">             }</span>
<a href="#l62.28"></a><span id="l62.28">         });</span>
<a href="#l62.29"></a><span id="l62.29">     },</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-    parseString: function ip_parseString(aICSString, aTzProvider, aAsyncParsing) {</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+    parseString: function(aICSString, aTzProvider, aAsyncParsing) {</span>
<a href="#l62.33"></a><span id="l62.33">         if (aAsyncParsing) {</span>
<a href="#l62.34"></a><span id="l62.34">             let self = this;</span>
<a href="#l62.35"></a><span id="l62.35"> </span>
<a href="#l62.36"></a><span id="l62.36">             // We are using two types of very similar listeners here:</span>
<a href="#l62.37"></a><span id="l62.37">             // aAsyncParsing is a calIcsParsingListener that returns the ics</span>
<a href="#l62.38"></a><span id="l62.38">             //   parser containing the processed items.</span>
<a href="#l62.39"></a><span id="l62.39">             // The listener passed to parseICSAsync is a calICsComponentParsingListener</span>
<a href="#l62.40"></a><span id="l62.40">             //   required by the ics service, that receives the parsed root component.</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineat">@@ -134,17 +134,17 @@ calIcsParser.prototype = {</span>
<a href="#l62.42"></a><span id="l62.42">                     }</span>
<a href="#l62.43"></a><span id="l62.43">                 }</span>
<a href="#l62.44"></a><span id="l62.44">             });</span>
<a href="#l62.45"></a><span id="l62.45">         } else {</span>
<a href="#l62.46"></a><span id="l62.46">             this.processIcalComponent(cal.getIcsService().parseICS(aICSString, aTzProvider));</span>
<a href="#l62.47"></a><span id="l62.47">         }</span>
<a href="#l62.48"></a><span id="l62.48">     },</span>
<a href="#l62.49"></a><span id="l62.49"> </span>
<a href="#l62.50"></a><span id="l62.50" class="difflineminus">-    parseFromStream: function ip_parseFromStream(aStream, aTzProvider, aAsyncParsing) {</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+    parseFromStream: function(aStream, aTzProvider, aAsyncParsing) {</span>
<a href="#l62.52"></a><span id="l62.52">         // Read in the string. Note that it isn't a real string at this point,</span>
<a href="#l62.53"></a><span id="l62.53">         // because likely, the file is utf8. The multibyte chars show up as multiple</span>
<a href="#l62.54"></a><span id="l62.54">         // 'chars' in this string. So call it an array of octets for now.</span>
<a href="#l62.55"></a><span id="l62.55"> </span>
<a href="#l62.56"></a><span id="l62.56">         let octetArray = [];</span>
<a href="#l62.57"></a><span id="l62.57">         let binaryIS = Components.classes[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l62.58"></a><span id="l62.58">                                  .createInstance(Components.interfaces.nsIBinaryInputStream);</span>
<a href="#l62.59"></a><span id="l62.59">         binaryIS.setInputStream(aStream);</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineat">@@ -168,32 +168,32 @@ calIcsParser.prototype = {</span>
<a href="#l62.61"></a><span id="l62.61">                                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l62.62"></a><span id="l62.62">         // ICS files are always UTF8</span>
<a href="#l62.63"></a><span id="l62.63">         unicodeConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l62.64"></a><span id="l62.64">         let stringData = unicodeConverter.convertFromByteArray(octetArray, octetArray.length);</span>
<a href="#l62.65"></a><span id="l62.65"> </span>
<a href="#l62.66"></a><span id="l62.66">         this.parseString(stringData, aTzProvider, aAsyncParsing);</span>
<a href="#l62.67"></a><span id="l62.67">     },</span>
<a href="#l62.68"></a><span id="l62.68"> </span>
<a href="#l62.69"></a><span id="l62.69" class="difflineminus">-    getItems: function ip_getItems(aCount) {</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+    getItems: function(aCount) {</span>
<a href="#l62.71"></a><span id="l62.71">         aCount.value = this.mItems.length;</span>
<a href="#l62.72"></a><span id="l62.72">         return this.mItems.concat([]);</span>
<a href="#l62.73"></a><span id="l62.73">     },</span>
<a href="#l62.74"></a><span id="l62.74"> </span>
<a href="#l62.75"></a><span id="l62.75" class="difflineminus">-    getParentlessItems: function ip_getParentlessItems(aCount) {</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+    getParentlessItems: function(aCount) {</span>
<a href="#l62.77"></a><span id="l62.77">         aCount.value = this.mParentlessItems.length;</span>
<a href="#l62.78"></a><span id="l62.78">         return this.mParentlessItems.concat([]);</span>
<a href="#l62.79"></a><span id="l62.79">     },</span>
<a href="#l62.80"></a><span id="l62.80"> </span>
<a href="#l62.81"></a><span id="l62.81" class="difflineminus">-    getProperties: function ip_getProperties(aCount) {</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+    getProperties: function(aCount) {</span>
<a href="#l62.83"></a><span id="l62.83">         aCount.value = this.mProperties.length;</span>
<a href="#l62.84"></a><span id="l62.84">         return this.mProperties.concat([]);</span>
<a href="#l62.85"></a><span id="l62.85">     },</span>
<a href="#l62.86"></a><span id="l62.86"> </span>
<a href="#l62.87"></a><span id="l62.87" class="difflineminus">-    getComponents: function ip_getComponents(aCount) {</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+    getComponents: function(aCount) {</span>
<a href="#l62.89"></a><span id="l62.89">         aCount.value = this.mComponents.length;</span>
<a href="#l62.90"></a><span id="l62.90">         return this.mComponents.concat([]);</span>
<a href="#l62.91"></a><span id="l62.91">     }</span>
<a href="#l62.92"></a><span id="l62.92"> };</span>
<a href="#l62.93"></a><span id="l62.93"> </span>
<a href="#l62.94"></a><span id="l62.94"> /**</span>
<a href="#l62.95"></a><span id="l62.95">  * The parser state, which helps process ical components without clogging up the</span>
<a href="#l62.96"></a><span id="l62.96">  * event queue.</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineat">@@ -224,17 +224,17 @@ parserState.prototype = {</span>
<a href="#l62.98"></a><span id="l62.98">     listener: null,</span>
<a href="#l62.99"></a><span id="l62.99"> </span>
<a href="#l62.100"></a><span id="l62.100">     /**</span>
<a href="#l62.101"></a><span id="l62.101">      * Checks if the timezones are missing and notifies the user via error console</span>
<a href="#l62.102"></a><span id="l62.102">      *</span>
<a href="#l62.103"></a><span id="l62.103">      * @param item      The item to check for</span>
<a href="#l62.104"></a><span id="l62.104">      * @param dt        The datetime object to check with</span>
<a href="#l62.105"></a><span id="l62.105">      */</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineminus">-    checkTimezone: function checkTimezone(item, dt) {</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+    checkTimezone: function(item, dt) {</span>
<a href="#l62.108"></a><span id="l62.108">         if (dt &amp;&amp; cal.isPhantomTimezone(dt.timezone)) {</span>
<a href="#l62.109"></a><span id="l62.109">             let tzid = dt.timezone.tzid;</span>
<a href="#l62.110"></a><span id="l62.110">             let hid = item.hashId + &quot;#&quot; + tzid;</span>
<a href="#l62.111"></a><span id="l62.111">             if (!(hid in this.tzErrors)) {</span>
<a href="#l62.112"></a><span id="l62.112">                 // For now, publish errors to console and alert user.</span>
<a href="#l62.113"></a><span id="l62.113">                 // In future, maybe make them available through an interface method</span>
<a href="#l62.114"></a><span id="l62.114">                 // so this UI code can be removed from the parser, and caller can</span>
<a href="#l62.115"></a><span id="l62.115">                 // choose whether to alert, or show user the problem items and ask</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineat">@@ -248,20 +248,20 @@ parserState.prototype = {</span>
<a href="#l62.117"></a><span id="l62.117">         }</span>
<a href="#l62.118"></a><span id="l62.118">     },</span>
<a href="#l62.119"></a><span id="l62.119"> </span>
<a href="#l62.120"></a><span id="l62.120">     /**</span>
<a href="#l62.121"></a><span id="l62.121">      * Submit processing of a subcomponent to the event queue</span>
<a href="#l62.122"></a><span id="l62.122">      *</span>
<a href="#l62.123"></a><span id="l62.123">      * @param subComp       The component to process</span>
<a href="#l62.124"></a><span id="l62.124">      */</span>
<a href="#l62.125"></a><span id="l62.125" class="difflineminus">-    submit: function submit(subComp) {</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineplus">+    submit: function(subComp) {</span>
<a href="#l62.127"></a><span id="l62.127">         let self = this;</span>
<a href="#l62.128"></a><span id="l62.128">         let runner = {</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineminus">-            run: function run() {</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineplus">+            run: function() {</span>
<a href="#l62.131"></a><span id="l62.131">                 let item = null;</span>
<a href="#l62.132"></a><span id="l62.132">                 switch (subComp.componentType) {</span>
<a href="#l62.133"></a><span id="l62.133">                     case &quot;VEVENT&quot;:</span>
<a href="#l62.134"></a><span id="l62.134">                         item = cal.createEvent();</span>
<a href="#l62.135"></a><span id="l62.135">                         item.icalComponent = subComp;</span>
<a href="#l62.136"></a><span id="l62.136">                         self.checkTimezone(item, item.startDate);</span>
<a href="#l62.137"></a><span id="l62.137">                         self.checkTimezone(item, item.endDate);</span>
<a href="#l62.138"></a><span id="l62.138">                         break;</span>
<a href="#l62.139"></a><span id="l62.139" class="difflineat">@@ -323,13 +323,13 @@ parserState.prototype = {</span>
<a href="#l62.140"></a><span id="l62.140">         return false;</span>
<a href="#l62.141"></a><span id="l62.141">     },</span>
<a href="#l62.142"></a><span id="l62.142"> </span>
<a href="#l62.143"></a><span id="l62.143">     /**</span>
<a href="#l62.144"></a><span id="l62.144">      * Sets a join function that is called when all tasks have been completed</span>
<a href="#l62.145"></a><span id="l62.145">      *</span>
<a href="#l62.146"></a><span id="l62.146">      * @param joinFunc      The join function to call</span>
<a href="#l62.147"></a><span id="l62.147">      */</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineminus">-    join: function join(joinFunc) {</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+    join: function(joinFunc) {</span>
<a href="#l62.150"></a><span id="l62.150">         this.joinFunc = joinFunc;</span>
<a href="#l62.151"></a><span id="l62.151">         this.checkCompletion();</span>
<a href="#l62.152"></a><span id="l62.152">     }</span>
<a href="#l62.153"></a><span id="l62.153"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/base/src/calIcsSerializer.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/base/src/calIcsSerializer.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -18,54 +18,54 @@ calIcsSerializer.prototype = {</span>
<a href="#l63.4"></a><span id="l63.4">     QueryInterface: XPCOMUtils.generateQI(calIcsSerializerInterfaces),</span>
<a href="#l63.5"></a><span id="l63.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l63.6"></a><span id="l63.6">         classID: calIcsSerializerClassID,</span>
<a href="#l63.7"></a><span id="l63.7">         contractID: &quot;@mozilla.org/calendar/ics-serializer;1&quot;,</span>
<a href="#l63.8"></a><span id="l63.8">         classDescription: &quot;Calendar ICS Serializer&quot;,</span>
<a href="#l63.9"></a><span id="l63.9">         interfaces: calIcsSerializerInterfaces,</span>
<a href="#l63.10"></a><span id="l63.10">     }),</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-    addItems: function is_addItems(aItems, aCount) {</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+    addItems: function(aItems, aCount) {</span>
<a href="#l63.14"></a><span id="l63.14">         if (aCount &gt; 0) {</span>
<a href="#l63.15"></a><span id="l63.15">             this.mItems = this.mItems.concat(aItems);</span>
<a href="#l63.16"></a><span id="l63.16">         }</span>
<a href="#l63.17"></a><span id="l63.17">     },</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19" class="difflineminus">-    addProperty: function is_addProperty(aProperty) {</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+    addProperty: function(aProperty) {</span>
<a href="#l63.21"></a><span id="l63.21">        this.mProperties.push(aProperty);</span>
<a href="#l63.22"></a><span id="l63.22">     },</span>
<a href="#l63.23"></a><span id="l63.23"> </span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-    addComponent: function is_addComponent(aComponent) {</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+    addComponent: function(aComponent) {</span>
<a href="#l63.26"></a><span id="l63.26">        this.mComponents.push(aComponent);</span>
<a href="#l63.27"></a><span id="l63.27">     },</span>
<a href="#l63.28"></a><span id="l63.28"> </span>
<a href="#l63.29"></a><span id="l63.29" class="difflineminus">-    serializeToString: function is_serializeToString() {</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+    serializeToString: function() {</span>
<a href="#l63.31"></a><span id="l63.31">         let calComp = this.getIcalComponent();</span>
<a href="#l63.32"></a><span id="l63.32">         return calComp.serializeToICS();</span>
<a href="#l63.33"></a><span id="l63.33">     },</span>
<a href="#l63.34"></a><span id="l63.34"> </span>
<a href="#l63.35"></a><span id="l63.35" class="difflineminus">-    serializeToInputStream: function is_serializeToStream(aStream) {</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+    serializeToInputStream: function(aStream) {</span>
<a href="#l63.37"></a><span id="l63.37">         let calComp = this.getIcalComponent();</span>
<a href="#l63.38"></a><span id="l63.38">         return calComp.serializeToICSStream();</span>
<a href="#l63.39"></a><span id="l63.39">     },</span>
<a href="#l63.40"></a><span id="l63.40"> </span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-    serializeToStream: function is_serializeToStream(aStream) {</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineplus">+    serializeToStream: function(aStream) {</span>
<a href="#l63.43"></a><span id="l63.43">         let str = this.serializeToString();</span>
<a href="#l63.44"></a><span id="l63.44"> </span>
<a href="#l63.45"></a><span id="l63.45">         // Convert the javascript string to an array of bytes, using the</span>
<a href="#l63.46"></a><span id="l63.46">         // UTF8 encoder</span>
<a href="#l63.47"></a><span id="l63.47">         let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l63.48"></a><span id="l63.48">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l63.49"></a><span id="l63.49">         convStream.init(aStream, &quot;UTF-8&quot;, 0, 0x0000);</span>
<a href="#l63.50"></a><span id="l63.50"> </span>
<a href="#l63.51"></a><span id="l63.51">         convStream.writeString(str);</span>
<a href="#l63.52"></a><span id="l63.52">         convStream.close();</span>
<a href="#l63.53"></a><span id="l63.53">     },</span>
<a href="#l63.54"></a><span id="l63.54"> </span>
<a href="#l63.55"></a><span id="l63.55" class="difflineminus">-    getIcalComponent: function is_getIcalComponent() {</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+    getIcalComponent: function() {</span>
<a href="#l63.57"></a><span id="l63.57">         let calComp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l63.58"></a><span id="l63.58">         calSetProdidVersion(calComp);</span>
<a href="#l63.59"></a><span id="l63.59"> </span>
<a href="#l63.60"></a><span id="l63.60">         // xxx todo: think about that the below code doesn't clone the properties/components,</span>
<a href="#l63.61"></a><span id="l63.61">         //           thus ownership is moved to returned VCALENDAR...</span>
<a href="#l63.62"></a><span id="l63.62"> </span>
<a href="#l63.63"></a><span id="l63.63">         for (let prop of this.mProperties) {</span>
<a href="#l63.64"></a><span id="l63.64">             calComp.addProperty(prop);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -38,17 +38,17 @@ calItemBase.prototype = {</span>
<a href="#l64.4"></a><span id="l64.4">     mCategories: null,</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6">     mACLEntry: null,</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8">     /**</span>
<a href="#l64.9"></a><span id="l64.9">      * Initialize the base item's attributes. Can be called from inheriting</span>
<a href="#l64.10"></a><span id="l64.10">      * objects in their constructor.</span>
<a href="#l64.11"></a><span id="l64.11">      */</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-    initItemBase: function cIB_initItemBase() {</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+    initItemBase: function() {</span>
<a href="#l64.14"></a><span id="l64.14">         this.wrappedJSObject = this;</span>
<a href="#l64.15"></a><span id="l64.15">         this.mProperties = new calPropertyBag();</span>
<a href="#l64.16"></a><span id="l64.16">         this.mPropertyParams = {};</span>
<a href="#l64.17"></a><span id="l64.17">         this.mProperties.setProperty(&quot;CREATED&quot;, cal.jsDateToDateTime(new Date()));</span>
<a href="#l64.18"></a><span id="l64.18">     },</span>
<a href="#l64.19"></a><span id="l64.19"> </span>
<a href="#l64.20"></a><span id="l64.20">     /**</span>
<a href="#l64.21"></a><span id="l64.21">      * @see nsISupports</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineat">@@ -136,17 +136,17 @@ calItemBase.prototype = {</span>
<a href="#l64.23"></a><span id="l64.23">      *</span>
<a href="#l64.24"></a><span id="l64.24">      * XXXdbo Explain proxy a bit better, either here or in</span>
<a href="#l64.25"></a><span id="l64.25">      * calIInternalShallowCopy.</span>
<a href="#l64.26"></a><span id="l64.26">      *</span>
<a href="#l64.27"></a><span id="l64.27">      * @see calIInternalShallowCopy</span>
<a href="#l64.28"></a><span id="l64.28">      * @param aParentItem     The parent item to initialize the proxy on.</span>
<a href="#l64.29"></a><span id="l64.29">      * @param aRecurrenceId   The recurrence id to initialize the proxy for.</span>
<a href="#l64.30"></a><span id="l64.30">      */</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineminus">-    initializeProxy: function cib_initializeProxy(aParentItem, aRecurrenceId) {</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+    initializeProxy: function(aParentItem, aRecurrenceId) {</span>
<a href="#l64.33"></a><span id="l64.33">         this.mIsProxy = true;</span>
<a href="#l64.34"></a><span id="l64.34"> </span>
<a href="#l64.35"></a><span id="l64.35">         aParentItem = calTryWrappedJSObject(aParentItem);</span>
<a href="#l64.36"></a><span id="l64.36">         this.mParentItem = aParentItem;</span>
<a href="#l64.37"></a><span id="l64.37">         this.mCalendar = aParentItem.mCalendar;</span>
<a href="#l64.38"></a><span id="l64.38">         this.recurrenceId = aRecurrenceId;</span>
<a href="#l64.39"></a><span id="l64.39"> </span>
<a href="#l64.40"></a><span id="l64.40">         // Make sure organizer is unset, as the getter checks for this.</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineat">@@ -158,41 +158,41 @@ calItemBase.prototype = {</span>
<a href="#l64.42"></a><span id="l64.42">     // readonly attribute boolean isMutable;</span>
<a href="#l64.43"></a><span id="l64.43">     get isMutable() { return !this.mImmutable; },</span>
<a href="#l64.44"></a><span id="l64.44"> </span>
<a href="#l64.45"></a><span id="l64.45">     /**</span>
<a href="#l64.46"></a><span id="l64.46">      * This function should be called by all members that modify the item. It</span>
<a href="#l64.47"></a><span id="l64.47">      * checks if the item is immutable and throws accordingly, and sets the</span>
<a href="#l64.48"></a><span id="l64.48">      * mDirty property.</span>
<a href="#l64.49"></a><span id="l64.49">      */</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineminus">-    modify: function cIB_modify() {</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineplus">+    modify: function() {</span>
<a href="#l64.52"></a><span id="l64.52">         if (this.mImmutable) {</span>
<a href="#l64.53"></a><span id="l64.53">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l64.54"></a><span id="l64.54">         }</span>
<a href="#l64.55"></a><span id="l64.55">         this.mDirty = true;</span>
<a href="#l64.56"></a><span id="l64.56">     },</span>
<a href="#l64.57"></a><span id="l64.57"> </span>
<a href="#l64.58"></a><span id="l64.58">     /**</span>
<a href="#l64.59"></a><span id="l64.59">      * Makes sure the item is not dirty. If the item is dirty, properties like</span>
<a href="#l64.60"></a><span id="l64.60">      * LAST-MODIFIED and DTSTAMP are set to now.</span>
<a href="#l64.61"></a><span id="l64.61">      */</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineminus">-    ensureNotDirty: function cIB_ensureNotDirty() {</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineplus">+    ensureNotDirty: function() {</span>
<a href="#l64.64"></a><span id="l64.64">         if (this.mDirty) {</span>
<a href="#l64.65"></a><span id="l64.65">             let now = cal.jsDateToDateTime(new Date());</span>
<a href="#l64.66"></a><span id="l64.66">             this.setProperty(&quot;LAST-MODIFIED&quot;, now);</span>
<a href="#l64.67"></a><span id="l64.67">             this.setProperty(&quot;DTSTAMP&quot;, now);</span>
<a href="#l64.68"></a><span id="l64.68">             this.mDirty = false;</span>
<a href="#l64.69"></a><span id="l64.69">         }</span>
<a href="#l64.70"></a><span id="l64.70">     },</span>
<a href="#l64.71"></a><span id="l64.71"> </span>
<a href="#l64.72"></a><span id="l64.72">     /**</span>
<a href="#l64.73"></a><span id="l64.73">      * Makes all properties of the base item immutable. Can be called by</span>
<a href="#l64.74"></a><span id="l64.74">      * inheriting objects' makeImmutable method.</span>
<a href="#l64.75"></a><span id="l64.75">      */</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineminus">-    makeItemBaseImmutable: function cIB_makeItemBaseImmutable() {</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineplus">+    makeItemBaseImmutable: function() {</span>
<a href="#l64.78"></a><span id="l64.78">         if (this.mImmutable) {</span>
<a href="#l64.79"></a><span id="l64.79">             return;</span>
<a href="#l64.80"></a><span id="l64.80">         }</span>
<a href="#l64.81"></a><span id="l64.81"> </span>
<a href="#l64.82"></a><span id="l64.82">         // make all our components immutable</span>
<a href="#l64.83"></a><span id="l64.83">         if (this.mRecurrenceInfo) {</span>
<a href="#l64.84"></a><span id="l64.84">             this.mRecurrenceInfo.makeImmutable();</span>
<a href="#l64.85"></a><span id="l64.85">         }</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineat">@@ -223,36 +223,36 @@ calItemBase.prototype = {</span>
<a href="#l64.87"></a><span id="l64.87">             this.mAlarmLastAck.makeImmutable();</span>
<a href="#l64.88"></a><span id="l64.88">         }</span>
<a href="#l64.89"></a><span id="l64.89"> </span>
<a href="#l64.90"></a><span id="l64.90">         this.ensureNotDirty();</span>
<a href="#l64.91"></a><span id="l64.91">         this.mImmutable = true;</span>
<a href="#l64.92"></a><span id="l64.92">     },</span>
<a href="#l64.93"></a><span id="l64.93"> </span>
<a href="#l64.94"></a><span id="l64.94">      // boolean hasSameIds(in calIItemBase aItem);</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineminus">-    hasSameIds: function cIB_hasSameIds(that) {</span>
<a href="#l64.96"></a><span id="l64.96" class="difflineplus">+    hasSameIds: function(that) {</span>
<a href="#l64.97"></a><span id="l64.97">         return that &amp;&amp; this.id == that.id &amp;&amp;</span>
<a href="#l64.98"></a><span id="l64.98">                (this.recurrenceId == that.recurrenceId || // both null</span>
<a href="#l64.99"></a><span id="l64.99">                 (this.recurrenceId &amp;&amp; that.recurrenceId &amp;&amp;</span>
<a href="#l64.100"></a><span id="l64.100">                  this.recurrenceId.compare(that.recurrenceId) == 0));</span>
<a href="#l64.101"></a><span id="l64.101">     },</span>
<a href="#l64.102"></a><span id="l64.102"> </span>
<a href="#l64.103"></a><span id="l64.103">     // calIItemBase clone();</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineminus">-    clone: function cIB_clone() {</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineplus">+    clone: function() {</span>
<a href="#l64.106"></a><span id="l64.106">         return this.cloneShallow(this.mParentItem);</span>
<a href="#l64.107"></a><span id="l64.107">     },</span>
<a href="#l64.108"></a><span id="l64.108"> </span>
<a href="#l64.109"></a><span id="l64.109">     /**</span>
<a href="#l64.110"></a><span id="l64.110">      * Clones the base item's properties into the passed object, potentially</span>
<a href="#l64.111"></a><span id="l64.111">      * setting a new parent item.</span>
<a href="#l64.112"></a><span id="l64.112">      *</span>
<a href="#l64.113"></a><span id="l64.113">      * @param m     The item to clone this item into</span>
<a href="#l64.114"></a><span id="l64.114">      * @param aNewParent    (optional) The new parent item to set on m.</span>
<a href="#l64.115"></a><span id="l64.115">      */</span>
<a href="#l64.116"></a><span id="l64.116" class="difflineminus">-    cloneItemBaseInto: function cIB_cloneItemBaseInto(m, aNewParent) {</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineplus">+    cloneItemBaseInto: function(m, aNewParent) {</span>
<a href="#l64.118"></a><span id="l64.118">         m.mImmutable = false;</span>
<a href="#l64.119"></a><span id="l64.119">         m.mACLEntry = this.mACLEntry;</span>
<a href="#l64.120"></a><span id="l64.120">         m.mIsProxy = this.mIsProxy;</span>
<a href="#l64.121"></a><span id="l64.121">         m.mParentItem = calTryWrappedJSObject(aNewParent) || this.mParentItem;</span>
<a href="#l64.122"></a><span id="l64.122">         m.mHashId = this.mHashId;</span>
<a href="#l64.123"></a><span id="l64.123">         m.mCalendar = this.mCalendar;</span>
<a href="#l64.124"></a><span id="l64.124">         if (this.mRecurrenceInfo) {</span>
<a href="#l64.125"></a><span id="l64.125">             m.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l64.126"></a><span id="l64.126" class="difflineat">@@ -347,17 +347,17 @@ calItemBase.prototype = {</span>
<a href="#l64.127"></a><span id="l64.127">         if (this.mIsProxy) {</span>
<a href="#l64.128"></a><span id="l64.128">             cal.ASSERT(this.parentItem != this);</span>
<a href="#l64.129"></a><span id="l64.129">             return { // nsISimpleEnumerator:</span>
<a href="#l64.130"></a><span id="l64.130">                 mProxyEnum: this.mProperties.enumerator,</span>
<a href="#l64.131"></a><span id="l64.131">                 mParentEnum: this.mParentItem.propertyEnumerator,</span>
<a href="#l64.132"></a><span id="l64.132">                 mHandledProps: { },</span>
<a href="#l64.133"></a><span id="l64.133">                 mCurrentProp: null,</span>
<a href="#l64.134"></a><span id="l64.134"> </span>
<a href="#l64.135"></a><span id="l64.135" class="difflineminus">-                hasMoreElements: function cib_pe_hasMoreElements() {</span>
<a href="#l64.136"></a><span id="l64.136" class="difflineplus">+                hasMoreElements: function() {</span>
<a href="#l64.137"></a><span id="l64.137">                     if (this.mCurrentProp) {</span>
<a href="#l64.138"></a><span id="l64.138">                         return true;</span>
<a href="#l64.139"></a><span id="l64.139">                     }</span>
<a href="#l64.140"></a><span id="l64.140">                     if (this.mProxyEnum) {</span>
<a href="#l64.141"></a><span id="l64.141">                         while (this.mProxyEnum.hasMoreElements()) {</span>
<a href="#l64.142"></a><span id="l64.142">                             let prop = this.mProxyEnum.getNext();</span>
<a href="#l64.143"></a><span id="l64.143">                             this.mHandledProps[prop.name] = true;</span>
<a href="#l64.144"></a><span id="l64.144">                             if (prop.value !== null) {</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineat">@@ -372,101 +372,101 @@ calItemBase.prototype = {</span>
<a href="#l64.146"></a><span id="l64.146">                         if (!this.mHandledProps[prop.name]) {</span>
<a href="#l64.147"></a><span id="l64.147">                             this.mCurrentProp = prop;</span>
<a href="#l64.148"></a><span id="l64.148">                             return true;</span>
<a href="#l64.149"></a><span id="l64.149">                         }</span>
<a href="#l64.150"></a><span id="l64.150">                     }</span>
<a href="#l64.151"></a><span id="l64.151">                     return false;</span>
<a href="#l64.152"></a><span id="l64.152">                 },</span>
<a href="#l64.153"></a><span id="l64.153"> </span>
<a href="#l64.154"></a><span id="l64.154" class="difflineminus">-                getNext: function cib_pe_getNext() {</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineplus">+                getNext: function() {</span>
<a href="#l64.156"></a><span id="l64.156">                     if (!this.hasMoreElements()) { // hasMoreElements is called by intention to skip yet deleted properties</span>
<a href="#l64.157"></a><span id="l64.157">                         cal.ASSERT(false, Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l64.158"></a><span id="l64.158">                         throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l64.159"></a><span id="l64.159">                     }</span>
<a href="#l64.160"></a><span id="l64.160">                     let ret = this.mCurrentProp;</span>
<a href="#l64.161"></a><span id="l64.161">                     this.mCurrentProp = null;</span>
<a href="#l64.162"></a><span id="l64.162">                     return ret;</span>
<a href="#l64.163"></a><span id="l64.163">                 }</span>
<a href="#l64.164"></a><span id="l64.164">             };</span>
<a href="#l64.165"></a><span id="l64.165">         } else {</span>
<a href="#l64.166"></a><span id="l64.166">             return this.mProperties.enumerator;</span>
<a href="#l64.167"></a><span id="l64.167">         }</span>
<a href="#l64.168"></a><span id="l64.168">     },</span>
<a href="#l64.169"></a><span id="l64.169"> </span>
<a href="#l64.170"></a><span id="l64.170">     // nsIVariant getProperty(in AString name);</span>
<a href="#l64.171"></a><span id="l64.171" class="difflineminus">-    getProperty: function cIB_getProperty(aName) {</span>
<a href="#l64.172"></a><span id="l64.172" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l64.173"></a><span id="l64.173">         aName = aName.toUpperCase();</span>
<a href="#l64.174"></a><span id="l64.174">         let aValue = this.mProperties.getProperty_(aName);</span>
<a href="#l64.175"></a><span id="l64.175">         if (aValue === undefined) {</span>
<a href="#l64.176"></a><span id="l64.176">             aValue = (this.mIsProxy ? this.mParentItem.getProperty(aName) : null);</span>
<a href="#l64.177"></a><span id="l64.177">         }</span>
<a href="#l64.178"></a><span id="l64.178">         return aValue;</span>
<a href="#l64.179"></a><span id="l64.179">     },</span>
<a href="#l64.180"></a><span id="l64.180"> </span>
<a href="#l64.181"></a><span id="l64.181">     // boolean hasProperty(in AString name);</span>
<a href="#l64.182"></a><span id="l64.182" class="difflineminus">-    hasProperty: function cIB_hasProperty(aName) {</span>
<a href="#l64.183"></a><span id="l64.183" class="difflineplus">+    hasProperty: function(aName) {</span>
<a href="#l64.184"></a><span id="l64.184">         return (this.getProperty(aName.toUpperCase()) != null);</span>
<a href="#l64.185"></a><span id="l64.185">     },</span>
<a href="#l64.186"></a><span id="l64.186"> </span>
<a href="#l64.187"></a><span id="l64.187">     // void setProperty(in AString name, in nsIVariant value);</span>
<a href="#l64.188"></a><span id="l64.188" class="difflineminus">-    setProperty: function cIB_setProperty(aName, aValue) {</span>
<a href="#l64.189"></a><span id="l64.189" class="difflineplus">+    setProperty: function(aName, aValue) {</span>
<a href="#l64.190"></a><span id="l64.190">         this.modify();</span>
<a href="#l64.191"></a><span id="l64.191">         aName = aName.toUpperCase();</span>
<a href="#l64.192"></a><span id="l64.192">         if (aValue || !isNaN(parseInt(aValue, 10))) {</span>
<a href="#l64.193"></a><span id="l64.193">             this.mProperties.setProperty(aName, aValue);</span>
<a href="#l64.194"></a><span id="l64.194">         } else {</span>
<a href="#l64.195"></a><span id="l64.195">             this.deleteProperty(aName);</span>
<a href="#l64.196"></a><span id="l64.196">         }</span>
<a href="#l64.197"></a><span id="l64.197">         if (aName == &quot;LAST-MODIFIED&quot;) {</span>
<a href="#l64.198"></a><span id="l64.198">             // setting LAST-MODIFIED cleans/undirties the item, we use this for preserving DTSTAMP</span>
<a href="#l64.199"></a><span id="l64.199">             this.mDirty = false;</span>
<a href="#l64.200"></a><span id="l64.200">         }</span>
<a href="#l64.201"></a><span id="l64.201">     },</span>
<a href="#l64.202"></a><span id="l64.202"> </span>
<a href="#l64.203"></a><span id="l64.203">     // void deleteProperty(in AString name);</span>
<a href="#l64.204"></a><span id="l64.204" class="difflineminus">-    deleteProperty: function cIB_deleteProperty(aName) {</span>
<a href="#l64.205"></a><span id="l64.205" class="difflineplus">+    deleteProperty: function(aName) {</span>
<a href="#l64.206"></a><span id="l64.206">         this.modify();</span>
<a href="#l64.207"></a><span id="l64.207">         aName = aName.toUpperCase();</span>
<a href="#l64.208"></a><span id="l64.208">         if (this.mIsProxy) {</span>
<a href="#l64.209"></a><span id="l64.209">             // deleting a proxy's property will mark the bag's item as null, so we could</span>
<a href="#l64.210"></a><span id="l64.210">             // distinguish it when enumerating/getting properties from the undefined ones.</span>
<a href="#l64.211"></a><span id="l64.211">             this.mProperties.setProperty(aName, null);</span>
<a href="#l64.212"></a><span id="l64.212">         } else {</span>
<a href="#l64.213"></a><span id="l64.213">             this.mProperties.deleteProperty(aName);</span>
<a href="#l64.214"></a><span id="l64.214">         }</span>
<a href="#l64.215"></a><span id="l64.215">         delete this.mPropertyParams[aName];</span>
<a href="#l64.216"></a><span id="l64.216">     },</span>
<a href="#l64.217"></a><span id="l64.217"> </span>
<a href="#l64.218"></a><span id="l64.218">     // AString getPropertyParameter(in AString aPropertyName,</span>
<a href="#l64.219"></a><span id="l64.219">     //                              in AString aParameterName);</span>
<a href="#l64.220"></a><span id="l64.220" class="difflineminus">-    getPropertyParameter: function cIB_getPropertyParameter(aPropName, aParamName) {</span>
<a href="#l64.221"></a><span id="l64.221" class="difflineplus">+    getPropertyParameter: function(aPropName, aParamName) {</span>
<a href="#l64.222"></a><span id="l64.222">         let propName = aPropName.toUpperCase();</span>
<a href="#l64.223"></a><span id="l64.223">         let paramName = aParamName.toUpperCase();</span>
<a href="#l64.224"></a><span id="l64.224">         if (propName in this.mPropertyParams &amp;&amp; paramName in this.mPropertyParams[propName]) {</span>
<a href="#l64.225"></a><span id="l64.225">             // If the property is not in mPropertyParams, then this just means</span>
<a href="#l64.226"></a><span id="l64.226">             // there are no properties set.</span>
<a href="#l64.227"></a><span id="l64.227">             return this.mPropertyParams[propName][paramName];</span>
<a href="#l64.228"></a><span id="l64.228">         }</span>
<a href="#l64.229"></a><span id="l64.229">         return null;</span>
<a href="#l64.230"></a><span id="l64.230">     },</span>
<a href="#l64.231"></a><span id="l64.231"> </span>
<a href="#l64.232"></a><span id="l64.232">     // boolean hasPropertyParameter(in AString aPropertyName,</span>
<a href="#l64.233"></a><span id="l64.233">     //                              in AString aParameterName);</span>
<a href="#l64.234"></a><span id="l64.234" class="difflineminus">-    hasPropertyParameter: function cIB_hasPropertyParameter(aPropName, aParamName) {</span>
<a href="#l64.235"></a><span id="l64.235" class="difflineplus">+    hasPropertyParameter: function(aPropName, aParamName) {</span>
<a href="#l64.236"></a><span id="l64.236">         let propName = aPropName.toUpperCase();</span>
<a href="#l64.237"></a><span id="l64.237">         let paramName = aParamName.toUpperCase();</span>
<a href="#l64.238"></a><span id="l64.238">         return (propName in this.mPropertyParams) &amp;&amp;</span>
<a href="#l64.239"></a><span id="l64.239">                 (paramName in this.mPropertyParams[propName]);</span>
<a href="#l64.240"></a><span id="l64.240">     },</span>
<a href="#l64.241"></a><span id="l64.241"> </span>
<a href="#l64.242"></a><span id="l64.242">     // void setPropertyParameter(in AString aPropertyName,</span>
<a href="#l64.243"></a><span id="l64.243">     //                           in AString aParameterName,</span>
<a href="#l64.244"></a><span id="l64.244">     //                           in AUTF8String aParameterValue);</span>
<a href="#l64.245"></a><span id="l64.245" class="difflineminus">-    setPropertyParameter: function cIB_setPropertyParameter(aPropName, aParamName, aParamValue) {</span>
<a href="#l64.246"></a><span id="l64.246" class="difflineplus">+    setPropertyParameter: function(aPropName, aParamName, aParamValue) {</span>
<a href="#l64.247"></a><span id="l64.247">         let propName = aPropName.toUpperCase();</span>
<a href="#l64.248"></a><span id="l64.248">         let paramName = aParamName.toUpperCase();</span>
<a href="#l64.249"></a><span id="l64.249">         this.modify();</span>
<a href="#l64.250"></a><span id="l64.250">         if (!(propName in this.mPropertyParams)) {</span>
<a href="#l64.251"></a><span id="l64.251">             if (!this.hasProperty(propName)) {</span>
<a href="#l64.252"></a><span id="l64.252">                 throw &quot;Property &quot; + aPropName + &quot; not set&quot;;</span>
<a href="#l64.253"></a><span id="l64.253">             } else {</span>
<a href="#l64.254"></a><span id="l64.254">                 this.mPropertyParams[propName] = {};</span>
<a href="#l64.255"></a><span id="l64.255" class="difflineat">@@ -476,70 +476,70 @@ calItemBase.prototype = {</span>
<a href="#l64.256"></a><span id="l64.256">             this.mPropertyParams[propName][paramName] = aParamValue;</span>
<a href="#l64.257"></a><span id="l64.257">         } else {</span>
<a href="#l64.258"></a><span id="l64.258">             delete this.mPropertyParams[propName][paramName];</span>
<a href="#l64.259"></a><span id="l64.259">         }</span>
<a href="#l64.260"></a><span id="l64.260">         return aParamValue;</span>
<a href="#l64.261"></a><span id="l64.261">     },</span>
<a href="#l64.262"></a><span id="l64.262"> </span>
<a href="#l64.263"></a><span id="l64.263">     // nsISimpleEnumerator getParameterEnumerator(in AString aPropertyName);</span>
<a href="#l64.264"></a><span id="l64.264" class="difflineminus">-    getParameterEnumerator: function cIB_getParameterEnumerator(aPropName) {</span>
<a href="#l64.265"></a><span id="l64.265" class="difflineplus">+    getParameterEnumerator: function(aPropName) {</span>
<a href="#l64.266"></a><span id="l64.266">         let propName = aPropName.toUpperCase();</span>
<a href="#l64.267"></a><span id="l64.267">         if (!(propName in this.mPropertyParams)) {</span>
<a href="#l64.268"></a><span id="l64.268">             throw &quot;Property &quot; + aPropName + &quot; not set&quot;;</span>
<a href="#l64.269"></a><span id="l64.269">         }</span>
<a href="#l64.270"></a><span id="l64.270">         let parameters = this.mPropertyParams[propName];</span>
<a href="#l64.271"></a><span id="l64.271">         return { // nsISimpleEnumerator</span>
<a href="#l64.272"></a><span id="l64.272">             mParamNames: Object.keys(parameters),</span>
<a href="#l64.273"></a><span id="l64.273" class="difflineminus">-            hasMoreElements: function cIB_gPE_hasMoreElements() {</span>
<a href="#l64.274"></a><span id="l64.274" class="difflineplus">+            hasMoreElements: function() {</span>
<a href="#l64.275"></a><span id="l64.275">                 return (this.mParamNames.length &gt; 0);</span>
<a href="#l64.276"></a><span id="l64.276">             },</span>
<a href="#l64.277"></a><span id="l64.277"> </span>
<a href="#l64.278"></a><span id="l64.278" class="difflineminus">-            getNext: function cIB_gPE_getNext() {</span>
<a href="#l64.279"></a><span id="l64.279" class="difflineplus">+            getNext: function() {</span>
<a href="#l64.280"></a><span id="l64.280">                 let paramName = this.mParamNames.pop();</span>
<a href="#l64.281"></a><span id="l64.281">                 return { // nsIProperty</span>
<a href="#l64.282"></a><span id="l64.282">                     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIProperty]),</span>
<a href="#l64.283"></a><span id="l64.283">                     name: paramName,</span>
<a href="#l64.284"></a><span id="l64.284">                     value: parameters[paramName]</span>
<a href="#l64.285"></a><span id="l64.285">                 };</span>
<a href="#l64.286"></a><span id="l64.286">             }</span>
<a href="#l64.287"></a><span id="l64.287">         };</span>
<a href="#l64.288"></a><span id="l64.288">     },</span>
<a href="#l64.289"></a><span id="l64.289"> </span>
<a href="#l64.290"></a><span id="l64.290">     // void getAttendees(out PRUint32 count,</span>
<a href="#l64.291"></a><span id="l64.291">     //                   [array,size_is(count),retval] out calIAttendee attendees);</span>
<a href="#l64.292"></a><span id="l64.292" class="difflineminus">-    getAttendees: function cIB_getAttendees(countObj) {</span>
<a href="#l64.293"></a><span id="l64.293" class="difflineplus">+    getAttendees: function(countObj) {</span>
<a href="#l64.294"></a><span id="l64.294">         if (!this.mAttendees &amp;&amp; this.mIsProxy) {</span>
<a href="#l64.295"></a><span id="l64.295">             this.mAttendees = this.mParentItem.getAttendees(countObj);</span>
<a href="#l64.296"></a><span id="l64.296">         }</span>
<a href="#l64.297"></a><span id="l64.297">         if (this.mAttendees) {</span>
<a href="#l64.298"></a><span id="l64.298">             countObj.value = this.mAttendees.length;</span>
<a href="#l64.299"></a><span id="l64.299">             return this.mAttendees.concat([]); // clone</span>
<a href="#l64.300"></a><span id="l64.300">         } else {</span>
<a href="#l64.301"></a><span id="l64.301">             countObj.value = 0;</span>
<a href="#l64.302"></a><span id="l64.302">             return [];</span>
<a href="#l64.303"></a><span id="l64.303">         }</span>
<a href="#l64.304"></a><span id="l64.304">     },</span>
<a href="#l64.305"></a><span id="l64.305"> </span>
<a href="#l64.306"></a><span id="l64.306">     // calIAttendee getAttendeeById(in AUTF8String id);</span>
<a href="#l64.307"></a><span id="l64.307" class="difflineminus">-    getAttendeeById: function cIB_getAttendeeById(id) {</span>
<a href="#l64.308"></a><span id="l64.308" class="difflineplus">+    getAttendeeById: function(id) {</span>
<a href="#l64.309"></a><span id="l64.309">         let attendees = this.getAttendees({});</span>
<a href="#l64.310"></a><span id="l64.310">         let lowerCaseId = id.toLowerCase();</span>
<a href="#l64.311"></a><span id="l64.311">         for (let attendee of attendees) {</span>
<a href="#l64.312"></a><span id="l64.312">             // This match must be case insensitive to deal with differing</span>
<a href="#l64.313"></a><span id="l64.313">             // cases of things like MAILTO:</span>
<a href="#l64.314"></a><span id="l64.314">             if (attendee.id.toLowerCase() == lowerCaseId) {</span>
<a href="#l64.315"></a><span id="l64.315">                 return attendee;</span>
<a href="#l64.316"></a><span id="l64.316">             }</span>
<a href="#l64.317"></a><span id="l64.317">         }</span>
<a href="#l64.318"></a><span id="l64.318">         return null;</span>
<a href="#l64.319"></a><span id="l64.319">     },</span>
<a href="#l64.320"></a><span id="l64.320"> </span>
<a href="#l64.321"></a><span id="l64.321">     // void removeAttendee(in calIAttendee attendee);</span>
<a href="#l64.322"></a><span id="l64.322" class="difflineminus">-    removeAttendee: function cIB_removeAttendee(attendee) {</span>
<a href="#l64.323"></a><span id="l64.323" class="difflineplus">+    removeAttendee: function(attendee) {</span>
<a href="#l64.324"></a><span id="l64.324">         this.modify();</span>
<a href="#l64.325"></a><span id="l64.325">         let found = false, newAttendees = [];</span>
<a href="#l64.326"></a><span id="l64.326">         let attendees = this.getAttendees({});</span>
<a href="#l64.327"></a><span id="l64.327">         let attIdLowerCase = attendee.id.toLowerCase();</span>
<a href="#l64.328"></a><span id="l64.328"> </span>
<a href="#l64.329"></a><span id="l64.329">         for (let i = 0; i &lt; attendees.length; i++) {</span>
<a href="#l64.330"></a><span id="l64.330">             if (attendees[i].id.toLowerCase() != attIdLowerCase) {</span>
<a href="#l64.331"></a><span id="l64.331">                 newAttendees.push(attendees[i]);</span>
<a href="#l64.332"></a><span id="l64.332" class="difflineat">@@ -548,23 +548,23 @@ calItemBase.prototype = {</span>
<a href="#l64.333"></a><span id="l64.333">             }</span>
<a href="#l64.334"></a><span id="l64.334">         }</span>
<a href="#l64.335"></a><span id="l64.335">         if (found) {</span>
<a href="#l64.336"></a><span id="l64.336">             this.mAttendees = newAttendees;</span>
<a href="#l64.337"></a><span id="l64.337">         }</span>
<a href="#l64.338"></a><span id="l64.338">     },</span>
<a href="#l64.339"></a><span id="l64.339"> </span>
<a href="#l64.340"></a><span id="l64.340">     // void removeAllAttendees();</span>
<a href="#l64.341"></a><span id="l64.341" class="difflineminus">-    removeAllAttendees: function cIB_removeAllAttendees() {</span>
<a href="#l64.342"></a><span id="l64.342" class="difflineplus">+    removeAllAttendees: function() {</span>
<a href="#l64.343"></a><span id="l64.343">         this.modify();</span>
<a href="#l64.344"></a><span id="l64.344">         this.mAttendees = [];</span>
<a href="#l64.345"></a><span id="l64.345">     },</span>
<a href="#l64.346"></a><span id="l64.346"> </span>
<a href="#l64.347"></a><span id="l64.347">     // void addAttendee(in calIAttendee attendee);</span>
<a href="#l64.348"></a><span id="l64.348" class="difflineminus">-    addAttendee: function cIB_addAttendee(attendee) {</span>
<a href="#l64.349"></a><span id="l64.349" class="difflineplus">+    addAttendee: function(attendee) {</span>
<a href="#l64.350"></a><span id="l64.350">         // the duplicate check is migration code for bug 1204255</span>
<a href="#l64.351"></a><span id="l64.351">         let exists = this.getAttendeeById(attendee.id);</span>
<a href="#l64.352"></a><span id="l64.352">         if (exists) {</span>
<a href="#l64.353"></a><span id="l64.353">             cal.LOG(&quot;Ignoring attendee duplicate for item &quot; + this.id +</span>
<a href="#l64.354"></a><span id="l64.354">                     &quot; (&quot; + this.title + &quot;): &quot; + exists.id);</span>
<a href="#l64.355"></a><span id="l64.355">             if (exists.participationStatus == &quot;NEEDS-ACTION&quot; ||</span>
<a href="#l64.356"></a><span id="l64.356">                 attendee.participationStatus == &quot;DECLINED&quot;) {</span>
<a href="#l64.357"></a><span id="l64.357">                 this.removeAttendee(exists);</span>
<a href="#l64.358"></a><span id="l64.358" class="difflineat">@@ -591,95 +591,95 @@ calItemBase.prototype = {</span>
<a href="#l64.359"></a><span id="l64.359">             this.modify();</span>
<a href="#l64.360"></a><span id="l64.360">             this.mAttendees = this.getAttendees({});</span>
<a href="#l64.361"></a><span id="l64.361">             this.mAttendees.push(attendee);</span>
<a href="#l64.362"></a><span id="l64.362">         }</span>
<a href="#l64.363"></a><span id="l64.363">     },</span>
<a href="#l64.364"></a><span id="l64.364"> </span>
<a href="#l64.365"></a><span id="l64.365">     // void getAttachments(out PRUint32 count,</span>
<a href="#l64.366"></a><span id="l64.366">     //                     [array,size_is(count),retval] out calIAttachment attachments);</span>
<a href="#l64.367"></a><span id="l64.367" class="difflineminus">-    getAttachments: function cIB_getAttachments(aCount) {</span>
<a href="#l64.368"></a><span id="l64.368" class="difflineplus">+    getAttachments: function(aCount) {</span>
<a href="#l64.369"></a><span id="l64.369">         if (!this.mAttachments &amp;&amp; this.mIsProxy) {</span>
<a href="#l64.370"></a><span id="l64.370">             this.mAttachments = this.mParentItem.getAttachments(aCount);</span>
<a href="#l64.371"></a><span id="l64.371">         }</span>
<a href="#l64.372"></a><span id="l64.372">         if (this.mAttachments) {</span>
<a href="#l64.373"></a><span id="l64.373">             aCount.value = this.mAttachments.length;</span>
<a href="#l64.374"></a><span id="l64.374">             return this.mAttachments.concat([]); // clone</span>
<a href="#l64.375"></a><span id="l64.375">         } else {</span>
<a href="#l64.376"></a><span id="l64.376">             aCount.value = 0;</span>
<a href="#l64.377"></a><span id="l64.377">             return [];</span>
<a href="#l64.378"></a><span id="l64.378">         }</span>
<a href="#l64.379"></a><span id="l64.379">     },</span>
<a href="#l64.380"></a><span id="l64.380"> </span>
<a href="#l64.381"></a><span id="l64.381">     // void removeAttachment(in calIAttachment attachment);</span>
<a href="#l64.382"></a><span id="l64.382" class="difflineminus">-    removeAttachment: function cIB_removeAttachment(aAttachment) {</span>
<a href="#l64.383"></a><span id="l64.383" class="difflineplus">+    removeAttachment: function(aAttachment) {</span>
<a href="#l64.384"></a><span id="l64.384">         this.modify();</span>
<a href="#l64.385"></a><span id="l64.385">         for (let attIndex in this.mAttachments) {</span>
<a href="#l64.386"></a><span id="l64.386">             if (cal.compareObjects(this.mAttachments[attIndex], aAttachment, Components.interfaces.calIAttachment)) {</span>
<a href="#l64.387"></a><span id="l64.387">                 this.modify();</span>
<a href="#l64.388"></a><span id="l64.388">                 this.mAttachments.splice(attIndex, 1);</span>
<a href="#l64.389"></a><span id="l64.389">                 break;</span>
<a href="#l64.390"></a><span id="l64.390">             }</span>
<a href="#l64.391"></a><span id="l64.391">         }</span>
<a href="#l64.392"></a><span id="l64.392">     },</span>
<a href="#l64.393"></a><span id="l64.393"> </span>
<a href="#l64.394"></a><span id="l64.394">     // void addAttachment(in calIAttachment attachment);</span>
<a href="#l64.395"></a><span id="l64.395" class="difflineminus">-    addAttachment: function cIB_addAttachment(attachment) {</span>
<a href="#l64.396"></a><span id="l64.396" class="difflineplus">+    addAttachment: function(attachment) {</span>
<a href="#l64.397"></a><span id="l64.397">         this.modify();</span>
<a href="#l64.398"></a><span id="l64.398">         this.mAttachments = this.getAttachments({});</span>
<a href="#l64.399"></a><span id="l64.399">         if (!this.mAttachments.some(x =&gt; x.hashId == attachment.hashId)) {</span>
<a href="#l64.400"></a><span id="l64.400">             this.mAttachments.push(attachment);</span>
<a href="#l64.401"></a><span id="l64.401">         }</span>
<a href="#l64.402"></a><span id="l64.402">     },</span>
<a href="#l64.403"></a><span id="l64.403"> </span>
<a href="#l64.404"></a><span id="l64.404">     // void removeAllAttachments();</span>
<a href="#l64.405"></a><span id="l64.405" class="difflineminus">-    removeAllAttachments: function cIB_removeAllAttachments() {</span>
<a href="#l64.406"></a><span id="l64.406" class="difflineplus">+    removeAllAttachments: function() {</span>
<a href="#l64.407"></a><span id="l64.407">         this.modify();</span>
<a href="#l64.408"></a><span id="l64.408">         this.mAttachments = [];</span>
<a href="#l64.409"></a><span id="l64.409">     },</span>
<a href="#l64.410"></a><span id="l64.410"> </span>
<a href="#l64.411"></a><span id="l64.411">     // void getRelations(out PRUint32 count,</span>
<a href="#l64.412"></a><span id="l64.412">     //                   [array,size_is(count),retval] out calIRelation relations);</span>
<a href="#l64.413"></a><span id="l64.413" class="difflineminus">-    getRelations: function cIB_getRelations(aCount) {</span>
<a href="#l64.414"></a><span id="l64.414" class="difflineplus">+    getRelations: function(aCount) {</span>
<a href="#l64.415"></a><span id="l64.415">         if (!this.mRelations &amp;&amp; this.mIsProxy) {</span>
<a href="#l64.416"></a><span id="l64.416">             this.mRelations = this.mParentItem.getRelations(aCount);</span>
<a href="#l64.417"></a><span id="l64.417">         }</span>
<a href="#l64.418"></a><span id="l64.418">         if (this.mRelations) {</span>
<a href="#l64.419"></a><span id="l64.419">             aCount.value = this.mRelations.length;</span>
<a href="#l64.420"></a><span id="l64.420">             return this.mRelations.concat([]);</span>
<a href="#l64.421"></a><span id="l64.421">         } else {</span>
<a href="#l64.422"></a><span id="l64.422">             aCount.value = 0;</span>
<a href="#l64.423"></a><span id="l64.423">             return [];</span>
<a href="#l64.424"></a><span id="l64.424">         }</span>
<a href="#l64.425"></a><span id="l64.425">     },</span>
<a href="#l64.426"></a><span id="l64.426"> </span>
<a href="#l64.427"></a><span id="l64.427">     // void removeRelation(in calIRelation relation);</span>
<a href="#l64.428"></a><span id="l64.428" class="difflineminus">-    removeRelation: function cIB_removeRelation(aRelation) {</span>
<a href="#l64.429"></a><span id="l64.429" class="difflineplus">+    removeRelation: function(aRelation) {</span>
<a href="#l64.430"></a><span id="l64.430">         this.modify();</span>
<a href="#l64.431"></a><span id="l64.431">         for (let attIndex in this.mRelations) {</span>
<a href="#l64.432"></a><span id="l64.432">             // Could we have the same item as parent and as child ?</span>
<a href="#l64.433"></a><span id="l64.433">             if (this.mRelations[attIndex].relId == aRelation.relId &amp;&amp;</span>
<a href="#l64.434"></a><span id="l64.434">                 this.mRelations[attIndex].relType == aRelation.relType) {</span>
<a href="#l64.435"></a><span id="l64.435">                 this.modify();</span>
<a href="#l64.436"></a><span id="l64.436">                 this.mRelations.splice(attIndex, 1);</span>
<a href="#l64.437"></a><span id="l64.437">                 break;</span>
<a href="#l64.438"></a><span id="l64.438">             }</span>
<a href="#l64.439"></a><span id="l64.439">         }</span>
<a href="#l64.440"></a><span id="l64.440">     },</span>
<a href="#l64.441"></a><span id="l64.441"> </span>
<a href="#l64.442"></a><span id="l64.442">     // void addRelation(in calIRelation relation);</span>
<a href="#l64.443"></a><span id="l64.443" class="difflineminus">-    addRelation: function cIB_addRelation(aRelation) {</span>
<a href="#l64.444"></a><span id="l64.444" class="difflineplus">+    addRelation: function(aRelation) {</span>
<a href="#l64.445"></a><span id="l64.445">         this.modify();</span>
<a href="#l64.446"></a><span id="l64.446">         this.mRelations = this.getRelations({});</span>
<a href="#l64.447"></a><span id="l64.447">         this.mRelations.push(aRelation);</span>
<a href="#l64.448"></a><span id="l64.448">         // XXX ensure that the relation isn't already there?</span>
<a href="#l64.449"></a><span id="l64.449">     },</span>
<a href="#l64.450"></a><span id="l64.450"> </span>
<a href="#l64.451"></a><span id="l64.451">     // void removeAllRelations();</span>
<a href="#l64.452"></a><span id="l64.452" class="difflineminus">-    removeAllRelations: function cIB_removeAllRelations() {</span>
<a href="#l64.453"></a><span id="l64.453" class="difflineplus">+    removeAllRelations: function() {</span>
<a href="#l64.454"></a><span id="l64.454">         this.modify();</span>
<a href="#l64.455"></a><span id="l64.455">         this.mRelations = [];</span>
<a href="#l64.456"></a><span id="l64.456">     },</span>
<a href="#l64.457"></a><span id="l64.457"> </span>
<a href="#l64.458"></a><span id="l64.458">     // attribute calICalendar calendar;</span>
<a href="#l64.459"></a><span id="l64.459">     get calendar() {</span>
<a href="#l64.460"></a><span id="l64.460">         if (!this.mCalendar &amp;&amp; (this.parentItem != this)) {</span>
<a href="#l64.461"></a><span id="l64.461">             return this.parentItem.calendar;</span>
<a href="#l64.462"></a><span id="l64.462" class="difflineat">@@ -705,32 +705,32 @@ calItemBase.prototype = {</span>
<a href="#l64.463"></a><span id="l64.463">     },</span>
<a href="#l64.464"></a><span id="l64.464">     set organizer(v) {</span>
<a href="#l64.465"></a><span id="l64.465">         this.modify();</span>
<a href="#l64.466"></a><span id="l64.466">         this.mOrganizer = v;</span>
<a href="#l64.467"></a><span id="l64.467">     },</span>
<a href="#l64.468"></a><span id="l64.468"> </span>
<a href="#l64.469"></a><span id="l64.469">     // void getCategories(out PRUint32 aCount,</span>
<a href="#l64.470"></a><span id="l64.470">     //                    [array, size_is(aCount), retval] out wstring aCategories);</span>
<a href="#l64.471"></a><span id="l64.471" class="difflineminus">-    getCategories: function cib_getCategories(aCount) {</span>
<a href="#l64.472"></a><span id="l64.472" class="difflineplus">+    getCategories: function(aCount) {</span>
<a href="#l64.473"></a><span id="l64.473">         if (!this.mCategories &amp;&amp; this.mIsProxy) {</span>
<a href="#l64.474"></a><span id="l64.474">             this.mCategories = this.mParentItem.getCategories(aCount);</span>
<a href="#l64.475"></a><span id="l64.475">         }</span>
<a href="#l64.476"></a><span id="l64.476">         if (this.mCategories) {</span>
<a href="#l64.477"></a><span id="l64.477">             aCount.value = this.mCategories.length;</span>
<a href="#l64.478"></a><span id="l64.478">             return this.mCategories.concat([]); // clone</span>
<a href="#l64.479"></a><span id="l64.479">         } else {</span>
<a href="#l64.480"></a><span id="l64.480">             aCount.value = 0;</span>
<a href="#l64.481"></a><span id="l64.481">             return [];</span>
<a href="#l64.482"></a><span id="l64.482">         }</span>
<a href="#l64.483"></a><span id="l64.483">     },</span>
<a href="#l64.484"></a><span id="l64.484"> </span>
<a href="#l64.485"></a><span id="l64.485">     // void setCategories(in PRUint32 aCount,</span>
<a href="#l64.486"></a><span id="l64.486">     //                    [array, size_is(aCount)] in wstring aCategories);</span>
<a href="#l64.487"></a><span id="l64.487" class="difflineminus">-    setCategories: function cib_setCategories(aCount, aCategories) {</span>
<a href="#l64.488"></a><span id="l64.488" class="difflineplus">+    setCategories: function(aCount, aCategories) {</span>
<a href="#l64.489"></a><span id="l64.489">         this.modify();</span>
<a href="#l64.490"></a><span id="l64.490">         this.mCategories = aCategories.concat([]);</span>
<a href="#l64.491"></a><span id="l64.491">     },</span>
<a href="#l64.492"></a><span id="l64.492"> </span>
<a href="#l64.493"></a><span id="l64.493">     // attribute AUTF8String icalString;</span>
<a href="#l64.494"></a><span id="l64.494">     get icalString() {</span>
<a href="#l64.495"></a><span id="l64.495">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l64.496"></a><span id="l64.496">     },</span>
<a href="#l64.497"></a><span id="l64.497" class="difflineat">@@ -782,17 +782,17 @@ calItemBase.prototype = {</span>
<a href="#l64.498"></a><span id="l64.498"> </span>
<a href="#l64.499"></a><span id="l64.499">     /**</span>
<a href="#l64.500"></a><span id="l64.500">      * Walks through the propmap and sets all properties on this item from the</span>
<a href="#l64.501"></a><span id="l64.501">      * given icalcomp.</span>
<a href="#l64.502"></a><span id="l64.502">      *</span>
<a href="#l64.503"></a><span id="l64.503">      * @param icalcomp      The calIIcalComponent to read from.</span>
<a href="#l64.504"></a><span id="l64.504">      * @param propmap       The property map to walk through.</span>
<a href="#l64.505"></a><span id="l64.505">      */</span>
<a href="#l64.506"></a><span id="l64.506" class="difflineminus">-    mapPropsFromICS: function cIB_mapPropsFromICS(icalcomp, propmap) {</span>
<a href="#l64.507"></a><span id="l64.507" class="difflineplus">+    mapPropsFromICS: function(icalcomp, propmap) {</span>
<a href="#l64.508"></a><span id="l64.508">         for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l64.509"></a><span id="l64.509">             let prop = propmap[i];</span>
<a href="#l64.510"></a><span id="l64.510">             let val = icalcomp[prop.ics];</span>
<a href="#l64.511"></a><span id="l64.511">             if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l64.512"></a><span id="l64.512">                 this.setProperty(prop.cal, val);</span>
<a href="#l64.513"></a><span id="l64.513">             }</span>
<a href="#l64.514"></a><span id="l64.514">         }</span>
<a href="#l64.515"></a><span id="l64.515">     },</span>
<a href="#l64.516"></a><span id="l64.516" class="difflineat">@@ -800,34 +800,34 @@ calItemBase.prototype = {</span>
<a href="#l64.517"></a><span id="l64.517">     /**</span>
<a href="#l64.518"></a><span id="l64.518">      * Walks through the propmap and sets all properties on the given icalcomp</span>
<a href="#l64.519"></a><span id="l64.519">      * from the properties set on this item.</span>
<a href="#l64.520"></a><span id="l64.520">      * given icalcomp.</span>
<a href="#l64.521"></a><span id="l64.521">      *</span>
<a href="#l64.522"></a><span id="l64.522">      * @param icalcomp      The calIIcalComponent to write to.</span>
<a href="#l64.523"></a><span id="l64.523">      * @param propmap       The property map to walk through.</span>
<a href="#l64.524"></a><span id="l64.524">      */</span>
<a href="#l64.525"></a><span id="l64.525" class="difflineminus">-    mapPropsToICS: function cIB_mapPropsToICS(icalcomp, propmap) {</span>
<a href="#l64.526"></a><span id="l64.526" class="difflineplus">+    mapPropsToICS: function(icalcomp, propmap) {</span>
<a href="#l64.527"></a><span id="l64.527">         for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l64.528"></a><span id="l64.528">             let prop = propmap[i];</span>
<a href="#l64.529"></a><span id="l64.529">             let val = this.getProperty(prop.cal);</span>
<a href="#l64.530"></a><span id="l64.530">             if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l64.531"></a><span id="l64.531">                 icalcomp[prop.ics] = val;</span>
<a href="#l64.532"></a><span id="l64.532">             }</span>
<a href="#l64.533"></a><span id="l64.533">         }</span>
<a href="#l64.534"></a><span id="l64.534">     },</span>
<a href="#l64.535"></a><span id="l64.535"> </span>
<a href="#l64.536"></a><span id="l64.536"> </span>
<a href="#l64.537"></a><span id="l64.537">     /**</span>
<a href="#l64.538"></a><span id="l64.538">      * Reads an ical component and sets up the base item's properties to match</span>
<a href="#l64.539"></a><span id="l64.539">      * it.</span>
<a href="#l64.540"></a><span id="l64.540">      *</span>
<a href="#l64.541"></a><span id="l64.541">      * @param icalcomp      The ical component to read.</span>
<a href="#l64.542"></a><span id="l64.542">      */</span>
<a href="#l64.543"></a><span id="l64.543" class="difflineminus">-    setItemBaseFromICS: function cIB_setItemBaseFromICS(icalcomp) {</span>
<a href="#l64.544"></a><span id="l64.544" class="difflineplus">+    setItemBaseFromICS: function(icalcomp) {</span>
<a href="#l64.545"></a><span id="l64.545">         this.modify();</span>
<a href="#l64.546"></a><span id="l64.546"> </span>
<a href="#l64.547"></a><span id="l64.547">         // re-initializing from scratch -- no light proxy anymore:</span>
<a href="#l64.548"></a><span id="l64.548">         this.mIsProxy = false;</span>
<a href="#l64.549"></a><span id="l64.549">         this.mProperties = new calPropertyBag();</span>
<a href="#l64.550"></a><span id="l64.550">         this.mPropertyParams = {};</span>
<a href="#l64.551"></a><span id="l64.551"> </span>
<a href="#l64.552"></a><span id="l64.552">         this.mapPropsFromICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l64.553"></a><span id="l64.553" class="difflineat">@@ -919,33 +919,33 @@ calItemBase.prototype = {</span>
<a href="#l64.554"></a><span id="l64.554"> </span>
<a href="#l64.555"></a><span id="l64.555">     /**</span>
<a href="#l64.556"></a><span id="l64.556">      * Import all properties not in the promoted map into this item's extended</span>
<a href="#l64.557"></a><span id="l64.557">      * properties bag.</span>
<a href="#l64.558"></a><span id="l64.558">      *</span>
<a href="#l64.559"></a><span id="l64.559">      * @param icalcomp      The ical component to read.</span>
<a href="#l64.560"></a><span id="l64.560">      * @param promoted      The map of promoted properties.</span>
<a href="#l64.561"></a><span id="l64.561">      */</span>
<a href="#l64.562"></a><span id="l64.562" class="difflineminus">-    importUnpromotedProperties: function cIB_importUnpromotedProperties(icalcomp, promoted) {</span>
<a href="#l64.563"></a><span id="l64.563" class="difflineplus">+    importUnpromotedProperties: function(icalcomp, promoted) {</span>
<a href="#l64.564"></a><span id="l64.564">         for (let prop of cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l64.565"></a><span id="l64.565">             let propName = prop.propertyName;</span>
<a href="#l64.566"></a><span id="l64.566">             if (!promoted[propName]) {</span>
<a href="#l64.567"></a><span id="l64.567">                 this.setProperty(propName, prop.value);</span>
<a href="#l64.568"></a><span id="l64.568">                 for (let [paramName, paramValue] of cal.ical.paramIterator(prop)) {</span>
<a href="#l64.569"></a><span id="l64.569">                     if (!(propName in this.mPropertyParams)) {</span>
<a href="#l64.570"></a><span id="l64.570">                         this.mPropertyParams[propName] = {};</span>
<a href="#l64.571"></a><span id="l64.571">                     }</span>
<a href="#l64.572"></a><span id="l64.572">                     this.mPropertyParams[propName][paramName] = paramValue;</span>
<a href="#l64.573"></a><span id="l64.573">                 }</span>
<a href="#l64.574"></a><span id="l64.574">             }</span>
<a href="#l64.575"></a><span id="l64.575">         }</span>
<a href="#l64.576"></a><span id="l64.576">     },</span>
<a href="#l64.577"></a><span id="l64.577"> </span>
<a href="#l64.578"></a><span id="l64.578">     // boolean isPropertyPromoted(in AString name);</span>
<a href="#l64.579"></a><span id="l64.579" class="difflineminus">-    isPropertyPromoted: function cIB_isPropertyPromoted(name) {</span>
<a href="#l64.580"></a><span id="l64.580" class="difflineplus">+    isPropertyPromoted: function(name) {</span>
<a href="#l64.581"></a><span id="l64.581">         return this.itemBasePromotedProps[name.toUpperCase()];</span>
<a href="#l64.582"></a><span id="l64.582">     },</span>
<a href="#l64.583"></a><span id="l64.583"> </span>
<a href="#l64.584"></a><span id="l64.584">     // attribute calIIcalComponent icalComponent;</span>
<a href="#l64.585"></a><span id="l64.585">     get icalComponent() {</span>
<a href="#l64.586"></a><span id="l64.586">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l64.587"></a><span id="l64.587">     },</span>
<a href="#l64.588"></a><span id="l64.588">     set icalComponent(val) {</span>
<a href="#l64.589"></a><span id="l64.589" class="difflineat">@@ -961,17 +961,17 @@ calItemBase.prototype = {</span>
<a href="#l64.590"></a><span id="l64.590">         return this.setProperty(&quot;X-MOZ-GENERATION&quot;, String(aValue));</span>
<a href="#l64.591"></a><span id="l64.591">     },</span>
<a href="#l64.592"></a><span id="l64.592"> </span>
<a href="#l64.593"></a><span id="l64.593">     /**</span>
<a href="#l64.594"></a><span id="l64.594">      * Fills the passed ical component with the base item's properties.</span>
<a href="#l64.595"></a><span id="l64.595">      *</span>
<a href="#l64.596"></a><span id="l64.596">      * @param icalcomp    The ical component to write to.</span>
<a href="#l64.597"></a><span id="l64.597">      */</span>
<a href="#l64.598"></a><span id="l64.598" class="difflineminus">-    fillIcalComponentFromBase: function cIB_fillIcalComponentFromBase(icalcomp) {</span>
<a href="#l64.599"></a><span id="l64.599" class="difflineplus">+    fillIcalComponentFromBase: function(icalcomp) {</span>
<a href="#l64.600"></a><span id="l64.600">         this.ensureNotDirty();</span>
<a href="#l64.601"></a><span id="l64.601">         let icssvc = cal.getIcsService();</span>
<a href="#l64.602"></a><span id="l64.602"> </span>
<a href="#l64.603"></a><span id="l64.603">         this.mapPropsToICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l64.604"></a><span id="l64.604"> </span>
<a href="#l64.605"></a><span id="l64.605">         let org = this.organizer;</span>
<a href="#l64.606"></a><span id="l64.606">         if (org) {</span>
<a href="#l64.607"></a><span id="l64.607">             icalcomp.addProperty(org.icalProperty);</span>
<a href="#l64.608"></a><span id="l64.608" class="difflineat">@@ -1012,17 +1012,17 @@ calItemBase.prototype = {</span>
<a href="#l64.609"></a><span id="l64.609">             let lastAck = cal.getIcsService().createIcalProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l64.610"></a><span id="l64.610">             // - should we further ensure that those are UTC or rely on calAlarmService doing so?</span>
<a href="#l64.611"></a><span id="l64.611">             lastAck.value = alarmLastAck.icalString;</span>
<a href="#l64.612"></a><span id="l64.612">             icalcomp.addProperty(lastAck);</span>
<a href="#l64.613"></a><span id="l64.613">         }</span>
<a href="#l64.614"></a><span id="l64.614">     },</span>
<a href="#l64.615"></a><span id="l64.615"> </span>
<a href="#l64.616"></a><span id="l64.616">     // void getAlarms(out PRUint32 count, [array, size_is(count), retval] out calIAlarm aAlarms);</span>
<a href="#l64.617"></a><span id="l64.617" class="difflineminus">-    getAlarms: function cIB_getAlarms(aCount) {</span>
<a href="#l64.618"></a><span id="l64.618" class="difflineplus">+    getAlarms: function(aCount) {</span>
<a href="#l64.619"></a><span id="l64.619">         if (typeof aCount != &quot;object&quot;) {</span>
<a href="#l64.620"></a><span id="l64.620">             throw Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT;</span>
<a href="#l64.621"></a><span id="l64.621">         }</span>
<a href="#l64.622"></a><span id="l64.622"> </span>
<a href="#l64.623"></a><span id="l64.623">         if (!this.mAlarms &amp;&amp; this.mIsProxy) {</span>
<a href="#l64.624"></a><span id="l64.624">             this.mAlarms = this.mParentItem.getAlarms(aCount);</span>
<a href="#l64.625"></a><span id="l64.625">         }</span>
<a href="#l64.626"></a><span id="l64.626">         if (this.mAlarms) {</span>
<a href="#l64.627"></a><span id="l64.627" class="difflineat">@@ -1037,53 +1037,53 @@ calItemBase.prototype = {</span>
<a href="#l64.628"></a><span id="l64.628">     /**</span>
<a href="#l64.629"></a><span id="l64.629">      * Adds an alarm. The second parameter is for internal use only, i.e not</span>
<a href="#l64.630"></a><span id="l64.630">      * provided on the interface.</span>
<a href="#l64.631"></a><span id="l64.631">      *</span>
<a href="#l64.632"></a><span id="l64.632">      * @see calIItemBase</span>
<a href="#l64.633"></a><span id="l64.633">      * @param aDoNotValidate    Don't serialize the component to check for</span>
<a href="#l64.634"></a><span id="l64.634">      *                            errors.</span>
<a href="#l64.635"></a><span id="l64.635">      */</span>
<a href="#l64.636"></a><span id="l64.636" class="difflineminus">-    addAlarm: function cIB_addAlarm(aAlarm, aDoNotValidate) {</span>
<a href="#l64.637"></a><span id="l64.637" class="difflineplus">+    addAlarm: function(aAlarm, aDoNotValidate) {</span>
<a href="#l64.638"></a><span id="l64.638">         if (!aDoNotValidate) {</span>
<a href="#l64.639"></a><span id="l64.639">             try {</span>
<a href="#l64.640"></a><span id="l64.640">                 // Trigger the icalComponent getter to make sure the alarm is valid.</span>
<a href="#l64.641"></a><span id="l64.641">                 aAlarm.icalComponent; // eslint-disable-line no-unused-expressions</span>
<a href="#l64.642"></a><span id="l64.642">             } catch (e) {</span>
<a href="#l64.643"></a><span id="l64.643">                 throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l64.644"></a><span id="l64.644">             }</span>
<a href="#l64.645"></a><span id="l64.645">         }</span>
<a href="#l64.646"></a><span id="l64.646"> </span>
<a href="#l64.647"></a><span id="l64.647">         this.modify();</span>
<a href="#l64.648"></a><span id="l64.648">         this.mAlarms = this.getAlarms({});</span>
<a href="#l64.649"></a><span id="l64.649">         this.mAlarms.push(aAlarm);</span>
<a href="#l64.650"></a><span id="l64.650">     },</span>
<a href="#l64.651"></a><span id="l64.651"> </span>
<a href="#l64.652"></a><span id="l64.652">     // void deleteAlarm(in calIAlarm aAlarm);</span>
<a href="#l64.653"></a><span id="l64.653" class="difflineminus">-    deleteAlarm: function cIB_deleteAlarm(aAlarm) {</span>
<a href="#l64.654"></a><span id="l64.654" class="difflineplus">+    deleteAlarm: function(aAlarm) {</span>
<a href="#l64.655"></a><span id="l64.655">         this.modify();</span>
<a href="#l64.656"></a><span id="l64.656">         this.mAlarms = this.getAlarms({});</span>
<a href="#l64.657"></a><span id="l64.657">         for (let i = 0; i &lt; this.mAlarms.length; i++) {</span>
<a href="#l64.658"></a><span id="l64.658">             if (cal.compareObjects(this.mAlarms[i], aAlarm, Components.interfaces.calIAlarm)) {</span>
<a href="#l64.659"></a><span id="l64.659">                 this.mAlarms.splice(i, 1);</span>
<a href="#l64.660"></a><span id="l64.660">                 break;</span>
<a href="#l64.661"></a><span id="l64.661">             }</span>
<a href="#l64.662"></a><span id="l64.662">         }</span>
<a href="#l64.663"></a><span id="l64.663">     },</span>
<a href="#l64.664"></a><span id="l64.664"> </span>
<a href="#l64.665"></a><span id="l64.665">     // void clearAlarms();</span>
<a href="#l64.666"></a><span id="l64.666" class="difflineminus">-    clearAlarms: function cIB_clearAlarms() {</span>
<a href="#l64.667"></a><span id="l64.667" class="difflineplus">+    clearAlarms: function() {</span>
<a href="#l64.668"></a><span id="l64.668">         this.modify();</span>
<a href="#l64.669"></a><span id="l64.669">         this.mAlarms = [];</span>
<a href="#l64.670"></a><span id="l64.670">     },</span>
<a href="#l64.671"></a><span id="l64.671"> </span>
<a href="#l64.672"></a><span id="l64.672">     // void getOccurrencesBetween (in calIDateTime aStartDate, in calIDateTime aEndDate,</span>
<a href="#l64.673"></a><span id="l64.673">     //                             out PRUint32 aCount,</span>
<a href="#l64.674"></a><span id="l64.674">     //                             [array,size_is(aCount),retval] out calIItemBase aOccurrences);</span>
<a href="#l64.675"></a><span id="l64.675" class="difflineminus">-    getOccurrencesBetween: function cIB_getOccurrencesBetween(aStartDate, aEndDate, aCount) {</span>
<a href="#l64.676"></a><span id="l64.676" class="difflineplus">+    getOccurrencesBetween: function(aStartDate, aEndDate, aCount) {</span>
<a href="#l64.677"></a><span id="l64.677">         if (this.recurrenceInfo) {</span>
<a href="#l64.678"></a><span id="l64.678">             return this.recurrenceInfo.getOccurrences(aStartDate, aEndDate, 0, aCount);</span>
<a href="#l64.679"></a><span id="l64.679">         }</span>
<a href="#l64.680"></a><span id="l64.680"> </span>
<a href="#l64.681"></a><span id="l64.681">         if (checkIfInRange(this, aStartDate, aEndDate)) {</span>
<a href="#l64.682"></a><span id="l64.682">             aCount.value = 1;</span>
<a href="#l64.683"></a><span id="l64.683">             return [this];</span>
<a href="#l64.684"></a><span id="l64.684">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -84,17 +84,17 @@ calItipItem.prototype = {</span>
<a href="#l65.4"></a><span id="l65.4">         return this.mLocalStatus;</span>
<a href="#l65.5"></a><span id="l65.5">     },</span>
<a href="#l65.6"></a><span id="l65.6">     set localStatus(aValue) {</span>
<a href="#l65.7"></a><span id="l65.7">         return (this.mLocalStatus = aValue);</span>
<a href="#l65.8"></a><span id="l65.8">      },</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10">     mItemList: {},</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-    init: function ciiI(aIcalString) {</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+    init: function(aIcalString) {</span>
<a href="#l65.14"></a><span id="l65.14">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l65.15"></a><span id="l65.15">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l65.16"></a><span id="l65.16">         parser.parseString(aIcalString, null);</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18">         // - User specific alarms as well as X-MOZ- properties are irrelevant w.r.t. iTIP messages,</span>
<a href="#l65.19"></a><span id="l65.19">         //   should not be sent out and should not be relevant for incoming messages</span>
<a href="#l65.20"></a><span id="l65.20">         // - faked master items</span>
<a href="#l65.21"></a><span id="l65.21">         // so clean them out:</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -151,17 +151,17 @@ calItipItem.prototype = {</span>
<a href="#l65.23"></a><span id="l65.23">                 this.mResponseMethod = prop.value;</span>
<a href="#l65.24"></a><span id="l65.24">                 break;</span>
<a href="#l65.25"></a><span id="l65.25">             }</span>
<a href="#l65.26"></a><span id="l65.26">         }</span>
<a href="#l65.27"></a><span id="l65.27"> </span>
<a href="#l65.28"></a><span id="l65.28">         this.mIsInitialized = true;</span>
<a href="#l65.29"></a><span id="l65.29">     },</span>
<a href="#l65.30"></a><span id="l65.30"> </span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-    clone: function ciiC() {</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+    clone: function() {</span>
<a href="#l65.33"></a><span id="l65.33">         let newItem = new calItipItem();</span>
<a href="#l65.34"></a><span id="l65.34">         newItem.mItemList = this.mItemList.map(function(item) { return item.clone(); });</span>
<a href="#l65.35"></a><span id="l65.35">         newItem.mReceivedMethod = this.mReceivedMethod;</span>
<a href="#l65.36"></a><span id="l65.36">         newItem.mResponseMethod = this.mResponseMethod;</span>
<a href="#l65.37"></a><span id="l65.37">         newItem.mAutoResponse = this.mAutoResponse;</span>
<a href="#l65.38"></a><span id="l65.38">         newItem.mTargetCalendar = this.mTargetCalendar;</span>
<a href="#l65.39"></a><span id="l65.39">         newItem.mIdentity = this.mIdentity;</span>
<a href="#l65.40"></a><span id="l65.40">         newItem.mLocalStatus = this.mLocalStatus;</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineat">@@ -169,29 +169,29 @@ calItipItem.prototype = {</span>
<a href="#l65.42"></a><span id="l65.42">         newItem.mIsInitialized = this.mIsInitialized;</span>
<a href="#l65.43"></a><span id="l65.43">         return newItem;</span>
<a href="#l65.44"></a><span id="l65.44">     },</span>
<a href="#l65.45"></a><span id="l65.45"> </span>
<a href="#l65.46"></a><span id="l65.46">     /**</span>
<a href="#l65.47"></a><span id="l65.47">      * This returns both the array and the number of items. An easy way to</span>
<a href="#l65.48"></a><span id="l65.48">      * call it is: let itemArray = itipItem.getItemList({ });</span>
<a href="#l65.49"></a><span id="l65.49">      */</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineminus">-    getItemList: function ciiGIL(itemCountRef) {</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+    getItemList: function(itemCountRef) {</span>
<a href="#l65.52"></a><span id="l65.52">         if (!this.mIsInitialized) {</span>
<a href="#l65.53"></a><span id="l65.53">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l65.54"></a><span id="l65.54">         }</span>
<a href="#l65.55"></a><span id="l65.55">         itemCountRef.value = this.mItemList.length;</span>
<a href="#l65.56"></a><span id="l65.56">         return this.mItemList;</span>
<a href="#l65.57"></a><span id="l65.57">     },</span>
<a href="#l65.58"></a><span id="l65.58"> </span>
<a href="#l65.59"></a><span id="l65.59">     /**</span>
<a href="#l65.60"></a><span id="l65.60">      * Note that this code forces the user to respond to all items in the same</span>
<a href="#l65.61"></a><span id="l65.61">      * way, which is a current limitation of the spec.</span>
<a href="#l65.62"></a><span id="l65.62">      */</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineminus">-    setAttendeeStatus: function ciiSAS(aAttendeeId, aStatus) {</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+    setAttendeeStatus: function(aAttendeeId, aStatus) {</span>
<a href="#l65.65"></a><span id="l65.65">         // Append &quot;mailto:&quot; to the attendee if it is missing it.</span>
<a href="#l65.66"></a><span id="l65.66">         if (!aAttendeeId.match(/^mailto:/i)) {</span>
<a href="#l65.67"></a><span id="l65.67">             aAttendeeId = &quot;mailto:&quot; + aAttendeeId;</span>
<a href="#l65.68"></a><span id="l65.68">         }</span>
<a href="#l65.69"></a><span id="l65.69"> </span>
<a href="#l65.70"></a><span id="l65.70">         for (let item of this.mItemList) {</span>
<a href="#l65.71"></a><span id="l65.71">             let attendee = item.getAttendeeById(aAttendeeId);</span>
<a href="#l65.72"></a><span id="l65.72">             if (attendee) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/base/src/calProtocolHandler.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/base/src/calProtocolHandler.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -25,29 +25,29 @@ function calProtocolHandler(scheme) {</span>
<a href="#l66.4"></a><span id="l66.4">     this.mHttpProtocol = Services.io.getProtocolHandler(this.scheme == &quot;webcal&quot; ? &quot;http&quot; : &quot;https&quot;);</span>
<a href="#l66.5"></a><span id="l66.5">     this.wrappedJSObject = this;</span>
<a href="#l66.6"></a><span id="l66.6"> }</span>
<a href="#l66.7"></a><span id="l66.7"> </span>
<a href="#l66.8"></a><span id="l66.8"> calProtocolHandler.prototype = {</span>
<a href="#l66.9"></a><span id="l66.9">     get defaultPort() { return this.mHttpProtocol.defaultPort; },</span>
<a href="#l66.10"></a><span id="l66.10">     get protocolFlags() { return this.mHttpProtocol.protocolFlags; },</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-    newURI: function cph_newURI(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+    newURI: function(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l66.14"></a><span id="l66.14">         let uri = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;]</span>
<a href="#l66.15"></a><span id="l66.15">                             .createInstance(Components.interfaces.nsIStandardURL);</span>
<a href="#l66.16"></a><span id="l66.16">         uri.init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l66.17"></a><span id="l66.17">                  this.mHttpProtocol.defaultPort, aSpec, anOriginalCharset, aBaseURI);</span>
<a href="#l66.18"></a><span id="l66.18">         return uri;</span>
<a href="#l66.19"></a><span id="l66.19">     },</span>
<a href="#l66.20"></a><span id="l66.20"> </span>
<a href="#l66.21"></a><span id="l66.21" class="difflineminus">-    newChannel: function cph_newChannel(aUri) {</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineplus">+    newChannel: function(aUri) {</span>
<a href="#l66.23"></a><span id="l66.23">       return this.newChannel2(aUri, null);</span>
<a href="#l66.24"></a><span id="l66.24">     },</span>
<a href="#l66.25"></a><span id="l66.25"> </span>
<a href="#l66.26"></a><span id="l66.26" class="difflineminus">-    newChannel2: function cph_newChannel2(aUri, aLoadInfo) {</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+    newChannel2: function(aUri, aLoadInfo) {</span>
<a href="#l66.28"></a><span id="l66.28">         // make sure to clone the uri, because we are about to change</span>
<a href="#l66.29"></a><span id="l66.29">         // it, and we don't want to change the original uri.</span>
<a href="#l66.30"></a><span id="l66.30">         let uri = aUri.clone();</span>
<a href="#l66.31"></a><span id="l66.31">         uri.scheme = this.mHttpProtocol.scheme;</span>
<a href="#l66.32"></a><span id="l66.32"> </span>
<a href="#l66.33"></a><span id="l66.33">         let channel;</span>
<a href="#l66.34"></a><span id="l66.34">         if (aLoadInfo) {</span>
<a href="#l66.35"></a><span id="l66.35">             channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineat">@@ -59,17 +59,17 @@ calProtocolHandler.prototype = {</span>
<a href="#l66.37"></a><span id="l66.37">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l66.38"></a><span id="l66.38">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l66.39"></a><span id="l66.39">         }</span>
<a href="#l66.40"></a><span id="l66.40">         channel.originalURI = aUri;</span>
<a href="#l66.41"></a><span id="l66.41">         return channel;</span>
<a href="#l66.42"></a><span id="l66.42">     },</span>
<a href="#l66.43"></a><span id="l66.43"> </span>
<a href="#l66.44"></a><span id="l66.44">     // We are not overriding any special ports</span>
<a href="#l66.45"></a><span id="l66.45" class="difflineminus">-    allowPort: function cph_allowPort(aPort, aScheme) { return false; }</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineplus">+    allowPort: function(aPort, aScheme) { return false; }</span>
<a href="#l66.47"></a><span id="l66.47"> };</span>
<a href="#l66.48"></a><span id="l66.48"> </span>
<a href="#l66.49"></a><span id="l66.49"> var calProtocolHandlerWebcalClassID = Components.ID(&quot;{1153c73a-39be-46aa-9ba9-656d188865ca}&quot;);</span>
<a href="#l66.50"></a><span id="l66.50"> var calProtocolHandlerWebcalInterfaces = [Components.interfaces.nsIProtocolHandler];</span>
<a href="#l66.51"></a><span id="l66.51"> calProtocolHandlerWebcal.prototype = {</span>
<a href="#l66.52"></a><span id="l66.52">     __proto__: calProtocolHandler.prototype,</span>
<a href="#l66.53"></a><span id="l66.53">     classID: calProtocolHandlerWebcalClassID,</span>
<a href="#l66.54"></a><span id="l66.54">     QueryInterface: XPCOMUtils.generateQI(calProtocolHandlerWebcalInterfaces),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -20,27 +20,27 @@ calRecurrenceDate.prototype = {</span>
<a href="#l67.4"></a><span id="l67.4">     classID: calRecurrenceDateClassID,</span>
<a href="#l67.5"></a><span id="l67.5">     QueryInterface: XPCOMUtils.generateQI(calRecurrenceDateInterfaces),</span>
<a href="#l67.6"></a><span id="l67.6">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l67.7"></a><span id="l67.7">         classID: calRecurrenceDateClassID,</span>
<a href="#l67.8"></a><span id="l67.8">         contractID: &quot;@mozilla.org/calendar/recurrence-date;1&quot;,</span>
<a href="#l67.9"></a><span id="l67.9">         classDescription: &quot;The date of an occurrence of a recurring item&quot;,</span>
<a href="#l67.10"></a><span id="l67.10">         interfaces: calRecurrenceDateInterfaces</span>
<a href="#l67.11"></a><span id="l67.11">     }),</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-    makeImmutable: function makeImmutable() {</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+    makeImmutable: function() {</span>
<a href="#l67.14"></a><span id="l67.14">         this.isMutable = false;</span>
<a href="#l67.15"></a><span id="l67.15">     },</span>
<a href="#l67.16"></a><span id="l67.16"> </span>
<a href="#l67.17"></a><span id="l67.17" class="difflineminus">-    ensureMutable: function ensureMutable() {</span>
<a href="#l67.18"></a><span id="l67.18" class="difflineplus">+    ensureMutable: function() {</span>
<a href="#l67.19"></a><span id="l67.19">         if (!this.isMutable) {</span>
<a href="#l67.20"></a><span id="l67.20">             throw Components.results.NS_ERROR_OBJECT_IS_MUTABLE;</span>
<a href="#l67.21"></a><span id="l67.21">         }</span>
<a href="#l67.22"></a><span id="l67.22">     },</span>
<a href="#l67.23"></a><span id="l67.23"> </span>
<a href="#l67.24"></a><span id="l67.24" class="difflineminus">-    clone: function clone() {</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineplus">+    clone: function() {</span>
<a href="#l67.26"></a><span id="l67.26">         let other = new calRecurrenceDate();</span>
<a href="#l67.27"></a><span id="l67.27">         other.mDate = (this.mDate ? this.mDate.clone() : null);</span>
<a href="#l67.28"></a><span id="l67.28">         other.mIsNegative = this.mIsNegative;</span>
<a href="#l67.29"></a><span id="l67.29">         return other;</span>
<a href="#l67.30"></a><span id="l67.30">     },</span>
<a href="#l67.31"></a><span id="l67.31"> </span>
<a href="#l67.32"></a><span id="l67.32">     get isNegative() { return this.mIsNegative; },</span>
<a href="#l67.33"></a><span id="l67.33">     set isNegative(val) {</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineat">@@ -51,25 +51,25 @@ calRecurrenceDate.prototype = {</span>
<a href="#l67.35"></a><span id="l67.35">     get isFinite() { return true; },</span>
<a href="#l67.36"></a><span id="l67.36"> </span>
<a href="#l67.37"></a><span id="l67.37">     get date() { return this.mDate; },</span>
<a href="#l67.38"></a><span id="l67.38">     set date(val) {</span>
<a href="#l67.39"></a><span id="l67.39">         this.ensureMutable();</span>
<a href="#l67.40"></a><span id="l67.40">         return (this.mDate = val);</span>
<a href="#l67.41"></a><span id="l67.41">     },</span>
<a href="#l67.42"></a><span id="l67.42"> </span>
<a href="#l67.43"></a><span id="l67.43" class="difflineminus">-    getNextOccurrence: function getNextOccurrence(aStartTime, aOccurrenceTime) {</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineplus">+    getNextOccurrence: function(aStartTime, aOccurrenceTime) {</span>
<a href="#l67.45"></a><span id="l67.45">         if (this.mDate &amp;&amp; this.mDate.compare(aStartTime) &gt; 0) {</span>
<a href="#l67.46"></a><span id="l67.46">             return this.mDate;</span>
<a href="#l67.47"></a><span id="l67.47">         } else {</span>
<a href="#l67.48"></a><span id="l67.48">             return null;</span>
<a href="#l67.49"></a><span id="l67.49">         }</span>
<a href="#l67.50"></a><span id="l67.50">     },</span>
<a href="#l67.51"></a><span id="l67.51"> </span>
<a href="#l67.52"></a><span id="l67.52" class="difflineminus">-    getOccurrences: function getOccurrences(aStartTime, aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l67.53"></a><span id="l67.53" class="difflineplus">+    getOccurrences: function(aStartTime, aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l67.54"></a><span id="l67.54">         if (this.mDate &amp;&amp;</span>
<a href="#l67.55"></a><span id="l67.55">             this.mDate.compare(aRangeStart) &gt;= 0 &amp;&amp;</span>
<a href="#l67.56"></a><span id="l67.56">             (!aRangeEnd || this.mDate.compare(aRangeEnd) &lt; 0)) {</span>
<a href="#l67.57"></a><span id="l67.57">             aCount.value = 1;</span>
<a href="#l67.58"></a><span id="l67.58">             return [this.mDate];</span>
<a href="#l67.59"></a><span id="l67.59">         } else {</span>
<a href="#l67.60"></a><span id="l67.60">             aCount.value = 0;</span>
<a href="#l67.61"></a><span id="l67.61">             return [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -40,27 +40,27 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.4"></a><span id="l68.4">         contractID: &quot;@mozilla.org/calendar/recurrence-info;1&quot;,</span>
<a href="#l68.5"></a><span id="l68.5">         classDescription: &quot;Calendar Recurrence Info&quot;,</span>
<a href="#l68.6"></a><span id="l68.6">         interfaces: calRecurrenceInfoInterfaces,</span>
<a href="#l68.7"></a><span id="l68.7">     }),</span>
<a href="#l68.8"></a><span id="l68.8"> </span>
<a href="#l68.9"></a><span id="l68.9">     /**</span>
<a href="#l68.10"></a><span id="l68.10">      * Helpers</span>
<a href="#l68.11"></a><span id="l68.11">      */</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-    ensureBaseItem: function cRI_ensureBaseItem() {</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+    ensureBaseItem: function() {</span>
<a href="#l68.14"></a><span id="l68.14">         if (!this.mBaseItem) {</span>
<a href="#l68.15"></a><span id="l68.15">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l68.16"></a><span id="l68.16">         }</span>
<a href="#l68.17"></a><span id="l68.17">     },</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineminus">-    ensureMutable: function cRI_ensureMutable() {</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+    ensureMutable: function() {</span>
<a href="#l68.20"></a><span id="l68.20">         if (this.mImmutable) {</span>
<a href="#l68.21"></a><span id="l68.21">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l68.22"></a><span id="l68.22">         }</span>
<a href="#l68.23"></a><span id="l68.23">     },</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineminus">-    ensureSortedRecurrenceRules: function cRI_ensureSortedRecurrenceRules() {</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineplus">+    ensureSortedRecurrenceRules: function() {</span>
<a href="#l68.26"></a><span id="l68.26">         if (!this.mPositiveRules || !this.mNegativeRules) {</span>
<a href="#l68.27"></a><span id="l68.27">             this.mPositiveRules = [];</span>
<a href="#l68.28"></a><span id="l68.28">             this.mNegativeRules = [];</span>
<a href="#l68.29"></a><span id="l68.29">             for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l68.30"></a><span id="l68.30">                 if (ritem.isNegative) {</span>
<a href="#l68.31"></a><span id="l68.31">                     this.mNegativeRules.push(ritem);</span>
<a href="#l68.32"></a><span id="l68.32">                 } else {</span>
<a href="#l68.33"></a><span id="l68.33">                     this.mPositiveRules.push(ritem);</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineat">@@ -70,17 +70,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.35"></a><span id="l68.35">     },</span>
<a href="#l68.36"></a><span id="l68.36"> </span>
<a href="#l68.37"></a><span id="l68.37">     /**</span>
<a href="#l68.38"></a><span id="l68.38">      * Mutability bits</span>
<a href="#l68.39"></a><span id="l68.39">      */</span>
<a href="#l68.40"></a><span id="l68.40">     get isMutable() {</span>
<a href="#l68.41"></a><span id="l68.41">         return !this.mImmutable;</span>
<a href="#l68.42"></a><span id="l68.42">     },</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineminus">-    makeImmutable: function cRI_makeImmutable() {</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineplus">+    makeImmutable: function() {</span>
<a href="#l68.45"></a><span id="l68.45">         if (this.mImmutable) {</span>
<a href="#l68.46"></a><span id="l68.46">             return;</span>
<a href="#l68.47"></a><span id="l68.47">         }</span>
<a href="#l68.48"></a><span id="l68.48"> </span>
<a href="#l68.49"></a><span id="l68.49">         for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l68.50"></a><span id="l68.50">             if (ritem.isMutable) {</span>
<a href="#l68.51"></a><span id="l68.51">                 ritem.makeImmutable();</span>
<a href="#l68.52"></a><span id="l68.52">             }</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineat">@@ -91,17 +91,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.54"></a><span id="l68.54">             if (item.isMutable) {</span>
<a href="#l68.55"></a><span id="l68.55">                 item.makeImmutable();</span>
<a href="#l68.56"></a><span id="l68.56">             }</span>
<a href="#l68.57"></a><span id="l68.57">         }</span>
<a href="#l68.58"></a><span id="l68.58"> </span>
<a href="#l68.59"></a><span id="l68.59">         this.mImmutable = true;</span>
<a href="#l68.60"></a><span id="l68.60">     },</span>
<a href="#l68.61"></a><span id="l68.61"> </span>
<a href="#l68.62"></a><span id="l68.62" class="difflineminus">-    clone: function cRI_clone() {</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineplus">+    clone: function() {</span>
<a href="#l68.64"></a><span id="l68.64">         let cloned = new calRecurrenceInfo();</span>
<a href="#l68.65"></a><span id="l68.65">         cloned.mBaseItem = this.mBaseItem;</span>
<a href="#l68.66"></a><span id="l68.66"> </span>
<a href="#l68.67"></a><span id="l68.67">         let clonedItems = [];</span>
<a href="#l68.68"></a><span id="l68.68">         for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l68.69"></a><span id="l68.69">             clonedItems.push(ritem.clone());</span>
<a href="#l68.70"></a><span id="l68.70">         }</span>
<a href="#l68.71"></a><span id="l68.71">         cloned.mRecurrenceItems = clonedItems;</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineat">@@ -139,97 +139,97 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.73"></a><span id="l68.73">         for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l68.74"></a><span id="l68.74">             if (!ritem.isFinite) {</span>
<a href="#l68.75"></a><span id="l68.75">                 return false;</span>
<a href="#l68.76"></a><span id="l68.76">             }</span>
<a href="#l68.77"></a><span id="l68.77">         }</span>
<a href="#l68.78"></a><span id="l68.78">         return true;</span>
<a href="#l68.79"></a><span id="l68.79">     },</span>
<a href="#l68.80"></a><span id="l68.80"> </span>
<a href="#l68.81"></a><span id="l68.81" class="difflineminus">-    getRecurrenceItems: function cRI_getRecurrenceItems(aCount) {</span>
<a href="#l68.82"></a><span id="l68.82" class="difflineplus">+    getRecurrenceItems: function(aCount) {</span>
<a href="#l68.83"></a><span id="l68.83">         this.ensureBaseItem();</span>
<a href="#l68.84"></a><span id="l68.84"> </span>
<a href="#l68.85"></a><span id="l68.85">         aCount.value = this.mRecurrenceItems.length;</span>
<a href="#l68.86"></a><span id="l68.86">         return this.mRecurrenceItems;</span>
<a href="#l68.87"></a><span id="l68.87">     },</span>
<a href="#l68.88"></a><span id="l68.88"> </span>
<a href="#l68.89"></a><span id="l68.89" class="difflineminus">-    setRecurrenceItems: function cRI_setRecurrenceItems(aCount, aItems) {</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineplus">+    setRecurrenceItems: function(aCount, aItems) {</span>
<a href="#l68.91"></a><span id="l68.91">         this.ensureBaseItem();</span>
<a href="#l68.92"></a><span id="l68.92">         this.ensureMutable();</span>
<a href="#l68.93"></a><span id="l68.93"> </span>
<a href="#l68.94"></a><span id="l68.94">         // XXX should we clone these?</span>
<a href="#l68.95"></a><span id="l68.95">         this.mRecurrenceItems = aItems;</span>
<a href="#l68.96"></a><span id="l68.96">         this.mPositiveRules = null;</span>
<a href="#l68.97"></a><span id="l68.97">         this.mNegativeRules = null;</span>
<a href="#l68.98"></a><span id="l68.98">     },</span>
<a href="#l68.99"></a><span id="l68.99"> </span>
<a href="#l68.100"></a><span id="l68.100" class="difflineminus">-    countRecurrenceItems: function cRI_countRecurrenceItems() {</span>
<a href="#l68.101"></a><span id="l68.101" class="difflineplus">+    countRecurrenceItems: function() {</span>
<a href="#l68.102"></a><span id="l68.102">         this.ensureBaseItem();</span>
<a href="#l68.103"></a><span id="l68.103"> </span>
<a href="#l68.104"></a><span id="l68.104">         return this.mRecurrenceItems.length;</span>
<a href="#l68.105"></a><span id="l68.105">     },</span>
<a href="#l68.106"></a><span id="l68.106"> </span>
<a href="#l68.107"></a><span id="l68.107" class="difflineminus">-    getRecurrenceItemAt: function cRI_getRecurrenceItemAt(aIndex) {</span>
<a href="#l68.108"></a><span id="l68.108" class="difflineplus">+    getRecurrenceItemAt: function(aIndex) {</span>
<a href="#l68.109"></a><span id="l68.109">         this.ensureBaseItem();</span>
<a href="#l68.110"></a><span id="l68.110"> </span>
<a href="#l68.111"></a><span id="l68.111">         if (aIndex &lt; 0 || aIndex &gt;= this.mRecurrenceItems.length) {</span>
<a href="#l68.112"></a><span id="l68.112">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l68.113"></a><span id="l68.113">         }</span>
<a href="#l68.114"></a><span id="l68.114"> </span>
<a href="#l68.115"></a><span id="l68.115">         return this.mRecurrenceItems[aIndex];</span>
<a href="#l68.116"></a><span id="l68.116">     },</span>
<a href="#l68.117"></a><span id="l68.117"> </span>
<a href="#l68.118"></a><span id="l68.118" class="difflineminus">-    appendRecurrenceItem: function cRI_appendRecurrenceItem(aItem) {</span>
<a href="#l68.119"></a><span id="l68.119" class="difflineplus">+    appendRecurrenceItem: function(aItem) {</span>
<a href="#l68.120"></a><span id="l68.120">         this.ensureBaseItem();</span>
<a href="#l68.121"></a><span id="l68.121">         this.ensureMutable();</span>
<a href="#l68.122"></a><span id="l68.122">         this.ensureSortedRecurrenceRules();</span>
<a href="#l68.123"></a><span id="l68.123"> </span>
<a href="#l68.124"></a><span id="l68.124">         this.mRecurrenceItems.push(aItem);</span>
<a href="#l68.125"></a><span id="l68.125">         if (aItem.isNegative) {</span>
<a href="#l68.126"></a><span id="l68.126">             this.mNegativeRules.push(aItem);</span>
<a href="#l68.127"></a><span id="l68.127">         } else {</span>
<a href="#l68.128"></a><span id="l68.128">             this.mPositiveRules.push(aItem);</span>
<a href="#l68.129"></a><span id="l68.129">         }</span>
<a href="#l68.130"></a><span id="l68.130">     },</span>
<a href="#l68.131"></a><span id="l68.131"> </span>
<a href="#l68.132"></a><span id="l68.132" class="difflineminus">-    deleteRecurrenceItemAt: function cRI_deleteRecurrenceItemAt(aIndex) {</span>
<a href="#l68.133"></a><span id="l68.133" class="difflineplus">+    deleteRecurrenceItemAt: function(aIndex) {</span>
<a href="#l68.134"></a><span id="l68.134">         this.ensureBaseItem();</span>
<a href="#l68.135"></a><span id="l68.135">         this.ensureMutable();</span>
<a href="#l68.136"></a><span id="l68.136"> </span>
<a href="#l68.137"></a><span id="l68.137">         if (aIndex &lt; 0 || aIndex &gt;= this.mRecurrenceItems.length) {</span>
<a href="#l68.138"></a><span id="l68.138">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l68.139"></a><span id="l68.139">         }</span>
<a href="#l68.140"></a><span id="l68.140"> </span>
<a href="#l68.141"></a><span id="l68.141">         if (this.mRecurrenceItems[aIndex].isNegative) {</span>
<a href="#l68.142"></a><span id="l68.142">             this.mNegativeRules = null;</span>
<a href="#l68.143"></a><span id="l68.143">         } else {</span>
<a href="#l68.144"></a><span id="l68.144">             this.mPositiveRules = null;</span>
<a href="#l68.145"></a><span id="l68.145">         }</span>
<a href="#l68.146"></a><span id="l68.146"> </span>
<a href="#l68.147"></a><span id="l68.147">         this.mRecurrenceItems.splice(aIndex, 1);</span>
<a href="#l68.148"></a><span id="l68.148">     },</span>
<a href="#l68.149"></a><span id="l68.149"> </span>
<a href="#l68.150"></a><span id="l68.150" class="difflineminus">-    deleteRecurrenceItem: function cRI_deleteRecurrenceItem(aItem) {</span>
<a href="#l68.151"></a><span id="l68.151" class="difflineplus">+    deleteRecurrenceItem: function(aItem) {</span>
<a href="#l68.152"></a><span id="l68.152">         // Because xpcom objects can be wrapped in various ways, testing for</span>
<a href="#l68.153"></a><span id="l68.153">         // mere == sometimes returns false even when it should be true.  Use</span>
<a href="#l68.154"></a><span id="l68.154">         // the interface pointer returned by sip to avoid that problem.</span>
<a href="#l68.155"></a><span id="l68.155">         let sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l68.156"></a><span id="l68.156">                             .createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l68.157"></a><span id="l68.157">         sip1.data = aItem;</span>
<a href="#l68.158"></a><span id="l68.158">         sip1.dataIID = Components.interfaces.calIRecurrenceItem;</span>
<a href="#l68.159"></a><span id="l68.159"> </span>
<a href="#l68.160"></a><span id="l68.160">         let pos;</span>
<a href="#l68.161"></a><span id="l68.161">         if ((pos = this.mRecurrenceItems.indexOf(sip1.data)) &gt; -1) {</span>
<a href="#l68.162"></a><span id="l68.162">             this.deleteRecurrenceItemAt(pos);</span>
<a href="#l68.163"></a><span id="l68.163">         } else {</span>
<a href="#l68.164"></a><span id="l68.164">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l68.165"></a><span id="l68.165">         }</span>
<a href="#l68.166"></a><span id="l68.166">     },</span>
<a href="#l68.167"></a><span id="l68.167"> </span>
<a href="#l68.168"></a><span id="l68.168" class="difflineminus">-    insertRecurrenceItemAt: function cRI_insertRecurrenceItemAt(aItem, aIndex) {</span>
<a href="#l68.169"></a><span id="l68.169" class="difflineplus">+    insertRecurrenceItemAt: function(aItem, aIndex) {</span>
<a href="#l68.170"></a><span id="l68.170">         this.ensureBaseItem();</span>
<a href="#l68.171"></a><span id="l68.171">         this.ensureMutable();</span>
<a href="#l68.172"></a><span id="l68.172">         this.ensureSortedRecurrenceRules();</span>
<a href="#l68.173"></a><span id="l68.173"> </span>
<a href="#l68.174"></a><span id="l68.174">         if (aIndex &lt; 0 || aIndex &gt; this.mRecurrenceItems.length) {</span>
<a href="#l68.175"></a><span id="l68.175">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l68.176"></a><span id="l68.176">         }</span>
<a href="#l68.177"></a><span id="l68.177"> </span>
<a href="#l68.178"></a><span id="l68.178" class="difflineat">@@ -237,29 +237,29 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.179"></a><span id="l68.179">             this.mNegativeRules.push(aItem);</span>
<a href="#l68.180"></a><span id="l68.180">         } else {</span>
<a href="#l68.181"></a><span id="l68.181">             this.mPositiveRules.push(aItem);</span>
<a href="#l68.182"></a><span id="l68.182">         }</span>
<a href="#l68.183"></a><span id="l68.183"> </span>
<a href="#l68.184"></a><span id="l68.184">         this.mRecurrenceItems.splice(aIndex, 0, aItem);</span>
<a href="#l68.185"></a><span id="l68.185">     },</span>
<a href="#l68.186"></a><span id="l68.186"> </span>
<a href="#l68.187"></a><span id="l68.187" class="difflineminus">-    clearRecurrenceItems: function cRI_clearRecurrenceItems() {</span>
<a href="#l68.188"></a><span id="l68.188" class="difflineplus">+    clearRecurrenceItems: function() {</span>
<a href="#l68.189"></a><span id="l68.189">         this.ensureBaseItem();</span>
<a href="#l68.190"></a><span id="l68.190">         this.ensureMutable();</span>
<a href="#l68.191"></a><span id="l68.191"> </span>
<a href="#l68.192"></a><span id="l68.192">         this.mRecurrenceItems = [];</span>
<a href="#l68.193"></a><span id="l68.193">         this.mPositiveRules = [];</span>
<a href="#l68.194"></a><span id="l68.194">         this.mNegativeRules = [];</span>
<a href="#l68.195"></a><span id="l68.195">     },</span>
<a href="#l68.196"></a><span id="l68.196"> </span>
<a href="#l68.197"></a><span id="l68.197">     /*</span>
<a href="#l68.198"></a><span id="l68.198">      * calculations</span>
<a href="#l68.199"></a><span id="l68.199">      */</span>
<a href="#l68.200"></a><span id="l68.200" class="difflineminus">-    getNextOccurrence: function cRI_getNextOccurrence(aTime) {</span>
<a href="#l68.201"></a><span id="l68.201" class="difflineplus">+    getNextOccurrence: function(aTime) {</span>
<a href="#l68.202"></a><span id="l68.202">         this.ensureBaseItem();</span>
<a href="#l68.203"></a><span id="l68.203">         this.ensureSortedRecurrenceRules();</span>
<a href="#l68.204"></a><span id="l68.204"> </span>
<a href="#l68.205"></a><span id="l68.205">         let startDate = this.mBaseItem.recurrenceStartDate;</span>
<a href="#l68.206"></a><span id="l68.206">         let nextOccurrences = [];</span>
<a href="#l68.207"></a><span id="l68.207">         let invalidOccurrences;</span>
<a href="#l68.208"></a><span id="l68.208">         let negMap = {};</span>
<a href="#l68.209"></a><span id="l68.209">         let minOccRid;</span>
<a href="#l68.210"></a><span id="l68.210" class="difflineat">@@ -393,17 +393,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.211"></a><span id="l68.211">             }</span>
<a href="#l68.212"></a><span id="l68.212">         }</span>
<a href="#l68.213"></a><span id="l68.213"> </span>
<a href="#l68.214"></a><span id="l68.214">         // If we found a recurrence id any time above, then return the</span>
<a href="#l68.215"></a><span id="l68.215">         // occurrence for it.</span>
<a href="#l68.216"></a><span id="l68.216">         return (minOccRid ? this.getOccurrenceFor(minOccRid) : null);</span>
<a href="#l68.217"></a><span id="l68.217">     },</span>
<a href="#l68.218"></a><span id="l68.218"> </span>
<a href="#l68.219"></a><span id="l68.219" class="difflineminus">-    getPreviousOccurrence: function cRI_getPreviousOccurrence(aTime) {</span>
<a href="#l68.220"></a><span id="l68.220" class="difflineplus">+    getPreviousOccurrence: function(aTime) {</span>
<a href="#l68.221"></a><span id="l68.221">         // TODO libical currently does not provide us with easy means of</span>
<a href="#l68.222"></a><span id="l68.222">         // getting the previous occurrence. This could be fixed to improve</span>
<a href="#l68.223"></a><span id="l68.223">         // performance greatly. Filed as libical feature request 1944020.</span>
<a href="#l68.224"></a><span id="l68.224"> </span>
<a href="#l68.225"></a><span id="l68.225">         // HACK We never know how early an RDATE might be before the actual</span>
<a href="#l68.226"></a><span id="l68.226">         // recurrence start. Since rangeStart cannot be null for recurrence</span>
<a href="#l68.227"></a><span id="l68.227">         // items like calIRecurrenceRule, we need to work around by supplying a</span>
<a href="#l68.228"></a><span id="l68.228">         // very early date. Again, this might have a high performance penalty.</span>
<a href="#l68.229"></a><span id="l68.229" class="difflineat">@@ -414,19 +414,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.230"></a><span id="l68.230">                                        aTime,</span>
<a href="#l68.231"></a><span id="l68.231">                                        0);</span>
<a href="#l68.232"></a><span id="l68.232">         // The returned dates are sorted, so the last one is a good</span>
<a href="#l68.233"></a><span id="l68.233">         // candidate, if it exists.</span>
<a href="#l68.234"></a><span id="l68.234">         return (rids.length &gt; 0 ? this.getOccurrenceFor(rids[rids.length - 1].id) : null);</span>
<a href="#l68.235"></a><span id="l68.235">     },</span>
<a href="#l68.236"></a><span id="l68.236"> </span>
<a href="#l68.237"></a><span id="l68.237">     // internal helper function;</span>
<a href="#l68.238"></a><span id="l68.238" class="difflineminus">-    calculateDates: function cRI_calculateDates(aRangeStart,</span>
<a href="#l68.239"></a><span id="l68.239" class="difflineminus">-                                                aRangeEnd,</span>
<a href="#l68.240"></a><span id="l68.240" class="difflineminus">-                                                aMaxCount) {</span>
<a href="#l68.241"></a><span id="l68.241" class="difflineplus">+    calculateDates: function(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l68.242"></a><span id="l68.242">         this.ensureBaseItem();</span>
<a href="#l68.243"></a><span id="l68.243">         this.ensureSortedRecurrenceRules();</span>
<a href="#l68.244"></a><span id="l68.244"> </span>
<a href="#l68.245"></a><span id="l68.245">         function ridDateSortComptor(a, b) {</span>
<a href="#l68.246"></a><span id="l68.246">             return a.rstart.compare(b.rstart);</span>
<a href="#l68.247"></a><span id="l68.247">         }</span>
<a href="#l68.248"></a><span id="l68.248"> </span>
<a href="#l68.249"></a><span id="l68.249">         // workaround for UTC- timezones</span>
<a href="#l68.250"></a><span id="l68.250" class="difflineat">@@ -571,30 +569,24 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.251"></a><span id="l68.251">         // specified.</span>
<a href="#l68.252"></a><span id="l68.252">         if (aMaxCount &amp;&amp; dates.length &gt; aMaxCount) {</span>
<a href="#l68.253"></a><span id="l68.253">             dates = dates.slice(0, aMaxCount);</span>
<a href="#l68.254"></a><span id="l68.254">         }</span>
<a href="#l68.255"></a><span id="l68.255"> </span>
<a href="#l68.256"></a><span id="l68.256">         return dates;</span>
<a href="#l68.257"></a><span id="l68.257">     },</span>
<a href="#l68.258"></a><span id="l68.258"> </span>
<a href="#l68.259"></a><span id="l68.259" class="difflineminus">-    getOccurrenceDates: function cRI_getOccurrenceDates(aRangeStart,</span>
<a href="#l68.260"></a><span id="l68.260" class="difflineminus">-                                                        aRangeEnd,</span>
<a href="#l68.261"></a><span id="l68.261" class="difflineminus">-                                                        aMaxCount,</span>
<a href="#l68.262"></a><span id="l68.262" class="difflineminus">-                                                        aCount) {</span>
<a href="#l68.263"></a><span id="l68.263" class="difflineplus">+    getOccurrenceDates: function(aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l68.264"></a><span id="l68.264">         let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l68.265"></a><span id="l68.265">         dates = dates.map(function(d) { return d.rstart; });</span>
<a href="#l68.266"></a><span id="l68.266">         aCount.value = dates.length;</span>
<a href="#l68.267"></a><span id="l68.267">         return dates;</span>
<a href="#l68.268"></a><span id="l68.268">     },</span>
<a href="#l68.269"></a><span id="l68.269"> </span>
<a href="#l68.270"></a><span id="l68.270" class="difflineminus">-    getOccurrences: function cRI_getOccurrences(aRangeStart,</span>
<a href="#l68.271"></a><span id="l68.271" class="difflineminus">-                                                aRangeEnd,</span>
<a href="#l68.272"></a><span id="l68.272" class="difflineminus">-                                                aMaxCount,</span>
<a href="#l68.273"></a><span id="l68.273" class="difflineminus">-                                                aCount) {</span>
<a href="#l68.274"></a><span id="l68.274" class="difflineplus">+    getOccurrences: function(aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l68.275"></a><span id="l68.275">         let results = [];</span>
<a href="#l68.276"></a><span id="l68.276">         let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l68.277"></a><span id="l68.277">         if (dates.length) {</span>
<a href="#l68.278"></a><span id="l68.278">             let count;</span>
<a href="#l68.279"></a><span id="l68.279">             if (aMaxCount) {</span>
<a href="#l68.280"></a><span id="l68.280">                 count = Math.min(aMaxCount, dates.length);</span>
<a href="#l68.281"></a><span id="l68.281">             } else {</span>
<a href="#l68.282"></a><span id="l68.282">                 count = dates.length;</span>
<a href="#l68.283"></a><span id="l68.283" class="difflineat">@@ -604,39 +596,39 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.284"></a><span id="l68.284">                 results.push(this.getOccurrenceFor(dates[i].id));</span>
<a href="#l68.285"></a><span id="l68.285">             }</span>
<a href="#l68.286"></a><span id="l68.286">         }</span>
<a href="#l68.287"></a><span id="l68.287"> </span>
<a href="#l68.288"></a><span id="l68.288">         aCount.value = results.length;</span>
<a href="#l68.289"></a><span id="l68.289">         return results;</span>
<a href="#l68.290"></a><span id="l68.290">     },</span>
<a href="#l68.291"></a><span id="l68.291"> </span>
<a href="#l68.292"></a><span id="l68.292" class="difflineminus">-    getOccurrenceFor: function cRI_getOccurrenceFor(aRecurrenceId) {</span>
<a href="#l68.293"></a><span id="l68.293" class="difflineplus">+    getOccurrenceFor: function(aRecurrenceId) {</span>
<a href="#l68.294"></a><span id="l68.294">         let proxy = this.getExceptionFor(aRecurrenceId);</span>
<a href="#l68.295"></a><span id="l68.295">         if (!proxy) {</span>
<a href="#l68.296"></a><span id="l68.296">             return this.item.createProxy(aRecurrenceId);</span>
<a href="#l68.297"></a><span id="l68.297">         }</span>
<a href="#l68.298"></a><span id="l68.298">         return proxy;</span>
<a href="#l68.299"></a><span id="l68.299">     },</span>
<a href="#l68.300"></a><span id="l68.300"> </span>
<a href="#l68.301"></a><span id="l68.301" class="difflineminus">-    removeOccurrenceAt: function cRI_removeOccurrenceAt(aRecurrenceId) {</span>
<a href="#l68.302"></a><span id="l68.302" class="difflineplus">+    removeOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l68.303"></a><span id="l68.303">         this.ensureBaseItem();</span>
<a href="#l68.304"></a><span id="l68.304">         this.ensureMutable();</span>
<a href="#l68.305"></a><span id="l68.305"> </span>
<a href="#l68.306"></a><span id="l68.306">         let d = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l68.307"></a><span id="l68.307">                           .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l68.308"></a><span id="l68.308">         d.isNegative = true;</span>
<a href="#l68.309"></a><span id="l68.309">         d.date = aRecurrenceId.clone();</span>
<a href="#l68.310"></a><span id="l68.310"> </span>
<a href="#l68.311"></a><span id="l68.311">         this.removeExceptionFor(d.date);</span>
<a href="#l68.312"></a><span id="l68.312"> </span>
<a href="#l68.313"></a><span id="l68.313">         this.appendRecurrenceItem(d);</span>
<a href="#l68.314"></a><span id="l68.314">     },</span>
<a href="#l68.315"></a><span id="l68.315"> </span>
<a href="#l68.316"></a><span id="l68.316" class="difflineminus">-    restoreOccurrenceAt: function cRI_restoreOccurrenceAt(aRecurrenceId) {</span>
<a href="#l68.317"></a><span id="l68.317" class="difflineplus">+    restoreOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l68.318"></a><span id="l68.318">         this.ensureBaseItem();</span>
<a href="#l68.319"></a><span id="l68.319">         this.ensureMutable();</span>
<a href="#l68.320"></a><span id="l68.320">         this.ensureSortedRecurrenceRules();</span>
<a href="#l68.321"></a><span id="l68.321"> </span>
<a href="#l68.322"></a><span id="l68.322">         for (let i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l68.323"></a><span id="l68.323">             let wrappedItem = cal.wrapInstance(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l68.324"></a><span id="l68.324">             if (wrappedItem) {</span>
<a href="#l68.325"></a><span id="l68.325">                 let rd = wrappedItem;</span>
<a href="#l68.326"></a><span id="l68.326" class="difflineat">@@ -676,17 +668,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.327"></a><span id="l68.327">     // RECURRENCE-ID.  This madness is described in ITIP end of</span>
<a href="#l68.328"></a><span id="l68.328">     // section 3.7.1.</span>
<a href="#l68.329"></a><span id="l68.329">     //</span>
<a href="#l68.330"></a><span id="l68.330">     // This implementation does the first approach (RECURRENCE-ID will</span>
<a href="#l68.331"></a><span id="l68.331">     // never change even if DTSTART for that instance changes), which</span>
<a href="#l68.332"></a><span id="l68.332">     // I think is the right thing to do for CalDAV; I don't know what</span>
<a href="#l68.333"></a><span id="l68.333">     // we'll do for incoming ITIP events though.</span>
<a href="#l68.334"></a><span id="l68.334">     //</span>
<a href="#l68.335"></a><span id="l68.335" class="difflineminus">-    modifyException: function cRI_modifyException(anItem, aTakeOverOwnership) {</span>
<a href="#l68.336"></a><span id="l68.336" class="difflineplus">+    modifyException: function(anItem, aTakeOverOwnership) {</span>
<a href="#l68.337"></a><span id="l68.337">         this.ensureBaseItem();</span>
<a href="#l68.338"></a><span id="l68.338"> </span>
<a href="#l68.339"></a><span id="l68.339">         anItem = calTryWrappedJSObject(anItem);</span>
<a href="#l68.340"></a><span id="l68.340"> </span>
<a href="#l68.341"></a><span id="l68.341">         if (anItem.parentItem.calendar != this.mBaseItem.calendar &amp;&amp;</span>
<a href="#l68.342"></a><span id="l68.342">             anItem.parentItem.id != this.mBaseItem.id) {</span>
<a href="#l68.343"></a><span id="l68.343">             ERROR(&quot;recurrenceInfo::addException: item parentItem != this.mBaseItem (calendar/id)!&quot;);</span>
<a href="#l68.344"></a><span id="l68.344">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l68.345"></a><span id="l68.345" class="difflineat">@@ -707,47 +699,47 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.346"></a><span id="l68.346"> </span>
<a href="#l68.347"></a><span id="l68.347">         // we're going to assume that the recurrenceId is valid here,</span>
<a href="#l68.348"></a><span id="l68.348">         // because presumably the item came from one of our functions</span>
<a href="#l68.349"></a><span id="l68.349"> </span>
<a href="#l68.350"></a><span id="l68.350">         let exKey = getRidKey(itemtoadd.recurrenceId);</span>
<a href="#l68.351"></a><span id="l68.351">         this.mExceptionMap[exKey] = itemtoadd;</span>
<a href="#l68.352"></a><span id="l68.352">     },</span>
<a href="#l68.353"></a><span id="l68.353"> </span>
<a href="#l68.354"></a><span id="l68.354" class="difflineminus">-    getExceptionFor: function cRI_getExceptionFor(aRecurrenceId) {</span>
<a href="#l68.355"></a><span id="l68.355" class="difflineplus">+    getExceptionFor: function(aRecurrenceId) {</span>
<a href="#l68.356"></a><span id="l68.356">         this.ensureBaseItem();</span>
<a href="#l68.357"></a><span id="l68.357">         // Interface calIRecurrenceInfo specifies result be null if not found.</span>
<a href="#l68.358"></a><span id="l68.358">         // To avoid strict &quot;reference to undefined property&quot; warning, appending</span>
<a href="#l68.359"></a><span id="l68.359">         // &quot;|| null&quot; gives explicit result in case where property undefined</span>
<a href="#l68.360"></a><span id="l68.360">         // (or false, 0, null, or &quot;&quot;, but here it should never be those values).</span>
<a href="#l68.361"></a><span id="l68.361">         return this.mExceptionMap[getRidKey(aRecurrenceId)] || null;</span>
<a href="#l68.362"></a><span id="l68.362">     },</span>
<a href="#l68.363"></a><span id="l68.363"> </span>
<a href="#l68.364"></a><span id="l68.364" class="difflineminus">-    removeExceptionFor: function cRI_removeExceptionFor(aRecurrenceId) {</span>
<a href="#l68.365"></a><span id="l68.365" class="difflineplus">+    removeExceptionFor: function(aRecurrenceId) {</span>
<a href="#l68.366"></a><span id="l68.366">         this.ensureBaseItem();</span>
<a href="#l68.367"></a><span id="l68.367">         delete this.mExceptionMap[getRidKey(aRecurrenceId)];</span>
<a href="#l68.368"></a><span id="l68.368">     },</span>
<a href="#l68.369"></a><span id="l68.369"> </span>
<a href="#l68.370"></a><span id="l68.370" class="difflineminus">-    getExceptionIds: function cRI_getExceptionIds(aCount) {</span>
<a href="#l68.371"></a><span id="l68.371" class="difflineplus">+    getExceptionIds: function(aCount) {</span>
<a href="#l68.372"></a><span id="l68.372">         this.ensureBaseItem();</span>
<a href="#l68.373"></a><span id="l68.373"> </span>
<a href="#l68.374"></a><span id="l68.374">         let ids = [];</span>
<a href="#l68.375"></a><span id="l68.375">         for (let ex in this.mExceptionMap) {</span>
<a href="#l68.376"></a><span id="l68.376">             let item = this.mExceptionMap[ex];</span>
<a href="#l68.377"></a><span id="l68.377">             ids.push(item.recurrenceId);</span>
<a href="#l68.378"></a><span id="l68.378">         }</span>
<a href="#l68.379"></a><span id="l68.379"> </span>
<a href="#l68.380"></a><span id="l68.380">         aCount.value = ids.length;</span>
<a href="#l68.381"></a><span id="l68.381">         return ids;</span>
<a href="#l68.382"></a><span id="l68.382">     },</span>
<a href="#l68.383"></a><span id="l68.383"> </span>
<a href="#l68.384"></a><span id="l68.384">     // changing the startdate of an item needs to take exceptions into account.</span>
<a href="#l68.385"></a><span id="l68.385">     // in case we're about to modify a parentItem (aka 'folded' item), we need</span>
<a href="#l68.386"></a><span id="l68.386">     // to modify the recurrenceId's of all possibly existing exceptions as well.</span>
<a href="#l68.387"></a><span id="l68.387" class="difflineminus">-    onStartDateChange: function cRI_onStartDateChange(aNewStartTime, aOldStartTime) {</span>
<a href="#l68.388"></a><span id="l68.388" class="difflineplus">+    onStartDateChange: function(aNewStartTime, aOldStartTime) {</span>
<a href="#l68.389"></a><span id="l68.389">         // passing null for the new starttime would indicate an error condition,</span>
<a href="#l68.390"></a><span id="l68.390">         // since having a recurrence without a starttime is invalid.</span>
<a href="#l68.391"></a><span id="l68.391">         cal.ASSERT(aNewStartTime, &quot;invalid arg!&quot;, true);</span>
<a href="#l68.392"></a><span id="l68.392"> </span>
<a href="#l68.393"></a><span id="l68.393">         // no need to check for changes if there's no previous starttime.</span>
<a href="#l68.394"></a><span id="l68.394">         if (!aOldStartTime) {</span>
<a href="#l68.395"></a><span id="l68.395">             return;</span>
<a href="#l68.396"></a><span id="l68.396">         }</span>
<a href="#l68.397"></a><span id="l68.397" class="difflineat">@@ -801,16 +793,16 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l68.398"></a><span id="l68.398">                 this.removeExceptionFor(exid);</span>
<a href="#l68.399"></a><span id="l68.399">             }</span>
<a href="#l68.400"></a><span id="l68.400">         }</span>
<a href="#l68.401"></a><span id="l68.401">         for (let modifiedEx of modifiedExceptions) {</span>
<a href="#l68.402"></a><span id="l68.402">             this.modifyException(modifiedEx, true);</span>
<a href="#l68.403"></a><span id="l68.403">         }</span>
<a href="#l68.404"></a><span id="l68.404">     },</span>
<a href="#l68.405"></a><span id="l68.405"> </span>
<a href="#l68.406"></a><span id="l68.406" class="difflineminus">-    onIdChange: function cRI_onIdChange(aNewId) {</span>
<a href="#l68.407"></a><span id="l68.407" class="difflineplus">+    onIdChange: function(aNewId) {</span>
<a href="#l68.408"></a><span id="l68.408">         // patch all overridden items' id:</span>
<a href="#l68.409"></a><span id="l68.409">         for (let ex in this.mExceptionMap) {</span>
<a href="#l68.410"></a><span id="l68.410">             let item = this.mExceptionMap[ex];</span>
<a href="#l68.411"></a><span id="l68.411">             item.id = aNewId;</span>
<a href="#l68.412"></a><span id="l68.412">         }</span>
<a href="#l68.413"></a><span id="l68.413">     }</span>
<a href="#l68.414"></a><span id="l68.414"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/base/src/calRelation.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/base/src/calRelation.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -114,17 +114,17 @@ calRelation.prototype = {</span>
<a href="#l69.4"></a><span id="l69.4">     setParameter: function(aName, aValue) {</span>
<a href="#l69.5"></a><span id="l69.5">         return this.mProperties.setProperty(aName, aValue);</span>
<a href="#l69.6"></a><span id="l69.6">     },</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8">     deleteParameter: function(aName) {</span>
<a href="#l69.9"></a><span id="l69.9">         return this.mProperties.deleteProperty(aName);</span>
<a href="#l69.10"></a><span id="l69.10">     },</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-    clone: function cR_clone() {</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+    clone: function() {</span>
<a href="#l69.14"></a><span id="l69.14">         let newRelation = new calRelation();</span>
<a href="#l69.15"></a><span id="l69.15">         newRelation.mId = this.mId;</span>
<a href="#l69.16"></a><span id="l69.16">         newRelation.mType = this.mType;</span>
<a href="#l69.17"></a><span id="l69.17">         for (let [name, value] of this.mProperties) {</span>
<a href="#l69.18"></a><span id="l69.18">             newRelation.mProperties.setProperty(name, value);</span>
<a href="#l69.19"></a><span id="l69.19">         }</span>
<a href="#l69.20"></a><span id="l69.20">         return newRelation;</span>
<a href="#l69.21"></a><span id="l69.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/base/src/calSleepMonitor.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/base/src/calSleepMonitor.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -45,17 +45,17 @@ calSleepMonitor.prototype = {</span>
<a href="#l70.4"></a><span id="l70.4">     stop: function() {</span>
<a href="#l70.5"></a><span id="l70.5">         if (this.timer) {</span>
<a href="#l70.6"></a><span id="l70.6">             this.timer.cancel();</span>
<a href="#l70.7"></a><span id="l70.7">             this.timer = null;</span>
<a href="#l70.8"></a><span id="l70.8">         }</span>
<a href="#l70.9"></a><span id="l70.9">     },</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11">     // nsIObserver:</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-    observe: function observe(aSubject, aTopic, aData) {</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l70.14"></a><span id="l70.14">         // calSleepMonitor is not used on Windows or OSX.</span>
<a href="#l70.15"></a><span id="l70.15">         if (Services.appinfo.OS == &quot;WINNT&quot; || Services.appinfo.OS == &quot;Darwin&quot;) {</span>
<a href="#l70.16"></a><span id="l70.16">             return;</span>
<a href="#l70.17"></a><span id="l70.17">         }</span>
<a href="#l70.18"></a><span id="l70.18"> </span>
<a href="#l70.19"></a><span id="l70.19">         if (aTopic == &quot;profile-after-change&quot;) {</span>
<a href="#l70.20"></a><span id="l70.20">             cal.LOG(&quot;[calSleepMonitor] Starting sleep monitor.&quot;);</span>
<a href="#l70.21"></a><span id="l70.21">             this.start();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/base/src/calStartupService.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/base/src/calStartupService.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -43,45 +43,45 @@ calStartupService.prototype = {</span>
<a href="#l71.4"></a><span id="l71.4">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l71.5"></a><span id="l71.5">     }),</span>
<a href="#l71.6"></a><span id="l71.6"> </span>
<a href="#l71.7"></a><span id="l71.7">     // Startup Service Methods</span>
<a href="#l71.8"></a><span id="l71.8"> </span>
<a href="#l71.9"></a><span id="l71.9">     /**</span>
<a href="#l71.10"></a><span id="l71.10">      * Sets up the needed observers for noticing startup/shutdown</span>
<a href="#l71.11"></a><span id="l71.11">      */</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-    setupObservers: function ccm_setUpStartupObservers() {</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+    setupObservers: function() {</span>
<a href="#l71.14"></a><span id="l71.14">         Services.obs.addObserver(this, &quot;profile-after-change&quot;, false);</span>
<a href="#l71.15"></a><span id="l71.15">         Services.obs.addObserver(this, &quot;profile-before-change&quot;, false);</span>
<a href="#l71.16"></a><span id="l71.16">         Services.obs.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l71.17"></a><span id="l71.17">     },</span>
<a href="#l71.18"></a><span id="l71.18"> </span>
<a href="#l71.19"></a><span id="l71.19">     started: false,</span>
<a href="#l71.20"></a><span id="l71.20"> </span>
<a href="#l71.21"></a><span id="l71.21">     /**</span>
<a href="#l71.22"></a><span id="l71.22">      * Gets the startup order of services. This is an array of service objects</span>
<a href="#l71.23"></a><span id="l71.23">      * that should be called in order at startup.</span>
<a href="#l71.24"></a><span id="l71.24">      *</span>
<a href="#l71.25"></a><span id="l71.25">      * @return      The startup order as an array.</span>
<a href="#l71.26"></a><span id="l71.26">      */</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineminus">-    getStartupOrder: function getStartupOrder() {</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+    getStartupOrder: function() {</span>
<a href="#l71.29"></a><span id="l71.29">         let self = this;</span>
<a href="#l71.30"></a><span id="l71.30">         let tzService = Components.classes[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l71.31"></a><span id="l71.31">                                   .getService(Components.interfaces.calITimezoneService);</span>
<a href="#l71.32"></a><span id="l71.32">         let calMgr = Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l71.33"></a><span id="l71.33">                                .getService(Components.interfaces.calICalendarManager);</span>
<a href="#l71.34"></a><span id="l71.34"> </span>
<a href="#l71.35"></a><span id="l71.35">         // Notification object</span>
<a href="#l71.36"></a><span id="l71.36">         let notify = {</span>
<a href="#l71.37"></a><span id="l71.37">             startup: function(aCompleteListener) {</span>
<a href="#l71.38"></a><span id="l71.38">                 self.started = true;</span>
<a href="#l71.39"></a><span id="l71.39">                 Services.obs.notifyObservers(null, &quot;calendar-startup-done&quot;, null);</span>
<a href="#l71.40"></a><span id="l71.40">                 aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l71.41"></a><span id="l71.41">             },</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineminus">-            shutdown: function shutdown(aCompleteListener) {</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+            shutdown: function(aCompleteListener) {</span>
<a href="#l71.44"></a><span id="l71.44">                 // Argh, it would have all been so pretty! Since we just reverse</span>
<a href="#l71.45"></a><span id="l71.45">                 // the array, the shutdown notification would happen before the</span>
<a href="#l71.46"></a><span id="l71.46">                 // other shutdown calls. For lack of pretty code, I'm</span>
<a href="#l71.47"></a><span id="l71.47">                 // leaving this out! Users can still listen to xpcom-shutdown.</span>
<a href="#l71.48"></a><span id="l71.48">                 self.started = false;</span>
<a href="#l71.49"></a><span id="l71.49">                 aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l71.50"></a><span id="l71.50">             }</span>
<a href="#l71.51"></a><span id="l71.51">         };</span>
<a href="#l71.52"></a><span id="l71.52" class="difflineat">@@ -90,17 +90,17 @@ calStartupService.prototype = {</span>
<a href="#l71.53"></a><span id="l71.53">         // to ensure we have the timezones initialized. Make sure &quot;notify&quot; is</span>
<a href="#l71.54"></a><span id="l71.54">         // last in this array!</span>
<a href="#l71.55"></a><span id="l71.55">         return [tzService, calMgr, notify];</span>
<a href="#l71.56"></a><span id="l71.56">     },</span>
<a href="#l71.57"></a><span id="l71.57"> </span>
<a href="#l71.58"></a><span id="l71.58">     /**</span>
<a href="#l71.59"></a><span id="l71.59">      * Observer notification callback</span>
<a href="#l71.60"></a><span id="l71.60">      */</span>
<a href="#l71.61"></a><span id="l71.61" class="difflineminus">-    observe: function observe(aSubject, aTopic, aData) {</span>
<a href="#l71.62"></a><span id="l71.62" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l71.63"></a><span id="l71.63">         switch (aTopic) {</span>
<a href="#l71.64"></a><span id="l71.64">             case &quot;profile-after-change&quot;:</span>
<a href="#l71.65"></a><span id="l71.65">                 callOrderedServices(&quot;startup&quot;, this.getStartupOrder());</span>
<a href="#l71.66"></a><span id="l71.66">                 break;</span>
<a href="#l71.67"></a><span id="l71.67">             case &quot;profile-before-change&quot;:</span>
<a href="#l71.68"></a><span id="l71.68">                 callOrderedServices(&quot;shutdown&quot;, this.getStartupOrder().reverse());</span>
<a href="#l71.69"></a><span id="l71.69">                 break;</span>
<a href="#l71.70"></a><span id="l71.70">             case &quot;xpcom-shutdown&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/base/src/calTimezone.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/base/src/calTimezone.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -72,17 +72,17 @@ calLibicalTimezone.prototype = {</span>
<a href="#l72.4"></a><span id="l72.4">     classID: calTimezoneClassID,</span>
<a href="#l72.5"></a><span id="l72.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l72.6"></a><span id="l72.6">         contractID: &quot;@mozilla.org/calendar/timezone;1&quot;,</span>
<a href="#l72.7"></a><span id="l72.7">         classDescription: &quot;Calendar Timezone&quot;,</span>
<a href="#l72.8"></a><span id="l72.8">         classID: calTimezoneClassID,</span>
<a href="#l72.9"></a><span id="l72.9">         interfaces: calTimezoneInterfaces</span>
<a href="#l72.10"></a><span id="l72.10">     }),</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-    toString: function calLibicalTimezone_toString() {</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+    toString: function() {</span>
<a href="#l72.14"></a><span id="l72.14">         return (this.icalComponent ? this.icalComponent.toString() : this.tzid);</span>
<a href="#l72.15"></a><span id="l72.15">     },</span>
<a href="#l72.16"></a><span id="l72.16"> </span>
<a href="#l72.17"></a><span id="l72.17">     get isUTC() { return this.mUTC; },</span>
<a href="#l72.18"></a><span id="l72.18"> </span>
<a href="#l72.19"></a><span id="l72.19">     get icalComponent() {</span>
<a href="#l72.20"></a><span id="l72.20">         let comp = this.mComponent;</span>
<a href="#l72.21"></a><span id="l72.21">         if (comp &amp;&amp; (typeof comp == &quot;string&quot;)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -17,20 +17,20 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l73.4"></a><span id="l73.4"> var g_stringBundle = null;</span>
<a href="#l73.5"></a><span id="l73.5"> </span>
<a href="#l73.6"></a><span id="l73.6"> function calStringEnumerator(stringArray) {</span>
<a href="#l73.7"></a><span id="l73.7">     this.mIndex = 0;</span>
<a href="#l73.8"></a><span id="l73.8">     this.mStringArray = stringArray;</span>
<a href="#l73.9"></a><span id="l73.9"> }</span>
<a href="#l73.10"></a><span id="l73.10"> calStringEnumerator.prototype = {</span>
<a href="#l73.11"></a><span id="l73.11">     // nsIUTF8StringEnumerator:</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-    hasMore: function calStringEnumerator_hasMore() {</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+    hasMore: function() {</span>
<a href="#l73.14"></a><span id="l73.14">         return (this.mIndex &lt; this.mStringArray.length);</span>
<a href="#l73.15"></a><span id="l73.15">     },</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineminus">-    getNext: function calStringEnumerator_getNext() {</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+    getNext: function() {</span>
<a href="#l73.18"></a><span id="l73.18">         if (!this.hasMore()) {</span>
<a href="#l73.19"></a><span id="l73.19">             throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l73.20"></a><span id="l73.20">         }</span>
<a href="#l73.21"></a><span id="l73.21">         return this.mStringArray[this.mIndex++];</span>
<a href="#l73.22"></a><span id="l73.22">     }</span>
<a href="#l73.23"></a><span id="l73.23"> };</span>
<a href="#l73.24"></a><span id="l73.24"> </span>
<a href="#l73.25"></a><span id="l73.25"> function calTimezoneService() {</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineat">@@ -66,17 +66,17 @@ calTimezoneService.prototype = {</span>
<a href="#l73.27"></a><span id="l73.27">     has: function(id) { return this.getTimezone(id) != null; },</span>
<a href="#l73.28"></a><span id="l73.28">     get: function(id) {</span>
<a href="#l73.29"></a><span id="l73.29">         return id ? unwrapSingle(ICAL.Timezone, this.getTimezone(id)) : null;</span>
<a href="#l73.30"></a><span id="l73.30">     },</span>
<a href="#l73.31"></a><span id="l73.31">     remove: function() {},</span>
<a href="#l73.32"></a><span id="l73.32">     register: function() {},</span>
<a href="#l73.33"></a><span id="l73.33"> </span>
<a href="#l73.34"></a><span id="l73.34">     // calIStartupService:</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineminus">-    startup: function startup(aCompleteListener) {</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+    startup: function(aCompleteListener) {</span>
<a href="#l73.37"></a><span id="l73.37">         function fetchJSON(aURL) {</span>
<a href="#l73.38"></a><span id="l73.38">             cal.LOG(&quot;[calTimezoneService] Loading &quot; + aURL);</span>
<a href="#l73.39"></a><span id="l73.39"> </span>
<a href="#l73.40"></a><span id="l73.40">             return new Promise((resolve, reject) =&gt; {</span>
<a href="#l73.41"></a><span id="l73.41">                 let uri = Services.io.newURI(aURL, null, null);</span>
<a href="#l73.42"></a><span id="l73.42">                 let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l73.43"></a><span id="l73.43">                                                              null,</span>
<a href="#l73.44"></a><span id="l73.44">                                                              Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineat">@@ -139,17 +139,17 @@ calTimezoneService.prototype = {</span>
<a href="#l73.46"></a><span id="l73.46">         }, (error) =&gt; {</span>
<a href="#l73.47"></a><span id="l73.47">             // We have to give up. Show an error and fail hard!</span>
<a href="#l73.48"></a><span id="l73.48">             let msg = cal.calGetString(&quot;calendar&quot;, &quot;missingCalendarTimezonesError&quot;);</span>
<a href="#l73.49"></a><span id="l73.49">             cal.ERROR(msg);</span>
<a href="#l73.50"></a><span id="l73.50">             cal.showError(msg);</span>
<a href="#l73.51"></a><span id="l73.51">         });</span>
<a href="#l73.52"></a><span id="l73.52">     },</span>
<a href="#l73.53"></a><span id="l73.53"> </span>
<a href="#l73.54"></a><span id="l73.54" class="difflineminus">-    shutdown: function shutdown(aCompleteListener) {</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+    shutdown: function(aCompleteListener) {</span>
<a href="#l73.56"></a><span id="l73.56">         Services.prefs.removeObserver(&quot;calendar.timezone.local&quot;, this);</span>
<a href="#l73.57"></a><span id="l73.57">         aCompleteListener.onResult(null, Components.results.NS_OK);</span>
<a href="#l73.58"></a><span id="l73.58">     },</span>
<a href="#l73.59"></a><span id="l73.59"> </span>
<a href="#l73.60"></a><span id="l73.60">     get UTC() {</span>
<a href="#l73.61"></a><span id="l73.61">         if (!this.mZones.has(&quot;UTC&quot;)) {</span>
<a href="#l73.62"></a><span id="l73.62">             let utc;</span>
<a href="#l73.63"></a><span id="l73.63">             if (Preferences.get(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineat">@@ -176,17 +176,17 @@ calTimezoneService.prototype = {</span>
<a href="#l73.65"></a><span id="l73.65">             }</span>
<a href="#l73.66"></a><span id="l73.66">             this.mZones.set(&quot;floating&quot;, { zone: floating });</span>
<a href="#l73.67"></a><span id="l73.67">         }</span>
<a href="#l73.68"></a><span id="l73.68"> </span>
<a href="#l73.69"></a><span id="l73.69">         return this.mZones.get(&quot;floating&quot;).zone;</span>
<a href="#l73.70"></a><span id="l73.70">     },</span>
<a href="#l73.71"></a><span id="l73.71"> </span>
<a href="#l73.72"></a><span id="l73.72">     // calITimezoneProvider:</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineminus">-    getTimezone: function calTimezoneService_getTimezone(tzid) {</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+    getTimezone: function(tzid) {</span>
<a href="#l73.75"></a><span id="l73.75">         if (!tzid) {</span>
<a href="#l73.76"></a><span id="l73.76">             cal.ERROR(&quot;Unknown timezone requested\n&quot; + cal.STACK(10));</span>
<a href="#l73.77"></a><span id="l73.77">             return null;</span>
<a href="#l73.78"></a><span id="l73.78">         }</span>
<a href="#l73.79"></a><span id="l73.79">         if (tzid.startsWith(&quot;/mozilla.org/&quot;)) {</span>
<a href="#l73.80"></a><span id="l73.80">             // We know that our former tzids look like &quot;/mozilla.org/&lt;dtstamp&gt;/continent/...&quot;</span>
<a href="#l73.81"></a><span id="l73.81">             // The ending of the mozilla prefix is the index of that slash before the</span>
<a href="#l73.82"></a><span id="l73.82">             // continent. Therefore, we start looking for the prefix-ending slash</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineat">@@ -265,25 +265,25 @@ calTimezoneService.prototype = {</span>
<a href="#l73.84"></a><span id="l73.84"> </span>
<a href="#l73.85"></a><span id="l73.85">             // We need to observe the timezone preference to update the default</span>
<a href="#l73.86"></a><span id="l73.86">             // timezone if needed.</span>
<a href="#l73.87"></a><span id="l73.87">             this.setupObservers();</span>
<a href="#l73.88"></a><span id="l73.88">         }</span>
<a href="#l73.89"></a><span id="l73.89">         return this.mDefaultTimezone;</span>
<a href="#l73.90"></a><span id="l73.90">     },</span>
<a href="#l73.91"></a><span id="l73.91"> </span>
<a href="#l73.92"></a><span id="l73.92" class="difflineminus">-    setupObservers: function calTimezoneService_setupObservers() {</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+    setupObservers: function() {</span>
<a href="#l73.94"></a><span id="l73.94">         if (!this.mHasSetupObservers) {</span>
<a href="#l73.95"></a><span id="l73.95">             // Now set up the observer</span>
<a href="#l73.96"></a><span id="l73.96">             Services.prefs.addObserver(&quot;calendar.timezone.local&quot;, this, false);</span>
<a href="#l73.97"></a><span id="l73.97">             this.mHasSetupObservers = true;</span>
<a href="#l73.98"></a><span id="l73.98">         }</span>
<a href="#l73.99"></a><span id="l73.99">     },</span>
<a href="#l73.100"></a><span id="l73.100"> </span>
<a href="#l73.101"></a><span id="l73.101" class="difflineminus">-    observe: function calTimezoneService_observe(aSubject, aTopic, aData) {</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l73.103"></a><span id="l73.103">         if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aData == &quot;calendar.timezone.local&quot;) {</span>
<a href="#l73.104"></a><span id="l73.104">             // Unsetting the default timezone will make the next call to the</span>
<a href="#l73.105"></a><span id="l73.105">             // default timezone getter set up the correct timezone again.</span>
<a href="#l73.106"></a><span id="l73.106">             this.mDefaultTimezone = null;</span>
<a href="#l73.107"></a><span id="l73.107">         }</span>
<a href="#l73.108"></a><span id="l73.108">     }</span>
<a href="#l73.109"></a><span id="l73.109"> };</span>
<a href="#l73.110"></a><span id="l73.110"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -39,17 +39,17 @@ calTodo.prototype = {</span>
<a href="#l74.4"></a><span id="l74.4">     }),</span>
<a href="#l74.5"></a><span id="l74.5"> </span>
<a href="#l74.6"></a><span id="l74.6">     cloneShallow: function(aNewParent) {</span>
<a href="#l74.7"></a><span id="l74.7">         let m = new calTodo();</span>
<a href="#l74.8"></a><span id="l74.8">         this.cloneItemBaseInto(m, aNewParent);</span>
<a href="#l74.9"></a><span id="l74.9">         return m;</span>
<a href="#l74.10"></a><span id="l74.10">     },</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-    createProxy: function calTodo_createProxy(aRecurrenceId) {</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+    createProxy: function(aRecurrenceId) {</span>
<a href="#l74.14"></a><span id="l74.14">         cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l74.15"></a><span id="l74.15"> </span>
<a href="#l74.16"></a><span id="l74.16">         let m = new calTodo();</span>
<a href="#l74.17"></a><span id="l74.17"> </span>
<a href="#l74.18"></a><span id="l74.18">         // override proxy's DTSTART/DUE/RECURRENCE-ID</span>
<a href="#l74.19"></a><span id="l74.19">         // before master is set (and item might get immutable):</span>
<a href="#l74.20"></a><span id="l74.20">         let duration = this.duration;</span>
<a href="#l74.21"></a><span id="l74.21">         if (duration) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -24,62 +24,58 @@ calTransactionManager.prototype = {</span>
<a href="#l75.4"></a><span id="l75.4">         classID: calTransactionManagerClassID,</span>
<a href="#l75.5"></a><span id="l75.5">         classDescription: &quot;Calendar Transaction Manager&quot;,</span>
<a href="#l75.6"></a><span id="l75.6">         contractID: &quot;mozilla.org/calendar/transactionmanager;1&quot;,</span>
<a href="#l75.7"></a><span id="l75.7">         interfaces: calTransactionManagerInterfaces,</span>
<a href="#l75.8"></a><span id="l75.8">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l75.9"></a><span id="l75.9">     }),</span>
<a href="#l75.10"></a><span id="l75.10"> </span>
<a href="#l75.11"></a><span id="l75.11">     transactionManager: null,</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-    createAndCommitTxn: function cTM_createAndCommitTxn(aAction,</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineminus">-                                                        aItem,</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-                                                        aCalendar,</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineminus">-                                                        aOldItem,</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineminus">-                                                        aListener) {</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineplus">+    createAndCommitTxn: function(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l75.18"></a><span id="l75.18">         let txn = new calTransaction(aAction,</span>
<a href="#l75.19"></a><span id="l75.19">                                      aItem,</span>
<a href="#l75.20"></a><span id="l75.20">                                      aCalendar,</span>
<a href="#l75.21"></a><span id="l75.21">                                      aOldItem,</span>
<a href="#l75.22"></a><span id="l75.22">                                      aListener);</span>
<a href="#l75.23"></a><span id="l75.23">         this.transactionManager.doTransaction(txn);</span>
<a href="#l75.24"></a><span id="l75.24">     },</span>
<a href="#l75.25"></a><span id="l75.25"> </span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-    beginBatch: function cTM_beginBatch() {</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+    beginBatch: function() {</span>
<a href="#l75.28"></a><span id="l75.28">         this.transactionManager.beginBatch(null);</span>
<a href="#l75.29"></a><span id="l75.29">     },</span>
<a href="#l75.30"></a><span id="l75.30"> </span>
<a href="#l75.31"></a><span id="l75.31" class="difflineminus">-    endBatch: function cTM_endBatch() {</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineplus">+    endBatch: function() {</span>
<a href="#l75.33"></a><span id="l75.33">         this.transactionManager.endBatch(false);</span>
<a href="#l75.34"></a><span id="l75.34">     },</span>
<a href="#l75.35"></a><span id="l75.35"> </span>
<a href="#l75.36"></a><span id="l75.36" class="difflineminus">-    checkWritable: function cTM_checkWritable(transaction) {</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineplus">+    checkWritable: function(transaction) {</span>
<a href="#l75.38"></a><span id="l75.38">         function checkItem(item) {</span>
<a href="#l75.39"></a><span id="l75.39">             return item &amp;&amp; item.calendar &amp;&amp;</span>
<a href="#l75.40"></a><span id="l75.40">                    isCalendarWritable(item.calendar) &amp;&amp;</span>
<a href="#l75.41"></a><span id="l75.41">                    userCanAddItemsToCalendar(item.calendar);</span>
<a href="#l75.42"></a><span id="l75.42">         }</span>
<a href="#l75.43"></a><span id="l75.43"> </span>
<a href="#l75.44"></a><span id="l75.44">         let trans = transaction &amp;&amp; transaction.wrappedJSObject;</span>
<a href="#l75.45"></a><span id="l75.45">         return trans &amp;&amp; checkItem(trans.mItem) &amp;&amp; checkItem(trans.mOldItem);</span>
<a href="#l75.46"></a><span id="l75.46">     },</span>
<a href="#l75.47"></a><span id="l75.47"> </span>
<a href="#l75.48"></a><span id="l75.48" class="difflineminus">-    undo: function cTM_undo() {</span>
<a href="#l75.49"></a><span id="l75.49" class="difflineplus">+    undo: function() {</span>
<a href="#l75.50"></a><span id="l75.50">         this.transactionManager.undoTransaction();</span>
<a href="#l75.51"></a><span id="l75.51">     },</span>
<a href="#l75.52"></a><span id="l75.52"> </span>
<a href="#l75.53"></a><span id="l75.53" class="difflineminus">-    canUndo: function cTM_canUndo() {</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineplus">+    canUndo: function() {</span>
<a href="#l75.55"></a><span id="l75.55">         return this.transactionManager.numberOfUndoItems &gt; 0 &amp;&amp;</span>
<a href="#l75.56"></a><span id="l75.56">                this.checkWritable(this.transactionManager.peekUndoStack());</span>
<a href="#l75.57"></a><span id="l75.57">     },</span>
<a href="#l75.58"></a><span id="l75.58"> </span>
<a href="#l75.59"></a><span id="l75.59" class="difflineminus">-    redo: function cTM_redo() {</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineplus">+    redo: function() {</span>
<a href="#l75.61"></a><span id="l75.61">         this.transactionManager.redoTransaction();</span>
<a href="#l75.62"></a><span id="l75.62">     },</span>
<a href="#l75.63"></a><span id="l75.63"> </span>
<a href="#l75.64"></a><span id="l75.64" class="difflineminus">-    canRedo: function cTM_canRedo() {</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+    canRedo: function() {</span>
<a href="#l75.66"></a><span id="l75.66">         return this.transactionManager.numberOfRedoItems &gt; 0 &amp;&amp;</span>
<a href="#l75.67"></a><span id="l75.67">                this.checkWritable(this.transactionManager.peekRedoStack());</span>
<a href="#l75.68"></a><span id="l75.68">     }</span>
<a href="#l75.69"></a><span id="l75.69"> };</span>
<a href="#l75.70"></a><span id="l75.70"> </span>
<a href="#l75.71"></a><span id="l75.71"> function calTransaction(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l75.72"></a><span id="l75.72">     this.wrappedJSObject = this;</span>
<a href="#l75.73"></a><span id="l75.73">     this.mAction = aAction;</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineat">@@ -107,21 +103,17 @@ calTransaction.prototype = {</span>
<a href="#l75.75"></a><span id="l75.75">     mAction: null,</span>
<a href="#l75.76"></a><span id="l75.76">     mCalendar: null,</span>
<a href="#l75.77"></a><span id="l75.77">     mItem: null,</span>
<a href="#l75.78"></a><span id="l75.78">     mOldItem: null,</span>
<a href="#l75.79"></a><span id="l75.79">     mOldCalendar: null,</span>
<a href="#l75.80"></a><span id="l75.80">     mListener: null,</span>
<a href="#l75.81"></a><span id="l75.81">     mIsDoTransaction: false,</span>
<a href="#l75.82"></a><span id="l75.82"> </span>
<a href="#l75.83"></a><span id="l75.83" class="difflineminus">-    onOperationComplete: function cT_onOperationComplete(aCalendar,</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineminus">-                                                         aStatus,</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineminus">-                                                         aOperationType,</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineminus">-                                                         aId,</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineminus">-                                                         aDetail) {</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineplus">+    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l75.89"></a><span id="l75.89">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l75.90"></a><span id="l75.90">             cal.itip.checkAndSend(aOperationType,</span>
<a href="#l75.91"></a><span id="l75.91">                                   aDetail,</span>
<a href="#l75.92"></a><span id="l75.92">                                   this.mIsDoTransaction ? this.mOldItem : this.mItem);</span>
<a href="#l75.93"></a><span id="l75.93"> </span>
<a href="#l75.94"></a><span id="l75.94">             if (aOperationType == Components.interfaces.calIOperationListener.ADD ||</span>
<a href="#l75.95"></a><span id="l75.95">                 aOperationType == Components.interfaces.calIOperationListener.MODIFY) {</span>
<a href="#l75.96"></a><span id="l75.96">                 if (this.mIsDoTransaction) {</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineat">@@ -135,47 +127,38 @@ calTransaction.prototype = {</span>
<a href="#l75.98"></a><span id="l75.98">             this.mListener.onOperationComplete(aCalendar,</span>
<a href="#l75.99"></a><span id="l75.99">                                                aStatus,</span>
<a href="#l75.100"></a><span id="l75.100">                                                aOperationType,</span>
<a href="#l75.101"></a><span id="l75.101">                                                aId,</span>
<a href="#l75.102"></a><span id="l75.102">                                                aDetail);</span>
<a href="#l75.103"></a><span id="l75.103">         }</span>
<a href="#l75.104"></a><span id="l75.104">     },</span>
<a href="#l75.105"></a><span id="l75.105"> </span>
<a href="#l75.106"></a><span id="l75.106" class="difflineminus">-    onGetResult: function cT_onGetResult(aCalendar,</span>
<a href="#l75.107"></a><span id="l75.107" class="difflineminus">-                                         aStatus,</span>
<a href="#l75.108"></a><span id="l75.108" class="difflineminus">-                                         aItemType,</span>
<a href="#l75.109"></a><span id="l75.109" class="difflineminus">-                                         aDetail,</span>
<a href="#l75.110"></a><span id="l75.110" class="difflineminus">-                                         aCount,</span>
<a href="#l75.111"></a><span id="l75.111" class="difflineminus">-                                         aItems) {</span>
<a href="#l75.112"></a><span id="l75.112" class="difflineplus">+    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l75.113"></a><span id="l75.113">         if (this.mListener) {</span>
<a href="#l75.114"></a><span id="l75.114">             this.mListener.onGetResult(aCalendar,</span>
<a href="#l75.115"></a><span id="l75.115">                                        aStatus,</span>
<a href="#l75.116"></a><span id="l75.116">                                        aItemType,</span>
<a href="#l75.117"></a><span id="l75.117">                                        aDetail,</span>
<a href="#l75.118"></a><span id="l75.118">                                        aCount,</span>
<a href="#l75.119"></a><span id="l75.119">                                        aItems);</span>
<a href="#l75.120"></a><span id="l75.120">         }</span>
<a href="#l75.121"></a><span id="l75.121">     },</span>
<a href="#l75.122"></a><span id="l75.122"> </span>
<a href="#l75.123"></a><span id="l75.123" class="difflineminus">-    doTransaction: function cT_doTransaction() {</span>
<a href="#l75.124"></a><span id="l75.124" class="difflineplus">+    doTransaction: function() {</span>
<a href="#l75.125"></a><span id="l75.125">         this.mIsDoTransaction = true;</span>
<a href="#l75.126"></a><span id="l75.126">         switch (this.mAction) {</span>
<a href="#l75.127"></a><span id="l75.127">             case &quot;add&quot;:</span>
<a href="#l75.128"></a><span id="l75.128">                 this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l75.129"></a><span id="l75.129">                 break;</span>
<a href="#l75.130"></a><span id="l75.130">             case &quot;modify&quot;:</span>
<a href="#l75.131"></a><span id="l75.131">                 if (this.mItem.calendar.id != this.mOldItem.calendar.id) {</span>
<a href="#l75.132"></a><span id="l75.132">                     let self = this;</span>
<a href="#l75.133"></a><span id="l75.133">                     let addListener = {</span>
<a href="#l75.134"></a><span id="l75.134" class="difflineminus">-                        onOperationComplete: function cT_onOperationComplete(aCalendar,</span>
<a href="#l75.135"></a><span id="l75.135" class="difflineminus">-                                                                             aStatus,</span>
<a href="#l75.136"></a><span id="l75.136" class="difflineminus">-                                                                             aOperationType,</span>
<a href="#l75.137"></a><span id="l75.137" class="difflineminus">-                                                                             aId,</span>
<a href="#l75.138"></a><span id="l75.138" class="difflineminus">-                                                                             aDetail) {</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineplus">+                        onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l75.140"></a><span id="l75.140">                             self.onOperationComplete.apply(self, arguments);</span>
<a href="#l75.141"></a><span id="l75.141">                             if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l75.142"></a><span id="l75.142">                                 self.mOldItem.calendar.deleteItem(self.mOldItem, self);</span>
<a href="#l75.143"></a><span id="l75.143">                             }</span>
<a href="#l75.144"></a><span id="l75.144">                         }</span>
<a href="#l75.145"></a><span id="l75.145">                     };</span>
<a href="#l75.146"></a><span id="l75.146"> </span>
<a href="#l75.147"></a><span id="l75.147">                     this.mOldCalendar = this.mOldItem.calendar;</span>
<a href="#l75.148"></a><span id="l75.148" class="difflineat">@@ -190,17 +173,17 @@ calTransaction.prototype = {</span>
<a href="#l75.149"></a><span id="l75.149">                 this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l75.150"></a><span id="l75.150">                 break;</span>
<a href="#l75.151"></a><span id="l75.151">             default:</span>
<a href="#l75.152"></a><span id="l75.152">                 throw new Components.Exception(&quot;Invalid action specified&quot;,</span>
<a href="#l75.153"></a><span id="l75.153">                                                Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l75.154"></a><span id="l75.154">         }</span>
<a href="#l75.155"></a><span id="l75.155">     },</span>
<a href="#l75.156"></a><span id="l75.156"> </span>
<a href="#l75.157"></a><span id="l75.157" class="difflineminus">-    undoTransaction: function cT_undoTransaction() {</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineplus">+    undoTransaction: function() {</span>
<a href="#l75.159"></a><span id="l75.159">         this.mIsDoTransaction = false;</span>
<a href="#l75.160"></a><span id="l75.160">         switch (this.mAction) {</span>
<a href="#l75.161"></a><span id="l75.161">             case &quot;add&quot;:</span>
<a href="#l75.162"></a><span id="l75.162">                 this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l75.163"></a><span id="l75.163">                 break;</span>
<a href="#l75.164"></a><span id="l75.164">             case &quot;modify&quot;:</span>
<a href="#l75.165"></a><span id="l75.165">                 if (this.mOldItem.calendar.id != this.mItem.calendar.id) {</span>
<a href="#l75.166"></a><span id="l75.166">                     this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l75.167"></a><span id="l75.167" class="difflineat">@@ -214,19 +197,19 @@ calTransaction.prototype = {</span>
<a href="#l75.168"></a><span id="l75.168">                 this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l75.169"></a><span id="l75.169">                 break;</span>
<a href="#l75.170"></a><span id="l75.170">             default:</span>
<a href="#l75.171"></a><span id="l75.171">                 throw new Components.Exception(&quot;Invalid action specified&quot;,</span>
<a href="#l75.172"></a><span id="l75.172">                                                Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l75.173"></a><span id="l75.173">         }</span>
<a href="#l75.174"></a><span id="l75.174">     },</span>
<a href="#l75.175"></a><span id="l75.175"> </span>
<a href="#l75.176"></a><span id="l75.176" class="difflineminus">-    redoTransaction: function cT_redoTransaction() {</span>
<a href="#l75.177"></a><span id="l75.177" class="difflineplus">+    redoTransaction: function() {</span>
<a href="#l75.178"></a><span id="l75.178">         this.doTransaction();</span>
<a href="#l75.179"></a><span id="l75.179">     },</span>
<a href="#l75.180"></a><span id="l75.180"> </span>
<a href="#l75.181"></a><span id="l75.181">     isTransient: false,</span>
<a href="#l75.182"></a><span id="l75.182"> </span>
<a href="#l75.183"></a><span id="l75.183" class="difflineminus">-    merge: function cT_merge(aTransaction) {</span>
<a href="#l75.184"></a><span id="l75.184" class="difflineplus">+    merge: function(aTransaction) {</span>
<a href="#l75.185"></a><span id="l75.185">         // No support for merging</span>
<a href="#l75.186"></a><span id="l75.186">         return false;</span>
<a href="#l75.187"></a><span id="l75.187">     }</span>
<a href="#l75.188"></a><span id="l75.188"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -1183,63 +1183,63 @@ function calInterfaceBag(iid) {</span>
<a href="#l76.4"></a><span id="l76.4"> calInterfaceBag.prototype = {</span>
<a href="#l76.5"></a><span id="l76.5">     mIid: null,</span>
<a href="#l76.6"></a><span id="l76.6">     mInterfaces: null,</span>
<a href="#l76.7"></a><span id="l76.7"> </span>
<a href="#l76.8"></a><span id="l76.8">     // Iterating the inteface bag iterates the interfaces it contains</span>
<a href="#l76.9"></a><span id="l76.9">     [Symbol.iterator]: function() { return this.mInterfaces[Symbol.iterator](); },</span>
<a href="#l76.10"></a><span id="l76.10"> </span>
<a href="#l76.11"></a><span id="l76.11">     // internal:</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-    init: function calInterfaceBag_init(iid) {</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+    init: function(iid) {</span>
<a href="#l76.14"></a><span id="l76.14">         this.mIid = iid;</span>
<a href="#l76.15"></a><span id="l76.15">         this.mInterfaces = [];</span>
<a href="#l76.16"></a><span id="l76.16">     },</span>
<a href="#l76.17"></a><span id="l76.17"> </span>
<a href="#l76.18"></a><span id="l76.18">     // external:</span>
<a href="#l76.19"></a><span id="l76.19">     get size() {</span>
<a href="#l76.20"></a><span id="l76.20">         return this.mInterfaces.length;</span>
<a href="#l76.21"></a><span id="l76.21">     },</span>
<a href="#l76.22"></a><span id="l76.22"> </span>
<a href="#l76.23"></a><span id="l76.23">     get interfaceArray() {</span>
<a href="#l76.24"></a><span id="l76.24">         return this.mInterfaces;</span>
<a href="#l76.25"></a><span id="l76.25">     },</span>
<a href="#l76.26"></a><span id="l76.26"> </span>
<a href="#l76.27"></a><span id="l76.27" class="difflineminus">-    add: function calInterfaceBag_add(iface) {</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+    add: function(iface) {</span>
<a href="#l76.29"></a><span id="l76.29">         if (iface) {</span>
<a href="#l76.30"></a><span id="l76.30">             let existing = this.mInterfaces.some(obj =&gt; {</span>
<a href="#l76.31"></a><span id="l76.31">                 return compareObjects(obj, iface, this.mIid);</span>
<a href="#l76.32"></a><span id="l76.32">             });</span>
<a href="#l76.33"></a><span id="l76.33">             if (!existing) {</span>
<a href="#l76.34"></a><span id="l76.34">                 this.mInterfaces.push(iface);</span>
<a href="#l76.35"></a><span id="l76.35">             }</span>
<a href="#l76.36"></a><span id="l76.36">             return !existing;</span>
<a href="#l76.37"></a><span id="l76.37">         }</span>
<a href="#l76.38"></a><span id="l76.38">         return false;</span>
<a href="#l76.39"></a><span id="l76.39">     },</span>
<a href="#l76.40"></a><span id="l76.40"> </span>
<a href="#l76.41"></a><span id="l76.41" class="difflineminus">-    remove: function calInterfaceBag_remove(iface) {</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineplus">+    remove: function(iface) {</span>
<a href="#l76.43"></a><span id="l76.43">         if (iface) {</span>
<a href="#l76.44"></a><span id="l76.44">             this.mInterfaces = this.mInterfaces.filter((obj) =&gt; {</span>
<a href="#l76.45"></a><span id="l76.45">                 return !compareObjects(obj, iface, this.mIid);</span>
<a href="#l76.46"></a><span id="l76.46">             });</span>
<a href="#l76.47"></a><span id="l76.47">         }</span>
<a href="#l76.48"></a><span id="l76.48">     },</span>
<a href="#l76.49"></a><span id="l76.49"> </span>
<a href="#l76.50"></a><span id="l76.50" class="difflineminus">-    forEach: function calInterfaceBag_forEach(func) {</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+    forEach: function(func) {</span>
<a href="#l76.52"></a><span id="l76.52">         this.mInterfaces.forEach(func);</span>
<a href="#l76.53"></a><span id="l76.53">     }</span>
<a href="#l76.54"></a><span id="l76.54"> };</span>
<a href="#l76.55"></a><span id="l76.55"> </span>
<a href="#l76.56"></a><span id="l76.56"> function calListenerBag(iid) {</span>
<a href="#l76.57"></a><span id="l76.57">     this.init(iid);</span>
<a href="#l76.58"></a><span id="l76.58"> }</span>
<a href="#l76.59"></a><span id="l76.59"> calListenerBag.prototype = {</span>
<a href="#l76.60"></a><span id="l76.60">     __proto__: calInterfaceBag.prototype,</span>
<a href="#l76.61"></a><span id="l76.61"> </span>
<a href="#l76.62"></a><span id="l76.62" class="difflineminus">-    notify: function calListenerBag_notify(func, args) {</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+    notify: function(func, args) {</span>
<a href="#l76.64"></a><span id="l76.64">         function notifyFunc(iface) {</span>
<a href="#l76.65"></a><span id="l76.65">             try {</span>
<a href="#l76.66"></a><span id="l76.66">                 iface[func].apply(iface, args ? args : []);</span>
<a href="#l76.67"></a><span id="l76.67">             } catch (exc) {</span>
<a href="#l76.68"></a><span id="l76.68">                 let stack = exc.stack || (exc.location ? exc.location.formattedStack : null);</span>
<a href="#l76.69"></a><span id="l76.69">                 Components.utils.reportError(exc + &quot;\nSTACK: &quot; + stack);</span>
<a href="#l76.70"></a><span id="l76.70">             }</span>
<a href="#l76.71"></a><span id="l76.71">         }</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineat">@@ -1289,60 +1289,60 @@ function calOperationGroup(cancelFunc) {</span>
<a href="#l76.73"></a><span id="l76.73"> }</span>
<a href="#l76.74"></a><span id="l76.74"> calOperationGroup.prototype = {</span>
<a href="#l76.75"></a><span id="l76.75">     mCancelFunc: null,</span>
<a href="#l76.76"></a><span id="l76.76">     mId: null,</span>
<a href="#l76.77"></a><span id="l76.77">     mIsPending: true,</span>
<a href="#l76.78"></a><span id="l76.78">     mStatus: Components.results.NS_OK,</span>
<a href="#l76.79"></a><span id="l76.79">     mSubOperations: null,</span>
<a href="#l76.80"></a><span id="l76.80"> </span>
<a href="#l76.81"></a><span id="l76.81" class="difflineminus">-    add: function calOperationGroup_add(op) {</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineplus">+    add: function(op) {</span>
<a href="#l76.83"></a><span id="l76.83">         if (op &amp;&amp; op.isPending) {</span>
<a href="#l76.84"></a><span id="l76.84">             this.mSubOperations.push(op);</span>
<a href="#l76.85"></a><span id="l76.85">         }</span>
<a href="#l76.86"></a><span id="l76.86">     },</span>
<a href="#l76.87"></a><span id="l76.87"> </span>
<a href="#l76.88"></a><span id="l76.88" class="difflineminus">-    remove: function calOperationGroup_remove(op) {</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineplus">+    remove: function(op) {</span>
<a href="#l76.90"></a><span id="l76.90">         if (op) {</span>
<a href="#l76.91"></a><span id="l76.91">             this.mSubOperations = this.mSubOperations.filter(op_ =&gt; op.id != op_.id);</span>
<a href="#l76.92"></a><span id="l76.92">         }</span>
<a href="#l76.93"></a><span id="l76.93">     },</span>
<a href="#l76.94"></a><span id="l76.94"> </span>
<a href="#l76.95"></a><span id="l76.95">     get isEmpty() {</span>
<a href="#l76.96"></a><span id="l76.96">         return (this.mSubOperations.length == 0);</span>
<a href="#l76.97"></a><span id="l76.97">     },</span>
<a href="#l76.98"></a><span id="l76.98"> </span>
<a href="#l76.99"></a><span id="l76.99" class="difflineminus">-    notifyCompleted: function calOperationGroup_notifyCompleted(status) {</span>
<a href="#l76.100"></a><span id="l76.100" class="difflineplus">+    notifyCompleted: function(status) {</span>
<a href="#l76.101"></a><span id="l76.101">         ASSERT(this.isPending, &quot;[calOperationGroup_notifyCompleted] this.isPending&quot;);</span>
<a href="#l76.102"></a><span id="l76.102">         if (this.isPending) {</span>
<a href="#l76.103"></a><span id="l76.103">             this.mIsPending = false;</span>
<a href="#l76.104"></a><span id="l76.104">             if (status) {</span>
<a href="#l76.105"></a><span id="l76.105">                 this.mStatus = status;</span>
<a href="#l76.106"></a><span id="l76.106">             }</span>
<a href="#l76.107"></a><span id="l76.107">         }</span>
<a href="#l76.108"></a><span id="l76.108">     },</span>
<a href="#l76.109"></a><span id="l76.109"> </span>
<a href="#l76.110"></a><span id="l76.110" class="difflineminus">-    toString: function calOperationGroup_toString() {</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineplus">+    toString: function() {</span>
<a href="#l76.112"></a><span id="l76.112">         return &quot;[calOperationGroup] id=&quot; + this.id;</span>
<a href="#l76.113"></a><span id="l76.113">     },</span>
<a href="#l76.114"></a><span id="l76.114"> </span>
<a href="#l76.115"></a><span id="l76.115">     // calIOperation:</span>
<a href="#l76.116"></a><span id="l76.116">     get id() {</span>
<a href="#l76.117"></a><span id="l76.117">         return this.mId;</span>
<a href="#l76.118"></a><span id="l76.118">     },</span>
<a href="#l76.119"></a><span id="l76.119"> </span>
<a href="#l76.120"></a><span id="l76.120">     get isPending() {</span>
<a href="#l76.121"></a><span id="l76.121">         return this.mIsPending;</span>
<a href="#l76.122"></a><span id="l76.122">     },</span>
<a href="#l76.123"></a><span id="l76.123"> </span>
<a href="#l76.124"></a><span id="l76.124">     get status() {</span>
<a href="#l76.125"></a><span id="l76.125">         return this.mStatus;</span>
<a href="#l76.126"></a><span id="l76.126">     },</span>
<a href="#l76.127"></a><span id="l76.127"> </span>
<a href="#l76.128"></a><span id="l76.128" class="difflineminus">-    cancel: function calOperationGroup_cancel(status) {</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineplus">+    cancel: function(status) {</span>
<a href="#l76.130"></a><span id="l76.130">         if (this.isPending) {</span>
<a href="#l76.131"></a><span id="l76.131">             if (!status) {</span>
<a href="#l76.132"></a><span id="l76.132">                 status = Components.interfaces.calIErrors.OPERATION_CANCELLED;</span>
<a href="#l76.133"></a><span id="l76.133">             }</span>
<a href="#l76.134"></a><span id="l76.134">             this.notifyCompleted(status);</span>
<a href="#l76.135"></a><span id="l76.135">             let cancelFunc = this.mCancelFunc;</span>
<a href="#l76.136"></a><span id="l76.136">             if (cancelFunc) {</span>
<a href="#l76.137"></a><span id="l76.137">                 this.mCancelFunc = null;</span>
<a href="#l76.138"></a><span id="l76.138" class="difflineat">@@ -1583,44 +1583,44 @@ function setItemProperty(item, propertyN</span>
<a href="#l76.139"></a><span id="l76.139">  * Implements a property bag.</span>
<a href="#l76.140"></a><span id="l76.140">  */</span>
<a href="#l76.141"></a><span id="l76.141"> function calPropertyBag() {</span>
<a href="#l76.142"></a><span id="l76.142">     this.mData = {};</span>
<a href="#l76.143"></a><span id="l76.143"> }</span>
<a href="#l76.144"></a><span id="l76.144"> calPropertyBag.prototype = {</span>
<a href="#l76.145"></a><span id="l76.145">     mData: null,</span>
<a href="#l76.146"></a><span id="l76.146"> </span>
<a href="#l76.147"></a><span id="l76.147" class="difflineminus">-    setProperty: function cpb_setProperty(aName, aValue) {</span>
<a href="#l76.148"></a><span id="l76.148" class="difflineplus">+    setProperty: function(aName, aValue) {</span>
<a href="#l76.149"></a><span id="l76.149">         return (this.mData[aName] = aValue);</span>
<a href="#l76.150"></a><span id="l76.150">     },</span>
<a href="#l76.151"></a><span id="l76.151" class="difflineminus">-    getProperty_: function cpb_getProperty(aName) {</span>
<a href="#l76.152"></a><span id="l76.152" class="difflineplus">+    getProperty_: function(aName) {</span>
<a href="#l76.153"></a><span id="l76.153">         // avoid strict undefined property warning</span>
<a href="#l76.154"></a><span id="l76.154">         return (aName in this.mData ? this.mData[aName] : undefined);</span>
<a href="#l76.155"></a><span id="l76.155">     },</span>
<a href="#l76.156"></a><span id="l76.156" class="difflineminus">-    getProperty: function cpb_getProperty(aName) {</span>
<a href="#l76.157"></a><span id="l76.157" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l76.158"></a><span id="l76.158">         // avoid strict undefined property warning</span>
<a href="#l76.159"></a><span id="l76.159">         return (aName in this.mData ? this.mData[aName] : null);</span>
<a href="#l76.160"></a><span id="l76.160">     },</span>
<a href="#l76.161"></a><span id="l76.161" class="difflineminus">-    getAllProperties: function cpb_getAllProperties(aOutKeys, aOutValues) {</span>
<a href="#l76.162"></a><span id="l76.162" class="difflineplus">+    getAllProperties: function(aOutKeys, aOutValues) {</span>
<a href="#l76.163"></a><span id="l76.163">         let keys = [];</span>
<a href="#l76.164"></a><span id="l76.164">         let values = [];</span>
<a href="#l76.165"></a><span id="l76.165">         for (let key in this.mData) {</span>
<a href="#l76.166"></a><span id="l76.166">             keys.push(key);</span>
<a href="#l76.167"></a><span id="l76.167">             values.push(this.mData[key]);</span>
<a href="#l76.168"></a><span id="l76.168">         }</span>
<a href="#l76.169"></a><span id="l76.169">         aOutKeys.value = keys;</span>
<a href="#l76.170"></a><span id="l76.170">         aOutValues.value = values;</span>
<a href="#l76.171"></a><span id="l76.171">     },</span>
<a href="#l76.172"></a><span id="l76.172" class="difflineminus">-    deleteProperty: function cpb_deleteProperty(aName) {</span>
<a href="#l76.173"></a><span id="l76.173" class="difflineplus">+    deleteProperty: function(aName) {</span>
<a href="#l76.174"></a><span id="l76.174">         delete this.mData[aName];</span>
<a href="#l76.175"></a><span id="l76.175">     },</span>
<a href="#l76.176"></a><span id="l76.176">     get enumerator() {</span>
<a href="#l76.177"></a><span id="l76.177">         return new calPropertyBagEnumerator(this);</span>
<a href="#l76.178"></a><span id="l76.178">     },</span>
<a href="#l76.179"></a><span id="l76.179" class="difflineminus">-    [Symbol.iterator]: function* cpb_iterator() {</span>
<a href="#l76.180"></a><span id="l76.180" class="difflineplus">+    [Symbol.iterator]: function* () {</span>
<a href="#l76.181"></a><span id="l76.181">         for (let name of Object.keys(this.mData)) {</span>
<a href="#l76.182"></a><span id="l76.182">             yield [name, this.mData[name]];</span>
<a href="#l76.183"></a><span id="l76.183">         }</span>
<a href="#l76.184"></a><span id="l76.184">     }</span>
<a href="#l76.185"></a><span id="l76.185"> };</span>
<a href="#l76.186"></a><span id="l76.186"> // implementation part of calPropertyBag</span>
<a href="#l76.187"></a><span id="l76.187"> function calPropertyBagEnumerator(bag) {</span>
<a href="#l76.188"></a><span id="l76.188">     this.mIndex = 0;</span>
<a href="#l76.189"></a><span id="l76.189" class="difflineat">@@ -1628,29 +1628,29 @@ function calPropertyBagEnumerator(bag) {</span>
<a href="#l76.190"></a><span id="l76.190">     this.mKeys = Object.keys(bag.mData);</span>
<a href="#l76.191"></a><span id="l76.191"> }</span>
<a href="#l76.192"></a><span id="l76.192"> calPropertyBagEnumerator.prototype = {</span>
<a href="#l76.193"></a><span id="l76.193">     mIndex: 0,</span>
<a href="#l76.194"></a><span id="l76.194">     mBag: null,</span>
<a href="#l76.195"></a><span id="l76.195">     mKeys: null,</span>
<a href="#l76.196"></a><span id="l76.196"> </span>
<a href="#l76.197"></a><span id="l76.197">     // nsISimpleEnumerator:</span>
<a href="#l76.198"></a><span id="l76.198" class="difflineminus">-    getNext: function cpb_enum_getNext() {</span>
<a href="#l76.199"></a><span id="l76.199" class="difflineplus">+    getNext: function() {</span>
<a href="#l76.200"></a><span id="l76.200">         if (!this.hasMoreElements()) { // hasMoreElements is called by intention to skip yet deleted properties</span>
<a href="#l76.201"></a><span id="l76.201">             ASSERT(false, Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l76.202"></a><span id="l76.202">             throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l76.203"></a><span id="l76.203">         }</span>
<a href="#l76.204"></a><span id="l76.204">         let name = this.mKeys[this.mIndex++];</span>
<a href="#l76.205"></a><span id="l76.205">         return { // nsIProperty:</span>
<a href="#l76.206"></a><span id="l76.206">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIProperty]),</span>
<a href="#l76.207"></a><span id="l76.207">             name: name,</span>
<a href="#l76.208"></a><span id="l76.208">             value: this.mCurrentValue</span>
<a href="#l76.209"></a><span id="l76.209">         };</span>
<a href="#l76.210"></a><span id="l76.210">     },</span>
<a href="#l76.211"></a><span id="l76.211" class="difflineminus">-    hasMoreElements: function cpb_enum_hasMoreElements() {</span>
<a href="#l76.212"></a><span id="l76.212" class="difflineplus">+    hasMoreElements: function() {</span>
<a href="#l76.213"></a><span id="l76.213">         while (this.mIndex &lt; this.mKeys.length) {</span>
<a href="#l76.214"></a><span id="l76.214">             this.mCurrentValue = this.mBag.mData[this.mKeys[this.mIndex]];</span>
<a href="#l76.215"></a><span id="l76.215">             if (this.mCurrentValue !== undefined) {</span>
<a href="#l76.216"></a><span id="l76.216">                 return true;</span>
<a href="#l76.217"></a><span id="l76.217">             }</span>
<a href="#l76.218"></a><span id="l76.218">             ++this.mIndex;</span>
<a href="#l76.219"></a><span id="l76.219">         }</span>
<a href="#l76.220"></a><span id="l76.220">         return false;</span>
<a href="#l76.221"></a><span id="l76.221" class="difflineat">@@ -1783,17 +1783,17 @@ function binarySearch(itemArray, newItem</span>
<a href="#l76.222"></a><span id="l76.222">             return mid;</span>
<a href="#l76.223"></a><span id="l76.223">         }</span>
<a href="#l76.224"></a><span id="l76.224">     }</span>
<a href="#l76.225"></a><span id="l76.225"> </span>
<a href="#l76.226"></a><span id="l76.226">     if (itemArray.length &lt; 1) {</span>
<a href="#l76.227"></a><span id="l76.227">         return -1;</span>
<a href="#l76.228"></a><span id="l76.228">     }</span>
<a href="#l76.229"></a><span id="l76.229">     if (!comptor) {</span>
<a href="#l76.230"></a><span id="l76.230" class="difflineminus">-        comptor = function defaultComptor(a, b) {</span>
<a href="#l76.231"></a><span id="l76.231" class="difflineplus">+        comptor = function(a, b) {</span>
<a href="#l76.232"></a><span id="l76.232">             return (a &gt; b) - (a &lt; b);</span>
<a href="#l76.233"></a><span id="l76.233">         };</span>
<a href="#l76.234"></a><span id="l76.234">     }</span>
<a href="#l76.235"></a><span id="l76.235">     return binarySearchInternal(0, itemArray.length - 1);</span>
<a href="#l76.236"></a><span id="l76.236"> }</span>
<a href="#l76.237"></a><span id="l76.237"> </span>
<a href="#l76.238"></a><span id="l76.238"> /**</span>
<a href="#l76.239"></a><span id="l76.239">  * Insert a new node underneath the given parentNode, using binary search. See binarySearch</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/import-export/calHtmlExport.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/import-export/calHtmlExport.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -22,29 +22,29 @@ calHtmlExporter.prototype = {</span>
<a href="#l77.4"></a><span id="l77.4"> </span>
<a href="#l77.5"></a><span id="l77.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l77.6"></a><span id="l77.6">         classID: calHtmlExporterClassID,</span>
<a href="#l77.7"></a><span id="l77.7">         contractID: &quot;@mozilla.org/calendar/export;1?type=html&quot;,</span>
<a href="#l77.8"></a><span id="l77.8">         classDescription: &quot;Calendar HTML Exporter&quot;,</span>
<a href="#l77.9"></a><span id="l77.9">         interfaces: calHtmlExporterInterfaces</span>
<a href="#l77.10"></a><span id="l77.10">     }),</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-    getFileTypes: function getFileTypes(aCount) {</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+    getFileTypes: function(aCount) {</span>
<a href="#l77.14"></a><span id="l77.14">         aCount.value = 1;</span>
<a href="#l77.15"></a><span id="l77.15">         let wildmat = &quot;*.html; *.htm&quot;;</span>
<a href="#l77.16"></a><span id="l77.16">         let label = cal.calGetString(&quot;calendar&quot;, &quot;filterHtml&quot;, [wildmat]);</span>
<a href="#l77.17"></a><span id="l77.17">         return [{</span>
<a href="#l77.18"></a><span id="l77.18">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIFileType]),</span>
<a href="#l77.19"></a><span id="l77.19">             defaultExtension: &quot;html&quot;,</span>
<a href="#l77.20"></a><span id="l77.20">             extensionFilter: wildmat,</span>
<a href="#l77.21"></a><span id="l77.21">             description: label</span>
<a href="#l77.22"></a><span id="l77.22">         }];</span>
<a href="#l77.23"></a><span id="l77.23">     },</span>
<a href="#l77.24"></a><span id="l77.24"> </span>
<a href="#l77.25"></a><span id="l77.25" class="difflineminus">-    exportToStream: function html_exportToStream(aStream, aCount, aItems, aTitle) {</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineplus">+    exportToStream: function(aStream, aCount, aItems, aTitle) {</span>
<a href="#l77.27"></a><span id="l77.27">         let document = cal.xml.parseFile(&quot;chrome://calendar-common/skin/printing/calHtmlExport.html&quot;);</span>
<a href="#l77.28"></a><span id="l77.28">         let itemContainer = document.getElementById(&quot;item-container&quot;);</span>
<a href="#l77.29"></a><span id="l77.29">         document.getElementById(&quot;title&quot;).textContent = aTitle || cal.calGetString(&quot;calendar&quot;, &quot;HTMLTitle&quot;);</span>
<a href="#l77.30"></a><span id="l77.30"> </span>
<a href="#l77.31"></a><span id="l77.31">         // Sort aItems</span>
<a href="#l77.32"></a><span id="l77.32">         aItems.sort(function(a, b) {</span>
<a href="#l77.33"></a><span id="l77.33">             let start_a = a[cal.calGetStartDateProp(a)];</span>
<a href="#l77.34"></a><span id="l77.34">             if (!start_a) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/import-export/calIcsImportExport.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/import-export/calIcsImportExport.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -34,17 +34,17 @@ calIcsImporter.prototype = {</span>
<a href="#l78.4"></a><span id="l78.4">         classID: calIcsImporterClassID,</span>
<a href="#l78.5"></a><span id="l78.5">         contractID: &quot;@mozilla.org/calendar/import;1?type=ics&quot;,</span>
<a href="#l78.6"></a><span id="l78.6">         classDescription: &quot;Calendar ICS Importer&quot;,</span>
<a href="#l78.7"></a><span id="l78.7">         interfaces: calIcsImporterInterfaces</span>
<a href="#l78.8"></a><span id="l78.8">     }),</span>
<a href="#l78.9"></a><span id="l78.9"> </span>
<a href="#l78.10"></a><span id="l78.10">     getFileTypes: getIcsFileTypes,</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-    importFromStream: function importFromStream(aStream, aCount) {</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+    importFromStream: function(aStream, aCount) {</span>
<a href="#l78.14"></a><span id="l78.14">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l78.15"></a><span id="l78.15">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l78.16"></a><span id="l78.16">         parser.parseFromStream(aStream, null);</span>
<a href="#l78.17"></a><span id="l78.17">         return parser.getItems(aCount);</span>
<a href="#l78.18"></a><span id="l78.18">     }</span>
<a href="#l78.19"></a><span id="l78.19"> };</span>
<a href="#l78.20"></a><span id="l78.20"> </span>
<a href="#l78.21"></a><span id="l78.21"> // Exporter</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineat">@@ -62,15 +62,15 @@ calIcsExporter.prototype = {</span>
<a href="#l78.23"></a><span id="l78.23">         classID: calIcsExporterClassID,</span>
<a href="#l78.24"></a><span id="l78.24">         contractID: &quot;@mozilla.org/calendar/export;1?type=ics&quot;,</span>
<a href="#l78.25"></a><span id="l78.25">         classDescription: &quot;Calendar ICS Exporter&quot;,</span>
<a href="#l78.26"></a><span id="l78.26">         interfaces: calIcsExporterInterfaces</span>
<a href="#l78.27"></a><span id="l78.27">     }),</span>
<a href="#l78.28"></a><span id="l78.28"> </span>
<a href="#l78.29"></a><span id="l78.29">     getFileTypes: getIcsFileTypes,</span>
<a href="#l78.30"></a><span id="l78.30"> </span>
<a href="#l78.31"></a><span id="l78.31" class="difflineminus">-    exportToStream: function exportToStream(aStream, aCount, aItems) {</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+    exportToStream: function(aStream, aCount, aItems) {</span>
<a href="#l78.33"></a><span id="l78.33">         let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l78.34"></a><span id="l78.34">                                    .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l78.35"></a><span id="l78.35">         serializer.addItems(aItems, aItems.length);</span>
<a href="#l78.36"></a><span id="l78.36">         serializer.serializeToStream(aStream);</span>
<a href="#l78.37"></a><span id="l78.37">     }</span>
<a href="#l78.38"></a><span id="l78.38"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/import-export/calListFormatter.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/import-export/calListFormatter.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -22,14 +22,14 @@ calListFormatter.prototype = {</span>
<a href="#l79.4"></a><span id="l79.4">         classID: calListFormatterClassID,</span>
<a href="#l79.5"></a><span id="l79.5">         contractID: &quot;@mozilla.org/calendar/printformatter;1?type=list&quot;,</span>
<a href="#l79.6"></a><span id="l79.6">         classDescription: &quot;Calendar List Print Formatter&quot;,</span>
<a href="#l79.7"></a><span id="l79.7">         interfaces: calListFormatterInterfaces</span>
<a href="#l79.8"></a><span id="l79.8">     }),</span>
<a href="#l79.9"></a><span id="l79.9"> </span>
<a href="#l79.10"></a><span id="l79.10">     get name() { return cal.calGetString(&quot;calendar&quot;, &quot;formatListName&quot;); },</span>
<a href="#l79.11"></a><span id="l79.11"> </span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-    formatToHtml: function list_formatToHtml(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+    formatToHtml: function(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l79.14"></a><span id="l79.14">         let htmlexporter = Components.classes[&quot;@mozilla.org/calendar/export;1?type=htmllist&quot;]</span>
<a href="#l79.15"></a><span id="l79.15">                                      .createInstance(Components.interfaces.calIExporter);</span>
<a href="#l79.16"></a><span id="l79.16">         htmlexporter.exportToStream(aStream, aCount, aItems, aTitle);</span>
<a href="#l79.17"></a><span id="l79.17">     }</span>
<a href="#l79.18"></a><span id="l79.18"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -26,17 +26,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l80.4"></a><span id="l80.4">         classID: calMonthPrinterClassID,</span>
<a href="#l80.5"></a><span id="l80.5">         contractID: &quot;@mozilla.org/calendar/printformatter;1?type=monthgrid&quot;,</span>
<a href="#l80.6"></a><span id="l80.6">         classDescription: &quot;Calendar Month Grid Print Formatter&quot;,</span>
<a href="#l80.7"></a><span id="l80.7">         interfaces: calMonthPrinterInterfaces</span>
<a href="#l80.8"></a><span id="l80.8">     }),</span>
<a href="#l80.9"></a><span id="l80.9"> </span>
<a href="#l80.10"></a><span id="l80.10">     get name() { return cal.calGetString(&quot;calendar&quot;, &quot;monthPrinterName&quot;); },</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-    formatToHtml: function monthPrint_format(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+    formatToHtml: function(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l80.14"></a><span id="l80.14">         let document = cal.xml.parseFile(&quot;chrome://calendar-common/skin/printing/calMonthGridPrinter.html&quot;);</span>
<a href="#l80.15"></a><span id="l80.15">         let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l80.16"></a><span id="l80.16"> </span>
<a href="#l80.17"></a><span id="l80.17">         // Set page title</span>
<a href="#l80.18"></a><span id="l80.18">         document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l80.19"></a><span id="l80.19"> </span>
<a href="#l80.20"></a><span id="l80.20">         // Table that maps YYYY-MM-DD to the DOM node container where items are to be added</span>
<a href="#l80.21"></a><span id="l80.21">         let dayTable = {};</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineat">@@ -102,17 +102,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l80.23"></a><span id="l80.23">         // Stream out the resulting HTML</span>
<a href="#l80.24"></a><span id="l80.24">         let html = cal.xml.serializeDOM(document);</span>
<a href="#l80.25"></a><span id="l80.25">         let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l80.26"></a><span id="l80.26">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l80.27"></a><span id="l80.27">         convStream.init(aStream, &quot;UTF-8&quot;, 0, 0x0000);</span>
<a href="#l80.28"></a><span id="l80.28">         convStream.writeString(html);</span>
<a href="#l80.29"></a><span id="l80.29">     },</span>
<a href="#l80.30"></a><span id="l80.30"> </span>
<a href="#l80.31"></a><span id="l80.31" class="difflineminus">-    normalizeStartDate: function monthPrint_normalizeStartDate(aStart) {</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineplus">+    normalizeStartDate: function(aStart) {</span>
<a href="#l80.33"></a><span id="l80.33">         // Make sure the start date is really a date.</span>
<a href="#l80.34"></a><span id="l80.34">         let startDate = aStart.clone();</span>
<a href="#l80.35"></a><span id="l80.35">         startDate.isDate = true;</span>
<a href="#l80.36"></a><span id="l80.36"> </span>
<a href="#l80.37"></a><span id="l80.37">         // Find out if the start date is also shown in the first week of the</span>
<a href="#l80.38"></a><span id="l80.38">         // following month. This means we can spare a month printout.</span>
<a href="#l80.39"></a><span id="l80.39">         let firstDayOfNextMonth = startDate.clone();</span>
<a href="#l80.40"></a><span id="l80.40">         firstDayOfNextMonth.day = 1;</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineat">@@ -120,17 +120,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l80.42"></a><span id="l80.42">         if (cal.getWeekInfoService().getStartOfWeek(firstDayOfNextMonth).compare(startDate) &lt;= 0) {</span>
<a href="#l80.43"></a><span id="l80.43">             startDate = firstDayOfNextMonth;</span>
<a href="#l80.44"></a><span id="l80.44">         } else {</span>
<a href="#l80.45"></a><span id="l80.45">             startDate = startDate.startOfMonth;</span>
<a href="#l80.46"></a><span id="l80.46">         }</span>
<a href="#l80.47"></a><span id="l80.47">         return startDate;</span>
<a href="#l80.48"></a><span id="l80.48">     },</span>
<a href="#l80.49"></a><span id="l80.49"> </span>
<a href="#l80.50"></a><span id="l80.50" class="difflineminus">-    normalizeEndDate: function monthPrint_normalizeEndDate(aEnd) {</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineplus">+    normalizeEndDate: function(aEnd) {</span>
<a href="#l80.52"></a><span id="l80.52">         // Copy end date, which is exclusive. For our calculations, we will</span>
<a href="#l80.53"></a><span id="l80.53">         // only be handling dates and the formatToHtml() code is much cleaner with</span>
<a href="#l80.54"></a><span id="l80.54">         // the range being inclusive.</span>
<a href="#l80.55"></a><span id="l80.55">         let endDate = aEnd.clone();</span>
<a href="#l80.56"></a><span id="l80.56">         endDate.isDate = true;</span>
<a href="#l80.57"></a><span id="l80.57"> </span>
<a href="#l80.58"></a><span id="l80.58">         // Find out if the end date is also shown in the last week of the</span>
<a href="#l80.59"></a><span id="l80.59">         // previous month. This also means we can spare a month printout.</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineat">@@ -139,17 +139,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l80.61"></a><span id="l80.61">         lastDayOfPreviousMonth = lastDayOfPreviousMonth.endOfMonth;</span>
<a href="#l80.62"></a><span id="l80.62">         if (cal.getWeekInfoService().getEndOfWeek(lastDayOfPreviousMonth).compare(endDate) &gt;= 0) {</span>
<a href="#l80.63"></a><span id="l80.63">             endDate = lastDayOfPreviousMonth;</span>
<a href="#l80.64"></a><span id="l80.64">         }</span>
<a href="#l80.65"></a><span id="l80.65"> </span>
<a href="#l80.66"></a><span id="l80.66">         return endDate;</span>
<a href="#l80.67"></a><span id="l80.67">     },</span>
<a href="#l80.68"></a><span id="l80.68"> </span>
<a href="#l80.69"></a><span id="l80.69" class="difflineminus">-    setupMonth: function monthPrint_setupMonth(document, startOfMonth, dayTable) {</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineplus">+    setupMonth: function(document, startOfMonth, dayTable) {</span>
<a href="#l80.71"></a><span id="l80.71">         let monthTemplate = document.getElementById(&quot;month-template&quot;);</span>
<a href="#l80.72"></a><span id="l80.72">         let monthContainer = document.getElementById(&quot;month-container&quot;);</span>
<a href="#l80.73"></a><span id="l80.73"> </span>
<a href="#l80.74"></a><span id="l80.74">         // Clone the template month and make sure it doesn't have an id</span>
<a href="#l80.75"></a><span id="l80.75">         let currentMonth = monthTemplate.cloneNode(true);</span>
<a href="#l80.76"></a><span id="l80.76">         currentMonth.removeAttribute(&quot;id&quot;);</span>
<a href="#l80.77"></a><span id="l80.77">         currentMonth.item = startOfMonth.clone();</span>
<a href="#l80.78"></a><span id="l80.78"> </span>
<a href="#l80.79"></a><span id="l80.79" class="difflineat">@@ -180,17 +180,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l80.80"></a><span id="l80.80">         // Now insert the month into the page container, sorting by date (and therefore by month)</span>
<a href="#l80.81"></a><span id="l80.81">         function compareDates(a, b) {</span>
<a href="#l80.82"></a><span id="l80.82">             return !a || !b ? -1 : a.compare(b);</span>
<a href="#l80.83"></a><span id="l80.83">         }</span>
<a href="#l80.84"></a><span id="l80.84"> </span>
<a href="#l80.85"></a><span id="l80.85">         cal.binaryInsertNode(monthContainer, currentMonth, currentMonth.item, compareDates);</span>
<a href="#l80.86"></a><span id="l80.86">     },</span>
<a href="#l80.87"></a><span id="l80.87"> </span>
<a href="#l80.88"></a><span id="l80.88" class="difflineminus">-    setupWeek: function monthPrint_setupWeek(document, weekContainer, startOfWeek, mainMonth, dayTable) {</span>
<a href="#l80.89"></a><span id="l80.89" class="difflineplus">+    setupWeek: function(document, weekContainer, startOfWeek, mainMonth, dayTable) {</span>
<a href="#l80.90"></a><span id="l80.90">         const weekdayMap = [&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;, &quot;saturday&quot;];</span>
<a href="#l80.91"></a><span id="l80.91">         let weekTemplate = document.getElementById(&quot;week-template&quot;);</span>
<a href="#l80.92"></a><span id="l80.92"> </span>
<a href="#l80.93"></a><span id="l80.93">         // Clone the template week and make sure it doesn't have an id</span>
<a href="#l80.94"></a><span id="l80.94">         let currentWeek = weekTemplate.cloneNode(true);</span>
<a href="#l80.95"></a><span id="l80.95">         currentWeek.removeAttribute(&quot;id&quot;);</span>
<a href="#l80.96"></a><span id="l80.96"> </span>
<a href="#l80.97"></a><span id="l80.97">         // Set up day numbers for all days in this week</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -119,17 +119,17 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l81.4"></a><span id="l81.4">      *  default durations are set.</span>
<a href="#l81.5"></a><span id="l81.5">      *</span>
<a href="#l81.6"></a><span id="l81.6">      * The rest of the lines are events, one event per line, with fields in the</span>
<a href="#l81.7"></a><span id="l81.7">      * order descibed by the first line.   All non-empty values must be quoted.</span>
<a href="#l81.8"></a><span id="l81.8">      *</span>
<a href="#l81.9"></a><span id="l81.9">      * Returns: an array of parsed calendarEvents.</span>
<a href="#l81.10"></a><span id="l81.10">      *   If the parse is cancelled, a zero length array is returned.</span>
<a href="#l81.11"></a><span id="l81.11">      */</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-    importFromStream: function csv_importFromStream(aStream, aCount) {</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+    importFromStream: function(aStream, aCount) {</span>
<a href="#l81.14"></a><span id="l81.14">         let scriptableInputStream = Components.classes[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l81.15"></a><span id="l81.15">                                               .createInstance(Components.interfaces.nsIScriptableInputStream);</span>
<a href="#l81.16"></a><span id="l81.16">         scriptableInputStream.init(aStream);</span>
<a href="#l81.17"></a><span id="l81.17">         let str = scriptableInputStream.read(-1);</span>
<a href="#l81.18"></a><span id="l81.18"> </span>
<a href="#l81.19"></a><span id="l81.19">         // parse header line of quoted comma separated column names.</span>
<a href="#l81.20"></a><span id="l81.20">         let trimEndQuotesRegExp = /^&quot;(.*)&quot;$/m;</span>
<a href="#l81.21"></a><span id="l81.21">         let trimResults = trimEndQuotesRegExp.exec(str);</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineat">@@ -358,17 +358,17 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l81.23"></a><span id="l81.23">             eventFields = eventRegExp.exec(str);</span>
<a href="#l81.24"></a><span id="l81.24">         } while (eventRegExp.lastIndex != 0);</span>
<a href="#l81.25"></a><span id="l81.25"> </span>
<a href="#l81.26"></a><span id="l81.26">         // return results</span>
<a href="#l81.27"></a><span id="l81.27">         aCount.value = eventArray.length;</span>
<a href="#l81.28"></a><span id="l81.28">         return eventArray;</span>
<a href="#l81.29"></a><span id="l81.29">     },</span>
<a href="#l81.30"></a><span id="l81.30"> </span>
<a href="#l81.31"></a><span id="l81.31" class="difflineminus">-    parseDateTime: function parseDateTime(aDate, aTime, aLocale) {</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+    parseDateTime: function(aDate, aTime, aLocale) {</span>
<a href="#l81.33"></a><span id="l81.33">         let dt = cal.createDateTime();</span>
<a href="#l81.34"></a><span id="l81.34"> </span>
<a href="#l81.35"></a><span id="l81.35">         // XXX Can we do better?</span>
<a href="#l81.36"></a><span id="l81.36">         dt.timezone = cal.floating();</span>
<a href="#l81.37"></a><span id="l81.37"> </span>
<a href="#l81.38"></a><span id="l81.38">         let rd = aLocale.dateRe.exec(aDate);</span>
<a href="#l81.39"></a><span id="l81.39">         let rt = aLocale.timeRe.exec(aTime);</span>
<a href="#l81.40"></a><span id="l81.40"> </span>
<a href="#l81.41"></a><span id="l81.41" class="difflineat">@@ -395,17 +395,17 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l81.42"></a><span id="l81.42">             }</span>
<a href="#l81.43"></a><span id="l81.43">         } else if (dt.hour &lt; 12) {</span>
<a href="#l81.44"></a><span id="l81.44">            // PM</span>
<a href="#l81.45"></a><span id="l81.45">            dt.hour += 12;</span>
<a href="#l81.46"></a><span id="l81.46">         }</span>
<a href="#l81.47"></a><span id="l81.47">         return dt;</span>
<a href="#l81.48"></a><span id="l81.48">     },</span>
<a href="#l81.49"></a><span id="l81.49"> </span>
<a href="#l81.50"></a><span id="l81.50" class="difflineminus">-    parseTextField: function parseTextField(aTextField) {</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+    parseTextField: function(aTextField) {</span>
<a href="#l81.52"></a><span id="l81.52">         return aTextField ? aTextField.replace(/&quot;&quot;/g, &quot;\&quot;&quot;) : &quot;&quot;;</span>
<a href="#l81.53"></a><span id="l81.53">     }</span>
<a href="#l81.54"></a><span id="l81.54"> };</span>
<a href="#l81.55"></a><span id="l81.55"> </span>
<a href="#l81.56"></a><span id="l81.56"> // Exporter</span>
<a href="#l81.57"></a><span id="l81.57"> function calOutlookCSVExporter() {</span>
<a href="#l81.58"></a><span id="l81.58"> }</span>
<a href="#l81.59"></a><span id="l81.59"> var calOutlookCSVExporterClassID = Components.ID(&quot;{48e6d3a6-b41b-4052-9ed2-40b27800bd4b}&quot;);</span>
<a href="#l81.60"></a><span id="l81.60" class="difflineat">@@ -417,17 +417,17 @@ calOutlookCSVExporter.prototype = {</span>
<a href="#l81.61"></a><span id="l81.61">         classID: calOutlookCSVExporterClassID,</span>
<a href="#l81.62"></a><span id="l81.62">         contractID: &quot;@mozilla.org/calendar/export;1?type=csv&quot;,</span>
<a href="#l81.63"></a><span id="l81.63">         classDescription: &quot;Calendar Outlook CSV Exporter&quot;,</span>
<a href="#l81.64"></a><span id="l81.64">         interfaces: calOutlookCSVExporterInterfaces</span>
<a href="#l81.65"></a><span id="l81.65">     }),</span>
<a href="#l81.66"></a><span id="l81.66"> </span>
<a href="#l81.67"></a><span id="l81.67">     getFileTypes: getOutlookCsvFileTypes,</span>
<a href="#l81.68"></a><span id="l81.68"> </span>
<a href="#l81.69"></a><span id="l81.69" class="difflineminus">-    exportToStream: function csv_exportToStream(aStream, aCount, aItems) {</span>
<a href="#l81.70"></a><span id="l81.70" class="difflineplus">+    exportToStream: function(aStream, aCount, aItems) {</span>
<a href="#l81.71"></a><span id="l81.71">         // Helper functions</span>
<a href="#l81.72"></a><span id="l81.72">         function dateString(aDateTime) { return cal.dateTimeToJsDate(aDateTime).toLocaleFormat(localeEn.dateFormat); }</span>
<a href="#l81.73"></a><span id="l81.73">         function timeString(aDateTime) { return cal.dateTimeToJsDate(aDateTime).toLocaleFormat(localeEn.timeFormat); }</span>
<a href="#l81.74"></a><span id="l81.74">         function txtString(aString) { return aString || &quot;&quot;; }</span>
<a href="#l81.75"></a><span id="l81.75"> </span>
<a href="#l81.76"></a><span id="l81.76">         let str = &quot;&quot;;</span>
<a href="#l81.77"></a><span id="l81.77">         let headers = [];</span>
<a href="#l81.78"></a><span id="l81.78">         // Not using a loop here, since we need to be sure the order here matches</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/import-export/calWeekPrinter.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/import-export/calWeekPrinter.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -26,17 +26,17 @@ calWeekPrinter.prototype = {</span>
<a href="#l82.4"></a><span id="l82.4">         classID: calWeekPrinterClassID,</span>
<a href="#l82.5"></a><span id="l82.5">         contractID: &quot;@mozilla.org/calendar/printformatter;1?type=weekplan&quot;,</span>
<a href="#l82.6"></a><span id="l82.6">         classDescription: &quot;Calendar Week Print Formatter&quot;,</span>
<a href="#l82.7"></a><span id="l82.7">         interfaces: calWeekPrinterInterfaces</span>
<a href="#l82.8"></a><span id="l82.8">     }),</span>
<a href="#l82.9"></a><span id="l82.9"> </span>
<a href="#l82.10"></a><span id="l82.10">     get name() { return cal.calGetString(&quot;calendar&quot;, &quot;weekPrinterName&quot;); },</span>
<a href="#l82.11"></a><span id="l82.11"> </span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-    formatToHtml: function weekPrint_format(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+    formatToHtml: function(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l82.14"></a><span id="l82.14">         let document = cal.xml.parseFile(&quot;chrome://calendar-common/skin/printing/calWeekPrinter.html&quot;);</span>
<a href="#l82.15"></a><span id="l82.15">         let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l82.16"></a><span id="l82.16"> </span>
<a href="#l82.17"></a><span id="l82.17">         // Set page title</span>
<a href="#l82.18"></a><span id="l82.18">         document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l82.19"></a><span id="l82.19"> </span>
<a href="#l82.20"></a><span id="l82.20">         // Table that maps YYYY-MM-DD to the DOM node container where items are to be added</span>
<a href="#l82.21"></a><span id="l82.21">         let dayTable = {};</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineat">@@ -89,17 +89,17 @@ calWeekPrinter.prototype = {</span>
<a href="#l82.23"></a><span id="l82.23">         // Stream out the resulting HTML</span>
<a href="#l82.24"></a><span id="l82.24">         let html = cal.xml.serializeDOM(document);</span>
<a href="#l82.25"></a><span id="l82.25">         let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l82.26"></a><span id="l82.26">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l82.27"></a><span id="l82.27">         convStream.init(aStream, &quot;UTF-8&quot;, 0, 0x0000);</span>
<a href="#l82.28"></a><span id="l82.28">         convStream.writeString(html);</span>
<a href="#l82.29"></a><span id="l82.29">     },</span>
<a href="#l82.30"></a><span id="l82.30"> </span>
<a href="#l82.31"></a><span id="l82.31" class="difflineminus">-    setupWeek: function weekPrint_setupWeek(document, startOfWeek, dayTable) {</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineplus">+    setupWeek: function(document, startOfWeek, dayTable) {</span>
<a href="#l82.33"></a><span id="l82.33">         const weekdayMap = [&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;, &quot;saturday&quot;];</span>
<a href="#l82.34"></a><span id="l82.34"> </span>
<a href="#l82.35"></a><span id="l82.35">         let weekTemplate = document.getElementById(&quot;week-template&quot;);</span>
<a href="#l82.36"></a><span id="l82.36">         let weekContainer = document.getElementById(&quot;week-container&quot;);</span>
<a href="#l82.37"></a><span id="l82.37">         let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l82.38"></a><span id="l82.38"> </span>
<a href="#l82.39"></a><span id="l82.39">         // Clone the template week and make sure it doesn't have an id</span>
<a href="#l82.40"></a><span id="l82.40">         let currentPage = weekTemplate.cloneNode(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -39,17 +39,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l83.4"></a><span id="l83.4">     mSenderAddress: null,</span>
<a href="#l83.5"></a><span id="l83.5">     get senderAddress() {</span>
<a href="#l83.6"></a><span id="l83.6">         return this.mSenderAddress;</span>
<a href="#l83.7"></a><span id="l83.7">     },</span>
<a href="#l83.8"></a><span id="l83.8">     set senderAddress(aValue) {</span>
<a href="#l83.9"></a><span id="l83.9">         return (this.mSenderAddress = aValue);</span>
<a href="#l83.10"></a><span id="l83.10">     },</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-    sendItems: function cietSI(aCount, aRecipients, aItipItem) {</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+    sendItems: function(aCount, aRecipients, aItipItem) {</span>
<a href="#l83.14"></a><span id="l83.14">         if (this.mHasXpcomMail) {</span>
<a href="#l83.15"></a><span id="l83.15">             cal.LOG(&quot;sendItems: Sending Email...&quot;);</span>
<a href="#l83.16"></a><span id="l83.16">             let items = this._prepareItems(aItipItem);</span>
<a href="#l83.17"></a><span id="l83.17">             if (items === false) {</span>
<a href="#l83.18"></a><span id="l83.18">                 return false;</span>
<a href="#l83.19"></a><span id="l83.19">             } else {</span>
<a href="#l83.20"></a><span id="l83.20">                 return this._sendXpcomMail(aRecipients, items.subject, items.body, aItipItem);</span>
<a href="#l83.21"></a><span id="l83.21">             }</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineat">@@ -162,17 +162,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l83.23"></a><span id="l83.23">         }</span>
<a href="#l83.24"></a><span id="l83.24"> </span>
<a href="#l83.25"></a><span id="l83.25">         return {</span>
<a href="#l83.26"></a><span id="l83.26">             subject: subject,</span>
<a href="#l83.27"></a><span id="l83.27">             body: body</span>
<a href="#l83.28"></a><span id="l83.28">         };</span>
<a href="#l83.29"></a><span id="l83.29">     },</span>
<a href="#l83.30"></a><span id="l83.30"> </span>
<a href="#l83.31"></a><span id="l83.31" class="difflineminus">-    _initEmailTransport: function cietIES() {</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+    _initEmailTransport: function() {</span>
<a href="#l83.33"></a><span id="l83.33">         this.mHasXpcomMail = true;</span>
<a href="#l83.34"></a><span id="l83.34"> </span>
<a href="#l83.35"></a><span id="l83.35">         try {</span>
<a href="#l83.36"></a><span id="l83.36">             this.mDefaultSmtpServer = MailServices.smtp.defaultServer;</span>
<a href="#l83.37"></a><span id="l83.37">             this.mDefaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l83.38"></a><span id="l83.38">             this.mDefaultIdentity = this.mDefaultAccount.defaultIdentity;</span>
<a href="#l83.39"></a><span id="l83.39"> </span>
<a href="#l83.40"></a><span id="l83.40">             if (!this.mDefaultIdentity) {</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineat">@@ -190,17 +190,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l83.42"></a><span id="l83.42">                 }</span>
<a href="#l83.43"></a><span id="l83.43">             }</span>
<a href="#l83.44"></a><span id="l83.44">         } catch (ex) {</span>
<a href="#l83.45"></a><span id="l83.45">             // Then we must resort to operating system specific means</span>
<a href="#l83.46"></a><span id="l83.46">             this.mHasXpcomMail = false;</span>
<a href="#l83.47"></a><span id="l83.47">         }</span>
<a href="#l83.48"></a><span id="l83.48">     },</span>
<a href="#l83.49"></a><span id="l83.49"> </span>
<a href="#l83.50"></a><span id="l83.50" class="difflineminus">-    _sendXpcomMail: function cietSXM(aToList, aSubject, aBody, aItem) {</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+    _sendXpcomMail: function(aToList, aSubject, aBody, aItem) {</span>
<a href="#l83.52"></a><span id="l83.52">         let identity = null;</span>
<a href="#l83.53"></a><span id="l83.53">         let account;</span>
<a href="#l83.54"></a><span id="l83.54">         if (aItem.targetCalendar) {</span>
<a href="#l83.55"></a><span id="l83.55">             identity = aItem.targetCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l83.56"></a><span id="l83.56">             if (identity) {</span>
<a href="#l83.57"></a><span id="l83.57">                 identity = identity.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l83.58"></a><span id="l83.58">                 account = aItem.targetCalendar.getProperty(&quot;imip.account&quot;)</span>
<a href="#l83.59"></a><span id="l83.59">                                               .QueryInterface(Components.interfaces.nsIMsgAccount);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -23,17 +23,17 @@ ltnMimeConverter.prototype = {</span>
<a href="#l84.4"></a><span id="l84.4">         classID: ltnMimeConverterClassID,</span>
<a href="#l84.5"></a><span id="l84.5">         contractID: &quot;@mozilla.org/lightning/mime-converter;1&quot;,</span>
<a href="#l84.6"></a><span id="l84.6">         classDescription: &quot;Lightning text/calendar handler&quot;,</span>
<a href="#l84.7"></a><span id="l84.7">         interfaces: ltnMimeConverterInterfaces</span>
<a href="#l84.8"></a><span id="l84.8">     }),</span>
<a href="#l84.9"></a><span id="l84.9"> </span>
<a href="#l84.10"></a><span id="l84.10">     uri: null,</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-    convertToHTML: function lmcCTH(contentType, data) {</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+    convertToHTML: function(contentType, data) {</span>
<a href="#l84.14"></a><span id="l84.14">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l84.15"></a><span id="l84.15">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l84.16"></a><span id="l84.16">         parser.parseString(data);</span>
<a href="#l84.17"></a><span id="l84.17">         let event = null;</span>
<a href="#l84.18"></a><span id="l84.18">         for (let item of parser.getItems({})) {</span>
<a href="#l84.19"></a><span id="l84.19">             if (cal.isEvent(item)) {</span>
<a href="#l84.20"></a><span id="l84.20">                 if (item.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l84.21"></a><span id="l84.21">                     // if it's a faked master, take any overridden item to get a real occurrence:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -18,61 +18,61 @@ var ltnImipBar = {</span>
<a href="#l85.4"></a><span id="l85.4">     actionFunc: null,</span>
<a href="#l85.5"></a><span id="l85.5">     itipItem: null,</span>
<a href="#l85.6"></a><span id="l85.6">     foundItems: null,</span>
<a href="#l85.7"></a><span id="l85.7">     msgOverlay: null,</span>
<a href="#l85.8"></a><span id="l85.8"> </span>
<a href="#l85.9"></a><span id="l85.9">     /**</span>
<a href="#l85.10"></a><span id="l85.10">      * Thunderbird Message listener interface, hide the bar before we begin</span>
<a href="#l85.11"></a><span id="l85.11">      */</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-    onStartHeaders: function onImipStartHeaders() {</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+    onStartHeaders: function() {</span>
<a href="#l85.14"></a><span id="l85.14">       ltnImipBar.resetBar();</span>
<a href="#l85.15"></a><span id="l85.15">     },</span>
<a href="#l85.16"></a><span id="l85.16"> </span>
<a href="#l85.17"></a><span id="l85.17">     /**</span>
<a href="#l85.18"></a><span id="l85.18">      * Thunderbird Message listener interface</span>
<a href="#l85.19"></a><span id="l85.19">      */</span>
<a href="#l85.20"></a><span id="l85.20" class="difflineminus">-    onEndHeaders: function onImipEndHeaders() {</span>
<a href="#l85.21"></a><span id="l85.21" class="difflineplus">+    onEndHeaders: function() {</span>
<a href="#l85.22"></a><span id="l85.22"> </span>
<a href="#l85.23"></a><span id="l85.23">     },</span>
<a href="#l85.24"></a><span id="l85.24"> </span>
<a href="#l85.25"></a><span id="l85.25">     /**</span>
<a href="#l85.26"></a><span id="l85.26">      * Load Handler called to initialize the imip bar</span>
<a href="#l85.27"></a><span id="l85.27">      * NOTE: This function is called without a valid this-context!</span>
<a href="#l85.28"></a><span id="l85.28">      */</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineminus">-    load: function ltnImipOnLoad() {</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineplus">+    load: function() {</span>
<a href="#l85.31"></a><span id="l85.31">         // Add a listener to gMessageListeners defined in msgHdrViewOverlay.js</span>
<a href="#l85.32"></a><span id="l85.32">         gMessageListeners.push(ltnImipBar);</span>
<a href="#l85.33"></a><span id="l85.33"> </span>
<a href="#l85.34"></a><span id="l85.34">         // We need to extend the HideMessageHeaderPane function to also hide the</span>
<a href="#l85.35"></a><span id="l85.35">         // message header pane. Otherwise, the imip bar will still be shown when</span>
<a href="#l85.36"></a><span id="l85.36">         // changing folders.</span>
<a href="#l85.37"></a><span id="l85.37">         ltnImipBar.tbHideMessageHeaderPane = HideMessageHeaderPane;</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineminus">-        HideMessageHeaderPane = function ltnHideMessageHeaderPane() {</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineplus">+        HideMessageHeaderPane = function() {</span>
<a href="#l85.40"></a><span id="l85.40">             ltnImipBar.resetBar();</span>
<a href="#l85.41"></a><span id="l85.41">             ltnImipBar.tbHideMessageHeaderPane.apply(null, arguments);</span>
<a href="#l85.42"></a><span id="l85.42">         };</span>
<a href="#l85.43"></a><span id="l85.43"> </span>
<a href="#l85.44"></a><span id="l85.44">         // Set up our observers</span>
<a href="#l85.45"></a><span id="l85.45">         Services.obs.addObserver(ltnImipBar, &quot;onItipItemCreation&quot;, false);</span>
<a href="#l85.46"></a><span id="l85.46">     },</span>
<a href="#l85.47"></a><span id="l85.47"> </span>
<a href="#l85.48"></a><span id="l85.48">     /**</span>
<a href="#l85.49"></a><span id="l85.49">      * Unload handler to clean up after the imip bar</span>
<a href="#l85.50"></a><span id="l85.50">      * NOTE: This function is called without a valid this-context!</span>
<a href="#l85.51"></a><span id="l85.51">      */</span>
<a href="#l85.52"></a><span id="l85.52" class="difflineminus">-    unload: function ltnImipOnUnload() {</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineplus">+    unload: function() {</span>
<a href="#l85.54"></a><span id="l85.54">         removeEventListener(&quot;messagepane-loaded&quot;, ltnImipBar.load, true);</span>
<a href="#l85.55"></a><span id="l85.55">         removeEventListener(&quot;messagepane-unloaded&quot;, ltnImipBar.unload, true);</span>
<a href="#l85.56"></a><span id="l85.56"> </span>
<a href="#l85.57"></a><span id="l85.57">         ltnImipBar.resetBar();</span>
<a href="#l85.58"></a><span id="l85.58">         Services.obs.removeObserver(ltnImipBar, &quot;onItipItemCreation&quot;);</span>
<a href="#l85.59"></a><span id="l85.59">     },</span>
<a href="#l85.60"></a><span id="l85.60"> </span>
<a href="#l85.61"></a><span id="l85.61" class="difflineminus">-    observe: function ltnImipBar_observe(subject, topic, state) {</span>
<a href="#l85.62"></a><span id="l85.62" class="difflineplus">+    observe: function(subject, topic, state) {</span>
<a href="#l85.63"></a><span id="l85.63">         if (topic == &quot;onItipItemCreation&quot;) {</span>
<a href="#l85.64"></a><span id="l85.64">             let itipItem = null;</span>
<a href="#l85.65"></a><span id="l85.65">             let msgOverlay = null;</span>
<a href="#l85.66"></a><span id="l85.66">             try {</span>
<a href="#l85.67"></a><span id="l85.67">                 if (!subject) {</span>
<a href="#l85.68"></a><span id="l85.68">                     let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l85.69"></a><span id="l85.69">                     // This property was set by lightningTextCalendarConverter.js</span>
<a href="#l85.70"></a><span id="l85.70">                     itipItem = sinkProps.getPropertyAsInterface(&quot;itipItem&quot;,</span>
<a href="#l85.71"></a><span id="l85.71" class="difflineat">@@ -100,71 +100,71 @@ var ltnImipBar = {</span>
<a href="#l85.72"></a><span id="l85.72"> </span>
<a href="#l85.73"></a><span id="l85.73">             cal.itip.processItipItem(itipItem, ltnImipBar.setupOptions);</span>
<a href="#l85.74"></a><span id="l85.74">         }</span>
<a href="#l85.75"></a><span id="l85.75">     },</span>
<a href="#l85.76"></a><span id="l85.76"> </span>
<a href="#l85.77"></a><span id="l85.77">     /**</span>
<a href="#l85.78"></a><span id="l85.78">      * Hide the imip bar and reset the itip item.</span>
<a href="#l85.79"></a><span id="l85.79">      */</span>
<a href="#l85.80"></a><span id="l85.80" class="difflineminus">-    resetBar: function ltnResetImipBar() {</span>
<a href="#l85.81"></a><span id="l85.81" class="difflineplus">+    resetBar: function() {</span>
<a href="#l85.82"></a><span id="l85.82">         document.getElementById(&quot;imip-bar&quot;).collapsed = true;</span>
<a href="#l85.83"></a><span id="l85.83">         ltnImipBar.resetButtons();</span>
<a href="#l85.84"></a><span id="l85.84"> </span>
<a href="#l85.85"></a><span id="l85.85">         // Clear our iMIP/iTIP stuff so it doesn't contain stale information.</span>
<a href="#l85.86"></a><span id="l85.86">         cal.itip.cleanupItipItem(ltnImipBar.itipItem);</span>
<a href="#l85.87"></a><span id="l85.87">         ltnImipBar.itipItem = null;</span>
<a href="#l85.88"></a><span id="l85.88">     },</span>
<a href="#l85.89"></a><span id="l85.89"> </span>
<a href="#l85.90"></a><span id="l85.90">     /**</span>
<a href="#l85.91"></a><span id="l85.91">      * Resets all buttons and its menuitems, all buttons are hidden thereafter</span>
<a href="#l85.92"></a><span id="l85.92">      */</span>
<a href="#l85.93"></a><span id="l85.93" class="difflineminus">-    resetButtons: function ltnResetImipButtons() {</span>
<a href="#l85.94"></a><span id="l85.94" class="difflineplus">+    resetButtons: function() {</span>
<a href="#l85.95"></a><span id="l85.95">         let buttons = ltnImipBar.getButtons();</span>
<a href="#l85.96"></a><span id="l85.96">         buttons.forEach(hideElement);</span>
<a href="#l85.97"></a><span id="l85.97">         buttons.forEach(aButton =&gt; ltnImipBar.getMenuItems(aButton).forEach(showElement));</span>
<a href="#l85.98"></a><span id="l85.98">     },</span>
<a href="#l85.99"></a><span id="l85.99"> </span>
<a href="#l85.100"></a><span id="l85.100">     /**</span>
<a href="#l85.101"></a><span id="l85.101">      * Provides a list of all available buttons</span>
<a href="#l85.102"></a><span id="l85.102">      */</span>
<a href="#l85.103"></a><span id="l85.103" class="difflineminus">-    getButtons: function ltnGetButtons() {</span>
<a href="#l85.104"></a><span id="l85.104" class="difflineplus">+    getButtons: function() {</span>
<a href="#l85.105"></a><span id="l85.105">         let buttons = [];</span>
<a href="#l85.106"></a><span id="l85.106">         let nl = document.getElementById(&quot;imip-view-toolbar&quot;)</span>
<a href="#l85.107"></a><span id="l85.107">                          .getElementsByTagName(&quot;toolbarbutton&quot;);</span>
<a href="#l85.108"></a><span id="l85.108">         if (nl != null &amp;&amp; nl.length &gt; 0) {</span>
<a href="#l85.109"></a><span id="l85.109">             for (let button of nl) {</span>
<a href="#l85.110"></a><span id="l85.110">                 buttons.push(button);</span>
<a href="#l85.111"></a><span id="l85.111">             }</span>
<a href="#l85.112"></a><span id="l85.112">         }</span>
<a href="#l85.113"></a><span id="l85.113">         return buttons;</span>
<a href="#l85.114"></a><span id="l85.114">     },</span>
<a href="#l85.115"></a><span id="l85.115"> </span>
<a href="#l85.116"></a><span id="l85.116">     /**</span>
<a href="#l85.117"></a><span id="l85.117">      * Provides a list of available menuitems of a button</span>
<a href="#l85.118"></a><span id="l85.118">      *</span>
<a href="#l85.119"></a><span id="l85.119">      * @param aButton        button node</span>
<a href="#l85.120"></a><span id="l85.120">      */</span>
<a href="#l85.121"></a><span id="l85.121" class="difflineminus">-    getMenuItems: function ltnGetMenuItems(aButton) {</span>
<a href="#l85.122"></a><span id="l85.122" class="difflineplus">+    getMenuItems: function(aButton) {</span>
<a href="#l85.123"></a><span id="l85.123">         let items = [];</span>
<a href="#l85.124"></a><span id="l85.124">         let mitems = aButton.getElementsByTagName(&quot;menuitem&quot;);</span>
<a href="#l85.125"></a><span id="l85.125">         if (mitems != null &amp;&amp; mitems.length &gt; 0) {</span>
<a href="#l85.126"></a><span id="l85.126">             for (let mitem of mitems) {</span>
<a href="#l85.127"></a><span id="l85.127">                 items.push(mitem);</span>
<a href="#l85.128"></a><span id="l85.128">             }</span>
<a href="#l85.129"></a><span id="l85.129">         }</span>
<a href="#l85.130"></a><span id="l85.130">         return items;</span>
<a href="#l85.131"></a><span id="l85.131">     },</span>
<a href="#l85.132"></a><span id="l85.132"> </span>
<a href="#l85.133"></a><span id="l85.133">     /**</span>
<a href="#l85.134"></a><span id="l85.134">      * Checks and converts button types based on available menuitems of the buttons</span>
<a href="#l85.135"></a><span id="l85.135">      * to avoid dropdowns which are empty or only replicating the default button action</span>
<a href="#l85.136"></a><span id="l85.136">      * Should be called once the buttons are set up</span>
<a href="#l85.137"></a><span id="l85.137">      */</span>
<a href="#l85.138"></a><span id="l85.138" class="difflineminus">-    conformButtonType: function ltnConformButtonType() {</span>
<a href="#l85.139"></a><span id="l85.139" class="difflineplus">+    conformButtonType: function() {</span>
<a href="#l85.140"></a><span id="l85.140">         // check only needed on visible and not simple buttons</span>
<a href="#l85.141"></a><span id="l85.141">         let buttons = ltnImipBar.getButtons()</span>
<a href="#l85.142"></a><span id="l85.142">                                 .filter(aElement =&gt; aElement.hasAttribute(&quot;type&quot;) &amp;&amp; !aElement.hidden);</span>
<a href="#l85.143"></a><span id="l85.143">         // change button if appropriate</span>
<a href="#l85.144"></a><span id="l85.144">         for (let button of buttons) {</span>
<a href="#l85.145"></a><span id="l85.145">             let items = ltnImipBar.getMenuItems(button).filter(aItem =&gt; !aItem.hidden);</span>
<a href="#l85.146"></a><span id="l85.146">             if (button.type == &quot;menu&quot; &amp;&amp; items.length == 0) {</span>
<a href="#l85.147"></a><span id="l85.147">                 // hide non functional buttons</span>
<a href="#l85.148"></a><span id="l85.148" class="difflineat">@@ -188,17 +188,17 @@ var ltnImipBar = {</span>
<a href="#l85.149"></a><span id="l85.149">      * NOTE: This function is called without a valid this-context!</span>
<a href="#l85.150"></a><span id="l85.150">      *</span>
<a href="#l85.151"></a><span id="l85.151">      * @param itipItem      The iTIP item to set up for</span>
<a href="#l85.152"></a><span id="l85.152">      * @param rc            The status code from processing</span>
<a href="#l85.153"></a><span id="l85.153">      * @param actionFunc    The action function called for execution</span>
<a href="#l85.154"></a><span id="l85.154">      * @param foundItems    An array of items found while searching for the item</span>
<a href="#l85.155"></a><span id="l85.155">      *                      in subscribed calendars</span>
<a href="#l85.156"></a><span id="l85.156">      */</span>
<a href="#l85.157"></a><span id="l85.157" class="difflineminus">-    setupOptions: function setupOptions(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l85.158"></a><span id="l85.158" class="difflineplus">+    setupOptions: function(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l85.159"></a><span id="l85.159">         let imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l85.160"></a><span id="l85.160">         let data = cal.itip.getOptionsText(itipItem, rc, actionFunc, foundItems);</span>
<a href="#l85.161"></a><span id="l85.161"> </span>
<a href="#l85.162"></a><span id="l85.162">         if (Components.isSuccessCode(rc)) {</span>
<a href="#l85.163"></a><span id="l85.163">             ltnImipBar.itipItem = itipItem;</span>
<a href="#l85.164"></a><span id="l85.164">             ltnImipBar.actionFunc = actionFunc;</span>
<a href="#l85.165"></a><span id="l85.165">             ltnImipBar.foundItems = foundItems;</span>
<a href="#l85.166"></a><span id="l85.166">         }</span>
<a href="#l85.167"></a><span id="l85.167" class="difflineat">@@ -274,50 +274,41 @@ var ltnImipBar = {</span>
<a href="#l85.168"></a><span id="l85.168">                 // meanwhile accepted invitation, so we flip comparison order</span>
<a href="#l85.169"></a><span id="l85.169">                 msgOverlay = ltn.invitation.compareInvitationOverlay(msgOverlay, serializedOverlay,</span>
<a href="#l85.170"></a><span id="l85.170">                                                                      organizerId);</span>
<a href="#l85.171"></a><span id="l85.171">             }</span>
<a href="#l85.172"></a><span id="l85.172">         }</span>
<a href="#l85.173"></a><span id="l85.173">         msgWindow.displayHTMLInMessagePane(&quot;&quot;, msgOverlay, false);</span>
<a href="#l85.174"></a><span id="l85.174">     },</span>
<a href="#l85.175"></a><span id="l85.175"> </span>
<a href="#l85.176"></a><span id="l85.176" class="difflineminus">-    executeAction: function ltnExecAction(partStat, extendResponse) {</span>
<a href="#l85.177"></a><span id="l85.177" class="difflineplus">+    executeAction: function(partStat, extendResponse) {</span>
<a href="#l85.178"></a><span id="l85.178">         function _execAction(aActionFunc, aItipItem, aWindow, aPartStat) {</span>
<a href="#l85.179"></a><span id="l85.179">             if (cal.itip.promptCalendar(aActionFunc.method, aItipItem, aWindow)) {</span>
<a href="#l85.180"></a><span id="l85.180">                 // filter out fake partstats</span>
<a href="#l85.181"></a><span id="l85.181">                 if (aPartStat.startsWith(&quot;X-&quot;)) {</span>
<a href="#l85.182"></a><span id="l85.182">                     partstat = &quot;&quot;;</span>
<a href="#l85.183"></a><span id="l85.183">                 }</span>
<a href="#l85.184"></a><span id="l85.184">                 // hide the buttons now, to disable pressing them twice...</span>
<a href="#l85.185"></a><span id="l85.185">                 if (aPartStat == partStat) {</span>
<a href="#l85.186"></a><span id="l85.186">                     ltnImipBar.resetButtons();</span>
<a href="#l85.187"></a><span id="l85.187">                 }</span>
<a href="#l85.188"></a><span id="l85.188"> </span>
<a href="#l85.189"></a><span id="l85.189">                 let opListener = {</span>
<a href="#l85.190"></a><span id="l85.190">                     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l85.191"></a><span id="l85.191" class="difflineminus">-                    onOperationComplete: function ltnItipActionListener_onOperationComplete(aCalendar,</span>
<a href="#l85.192"></a><span id="l85.192" class="difflineminus">-                                                                                            aStatus,</span>
<a href="#l85.193"></a><span id="l85.193" class="difflineminus">-                                                                                            aOperationType,</span>
<a href="#l85.194"></a><span id="l85.194" class="difflineminus">-                                                                                            aId,</span>
<a href="#l85.195"></a><span id="l85.195" class="difflineminus">-                                                                                            aDetail) {</span>
<a href="#l85.196"></a><span id="l85.196" class="difflineplus">+                    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l85.197"></a><span id="l85.197">                         // For now, we just state the status for the user something very simple</span>
<a href="#l85.198"></a><span id="l85.198">                         let imipBar = document.getElementById(&quot;imip-bar&quot;);</span>
<a href="#l85.199"></a><span id="l85.199">                         let label = cal.itip.getCompleteText(aStatus, aOperationType);</span>
<a href="#l85.200"></a><span id="l85.200">                         imipBar.setAttribute(&quot;label&quot;, label);</span>
<a href="#l85.201"></a><span id="l85.201"> </span>
<a href="#l85.202"></a><span id="l85.202">                         if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l85.203"></a><span id="l85.203">                             showError(label);</span>
<a href="#l85.204"></a><span id="l85.204">                         }</span>
<a href="#l85.205"></a><span id="l85.205">                     },</span>
<a href="#l85.206"></a><span id="l85.206" class="difflineminus">-                    onGetResult: function ltnItipActionListener_onGetResult(aCalendar,</span>
<a href="#l85.207"></a><span id="l85.207" class="difflineminus">-                                                                            aStatus,</span>
<a href="#l85.208"></a><span id="l85.208" class="difflineminus">-                                                                            aItemType,</span>
<a href="#l85.209"></a><span id="l85.209" class="difflineminus">-                                                                            aDetail,</span>
<a href="#l85.210"></a><span id="l85.210" class="difflineminus">-                                                                            aCount,</span>
<a href="#l85.211"></a><span id="l85.211" class="difflineminus">-                                                                            aItems) {</span>
<a href="#l85.212"></a><span id="l85.212" class="difflineplus">+                    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l85.213"></a><span id="l85.213">                     }</span>
<a href="#l85.214"></a><span id="l85.214">                 };</span>
<a href="#l85.215"></a><span id="l85.215"> </span>
<a href="#l85.216"></a><span id="l85.216">                 try {</span>
<a href="#l85.217"></a><span id="l85.217">                     aActionFunc(opListener, partStat);</span>
<a href="#l85.218"></a><span id="l85.218">                 } catch (exc) {</span>
<a href="#l85.219"></a><span id="l85.219">                     Components.utils.reportError(exc);</span>
<a href="#l85.220"></a><span id="l85.220">                 }</span>
<a href="#l85.221"></a><span id="l85.221" class="difflineat">@@ -364,17 +355,17 @@ var ltnImipBar = {</span>
<a href="#l85.222"></a><span id="l85.222">                 if (saveitems.length &gt; 0) {</span>
<a href="#l85.223"></a><span id="l85.223">                     let newItipItem = cal.itip.getModifiedItipItem(ltnImipBar.itipItem,</span>
<a href="#l85.224"></a><span id="l85.224">                                                                    saveitems,</span>
<a href="#l85.225"></a><span id="l85.225">                                                                    { receivedMethod: &quot;PUBLISH&quot;,</span>
<a href="#l85.226"></a><span id="l85.226">                                                                      responseMethod: &quot;PUBLISH&quot; });</span>
<a href="#l85.227"></a><span id="l85.227">                     // control to avoid processing _execAction on later user changes on the item</span>
<a href="#l85.228"></a><span id="l85.228">                     let isFirstProcessing = true;</span>
<a href="#l85.229"></a><span id="l85.229">                     // setup callback and trigger re-processing</span>
<a href="#l85.230"></a><span id="l85.230" class="difflineminus">-                    let storeCopy = function storeCopy(aItipItem, aRc, aActionFunc, aFoundItems) {</span>
<a href="#l85.231"></a><span id="l85.231" class="difflineplus">+                    let storeCopy = function(aItipItem, aRc, aActionFunc, aFoundItems) {</span>
<a href="#l85.232"></a><span id="l85.232">                         if (isFirstProcessing &amp;&amp; aActionFunc &amp;&amp; Components.isSuccessCode(aRc)) {</span>
<a href="#l85.233"></a><span id="l85.233">                             _execAction(aActionFunc, aItipItem, window, partStat);</span>
<a href="#l85.234"></a><span id="l85.234">                         }</span>
<a href="#l85.235"></a><span id="l85.235">                     };</span>
<a href="#l85.236"></a><span id="l85.236">                     cal.itip.processItipItem(newItipItem, storeCopy);</span>
<a href="#l85.237"></a><span id="l85.237">                     isFirstProcessing = false;</span>
<a href="#l85.238"></a><span id="l85.238">                 }</span>
<a href="#l85.239"></a><span id="l85.239">                 // we stop here to not process the original item</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/lightning/content/lightning-calendar-creation.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-calendar-creation.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l86.4"></a><span id="l86.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l86.5"></a><span id="l86.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l86.6"></a><span id="l86.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l86.7"></a><span id="l86.7"> </span>
<a href="#l86.8"></a><span id="l86.8"> var common_initCustomizePage = initCustomizePage;</span>
<a href="#l86.9"></a><span id="l86.9"> var common_doCreateCalendar = doCreateCalendar;</span>
<a href="#l86.10"></a><span id="l86.10"> </span>
<a href="#l86.11"></a><span id="l86.11" class="difflineminus">-initCustomizePage = function ltn_initCustomizePage() {</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineplus">+initCustomizePage = function() {</span>
<a href="#l86.13"></a><span id="l86.13">     common_initCustomizePage();</span>
<a href="#l86.14"></a><span id="l86.14">     ltnInitMailIdentitiesRow();</span>
<a href="#l86.15"></a><span id="l86.15"> };</span>
<a href="#l86.16"></a><span id="l86.16"> </span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-doCreateCalendar = function ltn_doCreateCalendar() {</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineplus">+doCreateCalendar = function() {</span>
<a href="#l86.19"></a><span id="l86.19">     common_doCreateCalendar();</span>
<a href="#l86.20"></a><span id="l86.20">     ltnSaveMailIdentitySelection();</span>
<a href="#l86.21"></a><span id="l86.21">     return true;</span>
<a href="#l86.22"></a><span id="l86.22"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/lightning/content/lightning-calendar-properties.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-calendar-properties.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l87.4"></a><span id="l87.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l87.5"></a><span id="l87.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l87.6"></a><span id="l87.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l87.7"></a><span id="l87.7"> </span>
<a href="#l87.8"></a><span id="l87.8"> var common_onLoad = onLoad;</span>
<a href="#l87.9"></a><span id="l87.9"> var common_onAcceptDialog = onAcceptDialog;</span>
<a href="#l87.10"></a><span id="l87.10"> </span>
<a href="#l87.11"></a><span id="l87.11" class="difflineminus">-onLoad = function ltn_onLoad() {</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineplus">+onLoad = function() {</span>
<a href="#l87.13"></a><span id="l87.13">     gCalendar = window.arguments[0].calendar;</span>
<a href="#l87.14"></a><span id="l87.14">     ltnInitMailIdentitiesRow();</span>
<a href="#l87.15"></a><span id="l87.15">     common_onLoad();</span>
<a href="#l87.16"></a><span id="l87.16"> };</span>
<a href="#l87.17"></a><span id="l87.17"> </span>
<a href="#l87.18"></a><span id="l87.18" class="difflineminus">-onAcceptDialog = function ltn_onAcceptDialog() {</span>
<a href="#l87.19"></a><span id="l87.19" class="difflineplus">+onAcceptDialog = function() {</span>
<a href="#l87.20"></a><span id="l87.20">     ltnSaveMailIdentitySelection();</span>
<a href="#l87.21"></a><span id="l87.21">     return common_onAcceptDialog();</span>
<a href="#l87.22"></a><span id="l87.22"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -1107,17 +1107,17 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l88.4"></a><span id="l88.4">     updateTimezone();</span>
<a href="#l88.5"></a><span id="l88.5">     updateAccept();</span>
<a href="#l88.6"></a><span id="l88.6"> </span>
<a href="#l88.7"></a><span id="l88.7">     if (warning) {</span>
<a href="#l88.8"></a><span id="l88.8">         // Disable the &quot;Save&quot; and &quot;Save and Close&quot; commands as long as the</span>
<a href="#l88.9"></a><span id="l88.9">         // warning dialog is showed.</span>
<a href="#l88.10"></a><span id="l88.10">         enableAcceptCommand(false);</span>
<a href="#l88.11"></a><span id="l88.11">         gWarning = true;</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-        let callback = function func() {</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+        let callback = function() {</span>
<a href="#l88.14"></a><span id="l88.14">             Services.prompt.alert(null, document.title, stringWarning);</span>
<a href="#l88.15"></a><span id="l88.15">             gWarning = false;</span>
<a href="#l88.16"></a><span id="l88.16">             updateAccept();</span>
<a href="#l88.17"></a><span id="l88.17">         };</span>
<a href="#l88.18"></a><span id="l88.18">         setTimeout(callback, 1);</span>
<a href="#l88.19"></a><span id="l88.19">     }</span>
<a href="#l88.20"></a><span id="l88.20"> }</span>
<a href="#l88.21"></a><span id="l88.21"> </span>
<a href="#l88.22"></a><span id="l88.22" class="difflineat">@@ -2108,21 +2108,21 @@ function makePrettyName(aUri) {</span>
<a href="#l88.23"></a><span id="l88.23">  * @param cloudProvider     The clould provider to upload to</span>
<a href="#l88.24"></a><span id="l88.24">  * @param listItem          The listitem in attachment-link listbox to update.</span>
<a href="#l88.25"></a><span id="l88.25">  */</span>
<a href="#l88.26"></a><span id="l88.26"> function uploadCloudAttachment(attachment, cloudProvider, listItem) {</span>
<a href="#l88.27"></a><span id="l88.27">     let file = attachment.uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l88.28"></a><span id="l88.28">     listItem.attachLocalFile = file;</span>
<a href="#l88.29"></a><span id="l88.29">     listItem.attachCloudProvider = cloudProvider;</span>
<a href="#l88.30"></a><span id="l88.30">     cloudProvider.uploadFile(file, {</span>
<a href="#l88.31"></a><span id="l88.31" class="difflineminus">-        onStartRequest: function onStartRequest() {</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineplus">+        onStartRequest: function() {</span>
<a href="#l88.33"></a><span id="l88.33">             listItem.setAttribute(&quot;image&quot;, &quot;chrome://messenger/skin/icons/loading.png&quot;);</span>
<a href="#l88.34"></a><span id="l88.34">         },</span>
<a href="#l88.35"></a><span id="l88.35"> </span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">-        onStopRequest: function onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+        onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l88.38"></a><span id="l88.38">             if (Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l88.39"></a><span id="l88.39">                 delete gAttachMap[attachment.hashId];</span>
<a href="#l88.40"></a><span id="l88.40">                 attachment.uri = makeURL(cloudProvider.urlForFile(file));</span>
<a href="#l88.41"></a><span id="l88.41">                 attachment.setParameter(&quot;FILENAME&quot;, file.leafName);</span>
<a href="#l88.42"></a><span id="l88.42">                 attachment.setParameter(&quot;PROVIDER&quot;, cloudProvider.type);</span>
<a href="#l88.43"></a><span id="l88.43">                 listItem.setAttribute(&quot;label&quot;, file.leafName);</span>
<a href="#l88.44"></a><span id="l88.44">                 gAttachMap[attachment.hashId] = attachment;</span>
<a href="#l88.45"></a><span id="l88.45">                 listItem.setAttribute(&quot;image&quot;, cloudProvider.iconClass);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-preferences.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-preferences.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -2,26 +2,26 @@</span>
<a href="#l89.4"></a><span id="l89.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l89.5"></a><span id="l89.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l89.6"></a><span id="l89.6"> </span>
<a href="#l89.7"></a><span id="l89.7"> /* exported gLightningPane */</span>
<a href="#l89.8"></a><span id="l89.8"> </span>
<a href="#l89.9"></a><span id="l89.9"> var gLightningPane = {</span>
<a href="#l89.10"></a><span id="l89.10">     mInitialized: false,</span>
<a href="#l89.11"></a><span id="l89.11"> </span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-    init: function lnPaneInit() {</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+    init: function() {</span>
<a href="#l89.14"></a><span id="l89.14">         let preference = document.getElementById(&quot;calendar.preferences.lightning.selectedTabIndex&quot;);</span>
<a href="#l89.15"></a><span id="l89.15">         if (preference.value) {</span>
<a href="#l89.16"></a><span id="l89.16">             let ltnPrefs = document.getElementById(&quot;calPreferencesTabbox&quot;);</span>
<a href="#l89.17"></a><span id="l89.17">             ltnPrefs.selectedIndex = preference.value;</span>
<a href="#l89.18"></a><span id="l89.18">         }</span>
<a href="#l89.19"></a><span id="l89.19">         this.mInitialized = true;</span>
<a href="#l89.20"></a><span id="l89.20">     },</span>
<a href="#l89.21"></a><span id="l89.21"> </span>
<a href="#l89.22"></a><span id="l89.22" class="difflineminus">-    tabSelectionChanged: function lnPaneTabSelectionChanged() {</span>
<a href="#l89.23"></a><span id="l89.23" class="difflineplus">+    tabSelectionChanged: function() {</span>
<a href="#l89.24"></a><span id="l89.24">         if (!this.mInitialized) {</span>
<a href="#l89.25"></a><span id="l89.25">             return;</span>
<a href="#l89.26"></a><span id="l89.26">         }</span>
<a href="#l89.27"></a><span id="l89.27">         let ltnPrefs = document.getElementById(&quot;calPreferencesTabbox&quot;);</span>
<a href="#l89.28"></a><span id="l89.28">         let preference = document.getElementById(&quot;calendar.preferences.lightning.selectedTabIndex&quot;);</span>
<a href="#l89.29"></a><span id="l89.29">         preference.valueFromPreferences = ltnPrefs.selectedIndex;</span>
<a href="#l89.30"></a><span id="l89.30">     }</span>
<a href="#l89.31"></a><span id="l89.31"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -22,17 +22,17 @@ var calendarTabMonitor = {</span>
<a href="#l90.4"></a><span id="l90.4"> </span>
<a href="#l90.5"></a><span id="l90.5">     // Unused, but needed functions</span>
<a href="#l90.6"></a><span id="l90.6">     onTabTitleChanged: function() {},</span>
<a href="#l90.7"></a><span id="l90.7">     onTabOpened: function() {},</span>
<a href="#l90.8"></a><span id="l90.8">     onTabClosing: function() {},</span>
<a href="#l90.9"></a><span id="l90.9">     onTabPersist: function() {},</span>
<a href="#l90.10"></a><span id="l90.10">     onTabRestored: function() {},</span>
<a href="#l90.11"></a><span id="l90.11"> </span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-    onTabSwitched: function onTabSwitched(aNewTab, aOldTab) {</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+    onTabSwitched: function(aNewTab, aOldTab) {</span>
<a href="#l90.14"></a><span id="l90.14">         // Unfortunately, tabmail doesn't provide a hideTab function on the tab</span>
<a href="#l90.15"></a><span id="l90.15">         // type definitions. To make sure the commands are correctly disabled,</span>
<a href="#l90.16"></a><span id="l90.16">         // we want to update calendar/task commands when switching away from</span>
<a href="#l90.17"></a><span id="l90.17">         // those tabs.</span>
<a href="#l90.18"></a><span id="l90.18">         if (aOldTab.mode.name == &quot;calendar&quot; ||</span>
<a href="#l90.19"></a><span id="l90.19">             aOldTab.mode.name == &quot;task&quot;) {</span>
<a href="#l90.20"></a><span id="l90.20">             calendarController.updateCommands();</span>
<a href="#l90.21"></a><span id="l90.21">             calendarController2.updateCommands();</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineat">@@ -646,58 +646,49 @@ var FIRST_DELAY_STARTUP = 100;</span>
<a href="#l90.23"></a><span id="l90.23"> var FIRST_DELAY_RESCHEDULE = 100;</span>
<a href="#l90.24"></a><span id="l90.24"> var FIRST_DELAY_REGISTER = 10000;</span>
<a href="#l90.25"></a><span id="l90.25"> var FIRST_DELAY_UNREGISTER = 0;</span>
<a href="#l90.26"></a><span id="l90.26"> </span>
<a href="#l90.27"></a><span id="l90.27"> var gInvitationsOperationListener = {</span>
<a href="#l90.28"></a><span id="l90.28">     mCount: 0,</span>
<a href="#l90.29"></a><span id="l90.29"> </span>
<a href="#l90.30"></a><span id="l90.30">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineminus">-    onOperationComplete: function sBOL_onOperationComplete(aCalendar,</span>
<a href="#l90.32"></a><span id="l90.32" class="difflineminus">-                                                           aStatus,</span>
<a href="#l90.33"></a><span id="l90.33" class="difflineminus">-                                                           aOperationType,</span>
<a href="#l90.34"></a><span id="l90.34" class="difflineminus">-                                                           aId,</span>
<a href="#l90.35"></a><span id="l90.35" class="difflineminus">-                                                           aDetail) {</span>
<a href="#l90.36"></a><span id="l90.36" class="difflineplus">+    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l90.37"></a><span id="l90.37">         let invitationsBox = document.getElementById(&quot;calendar-invitations-panel&quot;);</span>
<a href="#l90.38"></a><span id="l90.38">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l90.39"></a><span id="l90.39">             let value = ltnGetString(&quot;lightning&quot;, &quot;invitationsLink.label&quot;, [this.mCount]);</span>
<a href="#l90.40"></a><span id="l90.40">             document.getElementById(&quot;calendar-invitations-label&quot;).value = value;</span>
<a href="#l90.41"></a><span id="l90.41">             setElementValue(invitationsBox, this.mCount &lt; 1 &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l90.42"></a><span id="l90.42">         } else {</span>
<a href="#l90.43"></a><span id="l90.43">             invitationsBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l90.44"></a><span id="l90.44">         }</span>
<a href="#l90.45"></a><span id="l90.45">         this.mCount = 0;</span>
<a href="#l90.46"></a><span id="l90.46">     },</span>
<a href="#l90.47"></a><span id="l90.47"> </span>
<a href="#l90.48"></a><span id="l90.48" class="difflineminus">-    onGetResult: function sBOL_onGetResult(aCalendar,</span>
<a href="#l90.49"></a><span id="l90.49" class="difflineminus">-                                           aStatus,</span>
<a href="#l90.50"></a><span id="l90.50" class="difflineminus">-                                           aItemType,</span>
<a href="#l90.51"></a><span id="l90.51" class="difflineminus">-                                           aDetail,</span>
<a href="#l90.52"></a><span id="l90.52" class="difflineminus">-                                           aCount,</span>
<a href="#l90.53"></a><span id="l90.53" class="difflineminus">-                                           aItems) {</span>
<a href="#l90.54"></a><span id="l90.54" class="difflineplus">+    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l90.55"></a><span id="l90.55">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l90.56"></a><span id="l90.56">             this.mCount += aCount;</span>
<a href="#l90.57"></a><span id="l90.57">         }</span>
<a href="#l90.58"></a><span id="l90.58">     }</span>
<a href="#l90.59"></a><span id="l90.59"> };</span>
<a href="#l90.60"></a><span id="l90.60"> </span>
<a href="#l90.61"></a><span id="l90.61"> var gInvitationsCalendarManagerObserver = {</span>
<a href="#l90.62"></a><span id="l90.62">     mSideBar: this,</span>
<a href="#l90.63"></a><span id="l90.63"> </span>
<a href="#l90.64"></a><span id="l90.64">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarManagerObserver]),</span>
<a href="#l90.65"></a><span id="l90.65"> </span>
<a href="#l90.66"></a><span id="l90.66" class="difflineminus">-    onCalendarRegistered: function cMO_onCalendarRegistered(aCalendar) {</span>
<a href="#l90.67"></a><span id="l90.67" class="difflineplus">+    onCalendarRegistered: function(aCalendar) {</span>
<a href="#l90.68"></a><span id="l90.68">         this.mSideBar.rescheduleInvitationsUpdate(FIRST_DELAY_REGISTER);</span>
<a href="#l90.69"></a><span id="l90.69">     },</span>
<a href="#l90.70"></a><span id="l90.70"> </span>
<a href="#l90.71"></a><span id="l90.71" class="difflineminus">-    onCalendarUnregistering: function cMO_onCalendarUnregistering(aCalendar) {</span>
<a href="#l90.72"></a><span id="l90.72" class="difflineplus">+    onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l90.73"></a><span id="l90.73">         this.mSideBar.rescheduleInvitationsUpdate(FIRST_DELAY_UNREGISTER);</span>
<a href="#l90.74"></a><span id="l90.74">     },</span>
<a href="#l90.75"></a><span id="l90.75"> </span>
<a href="#l90.76"></a><span id="l90.76" class="difflineminus">-    onCalendarDeleting: function cMO_onCalendarDeleting(aCalendar) {</span>
<a href="#l90.77"></a><span id="l90.77" class="difflineplus">+    onCalendarDeleting: function(aCalendar) {</span>
<a href="#l90.78"></a><span id="l90.78">     }</span>
<a href="#l90.79"></a><span id="l90.79"> };</span>
<a href="#l90.80"></a><span id="l90.80"> </span>
<a href="#l90.81"></a><span id="l90.81"> function scheduleInvitationsUpdate(firstDelay) {</span>
<a href="#l90.82"></a><span id="l90.82">     gInvitationsOperationListener.mCount = 0;</span>
<a href="#l90.83"></a><span id="l90.83">     getInvitationsManager().scheduleInvitationsUpdate(firstDelay,</span>
<a href="#l90.84"></a><span id="l90.84">                                                       gInvitationsOperationListener);</span>
<a href="#l90.85"></a><span id="l90.85"> }</span>
<a href="#l90.86"></a><span id="l90.86" class="difflineat">@@ -707,19 +698,17 @@ function rescheduleInvitationsUpdate(fir</span>
<a href="#l90.87"></a><span id="l90.87">     scheduleInvitationsUpdate(firstDelay);</span>
<a href="#l90.88"></a><span id="l90.88"> }</span>
<a href="#l90.89"></a><span id="l90.89"> </span>
<a href="#l90.90"></a><span id="l90.90"> function openInvitationsDialog() {</span>
<a href="#l90.91"></a><span id="l90.91">     getInvitationsManager().cancelInvitationsUpdate();</span>
<a href="#l90.92"></a><span id="l90.92">     gInvitationsOperationListener.mCount = 0;</span>
<a href="#l90.93"></a><span id="l90.93">     getInvitationsManager().openInvitationsDialog(</span>
<a href="#l90.94"></a><span id="l90.94">         gInvitationsOperationListener,</span>
<a href="#l90.95"></a><span id="l90.95" class="difflineminus">-        function oiD_callback() {</span>
<a href="#l90.96"></a><span id="l90.96" class="difflineminus">-            scheduleInvitationsUpdate(FIRST_DELAY_RESCHEDULE);</span>
<a href="#l90.97"></a><span id="l90.97" class="difflineminus">-        });</span>
<a href="#l90.98"></a><span id="l90.98" class="difflineplus">+        () =&gt; scheduleInvitationsUpdate(FIRST_DELAY_RESCHEDULE));</span>
<a href="#l90.99"></a><span id="l90.99"> }</span>
<a href="#l90.100"></a><span id="l90.100"> </span>
<a href="#l90.101"></a><span id="l90.101"> /**</span>
<a href="#l90.102"></a><span id="l90.102">  * the current mode is set to a string defining the current</span>
<a href="#l90.103"></a><span id="l90.103">  * mode we're in. allowed values are:</span>
<a href="#l90.104"></a><span id="l90.104">  *  - 'mail'</span>
<a href="#l90.105"></a><span id="l90.105">  *  - 'calendar'</span>
<a href="#l90.106"></a><span id="l90.106">  *  - 'task'</span>
<a href="#l90.107"></a><span id="l90.107" class="difflineat">@@ -778,17 +767,17 @@ function ltnSwitch2Task() {</span>
<a href="#l90.108"></a><span id="l90.108">     deck.selectedPanel = document.getElementById(&quot;calendar-task-box&quot;);</span>
<a href="#l90.109"></a><span id="l90.109"> </span>
<a href="#l90.110"></a><span id="l90.110">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l90.111"></a><span id="l90.111">     window.setCursor(&quot;auto&quot;);</span>
<a href="#l90.112"></a><span id="l90.112">   }</span>
<a href="#l90.113"></a><span id="l90.113"> }</span>
<a href="#l90.114"></a><span id="l90.114"> </span>
<a href="#l90.115"></a><span id="l90.115"> var gCalSetupMailContext = {</span>
<a href="#l90.116"></a><span id="l90.116" class="difflineminus">-    popup: function gCalSetupMailContext_popup() {</span>
<a href="#l90.117"></a><span id="l90.117" class="difflineplus">+    popup: function() {</span>
<a href="#l90.118"></a><span id="l90.118">         let hasSelection = (gFolderDisplay.selectedMessage != null);</span>
<a href="#l90.119"></a><span id="l90.119">         // Disable the convert menu altogether.</span>
<a href="#l90.120"></a><span id="l90.120">         setElementValue(&quot;mailContext-calendar-convert-menu&quot;,</span>
<a href="#l90.121"></a><span id="l90.121">                         !hasSelection &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l90.122"></a><span id="l90.122">     }</span>
<a href="#l90.123"></a><span id="l90.123"> };</span>
<a href="#l90.124"></a><span id="l90.124"> </span>
<a href="#l90.125"></a><span id="l90.125"> // Overwrite the InitMessageMenu function, since we never know in which order</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/lightning/content/suite-overlay-sidebar.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/lightning/content/suite-overlay-sidebar.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -1,24 +1,24 @@</span>
<a href="#l91.4"></a><span id="l91.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l91.5"></a><span id="l91.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l91.6"></a><span id="l91.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l91.7"></a><span id="l91.7"> </span>
<a href="#l91.8"></a><span id="l91.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l91.9"></a><span id="l91.9"> </span>
<a href="#l91.10"></a><span id="l91.10"> var ltnSuiteUtils = {</span>
<a href="#l91.11"></a><span id="l91.11"> </span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-  addStartupObserver: function lSU_addStartupObserver() {</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+  addStartupObserver: function() {</span>
<a href="#l91.14"></a><span id="l91.14">     Services.obs.addObserver(this.startupObserver, &quot;lightning-startup-done&quot;, false);</span>
<a href="#l91.15"></a><span id="l91.15">     Services.obs.addObserver(this.startupObserver, &quot;calendar-taskview-startup-done&quot;,</span>
<a href="#l91.16"></a><span id="l91.16">                     false);</span>
<a href="#l91.17"></a><span id="l91.17">   },</span>
<a href="#l91.18"></a><span id="l91.18"> </span>
<a href="#l91.19"></a><span id="l91.19">   startupObserver: {</span>
<a href="#l91.20"></a><span id="l91.20" class="difflineminus">-    observe: function lSU_observe(subject, topic, state) {</span>
<a href="#l91.21"></a><span id="l91.21" class="difflineplus">+    observe: function(subject, topic, state) {</span>
<a href="#l91.22"></a><span id="l91.22">       if (topic != &quot;lightning-startup-done&quot; &amp;&amp;</span>
<a href="#l91.23"></a><span id="l91.23">           topic != &quot;calendar-taskview-startup-done&quot;) {</span>
<a href="#l91.24"></a><span id="l91.24">         return;</span>
<a href="#l91.25"></a><span id="l91.25">       }</span>
<a href="#l91.26"></a><span id="l91.26"> </span>
<a href="#l91.27"></a><span id="l91.27">       [[&quot;CustomizeTaskActionsToolbar&quot;, &quot;task-actions-toolbox&quot;],</span>
<a href="#l91.28"></a><span id="l91.28">        [&quot;CustomizeCalendarToolbar&quot;, &quot;calendar-toolbox&quot;],</span>
<a href="#l91.29"></a><span id="l91.29">        [&quot;CustomizeTaskToolbar&quot;, &quot;task-toolbox&quot;]].forEach(function(eIDs) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -126,17 +126,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.4"></a><span id="l92.4">     },</span>
<a href="#l92.5"></a><span id="l92.5"> </span>
<a href="#l92.6"></a><span id="l92.6">     get isCached() {</span>
<a href="#l92.7"></a><span id="l92.7">         return (this != this.superCalendar);</span>
<a href="#l92.8"></a><span id="l92.8">     },</span>
<a href="#l92.9"></a><span id="l92.9"> </span>
<a href="#l92.10"></a><span id="l92.10">     mLastRedirectStatus: null,</span>
<a href="#l92.11"></a><span id="l92.11"> </span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-    ensureTargetCalendar: function caldav_ensureTargetCalendar() {</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+    ensureTargetCalendar: function() {</span>
<a href="#l92.14"></a><span id="l92.14">         if (!this.isCached &amp;&amp; !this.mOfflineStorage) {</span>
<a href="#l92.15"></a><span id="l92.15">             // If this is a cached calendar, the actual cache is taken care of</span>
<a href="#l92.16"></a><span id="l92.16">             // by the calCachedCalendar facade. In any other case, we use a</span>
<a href="#l92.17"></a><span id="l92.17">             // memory calendar to cache things.</span>
<a href="#l92.18"></a><span id="l92.18">             this.mOfflineStorage = Components</span>
<a href="#l92.19"></a><span id="l92.19">                                    .classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l92.20"></a><span id="l92.20">                                    .createInstance(Components.interfaces.calISyncWriteCalendar);</span>
<a href="#l92.21"></a><span id="l92.21"> </span>
<a href="#l92.22"></a><span id="l92.22" class="difflineat">@@ -153,35 +153,35 @@ calDavCalendar.prototype = {</span>
<a href="#l92.23"></a><span id="l92.23">     get prefChromeOverlay() {</span>
<a href="#l92.24"></a><span id="l92.24">         return null;</span>
<a href="#l92.25"></a><span id="l92.25">     },</span>
<a href="#l92.26"></a><span id="l92.26"> </span>
<a href="#l92.27"></a><span id="l92.27">     get displayName() {</span>
<a href="#l92.28"></a><span id="l92.28">         return calGetString(&quot;calendar&quot;, &quot;caldavName&quot;);</span>
<a href="#l92.29"></a><span id="l92.29">     },</span>
<a href="#l92.30"></a><span id="l92.30"> </span>
<a href="#l92.31"></a><span id="l92.31" class="difflineminus">-    createCalendar: function caldav_createCalendar() {</span>
<a href="#l92.32"></a><span id="l92.32" class="difflineplus">+    createCalendar: function() {</span>
<a href="#l92.33"></a><span id="l92.33">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l92.34"></a><span id="l92.34">     },</span>
<a href="#l92.35"></a><span id="l92.35"> </span>
<a href="#l92.36"></a><span id="l92.36" class="difflineminus">-    deleteCalendar: function caldav_deleteCalendar(cal, listener) {</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineplus">+    deleteCalendar: function(cal, listener) {</span>
<a href="#l92.38"></a><span id="l92.38">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l92.39"></a><span id="l92.39">     },</span>
<a href="#l92.40"></a><span id="l92.40"> </span>
<a href="#l92.41"></a><span id="l92.41">     // calIChangeLog interface</span>
<a href="#l92.42"></a><span id="l92.42">     get offlineStorage() {</span>
<a href="#l92.43"></a><span id="l92.43">         return this.mOfflineStorage;</span>
<a href="#l92.44"></a><span id="l92.44">     },</span>
<a href="#l92.45"></a><span id="l92.45"> </span>
<a href="#l92.46"></a><span id="l92.46">     set offlineStorage(storage) {</span>
<a href="#l92.47"></a><span id="l92.47">         this.mOfflineStorage = storage;</span>
<a href="#l92.48"></a><span id="l92.48">         this.fetchCachedMetaData();</span>
<a href="#l92.49"></a><span id="l92.49">     },</span>
<a href="#l92.50"></a><span id="l92.50"> </span>
<a href="#l92.51"></a><span id="l92.51" class="difflineminus">-    resetLog: function caldav_resetLog() {</span>
<a href="#l92.52"></a><span id="l92.52" class="difflineplus">+    resetLog: function() {</span>
<a href="#l92.53"></a><span id="l92.53">         if (this.isCached &amp;&amp; this.mOfflineStorage) {</span>
<a href="#l92.54"></a><span id="l92.54">             this.mOfflineStorage.startBatch();</span>
<a href="#l92.55"></a><span id="l92.55">             try {</span>
<a href="#l92.56"></a><span id="l92.56">                 for (let itemId in this.mItemInfoCache) {</span>
<a href="#l92.57"></a><span id="l92.57">                     this.mOfflineStorage.deleteMetaData(itemId);</span>
<a href="#l92.58"></a><span id="l92.58">                     delete this.mItemInfoCache[itemId];</span>
<a href="#l92.59"></a><span id="l92.59">                 }</span>
<a href="#l92.60"></a><span id="l92.60">             } finally {</span>
<a href="#l92.61"></a><span id="l92.61" class="difflineat">@@ -205,94 +205,94 @@ calDavCalendar.prototype = {</span>
<a href="#l92.62"></a><span id="l92.62">             return this.mCheckedServerInfo;</span>
<a href="#l92.63"></a><span id="l92.63">         }</span>
<a href="#l92.64"></a><span id="l92.64">     },</span>
<a href="#l92.65"></a><span id="l92.65"> </span>
<a href="#l92.66"></a><span id="l92.66">     set checkedServerInfo(val) {</span>
<a href="#l92.67"></a><span id="l92.67">         return (this.mCheckedServerInfo = val);</span>
<a href="#l92.68"></a><span id="l92.68">     },</span>
<a href="#l92.69"></a><span id="l92.69"> </span>
<a href="#l92.70"></a><span id="l92.70" class="difflineminus">-    saveCalendarProperties: function caldav_saveCalendarProperties() {</span>
<a href="#l92.71"></a><span id="l92.71" class="difflineplus">+    saveCalendarProperties: function() {</span>
<a href="#l92.72"></a><span id="l92.72">         let properties = {};</span>
<a href="#l92.73"></a><span id="l92.73">         for (let property of this.offlineCachedProperties) {</span>
<a href="#l92.74"></a><span id="l92.74">             if (this[property] !== undefined) {</span>
<a href="#l92.75"></a><span id="l92.75">                 properties[property] = this[property];</span>
<a href="#l92.76"></a><span id="l92.76">             }</span>
<a href="#l92.77"></a><span id="l92.77">         }</span>
<a href="#l92.78"></a><span id="l92.78">         this.mOfflineStorage.setMetaData(&quot;calendar-properties&quot;, JSON.stringify(properties));</span>
<a href="#l92.79"></a><span id="l92.79">     },</span>
<a href="#l92.80"></a><span id="l92.80" class="difflineminus">-    restoreCalendarProperties: function caldav_restoreCalendarProperties(data) {</span>
<a href="#l92.81"></a><span id="l92.81" class="difflineplus">+    restoreCalendarProperties: function(data) {</span>
<a href="#l92.82"></a><span id="l92.82">         let properties = JSON.parse(data);</span>
<a href="#l92.83"></a><span id="l92.83">         for (let property of this.offlineCachedProperties) {</span>
<a href="#l92.84"></a><span id="l92.84">             if (properties[property] !== undefined) {</span>
<a href="#l92.85"></a><span id="l92.85">                 this[property] = properties[property];</span>
<a href="#l92.86"></a><span id="l92.86">             }</span>
<a href="#l92.87"></a><span id="l92.87">         }</span>
<a href="#l92.88"></a><span id="l92.88">     },</span>
<a href="#l92.89"></a><span id="l92.89"> </span>
<a href="#l92.90"></a><span id="l92.90">     // in calIGenericOperationListener aListener</span>
<a href="#l92.91"></a><span id="l92.91" class="difflineminus">-    replayChangesOn: function caldav_replayChangesOn(aChangeLogListener) {</span>
<a href="#l92.92"></a><span id="l92.92" class="difflineplus">+    replayChangesOn: function(aChangeLogListener) {</span>
<a href="#l92.93"></a><span id="l92.93">         if (!this.checkedServerInfo) {</span>
<a href="#l92.94"></a><span id="l92.94">             // If we haven't refreshed yet, then we should check the resource</span>
<a href="#l92.95"></a><span id="l92.95">             // type first. This will call refresh() again afterwards.</span>
<a href="#l92.96"></a><span id="l92.96">             this.setupAuthentication(aChangeLogListener);</span>
<a href="#l92.97"></a><span id="l92.97">         } else {</span>
<a href="#l92.98"></a><span id="l92.98">             this.safeRefresh(aChangeLogListener);</span>
<a href="#l92.99"></a><span id="l92.99">         }</span>
<a href="#l92.100"></a><span id="l92.100">     },</span>
<a href="#l92.101"></a><span id="l92.101" class="difflineminus">-    setMetaData: function caldav_setMetaData(id, path, etag, isInboxItem) {</span>
<a href="#l92.102"></a><span id="l92.102" class="difflineplus">+    setMetaData: function(id, path, etag, isInboxItem) {</span>
<a href="#l92.103"></a><span id="l92.103">         if (this.mOfflineStorage.setMetaData) {</span>
<a href="#l92.104"></a><span id="l92.104">             if (id) {</span>
<a href="#l92.105"></a><span id="l92.105">                 let dataString = [etag, path, isInboxItem ? &quot;true&quot; : &quot;false&quot;].join(&quot;\u001A&quot;);</span>
<a href="#l92.106"></a><span id="l92.106">                 this.mOfflineStorage.setMetaData(id, dataString);</span>
<a href="#l92.107"></a><span id="l92.107">             } else {</span>
<a href="#l92.108"></a><span id="l92.108">                 cal.LOG(&quot;CalDAV: cannot store meta data without an id&quot;);</span>
<a href="#l92.109"></a><span id="l92.109">             }</span>
<a href="#l92.110"></a><span id="l92.110">         } else {</span>
<a href="#l92.111"></a><span id="l92.111">             cal.ERROR(&quot;CalDAV: calendar storage does not support meta data&quot;);</span>
<a href="#l92.112"></a><span id="l92.112">         }</span>
<a href="#l92.113"></a><span id="l92.113">     },</span>
<a href="#l92.114"></a><span id="l92.114"> </span>
<a href="#l92.115"></a><span id="l92.115">     /**</span>
<a href="#l92.116"></a><span id="l92.116">      * Ensure that cached items have associated meta data, otherwise server side</span>
<a href="#l92.117"></a><span id="l92.117">      * changes may not be reflected</span>
<a href="#l92.118"></a><span id="l92.118">      */</span>
<a href="#l92.119"></a><span id="l92.119" class="difflineminus">-    ensureMetaData: function caldav_ensureMetaData() {</span>
<a href="#l92.120"></a><span id="l92.120" class="difflineplus">+    ensureMetaData: function() {</span>
<a href="#l92.121"></a><span id="l92.121">         let self = this;</span>
<a href="#l92.122"></a><span id="l92.122">         let refreshNeeded = false;</span>
<a href="#l92.123"></a><span id="l92.123">         let getMetaListener = {</span>
<a href="#l92.124"></a><span id="l92.124">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l92.125"></a><span id="l92.125" class="difflineminus">-            onGetResult: function meta_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l92.126"></a><span id="l92.126" class="difflineplus">+            onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l92.127"></a><span id="l92.127">                 for (let item of aItems) {</span>
<a href="#l92.128"></a><span id="l92.128">                     if (!(item.id in self.mItemInfoCache)) {</span>
<a href="#l92.129"></a><span id="l92.129">                         let path = self.getItemLocationPath(item);</span>
<a href="#l92.130"></a><span id="l92.130">                         cal.LOG(&quot;Adding meta-data for cached item &quot; + item.id);</span>
<a href="#l92.131"></a><span id="l92.131">                         self.mItemInfoCache[item.id] = { etag: null,</span>
<a href="#l92.132"></a><span id="l92.132">                                                          isNew: false,</span>
<a href="#l92.133"></a><span id="l92.133">                                                          locationPath: path,</span>
<a href="#l92.134"></a><span id="l92.134">                                                          isInboxItem: false };</span>
<a href="#l92.135"></a><span id="l92.135">                         self.mHrefIndex[self.mLocationPath + path] = item.id;</span>
<a href="#l92.136"></a><span id="l92.136">                         refreshNeeded = true;</span>
<a href="#l92.137"></a><span id="l92.137">                     }</span>
<a href="#l92.138"></a><span id="l92.138">                 }</span>
<a href="#l92.139"></a><span id="l92.139">             },</span>
<a href="#l92.140"></a><span id="l92.140" class="difflineminus">-            onOperationComplete: function meta_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l92.141"></a><span id="l92.141" class="difflineplus">+            onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l92.142"></a><span id="l92.142">                 if (refreshNeeded) {</span>
<a href="#l92.143"></a><span id="l92.143">                     // reseting the cached ctag forces an item refresh when</span>
<a href="#l92.144"></a><span id="l92.144">                     // safeRefresh is called later</span>
<a href="#l92.145"></a><span id="l92.145">                     self.mCtag = null;</span>
<a href="#l92.146"></a><span id="l92.146">                     self.mProposedCtag = null;</span>
<a href="#l92.147"></a><span id="l92.147">                 }</span>
<a href="#l92.148"></a><span id="l92.148">             }</span>
<a href="#l92.149"></a><span id="l92.149">         };</span>
<a href="#l92.150"></a><span id="l92.150">         this.mOfflineStorage.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l92.151"></a><span id="l92.151">                                       0, null, null, getMetaListener);</span>
<a href="#l92.152"></a><span id="l92.152">     },</span>
<a href="#l92.153"></a><span id="l92.153"> </span>
<a href="#l92.154"></a><span id="l92.154" class="difflineminus">-    fetchCachedMetaData: function caldav_fetchCachedMetaData() {</span>
<a href="#l92.155"></a><span id="l92.155" class="difflineplus">+    fetchCachedMetaData: function() {</span>
<a href="#l92.156"></a><span id="l92.156">         cal.LOG(&quot;CalDAV: Retrieving server info from cache for &quot; + this.name);</span>
<a href="#l92.157"></a><span id="l92.157">         let cacheIds = {};</span>
<a href="#l92.158"></a><span id="l92.158">         let cacheValues = {};</span>
<a href="#l92.159"></a><span id="l92.159">         this.mOfflineStorage.getAllMetaData({}, cacheIds, cacheValues);</span>
<a href="#l92.160"></a><span id="l92.160">         cacheIds = cacheIds.value;</span>
<a href="#l92.161"></a><span id="l92.161">         cacheValues = cacheValues.value;</span>
<a href="#l92.162"></a><span id="l92.162"> </span>
<a href="#l92.163"></a><span id="l92.163">         for (let count = 0; count &lt; cacheIds.length; count++) {</span>
<a href="#l92.164"></a><span id="l92.164" class="difflineat">@@ -438,17 +438,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.165"></a><span id="l92.165">             this.mUriParams = &quot;?&quot; + parts.join(&quot;?&quot;);</span>
<a href="#l92.166"></a><span id="l92.166">         }</span>
<a href="#l92.167"></a><span id="l92.167">         if (calUri.spec.charAt(calUri.spec.length - 1) != &quot;/&quot;) {</span>
<a href="#l92.168"></a><span id="l92.168">             calUri.spec += &quot;/&quot;;</span>
<a href="#l92.169"></a><span id="l92.169">         }</span>
<a href="#l92.170"></a><span id="l92.170">         return calUri;</span>
<a href="#l92.171"></a><span id="l92.171">     },</span>
<a href="#l92.172"></a><span id="l92.172"> </span>
<a href="#l92.173"></a><span id="l92.173" class="difflineminus">-    setCalHomeSet: function caldav_setCalHomeSet(removeLastPathSegment) {</span>
<a href="#l92.174"></a><span id="l92.174" class="difflineplus">+    setCalHomeSet: function(removeLastPathSegment) {</span>
<a href="#l92.175"></a><span id="l92.175">         if (removeLastPathSegment) {</span>
<a href="#l92.176"></a><span id="l92.176">             let calUri = this.mUri.clone();</span>
<a href="#l92.177"></a><span id="l92.177">             let split1 = calUri.spec.split(&quot;?&quot;);</span>
<a href="#l92.178"></a><span id="l92.178">             let baseUrl = split1[0];</span>
<a href="#l92.179"></a><span id="l92.179">             if (baseUrl.charAt(baseUrl.length - 1) == &quot;/&quot;) {</span>
<a href="#l92.180"></a><span id="l92.180">                 baseUrl = baseUrl.substring(0, baseUrl.length - 2);</span>
<a href="#l92.181"></a><span id="l92.181">             }</span>
<a href="#l92.182"></a><span id="l92.182">             let split2 = baseUrl.split(&quot;/&quot;);</span>
<a href="#l92.183"></a><span id="l92.183" class="difflineat">@@ -510,17 +510,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.184"></a><span id="l92.184">      *</span>
<a href="#l92.185"></a><span id="l92.185">      * @param aInsertString  String to append to the base uri, for example,</span>
<a href="#l92.186"></a><span id="l92.186">      *                       when creating an event this would be the</span>
<a href="#l92.187"></a><span id="l92.187">      *                       event file name (event.ics), if null, an empty</span>
<a href="#l92.188"></a><span id="l92.188">      *                       string is used.</span>
<a href="#l92.189"></a><span id="l92.189">      * @param aBaseUri       base uri (nsIURI object), if null, this.calendarUri</span>
<a href="#l92.190"></a><span id="l92.190">      *                       will be used.</span>
<a href="#l92.191"></a><span id="l92.191">      */</span>
<a href="#l92.192"></a><span id="l92.192" class="difflineminus">-    makeUri: function caldav_makeUri(aInsertString, aBaseUri) {</span>
<a href="#l92.193"></a><span id="l92.193" class="difflineplus">+    makeUri: function(aInsertString, aBaseUri) {</span>
<a href="#l92.194"></a><span id="l92.194">         let baseUri = aBaseUri || this.calendarUri;</span>
<a href="#l92.195"></a><span id="l92.195">         // Build a string containing the full path, decoded, so it looks like</span>
<a href="#l92.196"></a><span id="l92.196">         // this:</span>
<a href="#l92.197"></a><span id="l92.197">         // /some path/insert string.ics</span>
<a href="#l92.198"></a><span id="l92.198">         let decodedPath = this.ensureDecodedPath(baseUri.path) + (aInsertString || &quot;&quot;);</span>
<a href="#l92.199"></a><span id="l92.199"> </span>
<a href="#l92.200"></a><span id="l92.200">         // Build the nsIURI by specifying a string with a fully encoded path</span>
<a href="#l92.201"></a><span id="l92.201">         // the end result will be something like this:</span>
<a href="#l92.202"></a><span id="l92.202" class="difflineat">@@ -528,29 +528,29 @@ calDavCalendar.prototype = {</span>
<a href="#l92.203"></a><span id="l92.203">         let url = cal.makeURL(baseUri.prePath + this.ensureEncodedPath(decodedPath) + (this.mUriParams || &quot;&quot;));</span>
<a href="#l92.204"></a><span id="l92.204">         return url;</span>
<a href="#l92.205"></a><span id="l92.205">     },</span>
<a href="#l92.206"></a><span id="l92.206"> </span>
<a href="#l92.207"></a><span id="l92.207">     get mLocationPath() {</span>
<a href="#l92.208"></a><span id="l92.208">         return this.ensureDecodedPath(this.calendarUri.path);</span>
<a href="#l92.209"></a><span id="l92.209">     },</span>
<a href="#l92.210"></a><span id="l92.210"> </span>
<a href="#l92.211"></a><span id="l92.211" class="difflineminus">-    getItemLocationPath: function caldav_getItemLocationPath(aItem) {</span>
<a href="#l92.212"></a><span id="l92.212" class="difflineplus">+    getItemLocationPath: function(aItem) {</span>
<a href="#l92.213"></a><span id="l92.213">         if (aItem.id &amp;&amp;</span>
<a href="#l92.214"></a><span id="l92.214">             aItem.id in this.mItemInfoCache &amp;&amp;</span>
<a href="#l92.215"></a><span id="l92.215">             this.mItemInfoCache[aItem.id].locationPath) {</span>
<a href="#l92.216"></a><span id="l92.216">             // modifying items use the cached location path</span>
<a href="#l92.217"></a><span id="l92.217">             return this.mItemInfoCache[aItem.id].locationPath;</span>
<a href="#l92.218"></a><span id="l92.218">         } else {</span>
<a href="#l92.219"></a><span id="l92.219">             // New items just use id.ics</span>
<a href="#l92.220"></a><span id="l92.220">             return aItem.id + &quot;.ics&quot;;</span>
<a href="#l92.221"></a><span id="l92.221">         }</span>
<a href="#l92.222"></a><span id="l92.222">     },</span>
<a href="#l92.223"></a><span id="l92.223"> </span>
<a href="#l92.224"></a><span id="l92.224" class="difflineminus">-    getProperty: function caldav_getProperty(aName) {</span>
<a href="#l92.225"></a><span id="l92.225" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l92.226"></a><span id="l92.226">         if (aName in this.mACLProperties &amp;&amp; this.mACLProperties[aName]) {</span>
<a href="#l92.227"></a><span id="l92.227">             return this.mACLProperties[aName];</span>
<a href="#l92.228"></a><span id="l92.228">         }</span>
<a href="#l92.229"></a><span id="l92.229"> </span>
<a href="#l92.230"></a><span id="l92.230">         switch (aName) {</span>
<a href="#l92.231"></a><span id="l92.231">             case &quot;organizerId&quot;:</span>
<a href="#l92.232"></a><span id="l92.232">                 if (this.calendarUserAddress) {</span>
<a href="#l92.233"></a><span id="l92.233">                     return this.calendarUserAddress;</span>
<a href="#l92.234"></a><span id="l92.234" class="difflineat">@@ -568,17 +568,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.235"></a><span id="l92.235">             case &quot;capabilities.events.supported&quot;:</span>
<a href="#l92.236"></a><span id="l92.236">                 return this.supportedItemTypes.includes(&quot;VEVENT&quot;);</span>
<a href="#l92.237"></a><span id="l92.237">             case &quot;capabilities.autoschedule.supported&quot;:</span>
<a href="#l92.238"></a><span id="l92.238">                 return this.hasAutoScheduling;</span>
<a href="#l92.239"></a><span id="l92.239">         }</span>
<a href="#l92.240"></a><span id="l92.240">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l92.241"></a><span id="l92.241">     },</span>
<a href="#l92.242"></a><span id="l92.242"> </span>
<a href="#l92.243"></a><span id="l92.243" class="difflineminus">-    promptOverwrite: function caldav_promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l92.244"></a><span id="l92.244" class="difflineplus">+    promptOverwrite: function(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l92.245"></a><span id="l92.245">         let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l92.246"></a><span id="l92.246">         if (overwrite) {</span>
<a href="#l92.247"></a><span id="l92.247">             if (aMethod == CALDAV_MODIFY_ITEM) {</span>
<a href="#l92.248"></a><span id="l92.248">                 this.doModifyItem(aItem, aOldItem, aListener, true);</span>
<a href="#l92.249"></a><span id="l92.249">             } else {</span>
<a href="#l92.250"></a><span id="l92.250">                 this.doDeleteItem(aItem, aListener, true, false, null);</span>
<a href="#l92.251"></a><span id="l92.251">             }</span>
<a href="#l92.252"></a><span id="l92.252">         } else {</span>
<a href="#l92.253"></a><span id="l92.253" class="difflineat">@@ -592,39 +592,39 @@ calDavCalendar.prototype = {</span>
<a href="#l92.254"></a><span id="l92.254"> </span>
<a href="#l92.255"></a><span id="l92.255">     /**</span>
<a href="#l92.256"></a><span id="l92.256">      * addItem()</span>
<a href="#l92.257"></a><span id="l92.257">      * we actually use doAdoptItem()</span>
<a href="#l92.258"></a><span id="l92.258">      *</span>
<a href="#l92.259"></a><span id="l92.259">      * @param aItem       item to add</span>
<a href="#l92.260"></a><span id="l92.260">      * @param aListener   listener for method completion</span>
<a href="#l92.261"></a><span id="l92.261">      */</span>
<a href="#l92.262"></a><span id="l92.262" class="difflineminus">-    addItem: function caldav_addItem(aItem, aListener) {</span>
<a href="#l92.263"></a><span id="l92.263" class="difflineplus">+    addItem: function(aItem, aListener) {</span>
<a href="#l92.264"></a><span id="l92.264">         return this.doAdoptItem(aItem.clone(), aListener);</span>
<a href="#l92.265"></a><span id="l92.265">     },</span>
<a href="#l92.266"></a><span id="l92.266"> </span>
<a href="#l92.267"></a><span id="l92.267">     /**</span>
<a href="#l92.268"></a><span id="l92.268">      * adoptItem()</span>
<a href="#l92.269"></a><span id="l92.269">      * we actually use doAdoptItem()</span>
<a href="#l92.270"></a><span id="l92.270">      *</span>
<a href="#l92.271"></a><span id="l92.271">      * @param aItem       item to check</span>
<a href="#l92.272"></a><span id="l92.272">      * @param aListener   listener for method completion</span>
<a href="#l92.273"></a><span id="l92.273">      */</span>
<a href="#l92.274"></a><span id="l92.274" class="difflineminus">-    adoptItem: function caldav_adoptItem(aItem, aListener) {</span>
<a href="#l92.275"></a><span id="l92.275" class="difflineplus">+    adoptItem: function(aItem, aListener) {</span>
<a href="#l92.276"></a><span id="l92.276">         return this.doAdoptItem(aItem, aListener);</span>
<a href="#l92.277"></a><span id="l92.277">     },</span>
<a href="#l92.278"></a><span id="l92.278"> </span>
<a href="#l92.279"></a><span id="l92.279">     /**</span>
<a href="#l92.280"></a><span id="l92.280">      * Performs the actual addition of the item to CalDAV store</span>
<a href="#l92.281"></a><span id="l92.281">      *</span>
<a href="#l92.282"></a><span id="l92.282">      * @param aItem       item to add</span>
<a href="#l92.283"></a><span id="l92.283">      * @param aListener   listener for method completion</span>
<a href="#l92.284"></a><span id="l92.284">      * @param aIgnoreEtag flag to indicate ignoring of Etag</span>
<a href="#l92.285"></a><span id="l92.285">      */</span>
<a href="#l92.286"></a><span id="l92.286" class="difflineminus">-    doAdoptItem: function caldav_doAdoptItem(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l92.287"></a><span id="l92.287" class="difflineplus">+    doAdoptItem: function(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l92.288"></a><span id="l92.288">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l92.289"></a><span id="l92.289">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l92.290"></a><span id="l92.290">             this[method](aListener, status, cIOL.ADD, aItem.id, detail);</span>
<a href="#l92.291"></a><span id="l92.291">         };</span>
<a href="#l92.292"></a><span id="l92.292">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l92.293"></a><span id="l92.293">             aItem.id = cal.getUUID();</span>
<a href="#l92.294"></a><span id="l92.294">         }</span>
<a href="#l92.295"></a><span id="l92.295"> </span>
<a href="#l92.296"></a><span id="l92.296" class="difflineat">@@ -645,17 +645,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.297"></a><span id="l92.297"> </span>
<a href="#l92.298"></a><span id="l92.298">         let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l92.299"></a><span id="l92.299">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l92.300"></a><span id="l92.300">         cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l92.301"></a><span id="l92.301"> </span>
<a href="#l92.302"></a><span id="l92.302">         let self = this;</span>
<a href="#l92.303"></a><span id="l92.303">         let serializedItem = this.getSerializedItem(aItem);</span>
<a href="#l92.304"></a><span id="l92.304">         let addListener = {</span>
<a href="#l92.305"></a><span id="l92.305" class="difflineminus">-            onStreamComplete: function onPutComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.306"></a><span id="l92.306" class="difflineplus">+            onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.307"></a><span id="l92.307">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.308"></a><span id="l92.308">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l92.309"></a><span id="l92.309">                 let listenerDetail = parentItem;</span>
<a href="#l92.310"></a><span id="l92.310">                 let responseStatus;</span>
<a href="#l92.311"></a><span id="l92.311">                 try {</span>
<a href="#l92.312"></a><span id="l92.312">                     responseStatus = request.responseStatus;</span>
<a href="#l92.313"></a><span id="l92.313"> </span>
<a href="#l92.314"></a><span id="l92.314">                     if (self.verboseLogging()) {</span>
<a href="#l92.315"></a><span id="l92.315" class="difflineat">@@ -727,29 +727,29 @@ calDavCalendar.prototype = {</span>
<a href="#l92.316"></a><span id="l92.316"> </span>
<a href="#l92.317"></a><span id="l92.317">     /**</span>
<a href="#l92.318"></a><span id="l92.318">      * modifyItem(); required by calICalendar.idl</span>
<a href="#l92.319"></a><span id="l92.319">      * we actually use doModifyItem()</span>
<a href="#l92.320"></a><span id="l92.320">      *</span>
<a href="#l92.321"></a><span id="l92.321">      * @param aItem       item to check</span>
<a href="#l92.322"></a><span id="l92.322">      * @param aListener   listener for method completion</span>
<a href="#l92.323"></a><span id="l92.323">     */</span>
<a href="#l92.324"></a><span id="l92.324" class="difflineminus">-    modifyItem: function caldav_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l92.325"></a><span id="l92.325" class="difflineplus">+    modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l92.326"></a><span id="l92.326">         return this.doModifyItem(aNewItem, aOldItem, aListener, false);</span>
<a href="#l92.327"></a><span id="l92.327">     },</span>
<a href="#l92.328"></a><span id="l92.328"> </span>
<a href="#l92.329"></a><span id="l92.329">     /**</span>
<a href="#l92.330"></a><span id="l92.330">      * Modifies existing item in CalDAV store.</span>
<a href="#l92.331"></a><span id="l92.331">      *</span>
<a href="#l92.332"></a><span id="l92.332">      * @param aItem       item to check</span>
<a href="#l92.333"></a><span id="l92.333">      * @param aOldItem    previous version of item to be modified</span>
<a href="#l92.334"></a><span id="l92.334">      * @param aListener   listener from original request</span>
<a href="#l92.335"></a><span id="l92.335">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l92.336"></a><span id="l92.336">      */</span>
<a href="#l92.337"></a><span id="l92.337" class="difflineminus">-    doModifyItem: function caldav_doModifyItem(aNewItem, aOldItem, aListener, aIgnoreEtag) {</span>
<a href="#l92.338"></a><span id="l92.338" class="difflineplus">+    doModifyItem: function(aNewItem, aOldItem, aListener, aIgnoreEtag) {</span>
<a href="#l92.339"></a><span id="l92.339">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l92.340"></a><span id="l92.340">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l92.341"></a><span id="l92.341">             this[method](aListener, status, cIOL.MODIFY, aNewItem.id, detail);</span>
<a href="#l92.342"></a><span id="l92.342">         };</span>
<a href="#l92.343"></a><span id="l92.343">         if (aNewItem.id == null) {</span>
<a href="#l92.344"></a><span id="l92.344">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l92.345"></a><span id="l92.345">                            &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l92.346"></a><span id="l92.346">             return;</span>
<a href="#l92.347"></a><span id="l92.347" class="difflineat">@@ -766,18 +766,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.348"></a><span id="l92.348"> </span>
<a href="#l92.349"></a><span id="l92.349">         let eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l92.350"></a><span id="l92.350"> </span>
<a href="#l92.351"></a><span id="l92.351">         let self = this;</span>
<a href="#l92.352"></a><span id="l92.352"> </span>
<a href="#l92.353"></a><span id="l92.353">         let modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l92.354"></a><span id="l92.354"> </span>
<a href="#l92.355"></a><span id="l92.355">         let modListener = {</span>
<a href="#l92.356"></a><span id="l92.356" class="difflineminus">-            onStreamComplete: function caldav_mod_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l92.357"></a><span id="l92.357" class="difflineminus">-                                                                   aResultLength, aResult) {</span>
<a href="#l92.358"></a><span id="l92.358" class="difflineplus">+            onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.359"></a><span id="l92.359">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.360"></a><span id="l92.360">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l92.361"></a><span id="l92.361">                 let listenerDetail = aNewItem;</span>
<a href="#l92.362"></a><span id="l92.362">                 let responseStatus;</span>
<a href="#l92.363"></a><span id="l92.363">                 try {</span>
<a href="#l92.364"></a><span id="l92.364">                     responseStatus = request.responseStatus;</span>
<a href="#l92.365"></a><span id="l92.365"> </span>
<a href="#l92.366"></a><span id="l92.366">                     if (self.verboseLogging()) {</span>
<a href="#l92.367"></a><span id="l92.367" class="difflineat">@@ -851,30 +850,30 @@ calDavCalendar.prototype = {</span>
<a href="#l92.368"></a><span id="l92.368"> </span>
<a href="#l92.369"></a><span id="l92.369">     /**</span>
<a href="#l92.370"></a><span id="l92.370">      * deleteItem(); required by calICalendar.idl</span>
<a href="#l92.371"></a><span id="l92.371">      * the actual deletion is done in doDeleteItem()</span>
<a href="#l92.372"></a><span id="l92.372">      *</span>
<a href="#l92.373"></a><span id="l92.373">      * @param aItem       item to delete</span>
<a href="#l92.374"></a><span id="l92.374">      * @param aListener   listener for method completion</span>
<a href="#l92.375"></a><span id="l92.375">      */</span>
<a href="#l92.376"></a><span id="l92.376" class="difflineminus">-    deleteItem: function caldav_deleteItem(aItem, aListener) {</span>
<a href="#l92.377"></a><span id="l92.377" class="difflineplus">+    deleteItem: function(aItem, aListener) {</span>
<a href="#l92.378"></a><span id="l92.378">         return this.doDeleteItem(aItem, aListener, false, null, null);</span>
<a href="#l92.379"></a><span id="l92.379">     },</span>
<a href="#l92.380"></a><span id="l92.380"> </span>
<a href="#l92.381"></a><span id="l92.381">     /**</span>
<a href="#l92.382"></a><span id="l92.382">      * Deletes item from CalDAV store.</span>
<a href="#l92.383"></a><span id="l92.383">      *</span>
<a href="#l92.384"></a><span id="l92.384">      * @param aItem       item to delete</span>
<a href="#l92.385"></a><span id="l92.385">      * @param aListener   listener for method completion</span>
<a href="#l92.386"></a><span id="l92.386">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l92.387"></a><span id="l92.387">      * @param aFromInbox  delete from inbox rather than calendar</span>
<a href="#l92.388"></a><span id="l92.388">      * @param aUri        uri of item to delete</span>
<a href="#l92.389"></a><span id="l92.389">      * */</span>
<a href="#l92.390"></a><span id="l92.390" class="difflineminus">-    doDeleteItem: function caldav_doDeleteItem(aItem, aListener, aIgnoreEtag, aFromInbox, aUri) {</span>
<a href="#l92.391"></a><span id="l92.391" class="difflineplus">+    doDeleteItem: function(aItem, aListener, aIgnoreEtag, aFromInbox, aUri) {</span>
<a href="#l92.392"></a><span id="l92.392">         let notifyListener = (status, detail, pure=false) =&gt; {</span>
<a href="#l92.393"></a><span id="l92.393">             let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l92.394"></a><span id="l92.394">             this[method](aListener, status, cIOL.DELETE, aItem.id, detail);</span>
<a href="#l92.395"></a><span id="l92.395">         };</span>
<a href="#l92.396"></a><span id="l92.396"> </span>
<a href="#l92.397"></a><span id="l92.397">         if (aItem.id == null) {</span>
<a href="#l92.398"></a><span id="l92.398">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l92.399"></a><span id="l92.399">                            &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l92.400"></a><span id="l92.400" class="difflineat">@@ -895,17 +894,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.401"></a><span id="l92.401">                            &quot;eventUri and calendarUri paths are the same, &quot; +</span>
<a href="#l92.402"></a><span id="l92.402">                            &quot;will not go on to delete entire calendar&quot;);</span>
<a href="#l92.403"></a><span id="l92.403">             return;</span>
<a href="#l92.404"></a><span id="l92.404">         }</span>
<a href="#l92.405"></a><span id="l92.405"> </span>
<a href="#l92.406"></a><span id="l92.406">         let self = this;</span>
<a href="#l92.407"></a><span id="l92.407"> </span>
<a href="#l92.408"></a><span id="l92.408">         let delListener = {</span>
<a href="#l92.409"></a><span id="l92.409" class="difflineminus">-            onStreamComplete: function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.410"></a><span id="l92.410" class="difflineplus">+            onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.411"></a><span id="l92.411">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.412"></a><span id="l92.412">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l92.413"></a><span id="l92.413">                 let listenerDetail = aItem;</span>
<a href="#l92.414"></a><span id="l92.414">                 let responseStatus;</span>
<a href="#l92.415"></a><span id="l92.415">                 try {</span>
<a href="#l92.416"></a><span id="l92.416">                     responseStatus = request.responseStatus;</span>
<a href="#l92.417"></a><span id="l92.417"> </span>
<a href="#l92.418"></a><span id="l92.418">                     if (self.verboseLogging()) {</span>
<a href="#l92.419"></a><span id="l92.419" class="difflineat">@@ -965,17 +964,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.420"></a><span id="l92.420">                 }</span>
<a href="#l92.421"></a><span id="l92.421"> </span>
<a href="#l92.422"></a><span id="l92.422">                 // Finally, notify listener.</span>
<a href="#l92.423"></a><span id="l92.423">                 notifyListener(listenerStatus, listenerDetail);</span>
<a href="#l92.424"></a><span id="l92.424">             }</span>
<a href="#l92.425"></a><span id="l92.425">         };</span>
<a href="#l92.426"></a><span id="l92.426"> </span>
<a href="#l92.427"></a><span id="l92.427">         let delListener2 = {</span>
<a href="#l92.428"></a><span id="l92.428" class="difflineminus">-            onStreamComplete: function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.429"></a><span id="l92.429" class="difflineplus">+            onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.430"></a><span id="l92.430">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.431"></a><span id="l92.431">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l92.432"></a><span id="l92.432">                 let listenerDetail = aItem;</span>
<a href="#l92.433"></a><span id="l92.433">                 let responseStatus;</span>
<a href="#l92.434"></a><span id="l92.434">                 try {</span>
<a href="#l92.435"></a><span id="l92.435">                     responseStatus = request.responseStatus;</span>
<a href="#l92.436"></a><span id="l92.436"> </span>
<a href="#l92.437"></a><span id="l92.437">                     if (self.verboseLogging()) {</span>
<a href="#l92.438"></a><span id="l92.438" class="difflineat">@@ -1028,17 +1027,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.439"></a><span id="l92.439">     /**</span>
<a href="#l92.440"></a><span id="l92.440">      * Add an item to the target calendar</span>
<a href="#l92.441"></a><span id="l92.441">      *</span>
<a href="#l92.442"></a><span id="l92.442">      * @param path      Item path MUST NOT BE ENCODED</span>
<a href="#l92.443"></a><span id="l92.443">      * @param calData   iCalendar string representation of the item</span>
<a href="#l92.444"></a><span id="l92.444">      * @param aUri      Base URI of the request</span>
<a href="#l92.445"></a><span id="l92.445">      * @param aListener Listener</span>
<a href="#l92.446"></a><span id="l92.446">      */</span>
<a href="#l92.447"></a><span id="l92.447" class="difflineminus">-    addTargetCalendarItem: function caldav_addTargetCalendarItem(path, calData, aUri, etag, aListener) {</span>
<a href="#l92.448"></a><span id="l92.448" class="difflineplus">+    addTargetCalendarItem: function(path, calData, aUri, etag, aListener) {</span>
<a href="#l92.449"></a><span id="l92.449">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l92.450"></a><span id="l92.450">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l92.451"></a><span id="l92.451">         // aUri.path may contain double slashes whereas path does not</span>
<a href="#l92.452"></a><span id="l92.452">         // this confuses our counting, so remove multiple successive slashes</span>
<a href="#l92.453"></a><span id="l92.453">         let strippedUriPath = aUri.path.replace(/\/{2,}/g, &quot;/&quot;);</span>
<a href="#l92.454"></a><span id="l92.454">         let uriPathComponentLength = strippedUriPath.split(&quot;/&quot;).length;</span>
<a href="#l92.455"></a><span id="l92.455">         try {</span>
<a href="#l92.456"></a><span id="l92.456">             parser.parseString(calData);</span>
<a href="#l92.457"></a><span id="l92.457" class="difflineat">@@ -1174,17 +1173,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.458"></a><span id="l92.458">     /**</span>
<a href="#l92.459"></a><span id="l92.459">      * Perform tasks required after updating items in the calendar such as</span>
<a href="#l92.460"></a><span id="l92.460">      * notifying the observers and listeners</span>
<a href="#l92.461"></a><span id="l92.461">      *</span>
<a href="#l92.462"></a><span id="l92.462">      * @param aChangeLogListener    Change log listener</span>
<a href="#l92.463"></a><span id="l92.463">      * @param calendarURI           URI of the calendar whose items just got</span>
<a href="#l92.464"></a><span id="l92.464">      *                              changed</span>
<a href="#l92.465"></a><span id="l92.465">      */</span>
<a href="#l92.466"></a><span id="l92.466" class="difflineminus">-    finalizeUpdatedItems: function calDav_finalizeUpdatedItems(aChangeLogListener, calendarURI) {</span>
<a href="#l92.467"></a><span id="l92.467" class="difflineplus">+    finalizeUpdatedItems: function(aChangeLogListener, calendarURI) {</span>
<a href="#l92.468"></a><span id="l92.468">         cal.LOG(&quot;aChangeLogListener=&quot; + aChangeLogListener + &quot;\n&quot; +</span>
<a href="#l92.469"></a><span id="l92.469">                 &quot;calendarURI=&quot; + (calendarURI ? calendarURI.spec : &quot;undefined&quot;) + &quot; \n&quot; +</span>
<a href="#l92.470"></a><span id="l92.470">                 &quot;iscached=&quot; + this.isCached + &quot;\n&quot; +</span>
<a href="#l92.471"></a><span id="l92.471">                 &quot;this.mQueuedQueries.length=&quot; + this.mQueuedQueries.length);</span>
<a href="#l92.472"></a><span id="l92.472">         if (this.isCached) {</span>
<a href="#l92.473"></a><span id="l92.473">             if (aChangeLogListener) {</span>
<a href="#l92.474"></a><span id="l92.474">                 aChangeLogListener.onResult({ status: Components.results.NS_OK },</span>
<a href="#l92.475"></a><span id="l92.475">                                             Components.results.NS_OK);</span>
<a href="#l92.476"></a><span id="l92.476" class="difflineat">@@ -1212,17 +1211,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.477"></a><span id="l92.477"> </span>
<a href="#l92.478"></a><span id="l92.478">     /**</span>
<a href="#l92.479"></a><span id="l92.479">      * Notifies the caller that a get request has failed.</span>
<a href="#l92.480"></a><span id="l92.480">      *</span>
<a href="#l92.481"></a><span id="l92.481">      * @param errorMsg           Error message</span>
<a href="#l92.482"></a><span id="l92.482">      * @param aListener          (optional) Listener of the request</span>
<a href="#l92.483"></a><span id="l92.483">      * @param aChangeLogListener (optional)Listener for cached calendars</span>
<a href="#l92.484"></a><span id="l92.484">      */</span>
<a href="#l92.485"></a><span id="l92.485" class="difflineminus">-    notifyGetFailed: function notifyGetFailed(errorMsg, aListener, aChangeLogListener) {</span>
<a href="#l92.486"></a><span id="l92.486" class="difflineplus">+    notifyGetFailed: function(errorMsg, aListener, aChangeLogListener) {</span>
<a href="#l92.487"></a><span id="l92.487">          cal.WARN(&quot;CalDAV: Get failed: &quot; + errorMsg);</span>
<a href="#l92.488"></a><span id="l92.488"> </span>
<a href="#l92.489"></a><span id="l92.489">          // Notify changelog listener</span>
<a href="#l92.490"></a><span id="l92.490">          if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l92.491"></a><span id="l92.491">              aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l92.492"></a><span id="l92.492">                                          Components.results.NS_ERROR_FAILURE);</span>
<a href="#l92.493"></a><span id="l92.493">          }</span>
<a href="#l92.494"></a><span id="l92.494"> </span>
<a href="#l92.495"></a><span id="l92.495" class="difflineat">@@ -1250,17 +1249,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.496"></a><span id="l92.496"> </span>
<a href="#l92.497"></a><span id="l92.497">     /**</span>
<a href="#l92.498"></a><span id="l92.498">      * Retrieves a specific item from the CalDAV store.</span>
<a href="#l92.499"></a><span id="l92.499">      * Use when an outdated copy of the item is in hand.</span>
<a href="#l92.500"></a><span id="l92.500">      *</span>
<a href="#l92.501"></a><span id="l92.501">      * @param aItem       item to fetch</span>
<a href="#l92.502"></a><span id="l92.502">      * @param aListener   listener for method completion</span>
<a href="#l92.503"></a><span id="l92.503">      */</span>
<a href="#l92.504"></a><span id="l92.504" class="difflineminus">-    getUpdatedItem: function caldav_getUpdatedItem(aItem, aListener, aChangeLogListener) {</span>
<a href="#l92.505"></a><span id="l92.505" class="difflineplus">+    getUpdatedItem: function(aItem, aListener, aChangeLogListener) {</span>
<a href="#l92.506"></a><span id="l92.506">         if (aItem == null) {</span>
<a href="#l92.507"></a><span id="l92.507">             this.notifyOperationComplete(aListener,</span>
<a href="#l92.508"></a><span id="l92.508">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l92.509"></a><span id="l92.509">                                          cIOL.GET,</span>
<a href="#l92.510"></a><span id="l92.510">                                          null,</span>
<a href="#l92.511"></a><span id="l92.511">                                          &quot;passed in null item&quot;);</span>
<a href="#l92.512"></a><span id="l92.512">             return;</span>
<a href="#l92.513"></a><span id="l92.513">         }</span>
<a href="#l92.514"></a><span id="l92.514" class="difflineat">@@ -1274,25 +1273,24 @@ calDavCalendar.prototype = {</span>
<a href="#l92.515"></a><span id="l92.515">                                                null,</span>
<a href="#l92.516"></a><span id="l92.516">                                                false,</span>
<a href="#l92.517"></a><span id="l92.517">                                                aListener,</span>
<a href="#l92.518"></a><span id="l92.518">                                                aChangeLogListener);</span>
<a href="#l92.519"></a><span id="l92.519">         multiget.doMultiGet();</span>
<a href="#l92.520"></a><span id="l92.520">     },</span>
<a href="#l92.521"></a><span id="l92.521"> </span>
<a href="#l92.522"></a><span id="l92.522">     // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l92.523"></a><span id="l92.523" class="difflineminus">-    getItem: function caldav_getItem(aId, aListener) {</span>
<a href="#l92.524"></a><span id="l92.524" class="difflineplus">+    getItem: function(aId, aListener) {</span>
<a href="#l92.525"></a><span id="l92.525">         this.mOfflineStorage.getItem(aId, aListener);</span>
<a href="#l92.526"></a><span id="l92.526">     },</span>
<a href="#l92.527"></a><span id="l92.527"> </span>
<a href="#l92.528"></a><span id="l92.528">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l92.529"></a><span id="l92.529">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l92.530"></a><span id="l92.530">     //                in calIOperationListener aListener );</span>
<a href="#l92.531"></a><span id="l92.531" class="difflineminus">-    getItems: function caldav_getItems(aItemFilter, aCount, aRangeStart,</span>
<a href="#l92.532"></a><span id="l92.532" class="difflineminus">-                                       aRangeEnd, aListener) {</span>
<a href="#l92.533"></a><span id="l92.533" class="difflineplus">+    getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l92.534"></a><span id="l92.534">         if (this.isCached) {</span>
<a href="#l92.535"></a><span id="l92.535">             if (this.mOfflineStorage) {</span>
<a href="#l92.536"></a><span id="l92.536">                 this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l92.537"></a><span id="l92.537">             } else {</span>
<a href="#l92.538"></a><span id="l92.538">                 this.notifyOperationComplete(aListener,</span>
<a href="#l92.539"></a><span id="l92.539">                                              Components.results.NS_OK,</span>
<a href="#l92.540"></a><span id="l92.540">                                              cIOL.GET,</span>
<a href="#l92.541"></a><span id="l92.541">                                              null,</span>
<a href="#l92.542"></a><span id="l92.542" class="difflineat">@@ -1300,34 +1298,34 @@ calDavCalendar.prototype = {</span>
<a href="#l92.543"></a><span id="l92.543">             }</span>
<a href="#l92.544"></a><span id="l92.544">         } else if (!this.checkedServerInfo) {</span>
<a href="#l92.545"></a><span id="l92.545">             this.mQueuedQueries.push(Array.from(arguments));</span>
<a href="#l92.546"></a><span id="l92.546">         } else {</span>
<a href="#l92.547"></a><span id="l92.547">             this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l92.548"></a><span id="l92.548">         }</span>
<a href="#l92.549"></a><span id="l92.549">     },</span>
<a href="#l92.550"></a><span id="l92.550"> </span>
<a href="#l92.551"></a><span id="l92.551" class="difflineminus">-    fillACLProperties: function caldav_fillACLProperties() {</span>
<a href="#l92.552"></a><span id="l92.552" class="difflineplus">+    fillACLProperties: function() {</span>
<a href="#l92.553"></a><span id="l92.553">         let orgId = this.calendarUserAddress;</span>
<a href="#l92.554"></a><span id="l92.554">         if (orgId) {</span>
<a href="#l92.555"></a><span id="l92.555">             this.mACLProperties.organizerId = orgId;</span>
<a href="#l92.556"></a><span id="l92.556">         }</span>
<a href="#l92.557"></a><span id="l92.557"> </span>
<a href="#l92.558"></a><span id="l92.558">         if (this.mACLEntry &amp;&amp; this.mACLEntry.hasAccessControl) {</span>
<a href="#l92.559"></a><span id="l92.559">             let ownerIdentities = this.mACLEntry.getOwnerIdentities({});</span>
<a href="#l92.560"></a><span id="l92.560">             if (ownerIdentities.length &gt; 0) {</span>
<a href="#l92.561"></a><span id="l92.561">                 let identity = ownerIdentities[0];</span>
<a href="#l92.562"></a><span id="l92.562">                 this.mACLProperties.organizerId = identity.email;</span>
<a href="#l92.563"></a><span id="l92.563">                 this.mACLProperties.organizerCN = identity.fullName;</span>
<a href="#l92.564"></a><span id="l92.564">                 this.mACLProperties[&quot;imip.identity&quot;] = identity;</span>
<a href="#l92.565"></a><span id="l92.565">             }</span>
<a href="#l92.566"></a><span id="l92.566">         }</span>
<a href="#l92.567"></a><span id="l92.567">     },</span>
<a href="#l92.568"></a><span id="l92.568"> </span>
<a href="#l92.569"></a><span id="l92.569" class="difflineminus">-    safeRefresh: function caldav_safeRefresh(aChangeLogListener) {</span>
<a href="#l92.570"></a><span id="l92.570" class="difflineplus">+    safeRefresh: function(aChangeLogListener) {</span>
<a href="#l92.571"></a><span id="l92.571">         let notifyListener = (status) =&gt; {</span>
<a href="#l92.572"></a><span id="l92.572">             if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l92.573"></a><span id="l92.573">                 aChangeLogListener.onResult({ status: status }, status);</span>
<a href="#l92.574"></a><span id="l92.574">             }</span>
<a href="#l92.575"></a><span id="l92.575">         };</span>
<a href="#l92.576"></a><span id="l92.576"> </span>
<a href="#l92.577"></a><span id="l92.577">         if (!this.mACLEntry) {</span>
<a href="#l92.578"></a><span id="l92.578">             let self = this;</span>
<a href="#l92.579"></a><span id="l92.579" class="difflineat">@@ -1387,17 +1385,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.580"></a><span id="l92.580">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l92.581"></a><span id="l92.581"> </span>
<a href="#l92.582"></a><span id="l92.582">         if (this.verboseLogging()) {</span>
<a href="#l92.583"></a><span id="l92.583">             cal.LOG(&quot;CalDAV: send(&quot; + this.makeUri().spec + &quot;): &quot; + queryXml);</span>
<a href="#l92.584"></a><span id="l92.584">         }</span>
<a href="#l92.585"></a><span id="l92.585"> </span>
<a href="#l92.586"></a><span id="l92.586">         let streamListener = {};</span>
<a href="#l92.587"></a><span id="l92.587">         streamListener.onStreamComplete =</span>
<a href="#l92.588"></a><span id="l92.588" class="difflineminus">-            function safeRefresh_safeRefresh_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.589"></a><span id="l92.589" class="difflineplus">+            function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.590"></a><span id="l92.590">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.591"></a><span id="l92.591">             try {</span>
<a href="#l92.592"></a><span id="l92.592">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l92.593"></a><span id="l92.593">                         &quot; checking ctag for calendar &quot; + self.name);</span>
<a href="#l92.594"></a><span id="l92.594">             } catch (ex) {</span>
<a href="#l92.595"></a><span id="l92.595">                 cal.LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l92.596"></a><span id="l92.596">                         self.name);</span>
<a href="#l92.597"></a><span id="l92.597">                 notifyListener(Components.results.NS_OK);</span>
<a href="#l92.598"></a><span id="l92.598" class="difflineat">@@ -1463,21 +1461,21 @@ calDavCalendar.prototype = {</span>
<a href="#l92.599"></a><span id="l92.599">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l92.600"></a><span id="l92.600">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l92.601"></a><span id="l92.601">             return streamListener;</span>
<a href="#l92.602"></a><span id="l92.602">         }, () =&gt; {</span>
<a href="#l92.603"></a><span id="l92.603">             notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l92.604"></a><span id="l92.604">         });</span>
<a href="#l92.605"></a><span id="l92.605">     },</span>
<a href="#l92.606"></a><span id="l92.606"> </span>
<a href="#l92.607"></a><span id="l92.607" class="difflineminus">-    refresh: function caldav_refresh() {</span>
<a href="#l92.608"></a><span id="l92.608" class="difflineplus">+    refresh: function() {</span>
<a href="#l92.609"></a><span id="l92.609">         this.replayChangesOn(null);</span>
<a href="#l92.610"></a><span id="l92.610">     },</span>
<a href="#l92.611"></a><span id="l92.611"> </span>
<a href="#l92.612"></a><span id="l92.612" class="difflineminus">-    firstInRealm: function caldav_firstInRealm() {</span>
<a href="#l92.613"></a><span id="l92.613" class="difflineplus">+    firstInRealm: function() {</span>
<a href="#l92.614"></a><span id="l92.614">         let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l92.615"></a><span id="l92.615">         for (let i = 0; i &lt; calendars.length; i++) {</span>
<a href="#l92.616"></a><span id="l92.616">             if (calendars[i].type != &quot;caldav&quot; || calendars[i].getProperty(&quot;disabled&quot;)) {</span>
<a href="#l92.617"></a><span id="l92.617">                 continue;</span>
<a href="#l92.618"></a><span id="l92.618">             }</span>
<a href="#l92.619"></a><span id="l92.619">             // XXX We should probably expose the inner calendar via an</span>
<a href="#l92.620"></a><span id="l92.620">             // interface, but for now use wrappedJSObject.</span>
<a href="#l92.621"></a><span id="l92.621">             let calendar = calendars[i].wrappedJSObject;</span>
<a href="#l92.622"></a><span id="l92.622" class="difflineat">@@ -1500,17 +1498,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.623"></a><span id="l92.623">      *</span>
<a href="#l92.624"></a><span id="l92.624">      * @param aUri                  The uri to request the items from.</span>
<a href="#l92.625"></a><span id="l92.625">      *                                NOTE: This must be the uri without any uri</span>
<a href="#l92.626"></a><span id="l92.626">      *                                     params. They will be appended in this</span>
<a href="#l92.627"></a><span id="l92.627">      *                                     function.</span>
<a href="#l92.628"></a><span id="l92.628">      * @param aChangeLogListener    (optional) The listener to notify for cached</span>
<a href="#l92.629"></a><span id="l92.629">      *                                         calendars.</span>
<a href="#l92.630"></a><span id="l92.630">      */</span>
<a href="#l92.631"></a><span id="l92.631" class="difflineminus">-    getUpdatedItems: function caldav_getUpdatedItems(aUri, aChangeLogListener) {</span>
<a href="#l92.632"></a><span id="l92.632" class="difflineplus">+    getUpdatedItems: function(aUri, aChangeLogListener) {</span>
<a href="#l92.633"></a><span id="l92.633">         if (this.mDisabled) {</span>
<a href="#l92.634"></a><span id="l92.634">             // check if maybe our calendar has become available</span>
<a href="#l92.635"></a><span id="l92.635">             this.setupAuthentication(aChangeLogListener);</span>
<a href="#l92.636"></a><span id="l92.636">             return;</span>
<a href="#l92.637"></a><span id="l92.637">         }</span>
<a href="#l92.638"></a><span id="l92.638"> </span>
<a href="#l92.639"></a><span id="l92.639">         if (this.mHasWebdavSyncSupport) {</span>
<a href="#l92.640"></a><span id="l92.640">             webDavSync = new webDavSyncHandler(this, aUri, aChangeLogListener);</span>
<a href="#l92.641"></a><span id="l92.641" class="difflineat">@@ -1606,32 +1604,32 @@ calDavCalendar.prototype = {</span>
<a href="#l92.642"></a><span id="l92.642">                                                  [this.name], &quot;global&quot;);</span>
<a href="#l92.643"></a><span id="l92.643"> </span>
<a href="#l92.644"></a><span id="l92.644">                 this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE,</span>
<a href="#l92.645"></a><span id="l92.645">                                         OAUTH_CLIENT_ID, OAUTH_HASH);</span>
<a href="#l92.646"></a><span id="l92.646">                 this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l92.647"></a><span id="l92.647">                 this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=600&quot;;</span>
<a href="#l92.648"></a><span id="l92.648"> </span>
<a href="#l92.649"></a><span id="l92.649">                 Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l92.650"></a><span id="l92.650" class="difflineminus">-                    get: function getRefreshToken() {</span>
<a href="#l92.651"></a><span id="l92.651" class="difflineplus">+                    get: function() {</span>
<a href="#l92.652"></a><span id="l92.652">                         if (!this.mRefreshToken) {</span>
<a href="#l92.653"></a><span id="l92.653">                             let pass = { value: null };</span>
<a href="#l92.654"></a><span id="l92.654">                             try {</span>
<a href="#l92.655"></a><span id="l92.655">                                 cal.auth.passwordManagerGet(sessionId, pass, sessionId, pwMgrId);</span>
<a href="#l92.656"></a><span id="l92.656">                             } catch (e) {</span>
<a href="#l92.657"></a><span id="l92.657">                                 // User might have cancelled the master password prompt, thats ok</span>
<a href="#l92.658"></a><span id="l92.658">                                 if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l92.659"></a><span id="l92.659">                                     throw e;</span>
<a href="#l92.660"></a><span id="l92.660">                                 }</span>
<a href="#l92.661"></a><span id="l92.661">                             }</span>
<a href="#l92.662"></a><span id="l92.662">                             this.mRefreshToken = pass.value;</span>
<a href="#l92.663"></a><span id="l92.663">                         }</span>
<a href="#l92.664"></a><span id="l92.664">                         return this.mRefreshToken;</span>
<a href="#l92.665"></a><span id="l92.665">                     },</span>
<a href="#l92.666"></a><span id="l92.666" class="difflineminus">-                    set: function setRefreshToken(val) {</span>
<a href="#l92.667"></a><span id="l92.667" class="difflineplus">+                    set: function(val) {</span>
<a href="#l92.668"></a><span id="l92.668">                         try {</span>
<a href="#l92.669"></a><span id="l92.669">                             if (!val) {</span>
<a href="#l92.670"></a><span id="l92.670">                                 cal.auth.passwordManagerRemove(sessionId, sessionId, pwMgrId);</span>
<a href="#l92.671"></a><span id="l92.671">                             } else {</span>
<a href="#l92.672"></a><span id="l92.672">                                 cal.auth.passwordManagerSave(sessionId, val, sessionId, pwMgrId);</span>
<a href="#l92.673"></a><span id="l92.673">                             }</span>
<a href="#l92.674"></a><span id="l92.674">                         } catch (e) {</span>
<a href="#l92.675"></a><span id="l92.675">                             // User might have cancelled the master password prompt, thats ok</span>
<a href="#l92.676"></a><span id="l92.676" class="difflineat">@@ -1647,17 +1645,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.677"></a><span id="l92.677"> </span>
<a href="#l92.678"></a><span id="l92.678">             if (this.oauth.accessToken) {</span>
<a href="#l92.679"></a><span id="l92.679">                 authSuccess();</span>
<a href="#l92.680"></a><span id="l92.680">             } else {</span>
<a href="#l92.681"></a><span id="l92.681">                 // bug 901329: If the calendar window isn't loaded yet the</span>
<a href="#l92.682"></a><span id="l92.682">                 // master password prompt will show just the buttons and</span>
<a href="#l92.683"></a><span id="l92.683">                 // possibly hang. If we postpone until the window is loaded,</span>
<a href="#l92.684"></a><span id="l92.684">                 // all is well.</span>
<a href="#l92.685"></a><span id="l92.685" class="difflineminus">-                setTimeout(function postpone() {</span>
<a href="#l92.686"></a><span id="l92.686" class="difflineplus">+                setTimeout(function postpone() { // eslint-disable-line func-names</span>
<a href="#l92.687"></a><span id="l92.687">                     let win = cal.getCalendarWindow();</span>
<a href="#l92.688"></a><span id="l92.688">                     if (!win || win.document.readyState != &quot;complete&quot;) {</span>
<a href="#l92.689"></a><span id="l92.689">                         setTimeout(postpone, 0);</span>
<a href="#l92.690"></a><span id="l92.690">                     } else {</span>
<a href="#l92.691"></a><span id="l92.691">                         connect();</span>
<a href="#l92.692"></a><span id="l92.692">                     }</span>
<a href="#l92.693"></a><span id="l92.693">                 }, 0);</span>
<a href="#l92.694"></a><span id="l92.694">             }</span>
<a href="#l92.695"></a><span id="l92.695" class="difflineat">@@ -1671,17 +1669,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.696"></a><span id="l92.696">      *</span>
<a href="#l92.697"></a><span id="l92.697">      * setupAuthentication</span>
<a href="#l92.698"></a><span id="l92.698">      * checkDavResourceType                        * You are here</span>
<a href="#l92.699"></a><span id="l92.699">      * checkServerCaps</span>
<a href="#l92.700"></a><span id="l92.700">      * findPrincipalNS</span>
<a href="#l92.701"></a><span id="l92.701">      * checkPrincipalsNameSpace</span>
<a href="#l92.702"></a><span id="l92.702">      * completeCheckServerInfo</span>
<a href="#l92.703"></a><span id="l92.703">      */</span>
<a href="#l92.704"></a><span id="l92.704" class="difflineminus">-    checkDavResourceType: function caldav_checkDavResourceType(aChangeLogListener) {</span>
<a href="#l92.705"></a><span id="l92.705" class="difflineplus">+    checkDavResourceType: function(aChangeLogListener) {</span>
<a href="#l92.706"></a><span id="l92.706">         this.ensureTargetCalendar();</span>
<a href="#l92.707"></a><span id="l92.707"> </span>
<a href="#l92.708"></a><span id="l92.708">         let resourceType = kDavResourceTypeNone;</span>
<a href="#l92.709"></a><span id="l92.709">         let self = this;</span>
<a href="#l92.710"></a><span id="l92.710"> </span>
<a href="#l92.711"></a><span id="l92.711">         let queryXml =</span>
<a href="#l92.712"></a><span id="l92.712">             xmlHeader +</span>
<a href="#l92.713"></a><span id="l92.713">             '&lt;D:propfind xmlns:D=&quot;DAV:&quot; xmlns:CS=&quot;http://calendarserver.org/ns/&quot; xmlns:C=&quot;urn:ietf:params:xml:ns:caldav&quot;&gt;' +</span>
<a href="#l92.714"></a><span id="l92.714" class="difflineat">@@ -1695,18 +1693,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.715"></a><span id="l92.715">               &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l92.716"></a><span id="l92.716">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l92.717"></a><span id="l92.717"> </span>
<a href="#l92.718"></a><span id="l92.718">         if (this.verboseLogging()) {</span>
<a href="#l92.719"></a><span id="l92.719">             cal.LOG(&quot;CalDAV: send: &quot; + queryXml);</span>
<a href="#l92.720"></a><span id="l92.720">         }</span>
<a href="#l92.721"></a><span id="l92.721">         let streamListener = {};</span>
<a href="#l92.722"></a><span id="l92.722"> </span>
<a href="#l92.723"></a><span id="l92.723" class="difflineminus">-        streamListener.onStreamComplete =</span>
<a href="#l92.724"></a><span id="l92.724" class="difflineminus">-            function checkDavResourceType_oSC(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.725"></a><span id="l92.725" class="difflineplus">+        streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.726"></a><span id="l92.726">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.727"></a><span id="l92.727">             try {</span>
<a href="#l92.728"></a><span id="l92.728">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l92.729"></a><span id="l92.729">                         &quot; on initial PROPFIND for calendar &quot; + self.name);</span>
<a href="#l92.730"></a><span id="l92.730">             } catch (ex) {</span>
<a href="#l92.731"></a><span id="l92.731">                 cal.LOG(&quot;CalDAV: Error without status on initial PROPFIND for calendar &quot; +</span>
<a href="#l92.732"></a><span id="l92.732">                         self.name);</span>
<a href="#l92.733"></a><span id="l92.733">                 self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l92.734"></a><span id="l92.734" class="difflineat">@@ -1918,28 +1915,26 @@ calDavCalendar.prototype = {</span>
<a href="#l92.735"></a><span id="l92.735">      *</span>
<a href="#l92.736"></a><span id="l92.736">      * setupAuthentication</span>
<a href="#l92.737"></a><span id="l92.737">      * checkDavResourceType</span>
<a href="#l92.738"></a><span id="l92.738">      * checkServerCaps                              * You are here</span>
<a href="#l92.739"></a><span id="l92.739">      * findPrincipalNS</span>
<a href="#l92.740"></a><span id="l92.740">      * checkPrincipalsNameSpace</span>
<a href="#l92.741"></a><span id="l92.741">      * completeCheckServerInfo</span>
<a href="#l92.742"></a><span id="l92.742">      */</span>
<a href="#l92.743"></a><span id="l92.743" class="difflineminus">-    checkServerCaps: function caldav_checkServerCaps(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l92.744"></a><span id="l92.744" class="difflineplus">+    checkServerCaps: function(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l92.745"></a><span id="l92.745">         let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l92.746"></a><span id="l92.746">         let self = this;</span>
<a href="#l92.747"></a><span id="l92.747"> </span>
<a href="#l92.748"></a><span id="l92.748">         if (this.verboseLogging()) {</span>
<a href="#l92.749"></a><span id="l92.749">             cal.LOG(&quot;CalDAV: send: OPTIONS &quot; + homeSet.spec);</span>
<a href="#l92.750"></a><span id="l92.750">         }</span>
<a href="#l92.751"></a><span id="l92.751"> </span>
<a href="#l92.752"></a><span id="l92.752">         let streamListener = {};</span>
<a href="#l92.753"></a><span id="l92.753" class="difflineminus">-        streamListener.onStreamComplete =</span>
<a href="#l92.754"></a><span id="l92.754" class="difflineminus">-            function checkServerCaps_oSC(aLoader, aContext, aStatus,</span>
<a href="#l92.755"></a><span id="l92.755" class="difflineminus">-                                         aResultLength, aResult) {</span>
<a href="#l92.756"></a><span id="l92.756" class="difflineplus">+        streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.757"></a><span id="l92.757">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.758"></a><span id="l92.758">             if (request.responseStatus != 200) {</span>
<a href="#l92.759"></a><span id="l92.759">                 if (!calHomeSetUrlRetry &amp;&amp; request.responseStatus == 404) {</span>
<a href="#l92.760"></a><span id="l92.760">                     // try again with calendar URL, see https://bugzilla.mozilla.org/show_bug.cgi?id=588799</span>
<a href="#l92.761"></a><span id="l92.761">                     cal.LOG(&quot;CalDAV: Calendar homeset was not found at parent url of calendar URL&quot; +</span>
<a href="#l92.762"></a><span id="l92.762">                             &quot; while querying options &quot; + self.name + &quot;, will try calendar URL itself now&quot;);</span>
<a href="#l92.763"></a><span id="l92.763">                     self.setCalHomeSet(false);</span>
<a href="#l92.764"></a><span id="l92.764">                     self.checkServerCaps(aChangeLogListener, true);</span>
<a href="#l92.765"></a><span id="l92.765" class="difflineat">@@ -2020,17 +2015,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.766"></a><span id="l92.766">      *</span>
<a href="#l92.767"></a><span id="l92.767">      * setupAuthentication</span>
<a href="#l92.768"></a><span id="l92.768">      * checkDavResourceType</span>
<a href="#l92.769"></a><span id="l92.769">      * checkServerCaps</span>
<a href="#l92.770"></a><span id="l92.770">      * findPrincipalNS                              * You are here</span>
<a href="#l92.771"></a><span id="l92.771">      * checkPrincipalsNameSpace</span>
<a href="#l92.772"></a><span id="l92.772">      * completeCheckServerInfo</span>
<a href="#l92.773"></a><span id="l92.773">      */</span>
<a href="#l92.774"></a><span id="l92.774" class="difflineminus">-    findPrincipalNS: function caldav_findPrincipalNS(aChangeLogListener) {</span>
<a href="#l92.775"></a><span id="l92.775" class="difflineplus">+    findPrincipalNS: function(aChangeLogListener) {</span>
<a href="#l92.776"></a><span id="l92.776">         if (this.principalUrl) {</span>
<a href="#l92.777"></a><span id="l92.777">             // We already have a principal namespace, use it.</span>
<a href="#l92.778"></a><span id="l92.778">             this.checkPrincipalsNameSpace([this.principalUrl],</span>
<a href="#l92.779"></a><span id="l92.779">                                           aChangeLogListener);</span>
<a href="#l92.780"></a><span id="l92.780">             return;</span>
<a href="#l92.781"></a><span id="l92.781">         }</span>
<a href="#l92.782"></a><span id="l92.782"> </span>
<a href="#l92.783"></a><span id="l92.783">         let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l92.784"></a><span id="l92.784" class="difflineat">@@ -2043,19 +2038,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.785"></a><span id="l92.785">                 &quot;&lt;D:principal-collection-set/&gt;&quot; +</span>
<a href="#l92.786"></a><span id="l92.786">               &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l92.787"></a><span id="l92.787">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l92.788"></a><span id="l92.788"> </span>
<a href="#l92.789"></a><span id="l92.789">         if (this.verboseLogging()) {</span>
<a href="#l92.790"></a><span id="l92.790">             cal.LOG(&quot;CalDAV: send: &quot; + homeSet.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l92.791"></a><span id="l92.791">         }</span>
<a href="#l92.792"></a><span id="l92.792">         let streamListener = {};</span>
<a href="#l92.793"></a><span id="l92.793" class="difflineminus">-        streamListener.onStreamComplete =</span>
<a href="#l92.794"></a><span id="l92.794" class="difflineminus">-            function findInOutboxes_oSC(aLoader, aContext, aStatus,</span>
<a href="#l92.795"></a><span id="l92.795" class="difflineminus">-                                         aResultLength, aResult) {</span>
<a href="#l92.796"></a><span id="l92.796" class="difflineplus">+        streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.797"></a><span id="l92.797">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.798"></a><span id="l92.798">             if (request.responseStatus != 207) {</span>
<a href="#l92.799"></a><span id="l92.799">                 cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l92.800"></a><span id="l92.800">                     &quot; while querying principal namespace for &quot; + self.name);</span>
<a href="#l92.801"></a><span id="l92.801">                 self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l92.802"></a><span id="l92.802">                                              Components.results.NS_ERROR_FAILURE);</span>
<a href="#l92.803"></a><span id="l92.803">                 return;</span>
<a href="#l92.804"></a><span id="l92.804">             }</span>
<a href="#l92.805"></a><span id="l92.805" class="difflineat">@@ -2106,17 +2099,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.806"></a><span id="l92.806">      * checkDavResourceType</span>
<a href="#l92.807"></a><span id="l92.807">      * checkServerCaps</span>
<a href="#l92.808"></a><span id="l92.808">      * findPrincipalNS</span>
<a href="#l92.809"></a><span id="l92.809">      * checkPrincipalsNameSpace                     * You are here</span>
<a href="#l92.810"></a><span id="l92.810">      * completeCheckServerInfo</span>
<a href="#l92.811"></a><span id="l92.811">      *</span>
<a href="#l92.812"></a><span id="l92.812">      * @param aNameSpaceList    List of available namespaces</span>
<a href="#l92.813"></a><span id="l92.813">      */</span>
<a href="#l92.814"></a><span id="l92.814" class="difflineminus">-    checkPrincipalsNameSpace: function caldav_checkPrincipalsNameSpace(aNameSpaceList, aChangeLogListener) {</span>
<a href="#l92.815"></a><span id="l92.815" class="difflineplus">+    checkPrincipalsNameSpace: function(aNameSpaceList, aChangeLogListener) {</span>
<a href="#l92.816"></a><span id="l92.816">         let self = this;</span>
<a href="#l92.817"></a><span id="l92.817">         let doesntSupportScheduling = () =&gt; {</span>
<a href="#l92.818"></a><span id="l92.818">             this.hasScheduling = false;</span>
<a href="#l92.819"></a><span id="l92.819">             this.mInboxUrl = null;</span>
<a href="#l92.820"></a><span id="l92.820">             this.mOutboxUrl = null;</span>
<a href="#l92.821"></a><span id="l92.821">             this.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l92.822"></a><span id="l92.822">         };</span>
<a href="#l92.823"></a><span id="l92.823"> </span>
<a href="#l92.824"></a><span id="l92.824" class="difflineat">@@ -2170,19 +2163,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.825"></a><span id="l92.825">         let nextNS = aNameSpaceList.pop().replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l92.826"></a><span id="l92.826">         let requestUri = makeURL(this.calendarUri.prePath + this.ensureEncodedPath(nextNS));</span>
<a href="#l92.827"></a><span id="l92.827"> </span>
<a href="#l92.828"></a><span id="l92.828">         if (this.verboseLogging()) {</span>
<a href="#l92.829"></a><span id="l92.829">             cal.LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + requestUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l92.830"></a><span id="l92.830">         }</span>
<a href="#l92.831"></a><span id="l92.831"> </span>
<a href="#l92.832"></a><span id="l92.832">         let streamListener = {};</span>
<a href="#l92.833"></a><span id="l92.833" class="difflineminus">-        streamListener.onStreamComplete =</span>
<a href="#l92.834"></a><span id="l92.834" class="difflineminus">-            function caldav_cPNS_oSC(aLoader, aContext, aStatus,</span>
<a href="#l92.835"></a><span id="l92.835" class="difflineminus">-                                         aResultLength, aResult) {</span>
<a href="#l92.836"></a><span id="l92.836" class="difflineplus">+        streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.837"></a><span id="l92.837">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.838"></a><span id="l92.838">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l92.839"></a><span id="l92.839">             if (!str) {</span>
<a href="#l92.840"></a><span id="l92.840">                 cal.LOG(&quot;CalDAV: Failed to report principals namespace for &quot; + self.name);</span>
<a href="#l92.841"></a><span id="l92.841">                 doesntSupportScheduling();</span>
<a href="#l92.842"></a><span id="l92.842">                 return;</span>
<a href="#l92.843"></a><span id="l92.843">             } else if (self.verboseLogging()) {</span>
<a href="#l92.844"></a><span id="l92.844">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l92.845"></a><span id="l92.845" class="difflineat">@@ -2293,17 +2284,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.846"></a><span id="l92.846">      *</span>
<a href="#l92.847"></a><span id="l92.847">      * setupAuthentication</span>
<a href="#l92.848"></a><span id="l92.848">      * checkDavResourceType</span>
<a href="#l92.849"></a><span id="l92.849">      * checkServerCaps</span>
<a href="#l92.850"></a><span id="l92.850">      * findPrincipalNS</span>
<a href="#l92.851"></a><span id="l92.851">      * checkPrincipalsNameSpace</span>
<a href="#l92.852"></a><span id="l92.852">      * completeCheckServerInfo                      * You are here</span>
<a href="#l92.853"></a><span id="l92.853">      */</span>
<a href="#l92.854"></a><span id="l92.854" class="difflineminus">-    completeCheckServerInfo: function caldav_completeCheckServerInfo(aChangeLogListener, aError) {</span>
<a href="#l92.855"></a><span id="l92.855" class="difflineplus">+    completeCheckServerInfo: function(aChangeLogListener, aError) {</span>
<a href="#l92.856"></a><span id="l92.856">         if (Components.isSuccessCode(aError)) {</span>
<a href="#l92.857"></a><span id="l92.857">             // &quot;undefined&quot; is a successcode, so all is good</span>
<a href="#l92.858"></a><span id="l92.858">             this.saveCalendarProperties();</span>
<a href="#l92.859"></a><span id="l92.859">             this.checkedServerInfo = true;</span>
<a href="#l92.860"></a><span id="l92.860">             this.setProperty(&quot;currentStatus&quot;, Components.results.NS_OK);</span>
<a href="#l92.861"></a><span id="l92.861"> </span>
<a href="#l92.862"></a><span id="l92.862">             if (this.isCached) {</span>
<a href="#l92.863"></a><span id="l92.863">                 this.safeRefresh(aChangeLogListener);</span>
<a href="#l92.864"></a><span id="l92.864" class="difflineat">@@ -2318,17 +2309,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.865"></a><span id="l92.865">             }</span>
<a href="#l92.866"></a><span id="l92.866">         }</span>
<a href="#l92.867"></a><span id="l92.867">     },</span>
<a href="#l92.868"></a><span id="l92.868"> </span>
<a href="#l92.869"></a><span id="l92.869">     /**</span>
<a href="#l92.870"></a><span id="l92.870">      * Called to report a certain DAV error. Strings and modification type are</span>
<a href="#l92.871"></a><span id="l92.871">      * handled here.</span>
<a href="#l92.872"></a><span id="l92.872">      */</span>
<a href="#l92.873"></a><span id="l92.873" class="difflineminus">-    reportDavError: function caldav_reportDavError(aErrNo, status, extraInfo) {</span>
<a href="#l92.874"></a><span id="l92.874" class="difflineplus">+    reportDavError: function(aErrNo, status, extraInfo) {</span>
<a href="#l92.875"></a><span id="l92.875">         let mapError = {};</span>
<a href="#l92.876"></a><span id="l92.876">         mapError[Components.interfaces.calIErrors.DAV_NOT_DAV] = &quot;dav_notDav&quot;;</span>
<a href="#l92.877"></a><span id="l92.877">         mapError[Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV] = &quot;dav_davNotCaldav&quot;;</span>
<a href="#l92.878"></a><span id="l92.878">         mapError[Components.interfaces.calIErrors.DAV_PUT_ERROR] = &quot;itemPutError&quot;;</span>
<a href="#l92.879"></a><span id="l92.879">         mapError[Components.interfaces.calIErrors.DAV_REMOVE_ERROR] = &quot;itemDeleteError&quot;;</span>
<a href="#l92.880"></a><span id="l92.880">         mapError[Components.interfaces.calIErrors.DAV_REPORT_ERROR] = &quot;disabledMode&quot;;</span>
<a href="#l92.881"></a><span id="l92.881"> </span>
<a href="#l92.882"></a><span id="l92.882">         let mapModification = {};</span>
<a href="#l92.883"></a><span id="l92.883" class="difflineat">@@ -2351,17 +2342,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.884"></a><span id="l92.884">         this.mDisabled = true;</span>
<a href="#l92.885"></a><span id="l92.885">         this.notifyError(aErrNo, localizedMessage);</span>
<a href="#l92.886"></a><span id="l92.886">         this.notifyError(modificationError</span>
<a href="#l92.887"></a><span id="l92.887">                          ? Components.interfaces.calIErrors.MODIFICATION_FAILED</span>
<a href="#l92.888"></a><span id="l92.888">                          : Components.interfaces.calIErrors.READ_FAILED,</span>
<a href="#l92.889"></a><span id="l92.889">                          this.buildDetailedMessage(status, extraInfo));</span>
<a href="#l92.890"></a><span id="l92.890">     },</span>
<a href="#l92.891"></a><span id="l92.891"> </span>
<a href="#l92.892"></a><span id="l92.892" class="difflineminus">-    buildDetailedMessage: function caldav_buildDetailedMessage(status, extraInfo) {</span>
<a href="#l92.893"></a><span id="l92.893" class="difflineplus">+    buildDetailedMessage: function(status, extraInfo) {</span>
<a href="#l92.894"></a><span id="l92.894">         if (!status) {</span>
<a href="#l92.895"></a><span id="l92.895">             return &quot;&quot;;</span>
<a href="#l92.896"></a><span id="l92.896">         }</span>
<a href="#l92.897"></a><span id="l92.897"> </span>
<a href="#l92.898"></a><span id="l92.898">         let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l92.899"></a><span id="l92.899">         let statusString;</span>
<a href="#l92.900"></a><span id="l92.900">         try {</span>
<a href="#l92.901"></a><span id="l92.901">             statusString = props.GetStringFromName(&quot;caldavRequestStatusCodeString&quot; + status);</span>
<a href="#l92.902"></a><span id="l92.902" class="difflineat">@@ -2373,18 +2364,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.903"></a><span id="l92.903">                statusString + &quot;\n\n&quot; +</span>
<a href="#l92.904"></a><span id="l92.904">                (extraInfo ? extraInfo : &quot;&quot;);</span>
<a href="#l92.905"></a><span id="l92.905">     },</span>
<a href="#l92.906"></a><span id="l92.906"> </span>
<a href="#l92.907"></a><span id="l92.907">     //</span>
<a href="#l92.908"></a><span id="l92.908">     // calIFreeBusyProvider interface</span>
<a href="#l92.909"></a><span id="l92.909">     //</span>
<a href="#l92.910"></a><span id="l92.910"> </span>
<a href="#l92.911"></a><span id="l92.911" class="difflineminus">-    getFreeBusyIntervals: function caldav_getFreeBusyIntervals(</span>
<a href="#l92.912"></a><span id="l92.912" class="difflineminus">-                             aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l92.913"></a><span id="l92.913" class="difflineplus">+    getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l92.914"></a><span id="l92.914">         // We explicitly don't check for hasScheduling here to allow free-busy queries</span>
<a href="#l92.915"></a><span id="l92.915">         // even in case sched is turned off.</span>
<a href="#l92.916"></a><span id="l92.916">         if (!this.outboxUrl || !this.calendarUserAddress) {</span>
<a href="#l92.917"></a><span id="l92.917">             cal.LOG(&quot;CalDAV: Calendar &quot; + this.name + &quot; doen't support scheduling;&quot; +</span>
<a href="#l92.918"></a><span id="l92.918">                     &quot; freebusy query not possible&quot;);</span>
<a href="#l92.919"></a><span id="l92.919">             aListener.onResult(null, null);</span>
<a href="#l92.920"></a><span id="l92.920">             return;</span>
<a href="#l92.921"></a><span id="l92.921">         }</span>
<a href="#l92.922"></a><span id="l92.922" class="difflineat">@@ -2443,19 +2433,18 @@ calDavCalendar.prototype = {</span>
<a href="#l92.923"></a><span id="l92.923">         fbQuery = fbQuery.serializeToICS();</span>
<a href="#l92.924"></a><span id="l92.924">         if (this.verboseLogging()) {</span>
<a href="#l92.925"></a><span id="l92.925">             cal.LOG(&quot;CalDAV: send (Originator=&quot; + organizer +</span>
<a href="#l92.926"></a><span id="l92.926">                     &quot;,Recipient=&quot; + mailto_aCalId + &quot;): &quot; + fbQuery);</span>
<a href="#l92.927"></a><span id="l92.927">         }</span>
<a href="#l92.928"></a><span id="l92.928"> </span>
<a href="#l92.929"></a><span id="l92.929">         let streamListener = {};</span>
<a href="#l92.930"></a><span id="l92.930"> </span>
<a href="#l92.931"></a><span id="l92.931" class="difflineminus">-        streamListener.onStreamComplete =</span>
<a href="#l92.932"></a><span id="l92.932" class="difflineminus">-            function caldav_GFBI_oSC(aLoader, aContext, aStatus,</span>
<a href="#l92.933"></a><span id="l92.933" class="difflineminus">-                                         aResultLength, aResult) {</span>
<a href="#l92.934"></a><span id="l92.934" class="difflineplus">+        streamListener.onStreamComplete = function(aLoader, aContext, aStatus,</span>
<a href="#l92.935"></a><span id="l92.935" class="difflineplus">+                                                   aResultLength, aResult) {</span>
<a href="#l92.936"></a><span id="l92.936">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.937"></a><span id="l92.937">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l92.938"></a><span id="l92.938">             if (!str) {</span>
<a href="#l92.939"></a><span id="l92.939">                 cal.LOG(&quot;CalDAV: Failed to parse freebusy response from &quot; + self.name);</span>
<a href="#l92.940"></a><span id="l92.940">             } else if (self.verboseLogging()) {</span>
<a href="#l92.941"></a><span id="l92.941">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l92.942"></a><span id="l92.942">             }</span>
<a href="#l92.943"></a><span id="l92.943"> </span>
<a href="#l92.944"></a><span id="l92.944" class="difflineat">@@ -2558,17 +2547,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.945"></a><span id="l92.945">                            &quot;Error preparing http channel&quot;);</span>
<a href="#l92.946"></a><span id="l92.946">         });</span>
<a href="#l92.947"></a><span id="l92.947">     },</span>
<a href="#l92.948"></a><span id="l92.948"> </span>
<a href="#l92.949"></a><span id="l92.949">     /**</span>
<a href="#l92.950"></a><span id="l92.950">      * Extract the path from the full spec, if the regexp failed, log</span>
<a href="#l92.951"></a><span id="l92.951">      * warning and return unaltered path.</span>
<a href="#l92.952"></a><span id="l92.952">      */</span>
<a href="#l92.953"></a><span id="l92.953" class="difflineminus">-    extractPathFromSpec: function caldav_extractPathFromSpec(aSpec) {</span>
<a href="#l92.954"></a><span id="l92.954" class="difflineplus">+    extractPathFromSpec: function(aSpec) {</span>
<a href="#l92.955"></a><span id="l92.955">         // The parsed array should look like this:</span>
<a href="#l92.956"></a><span id="l92.956">         // a[0] = full string</span>
<a href="#l92.957"></a><span id="l92.957">         // a[1] = scheme</span>
<a href="#l92.958"></a><span id="l92.958">         // a[2] = everything between the scheme and the start of the path</span>
<a href="#l92.959"></a><span id="l92.959">         // a[3] = extracted path</span>
<a href="#l92.960"></a><span id="l92.960">         let a = aSpec.match(&quot;(https?)(://[^/]*)([^#?]*)&quot;);</span>
<a href="#l92.961"></a><span id="l92.961">         if (a &amp;&amp; a[3]) {</span>
<a href="#l92.962"></a><span id="l92.962">           return a[3];</span>
<a href="#l92.963"></a><span id="l92.963" class="difflineat">@@ -2577,92 +2566,83 @@ calDavCalendar.prototype = {</span>
<a href="#l92.964"></a><span id="l92.964">         return aSpec;</span>
<a href="#l92.965"></a><span id="l92.965">     },</span>
<a href="#l92.966"></a><span id="l92.966">     /**</span>
<a href="#l92.967"></a><span id="l92.967">      * This is called to create an encoded path from a unencoded path OR</span>
<a href="#l92.968"></a><span id="l92.968">      * encoded full url</span>
<a href="#l92.969"></a><span id="l92.969">      *</span>
<a href="#l92.970"></a><span id="l92.970">      * @param aString {string} un-encoded path OR encoded uri spec.</span>
<a href="#l92.971"></a><span id="l92.971">      */</span>
<a href="#l92.972"></a><span id="l92.972" class="difflineminus">-    ensureEncodedPath: function caldav_ensureEncodedPath(aString) {</span>
<a href="#l92.973"></a><span id="l92.973" class="difflineplus">+    ensureEncodedPath: function(aString) {</span>
<a href="#l92.974"></a><span id="l92.974">         if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l92.975"></a><span id="l92.975">             aString = this.ensureDecodedPath(aString);</span>
<a href="#l92.976"></a><span id="l92.976">         }</span>
<a href="#l92.977"></a><span id="l92.977">         let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l92.978"></a><span id="l92.978">         uriComponents = uriComponents.map(encodeURIComponent);</span>
<a href="#l92.979"></a><span id="l92.979">         return uriComponents.join(&quot;/&quot;);</span>
<a href="#l92.980"></a><span id="l92.980">     },</span>
<a href="#l92.981"></a><span id="l92.981"> </span>
<a href="#l92.982"></a><span id="l92.982">     /**</span>
<a href="#l92.983"></a><span id="l92.983">      * This is called to get a decoded path from an encoded path or uri spec.</span>
<a href="#l92.984"></a><span id="l92.984">      *</span>
<a href="#l92.985"></a><span id="l92.985">      * @param aString {string} Represents either a path</span>
<a href="#l92.986"></a><span id="l92.986">      * or a full uri that needs to be decoded.</span>
<a href="#l92.987"></a><span id="l92.987">      */</span>
<a href="#l92.988"></a><span id="l92.988" class="difflineminus">-    ensureDecodedPath: function caldav_ensureDecodedPath(aString) {</span>
<a href="#l92.989"></a><span id="l92.989" class="difflineplus">+    ensureDecodedPath: function(aString) {</span>
<a href="#l92.990"></a><span id="l92.990">         if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l92.991"></a><span id="l92.991">             aString = this.extractPathFromSpec(aString);</span>
<a href="#l92.992"></a><span id="l92.992">         }</span>
<a href="#l92.993"></a><span id="l92.993"> </span>
<a href="#l92.994"></a><span id="l92.994">         let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l92.995"></a><span id="l92.995">         for (let i = 0; i &lt; uriComponents.length; i++) {</span>
<a href="#l92.996"></a><span id="l92.996">             try {</span>
<a href="#l92.997"></a><span id="l92.997">                 uriComponents[i] = decodeURIComponent(uriComponents[i]);</span>
<a href="#l92.998"></a><span id="l92.998">             } catch (e) {</span>
<a href="#l92.999"></a><span id="l92.999">                 cal.WARN(&quot;CalDAV: Exception decoding path &quot; + aString + &quot;, segment: &quot; + uriComponents[i]);</span>
<a href="#l92.1000"></a><span id="l92.1000">             }</span>
<a href="#l92.1001"></a><span id="l92.1001">         }</span>
<a href="#l92.1002"></a><span id="l92.1002">         return uriComponents.join(&quot;/&quot;);</span>
<a href="#l92.1003"></a><span id="l92.1003">     },</span>
<a href="#l92.1004"></a><span id="l92.1004" class="difflineminus">-    isInbox: function caldav_isInbox(aString) {</span>
<a href="#l92.1005"></a><span id="l92.1005" class="difflineplus">+    isInbox: function(aString) {</span>
<a href="#l92.1006"></a><span id="l92.1006">         // Note: If you change this, make sure it really returns a boolean</span>
<a href="#l92.1007"></a><span id="l92.1007">         // value and not null!</span>
<a href="#l92.1008"></a><span id="l92.1008">         return (this.hasScheduling || this.hasAutoScheduling) &amp;&amp;</span>
<a href="#l92.1009"></a><span id="l92.1009">                this.mInboxUrl != null &amp;&amp;</span>
<a href="#l92.1010"></a><span id="l92.1010">                aString.startsWith(this.mInboxUrl.spec);</span>
<a href="#l92.1011"></a><span id="l92.1011">     },</span>
<a href="#l92.1012"></a><span id="l92.1012"> </span>
<a href="#l92.1013"></a><span id="l92.1013">     /**</span>
<a href="#l92.1014"></a><span id="l92.1014">      * Query contents of scheduling inbox</span>
<a href="#l92.1015"></a><span id="l92.1015">      *</span>
<a href="#l92.1016"></a><span id="l92.1016">      */</span>
<a href="#l92.1017"></a><span id="l92.1017" class="difflineminus">-    pollInbox: function caldav_pollInbox() {</span>
<a href="#l92.1018"></a><span id="l92.1018" class="difflineplus">+    pollInbox: function() {</span>
<a href="#l92.1019"></a><span id="l92.1019">         // If polling the inbox was switched off, no need to poll the inbox.</span>
<a href="#l92.1020"></a><span id="l92.1020">         // Also, if we have more than one calendar in this CalDAV account, we</span>
<a href="#l92.1021"></a><span id="l92.1021">         // want only one of them to be checking the inbox.</span>
<a href="#l92.1022"></a><span id="l92.1022">         if ((!this.hasScheduling &amp;&amp; !this.hasAutoScheduling) || !this.mShouldPollInbox || !this.firstInRealm()) {</span>
<a href="#l92.1023"></a><span id="l92.1023">             return;</span>
<a href="#l92.1024"></a><span id="l92.1024">         }</span>
<a href="#l92.1025"></a><span id="l92.1025"> </span>
<a href="#l92.1026"></a><span id="l92.1026">         this.getUpdatedItems(this.mInboxUrl, null);</span>
<a href="#l92.1027"></a><span id="l92.1027">     },</span>
<a href="#l92.1028"></a><span id="l92.1028"> </span>
<a href="#l92.1029"></a><span id="l92.1029">     //</span>
<a href="#l92.1030"></a><span id="l92.1030">     // take calISchedulingSupport interface base implementation (cal.ProviderBase)</span>
<a href="#l92.1031"></a><span id="l92.1031">     //</span>
<a href="#l92.1032"></a><span id="l92.1032"> </span>
<a href="#l92.1033"></a><span id="l92.1033" class="difflineminus">-    processItipReply: function caldav_processItipReply(aItem, aPath) {</span>
<a href="#l92.1034"></a><span id="l92.1034" class="difflineplus">+    processItipReply: function(aItem, aPath) {</span>
<a href="#l92.1035"></a><span id="l92.1035">         // modify partstat for in-calendar item</span>
<a href="#l92.1036"></a><span id="l92.1036">         // delete item from inbox</span>
<a href="#l92.1037"></a><span id="l92.1037">         let self = this;</span>
<a href="#l92.1038"></a><span id="l92.1038"> </span>
<a href="#l92.1039"></a><span id="l92.1039">         let getItemListener = {};</span>
<a href="#l92.1040"></a><span id="l92.1040">         getItemListener.QueryInterface = XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]);</span>
<a href="#l92.1041"></a><span id="l92.1041" class="difflineminus">-        getItemListener.onOperationComplete = function caldav_gUIs_oOC(aCalendar,</span>
<a href="#l92.1042"></a><span id="l92.1042" class="difflineminus">-                                                                       aStatus,</span>
<a href="#l92.1043"></a><span id="l92.1043" class="difflineminus">-                                                                       aOperationType,</span>
<a href="#l92.1044"></a><span id="l92.1044" class="difflineminus">-                                                                       aId,</span>
<a href="#l92.1045"></a><span id="l92.1045" class="difflineminus">-                                                                       aDetail) {</span>
<a href="#l92.1046"></a><span id="l92.1046" class="difflineplus">+        getItemListener.onOperationComplete = function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l92.1047"></a><span id="l92.1047">         };</span>
<a href="#l92.1048"></a><span id="l92.1048" class="difflineminus">-        getItemListener.onGetResult = function caldav_pIR_oGR(aCalendar,</span>
<a href="#l92.1049"></a><span id="l92.1049" class="difflineminus">-                                                              aStatus,</span>
<a href="#l92.1050"></a><span id="l92.1050" class="difflineminus">-                                                              aItemType,</span>
<a href="#l92.1051"></a><span id="l92.1051" class="difflineminus">-                                                              aDetail,</span>
<a href="#l92.1052"></a><span id="l92.1052" class="difflineminus">-                                                              aCount,</span>
<a href="#l92.1053"></a><span id="l92.1053" class="difflineminus">-                                                              aItems) {</span>
<a href="#l92.1054"></a><span id="l92.1054" class="difflineplus">+        getItemListener.onGetResult = function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l92.1055"></a><span id="l92.1055">             let itemToUpdate = aItems[0];</span>
<a href="#l92.1056"></a><span id="l92.1056">             if (aItem.recurrenceId &amp;&amp; itemToUpdate.recurrenceInfo) {</span>
<a href="#l92.1057"></a><span id="l92.1057">                 itemToUpdate = itemToUpdate.recurrenceInfo.getOccurrenceFor(aItem.recurrenceId);</span>
<a href="#l92.1058"></a><span id="l92.1058">             }</span>
<a href="#l92.1059"></a><span id="l92.1059">             let newItem = itemToUpdate.clone();</span>
<a href="#l92.1060"></a><span id="l92.1060"> </span>
<a href="#l92.1061"></a><span id="l92.1061">             for (let attendee of aItem.getAttendees({})) {</span>
<a href="#l92.1062"></a><span id="l92.1062">                 let att = newItem.getAttendeeById(attendee.id);</span>
<a href="#l92.1063"></a><span id="l92.1063" class="difflineat">@@ -2674,36 +2654,32 @@ calDavCalendar.prototype = {</span>
<a href="#l92.1064"></a><span id="l92.1064">                 }</span>
<a href="#l92.1065"></a><span id="l92.1065">             }</span>
<a href="#l92.1066"></a><span id="l92.1066">             self.doModifyItem(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l92.1067"></a><span id="l92.1067">                               modListener, true);</span>
<a href="#l92.1068"></a><span id="l92.1068">         };</span>
<a href="#l92.1069"></a><span id="l92.1069"> </span>
<a href="#l92.1070"></a><span id="l92.1070">         let modListener = {};</span>
<a href="#l92.1071"></a><span id="l92.1071">         modListener.QueryInterface = XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]);</span>
<a href="#l92.1072"></a><span id="l92.1072" class="difflineminus">-        modListener.onOperationComplete = function caldav_pIR_moOC(aCalendar,</span>
<a href="#l92.1073"></a><span id="l92.1073" class="difflineminus">-                                                                   aStatus,</span>
<a href="#l92.1074"></a><span id="l92.1074" class="difflineminus">-                                                                   aOperationType,</span>
<a href="#l92.1075"></a><span id="l92.1075" class="difflineminus">-                                                                   aItemId,</span>
<a href="#l92.1076"></a><span id="l92.1076" class="difflineminus">-                                                                   aDetail) {</span>
<a href="#l92.1077"></a><span id="l92.1077" class="difflineplus">+        modListener.onOperationComplete = function(aCalendar, aStatus, aOperationType, aItemId, aDetail) {</span>
<a href="#l92.1078"></a><span id="l92.1078">             cal.LOG(&quot;CalDAV: status &quot; + aStatus + &quot; while processing iTIP REPLY &quot; +</span>
<a href="#l92.1079"></a><span id="l92.1079">                     &quot; for &quot; + self.name);</span>
<a href="#l92.1080"></a><span id="l92.1080">             // don't delete the REPLY item from inbox unless modifying the master</span>
<a href="#l92.1081"></a><span id="l92.1081">             // item was successful</span>
<a href="#l92.1082"></a><span id="l92.1082">             if (aStatus == 0) { // aStatus undocumented; 0 seems to indicate no error</span>
<a href="#l92.1083"></a><span id="l92.1083">                 let delUri = self.calendarUri.clone();</span>
<a href="#l92.1084"></a><span id="l92.1084">                 delUri.path = self.ensureEncodedPath(aPath);</span>
<a href="#l92.1085"></a><span id="l92.1085">                 self.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l92.1086"></a><span id="l92.1086">             }</span>
<a href="#l92.1087"></a><span id="l92.1087">         };</span>
<a href="#l92.1088"></a><span id="l92.1088"> </span>
<a href="#l92.1089"></a><span id="l92.1089">         this.mOfflineStorage.getItem(aItem.id, getItemListener);</span>
<a href="#l92.1090"></a><span id="l92.1090">     },</span>
<a href="#l92.1091"></a><span id="l92.1091"> </span>
<a href="#l92.1092"></a><span id="l92.1092" class="difflineminus">-    canNotify: function caldav_canNotify(aMethod, aItem) {</span>
<a href="#l92.1093"></a><span id="l92.1093" class="difflineplus">+    canNotify: function(aMethod, aItem) {</span>
<a href="#l92.1094"></a><span id="l92.1094">         if (this.hasAutoScheduling) {</span>
<a href="#l92.1095"></a><span id="l92.1095">             // canNotify should return false if the schedule agent is client</span>
<a href="#l92.1096"></a><span id="l92.1096">             // so the itip transport(imip) takes care of notifying participants</span>
<a href="#l92.1097"></a><span id="l92.1097">             if (aItem.organizer &amp;&amp;</span>
<a href="#l92.1098"></a><span id="l92.1098">                 aItem.organizer.getProperty(&quot;SCHEDULE-AGENT&quot;) == &quot;CLIENT&quot;) {</span>
<a href="#l92.1099"></a><span id="l92.1099">                 return false;</span>
<a href="#l92.1100"></a><span id="l92.1100">             }</span>
<a href="#l92.1101"></a><span id="l92.1101">             return true;</span>
<a href="#l92.1102"></a><span id="l92.1102" class="difflineat">@@ -2722,17 +2698,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.1103"></a><span id="l92.1103">     mSenderAddress: null,</span>
<a href="#l92.1104"></a><span id="l92.1104">     get senderAddress() {</span>
<a href="#l92.1105"></a><span id="l92.1105">         return this.mSenderAddress || this.calendarUserAddress;</span>
<a href="#l92.1106"></a><span id="l92.1106">     },</span>
<a href="#l92.1107"></a><span id="l92.1107">     set senderAddress(aString) {</span>
<a href="#l92.1108"></a><span id="l92.1108">         return (this.mSenderAddress = aString);</span>
<a href="#l92.1109"></a><span id="l92.1109">     },</span>
<a href="#l92.1110"></a><span id="l92.1110"> </span>
<a href="#l92.1111"></a><span id="l92.1111" class="difflineminus">-    sendItems: function caldav_sendItems(aCount, aRecipients, aItipItem) {</span>
<a href="#l92.1112"></a><span id="l92.1112" class="difflineplus">+    sendItems: function(aCount, aRecipients, aItipItem) {</span>
<a href="#l92.1113"></a><span id="l92.1113">         if (this.hasAutoScheduling) {</span>
<a href="#l92.1114"></a><span id="l92.1114">             // If auto scheduling is supported by the server we still need</span>
<a href="#l92.1115"></a><span id="l92.1115">             // to send out REPLIES for meetings where the ORGANIZER has the</span>
<a href="#l92.1116"></a><span id="l92.1116">             // parameter SCHEDULE-AGENT set to CLIENT, this property is</span>
<a href="#l92.1117"></a><span id="l92.1117">             // checked in in canNotify()</span>
<a href="#l92.1118"></a><span id="l92.1118">             if (aItipItem.responseMethod == &quot;REPLY&quot;) {</span>
<a href="#l92.1119"></a><span id="l92.1119">                 let imipTransport = cal.getImipTransport(this);</span>
<a href="#l92.1120"></a><span id="l92.1120">                 if (imipTransport) {</span>
<a href="#l92.1121"></a><span id="l92.1121" class="difflineat">@@ -2763,18 +2739,17 @@ calDavCalendar.prototype = {</span>
<a href="#l92.1122"></a><span id="l92.1122">                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l92.1123"></a><span id="l92.1123">             serializer.addItems([item], 1);</span>
<a href="#l92.1124"></a><span id="l92.1124">             let methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l92.1125"></a><span id="l92.1125">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l92.1126"></a><span id="l92.1126">             serializer.addProperty(methodProp);</span>
<a href="#l92.1127"></a><span id="l92.1127"> </span>
<a href="#l92.1128"></a><span id="l92.1128">             let self = this;</span>
<a href="#l92.1129"></a><span id="l92.1129">             let streamListener = {</span>
<a href="#l92.1130"></a><span id="l92.1130" class="difflineminus">-                onStreamComplete: function caldav_sendItems_oSC(aLoader, aContext, aStatus,</span>
<a href="#l92.1131"></a><span id="l92.1131" class="difflineminus">-                                                                aResultLength, aResult) {</span>
<a href="#l92.1132"></a><span id="l92.1132" class="difflineplus">+                onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l92.1133"></a><span id="l92.1133">                     let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l92.1134"></a><span id="l92.1134">                     let status;</span>
<a href="#l92.1135"></a><span id="l92.1135">                     try {</span>
<a href="#l92.1136"></a><span id="l92.1136">                         status = request.responseStatus;</span>
<a href="#l92.1137"></a><span id="l92.1137">                     } catch (ex) {</span>
<a href="#l92.1138"></a><span id="l92.1138">                         status = Components.interfaces.calIErrors.DAV_POST_ERROR;</span>
<a href="#l92.1139"></a><span id="l92.1139">                         cal.LOG(&quot;CalDAV: no response status when sending iTIP for&quot; +</span>
<a href="#l92.1140"></a><span id="l92.1140">                                 self.name);</span>
<a href="#l92.1141"></a><span id="l92.1141" class="difflineat">@@ -2859,36 +2834,36 @@ calDavCalendar.prototype = {</span>
<a href="#l92.1142"></a><span id="l92.1142">                 notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l92.1143"></a><span id="l92.1143">                                &quot;Error preparing http channel&quot;);</span>
<a href="#l92.1144"></a><span id="l92.1144">             });</span>
<a href="#l92.1145"></a><span id="l92.1145">         }</span>
<a href="#l92.1146"></a><span id="l92.1146">         return true;</span>
<a href="#l92.1147"></a><span id="l92.1147">     },</span>
<a href="#l92.1148"></a><span id="l92.1148"> </span>
<a href="#l92.1149"></a><span id="l92.1149">     mVerboseLogging: undefined,</span>
<a href="#l92.1150"></a><span id="l92.1150" class="difflineminus">-    verboseLogging: function caldav_verboseLogging() {</span>
<a href="#l92.1151"></a><span id="l92.1151" class="difflineplus">+    verboseLogging: function() {</span>
<a href="#l92.1152"></a><span id="l92.1152">         if (this.mVerboseLogging === undefined) {</span>
<a href="#l92.1153"></a><span id="l92.1153">             this.mVerboseLogging = Preferences.get(&quot;calendar.debug.log.verbose&quot;, false);</span>
<a href="#l92.1154"></a><span id="l92.1154">         }</span>
<a href="#l92.1155"></a><span id="l92.1155">         return this.mVerboseLogging;</span>
<a href="#l92.1156"></a><span id="l92.1156">     },</span>
<a href="#l92.1157"></a><span id="l92.1157"> </span>
<a href="#l92.1158"></a><span id="l92.1158" class="difflineminus">-    getSerializedItem: function caldav_getSerializedItem(aItem) {</span>
<a href="#l92.1159"></a><span id="l92.1159" class="difflineplus">+    getSerializedItem: function(aItem) {</span>
<a href="#l92.1160"></a><span id="l92.1160">         let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l92.1161"></a><span id="l92.1161">                                    .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l92.1162"></a><span id="l92.1162">         serializer.addItems([aItem], 1);</span>
<a href="#l92.1163"></a><span id="l92.1163">         let serializedItem = serializer.serializeToString();</span>
<a href="#l92.1164"></a><span id="l92.1164">         if (this.verboseLogging()) {</span>
<a href="#l92.1165"></a><span id="l92.1165">             cal.LOG(&quot;CalDAV: send: &quot; + serializedItem);</span>
<a href="#l92.1166"></a><span id="l92.1166">         }</span>
<a href="#l92.1167"></a><span id="l92.1167">         return serializedItem;</span>
<a href="#l92.1168"></a><span id="l92.1168">     },</span>
<a href="#l92.1169"></a><span id="l92.1169"> </span>
<a href="#l92.1170"></a><span id="l92.1170">     // nsIChannelEventSink implementation</span>
<a href="#l92.1171"></a><span id="l92.1171" class="difflineminus">-    asyncOnChannelRedirect: function caldav_asyncOonChannelRedirect(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l92.1172"></a><span id="l92.1172" class="difflineplus">+    asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l92.1173"></a><span id="l92.1173">         let uploadData;</span>
<a href="#l92.1174"></a><span id="l92.1174">         let uploadContent;</span>
<a href="#l92.1175"></a><span id="l92.1175">         if (aOldChannel instanceof Components.interfaces.nsIUploadChannel &amp;&amp;</span>
<a href="#l92.1176"></a><span id="l92.1176">             aOldChannel instanceof Components.interfaces.nsIHttpChannel &amp;&amp;</span>
<a href="#l92.1177"></a><span id="l92.1177">             aOldChannel.uploadStream) {</span>
<a href="#l92.1178"></a><span id="l92.1178">             uploadData = aOldChannel.uploadStream;</span>
<a href="#l92.1179"></a><span id="l92.1179">             uploadContent = aOldChannel.getRequestHeader(&quot;Content-Type&quot;);</span>
<a href="#l92.1180"></a><span id="l92.1180">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -52,17 +52,17 @@ etagsHandler.prototype = {</span>
<a href="#l93.4"></a><span id="l93.4">         Components.interfaces.nsISAXErrorHandler,</span>
<a href="#l93.5"></a><span id="l93.5">         Components.interfaces.nsIRequestObserver,</span>
<a href="#l93.6"></a><span id="l93.6">         Components.interfaces.nsIStreamListener</span>
<a href="#l93.7"></a><span id="l93.7">     ]),</span>
<a href="#l93.8"></a><span id="l93.8"> </span>
<a href="#l93.9"></a><span id="l93.9">     /**</span>
<a href="#l93.10"></a><span id="l93.10">      * @see nsIStreamListener</span>
<a href="#l93.11"></a><span id="l93.11">      */</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-    onStartRequest: function eSL_onStartRequest(request, context) {</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+    onStartRequest: function(request, context) {</span>
<a href="#l93.14"></a><span id="l93.14">         let httpchannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l93.15"></a><span id="l93.15"> </span>
<a href="#l93.16"></a><span id="l93.16">         let responseStatus;</span>
<a href="#l93.17"></a><span id="l93.17">         try {</span>
<a href="#l93.18"></a><span id="l93.18">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l93.19"></a><span id="l93.19">         } catch (ex) {</span>
<a href="#l93.20"></a><span id="l93.20">             cal.WARN(&quot;CalDAV: No response status getting etags for calendar &quot; + this.calendar.name);</span>
<a href="#l93.21"></a><span id="l93.21">         }</span>
<a href="#l93.22"></a><span id="l93.22" class="difflineat">@@ -157,51 +157,51 @@ etagsHandler.prototype = {</span>
<a href="#l93.23"></a><span id="l93.23">                                        null,</span>
<a href="#l93.24"></a><span id="l93.24">                                        false,</span>
<a href="#l93.25"></a><span id="l93.25">                                        null,</span>
<a href="#l93.26"></a><span id="l93.26">                                        this.changeLogListener);</span>
<a href="#l93.27"></a><span id="l93.27">             multiget.doMultiGet();</span>
<a href="#l93.28"></a><span id="l93.28">         }</span>
<a href="#l93.29"></a><span id="l93.29">     }),</span>
<a href="#l93.30"></a><span id="l93.30"> </span>
<a href="#l93.31"></a><span id="l93.31" class="difflineminus">-    onDataAvailable: function eSL_onDataAvailable(request, context, inputStream, offset, count) {</span>
<a href="#l93.32"></a><span id="l93.32" class="difflineplus">+    onDataAvailable: function(request, context, inputStream, offset, count) {</span>
<a href="#l93.33"></a><span id="l93.33">         if (this._reader) {</span>
<a href="#l93.34"></a><span id="l93.34">             // No reader means request error</span>
<a href="#l93.35"></a><span id="l93.35">             this._reader.onDataAvailable(request, context, inputStream, offset, count);</span>
<a href="#l93.36"></a><span id="l93.36">         }</span>
<a href="#l93.37"></a><span id="l93.37">     },</span>
<a href="#l93.38"></a><span id="l93.38"> </span>
<a href="#l93.39"></a><span id="l93.39"> </span>
<a href="#l93.40"></a><span id="l93.40">     /**</span>
<a href="#l93.41"></a><span id="l93.41">      * @see nsISAXErrorHandler</span>
<a href="#l93.42"></a><span id="l93.42">      */</span>
<a href="#l93.43"></a><span id="l93.43" class="difflineminus">-    fatalError: function eH_fatalError() {</span>
<a href="#l93.44"></a><span id="l93.44" class="difflineplus">+    fatalError: function() {</span>
<a href="#l93.45"></a><span id="l93.45">         cal.WARN(&quot;CalDAV: Fatal Error parsing etags for &quot; + this.calendar.name);</span>
<a href="#l93.46"></a><span id="l93.46">     },</span>
<a href="#l93.47"></a><span id="l93.47"> </span>
<a href="#l93.48"></a><span id="l93.48"> </span>
<a href="#l93.49"></a><span id="l93.49">     /**</span>
<a href="#l93.50"></a><span id="l93.50">      * @see nsISAXContentHandler</span>
<a href="#l93.51"></a><span id="l93.51">      */</span>
<a href="#l93.52"></a><span id="l93.52" class="difflineminus">-    characters: function eH_characters(aValue) {</span>
<a href="#l93.53"></a><span id="l93.53" class="difflineplus">+    characters: function(aValue) {</span>
<a href="#l93.54"></a><span id="l93.54">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.55"></a><span id="l93.55">             this.logXML += aValue;</span>
<a href="#l93.56"></a><span id="l93.56">         }</span>
<a href="#l93.57"></a><span id="l93.57">         this.currentResponse[this.tag] += aValue;</span>
<a href="#l93.58"></a><span id="l93.58">     },</span>
<a href="#l93.59"></a><span id="l93.59"> </span>
<a href="#l93.60"></a><span id="l93.60" class="difflineminus">-    startDocument: function eH_startDocument() {</span>
<a href="#l93.61"></a><span id="l93.61" class="difflineplus">+    startDocument: function() {</span>
<a href="#l93.62"></a><span id="l93.62">         this.hrefMap = {};</span>
<a href="#l93.63"></a><span id="l93.63">         this.currentResponse = {};</span>
<a href="#l93.64"></a><span id="l93.64">         this.tag = null;</span>
<a href="#l93.65"></a><span id="l93.65">     },</span>
<a href="#l93.66"></a><span id="l93.66"> </span>
<a href="#l93.67"></a><span id="l93.67" class="difflineminus">-    endDocument: function eH_endDocument() { },</span>
<a href="#l93.68"></a><span id="l93.68" class="difflineplus">+    endDocument: function() { },</span>
<a href="#l93.69"></a><span id="l93.69"> </span>
<a href="#l93.70"></a><span id="l93.70" class="difflineminus">-    startElement: function eH_startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l93.71"></a><span id="l93.71" class="difflineplus">+    startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l93.72"></a><span id="l93.72">         switch (aLocalName) {</span>
<a href="#l93.73"></a><span id="l93.73">             case &quot;response&quot;:</span>
<a href="#l93.74"></a><span id="l93.74">                 this.currentResponse = {};</span>
<a href="#l93.75"></a><span id="l93.75">                 this.currentResponse.isCollection = false;</span>
<a href="#l93.76"></a><span id="l93.76">                 this.tag = null;</span>
<a href="#l93.77"></a><span id="l93.77">                 break;</span>
<a href="#l93.78"></a><span id="l93.78">             case &quot;collection&quot;:</span>
<a href="#l93.79"></a><span id="l93.79">                 this.currentResponse.isCollection = true;</span>
<a href="#l93.80"></a><span id="l93.80" class="difflineat">@@ -213,17 +213,17 @@ etagsHandler.prototype = {</span>
<a href="#l93.81"></a><span id="l93.81">                 this.currentResponse[aLocalName] = &quot;&quot;;</span>
<a href="#l93.82"></a><span id="l93.82">                 break;</span>
<a href="#l93.83"></a><span id="l93.83">         }</span>
<a href="#l93.84"></a><span id="l93.84">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.85"></a><span id="l93.85">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l93.86"></a><span id="l93.86">         }</span>
<a href="#l93.87"></a><span id="l93.87">     },</span>
<a href="#l93.88"></a><span id="l93.88"> </span>
<a href="#l93.89"></a><span id="l93.89" class="difflineminus">-    endElement: function eH_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l93.90"></a><span id="l93.90" class="difflineplus">+    endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l93.91"></a><span id="l93.91">         switch (aLocalName) {</span>
<a href="#l93.92"></a><span id="l93.92">             case &quot;response&quot;:</span>
<a href="#l93.93"></a><span id="l93.93">                 this.tag = null;</span>
<a href="#l93.94"></a><span id="l93.94">                 let r = this.currentResponse;</span>
<a href="#l93.95"></a><span id="l93.95">                 if (r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l93.96"></a><span id="l93.96">                     r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l93.97"></a><span id="l93.97">                     r.getcontenttype &amp;&amp; r.getcontenttype.length &amp;&amp;</span>
<a href="#l93.98"></a><span id="l93.98">                     !r.isCollection) {</span>
<a href="#l93.99"></a><span id="l93.99" class="difflineat">@@ -259,20 +259,20 @@ etagsHandler.prototype = {</span>
<a href="#l93.100"></a><span id="l93.100">                 this.tag = null;</span>
<a href="#l93.101"></a><span id="l93.101">                 break;</span>
<a href="#l93.102"></a><span id="l93.102">         }</span>
<a href="#l93.103"></a><span id="l93.103">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.104"></a><span id="l93.104">             this.logXML += &quot;&lt;/&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l93.105"></a><span id="l93.105">         }</span>
<a href="#l93.106"></a><span id="l93.106">     },</span>
<a href="#l93.107"></a><span id="l93.107"> </span>
<a href="#l93.108"></a><span id="l93.108" class="difflineminus">-    startPrefixMapping: function eH_startPrefixMapping(aPrefix, aUri) { },</span>
<a href="#l93.109"></a><span id="l93.109" class="difflineminus">-    endPrefixMapping: function eH_endPrefixMapping(aPrefix) { },</span>
<a href="#l93.110"></a><span id="l93.110" class="difflineminus">-    ignorableWhitespace: function eH_ignorableWhitespace(aWhiteSpace) { },</span>
<a href="#l93.111"></a><span id="l93.111" class="difflineminus">-    processingInstruction: function eH_processingInstruction(aTarget, aData) { }</span>
<a href="#l93.112"></a><span id="l93.112" class="difflineplus">+    startPrefixMapping: function(aPrefix, aUri) { },</span>
<a href="#l93.113"></a><span id="l93.113" class="difflineplus">+    endPrefixMapping: function(aPrefix) { },</span>
<a href="#l93.114"></a><span id="l93.114" class="difflineplus">+    ignorableWhitespace: function(aWhiteSpace) { },</span>
<a href="#l93.115"></a><span id="l93.115" class="difflineplus">+    processingInstruction: function(aTarget, aData) { }</span>
<a href="#l93.116"></a><span id="l93.116"> };</span>
<a href="#l93.117"></a><span id="l93.117"> </span>
<a href="#l93.118"></a><span id="l93.118"> /**</span>
<a href="#l93.119"></a><span id="l93.119">  * This is a handler for the webdav sync request in calDavCalendar.js' getUpdatedItem.</span>
<a href="#l93.120"></a><span id="l93.120">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l93.121"></a><span id="l93.121">  * resulting multiget.</span>
<a href="#l93.122"></a><span id="l93.122">  *</span>
<a href="#l93.123"></a><span id="l93.123">  * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l93.124"></a><span id="l93.124" class="difflineat">@@ -311,17 +311,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l93.125"></a><span id="l93.125"> </span>
<a href="#l93.126"></a><span id="l93.126">     QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l93.127"></a><span id="l93.127">         Components.interfaces.nsISAXContentHandler,</span>
<a href="#l93.128"></a><span id="l93.128">         Components.interfaces.nsISAXErrorHandler,</span>
<a href="#l93.129"></a><span id="l93.129">         Components.interfaces.nsIRequestObserver,</span>
<a href="#l93.130"></a><span id="l93.130">         Components.interfaces.nsIStreamListener</span>
<a href="#l93.131"></a><span id="l93.131">     ]),</span>
<a href="#l93.132"></a><span id="l93.132"> </span>
<a href="#l93.133"></a><span id="l93.133" class="difflineminus">-    doWebDAVSync: function doWebDAVSync() {</span>
<a href="#l93.134"></a><span id="l93.134" class="difflineplus">+    doWebDAVSync: function() {</span>
<a href="#l93.135"></a><span id="l93.135">         if (this.calendar.mDisabled) {</span>
<a href="#l93.136"></a><span id="l93.136">             // check if maybe our calendar has become available</span>
<a href="#l93.137"></a><span id="l93.137">             this.calendar.setupAuthentication(this.changeLogListener);</span>
<a href="#l93.138"></a><span id="l93.138">             return;</span>
<a href="#l93.139"></a><span id="l93.139">         }</span>
<a href="#l93.140"></a><span id="l93.140"> </span>
<a href="#l93.141"></a><span id="l93.141"> </span>
<a href="#l93.142"></a><span id="l93.142">         let syncTokenString = &quot;&lt;sync-token/&gt;&quot;;</span>
<a href="#l93.143"></a><span id="l93.143" class="difflineat">@@ -363,17 +363,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l93.144"></a><span id="l93.144">                                                 Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l93.145"></a><span id="l93.145">             }</span>
<a href="#l93.146"></a><span id="l93.146">         }, false);</span>
<a href="#l93.147"></a><span id="l93.147">     },</span>
<a href="#l93.148"></a><span id="l93.148"> </span>
<a href="#l93.149"></a><span id="l93.149">     /**</span>
<a href="#l93.150"></a><span id="l93.150">      * @see nsIStreamListener</span>
<a href="#l93.151"></a><span id="l93.151">      */</span>
<a href="#l93.152"></a><span id="l93.152" class="difflineminus">-    onStartRequest: function wSL_onStartRequest(request, context) {</span>
<a href="#l93.153"></a><span id="l93.153" class="difflineplus">+    onStartRequest: function(request, context) {</span>
<a href="#l93.154"></a><span id="l93.154">         let httpchannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l93.155"></a><span id="l93.155"> </span>
<a href="#l93.156"></a><span id="l93.156">         let responseStatus;</span>
<a href="#l93.157"></a><span id="l93.157">         try {</span>
<a href="#l93.158"></a><span id="l93.158">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l93.159"></a><span id="l93.159">         } catch (ex) {</span>
<a href="#l93.160"></a><span id="l93.160">             cal.WARN(&quot;CalDAV: No response status doing webdav sync for calendar &quot; + this.calendar.name);</span>
<a href="#l93.161"></a><span id="l93.161">         }</span>
<a href="#l93.162"></a><span id="l93.162" class="difflineat">@@ -399,66 +399,66 @@ webDavSyncHandler.prototype = {</span>
<a href="#l93.163"></a><span id="l93.163">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l93.164"></a><span id="l93.164">                 this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l93.165"></a><span id="l93.165">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l93.166"></a><span id="l93.166">             }</span>
<a href="#l93.167"></a><span id="l93.167">             this._reader = null;</span>
<a href="#l93.168"></a><span id="l93.168">         }</span>
<a href="#l93.169"></a><span id="l93.169">     },</span>
<a href="#l93.170"></a><span id="l93.170"> </span>
<a href="#l93.171"></a><span id="l93.171" class="difflineminus">-    onStopRequest: function wSL_onStopRequest(request, context, statusCode) {</span>
<a href="#l93.172"></a><span id="l93.172" class="difflineplus">+    onStopRequest: function(request, context, statusCode) {</span>
<a href="#l93.173"></a><span id="l93.173">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.174"></a><span id="l93.174">             cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l93.175"></a><span id="l93.175">         }</span>
<a href="#l93.176"></a><span id="l93.176">         if (!this._reader) {</span>
<a href="#l93.177"></a><span id="l93.177">             // No reader means there was a request error</span>
<a href="#l93.178"></a><span id="l93.178">             cal.LOG(&quot;CalDAV: onStopRequest: no reader&quot;);</span>
<a href="#l93.179"></a><span id="l93.179">             return;</span>
<a href="#l93.180"></a><span id="l93.180">         }</span>
<a href="#l93.181"></a><span id="l93.181">         try {</span>
<a href="#l93.182"></a><span id="l93.182">             this._reader.onStopRequest(request, context, statusCode);</span>
<a href="#l93.183"></a><span id="l93.183">         } finally {</span>
<a href="#l93.184"></a><span id="l93.184">             this._reader = null;</span>
<a href="#l93.185"></a><span id="l93.185">         }</span>
<a href="#l93.186"></a><span id="l93.186">     },</span>
<a href="#l93.187"></a><span id="l93.187"> </span>
<a href="#l93.188"></a><span id="l93.188" class="difflineminus">-    onDataAvailable: function wSL_onDataAvailable(request, context, inputStream, offset, count) {</span>
<a href="#l93.189"></a><span id="l93.189" class="difflineplus">+    onDataAvailable: function(request, context, inputStream, offset, count) {</span>
<a href="#l93.190"></a><span id="l93.190">         if (this._reader) {</span>
<a href="#l93.191"></a><span id="l93.191">             // No reader means request error</span>
<a href="#l93.192"></a><span id="l93.192">             this._reader.onDataAvailable(request, context, inputStream, offset, count);</span>
<a href="#l93.193"></a><span id="l93.193">         }</span>
<a href="#l93.194"></a><span id="l93.194">     },</span>
<a href="#l93.195"></a><span id="l93.195"> </span>
<a href="#l93.196"></a><span id="l93.196">     /**</span>
<a href="#l93.197"></a><span id="l93.197">      * @see nsISAXErrorHandler</span>
<a href="#l93.198"></a><span id="l93.198">      */</span>
<a href="#l93.199"></a><span id="l93.199" class="difflineminus">-    fatalError: function wH_fatalError() {</span>
<a href="#l93.200"></a><span id="l93.200" class="difflineplus">+    fatalError: function() {</span>
<a href="#l93.201"></a><span id="l93.201">         cal.WARN(&quot;CalDAV: Fatal Error doing webdav sync for &quot; + this.calendar.name);</span>
<a href="#l93.202"></a><span id="l93.202">     },</span>
<a href="#l93.203"></a><span id="l93.203"> </span>
<a href="#l93.204"></a><span id="l93.204">     /**</span>
<a href="#l93.205"></a><span id="l93.205">      * @see nsISAXContentHandler</span>
<a href="#l93.206"></a><span id="l93.206">      */</span>
<a href="#l93.207"></a><span id="l93.207" class="difflineminus">-    characters: function wH_characters(aValue) {</span>
<a href="#l93.208"></a><span id="l93.208" class="difflineplus">+    characters: function(aValue) {</span>
<a href="#l93.209"></a><span id="l93.209">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.210"></a><span id="l93.210">             this.logXML += aValue;</span>
<a href="#l93.211"></a><span id="l93.211">         }</span>
<a href="#l93.212"></a><span id="l93.212">         this.currentResponse[this.tag] += aValue;</span>
<a href="#l93.213"></a><span id="l93.213">     },</span>
<a href="#l93.214"></a><span id="l93.214"> </span>
<a href="#l93.215"></a><span id="l93.215" class="difflineminus">-    startDocument: function wH_startDocument() {</span>
<a href="#l93.216"></a><span id="l93.216" class="difflineplus">+    startDocument: function() {</span>
<a href="#l93.217"></a><span id="l93.217">         this.hrefMap = {};</span>
<a href="#l93.218"></a><span id="l93.218">         this.currentResponse = {};</span>
<a href="#l93.219"></a><span id="l93.219">         this.tag = null;</span>
<a href="#l93.220"></a><span id="l93.220">         if (this.calendar.isCached) {</span>
<a href="#l93.221"></a><span id="l93.221">             this.calendar.superCalendar.startBatch();</span>
<a href="#l93.222"></a><span id="l93.222">         }</span>
<a href="#l93.223"></a><span id="l93.223">     },</span>
<a href="#l93.224"></a><span id="l93.224"> </span>
<a href="#l93.225"></a><span id="l93.225" class="difflineminus">-    endDocument: function wH_endDocument() {</span>
<a href="#l93.226"></a><span id="l93.226" class="difflineplus">+    endDocument: function() {</span>
<a href="#l93.227"></a><span id="l93.227">         if (this.unhandledErrors) {</span>
<a href="#l93.228"></a><span id="l93.228">             this.calendar.superCalendar.endBatch();</span>
<a href="#l93.229"></a><span id="l93.229">             this.calendar.reportDavError(Components.interfaces.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l93.230"></a><span id="l93.230">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l93.231"></a><span id="l93.231">                 this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l93.232"></a><span id="l93.232">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l93.233"></a><span id="l93.233">             }</span>
<a href="#l93.234"></a><span id="l93.234">             return;</span>
<a href="#l93.235"></a><span id="l93.235" class="difflineat">@@ -493,17 +493,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l93.236"></a><span id="l93.236">                                                    this.newSyncToken,</span>
<a href="#l93.237"></a><span id="l93.237">                                                    this.additionalSyncNeeded,</span>
<a href="#l93.238"></a><span id="l93.238">                                                    null,</span>
<a href="#l93.239"></a><span id="l93.239">                                                    this.changeLogListener);</span>
<a href="#l93.240"></a><span id="l93.240">             multiget.doMultiGet();</span>
<a href="#l93.241"></a><span id="l93.241">         }</span>
<a href="#l93.242"></a><span id="l93.242">     },</span>
<a href="#l93.243"></a><span id="l93.243"> </span>
<a href="#l93.244"></a><span id="l93.244" class="difflineminus">-    startElement: function wH_startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l93.245"></a><span id="l93.245" class="difflineplus">+    startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l93.246"></a><span id="l93.246">         switch (aLocalName) {</span>
<a href="#l93.247"></a><span id="l93.247">             case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l93.248"></a><span id="l93.248">                 this.currentResponse = {};</span>
<a href="#l93.249"></a><span id="l93.249">                 this.tag = null;</span>
<a href="#l93.250"></a><span id="l93.250">                 this.isInPropStat = false;</span>
<a href="#l93.251"></a><span id="l93.251">                 break;</span>
<a href="#l93.252"></a><span id="l93.252">             case &quot;propstat&quot;:</span>
<a href="#l93.253"></a><span id="l93.253">                 this.isInPropStat = true;</span>
<a href="#l93.254"></a><span id="l93.254" class="difflineat">@@ -524,17 +524,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l93.255"></a><span id="l93.255">                 this.currentResponse[this.tag] = &quot;&quot;;</span>
<a href="#l93.256"></a><span id="l93.256">                 break;</span>
<a href="#l93.257"></a><span id="l93.257">         }</span>
<a href="#l93.258"></a><span id="l93.258">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.259"></a><span id="l93.259">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l93.260"></a><span id="l93.260">         }</span>
<a href="#l93.261"></a><span id="l93.261">     },</span>
<a href="#l93.262"></a><span id="l93.262"> </span>
<a href="#l93.263"></a><span id="l93.263" class="difflineminus">-    endElement: function wH_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l93.264"></a><span id="l93.264" class="difflineplus">+    endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l93.265"></a><span id="l93.265">         switch (aLocalName) {</span>
<a href="#l93.266"></a><span id="l93.266">             case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l93.267"></a><span id="l93.267">             case &quot;sync-response&quot;: // WebDAV Sync draft 0,1,2</span>
<a href="#l93.268"></a><span id="l93.268">                 let r = this.currentResponse;</span>
<a href="#l93.269"></a><span id="l93.269">                 if (r.href &amp;&amp; r.href.length) {</span>
<a href="#l93.270"></a><span id="l93.270">                     r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l93.271"></a><span id="l93.271">                 }</span>
<a href="#l93.272"></a><span id="l93.272"> </span>
<a href="#l93.273"></a><span id="l93.273" class="difflineat">@@ -620,20 +620,20 @@ webDavSyncHandler.prototype = {</span>
<a href="#l93.274"></a><span id="l93.274">                 break;</span>
<a href="#l93.275"></a><span id="l93.275">         }</span>
<a href="#l93.276"></a><span id="l93.276">         this.tag = null;</span>
<a href="#l93.277"></a><span id="l93.277">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.278"></a><span id="l93.278">             this.logXML += &quot;&lt;/&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l93.279"></a><span id="l93.279">         }</span>
<a href="#l93.280"></a><span id="l93.280">     },</span>
<a href="#l93.281"></a><span id="l93.281"> </span>
<a href="#l93.282"></a><span id="l93.282" class="difflineminus">-    startPrefixMapping: function wH_startPrefixMapping(aPrefix, aUri) { },</span>
<a href="#l93.283"></a><span id="l93.283" class="difflineminus">-    endPrefixMapping: function wH_endPrefixMapping(aPrefix) { },</span>
<a href="#l93.284"></a><span id="l93.284" class="difflineminus">-    ignorableWhitespace: function wH_ignorableWhitespace(aWhiteSpace) { },</span>
<a href="#l93.285"></a><span id="l93.285" class="difflineminus">-    processingInstruction: function wH_processingInstruction(aTarget, aData) { }</span>
<a href="#l93.286"></a><span id="l93.286" class="difflineplus">+    startPrefixMapping: function(aPrefix, aUri) { },</span>
<a href="#l93.287"></a><span id="l93.287" class="difflineplus">+    endPrefixMapping: function(aPrefix) { },</span>
<a href="#l93.288"></a><span id="l93.288" class="difflineplus">+    ignorableWhitespace: function(aWhiteSpace) { },</span>
<a href="#l93.289"></a><span id="l93.289" class="difflineplus">+    processingInstruction: function(aTarget, aData) { }</span>
<a href="#l93.290"></a><span id="l93.290"> };</span>
<a href="#l93.291"></a><span id="l93.291"> </span>
<a href="#l93.292"></a><span id="l93.292"> /**</span>
<a href="#l93.293"></a><span id="l93.293">  * This is a handler for the multiget request.</span>
<a href="#l93.294"></a><span id="l93.294">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l93.295"></a><span id="l93.295">  * resulting multiget.</span>
<a href="#l93.296"></a><span id="l93.296">  *</span>
<a href="#l93.297"></a><span id="l93.297">  * @param aItemsNeedFetching    The array of items to fetch, this must be an</span>
<a href="#l93.298"></a><span id="l93.298" class="difflineat">@@ -677,17 +677,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l93.299"></a><span id="l93.299"> </span>
<a href="#l93.300"></a><span id="l93.300">     QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l93.301"></a><span id="l93.301">         Components.interfaces.nsISAXContentHandler,</span>
<a href="#l93.302"></a><span id="l93.302">         Components.interfaces.nsISAXErrorHandler,</span>
<a href="#l93.303"></a><span id="l93.303">         Components.interfaces.nsIRequestObserver,</span>
<a href="#l93.304"></a><span id="l93.304">         Components.interfaces.nsIStreamListener</span>
<a href="#l93.305"></a><span id="l93.305">     ]),</span>
<a href="#l93.306"></a><span id="l93.306"> </span>
<a href="#l93.307"></a><span id="l93.307" class="difflineminus">-    doMultiGet: function doMultiGet() {</span>
<a href="#l93.308"></a><span id="l93.308" class="difflineplus">+    doMultiGet: function() {</span>
<a href="#l93.309"></a><span id="l93.309">         if (this.calendar.mDisabled) {</span>
<a href="#l93.310"></a><span id="l93.310">             // check if maybe our calendar has become available</span>
<a href="#l93.311"></a><span id="l93.311">             this.calendar.setupAuthentication(this.changeLogListener);</span>
<a href="#l93.312"></a><span id="l93.312">             return;</span>
<a href="#l93.313"></a><span id="l93.313">         }</span>
<a href="#l93.314"></a><span id="l93.314"> </span>
<a href="#l93.315"></a><span id="l93.315">         let batchSize = Preferences.get(&quot;calendar.caldav.multigetBatchSize&quot;, 100);</span>
<a href="#l93.316"></a><span id="l93.316">         let hrefString = &quot;&quot;;</span>
<a href="#l93.317"></a><span id="l93.317" class="difflineat">@@ -724,17 +724,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l93.318"></a><span id="l93.318">                                                 Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l93.319"></a><span id="l93.319">             }</span>
<a href="#l93.320"></a><span id="l93.320">         }, false);</span>
<a href="#l93.321"></a><span id="l93.321">     },</span>
<a href="#l93.322"></a><span id="l93.322"> </span>
<a href="#l93.323"></a><span id="l93.323">     /**</span>
<a href="#l93.324"></a><span id="l93.324">      * @see nsIStreamListener</span>
<a href="#l93.325"></a><span id="l93.325">      */</span>
<a href="#l93.326"></a><span id="l93.326" class="difflineminus">-    onStartRequest: function mg_onStartRequest(request, context) {</span>
<a href="#l93.327"></a><span id="l93.327" class="difflineplus">+    onStartRequest: function(request, context) {</span>
<a href="#l93.328"></a><span id="l93.328">         let httpchannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l93.329"></a><span id="l93.329"> </span>
<a href="#l93.330"></a><span id="l93.330">         let responseStatus;</span>
<a href="#l93.331"></a><span id="l93.331">         try {</span>
<a href="#l93.332"></a><span id="l93.332">             responseStatus = httpchannel.responseStatus;</span>
<a href="#l93.333"></a><span id="l93.333">         } catch (ex) {</span>
<a href="#l93.334"></a><span id="l93.334">             cal.WARN(&quot;CalDAV: No response status doing multiget for calendar &quot; + this.calendar.name);</span>
<a href="#l93.335"></a><span id="l93.335">         }</span>
<a href="#l93.336"></a><span id="l93.336" class="difflineat">@@ -747,17 +747,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l93.337"></a><span id="l93.337">         } else {</span>
<a href="#l93.338"></a><span id="l93.338">             let errorMsg = &quot;CalDAV: Error: got status &quot; + responseStatus +</span>
<a href="#l93.339"></a><span id="l93.339">                                &quot; fetching calendar data for &quot; + this.calendar.name + &quot;, &quot; + this.listener;</span>
<a href="#l93.340"></a><span id="l93.340">             this.calendar.notifyGetFailed(errorMsg, this.listener, this.changeLogListener);</span>
<a href="#l93.341"></a><span id="l93.341">             this._reader = null;</span>
<a href="#l93.342"></a><span id="l93.342">         }</span>
<a href="#l93.343"></a><span id="l93.343">     },</span>
<a href="#l93.344"></a><span id="l93.344"> </span>
<a href="#l93.345"></a><span id="l93.345" class="difflineminus">-    onStopRequest: function mg_onStopRequest(request, context, statusCode) {</span>
<a href="#l93.346"></a><span id="l93.346" class="difflineplus">+    onStopRequest: function(request, context, statusCode) {</span>
<a href="#l93.347"></a><span id="l93.347">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.348"></a><span id="l93.348">             cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l93.349"></a><span id="l93.349">         }</span>
<a href="#l93.350"></a><span id="l93.350">         if (this.unhandledErrors) {</span>
<a href="#l93.351"></a><span id="l93.351">             this.calendar.superCalendar.endBatch();</span>
<a href="#l93.352"></a><span id="l93.352">             this.calendar.notifyGetFailed(&quot;multiget error&quot;, this.listener, this.changeLogListener);</span>
<a href="#l93.353"></a><span id="l93.353">             return;</span>
<a href="#l93.354"></a><span id="l93.354">         }</span>
<a href="#l93.355"></a><span id="l93.355" class="difflineat">@@ -808,57 +808,57 @@ multigetSyncHandler.prototype = {</span>
<a href="#l93.356"></a><span id="l93.356">             let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l93.357"></a><span id="l93.357">                         .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l93.358"></a><span id="l93.358">             timer.initWithCallback(timerCallback,</span>
<a href="#l93.359"></a><span id="l93.359">                                    0,</span>
<a href="#l93.360"></a><span id="l93.360">                                    Components.interfaces.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l93.361"></a><span id="l93.361">         }</span>
<a href="#l93.362"></a><span id="l93.362">     },</span>
<a href="#l93.363"></a><span id="l93.363"> </span>
<a href="#l93.364"></a><span id="l93.364" class="difflineminus">-    onDataAvailable: function mg_onDataAvailable(request, context, inputStream, offset, count) {</span>
<a href="#l93.365"></a><span id="l93.365" class="difflineplus">+    onDataAvailable: function(request, context, inputStream, offset, count) {</span>
<a href="#l93.366"></a><span id="l93.366">         if (this._reader) {</span>
<a href="#l93.367"></a><span id="l93.367">             // No reader means request error</span>
<a href="#l93.368"></a><span id="l93.368">             this._reader.onDataAvailable(request, context, inputStream, offset, count);</span>
<a href="#l93.369"></a><span id="l93.369">         }</span>
<a href="#l93.370"></a><span id="l93.370">     },</span>
<a href="#l93.371"></a><span id="l93.371"> </span>
<a href="#l93.372"></a><span id="l93.372">     /**</span>
<a href="#l93.373"></a><span id="l93.373">      * @see nsISAXErrorHandler</span>
<a href="#l93.374"></a><span id="l93.374">      */</span>
<a href="#l93.375"></a><span id="l93.375" class="difflineminus">-    fatalError: function mg_fatalError() {</span>
<a href="#l93.376"></a><span id="l93.376" class="difflineplus">+    fatalError: function() {</span>
<a href="#l93.377"></a><span id="l93.377">         cal.WARN(&quot;CalDAV: Fatal Error doing multiget for &quot; + this.calendar.name);</span>
<a href="#l93.378"></a><span id="l93.378">     },</span>
<a href="#l93.379"></a><span id="l93.379"> </span>
<a href="#l93.380"></a><span id="l93.380">     /**</span>
<a href="#l93.381"></a><span id="l93.381">      * @see nsISAXContentHandler</span>
<a href="#l93.382"></a><span id="l93.382">      */</span>
<a href="#l93.383"></a><span id="l93.383" class="difflineminus">-    characters: function mg_characters(aValue) {</span>
<a href="#l93.384"></a><span id="l93.384" class="difflineplus">+    characters: function(aValue) {</span>
<a href="#l93.385"></a><span id="l93.385">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.386"></a><span id="l93.386">             this.logXML += aValue;</span>
<a href="#l93.387"></a><span id="l93.387">         }</span>
<a href="#l93.388"></a><span id="l93.388">         this.currentResponse[this.tag] += aValue;</span>
<a href="#l93.389"></a><span id="l93.389">     },</span>
<a href="#l93.390"></a><span id="l93.390"> </span>
<a href="#l93.391"></a><span id="l93.391" class="difflineminus">-    startDocument: function mg_startDocument() {</span>
<a href="#l93.392"></a><span id="l93.392" class="difflineplus">+    startDocument: function() {</span>
<a href="#l93.393"></a><span id="l93.393">         this.hrefMap = {};</span>
<a href="#l93.394"></a><span id="l93.394">         this.currentResponse = {};</span>
<a href="#l93.395"></a><span id="l93.395">         this.tag = null;</span>
<a href="#l93.396"></a><span id="l93.396">         this.logXML = &quot;&quot;;</span>
<a href="#l93.397"></a><span id="l93.397">         if (this.calendar.isCached) {</span>
<a href="#l93.398"></a><span id="l93.398">             this.calendar.superCalendar.startBatch();</span>
<a href="#l93.399"></a><span id="l93.399">         }</span>
<a href="#l93.400"></a><span id="l93.400">     },</span>
<a href="#l93.401"></a><span id="l93.401"> </span>
<a href="#l93.402"></a><span id="l93.402" class="difflineminus">-    endDocument: function mg_endDocument() {</span>
<a href="#l93.403"></a><span id="l93.403" class="difflineplus">+    endDocument: function() {</span>
<a href="#l93.404"></a><span id="l93.404">         if (this.calendar.isCached) {</span>
<a href="#l93.405"></a><span id="l93.405">             this.calendar.superCalendar.endBatch();</span>
<a href="#l93.406"></a><span id="l93.406">         }</span>
<a href="#l93.407"></a><span id="l93.407">     },</span>
<a href="#l93.408"></a><span id="l93.408"> </span>
<a href="#l93.409"></a><span id="l93.409" class="difflineminus">-    startElement: function mg_startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l93.410"></a><span id="l93.410" class="difflineplus">+    startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l93.411"></a><span id="l93.411">         switch (aLocalName) {</span>
<a href="#l93.412"></a><span id="l93.412">             case &quot;response&quot;:</span>
<a href="#l93.413"></a><span id="l93.413">                 this.currentResponse = {};</span>
<a href="#l93.414"></a><span id="l93.414">                 this.tag = null;</span>
<a href="#l93.415"></a><span id="l93.415">                 this.isInPropStat = false;</span>
<a href="#l93.416"></a><span id="l93.416">                 break;</span>
<a href="#l93.417"></a><span id="l93.417">             case &quot;propstat&quot;:</span>
<a href="#l93.418"></a><span id="l93.418">                 this.isInPropStat = true;</span>
<a href="#l93.419"></a><span id="l93.419" class="difflineat">@@ -878,17 +878,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l93.420"></a><span id="l93.420">                 this.currentResponse[this.tag] = &quot;&quot;;</span>
<a href="#l93.421"></a><span id="l93.421">                 break;</span>
<a href="#l93.422"></a><span id="l93.422">         }</span>
<a href="#l93.423"></a><span id="l93.423">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.424"></a><span id="l93.424">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l93.425"></a><span id="l93.425">         }</span>
<a href="#l93.426"></a><span id="l93.426">     },</span>
<a href="#l93.427"></a><span id="l93.427"> </span>
<a href="#l93.428"></a><span id="l93.428" class="difflineminus">-    endElement: function mg_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l93.429"></a><span id="l93.429" class="difflineplus">+    endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l93.430"></a><span id="l93.430">         switch (aLocalName) {</span>
<a href="#l93.431"></a><span id="l93.431">             case &quot;response&quot;:</span>
<a href="#l93.432"></a><span id="l93.432">                 let r = this.currentResponse;</span>
<a href="#l93.433"></a><span id="l93.433">                 if (r.href &amp;&amp;</span>
<a href="#l93.434"></a><span id="l93.434">                     r.href.length) {</span>
<a href="#l93.435"></a><span id="l93.435">                     r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l93.436"></a><span id="l93.436">                 }</span>
<a href="#l93.437"></a><span id="l93.437">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l93.438"></a><span id="l93.438" class="difflineat">@@ -933,13 +933,13 @@ multigetSyncHandler.prototype = {</span>
<a href="#l93.439"></a><span id="l93.439">                 break;</span>
<a href="#l93.440"></a><span id="l93.440">         }</span>
<a href="#l93.441"></a><span id="l93.441">         this.tag = null;</span>
<a href="#l93.442"></a><span id="l93.442">         if (this.calendar.verboseLogging()) {</span>
<a href="#l93.443"></a><span id="l93.443">             this.logXML += &quot;&lt;/&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l93.444"></a><span id="l93.444">         }</span>
<a href="#l93.445"></a><span id="l93.445">     },</span>
<a href="#l93.446"></a><span id="l93.446"> </span>
<a href="#l93.447"></a><span id="l93.447" class="difflineminus">-    startPrefixMapping: function mg_startPrefixMapping(aPrefix, aUri) { },</span>
<a href="#l93.448"></a><span id="l93.448" class="difflineminus">-    endPrefixMapping: function mg_endPrefixMapping(aPrefix) { },</span>
<a href="#l93.449"></a><span id="l93.449" class="difflineminus">-    ignorableWhitespace: function mg_ignorableWhitespace(aWhiteSpace) { },</span>
<a href="#l93.450"></a><span id="l93.450" class="difflineminus">-    processingInstruction: function mg_processingInstruction(aTarget, aData) { }</span>
<a href="#l93.451"></a><span id="l93.451" class="difflineplus">+    startPrefixMapping: function(aPrefix, aUri) { },</span>
<a href="#l93.452"></a><span id="l93.452" class="difflineplus">+    endPrefixMapping: function(aPrefix) { },</span>
<a href="#l93.453"></a><span id="l93.453" class="difflineplus">+    ignorableWhitespace: function(aWhiteSpace) { },</span>
<a href="#l93.454"></a><span id="l93.454" class="difflineplus">+    processingInstruction: function(aTarget, aData) { }</span>
<a href="#l93.455"></a><span id="l93.455"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -98,21 +98,21 @@ calCompositeCalendar.prototype = {</span>
<a href="#l94.4"></a><span id="l94.4">     }),</span>
<a href="#l94.5"></a><span id="l94.5"> </span>
<a href="#l94.6"></a><span id="l94.6">     //</span>
<a href="#l94.7"></a><span id="l94.7">     // calICalendarProvider interface</span>
<a href="#l94.8"></a><span id="l94.8">     //</span>
<a href="#l94.9"></a><span id="l94.9">     get prefChromeOverlay() { return null; },</span>
<a href="#l94.10"></a><span id="l94.10">     get displayName() { return cal.calGetString(&quot;calendar&quot;, &quot;compositeName&quot;); },</span>
<a href="#l94.11"></a><span id="l94.11"> </span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-    createCalendar: function comp_createCal() {</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+    createCalendar: function() {</span>
<a href="#l94.14"></a><span id="l94.14">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l94.15"></a><span id="l94.15">     },</span>
<a href="#l94.16"></a><span id="l94.16"> </span>
<a href="#l94.17"></a><span id="l94.17" class="difflineminus">-    deleteCalendar: function comp_deleteCal(calendar, listener) {</span>
<a href="#l94.18"></a><span id="l94.18" class="difflineplus">+    deleteCalendar: function(calendar, listener) {</span>
<a href="#l94.19"></a><span id="l94.19">         // You shouldn't be able to delete from the composite calendar.</span>
<a href="#l94.20"></a><span id="l94.20">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l94.21"></a><span id="l94.21">     },</span>
<a href="#l94.22"></a><span id="l94.22"> </span>
<a href="#l94.23"></a><span id="l94.23">     //</span>
<a href="#l94.24"></a><span id="l94.24">     // calICompositeCalendar interface</span>
<a href="#l94.25"></a><span id="l94.25">     //</span>
<a href="#l94.26"></a><span id="l94.26"> </span>
<a href="#l94.27"></a><span id="l94.27" class="difflineat">@@ -149,17 +149,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l94.28"></a><span id="l94.28">             }</span>
<a href="#l94.29"></a><span id="l94.29">         }, this);</span>
<a href="#l94.30"></a><span id="l94.30">     },</span>
<a href="#l94.31"></a><span id="l94.31"> </span>
<a href="#l94.32"></a><span id="l94.32">     get prefPrefix() {</span>
<a href="#l94.33"></a><span id="l94.33">         return this.mPrefPrefix;</span>
<a href="#l94.34"></a><span id="l94.34">     },</span>
<a href="#l94.35"></a><span id="l94.35"> </span>
<a href="#l94.36"></a><span id="l94.36" class="difflineminus">-    addCalendar: function cCC_addCalendar(aCalendar) {</span>
<a href="#l94.37"></a><span id="l94.37" class="difflineplus">+    addCalendar: function(aCalendar) {</span>
<a href="#l94.38"></a><span id="l94.38">         cal.ASSERT(aCalendar.id, &quot;calendar does not have an id!&quot;, true);</span>
<a href="#l94.39"></a><span id="l94.39"> </span>
<a href="#l94.40"></a><span id="l94.40">         // check if the calendar already exists</span>
<a href="#l94.41"></a><span id="l94.41">         if (this.getCalendarById(aCalendar.id)) {</span>
<a href="#l94.42"></a><span id="l94.42">             return;</span>
<a href="#l94.43"></a><span id="l94.43">         }</span>
<a href="#l94.44"></a><span id="l94.44"> </span>
<a href="#l94.45"></a><span id="l94.45">         // add our observer helper</span>
<a href="#l94.46"></a><span id="l94.46" class="difflineat">@@ -172,40 +172,40 @@ calCompositeCalendar.prototype = {</span>
<a href="#l94.47"></a><span id="l94.47">         this.mCompositeObservers.notify(&quot;onCalendarAdded&quot;, [aCalendar]);</span>
<a href="#l94.48"></a><span id="l94.48"> </span>
<a href="#l94.49"></a><span id="l94.49">         // if we have no default calendar, we need one here</span>
<a href="#l94.50"></a><span id="l94.50">         if (this.mDefaultCalendar == null &amp;&amp; !aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l94.51"></a><span id="l94.51">             this.setDefaultCalendar(aCalendar, false);</span>
<a href="#l94.52"></a><span id="l94.52">         }</span>
<a href="#l94.53"></a><span id="l94.53">     },</span>
<a href="#l94.54"></a><span id="l94.54"> </span>
<a href="#l94.55"></a><span id="l94.55" class="difflineminus">-    removeCalendar: function cCC_removeCalendar(aCalendar) {</span>
<a href="#l94.56"></a><span id="l94.56" class="difflineplus">+    removeCalendar: function(aCalendar) {</span>
<a href="#l94.57"></a><span id="l94.57">         let id = aCalendar.id;</span>
<a href="#l94.58"></a><span id="l94.58">         let newCalendars = this.mCalendars.filter(function(calendar) { return calendar.id != id; });</span>
<a href="#l94.59"></a><span id="l94.59">         if (newCalendars.length != this.mCalendars) {</span>
<a href="#l94.60"></a><span id="l94.60">             this.mCalendars = newCalendars;</span>
<a href="#l94.61"></a><span id="l94.61">             if (this.mPrefPrefix) {</span>
<a href="#l94.62"></a><span id="l94.62">                 aCalendar.deleteProperty(this.mActivePref);</span>
<a href="#l94.63"></a><span id="l94.63">                 aCalendar.deleteProperty(this.mDefaultPref);</span>
<a href="#l94.64"></a><span id="l94.64">             }</span>
<a href="#l94.65"></a><span id="l94.65">             aCalendar.removeObserver(this.mObserverHelper);</span>
<a href="#l94.66"></a><span id="l94.66">             this.mCompositeObservers.notify(&quot;onCalendarRemoved&quot;, [aCalendar]);</span>
<a href="#l94.67"></a><span id="l94.67">         }</span>
<a href="#l94.68"></a><span id="l94.68">     },</span>
<a href="#l94.69"></a><span id="l94.69"> </span>
<a href="#l94.70"></a><span id="l94.70" class="difflineminus">-    getCalendarById: function cCC_getCalendarById(aId) {</span>
<a href="#l94.71"></a><span id="l94.71" class="difflineplus">+    getCalendarById: function(aId) {</span>
<a href="#l94.72"></a><span id="l94.72">         for (let calendar of this.mCalendars) {</span>
<a href="#l94.73"></a><span id="l94.73">             if (calendar.id == aId) {</span>
<a href="#l94.74"></a><span id="l94.74">                 return calendar;</span>
<a href="#l94.75"></a><span id="l94.75">             }</span>
<a href="#l94.76"></a><span id="l94.76">         }</span>
<a href="#l94.77"></a><span id="l94.77">         return null;</span>
<a href="#l94.78"></a><span id="l94.78">     },</span>
<a href="#l94.79"></a><span id="l94.79"> </span>
<a href="#l94.80"></a><span id="l94.80" class="difflineminus">-    getCalendars: function getCalendars(count) {</span>
<a href="#l94.81"></a><span id="l94.81" class="difflineplus">+    getCalendars: function(count) {</span>
<a href="#l94.82"></a><span id="l94.82">         count.value = this.mCalendars.length;</span>
<a href="#l94.83"></a><span id="l94.83">         return this.mCalendars;</span>
<a href="#l94.84"></a><span id="l94.84">     },</span>
<a href="#l94.85"></a><span id="l94.85"> </span>
<a href="#l94.86"></a><span id="l94.86">     get defaultCalendar() {</span>
<a href="#l94.87"></a><span id="l94.87">         return this.mDefaultCalendar;</span>
<a href="#l94.88"></a><span id="l94.88">     },</span>
<a href="#l94.89"></a><span id="l94.89"> </span>
<a href="#l94.90"></a><span id="l94.90" class="difflineat">@@ -313,17 +313,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l94.91"></a><span id="l94.91">     removeObserver: function(aObserver) {</span>
<a href="#l94.92"></a><span id="l94.92">         let wrappedCObserver = cal.wrapInstance(aObserver, Components.interfaces.calICompositeObserver);</span>
<a href="#l94.93"></a><span id="l94.93">         if (wrappedCObserver) {</span>
<a href="#l94.94"></a><span id="l94.94">             this.mCompositeObservers.remove(wrappedCObserver);</span>
<a href="#l94.95"></a><span id="l94.95">         }</span>
<a href="#l94.96"></a><span id="l94.96">         this.mObservers.remove(aObserver);</span>
<a href="#l94.97"></a><span id="l94.97">     },</span>
<a href="#l94.98"></a><span id="l94.98"> </span>
<a href="#l94.99"></a><span id="l94.99" class="difflineminus">-    refresh: function cCC_refresh() {</span>
<a href="#l94.100"></a><span id="l94.100" class="difflineplus">+    refresh: function() {</span>
<a href="#l94.101"></a><span id="l94.101">         if (this.mStatusObserver) {</span>
<a href="#l94.102"></a><span id="l94.102">             this.mStatusObserver.startMeteors(Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS, this.mCalendars.length);</span>
<a href="#l94.103"></a><span id="l94.103">         }</span>
<a href="#l94.104"></a><span id="l94.104">         for (let calendar of this.enabledCalendars) {</span>
<a href="#l94.105"></a><span id="l94.105">             try {</span>
<a href="#l94.106"></a><span id="l94.106">                 if (calendar.canRefresh) {</span>
<a href="#l94.107"></a><span id="l94.107">                     this.mObserverHelper.pendingLoads[calendar.id] = true;</span>
<a href="#l94.108"></a><span id="l94.108">                     calendar.refresh();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -83,21 +83,21 @@ calICSCalendar.prototype = {</span>
<a href="#l95.4"></a><span id="l95.4">     get prefChromeOverlay() {</span>
<a href="#l95.5"></a><span id="l95.5">         return null;</span>
<a href="#l95.6"></a><span id="l95.6">     },</span>
<a href="#l95.7"></a><span id="l95.7"> </span>
<a href="#l95.8"></a><span id="l95.8">     get displayName() {</span>
<a href="#l95.9"></a><span id="l95.9">         return calGetString(&quot;calendar&quot;, &quot;icsName&quot;);</span>
<a href="#l95.10"></a><span id="l95.10">     },</span>
<a href="#l95.11"></a><span id="l95.11"> </span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-    createCalendar: function ics_createCal() {</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineplus">+    createCalendar: function() {</span>
<a href="#l95.14"></a><span id="l95.14">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l95.15"></a><span id="l95.15">     },</span>
<a href="#l95.16"></a><span id="l95.16"> </span>
<a href="#l95.17"></a><span id="l95.17" class="difflineminus">-    deleteCalendar: function ics_deleteCal(cal, listener) {</span>
<a href="#l95.18"></a><span id="l95.18" class="difflineplus">+    deleteCalendar: function(cal, listener) {</span>
<a href="#l95.19"></a><span id="l95.19">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l95.20"></a><span id="l95.20">     },</span>
<a href="#l95.21"></a><span id="l95.21"> </span>
<a href="#l95.22"></a><span id="l95.22">     //</span>
<a href="#l95.23"></a><span id="l95.23">     // calICalendar interface</span>
<a href="#l95.24"></a><span id="l95.24">     //</span>
<a href="#l95.25"></a><span id="l95.25">     get type() { return &quot;ics&quot;; },</span>
<a href="#l95.26"></a><span id="l95.26"> </span>
<a href="#l95.27"></a><span id="l95.27" class="difflineat">@@ -125,56 +125,56 @@ calICSCalendar.prototype = {</span>
<a href="#l95.28"></a><span id="l95.28">             this.mHooks = new httpHooks(this);</span>
<a href="#l95.29"></a><span id="l95.29">         } else if (wFileChannel) {</span>
<a href="#l95.30"></a><span id="l95.30">             this.mHooks = new fileHooks(this);</span>
<a href="#l95.31"></a><span id="l95.31">         } else {</span>
<a href="#l95.32"></a><span id="l95.32">             this.mHooks = new dummyHooks(this);</span>
<a href="#l95.33"></a><span id="l95.33">         }</span>
<a href="#l95.34"></a><span id="l95.34">     },</span>
<a href="#l95.35"></a><span id="l95.35"> </span>
<a href="#l95.36"></a><span id="l95.36" class="difflineminus">-    getProperty: function calICSCalendar_getProperty(aName) {</span>
<a href="#l95.37"></a><span id="l95.37" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l95.38"></a><span id="l95.38">         switch (aName) {</span>
<a href="#l95.39"></a><span id="l95.39">             case &quot;requiresNetwork&quot;:</span>
<a href="#l95.40"></a><span id="l95.40">                 return !this.uri.schemeIs(&quot;file&quot;);</span>
<a href="#l95.41"></a><span id="l95.41">         }</span>
<a href="#l95.42"></a><span id="l95.42">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l95.43"></a><span id="l95.43">     },</span>
<a href="#l95.44"></a><span id="l95.44"> </span>
<a href="#l95.45"></a><span id="l95.45" class="difflineminus">-    refresh: function calICSCalendar_refresh() {</span>
<a href="#l95.46"></a><span id="l95.46" class="difflineplus">+    refresh: function() {</span>
<a href="#l95.47"></a><span id="l95.47">         this.queue.push({ action: &quot;refresh&quot;, forceRefresh: false });</span>
<a href="#l95.48"></a><span id="l95.48">         this.processQueue();</span>
<a href="#l95.49"></a><span id="l95.49">     },</span>
<a href="#l95.50"></a><span id="l95.50"> </span>
<a href="#l95.51"></a><span id="l95.51" class="difflineminus">-    forceRefresh: function calICSCalendar_forceRefresh() {</span>
<a href="#l95.52"></a><span id="l95.52" class="difflineplus">+    forceRefresh: function() {</span>
<a href="#l95.53"></a><span id="l95.53">         this.queue.push({ action: &quot;refresh&quot;, forceRefresh: true });</span>
<a href="#l95.54"></a><span id="l95.54">         this.processQueue();</span>
<a href="#l95.55"></a><span id="l95.55">     },</span>
<a href="#l95.56"></a><span id="l95.56"> </span>
<a href="#l95.57"></a><span id="l95.57" class="difflineminus">-    prepareChannel: function calICSCalendar_prepareChannel(aChannel, aForceRefresh) {</span>
<a href="#l95.58"></a><span id="l95.58" class="difflineplus">+    prepareChannel: function(aChannel, aForceRefresh) {</span>
<a href="#l95.59"></a><span id="l95.59">         aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l95.60"></a><span id="l95.60">         aChannel.notificationCallbacks = this;</span>
<a href="#l95.61"></a><span id="l95.61"> </span>
<a href="#l95.62"></a><span id="l95.62">         // Allow the hook to do its work, like a performing a quick check to</span>
<a href="#l95.63"></a><span id="l95.63">         // see if the remote file really changed. Might save a lot of time</span>
<a href="#l95.64"></a><span id="l95.64">         this.mHooks.onBeforeGet(aChannel, aForceRefresh);</span>
<a href="#l95.65"></a><span id="l95.65">     },</span>
<a href="#l95.66"></a><span id="l95.66"> </span>
<a href="#l95.67"></a><span id="l95.67" class="difflineminus">-    createMemoryCalendar: function calICSCalendar_createMemoryCalendar() {</span>
<a href="#l95.68"></a><span id="l95.68" class="difflineplus">+    createMemoryCalendar: function() {</span>
<a href="#l95.69"></a><span id="l95.69">         // Create a new calendar, to get rid of all the old events</span>
<a href="#l95.70"></a><span id="l95.70">         // Don't forget to remove the observer</span>
<a href="#l95.71"></a><span id="l95.71">         if (this.mMemoryCalendar) {</span>
<a href="#l95.72"></a><span id="l95.72">             this.mMemoryCalendar.removeObserver(this.mObserver);</span>
<a href="#l95.73"></a><span id="l95.73">         }</span>
<a href="#l95.74"></a><span id="l95.74">         this.mMemoryCalendar = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l95.75"></a><span id="l95.75">                                          .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l95.76"></a><span id="l95.76">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l95.77"></a><span id="l95.77">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l95.78"></a><span id="l95.78">     },</span>
<a href="#l95.79"></a><span id="l95.79"> </span>
<a href="#l95.80"></a><span id="l95.80" class="difflineminus">-    doRefresh: function calICSCalendar_doRefresh(aForce) {</span>
<a href="#l95.81"></a><span id="l95.81" class="difflineplus">+    doRefresh: function(aForce) {</span>
<a href="#l95.82"></a><span id="l95.82">         let prbForce = Components.classes[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l95.83"></a><span id="l95.83">                                  .createInstance(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l95.84"></a><span id="l95.84">         prbForce.data = aForce;</span>
<a href="#l95.85"></a><span id="l95.85"> </span>
<a href="#l95.86"></a><span id="l95.86">         let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l95.87"></a><span id="l95.87">                                                      null,</span>
<a href="#l95.88"></a><span id="l95.88">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l95.89"></a><span id="l95.89">                                                      null,</span>
<a href="#l95.90"></a><span id="l95.90" class="difflineat">@@ -262,17 +262,17 @@ calICSCalendar.prototype = {</span>
<a href="#l95.91"></a><span id="l95.91"> </span>
<a href="#l95.92"></a><span id="l95.92">         // Wrap parsing in a try block. Will ignore errors. That's a good thing</span>
<a href="#l95.93"></a><span id="l95.93">         // for non-existing or empty files, but not good for invalid files.</span>
<a href="#l95.94"></a><span id="l95.94">         // That's why we put them in readOnly mode</span>
<a href="#l95.95"></a><span id="l95.95">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l95.96"></a><span id="l95.96">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l95.97"></a><span id="l95.97">         let self = this;</span>
<a href="#l95.98"></a><span id="l95.98">         let listener = { // calIIcsParsingListener</span>
<a href="#l95.99"></a><span id="l95.99" class="difflineminus">-            onParsingComplete: function ics_onParsingComplete(rc, parser_) {</span>
<a href="#l95.100"></a><span id="l95.100" class="difflineplus">+            onParsingComplete: function(rc, parser_) {</span>
<a href="#l95.101"></a><span id="l95.101">                 try {</span>
<a href="#l95.102"></a><span id="l95.102">                     for (let item of parser_.getItems({})) {</span>
<a href="#l95.103"></a><span id="l95.103">                         self.mMemoryCalendar.adoptItem(item, null);</span>
<a href="#l95.104"></a><span id="l95.104">                     }</span>
<a href="#l95.105"></a><span id="l95.105">                     self.unmappedComponents = parser_.getComponents({});</span>
<a href="#l95.106"></a><span id="l95.106">                     self.unmappedProperties = parser_.getProperties({});</span>
<a href="#l95.107"></a><span id="l95.107">                     cal.LOG(&quot;[calICSCalendar] Parsing ICS succeeded for &quot; + self.uri.spec);</span>
<a href="#l95.108"></a><span id="l95.108">                 } catch (exc) {</span>
<a href="#l95.109"></a><span id="l95.109" class="difflineat">@@ -997,19 +997,17 @@ httpHooks.prototype = {</span>
<a href="#l95.110"></a><span id="l95.110">             // putting is not atomic. This is bad. Race conditions can happen,</span>
<a href="#l95.111"></a><span id="l95.111">             // because there is a time in which we don't know the right</span>
<a href="#l95.112"></a><span id="l95.112">             // etag.</span>
<a href="#l95.113"></a><span id="l95.113">             // Try to do the best we can, by immediatly getting the etag.</span>
<a href="#l95.114"></a><span id="l95.114"> </span>
<a href="#l95.115"></a><span id="l95.115">             let etagListener = {};</span>
<a href="#l95.116"></a><span id="l95.116">             let self = this; // need to reference in callback</span>
<a href="#l95.117"></a><span id="l95.117"> </span>
<a href="#l95.118"></a><span id="l95.118" class="difflineminus">-            etagListener.onStreamComplete =</span>
<a href="#l95.119"></a><span id="l95.119" class="difflineminus">-                function ics_etLoSC(aLoader, aContext, aStatus, aResultLength,</span>
<a href="#l95.120"></a><span id="l95.120" class="difflineminus">-                                    aResult) {</span>
<a href="#l95.121"></a><span id="l95.121" class="difflineplus">+            etagListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l95.122"></a><span id="l95.122">                 let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l95.123"></a><span id="l95.123">                                                 .createInstance(Components</span>
<a href="#l95.124"></a><span id="l95.124">                                                 .interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l95.125"></a><span id="l95.125">                 resultConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l95.126"></a><span id="l95.126"> </span>
<a href="#l95.127"></a><span id="l95.127">                 let multistatus;</span>
<a href="#l95.128"></a><span id="l95.128">                 try {</span>
<a href="#l95.129"></a><span id="l95.129">                     let str = resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l95.130"></a><span id="l95.130" class="difflineat">@@ -1038,69 +1036,69 @@ httpHooks.prototype = {</span>
<a href="#l95.131"></a><span id="l95.131">                                          .nsIStreamLoader);</span>
<a href="#l95.132"></a><span id="l95.132"> </span>
<a href="#l95.133"></a><span id="l95.133">             cal.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l95.134"></a><span id="l95.134">         }</span>
<a href="#l95.135"></a><span id="l95.135">         return true;</span>
<a href="#l95.136"></a><span id="l95.136">     },</span>
<a href="#l95.137"></a><span id="l95.137"> </span>
<a href="#l95.138"></a><span id="l95.138">     // nsIProgressEventSink</span>
<a href="#l95.139"></a><span id="l95.139" class="difflineminus">-    onProgress: function onProgress(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l95.140"></a><span id="l95.140" class="difflineminus">-    onStatus: function onStatus(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l95.141"></a><span id="l95.141" class="difflineplus">+    onProgress: function(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l95.142"></a><span id="l95.142" class="difflineplus">+    onStatus: function(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l95.143"></a><span id="l95.143"> </span>
<a href="#l95.144"></a><span id="l95.144">     getInterface: function(aIid) {</span>
<a href="#l95.145"></a><span id="l95.145">         if (aIid.equals(Components.interfaces.nsIProgressEventSink)) {</span>
<a href="#l95.146"></a><span id="l95.146">             return this;</span>
<a href="#l95.147"></a><span id="l95.147">         } else {</span>
<a href="#l95.148"></a><span id="l95.148">             throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l95.149"></a><span id="l95.149">         }</span>
<a href="#l95.150"></a><span id="l95.150">     }</span>
<a href="#l95.151"></a><span id="l95.151"> };</span>
<a href="#l95.152"></a><span id="l95.152"> </span>
<a href="#l95.153"></a><span id="l95.153"> function fileHooks(calendar) {</span>
<a href="#l95.154"></a><span id="l95.154">     this.mCalendar = calendar;</span>
<a href="#l95.155"></a><span id="l95.155"> }</span>
<a href="#l95.156"></a><span id="l95.156"> </span>
<a href="#l95.157"></a><span id="l95.157"> fileHooks.prototype = {</span>
<a href="#l95.158"></a><span id="l95.158" class="difflineminus">-    onBeforeGet: function fH_onBeforeGet(aChannel, aForceRefresh) {</span>
<a href="#l95.159"></a><span id="l95.159" class="difflineplus">+    onBeforeGet: function(aChannel, aForceRefresh) {</span>
<a href="#l95.160"></a><span id="l95.160">         return true;</span>
<a href="#l95.161"></a><span id="l95.161">     },</span>
<a href="#l95.162"></a><span id="l95.162"> </span>
<a href="#l95.163"></a><span id="l95.163">     /**</span>
<a href="#l95.164"></a><span id="l95.164">      * @return</span>
<a href="#l95.165"></a><span id="l95.165">      *     a boolean, false if the previous data should be used (the datastore</span>
<a href="#l95.166"></a><span id="l95.166">      *     didn't change, there might be no data in this GET), true in all</span>
<a href="#l95.167"></a><span id="l95.167">      *     other cases</span>
<a href="#l95.168"></a><span id="l95.168">      */</span>
<a href="#l95.169"></a><span id="l95.169" class="difflineminus">-    onAfterGet: function fH_onAfterGet(aChannel, aForceRefresh) {</span>
<a href="#l95.170"></a><span id="l95.170" class="difflineplus">+    onAfterGet: function(aChannel, aForceRefresh) {</span>
<a href="#l95.171"></a><span id="l95.171">         let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l95.172"></a><span id="l95.172">         if (this.mtime) {</span>
<a href="#l95.173"></a><span id="l95.173">             let newMtime = filechannel.file.lastModifiedTime;</span>
<a href="#l95.174"></a><span id="l95.174">             if (this.mtime == newMtime &amp;&amp; !aForceRefresh) {</span>
<a href="#l95.175"></a><span id="l95.175">                 return false;</span>
<a href="#l95.176"></a><span id="l95.176">             } else {</span>
<a href="#l95.177"></a><span id="l95.177">                 this.mtime = newMtime;</span>
<a href="#l95.178"></a><span id="l95.178">                 return true;</span>
<a href="#l95.179"></a><span id="l95.179">             }</span>
<a href="#l95.180"></a><span id="l95.180">         } else {</span>
<a href="#l95.181"></a><span id="l95.181">             this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l95.182"></a><span id="l95.182">         return true;</span>
<a href="#l95.183"></a><span id="l95.183">         }</span>
<a href="#l95.184"></a><span id="l95.184">     },</span>
<a href="#l95.185"></a><span id="l95.185"> </span>
<a href="#l95.186"></a><span id="l95.186" class="difflineminus">-    onBeforePut: function fH_onBeforePut(aChannel) {</span>
<a href="#l95.187"></a><span id="l95.187" class="difflineplus">+    onBeforePut: function(aChannel) {</span>
<a href="#l95.188"></a><span id="l95.188">         let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l95.189"></a><span id="l95.189">         if (this.mtime &amp;&amp; this.mtime != filechannel.file.lastModifiedTime) {</span>
<a href="#l95.190"></a><span id="l95.190">             return false;</span>
<a href="#l95.191"></a><span id="l95.191">         } else {</span>
<a href="#l95.192"></a><span id="l95.192">             return true;</span>
<a href="#l95.193"></a><span id="l95.193">         }</span>
<a href="#l95.194"></a><span id="l95.194">     },</span>
<a href="#l95.195"></a><span id="l95.195"> </span>
<a href="#l95.196"></a><span id="l95.196" class="difflineminus">-    onAfterPut: function fH_onAfterPut(aChannel, aRespFunc) {</span>
<a href="#l95.197"></a><span id="l95.197" class="difflineplus">+    onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l95.198"></a><span id="l95.198">         let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l95.199"></a><span id="l95.199">         this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l95.200"></a><span id="l95.200">         aRespFunc();</span>
<a href="#l95.201"></a><span id="l95.201">         return true;</span>
<a href="#l95.202"></a><span id="l95.202">     }</span>
<a href="#l95.203"></a><span id="l95.203"> };</span>
<a href="#l95.204"></a><span id="l95.204"> </span>
<a href="#l95.205"></a><span id="l95.205"> /** Module Registration */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -56,21 +56,21 @@ calMemoryCalendar.prototype = {</span>
<a href="#l96.4"></a><span id="l96.4">     get prefChromeOverlay() {</span>
<a href="#l96.5"></a><span id="l96.5">         return null;</span>
<a href="#l96.6"></a><span id="l96.6">     },</span>
<a href="#l96.7"></a><span id="l96.7"> </span>
<a href="#l96.8"></a><span id="l96.8">     get displayName() {</span>
<a href="#l96.9"></a><span id="l96.9">         return cal.calGetString(&quot;calendar&quot;, &quot;memoryName&quot;);</span>
<a href="#l96.10"></a><span id="l96.10">     },</span>
<a href="#l96.11"></a><span id="l96.11"> </span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-    createCalendar: function mem_createCal() {</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+    createCalendar: function() {</span>
<a href="#l96.14"></a><span id="l96.14">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l96.15"></a><span id="l96.15">     },</span>
<a href="#l96.16"></a><span id="l96.16"> </span>
<a href="#l96.17"></a><span id="l96.17" class="difflineminus">-    deleteCalendar: function mem_deleteCal(calendar, listener) {</span>
<a href="#l96.18"></a><span id="l96.18" class="difflineplus">+    deleteCalendar: function(calendar, listener) {</span>
<a href="#l96.19"></a><span id="l96.19">         calendar = calendar.wrappedJSObject;</span>
<a href="#l96.20"></a><span id="l96.20">         calendar.mItems = {};</span>
<a href="#l96.21"></a><span id="l96.21">         calendar.mMetaData = new cal.calPropertyBag();</span>
<a href="#l96.22"></a><span id="l96.22"> </span>
<a href="#l96.23"></a><span id="l96.23">         try {</span>
<a href="#l96.24"></a><span id="l96.24">             listener.onDeleteCalendar(calendar, Components.results.NS_OK, null);</span>
<a href="#l96.25"></a><span id="l96.25">         } catch (ex) {</span>
<a href="#l96.26"></a><span id="l96.26">             // Don't bail out if the listener fails</span>
<a href="#l96.27"></a><span id="l96.27" class="difflineat">@@ -84,17 +84,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l96.28"></a><span id="l96.28">         }</span>
<a href="#l96.29"></a><span id="l96.29">         return this.mRelaxedMode;</span>
<a href="#l96.30"></a><span id="l96.30">     },</span>
<a href="#l96.31"></a><span id="l96.31"> </span>
<a href="#l96.32"></a><span id="l96.32">     //</span>
<a href="#l96.33"></a><span id="l96.33">     // calICalendar interface</span>
<a href="#l96.34"></a><span id="l96.34">     //</span>
<a href="#l96.35"></a><span id="l96.35"> </span>
<a href="#l96.36"></a><span id="l96.36" class="difflineminus">-    getProperty: function calMemoryCalendar_getProperty(aName) {</span>
<a href="#l96.37"></a><span id="l96.37" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l96.38"></a><span id="l96.38">         switch (aName) {</span>
<a href="#l96.39"></a><span id="l96.39">             case &quot;cache.supported&quot;:</span>
<a href="#l96.40"></a><span id="l96.40">             case &quot;requiresNetwork&quot;:</span>
<a href="#l96.41"></a><span id="l96.41">                 return false;</span>
<a href="#l96.42"></a><span id="l96.42">             case &quot;removemodes&quot;:</span>
<a href="#l96.43"></a><span id="l96.43">                 return [&quot;delete&quot;];</span>
<a href="#l96.44"></a><span id="l96.44">         }</span>
<a href="#l96.45"></a><span id="l96.45">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l96.46"></a><span id="l96.46" class="difflineat">@@ -484,40 +484,40 @@ calMemoryCalendar.prototype = {</span>
<a href="#l96.47"></a><span id="l96.47">                                          null,</span>
<a href="#l96.48"></a><span id="l96.48">                                          null);</span>
<a href="#l96.49"></a><span id="l96.49">         });</span>
<a href="#l96.50"></a><span id="l96.50">     },</span>
<a href="#l96.51"></a><span id="l96.51"> </span>
<a href="#l96.52"></a><span id="l96.52">     //</span>
<a href="#l96.53"></a><span id="l96.53">     // calIOfflineStorage interface</span>
<a href="#l96.54"></a><span id="l96.54">     //</span>
<a href="#l96.55"></a><span id="l96.55" class="difflineminus">-    addOfflineItem: function addOfflineItem(aItem, aListener) {</span>
<a href="#l96.56"></a><span id="l96.56" class="difflineplus">+    addOfflineItem: function(aItem, aListener) {</span>
<a href="#l96.57"></a><span id="l96.57">         this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l96.58"></a><span id="l96.58">         this.notifyOperationComplete(aListener,</span>
<a href="#l96.59"></a><span id="l96.59">                                      Components.results.NS_OK,</span>
<a href="#l96.60"></a><span id="l96.60">                                      Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l96.61"></a><span id="l96.61">                                      aItem.id,</span>
<a href="#l96.62"></a><span id="l96.62">                                      aItem);</span>
<a href="#l96.63"></a><span id="l96.63">     },</span>
<a href="#l96.64"></a><span id="l96.64"> </span>
<a href="#l96.65"></a><span id="l96.65" class="difflineminus">-    modifyOfflineItem: function modifyOfflineItem(aItem, aListener) {</span>
<a href="#l96.66"></a><span id="l96.66" class="difflineplus">+    modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l96.67"></a><span id="l96.67">         let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l96.68"></a><span id="l96.68">         if (oldFlag != cICL.OFFLINE_FLAG_CREATED_RECORD &amp;&amp;</span>
<a href="#l96.69"></a><span id="l96.69">             oldFlag != cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l96.70"></a><span id="l96.70">             this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l96.71"></a><span id="l96.71">         }</span>
<a href="#l96.72"></a><span id="l96.72"> </span>
<a href="#l96.73"></a><span id="l96.73">         this.notifyOperationComplete(aListener,</span>
<a href="#l96.74"></a><span id="l96.74">                                      Components.results.NS_OK,</span>
<a href="#l96.75"></a><span id="l96.75">                                      Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l96.76"></a><span id="l96.76">                                      aItem.id,</span>
<a href="#l96.77"></a><span id="l96.77">                                      aItem);</span>
<a href="#l96.78"></a><span id="l96.78">     },</span>
<a href="#l96.79"></a><span id="l96.79"> </span>
<a href="#l96.80"></a><span id="l96.80" class="difflineminus">-    deleteOfflineItem: function deleteOfflineItem(aItem, aListener) {</span>
<a href="#l96.81"></a><span id="l96.81" class="difflineplus">+    deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l96.82"></a><span id="l96.82">         let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l96.83"></a><span id="l96.83">         if (oldFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l96.84"></a><span id="l96.84">             delete this.mItems[aItem.id];</span>
<a href="#l96.85"></a><span id="l96.85">             delete this.mOfflineFlags[aItem.id];</span>
<a href="#l96.86"></a><span id="l96.86">         } else {</span>
<a href="#l96.87"></a><span id="l96.87">             this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l96.88"></a><span id="l96.88">         }</span>
<a href="#l96.89"></a><span id="l96.89"> </span>
<a href="#l96.90"></a><span id="l96.90" class="difflineat">@@ -525,44 +525,42 @@ calMemoryCalendar.prototype = {</span>
<a href="#l96.91"></a><span id="l96.91">                                      Components.results.NS_OK,</span>
<a href="#l96.92"></a><span id="l96.92">                                      Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l96.93"></a><span id="l96.93">                                      aItem.id,</span>
<a href="#l96.94"></a><span id="l96.94">                                      aItem);</span>
<a href="#l96.95"></a><span id="l96.95">         // notify observers</span>
<a href="#l96.96"></a><span id="l96.96">         this.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l96.97"></a><span id="l96.97">     },</span>
<a href="#l96.98"></a><span id="l96.98"> </span>
<a href="#l96.99"></a><span id="l96.99" class="difflineminus">-    getItemOfflineFlag: function getItemOfflineFlag(aItem, aListener) {</span>
<a href="#l96.100"></a><span id="l96.100" class="difflineplus">+    getItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l96.101"></a><span id="l96.101">         let flag = (aItem &amp;&amp; aItem.id in this.mOfflineFlags ? this.mOfflineFlags[aItem.id] : null);</span>
<a href="#l96.102"></a><span id="l96.102">         this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l96.103"></a><span id="l96.103">                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l96.104"></a><span id="l96.104">                                      null, flag);</span>
<a href="#l96.105"></a><span id="l96.105">     },</span>
<a href="#l96.106"></a><span id="l96.106"> </span>
<a href="#l96.107"></a><span id="l96.107" class="difflineminus">-    resetItemOfflineFlag: function resetItemOfflineFlag(aItem, aListener) {</span>
<a href="#l96.108"></a><span id="l96.108" class="difflineplus">+    resetItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l96.109"></a><span id="l96.109">         delete this.mOfflineFlags[aItem.id];</span>
<a href="#l96.110"></a><span id="l96.110">         this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l96.111"></a><span id="l96.111">                                      Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l96.112"></a><span id="l96.112">                                      aItem.id, aItem);</span>
<a href="#l96.113"></a><span id="l96.113">     },</span>
<a href="#l96.114"></a><span id="l96.114"> </span>
<a href="#l96.115"></a><span id="l96.115">     //</span>
<a href="#l96.116"></a><span id="l96.116">     // calISyncWriteCalendar interface</span>
<a href="#l96.117"></a><span id="l96.117">     //</span>
<a href="#l96.118"></a><span id="l96.118" class="difflineminus">-    setMetaData: function memory_setMetaData(id, value) {</span>
<a href="#l96.119"></a><span id="l96.119" class="difflineplus">+    setMetaData: function(id, value) {</span>
<a href="#l96.120"></a><span id="l96.120">         this.mMetaData.setProperty(id, value);</span>
<a href="#l96.121"></a><span id="l96.121">     },</span>
<a href="#l96.122"></a><span id="l96.122" class="difflineminus">-    deleteMetaData: function memory_deleteMetaData(id) {</span>
<a href="#l96.123"></a><span id="l96.123" class="difflineplus">+    deleteMetaData: function(id) {</span>
<a href="#l96.124"></a><span id="l96.124">         this.mMetaData.deleteProperty(id);</span>
<a href="#l96.125"></a><span id="l96.125">     },</span>
<a href="#l96.126"></a><span id="l96.126" class="difflineminus">-    getMetaData: function memory_getMetaData(id) {</span>
<a href="#l96.127"></a><span id="l96.127" class="difflineplus">+    getMetaData: function(id) {</span>
<a href="#l96.128"></a><span id="l96.128">         return this.mMetaData.getProperty(id);</span>
<a href="#l96.129"></a><span id="l96.129">     },</span>
<a href="#l96.130"></a><span id="l96.130" class="difflineminus">-    getAllMetaData: function memory_getAllMetaData(out_count,</span>
<a href="#l96.131"></a><span id="l96.131" class="difflineminus">-                                                   out_ids,</span>
<a href="#l96.132"></a><span id="l96.132" class="difflineminus">-                                                   out_values) {</span>
<a href="#l96.133"></a><span id="l96.133" class="difflineplus">+    getAllMetaData: function(out_count, out_ids, out_values) {</span>
<a href="#l96.134"></a><span id="l96.134">         this.mMetaData.getAllProperties(out_ids, out_values);</span>
<a href="#l96.135"></a><span id="l96.135">         out_count.value = out_ids.value.length;</span>
<a href="#l96.136"></a><span id="l96.136">     }</span>
<a href="#l96.137"></a><span id="l96.137"> };</span>
<a href="#l96.138"></a><span id="l96.138"> </span>
<a href="#l96.139"></a><span id="l96.139"> /** Module Registration */</span>
<a href="#l96.140"></a><span id="l96.140"> this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calMemoryCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -60,21 +60,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.4"></a><span id="l97.4">     get prefChromeOverlay() {</span>
<a href="#l97.5"></a><span id="l97.5">         return null;</span>
<a href="#l97.6"></a><span id="l97.6">     },</span>
<a href="#l97.7"></a><span id="l97.7"> </span>
<a href="#l97.8"></a><span id="l97.8">     get displayName() {</span>
<a href="#l97.9"></a><span id="l97.9">         return cal.calGetString(&quot;calendar&quot;, &quot;storageName&quot;);</span>
<a href="#l97.10"></a><span id="l97.10">     },</span>
<a href="#l97.11"></a><span id="l97.11"> </span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-    createCalendar: function cSC_createCalendar() {</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+    createCalendar: function() {</span>
<a href="#l97.14"></a><span id="l97.14">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l97.15"></a><span id="l97.15">     },</span>
<a href="#l97.16"></a><span id="l97.16"> </span>
<a href="#l97.17"></a><span id="l97.17" class="difflineminus">-    deleteCalendar: function cSC_deleteCalendar(aCalendar, listener) {</span>
<a href="#l97.18"></a><span id="l97.18" class="difflineplus">+    deleteCalendar: function(aCalendar, listener) {</span>
<a href="#l97.19"></a><span id="l97.19">         aCalendar = aCalendar.wrappedJSObject;</span>
<a href="#l97.20"></a><span id="l97.20"> </span>
<a href="#l97.21"></a><span id="l97.21">         if (this.mDeleteEventExtras) {</span>
<a href="#l97.22"></a><span id="l97.22">             for (let stmt of this.mDeleteEventExtras) {</span>
<a href="#l97.23"></a><span id="l97.23">                 try {</span>
<a href="#l97.24"></a><span id="l97.24">                     this.prepareStatement(stmt);</span>
<a href="#l97.25"></a><span id="l97.25">                     stmt.executeStep();</span>
<a href="#l97.26"></a><span id="l97.26">                 } finally {</span>
<a href="#l97.27"></a><span id="l97.27" class="difflineat">@@ -131,17 +131,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.28"></a><span id="l97.28">         }</span>
<a href="#l97.29"></a><span id="l97.29">         return this.mRelaxedMode;</span>
<a href="#l97.30"></a><span id="l97.30">     },</span>
<a href="#l97.31"></a><span id="l97.31"> </span>
<a href="#l97.32"></a><span id="l97.32">     //</span>
<a href="#l97.33"></a><span id="l97.33">     // calICalendar interface</span>
<a href="#l97.34"></a><span id="l97.34">     //</span>
<a href="#l97.35"></a><span id="l97.35"> </span>
<a href="#l97.36"></a><span id="l97.36" class="difflineminus">-    getProperty: function cSC_getProperty(aName) {</span>
<a href="#l97.37"></a><span id="l97.37" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l97.38"></a><span id="l97.38">         switch (aName) {</span>
<a href="#l97.39"></a><span id="l97.39">             case &quot;cache.supported&quot;:</span>
<a href="#l97.40"></a><span id="l97.40">                 return false;</span>
<a href="#l97.41"></a><span id="l97.41">             case &quot;requiresNetwork&quot;:</span>
<a href="#l97.42"></a><span id="l97.42">                 return false;</span>
<a href="#l97.43"></a><span id="l97.43">             case &quot;capabilities.removeModes&quot;:</span>
<a href="#l97.44"></a><span id="l97.44">                 return [&quot;delete&quot;];</span>
<a href="#l97.45"></a><span id="l97.45">         }</span>
<a href="#l97.46"></a><span id="l97.46" class="difflineat">@@ -184,17 +184,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.47"></a><span id="l97.47"> </span>
<a href="#l97.48"></a><span id="l97.48">         return uri;</span>
<a href="#l97.49"></a><span id="l97.49">     },</span>
<a href="#l97.50"></a><span id="l97.50"> </span>
<a href="#l97.51"></a><span id="l97.51">     /**</span>
<a href="#l97.52"></a><span id="l97.52">      * Initialize the Database. This should only be called from the uri or id</span>
<a href="#l97.53"></a><span id="l97.53">      * setter and requires those two attributes to be set.</span>
<a href="#l97.54"></a><span id="l97.54">      */</span>
<a href="#l97.55"></a><span id="l97.55" class="difflineminus">-    prepareInitDB: function cSC_prepareInitDB() {</span>
<a href="#l97.56"></a><span id="l97.56" class="difflineplus">+    prepareInitDB: function() {</span>
<a href="#l97.57"></a><span id="l97.57">         if (this.uri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l97.58"></a><span id="l97.58">             let fileURL = this.uri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l97.59"></a><span id="l97.59">             if (!fileURL) {</span>
<a href="#l97.60"></a><span id="l97.60">                 throw new Components.Exception(&quot;Invalid file&quot;, Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l97.61"></a><span id="l97.61">             }</span>
<a href="#l97.62"></a><span id="l97.62">             // open the database</span>
<a href="#l97.63"></a><span id="l97.63">             this.mDB = Services.storage.openDatabase(fileURL.file);</span>
<a href="#l97.64"></a><span id="l97.64">             this.mDB.executeSimpleSQL(&quot;PRAGMA journal_mode=WAL&quot;);</span>
<a href="#l97.65"></a><span id="l97.65" class="difflineat">@@ -355,69 +355,69 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.66"></a><span id="l97.66">         } else {</span>
<a href="#l97.67"></a><span id="l97.67">             throw new Components.Exception(&quot;Invalid Scheme &quot; + this.uri.spec);</span>
<a href="#l97.68"></a><span id="l97.68">         }</span>
<a href="#l97.69"></a><span id="l97.69"> </span>
<a href="#l97.70"></a><span id="l97.70">         this.initDB();</span>
<a href="#l97.71"></a><span id="l97.71">         Services.obs.addObserver(this, &quot;profile-before-change&quot;, false);</span>
<a href="#l97.72"></a><span id="l97.72">     },</span>
<a href="#l97.73"></a><span id="l97.73"> </span>
<a href="#l97.74"></a><span id="l97.74" class="difflineminus">-    observe: function cSC_observe(aSubject, aTopic, aData) {</span>
<a href="#l97.75"></a><span id="l97.75" class="difflineplus">+    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l97.76"></a><span id="l97.76">         if (aTopic == &quot;profile-before-change&quot;) {</span>
<a href="#l97.77"></a><span id="l97.77">             Services.obs.removeObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l97.78"></a><span id="l97.78">             this.shutdownDB();</span>
<a href="#l97.79"></a><span id="l97.79">         }</span>
<a href="#l97.80"></a><span id="l97.80">     },</span>
<a href="#l97.81"></a><span id="l97.81"> </span>
<a href="#l97.82"></a><span id="l97.82">     /**</span>
<a href="#l97.83"></a><span id="l97.83">      * Takes care of necessary preparations for most of our statements.</span>
<a href="#l97.84"></a><span id="l97.84">      *</span>
<a href="#l97.85"></a><span id="l97.85">      * @param aStmt         The statement to prepare.</span>
<a href="#l97.86"></a><span id="l97.86">      */</span>
<a href="#l97.87"></a><span id="l97.87" class="difflineminus">-    prepareStatement: function cSC_prepareStatement(aStmt) {</span>
<a href="#l97.88"></a><span id="l97.88" class="difflineplus">+    prepareStatement: function(aStmt) {</span>
<a href="#l97.89"></a><span id="l97.89">         try {</span>
<a href="#l97.90"></a><span id="l97.90">             aStmt.params.cal_id = this.id;</span>
<a href="#l97.91"></a><span id="l97.91">             this.mLastStatement = aStmt;</span>
<a href="#l97.92"></a><span id="l97.92">         } catch (e) {</span>
<a href="#l97.93"></a><span id="l97.93">             this.logError(&quot;prepareStatement exception&quot;, e);</span>
<a href="#l97.94"></a><span id="l97.94">         }</span>
<a href="#l97.95"></a><span id="l97.95">     },</span>
<a href="#l97.96"></a><span id="l97.96"> </span>
<a href="#l97.97"></a><span id="l97.97">     /**</span>
<a href="#l97.98"></a><span id="l97.98">      * Executes a statement using an item as a parameter.</span>
<a href="#l97.99"></a><span id="l97.99">      *</span>
<a href="#l97.100"></a><span id="l97.100">      * @param aStmt         The statement to execute.</span>
<a href="#l97.101"></a><span id="l97.101">      * @param aIdParam      The name of the parameter refering to the item id.</span>
<a href="#l97.102"></a><span id="l97.102">      * @param aId           The id of the item.</span>
<a href="#l97.103"></a><span id="l97.103">      */</span>
<a href="#l97.104"></a><span id="l97.104" class="difflineminus">-    executeItemStatement: function cSC_executeItemStatement(aStmt, aIdParam, aId) {</span>
<a href="#l97.105"></a><span id="l97.105" class="difflineplus">+    executeItemStatement: function(aStmt, aIdParam, aId) {</span>
<a href="#l97.106"></a><span id="l97.106">         try {</span>
<a href="#l97.107"></a><span id="l97.107">             aStmt.params.cal_id = this.id;</span>
<a href="#l97.108"></a><span id="l97.108">             aStmt.params[aIdParam] = aId;</span>
<a href="#l97.109"></a><span id="l97.109">             aStmt.executeStep();</span>
<a href="#l97.110"></a><span id="l97.110">         } catch (e) {</span>
<a href="#l97.111"></a><span id="l97.111">             this.logError(&quot;executeItemStatement exception&quot;, e);</span>
<a href="#l97.112"></a><span id="l97.112">             throw e;</span>
<a href="#l97.113"></a><span id="l97.113">         } finally {</span>
<a href="#l97.114"></a><span id="l97.114">             aStmt.reset();</span>
<a href="#l97.115"></a><span id="l97.115">         }</span>
<a href="#l97.116"></a><span id="l97.116">     },</span>
<a href="#l97.117"></a><span id="l97.117"> </span>
<a href="#l97.118"></a><span id="l97.118" class="difflineminus">-    refresh: function cSC_refresh() {</span>
<a href="#l97.119"></a><span id="l97.119" class="difflineplus">+    refresh: function() {</span>
<a href="#l97.120"></a><span id="l97.120">         // no-op</span>
<a href="#l97.121"></a><span id="l97.121">     },</span>
<a href="#l97.122"></a><span id="l97.122"> </span>
<a href="#l97.123"></a><span id="l97.123">     // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l97.124"></a><span id="l97.124" class="difflineminus">-    addItem: function cSC_addItem(aItem, aListener) {</span>
<a href="#l97.125"></a><span id="l97.125" class="difflineplus">+    addItem: function(aItem, aListener) {</span>
<a href="#l97.126"></a><span id="l97.126">         let newItem = aItem.clone();</span>
<a href="#l97.127"></a><span id="l97.127">         return this.adoptItem(newItem, aListener);</span>
<a href="#l97.128"></a><span id="l97.128">     },</span>
<a href="#l97.129"></a><span id="l97.129"> </span>
<a href="#l97.130"></a><span id="l97.130">     // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l97.131"></a><span id="l97.131" class="difflineminus">-    adoptItem: function cSC_adoptItem(aItem, aListener) {</span>
<a href="#l97.132"></a><span id="l97.132" class="difflineplus">+    adoptItem: function(aItem, aListener) {</span>
<a href="#l97.133"></a><span id="l97.133">         if (this.readOnly) {</span>
<a href="#l97.134"></a><span id="l97.134">             this.notifyOperationComplete(aListener,</span>
<a href="#l97.135"></a><span id="l97.135">                                          Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l97.136"></a><span id="l97.136">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l97.137"></a><span id="l97.137">                                          null,</span>
<a href="#l97.138"></a><span id="l97.138">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l97.139"></a><span id="l97.139">             return;</span>
<a href="#l97.140"></a><span id="l97.140">         }</span>
<a href="#l97.141"></a><span id="l97.141" class="difflineat">@@ -460,32 +460,32 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.142"></a><span id="l97.142">                                      aItem);</span>
<a href="#l97.143"></a><span id="l97.143"> </span>
<a href="#l97.144"></a><span id="l97.144">         // notify observers</span>
<a href="#l97.145"></a><span id="l97.145">         this.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l97.146"></a><span id="l97.146">     },</span>
<a href="#l97.147"></a><span id="l97.147"> </span>
<a href="#l97.148"></a><span id="l97.148">     // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l97.149"></a><span id="l97.149">     // Actually uses doModifyItem</span>
<a href="#l97.150"></a><span id="l97.150" class="difflineminus">-    modifyItem: function cSC_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l97.151"></a><span id="l97.151" class="difflineplus">+    modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l97.152"></a><span id="l97.152">         let self = this;</span>
<a href="#l97.153"></a><span id="l97.153"> </span>
<a href="#l97.154"></a><span id="l97.154">         // HACK Just modifying the item would clear the offline flag, we need to</span>
<a href="#l97.155"></a><span id="l97.155">         // retrieve the flag and pass it to the real modify function.</span>
<a href="#l97.156"></a><span id="l97.156">         let offlineJournalFlagListener = {</span>
<a href="#l97.157"></a><span id="l97.157">             onGetResult: function(calendar, status, opType, id, detail) {</span>
<a href="#l97.158"></a><span id="l97.158">             },</span>
<a href="#l97.159"></a><span id="l97.159">             onOperationComplete: function(opcalendar, status, opType, id, offlineFlag) {</span>
<a href="#l97.160"></a><span id="l97.160">                 self.doModifyItem(aNewItem, aOldItem, aListener, offlineFlag);</span>
<a href="#l97.161"></a><span id="l97.161">             }</span>
<a href="#l97.162"></a><span id="l97.162">         };</span>
<a href="#l97.163"></a><span id="l97.163">         this.getItemOfflineFlag(aOldItem, offlineJournalFlagListener);</span>
<a href="#l97.164"></a><span id="l97.164">     },</span>
<a href="#l97.165"></a><span id="l97.165"> </span>
<a href="#l97.166"></a><span id="l97.166" class="difflineminus">-    doModifyItem: function cSC_doModifyItem(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l97.167"></a><span id="l97.167" class="difflineplus">+    doModifyItem: function(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l97.168"></a><span id="l97.168">         let oldOfflineFlag = offlineFlag;</span>
<a href="#l97.169"></a><span id="l97.169">         if (this.readOnly) {</span>
<a href="#l97.170"></a><span id="l97.170">             this.notifyOperationComplete(aListener,</span>
<a href="#l97.171"></a><span id="l97.171">                                          Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l97.172"></a><span id="l97.172">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l97.173"></a><span id="l97.173">                                          null,</span>
<a href="#l97.174"></a><span id="l97.174">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l97.175"></a><span id="l97.175">             return null;</span>
<a href="#l97.176"></a><span id="l97.176" class="difflineat">@@ -571,17 +571,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.177"></a><span id="l97.177">                                      modifiedItem);</span>
<a href="#l97.178"></a><span id="l97.178"> </span>
<a href="#l97.179"></a><span id="l97.179">         // notify observers</span>
<a href="#l97.180"></a><span id="l97.180">         this.observers.notify(&quot;onModifyItem&quot;, [modifiedItem, aOldItem]);</span>
<a href="#l97.181"></a><span id="l97.181">         return null;</span>
<a href="#l97.182"></a><span id="l97.182">     },</span>
<a href="#l97.183"></a><span id="l97.183"> </span>
<a href="#l97.184"></a><span id="l97.184">     // void deleteItem( in string id, in calIOperationListener aListener );</span>
<a href="#l97.185"></a><span id="l97.185" class="difflineminus">-    deleteItem: function cSC_deleteItem(aItem, aListener) {</span>
<a href="#l97.186"></a><span id="l97.186" class="difflineplus">+    deleteItem: function(aItem, aListener) {</span>
<a href="#l97.187"></a><span id="l97.187">         if (this.readOnly) {</span>
<a href="#l97.188"></a><span id="l97.188">             this.notifyOperationComplete(aListener,</span>
<a href="#l97.189"></a><span id="l97.189">                                          Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l97.190"></a><span id="l97.190">                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l97.191"></a><span id="l97.191">                                          null,</span>
<a href="#l97.192"></a><span id="l97.192">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l97.193"></a><span id="l97.193">             return;</span>
<a href="#l97.194"></a><span id="l97.194">         }</span>
<a href="#l97.195"></a><span id="l97.195" class="difflineat">@@ -609,17 +609,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.196"></a><span id="l97.196">                                      aItem.id,</span>
<a href="#l97.197"></a><span id="l97.197">                                      aItem);</span>
<a href="#l97.198"></a><span id="l97.198"> </span>
<a href="#l97.199"></a><span id="l97.199">         // notify observers</span>
<a href="#l97.200"></a><span id="l97.200">         this.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l97.201"></a><span id="l97.201">     },</span>
<a href="#l97.202"></a><span id="l97.202"> </span>
<a href="#l97.203"></a><span id="l97.203">     // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l97.204"></a><span id="l97.204" class="difflineminus">-    getItem: function cSC_getItem(aId, aListener) {</span>
<a href="#l97.205"></a><span id="l97.205" class="difflineplus">+    getItem: function(aId, aListener) {</span>
<a href="#l97.206"></a><span id="l97.206">         if (!aListener) {</span>
<a href="#l97.207"></a><span id="l97.207">             return;</span>
<a href="#l97.208"></a><span id="l97.208">         }</span>
<a href="#l97.209"></a><span id="l97.209"> </span>
<a href="#l97.210"></a><span id="l97.210">         let item = this.getItemById(aId);</span>
<a href="#l97.211"></a><span id="l97.211">         if (!item) {</span>
<a href="#l97.212"></a><span id="l97.212">             // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l97.213"></a><span id="l97.213">             this.notifyOperationComplete(aListener,</span>
<a href="#l97.214"></a><span id="l97.214" class="difflineat">@@ -654,24 +654,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.215"></a><span id="l97.215">                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l97.216"></a><span id="l97.216">                                      aId,</span>
<a href="#l97.217"></a><span id="l97.217">                                      null);</span>
<a href="#l97.218"></a><span id="l97.218">     },</span>
<a href="#l97.219"></a><span id="l97.219"> </span>
<a href="#l97.220"></a><span id="l97.220">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l97.221"></a><span id="l97.221">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l97.222"></a><span id="l97.222">     //                in calIOperationListener aListener );</span>
<a href="#l97.223"></a><span id="l97.223" class="difflineminus">-    getItems: function cSC_getItems(aItemFilter, aCount,</span>
<a href="#l97.224"></a><span id="l97.224" class="difflineminus">-                                    aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l97.225"></a><span id="l97.225" class="difflineplus">+    getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l97.226"></a><span id="l97.226">         cal.postPone(() =&gt; {</span>
<a href="#l97.227"></a><span id="l97.227">             this.getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener);</span>
<a href="#l97.228"></a><span id="l97.228">         });</span>
<a href="#l97.229"></a><span id="l97.229">     },</span>
<a href="#l97.230"></a><span id="l97.230" class="difflineminus">-    getItems_: function cSC_getItems_(aItemFilter, aCount,</span>
<a href="#l97.231"></a><span id="l97.231" class="difflineminus">-                                      aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l97.232"></a><span id="l97.232" class="difflineplus">+    getItems_: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l97.233"></a><span id="l97.233">         if (!aListener) {</span>
<a href="#l97.234"></a><span id="l97.234">             return;</span>
<a href="#l97.235"></a><span id="l97.235">         }</span>
<a href="#l97.236"></a><span id="l97.236"> </span>
<a href="#l97.237"></a><span id="l97.237">         let self = this;</span>
<a href="#l97.238"></a><span id="l97.238"> </span>
<a href="#l97.239"></a><span id="l97.239">         let startTime = -0x7fffffffffffffff;</span>
<a href="#l97.240"></a><span id="l97.240">         // endTime needs to be the max value a PRTime can be</span>
<a href="#l97.241"></a><span id="l97.241" class="difflineat">@@ -937,17 +935,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.242"></a><span id="l97.242">         // and finish</span>
<a href="#l97.243"></a><span id="l97.243">         this.notifyOperationComplete(aListener,</span>
<a href="#l97.244"></a><span id="l97.244">                                      Components.results.NS_OK,</span>
<a href="#l97.245"></a><span id="l97.245">                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l97.246"></a><span id="l97.246">                                      null,</span>
<a href="#l97.247"></a><span id="l97.247">                                      null);</span>
<a href="#l97.248"></a><span id="l97.248">     },</span>
<a href="#l97.249"></a><span id="l97.249"> </span>
<a href="#l97.250"></a><span id="l97.250" class="difflineminus">-    getItemOfflineFlag: function cSC_getOfflineJournalFlag(aItem, aListener) {</span>
<a href="#l97.251"></a><span id="l97.251" class="difflineplus">+    getItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l97.252"></a><span id="l97.252">         let flag = null;</span>
<a href="#l97.253"></a><span id="l97.253">         if (!aItem) {</span>
<a href="#l97.254"></a><span id="l97.254">             // It is possible that aItem can be null, flag provided should be null in this case</span>
<a href="#l97.255"></a><span id="l97.255">             aListener.onOperationComplete(this, Components.results.NS_OK,</span>
<a href="#l97.256"></a><span id="l97.256">                                                Components.interfaces.calIOperationListener.GET, null, flag);</span>
<a href="#l97.257"></a><span id="l97.257">         } else {</span>
<a href="#l97.258"></a><span id="l97.258">             let aID = aItem.id;</span>
<a href="#l97.259"></a><span id="l97.259">             let self = this;</span>
<a href="#l97.260"></a><span id="l97.260" class="difflineat">@@ -973,17 +971,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.261"></a><span id="l97.261">             } else if (cal.isToDo(aItem)) {</span>
<a href="#l97.262"></a><span id="l97.262">                 this.prepareStatement(this.mSelectTodo);</span>
<a href="#l97.263"></a><span id="l97.263">                 this.mSelectTodo.params.id = aID;</span>
<a href="#l97.264"></a><span id="l97.264">                 this.mSelectTodo.executeAsync(listener);</span>
<a href="#l97.265"></a><span id="l97.265">             }</span>
<a href="#l97.266"></a><span id="l97.266">         }</span>
<a href="#l97.267"></a><span id="l97.267">     },</span>
<a href="#l97.268"></a><span id="l97.268"> </span>
<a href="#l97.269"></a><span id="l97.269" class="difflineminus">-    setOfflineJournalFlag: function cSC_setOfflineJournalFlag(aItem, flag) {</span>
<a href="#l97.270"></a><span id="l97.270" class="difflineplus">+    setOfflineJournalFlag: function(aItem, flag) {</span>
<a href="#l97.271"></a><span id="l97.271">         let aID = aItem.id;</span>
<a href="#l97.272"></a><span id="l97.272">         if (cal.isEvent(aItem)) {</span>
<a href="#l97.273"></a><span id="l97.273">             this.prepareStatement(this.mEditEventOfflineFlag);</span>
<a href="#l97.274"></a><span id="l97.274">             this.mEditEventOfflineFlag.params.id = aID;</span>
<a href="#l97.275"></a><span id="l97.275">             this.mEditEventOfflineFlag.params.offline_journal = flag || null;</span>
<a href="#l97.276"></a><span id="l97.276">             try {</span>
<a href="#l97.277"></a><span id="l97.277">                 this.mEditEventOfflineFlag.executeStep();</span>
<a href="#l97.278"></a><span id="l97.278">             } catch (e) {</span>
<a href="#l97.279"></a><span id="l97.279" class="difflineat">@@ -1083,17 +1081,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.280"></a><span id="l97.280"> </span>
<a href="#l97.281"></a><span id="l97.281">     //</span>
<a href="#l97.282"></a><span id="l97.282">     // database handling</span>
<a href="#l97.283"></a><span id="l97.283">     //</span>
<a href="#l97.284"></a><span id="l97.284"> </span>
<a href="#l97.285"></a><span id="l97.285">     // database initialization</span>
<a href="#l97.286"></a><span id="l97.286">     // assumes mDB is valid</span>
<a href="#l97.287"></a><span id="l97.287"> </span>
<a href="#l97.288"></a><span id="l97.288" class="difflineminus">-    initDB: function cSC_initDB() {</span>
<a href="#l97.289"></a><span id="l97.289" class="difflineplus">+    initDB: function() {</span>
<a href="#l97.290"></a><span id="l97.290">         cal.ASSERT(this.mDB, &quot;Database has not been opened!&quot;, true);</span>
<a href="#l97.291"></a><span id="l97.291"> </span>
<a href="#l97.292"></a><span id="l97.292">         try {</span>
<a href="#l97.293"></a><span id="l97.293">             this.mSelectEvent = this.mDB.createStatement(</span>
<a href="#l97.294"></a><span id="l97.294">                 &quot;SELECT * FROM cal_events &quot; +</span>
<a href="#l97.295"></a><span id="l97.295">                 &quot;WHERE id = :id AND cal_id = :cal_id &quot; +</span>
<a href="#l97.296"></a><span id="l97.296">                 &quot; AND recurrence_id IS NULL &quot; +</span>
<a href="#l97.297"></a><span id="l97.297">                 &quot;LIMIT 1&quot;</span>
<a href="#l97.298"></a><span id="l97.298" class="difflineat">@@ -1424,17 +1422,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.299"></a><span id="l97.299">                 &quot;DELETE FROM cal_metadata&quot; +</span>
<a href="#l97.300"></a><span id="l97.300">                 &quot; WHERE cal_id = :cal_id&quot;</span>
<a href="#l97.301"></a><span id="l97.301">                 );</span>
<a href="#l97.302"></a><span id="l97.302">         } catch (e) {</span>
<a href="#l97.303"></a><span id="l97.303">             this.logError(&quot;Error initializing statements.&quot;, e);</span>
<a href="#l97.304"></a><span id="l97.304">         }</span>
<a href="#l97.305"></a><span id="l97.305">     },</span>
<a href="#l97.306"></a><span id="l97.306"> </span>
<a href="#l97.307"></a><span id="l97.307" class="difflineminus">-    shutdownDB: function cSC_shutdownDB() {</span>
<a href="#l97.308"></a><span id="l97.308" class="difflineplus">+    shutdownDB: function() {</span>
<a href="#l97.309"></a><span id="l97.309">         try {</span>
<a href="#l97.310"></a><span id="l97.310">             if (this.mDeleteAlarms) { this.mDeleteAlarms.finalize(); }</span>
<a href="#l97.311"></a><span id="l97.311">             if (this.mDeleteAllEvents) { this.mDeleteAllEvents.finalize(); }</span>
<a href="#l97.312"></a><span id="l97.312">             if (this.mDeleteAllMetaData) { this.mDeleteAllMetaData.finalize(); }</span>
<a href="#l97.313"></a><span id="l97.313">             if (this.mDeleteAllTodos) { this.mDeleteAllTodos.finalize(); }</span>
<a href="#l97.314"></a><span id="l97.314">             if (this.mDeleteAttachments) { this.mDeleteAttachments.finalize(); }</span>
<a href="#l97.315"></a><span id="l97.315">             if (this.mDeleteAttendees) { this.mDeleteAttendees.finalize(); }</span>
<a href="#l97.316"></a><span id="l97.316">             if (this.mDeleteEvent) { this.mDeleteEvent.finalize(); }</span>
<a href="#l97.317"></a><span id="l97.317" class="difflineat">@@ -1489,17 +1487,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.318"></a><span id="l97.318">     },</span>
<a href="#l97.319"></a><span id="l97.319"> </span>
<a href="#l97.320"></a><span id="l97.320">     //</span>
<a href="#l97.321"></a><span id="l97.321">     // database reading functions</span>
<a href="#l97.322"></a><span id="l97.322">     //</span>
<a href="#l97.323"></a><span id="l97.323"> </span>
<a href="#l97.324"></a><span id="l97.324">     // read in the common ItemBase attributes from aDBRow, and stick</span>
<a href="#l97.325"></a><span id="l97.325">     // them on item</span>
<a href="#l97.326"></a><span id="l97.326" class="difflineminus">-    getItemBaseFromRow: function cSC_getItemBaseFromRow(row, flags, item) {</span>
<a href="#l97.327"></a><span id="l97.327" class="difflineplus">+    getItemBaseFromRow: function(row, flags, item) {</span>
<a href="#l97.328"></a><span id="l97.328">         item.calendar = this.superCalendar;</span>
<a href="#l97.329"></a><span id="l97.329">         item.id = row.id;</span>
<a href="#l97.330"></a><span id="l97.330">         if (row.title) {</span>
<a href="#l97.331"></a><span id="l97.331">             item.title = row.title;</span>
<a href="#l97.332"></a><span id="l97.332">         }</span>
<a href="#l97.333"></a><span id="l97.333">         if (row.priority) {</span>
<a href="#l97.334"></a><span id="l97.334">             item.priority = row.priority;</span>
<a href="#l97.335"></a><span id="l97.335">         }</span>
<a href="#l97.336"></a><span id="l97.336" class="difflineat">@@ -1532,30 +1530,30 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.337"></a><span id="l97.337"> </span>
<a href="#l97.338"></a><span id="l97.338">         // This must be done last because the setting of any other property</span>
<a href="#l97.339"></a><span id="l97.339">         // after this would overwrite it again.</span>
<a href="#l97.340"></a><span id="l97.340">         if (row.last_modified) {</span>
<a href="#l97.341"></a><span id="l97.341">             item.setProperty(&quot;LAST-MODIFIED&quot;, newDateTime(row.last_modified, &quot;UTC&quot;));</span>
<a href="#l97.342"></a><span id="l97.342">         }</span>
<a href="#l97.343"></a><span id="l97.343">     },</span>
<a href="#l97.344"></a><span id="l97.344"> </span>
<a href="#l97.345"></a><span id="l97.345" class="difflineminus">-    cacheItem: function cSC_cacheItem(item) {</span>
<a href="#l97.346"></a><span id="l97.346" class="difflineplus">+    cacheItem: function(item) {</span>
<a href="#l97.347"></a><span id="l97.347">         this.mItemCache[item.id] = item;</span>
<a href="#l97.348"></a><span id="l97.348">         if (item.recurrenceInfo) {</span>
<a href="#l97.349"></a><span id="l97.349">             if (cal.isEvent(item)) {</span>
<a href="#l97.350"></a><span id="l97.350">                 this.mRecEventCache[item.id] = item;</span>
<a href="#l97.351"></a><span id="l97.351">             } else {</span>
<a href="#l97.352"></a><span id="l97.352">                 this.mRecTodoCache[item.id] = item;</span>
<a href="#l97.353"></a><span id="l97.353">             }</span>
<a href="#l97.354"></a><span id="l97.354">         }</span>
<a href="#l97.355"></a><span id="l97.355">     },</span>
<a href="#l97.356"></a><span id="l97.356"> </span>
<a href="#l97.357"></a><span id="l97.357">     mRecEventCacheOfflineFlags: {},</span>
<a href="#l97.358"></a><span id="l97.358">     mRecTodoCacheOfflineFlags: {},</span>
<a href="#l97.359"></a><span id="l97.359" class="difflineminus">-    assureRecurringItemCaches: function cSC_assureRecurringItemCaches() {</span>
<a href="#l97.360"></a><span id="l97.360" class="difflineplus">+    assureRecurringItemCaches: function() {</span>
<a href="#l97.361"></a><span id="l97.361">         if (this.mRecItemCacheInited) {</span>
<a href="#l97.362"></a><span id="l97.362">             return;</span>
<a href="#l97.363"></a><span id="l97.363">         }</span>
<a href="#l97.364"></a><span id="l97.364">         // build up recurring event and todo cache with its offline flags,</span>
<a href="#l97.365"></a><span id="l97.365">         // because we need that on every query: for recurring items, we need to</span>
<a href="#l97.366"></a><span id="l97.366">         // query database-wide.. yuck</span>
<a href="#l97.367"></a><span id="l97.367"> </span>
<a href="#l97.368"></a><span id="l97.368">         try {</span>
<a href="#l97.369"></a><span id="l97.369" class="difflineat">@@ -1585,17 +1583,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.370"></a><span id="l97.370">         } finally {</span>
<a href="#l97.371"></a><span id="l97.371">             this.mSelectTodosWithRecurrence.reset();</span>
<a href="#l97.372"></a><span id="l97.372">         }</span>
<a href="#l97.373"></a><span id="l97.373"> </span>
<a href="#l97.374"></a><span id="l97.374">         this.mRecItemCacheInited = true;</span>
<a href="#l97.375"></a><span id="l97.375">     },</span>
<a href="#l97.376"></a><span id="l97.376"> </span>
<a href="#l97.377"></a><span id="l97.377">     // xxx todo: consider removing flags parameter</span>
<a href="#l97.378"></a><span id="l97.378" class="difflineminus">-    getEventFromRow: function cSC_getEventFromRow(row, flags, isException) {</span>
<a href="#l97.379"></a><span id="l97.379" class="difflineplus">+    getEventFromRow: function(row, flags, isException) {</span>
<a href="#l97.380"></a><span id="l97.380">         let item;</span>
<a href="#l97.381"></a><span id="l97.381">         if (!isException) { // only parent items are cached</span>
<a href="#l97.382"></a><span id="l97.382">             item = this.mItemCache[row.id];</span>
<a href="#l97.383"></a><span id="l97.383">             if (item) {</span>
<a href="#l97.384"></a><span id="l97.384">                 return item;</span>
<a href="#l97.385"></a><span id="l97.385">             }</span>
<a href="#l97.386"></a><span id="l97.386">         }</span>
<a href="#l97.387"></a><span id="l97.387"> </span>
<a href="#l97.388"></a><span id="l97.388" class="difflineat">@@ -1621,17 +1619,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.389"></a><span id="l97.389"> </span>
<a href="#l97.390"></a><span id="l97.390">         if (!isException) { // keep exceptions modifyable to set the parentItem</span>
<a href="#l97.391"></a><span id="l97.391">             item.makeImmutable();</span>
<a href="#l97.392"></a><span id="l97.392">             this.cacheItem(item);</span>
<a href="#l97.393"></a><span id="l97.393">         }</span>
<a href="#l97.394"></a><span id="l97.394">         return item;</span>
<a href="#l97.395"></a><span id="l97.395">     },</span>
<a href="#l97.396"></a><span id="l97.396"> </span>
<a href="#l97.397"></a><span id="l97.397" class="difflineminus">-    getTodoFromRow: function cSC_getTodoFromRow(row, flags, isException) {</span>
<a href="#l97.398"></a><span id="l97.398" class="difflineplus">+    getTodoFromRow: function(row, flags, isException) {</span>
<a href="#l97.399"></a><span id="l97.399">         let item;</span>
<a href="#l97.400"></a><span id="l97.400">         if (!isException) { // only parent items are cached</span>
<a href="#l97.401"></a><span id="l97.401">             item = this.mItemCache[row.id];</span>
<a href="#l97.402"></a><span id="l97.402">             if (item) {</span>
<a href="#l97.403"></a><span id="l97.403">                 return item;</span>
<a href="#l97.404"></a><span id="l97.404">             }</span>
<a href="#l97.405"></a><span id="l97.405">         }</span>
<a href="#l97.406"></a><span id="l97.406"> </span>
<a href="#l97.407"></a><span id="l97.407" class="difflineat">@@ -1665,17 +1663,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.408"></a><span id="l97.408">     },</span>
<a href="#l97.409"></a><span id="l97.409"> </span>
<a href="#l97.410"></a><span id="l97.410">     // after we get the base item, we need to check if we need to pull in</span>
<a href="#l97.411"></a><span id="l97.411">     // any extra data from other tables.  We do that here.</span>
<a href="#l97.412"></a><span id="l97.412"> </span>
<a href="#l97.413"></a><span id="l97.413">     // We used to use mDBTwo for this, so this can be run while a</span>
<a href="#l97.414"></a><span id="l97.414">     // select is executing but this no longer seems to be required.</span>
<a href="#l97.415"></a><span id="l97.415"> </span>
<a href="#l97.416"></a><span id="l97.416" class="difflineminus">-    getAdditionalDataForItem: function cSC_getAdditionalDataForItem(item, flags) {</span>
<a href="#l97.417"></a><span id="l97.417" class="difflineplus">+    getAdditionalDataForItem: function(item, flags) {</span>
<a href="#l97.418"></a><span id="l97.418">         // This is needed to keep the modification time intact.</span>
<a href="#l97.419"></a><span id="l97.419">         let savedLastModifiedTime = item.lastModifiedTime;</span>
<a href="#l97.420"></a><span id="l97.420"> </span>
<a href="#l97.421"></a><span id="l97.421">         if (flags &amp; CAL_ITEM_FLAG.HAS_ATTENDEES) {</span>
<a href="#l97.422"></a><span id="l97.422">             let selectItem = null;</span>
<a href="#l97.423"></a><span id="l97.423">             if (item.recurrenceId == null) {</span>
<a href="#l97.424"></a><span id="l97.424">                 selectItem = this.mSelectAttendeesForItem;</span>
<a href="#l97.425"></a><span id="l97.425">             } else {</span>
<a href="#l97.426"></a><span id="l97.426" class="difflineat">@@ -1875,17 +1873,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.427"></a><span id="l97.427">                 selectAlarm.reset();</span>
<a href="#l97.428"></a><span id="l97.428">             }</span>
<a href="#l97.429"></a><span id="l97.429">         }</span>
<a href="#l97.430"></a><span id="l97.430"> </span>
<a href="#l97.431"></a><span id="l97.431">         // Restore the saved modification time</span>
<a href="#l97.432"></a><span id="l97.432">         item.setProperty(&quot;LAST-MODIFIED&quot;, savedLastModifiedTime);</span>
<a href="#l97.433"></a><span id="l97.433">     },</span>
<a href="#l97.434"></a><span id="l97.434"> </span>
<a href="#l97.435"></a><span id="l97.435" class="difflineminus">-    getRecurrenceItemFromRow: function cSC_getRecurrenceItemFromRow(row, item) {</span>
<a href="#l97.436"></a><span id="l97.436" class="difflineplus">+    getRecurrenceItemFromRow: function(row, item) {</span>
<a href="#l97.437"></a><span id="l97.437">         let prop = cal.getIcsService().createIcalPropertyFromString(row.icalString);</span>
<a href="#l97.438"></a><span id="l97.438">         switch (prop.propertyName) {</span>
<a href="#l97.439"></a><span id="l97.439">             case &quot;RDATE&quot;:</span>
<a href="#l97.440"></a><span id="l97.440">             case &quot;EXDATE&quot;:</span>
<a href="#l97.441"></a><span id="l97.441">                 ritem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l97.442"></a><span id="l97.442">                                   .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l97.443"></a><span id="l97.443">                 break;</span>
<a href="#l97.444"></a><span id="l97.444">             case &quot;RRULE&quot;:</span>
<a href="#l97.445"></a><span id="l97.445" class="difflineat">@@ -1898,17 +1896,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.446"></a><span id="l97.446"> </span>
<a href="#l97.447"></a><span id="l97.447">         ritem.icalProperty = prop;</span>
<a href="#l97.448"></a><span id="l97.448">         return ritem;</span>
<a href="#l97.449"></a><span id="l97.449">     },</span>
<a href="#l97.450"></a><span id="l97.450"> </span>
<a href="#l97.451"></a><span id="l97.451">     //</span>
<a href="#l97.452"></a><span id="l97.452">     // get item from db or from cache with given iid</span>
<a href="#l97.453"></a><span id="l97.453">     //</span>
<a href="#l97.454"></a><span id="l97.454" class="difflineminus">-    getItemById: function cSC_getItemById(aID) {</span>
<a href="#l97.455"></a><span id="l97.455" class="difflineplus">+    getItemById: function(aID) {</span>
<a href="#l97.456"></a><span id="l97.456">         this.assureRecurringItemCaches();</span>
<a href="#l97.457"></a><span id="l97.457"> </span>
<a href="#l97.458"></a><span id="l97.458">         // cached?</span>
<a href="#l97.459"></a><span id="l97.459">         let item = this.mItemCache[aID];</span>
<a href="#l97.460"></a><span id="l97.460">         if (item) {</span>
<a href="#l97.461"></a><span id="l97.461">             return item;</span>
<a href="#l97.462"></a><span id="l97.462">         }</span>
<a href="#l97.463"></a><span id="l97.463"> </span>
<a href="#l97.464"></a><span id="l97.464" class="difflineat">@@ -1945,17 +1943,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.465"></a><span id="l97.465"> </span>
<a href="#l97.466"></a><span id="l97.466">         return item;</span>
<a href="#l97.467"></a><span id="l97.467">     },</span>
<a href="#l97.468"></a><span id="l97.468"> </span>
<a href="#l97.469"></a><span id="l97.469">     //</span>
<a href="#l97.470"></a><span id="l97.470">     // database writing functions</span>
<a href="#l97.471"></a><span id="l97.471">     //</span>
<a href="#l97.472"></a><span id="l97.472"> </span>
<a href="#l97.473"></a><span id="l97.473" class="difflineminus">-    setDateParamHelper: function cSC_setDateParamHelper(params, entryname, cdt) {</span>
<a href="#l97.474"></a><span id="l97.474" class="difflineplus">+    setDateParamHelper: function(params, entryname, cdt) {</span>
<a href="#l97.475"></a><span id="l97.475">         if (cdt) {</span>
<a href="#l97.476"></a><span id="l97.476">             params[entryname] = cdt.nativeTime;</span>
<a href="#l97.477"></a><span id="l97.477">             let tz = cdt.timezone;</span>
<a href="#l97.478"></a><span id="l97.478">             let ownTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l97.479"></a><span id="l97.479">             if (ownTz) { // if we know that TZID, we use it</span>
<a href="#l97.480"></a><span id="l97.480">                 params[entryname + &quot;_tz&quot;] = ownTz.tzid;</span>
<a href="#l97.481"></a><span id="l97.481">             } else if (!tz.icalComponent) { // timezone component missing</span>
<a href="#l97.482"></a><span id="l97.482">                 params[entryname + &quot;_tz&quot;] = &quot;floating&quot;;</span>
<a href="#l97.483"></a><span id="l97.483" class="difflineat">@@ -1963,17 +1961,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.484"></a><span id="l97.484">                 params[entryname + &quot;_tz&quot;] = tz.icalComponent.serializeToICS();</span>
<a href="#l97.485"></a><span id="l97.485">             }</span>
<a href="#l97.486"></a><span id="l97.486">         } else {</span>
<a href="#l97.487"></a><span id="l97.487">             params[entryname] = null;</span>
<a href="#l97.488"></a><span id="l97.488">             params[entryname + &quot;_tz&quot;] = null;</span>
<a href="#l97.489"></a><span id="l97.489">         }</span>
<a href="#l97.490"></a><span id="l97.490">     },</span>
<a href="#l97.491"></a><span id="l97.491"> </span>
<a href="#l97.492"></a><span id="l97.492" class="difflineminus">-    flushItem: function cSC_flushItem(item, olditem) {</span>
<a href="#l97.493"></a><span id="l97.493" class="difflineplus">+    flushItem: function(item, olditem) {</span>
<a href="#l97.494"></a><span id="l97.494">         ASSERT(!item.recurrenceId, &quot;no parent item passed!&quot;, true);</span>
<a href="#l97.495"></a><span id="l97.495"> </span>
<a href="#l97.496"></a><span id="l97.496">         try {</span>
<a href="#l97.497"></a><span id="l97.497">             this.deleteItemById(olditem ? olditem.id : item.id, true);</span>
<a href="#l97.498"></a><span id="l97.498">             this.acquireTransaction();</span>
<a href="#l97.499"></a><span id="l97.499">             this.writeItem(item, olditem);</span>
<a href="#l97.500"></a><span id="l97.500">         } catch (e) {</span>
<a href="#l97.501"></a><span id="l97.501">             this.releaseTransaction(e);</span>
<a href="#l97.502"></a><span id="l97.502" class="difflineat">@@ -1986,17 +1984,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.503"></a><span id="l97.503"> </span>
<a href="#l97.504"></a><span id="l97.504">     //</span>
<a href="#l97.505"></a><span id="l97.505">     // The write* functions execute the database bits</span>
<a href="#l97.506"></a><span id="l97.506">     // to write the given item type.  They're to return</span>
<a href="#l97.507"></a><span id="l97.507">     // any bits they want or'd into flags, which will be passed</span>
<a href="#l97.508"></a><span id="l97.508">     // to writeEvent/writeTodo to actually do the writing.</span>
<a href="#l97.509"></a><span id="l97.509">     //</span>
<a href="#l97.510"></a><span id="l97.510"> </span>
<a href="#l97.511"></a><span id="l97.511" class="difflineminus">-    writeItem: function cSC_writeItem(item, olditem) {</span>
<a href="#l97.512"></a><span id="l97.512" class="difflineplus">+    writeItem: function(item, olditem) {</span>
<a href="#l97.513"></a><span id="l97.513">         let flags = 0;</span>
<a href="#l97.514"></a><span id="l97.514"> </span>
<a href="#l97.515"></a><span id="l97.515">         flags |= this.writeAttendees(item, olditem);</span>
<a href="#l97.516"></a><span id="l97.516">         flags |= this.writeRecurrence(item, olditem);</span>
<a href="#l97.517"></a><span id="l97.517">         flags |= this.writeProperties(item, olditem);</span>
<a href="#l97.518"></a><span id="l97.518">         flags |= this.writeAttachments(item, olditem);</span>
<a href="#l97.519"></a><span id="l97.519">         flags |= this.writeRelations(item, olditem);</span>
<a href="#l97.520"></a><span id="l97.520">         flags |= this.writeAlarms(item, olditem);</span>
<a href="#l97.521"></a><span id="l97.521" class="difflineat">@@ -2005,17 +2003,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.522"></a><span id="l97.522">             this.writeEvent(item, olditem, flags);</span>
<a href="#l97.523"></a><span id="l97.523">         } else if (cal.isToDo(item)) {</span>
<a href="#l97.524"></a><span id="l97.524">             this.writeTodo(item, olditem, flags);</span>
<a href="#l97.525"></a><span id="l97.525">         } else {</span>
<a href="#l97.526"></a><span id="l97.526">             throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l97.527"></a><span id="l97.527">         }</span>
<a href="#l97.528"></a><span id="l97.528">     },</span>
<a href="#l97.529"></a><span id="l97.529"> </span>
<a href="#l97.530"></a><span id="l97.530" class="difflineminus">-    writeEvent: function cSC_writeEvent(item, olditem, flags) {</span>
<a href="#l97.531"></a><span id="l97.531" class="difflineplus">+    writeEvent: function(item, olditem, flags) {</span>
<a href="#l97.532"></a><span id="l97.532">         try {</span>
<a href="#l97.533"></a><span id="l97.533">             this.prepareStatement(this.mInsertEvent);</span>
<a href="#l97.534"></a><span id="l97.534">             let ip = this.mInsertEvent.params;</span>
<a href="#l97.535"></a><span id="l97.535">             this.setupItemBaseParams(item, olditem, ip);</span>
<a href="#l97.536"></a><span id="l97.536"> </span>
<a href="#l97.537"></a><span id="l97.537">             this.setDateParamHelper(ip, &quot;event_start&quot;, item.startDate);</span>
<a href="#l97.538"></a><span id="l97.538">             this.setDateParamHelper(ip, &quot;event_end&quot;, item.endDate);</span>
<a href="#l97.539"></a><span id="l97.539">             let dtstamp = item.stampTime;</span>
<a href="#l97.540"></a><span id="l97.540" class="difflineat">@@ -2030,17 +2028,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.541"></a><span id="l97.541">             ip.flags = flags;</span>
<a href="#l97.542"></a><span id="l97.542"> </span>
<a href="#l97.543"></a><span id="l97.543">             this.mInsertEvent.executeStep();</span>
<a href="#l97.544"></a><span id="l97.544">         } finally {</span>
<a href="#l97.545"></a><span id="l97.545">             this.mInsertEvent.reset();</span>
<a href="#l97.546"></a><span id="l97.546">         }</span>
<a href="#l97.547"></a><span id="l97.547">     },</span>
<a href="#l97.548"></a><span id="l97.548"> </span>
<a href="#l97.549"></a><span id="l97.549" class="difflineminus">-    writeTodo: function cSC_writeTodo(item, olditem, flags) {</span>
<a href="#l97.550"></a><span id="l97.550" class="difflineplus">+    writeTodo: function(item, olditem, flags) {</span>
<a href="#l97.551"></a><span id="l97.551">         try {</span>
<a href="#l97.552"></a><span id="l97.552">             this.prepareStatement(this.mInsertTodo);</span>
<a href="#l97.553"></a><span id="l97.553">             let ip = this.mInsertTodo.params;</span>
<a href="#l97.554"></a><span id="l97.554"> </span>
<a href="#l97.555"></a><span id="l97.555">             this.setupItemBaseParams(item, olditem, ip);</span>
<a href="#l97.556"></a><span id="l97.556"> </span>
<a href="#l97.557"></a><span id="l97.557">             this.setDateParamHelper(ip, &quot;todo_entry&quot;, item.entryDate);</span>
<a href="#l97.558"></a><span id="l97.558">             this.setDateParamHelper(ip, &quot;todo_due&quot;, item.dueDate);</span>
<a href="#l97.559"></a><span id="l97.559" class="difflineat">@@ -2060,17 +2058,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.560"></a><span id="l97.560">             ip.flags = flags;</span>
<a href="#l97.561"></a><span id="l97.561"> </span>
<a href="#l97.562"></a><span id="l97.562">             this.mInsertTodo.executeStep();</span>
<a href="#l97.563"></a><span id="l97.563">         } finally {</span>
<a href="#l97.564"></a><span id="l97.564">             this.mInsertTodo.reset();</span>
<a href="#l97.565"></a><span id="l97.565">         }</span>
<a href="#l97.566"></a><span id="l97.566">     },</span>
<a href="#l97.567"></a><span id="l97.567"> </span>
<a href="#l97.568"></a><span id="l97.568" class="difflineminus">-    setupItemBaseParams: function cSC_setupItemBaseParams(item, olditem, ip) {</span>
<a href="#l97.569"></a><span id="l97.569" class="difflineplus">+    setupItemBaseParams: function(item, olditem, ip) {</span>
<a href="#l97.570"></a><span id="l97.570">         ip.id = item.id;</span>
<a href="#l97.571"></a><span id="l97.571"> </span>
<a href="#l97.572"></a><span id="l97.572">         if (item.recurrenceId) {</span>
<a href="#l97.573"></a><span id="l97.573">             this.setDateParamHelper(ip, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l97.574"></a><span id="l97.574">         }</span>
<a href="#l97.575"></a><span id="l97.575"> </span>
<a href="#l97.576"></a><span id="l97.576">         let tmp;</span>
<a href="#l97.577"></a><span id="l97.577"> </span>
<a href="#l97.578"></a><span id="l97.578" class="difflineat">@@ -2086,17 +2084,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.579"></a><span id="l97.579">         ip.privacy = item.getProperty(&quot;CLASS&quot;);</span>
<a href="#l97.580"></a><span id="l97.580">         ip.ical_status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l97.581"></a><span id="l97.581"> </span>
<a href="#l97.582"></a><span id="l97.582">         if (item.alarmLastAck) {</span>
<a href="#l97.583"></a><span id="l97.583">             ip.alarm_last_ack = item.alarmLastAck.nativeTime;</span>
<a href="#l97.584"></a><span id="l97.584">         }</span>
<a href="#l97.585"></a><span id="l97.585">     },</span>
<a href="#l97.586"></a><span id="l97.586"> </span>
<a href="#l97.587"></a><span id="l97.587" class="difflineminus">-    writeAttendees: function cSC_writeAttendees(item, olditem) {</span>
<a href="#l97.588"></a><span id="l97.588" class="difflineplus">+    writeAttendees: function(item, olditem) {</span>
<a href="#l97.589"></a><span id="l97.589">         let attendees = item.getAttendees({});</span>
<a href="#l97.590"></a><span id="l97.590">         if (item.organizer) {</span>
<a href="#l97.591"></a><span id="l97.591">             attendees = attendees.concat([]);</span>
<a href="#l97.592"></a><span id="l97.592">             attendees.push(item.organizer);</span>
<a href="#l97.593"></a><span id="l97.593">         }</span>
<a href="#l97.594"></a><span id="l97.594">         if (attendees.length &gt; 0) {</span>
<a href="#l97.595"></a><span id="l97.595">             for (let att of attendees) {</span>
<a href="#l97.596"></a><span id="l97.596">                 let ap = this.mInsertAttendee.params;</span>
<a href="#l97.597"></a><span id="l97.597" class="difflineat">@@ -2112,17 +2110,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.598"></a><span id="l97.598">             }</span>
<a href="#l97.599"></a><span id="l97.599"> </span>
<a href="#l97.600"></a><span id="l97.600">             return CAL_ITEM_FLAG.HAS_ATTENDEES;</span>
<a href="#l97.601"></a><span id="l97.601">         }</span>
<a href="#l97.602"></a><span id="l97.602"> </span>
<a href="#l97.603"></a><span id="l97.603">         return 0;</span>
<a href="#l97.604"></a><span id="l97.604">     },</span>
<a href="#l97.605"></a><span id="l97.605"> </span>
<a href="#l97.606"></a><span id="l97.606" class="difflineminus">-    writeProperty: function cSC_writeProperty(item, propName, propValue) {</span>
<a href="#l97.607"></a><span id="l97.607" class="difflineplus">+    writeProperty: function(item, propName, propValue) {</span>
<a href="#l97.608"></a><span id="l97.608">         try {</span>
<a href="#l97.609"></a><span id="l97.609">             this.prepareStatement(this.mInsertProperty);</span>
<a href="#l97.610"></a><span id="l97.610">             let pp = this.mInsertProperty.params;</span>
<a href="#l97.611"></a><span id="l97.611">             pp.key = propName;</span>
<a href="#l97.612"></a><span id="l97.612">             let wPropValue = cal.wrapInstance(propValue, Components.interfaces.calIDateTime);</span>
<a href="#l97.613"></a><span id="l97.613">             if (wPropValue) {</span>
<a href="#l97.614"></a><span id="l97.614">                 pp.value = wPropValue.nativeTime;</span>
<a href="#l97.615"></a><span id="l97.615">             } else {</span>
<a href="#l97.616"></a><span id="l97.616" class="difflineat">@@ -2140,17 +2138,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.617"></a><span id="l97.617">             pp.item_id = item.id;</span>
<a href="#l97.618"></a><span id="l97.618">             this.setDateParamHelper(pp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l97.619"></a><span id="l97.619">             this.mInsertProperty.executeStep();</span>
<a href="#l97.620"></a><span id="l97.620">         } finally {</span>
<a href="#l97.621"></a><span id="l97.621">             this.mInsertProperty.reset();</span>
<a href="#l97.622"></a><span id="l97.622">         }</span>
<a href="#l97.623"></a><span id="l97.623">     },</span>
<a href="#l97.624"></a><span id="l97.624"> </span>
<a href="#l97.625"></a><span id="l97.625" class="difflineminus">-    writeProperties: function cSC_writeProperties(item, olditem) {</span>
<a href="#l97.626"></a><span id="l97.626" class="difflineplus">+    writeProperties: function(item, olditem) {</span>
<a href="#l97.627"></a><span id="l97.627">         let ret = 0;</span>
<a href="#l97.628"></a><span id="l97.628">         let propEnumerator = item.propertyEnumerator;</span>
<a href="#l97.629"></a><span id="l97.629">         while (propEnumerator.hasMoreElements()) {</span>
<a href="#l97.630"></a><span id="l97.630">             ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l97.631"></a><span id="l97.631">             let prop = propEnumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l97.632"></a><span id="l97.632">             if (item.isPropertyPromoted(prop.name)) {</span>
<a href="#l97.633"></a><span id="l97.633">                 continue;</span>
<a href="#l97.634"></a><span id="l97.634">             }</span>
<a href="#l97.635"></a><span id="l97.635" class="difflineat">@@ -2161,17 +2159,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.636"></a><span id="l97.636">         if (cats.length &gt; 0) {</span>
<a href="#l97.637"></a><span id="l97.637">             ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l97.638"></a><span id="l97.638">             this.writeProperty(item, &quot;CATEGORIES&quot;, categoriesArrayToString(cats));</span>
<a href="#l97.639"></a><span id="l97.639">         }</span>
<a href="#l97.640"></a><span id="l97.640"> </span>
<a href="#l97.641"></a><span id="l97.641">         return ret;</span>
<a href="#l97.642"></a><span id="l97.642">     },</span>
<a href="#l97.643"></a><span id="l97.643"> </span>
<a href="#l97.644"></a><span id="l97.644" class="difflineminus">-    writeRecurrence: function cSC_writeRecurrence(item, olditem) {</span>
<a href="#l97.645"></a><span id="l97.645" class="difflineplus">+    writeRecurrence: function(item, olditem) {</span>
<a href="#l97.646"></a><span id="l97.646">         let flags = 0;</span>
<a href="#l97.647"></a><span id="l97.647"> </span>
<a href="#l97.648"></a><span id="l97.648">         let rec = item.recurrenceInfo;</span>
<a href="#l97.649"></a><span id="l97.649">         if (rec) {</span>
<a href="#l97.650"></a><span id="l97.650">             flags = CAL_ITEM_FLAG.HAS_RECURRENCE;</span>
<a href="#l97.651"></a><span id="l97.651">             let ritems = rec.getRecurrenceItems({});</span>
<a href="#l97.652"></a><span id="l97.652">             for (let ritem of ritems) {</span>
<a href="#l97.653"></a><span id="l97.653">                 let ap = this.mInsertRecurrence.params;</span>
<a href="#l97.654"></a><span id="l97.654" class="difflineat">@@ -2202,17 +2200,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.655"></a><span id="l97.655">             }</span>
<a href="#l97.656"></a><span id="l97.656">         } else if (item.recurrenceId &amp;&amp; item.recurrenceId.isDate) {</span>
<a href="#l97.657"></a><span id="l97.657">             flags |= CAL_ITEM_FLAG.RECURRENCE_ID_ALLDAY;</span>
<a href="#l97.658"></a><span id="l97.658">         }</span>
<a href="#l97.659"></a><span id="l97.659"> </span>
<a href="#l97.660"></a><span id="l97.660">         return flags;</span>
<a href="#l97.661"></a><span id="l97.661">     },</span>
<a href="#l97.662"></a><span id="l97.662"> </span>
<a href="#l97.663"></a><span id="l97.663" class="difflineminus">-    writeAttachments: function cSC_writeAttachments(item, olditem) {</span>
<a href="#l97.664"></a><span id="l97.664" class="difflineplus">+    writeAttachments: function(item, olditem) {</span>
<a href="#l97.665"></a><span id="l97.665">         let attachments = item.getAttachments({});</span>
<a href="#l97.666"></a><span id="l97.666">         if (attachments &amp;&amp; attachments.length &gt; 0) {</span>
<a href="#l97.667"></a><span id="l97.667">             for (let att of attachments) {</span>
<a href="#l97.668"></a><span id="l97.668">                 let ap = this.mInsertAttachment.params;</span>
<a href="#l97.669"></a><span id="l97.669">                 try {</span>
<a href="#l97.670"></a><span id="l97.670">                     this.prepareStatement(this.mInsertAttachment);</span>
<a href="#l97.671"></a><span id="l97.671">                     this.setDateParamHelper(ap, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l97.672"></a><span id="l97.672">                     ap.item_id = item.id;</span>
<a href="#l97.673"></a><span id="l97.673" class="difflineat">@@ -2223,17 +2221,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.674"></a><span id="l97.674">                     this.mInsertAttachment.reset();</span>
<a href="#l97.675"></a><span id="l97.675">                 }</span>
<a href="#l97.676"></a><span id="l97.676">             }</span>
<a href="#l97.677"></a><span id="l97.677">             return CAL_ITEM_FLAG.HAS_ATTACHMENTS;</span>
<a href="#l97.678"></a><span id="l97.678">         }</span>
<a href="#l97.679"></a><span id="l97.679">         return 0;</span>
<a href="#l97.680"></a><span id="l97.680">     },</span>
<a href="#l97.681"></a><span id="l97.681"> </span>
<a href="#l97.682"></a><span id="l97.682" class="difflineminus">-    writeRelations: function cSC_writeRelations(item, olditem) {</span>
<a href="#l97.683"></a><span id="l97.683" class="difflineplus">+    writeRelations: function(item, olditem) {</span>
<a href="#l97.684"></a><span id="l97.684">         let relations = item.getRelations({});</span>
<a href="#l97.685"></a><span id="l97.685">         if (relations &amp;&amp; relations.length &gt; 0) {</span>
<a href="#l97.686"></a><span id="l97.686">             for (let rel of relations) {</span>
<a href="#l97.687"></a><span id="l97.687">                 let rp = this.mInsertRelation.params;</span>
<a href="#l97.688"></a><span id="l97.688">                 try {</span>
<a href="#l97.689"></a><span id="l97.689">                     this.prepareStatement(this.mInsertRelation);</span>
<a href="#l97.690"></a><span id="l97.690">                     this.setDateParamHelper(rp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l97.691"></a><span id="l97.691">                     rp.item_id = item.id;</span>
<a href="#l97.692"></a><span id="l97.692" class="difflineat">@@ -2244,17 +2242,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.693"></a><span id="l97.693">                     this.mInsertRelation.reset();</span>
<a href="#l97.694"></a><span id="l97.694">                 }</span>
<a href="#l97.695"></a><span id="l97.695">             }</span>
<a href="#l97.696"></a><span id="l97.696">             return CAL_ITEM_FLAG.HAS_RELATIONS;</span>
<a href="#l97.697"></a><span id="l97.697">         }</span>
<a href="#l97.698"></a><span id="l97.698">         return 0;</span>
<a href="#l97.699"></a><span id="l97.699">     },</span>
<a href="#l97.700"></a><span id="l97.700"> </span>
<a href="#l97.701"></a><span id="l97.701" class="difflineminus">-    writeAlarms: function cSC_writeAlarms(item, olditem) {</span>
<a href="#l97.702"></a><span id="l97.702" class="difflineplus">+    writeAlarms: function(item, olditem) {</span>
<a href="#l97.703"></a><span id="l97.703">         let alarms = item.getAlarms({});</span>
<a href="#l97.704"></a><span id="l97.704">         if (alarms.length &lt; 1) {</span>
<a href="#l97.705"></a><span id="l97.705">             return 0;</span>
<a href="#l97.706"></a><span id="l97.706">         }</span>
<a href="#l97.707"></a><span id="l97.707"> </span>
<a href="#l97.708"></a><span id="l97.708">         for (let alarm of alarms) {</span>
<a href="#l97.709"></a><span id="l97.709">             let pp = this.mInsertAlarm.params;</span>
<a href="#l97.710"></a><span id="l97.710">             try {</span>
<a href="#l97.711"></a><span id="l97.711" class="difflineat">@@ -2274,17 +2272,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.712"></a><span id="l97.712">     },</span>
<a href="#l97.713"></a><span id="l97.713"> </span>
<a href="#l97.714"></a><span id="l97.714">     /**</span>
<a href="#l97.715"></a><span id="l97.715">      * Deletes the item with the given item id.</span>
<a href="#l97.716"></a><span id="l97.716">      *</span>
<a href="#l97.717"></a><span id="l97.717">      * @param aID           The id of the item to delete.</span>
<a href="#l97.718"></a><span id="l97.718">      * @param aIsModify     If true, then leave in metadata for the item</span>
<a href="#l97.719"></a><span id="l97.719">      */</span>
<a href="#l97.720"></a><span id="l97.720" class="difflineminus">-    deleteItemById: function cSC_deleteItemById(aID, aIsModify) {</span>
<a href="#l97.721"></a><span id="l97.721" class="difflineplus">+    deleteItemById: function(aID, aIsModify) {</span>
<a href="#l97.722"></a><span id="l97.722">         this.acquireTransaction();</span>
<a href="#l97.723"></a><span id="l97.723">         try {</span>
<a href="#l97.724"></a><span id="l97.724">             this.executeItemStatement(this.mDeleteAttendees, &quot;item_id&quot;, aID);</span>
<a href="#l97.725"></a><span id="l97.725">             this.executeItemStatement(this.mDeleteProperties, &quot;item_id&quot;, aID);</span>
<a href="#l97.726"></a><span id="l97.726">             this.executeItemStatement(this.mDeleteRecurrence, &quot;item_id&quot;, aID);</span>
<a href="#l97.727"></a><span id="l97.727">             this.executeItemStatement(this.mDeleteEvent, &quot;id&quot;, aID);</span>
<a href="#l97.728"></a><span id="l97.728">             this.executeItemStatement(this.mDeleteTodo, &quot;id&quot;, aID);</span>
<a href="#l97.729"></a><span id="l97.729">             this.executeItemStatement(this.mDeleteAttachments, &quot;item_id&quot;, aID);</span>
<a href="#l97.730"></a><span id="l97.730" class="difflineat">@@ -2302,40 +2300,40 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.731"></a><span id="l97.731">         delete this.mItemCache[aID];</span>
<a href="#l97.732"></a><span id="l97.732">         delete this.mRecEventCache[aID];</span>
<a href="#l97.733"></a><span id="l97.733">         delete this.mRecTodoCache[aID];</span>
<a href="#l97.734"></a><span id="l97.734">     },</span>
<a href="#l97.735"></a><span id="l97.735"> </span>
<a href="#l97.736"></a><span id="l97.736">     /**</span>
<a href="#l97.737"></a><span id="l97.737">      * Acquire a transaction for this calendar.</span>
<a href="#l97.738"></a><span id="l97.738">      */</span>
<a href="#l97.739"></a><span id="l97.739" class="difflineminus">-    acquireTransaction: function cSC_acquireTransaction() {</span>
<a href="#l97.740"></a><span id="l97.740" class="difflineplus">+    acquireTransaction: function() {</span>
<a href="#l97.741"></a><span id="l97.741">         this.mDB.beginTransaction();</span>
<a href="#l97.742"></a><span id="l97.742">     },</span>
<a href="#l97.743"></a><span id="l97.743"> </span>
<a href="#l97.744"></a><span id="l97.744">     /**</span>
<a href="#l97.745"></a><span id="l97.745">      * Releases one level of transactions for this calendar.</span>
<a href="#l97.746"></a><span id="l97.746">      *</span>
<a href="#l97.747"></a><span id="l97.747">      * @param err       (optional) If set, the transaction is set to fail when</span>
<a href="#l97.748"></a><span id="l97.748">      *                    the count reaches zero.</span>
<a href="#l97.749"></a><span id="l97.749">      */</span>
<a href="#l97.750"></a><span id="l97.750" class="difflineminus">-    releaseTransaction: function cSC_releaseTransaction(err) {</span>
<a href="#l97.751"></a><span id="l97.751" class="difflineplus">+    releaseTransaction: function(err) {</span>
<a href="#l97.752"></a><span id="l97.752">         if (err) {</span>
<a href="#l97.753"></a><span id="l97.753">             cal.ERROR(&quot;[calStorageCalendar] DB error: &quot; + this.mDB.lastErrorString + &quot;\nexc: &quot; + err);</span>
<a href="#l97.754"></a><span id="l97.754">             this.mDB.rollbackTransaction();</span>
<a href="#l97.755"></a><span id="l97.755">         } else {</span>
<a href="#l97.756"></a><span id="l97.756">             this.mDB.commitTransaction();</span>
<a href="#l97.757"></a><span id="l97.757">         }</span>
<a href="#l97.758"></a><span id="l97.758">     },</span>
<a href="#l97.759"></a><span id="l97.759"> </span>
<a href="#l97.760"></a><span id="l97.760">     //</span>
<a href="#l97.761"></a><span id="l97.761">     // calISyncWriteCalendar interface</span>
<a href="#l97.762"></a><span id="l97.762">     //</span>
<a href="#l97.763"></a><span id="l97.763"> </span>
<a href="#l97.764"></a><span id="l97.764" class="difflineminus">-    setMetaData: function cSC_setMetaData(id, value) {</span>
<a href="#l97.765"></a><span id="l97.765" class="difflineplus">+    setMetaData: function(id, value) {</span>
<a href="#l97.766"></a><span id="l97.766">         this.executeItemStatement(this.mDeleteMetaData, &quot;item_id&quot;, id);</span>
<a href="#l97.767"></a><span id="l97.767">         try {</span>
<a href="#l97.768"></a><span id="l97.768">             this.prepareStatement(this.mInsertMetaData);</span>
<a href="#l97.769"></a><span id="l97.769">             let sp = this.mInsertMetaData.params;</span>
<a href="#l97.770"></a><span id="l97.770">             sp.item_id = id;</span>
<a href="#l97.771"></a><span id="l97.771">             sp.value = value;</span>
<a href="#l97.772"></a><span id="l97.772">             this.mInsertMetaData.executeStep();</span>
<a href="#l97.773"></a><span id="l97.773">         } catch (e) {</span>
<a href="#l97.774"></a><span id="l97.774" class="difflineat">@@ -2347,21 +2345,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.775"></a><span id="l97.775">             } else {</span>
<a href="#l97.776"></a><span id="l97.776">                 this.logError(&quot;Unknown error!&quot;, e);</span>
<a href="#l97.777"></a><span id="l97.777">             }</span>
<a href="#l97.778"></a><span id="l97.778">         } finally {</span>
<a href="#l97.779"></a><span id="l97.779">             this.mInsertMetaData.reset();</span>
<a href="#l97.780"></a><span id="l97.780">         }</span>
<a href="#l97.781"></a><span id="l97.781">     },</span>
<a href="#l97.782"></a><span id="l97.782"> </span>
<a href="#l97.783"></a><span id="l97.783" class="difflineminus">-    deleteMetaData: function cSC_deleteMetaData(id) {</span>
<a href="#l97.784"></a><span id="l97.784" class="difflineplus">+    deleteMetaData: function(id) {</span>
<a href="#l97.785"></a><span id="l97.785">         this.executeItemStatement(this.mDeleteMetaData, &quot;item_id&quot;, id);</span>
<a href="#l97.786"></a><span id="l97.786">     },</span>
<a href="#l97.787"></a><span id="l97.787"> </span>
<a href="#l97.788"></a><span id="l97.788" class="difflineminus">-    getMetaData: function cSC_getMetaData(id) {</span>
<a href="#l97.789"></a><span id="l97.789" class="difflineplus">+    getMetaData: function(id) {</span>
<a href="#l97.790"></a><span id="l97.790">         let query = this.mSelectMetaData;</span>
<a href="#l97.791"></a><span id="l97.791">         let value = null;</span>
<a href="#l97.792"></a><span id="l97.792">         try {</span>
<a href="#l97.793"></a><span id="l97.793">             this.prepareStatement(query);</span>
<a href="#l97.794"></a><span id="l97.794">             query.params.item_id = id;</span>
<a href="#l97.795"></a><span id="l97.795"> </span>
<a href="#l97.796"></a><span id="l97.796">             if (query.executeStep()) {</span>
<a href="#l97.797"></a><span id="l97.797">                 value = query.row.value;</span>
<a href="#l97.798"></a><span id="l97.798" class="difflineat">@@ -2370,19 +2368,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.799"></a><span id="l97.799">             this.logError(&quot;Error getting metadata for id &quot; + id + &quot;!&quot;, e);</span>
<a href="#l97.800"></a><span id="l97.800">         } finally {</span>
<a href="#l97.801"></a><span id="l97.801">             query.reset();</span>
<a href="#l97.802"></a><span id="l97.802">         }</span>
<a href="#l97.803"></a><span id="l97.803"> </span>
<a href="#l97.804"></a><span id="l97.804">         return value;</span>
<a href="#l97.805"></a><span id="l97.805">     },</span>
<a href="#l97.806"></a><span id="l97.806"> </span>
<a href="#l97.807"></a><span id="l97.807" class="difflineminus">-    getAllMetaData: function cSC_getAllMetaData(out_count,</span>
<a href="#l97.808"></a><span id="l97.808" class="difflineminus">-                                                 out_ids,</span>
<a href="#l97.809"></a><span id="l97.809" class="difflineminus">-                                                 out_values) {</span>
<a href="#l97.810"></a><span id="l97.810" class="difflineplus">+    getAllMetaData: function(out_count, out_ids, out_values) {</span>
<a href="#l97.811"></a><span id="l97.811">         let query = this.mSelectAllMetaData;</span>
<a href="#l97.812"></a><span id="l97.812">         try {</span>
<a href="#l97.813"></a><span id="l97.813">             this.prepareStatement(query);</span>
<a href="#l97.814"></a><span id="l97.814">             let ids = [];</span>
<a href="#l97.815"></a><span id="l97.815">             let values = [];</span>
<a href="#l97.816"></a><span id="l97.816">             while (query.executeStep()) {</span>
<a href="#l97.817"></a><span id="l97.817">                 ids.push(query.row.item_id);</span>
<a href="#l97.818"></a><span id="l97.818">                 values.push(query.row.value);</span>
<a href="#l97.819"></a><span id="l97.819" class="difflineat">@@ -2399,17 +2395,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.820"></a><span id="l97.820">     /**</span>
<a href="#l97.821"></a><span id="l97.821">      * Internal logging function that should be called on any database error,</span>
<a href="#l97.822"></a><span id="l97.822">      * it will log as much info as possible about the database context and</span>
<a href="#l97.823"></a><span id="l97.823">      * last statement so the problem can be investigated more easilly.</span>
<a href="#l97.824"></a><span id="l97.824">      *</span>
<a href="#l97.825"></a><span id="l97.825">      * @param message           Error message to log.</span>
<a href="#l97.826"></a><span id="l97.826">      * @param exception         Exception that caused the error.</span>
<a href="#l97.827"></a><span id="l97.827">      */</span>
<a href="#l97.828"></a><span id="l97.828" class="difflineminus">-    logError: function cSC_logError(message, exception) {</span>
<a href="#l97.829"></a><span id="l97.829" class="difflineplus">+    logError: function(message, exception) {</span>
<a href="#l97.830"></a><span id="l97.830">         let logMessage = &quot;Message: &quot; + message;</span>
<a href="#l97.831"></a><span id="l97.831">         if (this.mDB) {</span>
<a href="#l97.832"></a><span id="l97.832">             if (this.mDB.connectionReady) {</span>
<a href="#l97.833"></a><span id="l97.833">               logMessage += &quot;\nConnection Ready: &quot; + this.mDB.connectionReady;</span>
<a href="#l97.834"></a><span id="l97.834">             }</span>
<a href="#l97.835"></a><span id="l97.835">             if (this.mDB.lastError) {</span>
<a href="#l97.836"></a><span id="l97.836">               logMessage += &quot;\nLast DB Error Number: &quot; + this.mDB.lastError;</span>
<a href="#l97.837"></a><span id="l97.837">             }</span>
<a href="#l97.838"></a><span id="l97.838" class="difflineat">@@ -2439,17 +2435,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l97.839"></a><span id="l97.839">         if (exception) {</span>
<a href="#l97.840"></a><span id="l97.840">             logMessage += &quot;\nException: &quot; + exception;</span>
<a href="#l97.841"></a><span id="l97.841">         }</span>
<a href="#l97.842"></a><span id="l97.842">         cal.ERROR(&quot;[calStorageCalendar] &quot; + logMessage + &quot;\n&quot; + cal.STACK(10));</span>
<a href="#l97.843"></a><span id="l97.843">     },</span>
<a href="#l97.844"></a><span id="l97.844">     /**</span>
<a href="#l97.845"></a><span id="l97.845">      * propagate the given sequence in exceptions. It may be needed by some calendar implementations</span>
<a href="#l97.846"></a><span id="l97.846">      */</span>
<a href="#l97.847"></a><span id="l97.847" class="difflineminus">-    _propagateSequence: function cSC__propagateSequence(aItem, newSequence) {</span>
<a href="#l97.848"></a><span id="l97.848" class="difflineplus">+    _propagateSequence: function(aItem, newSequence) {</span>
<a href="#l97.849"></a><span id="l97.849">         if (newSequence) {</span>
<a href="#l97.850"></a><span id="l97.850">             aItem.setProperty(&quot;SEQUENCE&quot;, newSequence);</span>
<a href="#l97.851"></a><span id="l97.851">         } else {</span>
<a href="#l97.852"></a><span id="l97.852">             aItem.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l97.853"></a><span id="l97.853">         }</span>
<a href="#l97.854"></a><span id="l97.854">         let rec = aItem.recurrenceInfo;</span>
<a href="#l97.855"></a><span id="l97.855">         if (rec) {</span>
<a href="#l97.856"></a><span id="l97.856">             let exceptions = rec.getExceptionIds({});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -636,17 +636,17 @@ var upgrade = {};</span>
<a href="#l98.4"></a><span id="l98.4">  * Returns the initial storage database schema. Note this is not the current</span>
<a href="#l98.5"></a><span id="l98.5">  * schema, it will be modified by the upgrade.vNN() functions. This function</span>
<a href="#l98.6"></a><span id="l98.6">  * returns the initial v1 with modifications from v2 applied.</span>
<a href="#l98.7"></a><span id="l98.7">  *</span>
<a href="#l98.8"></a><span id="l98.8">  * No bug - new recurrence system. exceptions supported now, along with</span>
<a href="#l98.9"></a><span id="l98.9">  * everything else ical can throw at us. I hope.</span>
<a href="#l98.10"></a><span id="l98.10">  * p=vlad</span>
<a href="#l98.11"></a><span id="l98.11">  */</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-upgrade.v2 = upgrade.v1 = function upgrade_v2(db, version) {</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+upgrade.v2 = upgrade.v1 = function(db, version) {</span>
<a href="#l98.14"></a><span id="l98.14">     LOGdb(db, &quot;Storage: Upgrading to v1/v2&quot;);</span>
<a href="#l98.15"></a><span id="l98.15">     let tblData = {</span>
<a href="#l98.16"></a><span id="l98.16">       cal_calendar_schema_version: {</span>
<a href="#l98.17"></a><span id="l98.17">         version: &quot;INTEGER&quot;</span>
<a href="#l98.18"></a><span id="l98.18">       },</span>
<a href="#l98.19"></a><span id="l98.19"> </span>
<a href="#l98.20"></a><span id="l98.20">     /* While this table is in v1, actually keeping it in the sql object will</span>
<a href="#l98.21"></a><span id="l98.21">      * cause problems when migrating from storage.sdb to local.sqlite. There,</span>
<a href="#l98.22"></a><span id="l98.22" class="difflineat">@@ -730,17 +730,17 @@ upgrade.v2 = upgrade.v1 = function upgra</span>
<a href="#l98.23"></a><span id="l98.23"> };</span>
<a href="#l98.24"></a><span id="l98.24"> </span>
<a href="#l98.25"></a><span id="l98.25"> /**</span>
<a href="#l98.26"></a><span id="l98.26">  * Upgrade to version 3.</span>
<a href="#l98.27"></a><span id="l98.27">  * Bug 293707, updates to storage provider; calendar manager database locked</span>
<a href="#l98.28"></a><span id="l98.28">  * fix, r=shaver, p=vlad</span>
<a href="#l98.29"></a><span id="l98.29">  * p=vlad</span>
<a href="#l98.30"></a><span id="l98.30">  */</span>
<a href="#l98.31"></a><span id="l98.31" class="difflineminus">-upgrade.v3 = function upgrade_v3(db, version) {</span>
<a href="#l98.32"></a><span id="l98.32" class="difflineplus">+upgrade.v3 = function(db, version) {</span>
<a href="#l98.33"></a><span id="l98.33">     function updateSql(tbl, field) {</span>
<a href="#l98.34"></a><span id="l98.34">         executeSimpleSQL(db, &quot;UPDATE &quot; + tbl + &quot; SET &quot; + field + &quot;_tz='UTC'&quot; +</span>
<a href="#l98.35"></a><span id="l98.35">                              &quot; WHERE &quot; + field + &quot; IS NOT NULL&quot;);</span>
<a href="#l98.36"></a><span id="l98.36">     }</span>
<a href="#l98.37"></a><span id="l98.37"> </span>
<a href="#l98.38"></a><span id="l98.38">     let tbl = upgrade.v2(version &lt; 2 &amp;&amp; db, version);</span>
<a href="#l98.39"></a><span id="l98.39">     LOGdb(db, &quot;Storage: Upgrading to v3&quot;);</span>
<a href="#l98.40"></a><span id="l98.40"> </span>
<a href="#l98.41"></a><span id="l98.41" class="difflineat">@@ -800,17 +800,17 @@ upgrade.v3 = function upgrade_v3(db, ver</span>
<a href="#l98.42"></a><span id="l98.42">     return tbl;</span>
<a href="#l98.43"></a><span id="l98.43"> };</span>
<a href="#l98.44"></a><span id="l98.44"> </span>
<a href="#l98.45"></a><span id="l98.45"> /**</span>
<a href="#l98.46"></a><span id="l98.46">  * Upgrade to version 4.</span>
<a href="#l98.47"></a><span id="l98.47">  * Bug 293183 - implement exception support for recurrence.</span>
<a href="#l98.48"></a><span id="l98.48">  * r=shaver,p=vlad</span>
<a href="#l98.49"></a><span id="l98.49">  */</span>
<a href="#l98.50"></a><span id="l98.50" class="difflineminus">-upgrade.v4 = function upgrade_v4(db, version) {</span>
<a href="#l98.51"></a><span id="l98.51" class="difflineplus">+upgrade.v4 = function(db, version) {</span>
<a href="#l98.52"></a><span id="l98.52">     let tbl = upgrade.v3(version &lt; 3 &amp;&amp; db, version);</span>
<a href="#l98.53"></a><span id="l98.53">     LOGdb(db, &quot;Storage: Upgrading to v4&quot;);</span>
<a href="#l98.54"></a><span id="l98.54"> </span>
<a href="#l98.55"></a><span id="l98.55">     beginTransaction(db);</span>
<a href="#l98.56"></a><span id="l98.56">     try {</span>
<a href="#l98.57"></a><span id="l98.57">         for (let tblid of [&quot;events&quot;, &quot;todos&quot;, &quot;attendees&quot;, &quot;properties&quot;]) {</span>
<a href="#l98.58"></a><span id="l98.58">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;recurrence_id&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l98.59"></a><span id="l98.59">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;recurrence_id_tz&quot;, &quot;VARCHAR&quot;, db);</span>
<a href="#l98.60"></a><span id="l98.60" class="difflineat">@@ -823,17 +823,17 @@ upgrade.v4 = function upgrade_v4(db, ver</span>
<a href="#l98.61"></a><span id="l98.61">     return tbl;</span>
<a href="#l98.62"></a><span id="l98.62"> };</span>
<a href="#l98.63"></a><span id="l98.63"> </span>
<a href="#l98.64"></a><span id="l98.64"> /**</span>
<a href="#l98.65"></a><span id="l98.65">  * Bug 315051 - Switch to storing alarms based on offsets from start/end time</span>
<a href="#l98.66"></a><span id="l98.66">  * rather than as absolute times. Ensure that missed alarms are fired.</span>
<a href="#l98.67"></a><span id="l98.67">  * r=dmose, p=jminta</span>
<a href="#l98.68"></a><span id="l98.68">  */</span>
<a href="#l98.69"></a><span id="l98.69" class="difflineminus">-upgrade.v5 = function upgrade_v5(db, version) {</span>
<a href="#l98.70"></a><span id="l98.70" class="difflineplus">+upgrade.v5 = function(db, version) {</span>
<a href="#l98.71"></a><span id="l98.71">     let tbl = upgrade.v4(version &lt; 4 &amp;&amp; db, version);</span>
<a href="#l98.72"></a><span id="l98.72">     LOGdb(db, &quot;Storage: Upgrading to v5&quot;);</span>
<a href="#l98.73"></a><span id="l98.73"> </span>
<a href="#l98.74"></a><span id="l98.74">     beginTransaction(db);</span>
<a href="#l98.75"></a><span id="l98.75">     try {</span>
<a href="#l98.76"></a><span id="l98.76">         for (let tblid of [&quot;events&quot;, &quot;todos&quot;]) {</span>
<a href="#l98.77"></a><span id="l98.77">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_offset&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l98.78"></a><span id="l98.78">             addColumn(tbl, &quot;cal_&quot; + tblid, &quot;alarm_related&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l98.79"></a><span id="l98.79" class="difflineat">@@ -847,17 +847,17 @@ upgrade.v5 = function upgrade_v5(db, ver</span>
<a href="#l98.80"></a><span id="l98.80">     return tbl;</span>
<a href="#l98.81"></a><span id="l98.81"> };</span>
<a href="#l98.82"></a><span id="l98.82"> </span>
<a href="#l98.83"></a><span id="l98.83"> /**</span>
<a href="#l98.84"></a><span id="l98.84">  * Bug 333688 - Converts STRING and VARCHAR columns to TEXT to avoid SQLite's</span>
<a href="#l98.85"></a><span id="l98.85">  * auto-conversion of strings to numbers (10e4 to 10000)</span>
<a href="#l98.86"></a><span id="l98.86">  * r=ctalbert,jminta p=lilmatt</span>
<a href="#l98.87"></a><span id="l98.87">  */</span>
<a href="#l98.88"></a><span id="l98.88" class="difflineminus">-upgrade.v6 = function upgrade_v6(db, version) {</span>
<a href="#l98.89"></a><span id="l98.89" class="difflineplus">+upgrade.v6 = function(db, version) {</span>
<a href="#l98.90"></a><span id="l98.90">     let tbl = upgrade.v5(version &lt; 5 &amp;&amp; db, version);</span>
<a href="#l98.91"></a><span id="l98.91">     LOGdb(db, &quot;Storage: Upgrading to v6&quot;);</span>
<a href="#l98.92"></a><span id="l98.92"> </span>
<a href="#l98.93"></a><span id="l98.93">     beginTransaction(db);</span>
<a href="#l98.94"></a><span id="l98.94">     try {</span>
<a href="#l98.95"></a><span id="l98.95">         let eventCols = [&quot;id&quot;, &quot;title&quot;, &quot;privacy&quot;, &quot;ical_status&quot;,</span>
<a href="#l98.96"></a><span id="l98.96">                          &quot;recurrence_id_tz&quot;, &quot;event_start_tz&quot;,</span>
<a href="#l98.97"></a><span id="l98.97">                          &quot;event_end_tz&quot;, &quot;alarm_time_tz&quot;];</span>
<a href="#l98.98"></a><span id="l98.98" class="difflineat">@@ -887,51 +887,51 @@ upgrade.v6 = function upgrade_v6(db, ver</span>
<a href="#l98.99"></a><span id="l98.99"> </span>
<a href="#l98.100"></a><span id="l98.100">     return tbl;</span>
<a href="#l98.101"></a><span id="l98.101"> };</span>
<a href="#l98.102"></a><span id="l98.102"> </span>
<a href="#l98.103"></a><span id="l98.103"> /**</span>
<a href="#l98.104"></a><span id="l98.104">  * Bug 369010: Migrate all old tzids in storage to new one.</span>
<a href="#l98.105"></a><span id="l98.105">  * r=ctalbert,dmose p=lilmatt</span>
<a href="#l98.106"></a><span id="l98.106">  */</span>
<a href="#l98.107"></a><span id="l98.107" class="difflineminus">-upgrade.v7 = function upgrade_v7(db, version) {</span>
<a href="#l98.108"></a><span id="l98.108" class="difflineplus">+upgrade.v7 = function(db, version) {</span>
<a href="#l98.109"></a><span id="l98.109">     // No schema changes in v7</span>
<a href="#l98.110"></a><span id="l98.110">     let tbl = upgrade.v6(db, version);</span>
<a href="#l98.111"></a><span id="l98.111">     LOGdb(db, &quot;Storage: Upgrading to v7&quot;);</span>
<a href="#l98.112"></a><span id="l98.112">     return tbl;</span>
<a href="#l98.113"></a><span id="l98.113"> };</span>
<a href="#l98.114"></a><span id="l98.114"> </span>
<a href="#l98.115"></a><span id="l98.115"> /**</span>
<a href="#l98.116"></a><span id="l98.116">  * Bug 410931 - Update internal timezone definitions</span>
<a href="#l98.117"></a><span id="l98.117">  * r=ctalbert, p=dbo,nth10sd,hb</span>
<a href="#l98.118"></a><span id="l98.118">  */</span>
<a href="#l98.119"></a><span id="l98.119" class="difflineminus">-upgrade.v8 = function upgrade_v8(db, version) {</span>
<a href="#l98.120"></a><span id="l98.120" class="difflineplus">+upgrade.v8 = function(db, version) {</span>
<a href="#l98.121"></a><span id="l98.121">     // No schema changes in v8</span>
<a href="#l98.122"></a><span id="l98.122">     let tbl = upgrade.v7(db, version);</span>
<a href="#l98.123"></a><span id="l98.123">     LOGdb(db, &quot;Storage: Upgrading to v8&quot;);</span>
<a href="#l98.124"></a><span id="l98.124">     return tbl;</span>
<a href="#l98.125"></a><span id="l98.125"> };</span>
<a href="#l98.126"></a><span id="l98.126"> </span>
<a href="#l98.127"></a><span id="l98.127"> /**</span>
<a href="#l98.128"></a><span id="l98.128">  * Bug 363191 - Handle Timezones more efficiently (Timezone Database)</span>
<a href="#l98.129"></a><span id="l98.129">  * r=philipp,ctalbert, p=dbo</span>
<a href="#l98.130"></a><span id="l98.130">  */</span>
<a href="#l98.131"></a><span id="l98.131" class="difflineminus">-upgrade.v9 = function upgrade_v9(db, version) {</span>
<a href="#l98.132"></a><span id="l98.132" class="difflineplus">+upgrade.v9 = function(db, version) {</span>
<a href="#l98.133"></a><span id="l98.133">     // No schema changes in v9</span>
<a href="#l98.134"></a><span id="l98.134">     let tbl = upgrade.v8(db, version);</span>
<a href="#l98.135"></a><span id="l98.135">     LOGdb(db, &quot;Storage: Upgrading to v9&quot;);</span>
<a href="#l98.136"></a><span id="l98.136">     return tbl;</span>
<a href="#l98.137"></a><span id="l98.137"> };</span>
<a href="#l98.138"></a><span id="l98.138"> </span>
<a href="#l98.139"></a><span id="l98.139"> /**</span>
<a href="#l98.140"></a><span id="l98.140">  * Bug 413908 – Events using internal timezones are no longer updated to</span>
<a href="#l98.141"></a><span id="l98.141">  * recent timezone version;</span>
<a href="#l98.142"></a><span id="l98.142">  * r=philipp, p=dbo</span>
<a href="#l98.143"></a><span id="l98.143">  */</span>
<a href="#l98.144"></a><span id="l98.144" class="difflineminus">-upgrade.v10 = function upgrade_v10(db, version) {</span>
<a href="#l98.145"></a><span id="l98.145" class="difflineplus">+upgrade.v10 = function(db, version) {</span>
<a href="#l98.146"></a><span id="l98.146">     let tbl = upgrade.v9(version &lt; 9 &amp;&amp; db, version);</span>
<a href="#l98.147"></a><span id="l98.147">     LOGdb(db, &quot;Storage: Upgrading to v10&quot;);</span>
<a href="#l98.148"></a><span id="l98.148"> </span>
<a href="#l98.149"></a><span id="l98.149">     beginTransaction(db);</span>
<a href="#l98.150"></a><span id="l98.150">     try {</span>
<a href="#l98.151"></a><span id="l98.151">         addTable(tbl, &quot;cal_tz_version&quot;, { version: &quot;TEXT&quot; }, db);</span>
<a href="#l98.152"></a><span id="l98.152">         setDbVersionAndCommit(db, 10);</span>
<a href="#l98.153"></a><span id="l98.153">     } catch (e) {</span>
<a href="#l98.154"></a><span id="l98.154" class="difflineat">@@ -940,17 +940,17 @@ upgrade.v10 = function upgrade_v10(db, v</span>
<a href="#l98.155"></a><span id="l98.155">     return tbl;</span>
<a href="#l98.156"></a><span id="l98.156"> };</span>
<a href="#l98.157"></a><span id="l98.157"> </span>
<a href="#l98.158"></a><span id="l98.158"> /**</span>
<a href="#l98.159"></a><span id="l98.159">  * Fix bug 319909 - Failure to properly serialize/unserialize ics ATTACH</span>
<a href="#l98.160"></a><span id="l98.160">  * properties.</span>
<a href="#l98.161"></a><span id="l98.161">  * r=philipp,p=fred.jen@web.de</span>
<a href="#l98.162"></a><span id="l98.162">  */</span>
<a href="#l98.163"></a><span id="l98.163" class="difflineminus">-upgrade.v11 = function upgrade_v11(db, version) {</span>
<a href="#l98.164"></a><span id="l98.164" class="difflineplus">+upgrade.v11 = function(db, version) {</span>
<a href="#l98.165"></a><span id="l98.165">     let tbl = upgrade.v10(version &lt; 10 &amp;&amp; db, version);</span>
<a href="#l98.166"></a><span id="l98.166">     LOGdb(db, &quot;Storage: Upgrading to v11&quot;);</span>
<a href="#l98.167"></a><span id="l98.167"> </span>
<a href="#l98.168"></a><span id="l98.168">     beginTransaction(db);</span>
<a href="#l98.169"></a><span id="l98.169">     try {</span>
<a href="#l98.170"></a><span id="l98.170">         addTable(tbl, &quot;cal_attachments&quot;, {</span>
<a href="#l98.171"></a><span id="l98.171">             item_id: &quot;TEXT&quot;,</span>
<a href="#l98.172"></a><span id="l98.172">             data: &quot;BLOB&quot;,</span>
<a href="#l98.173"></a><span id="l98.173" class="difflineat">@@ -963,17 +963,17 @@ upgrade.v11 = function upgrade_v11(db, v</span>
<a href="#l98.174"></a><span id="l98.174">     }</span>
<a href="#l98.175"></a><span id="l98.175">     return tbl;</span>
<a href="#l98.176"></a><span id="l98.176"> };</span>
<a href="#l98.177"></a><span id="l98.177"> </span>
<a href="#l98.178"></a><span id="l98.178"> /**</span>
<a href="#l98.179"></a><span id="l98.179">  * Bug 449031 - Add meta data API to memory/storage</span>
<a href="#l98.180"></a><span id="l98.180">  * r=philipp, p=dbo</span>
<a href="#l98.181"></a><span id="l98.181">  */</span>
<a href="#l98.182"></a><span id="l98.182" class="difflineminus">-upgrade.v12 = function upgrade_v12(db, version) {</span>
<a href="#l98.183"></a><span id="l98.183" class="difflineplus">+upgrade.v12 = function(db, version) {</span>
<a href="#l98.184"></a><span id="l98.184">     let tbl = upgrade.v11(version &lt; 11 &amp;&amp; db, version);</span>
<a href="#l98.185"></a><span id="l98.185">     LOGdb(db, &quot;Storage: Upgrading to v12&quot;);</span>
<a href="#l98.186"></a><span id="l98.186"> </span>
<a href="#l98.187"></a><span id="l98.187">     beginTransaction(db);</span>
<a href="#l98.188"></a><span id="l98.188">     try {</span>
<a href="#l98.189"></a><span id="l98.189">         addColumn(tbl, &quot;cal_attendees&quot;, &quot;is_organizer&quot;, &quot;BOOLEAN&quot;, db);</span>
<a href="#l98.190"></a><span id="l98.190">         addColumn(tbl, &quot;cal_attendees&quot;, &quot;properties&quot;, &quot;BLOB&quot;, db);</span>
<a href="#l98.191"></a><span id="l98.191"> </span>
<a href="#l98.192"></a><span id="l98.192" class="difflineat">@@ -990,17 +990,17 @@ upgrade.v12 = function upgrade_v12(db, v</span>
<a href="#l98.193"></a><span id="l98.193">     return tbl;</span>
<a href="#l98.194"></a><span id="l98.194"> };</span>
<a href="#l98.195"></a><span id="l98.195"> </span>
<a href="#l98.196"></a><span id="l98.196"> /**</span>
<a href="#l98.197"></a><span id="l98.197">  * Bug 449401 - storage provider doesn't cleanly separate items of the same id</span>
<a href="#l98.198"></a><span id="l98.198">  * across different calendars</span>
<a href="#l98.199"></a><span id="l98.199">  * r=dbo,philipp, p=wsourdeau@inverse.ca</span>
<a href="#l98.200"></a><span id="l98.200">  */</span>
<a href="#l98.201"></a><span id="l98.201" class="difflineminus">-upgrade.v13 = function upgrade_v13(db, version) {</span>
<a href="#l98.202"></a><span id="l98.202" class="difflineplus">+upgrade.v13 = function(db, version) {</span>
<a href="#l98.203"></a><span id="l98.203">     let tbl = upgrade.v12(version &lt; 12 &amp;&amp; db, version);</span>
<a href="#l98.204"></a><span id="l98.204">     LOGdb(db, &quot;Storage: Upgrading to v13&quot;);</span>
<a href="#l98.205"></a><span id="l98.205"> </span>
<a href="#l98.206"></a><span id="l98.206">     beginTransaction(db);</span>
<a href="#l98.207"></a><span id="l98.207">     try {</span>
<a href="#l98.208"></a><span id="l98.208">         alterTypes(tbl, &quot;cal_metadata&quot;, [&quot;item_id&quot;], &quot;TEXT&quot;, db);</span>
<a href="#l98.209"></a><span id="l98.209"> </span>
<a href="#l98.210"></a><span id="l98.210">         let calIds = {};</span>
<a href="#l98.211"></a><span id="l98.211" class="difflineat">@@ -1040,17 +1040,17 @@ upgrade.v13 = function upgrade_v13(db, v</span>
<a href="#l98.212"></a><span id="l98.212">     }</span>
<a href="#l98.213"></a><span id="l98.213">     return tbl;</span>
<a href="#l98.214"></a><span id="l98.214"> };</span>
<a href="#l98.215"></a><span id="l98.215"> </span>
<a href="#l98.216"></a><span id="l98.216"> /**</span>
<a href="#l98.217"></a><span id="l98.217">  * Bug 446303 - use the &quot;RELATED-TO&quot; property.</span>
<a href="#l98.218"></a><span id="l98.218">  * r=philipp,dbo, p=fred.jen@web.de</span>
<a href="#l98.219"></a><span id="l98.219">  */</span>
<a href="#l98.220"></a><span id="l98.220" class="difflineminus">-upgrade.v14 = function upgrade_v14(db, version) {</span>
<a href="#l98.221"></a><span id="l98.221" class="difflineplus">+upgrade.v14 = function(db, version) {</span>
<a href="#l98.222"></a><span id="l98.222">     let tbl = upgrade.v13(version &lt; 13 &amp;&amp; db, version);</span>
<a href="#l98.223"></a><span id="l98.223">     LOGdb(db, &quot;Storage: Upgrading to v14&quot;);</span>
<a href="#l98.224"></a><span id="l98.224"> </span>
<a href="#l98.225"></a><span id="l98.225">     beginTransaction(db);</span>
<a href="#l98.226"></a><span id="l98.226">     try {</span>
<a href="#l98.227"></a><span id="l98.227">         addTable(tbl, &quot;cal_relations&quot;, {</span>
<a href="#l98.228"></a><span id="l98.228">             cal_id: &quot;INTEGER&quot;,</span>
<a href="#l98.229"></a><span id="l98.229">             item_id: &quot;TEXT&quot;,</span>
<a href="#l98.230"></a><span id="l98.230" class="difflineat">@@ -1063,17 +1063,17 @@ upgrade.v14 = function upgrade_v14(db, v</span>
<a href="#l98.231"></a><span id="l98.231">     }</span>
<a href="#l98.232"></a><span id="l98.232">     return tbl;</span>
<a href="#l98.233"></a><span id="l98.233"> };</span>
<a href="#l98.234"></a><span id="l98.234"> </span>
<a href="#l98.235"></a><span id="l98.235"> /**</span>
<a href="#l98.236"></a><span id="l98.236">  * Bug 463282 - Tasks cannot be created or imported (regression).</span>
<a href="#l98.237"></a><span id="l98.237">  * r=philipp,berend, p=dbo</span>
<a href="#l98.238"></a><span id="l98.238">  */</span>
<a href="#l98.239"></a><span id="l98.239" class="difflineminus">-upgrade.v15 = function upgrade_v15(db, version) {</span>
<a href="#l98.240"></a><span id="l98.240" class="difflineplus">+upgrade.v15 = function(db, version) {</span>
<a href="#l98.241"></a><span id="l98.241">     let tbl = upgrade.v14(version &lt; 14 &amp;&amp; db, version);</span>
<a href="#l98.242"></a><span id="l98.242">     LOGdb(db, &quot;Storage: Upgrading to v15&quot;);</span>
<a href="#l98.243"></a><span id="l98.243"> </span>
<a href="#l98.244"></a><span id="l98.244">     beginTransaction(db);</span>
<a href="#l98.245"></a><span id="l98.245">     try {</span>
<a href="#l98.246"></a><span id="l98.246">         addColumn(tbl, &quot;cal_todos&quot;, &quot;todo_stamp&quot;, &quot;INTEGER&quot;, db);</span>
<a href="#l98.247"></a><span id="l98.247">         setDbVersionAndCommit(db, 15);</span>
<a href="#l98.248"></a><span id="l98.248">     } catch (e) {</span>
<a href="#l98.249"></a><span id="l98.249" class="difflineat">@@ -1088,23 +1088,23 @@ upgrade.v15 = function upgrade_v15(db, v</span>
<a href="#l98.250"></a><span id="l98.250">  * alarms.</span>
<a href="#l98.251"></a><span id="l98.251">  * r=dbo,ssitter, p=philipp</span>
<a href="#l98.252"></a><span id="l98.252">  *</span>
<a href="#l98.253"></a><span id="l98.253">  * This upgrader is a bit special. To fix bug 494140, we decided to change the</span>
<a href="#l98.254"></a><span id="l98.254">  * upgrading code afterwards to make sure no data is lost for people upgrading</span>
<a href="#l98.255"></a><span id="l98.255">  * from 0.9 -&gt; 1.0b1 and later. The v17 upgrader will merely take care of the</span>
<a href="#l98.256"></a><span id="l98.256">  * upgrade if a user is upgrading from 1.0pre -&gt; 1.0b1 or later.</span>
<a href="#l98.257"></a><span id="l98.257">  */</span>
<a href="#l98.258"></a><span id="l98.258" class="difflineminus">-upgrade.v16 = function upgrade_v16(db, version) {</span>
<a href="#l98.259"></a><span id="l98.259" class="difflineplus">+upgrade.v16 = function(db, version) {</span>
<a href="#l98.260"></a><span id="l98.260">     let tbl = upgrade.v15(version &lt; 15 &amp;&amp; db, version);</span>
<a href="#l98.261"></a><span id="l98.261">     LOGdb(db, &quot;Storage: Upgrading to v16&quot;);</span>
<a href="#l98.262"></a><span id="l98.262">     beginTransaction(db);</span>
<a href="#l98.263"></a><span id="l98.263">     try {</span>
<a href="#l98.264"></a><span id="l98.264">         createFunction(db, &quot;translateAlarm&quot;, 4, {</span>
<a href="#l98.265"></a><span id="l98.265" class="difflineminus">-            onFunctionCall: function translateAlarm(storArgs) {</span>
<a href="#l98.266"></a><span id="l98.266" class="difflineplus">+            onFunctionCall: function(storArgs) {</span>
<a href="#l98.267"></a><span id="l98.267">                 try {</span>
<a href="#l98.268"></a><span id="l98.268">                     let [aOffset, aRelated, aAlarmTime, aTzId] =</span>
<a href="#l98.269"></a><span id="l98.269">                         mapStorageArgs(storArgs);</span>
<a href="#l98.270"></a><span id="l98.270"> </span>
<a href="#l98.271"></a><span id="l98.271">                     let alarm = cal.createAlarm();</span>
<a href="#l98.272"></a><span id="l98.272">                     if (aOffset) {</span>
<a href="#l98.273"></a><span id="l98.273">                         alarm.related = parseInt(aRelated, 10) + 1;</span>
<a href="#l98.274"></a><span id="l98.274">                         alarm.offset = cal.createDuration();</span>
<a href="#l98.275"></a><span id="l98.275" class="difflineat">@@ -1142,17 +1142,17 @@ upgrade.v16 = function upgrade_v16(db, v</span>
<a href="#l98.276"></a><span id="l98.276">             item_id: &quot;TEXT&quot;,</span>
<a href="#l98.277"></a><span id="l98.277">             // Note the following two columns were not originally part of the</span>
<a href="#l98.278"></a><span id="l98.278">             // v16 upgrade, see note above function.</span>
<a href="#l98.279"></a><span id="l98.279">             recurrence_id: &quot;INTEGER&quot;,</span>
<a href="#l98.280"></a><span id="l98.280">             recurrence_id_tz: &quot;TEXT&quot;,</span>
<a href="#l98.281"></a><span id="l98.281">             icalString: &quot;TEXT&quot;</span>
<a href="#l98.282"></a><span id="l98.282">         }, db);</span>
<a href="#l98.283"></a><span id="l98.283"> </span>
<a href="#l98.284"></a><span id="l98.284" class="difflineminus">-        let copyDataOver = function copyDataOver(tblName) {</span>
<a href="#l98.285"></a><span id="l98.285" class="difflineplus">+        let copyDataOver = function(tblName) {</span>
<a href="#l98.286"></a><span id="l98.286">             const transAlarm = &quot;translateAlarm(alarm_offset, &quot; +</span>
<a href="#l98.287"></a><span id="l98.287">                                               &quot;alarm_related, &quot; +</span>
<a href="#l98.288"></a><span id="l98.288">                                               &quot;alarm_time, &quot; +</span>
<a href="#l98.289"></a><span id="l98.289">                                               &quot;alarm_time_tz)&quot;;</span>
<a href="#l98.290"></a><span id="l98.290">             executeSimpleSQL(db, &quot;INSERT INTO cal_alarms (cal_id, item_id,&quot; +</span>
<a href="#l98.291"></a><span id="l98.291">                                  &quot;                        recurrence_id, &quot; +</span>
<a href="#l98.292"></a><span id="l98.292">                                  &quot;                        recurrence_id_tz, &quot; +</span>
<a href="#l98.293"></a><span id="l98.293">                                  &quot;                        icalString)&quot; +</span>
<a href="#l98.294"></a><span id="l98.294" class="difflineat">@@ -1202,17 +1202,17 @@ upgrade.v16 = function upgrade_v16(db, v</span>
<a href="#l98.295"></a><span id="l98.295">  * repeating event.</span>
<a href="#l98.296"></a><span id="l98.296">  * r=dbo,ssitter, p=philipp</span>
<a href="#l98.297"></a><span id="l98.297">  *</span>
<a href="#l98.298"></a><span id="l98.298">  * This upgrader is special. In bug 494140 we decided it would be better to fix</span>
<a href="#l98.299"></a><span id="l98.299">  * the v16 upgrader so 0.9 users can update to 1.0b1 and later without dataloss.</span>
<a href="#l98.300"></a><span id="l98.300">  * Therefore all this upgrader does is handle users of 1.0pre before the</span>
<a href="#l98.301"></a><span id="l98.301">  * mentioned bug.</span>
<a href="#l98.302"></a><span id="l98.302">  */</span>
<a href="#l98.303"></a><span id="l98.303" class="difflineminus">-upgrade.v17 = function upgrade_v17(db, version) {</span>
<a href="#l98.304"></a><span id="l98.304" class="difflineplus">+upgrade.v17 = function(db, version) {</span>
<a href="#l98.305"></a><span id="l98.305">     let tbl = upgrade.v16(version &lt; 16 &amp;&amp; db, version);</span>
<a href="#l98.306"></a><span id="l98.306">     LOGdb(db, &quot;Storage: Upgrading to v17&quot;);</span>
<a href="#l98.307"></a><span id="l98.307">     beginTransaction(db);</span>
<a href="#l98.308"></a><span id="l98.308">     try {</span>
<a href="#l98.309"></a><span id="l98.309">         for (let tblName of [&quot;alarms&quot;, &quot;relations&quot;, &quot;attachments&quot;]) {</span>
<a href="#l98.310"></a><span id="l98.310">             let hasColumns = true;</span>
<a href="#l98.311"></a><span id="l98.311">             let stmt;</span>
<a href="#l98.312"></a><span id="l98.312">             try {</span>
<a href="#l98.313"></a><span id="l98.313" class="difflineat">@@ -1267,17 +1267,17 @@ upgrade.v17 = function upgrade_v17(db, v</span>
<a href="#l98.314"></a><span id="l98.314"> </span>
<a href="#l98.315"></a><span id="l98.315"> /**</span>
<a href="#l98.316"></a><span id="l98.316">  * Bug 529326 -  Create indexes for the local calendar</span>
<a href="#l98.317"></a><span id="l98.317">  * r=mschroeder, p=philipp</span>
<a href="#l98.318"></a><span id="l98.318">  *</span>
<a href="#l98.319"></a><span id="l98.319">  * This bug adds some indexes to improve performance. If you would like to add</span>
<a href="#l98.320"></a><span id="l98.320">  * additional indexes, please read http://www.sqlite.org/optoverview.html first.</span>
<a href="#l98.321"></a><span id="l98.321">  */</span>
<a href="#l98.322"></a><span id="l98.322" class="difflineminus">-upgrade.v18 = function upgrade_v18(db, version) {</span>
<a href="#l98.323"></a><span id="l98.323" class="difflineplus">+upgrade.v18 = function(db, version) {</span>
<a href="#l98.324"></a><span id="l98.324">     let tbl = upgrade.v17(version &lt; 17 &amp;&amp; db, version);</span>
<a href="#l98.325"></a><span id="l98.325">     LOGdb(db, &quot;Storage: Upgrading to v18&quot;);</span>
<a href="#l98.326"></a><span id="l98.326">     beginTransaction(db);</span>
<a href="#l98.327"></a><span id="l98.327">     try {</span>
<a href="#l98.328"></a><span id="l98.328">         // These fields are often indexed over</span>
<a href="#l98.329"></a><span id="l98.329">         let simpleIds = [&quot;cal_id&quot;, &quot;item_id&quot;];</span>
<a href="#l98.330"></a><span id="l98.330">         let allIds = simpleIds.concat([&quot;recurrence_id&quot;, &quot;recurrence_id_tz&quot;]);</span>
<a href="#l98.331"></a><span id="l98.331"> </span>
<a href="#l98.332"></a><span id="l98.332" class="difflineat">@@ -1311,17 +1311,17 @@ upgrade.v18 = function upgrade_v18(db, v</span>
<a href="#l98.333"></a><span id="l98.333">     return tbl;</span>
<a href="#l98.334"></a><span id="l98.334"> };</span>
<a href="#l98.335"></a><span id="l98.335"> </span>
<a href="#l98.336"></a><span id="l98.336"> /**</span>
<a href="#l98.337"></a><span id="l98.337">  * Bug 479867 - Cached calendars don't set id correctly, causing duplicate</span>
<a href="#l98.338"></a><span id="l98.338">  * events to be shown for multiple cached calendars</span>
<a href="#l98.339"></a><span id="l98.339">  * r=simon.at.orcl, p=philipp,dbo</span>
<a href="#l98.340"></a><span id="l98.340">  */</span>
<a href="#l98.341"></a><span id="l98.341" class="difflineminus">-upgrade.v19 = function upgrade_v19(db, version) {</span>
<a href="#l98.342"></a><span id="l98.342" class="difflineplus">+upgrade.v19 = function(db, version) {</span>
<a href="#l98.343"></a><span id="l98.343">     let tbl = upgrade.v18(version &lt; 18 &amp;&amp; db, version);</span>
<a href="#l98.344"></a><span id="l98.344">     LOGdb(db, &quot;Storage: Upgrading to v19&quot;);</span>
<a href="#l98.345"></a><span id="l98.345">     beginTransaction(db);</span>
<a href="#l98.346"></a><span id="l98.346">     try {</span>
<a href="#l98.347"></a><span id="l98.347">         // Change types of column to TEXT.</span>
<a href="#l98.348"></a><span id="l98.348">         for (let tblName of [&quot;cal_alarms&quot;, &quot;cal_attachments&quot;,</span>
<a href="#l98.349"></a><span id="l98.349">                              &quot;cal_attendees&quot;, &quot;cal_events&quot;,</span>
<a href="#l98.350"></a><span id="l98.350">                              &quot;cal_metadata&quot;, &quot;cal_properties&quot;,</span>
<a href="#l98.351"></a><span id="l98.351" class="difflineat">@@ -1337,17 +1337,17 @@ upgrade.v19 = function upgrade_v19(db, v</span>
<a href="#l98.352"></a><span id="l98.352">     return tbl;</span>
<a href="#l98.353"></a><span id="l98.353"> };</span>
<a href="#l98.354"></a><span id="l98.354"> </span>
<a href="#l98.355"></a><span id="l98.355"> /**</span>
<a href="#l98.356"></a><span id="l98.356">  * Bug 380060 - Offline Sync feature for calendar</span>
<a href="#l98.357"></a><span id="l98.357">  * Setting a offline_journal column in cal_events tables</span>
<a href="#l98.358"></a><span id="l98.358">  * r=philipp, p=redDragon</span>
<a href="#l98.359"></a><span id="l98.359">  */</span>
<a href="#l98.360"></a><span id="l98.360" class="difflineminus">-upgrade.v20 = function upgrade_v20(db, version) {</span>
<a href="#l98.361"></a><span id="l98.361" class="difflineplus">+upgrade.v20 = function(db, version) {</span>
<a href="#l98.362"></a><span id="l98.362">     let tbl = upgrade.v19(version &lt; 19 &amp;&amp; db, version);</span>
<a href="#l98.363"></a><span id="l98.363">     LOGdb(db, &quot;Storage: Upgrading to v20&quot;);</span>
<a href="#l98.364"></a><span id="l98.364">     beginTransaction(db);</span>
<a href="#l98.365"></a><span id="l98.365">     try {</span>
<a href="#l98.366"></a><span id="l98.366">         // Adding a offline_journal column</span>
<a href="#l98.367"></a><span id="l98.367">         for (let tblName of [&quot;cal_events&quot;, &quot;cal_todos&quot;]) {</span>
<a href="#l98.368"></a><span id="l98.368">             addColumn(tbl, tblName, [&quot;offline_journal&quot;], &quot;INTEGER&quot;, db);</span>
<a href="#l98.369"></a><span id="l98.369">         }</span>
<a href="#l98.370"></a><span id="l98.370" class="difflineat">@@ -1358,17 +1358,17 @@ upgrade.v20 = function upgrade_v20(db, v</span>
<a href="#l98.371"></a><span id="l98.371">     return tbl;</span>
<a href="#l98.372"></a><span id="l98.372"> };</span>
<a href="#l98.373"></a><span id="l98.373"> </span>
<a href="#l98.374"></a><span id="l98.374"> /**</span>
<a href="#l98.375"></a><span id="l98.375">  * Bug 785659 - Get rid of calIRecurrenceDateSet</span>
<a href="#l98.376"></a><span id="l98.376">  * Migrate x-dateset to x-date in the storage database</span>
<a href="#l98.377"></a><span id="l98.377">  * r=mmecca, p=philipp</span>
<a href="#l98.378"></a><span id="l98.378">  */</span>
<a href="#l98.379"></a><span id="l98.379" class="difflineminus">-upgrade.v21 = function upgrade_v21(db, version) {</span>
<a href="#l98.380"></a><span id="l98.380" class="difflineplus">+upgrade.v21 = function(db, version) {</span>
<a href="#l98.381"></a><span id="l98.381">     let tbl = upgrade.v20(version &lt; 20 &amp;&amp; db, version);</span>
<a href="#l98.382"></a><span id="l98.382">     LOGdb(db, &quot;Storage: Upgrading to v21&quot;);</span>
<a href="#l98.383"></a><span id="l98.383">     beginTransaction(db);</span>
<a href="#l98.384"></a><span id="l98.384"> </span>
<a href="#l98.385"></a><span id="l98.385">     try {</span>
<a href="#l98.386"></a><span id="l98.386">         // The following operation is only important on a live DB, since we are</span>
<a href="#l98.387"></a><span id="l98.387">         // changing only the values on the DB, not the schema itself.</span>
<a href="#l98.388"></a><span id="l98.388">         if (db) {</span>
<a href="#l98.389"></a><span id="l98.389" class="difflineat">@@ -1431,24 +1431,24 @@ upgrade.v21 = function upgrade_v21(db, v</span>
<a href="#l98.390"></a><span id="l98.390"> };</span>
<a href="#l98.391"></a><span id="l98.391"> </span>
<a href="#l98.392"></a><span id="l98.392"> /**</span>
<a href="#l98.393"></a><span id="l98.393">  * Bug 785733 - Move some properties to use icalString in database.</span>
<a href="#l98.394"></a><span id="l98.394">  * Use the full icalString in attendees, attachments, relations and recurrence</span>
<a href="#l98.395"></a><span id="l98.395">  * tables.</span>
<a href="#l98.396"></a><span id="l98.396">  * r=mmecca, p=philipp</span>
<a href="#l98.397"></a><span id="l98.397">  */</span>
<a href="#l98.398"></a><span id="l98.398" class="difflineminus">-upgrade.v22 = function upgrade_v22(db, version) {</span>
<a href="#l98.399"></a><span id="l98.399" class="difflineplus">+upgrade.v22 = function(db, version) {</span>
<a href="#l98.400"></a><span id="l98.400">     let tbl = upgrade.v21(version &lt; 21 &amp;&amp; db, version);</span>
<a href="#l98.401"></a><span id="l98.401">     LOGdb(db, &quot;Storage: Upgrading to v22&quot;);</span>
<a href="#l98.402"></a><span id="l98.402">     beginTransaction(db);</span>
<a href="#l98.403"></a><span id="l98.403">     try {</span>
<a href="#l98.404"></a><span id="l98.404">         // Update attachments to using icalString directly</span>
<a href="#l98.405"></a><span id="l98.405">         createFunction(db, &quot;translateAttachment&quot;, 3, {</span>
<a href="#l98.406"></a><span id="l98.406" class="difflineminus">-            onFunctionCall: function translateAttachment(storArgs) {</span>
<a href="#l98.407"></a><span id="l98.407" class="difflineplus">+            onFunctionCall: function(storArgs) {</span>
<a href="#l98.408"></a><span id="l98.408">                 try {</span>
<a href="#l98.409"></a><span id="l98.409">                     let [aData, aFmtType, aEncoding] = mapStorageArgs(storArgs);</span>
<a href="#l98.410"></a><span id="l98.410"> </span>
<a href="#l98.411"></a><span id="l98.411">                     let attach = cal.createAttachment();</span>
<a href="#l98.412"></a><span id="l98.412">                     attach.uri = cal.makeURL(aData);</span>
<a href="#l98.413"></a><span id="l98.413">                     attach.formatType = aFmtType;</span>
<a href="#l98.414"></a><span id="l98.414">                     attach.encoding = aEncoding;</span>
<a href="#l98.415"></a><span id="l98.415">                     return attach.icalString;</span>
<a href="#l98.416"></a><span id="l98.416" class="difflineat">@@ -1458,17 +1458,17 @@ upgrade.v22 = function upgrade_v22(db, v</span>
<a href="#l98.417"></a><span id="l98.417">                 }</span>
<a href="#l98.418"></a><span id="l98.418">             }</span>
<a href="#l98.419"></a><span id="l98.419">         });</span>
<a href="#l98.420"></a><span id="l98.420">         migrateToIcalString(tbl, &quot;cal_attachments&quot;, &quot;translateAttachment&quot;,</span>
<a href="#l98.421"></a><span id="l98.421">                            [&quot;data&quot;, &quot;format_type&quot;, &quot;encoding&quot;], db);</span>
<a href="#l98.422"></a><span id="l98.422"> </span>
<a href="#l98.423"></a><span id="l98.423">         // Update relations to using icalString directly</span>
<a href="#l98.424"></a><span id="l98.424">         createFunction(db, &quot;translateRelation&quot;, 2, {</span>
<a href="#l98.425"></a><span id="l98.425" class="difflineminus">-            onFunctionCall: function translateAttachment(storArgs) {</span>
<a href="#l98.426"></a><span id="l98.426" class="difflineplus">+            onFunctionCall: function(storArgs) {</span>
<a href="#l98.427"></a><span id="l98.427">                 try {</span>
<a href="#l98.428"></a><span id="l98.428">                     let [aRelType, aRelId] = mapStorageArgs(storArgs);</span>
<a href="#l98.429"></a><span id="l98.429">                     let relation = cal.createRelation();</span>
<a href="#l98.430"></a><span id="l98.430">                     relation.relType = aRelType;</span>
<a href="#l98.431"></a><span id="l98.431">                     relation.relId = aRelId;</span>
<a href="#l98.432"></a><span id="l98.432">                     return relation.icalString;</span>
<a href="#l98.433"></a><span id="l98.433">                 } catch (e) {</span>
<a href="#l98.434"></a><span id="l98.434">                     cal.ERROR(&quot;Error converting relation: &quot; + e);</span>
<a href="#l98.435"></a><span id="l98.435" class="difflineat">@@ -1476,17 +1476,17 @@ upgrade.v22 = function upgrade_v22(db, v</span>
<a href="#l98.436"></a><span id="l98.436">                 }</span>
<a href="#l98.437"></a><span id="l98.437">             }</span>
<a href="#l98.438"></a><span id="l98.438">         });</span>
<a href="#l98.439"></a><span id="l98.439">         migrateToIcalString(tbl, &quot;cal_relations&quot;, &quot;translateRelation&quot;,</span>
<a href="#l98.440"></a><span id="l98.440">                            [&quot;rel_type&quot;, &quot;rel_id&quot;], db);</span>
<a href="#l98.441"></a><span id="l98.441"> </span>
<a href="#l98.442"></a><span id="l98.442">         // Update attendees table to using icalString directly</span>
<a href="#l98.443"></a><span id="l98.443">         createFunction(db, &quot;translateAttendee&quot;, 8, {</span>
<a href="#l98.444"></a><span id="l98.444" class="difflineminus">-            onFunctionCall: function translateAttachment(storArgs) {</span>
<a href="#l98.445"></a><span id="l98.445" class="difflineplus">+            onFunctionCall: function(storArgs) {</span>
<a href="#l98.446"></a><span id="l98.446">                 try {</span>
<a href="#l98.447"></a><span id="l98.447">                     let [aAttendeeId, aCommonName, aRsvp, aRole,</span>
<a href="#l98.448"></a><span id="l98.448">                          aStatus, aType, aIsOrganizer, aProperties] =</span>
<a href="#l98.449"></a><span id="l98.449">                          mapStorageArgs(storArgs);</span>
<a href="#l98.450"></a><span id="l98.450"> </span>
<a href="#l98.451"></a><span id="l98.451">                     let attendee = cal.createAttendee();</span>
<a href="#l98.452"></a><span id="l98.452"> </span>
<a href="#l98.453"></a><span id="l98.453">                     attendee.id = aAttendeeId;</span>
<a href="#l98.454"></a><span id="l98.454" class="difflineat">@@ -1520,17 +1520,17 @@ upgrade.v22 = function upgrade_v22(db, v</span>
<a href="#l98.455"></a><span id="l98.455">             }</span>
<a href="#l98.456"></a><span id="l98.456">         });</span>
<a href="#l98.457"></a><span id="l98.457">         migrateToIcalString(tbl, &quot;cal_attendees&quot;, &quot;translateAttendee&quot;,</span>
<a href="#l98.458"></a><span id="l98.458">                             [&quot;attendee_id&quot;, &quot;common_name&quot;, &quot;rsvp&quot;, &quot;role&quot;,</span>
<a href="#l98.459"></a><span id="l98.459">                              &quot;status&quot;, &quot;type&quot;, &quot;is_organizer&quot;, &quot;properties&quot;], db);</span>
<a href="#l98.460"></a><span id="l98.460"> </span>
<a href="#l98.461"></a><span id="l98.461">         // Update recurrence table to using icalString directly</span>
<a href="#l98.462"></a><span id="l98.462">         createFunction(db, &quot;translateRecurrence&quot;, 17, {</span>
<a href="#l98.463"></a><span id="l98.463" class="difflineminus">-            onFunctionCall: function translateRecurrence(storArgs) {</span>
<a href="#l98.464"></a><span id="l98.464" class="difflineplus">+            onFunctionCall: function(storArgs) {</span>
<a href="#l98.465"></a><span id="l98.465">                 function parseInt10(x) { return parseInt(x, 10); }</span>
<a href="#l98.466"></a><span id="l98.466">                 try {</span>
<a href="#l98.467"></a><span id="l98.467">                     // eslint-disable-next-line no-unused-vars</span>
<a href="#l98.468"></a><span id="l98.468">                     let [aIndex, aType, aIsNegative, aDates, aCount,</span>
<a href="#l98.469"></a><span id="l98.469">                          aEndDate, aInterval, aSecond, aMinute, aHour,</span>
<a href="#l98.470"></a><span id="l98.470">                          aDay, aMonthday, aYearday, aWeekno, aMonth,</span>
<a href="#l98.471"></a><span id="l98.471">                          aSetPos, aTmpFlags] = mapStorageArgs(storArgs);</span>
<a href="#l98.472"></a><span id="l98.472"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -32,59 +32,59 @@ calWcapCalendar.prototype = {</span>
<a href="#l99.4"></a><span id="l99.4">     QueryInterface: XPCOMUtils.generateQI(calWcapCalendarInterfaces),</span>
<a href="#l99.5"></a><span id="l99.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l99.6"></a><span id="l99.6">         classID: calWcapCalendarClassID,</span>
<a href="#l99.7"></a><span id="l99.7">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l99.8"></a><span id="l99.8">         classDescription: &quot;Sun Java System Calendar Server WCAP Provider&quot;,</span>
<a href="#l99.9"></a><span id="l99.9">         interfaces: calWcapCalendarInterfaces</span>
<a href="#l99.10"></a><span id="l99.10">     }),</span>
<a href="#l99.11"></a><span id="l99.11"> </span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-    toString: function calWcapCalendar_toString() {</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+    toString: function() {</span>
<a href="#l99.14"></a><span id="l99.14">         let str = this.session.toString();</span>
<a href="#l99.15"></a><span id="l99.15">         if (this.m_calId) {</span>
<a href="#l99.16"></a><span id="l99.16">             str += &quot;, calId=&quot; + this.calId;</span>
<a href="#l99.17"></a><span id="l99.17">         } else {</span>
<a href="#l99.18"></a><span id="l99.18">             str += &quot;, default calendar&quot;;</span>
<a href="#l99.19"></a><span id="l99.19">         }</span>
<a href="#l99.20"></a><span id="l99.20">         return str;</span>
<a href="#l99.21"></a><span id="l99.21">     },</span>
<a href="#l99.22"></a><span id="l99.22"> </span>
<a href="#l99.23"></a><span id="l99.23" class="difflineminus">-    notifyError_: function calWcapCalendar_notifyError_(err, msg, context) {</span>
<a href="#l99.24"></a><span id="l99.24" class="difflineplus">+    notifyError_: function(err, msg, context) {</span>
<a href="#l99.25"></a><span id="l99.25">         let rc = getResultCode(err);</span>
<a href="#l99.26"></a><span id="l99.26">         switch (rc) {</span>
<a href="#l99.27"></a><span id="l99.27">             case calIWcapErrors.WCAP_COMPONENT_NOT_FOUND:</span>
<a href="#l99.28"></a><span id="l99.28">             case NS_ERROR_OFFLINE:</span>
<a href="#l99.29"></a><span id="l99.29">                 return;</span>
<a href="#l99.30"></a><span id="l99.30">             default:</span>
<a href="#l99.31"></a><span id="l99.31">                 msg = errorToString(err);</span>
<a href="#l99.32"></a><span id="l99.32">                 log(&quot;error: &quot; + msg, context);</span>
<a href="#l99.33"></a><span id="l99.33">                 break;</span>
<a href="#l99.34"></a><span id="l99.34">         }</span>
<a href="#l99.35"></a><span id="l99.35">         this.__proto__.__proto__.notifyError.apply(</span>
<a href="#l99.36"></a><span id="l99.36">             this,</span>
<a href="#l99.37"></a><span id="l99.37">             err instanceof Components.interfaces.nsIException</span>
<a href="#l99.38"></a><span id="l99.38">             ? [err.result, err.message]</span>
<a href="#l99.39"></a><span id="l99.39">             : [isNaN(err) ? Components.results.NS_ERROR_FAILURE : err, msg]);</span>
<a href="#l99.40"></a><span id="l99.40">     },</span>
<a href="#l99.41"></a><span id="l99.41" class="difflineminus">-    notifyError: function calWcapCalendar_notifyError(err, msg) {</span>
<a href="#l99.42"></a><span id="l99.42" class="difflineplus">+    notifyError: function(err, msg) {</span>
<a href="#l99.43"></a><span id="l99.43">         this.notifyError_(err, msg, this);</span>
<a href="#l99.44"></a><span id="l99.44">     },</span>
<a href="#l99.45"></a><span id="l99.45"> </span>
<a href="#l99.46"></a><span id="l99.46">     // calICalendarProvider:</span>
<a href="#l99.47"></a><span id="l99.47">     get prefChromeOverlay() {</span>
<a href="#l99.48"></a><span id="l99.48">         return null;</span>
<a href="#l99.49"></a><span id="l99.49">     },</span>
<a href="#l99.50"></a><span id="l99.50">     // displayName attribute already part of calIWcapCalendar</span>
<a href="#l99.51"></a><span id="l99.51" class="difflineminus">-    createCalendar: function calWcapCalendar_createCalendar(name, url, listener) {</span>
<a href="#l99.52"></a><span id="l99.52" class="difflineplus">+    createCalendar: function(name, url, listener) {</span>
<a href="#l99.53"></a><span id="l99.53">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.54"></a><span id="l99.54">     },</span>
<a href="#l99.55"></a><span id="l99.55" class="difflineminus">-    deleteCalendar: function calWcapCalendar_deleteCalendar(calendar, listener) {</span>
<a href="#l99.56"></a><span id="l99.56" class="difflineplus">+    deleteCalendar: function(calendar, listener) {</span>
<a href="#l99.57"></a><span id="l99.57">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.58"></a><span id="l99.58">     },</span>
<a href="#l99.59"></a><span id="l99.59" class="difflineminus">-    getCalendar: function calWcapCalendar_getCalendar(url) {</span>
<a href="#l99.60"></a><span id="l99.60" class="difflineplus">+    getCalendar: function(url) {</span>
<a href="#l99.61"></a><span id="l99.61">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.62"></a><span id="l99.62">     },</span>
<a href="#l99.63"></a><span id="l99.63"> </span>
<a href="#l99.64"></a><span id="l99.64">     // calICalendar:</span>
<a href="#l99.65"></a><span id="l99.65">     get name() {</span>
<a href="#l99.66"></a><span id="l99.66">         let name = this.getProperty(&quot;name&quot;);</span>
<a href="#l99.67"></a><span id="l99.67">         if (!name) {</span>
<a href="#l99.68"></a><span id="l99.68">             name = this.displayName;</span>
<a href="#l99.69"></a><span id="l99.69" class="difflineat">@@ -114,17 +114,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l99.70"></a><span id="l99.70">                 let end = path.indexOf(&quot;&amp;&quot;, start);</span>
<a href="#l99.71"></a><span id="l99.71">                 this.m_calId = decodeURIComponent(</span>
<a href="#l99.72"></a><span id="l99.72">                     path.substring(start, end == -1 ? path.length : end));</span>
<a href="#l99.73"></a><span id="l99.73">             }</span>
<a href="#l99.74"></a><span id="l99.74">         }</span>
<a href="#l99.75"></a><span id="l99.75">         return this.uri;</span>
<a href="#l99.76"></a><span id="l99.76">     },</span>
<a href="#l99.77"></a><span id="l99.77"> </span>
<a href="#l99.78"></a><span id="l99.78" class="difflineminus">-    getProperty: function calWcapCalendar_getProperty(aName) {</span>
<a href="#l99.79"></a><span id="l99.79" class="difflineplus">+    getProperty: function(aName) {</span>
<a href="#l99.80"></a><span id="l99.80">         switch (aName) {</span>
<a href="#l99.81"></a><span id="l99.81">             case &quot;cache.supported&quot;:</span>
<a href="#l99.82"></a><span id="l99.82">                 return true;</span>
<a href="#l99.83"></a><span id="l99.83">             case &quot;timezones.provider&quot;:</span>
<a href="#l99.84"></a><span id="l99.84">                 return ((this.m_session &amp;&amp; this.session.isLoggedIn) ? this.session : null);</span>
<a href="#l99.85"></a><span id="l99.85">             case &quot;organizerId&quot;:</span>
<a href="#l99.86"></a><span id="l99.86">                 return this.ownerId;</span>
<a href="#l99.87"></a><span id="l99.87">             case &quot;organizerCN&quot;:</span>
<a href="#l99.88"></a><span id="l99.88" class="difflineat">@@ -160,17 +160,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l99.89"></a><span id="l99.89">                     // tweak in-composite to false for secondary calendars:</span>
<a href="#l99.90"></a><span id="l99.90">                     value = false;</span>
<a href="#l99.91"></a><span id="l99.91">                 }</span>
<a href="#l99.92"></a><span id="l99.92">                 break;</span>
<a href="#l99.93"></a><span id="l99.93">         }</span>
<a href="#l99.94"></a><span id="l99.94">         return value;</span>
<a href="#l99.95"></a><span id="l99.95">     },</span>
<a href="#l99.96"></a><span id="l99.96"> </span>
<a href="#l99.97"></a><span id="l99.97" class="difflineminus">-    setProperty: function calWcapCalendar_setProperty(aName, aValue) {</span>
<a href="#l99.98"></a><span id="l99.98" class="difflineplus">+    setProperty: function(aName, aValue) {</span>
<a href="#l99.99"></a><span id="l99.99">         switch (aName) {</span>
<a href="#l99.100"></a><span id="l99.100">             case &quot;disabled&quot;:</span>
<a href="#l99.101"></a><span id="l99.101">                 if (this.isDefaultCalendar) {</span>
<a href="#l99.102"></a><span id="l99.102">                     // disabling/enabling the default calendar will enable/disable all calendars</span>
<a href="#l99.103"></a><span id="l99.103">                     // belonging to the same session:</span>
<a href="#l99.104"></a><span id="l99.104">                     for (let calendar of this.session.getRegisteredCalendars()) {</span>
<a href="#l99.105"></a><span id="l99.105">                         if (!calendar.isDefaultCalendar) {</span>
<a href="#l99.106"></a><span id="l99.106">                             calendar.setProperty(&quot;disabled&quot;, aValue);</span>
<a href="#l99.107"></a><span id="l99.107" class="difflineat">@@ -179,51 +179,51 @@ calWcapCalendar.prototype = {</span>
<a href="#l99.108"></a><span id="l99.108">                 }</span>
<a href="#l99.109"></a><span id="l99.109">                 // falls through</span>
<a href="#l99.110"></a><span id="l99.110">             default:</span>
<a href="#l99.111"></a><span id="l99.111">                 this.__proto__.__proto__.setProperty.apply(this, arguments);</span>
<a href="#l99.112"></a><span id="l99.112">                 break;</span>
<a href="#l99.113"></a><span id="l99.113">         }</span>
<a href="#l99.114"></a><span id="l99.114">     },</span>
<a href="#l99.115"></a><span id="l99.115"> </span>
<a href="#l99.116"></a><span id="l99.116" class="difflineminus">-    notifyObservers: function calWcapCalendar_notifyObservers(func, args) {</span>
<a href="#l99.117"></a><span id="l99.117" class="difflineplus">+    notifyObservers: function(func, args) {</span>
<a href="#l99.118"></a><span id="l99.118">         if (g_bShutdown) {</span>
<a href="#l99.119"></a><span id="l99.119">             return;</span>
<a href="#l99.120"></a><span id="l99.120">         }</span>
<a href="#l99.121"></a><span id="l99.121">         this.observers.notify(func, args);</span>
<a href="#l99.122"></a><span id="l99.122">     },</span>
<a href="#l99.123"></a><span id="l99.123"> </span>
<a href="#l99.124"></a><span id="l99.124">     // xxx todo: batch currently not used</span>
<a href="#l99.125"></a><span id="l99.125" class="difflineminus">-    startBatch: function calWcapCalendar_startBatch() {</span>
<a href="#l99.126"></a><span id="l99.126" class="difflineplus">+    startBatch: function() {</span>
<a href="#l99.127"></a><span id="l99.127">         this.notifyObservers(&quot;onStartBatch&quot;);</span>
<a href="#l99.128"></a><span id="l99.128">     },</span>
<a href="#l99.129"></a><span id="l99.129" class="difflineminus">-    endBatch: function calWcapCalendar_endBatch() {</span>
<a href="#l99.130"></a><span id="l99.130" class="difflineplus">+    endBatch: function() {</span>
<a href="#l99.131"></a><span id="l99.131">         this.notifyObservers(&quot;onEndBatch&quot;);</span>
<a href="#l99.132"></a><span id="l99.132">     },</span>
<a href="#l99.133"></a><span id="l99.133"> </span>
<a href="#l99.134"></a><span id="l99.134">     get canRefresh() {</span>
<a href="#l99.135"></a><span id="l99.135">         return true;</span>
<a href="#l99.136"></a><span id="l99.136">     },</span>
<a href="#l99.137"></a><span id="l99.137" class="difflineminus">-    refresh: function calWcapCalendar_refresh() {</span>
<a href="#l99.138"></a><span id="l99.138" class="difflineplus">+    refresh: function() {</span>
<a href="#l99.139"></a><span id="l99.139">         log(&quot;refresh.&quot;, this);</span>
<a href="#l99.140"></a><span id="l99.140">         // invalidate cached results:</span>
<a href="#l99.141"></a><span id="l99.141">         delete this.m_cachedResults;</span>
<a href="#l99.142"></a><span id="l99.142">         // notify about refreshed calendar:</span>
<a href="#l99.143"></a><span id="l99.143">         this.notifyObservers(&quot;onLoad&quot;, [this]);</span>
<a href="#l99.144"></a><span id="l99.144">     },</span>
<a href="#l99.145"></a><span id="l99.145"> </span>
<a href="#l99.146"></a><span id="l99.146" class="difflineminus">-    issueNetworkRequest: function calWcapCalendar_issueNetworkRequest(</span>
<a href="#l99.147"></a><span id="l99.147" class="difflineplus">+    issueNetworkRequest: function(</span>
<a href="#l99.148"></a><span id="l99.148">               request, respFunc, dataConvFunc, wcapCommand, params, accessRights) {</span>
<a href="#l99.149"></a><span id="l99.149">         let self = this;</span>
<a href="#l99.150"></a><span id="l99.150">         // - bootstrap problem: no cal_props, no access check, no default calId</span>
<a href="#l99.151"></a><span id="l99.151">         // - assure being logged in, thus the default cal_props are available</span>
<a href="#l99.152"></a><span id="l99.152">         // - every subscribed calendar will come along with cal_props</span>
<a href="#l99.153"></a><span id="l99.153">         return this.session.getSessionId(</span>
<a href="#l99.154"></a><span id="l99.154">             request,</span>
<a href="#l99.155"></a><span id="l99.155" class="difflineminus">-            function getSessionId_resp(err, sessionId) {</span>
<a href="#l99.156"></a><span id="l99.156" class="difflineplus">+            function(err, sessionId) {</span>
<a href="#l99.157"></a><span id="l99.157">                 try {</span>
<a href="#l99.158"></a><span id="l99.158">                     if (err) {</span>
<a href="#l99.159"></a><span id="l99.159">                         throw err;</span>
<a href="#l99.160"></a><span id="l99.160">                     }</span>
<a href="#l99.161"></a><span id="l99.161">                     self.assureAccess(accessRights);</span>
<a href="#l99.162"></a><span id="l99.162">                     params += (&quot;&amp;calid=&quot; + encodeURIComponent(self.calId));</span>
<a href="#l99.163"></a><span id="l99.163">                     self.session.issueNetworkRequest(request, respFunc, dataConvFunc, wcapCommand, params);</span>
<a href="#l99.164"></a><span id="l99.164">                 } catch (exc) {</span>
<a href="#l99.165"></a><span id="l99.165" class="difflineat">@@ -290,17 +290,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l99.166"></a><span id="l99.166">         return (this.ownerId == this.session.userId);</span>
<a href="#l99.167"></a><span id="l99.167">     },</span>
<a href="#l99.168"></a><span id="l99.168"> </span>
<a href="#l99.169"></a><span id="l99.169">     get isDefaultCalendar() {</span>
<a href="#l99.170"></a><span id="l99.170">         return !this.m_calId;</span>
<a href="#l99.171"></a><span id="l99.171">     },</span>
<a href="#l99.172"></a><span id="l99.172"> </span>
<a href="#l99.173"></a><span id="l99.173">     m_calProps: null,</span>
<a href="#l99.174"></a><span id="l99.174" class="difflineminus">-    getCalendarProperties: function calWcapCalendar_getCalendarProperties(propName, out_count) {</span>
<a href="#l99.175"></a><span id="l99.175" class="difflineplus">+    getCalendarProperties: function(propName, out_count) {</span>
<a href="#l99.176"></a><span id="l99.176">         if (!this.m_calProps) {</span>
<a href="#l99.177"></a><span id="l99.177">             log(&quot;soft error: no calprops available, most possibly not logged in.&quot;, this);</span>
<a href="#l99.178"></a><span id="l99.178">         }</span>
<a href="#l99.179"></a><span id="l99.179">         let ret = filterXmlNodes(propName, this.m_calProps);</span>
<a href="#l99.180"></a><span id="l99.180">         if (out_count) {</span>
<a href="#l99.181"></a><span id="l99.181">             out_count.value = ret.length;</span>
<a href="#l99.182"></a><span id="l99.182">         }</span>
<a href="#l99.183"></a><span id="l99.183">         return ret;</span>
<a href="#l99.184"></a><span id="l99.184" class="difflineat">@@ -313,65 +313,64 @@ calWcapCalendar.prototype = {</span>
<a href="#l99.185"></a><span id="l99.185">         } else {</span>
<a href="#l99.186"></a><span id="l99.186">             logWarning(&quot;defaultTimezone: cannot get X-NSCP-CALPROPS-TZID!&quot;, this);</span>
<a href="#l99.187"></a><span id="l99.187">             // try to use local one if supported:</span>
<a href="#l99.188"></a><span id="l99.188">             tzid = cal.getTimezoneService().defaultTimezone.tzid;</span>
<a href="#l99.189"></a><span id="l99.189">             return (this.session.getTimezone(tzid) ? tzid : &quot;UTC&quot;);</span>
<a href="#l99.190"></a><span id="l99.190">         }</span>
<a href="#l99.191"></a><span id="l99.191">     },</span>
<a href="#l99.192"></a><span id="l99.192"> </span>
<a href="#l99.193"></a><span id="l99.193" class="difflineminus">-    getAlignedTzid: function calWcapCalendar_getAlignedTzid(tz) {</span>
<a href="#l99.194"></a><span id="l99.194" class="difflineplus">+    getAlignedTzid: function(tz) {</span>
<a href="#l99.195"></a><span id="l99.195">         let tzid = tz.tzid;</span>
<a href="#l99.196"></a><span id="l99.196">         // check whether it is one cs supports:</span>
<a href="#l99.197"></a><span id="l99.197">         if (tz.isFloating || !this.session.getTimezone(tzid)) {</span>
<a href="#l99.198"></a><span id="l99.198">             log(&quot;not a supported timezone: &quot; + tzid);</span>
<a href="#l99.199"></a><span id="l99.199">             // bug 435436:</span>
<a href="#l99.200"></a><span id="l99.200">             // xxx todo: we could further on search for a matching region,</span>
<a href="#l99.201"></a><span id="l99.201">             //           e.g. CET (in TZNAME), but for now stick to</span>
<a href="#l99.202"></a><span id="l99.202">             //           user's default if not supported directly</span>
<a href="#l99.203"></a><span id="l99.203">             let ret = this.defaultTimezone;</span>
<a href="#l99.204"></a><span id="l99.204">             // use calendar's default:</span>
<a href="#l99.205"></a><span id="l99.205">             log(tzid + &quot; not supported, falling back to default: &quot; + ret, this);</span>
<a href="#l99.206"></a><span id="l99.206">             return ret;</span>
<a href="#l99.207"></a><span id="l99.207">         }</span>
<a href="#l99.208"></a><span id="l99.208">         return tzid;</span>
<a href="#l99.209"></a><span id="l99.209">     },</span>
<a href="#l99.210"></a><span id="l99.210"> </span>
<a href="#l99.211"></a><span id="l99.211" class="difflineminus">-    checkAccess: function calWcapCalendar_checkAccess(accessControlBits) {</span>
<a href="#l99.212"></a><span id="l99.212" class="difflineplus">+    checkAccess: function(accessControlBits) {</span>
<a href="#l99.213"></a><span id="l99.213">         // xxx todo: take real acl into account</span>
<a href="#l99.214"></a><span id="l99.214">         // for now, optimistically assuming that everybody has full access, server will check:</span>
<a href="#l99.215"></a><span id="l99.215">         let granted = calIWcapCalendar.AC_FULL;</span>
<a href="#l99.216"></a><span id="l99.216">         if (this.getProperty(&quot;readOnly&quot;)) {</span>
<a href="#l99.217"></a><span id="l99.217">             granted &amp;= ~(calIWcapCalendar.AC_COMP_WRITE |</span>
<a href="#l99.218"></a><span id="l99.218">                          calIWcapCalendar.AC_PROP_WRITE);</span>
<a href="#l99.219"></a><span id="l99.219">         }</span>
<a href="#l99.220"></a><span id="l99.220">         // check whether every bit fits:</span>
<a href="#l99.221"></a><span id="l99.221">         return ((accessControlBits &amp; granted) == accessControlBits);</span>
<a href="#l99.222"></a><span id="l99.222">     },</span>
<a href="#l99.223"></a><span id="l99.223"> </span>
<a href="#l99.224"></a><span id="l99.224" class="difflineminus">-    assureAccess: function calWcapCalendar_assureAccess(accessControlBits) {</span>
<a href="#l99.225"></a><span id="l99.225" class="difflineplus">+    assureAccess: function(accessControlBits) {</span>
<a href="#l99.226"></a><span id="l99.226">         if (!this.checkAccess(accessControlBits &amp; (calIWcapCalendar.AC_COMP_WRITE |</span>
<a href="#l99.227"></a><span id="l99.227">                                                    calIWcapCalendar.AC_PROP_WRITE))) {</span>
<a href="#l99.228"></a><span id="l99.228">             // throw different error code for read-only:</span>
<a href="#l99.229"></a><span id="l99.229">             throw new Components.Exception(errorToString(calIErrors.CAL_IS_READONLY),</span>
<a href="#l99.230"></a><span id="l99.230">                                            calIErrors.CAL_IS_READONLY);</span>
<a href="#l99.231"></a><span id="l99.231">         }</span>
<a href="#l99.232"></a><span id="l99.232">         if (!this.checkAccess(accessControlBits)) {</span>
<a href="#l99.233"></a><span id="l99.233">             throw new Components.Exception(errorToString(calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR),</span>
<a href="#l99.234"></a><span id="l99.234">                                            calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR);</span>
<a href="#l99.235"></a><span id="l99.235">             // xxx todo: throwing different error here, no</span>
<a href="#l99.236"></a><span id="l99.236">             //           calIErrors.CAL_IS_READONLY anymore</span>
<a href="#l99.237"></a><span id="l99.237">         }</span>
<a href="#l99.238"></a><span id="l99.238">     },</span>
<a href="#l99.239"></a><span id="l99.239"> </span>
<a href="#l99.240"></a><span id="l99.240" class="difflineminus">-    defineAccessControl: function calWcapCalendar_defineAccessControl(userId, accessControlBits) {</span>
<a href="#l99.241"></a><span id="l99.241" class="difflineplus">+    defineAccessControl: function(userId, accessControlBits) {</span>
<a href="#l99.242"></a><span id="l99.242">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.243"></a><span id="l99.243">     },</span>
<a href="#l99.244"></a><span id="l99.244"> </span>
<a href="#l99.245"></a><span id="l99.245" class="difflineminus">-    resetAccessControl: function calWcapCalendar_resetAccessControl(userId) {</span>
<a href="#l99.246"></a><span id="l99.246" class="difflineplus">+    resetAccessControl: function(userId) {</span>
<a href="#l99.247"></a><span id="l99.247">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.248"></a><span id="l99.248">     },</span>
<a href="#l99.249"></a><span id="l99.249"> </span>
<a href="#l99.250"></a><span id="l99.250" class="difflineminus">-    getAccessControlDefinitions: function calWcapCalendar_getAccessControlDefinitions(out_count, out_users,</span>
<a href="#l99.251"></a><span id="l99.251" class="difflineminus">-                                                                                      out_accessControlBits) {</span>
<a href="#l99.252"></a><span id="l99.252" class="difflineplus">+    getAccessControlDefinitions: function(out_count, out_users, out_accessControlBits) {</span>
<a href="#l99.253"></a><span id="l99.253">         throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.254"></a><span id="l99.254">     }</span>
<a href="#l99.255"></a><span id="l99.255"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l100.4"></a><span id="l100.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l100.5"></a><span id="l100.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l100.6"></a><span id="l100.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l100.7"></a><span id="l100.7"> </span>
<a href="#l100.8"></a><span id="l100.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l100.9"></a><span id="l100.9"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l100.10"></a><span id="l100.10"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l100.11"></a><span id="l100.11"> </span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-calWcapCalendar.prototype.encodeAttendee =</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineminus">-function calWcapCalendar_encodeAttendee(att) {</span>
<a href="#l100.14"></a><span id="l100.14" class="difflineplus">+calWcapCalendar.prototype.encodeAttendee = function(att) {</span>
<a href="#l100.15"></a><span id="l100.15">     if (LOG_LEVEL &gt; 2) {</span>
<a href="#l100.16"></a><span id="l100.16">         log(&quot;attendee.icalProperty.icalString=&quot; + att.icalProperty.icalString, this);</span>
<a href="#l100.17"></a><span id="l100.17">     }</span>
<a href="#l100.18"></a><span id="l100.18">     function encodeAttr(val, attr, params) {</span>
<a href="#l100.19"></a><span id="l100.19">         if (val &amp;&amp; val.length &gt; 0) {</span>
<a href="#l100.20"></a><span id="l100.20">             if (params.length &gt; 0) {</span>
<a href="#l100.21"></a><span id="l100.21">                 params += &quot;^&quot;;</span>
<a href="#l100.22"></a><span id="l100.22">             }</span>
<a href="#l100.23"></a><span id="l100.23" class="difflineat">@@ -28,18 +27,17 @@ function calWcapCalendar_encodeAttendee(</span>
<a href="#l100.24"></a><span id="l100.24">     params = encodeAttr(att.role, &quot;ROLE&quot;, params);</span>
<a href="#l100.25"></a><span id="l100.25">     let cn = att.commonName;</span>
<a href="#l100.26"></a><span id="l100.26">     if (cn) {</span>
<a href="#l100.27"></a><span id="l100.27">         params = encodeAttr(cn.replace(/[;:]/g, &quot; &quot;), &quot;CN&quot;, params); // remove ';' and ':' from CN</span>
<a href="#l100.28"></a><span id="l100.28">     }</span>
<a href="#l100.29"></a><span id="l100.29">     return encodeAttr(att.id, null, params);</span>
<a href="#l100.30"></a><span id="l100.30"> };</span>
<a href="#l100.31"></a><span id="l100.31"> </span>
<a href="#l100.32"></a><span id="l100.32" class="difflineminus">-calWcapCalendar.prototype.getRecurrenceParams =</span>
<a href="#l100.33"></a><span id="l100.33" class="difflineminus">-function calWcapCalendar_getRecurrenceParams(item, out_rrules, out_rdates, out_exrules, out_exdates) {</span>
<a href="#l100.34"></a><span id="l100.34" class="difflineplus">+calWcapCalendar.prototype.getRecurrenceParams = function(item, out_rrules, out_rdates, out_exrules, out_exdates) {</span>
<a href="#l100.35"></a><span id="l100.35">     // recurrences:</span>
<a href="#l100.36"></a><span id="l100.36">     out_rrules.value = [];</span>
<a href="#l100.37"></a><span id="l100.37">     out_rdates.value = [];</span>
<a href="#l100.38"></a><span id="l100.38">     out_exrules.value = [];</span>
<a href="#l100.39"></a><span id="l100.39">     out_exdates.value = [];</span>
<a href="#l100.40"></a><span id="l100.40">     if (item.recurrenceInfo) {</span>
<a href="#l100.41"></a><span id="l100.41">         let rItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l100.42"></a><span id="l100.42">         for (let rItem of rItems) {</span>
<a href="#l100.43"></a><span id="l100.43" class="difflineat">@@ -68,18 +66,17 @@ function calWcapCalendar_getRecurrencePa</span>
<a href="#l100.44"></a><span id="l100.44">     }</span>
<a href="#l100.45"></a><span id="l100.45"> };</span>
<a href="#l100.46"></a><span id="l100.46"> </span>
<a href="#l100.47"></a><span id="l100.47"> function sameStringSet(list, list_) {</span>
<a href="#l100.48"></a><span id="l100.48">     return list.length == list_.length &amp;&amp;</span>
<a href="#l100.49"></a><span id="l100.49">            list.every(x =&gt; list_.some(y =&gt; x == y));</span>
<a href="#l100.50"></a><span id="l100.50"> }</span>
<a href="#l100.51"></a><span id="l100.51"> </span>
<a href="#l100.52"></a><span id="l100.52" class="difflineminus">-calWcapCalendar.prototype.encodeRecurrenceParams =</span>
<a href="#l100.53"></a><span id="l100.53" class="difflineminus">-    function calWcapCalendar_encodeRecurrenceParams(item, oldItem, excludeExdates) {</span>
<a href="#l100.54"></a><span id="l100.54" class="difflineplus">+calWcapCalendar.prototype.encodeRecurrenceParams = function(item, oldItem, excludeExdates) {</span>
<a href="#l100.55"></a><span id="l100.55">     let rrules = {};</span>
<a href="#l100.56"></a><span id="l100.56">     let rdates = {};</span>
<a href="#l100.57"></a><span id="l100.57">     let exrules = {};</span>
<a href="#l100.58"></a><span id="l100.58">     let exdates = {};</span>
<a href="#l100.59"></a><span id="l100.59">     this.getRecurrenceParams(item, rrules, rdates, exrules, exdates);</span>
<a href="#l100.60"></a><span id="l100.60">     if (oldItem) {</span>
<a href="#l100.61"></a><span id="l100.61">         // actually only write changes if an old item has been changed, because</span>
<a href="#l100.62"></a><span id="l100.62">         // cs recreates the whole series if a rule has changed.</span>
<a href="#l100.63"></a><span id="l100.63" class="difflineat">@@ -132,18 +129,17 @@ calWcapCalendar.prototype.encodeRecurren</span>
<a href="#l100.64"></a><span id="l100.64">     return ret;</span>
<a href="#l100.65"></a><span id="l100.65">     // xxx todo:</span>
<a href="#l100.66"></a><span id="l100.66">     // rchange=1: expand recurrences,</span>
<a href="#l100.67"></a><span id="l100.67">     // or whether to replace the rrule, ambiguous documentation!!!</span>
<a href="#l100.68"></a><span id="l100.68">     // check with store(with no uid) upon adoptItem() which behaves strange</span>
<a href="#l100.69"></a><span id="l100.69">     // if rchange=0 is set!</span>
<a href="#l100.70"></a><span id="l100.70"> };</span>
<a href="#l100.71"></a><span id="l100.71"> </span>
<a href="#l100.72"></a><span id="l100.72" class="difflineminus">-calWcapCalendar.prototype.getAlarmParams =</span>
<a href="#l100.73"></a><span id="l100.73" class="difflineminus">-function calWcapCalendar_getAlarmParams(item) {</span>
<a href="#l100.74"></a><span id="l100.74" class="difflineplus">+calWcapCalendar.prototype.getAlarmParams = function(item) {</span>
<a href="#l100.75"></a><span id="l100.75">     let params = null;</span>
<a href="#l100.76"></a><span id="l100.76">     // xxx TODO ALARMSUPPORT check if WCAP supports multiple alarms</span>
<a href="#l100.77"></a><span id="l100.77">     let alarms = item.getAlarms({}).filter(x =&gt; x.action == &quot;EMAIL&quot;);</span>
<a href="#l100.78"></a><span id="l100.78">     let alarm = alarms.length &gt; 0 &amp;&amp; alarms[0];</span>
<a href="#l100.79"></a><span id="l100.79"> </span>
<a href="#l100.80"></a><span id="l100.80">     if (alarm) {</span>
<a href="#l100.81"></a><span id="l100.81">         let alarmStart = cal.alarms.calculateAlarmOffset(item, alarm);</span>
<a href="#l100.82"></a><span id="l100.82">         if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l100.83"></a><span id="l100.83" class="difflineat">@@ -184,43 +180,40 @@ function getAttendeeByCalId(atts, calId)</span>
<a href="#l100.84"></a><span id="l100.84">     for (let att of atts) {</span>
<a href="#l100.85"></a><span id="l100.85">         if (getCalId(att) == calId) {</span>
<a href="#l100.86"></a><span id="l100.86">             return att;</span>
<a href="#l100.87"></a><span id="l100.87">         }</span>
<a href="#l100.88"></a><span id="l100.88">     }</span>
<a href="#l100.89"></a><span id="l100.89">     return null;</span>
<a href="#l100.90"></a><span id="l100.90"> }</span>
<a href="#l100.91"></a><span id="l100.91"> </span>
<a href="#l100.92"></a><span id="l100.92" class="difflineminus">-calWcapCalendar.prototype.isInvitation =</span>
<a href="#l100.93"></a><span id="l100.93" class="difflineminus">-function calWcapCalendar_isInvitation(item) {</span>
<a href="#l100.94"></a><span id="l100.94" class="difflineplus">+calWcapCalendar.prototype.isInvitation = function(item) {</span>
<a href="#l100.95"></a><span id="l100.95">     if (!this.session.isLoggedIn) {</span>
<a href="#l100.96"></a><span id="l100.96">         return false; // don't know</span>
<a href="#l100.97"></a><span id="l100.97">     }</span>
<a href="#l100.98"></a><span id="l100.98">     let calId = this.calId;</span>
<a href="#l100.99"></a><span id="l100.99">     let orgCalId = getCalId(item.organizer);</span>
<a href="#l100.100"></a><span id="l100.100">     if (!orgCalId || (orgCalId == calId)) {</span>
<a href="#l100.101"></a><span id="l100.101">         return false;</span>
<a href="#l100.102"></a><span id="l100.102">     }</span>
<a href="#l100.103"></a><span id="l100.103">     return (this.getInvitedAttendee(item) != null);</span>
<a href="#l100.104"></a><span id="l100.104"> };</span>
<a href="#l100.105"></a><span id="l100.105"> </span>
<a href="#l100.106"></a><span id="l100.106" class="difflineminus">-calWcapCalendar.prototype.getInvitedAttendee =</span>
<a href="#l100.107"></a><span id="l100.107" class="difflineminus">-function calWcapCalendar_getInvitedAttendee(item) {</span>
<a href="#l100.108"></a><span id="l100.108" class="difflineplus">+calWcapCalendar.prototype.getInvitedAttendee = function(item) {</span>
<a href="#l100.109"></a><span id="l100.109">     let att = getAttendeeByCalId(item.getAttendees({}), this.calId);</span>
<a href="#l100.110"></a><span id="l100.110">     if (!att) { // try to find mail address</span>
<a href="#l100.111"></a><span id="l100.111">         let ar = this.session.getUserPreferences(&quot;X-NSCP-WCAP-PREF-mail&quot;);</span>
<a href="#l100.112"></a><span id="l100.112">         if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l100.113"></a><span id="l100.113">             att = item.getAttendeeById(&quot;mailto:&quot; + ar[0]);</span>
<a href="#l100.114"></a><span id="l100.114">         }</span>
<a href="#l100.115"></a><span id="l100.115">     }</span>
<a href="#l100.116"></a><span id="l100.116">     return att;</span>
<a href="#l100.117"></a><span id="l100.117"> };</span>
<a href="#l100.118"></a><span id="l100.118"> </span>
<a href="#l100.119"></a><span id="l100.119" class="difflineminus">-calWcapCalendar.prototype.canNotify =</span>
<a href="#l100.120"></a><span id="l100.120" class="difflineminus">-function calWcapCalendar_canNotify(method, item) {</span>
<a href="#l100.121"></a><span id="l100.121" class="difflineplus">+calWcapCalendar.prototype.canNotify = function(method, item) {</span>
<a href="#l100.122"></a><span id="l100.122">     if (!this.session.isLoggedIn) {</span>
<a href="#l100.123"></a><span id="l100.123">         return false;</span>
<a href="#l100.124"></a><span id="l100.124">     }</span>
<a href="#l100.125"></a><span id="l100.125">     let calId = this.calId;</span>
<a href="#l100.126"></a><span id="l100.126">     switch (method) {</span>
<a href="#l100.127"></a><span id="l100.127">         case &quot;REQUEST&quot;:</span>
<a href="#l100.128"></a><span id="l100.128">         case &quot;CANCEL&quot;:</span>
<a href="#l100.129"></a><span id="l100.129">             // when creating new items, mind that organizer's id</span>
<a href="#l100.130"></a><span id="l100.130" class="difflineat">@@ -272,18 +265,17 @@ function diffProperty(newItem, oldItem, </span>
<a href="#l100.131"></a><span id="l100.131"> /* eslint-disable no-unused-vars */</span>
<a href="#l100.132"></a><span id="l100.132"> var METHOD_PUBLISH = 1;</span>
<a href="#l100.133"></a><span id="l100.133"> var METHOD_REQUEST = 2;</span>
<a href="#l100.134"></a><span id="l100.134"> var METHOD_REPLY = 4;</span>
<a href="#l100.135"></a><span id="l100.135"> var METHOD_CANCEL = 8;</span>
<a href="#l100.136"></a><span id="l100.136"> var METHOD_UPDATE = 256;</span>
<a href="#l100.137"></a><span id="l100.137"> /* eslint-enable no-unused-vars */</span>
<a href="#l100.138"></a><span id="l100.138"> </span>
<a href="#l100.139"></a><span id="l100.139" class="difflineminus">-calWcapCalendar.prototype.storeItem =</span>
<a href="#l100.140"></a><span id="l100.140" class="difflineminus">-function calWcapCalendar_storeItem(bAddItem, item, oldItem, request) {</span>
<a href="#l100.141"></a><span id="l100.141" class="difflineplus">+calWcapCalendar.prototype.storeItem = function(bAddItem, item, oldItem, request) {</span>
<a href="#l100.142"></a><span id="l100.142">     function getOrgId(orgItem) {</span>
<a href="#l100.143"></a><span id="l100.143">         return (orgItem &amp;&amp; orgItem.organizer &amp;&amp; orgItem.organizer.id ? orgItem.organizer.id : null);</span>
<a href="#l100.144"></a><span id="l100.144">     }</span>
<a href="#l100.145"></a><span id="l100.145">     function encodeAttendees(atts) {</span>
<a href="#l100.146"></a><span id="l100.146">         function attendeeSort(one, two) {</span>
<a href="#l100.147"></a><span id="l100.147">             one = one.id;</span>
<a href="#l100.148"></a><span id="l100.148">             two = two.id;</span>
<a href="#l100.149"></a><span id="l100.149">             if (one == two) {</span>
<a href="#l100.150"></a><span id="l100.150" class="difflineat">@@ -591,18 +583,17 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l100.151"></a><span id="l100.151">         };</span>
<a href="#l100.152"></a><span id="l100.152">         this.issueNetworkRequest(request, netRespFunc, stringToIcal,</span>
<a href="#l100.153"></a><span id="l100.153">                                  bIsEvent ? &quot;storeevents&quot; : &quot;storetodos&quot;, params,</span>
<a href="#l100.154"></a><span id="l100.154">                                  calIWcapCalendar.AC_COMP_READ |</span>
<a href="#l100.155"></a><span id="l100.155">                                  calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l100.156"></a><span id="l100.156">     }</span>
<a href="#l100.157"></a><span id="l100.157"> };</span>
<a href="#l100.158"></a><span id="l100.158"> </span>
<a href="#l100.159"></a><span id="l100.159" class="difflineminus">-calWcapCalendar.prototype.tunnelXProps =</span>
<a href="#l100.160"></a><span id="l100.160" class="difflineminus">-function calWcapCalendar_tunnelXProps(destItem, srcItem) {</span>
<a href="#l100.161"></a><span id="l100.161" class="difflineplus">+calWcapCalendar.prototype.tunnelXProps = function(destItem, srcItem) {</span>
<a href="#l100.162"></a><span id="l100.162">     // xxx todo: temp workaround for bug in calItemBase.js</span>
<a href="#l100.163"></a><span id="l100.163">     if (!isParent(srcItem)) {</span>
<a href="#l100.164"></a><span id="l100.164">         return;</span>
<a href="#l100.165"></a><span id="l100.165">     }</span>
<a href="#l100.166"></a><span id="l100.166">     // tunnel alarm X-MOZ-SNOOZE only if alarm is still set:</span>
<a href="#l100.167"></a><span id="l100.167">     // TODO ALARMSUPPORT still needed when showing alarms as EMAIL for wcap?</span>
<a href="#l100.168"></a><span id="l100.168">     let hasAlarms = destItem.getAlarms({}).length;</span>
<a href="#l100.169"></a><span id="l100.169">     let enumerator = srcItem.propertyEnumerator;</span>
<a href="#l100.170"></a><span id="l100.170" class="difflineat">@@ -627,21 +618,20 @@ function calWcapCalendar_tunnelXProps(de</span>
<a href="#l100.171"></a><span id="l100.171">                 }</span>
<a href="#l100.172"></a><span id="l100.172">             }</span>
<a href="#l100.173"></a><span id="l100.173">         } catch (exc) {</span>
<a href="#l100.174"></a><span id="l100.174">             logError(exc, this);</span>
<a href="#l100.175"></a><span id="l100.175">         }</span>
<a href="#l100.176"></a><span id="l100.176">     }</span>
<a href="#l100.177"></a><span id="l100.177"> };</span>
<a href="#l100.178"></a><span id="l100.178"> </span>
<a href="#l100.179"></a><span id="l100.179" class="difflineminus">-calWcapCalendar.prototype.adoptItem =</span>
<a href="#l100.180"></a><span id="l100.180" class="difflineminus">-function calWcapCalendar_adoptItem(item, listener) {</span>
<a href="#l100.181"></a><span id="l100.181" class="difflineplus">+calWcapCalendar.prototype.adoptItem = function(item, listener) {</span>
<a href="#l100.182"></a><span id="l100.182">     let self = this;</span>
<a href="#l100.183"></a><span id="l100.183">     let request = new calWcapRequest(</span>
<a href="#l100.184"></a><span id="l100.184" class="difflineminus">-        function adoptItem_resp(oprequest, err, newItem) {</span>
<a href="#l100.185"></a><span id="l100.185" class="difflineplus">+        function(oprequest, err, newItem) {</span>
<a href="#l100.186"></a><span id="l100.186">             self.notifyOperationComplete(listener,</span>
<a href="#l100.187"></a><span id="l100.187">                                          getResultCode(err),</span>
<a href="#l100.188"></a><span id="l100.188">                                          calIOperationListener.ADD,</span>
<a href="#l100.189"></a><span id="l100.189">                                          err ? item.id : newItem.id,</span>
<a href="#l100.190"></a><span id="l100.190">                                          err ? err : newItem);</span>
<a href="#l100.191"></a><span id="l100.191">             if (!err &amp;&amp; self == self.superCalendar) {</span>
<a href="#l100.192"></a><span id="l100.192">                 self.notifyObservers(&quot;onAddItem&quot;, [newItem]);</span>
<a href="#l100.193"></a><span id="l100.193">             }</span>
<a href="#l100.194"></a><span id="l100.194" class="difflineat">@@ -651,26 +641,24 @@ function calWcapCalendar_adoptItem(item,</span>
<a href="#l100.195"></a><span id="l100.195">     try {</span>
<a href="#l100.196"></a><span id="l100.196">         this.storeItem(true /* bAddItem */, item, null, request);</span>
<a href="#l100.197"></a><span id="l100.197">     } catch (exc) {</span>
<a href="#l100.198"></a><span id="l100.198">         request.execRespFunc(exc);</span>
<a href="#l100.199"></a><span id="l100.199">     }</span>
<a href="#l100.200"></a><span id="l100.200">     return request;</span>
<a href="#l100.201"></a><span id="l100.201"> };</span>
<a href="#l100.202"></a><span id="l100.202"> </span>
<a href="#l100.203"></a><span id="l100.203" class="difflineminus">-calWcapCalendar.prototype.addItem =</span>
<a href="#l100.204"></a><span id="l100.204" class="difflineminus">-function calWcapCalendar_addItem(item, listener) {</span>
<a href="#l100.205"></a><span id="l100.205" class="difflineplus">+calWcapCalendar.prototype.addItem = function(item, listener) {</span>
<a href="#l100.206"></a><span id="l100.206">     this.adoptItem(item.clone(), listener);</span>
<a href="#l100.207"></a><span id="l100.207"> };</span>
<a href="#l100.208"></a><span id="l100.208"> </span>
<a href="#l100.209"></a><span id="l100.209" class="difflineminus">-calWcapCalendar.prototype.modifyItem =</span>
<a href="#l100.210"></a><span id="l100.210" class="difflineminus">-function calWcapCalendar_modifyItem(newItem, oldItem, listener) {</span>
<a href="#l100.211"></a><span id="l100.211" class="difflineplus">+calWcapCalendar.prototype.modifyItem = function(newItem, oldItem, listener) {</span>
<a href="#l100.212"></a><span id="l100.212">     let self = this;</span>
<a href="#l100.213"></a><span id="l100.213">     let request = new calWcapRequest(</span>
<a href="#l100.214"></a><span id="l100.214" class="difflineminus">-        function modifyItem_resp(oprequest, err, item) {</span>
<a href="#l100.215"></a><span id="l100.215" class="difflineplus">+        function(oprequest, err, item) {</span>
<a href="#l100.216"></a><span id="l100.216">             self.notifyOperationComplete(listener,</span>
<a href="#l100.217"></a><span id="l100.217">                                          getResultCode(err),</span>
<a href="#l100.218"></a><span id="l100.218">                                          calIOperationListener.MODIFY,</span>
<a href="#l100.219"></a><span id="l100.219">                                          newItem.id, err ? err : item);</span>
<a href="#l100.220"></a><span id="l100.220">             if (!err &amp;&amp; self == self.superCalendar) {</span>
<a href="#l100.221"></a><span id="l100.221">                 self.notifyObservers(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l100.222"></a><span id="l100.222">             }</span>
<a href="#l100.223"></a><span id="l100.223">         },</span>
<a href="#l100.224"></a><span id="l100.224" class="difflineat">@@ -708,17 +696,17 @@ function calWcapCalendar_modifyItem(newI</span>
<a href="#l100.225"></a><span id="l100.225">                 if (!orgCalId || (orgCalId != this.calId)) {</span>
<a href="#l100.226"></a><span id="l100.226">                     // item does not belong to this user, so don't notify:</span>
<a href="#l100.227"></a><span id="l100.227">                     params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l100.228"></a><span id="l100.228">                 }</span>
<a href="#l100.229"></a><span id="l100.229">                 params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l100.230"></a><span id="l100.230"> </span>
<a href="#l100.231"></a><span id="l100.231">                 request.lockPending();</span>
<a href="#l100.232"></a><span id="l100.232">                 this.issueNetworkRequest(request,</span>
<a href="#l100.233"></a><span id="l100.233" class="difflineminus">-                                         function netResp(err, xml) {</span>
<a href="#l100.234"></a><span id="l100.234" class="difflineplus">+                                         function(err, xml) {</span>
<a href="#l100.235"></a><span id="l100.235">                                              try {</span>
<a href="#l100.236"></a><span id="l100.236">                                                  // ignore any error and continue storing the item:</span>
<a href="#l100.237"></a><span id="l100.237">                                                  if (LOG_LEVEL &gt; 0) {</span>
<a href="#l100.238"></a><span id="l100.238">                                                      log(&quot;modifyItem EXDATEs: &quot; +</span>
<a href="#l100.239"></a><span id="l100.239">                                                          (xml ? getWcapRequestStatusString(xml) : &quot;failed!&quot;), self);</span>
<a href="#l100.240"></a><span id="l100.240">                                                  }</span>
<a href="#l100.241"></a><span id="l100.241">                                                  // invalidate cached results:</span>
<a href="#l100.242"></a><span id="l100.242">                                                  delete self.m_cachedResults;</span>
<a href="#l100.243"></a><span id="l100.243" class="difflineat">@@ -737,21 +725,20 @@ function calWcapCalendar_modifyItem(newI</span>
<a href="#l100.244"></a><span id="l100.244">         }</span>
<a href="#l100.245"></a><span id="l100.245">         this.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l100.246"></a><span id="l100.246">     } catch (exc) {</span>
<a href="#l100.247"></a><span id="l100.247">         request.execRespFunc(exc);</span>
<a href="#l100.248"></a><span id="l100.248">     }</span>
<a href="#l100.249"></a><span id="l100.249">     return request;</span>
<a href="#l100.250"></a><span id="l100.250"> };</span>
<a href="#l100.251"></a><span id="l100.251"> </span>
<a href="#l100.252"></a><span id="l100.252" class="difflineminus">-calWcapCalendar.prototype.deleteItem =</span>
<a href="#l100.253"></a><span id="l100.253" class="difflineminus">-function calWcapCalendar_deleteItem(item, listener) {</span>
<a href="#l100.254"></a><span id="l100.254" class="difflineplus">+calWcapCalendar.prototype.deleteItem = function(item, listener) {</span>
<a href="#l100.255"></a><span id="l100.255">     let self = this;</span>
<a href="#l100.256"></a><span id="l100.256">     let request = new calWcapRequest(</span>
<a href="#l100.257"></a><span id="l100.257" class="difflineminus">-        function deleteItem_resp(oprequest, err) {</span>
<a href="#l100.258"></a><span id="l100.258" class="difflineplus">+        function(oprequest, err) {</span>
<a href="#l100.259"></a><span id="l100.259">             // xxx todo: need to notify about each deleted item if multiple?</span>
<a href="#l100.260"></a><span id="l100.260">             self.notifyOperationComplete(listener,</span>
<a href="#l100.261"></a><span id="l100.261">                                          getResultCode(err),</span>
<a href="#l100.262"></a><span id="l100.262">                                          calIOperationListener.DELETE,</span>
<a href="#l100.263"></a><span id="l100.263">                                          item.id, err ? err : item);</span>
<a href="#l100.264"></a><span id="l100.264">             if (!err &amp;&amp; self == self.superCalendar) {</span>
<a href="#l100.265"></a><span id="l100.265">                 self.notifyObservers(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l100.266"></a><span id="l100.266">             }</span>
<a href="#l100.267"></a><span id="l100.267" class="difflineat">@@ -774,17 +761,17 @@ function calWcapCalendar_deleteItem(item</span>
<a href="#l100.268"></a><span id="l100.268">         if (!orgCalId || (orgCalId != this.calId)) {</span>
<a href="#l100.269"></a><span id="l100.269">             // item does not belong to this user, so don't notify:</span>
<a href="#l100.270"></a><span id="l100.270">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l100.271"></a><span id="l100.271">         }</span>
<a href="#l100.272"></a><span id="l100.272"> </span>
<a href="#l100.273"></a><span id="l100.273">         params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l100.274"></a><span id="l100.274"> </span>
<a href="#l100.275"></a><span id="l100.275">         this.issueNetworkRequest(request,</span>
<a href="#l100.276"></a><span id="l100.276" class="difflineminus">-                                 function netResp(err, xml) {</span>
<a href="#l100.277"></a><span id="l100.277" class="difflineplus">+                                 function(err, xml) {</span>
<a href="#l100.278"></a><span id="l100.278">                                      if (err) {</span>
<a href="#l100.279"></a><span id="l100.279">                                          throw err;</span>
<a href="#l100.280"></a><span id="l100.280">                                      }</span>
<a href="#l100.281"></a><span id="l100.281">                                      // invalidate cached results:</span>
<a href="#l100.282"></a><span id="l100.282">                                      delete self.m_cachedResults;</span>
<a href="#l100.283"></a><span id="l100.283">                                      if (LOG_LEVEL &gt; 0) {</span>
<a href="#l100.284"></a><span id="l100.284">                                          log(&quot;deleteItem(): &quot; + getWcapRequestStatusString(xml), self);</span>
<a href="#l100.285"></a><span id="l100.285">                                      }</span>
<a href="#l100.286"></a><span id="l100.286" class="difflineat">@@ -792,17 +779,17 @@ function calWcapCalendar_deleteItem(item</span>
<a href="#l100.287"></a><span id="l100.287">                                  stringToXml, isEvent(item) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l100.288"></a><span id="l100.288">                                  params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l100.289"></a><span id="l100.289">     } catch (exc) {</span>
<a href="#l100.290"></a><span id="l100.290">         request.execRespFunc(exc);</span>
<a href="#l100.291"></a><span id="l100.291">     }</span>
<a href="#l100.292"></a><span id="l100.292">     return request;</span>
<a href="#l100.293"></a><span id="l100.293"> };</span>
<a href="#l100.294"></a><span id="l100.294"> </span>
<a href="#l100.295"></a><span id="l100.295" class="difflineminus">-calWcapCalendar.prototype.patchTimezone = function calWcapCalendar_patchTimezone(subComp, attr, xpropOrTz) {</span>
<a href="#l100.296"></a><span id="l100.296" class="difflineplus">+calWcapCalendar.prototype.patchTimezone = function(subComp, attr, xpropOrTz) {</span>
<a href="#l100.297"></a><span id="l100.297">     let dt = subComp[attr];</span>
<a href="#l100.298"></a><span id="l100.298">     // if TZID parameter present (all-day items), it takes precedence:</span>
<a href="#l100.299"></a><span id="l100.299">     if (dt &amp;&amp; (dt.timezone.isUTC || dt.timezone.isFloating)) {</span>
<a href="#l100.300"></a><span id="l100.300">         if (LOG_LEVEL &gt; 2) {</span>
<a href="#l100.301"></a><span id="l100.301">             log(attr + &quot; is &quot; + dt, this);</span>
<a href="#l100.302"></a><span id="l100.302">         }</span>
<a href="#l100.303"></a><span id="l100.303">         let tz;</span>
<a href="#l100.304"></a><span id="l100.304">         if (typeof xpropOrTz == &quot;string&quot;) {</span>
<a href="#l100.305"></a><span id="l100.305" class="difflineat">@@ -821,17 +808,17 @@ calWcapCalendar.prototype.patchTimezone </span>
<a href="#l100.306"></a><span id="l100.306">             }</span>
<a href="#l100.307"></a><span id="l100.307">             dt = dt.getInTimezone(tz);</span>
<a href="#l100.308"></a><span id="l100.308">             subComp[attr] = dt;</span>
<a href="#l100.309"></a><span id="l100.309">         }</span>
<a href="#l100.310"></a><span id="l100.310">     }</span>
<a href="#l100.311"></a><span id="l100.311">     return dt;</span>
<a href="#l100.312"></a><span id="l100.312"> };</span>
<a href="#l100.313"></a><span id="l100.313"> </span>
<a href="#l100.314"></a><span id="l100.314" class="difflineminus">-calWcapCalendar.prototype.parseItems = function calWcapCalendar_parseItems(</span>
<a href="#l100.315"></a><span id="l100.315" class="difflineplus">+calWcapCalendar.prototype.parseItems = function(</span>
<a href="#l100.316"></a><span id="l100.316">     icalRootComp, itemFilter, maxResults, rangeStart, rangeEnd, bLeaveMutable) {</span>
<a href="#l100.317"></a><span id="l100.317">     let items = [];</span>
<a href="#l100.318"></a><span id="l100.318">     let unexpandedItems = [];</span>
<a href="#l100.319"></a><span id="l100.319">     let uid2parent = {};</span>
<a href="#l100.320"></a><span id="l100.320">     let excItems = [];</span>
<a href="#l100.321"></a><span id="l100.321">     let fakedParents = {};</span>
<a href="#l100.322"></a><span id="l100.322"> </span>
<a href="#l100.323"></a><span id="l100.323">     let componentType = &quot;ANY&quot;;</span>
<a href="#l100.324"></a><span id="l100.324" class="difflineat">@@ -1028,21 +1015,20 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l100.325"></a><span id="l100.325">     }</span>
<a href="#l100.326"></a><span id="l100.326"> </span>
<a href="#l100.327"></a><span id="l100.327">     if (LOG_LEVEL &gt; 1) {</span>
<a href="#l100.328"></a><span id="l100.328">         log(&quot;parseItems(): returning &quot; + items.length + &quot; items&quot;, this);</span>
<a href="#l100.329"></a><span id="l100.329">     }</span>
<a href="#l100.330"></a><span id="l100.330">     return items;</span>
<a href="#l100.331"></a><span id="l100.331"> };</span>
<a href="#l100.332"></a><span id="l100.332"> </span>
<a href="#l100.333"></a><span id="l100.333" class="difflineminus">-calWcapCalendar.prototype.getItem =</span>
<a href="#l100.334"></a><span id="l100.334" class="difflineminus">-function calWcapCalendar_getItem(id, listener) {</span>
<a href="#l100.335"></a><span id="l100.335" class="difflineplus">+calWcapCalendar.prototype.getItem = function(id, listener) {</span>
<a href="#l100.336"></a><span id="l100.336">     let self = this;</span>
<a href="#l100.337"></a><span id="l100.337">     let request = new calWcapRequest(</span>
<a href="#l100.338"></a><span id="l100.338" class="difflineminus">-        function getItem_resp(oprequest, err, item) {</span>
<a href="#l100.339"></a><span id="l100.339" class="difflineplus">+        function(oprequest, err, item) {</span>
<a href="#l100.340"></a><span id="l100.340">             if (checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) ||</span>
<a href="#l100.341"></a><span id="l100.341">                 checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)) {</span>
<a href="#l100.342"></a><span id="l100.342">                 // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l100.343"></a><span id="l100.343">                 err = NS_OK;</span>
<a href="#l100.344"></a><span id="l100.344">             }</span>
<a href="#l100.345"></a><span id="l100.345">             self.notifyOperationComplete(listener,</span>
<a href="#l100.346"></a><span id="l100.346">                                          getResultCode(err),</span>
<a href="#l100.347"></a><span id="l100.347">                                          calIOperationListener.GET,</span>
<a href="#l100.348"></a><span id="l100.348" class="difflineat">@@ -1057,17 +1043,17 @@ function calWcapCalendar_getItem(id, lis</span>
<a href="#l100.349"></a><span id="l100.349">         }</span>
<a href="#l100.350"></a><span id="l100.350">         let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l100.351"></a><span id="l100.351">         params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&amp;uid=&quot;;</span>
<a href="#l100.352"></a><span id="l100.352">         params += encodeURIComponent(id);</span>
<a href="#l100.353"></a><span id="l100.353"> </span>
<a href="#l100.354"></a><span id="l100.354">         // most common: try events first</span>
<a href="#l100.355"></a><span id="l100.355">         this.issueNetworkRequest(</span>
<a href="#l100.356"></a><span id="l100.356">             request,</span>
<a href="#l100.357"></a><span id="l100.357" class="difflineminus">-            function fetchEventById_resp(err, eventRootComp) {</span>
<a href="#l100.358"></a><span id="l100.358" class="difflineplus">+            function(err, eventRootComp) {</span>
<a href="#l100.359"></a><span id="l100.359">                 function notifyResult(rootComp) {</span>
<a href="#l100.360"></a><span id="l100.360">                     let items = self.parseItems(rootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l100.361"></a><span id="l100.361">                     if (items.length &lt; 1) {</span>
<a href="#l100.362"></a><span id="l100.362">                         throw new Components.Exception(&quot;no such item!&quot;);</span>
<a href="#l100.363"></a><span id="l100.363">                     }</span>
<a href="#l100.364"></a><span id="l100.364">                     if (items.length &gt; 1) {</span>
<a href="#l100.365"></a><span id="l100.365">                         self.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l100.366"></a><span id="l100.366">                                          &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l100.367"></a><span id="l100.367" class="difflineat">@@ -1082,17 +1068,17 @@ function calWcapCalendar_getItem(id, lis</span>
<a href="#l100.368"></a><span id="l100.368">                 if (err) {</span>
<a href="#l100.369"></a><span id="l100.369">                     if (!checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) &amp;&amp;</span>
<a href="#l100.370"></a><span id="l100.370">                         !checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)) {</span>
<a href="#l100.371"></a><span id="l100.371">                         throw err;</span>
<a href="#l100.372"></a><span id="l100.372">                     }</span>
<a href="#l100.373"></a><span id="l100.373">                     // try todos:</span>
<a href="#l100.374"></a><span id="l100.374">                     self.issueNetworkRequest(</span>
<a href="#l100.375"></a><span id="l100.375">                         request,</span>
<a href="#l100.376"></a><span id="l100.376" class="difflineminus">-                        function fetchTodosById_resp(fetcherr, todoRootComp) {</span>
<a href="#l100.377"></a><span id="l100.377" class="difflineplus">+                        function(fetcherr, todoRootComp) {</span>
<a href="#l100.378"></a><span id="l100.378">                             if (fetcherr) {</span>
<a href="#l100.379"></a><span id="l100.379">                                 throw fetcherr;</span>
<a href="#l100.380"></a><span id="l100.380">                             }</span>
<a href="#l100.381"></a><span id="l100.381">                             notifyResult(todoRootComp);</span>
<a href="#l100.382"></a><span id="l100.382">                         },</span>
<a href="#l100.383"></a><span id="l100.383">                         stringToIcal, &quot;fetchtodos_by_id&quot;, params, calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l100.384"></a><span id="l100.384">                 } else {</span>
<a href="#l100.385"></a><span id="l100.385">                     notifyResult(eventRootComp);</span>
<a href="#l100.386"></a><span id="l100.386" class="difflineat">@@ -1134,26 +1120,25 @@ function getItemFilterParams(itemFilter)</span>
<a href="#l100.387"></a><span id="l100.387"> //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REQUEST_WAITFORREPLY)</span>
<a href="#l100.388"></a><span id="l100.388"> //         compstate += &quot;;REQUEST-WAITFORREPLY&quot;;</span>
<a href="#l100.389"></a><span id="l100.389">     if (compstate.length &gt; 0) {</span>
<a href="#l100.390"></a><span id="l100.390">         params += &quot;&amp;compstate=&quot; + compstate.substr(1);</span>
<a href="#l100.391"></a><span id="l100.391">     }</span>
<a href="#l100.392"></a><span id="l100.392">     return params;</span>
<a href="#l100.393"></a><span id="l100.393"> }</span>
<a href="#l100.394"></a><span id="l100.394"> </span>
<a href="#l100.395"></a><span id="l100.395" class="difflineminus">-calWcapCalendar.prototype.getItems =</span>
<a href="#l100.396"></a><span id="l100.396" class="difflineminus">-function calWcapCalendar_getItems(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l100.397"></a><span id="l100.397" class="difflineplus">+calWcapCalendar.prototype.getItems = function(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l100.398"></a><span id="l100.398">     rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l100.399"></a><span id="l100.399">     rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l100.400"></a><span id="l100.400">     let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l100.401"></a><span id="l100.401">     let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l100.402"></a><span id="l100.402"> </span>
<a href="#l100.403"></a><span id="l100.403">     let self = this;</span>
<a href="#l100.404"></a><span id="l100.404">     let request = new calWcapRequest(</span>
<a href="#l100.405"></a><span id="l100.405" class="difflineminus">-        function getItems_resp(oprequest, err, data) {</span>
<a href="#l100.406"></a><span id="l100.406" class="difflineplus">+        function(oprequest, err, data) {</span>
<a href="#l100.407"></a><span id="l100.407">             log(&quot;getItems() complete: &quot; + errorToString(err), self);</span>
<a href="#l100.408"></a><span id="l100.408">             self.notifyOperationComplete(listener,</span>
<a href="#l100.409"></a><span id="l100.409">                                          getResultCode(err),</span>
<a href="#l100.410"></a><span id="l100.410">                                          calIOperationListener.GET,</span>
<a href="#l100.411"></a><span id="l100.411">                                          null,</span>
<a href="#l100.412"></a><span id="l100.412">                                          err);</span>
<a href="#l100.413"></a><span id="l100.413">         },</span>
<a href="#l100.414"></a><span id="l100.414">         log(&quot;getItems():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) +</span>
<a href="#l100.415"></a><span id="l100.415" class="difflineat">@@ -1199,25 +1184,25 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l100.416"></a><span id="l100.416">         if (maxResults &gt; 0) {</span>
<a href="#l100.417"></a><span id="l100.417">             params += &quot;&amp;maxResults=&quot; + maxResults;</span>
<a href="#l100.418"></a><span id="l100.418">         }</span>
<a href="#l100.419"></a><span id="l100.419">         params += &quot;&amp;dtstart=&quot; + zRangeStart;</span>
<a href="#l100.420"></a><span id="l100.420">         params += &quot;&amp;dtend=&quot; + zRangeEnd;</span>
<a href="#l100.421"></a><span id="l100.421"> </span>
<a href="#l100.422"></a><span id="l100.422">         this.issueNetworkRequest(</span>
<a href="#l100.423"></a><span id="l100.423">             request,</span>
<a href="#l100.424"></a><span id="l100.424" class="difflineminus">-            function netResp(err, icalRootComp) {</span>
<a href="#l100.425"></a><span id="l100.425" class="difflineplus">+            function(err, icalRootComp) {</span>
<a href="#l100.426"></a><span id="l100.426">                 if (err) {</span>
<a href="#l100.427"></a><span id="l100.427">                     if (checkErrorCode(err, calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR)) {</span>
<a href="#l100.428"></a><span id="l100.428">                         // try free-busy times:</span>
<a href="#l100.429"></a><span id="l100.429">                         if (listener &amp;&amp;</span>
<a href="#l100.430"></a><span id="l100.430">                             (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_EVENT) &amp;&amp;</span>
<a href="#l100.431"></a><span id="l100.431">                             rangeStart &amp;&amp; rangeEnd) {</span>
<a href="#l100.432"></a><span id="l100.432">                             let freeBusyListener = { // calIGenericOperationListener:</span>
<a href="#l100.433"></a><span id="l100.433" class="difflineminus">-                                onResult: function freeBusyListener_onResult(oprequest, result) {</span>
<a href="#l100.434"></a><span id="l100.434" class="difflineplus">+                                onResult: function(oprequest, result) {</span>
<a href="#l100.435"></a><span id="l100.435">                                     if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l100.436"></a><span id="l100.436">                                         throw oprequest.status;</span>
<a href="#l100.437"></a><span id="l100.437">                                     }</span>
<a href="#l100.438"></a><span id="l100.438">                                     let items = [];</span>
<a href="#l100.439"></a><span id="l100.439">                                     for (let entry of result) {</span>
<a href="#l100.440"></a><span id="l100.440">                                         let item = createEvent();</span>
<a href="#l100.441"></a><span id="l100.441">                                         item.id = g_busyPhantomItemUuidPrefix + getIcalUTC(entry.interval.start);</span>
<a href="#l100.442"></a><span id="l100.442">                                         item.calendar = self.superCalendar;</span>
<a href="#l100.443"></a><span id="l100.443" class="difflineat">@@ -1243,17 +1228,17 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l100.444"></a><span id="l100.444">                     let items = self.parseItems(</span>
<a href="#l100.445"></a><span id="l100.445">                         icalRootComp, itemFilter, maxResults,</span>
<a href="#l100.446"></a><span id="l100.446">                         rangeStart, rangeEnd);</span>
<a href="#l100.447"></a><span id="l100.447"> </span>
<a href="#l100.448"></a><span id="l100.448">                     if (CACHE_LAST_RESULTS &gt; 0) {</span>
<a href="#l100.449"></a><span id="l100.449">                         // auto invalidate after X minutes:</span>
<a href="#l100.450"></a><span id="l100.450">                         if (!self.m_cachedResultsTimer) {</span>
<a href="#l100.451"></a><span id="l100.451">                             let callback = {</span>
<a href="#l100.452"></a><span id="l100.452" class="difflineminus">-                                notify: function notify(timer) {</span>
<a href="#l100.453"></a><span id="l100.453" class="difflineplus">+                                notify: function(timer) {</span>
<a href="#l100.454"></a><span id="l100.454">                                     if (!self.m_cachedResults) {</span>
<a href="#l100.455"></a><span id="l100.455">                                         return;</span>
<a href="#l100.456"></a><span id="l100.456">                                     }</span>
<a href="#l100.457"></a><span id="l100.457">                                     let now = (new Date()).getTime();</span>
<a href="#l100.458"></a><span id="l100.458">                                     // sort out old entries:</span>
<a href="#l100.459"></a><span id="l100.459">                                     let entries = [];</span>
<a href="#l100.460"></a><span id="l100.460">                                     for (let i = 0; i &lt; self.m_cachedResults.length; ++i) {</span>
<a href="#l100.461"></a><span id="l100.461">                                         let entry = self.m_cachedResults[i];</span>
<a href="#l100.462"></a><span id="l100.462" class="difflineat">@@ -1300,30 +1285,28 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l100.463"></a><span id="l100.463">     } catch (exc) {</span>
<a href="#l100.464"></a><span id="l100.464">         request.execRespFunc(exc);</span>
<a href="#l100.465"></a><span id="l100.465">     }</span>
<a href="#l100.466"></a><span id="l100.466">     return request;</span>
<a href="#l100.467"></a><span id="l100.467"> };</span>
<a href="#l100.468"></a><span id="l100.468"> </span>
<a href="#l100.469"></a><span id="l100.469"> calWcapCalendar.prototype.offlineStorage = null;</span>
<a href="#l100.470"></a><span id="l100.470"> </span>
<a href="#l100.471"></a><span id="l100.471" class="difflineminus">-calWcapCalendar.prototype.resetLog =</span>
<a href="#l100.472"></a><span id="l100.472" class="difflineminus">-function calWcapCalendar_resetLog() {</span>
<a href="#l100.473"></a><span id="l100.473" class="difflineplus">+calWcapCalendar.prototype.resetLog = function() {</span>
<a href="#l100.474"></a><span id="l100.474">     this.deleteProperty(&quot;replay.last_stamp&quot;);</span>
<a href="#l100.475"></a><span id="l100.475"> };</span>
<a href="#l100.476"></a><span id="l100.476"> </span>
<a href="#l100.477"></a><span id="l100.477" class="difflineminus">-calWcapCalendar.prototype.replayChangesOn =</span>
<a href="#l100.478"></a><span id="l100.478" class="difflineminus">-function calWcapCalendar_replayChangesOn(listener) {</span>
<a href="#l100.479"></a><span id="l100.479" class="difflineplus">+calWcapCalendar.prototype.replayChangesOn = function(listener) {</span>
<a href="#l100.480"></a><span id="l100.480">     let self = this;</span>
<a href="#l100.481"></a><span id="l100.481">     let itemFilter = calICalendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l100.482"></a><span id="l100.482">     let dtFrom = getDatetimeFromIcalString(this.getProperty(&quot;replay.last_stamp&quot;));</span>
<a href="#l100.483"></a><span id="l100.483">     let now = getTime(); // new stamp for this sync</span>
<a href="#l100.484"></a><span id="l100.484"> </span>
<a href="#l100.485"></a><span id="l100.485">     let request_ = new calWcapRequest(</span>
<a href="#l100.486"></a><span id="l100.486" class="difflineminus">-        function replayChangesOn_resp(request, err) {</span>
<a href="#l100.487"></a><span id="l100.487" class="difflineplus">+        function(request, err) {</span>
<a href="#l100.488"></a><span id="l100.488">             if (err) {</span>
<a href="#l100.489"></a><span id="l100.489">                 logError(&quot;error replaying changes: &quot; + errorToString(err));</span>
<a href="#l100.490"></a><span id="l100.490">                 self.notifyError(err);</span>
<a href="#l100.491"></a><span id="l100.491">             } else {</span>
<a href="#l100.492"></a><span id="l100.492">                 log(&quot;replay succeeded.&quot;, self);</span>
<a href="#l100.493"></a><span id="l100.493">                 self.setProperty(&quot;replay.last_stamp&quot;, getIcalUTC(now));</span>
<a href="#l100.494"></a><span id="l100.494">                 log(&quot;new replay stamp: &quot; + getIcalUTC(now), self);</span>
<a href="#l100.495"></a><span id="l100.495">             }</span>
<a href="#l100.496"></a><span id="l100.496" class="difflineat">@@ -1340,17 +1323,17 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l100.497"></a><span id="l100.497">             onGetResult: function() {},</span>
<a href="#l100.498"></a><span id="l100.498">             onOperationComplete: function(aCalendar, status, opType, id, detail) {</span>
<a href="#l100.499"></a><span id="l100.499">                 if (!Components.isSuccessCode(status)) {</span>
<a href="#l100.500"></a><span id="l100.500">                     request.execRespFunc(status); // any error on writing breaks whole operation</span>
<a href="#l100.501"></a><span id="l100.501">                 }</span>
<a href="#l100.502"></a><span id="l100.502">             }</span>
<a href="#l100.503"></a><span id="l100.503">         };</span>
<a href="#l100.504"></a><span id="l100.504">         let request = new calWcapRequest(</span>
<a href="#l100.505"></a><span id="l100.505" class="difflineminus">-            function netFinishedRespFunc(err, data) {</span>
<a href="#l100.506"></a><span id="l100.506" class="difflineplus">+            function(err, data) {</span>
<a href="#l100.507"></a><span id="l100.507">                 let modifiedIds = {};</span>
<a href="#l100.508"></a><span id="l100.508">                 for (let item of request.m_modifiedItems) {</span>
<a href="#l100.509"></a><span id="l100.509">                     let dtCreated = item.getProperty(&quot;CREATED&quot;);</span>
<a href="#l100.510"></a><span id="l100.510">                     let bAdd = !dtCreated || !dtFrom || dtCreated.compare(dtFrom) &gt;= 0;</span>
<a href="#l100.511"></a><span id="l100.511">                     modifiedIds[item.id] = true;</span>
<a href="#l100.512"></a><span id="l100.512">                     if (bAdd) {</span>
<a href="#l100.513"></a><span id="l100.513">                         log(&quot;replayChangesOn(): new item &quot; + item.id, self);</span>
<a href="#l100.514"></a><span id="l100.514">                         if (self.offlineStorage) {</span>
<a href="#l100.515"></a><span id="l100.515" class="difflineat">@@ -1383,48 +1366,48 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l100.516"></a><span id="l100.516">                     }</span>
<a href="#l100.517"></a><span id="l100.517">                 }</span>
<a href="#l100.518"></a><span id="l100.518">             }, &quot;replayChangesOn() netFinishedRespFunc&quot;);</span>
<a href="#l100.519"></a><span id="l100.519">         request_.attachSubRequest(request);</span>
<a href="#l100.520"></a><span id="l100.520"> </span>
<a href="#l100.521"></a><span id="l100.521">         // assure being logged in to calc server times:</span>
<a href="#l100.522"></a><span id="l100.522">         this.session.getSessionId(</span>
<a href="#l100.523"></a><span id="l100.523">             request,</span>
<a href="#l100.524"></a><span id="l100.524" class="difflineminus">-            function getSessionId_resp(err, sessionId) {</span>
<a href="#l100.525"></a><span id="l100.525" class="difflineplus">+            function(err, sessionId) {</span>
<a href="#l100.526"></a><span id="l100.526">                 try {</span>
<a href="#l100.527"></a><span id="l100.527">                     if (err) {</span>
<a href="#l100.528"></a><span id="l100.528">                         throw err;</span>
<a href="#l100.529"></a><span id="l100.529">                     }</span>
<a href="#l100.530"></a><span id="l100.530">                     let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot; +</span>
<a href="#l100.531"></a><span id="l100.531">                                  &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l100.532"></a><span id="l100.532">                     if (dtFrom) {</span>
<a href="#l100.533"></a><span id="l100.533">                         dtFrom = self.session.getServerTime(dtFrom);</span>
<a href="#l100.534"></a><span id="l100.534">                     }</span>
<a href="#l100.535"></a><span id="l100.535">                     params += &quot;&amp;dtstart=&quot; + getIcalUTC(dtFrom);</span>
<a href="#l100.536"></a><span id="l100.536">                     params += &quot;&amp;dtend=&quot; + getIcalUTC(self.session.getServerTime(now));</span>
<a href="#l100.537"></a><span id="l100.537"> </span>
<a href="#l100.538"></a><span id="l100.538">                     log(&quot;replayChangesOn(): getting last modifications...&quot;, self);</span>
<a href="#l100.539"></a><span id="l100.539">                     self.issueNetworkRequest(</span>
<a href="#l100.540"></a><span id="l100.540">                         request,</span>
<a href="#l100.541"></a><span id="l100.541" class="difflineminus">-                        function modifiedNetResp(fetcherr, icalRootComp) {</span>
<a href="#l100.542"></a><span id="l100.542" class="difflineplus">+                        function(fetcherr, icalRootComp) {</span>
<a href="#l100.543"></a><span id="l100.543">                             if (fetcherr) {</span>
<a href="#l100.544"></a><span id="l100.544">                                 throw fetcherr;</span>
<a href="#l100.545"></a><span id="l100.545">                             }</span>
<a href="#l100.546"></a><span id="l100.546">                             request.m_modifiedItems = self.parseItems(icalRootComp,</span>
<a href="#l100.547"></a><span id="l100.547">                                                                       calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l100.548"></a><span id="l100.548">                                                                       0, null, null);</span>
<a href="#l100.549"></a><span id="l100.549">                         },</span>
<a href="#l100.550"></a><span id="l100.550">                         stringToIcal, &quot;fetchcomponents_by_lastmod&quot;,</span>
<a href="#l100.551"></a><span id="l100.551">                         params + getItemFilterParams(itemFilter),</span>
<a href="#l100.552"></a><span id="l100.552">                         calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l100.553"></a><span id="l100.553"> </span>
<a href="#l100.554"></a><span id="l100.554">                     log(&quot;replayChangesOn(): getting deleted items...&quot;, self);</span>
<a href="#l100.555"></a><span id="l100.555">                     self.issueNetworkRequest(</span>
<a href="#l100.556"></a><span id="l100.556">                         request,</span>
<a href="#l100.557"></a><span id="l100.557" class="difflineminus">-                        function modifiedNetResp(fetcherr, icalRootComp) {</span>
<a href="#l100.558"></a><span id="l100.558" class="difflineplus">+                        function(fetcherr, icalRootComp) {</span>
<a href="#l100.559"></a><span id="l100.559">                             if (fetcherr) {</span>
<a href="#l100.560"></a><span id="l100.560">                                 throw fetcherr;</span>
<a href="#l100.561"></a><span id="l100.561">                             }</span>
<a href="#l100.562"></a><span id="l100.562">                             request.m_deletedItems = self.parseItems(icalRootComp,</span>
<a href="#l100.563"></a><span id="l100.563">                                                                      calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l100.564"></a><span id="l100.564">                                                                      0, null, null);</span>
<a href="#l100.565"></a><span id="l100.565">                         },</span>
<a href="#l100.566"></a><span id="l100.566">                         stringToIcal, &quot;fetch_deletedcomponents&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -60,86 +60,86 @@ calWcapRequest.prototype = {</span>
<a href="#l101.4"></a><span id="l101.4">         this.detachFromParent(); // detach without error</span>
<a href="#l101.5"></a><span id="l101.5">         return (this.m_parentRequest = req);</span>
<a href="#l101.6"></a><span id="l101.6">     },</span>
<a href="#l101.7"></a><span id="l101.7"> </span>
<a href="#l101.8"></a><span id="l101.8">     /** The following locking is necessary when scheduling multiple async</span>
<a href="#l101.9"></a><span id="l101.9">         requests; one cannot be sure that e.g. the first completes quickly</span>
<a href="#l101.10"></a><span id="l101.10">         and responds the whole parent request when detaching.</span>
<a href="#l101.11"></a><span id="l101.11">     */</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-    lockPending: function calWcapRequest_lockPending() {</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineplus">+    lockPending: function() {</span>
<a href="#l101.14"></a><span id="l101.14">         this.m_locked = true;</span>
<a href="#l101.15"></a><span id="l101.15">     },</span>
<a href="#l101.16"></a><span id="l101.16" class="difflineminus">-    unlockPending: function calWcapRequest_unlockPending() {</span>
<a href="#l101.17"></a><span id="l101.17" class="difflineplus">+    unlockPending: function() {</span>
<a href="#l101.18"></a><span id="l101.18">         if (this.m_locked) {</span>
<a href="#l101.19"></a><span id="l101.19">             this.m_locked = false;</span>
<a href="#l101.20"></a><span id="l101.20">             // assures that respFunc is executed:</span>
<a href="#l101.21"></a><span id="l101.21">             if (this.m_attachedRequests.length == 0) {</span>
<a href="#l101.22"></a><span id="l101.22">                 this.execRespFunc();</span>
<a href="#l101.23"></a><span id="l101.23">             }</span>
<a href="#l101.24"></a><span id="l101.24">         }</span>
<a href="#l101.25"></a><span id="l101.25">     },</span>
<a href="#l101.26"></a><span id="l101.26"> </span>
<a href="#l101.27"></a><span id="l101.27" class="difflineminus">-    toString: function calWcapRequest_toString() {</span>
<a href="#l101.28"></a><span id="l101.28" class="difflineplus">+    toString: function() {</span>
<a href="#l101.29"></a><span id="l101.29">         let ret = &quot;calWcapRequest id=&quot; + this.id +</span>
<a href="#l101.30"></a><span id="l101.30">                   &quot;, parent-id=&quot; + (this.parentRequest ? this.parentRequest.id : &quot;&lt;none&gt;&quot;) +</span>
<a href="#l101.31"></a><span id="l101.31">                   &quot; (&quot; + this.m_logContext + &quot;)&quot;;</span>
<a href="#l101.32"></a><span id="l101.32">         if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_attachedRequests.length &gt; 0) {</span>
<a href="#l101.33"></a><span id="l101.33">             ret += &quot;\nattached requests:&quot;;</span>
<a href="#l101.34"></a><span id="l101.34">             for (let req of this.m_attachedRequests) {</span>
<a href="#l101.35"></a><span id="l101.35">                 ret += &quot;\n#&quot; + req.id + &quot;\t&quot; + req;</span>
<a href="#l101.36"></a><span id="l101.36">             }</span>
<a href="#l101.37"></a><span id="l101.37">         }</span>
<a href="#l101.38"></a><span id="l101.38">         ret += &quot;, isPending=&quot; + this.isPending;</span>
<a href="#l101.39"></a><span id="l101.39">         ret += &quot;, status=&quot; + errorToString(this.status);</span>
<a href="#l101.40"></a><span id="l101.40">         return ret;</span>
<a href="#l101.41"></a><span id="l101.41">     },</span>
<a href="#l101.42"></a><span id="l101.42"> </span>
<a href="#l101.43"></a><span id="l101.43" class="difflineminus">-    attachSubRequest: function calWcapRequest_attachSubRequest(req) {</span>
<a href="#l101.44"></a><span id="l101.44" class="difflineplus">+    attachSubRequest: function(req) {</span>
<a href="#l101.45"></a><span id="l101.45">         if (req) {</span>
<a href="#l101.46"></a><span id="l101.46">             if (!this.m_attachedRequests.some(function(req_) { return req.id == req_.id; })) {</span>
<a href="#l101.47"></a><span id="l101.47">                 if (req.isPending) {</span>
<a href="#l101.48"></a><span id="l101.48">                     this.m_attachedRequests.push(req);</span>
<a href="#l101.49"></a><span id="l101.49">                     req.parentRequest = this;</span>
<a href="#l101.50"></a><span id="l101.50">                     log(&quot;attachSubRequest()&quot;, this);</span>
<a href="#l101.51"></a><span id="l101.51">                 } else if (!this.m_locked &amp;&amp; this.m_attachedRequests.length == 0) {</span>
<a href="#l101.52"></a><span id="l101.52">                     this.execRespFunc(req.status);</span>
<a href="#l101.53"></a><span id="l101.53">                 }</span>
<a href="#l101.54"></a><span id="l101.54">             } else {</span>
<a href="#l101.55"></a><span id="l101.55">                 logError(&quot;request already attached: &quot; + req.id, this);</span>
<a href="#l101.56"></a><span id="l101.56">             }</span>
<a href="#l101.57"></a><span id="l101.57">         }</span>
<a href="#l101.58"></a><span id="l101.58">     },</span>
<a href="#l101.59"></a><span id="l101.59"> </span>
<a href="#l101.60"></a><span id="l101.60" class="difflineminus">-    detachSubRequest: function calWcapRequest_detachSubRequest(req, err) {</span>
<a href="#l101.61"></a><span id="l101.61" class="difflineplus">+    detachSubRequest: function(req, err) {</span>
<a href="#l101.62"></a><span id="l101.62">         this.m_attachedRequests = this.m_attachedRequests.filter(function(req_) { return req.id != req_.id; });</span>
<a href="#l101.63"></a><span id="l101.63">         if (err) {</span>
<a href="#l101.64"></a><span id="l101.64">             // first failing sub request stops parent request:</span>
<a href="#l101.65"></a><span id="l101.65">             this.execRespFunc(err);</span>
<a href="#l101.66"></a><span id="l101.66">         } else if (!this.m_locked &amp;&amp; this.m_attachedRequests.length == 0) {</span>
<a href="#l101.67"></a><span id="l101.67">             // assures that respFunc is executed after all sub requests have been completed:</span>
<a href="#l101.68"></a><span id="l101.68">             this.execRespFunc();</span>
<a href="#l101.69"></a><span id="l101.69">         }</span>
<a href="#l101.70"></a><span id="l101.70">     },</span>
<a href="#l101.71"></a><span id="l101.71"> </span>
<a href="#l101.72"></a><span id="l101.72" class="difflineminus">-    cancelAllSubRequests: function calWcapRequest_cancelAllSubRequests(status) {</span>
<a href="#l101.73"></a><span id="l101.73" class="difflineplus">+    cancelAllSubRequests: function(status) {</span>
<a href="#l101.74"></a><span id="l101.74">         let attachedRequests = this.m_attachedRequests;</span>
<a href="#l101.75"></a><span id="l101.75">         this.m_attachedRequests = [];</span>
<a href="#l101.76"></a><span id="l101.76">         attachedRequests.forEach(function(req) { req.cancel(null); });</span>
<a href="#l101.77"></a><span id="l101.77">     },</span>
<a href="#l101.78"></a><span id="l101.78"> </span>
<a href="#l101.79"></a><span id="l101.79" class="difflineminus">-    detachFromParent: function calWcapRequest_detachFromParent(err) {</span>
<a href="#l101.80"></a><span id="l101.80" class="difflineplus">+    detachFromParent: function(err) {</span>
<a href="#l101.81"></a><span id="l101.81">         let parentRequest = this.m_parentRequest;</span>
<a href="#l101.82"></a><span id="l101.82">         if (parentRequest) {</span>
<a href="#l101.83"></a><span id="l101.83">             this.m_parentRequest = null;</span>
<a href="#l101.84"></a><span id="l101.84">             parentRequest.detachSubRequest(this, err);</span>
<a href="#l101.85"></a><span id="l101.85">         }</span>
<a href="#l101.86"></a><span id="l101.86">     },</span>
<a href="#l101.87"></a><span id="l101.87"> </span>
<a href="#l101.88"></a><span id="l101.88" class="difflineminus">-    execRespFunc: function calWcapRequest_execRespFunc(err, data) {</span>
<a href="#l101.89"></a><span id="l101.89" class="difflineplus">+    execRespFunc: function(err, data) {</span>
<a href="#l101.90"></a><span id="l101.90">         if (this.isPending) {</span>
<a href="#l101.91"></a><span id="l101.91">             this.m_isPending = false;</span>
<a href="#l101.92"></a><span id="l101.92">             if (err) {</span>
<a href="#l101.93"></a><span id="l101.93">                 this.m_status = err;</span>
<a href="#l101.94"></a><span id="l101.94">             }</span>
<a href="#l101.95"></a><span id="l101.95">             this.cancelAllSubRequests();</span>
<a href="#l101.96"></a><span id="l101.96">             let respFunc = this.m_respFunc;</span>
<a href="#l101.97"></a><span id="l101.97">             if (respFunc) {</span>
<a href="#l101.98"></a><span id="l101.98" class="difflineat">@@ -154,17 +154,17 @@ calWcapRequest.prototype = {</span>
<a href="#l101.99"></a><span id="l101.99">                     // don't pump into error console, may be handled:</span>
<a href="#l101.100"></a><span id="l101.100">                     log(&quot;error: &quot; + errorToString(exc), this);</span>
<a href="#l101.101"></a><span id="l101.101">                 }</span>
<a href="#l101.102"></a><span id="l101.102">             }</span>
<a href="#l101.103"></a><span id="l101.103">             this.detachFromParent(this.m_status);</span>
<a href="#l101.104"></a><span id="l101.104">         }</span>
<a href="#l101.105"></a><span id="l101.105">     },</span>
<a href="#l101.106"></a><span id="l101.106"> </span>
<a href="#l101.107"></a><span id="l101.107" class="difflineminus">-    execSubRespFunc: function calWcapRequest_execSubRespFunc(func, err, data) {</span>
<a href="#l101.108"></a><span id="l101.108" class="difflineplus">+    execSubRespFunc: function(func, err, data) {</span>
<a href="#l101.109"></a><span id="l101.109">         try {</span>
<a href="#l101.110"></a><span id="l101.110">             func(err, data);</span>
<a href="#l101.111"></a><span id="l101.111">         } catch (exc) {</span>
<a href="#l101.112"></a><span id="l101.112">             this.execRespFunc(exc);</span>
<a href="#l101.113"></a><span id="l101.113">         }</span>
<a href="#l101.114"></a><span id="l101.114">     },</span>
<a href="#l101.115"></a><span id="l101.115"> </span>
<a href="#l101.116"></a><span id="l101.116">     // calIOperation:</span>
<a href="#l101.117"></a><span id="l101.117" class="difflineat">@@ -173,17 +173,17 @@ calWcapRequest.prototype = {</span>
<a href="#l101.118"></a><span id="l101.118">     },</span>
<a href="#l101.119"></a><span id="l101.119">     get isPending() {</span>
<a href="#l101.120"></a><span id="l101.120">         return this.m_isPending;</span>
<a href="#l101.121"></a><span id="l101.121">     },</span>
<a href="#l101.122"></a><span id="l101.122">     get status() {</span>
<a href="#l101.123"></a><span id="l101.123">         return (this.m_status === null ? NS_OK : this.m_status);</span>
<a href="#l101.124"></a><span id="l101.124">     },</span>
<a href="#l101.125"></a><span id="l101.125"> </span>
<a href="#l101.126"></a><span id="l101.126" class="difflineminus">-    cancel: function calWcapRequest_cancel(status) {</span>
<a href="#l101.127"></a><span id="l101.127" class="difflineplus">+    cancel: function(status) {</span>
<a href="#l101.128"></a><span id="l101.128">         if (!status) {</span>
<a href="#l101.129"></a><span id="l101.129">             status = calIErrors.OPERATION_CANCELLED;</span>
<a href="#l101.130"></a><span id="l101.130">         }</span>
<a href="#l101.131"></a><span id="l101.131">         this.execRespFunc(status);</span>
<a href="#l101.132"></a><span id="l101.132">     }</span>
<a href="#l101.133"></a><span id="l101.133"> };</span>
<a href="#l101.134"></a><span id="l101.134"> </span>
<a href="#l101.135"></a><span id="l101.135"> function calWcapNetworkRequest(url, respFunc, bLogging) {</span>
<a href="#l101.136"></a><span id="l101.136" class="difflineat">@@ -223,42 +223,36 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l101.137"></a><span id="l101.137">     getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l101.138"></a><span id="l101.138"> </span>
<a href="#l101.139"></a><span id="l101.139">     /**</span>
<a href="#l101.140"></a><span id="l101.140">      * prepareChannel</span>
<a href="#l101.141"></a><span id="l101.141">      * Prepares the passed channel to match this objects properties</span>
<a href="#l101.142"></a><span id="l101.142">      *</span>
<a href="#l101.143"></a><span id="l101.143">      * @param aChannel    The Channel to be prepared</span>
<a href="#l101.144"></a><span id="l101.144">      */</span>
<a href="#l101.145"></a><span id="l101.145" class="difflineminus">-    prepareChannel: function calWcapNetworkRequest_prepareChannel(aChannel) {</span>
<a href="#l101.146"></a><span id="l101.146" class="difflineplus">+    prepareChannel: function(aChannel) {</span>
<a href="#l101.147"></a><span id="l101.147">         // No caching</span>
<a href="#l101.148"></a><span id="l101.148">         aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l101.149"></a><span id="l101.149">         aChannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l101.150"></a><span id="l101.150">         aChannel.requestMethod = &quot;GET&quot;;</span>
<a href="#l101.151"></a><span id="l101.151">     },</span>
<a href="#l101.152"></a><span id="l101.152"> </span>
<a href="#l101.153"></a><span id="l101.153">     /**</span>
<a href="#l101.154"></a><span id="l101.154">      * @see nsIChannelEventSink</span>
<a href="#l101.155"></a><span id="l101.155">      */</span>
<a href="#l101.156"></a><span id="l101.156" class="difflineminus">-    asyncOnChannelRedirect: function calWcapNetworkRequest_asyncOnChannelRedirect(aOldChannel,</span>
<a href="#l101.157"></a><span id="l101.157" class="difflineminus">-                                                                                  aNewChannel,</span>
<a href="#l101.158"></a><span id="l101.158" class="difflineminus">-                                                                                  aFlags,</span>
<a href="#l101.159"></a><span id="l101.159" class="difflineminus">-                                                                                  aCallback) {</span>
<a href="#l101.160"></a><span id="l101.160" class="difflineplus">+    asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l101.161"></a><span id="l101.161">         // all we need to do to the new channel is the basic preparation</span>
<a href="#l101.162"></a><span id="l101.162">         this.prepareChannel(aNewChannel);</span>
<a href="#l101.163"></a><span id="l101.163">         aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l101.164"></a><span id="l101.164">     },</span>
<a href="#l101.165"></a><span id="l101.165"> </span>
<a href="#l101.166"></a><span id="l101.166">     /**</span>
<a href="#l101.167"></a><span id="l101.167">      * @see nsIUnicharStreamLoaderObserver</span>
<a href="#l101.168"></a><span id="l101.168">      */</span>
<a href="#l101.169"></a><span id="l101.169" class="difflineminus">-    onDetermineCharset: function calWcapNetworkRequest_onDetermineCharset(loader,</span>
<a href="#l101.170"></a><span id="l101.170" class="difflineminus">-                                                                          context,</span>
<a href="#l101.171"></a><span id="l101.171" class="difflineminus">-                                                                          firstSegment,</span>
<a href="#l101.172"></a><span id="l101.172" class="difflineminus">-                                                                          length) {</span>
<a href="#l101.173"></a><span id="l101.173" class="difflineplus">+    onDetermineCharset: function(loader, context, firstSegment, length) {</span>
<a href="#l101.174"></a><span id="l101.174">         let channel = null;</span>
<a href="#l101.175"></a><span id="l101.175">         if (loader) {</span>
<a href="#l101.176"></a><span id="l101.176">             channel = loader.channel;</span>
<a href="#l101.177"></a><span id="l101.177">         }</span>
<a href="#l101.178"></a><span id="l101.178">         let charset = null;</span>
<a href="#l101.179"></a><span id="l101.179">         if (channel) {</span>
<a href="#l101.180"></a><span id="l101.180">             charset = channel.contentCharset;</span>
<a href="#l101.181"></a><span id="l101.181">         }</span>
<a href="#l101.182"></a><span id="l101.182" class="difflineat">@@ -266,20 +260,17 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l101.183"></a><span id="l101.183">             charset = &quot;UTF-8&quot;;</span>
<a href="#l101.184"></a><span id="l101.184">         }</span>
<a href="#l101.185"></a><span id="l101.185">         return charset;</span>
<a href="#l101.186"></a><span id="l101.186">     },</span>
<a href="#l101.187"></a><span id="l101.187"> </span>
<a href="#l101.188"></a><span id="l101.188">     /**</span>
<a href="#l101.189"></a><span id="l101.189">      * @see nsIUnicharStreamLoaderObserver</span>
<a href="#l101.190"></a><span id="l101.190">      */</span>
<a href="#l101.191"></a><span id="l101.191" class="difflineminus">-    onStreamComplete: function calWcapNetworkRequest_onStreamComplete(aLoader,</span>
<a href="#l101.192"></a><span id="l101.192" class="difflineminus">-                                                                      aContext,</span>
<a href="#l101.193"></a><span id="l101.193" class="difflineminus">-                                                                      aStatus,</span>
<a href="#l101.194"></a><span id="l101.194" class="difflineminus">-                                                                      unicharData) {</span>
<a href="#l101.195"></a><span id="l101.195" class="difflineplus">+    onStreamComplete: function(aLoader, aContext, aStatus, unicharData) {</span>
<a href="#l101.196"></a><span id="l101.196">         this.m_loader = null;</span>
<a href="#l101.197"></a><span id="l101.197"> </span>
<a href="#l101.198"></a><span id="l101.198">         if (LOG_LEVEL &gt; 0 &amp;&amp; this.m_bLogging) {</span>
<a href="#l101.199"></a><span id="l101.199">             log(&quot;status: &quot; + errorToString(aStatus), this);</span>
<a href="#l101.200"></a><span id="l101.200">         }</span>
<a href="#l101.201"></a><span id="l101.201">         if (aStatus != Components.results.NS_OK) {</span>
<a href="#l101.202"></a><span id="l101.202">             this.execRespFunc(aStatus);</span>
<a href="#l101.203"></a><span id="l101.203">             return;</span>
<a href="#l101.204"></a><span id="l101.204" class="difflineat">@@ -302,17 +293,17 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l101.205"></a><span id="l101.205">                             httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l101.206"></a><span id="l101.206">                             unicharData;</span>
<a href="#l101.207"></a><span id="l101.207">                 this.execRespFunc(Components.Exception(error, NS_BINDING_FAILED));</span>
<a href="#l101.208"></a><span id="l101.208">                 break;</span>
<a href="#l101.209"></a><span id="l101.209">             }</span>
<a href="#l101.210"></a><span id="l101.210">         }</span>
<a href="#l101.211"></a><span id="l101.211">     },</span>
<a href="#l101.212"></a><span id="l101.212"> </span>
<a href="#l101.213"></a><span id="l101.213" class="difflineminus">-    toString: function calWcapNetworkRequest_toString() {</span>
<a href="#l101.214"></a><span id="l101.214" class="difflineplus">+    toString: function() {</span>
<a href="#l101.215"></a><span id="l101.215">         let ret = &quot;calWcapNetworkRequest id=&quot; + this.id +</span>
<a href="#l101.216"></a><span id="l101.216">                    &quot;, parent-id=&quot; + (this.parentRequest ? this.parentRequest.id : &quot;&lt;none&gt;&quot;);</span>
<a href="#l101.217"></a><span id="l101.217">         if (this.m_bLogging) {</span>
<a href="#l101.218"></a><span id="l101.218">             ret += &quot; (&quot; + this.m_url + &quot;)&quot;;</span>
<a href="#l101.219"></a><span id="l101.219">         }</span>
<a href="#l101.220"></a><span id="l101.220">         ret += &quot;, isPending=&quot; + this.isPending;</span>
<a href="#l101.221"></a><span id="l101.221">         ret += &quot;, status=&quot; + errorToString(this.status);</span>
<a href="#l101.222"></a><span id="l101.222">         return ret;</span>
<a href="#l101.223"></a><span id="l101.223" class="difflineat">@@ -339,43 +330,43 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l101.224"></a><span id="l101.224">     get isPending() {</span>
<a href="#l101.225"></a><span id="l101.225">         return this.m_isPending;</span>
<a href="#l101.226"></a><span id="l101.226">     },</span>
<a href="#l101.227"></a><span id="l101.227"> </span>
<a href="#l101.228"></a><span id="l101.228">     get status() {</span>
<a href="#l101.229"></a><span id="l101.229">         return (this.request ? this.request.status : NS_OK);</span>
<a href="#l101.230"></a><span id="l101.230">     },</span>
<a href="#l101.231"></a><span id="l101.231"> </span>
<a href="#l101.232"></a><span id="l101.232" class="difflineminus">-    detachFromParent: function calWcapNetworkRequest_detachFromParent(err) {</span>
<a href="#l101.233"></a><span id="l101.233" class="difflineplus">+    detachFromParent: function(err) {</span>
<a href="#l101.234"></a><span id="l101.234">         let parentRequest = this.m_parentRequest;</span>
<a href="#l101.235"></a><span id="l101.235">         if (parentRequest) {</span>
<a href="#l101.236"></a><span id="l101.236">             this.m_parentRequest = null;</span>
<a href="#l101.237"></a><span id="l101.237">             parentRequest.detachSubRequest(this, err);</span>
<a href="#l101.238"></a><span id="l101.238">         }</span>
<a href="#l101.239"></a><span id="l101.239">     },</span>
<a href="#l101.240"></a><span id="l101.240"> </span>
<a href="#l101.241"></a><span id="l101.241">     get request() {</span>
<a href="#l101.242"></a><span id="l101.242">         return (this.m_loader ? this.m_loader.channel : null);</span>
<a href="#l101.243"></a><span id="l101.243">     },</span>
<a href="#l101.244"></a><span id="l101.244"> </span>
<a href="#l101.245"></a><span id="l101.245" class="difflineminus">-    cancel: function calWcapNetworkRequest_cancel(status) {</span>
<a href="#l101.246"></a><span id="l101.246" class="difflineplus">+    cancel: function(status) {</span>
<a href="#l101.247"></a><span id="l101.247">         if (!status) {</span>
<a href="#l101.248"></a><span id="l101.248">             status = calIErrors.OPERATION_CANCELLED;</span>
<a href="#l101.249"></a><span id="l101.249">         }</span>
<a href="#l101.250"></a><span id="l101.250">         this.execRespFunc(status);</span>
<a href="#l101.251"></a><span id="l101.251">         // xxx todo: check whether this works on redirected channels!</span>
<a href="#l101.252"></a><span id="l101.252">         let request = this.request;</span>
<a href="#l101.253"></a><span id="l101.253">         if (request &amp;&amp; request.isPending()) {</span>
<a href="#l101.254"></a><span id="l101.254">             log(&quot;canceling netwerk request...&quot;, this);</span>
<a href="#l101.255"></a><span id="l101.255">             request.cancel(NS_BINDING_FAILED);</span>
<a href="#l101.256"></a><span id="l101.256">             this.m_loader = null;</span>
<a href="#l101.257"></a><span id="l101.257">         }</span>
<a href="#l101.258"></a><span id="l101.258">     },</span>
<a href="#l101.259"></a><span id="l101.259"> </span>
<a href="#l101.260"></a><span id="l101.260" class="difflineminus">-    execRespFunc: function calWcapNetworkRequest_execRespFunc(err, str) {</span>
<a href="#l101.261"></a><span id="l101.261" class="difflineplus">+    execRespFunc: function(err, str) {</span>
<a href="#l101.262"></a><span id="l101.262">         if (this.isPending) {</span>
<a href="#l101.263"></a><span id="l101.263">             this.m_isPending = false;</span>
<a href="#l101.264"></a><span id="l101.264">             let respFunc = this.m_respFunc;</span>
<a href="#l101.265"></a><span id="l101.265">             if (respFunc) {</span>
<a href="#l101.266"></a><span id="l101.266">                 this.m_respFunc = null; // call once only</span>
<a href="#l101.267"></a><span id="l101.267">                 if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_bLogging) {</span>
<a href="#l101.268"></a><span id="l101.268">                     log(&quot;response exec: &quot; + errorToString(err), this);</span>
<a href="#l101.269"></a><span id="l101.269">                 }</span>
<a href="#l101.270"></a><span id="l101.270" class="difflineat">@@ -387,17 +378,17 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l101.271"></a><span id="l101.271">                     log(&quot;error: &quot; + errorToString(exc), this);</span>
<a href="#l101.272"></a><span id="l101.272">                     err = exc;</span>
<a href="#l101.273"></a><span id="l101.273">                 }</span>
<a href="#l101.274"></a><span id="l101.274">             }</span>
<a href="#l101.275"></a><span id="l101.275">             this.detachFromParent(err);</span>
<a href="#l101.276"></a><span id="l101.276">         }</span>
<a href="#l101.277"></a><span id="l101.277">     },</span>
<a href="#l101.278"></a><span id="l101.278"> </span>
<a href="#l101.279"></a><span id="l101.279" class="difflineminus">-    execSubRespFunc: function calWcapNetworkRequest_execSubRespFunc(func, err, data) {</span>
<a href="#l101.280"></a><span id="l101.280" class="difflineplus">+    execSubRespFunc: function(func, err, data) {</span>
<a href="#l101.281"></a><span id="l101.281">         try {</span>
<a href="#l101.282"></a><span id="l101.282">             func(err, data);</span>
<a href="#l101.283"></a><span id="l101.283">         } catch (exc) {</span>
<a href="#l101.284"></a><span id="l101.284">             this.execRespFunc(exc);</span>
<a href="#l101.285"></a><span id="l101.285">         }</span>
<a href="#l101.286"></a><span id="l101.286">     }</span>
<a href="#l101.287"></a><span id="l101.287"> };</span>
<a href="#l101.288"></a><span id="l101.288"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -118,27 +118,27 @@ calWcapSession.prototype = {</span>
<a href="#l102.4"></a><span id="l102.4">     QueryInterface: XPCOMUtils.generateQI(calWcapSessionInterfaces),</span>
<a href="#l102.5"></a><span id="l102.5">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l102.6"></a><span id="l102.6">         classID: calWcapSessionClassID,</span>
<a href="#l102.7"></a><span id="l102.7">         contractID: &quot;@mozilla.org/calendar/wcap/session;1&quot;,</span>
<a href="#l102.8"></a><span id="l102.8">         classDescription: &quot;Sun Java System Calendar Server WCAP Session&quot;,</span>
<a href="#l102.9"></a><span id="l102.9">         interfaces: calWcapSessionInterfaces</span>
<a href="#l102.10"></a><span id="l102.10">     }),</span>
<a href="#l102.11"></a><span id="l102.11"> </span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-    toString: function calWcapSession_toString(msg) {</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+    toString: function(msg) {</span>
<a href="#l102.14"></a><span id="l102.14">         let str = &quot;context-id: &quot; + this.m_contextId + &quot;, uri: &quot; + (this.uri ? this.uri.spec : &quot;unknown&quot;);</span>
<a href="#l102.15"></a><span id="l102.15">         if (this.credentials.userId) {</span>
<a href="#l102.16"></a><span id="l102.16">             str += &quot;, userId=&quot; + this.credentials.userId;</span>
<a href="#l102.17"></a><span id="l102.17">         }</span>
<a href="#l102.18"></a><span id="l102.18">         if (!this.m_sessionId) {</span>
<a href="#l102.19"></a><span id="l102.19">             str += (Services.io.offline ? &quot;, offline&quot; : &quot;, not logged in&quot;);</span>
<a href="#l102.20"></a><span id="l102.20">         }</span>
<a href="#l102.21"></a><span id="l102.21">         return str;</span>
<a href="#l102.22"></a><span id="l102.22">     },</span>
<a href="#l102.23"></a><span id="l102.23" class="difflineminus">-    notifyError: function calWcapSession_notifyError(err) {</span>
<a href="#l102.24"></a><span id="l102.24" class="difflineplus">+    notifyError: function(err) {</span>
<a href="#l102.25"></a><span id="l102.25">         if (this.defaultCalendar) {</span>
<a href="#l102.26"></a><span id="l102.26">             this.defaultCalendar.notifyError_(err, null, this);</span>
<a href="#l102.27"></a><span id="l102.27">         } else {</span>
<a href="#l102.28"></a><span id="l102.28">             logError(&quot;no default calendar!&quot;, this);</span>
<a href="#l102.29"></a><span id="l102.29">             logError(err, this);</span>
<a href="#l102.30"></a><span id="l102.30">         }</span>
<a href="#l102.31"></a><span id="l102.31">     },</span>
<a href="#l102.32"></a><span id="l102.32"> </span>
<a href="#l102.33"></a><span id="l102.33" class="difflineat">@@ -158,47 +158,47 @@ calWcapSession.prototype = {</span>
<a href="#l102.34"></a><span id="l102.34">                 }</span>
<a href="#l102.35"></a><span id="l102.35">                 return tzids[this.m_index++];</span>
<a href="#l102.36"></a><span id="l102.36">             },</span>
<a href="#l102.37"></a><span id="l102.37">             hasMore: function() {</span>
<a href="#l102.38"></a><span id="l102.38">                 return (this.m_index &lt; tzids.length);</span>
<a href="#l102.39"></a><span id="l102.39">             }</span>
<a href="#l102.40"></a><span id="l102.40">         };</span>
<a href="#l102.41"></a><span id="l102.41">     },</span>
<a href="#l102.42"></a><span id="l102.42" class="difflineminus">-    getTimezone: function calWcapSession_getTimezone(tzid) {</span>
<a href="#l102.43"></a><span id="l102.43" class="difflineplus">+    getTimezone: function(tzid) {</span>
<a href="#l102.44"></a><span id="l102.44">         switch (tzid) {</span>
<a href="#l102.45"></a><span id="l102.45">             case &quot;floating&quot;:</span>
<a href="#l102.46"></a><span id="l102.46">                 return floating();</span>
<a href="#l102.47"></a><span id="l102.47">             case &quot;UTC&quot;:</span>
<a href="#l102.48"></a><span id="l102.48">                 return UTC();</span>
<a href="#l102.49"></a><span id="l102.49">             default:</span>
<a href="#l102.50"></a><span id="l102.50">                 if (this.m_serverTimezones) {</span>
<a href="#l102.51"></a><span id="l102.51">                     return this.m_serverTimezones[tzid];</span>
<a href="#l102.52"></a><span id="l102.52">                 }</span>
<a href="#l102.53"></a><span id="l102.53">                 return null;</span>
<a href="#l102.54"></a><span id="l102.54">         }</span>
<a href="#l102.55"></a><span id="l102.55">     },</span>
<a href="#l102.56"></a><span id="l102.56"> </span>
<a href="#l102.57"></a><span id="l102.57">     m_serverTimeDiff: null,</span>
<a href="#l102.58"></a><span id="l102.58" class="difflineminus">-    getServerTime: function calWcapSession_getServerTime(localTime) {</span>
<a href="#l102.59"></a><span id="l102.59" class="difflineplus">+    getServerTime: function(localTime) {</span>
<a href="#l102.60"></a><span id="l102.60">         if (this.m_serverTimeDiff === null) {</span>
<a href="#l102.61"></a><span id="l102.61">             throw new Components.Exception(&quot;early run into getServerTime()!&quot;,</span>
<a href="#l102.62"></a><span id="l102.62">                                            Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l102.63"></a><span id="l102.63">         }</span>
<a href="#l102.64"></a><span id="l102.64">         let ret = (localTime ? localTime.clone() : getTime());</span>
<a href="#l102.65"></a><span id="l102.65">         ret.addDuration(this.m_serverTimeDiff);</span>
<a href="#l102.66"></a><span id="l102.66">         return ret;</span>
<a href="#l102.67"></a><span id="l102.67">     },</span>
<a href="#l102.68"></a><span id="l102.68"> </span>
<a href="#l102.69"></a><span id="l102.69">     m_sessionId: null,</span>
<a href="#l102.70"></a><span id="l102.70">     m_loginQueue: null,</span>
<a href="#l102.71"></a><span id="l102.71">     m_loginLock: false,</span>
<a href="#l102.72"></a><span id="l102.72"> </span>
<a href="#l102.73"></a><span id="l102.73">     getSessionId:</span>
<a href="#l102.74"></a><span id="l102.74" class="difflineminus">-    function calWcapSession_getSessionId(request, respFunc, timedOutSessionId) {</span>
<a href="#l102.75"></a><span id="l102.75" class="difflineplus">+    function(request, respFunc, timedOutSessionId) {</span>
<a href="#l102.76"></a><span id="l102.76">         if (Services.io.offline) {</span>
<a href="#l102.77"></a><span id="l102.77">             log(&quot;in offline mode.&quot;, this);</span>
<a href="#l102.78"></a><span id="l102.78">             respFunc(new Components.Exception(errorToString(NS_ERROR_OFFLINE), NS_ERROR_OFFLINE));</span>
<a href="#l102.79"></a><span id="l102.79">             return;</span>
<a href="#l102.80"></a><span id="l102.80">         }</span>
<a href="#l102.81"></a><span id="l102.81"> </span>
<a href="#l102.82"></a><span id="l102.82">         log(&quot;login queue lock: &quot; + this.m_loginLock + &quot;, length: &quot; + this.m_loginQueue.length, this);</span>
<a href="#l102.83"></a><span id="l102.83"> </span>
<a href="#l102.84"></a><span id="l102.84" class="difflineat">@@ -218,17 +218,17 @@ calWcapSession.prototype = {</span>
<a href="#l102.85"></a><span id="l102.85">             if (timedOutSessionId) {</span>
<a href="#l102.86"></a><span id="l102.86">                 log(&quot;reconnecting due to session timeout...&quot;, this);</span>
<a href="#l102.87"></a><span id="l102.87">                 getFreeBusyService().removeProvider(this);</span>
<a href="#l102.88"></a><span id="l102.88">                 getCalendarSearchService().removeProvider(this);</span>
<a href="#l102.89"></a><span id="l102.89">             }</span>
<a href="#l102.90"></a><span id="l102.90"> </span>
<a href="#l102.91"></a><span id="l102.91">             let self = this;</span>
<a href="#l102.92"></a><span id="l102.92">             this.getSessionId_(null, // don't couple to parent request parent may be cancelled</span>
<a href="#l102.93"></a><span id="l102.93" class="difflineminus">-                               function getSessionId_resp_(err, sessionId) {</span>
<a href="#l102.94"></a><span id="l102.94" class="difflineplus">+                               function(err, sessionId) {</span>
<a href="#l102.95"></a><span id="l102.95">                                    log(&quot;getSessionId_resp_(): &quot; + sessionId, self);</span>
<a href="#l102.96"></a><span id="l102.96">                                    if (!err) {</span>
<a href="#l102.97"></a><span id="l102.97">                                        self.m_sessionId = sessionId;</span>
<a href="#l102.98"></a><span id="l102.98">                                        getFreeBusyService().addProvider(self);</span>
<a href="#l102.99"></a><span id="l102.99">                                        getCalendarSearchService().addProvider(self);</span>
<a href="#l102.100"></a><span id="l102.100">                                    }</span>
<a href="#l102.101"></a><span id="l102.101"> </span>
<a href="#l102.102"></a><span id="l102.102">                                    let queue = self.m_loginQueue;</span>
<a href="#l102.103"></a><span id="l102.103" class="difflineat">@@ -249,22 +249,22 @@ calWcapSession.prototype = {</span>
<a href="#l102.104"></a><span id="l102.104">                                    queue.forEach(getSessionId_exec);</span>
<a href="#l102.105"></a><span id="l102.105">                                });</span>
<a href="#l102.106"></a><span id="l102.106">         }</span>
<a href="#l102.107"></a><span id="l102.107">     },</span>
<a href="#l102.108"></a><span id="l102.108"> </span>
<a href="#l102.109"></a><span id="l102.109">     // this is a server limit for recurrencies; default is 60</span>
<a href="#l102.110"></a><span id="l102.110">     recurrenceBound: 60,</span>
<a href="#l102.111"></a><span id="l102.111"> </span>
<a href="#l102.112"></a><span id="l102.112" class="difflineminus">-    getSessionId_: function calWcapSession_getSessionId_(request, respFunc) {</span>
<a href="#l102.113"></a><span id="l102.113" class="difflineplus">+    getSessionId_: function(request, respFunc) {</span>
<a href="#l102.114"></a><span id="l102.114">         let self = this;</span>
<a href="#l102.115"></a><span id="l102.115">         this.checkServerVersion(</span>
<a href="#l102.116"></a><span id="l102.116">             request,</span>
<a href="#l102.117"></a><span id="l102.117">             // probe whether server is accessible and responds:</span>
<a href="#l102.118"></a><span id="l102.118" class="difflineminus">-            function checkServerVersion_resp(err) {</span>
<a href="#l102.119"></a><span id="l102.119" class="difflineplus">+            function(err) {</span>
<a href="#l102.120"></a><span id="l102.120">                 if (err) {</span>
<a href="#l102.121"></a><span id="l102.121">                     respFunc(err);</span>
<a href="#l102.122"></a><span id="l102.122">                     return;</span>
<a href="#l102.123"></a><span id="l102.123">                 }</span>
<a href="#l102.124"></a><span id="l102.124">                 // lookup password manager, then try login or prompt/login:</span>
<a href="#l102.125"></a><span id="l102.125">                 log(&quot;attempting to get a session id for &quot; + self.sessionUri.spec, self);</span>
<a href="#l102.126"></a><span id="l102.126"> </span>
<a href="#l102.127"></a><span id="l102.127">                 if (!self.sessionUri.schemeIs(&quot;https&quot;) &amp;&amp;</span>
<a href="#l102.128"></a><span id="l102.128" class="difflineat">@@ -308,35 +308,35 @@ calWcapSession.prototype = {</span>
<a href="#l102.129"></a><span id="l102.129">                         if (outSavePW.value) {</span>
<a href="#l102.130"></a><span id="l102.130">                             // so try to remove old pw from db first:</span>
<a href="#l102.131"></a><span id="l102.131">                             cal.auth.passwordManagerSave(outUser.value, outPW.value, self.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l102.132"></a><span id="l102.132">                         }</span>
<a href="#l102.133"></a><span id="l102.133">                         self.credentials.userId = outUser.value;</span>
<a href="#l102.134"></a><span id="l102.134">                         self.credentials.pw = outPW.value;</span>
<a href="#l102.135"></a><span id="l102.135">                         self.setupSession(sessionId,</span>
<a href="#l102.136"></a><span id="l102.136">                                           request,</span>
<a href="#l102.137"></a><span id="l102.137" class="difflineminus">-                                          function setupSession_resp(setuperr) {</span>
<a href="#l102.138"></a><span id="l102.138" class="difflineplus">+                                          function(setuperr) {</span>
<a href="#l102.139"></a><span id="l102.139">                                               respFunc(setuperr, sessionId);</span>
<a href="#l102.140"></a><span id="l102.140">                                           });</span>
<a href="#l102.141"></a><span id="l102.141">                     }</span>
<a href="#l102.142"></a><span id="l102.142">                 }</span>
<a href="#l102.143"></a><span id="l102.143"> </span>
<a href="#l102.144"></a><span id="l102.144">                 if (outPW.value) {</span>
<a href="#l102.145"></a><span id="l102.145">                     self.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l102.146"></a><span id="l102.146">                 } else {</span>
<a href="#l102.147"></a><span id="l102.147">                     promptAndLoginLoop_resp(calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l102.148"></a><span id="l102.148">                 }</span>
<a href="#l102.149"></a><span id="l102.149">             });</span>
<a href="#l102.150"></a><span id="l102.150">     },</span>
<a href="#l102.151"></a><span id="l102.151"> </span>
<a href="#l102.152"></a><span id="l102.152" class="difflineminus">-    login: function calWcapSession_login(request, respFunc, user, pw) {</span>
<a href="#l102.153"></a><span id="l102.153" class="difflineplus">+    login: function(request, respFunc, user, pw) {</span>
<a href="#l102.154"></a><span id="l102.154">         let self = this;</span>
<a href="#l102.155"></a><span id="l102.155">         issueNetworkRequest(</span>
<a href="#l102.156"></a><span id="l102.156">             request,</span>
<a href="#l102.157"></a><span id="l102.157" class="difflineminus">-            function netResp(err, str) {</span>
<a href="#l102.158"></a><span id="l102.158" class="difflineplus">+            function(err, str) {</span>
<a href="#l102.159"></a><span id="l102.159">                 let sessionId;</span>
<a href="#l102.160"></a><span id="l102.160">                 try {</span>
<a href="#l102.161"></a><span id="l102.161">                     if (err) {</span>
<a href="#l102.162"></a><span id="l102.162">                         throw err;</span>
<a href="#l102.163"></a><span id="l102.163">                     }</span>
<a href="#l102.164"></a><span id="l102.164">                     // currently, xml parsing at an early stage during</span>
<a href="#l102.165"></a><span id="l102.165">                     // process startup does not work reliably, so use</span>
<a href="#l102.166"></a><span id="l102.166">                     // libical parsing for now:</span>
<a href="#l102.167"></a><span id="l102.167" class="difflineat">@@ -367,20 +367,20 @@ calWcapSession.prototype = {</span>
<a href="#l102.168"></a><span id="l102.168">                 }</span>
<a href="#l102.169"></a><span id="l102.169">                 respFunc(err, sessionId);</span>
<a href="#l102.170"></a><span id="l102.170">             },</span>
<a href="#l102.171"></a><span id="l102.171">             self.sessionUri.spec + &quot;login.wcap?fmt-out=text%2Fcalendar&amp;user=&quot; +</span>
<a href="#l102.172"></a><span id="l102.172">             encodeURIComponent(user) + &quot;&amp;password=&quot; + encodeURIComponent(pw),</span>
<a href="#l102.173"></a><span id="l102.173">             false /* no logging */);</span>
<a href="#l102.174"></a><span id="l102.174">     },</span>
<a href="#l102.175"></a><span id="l102.175"> </span>
<a href="#l102.176"></a><span id="l102.176" class="difflineminus">-    logout: function calWcapSession_logout(listener) {</span>
<a href="#l102.177"></a><span id="l102.177" class="difflineplus">+    logout: function(listener) {</span>
<a href="#l102.178"></a><span id="l102.178">         let self = this;</span>
<a href="#l102.179"></a><span id="l102.179">         let request = new calWcapRequest(</span>
<a href="#l102.180"></a><span id="l102.180" class="difflineminus">-            function logout_resp(oprequest, err) {</span>
<a href="#l102.181"></a><span id="l102.181" class="difflineplus">+            function(oprequest, err) {</span>
<a href="#l102.182"></a><span id="l102.182">                 if (err) {</span>
<a href="#l102.183"></a><span id="l102.183">                     logError(err, self);</span>
<a href="#l102.184"></a><span id="l102.184">                 } else {</span>
<a href="#l102.185"></a><span id="l102.185">                     log(&quot;logout succeeded.&quot;, self);</span>
<a href="#l102.186"></a><span id="l102.186">                 }</span>
<a href="#l102.187"></a><span id="l102.187">                 if (listener) {</span>
<a href="#l102.188"></a><span id="l102.188">                     listener.onResult(oprequest, null);</span>
<a href="#l102.189"></a><span id="l102.189">                 }</span>
<a href="#l102.190"></a><span id="l102.190" class="difflineat">@@ -398,35 +398,35 @@ calWcapSession.prototype = {</span>
<a href="#l102.191"></a><span id="l102.191">             this.m_sessionId = null;</span>
<a href="#l102.192"></a><span id="l102.192">             getFreeBusyService().removeProvider(this);</span>
<a href="#l102.193"></a><span id="l102.193">             getCalendarSearchService().removeProvider(this);</span>
<a href="#l102.194"></a><span id="l102.194">         }</span>
<a href="#l102.195"></a><span id="l102.195">         this.m_credentials = null;</span>
<a href="#l102.196"></a><span id="l102.196"> </span>
<a href="#l102.197"></a><span id="l102.197">         if (url) {</span>
<a href="#l102.198"></a><span id="l102.198">             issueNetworkRequest(request,</span>
<a href="#l102.199"></a><span id="l102.199" class="difflineminus">-                                function netResp(err, str) {</span>
<a href="#l102.200"></a><span id="l102.200" class="difflineplus">+                                function(err, str) {</span>
<a href="#l102.201"></a><span id="l102.201">                                     if (err) {</span>
<a href="#l102.202"></a><span id="l102.202">                                         throw err;</span>
<a href="#l102.203"></a><span id="l102.203">                                     }</span>
<a href="#l102.204"></a><span id="l102.204">                                     stringToXml(self, str, -1 /* logout successfull */);</span>
<a href="#l102.205"></a><span id="l102.205">                                 }, url);</span>
<a href="#l102.206"></a><span id="l102.206">         } else {</span>
<a href="#l102.207"></a><span id="l102.207">             request.execRespFunc();</span>
<a href="#l102.208"></a><span id="l102.208">         }</span>
<a href="#l102.209"></a><span id="l102.209">         return request;</span>
<a href="#l102.210"></a><span id="l102.210">     },</span>
<a href="#l102.211"></a><span id="l102.211"> </span>
<a href="#l102.212"></a><span id="l102.212" class="difflineminus">-    checkServerVersion: function calWcapSession_checkServerVersion(request, respFunc) {</span>
<a href="#l102.213"></a><span id="l102.213" class="difflineplus">+    checkServerVersion: function(request, respFunc) {</span>
<a href="#l102.214"></a><span id="l102.214">         // currently, xml parsing at an early stage during process startup</span>
<a href="#l102.215"></a><span id="l102.215">         // does not work reliably, so use libical:</span>
<a href="#l102.216"></a><span id="l102.216">         let self = this;</span>
<a href="#l102.217"></a><span id="l102.217">         issueNetworkRequest(</span>
<a href="#l102.218"></a><span id="l102.218">             request,</span>
<a href="#l102.219"></a><span id="l102.219" class="difflineminus">-            function netResp(err, str) {</span>
<a href="#l102.220"></a><span id="l102.220" class="difflineplus">+            function(err, str) {</span>
<a href="#l102.221"></a><span id="l102.221">                 try {</span>
<a href="#l102.222"></a><span id="l102.222">                     let icalRootComp;</span>
<a href="#l102.223"></a><span id="l102.223">                     if (!err) {</span>
<a href="#l102.224"></a><span id="l102.224">                         try {</span>
<a href="#l102.225"></a><span id="l102.225">                             icalRootComp = stringToIcal(self, str);</span>
<a href="#l102.226"></a><span id="l102.226">                         } catch (exc) {</span>
<a href="#l102.227"></a><span id="l102.227">                             err = exc;</span>
<a href="#l102.228"></a><span id="l102.228">                         }</span>
<a href="#l102.229"></a><span id="l102.229" class="difflineat">@@ -465,33 +465,33 @@ calWcapSession.prototype = {</span>
<a href="#l102.230"></a><span id="l102.230">                 } catch (exc) {</span>
<a href="#l102.231"></a><span id="l102.231">                     err = exc;</span>
<a href="#l102.232"></a><span id="l102.232">                 }</span>
<a href="#l102.233"></a><span id="l102.233">                 respFunc(err);</span>
<a href="#l102.234"></a><span id="l102.234">             },</span>
<a href="#l102.235"></a><span id="l102.235">             self.sessionUri.spec + &quot;version.wcap?fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l102.236"></a><span id="l102.236">     },</span>
<a href="#l102.237"></a><span id="l102.237"> </span>
<a href="#l102.238"></a><span id="l102.238" class="difflineminus">-    setupSession: function calWcapSession_setupSession(sessionId, request_, respFunc) {</span>
<a href="#l102.239"></a><span id="l102.239" class="difflineplus">+    setupSession: function(sessionId, request_, respFunc) {</span>
<a href="#l102.240"></a><span id="l102.240">         let self = this;</span>
<a href="#l102.241"></a><span id="l102.241">         let request = new calWcapRequest(</span>
<a href="#l102.242"></a><span id="l102.242" class="difflineminus">-            function setupSession_resp(oprequest, err) {</span>
<a href="#l102.243"></a><span id="l102.243" class="difflineplus">+            function(oprequest, err) {</span>
<a href="#l102.244"></a><span id="l102.244">                 log(&quot;setupSession_resp finished: &quot; + errorToString(err), self);</span>
<a href="#l102.245"></a><span id="l102.245">                 respFunc(err);</span>
<a href="#l102.246"></a><span id="l102.246">             },</span>
<a href="#l102.247"></a><span id="l102.247">             log(&quot;setupSession&quot;, this));</span>
<a href="#l102.248"></a><span id="l102.248">         if (request_) {</span>
<a href="#l102.249"></a><span id="l102.249">             request_.attachSubRequest(request);</span>
<a href="#l102.250"></a><span id="l102.250">         }</span>
<a href="#l102.251"></a><span id="l102.251"> </span>
<a href="#l102.252"></a><span id="l102.252">         request.lockPending();</span>
<a href="#l102.253"></a><span id="l102.253">         try {</span>
<a href="#l102.254"></a><span id="l102.254">             this.issueNetworkRequest_(</span>
<a href="#l102.255"></a><span id="l102.255">                 request,</span>
<a href="#l102.256"></a><span id="l102.256" class="difflineminus">-                function userprefs_resp(err, data) {</span>
<a href="#l102.257"></a><span id="l102.257" class="difflineplus">+                function(err, data) {</span>
<a href="#l102.258"></a><span id="l102.258">                     if (err) {</span>
<a href="#l102.259"></a><span id="l102.259">                         throw err;</span>
<a href="#l102.260"></a><span id="l102.260">                     }</span>
<a href="#l102.261"></a><span id="l102.261">                     self.credentials.userPrefs = data;</span>
<a href="#l102.262"></a><span id="l102.262">                     log(&quot;installed user prefs.&quot;, self);</span>
<a href="#l102.263"></a><span id="l102.263"> </span>
<a href="#l102.264"></a><span id="l102.264">                     // get calprops for all registered calendars:</span>
<a href="#l102.265"></a><span id="l102.265">                     let cals = self.getRegisteredCalendars(true);</span>
<a href="#l102.266"></a><span id="l102.266" class="difflineat">@@ -550,18 +550,17 @@ calWcapSession.prototype = {</span>
<a href="#l102.267"></a><span id="l102.267">                 sessionId);</span>
<a href="#l102.268"></a><span id="l102.268">             this.installServerTimeDiff(sessionId, request);</span>
<a href="#l102.269"></a><span id="l102.269">             this.installServerTimezones(sessionId, request);</span>
<a href="#l102.270"></a><span id="l102.270">         } finally {</span>
<a href="#l102.271"></a><span id="l102.271">             request.unlockPending();</span>
<a href="#l102.272"></a><span id="l102.272">         }</span>
<a href="#l102.273"></a><span id="l102.273">     },</span>
<a href="#l102.274"></a><span id="l102.274"> </span>
<a href="#l102.275"></a><span id="l102.275" class="difflineminus">-    installCalProps_get_calprops:</span>
<a href="#l102.276"></a><span id="l102.276" class="difflineminus">-    function calWcapSession_installCalProps_get_calprops(respFunc, sessionId, cals, request) {</span>
<a href="#l102.277"></a><span id="l102.277" class="difflineplus">+    installCalProps_get_calprops: function(respFunc, sessionId, cals, request) {</span>
<a href="#l102.278"></a><span id="l102.278">         let self = this;</span>
<a href="#l102.279"></a><span id="l102.279">         function calprops_resp(err, data) {</span>
<a href="#l102.280"></a><span id="l102.280">             if (err) {</span>
<a href="#l102.281"></a><span id="l102.281">                 throw err;</span>
<a href="#l102.282"></a><span id="l102.282">             }</span>
<a href="#l102.283"></a><span id="l102.283">             // string to xml converter func without WCAP errno check:</span>
<a href="#l102.284"></a><span id="l102.284">             if (!data || data.length == 0) { // assuming time-out</span>
<a href="#l102.285"></a><span id="l102.285">                 throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l102.286"></a><span id="l102.286" class="difflineat">@@ -604,25 +603,24 @@ calWcapSession.prototype = {</span>
<a href="#l102.287"></a><span id="l102.287">             calidParam += encodeURIComponent(calId);</span>
<a href="#l102.288"></a><span id="l102.288">         }</span>
<a href="#l102.289"></a><span id="l102.289">         self.issueNetworkRequest_(request, calprops_resp,</span>
<a href="#l102.290"></a><span id="l102.290">                                   null, &quot;get_calprops&quot;,</span>
<a href="#l102.291"></a><span id="l102.291">                                   &quot;&amp;fmt-out=text%2Fxml&amp;calid=&quot; + calidParam,</span>
<a href="#l102.292"></a><span id="l102.292">                                   sessionId);</span>
<a href="#l102.293"></a><span id="l102.293">     },</span>
<a href="#l102.294"></a><span id="l102.294"> </span>
<a href="#l102.295"></a><span id="l102.295" class="difflineminus">-    installCalProps_search_calprops:</span>
<a href="#l102.296"></a><span id="l102.296" class="difflineminus">-    function calWcapSession_installCalProps_search_calprops(respFunc, sessionId, cals, request) {</span>
<a href="#l102.297"></a><span id="l102.297" class="difflineplus">+    installCalProps_search_calprops: function(respFunc, sessionId, cals, request) {</span>
<a href="#l102.298"></a><span id="l102.298">         let self = this;</span>
<a href="#l102.299"></a><span id="l102.299">         let retrievedCals = {};</span>
<a href="#l102.300"></a><span id="l102.300">         let issuedSearchRequests = {};</span>
<a href="#l102.301"></a><span id="l102.301">         for (let calId in cals) {</span>
<a href="#l102.302"></a><span id="l102.302">             if (!retrievedCals[calId]) {</span>
<a href="#l102.303"></a><span id="l102.303">                 let listener = {</span>
<a href="#l102.304"></a><span id="l102.304" class="difflineminus">-                    onResult: function search_onResult(oprequest, result) {</span>
<a href="#l102.305"></a><span id="l102.305" class="difflineplus">+                    onResult: function(oprequest, result) {</span>
<a href="#l102.306"></a><span id="l102.306">                         try {</span>
<a href="#l102.307"></a><span id="l102.307">                             if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l102.308"></a><span id="l102.308">                                 throw oprequest.status;</span>
<a href="#l102.309"></a><span id="l102.309">                             }</span>
<a href="#l102.310"></a><span id="l102.310">                             if (result.length &lt; 1) {</span>
<a href="#l102.311"></a><span id="l102.311">                                 throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l102.312"></a><span id="l102.312">                             }</span>
<a href="#l102.313"></a><span id="l102.313">                             for (let calendar of result) {</span>
<a href="#l102.314"></a><span id="l102.314" class="difflineat">@@ -653,42 +651,42 @@ calWcapSession.prototype = {</span>
<a href="#l102.315"></a><span id="l102.315">                 if (!issuedSearchRequests[calId]) {</span>
<a href="#l102.316"></a><span id="l102.316">                     issuedSearchRequests[calId] = true;</span>
<a href="#l102.317"></a><span id="l102.317">                     this.searchForCalendars(calId, calICalendarSearchProvider.HINT_EXACT_MATCH, 20, listener);</span>
<a href="#l102.318"></a><span id="l102.318">                 }</span>
<a href="#l102.319"></a><span id="l102.319">             }</span>
<a href="#l102.320"></a><span id="l102.320">         }</span>
<a href="#l102.321"></a><span id="l102.321">     },</span>
<a href="#l102.322"></a><span id="l102.322"> </span>
<a href="#l102.323"></a><span id="l102.323" class="difflineminus">-    installServerTimeDiff: function calWcapSession_installServerTimeDiff(sessionId, request) {</span>
<a href="#l102.324"></a><span id="l102.324" class="difflineplus">+    installServerTimeDiff: function(sessionId, request) {</span>
<a href="#l102.325"></a><span id="l102.325">         let self = this;</span>
<a href="#l102.326"></a><span id="l102.326">         this.issueNetworkRequest_(</span>
<a href="#l102.327"></a><span id="l102.327">             request,</span>
<a href="#l102.328"></a><span id="l102.328" class="difflineminus">-            function netResp(err, data) {</span>
<a href="#l102.329"></a><span id="l102.329" class="difflineplus">+            function(err, data) {</span>
<a href="#l102.330"></a><span id="l102.330">                 if (err) {</span>
<a href="#l102.331"></a><span id="l102.331">                     throw err;</span>
<a href="#l102.332"></a><span id="l102.332">                 }</span>
<a href="#l102.333"></a><span id="l102.333">                 // xxx todo: think about</span>
<a href="#l102.334"></a><span id="l102.334">                 // assure that locally calculated server time is smaller</span>
<a href="#l102.335"></a><span id="l102.335">                 // than the current (real) server time:</span>
<a href="#l102.336"></a><span id="l102.336">                 let localTime = getTime();</span>
<a href="#l102.337"></a><span id="l102.337">                 let serverTime = getDatetimeFromIcalProp(data.getFirstProperty(&quot;X-NSCP-WCAPTIME&quot;));</span>
<a href="#l102.338"></a><span id="l102.338">                 self.m_serverTimeDiff = serverTime.subtractDate(localTime);</span>
<a href="#l102.339"></a><span id="l102.339">                 log(&quot;server time diff is: &quot; + self.m_serverTimeDiff, self);</span>
<a href="#l102.340"></a><span id="l102.340">             },</span>
<a href="#l102.341"></a><span id="l102.341">             stringToIcal, &quot;gettime&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l102.342"></a><span id="l102.342">             sessionId);</span>
<a href="#l102.343"></a><span id="l102.343">     },</span>
<a href="#l102.344"></a><span id="l102.344"> </span>
<a href="#l102.345"></a><span id="l102.345" class="difflineminus">-    installServerTimezones: function calWcapSession_installServerTimezones(sessionId, request) {</span>
<a href="#l102.346"></a><span id="l102.346" class="difflineplus">+    installServerTimezones: function(sessionId, request) {</span>
<a href="#l102.347"></a><span id="l102.347">         this.m_serverTimezones = {};</span>
<a href="#l102.348"></a><span id="l102.348">         let self = this;</span>
<a href="#l102.349"></a><span id="l102.349">         self.issueNetworkRequest_(</span>
<a href="#l102.350"></a><span id="l102.350">             request,</span>
<a href="#l102.351"></a><span id="l102.351" class="difflineminus">-            function netResp(err, data) {</span>
<a href="#l102.352"></a><span id="l102.352" class="difflineplus">+            function(err, data) {</span>
<a href="#l102.353"></a><span id="l102.353">                 if (err) {</span>
<a href="#l102.354"></a><span id="l102.354">                     throw err;</span>
<a href="#l102.355"></a><span id="l102.355">                 }</span>
<a href="#l102.356"></a><span id="l102.356">                 for (let subComp of cal.ical.calendarComponentIterator(data, &quot;VTIMEZONE&quot;)) {</span>
<a href="#l102.357"></a><span id="l102.357">                     try {</span>
<a href="#l102.358"></a><span id="l102.358">                         let tzid = subComp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l102.359"></a><span id="l102.359">                         self.m_serverTimezones[tzid] = new calWcapTimezone(self, tzid, subComp);</span>
<a href="#l102.360"></a><span id="l102.360">                     } catch (exc) { // ignore but errors:</span>
<a href="#l102.361"></a><span id="l102.361" class="difflineat">@@ -696,35 +694,34 @@ calWcapSession.prototype = {</span>
<a href="#l102.362"></a><span id="l102.362">                     }</span>
<a href="#l102.363"></a><span id="l102.363">                 }</span>
<a href="#l102.364"></a><span id="l102.364">                 log(&quot;installed timezones.&quot;, self);</span>
<a href="#l102.365"></a><span id="l102.365">             },</span>
<a href="#l102.366"></a><span id="l102.366">             stringToIcal, &quot;get_all_timezones&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l102.367"></a><span id="l102.367">             sessionId);</span>
<a href="#l102.368"></a><span id="l102.368">     },</span>
<a href="#l102.369"></a><span id="l102.369"> </span>
<a href="#l102.370"></a><span id="l102.370" class="difflineminus">-    getCommandUrl: function calWcapSession_getCommandUrl(wcapCommand, params, sessionId) {</span>
<a href="#l102.371"></a><span id="l102.371" class="difflineplus">+    getCommandUrl: function(wcapCommand, params, sessionId) {</span>
<a href="#l102.372"></a><span id="l102.372">         let url = this.sessionUri.spec;</span>
<a href="#l102.373"></a><span id="l102.373">         url += wcapCommand + &quot;.wcap?appid=mozilla-calendar&amp;id=&quot;;</span>
<a href="#l102.374"></a><span id="l102.374">         url += sessionId;</span>
<a href="#l102.375"></a><span id="l102.375">         url += params;</span>
<a href="#l102.376"></a><span id="l102.376">         return url;</span>
<a href="#l102.377"></a><span id="l102.377">     },</span>
<a href="#l102.378"></a><span id="l102.378"> </span>
<a href="#l102.379"></a><span id="l102.379" class="difflineminus">-    issueNetworkRequest: function calWcapSession_issueNetworkRequest(</span>
<a href="#l102.380"></a><span id="l102.380" class="difflineminus">-                    request, respFunc, dataConvFunc, wcapCommand, params) {</span>
<a href="#l102.381"></a><span id="l102.381" class="difflineplus">+    issueNetworkRequest: function(request, respFunc, dataConvFunc, wcapCommand, params) {</span>
<a href="#l102.382"></a><span id="l102.382">         let self = this;</span>
<a href="#l102.383"></a><span id="l102.383">         let getSessionId_resp = function(err, sessionId) {</span>
<a href="#l102.384"></a><span id="l102.384">             if (err) {</span>
<a href="#l102.385"></a><span id="l102.385">                 request.execSubRespFunc(respFunc, err);</span>
<a href="#l102.386"></a><span id="l102.386">             } else {</span>
<a href="#l102.387"></a><span id="l102.387">                 // else have session uri and id:</span>
<a href="#l102.388"></a><span id="l102.388">                 self.issueNetworkRequest_(</span>
<a href="#l102.389"></a><span id="l102.389">                     request,</span>
<a href="#l102.390"></a><span id="l102.390" class="difflineminus">-                    function issueNetworkRequest_resp(loginerr, data) {</span>
<a href="#l102.391"></a><span id="l102.391" class="difflineplus">+                    function(loginerr, data) {</span>
<a href="#l102.392"></a><span id="l102.392">                         // timeout?</span>
<a href="#l102.393"></a><span id="l102.393">                         if (checkErrorCode(loginerr, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l102.394"></a><span id="l102.394">                             // try again:</span>
<a href="#l102.395"></a><span id="l102.395">                             self.getSessionId(</span>
<a href="#l102.396"></a><span id="l102.396">                                 request,</span>
<a href="#l102.397"></a><span id="l102.397">                                 getSessionId_resp,</span>
<a href="#l102.398"></a><span id="l102.398">                                 sessionId/* (old) timed-out session */);</span>
<a href="#l102.399"></a><span id="l102.399">                             return;</span>
<a href="#l102.400"></a><span id="l102.400" class="difflineat">@@ -732,22 +729,21 @@ calWcapSession.prototype = {</span>
<a href="#l102.401"></a><span id="l102.401">                         request.execSubRespFunc(respFunc, loginerr, data);</span>
<a href="#l102.402"></a><span id="l102.402">                     },</span>
<a href="#l102.403"></a><span id="l102.403">                     dataConvFunc, wcapCommand, params, sessionId);</span>
<a href="#l102.404"></a><span id="l102.404">             }</span>
<a href="#l102.405"></a><span id="l102.405">         };</span>
<a href="#l102.406"></a><span id="l102.406">         this.getSessionId(request, getSessionId_resp);</span>
<a href="#l102.407"></a><span id="l102.407">     },</span>
<a href="#l102.408"></a><span id="l102.408"> </span>
<a href="#l102.409"></a><span id="l102.409" class="difflineminus">-    issueNetworkRequest_: function calWcapSession_issueNetworkRequest_(</span>
<a href="#l102.410"></a><span id="l102.410" class="difflineminus">-                    request, respFunc, dataConvFunc, wcapCommand, params, sessionId) {</span>
<a href="#l102.411"></a><span id="l102.411" class="difflineplus">+    issueNetworkRequest_: function(request, respFunc, dataConvFunc, wcapCommand, params, sessionId) {</span>
<a href="#l102.412"></a><span id="l102.412">         let url = this.getCommandUrl(wcapCommand, params, sessionId);</span>
<a href="#l102.413"></a><span id="l102.413">         let self = this;</span>
<a href="#l102.414"></a><span id="l102.414">         issueNetworkRequest(request,</span>
<a href="#l102.415"></a><span id="l102.415" class="difflineminus">-                            function netResp(err, str) {</span>
<a href="#l102.416"></a><span id="l102.416" class="difflineplus">+                            function(err, str) {</span>
<a href="#l102.417"></a><span id="l102.417">                                 let data;</span>
<a href="#l102.418"></a><span id="l102.418">                                 if (!err) {</span>
<a href="#l102.419"></a><span id="l102.419">                                     try {</span>
<a href="#l102.420"></a><span id="l102.420">                                         if (dataConvFunc) {</span>
<a href="#l102.421"></a><span id="l102.421">                                             data = dataConvFunc(self, str);</span>
<a href="#l102.422"></a><span id="l102.422">                                         } else {</span>
<a href="#l102.423"></a><span id="l102.423">                                             data = str;</span>
<a href="#l102.424"></a><span id="l102.424">                                         }</span>
<a href="#l102.425"></a><span id="l102.425" class="difflineat">@@ -801,82 +797,81 @@ calWcapSession.prototype = {</span>
<a href="#l102.426"></a><span id="l102.426">     },</span>
<a href="#l102.427"></a><span id="l102.427"> </span>
<a href="#l102.428"></a><span id="l102.428">     get isLoggedIn() {</span>
<a href="#l102.429"></a><span id="l102.429">         return (this.m_sessionId != null);</span>
<a href="#l102.430"></a><span id="l102.430">     },</span>
<a href="#l102.431"></a><span id="l102.431"> </span>
<a href="#l102.432"></a><span id="l102.432">     defaultCalendar: null,</span>
<a href="#l102.433"></a><span id="l102.433"> </span>
<a href="#l102.434"></a><span id="l102.434" class="difflineminus">-    belongsTo: function calWcapSession_belongsTo(calendar) {</span>
<a href="#l102.435"></a><span id="l102.435" class="difflineplus">+    belongsTo: function(calendar) {</span>
<a href="#l102.436"></a><span id="l102.436">         try {</span>
<a href="#l102.437"></a><span id="l102.437">             // xxx todo hack to get the unwrapped wcap calendar instance:</span>
<a href="#l102.438"></a><span id="l102.438">             calendar = calendar.getProperty(&quot;cache.uncachedCalendar&quot;)</span>
<a href="#l102.439"></a><span id="l102.439">                                .QueryInterface(calIWcapCalendar).wrappedJSObject;</span>
<a href="#l102.440"></a><span id="l102.440">             if (calendar &amp;&amp; (calendar.session.m_contextId == this.m_contextId)) {</span>
<a href="#l102.441"></a><span id="l102.441">                 return calendar;</span>
<a href="#l102.442"></a><span id="l102.442">             }</span>
<a href="#l102.443"></a><span id="l102.443">         } catch (exc) {</span>
<a href="#l102.444"></a><span id="l102.444">             // Fall through to the return statement below in case the uncached</span>
<a href="#l102.445"></a><span id="l102.445">             // calendar can't be retrieved.</span>
<a href="#l102.446"></a><span id="l102.446">         }</span>
<a href="#l102.447"></a><span id="l102.447">         return null;</span>
<a href="#l102.448"></a><span id="l102.448">     },</span>
<a href="#l102.449"></a><span id="l102.449"> </span>
<a href="#l102.450"></a><span id="l102.450" class="difflineminus">-    getRegisteredCalendars: function calWcapSession_getRegisteredCalendars(asAssocObj) {</span>
<a href="#l102.451"></a><span id="l102.451" class="difflineplus">+    getRegisteredCalendars: function(asAssocObj) {</span>
<a href="#l102.452"></a><span id="l102.452">         let registeredCalendars = (asAssocObj ? {} : []);</span>
<a href="#l102.453"></a><span id="l102.453">         let cals = cal.getCalendarManager().getCalendars({});</span>
<a href="#l102.454"></a><span id="l102.454">         for (let calendar of cals) {</span>
<a href="#l102.455"></a><span id="l102.455">             calendar = this.belongsTo(calendar);</span>
<a href="#l102.456"></a><span id="l102.456">             if (calendar) {</span>
<a href="#l102.457"></a><span id="l102.457">                 if (asAssocObj) {</span>
<a href="#l102.458"></a><span id="l102.458">                     registeredCalendars[calendar.calId] = calendar;</span>
<a href="#l102.459"></a><span id="l102.459">                 } else {</span>
<a href="#l102.460"></a><span id="l102.460">                     registeredCalendars.push(calendar);</span>
<a href="#l102.461"></a><span id="l102.461">                 }</span>
<a href="#l102.462"></a><span id="l102.462">             }</span>
<a href="#l102.463"></a><span id="l102.463">         }</span>
<a href="#l102.464"></a><span id="l102.464">         return registeredCalendars;</span>
<a href="#l102.465"></a><span id="l102.465">     },</span>
<a href="#l102.466"></a><span id="l102.466"> </span>
<a href="#l102.467"></a><span id="l102.467" class="difflineminus">-    getUserPreferences: function calWcapSession_getUserPreferences(prefName) {</span>
<a href="#l102.468"></a><span id="l102.468" class="difflineplus">+    getUserPreferences: function(prefName) {</span>
<a href="#l102.469"></a><span id="l102.469">         let prefs = filterXmlNodes(prefName, this.credentials.userPrefs);</span>
<a href="#l102.470"></a><span id="l102.470">         return prefs;</span>
<a href="#l102.471"></a><span id="l102.471">     },</span>
<a href="#l102.472"></a><span id="l102.472"> </span>
<a href="#l102.473"></a><span id="l102.473">     get defaultAlarmStart() {</span>
<a href="#l102.474"></a><span id="l102.474">         let alarmStart = null;</span>
<a href="#l102.475"></a><span id="l102.475">         let ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmStart&quot;);</span>
<a href="#l102.476"></a><span id="l102.476">         if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l102.477"></a><span id="l102.477">             // workarounding cs duration bug, missing &quot;T&quot;:</span>
<a href="#l102.478"></a><span id="l102.478">             let dur = ar[0].replace(/(^P)(\d+[HMS]$)/, &quot;$1T$2&quot;);</span>
<a href="#l102.479"></a><span id="l102.479">             alarmStart = cal.createDuration(dur);</span>
<a href="#l102.480"></a><span id="l102.480">             alarmStart.isNegative = !alarmStart.isNegative;</span>
<a href="#l102.481"></a><span id="l102.481">         }</span>
<a href="#l102.482"></a><span id="l102.482">         return alarmStart;</span>
<a href="#l102.483"></a><span id="l102.483">     },</span>
<a href="#l102.484"></a><span id="l102.484"> </span>
<a href="#l102.485"></a><span id="l102.485" class="difflineminus">-    getDefaultAlarmEmails: function calWcapSession_getDefaultAlarmEmails(out_count) {</span>
<a href="#l102.486"></a><span id="l102.486" class="difflineplus">+    getDefaultAlarmEmails: function(out_count) {</span>
<a href="#l102.487"></a><span id="l102.487">         let ret = [];</span>
<a href="#l102.488"></a><span id="l102.488">         let ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmEmail&quot;);</span>
<a href="#l102.489"></a><span id="l102.489">         if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l102.490"></a><span id="l102.490">             for (let i of ar) {</span>
<a href="#l102.491"></a><span id="l102.491">                 ret = ret.concat(i.split(/[;,]/).map(String.trim));</span>
<a href="#l102.492"></a><span id="l102.492">             }</span>
<a href="#l102.493"></a><span id="l102.493">         }</span>
<a href="#l102.494"></a><span id="l102.494">         out_count.value = ret.length;</span>
<a href="#l102.495"></a><span id="l102.495">         return ret;</span>
<a href="#l102.496"></a><span id="l102.496">     },</span>
<a href="#l102.497"></a><span id="l102.497"> </span>
<a href="#l102.498"></a><span id="l102.498">     // calICalendarSearchProvider:</span>
<a href="#l102.499"></a><span id="l102.499" class="difflineminus">-    searchForCalendars:</span>
<a href="#l102.500"></a><span id="l102.500" class="difflineminus">-    function calWcapSession_searchForCalendars(searchString, hints, maxResults, listener) {</span>
<a href="#l102.501"></a><span id="l102.501" class="difflineplus">+    searchForCalendars: function(searchString, hints, maxResults, listener) {</span>
<a href="#l102.502"></a><span id="l102.502">         let self = this;</span>
<a href="#l102.503"></a><span id="l102.503">         let request = new calWcapRequest(</span>
<a href="#l102.504"></a><span id="l102.504" class="difflineminus">-            function searchForCalendars_resp(oprequest, err, data) {</span>
<a href="#l102.505"></a><span id="l102.505" class="difflineplus">+            function(oprequest, err, data) {</span>
<a href="#l102.506"></a><span id="l102.506">                 if (err &amp;&amp; !checkErrorCode(err, calIErrors.OPERATION_CANCELLED)) {</span>
<a href="#l102.507"></a><span id="l102.507">                     self.notifyError(err);</span>
<a href="#l102.508"></a><span id="l102.508">                 }</span>
<a href="#l102.509"></a><span id="l102.509">                 if (listener) {</span>
<a href="#l102.510"></a><span id="l102.510">                     listener.onResult(oprequest, data);</span>
<a href="#l102.511"></a><span id="l102.511">                 }</span>
<a href="#l102.512"></a><span id="l102.512">             },</span>
<a href="#l102.513"></a><span id="l102.513">             log(&quot;searchForCalendars, searchString=&quot; + searchString, this));</span>
<a href="#l102.514"></a><span id="l102.514" class="difflineat">@@ -888,17 +883,17 @@ calWcapSession.prototype = {</span>
<a href="#l102.515"></a><span id="l102.515">             if (maxResults &gt; 0) {</span>
<a href="#l102.516"></a><span id="l102.516">                 params += &quot;&amp;maxResults=&quot; + maxResults;</span>
<a href="#l102.517"></a><span id="l102.517">             }</span>
<a href="#l102.518"></a><span id="l102.518">             params += &quot;&amp;name=1&amp;calid=1&amp;primaryOwner=1&amp;searchOpts=&quot; +</span>
<a href="#l102.519"></a><span id="l102.519">                        (hints &amp; calICalendarSearchProvider.HINT_EXACT_MATCH ? &quot;3&quot; : &quot;0&quot;);</span>
<a href="#l102.520"></a><span id="l102.520"> </span>
<a href="#l102.521"></a><span id="l102.521">             this.issueNetworkRequest(</span>
<a href="#l102.522"></a><span id="l102.522">                 request,</span>
<a href="#l102.523"></a><span id="l102.523" class="difflineminus">-                function searchForCalendars_netResp(err, data) {</span>
<a href="#l102.524"></a><span id="l102.524" class="difflineplus">+                function(err, data) {</span>
<a href="#l102.525"></a><span id="l102.525">                     if (err) {</span>
<a href="#l102.526"></a><span id="l102.526">                         throw err;</span>
<a href="#l102.527"></a><span id="l102.527">                     }</span>
<a href="#l102.528"></a><span id="l102.528">                     // string to xml converter func without WCAP errno check:</span>
<a href="#l102.529"></a><span id="l102.529">                     if (!data || data.length == 0) { // assuming time-out</span>
<a href="#l102.530"></a><span id="l102.530">                         throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l102.531"></a><span id="l102.531">                                                        calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l102.532"></a><span id="l102.532">                     }</span>
<a href="#l102.533"></a><span id="l102.533" class="difflineat">@@ -941,26 +936,25 @@ calWcapSession.prototype = {</span>
<a href="#l102.534"></a><span id="l102.534">                 null, &quot;search_calprops&quot;, params);</span>
<a href="#l102.535"></a><span id="l102.535">         } catch (exc) {</span>
<a href="#l102.536"></a><span id="l102.536">             request.execRespFunc(exc);</span>
<a href="#l102.537"></a><span id="l102.537">         }</span>
<a href="#l102.538"></a><span id="l102.538">         return request;</span>
<a href="#l102.539"></a><span id="l102.539">     },</span>
<a href="#l102.540"></a><span id="l102.540"> </span>
<a href="#l102.541"></a><span id="l102.541">     // calIFreeBusyProvider:</span>
<a href="#l102.542"></a><span id="l102.542" class="difflineminus">-    getFreeBusyIntervals:</span>
<a href="#l102.543"></a><span id="l102.543" class="difflineminus">-    function calWcapCalendar_getFreeBusyIntervals(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l102.544"></a><span id="l102.544" class="difflineplus">+    getFreeBusyIntervals: function(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l102.545"></a><span id="l102.545">         rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l102.546"></a><span id="l102.546">         rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l102.547"></a><span id="l102.547">         let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l102.548"></a><span id="l102.548">         let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l102.549"></a><span id="l102.549"> </span>
<a href="#l102.550"></a><span id="l102.550">         let self = this;</span>
<a href="#l102.551"></a><span id="l102.551">         let request = new calWcapRequest(</span>
<a href="#l102.552"></a><span id="l102.552" class="difflineminus">-            function _resp(oprequest, err, data) {</span>
<a href="#l102.553"></a><span id="l102.553" class="difflineplus">+            function(oprequest, err, data) {</span>
<a href="#l102.554"></a><span id="l102.554">                 let rc = getResultCode(err);</span>
<a href="#l102.555"></a><span id="l102.555">                 switch (rc) {</span>
<a href="#l102.556"></a><span id="l102.556">                     case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l102.557"></a><span id="l102.557">                     case calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR:</span>
<a href="#l102.558"></a><span id="l102.558">                     case calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST:</span>
<a href="#l102.559"></a><span id="l102.559">                         log(&quot;getFreeBusyIntervals_resp() error: &quot; + errorToString(err), self);</span>
<a href="#l102.560"></a><span id="l102.560">                         break;</span>
<a href="#l102.561"></a><span id="l102.561">                     default:</span>
<a href="#l102.562"></a><span id="l102.562" class="difflineat">@@ -990,17 +984,17 @@ calWcapSession.prototype = {</span>
<a href="#l102.563"></a><span id="l102.563">             let params = &quot;&amp;calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l102.564"></a><span id="l102.564">             params += &quot;&amp;busyonly=&quot; + (busyTypes &amp; calIFreeBusyInterval.FREE ? &quot;0&quot; : &quot;1&quot;);</span>
<a href="#l102.565"></a><span id="l102.565">             params += &quot;&amp;dtstart=&quot; + zRangeStart;</span>
<a href="#l102.566"></a><span id="l102.566">             params += &quot;&amp;dtend=&quot; + zRangeEnd;</span>
<a href="#l102.567"></a><span id="l102.567">             params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l102.568"></a><span id="l102.568"> </span>
<a href="#l102.569"></a><span id="l102.569">             this.issueNetworkRequest(</span>
<a href="#l102.570"></a><span id="l102.570">                 request,</span>
<a href="#l102.571"></a><span id="l102.571" class="difflineminus">-                function net_resp(err, xml) {</span>
<a href="#l102.572"></a><span id="l102.572" class="difflineplus">+                function(err, xml) {</span>
<a href="#l102.573"></a><span id="l102.573">                     if (err) {</span>
<a href="#l102.574"></a><span id="l102.574">                         throw err;</span>
<a href="#l102.575"></a><span id="l102.575">                     }</span>
<a href="#l102.576"></a><span id="l102.576">                     if (LOG_LEVEL &gt; 0) {</span>
<a href="#l102.577"></a><span id="l102.577">                         log(&quot;getFreeBusyIntervals net_resp(): &quot; +</span>
<a href="#l102.578"></a><span id="l102.578">                             getWcapRequestStatusString(xml), self);</span>
<a href="#l102.579"></a><span id="l102.579">                     }</span>
<a href="#l102.580"></a><span id="l102.580">                     if (listener) {</span>
<a href="#l102.581"></a><span id="l102.581" class="difflineat">@@ -1034,31 +1028,31 @@ calWcapSession.prototype = {</span>
<a href="#l102.582"></a><span id="l102.582">                 stringToXml_, &quot;get_freebusy&quot;, params);</span>
<a href="#l102.583"></a><span id="l102.583">         } catch (exc) {</span>
<a href="#l102.584"></a><span id="l102.584">             request.execRespFunc(exc);</span>
<a href="#l102.585"></a><span id="l102.585">         }</span>
<a href="#l102.586"></a><span id="l102.586">         return request;</span>
<a href="#l102.587"></a><span id="l102.587">     },</span>
<a href="#l102.588"></a><span id="l102.588"> </span>
<a href="#l102.589"></a><span id="l102.589">     // nsIObserver:</span>
<a href="#l102.590"></a><span id="l102.590" class="difflineminus">-    observe: function calWcapSession_observer(subject, topic, data) {</span>
<a href="#l102.591"></a><span id="l102.591" class="difflineplus">+    observe: function(subject, topic, data) {</span>
<a href="#l102.592"></a><span id="l102.592">         log(&quot;observing: &quot; + topic + &quot;, data: &quot; + data, this);</span>
<a href="#l102.593"></a><span id="l102.593">         if (topic == &quot;quit-application&quot;) {</span>
<a href="#l102.594"></a><span id="l102.594">             g_bShutdown = true;</span>
<a href="#l102.595"></a><span id="l102.595">             this.logout(null);</span>
<a href="#l102.596"></a><span id="l102.596">             // xxx todo: valid upon notification?</span>
<a href="#l102.597"></a><span id="l102.597">             cal.getCalendarManager().removeObserver(this);</span>
<a href="#l102.598"></a><span id="l102.598">             Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l102.599"></a><span id="l102.599">         }</span>
<a href="#l102.600"></a><span id="l102.600">     },</span>
<a href="#l102.601"></a><span id="l102.601"> </span>
<a href="#l102.602"></a><span id="l102.602">     // calICalendarManagerObserver:</span>
<a href="#l102.603"></a><span id="l102.603"> </span>
<a href="#l102.604"></a><span id="l102.604">     // called after the calendar is registered</span>
<a href="#l102.605"></a><span id="l102.605" class="difflineminus">-    onCalendarRegistered: function calWcapSession_onCalendarRegistered(aCalendar) {</span>
<a href="#l102.606"></a><span id="l102.606" class="difflineplus">+    onCalendarRegistered: function(aCalendar) {</span>
<a href="#l102.607"></a><span id="l102.607">         function assureDefault(pref, val) {</span>
<a href="#l102.608"></a><span id="l102.608">             if (aCalendar.getProperty(pref) === null) {</span>
<a href="#l102.609"></a><span id="l102.609">                 aCalendar.setProperty(pref, val);</span>
<a href="#l102.610"></a><span id="l102.610">             }</span>
<a href="#l102.611"></a><span id="l102.611">         }</span>
<a href="#l102.612"></a><span id="l102.612"> </span>
<a href="#l102.613"></a><span id="l102.613">         try {</span>
<a href="#l102.614"></a><span id="l102.614">             // make sure the calendar belongs to this session:</span>
<a href="#l102.615"></a><span id="l102.615" class="difflineat">@@ -1082,17 +1076,17 @@ calWcapSession.prototype = {</span>
<a href="#l102.616"></a><span id="l102.616">                 assureDefault(&quot;color&quot;, s_colors[(new Date()).getUTCMilliseconds() % s_colors.length]);</span>
<a href="#l102.617"></a><span id="l102.617">             }</span>
<a href="#l102.618"></a><span id="l102.618">         } catch (exc) { // never break the listener chain</span>
<a href="#l102.619"></a><span id="l102.619">             this.notifyError(exc);</span>
<a href="#l102.620"></a><span id="l102.620">         }</span>
<a href="#l102.621"></a><span id="l102.621">     },</span>
<a href="#l102.622"></a><span id="l102.622"> </span>
<a href="#l102.623"></a><span id="l102.623">     // called before the unregister actually takes place</span>
<a href="#l102.624"></a><span id="l102.624" class="difflineminus">-    onCalendarUnregistering: function calWcapSession_onCalendarUnregistering(aCalendar) {</span>
<a href="#l102.625"></a><span id="l102.625" class="difflineplus">+    onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l102.626"></a><span id="l102.626">         try {</span>
<a href="#l102.627"></a><span id="l102.627">             // make sure the calendar belongs to this session and is the default calendar,</span>
<a href="#l102.628"></a><span id="l102.628">             // then remove all subscribed calendars:</span>
<a href="#l102.629"></a><span id="l102.629">             aCalendar = this.belongsTo(aCalendar);</span>
<a href="#l102.630"></a><span id="l102.630">             if (aCalendar &amp;&amp; aCalendar.isDefaultCalendar) {</span>
<a href="#l102.631"></a><span id="l102.631">                 getFreeBusyService().removeProvider(this);</span>
<a href="#l102.632"></a><span id="l102.632">                 getCalendarSearchService().removeProvider(this);</span>
<a href="#l102.633"></a><span id="l102.633">                 let registeredCalendars = this.getRegisteredCalendars();</span>
<a href="#l102.634"></a><span id="l102.634" class="difflineat">@@ -1107,17 +1101,17 @@ calWcapSession.prototype = {</span>
<a href="#l102.635"></a><span id="l102.635">                 }</span>
<a href="#l102.636"></a><span id="l102.636">             }</span>
<a href="#l102.637"></a><span id="l102.637">         } catch (exc) { // never break the listener chain</span>
<a href="#l102.638"></a><span id="l102.638">             this.notifyError(exc);</span>
<a href="#l102.639"></a><span id="l102.639">         }</span>
<a href="#l102.640"></a><span id="l102.640">     },</span>
<a href="#l102.641"></a><span id="l102.641"> </span>
<a href="#l102.642"></a><span id="l102.642">     // called before the delete actually takes place</span>
<a href="#l102.643"></a><span id="l102.643" class="difflineminus">-    onCalendarDeleting: function calWcapSession_onCalendarDeleting(aCalendar) {</span>
<a href="#l102.644"></a><span id="l102.644" class="difflineplus">+    onCalendarDeleting: function(aCalendar) {</span>
<a href="#l102.645"></a><span id="l102.645">     }</span>
<a href="#l102.646"></a><span id="l102.646"> };</span>
<a href="#l102.647"></a><span id="l102.647"> </span>
<a href="#l102.648"></a><span id="l102.648"> function confirmInsecureLogin(uri) {</span>
<a href="#l102.649"></a><span id="l102.649">     if (!confirmInsecureLogin.m_confirmedHttpLogins) {</span>
<a href="#l102.650"></a><span id="l102.650">         confirmInsecureLogin.m_confirmedHttpLogins = {};</span>
<a href="#l102.651"></a><span id="l102.651">         let confirmedHttpLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l102.652"></a><span id="l102.652">         let tuples = confirmedHttpLogins.split(&quot;,&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -53,34 +53,34 @@ function initLogging() {</span>
<a href="#l103.4"></a><span id="l103.4">             }</span>
<a href="#l103.5"></a><span id="l103.5">         }</span>
<a href="#l103.6"></a><span id="l103.6">         log(&quot;################################# NEW WCAP LOG #################################&quot;, &quot;init logging&quot;);</span>
<a href="#l103.7"></a><span id="l103.7">         logWarning(&quot;WCAP logging enabled! level=&quot; + LOG_LEVEL +</span>
<a href="#l103.8"></a><span id="l103.8">                    (initLogging.mLogFilestream ? (&quot;, file=&quot; + logFileName) : &quot;&quot;));</span>
<a href="#l103.9"></a><span id="l103.9">     }</span>
<a href="#l103.10"></a><span id="l103.10">     if (!initLogging.mLogPrefObserver) {</span>
<a href="#l103.11"></a><span id="l103.11">         initLogging.mLogPrefObserver = { // nsIObserver:</span>
<a href="#l103.12"></a><span id="l103.12" class="difflineminus">-            observe: function logPrefObserver_observe(subject, topic, data) {</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+            observe: function(subject, topic, data) {</span>
<a href="#l103.14"></a><span id="l103.14">                 if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l103.15"></a><span id="l103.15">                     switch (data) {</span>
<a href="#l103.16"></a><span id="l103.16">                         case &quot;calendar.wcap.log_level&quot;:</span>
<a href="#l103.17"></a><span id="l103.17">                         case &quot;calendar.wcap.log_file&quot;:</span>
<a href="#l103.18"></a><span id="l103.18">                         case &quot;calendar.debug.log&quot;:</span>
<a href="#l103.19"></a><span id="l103.19">                             initLogging();</span>
<a href="#l103.20"></a><span id="l103.20">                             break;</span>
<a href="#l103.21"></a><span id="l103.21">                     }</span>
<a href="#l103.22"></a><span id="l103.22">                 }</span>
<a href="#l103.23"></a><span id="l103.23">             }</span>
<a href="#l103.24"></a><span id="l103.24">         };</span>
<a href="#l103.25"></a><span id="l103.25">         Services.prefs.addObserver(&quot;calendar.wcap.log_level&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l103.26"></a><span id="l103.26">         Services.prefs.addObserver(&quot;calendar.wcap.log_file&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l103.27"></a><span id="l103.27">         Services.prefs.addObserver(&quot;calendar.debug.log&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l103.28"></a><span id="l103.28"> </span>
<a href="#l103.29"></a><span id="l103.29">         let appObserver = { // nsIObserver:</span>
<a href="#l103.30"></a><span id="l103.30" class="difflineminus">-            observe: function app_observe(subject, topic, data) {</span>
<a href="#l103.31"></a><span id="l103.31" class="difflineplus">+            observe: function(subject, topic, data) {</span>
<a href="#l103.32"></a><span id="l103.32">                 if (topic == &quot;quit-application&quot;) {</span>
<a href="#l103.33"></a><span id="l103.33">                     Services.prefs.removeObserver(&quot;calendar.&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l103.34"></a><span id="l103.34">                 }</span>
<a href="#l103.35"></a><span id="l103.35">             }</span>
<a href="#l103.36"></a><span id="l103.36">         };</span>
<a href="#l103.37"></a><span id="l103.37">         Services.obs.addObserver(appObserver, &quot;quit-application&quot;, false);</span>
<a href="#l103.38"></a><span id="l103.38">     }</span>
<a href="#l103.39"></a><span id="l103.39"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/calendar/test/unit/.eslintrc</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/calendar/test/unit/.eslintrc</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -9,10 +9,13 @@</span>
<a href="#l104.4"></a><span id="l104.4">     // and variables defined in head.js files, without having to maintain a</span>
<a href="#l104.5"></a><span id="l104.5">     // list of globals in each .eslintrc file.</span>
<a href="#l104.6"></a><span id="l104.6">     // Note that bug 1168340 will eventually help auto-registering globals</span>
<a href="#l104.7"></a><span id="l104.7">     // from head.js files.</span>
<a href="#l104.8"></a><span id="l104.8">     &quot;no-undef&quot;: 0,</span>
<a href="#l104.9"></a><span id="l104.9">     &quot;block-scoped-var&quot;: 0,</span>
<a href="#l104.10"></a><span id="l104.10">     // Allow run_test to be unused in xpcshell</span>
<a href="#l104.11"></a><span id="l104.11">     &quot;no-unused-vars&quot;: [2, { &quot;vars&quot;: &quot;all&quot;, &quot;args&quot;: &quot;none&quot;, &quot;varsIgnorePattern&quot;: &quot;run_test&quot; }],</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineplus">+</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+    // Allow function names, because they are useful for add_test/add_task</span>
<a href="#l104.14"></a><span id="l104.14" class="difflineplus">+    &quot;func-names&quot;: 0,</span>
<a href="#l104.15"></a><span id="l104.15">   }</span>
<a href="#l104.16"></a><span id="l104.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -12,17 +12,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l105.4"></a><span id="l105.4"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l105.5"></a><span id="l105.5"> Components.utils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l105.6"></a><span id="l105.6"> </span>
<a href="#l105.7"></a><span id="l105.7"> Components.utils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l105.8"></a><span id="l105.8"> updateAppInfo();</span>
<a href="#l105.9"></a><span id="l105.9"> </span>
<a href="#l105.10"></a><span id="l105.10"> var { classes: Cc, interfaces: Ci, results: Cr, utils: Cu } = Components;</span>
<a href="#l105.11"></a><span id="l105.11"> </span>
<a href="#l105.12"></a><span id="l105.12" class="difflineminus">-(function load_lightning_manifest() {</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+(function() {</span>
<a href="#l105.14"></a><span id="l105.14">   let bindir = Services.dirsvc.get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l105.15"></a><span id="l105.15">   bindir.append(&quot;extensions&quot;);</span>
<a href="#l105.16"></a><span id="l105.16">   bindir.append(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;);</span>
<a href="#l105.17"></a><span id="l105.17">   bindir.append(&quot;chrome.manifest&quot;);</span>
<a href="#l105.18"></a><span id="l105.18">   dump(&quot;Loading&quot; + bindir.path + &quot;\n&quot;);</span>
<a href="#l105.19"></a><span id="l105.19">   Components.manager.autoRegister(bindir);</span>
<a href="#l105.20"></a><span id="l105.20"> })();</span>
<a href="#l105.21"></a><span id="l105.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/calendar/test/unit/test_alarmservice.js</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmservice.js</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -12,101 +12,101 @@ var EXPECT_TIMER = 2;</span>
<a href="#l106.4"></a><span id="l106.4"> function do_check_xor(a, b) { return ok((a &amp;&amp; !b) || (!a &amp;&amp; b)); }</span>
<a href="#l106.5"></a><span id="l106.5"> </span>
<a href="#l106.6"></a><span id="l106.6"> var alarmObserver = {</span>
<a href="#l106.7"></a><span id="l106.7">     service: null,</span>
<a href="#l106.8"></a><span id="l106.8">     firedMap: {},</span>
<a href="#l106.9"></a><span id="l106.9">     expectedMap: {},</span>
<a href="#l106.10"></a><span id="l106.10">     pendingOps: {},</span>
<a href="#l106.11"></a><span id="l106.11"> </span>
<a href="#l106.12"></a><span id="l106.12" class="difflineminus">-    onAlarm: function obs_onAlarm(aItem, aAlarm) {</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+    onAlarm: function(aItem, aAlarm) {</span>
<a href="#l106.14"></a><span id="l106.14">         this.firedMap[aItem.hashId] = this.firedMap[aItem.hashId] || {};</span>
<a href="#l106.15"></a><span id="l106.15">         this.firedMap[aItem.hashId][aAlarm.icalString] = true;</span>
<a href="#l106.16"></a><span id="l106.16">     },</span>
<a href="#l106.17"></a><span id="l106.17"> </span>
<a href="#l106.18"></a><span id="l106.18" class="difflineminus">-    onRemoveAlarmsByItem: function obs_onRemoveAlarmsByItem(aItem) {</span>
<a href="#l106.19"></a><span id="l106.19" class="difflineplus">+    onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l106.20"></a><span id="l106.20">         if (aItem.hashId in this.firedMap) {</span>
<a href="#l106.21"></a><span id="l106.21">             delete this.firedMap[aItem.hashId];</span>
<a href="#l106.22"></a><span id="l106.22">         }</span>
<a href="#l106.23"></a><span id="l106.23">     },</span>
<a href="#l106.24"></a><span id="l106.24"> </span>
<a href="#l106.25"></a><span id="l106.25">     onRemoveAlarmsByCalendar: function() {},</span>
<a href="#l106.26"></a><span id="l106.26"> </span>
<a href="#l106.27"></a><span id="l106.27" class="difflineminus">-    onAlarmsLoaded: function obs_onAlarmsLoaded(aCalendar) {</span>
<a href="#l106.28"></a><span id="l106.28" class="difflineplus">+    onAlarmsLoaded: function(aCalendar) {</span>
<a href="#l106.29"></a><span id="l106.29">         this.checkLoadStatus();</span>
<a href="#l106.30"></a><span id="l106.30">         if (aCalendar.id in this.pendingOps) {</span>
<a href="#l106.31"></a><span id="l106.31">             this.pendingOps[aCalendar.id].call();</span>
<a href="#l106.32"></a><span id="l106.32">         }</span>
<a href="#l106.33"></a><span id="l106.33">     },</span>
<a href="#l106.34"></a><span id="l106.34"> </span>
<a href="#l106.35"></a><span id="l106.35" class="difflineminus">-    doOnAlarmsLoaded: function obs_doOnAlarmsLoaded(aCalendar, aOperation) {</span>
<a href="#l106.36"></a><span id="l106.36" class="difflineplus">+    doOnAlarmsLoaded: function(aCalendar, aOperation) {</span>
<a href="#l106.37"></a><span id="l106.37">         this.checkLoadStatus();</span>
<a href="#l106.38"></a><span id="l106.38">         if (aCalendar.id in this.service.mLoadedCalendars &amp;&amp;</span>
<a href="#l106.39"></a><span id="l106.39">             this.service.mLoadedCalendars[aCalendar.id]) {</span>
<a href="#l106.40"></a><span id="l106.40">             // the calendar's alarms have already been loaded, do the callback now</span>
<a href="#l106.41"></a><span id="l106.41">             aOperation.call();</span>
<a href="#l106.42"></a><span id="l106.42">         } else {</span>
<a href="#l106.43"></a><span id="l106.43">             // the calendar hasn't been fully loaded yet, set as a pending operation</span>
<a href="#l106.44"></a><span id="l106.44">             this.pendingOps[aCalendar.id] = aOperation;</span>
<a href="#l106.45"></a><span id="l106.45">         }</span>
<a href="#l106.46"></a><span id="l106.46">     },</span>
<a href="#l106.47"></a><span id="l106.47"> </span>
<a href="#l106.48"></a><span id="l106.48" class="difflineminus">-    getTimer: function obs_getTimer(aCalendarId, aItemId, aAlarmStr) {</span>
<a href="#l106.49"></a><span id="l106.49" class="difflineplus">+    getTimer: function(aCalendarId, aItemId, aAlarmStr) {</span>
<a href="#l106.50"></a><span id="l106.50">         return aCalendarId in this.service.mTimerMap &amp;&amp;</span>
<a href="#l106.51"></a><span id="l106.51">                aItemId in this.service.mTimerMap[aCalendarId] &amp;&amp;</span>
<a href="#l106.52"></a><span id="l106.52">                aAlarmStr in this.service.mTimerMap[aCalendarId][aItemId] ?</span>
<a href="#l106.53"></a><span id="l106.53">                this.service.mTimerMap[aCalendarId][aItemId][aAlarmStr] : null;</span>
<a href="#l106.54"></a><span id="l106.54">     },</span>
<a href="#l106.55"></a><span id="l106.55"> </span>
<a href="#l106.56"></a><span id="l106.56" class="difflineminus">-    expectResult: function obs_expectResult(aCalendar, aItem, aAlarm, aExpected) {</span>
<a href="#l106.57"></a><span id="l106.57" class="difflineplus">+    expectResult: function(aCalendar, aItem, aAlarm, aExpected) {</span>
<a href="#l106.58"></a><span id="l106.58">         this.expectedMap[aCalendar.id] = this.expectedMap[aCalendar.id] || {};</span>
<a href="#l106.59"></a><span id="l106.59">         this.expectedMap[aCalendar.id][aItem.hashId] = this.expectedMap[aCalendar.id][aItem.hashId] || {};</span>
<a href="#l106.60"></a><span id="l106.60">         this.expectedMap[aCalendar.id][aItem.hashId][aAlarm.icalString] = aExpected;</span>
<a href="#l106.61"></a><span id="l106.61">     },</span>
<a href="#l106.62"></a><span id="l106.62"> </span>
<a href="#l106.63"></a><span id="l106.63" class="difflineminus">-    expectOccurrences: function obs_expectOccurrences(aCalendar, aItem, aAlarm, aExpectedArray) {</span>
<a href="#l106.64"></a><span id="l106.64" class="difflineplus">+    expectOccurrences: function(aCalendar, aItem, aAlarm, aExpectedArray) {</span>
<a href="#l106.65"></a><span id="l106.65">         // we need to be earlier than the first occurrence</span>
<a href="#l106.66"></a><span id="l106.66">         let dt = aItem.startDate.clone();</span>
<a href="#l106.67"></a><span id="l106.67">         dt.second -= 1;</span>
<a href="#l106.68"></a><span id="l106.68"> </span>
<a href="#l106.69"></a><span id="l106.69">         for (let expected of aExpectedArray) {</span>
<a href="#l106.70"></a><span id="l106.70">             let occ = aItem.recurrenceInfo.getNextOccurrence(dt);</span>
<a href="#l106.71"></a><span id="l106.71">             dt = occ.startDate;</span>
<a href="#l106.72"></a><span id="l106.72">             this.expectResult(aCalendar, occ, aAlarm, expected);</span>
<a href="#l106.73"></a><span id="l106.73">         }</span>
<a href="#l106.74"></a><span id="l106.74">     },</span>
<a href="#l106.75"></a><span id="l106.75"> </span>
<a href="#l106.76"></a><span id="l106.76" class="difflineminus">-    checkExpected: function obs_checkExpected() {</span>
<a href="#l106.77"></a><span id="l106.77" class="difflineplus">+    checkExpected: function() {</span>
<a href="#l106.78"></a><span id="l106.78">         for (let calId in this.expectedMap) {</span>
<a href="#l106.79"></a><span id="l106.79">             for (let id in this.expectedMap[calId]) {</span>
<a href="#l106.80"></a><span id="l106.80">                 for (let icalString in this.expectedMap[calId][id]) {</span>
<a href="#l106.81"></a><span id="l106.81">                     // only alarms expected as fired should exist in our fired alarm map</span>
<a href="#l106.82"></a><span id="l106.82">                     do_check_xor(this.expectedMap[calId][id][icalString] != EXPECT_FIRED,</span>
<a href="#l106.83"></a><span id="l106.83">                                  (id in this.firedMap) &amp;&amp;</span>
<a href="#l106.84"></a><span id="l106.84">                                  (icalString in this.firedMap[id]));</span>
<a href="#l106.85"></a><span id="l106.85">                     // only alarms expected as timers should exist in the service's timer map</span>
<a href="#l106.86"></a><span id="l106.86">                     do_check_xor(this.expectedMap[calId][id][icalString] != EXPECT_TIMER,</span>
<a href="#l106.87"></a><span id="l106.87">                                  !!this.getTimer(calId, id, icalString));</span>
<a href="#l106.88"></a><span id="l106.88">                 }</span>
<a href="#l106.89"></a><span id="l106.89">             }</span>
<a href="#l106.90"></a><span id="l106.90">         }</span>
<a href="#l106.91"></a><span id="l106.91">     },</span>
<a href="#l106.92"></a><span id="l106.92"> </span>
<a href="#l106.93"></a><span id="l106.93" class="difflineminus">-    checkLoadStatus: function obs_checkLoadStatus() {</span>
<a href="#l106.94"></a><span id="l106.94" class="difflineplus">+    checkLoadStatus: function() {</span>
<a href="#l106.95"></a><span id="l106.95">         for (let calId in this.service.mLoadedCalendars) {</span>
<a href="#l106.96"></a><span id="l106.96">             if (!this.service.mLoadedCalendars[calId]) {</span>
<a href="#l106.97"></a><span id="l106.97">                 // at least one calendar hasn't finished loading alarms</span>
<a href="#l106.98"></a><span id="l106.98">                 ok(this.service.isLoading);</span>
<a href="#l106.99"></a><span id="l106.99">                 return;</span>
<a href="#l106.100"></a><span id="l106.100">             }</span>
<a href="#l106.101"></a><span id="l106.101">         }</span>
<a href="#l106.102"></a><span id="l106.102">         ok(!this.service.isLoading);</span>
<a href="#l106.103"></a><span id="l106.103">     },</span>
<a href="#l106.104"></a><span id="l106.104"> </span>
<a href="#l106.105"></a><span id="l106.105" class="difflineminus">-    clear: function obs_clear() {</span>
<a href="#l106.106"></a><span id="l106.106" class="difflineplus">+    clear: function() {</span>
<a href="#l106.107"></a><span id="l106.107">         this.firedMap = {};</span>
<a href="#l106.108"></a><span id="l106.108">         this.pendingOps = {};</span>
<a href="#l106.109"></a><span id="l106.109">         this.expectedMap = {};</span>
<a href="#l106.110"></a><span id="l106.110">     }</span>
<a href="#l106.111"></a><span id="l106.111"> };</span>
<a href="#l106.112"></a><span id="l106.112"> </span>
<a href="#l106.113"></a><span id="l106.113"> function run_test() {</span>
<a href="#l106.114"></a><span id="l106.114">     do_get_profile();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/calendar/test/unit/test_bug494140.js</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/calendar/test/unit/test_bug494140.js</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -42,17 +42,17 @@ function run_test() {</span>
<a href="#l107.4"></a><span id="l107.4">     equal(item.getAlarms({}).length, 1);</span>
<a href="#l107.5"></a><span id="l107.5">     equal(item.getRelations({}).length, 1);</span>
<a href="#l107.6"></a><span id="l107.6">     equal(item.getAttachments({}).length, 1);</span>
<a href="#l107.7"></a><span id="l107.7"> </span>
<a href="#l107.8"></a><span id="l107.8">     // Add the item to the storage calendar and retrieve it again</span>
<a href="#l107.9"></a><span id="l107.9">     storageCal.adoptItem(item, null);</span>
<a href="#l107.10"></a><span id="l107.10">     let retrievedItem;</span>
<a href="#l107.11"></a><span id="l107.11">     storageCal.getItem(&quot;c1a6cfe7-7fbb-4bfb-a00d-861e07c649a5&quot;, {</span>
<a href="#l107.12"></a><span id="l107.12" class="difflineminus">-        onGetResult: function onGetResult(cal, stat, type, detail, count, items) {</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+        onGetResult: function(cal, stat, type, detail, count, items) {</span>
<a href="#l107.14"></a><span id="l107.14">             retrievedItem = items[0];</span>
<a href="#l107.15"></a><span id="l107.15">         },</span>
<a href="#l107.16"></a><span id="l107.16">         onOperationComplete: function() {}</span>
<a href="#l107.17"></a><span id="l107.17">     });</span>
<a href="#l107.18"></a><span id="l107.18"> </span>
<a href="#l107.19"></a><span id="l107.19">     // There should still be one alarm, one relation and one attachment</span>
<a href="#l107.20"></a><span id="l107.20">     equal(retrievedItem.getAlarms({}).length, 1);</span>
<a href="#l107.21"></a><span id="l107.21">     equal(retrievedItem.getRelations({}).length, 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/calendar/test/unit/test_calmgr.js</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/calendar/test/unit/test_calmgr.js</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -33,34 +33,34 @@ add_test(function test_registration() {</span>
<a href="#l108.4"></a><span id="l108.4"> </span>
<a href="#l108.5"></a><span id="l108.5">     // Create a local memory calendar, ths shouldn't register any calendars</span>
<a href="#l108.6"></a><span id="l108.6">     let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;, null, null));</span>
<a href="#l108.7"></a><span id="l108.7">     checkCalendarCount(0, 0, 0);</span>
<a href="#l108.8"></a><span id="l108.8"> </span>
<a href="#l108.9"></a><span id="l108.9">     // Register an observer to test it.</span>
<a href="#l108.10"></a><span id="l108.10">     let registered = false, unregistered = false, deleted = false, readOnly = false;</span>
<a href="#l108.11"></a><span id="l108.11">     let mgrobs = cal.createAdapter(Components.interfaces.calICalendarManagerObserver, {</span>
<a href="#l108.12"></a><span id="l108.12" class="difflineminus">-        onCalendarRegistered: function onCalendarRegistered(aCalendar) {</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+        onCalendarRegistered: function(aCalendar) {</span>
<a href="#l108.14"></a><span id="l108.14">             if (aCalendar.id == memory.id) {</span>
<a href="#l108.15"></a><span id="l108.15">               registered = true;</span>
<a href="#l108.16"></a><span id="l108.16">             }</span>
<a href="#l108.17"></a><span id="l108.17">         },</span>
<a href="#l108.18"></a><span id="l108.18" class="difflineminus">-        onCalendarUnregistering: function onCalendarUnregistering(aCalendar) {</span>
<a href="#l108.19"></a><span id="l108.19" class="difflineplus">+        onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l108.20"></a><span id="l108.20">             if (aCalendar.id == memory.id) {</span>
<a href="#l108.21"></a><span id="l108.21">               unregistered = true;</span>
<a href="#l108.22"></a><span id="l108.22">             }</span>
<a href="#l108.23"></a><span id="l108.23">         },</span>
<a href="#l108.24"></a><span id="l108.24" class="difflineminus">-        onCalendarDeleting: function onCalendarDeleting(aCalendar) {</span>
<a href="#l108.25"></a><span id="l108.25" class="difflineplus">+        onCalendarDeleting: function(aCalendar) {</span>
<a href="#l108.26"></a><span id="l108.26">             if (aCalendar.id == memory.id) {</span>
<a href="#l108.27"></a><span id="l108.27">               deleted = true;</span>
<a href="#l108.28"></a><span id="l108.28">             }</span>
<a href="#l108.29"></a><span id="l108.29">         }</span>
<a href="#l108.30"></a><span id="l108.30">     });</span>
<a href="#l108.31"></a><span id="l108.31">     let calobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l108.32"></a><span id="l108.32" class="difflineminus">-        onPropertyChanged: function onPropertyChanging(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l108.33"></a><span id="l108.33" class="difflineplus">+        onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l108.34"></a><span id="l108.34">             equal(aCalendar.id, memory.id);</span>
<a href="#l108.35"></a><span id="l108.35">             equal(aName, &quot;readOnly&quot;);</span>
<a href="#l108.36"></a><span id="l108.36">             readOnly = aValue;</span>
<a href="#l108.37"></a><span id="l108.37">         }</span>
<a href="#l108.38"></a><span id="l108.38">     });</span>
<a href="#l108.39"></a><span id="l108.39">     memory.addObserver(calobs);</span>
<a href="#l108.40"></a><span id="l108.40">     calmgr.addObserver(mgrobs);</span>
<a href="#l108.41"></a><span id="l108.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/calendar/test/unit/test_deleted_items.js</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/calendar/test/unit/test_deleted_items.js</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -49,17 +49,17 @@ add_task(function* test_deleted_items() </span>
<a href="#l109.4"></a><span id="l109.4">     equal(delmgr.getDeletedDate(item.id), null);</span>
<a href="#l109.5"></a><span id="l109.5">     equal(delmgr.getDeletedDate(item.id, memory.id), null);</span>
<a href="#l109.6"></a><span id="l109.6"> </span>
<a href="#l109.7"></a><span id="l109.7">     // We need to stop time so we have something to compare with.</span>
<a href="#l109.8"></a><span id="l109.8">     let referenceDate = cal.createDateTime(&quot;20120726T112045&quot;); referenceDate.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l109.9"></a><span id="l109.9">     let futureDate = cal.createDateTime(&quot;20380101T000000&quot;); futureDate.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l109.10"></a><span id="l109.10">     let useFutureDate = false;</span>
<a href="#l109.11"></a><span id="l109.11">     let oldNowFunction = cal.now;</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineminus">-    cal.now = function test_specific_now() {</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+    cal.now = function() {</span>
<a href="#l109.14"></a><span id="l109.14">         return (useFutureDate ? futureDate : referenceDate).clone();</span>
<a href="#l109.15"></a><span id="l109.15">     };</span>
<a href="#l109.16"></a><span id="l109.16"> </span>
<a href="#l109.17"></a><span id="l109.17">     // Deleting an item should trigger it being marked for deletion.</span>
<a href="#l109.18"></a><span id="l109.18">     yield check_delmgr_call(() =&gt; memory.deleteItem(item, null));</span>
<a href="#l109.19"></a><span id="l109.19"> </span>
<a href="#l109.20"></a><span id="l109.20">     // Now check if it was deleted at our reference date.</span>
<a href="#l109.21"></a><span id="l109.21">     let deltime = delmgr.getDeletedDate(item.id);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l110.4"></a><span id="l110.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l110.5"></a><span id="l110.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l110.6"></a><span id="l110.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l110.7"></a><span id="l110.7"> </span>
<a href="#l110.8"></a><span id="l110.8" class="difflineminus">-(function load_gdata_manifest() {</span>
<a href="#l110.9"></a><span id="l110.9" class="difflineplus">+(function() {</span>
<a href="#l110.10"></a><span id="l110.10">   Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l110.11"></a><span id="l110.11">   Services.prefs.setBoolPref(&quot;javascript.options.showInConsole&quot;, true);</span>
<a href="#l110.12"></a><span id="l110.12">   Services.prefs.setBoolPref(&quot;browser.dom.window.dump.enabled&quot;, true);</span>
<a href="#l110.13"></a><span id="l110.13">   Services.prefs.setBoolPref(&quot;calendar.debug.log&quot;, true);</span>
<a href="#l110.14"></a><span id="l110.14">   Services.prefs.setBoolPref(&quot;calendar.debug.log.verbose&quot;, true);</span>
<a href="#l110.15"></a><span id="l110.15"> </span>
<a href="#l110.16"></a><span id="l110.16">   let bindir = Services.dirsvc.get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l110.17"></a><span id="l110.17">   bindir.append(&quot;extensions&quot;);</span>
<a href="#l110.18"></a><span id="l110.18" class="difflineat">@@ -59,17 +59,17 @@ MockAlertsService.prototype = {</span>
<a href="#l110.19"></a><span id="l110.19">         Ci.nsISupports,</span>
<a href="#l110.20"></a><span id="l110.20">         Ci.nsIAlertsService</span>
<a href="#l110.21"></a><span id="l110.21">     ])</span>
<a href="#l110.22"></a><span id="l110.22"> };</span>
<a href="#l110.23"></a><span id="l110.23"> </span>
<a href="#l110.24"></a><span id="l110.24"> function replaceAlertsService() {</span>
<a href="#l110.25"></a><span id="l110.25">     let originalAlertsServiceCID =</span>
<a href="#l110.26"></a><span id="l110.26">         MockRegistrar.register(&quot;@mozilla.org/alerts-service;1&quot;, MockAlertsService);</span>
<a href="#l110.27"></a><span id="l110.27" class="difflineminus">-    do_register_cleanup(function restoreAlertsService() {</span>
<a href="#l110.28"></a><span id="l110.28" class="difflineplus">+    do_register_cleanup(() =&gt; {</span>
<a href="#l110.29"></a><span id="l110.29">         MockRegistrar.unregister(originalAlertsServiceCID);</span>
<a href="#l110.30"></a><span id="l110.30">     });</span>
<a href="#l110.31"></a><span id="l110.31"> }</span>
<a href="#l110.32"></a><span id="l110.32"> </span>
<a href="#l110.33"></a><span id="l110.33"> function GDataServer(calendarId, tasksId) {</span>
<a href="#l110.34"></a><span id="l110.34">     this.server = new HttpServer();</span>
<a href="#l110.35"></a><span id="l110.35">     this.calendarId = calendarId;</span>
<a href="#l110.36"></a><span id="l110.36">     this.tasksId = tasksId;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/calendar/test/unit/test_ics.js</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/calendar/test/unit/test_ics.js</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -123,17 +123,17 @@ function test_roundtrip() {</span>
<a href="#l111.4"></a><span id="l111.4">         checkEvent(data, event);</span>
<a href="#l111.5"></a><span id="l111.5"> </span>
<a href="#l111.6"></a><span id="l111.6">         // Now, try the same thing with asynchronous parsing. We need a copy of</span>
<a href="#l111.7"></a><span id="l111.7">         // the data variable, otherwise javascript will mix the data between</span>
<a href="#l111.8"></a><span id="l111.8">         // foreach loop iterations.</span>
<a href="#l111.9"></a><span id="l111.9">         do_test_pending();</span>
<a href="#l111.10"></a><span id="l111.10">         let thisdata = data;</span>
<a href="#l111.11"></a><span id="l111.11">         icssrv.parseICSAsync(data.ics, null, {</span>
<a href="#l111.12"></a><span id="l111.12" class="difflineminus">-            onParsingComplete: function onParsingComplete(rc, rootComp) {</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineplus">+            onParsingComplete: function(rc, rootComp) {</span>
<a href="#l111.14"></a><span id="l111.14">                 try {</span>
<a href="#l111.15"></a><span id="l111.15">                     ok(Components.isSuccessCode(rc));</span>
<a href="#l111.16"></a><span id="l111.16">                     let event2 = cal.createEvent();</span>
<a href="#l111.17"></a><span id="l111.17">                     event2.icalComponent = rootComp;</span>
<a href="#l111.18"></a><span id="l111.18">                     checkEvent(thisdata, event2);</span>
<a href="#l111.19"></a><span id="l111.19">                     do_test_finished();</span>
<a href="#l111.20"></a><span id="l111.20">                 } catch (e) {</span>
<a href="#l111.21"></a><span id="l111.21">                     do_throw(e + &quot;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/calendar/test/unit/test_storage.js</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/calendar/test/unit/test_storage.js</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -18,17 +18,17 @@ function testAttachRoundtrip() {</span>
<a href="#l112.4"></a><span id="l112.4">                &quot;RDATE:20120201T010101Z&quot;,</span>
<a href="#l112.5"></a><span id="l112.5">                &quot;EXDATE:20120301T010101Z&quot;,</span>
<a href="#l112.6"></a><span id="l112.6">                &quot;END:VEVENT&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l112.7"></a><span id="l112.7"> </span>
<a href="#l112.8"></a><span id="l112.8">     let storageItem = createEventFromIcalString(str);</span>
<a href="#l112.9"></a><span id="l112.9"> </span>
<a href="#l112.10"></a><span id="l112.10">     do_test_pending();</span>
<a href="#l112.11"></a><span id="l112.11">     storage.addItem(storageItem, {</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineminus">-        onOperationComplete: function checkAddedItem(c, s, o, i, addedItem) {</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineplus">+        onOperationComplete: function(c, s, o, i, addedItem) {</span>
<a href="#l112.14"></a><span id="l112.14">             do_execute_soon(function() {</span>
<a href="#l112.15"></a><span id="l112.15">                 // Make sure the cache is cleared, otherwise we'll get the cached item.</span>
<a href="#l112.16"></a><span id="l112.16">                 delete storage.wrappedJSObject.mItemCache[addedItem.id];</span>
<a href="#l112.17"></a><span id="l112.17">                 storage.getItem(addedItem.id, retrieveItem);</span>
<a href="#l112.18"></a><span id="l112.18">             });</span>
<a href="#l112.19"></a><span id="l112.19">         }</span>
<a href="#l112.20"></a><span id="l112.20">     });</span>
<a href="#l112.21"></a><span id="l112.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

