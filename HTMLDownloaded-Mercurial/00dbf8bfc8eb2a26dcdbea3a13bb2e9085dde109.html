<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26586:00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109" />
<meta property="og:url" content="/comm-central/rev/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/util. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">shortlog</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">files</a> |
changeset |
<a href="/comm-central/raw-rev/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">raw</a>  | <a href="/comm-central/archive/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/util. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 13 May 2019 00:23:57 +0200</td></tr>

<tr>
 <td>changeset 26586</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109</a></td>
</tr>



<tr>
<td>parent 26585</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b38b8ba2148b535c76ad39ad57373e734123d198">b38b8ba2148b535c76ad39ad57373e734123d198</a>
</td>
</tr>

<tr>
<td>child 26587</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/973cbf59e0bc89dbb150cd662389904c8bbdbfce">973cbf59e0bc89dbb150cd662389904c8bbdbfce</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">15902</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 May 2019 22:30:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@00dbf8bfc8eb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109&newProject=comm-central&newRevision=1596eb55471a58c3d9b550d80d5186fee15af2a6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109&newProject=comm-central&newRevision=1596eb55471a58c3d9b550d80d5186fee15af2a6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109&newProject=comm-central&newRevision=1596eb55471a58c3d9b550d80d5186fee15af2a6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/util. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/ServiceList.h">mailnews/base/util/ServiceList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/ServiceList.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/ServiceList.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/ServiceList.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/ServiceList.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/ServiceList.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.cpp">mailnews/base/util/Services.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.h">mailnews/base/util/Services.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/Services.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.cpp">mailnews/base/util/nsImapMoveCoalescer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.h">mailnews/base/util/nsImapMoveCoalescer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsImapMoveCoalescer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.cpp">mailnews/base/util/nsMsgCompressIStream.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.h">mailnews/base/util/nsMsgCompressIStream.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressIStream.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.cpp">mailnews/base/util/nsMsgCompressOStream.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.h">mailnews/base/util/nsMsgCompressOStream.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgCompressOStream.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.cpp">mailnews/base/util/nsMsgFileStream.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.h">mailnews/base/util/nsMsgFileStream.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgFileStream.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.cpp">mailnews/base/util/nsMsgI18N.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.h">mailnews/base/util/nsMsgI18N.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgI18N.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.cpp">mailnews/base/util/nsMsgIdentity.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.h">mailnews/base/util/nsMsgIdentity.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIdentity.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.h">mailnews/base/util/nsMsgIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.cpp">mailnews/base/util/nsMsgKeyArray.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.h">mailnews/base/util/nsMsgKeyArray.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeyArray.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.cpp">mailnews/base/util/nsMsgKeySet.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.h">mailnews/base/util/nsMsgKeySet.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgKeySet.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.cpp">mailnews/base/util/nsMsgLineBuffer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.h">mailnews/base/util/nsMsgLineBuffer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgLineBuffer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.h">mailnews/base/util/nsMsgMailNewsUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgMailNewsUrl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.h">mailnews/base/util/nsMsgProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.cpp">mailnews/base/util/nsMsgReadStateTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.h">mailnews/base/util/nsMsgReadStateTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgReadStateTxn.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.cpp">mailnews/base/util/nsMsgTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.h">mailnews/base/util/nsMsgTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgTxn.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.h">mailnews/base/util/nsMsgUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsMsgUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.cpp">mailnews/base/util/nsStopwatch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.cpp">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.cpp">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.cpp">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.cpp">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.h">mailnews/base/util/nsStopwatch.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.h">file</a> |
<a href="/comm-central/annotate/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.h">annotate</a> |
<a href="/comm-central/diff/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.h">diff</a> |
<a href="/comm-central/comparison/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.h">comparison</a> |
<a href="/comm-central/log/00dbf8bfc8eb2a26dcdbea3a13bb2e9085dde109/mailnews/base/util/nsStopwatch.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/util/ServiceList.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/util/ServiceList.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,40 +1,34 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> // IWYU pragma: private, include &quot;mozilla/mailnews/Services.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-MOZ_SERVICE(AbManager,         nsIAbManager,</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-            &quot;@mozilla.org/abmanager;1&quot;)</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-MOZ_SERVICE(AccountManager,    nsIMsgAccountManager,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+MOZ_SERVICE(AbManager, nsIAbManager, &quot;@mozilla.org/abmanager;1&quot;)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+MOZ_SERVICE(AccountManager, nsIMsgAccountManager,</span>
<a href="#l1.15"></a><span id="l1.15">             &quot;@mozilla.org/messenger/account-manager;1&quot;)</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-MOZ_SERVICE(ComposeService,    nsIMsgComposeService,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+MOZ_SERVICE(ComposeService, nsIMsgComposeService,</span>
<a href="#l1.18"></a><span id="l1.18">             &quot;@mozilla.org/messengercompose;1&quot;)</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-MOZ_SERVICE(CopyService,       nsIMsgCopyService,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+MOZ_SERVICE(CopyService, nsIMsgCopyService,</span>
<a href="#l1.21"></a><span id="l1.21">             &quot;@mozilla.org/messenger/messagecopyservice;1&quot;)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-MOZ_SERVICE(DBService,         nsIMsgDBService,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+MOZ_SERVICE(DBService, nsIMsgDBService,</span>
<a href="#l1.24"></a><span id="l1.24">             &quot;@mozilla.org/msgDatabase/msgDBService;1&quot;)</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-MOZ_SERVICE(FilterService,     nsIMsgFilterService,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+MOZ_SERVICE(FilterService, nsIMsgFilterService,</span>
<a href="#l1.27"></a><span id="l1.27">             &quot;@mozilla.org/messenger/services/filters;1&quot;)</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-MOZ_SERVICE(HeaderParser,      nsIMsgHeaderParser,</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+MOZ_SERVICE(HeaderParser, nsIMsgHeaderParser,</span>
<a href="#l1.30"></a><span id="l1.30">             &quot;@mozilla.org/messenger/headerparser;1&quot;)</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-MOZ_SERVICE(ImapService,       nsIImapService,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-            &quot;@mozilla.org/messenger/imapservice;1&quot;)</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-MOZ_SERVICE(ImportService,     nsIImportService,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+MOZ_SERVICE(ImapService, nsIImapService, &quot;@mozilla.org/messenger/imapservice;1&quot;)</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+MOZ_SERVICE(ImportService, nsIImportService,</span>
<a href="#l1.36"></a><span id="l1.36">             &quot;@mozilla.org/import/import-service;1&quot;)</span>
<a href="#l1.37"></a><span id="l1.37"> MOZ_SERVICE(MailNotifyService, mozINewMailNotificationService,</span>
<a href="#l1.38"></a><span id="l1.38">             &quot;@mozilla.org/newMailNotificationService;1&quot;)</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-MOZ_SERVICE(MailSession,       nsIMsgMailSession,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+MOZ_SERVICE(MailSession, nsIMsgMailSession,</span>
<a href="#l1.41"></a><span id="l1.41">             &quot;@mozilla.org/messenger/services/session;1&quot;)</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-MOZ_SERVICE(MimeConverter,     nsIMimeConverter,</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+MOZ_SERVICE(MimeConverter, nsIMimeConverter,</span>
<a href="#l1.44"></a><span id="l1.44">             &quot;@mozilla.org/messenger/mimeconverter;1&quot;)</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-MOZ_SERVICE(MFNService,        nsIMsgFolderNotificationService,</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+MOZ_SERVICE(MFNService, nsIMsgFolderNotificationService,</span>
<a href="#l1.47"></a><span id="l1.47">             &quot;@mozilla.org/messenger/msgnotificationservice;1&quot;)</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-MOZ_SERVICE(NntpService,       nsINntpService,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-            &quot;@mozilla.org/messenger/nntpservice;1&quot;)</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-MOZ_SERVICE(Pop3Service,       nsIPop3Service,</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-            &quot;@mozilla.org/messenger/popservice;1&quot;)</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-MOZ_SERVICE(SmtpService,       nsISmtpService,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-            &quot;@mozilla.org/messengercompose/smtp;1&quot;)</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-MOZ_SERVICE(TagService,        nsIMsgTagService,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-            &quot;@mozilla.org/messenger/tagservice;1&quot;)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+MOZ_SERVICE(NntpService, nsINntpService, &quot;@mozilla.org/messenger/nntpservice;1&quot;)</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+MOZ_SERVICE(Pop3Service, nsIPop3Service, &quot;@mozilla.org/messenger/popservice;1&quot;)</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+MOZ_SERVICE(SmtpService, nsISmtpService, &quot;@mozilla.org/messengercompose/smtp;1&quot;)</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+MOZ_SERVICE(TagService, nsIMsgTagService, &quot;@mozilla.org/messenger/tagservice;1&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/Services.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/Services.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -27,78 +27,72 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIPop3Service.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsISmtpService.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> namespace mozilla {</span>
<a href="#l2.9"></a><span id="l2.9"> namespace services {</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> namespace {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-class ShutdownObserver final : public nsIObserver</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-public:</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+class ShutdownObserver final : public nsIObserver {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ public:</span>
<a href="#l2.17"></a><span id="l2.17">   NS_DECL_ISUPPORTS</span>
<a href="#l2.18"></a><span id="l2.18">   NS_DECL_NSIOBSERVER</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   static void EnsureInitialized();</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-private:</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ private:</span>
<a href="#l2.24"></a><span id="l2.24">   ~ShutdownObserver() {}</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   void ShutdownServices();</span>
<a href="#l2.27"></a><span id="l2.27">   static RefPtr&lt;ShutdownObserver&gt; sShutdownObserver;</span>
<a href="#l2.28"></a><span id="l2.28">   static bool sShuttingDown;</span>
<a href="#l2.29"></a><span id="l2.29"> };</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31"> bool ShutdownObserver::sShuttingDown = false;</span>
<a href="#l2.32"></a><span id="l2.32"> RefPtr&lt;ShutdownObserver&gt; ShutdownObserver::sShutdownObserver = nullptr;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-}</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+}  // namespace</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-#define MOZ_SERVICE(NAME, TYPE, CONTRACT_ID) \</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  static TYPE *g##NAME = nullptr; \</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  already_AddRefed&lt;TYPE&gt; Get##NAME() \</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  { \</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    ShutdownObserver::EnsureInitialized(); \</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    if (!g##NAME) \</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    { \</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-      nsCOMPtr&lt;TYPE&gt; os = do_GetService(CONTRACT_ID); \</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      os.forget(&amp;g##NAME); \</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+#define MOZ_SERVICE(NAME, TYPE, CONTRACT_ID)                        \</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  static TYPE *g##NAME = nullptr;                                   \</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  already_AddRefed&lt;TYPE&gt; Get##NAME() {                              \</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    ShutdownObserver::EnsureInitialized();                          \</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    if (!g##NAME) {                                                 \</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+      nsCOMPtr&lt;TYPE&gt; os = do_GetService(CONTRACT_ID);               \</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      os.forget(&amp;g##NAME);                                          \</span>
<a href="#l2.52"></a><span id="l2.52">       MOZ_ASSERT(g##NAME, &quot;This service is unexpectedly missing.&quot;); \</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    } \</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    nsCOMPtr&lt;TYPE&gt; ret = g##NAME; \</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-    return ret.forget(); \</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    }                                                               \</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    nsCOMPtr&lt;TYPE&gt; ret = g##NAME;                                   \</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    return ret.forget();                                            \</span>
<a href="#l2.59"></a><span id="l2.59">   }</span>
<a href="#l2.60"></a><span id="l2.60"> #include &quot;mozilla/mailnews/ServiceList.h&quot;</span>
<a href="#l2.61"></a><span id="l2.61"> #undef MOZ_SERVICE</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63"> NS_IMPL_ISUPPORTS(ShutdownObserver, nsIObserver)</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65"> NS_IMETHODIMP ShutdownObserver::Observe(nsISupports *aSubject,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    const char *aTopic, const char16_t *aData)</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-{</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  if (!strcmp(aTopic, &quot;xpcom-shutdown-threads&quot;))</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    ShutdownServices();</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+                                        const char *aTopic,</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+                                        const char16_t *aData) {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  if (!strcmp(aTopic, &quot;xpcom-shutdown-threads&quot;)) ShutdownServices();</span>
<a href="#l2.73"></a><span id="l2.73">   return NS_OK;</span>
<a href="#l2.74"></a><span id="l2.74"> }</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-void ShutdownObserver::EnsureInitialized()</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-{</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+void ShutdownObserver::EnsureInitialized() {</span>
<a href="#l2.79"></a><span id="l2.79">   MOZ_ASSERT(!sShuttingDown, &quot;It is illegal to use this code after shutdown!&quot;);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  if (!sShutdownObserver)</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-  {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  if (!sShutdownObserver) {</span>
<a href="#l2.83"></a><span id="l2.83">     sShutdownObserver = new ShutdownObserver;</span>
<a href="#l2.84"></a><span id="l2.84">     nsCOMPtr&lt;nsIObserverService&gt; obs(mozilla::services::GetObserverService());</span>
<a href="#l2.85"></a><span id="l2.85">     MOZ_ASSERT(obs, &quot;This should never be null&quot;);</span>
<a href="#l2.86"></a><span id="l2.86">     obs-&gt;AddObserver(sShutdownObserver, &quot;xpcom-shutdown-threads&quot;, false);</span>
<a href="#l2.87"></a><span id="l2.87">   }</span>
<a href="#l2.88"></a><span id="l2.88"> }</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-void ShutdownObserver::ShutdownServices()</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-{</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+void ShutdownObserver::ShutdownServices() {</span>
<a href="#l2.93"></a><span id="l2.93">   sShuttingDown = true;</span>
<a href="#l2.94"></a><span id="l2.94">   MOZ_ASSERT(sShutdownObserver, &quot;Shutting down twice?&quot;);</span>
<a href="#l2.95"></a><span id="l2.95">   sShutdownObserver = nullptr;</span>
<a href="#l2.96"></a><span id="l2.96"> #define MOZ_SERVICE(NAME, TYPE, CONTRACT_ID) NS_IF_RELEASE(g##NAME);</span>
<a href="#l2.97"></a><span id="l2.97"> #include &quot;mozilla/mailnews/ServiceList.h&quot;</span>
<a href="#l2.98"></a><span id="l2.98"> #undef MOZ_SERVICE</span>
<a href="#l2.99"></a><span id="l2.99"> }</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-} // namespace services</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-} // namespace mozilla</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+}  // namespace services</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+}  // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/Services.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/Services.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -10,17 +10,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> #define MOZ_SERVICE(NAME, TYPE, SERVICE_CID) class TYPE;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;mozilla/mailnews/ServiceList.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #undef MOZ_SERVICE</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> namespace mozilla {</span>
<a href="#l3.10"></a><span id="l3.10"> namespace services {</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#define MOZ_SERVICE(NAME, TYPE, SERVICE_CID) \</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  already_AddRefed&lt;TYPE&gt; Get##NAME();</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#define MOZ_SERVICE(NAME, TYPE, SERVICE_CID) already_AddRefed&lt;TYPE&gt; Get##NAME();</span>
<a href="#l3.15"></a><span id="l3.15"> #include &quot;ServiceList.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16"> #undef MOZ_SERVICE</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-} // namespace services</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-} // namespace mozilla</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+}  // namespace services</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsImapMoveCoalescer.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsImapMoveCoalescer.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,226 +4,199 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsImapMoveCoalescer.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot; // TO include biffState enum. Change to bool later...</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;  // TO include biffState enum. Change to bool later...</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> NS_IMPL_ISUPPORTS(nsImapMoveCoalescer, nsIUrlListener)</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-nsImapMoveCoalescer::nsImapMoveCoalescer(nsIMsgFolder *sourceFolder, nsIMsgWindow *msgWindow)</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-{</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+nsImapMoveCoalescer::nsImapMoveCoalescer(nsIMsgFolder *sourceFolder,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+                                         nsIMsgWindow *msgWindow) {</span>
<a href="#l4.30"></a><span id="l4.30">   m_sourceFolder = sourceFolder;</span>
<a href="#l4.31"></a><span id="l4.31">   m_msgWindow = msgWindow;</span>
<a href="#l4.32"></a><span id="l4.32">   m_hasPendingMoves = false;</span>
<a href="#l4.33"></a><span id="l4.33"> }</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-nsImapMoveCoalescer::~nsImapMoveCoalescer()</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-{</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-}</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+nsImapMoveCoalescer::~nsImapMoveCoalescer() {}</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-nsresult nsImapMoveCoalescer::AddMove(nsIMsgFolder *folder, nsMsgKey key)</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-{</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+nsresult nsImapMoveCoalescer::AddMove(nsIMsgFolder *folder, nsMsgKey key) {</span>
<a href="#l4.43"></a><span id="l4.43">   m_hasPendingMoves = true;</span>
<a href="#l4.44"></a><span id="l4.44">   int32_t folderIndex = m_destFolders.IndexOf(folder);</span>
<a href="#l4.45"></a><span id="l4.45">   nsTArray&lt;nsMsgKey&gt; *keysToAdd = nullptr;</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">   if (folderIndex &gt;= 0)</span>
<a href="#l4.48"></a><span id="l4.48">     keysToAdd = &amp;(m_sourceKeyArrays[folderIndex]);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  else</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  else {</span>
<a href="#l4.52"></a><span id="l4.52">     m_destFolders.AppendObject(folder);</span>
<a href="#l4.53"></a><span id="l4.53">     keysToAdd = m_sourceKeyArrays.AppendElement();</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    if (!keysToAdd)</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    if (!keysToAdd) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.57"></a><span id="l4.57">   }</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  if (!keysToAdd-&gt;Contains(key))</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    keysToAdd-&gt;AppendElement(key);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  if (!keysToAdd-&gt;Contains(key)) keysToAdd-&gt;AppendElement(key);</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">   return NS_OK;</span>
<a href="#l4.64"></a><span id="l4.64"> }</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-nsresult nsImapMoveCoalescer::PlaybackMoves(bool doNewMailNotification /* = false */)</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-{</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+nsresult nsImapMoveCoalescer::PlaybackMoves(</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    bool doNewMailNotification /* = false */) {</span>
<a href="#l4.70"></a><span id="l4.70">   int32_t numFolders = m_destFolders.Count();</span>
<a href="#l4.71"></a><span id="l4.71">   // Nothing to do, so don't change the member variables.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  if (numFolders == 0)</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  if (numFolders == 0) return NS_OK;</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76">   nsresult rv = NS_OK;</span>
<a href="#l4.77"></a><span id="l4.77">   m_hasPendingMoves = false;</span>
<a href="#l4.78"></a><span id="l4.78">   m_doNewMailNotification = doNewMailNotification;</span>
<a href="#l4.79"></a><span id="l4.79">   m_outstandingMoves = 0;</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  for (int32_t i = 0; i &lt; numFolders; ++i)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  for (int32_t i = 0; i &lt; numFolders; ++i) {</span>
<a href="#l4.84"></a><span id="l4.84">     // XXX TODO</span>
<a href="#l4.85"></a><span id="l4.85">     // JUNK MAIL RELATED</span>
<a href="#l4.86"></a><span id="l4.86">     // is this the right place to make sure dest folder exists</span>
<a href="#l4.87"></a><span id="l4.87">     // (and has proper flags?), before we start copying?</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; destFolder(m_destFolders[i]);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt;&amp; keysToAdd = m_sourceKeyArrays[i];</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; destFolder(m_destFolders[i]);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; &amp;keysToAdd = m_sourceKeyArrays[i];</span>
<a href="#l4.92"></a><span id="l4.92">     int32_t numNewMessages = 0;</span>
<a href="#l4.93"></a><span id="l4.93">     int32_t numKeysToAdd = keysToAdd.Length();</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-    if (numKeysToAdd == 0)</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-      continue;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    if (numKeysToAdd == 0) continue;</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">     nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    for (uint32_t keyIndex = 0; keyIndex &lt; keysToAdd.Length(); keyIndex++)</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    for (uint32_t keyIndex = 0; keyIndex &lt; keysToAdd.Length(); keyIndex++) {</span>
<a href="#l4.102"></a><span id="l4.102">       nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr = nullptr;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-      rv = m_sourceFolder-&gt;GetMessageHeader(keysToAdd.ElementAt(keyIndex), getter_AddRefs(mailHdr));</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr)</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-      {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+      rv = m_sourceFolder-&gt;GetMessageHeader(keysToAdd.ElementAt(keyIndex),</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+                                            getter_AddRefs(mailHdr));</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr) {</span>
<a href="#l4.109"></a><span id="l4.109">         messages-&gt;AppendElement(mailHdr);</span>
<a href="#l4.110"></a><span id="l4.110">         bool isRead = false;</span>
<a href="#l4.111"></a><span id="l4.111">         mailHdr-&gt;GetIsRead(&amp;isRead);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-        if (!isRead)</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-          numNewMessages++;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+        if (!isRead) numNewMessages++;</span>
<a href="#l4.115"></a><span id="l4.115">       }</span>
<a href="#l4.116"></a><span id="l4.116">     }</span>
<a href="#l4.117"></a><span id="l4.117">     uint32_t destFlags;</span>
<a href="#l4.118"></a><span id="l4.118">     destFolder-&gt;GetFlags(&amp;destFlags);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-    if (! (destFlags &amp; nsMsgFolderFlags::Junk)) // don't set has new on junk folder</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    if (!(destFlags &amp;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+          nsMsgFolderFlags::Junk))  // don't set has new on junk folder</span>
<a href="#l4.122"></a><span id="l4.122">     {</span>
<a href="#l4.123"></a><span id="l4.123">       destFolder-&gt;SetNumNewMessages(numNewMessages);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-      if (numNewMessages &gt; 0)</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-        destFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+      if (numNewMessages &gt; 0) destFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l4.127"></a><span id="l4.127">     }</span>
<a href="#l4.128"></a><span id="l4.128">     // adjust the new message count on the source folder</span>
<a href="#l4.129"></a><span id="l4.129">     int32_t oldNewMessageCount = 0;</span>
<a href="#l4.130"></a><span id="l4.130">     m_sourceFolder-&gt;GetNumNewMessages(false, &amp;oldNewMessageCount);</span>
<a href="#l4.131"></a><span id="l4.131">     if (oldNewMessageCount &gt;= numKeysToAdd)</span>
<a href="#l4.132"></a><span id="l4.132">       oldNewMessageCount -= numKeysToAdd;</span>
<a href="#l4.133"></a><span id="l4.133">     else</span>
<a href="#l4.134"></a><span id="l4.134">       oldNewMessageCount = 0;</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">     m_sourceFolder-&gt;SetNumNewMessages(oldNewMessageCount);</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">     keysToAdd.Clear();</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-    if (copySvc)</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-    {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-      nsCOMPtr &lt;nsIMsgCopyServiceListener&gt; listener;</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-      if (m_doNewMailNotification)</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-      {</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-        nsMoveCoalescerCopyListener *copyListener = new nsMoveCoalescerCopyListener(this, destFolder);</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-        if (copyListener)</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-          listener = copyListener;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc =</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+    if (copySvc) {</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+      nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; listener;</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+      if (m_doNewMailNotification) {</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+        nsMoveCoalescerCopyListener *copyListener =</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+            new nsMoveCoalescerCopyListener(this, destFolder);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+        if (copyListener) listener = copyListener;</span>
<a href="#l4.156"></a><span id="l4.156">       }</span>
<a href="#l4.157"></a><span id="l4.157">       rv = copySvc-&gt;CopyMessages(m_sourceFolder, messages, destFolder, true,</span>
<a href="#l4.158"></a><span id="l4.158">                                  listener, m_msgWindow, false /*allowUndo*/);</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-        m_outstandingMoves++;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+      if (NS_SUCCEEDED(rv)) m_outstandingMoves++;</span>
<a href="#l4.162"></a><span id="l4.162">     }</span>
<a href="#l4.163"></a><span id="l4.163">   }</span>
<a href="#l4.164"></a><span id="l4.164">   return rv;</span>
<a href="#l4.165"></a><span id="l4.165"> }</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167"> NS_IMETHODIMP</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-nsImapMoveCoalescer::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-{</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+nsImapMoveCoalescer::OnStartRunningUrl(nsIURI *aUrl) {</span>
<a href="#l4.171"></a><span id="l4.171">   NS_ASSERTION(aUrl, &quot;just a sanity check&quot;);</span>
<a href="#l4.172"></a><span id="l4.172">   return NS_OK;</span>
<a href="#l4.173"></a><span id="l4.173"> }</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175"> NS_IMETHODIMP</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-nsImapMoveCoalescer::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-{</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+nsImapMoveCoalescer::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l4.179"></a><span id="l4.179">   m_outstandingMoves--;</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-  if (m_doNewMailNotification &amp;&amp; !m_outstandingMoves)</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-  {</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-    nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_sourceFolder);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-    if (imapFolder)</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-      imapFolder-&gt;NotifyIfNewMail();</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  if (m_doNewMailNotification &amp;&amp; !m_outstandingMoves) {</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+        do_QueryInterface(m_sourceFolder);</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+    if (imapFolder) imapFolder-&gt;NotifyIfNewMail();</span>
<a href="#l4.189"></a><span id="l4.189">   }</span>
<a href="#l4.190"></a><span id="l4.190">   return NS_OK;</span>
<a href="#l4.191"></a><span id="l4.191"> }</span>
<a href="#l4.192"></a><span id="l4.192"> </span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-nsTArray&lt;nsMsgKey&gt; *nsImapMoveCoalescer::GetKeyBucket(uint32_t keyArrayIndex)</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-{</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+nsTArray&lt;nsMsgKey&gt; *nsImapMoveCoalescer::GetKeyBucket(uint32_t keyArrayIndex) {</span>
<a href="#l4.196"></a><span id="l4.196">   NS_ASSERTION(keyArrayIndex &lt; MOZ_ARRAY_LENGTH(m_keyBuckets), &quot;invalid index&quot;);</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-  return keyArrayIndex &lt; mozilla::ArrayLength(m_keyBuckets) ?</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-           &amp;(m_keyBuckets[keyArrayIndex]) : nullptr;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+  return keyArrayIndex &lt; mozilla::ArrayLength(m_keyBuckets)</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+             ? &amp;(m_keyBuckets[keyArrayIndex])</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+             : nullptr;</span>
<a href="#l4.203"></a><span id="l4.203"> }</span>
<a href="#l4.204"></a><span id="l4.204"> </span>
<a href="#l4.205"></a><span id="l4.205"> NS_IMPL_ISUPPORTS(nsMoveCoalescerCopyListener, nsIMsgCopyServiceListener)</span>
<a href="#l4.206"></a><span id="l4.206"> </span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-nsMoveCoalescerCopyListener::nsMoveCoalescerCopyListener(nsImapMoveCoalescer * coalescer,</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-                                                         nsIMsgFolder *destFolder)</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-{</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+nsMoveCoalescerCopyListener::nsMoveCoalescerCopyListener(</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    nsImapMoveCoalescer *coalescer, nsIMsgFolder *destFolder) {</span>
<a href="#l4.212"></a><span id="l4.212">   m_destFolder = destFolder;</span>
<a href="#l4.213"></a><span id="l4.213">   m_coalescer = coalescer;</span>
<a href="#l4.214"></a><span id="l4.214"> }</span>
<a href="#l4.215"></a><span id="l4.215"> </span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-nsMoveCoalescerCopyListener::~nsMoveCoalescerCopyListener()</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-{</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-}</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+nsMoveCoalescerCopyListener::~nsMoveCoalescerCopyListener() {}</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-NS_IMETHODIMP nsMoveCoalescerCopyListener::OnStartCopy()</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-{</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+NS_IMETHODIMP nsMoveCoalescerCopyListener::OnStartCopy() {</span>
<a href="#l4.224"></a><span id="l4.224">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.225"></a><span id="l4.225"> }</span>
<a href="#l4.226"></a><span id="l4.226"> </span>
<a href="#l4.227"></a><span id="l4.227"> /* void OnProgress (in uint32_t aProgress, in uint32_t aProgressMax); */</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-NS_IMETHODIMP nsMoveCoalescerCopyListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-{</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+NS_IMETHODIMP nsMoveCoalescerCopyListener::OnProgress(uint32_t aProgress,</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+                                                      uint32_t aProgressMax) {</span>
<a href="#l4.232"></a><span id="l4.232">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.233"></a><span id="l4.233"> }</span>
<a href="#l4.234"></a><span id="l4.234"> </span>
<a href="#l4.235"></a><span id="l4.235"> /* void SetMessageKey (in uint32_t aKey); */</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-NS_IMETHODIMP nsMoveCoalescerCopyListener::SetMessageKey(uint32_t aKey)</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-{</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+NS_IMETHODIMP nsMoveCoalescerCopyListener::SetMessageKey(uint32_t aKey) {</span>
<a href="#l4.239"></a><span id="l4.239">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.240"></a><span id="l4.240"> }</span>
<a href="#l4.241"></a><span id="l4.241"> </span>
<a href="#l4.242"></a><span id="l4.242"> /* void GetMessageId (in nsACString aMessageId); */</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-NS_IMETHODIMP nsMoveCoalescerCopyListener::GetMessageId(nsACString&amp; messageId)</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-{</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+NS_IMETHODIMP nsMoveCoalescerCopyListener::GetMessageId(nsACString &amp;messageId) {</span>
<a href="#l4.246"></a><span id="l4.246">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.247"></a><span id="l4.247"> }</span>
<a href="#l4.248"></a><span id="l4.248"> </span>
<a href="#l4.249"></a><span id="l4.249"> /* void OnStopCopy (in nsresult aStatus); */</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-NS_IMETHODIMP nsMoveCoalescerCopyListener::OnStopCopy(nsresult aStatus)</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-{</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+NS_IMETHODIMP nsMoveCoalescerCopyListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l4.253"></a><span id="l4.253">   nsresult rv = NS_OK;</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-  {</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l4.257"></a><span id="l4.257">     // if the dest folder is imap, update it.</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-    nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_destFolder);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-    if (imapFolder)</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    {</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_destFolder);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    if (imapFolder) {</span>
<a href="#l4.263"></a><span id="l4.263">       uint32_t folderFlags;</span>
<a href="#l4.264"></a><span id="l4.264">       m_destFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-      if (!(folderFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash)))</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-      {</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-        nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+      if (!(folderFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash))) {</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+        nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+            do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.271"></a><span id="l4.271">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-        nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-        rv = imapService-&gt;SelectFolder(m_destFolder, m_coalescer, nullptr, getter_AddRefs(url));</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+        nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+        rv = imapService-&gt;SelectFolder(m_destFolder, m_coalescer, nullptr,</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+                                       getter_AddRefs(url));</span>
<a href="#l4.277"></a><span id="l4.277">       }</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-    }</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-    else // give junk filters a chance to run on new msgs in destination local folder</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+    } else  // give junk filters a chance to run on new msgs in destination</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+            // local folder</span>
<a href="#l4.282"></a><span id="l4.282">     {</span>
<a href="#l4.283"></a><span id="l4.283">       bool filtersRun;</span>
<a href="#l4.284"></a><span id="l4.284">       m_destFolder-&gt;CallFilterPlugins(nullptr, &amp;filtersRun);</span>
<a href="#l4.285"></a><span id="l4.285">     }</span>
<a href="#l4.286"></a><span id="l4.286">   }</span>
<a href="#l4.287"></a><span id="l4.287">   return rv;</span>
<a href="#l4.288"></a><span id="l4.288"> }</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsImapMoveCoalescer.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsImapMoveCoalescer.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -10,64 +10,62 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsTArray.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-// imap move coalescer class - in order to keep nsImapMailFolder from growing like Topsy</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-// Logically, we want to keep track of an nsTArray&lt;nsMsgKey&gt; per nsIMsgFolder, and then</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-// be able to retrieve them one by one and play back the moves.</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-// This utility class will be used by both the filter code and the offline playback code,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-// to avoid multiple moves to the same folder.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+// imap move coalescer class - in order to keep nsImapMailFolder from growing</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+// like Topsy Logically, we want to keep track of an nsTArray&lt;nsMsgKey&gt; per</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+// nsIMsgFolder, and then be able to retrieve them one by one and play back the</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+// moves. This utility class will be used by both the filter code and the</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+// offline playback code, to avoid multiple moves to the same folder.</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-class NS_MSG_BASE nsImapMoveCoalescer : public nsIUrlListener</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-{</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-public:</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+class NS_MSG_BASE nsImapMoveCoalescer : public nsIUrlListener {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+ public:</span>
<a href="#l5.28"></a><span id="l5.28">   friend class nsMoveCoalescerCopyListener;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   NS_DECL_ISUPPORTS</span>
<a href="#l5.31"></a><span id="l5.31">   NS_DECL_NSIURLLISTENER</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   nsImapMoveCoalescer(nsIMsgFolder *sourceFolder, nsIMsgWindow *msgWindow);</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">   nsresult AddMove(nsIMsgFolder *folder, nsMsgKey key);</span>
<a href="#l5.36"></a><span id="l5.36">   nsresult PlaybackMoves(bool doNewMailNotification = false);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  // this lets the caller store keys in an arbitrary number of buckets. If the bucket</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  // for the passed in index doesn't exist, it will get created.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  // this lets the caller store keys in an arbitrary number of buckets. If the</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  // bucket for the passed in index doesn't exist, it will get created.</span>
<a href="#l5.41"></a><span id="l5.41">   nsTArray&lt;nsMsgKey&gt; *GetKeyBucket(uint32_t keyArrayIndex);</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  nsIMsgWindow *GetMsgWindow() {return m_msgWindow;}</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  bool HasPendingMoves() {return m_hasPendingMoves;}</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-protected:</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  nsIMsgWindow *GetMsgWindow() { return m_msgWindow; }</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  bool HasPendingMoves() { return m_hasPendingMoves; }</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+ protected:</span>
<a href="#l5.49"></a><span id="l5.49">   virtual ~nsImapMoveCoalescer();</span>
<a href="#l5.50"></a><span id="l5.50">   // m_sourceKeyArrays and m_destFolders are parallel arrays.</span>
<a href="#l5.51"></a><span id="l5.51">   nsTArray&lt;nsTArray&lt;nsMsgKey&gt; &gt; m_sourceKeyArrays;</span>
<a href="#l5.52"></a><span id="l5.52">   nsCOMArray&lt;nsIMsgFolder&gt; m_destFolders;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_sourceFolder;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_sourceFolder;</span>
<a href="#l5.57"></a><span id="l5.57">   bool m_doNewMailNotification;</span>
<a href="#l5.58"></a><span id="l5.58">   bool m_hasPendingMoves;</span>
<a href="#l5.59"></a><span id="l5.59">   nsTArray&lt;nsMsgKey&gt; m_keyBuckets[2];</span>
<a href="#l5.60"></a><span id="l5.60">   int32_t m_outstandingMoves;</span>
<a href="#l5.61"></a><span id="l5.61"> };</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-class nsMoveCoalescerCopyListener final : public nsIMsgCopyServiceListener</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-{</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-public:</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-    nsMoveCoalescerCopyListener(nsImapMoveCoalescer * coalescer, nsIMsgFolder *destFolder);</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-    NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+class nsMoveCoalescerCopyListener final : public nsIMsgCopyServiceListener {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+ public:</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  nsMoveCoalescerCopyListener(nsImapMoveCoalescer *coalescer,</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+                              nsIMsgFolder *destFolder);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; m_destFolder;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_destFolder;</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-      nsImapMoveCoalescer *m_coalescer;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    // when we get OnStopCopy, update the folder. When we've finished all the copies,</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    // send the biff notification.</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  nsImapMoveCoalescer *m_coalescer;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  // when we get OnStopCopy, update the folder. When we've finished all the</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  // copies, send the biff notification.</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-private:</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-    ~nsMoveCoalescerCopyListener();</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+ private:</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  ~nsMoveCoalescerCopyListener();</span>
<a href="#l5.90"></a><span id="l5.90"> };</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-#endif // _nsImapMoveCoalescer_H</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+#endif  // _nsImapMoveCoalescer_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgCompressIStream.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgCompressIStream.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,158 +4,132 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsMsgCompressIStream.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;prio.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;prmem.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &lt;algorithm&gt;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> #define BUFFER_SIZE 16384</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-nsMsgCompressIStream::nsMsgCompressIStream() :</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  m_dataptr(nullptr),</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  m_dataleft(0),</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  m_inflateAgain(false)</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-{</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-}</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+nsMsgCompressIStream::nsMsgCompressIStream()</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+    : m_dataptr(nullptr), m_dataleft(0), m_inflateAgain(false) {}</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+nsMsgCompressIStream::~nsMsgCompressIStream() { Close(); }</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-nsMsgCompressIStream::~nsMsgCompressIStream()</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-{</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  Close();</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-}</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgCompressIStream, nsIInputStream, nsIAsyncInputStream)</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgCompressIStream, nsIInputStream,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                              nsIAsyncInputStream)</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-nsresult nsMsgCompressIStream::InitInputStream(nsIInputStream *rawStream)</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-{</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+nsresult nsMsgCompressIStream::InitInputStream(nsIInputStream *rawStream) {</span>
<a href="#l6.35"></a><span id="l6.35">   // protect against repeat calls</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  if (m_iStream)</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  if (m_iStream) return NS_ERROR_UNEXPECTED;</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   // allocate some memory for buffering</span>
<a href="#l6.41"></a><span id="l6.41">   m_zbuf = mozilla::MakeUnique&lt;char[]&gt;(BUFFER_SIZE);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  if (!m_zbuf)</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  if (!m_zbuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">   // allocate some memory for buffering</span>
<a href="#l6.47"></a><span id="l6.47">   m_databuf = mozilla::MakeUnique&lt;char[]&gt;(BUFFER_SIZE);</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  if (!m_databuf)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  if (!m_databuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   // set up zlib object</span>
<a href="#l6.53"></a><span id="l6.53">   m_zstream.zalloc = Z_NULL;</span>
<a href="#l6.54"></a><span id="l6.54">   m_zstream.zfree = Z_NULL;</span>
<a href="#l6.55"></a><span id="l6.55">   m_zstream.opaque = Z_NULL;</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   // http://zlib.net/manual.html is rather silent on the topic, but</span>
<a href="#l6.58"></a><span id="l6.58">   // perl's Compress::Raw::Zlib manual says:</span>
<a href="#l6.59"></a><span id="l6.59">   // -WindowBits</span>
<a href="#l6.60"></a><span id="l6.60">   //  To compress an RFC 1951 data stream, set WindowBits to -MAX_WBITS.</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  if (inflateInit2(&amp;m_zstream, -MAX_WBITS) != Z_OK)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  if (inflateInit2(&amp;m_zstream, -MAX_WBITS) != Z_OK) return NS_ERROR_FAILURE;</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">   m_iStream = rawStream;</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">   return NS_OK;</span>
<a href="#l6.68"></a><span id="l6.68"> }</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-nsresult nsMsgCompressIStream::DoInflation()</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-{</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+nsresult nsMsgCompressIStream::DoInflation() {</span>
<a href="#l6.73"></a><span id="l6.73">   // if there's something in the input buffer of the zstream, process it.</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  m_zstream.next_out = (Bytef *) m_databuf.get();</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  m_zstream.next_out = (Bytef *)m_databuf.get();</span>
<a href="#l6.76"></a><span id="l6.76">   m_zstream.avail_out = BUFFER_SIZE;</span>
<a href="#l6.77"></a><span id="l6.77">   int zr = inflate(&amp;m_zstream, Z_SYNC_FLUSH);</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79">   // inflate() should normally be called until it returns</span>
<a href="#l6.80"></a><span id="l6.80">   // Z_STREAM_END or an error, and Z_BUF_ERROR just means</span>
<a href="#l6.81"></a><span id="l6.81">   // unable to progress any further (possible if we filled</span>
<a href="#l6.82"></a><span id="l6.82">   // an output buffer exactly)</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  if (zr == Z_BUF_ERROR || zr == Z_STREAM_END)</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    zr = Z_OK;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  if (zr == Z_BUF_ERROR || zr == Z_STREAM_END) zr = Z_OK;</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">   // otherwise it's an error</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-  if (zr != Z_OK)</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  if (zr != Z_OK) return NS_ERROR_FAILURE;</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92">   // http://www.zlib.net/manual.html says:</span>
<a href="#l6.93"></a><span id="l6.93">   // If inflate returns Z_OK and with zero avail_out, it must be called</span>
<a href="#l6.94"></a><span id="l6.94">   // again after making room in the output buffer because there might be</span>
<a href="#l6.95"></a><span id="l6.95">   // more output pending.</span>
<a href="#l6.96"></a><span id="l6.96">   m_inflateAgain = m_zstream.avail_out ? false : true;</span>
<a href="#l6.97"></a><span id="l6.97"> </span>
<a href="#l6.98"></a><span id="l6.98">   // set the pointer to the start of the buffer, and the count to how</span>
<a href="#l6.99"></a><span id="l6.99">   // based on how many bytes are left unconsumed.</span>
<a href="#l6.100"></a><span id="l6.100">   m_dataptr = m_databuf.get();</span>
<a href="#l6.101"></a><span id="l6.101">   m_dataleft = BUFFER_SIZE - m_zstream.avail_out;</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">   return NS_OK;</span>
<a href="#l6.104"></a><span id="l6.104"> }</span>
<a href="#l6.105"></a><span id="l6.105"> </span>
<a href="#l6.106"></a><span id="l6.106"> /* void close (); */</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::Close()</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-{</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-  return CloseWithStatus(NS_OK);</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-}</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::Close() { return CloseWithStatus(NS_OK); }</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::CloseWithStatus(nsresult reason)</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-{</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::CloseWithStatus(nsresult reason) {</span>
<a href="#l6.116"></a><span id="l6.116">   nsresult rv = NS_OK;</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-  if (m_iStream)</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-  {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  if (m_iStream) {</span>
<a href="#l6.121"></a><span id="l6.121">     // pass the status through to our wrapped stream</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-    nsCOMPtr &lt;nsIAsyncInputStream&gt; asyncInputStream = do_QueryInterface(m_iStream);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    if (asyncInputStream)</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-      rv = asyncInputStream-&gt;CloseWithStatus(reason);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+    nsCOMPtr&lt;nsIAsyncInputStream&gt; asyncInputStream =</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+        do_QueryInterface(m_iStream);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+    if (asyncInputStream) rv = asyncInputStream-&gt;CloseWithStatus(reason);</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129">     // tidy up</span>
<a href="#l6.130"></a><span id="l6.130">     m_iStream = nullptr;</span>
<a href="#l6.131"></a><span id="l6.131">     inflateEnd(&amp;m_zstream);</span>
<a href="#l6.132"></a><span id="l6.132">   }</span>
<a href="#l6.133"></a><span id="l6.133"> </span>
<a href="#l6.134"></a><span id="l6.134">   // clean up all the buffers</span>
<a href="#l6.135"></a><span id="l6.135">   m_zbuf = nullptr;</span>
<a href="#l6.136"></a><span id="l6.136">   m_databuf = nullptr;</span>
<a href="#l6.137"></a><span id="l6.137">   m_dataptr = nullptr;</span>
<a href="#l6.138"></a><span id="l6.138">   m_dataleft = 0;</span>
<a href="#l6.139"></a><span id="l6.139"> </span>
<a href="#l6.140"></a><span id="l6.140">   return rv;</span>
<a href="#l6.141"></a><span id="l6.141"> }</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143"> /* unsigned long long available (); */</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::Available(uint64_t *aResult)</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-{</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-  if (!m_iStream)</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::Available(uint64_t *aResult) {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  if (!m_iStream) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l6.150"></a><span id="l6.150"> </span>
<a href="#l6.151"></a><span id="l6.151">   // check if there's anything still in flight</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-  if (!m_dataleft &amp;&amp; m_inflateAgain)</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-  {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  if (!m_dataleft &amp;&amp; m_inflateAgain) {</span>
<a href="#l6.155"></a><span id="l6.155">     nsresult rv = DoInflation();</span>
<a href="#l6.156"></a><span id="l6.156">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.157"></a><span id="l6.157">   }</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">   // we'll be returning this many to the next read, guaranteed</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  if (m_dataleft)</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-  {</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  if (m_dataleft) {</span>
<a href="#l6.163"></a><span id="l6.163">     *aResult = m_dataleft;</span>
<a href="#l6.164"></a><span id="l6.164">     return NS_OK;</span>
<a href="#l6.165"></a><span id="l6.165">   }</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167">   // this value isn't accurate, but will give a good true/false</span>
<a href="#l6.168"></a><span id="l6.168">   // indication for idle purposes, and next read will fill</span>
<a href="#l6.169"></a><span id="l6.169">   // m_dataleft, so we'll have an accurate count for the next call.</span>
<a href="#l6.170"></a><span id="l6.170">   return m_iStream-&gt;Available(aResult);</span>
<a href="#l6.171"></a><span id="l6.171"> }</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173"> /* [noscript] unsigned long read (in charPtr aBuf, in unsigned long aCount); */</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::Read(char * aBuf, uint32_t aCount, uint32_t *aResult)</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-{</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-  if (!m_iStream)</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-  {</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::Read(char *aBuf, uint32_t aCount,</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+                                         uint32_t *aResult) {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+  if (!m_iStream) {</span>
<a href="#l6.181"></a><span id="l6.181">     *aResult = 0;</span>
<a href="#l6.182"></a><span id="l6.182">     return NS_OK;</span>
<a href="#l6.183"></a><span id="l6.183">   }</span>
<a href="#l6.184"></a><span id="l6.184"> </span>
<a href="#l6.185"></a><span id="l6.185">   // There are two stages of buffering:</span>
<a href="#l6.186"></a><span id="l6.186">   // * m_zbuf contains the compressed data from the remote server</span>
<a href="#l6.187"></a><span id="l6.187">   // * m_databuf contains the uncompressed raw bytes for consumption</span>
<a href="#l6.188"></a><span id="l6.188">   //   by the local client.</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineat">@@ -165,63 +139,61 @@ NS_IMETHODIMP nsMsgCompressIStream::Read</span>
<a href="#l6.190"></a><span id="l6.190">   //</span>
<a href="#l6.191"></a><span id="l6.191">   // m_dataptr and m_dataleft are respectively a pointer to the</span>
<a href="#l6.192"></a><span id="l6.192">   // unconsumed portion of m_databuf and the number of bytes</span>
<a href="#l6.193"></a><span id="l6.193">   // of uncompressed data remaining in m_databuf.</span>
<a href="#l6.194"></a><span id="l6.194">   //</span>
<a href="#l6.195"></a><span id="l6.195">   // both buffers have a maximum size of BUFFER_SIZE, so it is</span>
<a href="#l6.196"></a><span id="l6.196">   // possible that multiple inflate passes will be required to</span>
<a href="#l6.197"></a><span id="l6.197">   // consume all of m_zbuf.</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  while (!m_dataleft)</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-  {</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  while (!m_dataleft) {</span>
<a href="#l6.201"></a><span id="l6.201">     // get some more data if we don't already have any</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    if (!m_inflateAgain)</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    {</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+    if (!m_inflateAgain) {</span>
<a href="#l6.205"></a><span id="l6.205">       uint32_t bytesRead;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-      nsresult rv = m_iStream-&gt;Read(m_zbuf.get(), (uint32_t)BUFFER_SIZE, &amp;bytesRead);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+      nsresult rv =</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+          m_iStream-&gt;Read(m_zbuf.get(), (uint32_t)BUFFER_SIZE, &amp;bytesRead);</span>
<a href="#l6.209"></a><span id="l6.209">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-      if (!bytesRead)</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-        return NS_BASE_STREAM_CLOSED;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-      m_zstream.next_in = (Bytef *) m_zbuf.get();</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+      if (!bytesRead) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+      m_zstream.next_in = (Bytef *)m_zbuf.get();</span>
<a href="#l6.215"></a><span id="l6.215">       m_zstream.avail_in = bytesRead;</span>
<a href="#l6.216"></a><span id="l6.216">     }</span>
<a href="#l6.217"></a><span id="l6.217"> </span>
<a href="#l6.218"></a><span id="l6.218">     nsresult rv = DoInflation();</span>
<a href="#l6.219"></a><span id="l6.219">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.220"></a><span id="l6.220">   }</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222">   *aResult = std::min(m_dataleft, aCount);</span>
<a href="#l6.223"></a><span id="l6.223"> </span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-  if (*aResult)</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-  {</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+  if (*aResult) {</span>
<a href="#l6.227"></a><span id="l6.227">     memcpy(aBuf, m_dataptr, *aResult);</span>
<a href="#l6.228"></a><span id="l6.228">     m_dataptr += *aResult;</span>
<a href="#l6.229"></a><span id="l6.229">     m_dataleft -= *aResult;</span>
<a href="#l6.230"></a><span id="l6.230">   }</span>
<a href="#l6.231"></a><span id="l6.231"> </span>
<a href="#l6.232"></a><span id="l6.232">   return NS_OK;</span>
<a href="#l6.233"></a><span id="l6.233"> }</span>
<a href="#l6.234"></a><span id="l6.234"> </span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-/* [noscript] unsigned long readSegments (in nsWriteSegmentFun aWriter, in voidPtr aClosure, in unsigned long aCount); */</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::ReadSegments(nsWriteSegmentFun aWriter, void * aClosure, uint32_t aCount, uint32_t *_retval)</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-{</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+/* [noscript] unsigned long readSegments (in nsWriteSegmentFun aWriter, in</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+ * voidPtr aClosure, in unsigned long aCount); */</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::ReadSegments(nsWriteSegmentFun aWriter,</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+                                                 void *aClosure,</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+                                                 uint32_t aCount,</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+                                                 uint32_t *_retval) {</span>
<a href="#l6.244"></a><span id="l6.244">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.245"></a><span id="l6.245"> }</span>
<a href="#l6.246"></a><span id="l6.246"> </span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::AsyncWait(nsIInputStreamCallback *callback, uint32_t flags, uint32_t amount, nsIEventTarget *target)</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-{</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-  if (!m_iStream)</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::AsyncWait(nsIInputStreamCallback *callback,</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+                                              uint32_t flags, uint32_t amount,</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+                                              nsIEventTarget *target) {</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+  if (!m_iStream) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l6.255"></a><span id="l6.255"> </span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-  nsCOMPtr &lt;nsIAsyncInputStream&gt; asyncInputStream = do_QueryInterface(m_iStream);</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+  nsCOMPtr&lt;nsIAsyncInputStream&gt; asyncInputStream = do_QueryInterface(m_iStream);</span>
<a href="#l6.258"></a><span id="l6.258">   if (asyncInputStream)</span>
<a href="#l6.259"></a><span id="l6.259">     return asyncInputStream-&gt;AsyncWait(callback, flags, amount, target);</span>
<a href="#l6.260"></a><span id="l6.260"> </span>
<a href="#l6.261"></a><span id="l6.261">   return NS_OK;</span>
<a href="#l6.262"></a><span id="l6.262"> }</span>
<a href="#l6.263"></a><span id="l6.263"> </span>
<a href="#l6.264"></a><span id="l6.264"> /* boolean isNonBlocking (); */</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-NS_IMETHODIMP nsMsgCompressIStream::IsNonBlocking(bool *aNonBlocking)</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-{</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+NS_IMETHODIMP nsMsgCompressIStream::IsNonBlocking(bool *aNonBlocking) {</span>
<a href="#l6.268"></a><span id="l6.268">   *aNonBlocking = false;</span>
<a href="#l6.269"></a><span id="l6.269">   return NS_OK;</span>
<a href="#l6.270"></a><span id="l6.270"> }</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/util/nsMsgCompressIStream.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgCompressIStream.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -4,32 +4,30 @@</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;mozilla/UniquePtr.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;zlib.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-class NS_MSG_BASE nsMsgCompressIStream final : public nsIAsyncInputStream</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-public:</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+class NS_MSG_BASE nsMsgCompressIStream final : public nsIAsyncInputStream {</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ public:</span>
<a href="#l7.17"></a><span id="l7.17">   nsMsgCompressIStream();</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   NS_DECL_NSIINPUTSTREAM</span>
<a href="#l7.22"></a><span id="l7.22">   NS_DECL_NSIASYNCINPUTSTREAM</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   nsresult InitInputStream(nsIInputStream *rawStream);</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-protected:</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ protected:</span>
<a href="#l7.28"></a><span id="l7.28">   ~nsMsgCompressIStream();</span>
<a href="#l7.29"></a><span id="l7.29">   nsresult DoInflation();</span>
<a href="#l7.30"></a><span id="l7.30">   nsCOMPtr&lt;nsIInputStream&gt; m_iStream;</span>
<a href="#l7.31"></a><span id="l7.31">   mozilla::UniquePtr&lt;char[]&gt; m_zbuf;</span>
<a href="#l7.32"></a><span id="l7.32">   mozilla::UniquePtr&lt;char[]&gt; m_databuf;</span>
<a href="#l7.33"></a><span id="l7.33">   char *m_dataptr;</span>
<a href="#l7.34"></a><span id="l7.34">   uint32_t m_dataleft;</span>
<a href="#l7.35"></a><span id="l7.35">   bool m_inflateAgain;</span>
<a href="#l7.36"></a><span id="l7.36">   z_stream m_zstream;</span>
<a href="#l7.37"></a><span id="l7.37"> };</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/util/nsMsgCompressOStream.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgCompressOStream.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,143 +3,122 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsMsgCompressOStream.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;prio.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;prmem.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> #define BUFFER_SIZE 16384</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-nsMsgCompressOStream::nsMsgCompressOStream() :</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  m_zbuf(nullptr)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-{</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-}</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+nsMsgCompressOStream::nsMsgCompressOStream() : m_zbuf(nullptr) {}</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-nsMsgCompressOStream::~nsMsgCompressOStream()</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-{</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-  Close();</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-}</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+nsMsgCompressOStream::~nsMsgCompressOStream() { Close(); }</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> NS_IMPL_ISUPPORTS(nsMsgCompressOStream, nsIOutputStream)</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-nsresult nsMsgCompressOStream::InitOutputStream(nsIOutputStream *rawStream)</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-{</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+nsresult nsMsgCompressOStream::InitOutputStream(nsIOutputStream *rawStream) {</span>
<a href="#l8.29"></a><span id="l8.29">   // protect against repeat calls</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  if (m_oStream)</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  if (m_oStream) return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">   // allocate some memory for a buffer</span>
<a href="#l8.35"></a><span id="l8.35">   m_zbuf = mozilla::MakeUnique&lt;char[]&gt;(BUFFER_SIZE);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  if (!m_zbuf)</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  if (!m_zbuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">   // set up the zlib object</span>
<a href="#l8.41"></a><span id="l8.41">   m_zstream.zalloc = Z_NULL;</span>
<a href="#l8.42"></a><span id="l8.42">   m_zstream.zfree = Z_NULL;</span>
<a href="#l8.43"></a><span id="l8.43">   m_zstream.opaque = Z_NULL;</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   // http://zlib.net/manual.html is rather silent on the topic, but</span>
<a href="#l8.46"></a><span id="l8.46">   // perl's Compress::Raw::Zlib manual says:</span>
<a href="#l8.47"></a><span id="l8.47">   // -WindowBits [...]</span>
<a href="#l8.48"></a><span id="l8.48">   //  To compress an RFC 1951 data stream, set WindowBits to -MAX_WBITS.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  if (deflateInit2(&amp;m_zstream, Z_DEFAULT_COMPRESSION, Z_DEFLATED,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-                   -MAX_WBITS, MAX_MEM_LEVEL, Z_DEFAULT_STRATEGY) != Z_OK)</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  if (deflateInit2(&amp;m_zstream, Z_DEFAULT_COMPRESSION, Z_DEFLATED, -MAX_WBITS,</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+                   MAX_MEM_LEVEL, Z_DEFAULT_STRATEGY) != Z_OK)</span>
<a href="#l8.53"></a><span id="l8.53">     return NS_ERROR_FAILURE;</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55">   m_oStream = rawStream;</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   return NS_OK;</span>
<a href="#l8.58"></a><span id="l8.58"> }</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60"> /* void close (); */</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-NS_IMETHODIMP nsMsgCompressOStream::Close()</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-{</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  if (m_oStream)</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+NS_IMETHODIMP nsMsgCompressOStream::Close() {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  if (m_oStream) {</span>
<a href="#l8.67"></a><span id="l8.67">     m_oStream = nullptr;</span>
<a href="#l8.68"></a><span id="l8.68">     deflateEnd(&amp;m_zstream);</span>
<a href="#l8.69"></a><span id="l8.69">   }</span>
<a href="#l8.70"></a><span id="l8.70">   m_zbuf = nullptr;</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   return NS_OK;</span>
<a href="#l8.73"></a><span id="l8.73"> }</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75"> NS_IMETHODIMP</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-nsMsgCompressOStream::Write(const char *buf, uint32_t count, uint32_t *result)</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-{</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  if (!m_oStream)</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+nsMsgCompressOStream::Write(const char *buf, uint32_t count, uint32_t *result) {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  if (!m_oStream) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  m_zstream.next_in = (Bytef *) buf;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  m_zstream.next_in = (Bytef *)buf;</span>
<a href="#l8.85"></a><span id="l8.85">   m_zstream.avail_in = count;</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87">   // keep looping until the buffer doesn't get filled</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  do</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  {</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    m_zstream.next_out = (Bytef *) m_zbuf.get();</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  do {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    m_zstream.next_out = (Bytef *)m_zbuf.get();</span>
<a href="#l8.93"></a><span id="l8.93">     m_zstream.avail_out = BUFFER_SIZE;</span>
<a href="#l8.94"></a><span id="l8.94">     // Using &quot;Z_SYNC_FLUSH&quot; may cause excess flushes if the calling</span>
<a href="#l8.95"></a><span id="l8.95">     // code does a lot of small writes.  An option with the IMAP</span>
<a href="#l8.96"></a><span id="l8.96">     // protocol is to check the buffer for &quot;\n&quot; at the end, but</span>
<a href="#l8.97"></a><span id="l8.97">     // in the interests of keeping this generic, don't optimise</span>
<a href="#l8.98"></a><span id="l8.98">     // yet.  An alternative is to require -&gt;Flush always, but that</span>
<a href="#l8.99"></a><span id="l8.99">     // is likely to break callers.</span>
<a href="#l8.100"></a><span id="l8.100">     int zr = deflate(&amp;m_zstream, Z_SYNC_FLUSH);</span>
<a href="#l8.101"></a><span id="l8.101">     if (zr == Z_STREAM_END || zr == Z_BUF_ERROR)</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-      zr = Z_OK; // not an error for our purposes</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-    if (zr != Z_OK)</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+      zr = Z_OK;  // not an error for our purposes</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    if (zr != Z_OK) return NS_ERROR_FAILURE;</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">     uint32_t out_size = BUFFER_SIZE - m_zstream.avail_out;</span>
<a href="#l8.109"></a><span id="l8.109">     const char *out_buf = m_zbuf.get();</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">     // push everything in the buffer before repeating</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    while (out_size)</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-    {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    while (out_size) {</span>
<a href="#l8.115"></a><span id="l8.115">       uint32_t out_result;</span>
<a href="#l8.116"></a><span id="l8.116">       nsresult rv = m_oStream-&gt;Write(out_buf, out_size, &amp;out_result);</span>
<a href="#l8.117"></a><span id="l8.117">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-      if (!out_result)</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        return NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+      if (!out_result) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.121"></a><span id="l8.121">       out_size -= out_result;</span>
<a href="#l8.122"></a><span id="l8.122">       out_buf += out_result;</span>
<a href="#l8.123"></a><span id="l8.123">     }</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-  // http://www.zlib.net/manual.html says:</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  // If deflate returns with avail_out == 0, this function must be</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-  // called again with the same value of the flush parameter and</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  // more output space (updated avail_out), until the flush is</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  // complete (deflate returns with non-zero avail_out).</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    // http://www.zlib.net/manual.html says:</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+    // If deflate returns with avail_out == 0, this function must be</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+    // called again with the same value of the flush parameter and</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    // more output space (updated avail_out), until the flush is</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    // complete (deflate returns with non-zero avail_out).</span>
<a href="#l8.135"></a><span id="l8.135">   } while (!m_zstream.avail_out);</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137">   *result = count;</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139">   return NS_OK;</span>
<a href="#l8.140"></a><span id="l8.140"> }</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142"> NS_IMETHODIMP</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-nsMsgCompressOStream::Flush(void)</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-{</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-  if (!m_oStream)</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+nsMsgCompressOStream::Flush(void) {</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  if (!m_oStream) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l8.149"></a><span id="l8.149"> </span>
<a href="#l8.150"></a><span id="l8.150">   return m_oStream-&gt;Flush();</span>
<a href="#l8.151"></a><span id="l8.151"> }</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153"> NS_IMETHODIMP</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-nsMsgCompressOStream::WriteFrom(nsIInputStream *inStr, uint32_t count, uint32_t *_retval)</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-{</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+nsMsgCompressOStream::WriteFrom(nsIInputStream *inStr, uint32_t count,</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+                                uint32_t *_retval) {</span>
<a href="#l8.158"></a><span id="l8.158">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.159"></a><span id="l8.159"> }</span>
<a href="#l8.160"></a><span id="l8.160"> </span>
<a href="#l8.161"></a><span id="l8.161"> NS_IMETHODIMP</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-nsMsgCompressOStream::WriteSegments(nsReadSegmentFun reader, void * closure, uint32_t count, uint32_t *_retval)</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-{</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+nsMsgCompressOStream::WriteSegments(nsReadSegmentFun reader, void *closure,</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+                                    uint32_t count, uint32_t *_retval) {</span>
<a href="#l8.166"></a><span id="l8.166">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.167"></a><span id="l8.167"> }</span>
<a href="#l8.168"></a><span id="l8.168"> </span>
<a href="#l8.169"></a><span id="l8.169"> /* boolean isNonBlocking (); */</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-NS_IMETHODIMP nsMsgCompressOStream::IsNonBlocking(bool *aNonBlocking)</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-{</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+NS_IMETHODIMP nsMsgCompressOStream::IsNonBlocking(bool *aNonBlocking) {</span>
<a href="#l8.173"></a><span id="l8.173">   *aNonBlocking = false;</span>
<a href="#l8.174"></a><span id="l8.174">   return NS_OK;</span>
<a href="#l8.175"></a><span id="l8.175"> }</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgCompressOStream.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgCompressOStream.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3,26 +3,24 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;mozilla/UniquePtr.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;zlib.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-class NS_MSG_BASE nsMsgCompressOStream final : public nsIOutputStream</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-public:</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+class NS_MSG_BASE nsMsgCompressOStream final : public nsIOutputStream {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ public:</span>
<a href="#l9.17"></a><span id="l9.17">   nsMsgCompressOStream();</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   NS_DECL_NSIOUTPUTSTREAM</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">   nsresult InitOutputStream(nsIOutputStream *rawStream);</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-protected:</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+ protected:</span>
<a href="#l9.27"></a><span id="l9.27">   ~nsMsgCompressOStream();</span>
<a href="#l9.28"></a><span id="l9.28">   nsCOMPtr&lt;nsIOutputStream&gt; m_oStream;</span>
<a href="#l9.29"></a><span id="l9.29">   mozilla::UniquePtr&lt;char[]&gt; m_zbuf;</span>
<a href="#l9.30"></a><span id="l9.30">   z_stream m_zstream;</span>
<a href="#l9.31"></a><span id="l9.31"> };</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -70,41 +70,42 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;mozilla/intl/LocaleService.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> using namespace mozilla;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-static PRTime gtimeOfLastPurgeCheck;  // variable to know when to check for purge threshold</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+static PRTime gtimeOfLastPurgeCheck;  // variable to know when to check for</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+                                      // purge threshold</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> #define PREF_MAIL_PROMPT_PURGE_THRESHOLD &quot;mail.prompt_purge_threshhold&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> #define PREF_MAIL_PURGE_THRESHOLD &quot;mail.purge_threshhold&quot;</span>
<a href="#l10.18"></a><span id="l10.18"> #define PREF_MAIL_PURGE_THRESHOLD_MB &quot;mail.purge_threshhold_mb&quot;</span>
<a href="#l10.19"></a><span id="l10.19"> #define PREF_MAIL_PURGE_MIGRATED &quot;mail.purge_threshold_migrated&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> #define PREF_MAIL_PURGE_ASK &quot;mail.purge.ask&quot;</span>
<a href="#l10.21"></a><span id="l10.21"> #define PREF_MAIL_WARN_FILTER_CHANGED &quot;mail.warn_filter_changed&quot;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> const char *kUseServerRetentionProp = &quot;useServerRetention&quot;;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-nsICollation * nsMsgDBFolder::gCollationKeyGenerator = nullptr;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+nsICollation *nsMsgDBFolder::gCollationKeyGenerator = nullptr;</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> nsString nsMsgDBFolder::kLocalizedInboxName;</span>
<a href="#l10.29"></a><span id="l10.29"> nsString nsMsgDBFolder::kLocalizedTrashName;</span>
<a href="#l10.30"></a><span id="l10.30"> nsString nsMsgDBFolder::kLocalizedSentName;</span>
<a href="#l10.31"></a><span id="l10.31"> nsString nsMsgDBFolder::kLocalizedDraftsName;</span>
<a href="#l10.32"></a><span id="l10.32"> nsString nsMsgDBFolder::kLocalizedTemplatesName;</span>
<a href="#l10.33"></a><span id="l10.33"> nsString nsMsgDBFolder::kLocalizedUnsentName;</span>
<a href="#l10.34"></a><span id="l10.34"> nsString nsMsgDBFolder::kLocalizedJunkName;</span>
<a href="#l10.35"></a><span id="l10.35"> nsString nsMsgDBFolder::kLocalizedArchivesName;</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37"> nsString nsMsgDBFolder::kLocalizedBrandShortName;</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-nsrefcnt nsMsgDBFolder::mInstanceCount=0;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+nsrefcnt nsMsgDBFolder::mInstanceCount = 0;</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42"> // We define strings for folder properties and events.</span>
<a href="#l10.43"></a><span id="l10.43"> // Properties:</span>
<a href="#l10.44"></a><span id="l10.44"> NS_NAMED_LITERAL_CSTRING(kBiffState, &quot;BiffState&quot;);</span>
<a href="#l10.45"></a><span id="l10.45"> NS_NAMED_LITERAL_CSTRING(kCanFileMessages, &quot;CanFileMessages&quot;);</span>
<a href="#l10.46"></a><span id="l10.46"> NS_NAMED_LITERAL_CSTRING(kDefaultServer, &quot;DefaultServer&quot;);</span>
<a href="#l10.47"></a><span id="l10.47"> NS_NAMED_LITERAL_CSTRING(kFlagged, &quot;Flagged&quot;);</span>
<a href="#l10.48"></a><span id="l10.48"> NS_NAMED_LITERAL_CSTRING(kFolderFlag, &quot;FolderFlag&quot;);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineat">@@ -133,128 +134,113 @@ NS_NAMED_LITERAL_CSTRING(kDeleteOrMoveMs</span>
<a href="#l10.50"></a><span id="l10.50"> NS_NAMED_LITERAL_CSTRING(kFiltersApplied, &quot;FiltersApplied&quot;);</span>
<a href="#l10.51"></a><span id="l10.51"> NS_NAMED_LITERAL_CSTRING(kFolderCreateCompleted, &quot;FolderCreateCompleted&quot;);</span>
<a href="#l10.52"></a><span id="l10.52"> NS_NAMED_LITERAL_CSTRING(kFolderCreateFailed, &quot;FolderCreateFailed&quot;);</span>
<a href="#l10.53"></a><span id="l10.53"> NS_NAMED_LITERAL_CSTRING(kFolderLoaded, &quot;FolderLoaded&quot;);</span>
<a href="#l10.54"></a><span id="l10.54"> NS_NAMED_LITERAL_CSTRING(kNumNewBiffMessages, &quot;NumNewBiffMessages&quot;);</span>
<a href="#l10.55"></a><span id="l10.55"> NS_NAMED_LITERAL_CSTRING(kRenameCompleted, &quot;RenameCompleted&quot;);</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57"> NS_IMPL_ISUPPORTS_INHERITED(nsMsgDBFolder, nsRDFResource,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-                             nsISupportsWeakReference, nsIMsgFolder,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-                             nsIDBChangeListener, nsIUrlListener,</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-                             nsIJunkMailClassificationListener,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-                             nsIMsgTraitClassificationListener)</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+                            nsISupportsWeakReference, nsIMsgFolder,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+                            nsIDBChangeListener, nsIUrlListener,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+                            nsIJunkMailClassificationListener,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+                            nsIMsgTraitClassificationListener)</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67"> nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-: mAddListener(true),</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  mNewMessages(false),</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  mGettingNewMessages(false),</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  mLastMessageLoaded(nsMsgKey_None),</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  mFlags(0),</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  mNumUnreadMessages(-1),</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-  mNumTotalMessages(-1),</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  mNotifyCountChanges(true),</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  mExpungedBytes(0),</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  mInitializedFromCache(false),</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  mSemaphoreHolder(nullptr),</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  mNumPendingUnreadMessages(0),</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-  mNumPendingTotalMessages(0),</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  mFolderSize(kSizeUnknown),</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  mNumNewBiffMessages(0),</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-  mHaveParsedURI(false),</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  mIsServerIsValid(false),</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  mIsServer(false)</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-{</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-  if (mInstanceCount++ &lt;=0) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+    : mAddListener(true),</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+      mNewMessages(false),</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+      mGettingNewMessages(false),</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+      mLastMessageLoaded(nsMsgKey_None),</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+      mFlags(0),</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+      mNumUnreadMessages(-1),</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+      mNumTotalMessages(-1),</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+      mNotifyCountChanges(true),</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+      mExpungedBytes(0),</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+      mInitializedFromCache(false),</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+      mSemaphoreHolder(nullptr),</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+      mNumPendingUnreadMessages(0),</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+      mNumPendingTotalMessages(0),</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+      mFolderSize(kSizeUnknown),</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+      mNumNewBiffMessages(0),</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+      mHaveParsedURI(false),</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+      mIsServerIsValid(false),</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+      mIsServer(false) {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  if (mInstanceCount++ &lt;= 0) {</span>
<a href="#l10.107"></a><span id="l10.107">     initializeStrings();</span>
<a href="#l10.108"></a><span id="l10.108">     createCollationKeyGenerator();</span>
<a href="#l10.109"></a><span id="l10.109">     gtimeOfLastPurgeCheck = 0;</span>
<a href="#l10.110"></a><span id="l10.110">   }</span>
<a href="#l10.111"></a><span id="l10.111"> </span>
<a href="#l10.112"></a><span id="l10.112">   mProcessingFlag[0].bit = nsMsgProcessingFlags::ClassifyJunk;</span>
<a href="#l10.113"></a><span id="l10.113">   mProcessingFlag[1].bit = nsMsgProcessingFlags::ClassifyTraits;</span>
<a href="#l10.114"></a><span id="l10.114">   mProcessingFlag[2].bit = nsMsgProcessingFlags::TraitsDone;</span>
<a href="#l10.115"></a><span id="l10.115">   mProcessingFlag[3].bit = nsMsgProcessingFlags::FiltersDone;</span>
<a href="#l10.116"></a><span id="l10.116">   mProcessingFlag[4].bit = nsMsgProcessingFlags::FilterToMove;</span>
<a href="#l10.117"></a><span id="l10.117">   mProcessingFlag[5].bit = nsMsgProcessingFlags::NotReportedClassified;</span>
<a href="#l10.118"></a><span id="l10.118">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l10.119"></a><span id="l10.119">     mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l10.120"></a><span id="l10.120"> }</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-nsMsgDBFolder::~nsMsgDBFolder(void)</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-{</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+nsMsgDBFolder::~nsMsgDBFolder(void) {</span>
<a href="#l10.125"></a><span id="l10.125">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l10.126"></a><span id="l10.126">     delete mProcessingFlag[i].keys;</span>
<a href="#l10.127"></a><span id="l10.127"> </span>
<a href="#l10.128"></a><span id="l10.128">   if (--mInstanceCount == 0) {</span>
<a href="#l10.129"></a><span id="l10.129">     NS_IF_RELEASE(gCollationKeyGenerator);</span>
<a href="#l10.130"></a><span id="l10.130">   }</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  //shutdown but don't shutdown children.</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  // shutdown but don't shutdown children.</span>
<a href="#l10.133"></a><span id="l10.133">   Shutdown(false);</span>
<a href="#l10.134"></a><span id="l10.134"> }</span>
<a href="#l10.135"></a><span id="l10.135"> </span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::Shutdown(bool shutdownChildren)</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-{</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-  if(mDatabase)</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-  {</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::Shutdown(bool shutdownChildren) {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.142"></a><span id="l10.142">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l10.143"></a><span id="l10.143">     mDatabase-&gt;ForceClosed();</span>
<a href="#l10.144"></a><span id="l10.144">     mDatabase = nullptr;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-    if (mBackupDatabase)</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    {</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+    if (mBackupDatabase) {</span>
<a href="#l10.148"></a><span id="l10.148">       mBackupDatabase-&gt;ForceClosed();</span>
<a href="#l10.149"></a><span id="l10.149">       mBackupDatabase = nullptr;</span>
<a href="#l10.150"></a><span id="l10.150">     }</span>
<a href="#l10.151"></a><span id="l10.151">   }</span>
<a href="#l10.152"></a><span id="l10.152"> </span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-  if(shutdownChildren)</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-  {</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+  if (shutdownChildren) {</span>
<a href="#l10.156"></a><span id="l10.156">     int32_t count = mSubFolders.Count();</span>
<a href="#l10.157"></a><span id="l10.157"> </span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-    for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-      mSubFolders[i]-&gt;Shutdown(true);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+    for (int32_t i = 0; i &lt; count; i++) mSubFolders[i]-&gt;Shutdown(true);</span>
<a href="#l10.161"></a><span id="l10.161"> </span>
<a href="#l10.162"></a><span id="l10.162">     // Reset incoming server pointer and pathname.</span>
<a href="#l10.163"></a><span id="l10.163">     mServer = nullptr;</span>
<a href="#l10.164"></a><span id="l10.164">     mPath = nullptr;</span>
<a href="#l10.165"></a><span id="l10.165">     mHaveParsedURI = false;</span>
<a href="#l10.166"></a><span id="l10.166">     mName.Truncate();</span>
<a href="#l10.167"></a><span id="l10.167">     mSubFolders.Clear();</span>
<a href="#l10.168"></a><span id="l10.168">   }</span>
<a href="#l10.169"></a><span id="l10.169">   return NS_OK;</span>
<a href="#l10.170"></a><span id="l10.170"> }</span>
<a href="#l10.171"></a><span id="l10.171"> </span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ForceDBClosed()</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-{</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ForceDBClosed() {</span>
<a href="#l10.176"></a><span id="l10.176">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-    mSubFolders[i]-&gt;ForceDBClosed();</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-  {</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) mSubFolders[i]-&gt;ForceDBClosed();</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.185"></a><span id="l10.185">     mDatabase-&gt;ForceClosed();</span>
<a href="#l10.186"></a><span id="l10.186">     mDatabase = nullptr;</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-  }</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-  else</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-  {</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; mailDBFactory(do_GetService(NS_MSGDB_SERVICE_CONTRACTID));</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-    if (mailDBFactory)</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-      mailDBFactory-&gt;ForceFolderDBClosed(this);</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+  } else {</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; mailDBFactory(</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID));</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+    if (mailDBFactory) mailDBFactory-&gt;ForceFolderDBClosed(this);</span>
<a href="#l10.197"></a><span id="l10.197">   }</span>
<a href="#l10.198"></a><span id="l10.198">   return NS_OK;</span>
<a href="#l10.199"></a><span id="l10.199"> }</span>
<a href="#l10.200"></a><span id="l10.200"> </span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CloseAndBackupFolderDB(const nsACString&amp; newName)</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-{</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CloseAndBackupFolderDB(const nsACString &amp;newName) {</span>
<a href="#l10.204"></a><span id="l10.204">   ForceDBClosed();</span>
<a href="#l10.205"></a><span id="l10.205"> </span>
<a href="#l10.206"></a><span id="l10.206">   // We only support backup for mail at the moment</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-  if ( !(mFlags &amp; nsMsgFolderFlags::Mail))</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+  if (!(mFlags &amp; nsMsgFolderFlags::Mail)) return NS_OK;</span>
<a href="#l10.210"></a><span id="l10.210"> </span>
<a href="#l10.211"></a><span id="l10.211">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l10.212"></a><span id="l10.212">   nsresult rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l10.213"></a><span id="l10.213">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.214"></a><span id="l10.214"> </span>
<a href="#l10.215"></a><span id="l10.215">   nsCOMPtr&lt;nsIFile&gt; dbFile;</span>
<a href="#l10.216"></a><span id="l10.216">   rv = GetSummaryFileLocation(folderPath, getter_AddRefs(dbFile));</span>
<a href="#l10.217"></a><span id="l10.217">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineat">@@ -262,44 +248,38 @@ NS_IMETHODIMP nsMsgDBFolder::CloseAndBac</span>
<a href="#l10.219"></a><span id="l10.219">   nsCOMPtr&lt;nsIFile&gt; backupDir;</span>
<a href="#l10.220"></a><span id="l10.220">   rv = CreateBackupDirectory(getter_AddRefs(backupDir));</span>
<a href="#l10.221"></a><span id="l10.221">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.222"></a><span id="l10.222"> </span>
<a href="#l10.223"></a><span id="l10.223">   nsCOMPtr&lt;nsIFile&gt; backupDBFile;</span>
<a href="#l10.224"></a><span id="l10.224">   rv = GetBackupSummaryFile(getter_AddRefs(backupDBFile), newName);</span>
<a href="#l10.225"></a><span id="l10.225">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.226"></a><span id="l10.226"> </span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-  if (mBackupDatabase)</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-  {</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+  if (mBackupDatabase) {</span>
<a href="#l10.230"></a><span id="l10.230">     mBackupDatabase-&gt;ForceClosed();</span>
<a href="#l10.231"></a><span id="l10.231">     mBackupDatabase = nullptr;</span>
<a href="#l10.232"></a><span id="l10.232">   }</span>
<a href="#l10.233"></a><span id="l10.233"> </span>
<a href="#l10.234"></a><span id="l10.234">   backupDBFile-&gt;Remove(false);</span>
<a href="#l10.235"></a><span id="l10.235">   bool backupExists;</span>
<a href="#l10.236"></a><span id="l10.236">   backupDBFile-&gt;Exists(&amp;backupExists);</span>
<a href="#l10.237"></a><span id="l10.237">   NS_ASSERTION(!backupExists, &quot;Couldn't delete database backup&quot;);</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-  if (backupExists)</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-  if (!newName.IsEmpty())</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-  {</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+  if (backupExists) return NS_ERROR_FAILURE;</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+  if (!newName.IsEmpty()) {</span>
<a href="#l10.246"></a><span id="l10.246">     nsAutoCString backupName;</span>
<a href="#l10.247"></a><span id="l10.247">     rv = backupDBFile-&gt;GetNativeLeafName(backupName);</span>
<a href="#l10.248"></a><span id="l10.248">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.249"></a><span id="l10.249">     return dbFile-&gt;CopyToNative(backupDir, backupName);</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-  }</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-  else</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+  } else</span>
<a href="#l10.253"></a><span id="l10.253">     return dbFile-&gt;CopyToNative(backupDir, EmptyCString());</span>
<a href="#l10.254"></a><span id="l10.254"> }</span>
<a href="#l10.255"></a><span id="l10.255"> </span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OpenBackupMsgDatabase()</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-{</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-  if (mBackupDatabase)</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OpenBackupMsgDatabase() {</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+  if (mBackupDatabase) return NS_OK;</span>
<a href="#l10.262"></a><span id="l10.262">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l10.263"></a><span id="l10.263">   nsresult rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l10.264"></a><span id="l10.264">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.265"></a><span id="l10.265"> </span>
<a href="#l10.266"></a><span id="l10.266">   nsAutoString folderName;</span>
<a href="#l10.267"></a><span id="l10.267">   rv = folderPath-&gt;GetLeafName(folderName);</span>
<a href="#l10.268"></a><span id="l10.268">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.269"></a><span id="l10.269"> </span>
<a href="#l10.270"></a><span id="l10.270" class="difflineat">@@ -313,32 +293,30 @@ NS_IMETHODIMP nsMsgDBFolder::OpenBackupM</span>
<a href="#l10.271"></a><span id="l10.271">   rv = CreateBackupDirectory(getter_AddRefs(backupDBDummyFolder));</span>
<a href="#l10.272"></a><span id="l10.272">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.273"></a><span id="l10.273">   rv = backupDBDummyFolder-&gt;Append(folderName);</span>
<a href="#l10.274"></a><span id="l10.274">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.275"></a><span id="l10.275"> </span>
<a href="#l10.276"></a><span id="l10.276">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l10.277"></a><span id="l10.277">       do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.278"></a><span id="l10.278">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-  rv = msgDBService-&gt;OpenMailDBFromFile(</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-      backupDBDummyFolder, this, false, true,</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-      getter_AddRefs(mBackupDatabase));</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-  // we add a listener so that we can close the db during OnAnnouncerGoingAway. There should</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-  // not be any other calls to the listener with the backup database</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mBackupDatabase)</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-    mBackupDatabase-&gt;AddListener(this);</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+  rv = msgDBService-&gt;OpenMailDBFromFile(backupDBDummyFolder, this, false, true,</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+                                        getter_AddRefs(mBackupDatabase));</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+  // we add a listener so that we can close the db during OnAnnouncerGoingAway.</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+  // There should not be any other calls to the listener with the backup</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+  // database</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mBackupDatabase) mBackupDatabase-&gt;AddListener(this);</span>
<a href="#l10.292"></a><span id="l10.292"> </span>
<a href="#l10.293"></a><span id="l10.293">   if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l10.294"></a><span id="l10.294">     // this is normal in reparsing</span>
<a href="#l10.295"></a><span id="l10.295">     rv = NS_OK;</span>
<a href="#l10.296"></a><span id="l10.296">   return rv;</span>
<a href="#l10.297"></a><span id="l10.297"> }</span>
<a href="#l10.298"></a><span id="l10.298"> </span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::RemoveBackupMsgDatabase()</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-{</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::RemoveBackupMsgDatabase() {</span>
<a href="#l10.302"></a><span id="l10.302">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l10.303"></a><span id="l10.303">   nsresult rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l10.304"></a><span id="l10.304">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.305"></a><span id="l10.305"> </span>
<a href="#l10.306"></a><span id="l10.306">   nsAutoString folderName;</span>
<a href="#l10.307"></a><span id="l10.307">   rv = folderPath-&gt;GetLeafName(folderName);</span>
<a href="#l10.308"></a><span id="l10.308">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.309"></a><span id="l10.309"> </span>
<a href="#l10.310"></a><span id="l10.310" class="difflineat">@@ -350,952 +328,862 @@ NS_IMETHODIMP nsMsgDBFolder::RemoveBacku</span>
<a href="#l10.311"></a><span id="l10.311">   // GetSummaryFileLocation to get the db file name</span>
<a href="#l10.312"></a><span id="l10.312">   nsCOMPtr&lt;nsIFile&gt; backupDBDummyFolder;</span>
<a href="#l10.313"></a><span id="l10.313">   rv = CreateBackupDirectory(getter_AddRefs(backupDBDummyFolder));</span>
<a href="#l10.314"></a><span id="l10.314">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.315"></a><span id="l10.315">   rv = backupDBDummyFolder-&gt;Append(folderName);</span>
<a href="#l10.316"></a><span id="l10.316">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.317"></a><span id="l10.317"> </span>
<a href="#l10.318"></a><span id="l10.318">   nsCOMPtr&lt;nsIFile&gt; backupDBFile;</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-  rv = GetSummaryFileLocation(backupDBDummyFolder, getter_AddRefs(backupDBFile));</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+  rv =</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+      GetSummaryFileLocation(backupDBDummyFolder, getter_AddRefs(backupDBFile));</span>
<a href="#l10.322"></a><span id="l10.322">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.323"></a><span id="l10.323"> </span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-  if (mBackupDatabase)</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-  {</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+  if (mBackupDatabase) {</span>
<a href="#l10.327"></a><span id="l10.327">     mBackupDatabase-&gt;ForceClosed();</span>
<a href="#l10.328"></a><span id="l10.328">     mBackupDatabase = nullptr;</span>
<a href="#l10.329"></a><span id="l10.329">   }</span>
<a href="#l10.330"></a><span id="l10.330"> </span>
<a href="#l10.331"></a><span id="l10.331">   return backupDBFile-&gt;Remove(false);</span>
<a href="#l10.332"></a><span id="l10.332"> }</span>
<a href="#l10.333"></a><span id="l10.333"> </span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::StartFolderLoading(void)</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-{</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-  if(mDatabase)</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-    mDatabase-&gt;RemoveListener(this);</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::StartFolderLoading(void) {</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+  if (mDatabase) mDatabase-&gt;RemoveListener(this);</span>
<a href="#l10.340"></a><span id="l10.340">   mAddListener = false;</span>
<a href="#l10.341"></a><span id="l10.341">   return NS_OK;</span>
<a href="#l10.342"></a><span id="l10.342"> }</span>
<a href="#l10.343"></a><span id="l10.343"> </span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::EndFolderLoading(void)</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-{</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-  if(mDatabase)</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-    mDatabase-&gt;AddListener(this);</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::EndFolderLoading(void) {</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+  if (mDatabase) mDatabase-&gt;AddListener(this);</span>
<a href="#l10.350"></a><span id="l10.350">   mAddListener = true;</span>
<a href="#l10.351"></a><span id="l10.351">   UpdateSummaryTotals(true);</span>
<a href="#l10.352"></a><span id="l10.352"> </span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-  //GGGG       check for new mail here and call SetNewMessages...?? -- ONE OF THE 2 PLACES</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-  if(mDatabase)</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-    m_newMsgs.Clear();</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+  // GGGG       check for new mail here and call SetNewMessages...?? -- ONE OF</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+  // THE 2 PLACES</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+  if (mDatabase) m_newMsgs.Clear();</span>
<a href="#l10.359"></a><span id="l10.359"> </span>
<a href="#l10.360"></a><span id="l10.360">   return NS_OK;</span>
<a href="#l10.361"></a><span id="l10.361"> }</span>
<a href="#l10.362"></a><span id="l10.362"> </span>
<a href="#l10.363"></a><span id="l10.363"> NS_IMETHODIMP</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-nsMsgDBFolder::GetExpungedBytes(int64_t *count)</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-{</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+nsMsgDBFolder::GetExpungedBytes(int64_t *count) {</span>
<a href="#l10.367"></a><span id="l10.367">   NS_ENSURE_ARG_POINTER(count);</span>
<a href="#l10.368"></a><span id="l10.368"> </span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-  {</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.372"></a><span id="l10.372">     nsresult rv;</span>
<a href="#l10.373"></a><span id="l10.373">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.374"></a><span id="l10.374">     rv = mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l10.375"></a><span id="l10.375">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.376"></a><span id="l10.376">     rv = folderInfo-&gt;GetExpungedBytes(count);</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineminus">-      mExpungedBytes = *count; // sync up with the database</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+    if (NS_SUCCEEDED(rv)) mExpungedBytes = *count;  // sync up with the database</span>
<a href="#l10.380"></a><span id="l10.380">     return rv;</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineminus">-  }</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-  else</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineminus">-  {</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+  } else {</span>
<a href="#l10.385"></a><span id="l10.385">     ReadDBFolderInfo(false);</span>
<a href="#l10.386"></a><span id="l10.386">     *count = mExpungedBytes;</span>
<a href="#l10.387"></a><span id="l10.387">   }</span>
<a href="#l10.388"></a><span id="l10.388">   return NS_OK;</span>
<a href="#l10.389"></a><span id="l10.389"> }</span>
<a href="#l10.390"></a><span id="l10.390"> </span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetCharset(nsACString&amp; aCharset)</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-{</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetCharset(nsACString &amp;aCharset) {</span>
<a href="#l10.395"></a><span id="l10.395">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.396"></a><span id="l10.396">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-  nsresult rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-    rv = folderInfo-&gt;GetEffectiveCharacterSet(aCharset);</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+  nsresult rv =</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+      GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = folderInfo-&gt;GetEffectiveCharacterSet(aCharset);</span>
<a href="#l10.403"></a><span id="l10.403">   return rv;</span>
<a href="#l10.404"></a><span id="l10.404"> }</span>
<a href="#l10.405"></a><span id="l10.405"> </span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetCharset(const nsACString&amp; aCharset)</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-{</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetCharset(const nsACString &amp;aCharset) {</span>
<a href="#l10.409"></a><span id="l10.409">   nsresult rv;</span>
<a href="#l10.410"></a><span id="l10.410"> </span>
<a href="#l10.411"></a><span id="l10.411">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.412"></a><span id="l10.412">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.413"></a><span id="l10.413">   rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-  {</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.417"></a><span id="l10.417">     rv = folderInfo-&gt;SetCharacterSet(aCharset);</span>
<a href="#l10.418"></a><span id="l10.418">     db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.419"></a><span id="l10.419">     mCharset = aCharset;</span>
<a href="#l10.420"></a><span id="l10.420">   }</span>
<a href="#l10.421"></a><span id="l10.421">   return rv;</span>
<a href="#l10.422"></a><span id="l10.422"> }</span>
<a href="#l10.423"></a><span id="l10.423"> </span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetCharsetOverride(bool *aCharsetOverride)</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-{</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetCharsetOverride(bool *aCharsetOverride) {</span>
<a href="#l10.427"></a><span id="l10.427">   NS_ENSURE_ARG_POINTER(aCharsetOverride);</span>
<a href="#l10.428"></a><span id="l10.428">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.429"></a><span id="l10.429">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-  nsresult rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineplus">+  nsresult rv =</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineplus">+      GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.435"></a><span id="l10.435">     rv = folderInfo-&gt;GetCharacterSetOverride(aCharsetOverride);</span>
<a href="#l10.436"></a><span id="l10.436">   return rv;</span>
<a href="#l10.437"></a><span id="l10.437"> }</span>
<a href="#l10.438"></a><span id="l10.438"> </span>
<a href="#l10.439"></a><span id="l10.439" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetCharsetOverride(bool aCharsetOverride)</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-{</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetCharsetOverride(bool aCharsetOverride) {</span>
<a href="#l10.442"></a><span id="l10.442">   nsresult rv;</span>
<a href="#l10.443"></a><span id="l10.443">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.444"></a><span id="l10.444">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.445"></a><span id="l10.445">   rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-  {</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.449"></a><span id="l10.449">     rv = folderInfo-&gt;SetCharacterSetOverride(aCharsetOverride);</span>
<a href="#l10.450"></a><span id="l10.450">     db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.451"></a><span id="l10.451">     mCharsetOverride = aCharsetOverride;  // synchronize member variable</span>
<a href="#l10.452"></a><span id="l10.452">   }</span>
<a href="#l10.453"></a><span id="l10.453">   return rv;</span>
<a href="#l10.454"></a><span id="l10.454"> }</span>
<a href="#l10.455"></a><span id="l10.455"> </span>
<a href="#l10.456"></a><span id="l10.456" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetHasNewMessages(bool *hasNewMessages)</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-{</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetHasNewMessages(bool *hasNewMessages) {</span>
<a href="#l10.459"></a><span id="l10.459">   NS_ENSURE_ARG_POINTER(hasNewMessages);</span>
<a href="#l10.460"></a><span id="l10.460">   *hasNewMessages = mNewMessages;</span>
<a href="#l10.461"></a><span id="l10.461">   return NS_OK;</span>
<a href="#l10.462"></a><span id="l10.462"> }</span>
<a href="#l10.463"></a><span id="l10.463"> </span>
<a href="#l10.464"></a><span id="l10.464" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetHasNewMessages(bool curNewMessages)</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-{</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-  if (curNewMessages != mNewMessages)</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-  {</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetHasNewMessages(bool curNewMessages) {</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+  if (curNewMessages != mNewMessages) {</span>
<a href="#l10.470"></a><span id="l10.470">     // Only change mru time if we're going from doesn't have new to has new.</span>
<a href="#l10.471"></a><span id="l10.471">     // technically, we should probably update mru time for every new message</span>
<a href="#l10.472"></a><span id="l10.472">     // but we would pay a performance penalty for that. If the user</span>
<a href="#l10.473"></a><span id="l10.473">     // opens the folder, the mrutime will get updated anyway.</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineminus">-    if (curNewMessages)</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-      SetMRUTime();</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+    if (curNewMessages) SetMRUTime();</span>
<a href="#l10.477"></a><span id="l10.477">     bool oldNewMessages = mNewMessages;</span>
<a href="#l10.478"></a><span id="l10.478">     mNewMessages = curNewMessages;</span>
<a href="#l10.479"></a><span id="l10.479">     NotifyBoolPropertyChanged(kNewMessages, oldNewMessages, curNewMessages);</span>
<a href="#l10.480"></a><span id="l10.480">   }</span>
<a href="#l10.481"></a><span id="l10.481"> </span>
<a href="#l10.482"></a><span id="l10.482">   return NS_OK;</span>
<a href="#l10.483"></a><span id="l10.483"> }</span>
<a href="#l10.484"></a><span id="l10.484"> </span>
<a href="#l10.485"></a><span id="l10.485" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetHasFolderOrSubfolderNewMessages(bool *aResult)</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineminus">-{</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetHasFolderOrSubfolderNewMessages(bool *aResult) {</span>
<a href="#l10.488"></a><span id="l10.488">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.489"></a><span id="l10.489">   bool hasNewMessages = mNewMessages;</span>
<a href="#l10.490"></a><span id="l10.490"> </span>
<a href="#l10.491"></a><span id="l10.491" class="difflineminus">-  if (!hasNewMessages)</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineminus">-  {</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+  if (!hasNewMessages) {</span>
<a href="#l10.494"></a><span id="l10.494">     int32_t count = mSubFolders.Count();</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-    for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-    {</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+    for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.498"></a><span id="l10.498">       bool hasNew = false;</span>
<a href="#l10.499"></a><span id="l10.499">       mSubFolders[i]-&gt;GetHasFolderOrSubfolderNewMessages(&amp;hasNew);</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-      if (hasNew)</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineminus">-      {</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+      if (hasNew) {</span>
<a href="#l10.503"></a><span id="l10.503">         hasNewMessages = true;</span>
<a href="#l10.504"></a><span id="l10.504">         break;</span>
<a href="#l10.505"></a><span id="l10.505">       }</span>
<a href="#l10.506"></a><span id="l10.506">     }</span>
<a href="#l10.507"></a><span id="l10.507">   }</span>
<a href="#l10.508"></a><span id="l10.508"> </span>
<a href="#l10.509"></a><span id="l10.509">   *aResult = hasNewMessages;</span>
<a href="#l10.510"></a><span id="l10.510">   return NS_OK;</span>
<a href="#l10.511"></a><span id="l10.511"> }</span>
<a href="#l10.512"></a><span id="l10.512"> </span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetGettingNewMessages(bool *gettingNewMessages)</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-{</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetGettingNewMessages(bool *gettingNewMessages) {</span>
<a href="#l10.516"></a><span id="l10.516">   NS_ENSURE_ARG_POINTER(gettingNewMessages);</span>
<a href="#l10.517"></a><span id="l10.517">   *gettingNewMessages = mGettingNewMessages;</span>
<a href="#l10.518"></a><span id="l10.518">   return NS_OK;</span>
<a href="#l10.519"></a><span id="l10.519"> }</span>
<a href="#l10.520"></a><span id="l10.520"> </span>
<a href="#l10.521"></a><span id="l10.521" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetGettingNewMessages(bool gettingNewMessages)</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineminus">-{</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetGettingNewMessages(bool gettingNewMessages) {</span>
<a href="#l10.524"></a><span id="l10.524">   mGettingNewMessages = gettingNewMessages;</span>
<a href="#l10.525"></a><span id="l10.525">   return NS_OK;</span>
<a href="#l10.526"></a><span id="l10.526"> }</span>
<a href="#l10.527"></a><span id="l10.527"> </span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetFirstNewMessage(nsIMsgDBHdr **firstNewMessage)</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineminus">-{</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineminus">-  //If there's not a db then there can't be new messages.  Return failure since you</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineminus">-  //should use HasNewMessages first.</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineminus">-  if(!mDatabase)</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetFirstNewMessage(nsIMsgDBHdr **firstNewMessage) {</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+  // If there's not a db then there can't be new messages.  Return failure since</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineplus">+  // you should use HasNewMessages first.</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+  if (!mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l10.538"></a><span id="l10.538"> </span>
<a href="#l10.539"></a><span id="l10.539">   nsresult rv;</span>
<a href="#l10.540"></a><span id="l10.540">   nsMsgKey key;</span>
<a href="#l10.541"></a><span id="l10.541">   rv = mDatabase-&gt;GetFirstNew(&amp;key);</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineminus">-  if(NS_FAILED(rv))</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineminus">-    return rv;</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.545"></a><span id="l10.545"> </span>
<a href="#l10.546"></a><span id="l10.546">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l10.547"></a><span id="l10.547">   rv = mDatabase-&gt;GetMsgHdrForKey(key, getter_AddRefs(hdr));</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineminus">-  if(NS_FAILED(rv))</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineminus">-    return rv;</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineminus">-</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-  return  mDatabase-&gt;GetMsgHdrForKey(key, firstNewMessage);</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-}</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ClearNewMessages()</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineminus">-{</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineplus">+</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+  return mDatabase-&gt;GetMsgHdrForKey(key, firstNewMessage);</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineplus">+}</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineplus">+</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ClearNewMessages() {</span>
<a href="#l10.562"></a><span id="l10.562">   nsresult rv = NS_OK;</span>
<a href="#l10.563"></a><span id="l10.563">   bool dbWasCached = mDatabase != nullptr;</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineminus">-  if (!dbWasCached)</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-    GetDatabase();</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-  {</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineplus">+  if (!dbWasCached) GetDatabase();</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineplus">+</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.572"></a><span id="l10.572">     uint32_t numNewKeys;</span>
<a href="#l10.573"></a><span id="l10.573">     nsMsgKey *newMessageKeys;</span>
<a href="#l10.574"></a><span id="l10.574">     rv = mDatabase-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; newMessageKeys)</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineminus">-    {</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; newMessageKeys) {</span>
<a href="#l10.578"></a><span id="l10.578">       m_saveNewMsgs.Clear();</span>
<a href="#l10.579"></a><span id="l10.579">       m_saveNewMsgs.AppendElements(newMessageKeys, numNewKeys);</span>
<a href="#l10.580"></a><span id="l10.580">       free(newMessageKeys);</span>
<a href="#l10.581"></a><span id="l10.581">     }</span>
<a href="#l10.582"></a><span id="l10.582">     mDatabase-&gt;ClearNewList(true);</span>
<a href="#l10.583"></a><span id="l10.583">   }</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineminus">-  if (!dbWasCached)</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-    SetMsgDatabase(nullptr);</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+  if (!dbWasCached) SetMsgDatabase(nullptr);</span>
<a href="#l10.587"></a><span id="l10.587"> </span>
<a href="#l10.588"></a><span id="l10.588">   m_newMsgs.Clear();</span>
<a href="#l10.589"></a><span id="l10.589">   mNumNewBiffMessages = 0;</span>
<a href="#l10.590"></a><span id="l10.590">   return rv;</span>
<a href="#l10.591"></a><span id="l10.591"> }</span>
<a href="#l10.592"></a><span id="l10.592"> </span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-void nsMsgDBFolder::UpdateNewMessages()</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-{</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-  if (! (mFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-  {</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+void nsMsgDBFolder::UpdateNewMessages() {</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+  if (!(mFlags &amp; nsMsgFolderFlags::Virtual)) {</span>
<a href="#l10.599"></a><span id="l10.599">     bool hasNewMessages = false;</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineminus">-    for (uint32_t keyIndex = 0; keyIndex &lt; m_newMsgs.Length(); keyIndex++)</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-    {</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+    for (uint32_t keyIndex = 0; keyIndex &lt; m_newMsgs.Length(); keyIndex++) {</span>
<a href="#l10.603"></a><span id="l10.603">       bool containsKey = false;</span>
<a href="#l10.604"></a><span id="l10.604">       mDatabase-&gt;ContainsKey(m_newMsgs[keyIndex], &amp;containsKey);</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-      if (!containsKey)</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-        continue;</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+      if (!containsKey) continue;</span>
<a href="#l10.608"></a><span id="l10.608">       bool isRead = false;</span>
<a href="#l10.609"></a><span id="l10.609">       nsresult rv2 = mDatabase-&gt;IsRead(m_newMsgs[keyIndex], &amp;isRead);</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-      if (NS_SUCCEEDED(rv2) &amp;&amp; !isRead)</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-      {</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineplus">+      if (NS_SUCCEEDED(rv2) &amp;&amp; !isRead) {</span>
<a href="#l10.613"></a><span id="l10.613">         hasNewMessages = true;</span>
<a href="#l10.614"></a><span id="l10.614">         mDatabase-&gt;AddToNewList(m_newMsgs[keyIndex]);</span>
<a href="#l10.615"></a><span id="l10.615">       }</span>
<a href="#l10.616"></a><span id="l10.616">     }</span>
<a href="#l10.617"></a><span id="l10.617">     SetHasNewMessages(hasNewMessages);</span>
<a href="#l10.618"></a><span id="l10.618">   }</span>
<a href="#l10.619"></a><span id="l10.619"> }</span>
<a href="#l10.620"></a><span id="l10.620"> </span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-// helper function that gets the cache element that corresponds to the passed in file spec.</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-// This could be static, or could live in another class - it's not specific to the current</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-// nsMsgDBFolder. If it lived at a higher level, we could cache the account manager and folder cache.</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-nsresult nsMsgDBFolder::GetFolderCacheElemFromFile(nsIFile *file, nsIMsgFolderCacheElement **cacheElement)</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-{</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineplus">+// helper function that gets the cache element that corresponds to the passed in</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+// file spec. This could be static, or could live in another class - it's not</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineplus">+// specific to the current nsMsgDBFolder. If it lived at a higher level, we</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineplus">+// could cache the account manager and folder cache.</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+nsresult nsMsgDBFolder::GetFolderCacheElemFromFile(</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineplus">+    nsIFile *file, nsIMsgFolderCacheElement **cacheElement) {</span>
<a href="#l10.632"></a><span id="l10.632">   nsresult result;</span>
<a href="#l10.633"></a><span id="l10.633">   NS_ENSURE_ARG_POINTER(file);</span>
<a href="#l10.634"></a><span id="l10.634">   NS_ENSURE_ARG_POINTER(cacheElement);</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolderCache&gt; folderCache;</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCache&gt; folderCache;</span>
<a href="#l10.637"></a><span id="l10.637"> #ifdef DEBUG_bienvenu1</span>
<a href="#l10.638"></a><span id="l10.638">   bool exists;</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(fileSpec-&gt;Exists(&amp;exists)) &amp;&amp; exists, &quot;whoops, file doesn't exist, mac will break&quot;);</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(fileSpec-&gt;Exists(&amp;exists)) &amp;&amp; exists,</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineplus">+               &quot;whoops, file doesn't exist, mac will break&quot;);</span>
<a href="#l10.642"></a><span id="l10.642"> #endif</span>
<a href="#l10.643"></a><span id="l10.643">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;result);</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineminus">-  if(NS_SUCCEEDED(result))</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineminus">-  {</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;result);</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineplus">+  if (NS_SUCCEEDED(result)) {</span>
<a href="#l10.649"></a><span id="l10.649">     result = accountMgr-&gt;GetFolderCache(getter_AddRefs(folderCache));</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-    if (NS_SUCCEEDED(result) &amp;&amp; folderCache)</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineminus">-    {</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineplus">+    if (NS_SUCCEEDED(result) &amp;&amp; folderCache) {</span>
<a href="#l10.653"></a><span id="l10.653">       nsCString persistentPath;</span>
<a href="#l10.654"></a><span id="l10.654">       result = file-&gt;GetPersistentDescriptor(persistentPath);</span>
<a href="#l10.655"></a><span id="l10.655">       NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineminus">-      result = folderCache-&gt;GetCacheElement(persistentPath, false, cacheElement);</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineplus">+      result =</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineplus">+          folderCache-&gt;GetCacheElement(persistentPath, false, cacheElement);</span>
<a href="#l10.659"></a><span id="l10.659">     }</span>
<a href="#l10.660"></a><span id="l10.660">   }</span>
<a href="#l10.661"></a><span id="l10.661">   return result;</span>
<a href="#l10.662"></a><span id="l10.662"> }</span>
<a href="#l10.663"></a><span id="l10.663"> </span>
<a href="#l10.664"></a><span id="l10.664" class="difflineminus">-nsresult nsMsgDBFolder::ReadDBFolderInfo(bool force)</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineminus">-{</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineplus">+nsresult nsMsgDBFolder::ReadDBFolderInfo(bool force) {</span>
<a href="#l10.667"></a><span id="l10.667">   // Since it turns out to be pretty expensive to open and close</span>
<a href="#l10.668"></a><span id="l10.668">   // the DBs all the time, if we have to open it once, get everything</span>
<a href="#l10.669"></a><span id="l10.669">   // we might need while we're here</span>
<a href="#l10.670"></a><span id="l10.670">   nsresult result = NS_OK;</span>
<a href="#l10.671"></a><span id="l10.671"> </span>
<a href="#l10.672"></a><span id="l10.672">   // don't need to reload from cache if we've already read from cache,</span>
<a href="#l10.673"></a><span id="l10.673">   // and, we might get stale info, so don't do it.</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineminus">-  if (!mInitializedFromCache)</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineminus">-  {</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; dbPath;</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineminus">-    result = GetFolderCacheKey(getter_AddRefs(dbPath), true /* createDBIfMissing */);</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineminus">-    if (dbPath)</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineminus">-    {</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineplus">+  if (!mInitializedFromCache) {</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineplus">+    result =</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineplus">+        GetFolderCacheKey(getter_AddRefs(dbPath), true /* createDBIfMissing */);</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+    if (dbPath) {</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.687"></a><span id="l10.687">       result = GetFolderCacheElemFromFile(dbPath, getter_AddRefs(cacheElement));</span>
<a href="#l10.688"></a><span id="l10.688">       if (NS_SUCCEEDED(result) &amp;&amp; cacheElement)</span>
<a href="#l10.689"></a><span id="l10.689">         result = ReadFromFolderCacheElem(cacheElement);</span>
<a href="#l10.690"></a><span id="l10.690">     }</span>
<a href="#l10.691"></a><span id="l10.691">   }</span>
<a href="#l10.692"></a><span id="l10.692"> </span>
<a href="#l10.693"></a><span id="l10.693" class="difflineminus">-  if (force || !mInitializedFromCache)</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineminus">-  {</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineplus">+  if (force || !mInitializedFromCache) {</span>
<a href="#l10.696"></a><span id="l10.696">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.697"></a><span id="l10.697">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineminus">-    result = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineminus">-    if(NS_SUCCEEDED(result))</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineminus">-    {</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineminus">-      if (folderInfo)</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineminus">-      {</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineminus">-        if (!mInitializedFromCache)</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineminus">-        {</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineplus">+    result =</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineplus">+        GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineplus">+    if (NS_SUCCEEDED(result)) {</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineplus">+      if (folderInfo) {</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+        if (!mInitializedFromCache) {</span>
<a href="#l10.710"></a><span id="l10.710">           folderInfo-&gt;GetFlags((int32_t *)&amp;mFlags);</span>
<a href="#l10.711"></a><span id="l10.711"> #ifdef DEBUG_bienvenu1</span>
<a href="#l10.712"></a><span id="l10.712">           nsString name;</span>
<a href="#l10.713"></a><span id="l10.713">           GetName(name);</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineminus">-          NS_ASSERTION(Compare(name, kLocalizedTrashName) || (mFlags &amp; nsMsgFolderFlags::Trash), &quot;lost trash flag&quot;);</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+          NS_ASSERTION(Compare(name, kLocalizedTrashName) ||</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+                           (mFlags &amp; nsMsgFolderFlags::Trash),</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineplus">+                       &quot;lost trash flag&quot;);</span>
<a href="#l10.718"></a><span id="l10.718"> #endif</span>
<a href="#l10.719"></a><span id="l10.719">           mInitializedFromCache = true;</span>
<a href="#l10.720"></a><span id="l10.720">         }</span>
<a href="#l10.721"></a><span id="l10.721"> </span>
<a href="#l10.722"></a><span id="l10.722">         folderInfo-&gt;GetNumMessages(&amp;mNumTotalMessages);</span>
<a href="#l10.723"></a><span id="l10.723">         folderInfo-&gt;GetNumUnreadMessages(&amp;mNumUnreadMessages);</span>
<a href="#l10.724"></a><span id="l10.724">         folderInfo-&gt;GetExpungedBytes(&amp;mExpungedBytes);</span>
<a href="#l10.725"></a><span id="l10.725"> </span>
<a href="#l10.726"></a><span id="l10.726">         nsCString utf8Name;</span>
<a href="#l10.727"></a><span id="l10.727">         folderInfo-&gt;GetFolderName(utf8Name);</span>
<a href="#l10.728"></a><span id="l10.728" class="difflineminus">-        if (!utf8Name.IsEmpty())</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineminus">-          CopyUTF8toUTF16(utf8Name, mName);</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineminus">-</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineminus">-        //These should be put in IMAP folder only.</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineminus">-        //folderInfo-&gt;GetImapTotalPendingMessages(&amp;mNumPendingTotalMessages);</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineminus">-        //folderInfo-&gt;GetImapUnreadPendingMessages(&amp;mNumPendingUnreadMessages);</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineplus">+        if (!utf8Name.IsEmpty()) CopyUTF8toUTF16(utf8Name, mName);</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineplus">+</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineplus">+        // These should be put in IMAP folder only.</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineplus">+        // folderInfo-&gt;GetImapTotalPendingMessages(&amp;mNumPendingTotalMessages);</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineplus">+        // folderInfo-&gt;GetImapUnreadPendingMessages(&amp;mNumPendingUnreadMessages);</span>
<a href="#l10.739"></a><span id="l10.739"> </span>
<a href="#l10.740"></a><span id="l10.740">         folderInfo-&gt;GetCharacterSet(mCharset);</span>
<a href="#l10.741"></a><span id="l10.741">         folderInfo-&gt;GetCharacterSetOverride(&amp;mCharsetOverride);</span>
<a href="#l10.742"></a><span id="l10.742"> </span>
<a href="#l10.743"></a><span id="l10.743">         if (db) {</span>
<a href="#l10.744"></a><span id="l10.744">           bool hasnew;</span>
<a href="#l10.745"></a><span id="l10.745">           nsresult rv;</span>
<a href="#l10.746"></a><span id="l10.746">           rv = db-&gt;HasNew(&amp;hasnew);</span>
<a href="#l10.747"></a><span id="l10.747">           if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.748"></a><span id="l10.748">         }</span>
<a href="#l10.749"></a><span id="l10.749">       }</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineminus">-    }</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineminus">-    else {</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineplus">+    } else {</span>
<a href="#l10.753"></a><span id="l10.753">       // we tried to open DB but failed - don't keep trying.</span>
<a href="#l10.754"></a><span id="l10.754">       // If a DB is created, we will call this method with force == TRUE,</span>
<a href="#l10.755"></a><span id="l10.755">       // and read from the db that way.</span>
<a href="#l10.756"></a><span id="l10.756">       mInitializedFromCache = true;</span>
<a href="#l10.757"></a><span id="l10.757">     }</span>
<a href="#l10.758"></a><span id="l10.758" class="difflineminus">-    if (db)</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineminus">-      db-&gt;Close(false);</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineplus">+    if (db) db-&gt;Close(false);</span>
<a href="#l10.761"></a><span id="l10.761">   }</span>
<a href="#l10.762"></a><span id="l10.762">   return result;</span>
<a href="#l10.763"></a><span id="l10.763"> }</span>
<a href="#l10.764"></a><span id="l10.764"> </span>
<a href="#l10.765"></a><span id="l10.765" class="difflineminus">-nsresult nsMsgDBFolder::SendFlagNotifications(nsIMsgDBHdr *item, uint32_t oldFlags, uint32_t newFlags)</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineminus">-{</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineplus">+nsresult nsMsgDBFolder::SendFlagNotifications(nsIMsgDBHdr *item,</span>
<a href="#l10.768"></a><span id="l10.768" class="difflineplus">+                                              uint32_t oldFlags,</span>
<a href="#l10.769"></a><span id="l10.769" class="difflineplus">+                                              uint32_t newFlags) {</span>
<a href="#l10.770"></a><span id="l10.770">   nsresult rv = NS_OK;</span>
<a href="#l10.771"></a><span id="l10.771">   uint32_t changedFlags = oldFlags ^ newFlags;</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineminus">-  if((changedFlags &amp; nsMsgMessageFlags::Read)  &amp;&amp; (changedFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineminus">-  {</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineminus">-    //..so..if the msg is read in the folder and the folder has new msgs clear the account level and status bar biffs.</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineplus">+  if ((changedFlags &amp; nsMsgMessageFlags::Read) &amp;&amp;</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineplus">+      (changedFlags &amp; nsMsgMessageFlags::New)) {</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineplus">+    //..so..if the msg is read in the folder and the folder has new msgs clear</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineplus">+    // the account level and status bar biffs.</span>
<a href="#l10.779"></a><span id="l10.779">     rv = NotifyPropertyFlagChanged(item, kStatus, oldFlags, newFlags);</span>
<a href="#l10.780"></a><span id="l10.780">     rv = SetBiffState(nsMsgBiffState_NoMail);</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineminus">-  }</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineminus">-  else if(changedFlags &amp; (nsMsgMessageFlags::Read | nsMsgMessageFlags::Replied | nsMsgMessageFlags::Forwarded</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineminus">-    | nsMsgMessageFlags::IMAPDeleted | nsMsgMessageFlags::New | nsMsgMessageFlags::Offline))</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineplus">+  } else if (changedFlags &amp;</span>
<a href="#l10.785"></a><span id="l10.785" class="difflineplus">+             (nsMsgMessageFlags::Read | nsMsgMessageFlags::Replied |</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineplus">+              nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::IMAPDeleted |</span>
<a href="#l10.787"></a><span id="l10.787" class="difflineplus">+              nsMsgMessageFlags::New | nsMsgMessageFlags::Offline))</span>
<a href="#l10.788"></a><span id="l10.788">     rv = NotifyPropertyFlagChanged(item, kStatus, oldFlags, newFlags);</span>
<a href="#l10.789"></a><span id="l10.789" class="difflineminus">-  else if((changedFlags &amp; nsMsgMessageFlags::Marked))</span>
<a href="#l10.790"></a><span id="l10.790" class="difflineplus">+  else if ((changedFlags &amp; nsMsgMessageFlags::Marked))</span>
<a href="#l10.791"></a><span id="l10.791">     rv = NotifyPropertyFlagChanged(item, kFlagged, oldFlags, newFlags);</span>
<a href="#l10.792"></a><span id="l10.792">   return rv;</span>
<a href="#l10.793"></a><span id="l10.793"> }</span>
<a href="#l10.794"></a><span id="l10.794"> </span>
<a href="#l10.795"></a><span id="l10.795" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::DownloadMessagesForOffline(nsIArray *messages, nsIMsgWindow *)</span>
<a href="#l10.796"></a><span id="l10.796" class="difflineminus">-{</span>
<a href="#l10.797"></a><span id="l10.797" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::DownloadMessagesForOffline(nsIArray *messages,</span>
<a href="#l10.798"></a><span id="l10.798" class="difflineplus">+                                                        nsIMsgWindow *) {</span>
<a href="#l10.799"></a><span id="l10.799">   NS_ASSERTION(false, &quot;imap and news need to override this&quot;);</span>
<a href="#l10.800"></a><span id="l10.800">   return NS_OK;</span>
<a href="#l10.801"></a><span id="l10.801"> }</span>
<a href="#l10.802"></a><span id="l10.802"> </span>
<a href="#l10.803"></a><span id="l10.803" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::DownloadAllForOffline(nsIUrlListener *listener, nsIMsgWindow *msgWindow)</span>
<a href="#l10.804"></a><span id="l10.804" class="difflineminus">-{</span>
<a href="#l10.805"></a><span id="l10.805" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::DownloadAllForOffline(nsIUrlListener *listener,</span>
<a href="#l10.806"></a><span id="l10.806" class="difflineplus">+                                                   nsIMsgWindow *msgWindow) {</span>
<a href="#l10.807"></a><span id="l10.807">   NS_ASSERTION(false, &quot;imap and news need to override this&quot;);</span>
<a href="#l10.808"></a><span id="l10.808">   return NS_OK;</span>
<a href="#l10.809"></a><span id="l10.809"> }</span>
<a href="#l10.810"></a><span id="l10.810"> </span>
<a href="#l10.811"></a><span id="l10.811" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetMsgStore(nsIMsgPluggableStore **aStore)</span>
<a href="#l10.812"></a><span id="l10.812" class="difflineminus">-{</span>
<a href="#l10.813"></a><span id="l10.813" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetMsgStore(nsIMsgPluggableStore **aStore) {</span>
<a href="#l10.814"></a><span id="l10.814">   NS_ENSURE_ARG_POINTER(aStore);</span>
<a href="#l10.815"></a><span id="l10.815">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.816"></a><span id="l10.816">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.817"></a><span id="l10.817">   NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l10.818"></a><span id="l10.818">   return server-&gt;GetMsgStore(aStore);</span>
<a href="#l10.819"></a><span id="l10.819"> }</span>
<a href="#l10.820"></a><span id="l10.820"> </span>
<a href="#l10.821"></a><span id="l10.821" class="difflineminus">-bool nsMsgDBFolder::VerifyOfflineMessage(nsIMsgDBHdr *msgHdr, nsIInputStream *fileStream)</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineminus">-{</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l10.824"></a><span id="l10.824" class="difflineminus">-  if (seekableStream)</span>
<a href="#l10.825"></a><span id="l10.825" class="difflineminus">-  {</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineplus">+bool nsMsgDBFolder::VerifyOfflineMessage(nsIMsgDBHdr *msgHdr,</span>
<a href="#l10.827"></a><span id="l10.827" class="difflineplus">+                                         nsIInputStream *fileStream) {</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l10.829"></a><span id="l10.829" class="difflineplus">+  if (seekableStream) {</span>
<a href="#l10.830"></a><span id="l10.830">     uint64_t offset;</span>
<a href="#l10.831"></a><span id="l10.831">     msgHdr-&gt;GetMessageOffset(&amp;offset);</span>
<a href="#l10.832"></a><span id="l10.832">     nsresult rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, offset);</span>
<a href="#l10.833"></a><span id="l10.833">     char startOfMsg[100];</span>
<a href="#l10.834"></a><span id="l10.834">     uint32_t bytesRead = 0;</span>
<a href="#l10.835"></a><span id="l10.835">     uint32_t bytesToRead = sizeof(startOfMsg) - 1;</span>
<a href="#l10.836"></a><span id="l10.836">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.837"></a><span id="l10.837">       rv = fileStream-&gt;Read(startOfMsg, bytesToRead, &amp;bytesRead);</span>
<a href="#l10.838"></a><span id="l10.838">     startOfMsg[bytesRead] = '\0';</span>
<a href="#l10.839"></a><span id="l10.839">     // check if message starts with From, or is a draft and starts with FCC</span>
<a href="#l10.840"></a><span id="l10.840">     if (NS_FAILED(rv) || bytesRead != bytesToRead ||</span>
<a href="#l10.841"></a><span id="l10.841" class="difflineminus">-      (strncmp(startOfMsg, &quot;From &quot;, 5) &amp;&amp; (! (mFlags &amp; nsMsgFolderFlags::Drafts) || strncmp(startOfMsg, &quot;FCC&quot;, 3))))</span>
<a href="#l10.842"></a><span id="l10.842" class="difflineplus">+        (strncmp(startOfMsg, &quot;From &quot;, 5) &amp;&amp;</span>
<a href="#l10.843"></a><span id="l10.843" class="difflineplus">+         (!(mFlags &amp; nsMsgFolderFlags::Drafts) ||</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineplus">+          strncmp(startOfMsg, &quot;FCC&quot;, 3))))</span>
<a href="#l10.845"></a><span id="l10.845">       return false;</span>
<a href="#l10.846"></a><span id="l10.846">   }</span>
<a href="#l10.847"></a><span id="l10.847">   return true;</span>
<a href="#l10.848"></a><span id="l10.848"> }</span>
<a href="#l10.849"></a><span id="l10.849"> </span>
<a href="#l10.850"></a><span id="l10.850" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetOfflineFileStream(nsMsgKey msgKey, int64_t *offset, uint32_t *size, nsIInputStream **aFileStream)</span>
<a href="#l10.851"></a><span id="l10.851" class="difflineminus">-{</span>
<a href="#l10.852"></a><span id="l10.852" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetOfflineFileStream(</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineplus">+    nsMsgKey msgKey, int64_t *offset, uint32_t *size,</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineplus">+    nsIInputStream **aFileStream) {</span>
<a href="#l10.855"></a><span id="l10.855">   NS_ENSURE_ARG(aFileStream);</span>
<a href="#l10.856"></a><span id="l10.856"> </span>
<a href="#l10.857"></a><span id="l10.857">   *offset = *size = 0;</span>
<a href="#l10.858"></a><span id="l10.858"> </span>
<a href="#l10.859"></a><span id="l10.859">   nsresult rv = GetDatabase();</span>
<a href="#l10.860"></a><span id="l10.860">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l10.861"></a><span id="l10.861">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l10.862"></a><span id="l10.862">   rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l10.863"></a><span id="l10.863">   NS_ENSURE_TRUE(hdr, NS_OK);</span>
<a href="#l10.864"></a><span id="l10.864">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineminus">-  if (hdr)</span>
<a href="#l10.866"></a><span id="l10.866" class="difflineminus">-    hdr-&gt;GetOfflineMessageSize(size);</span>
<a href="#l10.867"></a><span id="l10.867" class="difflineplus">+  if (hdr) hdr-&gt;GetOfflineMessageSize(size);</span>
<a href="#l10.868"></a><span id="l10.868"> </span>
<a href="#l10.869"></a><span id="l10.869">   bool reusable;</span>
<a href="#l10.870"></a><span id="l10.870">   rv = GetMsgInputStream(hdr, &amp;reusable, aFileStream);</span>
<a href="#l10.871"></a><span id="l10.871">   // check if offline store really has the correct offset into the offline</span>
<a href="#l10.872"></a><span id="l10.872">   // store by reading the first few bytes. If it doesn't, clear the offline</span>
<a href="#l10.873"></a><span id="l10.873" class="difflineminus">-  // flag on the msg and return false, which will fall back to reading the message</span>
<a href="#l10.874"></a><span id="l10.874" class="difflineminus">-  // from the server.</span>
<a href="#l10.875"></a><span id="l10.875" class="difflineminus">-  // We'll also advance the offset past the envelope header and</span>
<a href="#l10.876"></a><span id="l10.876" class="difflineminus">-  // X-Mozilla-Status lines.</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(*aFileStream);</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineminus">-  if (seekableStream)</span>
<a href="#l10.879"></a><span id="l10.879" class="difflineminus">-  {</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineplus">+  // flag on the msg and return false, which will fall back to reading the</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineplus">+  // message from the server. We'll also advance the offset past the envelope</span>
<a href="#l10.882"></a><span id="l10.882" class="difflineplus">+  // header and X-Mozilla-Status lines.</span>
<a href="#l10.883"></a><span id="l10.883" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(*aFileStream);</span>
<a href="#l10.884"></a><span id="l10.884" class="difflineplus">+  if (seekableStream) {</span>
<a href="#l10.885"></a><span id="l10.885">     seekableStream-&gt;Tell(offset);</span>
<a href="#l10.886"></a><span id="l10.886" class="difflineminus">-        char startOfMsg[200];</span>
<a href="#l10.887"></a><span id="l10.887" class="difflineminus">-        uint32_t bytesRead = 0;</span>
<a href="#l10.888"></a><span id="l10.888" class="difflineminus">-        uint32_t bytesToRead = sizeof(startOfMsg) - 1;</span>
<a href="#l10.889"></a><span id="l10.889" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l10.890"></a><span id="l10.890" class="difflineminus">-          rv = (*aFileStream)-&gt;Read(startOfMsg, bytesToRead, &amp;bytesRead);</span>
<a href="#l10.891"></a><span id="l10.891" class="difflineminus">-        startOfMsg[bytesRead] = '\0';</span>
<a href="#l10.892"></a><span id="l10.892" class="difflineminus">-        // check if message starts with From, or is a draft and starts with FCC</span>
<a href="#l10.893"></a><span id="l10.893" class="difflineminus">-        if (NS_FAILED(rv) || bytesRead != bytesToRead ||</span>
<a href="#l10.894"></a><span id="l10.894" class="difflineminus">-          (strncmp(startOfMsg, &quot;From &quot;, 5) &amp;&amp; (! (mFlags &amp; nsMsgFolderFlags::Drafts) || strncmp(startOfMsg, &quot;FCC&quot;, 3))))</span>
<a href="#l10.895"></a><span id="l10.895" class="difflineminus">-          rv = NS_ERROR_FAILURE;</span>
<a href="#l10.896"></a><span id="l10.896" class="difflineminus">-        else</span>
<a href="#l10.897"></a><span id="l10.897" class="difflineminus">-        {</span>
<a href="#l10.898"></a><span id="l10.898" class="difflineminus">-          uint32_t msgOffset = 0;</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineminus">-          // skip &quot;From &quot;/FCC line</span>
<a href="#l10.900"></a><span id="l10.900" class="difflineminus">-          bool foundNextLine = MsgAdvanceToNextLine(startOfMsg, msgOffset, bytesRead - 1);</span>
<a href="#l10.901"></a><span id="l10.901" class="difflineminus">-          if (foundNextLine &amp;&amp; !strncmp(startOfMsg + msgOffset,</span>
<a href="#l10.902"></a><span id="l10.902" class="difflineminus">-                                        X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN))</span>
<a href="#l10.903"></a><span id="l10.903" class="difflineminus">-          {</span>
<a href="#l10.904"></a><span id="l10.904" class="difflineminus">-            // skip X-Mozilla-Status line</span>
<a href="#l10.905"></a><span id="l10.905" class="difflineminus">-            if (MsgAdvanceToNextLine(startOfMsg, msgOffset, bytesRead - 1))</span>
<a href="#l10.906"></a><span id="l10.906" class="difflineminus">-            {</span>
<a href="#l10.907"></a><span id="l10.907" class="difflineminus">-              if (!strncmp(startOfMsg + msgOffset,</span>
<a href="#l10.908"></a><span id="l10.908" class="difflineminus">-                           X_MOZILLA_STATUS2, X_MOZILLA_STATUS2_LEN))</span>
<a href="#l10.909"></a><span id="l10.909" class="difflineminus">-                 MsgAdvanceToNextLine(startOfMsg, msgOffset, bytesRead - 1);</span>
<a href="#l10.910"></a><span id="l10.910" class="difflineminus">-            }</span>
<a href="#l10.911"></a><span id="l10.911" class="difflineminus">-          }</span>
<a href="#l10.912"></a><span id="l10.912" class="difflineminus">-          int32_t findPos = MsgFindCharInSet(nsDependentCString(startOfMsg),</span>
<a href="#l10.913"></a><span id="l10.913" class="difflineminus">-                                             &quot;:\n\r&quot;, msgOffset);</span>
<a href="#l10.914"></a><span id="l10.914" class="difflineminus">-          // Check that the first line is a header line, i.e., with a ':' in it.</span>
<a href="#l10.915"></a><span id="l10.915" class="difflineminus">-          // Or, the line starts with &quot;From &quot; - I've seen IMAP servers return</span>
<a href="#l10.916"></a><span id="l10.916" class="difflineminus">-          // a bogus &quot;From &quot; line without a ':'.</span>
<a href="#l10.917"></a><span id="l10.917" class="difflineminus">-          if (findPos != -1 &amp;&amp; (startOfMsg[findPos] == ':' ||</span>
<a href="#l10.918"></a><span id="l10.918" class="difflineminus">-                                !(strncmp(startOfMsg, &quot;From &quot;, 5))))</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineminus">-          {</span>
<a href="#l10.920"></a><span id="l10.920" class="difflineminus">-            *offset += msgOffset;</span>
<a href="#l10.921"></a><span id="l10.921" class="difflineminus">-            *size -= msgOffset;</span>
<a href="#l10.922"></a><span id="l10.922" class="difflineminus">-          }</span>
<a href="#l10.923"></a><span id="l10.923" class="difflineminus">-          else</span>
<a href="#l10.924"></a><span id="l10.924" class="difflineminus">-          {</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineminus">-            rv = NS_ERROR_FAILURE;</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineminus">-          }</span>
<a href="#l10.927"></a><span id="l10.927" class="difflineplus">+    char startOfMsg[200];</span>
<a href="#l10.928"></a><span id="l10.928" class="difflineplus">+    uint32_t bytesRead = 0;</span>
<a href="#l10.929"></a><span id="l10.929" class="difflineplus">+    uint32_t bytesToRead = sizeof(startOfMsg) - 1;</span>
<a href="#l10.930"></a><span id="l10.930" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.931"></a><span id="l10.931" class="difflineplus">+      rv = (*aFileStream)-&gt;Read(startOfMsg, bytesToRead, &amp;bytesRead);</span>
<a href="#l10.932"></a><span id="l10.932" class="difflineplus">+    startOfMsg[bytesRead] = '\0';</span>
<a href="#l10.933"></a><span id="l10.933" class="difflineplus">+    // check if message starts with From, or is a draft and starts with FCC</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineplus">+    if (NS_FAILED(rv) || bytesRead != bytesToRead ||</span>
<a href="#l10.935"></a><span id="l10.935" class="difflineplus">+        (strncmp(startOfMsg, &quot;From &quot;, 5) &amp;&amp;</span>
<a href="#l10.936"></a><span id="l10.936" class="difflineplus">+         (!(mFlags &amp; nsMsgFolderFlags::Drafts) ||</span>
<a href="#l10.937"></a><span id="l10.937" class="difflineplus">+          strncmp(startOfMsg, &quot;FCC&quot;, 3))))</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l10.939"></a><span id="l10.939" class="difflineplus">+    else {</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineplus">+      uint32_t msgOffset = 0;</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineplus">+      // skip &quot;From &quot;/FCC line</span>
<a href="#l10.942"></a><span id="l10.942" class="difflineplus">+      bool foundNextLine =</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineplus">+          MsgAdvanceToNextLine(startOfMsg, msgOffset, bytesRead - 1);</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineplus">+      if (foundNextLine &amp;&amp; !strncmp(startOfMsg + msgOffset, X_MOZILLA_STATUS,</span>
<a href="#l10.945"></a><span id="l10.945" class="difflineplus">+                                    X_MOZILLA_STATUS_LEN)) {</span>
<a href="#l10.946"></a><span id="l10.946" class="difflineplus">+        // skip X-Mozilla-Status line</span>
<a href="#l10.947"></a><span id="l10.947" class="difflineplus">+        if (MsgAdvanceToNextLine(startOfMsg, msgOffset, bytesRead - 1)) {</span>
<a href="#l10.948"></a><span id="l10.948" class="difflineplus">+          if (!strncmp(startOfMsg + msgOffset, X_MOZILLA_STATUS2,</span>
<a href="#l10.949"></a><span id="l10.949" class="difflineplus">+                       X_MOZILLA_STATUS2_LEN))</span>
<a href="#l10.950"></a><span id="l10.950" class="difflineplus">+            MsgAdvanceToNextLine(startOfMsg, msgOffset, bytesRead - 1);</span>
<a href="#l10.951"></a><span id="l10.951">         }</span>
<a href="#l10.952"></a><span id="l10.952" class="difflineplus">+      }</span>
<a href="#l10.953"></a><span id="l10.953" class="difflineplus">+      int32_t findPos =</span>
<a href="#l10.954"></a><span id="l10.954" class="difflineplus">+          MsgFindCharInSet(nsDependentCString(startOfMsg), &quot;:\n\r&quot;, msgOffset);</span>
<a href="#l10.955"></a><span id="l10.955" class="difflineplus">+      // Check that the first line is a header line, i.e., with a ':' in it.</span>
<a href="#l10.956"></a><span id="l10.956" class="difflineplus">+      // Or, the line starts with &quot;From &quot; - I've seen IMAP servers return</span>
<a href="#l10.957"></a><span id="l10.957" class="difflineplus">+      // a bogus &quot;From &quot; line without a ':'.</span>
<a href="#l10.958"></a><span id="l10.958" class="difflineplus">+      if (findPos != -1 &amp;&amp;</span>
<a href="#l10.959"></a><span id="l10.959" class="difflineplus">+          (startOfMsg[findPos] == ':' || !(strncmp(startOfMsg, &quot;From &quot;, 5)))) {</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineplus">+        *offset += msgOffset;</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineplus">+        *size -= msgOffset;</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineplus">+      } else {</span>
<a href="#l10.963"></a><span id="l10.963" class="difflineplus">+        rv = NS_ERROR_FAILURE;</span>
<a href="#l10.964"></a><span id="l10.964" class="difflineplus">+      }</span>
<a href="#l10.965"></a><span id="l10.965" class="difflineplus">+    }</span>
<a href="#l10.966"></a><span id="l10.966">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.967"></a><span id="l10.967">       seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, *offset);</span>
<a href="#l10.968"></a><span id="l10.968">     else if (mDatabase)</span>
<a href="#l10.969"></a><span id="l10.969">       mDatabase-&gt;MarkOffline(msgKey, false, nullptr);</span>
<a href="#l10.970"></a><span id="l10.970">   }</span>
<a href="#l10.971"></a><span id="l10.971"> </span>
<a href="#l10.972"></a><span id="l10.972">   return rv;</span>
<a href="#l10.973"></a><span id="l10.973"> }</span>
<a href="#l10.974"></a><span id="l10.974"> </span>
<a href="#l10.975"></a><span id="l10.975"> NS_IMETHODIMP</span>
<a href="#l10.976"></a><span id="l10.976"> nsMsgDBFolder::GetOfflineStoreOutputStream(nsIMsgDBHdr *aHdr,</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineminus">-                                           nsIOutputStream **aOutputStream)</span>
<a href="#l10.978"></a><span id="l10.978" class="difflineminus">-{</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineplus">+                                           nsIOutputStream **aOutputStream) {</span>
<a href="#l10.980"></a><span id="l10.980">   NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l10.981"></a><span id="l10.981">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l10.982"></a><span id="l10.982"> </span>
<a href="#l10.983"></a><span id="l10.983">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; offlineStore;</span>
<a href="#l10.984"></a><span id="l10.984">   nsresult rv = GetMsgStore(getter_AddRefs(offlineStore));</span>
<a href="#l10.985"></a><span id="l10.985">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.986"></a><span id="l10.986">   bool reusable;</span>
<a href="#l10.987"></a><span id="l10.987">   rv = offlineStore-&gt;GetNewMsgOutputStream(this, &amp;aHdr, &amp;reusable,</span>
<a href="#l10.988"></a><span id="l10.988">                                            aOutputStream);</span>
<a href="#l10.989"></a><span id="l10.989">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.990"></a><span id="l10.990">   return rv;</span>
<a href="#l10.991"></a><span id="l10.991"> }</span>
<a href="#l10.992"></a><span id="l10.992"> </span>
<a href="#l10.993"></a><span id="l10.993"> NS_IMETHODIMP</span>
<a href="#l10.994"></a><span id="l10.994"> nsMsgDBFolder::GetMsgInputStream(nsIMsgDBHdr *aMsgHdr, bool *aReusable,</span>
<a href="#l10.995"></a><span id="l10.995" class="difflineminus">-                              nsIInputStream **aInputStream)</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineminus">-{</span>
<a href="#l10.997"></a><span id="l10.997" class="difflineplus">+                                 nsIInputStream **aInputStream) {</span>
<a href="#l10.998"></a><span id="l10.998">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l10.999"></a><span id="l10.999">   NS_ENSURE_ARG_POINTER(aReusable);</span>
<a href="#l10.1000"></a><span id="l10.1000">   NS_ENSURE_ARG_POINTER(aInputStream);</span>
<a href="#l10.1001"></a><span id="l10.1001">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l10.1002"></a><span id="l10.1002">   nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l10.1003"></a><span id="l10.1003">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1004"></a><span id="l10.1004">   nsCString storeToken;</span>
<a href="#l10.1005"></a><span id="l10.1005">   rv = aMsgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(storeToken));</span>
<a href="#l10.1006"></a><span id="l10.1006">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1007"></a><span id="l10.1007">   int64_t offset;</span>
<a href="#l10.1008"></a><span id="l10.1008" class="difflineminus">-  rv = msgStore-&gt;GetMsgInputStream(this, storeToken, &amp;offset, aMsgHdr, aReusable,</span>
<a href="#l10.1009"></a><span id="l10.1009" class="difflineminus">-                                   aInputStream);</span>
<a href="#l10.1010"></a><span id="l10.1010" class="difflineplus">+  rv = msgStore-&gt;GetMsgInputStream(this, storeToken, &amp;offset, aMsgHdr,</span>
<a href="#l10.1011"></a><span id="l10.1011" class="difflineplus">+                                   aReusable, aInputStream);</span>
<a href="#l10.1012"></a><span id="l10.1012">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1013"></a><span id="l10.1013">   nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(*aInputStream));</span>
<a href="#l10.1014"></a><span id="l10.1014" class="difflineminus">-  if (seekableStream)</span>
<a href="#l10.1015"></a><span id="l10.1015" class="difflineminus">-    rv = seekableStream-&gt;Seek(PR_SEEK_SET, offset);</span>
<a href="#l10.1016"></a><span id="l10.1016" class="difflineplus">+  if (seekableStream) rv = seekableStream-&gt;Seek(PR_SEEK_SET, offset);</span>
<a href="#l10.1017"></a><span id="l10.1017">   NS_WARNING_ASSERTION(seekableStream || !offset,</span>
<a href="#l10.1018"></a><span id="l10.1018">                        &quot;non-zero offset w/ non-seekable stream&quot;);</span>
<a href="#l10.1019"></a><span id="l10.1019">   return rv;</span>
<a href="#l10.1020"></a><span id="l10.1020"> }</span>
<a href="#l10.1021"></a><span id="l10.1021"> </span>
<a href="#l10.1022"></a><span id="l10.1022"> // path coming in is the root path without the leaf name,</span>
<a href="#l10.1023"></a><span id="l10.1023"> // on the way out, it's the whole path.</span>
<a href="#l10.1024"></a><span id="l10.1024" class="difflineminus">-nsresult nsMsgDBFolder::CreateFileForDB(const nsAString&amp; userLeafName, nsIFile *path, nsIFile **dbFile)</span>
<a href="#l10.1025"></a><span id="l10.1025" class="difflineminus">-{</span>
<a href="#l10.1026"></a><span id="l10.1026" class="difflineplus">+nsresult nsMsgDBFolder::CreateFileForDB(const nsAString &amp;userLeafName,</span>
<a href="#l10.1027"></a><span id="l10.1027" class="difflineplus">+                                        nsIFile *path, nsIFile **dbFile) {</span>
<a href="#l10.1028"></a><span id="l10.1028">   NS_ENSURE_ARG_POINTER(dbFile);</span>
<a href="#l10.1029"></a><span id="l10.1029"> </span>
<a href="#l10.1030"></a><span id="l10.1030">   nsAutoString proposedDBName(userLeafName);</span>
<a href="#l10.1031"></a><span id="l10.1031">   NS_MsgHashIfNecessary(proposedDBName);</span>
<a href="#l10.1032"></a><span id="l10.1032"> </span>
<a href="#l10.1033"></a><span id="l10.1033">   // (note, the caller of this will be using the dbFile to call db-&gt;Open()</span>
<a href="#l10.1034"></a><span id="l10.1034">   // will turn the path into summary file path, and append the &quot;.msf&quot; extension)</span>
<a href="#l10.1035"></a><span id="l10.1035">   //</span>
<a href="#l10.1036"></a><span id="l10.1036">   // we want db-&gt;Open() to create a new summary file</span>
<a href="#l10.1037"></a><span id="l10.1037">   // so we have to jump through some hoops to make sure the .msf it will</span>
<a href="#l10.1038"></a><span id="l10.1038">   // create is unique.  now that we've got the &quot;safe&quot; proposedDBName,</span>
<a href="#l10.1039"></a><span id="l10.1039">   // we append &quot;.msf&quot; to see if the file exists.  if so, we make the name</span>
<a href="#l10.1040"></a><span id="l10.1040">   // unique and then string off the &quot;.msf&quot; so that we pass the right thing</span>
<a href="#l10.1041"></a><span id="l10.1041">   // into Open().  this isn't ideal, since this is not atomic</span>
<a href="#l10.1042"></a><span id="l10.1042">   // but it will make do.</span>
<a href="#l10.1043"></a><span id="l10.1043">   nsresult rv;</span>
<a href="#l10.1044"></a><span id="l10.1044" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; dbPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1045"></a><span id="l10.1045" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dbPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1046"></a><span id="l10.1046">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1047"></a><span id="l10.1047">   dbPath-&gt;InitWithFile(path);</span>
<a href="#l10.1048"></a><span id="l10.1048">   proposedDBName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l10.1049"></a><span id="l10.1049">   dbPath-&gt;Append(proposedDBName);</span>
<a href="#l10.1050"></a><span id="l10.1050">   bool exists;</span>
<a href="#l10.1051"></a><span id="l10.1051">   dbPath-&gt;Exists(&amp;exists);</span>
<a href="#l10.1052"></a><span id="l10.1052" class="difflineminus">-  if (exists)</span>
<a href="#l10.1053"></a><span id="l10.1053" class="difflineminus">-  {</span>
<a href="#l10.1054"></a><span id="l10.1054" class="difflineplus">+  if (exists) {</span>
<a href="#l10.1055"></a><span id="l10.1055">     rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l10.1056"></a><span id="l10.1056">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1057"></a><span id="l10.1057">     dbPath-&gt;GetLeafName(proposedDBName);</span>
<a href="#l10.1058"></a><span id="l10.1058">   }</span>
<a href="#l10.1059"></a><span id="l10.1059">   // now, take the &quot;.msf&quot; off</span>
<a href="#l10.1060"></a><span id="l10.1060">   proposedDBName.SetLength(proposedDBName.Length() - SUMMARY_SUFFIX_LENGTH);</span>
<a href="#l10.1061"></a><span id="l10.1061">   dbPath-&gt;SetLeafName(proposedDBName);</span>
<a href="#l10.1062"></a><span id="l10.1062"> </span>
<a href="#l10.1063"></a><span id="l10.1063">   dbPath.forget(dbFile);</span>
<a href="#l10.1064"></a><span id="l10.1064">   return NS_OK;</span>
<a href="#l10.1065"></a><span id="l10.1065"> }</span>
<a href="#l10.1066"></a><span id="l10.1066"> </span>
<a href="#l10.1067"></a><span id="l10.1067"> NS_IMETHODIMP</span>
<a href="#l10.1068"></a><span id="l10.1068" class="difflineminus">-nsMsgDBFolder::GetMsgDatabase(nsIMsgDatabase** aMsgDatabase)</span>
<a href="#l10.1069"></a><span id="l10.1069" class="difflineminus">-{</span>
<a href="#l10.1070"></a><span id="l10.1070" class="difflineplus">+nsMsgDBFolder::GetMsgDatabase(nsIMsgDatabase **aMsgDatabase) {</span>
<a href="#l10.1071"></a><span id="l10.1071">   NS_ENSURE_ARG_POINTER(aMsgDatabase);</span>
<a href="#l10.1072"></a><span id="l10.1072">   GetDatabase();</span>
<a href="#l10.1073"></a><span id="l10.1073" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l10.1074"></a><span id="l10.1074" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.1075"></a><span id="l10.1075" class="difflineplus">+  if (!mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l10.1076"></a><span id="l10.1076">   NS_ADDREF(*aMsgDatabase = mDatabase);</span>
<a href="#l10.1077"></a><span id="l10.1077">   mDatabase-&gt;SetLastUseTime(PR_Now());</span>
<a href="#l10.1078"></a><span id="l10.1078">   return NS_OK;</span>
<a href="#l10.1079"></a><span id="l10.1079"> }</span>
<a href="#l10.1080"></a><span id="l10.1080"> </span>
<a href="#l10.1081"></a><span id="l10.1081"> NS_IMETHODIMP</span>
<a href="#l10.1082"></a><span id="l10.1082" class="difflineminus">-nsMsgDBFolder::SetMsgDatabase(nsIMsgDatabase *aMsgDatabase)</span>
<a href="#l10.1083"></a><span id="l10.1083" class="difflineminus">-{</span>
<a href="#l10.1084"></a><span id="l10.1084" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.1085"></a><span id="l10.1085" class="difflineminus">-  {</span>
<a href="#l10.1086"></a><span id="l10.1086" class="difflineplus">+nsMsgDBFolder::SetMsgDatabase(nsIMsgDatabase *aMsgDatabase) {</span>
<a href="#l10.1087"></a><span id="l10.1087" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.1088"></a><span id="l10.1088">     // commit here - db might go away when all these refs are released.</span>
<a href="#l10.1089"></a><span id="l10.1089">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.1090"></a><span id="l10.1090">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l10.1091"></a><span id="l10.1091">     mDatabase-&gt;ClearCachedHdrs();</span>
<a href="#l10.1092"></a><span id="l10.1092" class="difflineminus">-    if (!aMsgDatabase)</span>
<a href="#l10.1093"></a><span id="l10.1093" class="difflineminus">-    {</span>
<a href="#l10.1094"></a><span id="l10.1094" class="difflineplus">+    if (!aMsgDatabase) {</span>
<a href="#l10.1095"></a><span id="l10.1095">       uint32_t numNewKeys;</span>
<a href="#l10.1096"></a><span id="l10.1096">       nsMsgKey *newMessageKeys;</span>
<a href="#l10.1097"></a><span id="l10.1097">       nsresult rv = mDatabase-&gt;GetNewList(&amp;numNewKeys, &amp;newMessageKeys);</span>
<a href="#l10.1098"></a><span id="l10.1098" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; newMessageKeys)</span>
<a href="#l10.1099"></a><span id="l10.1099" class="difflineminus">-      {</span>
<a href="#l10.1100"></a><span id="l10.1100" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; newMessageKeys) {</span>
<a href="#l10.1101"></a><span id="l10.1101">         m_newMsgs.Clear();</span>
<a href="#l10.1102"></a><span id="l10.1102">         m_newMsgs.AppendElements(newMessageKeys, numNewKeys);</span>
<a href="#l10.1103"></a><span id="l10.1103">       }</span>
<a href="#l10.1104"></a><span id="l10.1104">       free(newMessageKeys);</span>
<a href="#l10.1105"></a><span id="l10.1105">     }</span>
<a href="#l10.1106"></a><span id="l10.1106">   }</span>
<a href="#l10.1107"></a><span id="l10.1107">   mDatabase = aMsgDatabase;</span>
<a href="#l10.1108"></a><span id="l10.1108"> </span>
<a href="#l10.1109"></a><span id="l10.1109" class="difflineminus">-  if (aMsgDatabase)</span>
<a href="#l10.1110"></a><span id="l10.1110" class="difflineminus">-    aMsgDatabase-&gt;AddListener(this);</span>
<a href="#l10.1111"></a><span id="l10.1111" class="difflineplus">+  if (aMsgDatabase) aMsgDatabase-&gt;AddListener(this);</span>
<a href="#l10.1112"></a><span id="l10.1112">   return NS_OK;</span>
<a href="#l10.1113"></a><span id="l10.1113"> }</span>
<a href="#l10.1114"></a><span id="l10.1114"> </span>
<a href="#l10.1115"></a><span id="l10.1115"> NS_IMETHODIMP</span>
<a href="#l10.1116"></a><span id="l10.1116" class="difflineminus">-nsMsgDBFolder::GetDatabaseOpen(bool *aOpen)</span>
<a href="#l10.1117"></a><span id="l10.1117" class="difflineminus">-{</span>
<a href="#l10.1118"></a><span id="l10.1118" class="difflineplus">+nsMsgDBFolder::GetDatabaseOpen(bool *aOpen) {</span>
<a href="#l10.1119"></a><span id="l10.1119">   NS_ENSURE_ARG_POINTER(aOpen);</span>
<a href="#l10.1120"></a><span id="l10.1120"> </span>
<a href="#l10.1121"></a><span id="l10.1121">   *aOpen = (mDatabase != nullptr);</span>
<a href="#l10.1122"></a><span id="l10.1122">   return NS_OK;</span>
<a href="#l10.1123"></a><span id="l10.1123"> }</span>
<a href="#l10.1124"></a><span id="l10.1124"> </span>
<a href="#l10.1125"></a><span id="l10.1125"> NS_IMETHODIMP</span>
<a href="#l10.1126"></a><span id="l10.1126" class="difflineminus">-nsMsgDBFolder::GetBackupMsgDatabase(nsIMsgDatabase** aMsgDatabase)</span>
<a href="#l10.1127"></a><span id="l10.1127" class="difflineminus">-{</span>
<a href="#l10.1128"></a><span id="l10.1128" class="difflineplus">+nsMsgDBFolder::GetBackupMsgDatabase(nsIMsgDatabase **aMsgDatabase) {</span>
<a href="#l10.1129"></a><span id="l10.1129">   NS_ENSURE_ARG_POINTER(aMsgDatabase);</span>
<a href="#l10.1130"></a><span id="l10.1130">   nsresult rv = OpenBackupMsgDatabase();</span>
<a href="#l10.1131"></a><span id="l10.1131">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1132"></a><span id="l10.1132" class="difflineminus">-  if (!mBackupDatabase)</span>
<a href="#l10.1133"></a><span id="l10.1133" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.1134"></a><span id="l10.1134" class="difflineplus">+  if (!mBackupDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l10.1135"></a><span id="l10.1135"> </span>
<a href="#l10.1136"></a><span id="l10.1136">   NS_ADDREF(*aMsgDatabase = mBackupDatabase);</span>
<a href="#l10.1137"></a><span id="l10.1137">   return NS_OK;</span>
<a href="#l10.1138"></a><span id="l10.1138"> }</span>
<a href="#l10.1139"></a><span id="l10.1139"> </span>
<a href="#l10.1140"></a><span id="l10.1140"> NS_IMETHODIMP</span>
<a href="#l10.1141"></a><span id="l10.1141" class="difflineminus">-nsMsgDBFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **database)</span>
<a href="#l10.1142"></a><span id="l10.1142" class="difflineminus">-{</span>
<a href="#l10.1143"></a><span id="l10.1143" class="difflineplus">+nsMsgDBFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l10.1144"></a><span id="l10.1144" class="difflineplus">+                                    nsIMsgDatabase **database) {</span>
<a href="#l10.1145"></a><span id="l10.1145">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.1146"></a><span id="l10.1146"> }</span>
<a href="#l10.1147"></a><span id="l10.1147"> </span>
<a href="#l10.1148"></a><span id="l10.1148"> NS_IMETHODIMP</span>
<a href="#l10.1149"></a><span id="l10.1149" class="difflineminus">-nsMsgDBFolder::OnReadChanged(nsIDBChangeListener * aInstigator)</span>
<a href="#l10.1150"></a><span id="l10.1150" class="difflineminus">-{</span>
<a href="#l10.1151"></a><span id="l10.1151" class="difflineplus">+nsMsgDBFolder::OnReadChanged(nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1152"></a><span id="l10.1152">   /* do nothing.  if you care about this, override it.  see nsNewsFolder.cpp */</span>
<a href="#l10.1153"></a><span id="l10.1153">   return NS_OK;</span>
<a href="#l10.1154"></a><span id="l10.1154"> }</span>
<a href="#l10.1155"></a><span id="l10.1155"> </span>
<a href="#l10.1156"></a><span id="l10.1156"> NS_IMETHODIMP</span>
<a href="#l10.1157"></a><span id="l10.1157" class="difflineminus">-nsMsgDBFolder::OnJunkScoreChanged(nsIDBChangeListener * aInstigator)</span>
<a href="#l10.1158"></a><span id="l10.1158" class="difflineminus">-{</span>
<a href="#l10.1159"></a><span id="l10.1159" class="difflineplus">+nsMsgDBFolder::OnJunkScoreChanged(nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1160"></a><span id="l10.1160">   NotifyFolderEvent(kJunkStatusChanged);</span>
<a href="#l10.1161"></a><span id="l10.1161">   return NS_OK;</span>
<a href="#l10.1162"></a><span id="l10.1162"> }</span>
<a href="#l10.1163"></a><span id="l10.1163"> </span>
<a href="#l10.1164"></a><span id="l10.1164"> NS_IMETHODIMP</span>
<a href="#l10.1165"></a><span id="l10.1165" class="difflineminus">-nsMsgDBFolder::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l10.1166"></a><span id="l10.1166" class="difflineminus">-                                   nsIDBChangeListener *aInstigator)</span>
<a href="#l10.1167"></a><span id="l10.1167" class="difflineminus">-{</span>
<a href="#l10.1168"></a><span id="l10.1168" class="difflineplus">+nsMsgDBFolder::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange,</span>
<a href="#l10.1169"></a><span id="l10.1169" class="difflineplus">+                                    uint32_t *aStatus,</span>
<a href="#l10.1170"></a><span id="l10.1170" class="difflineplus">+                                    nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1171"></a><span id="l10.1171">   /* do nothing.  if you care about this, override it.*/</span>
<a href="#l10.1172"></a><span id="l10.1172">   return NS_OK;</span>
<a href="#l10.1173"></a><span id="l10.1173"> }</span>
<a href="#l10.1174"></a><span id="l10.1174"> </span>
<a href="#l10.1175"></a><span id="l10.1175"> // 1.  When the status of a message changes.</span>
<a href="#l10.1176"></a><span id="l10.1176" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l10.1177"></a><span id="l10.1177" class="difflineminus">-                                         nsIDBChangeListener * aInstigator)</span>
<a href="#l10.1178"></a><span id="l10.1178" class="difflineminus">-{</span>
<a href="#l10.1179"></a><span id="l10.1179" class="difflineminus">-  if(aHdrChanged)</span>
<a href="#l10.1180"></a><span id="l10.1180" class="difflineminus">-  {</span>
<a href="#l10.1181"></a><span id="l10.1181" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnHdrFlagsChanged(</span>
<a href="#l10.1182"></a><span id="l10.1182" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l10.1183"></a><span id="l10.1183" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1184"></a><span id="l10.1184" class="difflineplus">+  if (aHdrChanged) {</span>
<a href="#l10.1185"></a><span id="l10.1185">     SendFlagNotifications(aHdrChanged, aOldFlags, aNewFlags);</span>
<a href="#l10.1186"></a><span id="l10.1186">     UpdateSummaryTotals(true);</span>
<a href="#l10.1187"></a><span id="l10.1187">   }</span>
<a href="#l10.1188"></a><span id="l10.1188"> </span>
<a href="#l10.1189"></a><span id="l10.1189">   // The old state was new message state</span>
<a href="#l10.1190"></a><span id="l10.1190">   // We check and see if this state has changed</span>
<a href="#l10.1191"></a><span id="l10.1191" class="difflineminus">-  if(aOldFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l10.1192"></a><span id="l10.1192" class="difflineminus">-  {</span>
<a href="#l10.1193"></a><span id="l10.1193" class="difflineplus">+  if (aOldFlags &amp; nsMsgMessageFlags::New) {</span>
<a href="#l10.1194"></a><span id="l10.1194">     // state changing from new to something else</span>
<a href="#l10.1195"></a><span id="l10.1195" class="difflineminus">-    if (!(aNewFlags  &amp; nsMsgMessageFlags::New))</span>
<a href="#l10.1196"></a><span id="l10.1196" class="difflineplus">+    if (!(aNewFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l10.1197"></a><span id="l10.1197">       CheckWithNewMessagesStatus(false);</span>
<a href="#l10.1198"></a><span id="l10.1198">   }</span>
<a href="#l10.1199"></a><span id="l10.1199"> </span>
<a href="#l10.1200"></a><span id="l10.1200">   return NS_OK;</span>
<a href="#l10.1201"></a><span id="l10.1201"> }</span>
<a href="#l10.1202"></a><span id="l10.1202"> </span>
<a href="#l10.1203"></a><span id="l10.1203" class="difflineminus">-nsresult nsMsgDBFolder::CheckWithNewMessagesStatus(bool messageAdded)</span>
<a href="#l10.1204"></a><span id="l10.1204" class="difflineminus">-{</span>
<a href="#l10.1205"></a><span id="l10.1205" class="difflineplus">+nsresult nsMsgDBFolder::CheckWithNewMessagesStatus(bool messageAdded) {</span>
<a href="#l10.1206"></a><span id="l10.1206">   bool hasNewMessages;</span>
<a href="#l10.1207"></a><span id="l10.1207">   if (messageAdded)</span>
<a href="#l10.1208"></a><span id="l10.1208">     SetHasNewMessages(true);</span>
<a href="#l10.1209"></a><span id="l10.1209" class="difflineminus">-  else // message modified or deleted</span>
<a href="#l10.1210"></a><span id="l10.1210" class="difflineplus">+  else  // message modified or deleted</span>
<a href="#l10.1211"></a><span id="l10.1211">   {</span>
<a href="#l10.1212"></a><span id="l10.1212" class="difflineminus">-    if(mDatabase)</span>
<a href="#l10.1213"></a><span id="l10.1213" class="difflineminus">-    {</span>
<a href="#l10.1214"></a><span id="l10.1214" class="difflineplus">+    if (mDatabase) {</span>
<a href="#l10.1215"></a><span id="l10.1215">       nsresult rv = mDatabase-&gt;HasNew(&amp;hasNewMessages);</span>
<a href="#l10.1216"></a><span id="l10.1216">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1217"></a><span id="l10.1217">       SetHasNewMessages(hasNewMessages);</span>
<a href="#l10.1218"></a><span id="l10.1218">     }</span>
<a href="#l10.1219"></a><span id="l10.1219">   }</span>
<a href="#l10.1220"></a><span id="l10.1220"> </span>
<a href="#l10.1221"></a><span id="l10.1221">   return NS_OK;</span>
<a href="#l10.1222"></a><span id="l10.1222"> }</span>
<a href="#l10.1223"></a><span id="l10.1223"> </span>
<a href="#l10.1224"></a><span id="l10.1224"> // 3.  When a message gets deleted, we need to see if it was new</span>
<a href="#l10.1225"></a><span id="l10.1225" class="difflineminus">-//     When we lose a new message we need to check if there are still new messages</span>
<a href="#l10.1226"></a><span id="l10.1226" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged, nsMsgKey  aParentKey, int32_t aFlags,</span>
<a href="#l10.1227"></a><span id="l10.1227" class="difflineminus">-                          nsIDBChangeListener * aInstigator)</span>
<a href="#l10.1228"></a><span id="l10.1228" class="difflineminus">-{</span>
<a href="#l10.1229"></a><span id="l10.1229" class="difflineplus">+//     When we lose a new message we need to check if there are still new</span>
<a href="#l10.1230"></a><span id="l10.1230" class="difflineplus">+//     messages</span>
<a href="#l10.1231"></a><span id="l10.1231" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l10.1232"></a><span id="l10.1232" class="difflineplus">+                                          nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l10.1233"></a><span id="l10.1233" class="difflineplus">+                                          nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1234"></a><span id="l10.1234">   // check to see if a new message is being deleted</span>
<a href="#l10.1235"></a><span id="l10.1235">   // as in this case, if there is only one new message and it's being deleted</span>
<a href="#l10.1236"></a><span id="l10.1236">   // the folder newness has to be cleared.</span>
<a href="#l10.1237"></a><span id="l10.1237">   CheckWithNewMessagesStatus(false);</span>
<a href="#l10.1238"></a><span id="l10.1238">   // Remove all processing flags.  This is generally a good thing although</span>
<a href="#l10.1239"></a><span id="l10.1239">   // undo-ing a message back into position will not re-gain the flags.</span>
<a href="#l10.1240"></a><span id="l10.1240">   nsMsgKey msgKey;</span>
<a href="#l10.1241"></a><span id="l10.1241">   aHdrChanged-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.1242"></a><span id="l10.1242">   AndProcessingFlags(msgKey, 0);</span>
<a href="#l10.1243"></a><span id="l10.1243">   return OnHdrAddedOrDeleted(aHdrChanged, false);</span>
<a href="#l10.1244"></a><span id="l10.1244"> }</span>
<a href="#l10.1245"></a><span id="l10.1245"> </span>
<a href="#l10.1246"></a><span id="l10.1246"> // 2.  When a new messages gets added, we need to see if it's new.</span>
<a href="#l10.1247"></a><span id="l10.1247" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnHdrAdded(nsIMsgDBHdr *aHdrChanged, nsMsgKey  aParentKey , int32_t aFlags,</span>
<a href="#l10.1248"></a><span id="l10.1248" class="difflineminus">-                        nsIDBChangeListener * aInstigator)</span>
<a href="#l10.1249"></a><span id="l10.1249" class="difflineminus">-{</span>
<a href="#l10.1250"></a><span id="l10.1250" class="difflineminus">-  if(aFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l10.1251"></a><span id="l10.1251" class="difflineminus">-    CheckWithNewMessagesStatus(true);</span>
<a href="#l10.1252"></a><span id="l10.1252" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnHdrAdded(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l10.1253"></a><span id="l10.1253" class="difflineplus">+                                        nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l10.1254"></a><span id="l10.1254" class="difflineplus">+                                        nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1255"></a><span id="l10.1255" class="difflineplus">+  if (aFlags &amp; nsMsgMessageFlags::New) CheckWithNewMessagesStatus(true);</span>
<a href="#l10.1256"></a><span id="l10.1256">   return OnHdrAddedOrDeleted(aHdrChanged, true);</span>
<a href="#l10.1257"></a><span id="l10.1257"> }</span>
<a href="#l10.1258"></a><span id="l10.1258"> </span>
<a href="#l10.1259"></a><span id="l10.1259" class="difflineminus">-nsresult nsMsgDBFolder::OnHdrAddedOrDeleted(nsIMsgDBHdr *aHdrChanged, bool added)</span>
<a href="#l10.1260"></a><span id="l10.1260" class="difflineminus">-{</span>
<a href="#l10.1261"></a><span id="l10.1261" class="difflineminus">-  if(added)</span>
<a href="#l10.1262"></a><span id="l10.1262" class="difflineplus">+nsresult nsMsgDBFolder::OnHdrAddedOrDeleted(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l10.1263"></a><span id="l10.1263" class="difflineplus">+                                            bool added) {</span>
<a href="#l10.1264"></a><span id="l10.1264" class="difflineplus">+  if (added)</span>
<a href="#l10.1265"></a><span id="l10.1265">     NotifyItemAdded(aHdrChanged);</span>
<a href="#l10.1266"></a><span id="l10.1266">   else</span>
<a href="#l10.1267"></a><span id="l10.1267">     NotifyItemRemoved(aHdrChanged);</span>
<a href="#l10.1268"></a><span id="l10.1268">   UpdateSummaryTotals(true);</span>
<a href="#l10.1269"></a><span id="l10.1269">   return NS_OK;</span>
<a href="#l10.1270"></a><span id="l10.1270" class="difflineminus">-</span>
<a href="#l10.1271"></a><span id="l10.1271" class="difflineminus">-}</span>
<a href="#l10.1272"></a><span id="l10.1272" class="difflineminus">-</span>
<a href="#l10.1273"></a><span id="l10.1273" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnParentChanged(nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l10.1274"></a><span id="l10.1274" class="difflineminus">-            nsIDBChangeListener * aInstigator)</span>
<a href="#l10.1275"></a><span id="l10.1275" class="difflineminus">-{</span>
<a href="#l10.1276"></a><span id="l10.1276" class="difflineplus">+}</span>
<a href="#l10.1277"></a><span id="l10.1277" class="difflineplus">+</span>
<a href="#l10.1278"></a><span id="l10.1278" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnParentChanged(nsMsgKey aKeyChanged,</span>
<a href="#l10.1279"></a><span id="l10.1279" class="difflineplus">+                                             nsMsgKey oldParent,</span>
<a href="#l10.1280"></a><span id="l10.1280" class="difflineplus">+                                             nsMsgKey newParent,</span>
<a href="#l10.1281"></a><span id="l10.1281" class="difflineplus">+                                             nsIDBChangeListener *aInstigator) {</span>
<a href="#l10.1282"></a><span id="l10.1282">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdrChanged;</span>
<a href="#l10.1283"></a><span id="l10.1283">   mDatabase-&gt;GetMsgHdrForKey(aKeyChanged, getter_AddRefs(hdrChanged));</span>
<a href="#l10.1284"></a><span id="l10.1284" class="difflineminus">-  //In reality we probably want to just change the parent because otherwise we will lose things like</span>
<a href="#l10.1285"></a><span id="l10.1285" class="difflineminus">-  //selection.</span>
<a href="#l10.1286"></a><span id="l10.1286" class="difflineminus">-  if (hdrChanged)</span>
<a href="#l10.1287"></a><span id="l10.1287" class="difflineminus">-  {</span>
<a href="#l10.1288"></a><span id="l10.1288" class="difflineminus">-    //First delete the child from the old threadParent</span>
<a href="#l10.1289"></a><span id="l10.1289" class="difflineplus">+  // In reality we probably want to just change the parent because otherwise we</span>
<a href="#l10.1290"></a><span id="l10.1290" class="difflineplus">+  // will lose things like selection.</span>
<a href="#l10.1291"></a><span id="l10.1291" class="difflineplus">+  if (hdrChanged) {</span>
<a href="#l10.1292"></a><span id="l10.1292" class="difflineplus">+    // First delete the child from the old threadParent</span>
<a href="#l10.1293"></a><span id="l10.1293">     OnHdrAddedOrDeleted(hdrChanged, false);</span>
<a href="#l10.1294"></a><span id="l10.1294" class="difflineminus">-    //Then add it to the new threadParent</span>
<a href="#l10.1295"></a><span id="l10.1295" class="difflineplus">+    // Then add it to the new threadParent</span>
<a href="#l10.1296"></a><span id="l10.1296">     OnHdrAddedOrDeleted(hdrChanged, true);</span>
<a href="#l10.1297"></a><span id="l10.1297">   }</span>
<a href="#l10.1298"></a><span id="l10.1298">   return NS_OK;</span>
<a href="#l10.1299"></a><span id="l10.1299"> }</span>
<a href="#l10.1300"></a><span id="l10.1300"> </span>
<a href="#l10.1301"></a><span id="l10.1301" class="difflineminus">-</span>
<a href="#l10.1302"></a><span id="l10.1302" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l10.1303"></a><span id="l10.1303" class="difflineminus">-{</span>
<a href="#l10.1304"></a><span id="l10.1304" class="difflineminus">-  if (mBackupDatabase &amp;&amp; instigator == mBackupDatabase)</span>
<a href="#l10.1305"></a><span id="l10.1305" class="difflineminus">-  {</span>
<a href="#l10.1306"></a><span id="l10.1306" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnAnnouncerGoingAway(</span>
<a href="#l10.1307"></a><span id="l10.1307" class="difflineplus">+    nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l10.1308"></a><span id="l10.1308" class="difflineplus">+  if (mBackupDatabase &amp;&amp; instigator == mBackupDatabase) {</span>
<a href="#l10.1309"></a><span id="l10.1309">     mBackupDatabase-&gt;RemoveListener(this);</span>
<a href="#l10.1310"></a><span id="l10.1310">     mBackupDatabase = nullptr;</span>
<a href="#l10.1311"></a><span id="l10.1311" class="difflineminus">-  }</span>
<a href="#l10.1312"></a><span id="l10.1312" class="difflineminus">-  else if (mDatabase)</span>
<a href="#l10.1313"></a><span id="l10.1313" class="difflineminus">-  {</span>
<a href="#l10.1314"></a><span id="l10.1314" class="difflineplus">+  } else if (mDatabase) {</span>
<a href="#l10.1315"></a><span id="l10.1315">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l10.1316"></a><span id="l10.1316">     mDatabase = nullptr;</span>
<a href="#l10.1317"></a><span id="l10.1317">   }</span>
<a href="#l10.1318"></a><span id="l10.1318">   return NS_OK;</span>
<a href="#l10.1319"></a><span id="l10.1319"> }</span>
<a href="#l10.1320"></a><span id="l10.1320"> </span>
<a href="#l10.1321"></a><span id="l10.1321" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnEvent(nsIMsgDatabase *aDB, const char *aEvent)</span>
<a href="#l10.1322"></a><span id="l10.1322" class="difflineminus">-{</span>
<a href="#l10.1323"></a><span id="l10.1323" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnEvent(nsIMsgDatabase *aDB, const char *aEvent) {</span>
<a href="#l10.1324"></a><span id="l10.1324">   return NS_OK;</span>
<a href="#l10.1325"></a><span id="l10.1325"> }</span>
<a href="#l10.1326"></a><span id="l10.1326"> </span>
<a href="#l10.1327"></a><span id="l10.1327" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetManyHeadersToDownload(bool *retval)</span>
<a href="#l10.1328"></a><span id="l10.1328" class="difflineminus">-{</span>
<a href="#l10.1329"></a><span id="l10.1329" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetManyHeadersToDownload(bool *retval) {</span>
<a href="#l10.1330"></a><span id="l10.1330">   NS_ENSURE_ARG_POINTER(retval);</span>
<a href="#l10.1331"></a><span id="l10.1331">   int32_t numTotalMessages;</span>
<a href="#l10.1332"></a><span id="l10.1332"> </span>
<a href="#l10.1333"></a><span id="l10.1333">   // is there any reason to return false?</span>
<a href="#l10.1334"></a><span id="l10.1334">   if (!mDatabase)</span>
<a href="#l10.1335"></a><span id="l10.1335">     *retval = true;</span>
<a href="#l10.1336"></a><span id="l10.1336" class="difflineminus">-  else if (NS_SUCCEEDED(GetTotalMessages(false, &amp;numTotalMessages)) &amp;&amp; numTotalMessages &lt;= 0)</span>
<a href="#l10.1337"></a><span id="l10.1337" class="difflineplus">+  else if (NS_SUCCEEDED(GetTotalMessages(false, &amp;numTotalMessages)) &amp;&amp;</span>
<a href="#l10.1338"></a><span id="l10.1338" class="difflineplus">+           numTotalMessages &lt;= 0)</span>
<a href="#l10.1339"></a><span id="l10.1339">     *retval = true;</span>
<a href="#l10.1340"></a><span id="l10.1340">   else</span>
<a href="#l10.1341"></a><span id="l10.1341">     *retval = false;</span>
<a href="#l10.1342"></a><span id="l10.1342">   return NS_OK;</span>
<a href="#l10.1343"></a><span id="l10.1343"> }</span>
<a href="#l10.1344"></a><span id="l10.1344"> </span>
<a href="#l10.1345"></a><span id="l10.1345" class="difflineminus">-nsresult nsMsgDBFolder::MsgFitsDownloadCriteria(nsMsgKey msgKey, bool *result)</span>
<a href="#l10.1346"></a><span id="l10.1346" class="difflineminus">-{</span>
<a href="#l10.1347"></a><span id="l10.1347" class="difflineminus">-  if(!mDatabase)</span>
<a href="#l10.1348"></a><span id="l10.1348" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.1349"></a><span id="l10.1349" class="difflineplus">+nsresult nsMsgDBFolder::MsgFitsDownloadCriteria(nsMsgKey msgKey, bool *result) {</span>
<a href="#l10.1350"></a><span id="l10.1350" class="difflineplus">+  if (!mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l10.1351"></a><span id="l10.1351"> </span>
<a href="#l10.1352"></a><span id="l10.1352">   nsresult rv;</span>
<a href="#l10.1353"></a><span id="l10.1353">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l10.1354"></a><span id="l10.1354">   rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l10.1355"></a><span id="l10.1355" class="difflineminus">-  if(NS_FAILED(rv))</span>
<a href="#l10.1356"></a><span id="l10.1356" class="difflineminus">-    return rv;</span>
<a href="#l10.1357"></a><span id="l10.1357" class="difflineminus">-</span>
<a href="#l10.1358"></a><span id="l10.1358" class="difflineminus">-  if (hdr)</span>
<a href="#l10.1359"></a><span id="l10.1359" class="difflineminus">-  {</span>
<a href="#l10.1360"></a><span id="l10.1360" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.1361"></a><span id="l10.1361" class="difflineplus">+</span>
<a href="#l10.1362"></a><span id="l10.1362" class="difflineplus">+  if (hdr) {</span>
<a href="#l10.1363"></a><span id="l10.1363">     uint32_t msgFlags = 0;</span>
<a href="#l10.1364"></a><span id="l10.1364">     hdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l10.1365"></a><span id="l10.1365">     // check if we already have this message body offline</span>
<a href="#l10.1366"></a><span id="l10.1366" class="difflineminus">-    if (! (msgFlags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l10.1367"></a><span id="l10.1367" class="difflineminus">-    {</span>
<a href="#l10.1368"></a><span id="l10.1368" class="difflineplus">+    if (!(msgFlags &amp; nsMsgMessageFlags::Offline)) {</span>
<a href="#l10.1369"></a><span id="l10.1369">       *result = true;</span>
<a href="#l10.1370"></a><span id="l10.1370">       // check against the server download size limit .</span>
<a href="#l10.1371"></a><span id="l10.1371" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1372"></a><span id="l10.1372" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1373"></a><span id="l10.1373">       rv = GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l10.1374"></a><span id="l10.1374" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer)</span>
<a href="#l10.1375"></a><span id="l10.1375" class="difflineminus">-      {</span>
<a href="#l10.1376"></a><span id="l10.1376" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer) {</span>
<a href="#l10.1377"></a><span id="l10.1377">         bool limitDownloadSize = false;</span>
<a href="#l10.1378"></a><span id="l10.1378">         rv = incomingServer-&gt;GetLimitOfflineMessageSize(&amp;limitDownloadSize);</span>
<a href="#l10.1379"></a><span id="l10.1379">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1380"></a><span id="l10.1380" class="difflineminus">-        if (limitDownloadSize)</span>
<a href="#l10.1381"></a><span id="l10.1381" class="difflineminus">-        {</span>
<a href="#l10.1382"></a><span id="l10.1382" class="difflineplus">+        if (limitDownloadSize) {</span>
<a href="#l10.1383"></a><span id="l10.1383">           int32_t maxDownloadMsgSize = 0;</span>
<a href="#l10.1384"></a><span id="l10.1384">           uint32_t msgSize;</span>
<a href="#l10.1385"></a><span id="l10.1385">           hdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l10.1386"></a><span id="l10.1386">           rv = incomingServer-&gt;GetMaxMessageSize(&amp;maxDownloadMsgSize);</span>
<a href="#l10.1387"></a><span id="l10.1387">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1388"></a><span id="l10.1388">           maxDownloadMsgSize *= 1024;</span>
<a href="#l10.1389"></a><span id="l10.1389" class="difflineminus">-          if (msgSize &gt; (uint32_t) maxDownloadMsgSize)</span>
<a href="#l10.1390"></a><span id="l10.1390" class="difflineminus">-            *result = false;</span>
<a href="#l10.1391"></a><span id="l10.1391" class="difflineplus">+          if (msgSize &gt; (uint32_t)maxDownloadMsgSize) *result = false;</span>
<a href="#l10.1392"></a><span id="l10.1392">         }</span>
<a href="#l10.1393"></a><span id="l10.1393">       }</span>
<a href="#l10.1394"></a><span id="l10.1394">     }</span>
<a href="#l10.1395"></a><span id="l10.1395">   }</span>
<a href="#l10.1396"></a><span id="l10.1396">   return NS_OK;</span>
<a href="#l10.1397"></a><span id="l10.1397"> }</span>
<a href="#l10.1398"></a><span id="l10.1398"> </span>
<a href="#l10.1399"></a><span id="l10.1399" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetSupportsOffline(bool *aSupportsOffline)</span>
<a href="#l10.1400"></a><span id="l10.1400" class="difflineminus">-{</span>
<a href="#l10.1401"></a><span id="l10.1401" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetSupportsOffline(bool *aSupportsOffline) {</span>
<a href="#l10.1402"></a><span id="l10.1402">   NS_ENSURE_ARG_POINTER(aSupportsOffline);</span>
<a href="#l10.1403"></a><span id="l10.1403" class="difflineminus">-  if (mFlags &amp; nsMsgFolderFlags::Virtual)</span>
<a href="#l10.1404"></a><span id="l10.1404" class="difflineminus">-  {</span>
<a href="#l10.1405"></a><span id="l10.1405" class="difflineplus">+  if (mFlags &amp; nsMsgFolderFlags::Virtual) {</span>
<a href="#l10.1406"></a><span id="l10.1406">     *aSupportsOffline = false;</span>
<a href="#l10.1407"></a><span id="l10.1407">     return NS_OK;</span>
<a href="#l10.1408"></a><span id="l10.1408">   }</span>
<a href="#l10.1409"></a><span id="l10.1409"> </span>
<a href="#l10.1410"></a><span id="l10.1410">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.1411"></a><span id="l10.1411">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.1412"></a><span id="l10.1412" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1413"></a><span id="l10.1413" class="difflineminus">-  if (!server)</span>
<a href="#l10.1414"></a><span id="l10.1414" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.1415"></a><span id="l10.1415" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1416"></a><span id="l10.1416" class="difflineplus">+  if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l10.1417"></a><span id="l10.1417"> </span>
<a href="#l10.1418"></a><span id="l10.1418">   int32_t offlineSupportLevel;</span>
<a href="#l10.1419"></a><span id="l10.1419">   rv = server-&gt;GetOfflineSupportLevel(&amp;offlineSupportLevel);</span>
<a href="#l10.1420"></a><span id="l10.1420" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.1421"></a><span id="l10.1421" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1422"></a><span id="l10.1422"> </span>
<a href="#l10.1423"></a><span id="l10.1423">   *aSupportsOffline = (offlineSupportLevel &gt;= OFFLINE_SUPPORT_LEVEL_REGULAR);</span>
<a href="#l10.1424"></a><span id="l10.1424">   return NS_OK;</span>
<a href="#l10.1425"></a><span id="l10.1425"> }</span>
<a href="#l10.1426"></a><span id="l10.1426"> </span>
<a href="#l10.1427"></a><span id="l10.1427" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ShouldStoreMsgOffline(nsMsgKey msgKey, bool *result)</span>
<a href="#l10.1428"></a><span id="l10.1428" class="difflineminus">-{</span>
<a href="#l10.1429"></a><span id="l10.1429" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ShouldStoreMsgOffline(nsMsgKey msgKey,</span>
<a href="#l10.1430"></a><span id="l10.1430" class="difflineplus">+                                                   bool *result) {</span>
<a href="#l10.1431"></a><span id="l10.1431">   NS_ENSURE_ARG(result);</span>
<a href="#l10.1432"></a><span id="l10.1432">   uint32_t flags = 0;</span>
<a href="#l10.1433"></a><span id="l10.1433">   *result = false;</span>
<a href="#l10.1434"></a><span id="l10.1434">   GetFlags(&amp;flags);</span>
<a href="#l10.1435"></a><span id="l10.1435" class="difflineminus">-  return flags &amp; nsMsgFolderFlags::Offline ? MsgFitsDownloadCriteria(msgKey, result) : NS_OK;</span>
<a href="#l10.1436"></a><span id="l10.1436" class="difflineminus">-}</span>
<a href="#l10.1437"></a><span id="l10.1437" class="difflineminus">-</span>
<a href="#l10.1438"></a><span id="l10.1438" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::HasMsgOffline(nsMsgKey msgKey, bool *result)</span>
<a href="#l10.1439"></a><span id="l10.1439" class="difflineminus">-{</span>
<a href="#l10.1440"></a><span id="l10.1440" class="difflineplus">+  return flags &amp; nsMsgFolderFlags::Offline</span>
<a href="#l10.1441"></a><span id="l10.1441" class="difflineplus">+             ? MsgFitsDownloadCriteria(msgKey, result)</span>
<a href="#l10.1442"></a><span id="l10.1442" class="difflineplus">+             : NS_OK;</span>
<a href="#l10.1443"></a><span id="l10.1443" class="difflineplus">+}</span>
<a href="#l10.1444"></a><span id="l10.1444" class="difflineplus">+</span>
<a href="#l10.1445"></a><span id="l10.1445" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::HasMsgOffline(nsMsgKey msgKey, bool *result) {</span>
<a href="#l10.1446"></a><span id="l10.1446">   NS_ENSURE_ARG(result);</span>
<a href="#l10.1447"></a><span id="l10.1447">   *result = false;</span>
<a href="#l10.1448"></a><span id="l10.1448">   GetDatabase();</span>
<a href="#l10.1449"></a><span id="l10.1449" class="difflineminus">-  if(!mDatabase)</span>
<a href="#l10.1450"></a><span id="l10.1450" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.1451"></a><span id="l10.1451" class="difflineplus">+  if (!mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l10.1452"></a><span id="l10.1452"> </span>
<a href="#l10.1453"></a><span id="l10.1453">   nsresult rv;</span>
<a href="#l10.1454"></a><span id="l10.1454">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l10.1455"></a><span id="l10.1455">   rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l10.1456"></a><span id="l10.1456" class="difflineminus">-  if(NS_FAILED(rv))</span>
<a href="#l10.1457"></a><span id="l10.1457" class="difflineminus">-    return rv;</span>
<a href="#l10.1458"></a><span id="l10.1458" class="difflineminus">-</span>
<a href="#l10.1459"></a><span id="l10.1459" class="difflineminus">-  if (hdr)</span>
<a href="#l10.1460"></a><span id="l10.1460" class="difflineminus">-  {</span>
<a href="#l10.1461"></a><span id="l10.1461" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.1462"></a><span id="l10.1462" class="difflineplus">+</span>
<a href="#l10.1463"></a><span id="l10.1463" class="difflineplus">+  if (hdr) {</span>
<a href="#l10.1464"></a><span id="l10.1464">     uint32_t msgFlags = 0;</span>
<a href="#l10.1465"></a><span id="l10.1465">     hdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l10.1466"></a><span id="l10.1466">     // check if we already have this message body offline</span>
<a href="#l10.1467"></a><span id="l10.1467" class="difflineminus">-    if ((msgFlags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l10.1468"></a><span id="l10.1468" class="difflineminus">-      *result = true;</span>
<a href="#l10.1469"></a><span id="l10.1469" class="difflineplus">+    if ((msgFlags &amp; nsMsgMessageFlags::Offline)) *result = true;</span>
<a href="#l10.1470"></a><span id="l10.1470">   }</span>
<a href="#l10.1471"></a><span id="l10.1471">   return NS_OK;</span>
<a href="#l10.1472"></a><span id="l10.1472"> }</span>
<a href="#l10.1473"></a><span id="l10.1473"> </span>
<a href="#l10.1474"></a><span id="l10.1474" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetOfflineMsgFolder(nsMsgKey msgKey, nsIMsgFolder **aMsgFolder) {</span>
<a href="#l10.1475"></a><span id="l10.1475" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetOfflineMsgFolder(nsMsgKey msgKey,</span>
<a href="#l10.1476"></a><span id="l10.1476" class="difflineplus">+                                                 nsIMsgFolder **aMsgFolder) {</span>
<a href="#l10.1477"></a><span id="l10.1477">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l10.1478"></a><span id="l10.1478">   nsCOMPtr&lt;nsIMsgFolder&gt; subMsgFolder;</span>
<a href="#l10.1479"></a><span id="l10.1479">   GetDatabase();</span>
<a href="#l10.1480"></a><span id="l10.1480" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l10.1481"></a><span id="l10.1481" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.1482"></a><span id="l10.1482" class="difflineplus">+  if (!mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l10.1483"></a><span id="l10.1483"> </span>
<a href="#l10.1484"></a><span id="l10.1484">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l10.1485"></a><span id="l10.1485">   nsresult rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l10.1486"></a><span id="l10.1486" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.1487"></a><span id="l10.1487" class="difflineminus">-    return rv;</span>
<a href="#l10.1488"></a><span id="l10.1488" class="difflineminus">-</span>
<a href="#l10.1489"></a><span id="l10.1489" class="difflineminus">-  if (hdr)</span>
<a href="#l10.1490"></a><span id="l10.1490" class="difflineminus">-  {</span>
<a href="#l10.1491"></a><span id="l10.1491" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.1492"></a><span id="l10.1492" class="difflineplus">+</span>
<a href="#l10.1493"></a><span id="l10.1493" class="difflineplus">+  if (hdr) {</span>
<a href="#l10.1494"></a><span id="l10.1494">     uint32_t msgFlags = 0;</span>
<a href="#l10.1495"></a><span id="l10.1495">     hdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l10.1496"></a><span id="l10.1496">     // Check if we already have this message body offline</span>
<a href="#l10.1497"></a><span id="l10.1497" class="difflineminus">-    if ((msgFlags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l10.1498"></a><span id="l10.1498" class="difflineminus">-    {</span>
<a href="#l10.1499"></a><span id="l10.1499" class="difflineplus">+    if ((msgFlags &amp; nsMsgMessageFlags::Offline)) {</span>
<a href="#l10.1500"></a><span id="l10.1500">       NS_IF_ADDREF(*aMsgFolder = this);</span>
<a href="#l10.1501"></a><span id="l10.1501">       return NS_OK;</span>
<a href="#l10.1502"></a><span id="l10.1502">     }</span>
<a href="#l10.1503"></a><span id="l10.1503">   }</span>
<a href="#l10.1504"></a><span id="l10.1504">   // it's okay to not get a folder. Folder is remain unchanged in that case.</span>
<a href="#l10.1505"></a><span id="l10.1505">   return NS_OK;</span>
<a href="#l10.1506"></a><span id="l10.1506"> }</span>
<a href="#l10.1507"></a><span id="l10.1507"> </span>
<a href="#l10.1508"></a><span id="l10.1508" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetFlags(uint32_t *_retval)</span>
<a href="#l10.1509"></a><span id="l10.1509" class="difflineminus">-{</span>
<a href="#l10.1510"></a><span id="l10.1510" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetFlags(uint32_t *_retval) {</span>
<a href="#l10.1511"></a><span id="l10.1511">   ReadDBFolderInfo(false);</span>
<a href="#l10.1512"></a><span id="l10.1512">   *_retval = mFlags;</span>
<a href="#l10.1513"></a><span id="l10.1513">   return NS_OK;</span>
<a href="#l10.1514"></a><span id="l10.1514"> }</span>
<a href="#l10.1515"></a><span id="l10.1515"> </span>
<a href="#l10.1516"></a><span id="l10.1516" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element)</span>
<a href="#l10.1517"></a><span id="l10.1517" class="difflineminus">-{</span>
<a href="#l10.1518"></a><span id="l10.1518" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ReadFromFolderCacheElem(</span>
<a href="#l10.1519"></a><span id="l10.1519" class="difflineplus">+    nsIMsgFolderCacheElement *element) {</span>
<a href="#l10.1520"></a><span id="l10.1520">   nsresult rv = NS_OK;</span>
<a href="#l10.1521"></a><span id="l10.1521">   nsCString charset;</span>
<a href="#l10.1522"></a><span id="l10.1522"> </span>
<a href="#l10.1523"></a><span id="l10.1523" class="difflineminus">-  element-&gt;GetInt32Property(&quot;flags&quot;, (int32_t *) &amp;mFlags);</span>
<a href="#l10.1524"></a><span id="l10.1524" class="difflineplus">+  element-&gt;GetInt32Property(&quot;flags&quot;, (int32_t *)&amp;mFlags);</span>
<a href="#l10.1525"></a><span id="l10.1525">   element-&gt;GetInt32Property(&quot;totalMsgs&quot;, &amp;mNumTotalMessages);</span>
<a href="#l10.1526"></a><span id="l10.1526">   element-&gt;GetInt32Property(&quot;totalUnreadMsgs&quot;, &amp;mNumUnreadMessages);</span>
<a href="#l10.1527"></a><span id="l10.1527">   element-&gt;GetInt32Property(&quot;pendingUnreadMsgs&quot;, &amp;mNumPendingUnreadMessages);</span>
<a href="#l10.1528"></a><span id="l10.1528">   element-&gt;GetInt32Property(&quot;pendingMsgs&quot;, &amp;mNumPendingTotalMessages);</span>
<a href="#l10.1529"></a><span id="l10.1529">   element-&gt;GetInt64Property(&quot;expungedBytes&quot;, &amp;mExpungedBytes);</span>
<a href="#l10.1530"></a><span id="l10.1530">   element-&gt;GetInt64Property(&quot;folderSize&quot;, &amp;mFolderSize);</span>
<a href="#l10.1531"></a><span id="l10.1531">   element-&gt;GetStringProperty(&quot;charset&quot;, mCharset);</span>
<a href="#l10.1532"></a><span id="l10.1532"> </span>
<a href="#l10.1533"></a><span id="l10.1533" class="difflineat">@@ -1303,125 +1191,116 @@ NS_IMETHODIMP nsMsgDBFolder::ReadFromFol</span>
<a href="#l10.1534"></a><span id="l10.1534">   nsCString uri;</span>
<a href="#l10.1535"></a><span id="l10.1535">   GetURI(uri);</span>
<a href="#l10.1536"></a><span id="l10.1536">   printf(&quot;read total %ld for %s\n&quot;, mNumTotalMessages, uri.get());</span>
<a href="#l10.1537"></a><span id="l10.1537"> #endif</span>
<a href="#l10.1538"></a><span id="l10.1538">   mInitializedFromCache = true;</span>
<a href="#l10.1539"></a><span id="l10.1539">   return rv;</span>
<a href="#l10.1540"></a><span id="l10.1540"> }</span>
<a href="#l10.1541"></a><span id="l10.1541"> </span>
<a href="#l10.1542"></a><span id="l10.1542" class="difflineminus">-nsresult nsMsgDBFolder::GetFolderCacheKey(nsIFile **aFile, bool createDBIfMissing /* = false */)</span>
<a href="#l10.1543"></a><span id="l10.1543" class="difflineminus">-{</span>
<a href="#l10.1544"></a><span id="l10.1544" class="difflineplus">+nsresult nsMsgDBFolder::GetFolderCacheKey(</span>
<a href="#l10.1545"></a><span id="l10.1545" class="difflineplus">+    nsIFile **aFile, bool createDBIfMissing /* = false */) {</span>
<a href="#l10.1546"></a><span id="l10.1546">   nsresult rv;</span>
<a href="#l10.1547"></a><span id="l10.1547" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; path;</span>
<a href="#l10.1548"></a><span id="l10.1548" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l10.1549"></a><span id="l10.1549">   rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l10.1550"></a><span id="l10.1550"> </span>
<a href="#l10.1551"></a><span id="l10.1551">   // now we put a new file  in aFile, because we're going to change it.</span>
<a href="#l10.1552"></a><span id="l10.1552" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; dbPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1553"></a><span id="l10.1553" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dbPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1554"></a><span id="l10.1554">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1555"></a><span id="l10.1555"> </span>
<a href="#l10.1556"></a><span id="l10.1556" class="difflineminus">-  if (dbPath)</span>
<a href="#l10.1557"></a><span id="l10.1557" class="difflineminus">-  {</span>
<a href="#l10.1558"></a><span id="l10.1558" class="difflineplus">+  if (dbPath) {</span>
<a href="#l10.1559"></a><span id="l10.1559">     dbPath-&gt;InitWithFile(path);</span>
<a href="#l10.1560"></a><span id="l10.1560">     // if not a server, we need to convert to a db Path with .msf on the end</span>
<a href="#l10.1561"></a><span id="l10.1561">     bool isServer = false;</span>
<a href="#l10.1562"></a><span id="l10.1562">     GetIsServer(&amp;isServer);</span>
<a href="#l10.1563"></a><span id="l10.1563"> </span>
<a href="#l10.1564"></a><span id="l10.1564">     // if it's a server, we don't need the .msf appended to the name</span>
<a href="#l10.1565"></a><span id="l10.1565" class="difflineminus">-    if (!isServer)</span>
<a href="#l10.1566"></a><span id="l10.1566" class="difflineminus">-    {</span>
<a href="#l10.1567"></a><span id="l10.1567" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; summaryName;</span>
<a href="#l10.1568"></a><span id="l10.1568" class="difflineplus">+    if (!isServer) {</span>
<a href="#l10.1569"></a><span id="l10.1569" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; summaryName;</span>
<a href="#l10.1570"></a><span id="l10.1570">       rv = GetSummaryFileLocation(dbPath, getter_AddRefs(summaryName));</span>
<a href="#l10.1571"></a><span id="l10.1571">       dbPath-&gt;InitWithFile(summaryName);</span>
<a href="#l10.1572"></a><span id="l10.1572"> </span>
<a href="#l10.1573"></a><span id="l10.1573">       // create the .msf file</span>
<a href="#l10.1574"></a><span id="l10.1574">       // see bug #244217 for details</span>
<a href="#l10.1575"></a><span id="l10.1575">       bool exists;</span>
<a href="#l10.1576"></a><span id="l10.1576" class="difflineminus">-      if (createDBIfMissing &amp;&amp; NS_SUCCEEDED(dbPath-&gt;Exists(&amp;exists)) &amp;&amp; !exists) {</span>
<a href="#l10.1577"></a><span id="l10.1577" class="difflineplus">+      if (createDBIfMissing &amp;&amp; NS_SUCCEEDED(dbPath-&gt;Exists(&amp;exists)) &amp;&amp;</span>
<a href="#l10.1578"></a><span id="l10.1578" class="difflineplus">+          !exists) {</span>
<a href="#l10.1579"></a><span id="l10.1579">         rv = dbPath-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0644);</span>
<a href="#l10.1580"></a><span id="l10.1580">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1581"></a><span id="l10.1581">       }</span>
<a href="#l10.1582"></a><span id="l10.1582">     }</span>
<a href="#l10.1583"></a><span id="l10.1583">   }</span>
<a href="#l10.1584"></a><span id="l10.1584">   dbPath.forget(aFile);</span>
<a href="#l10.1585"></a><span id="l10.1585">   return rv;</span>
<a href="#l10.1586"></a><span id="l10.1586"> }</span>
<a href="#l10.1587"></a><span id="l10.1587"> </span>
<a href="#l10.1588"></a><span id="l10.1588" class="difflineminus">-nsresult nsMsgDBFolder::FlushToFolderCache()</span>
<a href="#l10.1589"></a><span id="l10.1589" class="difflineminus">-{</span>
<a href="#l10.1590"></a><span id="l10.1590" class="difflineplus">+nsresult nsMsgDBFolder::FlushToFolderCache() {</span>
<a href="#l10.1591"></a><span id="l10.1591">   nsresult rv;</span>
<a href="#l10.1592"></a><span id="l10.1592">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l10.1593"></a><span id="l10.1593" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.1594"></a><span id="l10.1594" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l10.1595"></a><span id="l10.1595" class="difflineminus">-  {</span>
<a href="#l10.1596"></a><span id="l10.1596" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.1597"></a><span id="l10.1597" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l10.1598"></a><span id="l10.1598">     nsCOMPtr&lt;nsIMsgFolderCache&gt; folderCache;</span>
<a href="#l10.1599"></a><span id="l10.1599">     rv = accountManager-&gt;GetFolderCache(getter_AddRefs(folderCache));</span>
<a href="#l10.1600"></a><span id="l10.1600">     if (NS_SUCCEEDED(rv) &amp;&amp; folderCache)</span>
<a href="#l10.1601"></a><span id="l10.1601">       rv = WriteToFolderCache(folderCache, false);</span>
<a href="#l10.1602"></a><span id="l10.1602">   }</span>
<a href="#l10.1603"></a><span id="l10.1603">   return rv;</span>
<a href="#l10.1604"></a><span id="l10.1604"> }</span>
<a href="#l10.1605"></a><span id="l10.1605"> </span>
<a href="#l10.1606"></a><span id="l10.1606" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::WriteToFolderCache(nsIMsgFolderCache *folderCache, bool deep)</span>
<a href="#l10.1607"></a><span id="l10.1607" class="difflineminus">-{</span>
<a href="#l10.1608"></a><span id="l10.1608" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::WriteToFolderCache(nsIMsgFolderCache *folderCache,</span>
<a href="#l10.1609"></a><span id="l10.1609" class="difflineplus">+                                                bool deep) {</span>
<a href="#l10.1610"></a><span id="l10.1610">   nsresult rv = NS_OK;</span>
<a href="#l10.1611"></a><span id="l10.1611"> </span>
<a href="#l10.1612"></a><span id="l10.1612" class="difflineminus">-  if (folderCache)</span>
<a href="#l10.1613"></a><span id="l10.1613" class="difflineminus">-  {</span>
<a href="#l10.1614"></a><span id="l10.1614" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.1615"></a><span id="l10.1615" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; dbPath;</span>
<a href="#l10.1616"></a><span id="l10.1616" class="difflineplus">+  if (folderCache) {</span>
<a href="#l10.1617"></a><span id="l10.1617" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.1618"></a><span id="l10.1618" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l10.1619"></a><span id="l10.1619">     rv = GetFolderCacheKey(getter_AddRefs(dbPath));</span>
<a href="#l10.1620"></a><span id="l10.1620"> #ifdef DEBUG_bienvenu1</span>
<a href="#l10.1621"></a><span id="l10.1621">     bool exists;</span>
<a href="#l10.1622"></a><span id="l10.1622" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(dbPath-&gt;Exists(&amp;exists)) &amp;&amp; exists, &quot;file spec we're adding to cache should exist&quot;);</span>
<a href="#l10.1623"></a><span id="l10.1623" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(dbPath-&gt;Exists(&amp;exists)) &amp;&amp; exists,</span>
<a href="#l10.1624"></a><span id="l10.1624" class="difflineplus">+                 &quot;file spec we're adding to cache should exist&quot;);</span>
<a href="#l10.1625"></a><span id="l10.1625"> #endif</span>
<a href="#l10.1626"></a><span id="l10.1626" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; dbPath)</span>
<a href="#l10.1627"></a><span id="l10.1627" class="difflineminus">-    {</span>
<a href="#l10.1628"></a><span id="l10.1628" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; dbPath) {</span>
<a href="#l10.1629"></a><span id="l10.1629">       nsCString persistentPath;</span>
<a href="#l10.1630"></a><span id="l10.1630">       rv = dbPath-&gt;GetPersistentDescriptor(persistentPath);</span>
<a href="#l10.1631"></a><span id="l10.1631">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1632"></a><span id="l10.1632" class="difflineminus">-      rv = folderCache-&gt;GetCacheElement(persistentPath, true, getter_AddRefs(cacheElement));</span>
<a href="#l10.1633"></a><span id="l10.1633" class="difflineplus">+      rv = folderCache-&gt;GetCacheElement(persistentPath, true,</span>
<a href="#l10.1634"></a><span id="l10.1634" class="difflineplus">+                                        getter_AddRefs(cacheElement));</span>
<a href="#l10.1635"></a><span id="l10.1635">       if (NS_SUCCEEDED(rv) &amp;&amp; cacheElement)</span>
<a href="#l10.1636"></a><span id="l10.1636">         rv = WriteToFolderCacheElem(cacheElement);</span>
<a href="#l10.1637"></a><span id="l10.1637">     }</span>
<a href="#l10.1638"></a><span id="l10.1638">   }</span>
<a href="#l10.1639"></a><span id="l10.1639"> </span>
<a href="#l10.1640"></a><span id="l10.1640" class="difflineminus">-  if (!deep)</span>
<a href="#l10.1641"></a><span id="l10.1641" class="difflineminus">-    return rv;</span>
<a href="#l10.1642"></a><span id="l10.1642" class="difflineplus">+  if (!deep) return rv;</span>
<a href="#l10.1643"></a><span id="l10.1643"> </span>
<a href="#l10.1644"></a><span id="l10.1644">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l10.1645"></a><span id="l10.1645">   rv = GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l10.1646"></a><span id="l10.1646" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.1647"></a><span id="l10.1647" class="difflineminus">-    return rv;</span>
<a href="#l10.1648"></a><span id="l10.1648" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.1649"></a><span id="l10.1649"> </span>
<a href="#l10.1650"></a><span id="l10.1650">   bool hasMore;</span>
<a href="#l10.1651"></a><span id="l10.1651" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l10.1652"></a><span id="l10.1652" class="difflineminus">-  {</span>
<a href="#l10.1653"></a><span id="l10.1653" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l10.1654"></a><span id="l10.1654">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l10.1655"></a><span id="l10.1655">     enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l10.1656"></a><span id="l10.1656"> </span>
<a href="#l10.1657"></a><span id="l10.1657">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryInterface(item));</span>
<a href="#l10.1658"></a><span id="l10.1658" class="difflineminus">-    if (!msgFolder)</span>
<a href="#l10.1659"></a><span id="l10.1659" class="difflineminus">-      continue;</span>
<a href="#l10.1660"></a><span id="l10.1660" class="difflineminus">-</span>
<a href="#l10.1661"></a><span id="l10.1661" class="difflineminus">-    if (folderCache)</span>
<a href="#l10.1662"></a><span id="l10.1662" class="difflineminus">-    {</span>
<a href="#l10.1663"></a><span id="l10.1663" class="difflineplus">+    if (!msgFolder) continue;</span>
<a href="#l10.1664"></a><span id="l10.1664" class="difflineplus">+</span>
<a href="#l10.1665"></a><span id="l10.1665" class="difflineplus">+    if (folderCache) {</span>
<a href="#l10.1666"></a><span id="l10.1666">       rv = msgFolder-&gt;WriteToFolderCache(folderCache, true);</span>
<a href="#l10.1667"></a><span id="l10.1667" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l10.1668"></a><span id="l10.1668" class="difflineminus">-        break;</span>
<a href="#l10.1669"></a><span id="l10.1669" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l10.1670"></a><span id="l10.1670">     }</span>
<a href="#l10.1671"></a><span id="l10.1671">   }</span>
<a href="#l10.1672"></a><span id="l10.1672">   return rv;</span>
<a href="#l10.1673"></a><span id="l10.1673"> }</span>
<a href="#l10.1674"></a><span id="l10.1674"> </span>
<a href="#l10.1675"></a><span id="l10.1675" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::WriteToFolderCacheElem(nsIMsgFolderCacheElement *element)</span>
<a href="#l10.1676"></a><span id="l10.1676" class="difflineminus">-{</span>
<a href="#l10.1677"></a><span id="l10.1677" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::WriteToFolderCacheElem(</span>
<a href="#l10.1678"></a><span id="l10.1678" class="difflineplus">+    nsIMsgFolderCacheElement *element) {</span>
<a href="#l10.1679"></a><span id="l10.1679">   nsresult rv = NS_OK;</span>
<a href="#l10.1680"></a><span id="l10.1680"> </span>
<a href="#l10.1681"></a><span id="l10.1681" class="difflineminus">-  element-&gt;SetInt32Property(&quot;flags&quot;, (int32_t) mFlags);</span>
<a href="#l10.1682"></a><span id="l10.1682" class="difflineplus">+  element-&gt;SetInt32Property(&quot;flags&quot;, (int32_t)mFlags);</span>
<a href="#l10.1683"></a><span id="l10.1683">   element-&gt;SetInt32Property(&quot;totalMsgs&quot;, mNumTotalMessages);</span>
<a href="#l10.1684"></a><span id="l10.1684">   element-&gt;SetInt32Property(&quot;totalUnreadMsgs&quot;, mNumUnreadMessages);</span>
<a href="#l10.1685"></a><span id="l10.1685">   element-&gt;SetInt32Property(&quot;pendingUnreadMsgs&quot;, mNumPendingUnreadMessages);</span>
<a href="#l10.1686"></a><span id="l10.1686">   element-&gt;SetInt32Property(&quot;pendingMsgs&quot;, mNumPendingTotalMessages);</span>
<a href="#l10.1687"></a><span id="l10.1687">   element-&gt;SetInt64Property(&quot;expungedBytes&quot;, mExpungedBytes);</span>
<a href="#l10.1688"></a><span id="l10.1688">   element-&gt;SetInt64Property(&quot;folderSize&quot;, mFolderSize);</span>
<a href="#l10.1689"></a><span id="l10.1689">   element-&gt;SetStringProperty(&quot;charset&quot;, mCharset);</span>
<a href="#l10.1690"></a><span id="l10.1690"> </span>
<a href="#l10.1691"></a><span id="l10.1691" class="difflineat">@@ -1429,18 +1308,18 @@ NS_IMETHODIMP nsMsgDBFolder::WriteToFold</span>
<a href="#l10.1692"></a><span id="l10.1692">   nsCString uri;</span>
<a href="#l10.1693"></a><span id="l10.1693">   GetURI(uri);</span>
<a href="#l10.1694"></a><span id="l10.1694">   printf(&quot;writing total %ld for %s\n&quot;, mNumTotalMessages, uri.get());</span>
<a href="#l10.1695"></a><span id="l10.1695"> #endif</span>
<a href="#l10.1696"></a><span id="l10.1696">   return rv;</span>
<a href="#l10.1697"></a><span id="l10.1697"> }</span>
<a href="#l10.1698"></a><span id="l10.1698"> </span>
<a href="#l10.1699"></a><span id="l10.1699"> NS_IMETHODIMP</span>
<a href="#l10.1700"></a><span id="l10.1700" class="difflineminus">-nsMsgDBFolder::AddMessageDispositionState(nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag)</span>
<a href="#l10.1701"></a><span id="l10.1701" class="difflineminus">-{</span>
<a href="#l10.1702"></a><span id="l10.1702" class="difflineplus">+nsMsgDBFolder::AddMessageDispositionState(</span>
<a href="#l10.1703"></a><span id="l10.1703" class="difflineplus">+    nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) {</span>
<a href="#l10.1704"></a><span id="l10.1704">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l10.1705"></a><span id="l10.1705"> </span>
<a href="#l10.1706"></a><span id="l10.1706">   nsresult rv = GetDatabase();</span>
<a href="#l10.1707"></a><span id="l10.1707">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l10.1708"></a><span id="l10.1708"> </span>
<a href="#l10.1709"></a><span id="l10.1709">   nsMsgKey msgKey;</span>
<a href="#l10.1710"></a><span id="l10.1710">   aMessage-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.1711"></a><span id="l10.1711"> </span>
<a href="#l10.1712"></a><span id="l10.1712" class="difflineat">@@ -1448,21 +1327,19 @@ nsMsgDBFolder::AddMessageDispositionStat</span>
<a href="#l10.1713"></a><span id="l10.1713">     mDatabase-&gt;MarkReplied(msgKey, true, nullptr);</span>
<a href="#l10.1714"></a><span id="l10.1714">   else if (aDispositionFlag == nsIMsgFolder::nsMsgDispositionState_Forwarded)</span>
<a href="#l10.1715"></a><span id="l10.1715">     mDatabase-&gt;MarkForwarded(msgKey, true, nullptr);</span>
<a href="#l10.1716"></a><span id="l10.1716">   return NS_OK;</span>
<a href="#l10.1717"></a><span id="l10.1717"> }</span>
<a href="#l10.1718"></a><span id="l10.1718"> </span>
<a href="#l10.1719"></a><span id="l10.1719"> nsresult nsMsgDBFolder::AddMarkAllReadUndoAction(nsIMsgWindow *msgWindow,</span>
<a href="#l10.1720"></a><span id="l10.1720">                                                  nsMsgKey *thoseMarked,</span>
<a href="#l10.1721"></a><span id="l10.1721" class="difflineminus">-                                                 uint32_t numMarked)</span>
<a href="#l10.1722"></a><span id="l10.1722" class="difflineminus">-{</span>
<a href="#l10.1723"></a><span id="l10.1723" class="difflineplus">+                                                 uint32_t numMarked) {</span>
<a href="#l10.1724"></a><span id="l10.1724">   RefPtr&lt;nsMsgReadStateTxn&gt; readStateTxn = new nsMsgReadStateTxn();</span>
<a href="#l10.1725"></a><span id="l10.1725" class="difflineminus">-  if (!readStateTxn)</span>
<a href="#l10.1726"></a><span id="l10.1726" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.1727"></a><span id="l10.1727" class="difflineplus">+  if (!readStateTxn) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.1728"></a><span id="l10.1728"> </span>
<a href="#l10.1729"></a><span id="l10.1729">   nsresult rv = readStateTxn-&gt;Init(this, numMarked, thoseMarked);</span>
<a href="#l10.1730"></a><span id="l10.1730">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1731"></a><span id="l10.1731"> </span>
<a href="#l10.1732"></a><span id="l10.1732">   rv = readStateTxn-&gt;SetTransactionType(nsIMessenger::eMarkAllMsg);</span>
<a href="#l10.1733"></a><span id="l10.1733">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1734"></a><span id="l10.1734"> </span>
<a href="#l10.1735"></a><span id="l10.1735">   nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l10.1736"></a><span id="l10.1736" class="difflineat">@@ -1470,23 +1347,21 @@ nsresult nsMsgDBFolder::AddMarkAllReadUn</span>
<a href="#l10.1737"></a><span id="l10.1737">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1738"></a><span id="l10.1738"> </span>
<a href="#l10.1739"></a><span id="l10.1739">   rv = txnMgr-&gt;DoTransaction(readStateTxn);</span>
<a href="#l10.1740"></a><span id="l10.1740">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1741"></a><span id="l10.1741">   return rv;</span>
<a href="#l10.1742"></a><span id="l10.1742"> }</span>
<a href="#l10.1743"></a><span id="l10.1743"> </span>
<a href="#l10.1744"></a><span id="l10.1744"> NS_IMETHODIMP</span>
<a href="#l10.1745"></a><span id="l10.1745" class="difflineminus">-nsMsgDBFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.1746"></a><span id="l10.1746" class="difflineminus">-{</span>
<a href="#l10.1747"></a><span id="l10.1747" class="difflineplus">+nsMsgDBFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l10.1748"></a><span id="l10.1748">   nsresult rv = GetDatabase();</span>
<a href="#l10.1749"></a><span id="l10.1749">   m_newMsgs.Clear();</span>
<a href="#l10.1750"></a><span id="l10.1750"> </span>
<a href="#l10.1751"></a><span id="l10.1751" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1752"></a><span id="l10.1752" class="difflineminus">-  {</span>
<a href="#l10.1753"></a><span id="l10.1753" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.1754"></a><span id="l10.1754">     EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l10.1755"></a><span id="l10.1755">     nsMsgKey *thoseMarked;</span>
<a href="#l10.1756"></a><span id="l10.1756">     uint32_t numMarked;</span>
<a href="#l10.1757"></a><span id="l10.1757">     rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l10.1758"></a><span id="l10.1758">     EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l10.1759"></a><span id="l10.1759">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1760"></a><span id="l10.1760"> </span>
<a href="#l10.1761"></a><span id="l10.1761">     // Setup a undo-state</span>
<a href="#l10.1762"></a><span id="l10.1762" class="difflineat">@@ -1494,1042 +1369,961 @@ nsMsgDBFolder::MarkAllMessagesRead(nsIMs</span>
<a href="#l10.1763"></a><span id="l10.1763">       rv = AddMarkAllReadUndoAction(aMsgWindow, thoseMarked, numMarked);</span>
<a href="#l10.1764"></a><span id="l10.1764">     free(thoseMarked);</span>
<a href="#l10.1765"></a><span id="l10.1765">   }</span>
<a href="#l10.1766"></a><span id="l10.1766"> </span>
<a href="#l10.1767"></a><span id="l10.1767">   SetHasNewMessages(false);</span>
<a href="#l10.1768"></a><span id="l10.1768">   return rv;</span>
<a href="#l10.1769"></a><span id="l10.1769"> }</span>
<a href="#l10.1770"></a><span id="l10.1770"> </span>
<a href="#l10.1771"></a><span id="l10.1771" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::MarkThreadRead(nsIMsgThread *thread)</span>
<a href="#l10.1772"></a><span id="l10.1772" class="difflineminus">-{</span>
<a href="#l10.1773"></a><span id="l10.1773" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::MarkThreadRead(nsIMsgThread *thread) {</span>
<a href="#l10.1774"></a><span id="l10.1774">   nsresult rv = GetDatabase();</span>
<a href="#l10.1775"></a><span id="l10.1775" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l10.1776"></a><span id="l10.1776" class="difflineminus">-  {</span>
<a href="#l10.1777"></a><span id="l10.1777" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.1778"></a><span id="l10.1778">     nsMsgKey *keys;</span>
<a href="#l10.1779"></a><span id="l10.1779">     uint32_t numKeys;</span>
<a href="#l10.1780"></a><span id="l10.1780">     rv = mDatabase-&gt;MarkThreadRead(thread, nullptr, &amp;numKeys, &amp;keys);</span>
<a href="#l10.1781"></a><span id="l10.1781">     free(keys);</span>
<a href="#l10.1782"></a><span id="l10.1782">   }</span>
<a href="#l10.1783"></a><span id="l10.1783">   return rv;</span>
<a href="#l10.1784"></a><span id="l10.1784"> }</span>
<a href="#l10.1785"></a><span id="l10.1785"> </span>
<a href="#l10.1786"></a><span id="l10.1786"> NS_IMETHODIMP</span>
<a href="#l10.1787"></a><span id="l10.1787" class="difflineminus">-nsMsgDBFolder::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l10.1788"></a><span id="l10.1788" class="difflineminus">-{</span>
<a href="#l10.1789"></a><span id="l10.1789" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.1790"></a><span id="l10.1790" class="difflineminus">-}</span>
<a href="#l10.1791"></a><span id="l10.1791" class="difflineplus">+nsMsgDBFolder::OnStartRunningUrl(nsIURI *aUrl) { return NS_OK; }</span>
<a href="#l10.1792"></a><span id="l10.1792"> </span>
<a href="#l10.1793"></a><span id="l10.1793"> NS_IMETHODIMP</span>
<a href="#l10.1794"></a><span id="l10.1794" class="difflineminus">-nsMsgDBFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l10.1795"></a><span id="l10.1795" class="difflineminus">-{</span>
<a href="#l10.1796"></a><span id="l10.1796" class="difflineplus">+nsMsgDBFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l10.1797"></a><span id="l10.1797">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l10.1798"></a><span id="l10.1798">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUrl);</span>
<a href="#l10.1799"></a><span id="l10.1799" class="difflineminus">-  if (mailUrl)</span>
<a href="#l10.1800"></a><span id="l10.1800" class="difflineminus">-  {</span>
<a href="#l10.1801"></a><span id="l10.1801" class="difflineplus">+  if (mailUrl) {</span>
<a href="#l10.1802"></a><span id="l10.1802">     bool updatingFolder = false;</span>
<a href="#l10.1803"></a><span id="l10.1803" class="difflineminus">-    if (NS_SUCCEEDED(mailUrl-&gt;GetUpdatingFolder(&amp;updatingFolder)) &amp;&amp; updatingFolder)</span>
<a href="#l10.1804"></a><span id="l10.1804" class="difflineplus">+    if (NS_SUCCEEDED(mailUrl-&gt;GetUpdatingFolder(&amp;updatingFolder)) &amp;&amp;</span>
<a href="#l10.1805"></a><span id="l10.1805" class="difflineplus">+        updatingFolder)</span>
<a href="#l10.1806"></a><span id="l10.1806">       NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l10.1807"></a><span id="l10.1807"> </span>
<a href="#l10.1808"></a><span id="l10.1808">     // be sure to remove ourselves as a url listener</span>
<a href="#l10.1809"></a><span id="l10.1809">     mailUrl-&gt;UnRegisterListener(this);</span>
<a href="#l10.1810"></a><span id="l10.1810">   }</span>
<a href="#l10.1811"></a><span id="l10.1811">   return NS_OK;</span>
<a href="#l10.1812"></a><span id="l10.1812"> }</span>
<a href="#l10.1813"></a><span id="l10.1813"> </span>
<a href="#l10.1814"></a><span id="l10.1814"> NS_IMETHODIMP</span>
<a href="#l10.1815"></a><span id="l10.1815" class="difflineminus">-nsMsgDBFolder::GetRetentionSettings(nsIMsgRetentionSettings **settings)</span>
<a href="#l10.1816"></a><span id="l10.1816" class="difflineminus">-{</span>
<a href="#l10.1817"></a><span id="l10.1817" class="difflineplus">+nsMsgDBFolder::GetRetentionSettings(nsIMsgRetentionSettings **settings) {</span>
<a href="#l10.1818"></a><span id="l10.1818">   NS_ENSURE_ARG_POINTER(settings);</span>
<a href="#l10.1819"></a><span id="l10.1819">   *settings = nullptr;</span>
<a href="#l10.1820"></a><span id="l10.1820">   nsresult rv = NS_OK;</span>
<a href="#l10.1821"></a><span id="l10.1821">   bool useServerDefaults = false;</span>
<a href="#l10.1822"></a><span id="l10.1822" class="difflineminus">-  if (!m_retentionSettings)</span>
<a href="#l10.1823"></a><span id="l10.1823" class="difflineminus">-  {</span>
<a href="#l10.1824"></a><span id="l10.1824" class="difflineplus">+  if (!m_retentionSettings) {</span>
<a href="#l10.1825"></a><span id="l10.1825">     nsCString useServerRetention;</span>
<a href="#l10.1826"></a><span id="l10.1826">     GetStringProperty(kUseServerRetentionProp, useServerRetention);</span>
<a href="#l10.1827"></a><span id="l10.1827" class="difflineminus">-    if (useServerRetention.EqualsLiteral(&quot;1&quot;))</span>
<a href="#l10.1828"></a><span id="l10.1828" class="difflineminus">-    {</span>
<a href="#l10.1829"></a><span id="l10.1829" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1830"></a><span id="l10.1830" class="difflineplus">+    if (useServerRetention.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l10.1831"></a><span id="l10.1831" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1832"></a><span id="l10.1832">       rv = GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l10.1833"></a><span id="l10.1833" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer)</span>
<a href="#l10.1834"></a><span id="l10.1834" class="difflineminus">-      {</span>
<a href="#l10.1835"></a><span id="l10.1835" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer) {</span>
<a href="#l10.1836"></a><span id="l10.1836">         rv = incomingServer-&gt;GetRetentionSettings(settings);</span>
<a href="#l10.1837"></a><span id="l10.1837">         useServerDefaults = true;</span>
<a href="#l10.1838"></a><span id="l10.1838">       }</span>
<a href="#l10.1839"></a><span id="l10.1839" class="difflineminus">-    }</span>
<a href="#l10.1840"></a><span id="l10.1840" class="difflineminus">-    else</span>
<a href="#l10.1841"></a><span id="l10.1841" class="difflineminus">-    {</span>
<a href="#l10.1842"></a><span id="l10.1842" class="difflineplus">+    } else {</span>
<a href="#l10.1843"></a><span id="l10.1843">       GetDatabase();</span>
<a href="#l10.1844"></a><span id="l10.1844" class="difflineminus">-      if (mDatabase)</span>
<a href="#l10.1845"></a><span id="l10.1845" class="difflineminus">-      {</span>
<a href="#l10.1846"></a><span id="l10.1846" class="difflineminus">-        // get the settings from the db - if the settings from the db say the folder</span>
<a href="#l10.1847"></a><span id="l10.1847" class="difflineminus">-        // is not overriding the incoming server settings, get the settings from the</span>
<a href="#l10.1848"></a><span id="l10.1848" class="difflineminus">-        // server.</span>
<a href="#l10.1849"></a><span id="l10.1849" class="difflineplus">+      if (mDatabase) {</span>
<a href="#l10.1850"></a><span id="l10.1850" class="difflineplus">+        // get the settings from the db - if the settings from the db say the</span>
<a href="#l10.1851"></a><span id="l10.1851" class="difflineplus">+        // folder is not overriding the incoming server settings, get the</span>
<a href="#l10.1852"></a><span id="l10.1852" class="difflineplus">+        // settings from the server.</span>
<a href="#l10.1853"></a><span id="l10.1853">         rv = mDatabase-&gt;GetMsgRetentionSettings(settings);</span>
<a href="#l10.1854"></a><span id="l10.1854" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; *settings)</span>
<a href="#l10.1855"></a><span id="l10.1855" class="difflineminus">-        {</span>
<a href="#l10.1856"></a><span id="l10.1856" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; *settings) {</span>
<a href="#l10.1857"></a><span id="l10.1857">           (*settings)-&gt;GetUseServerDefaults(&amp;useServerDefaults);</span>
<a href="#l10.1858"></a><span id="l10.1858" class="difflineminus">-          if (useServerDefaults)</span>
<a href="#l10.1859"></a><span id="l10.1859" class="difflineminus">-          {</span>
<a href="#l10.1860"></a><span id="l10.1860" class="difflineminus">-            nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1861"></a><span id="l10.1861" class="difflineplus">+          if (useServerDefaults) {</span>
<a href="#l10.1862"></a><span id="l10.1862" class="difflineplus">+            nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1863"></a><span id="l10.1863">             rv = GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l10.1864"></a><span id="l10.1864">             NS_IF_RELEASE(*settings);</span>
<a href="#l10.1865"></a><span id="l10.1865">             if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer)</span>
<a href="#l10.1866"></a><span id="l10.1866">               incomingServer-&gt;GetRetentionSettings(settings);</span>
<a href="#l10.1867"></a><span id="l10.1867">           }</span>
<a href="#l10.1868"></a><span id="l10.1868" class="difflineminus">-          if (useServerRetention.EqualsLiteral(&quot;1&quot;) != useServerDefaults)</span>
<a href="#l10.1869"></a><span id="l10.1869" class="difflineminus">-          {</span>
<a href="#l10.1870"></a><span id="l10.1870" class="difflineplus">+          if (useServerRetention.EqualsLiteral(&quot;1&quot;) != useServerDefaults) {</span>
<a href="#l10.1871"></a><span id="l10.1871">             if (useServerDefaults)</span>
<a href="#l10.1872"></a><span id="l10.1872">               useServerRetention.Assign('1');</span>
<a href="#l10.1873"></a><span id="l10.1873">             else</span>
<a href="#l10.1874"></a><span id="l10.1874">               useServerRetention.Assign('0');</span>
<a href="#l10.1875"></a><span id="l10.1875">             SetStringProperty(kUseServerRetentionProp, useServerRetention);</span>
<a href="#l10.1876"></a><span id="l10.1876">           }</span>
<a href="#l10.1877"></a><span id="l10.1877">         }</span>
<a href="#l10.1878"></a><span id="l10.1878" class="difflineminus">-      }</span>
<a href="#l10.1879"></a><span id="l10.1879" class="difflineminus">-      else</span>
<a href="#l10.1880"></a><span id="l10.1880" class="difflineplus">+      } else</span>
<a href="#l10.1881"></a><span id="l10.1881">         return NS_ERROR_FAILURE;</span>
<a href="#l10.1882"></a><span id="l10.1882">     }</span>
<a href="#l10.1883"></a><span id="l10.1883">     // Only cache the retention settings if we've overridden the server</span>
<a href="#l10.1884"></a><span id="l10.1884">     // settings (otherwise, we won't notice changes to the server settings).</span>
<a href="#l10.1885"></a><span id="l10.1885" class="difflineminus">-    if (!useServerDefaults)</span>
<a href="#l10.1886"></a><span id="l10.1886" class="difflineminus">-      m_retentionSettings = *settings;</span>
<a href="#l10.1887"></a><span id="l10.1887" class="difflineminus">-  }</span>
<a href="#l10.1888"></a><span id="l10.1888" class="difflineminus">-  else</span>
<a href="#l10.1889"></a><span id="l10.1889" class="difflineplus">+    if (!useServerDefaults) m_retentionSettings = *settings;</span>
<a href="#l10.1890"></a><span id="l10.1890" class="difflineplus">+  } else</span>
<a href="#l10.1891"></a><span id="l10.1891">     NS_IF_ADDREF(*settings = m_retentionSettings);</span>
<a href="#l10.1892"></a><span id="l10.1892"> </span>
<a href="#l10.1893"></a><span id="l10.1893">   return rv;</span>
<a href="#l10.1894"></a><span id="l10.1894"> }</span>
<a href="#l10.1895"></a><span id="l10.1895"> </span>
<a href="#l10.1896"></a><span id="l10.1896" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetRetentionSettings(nsIMsgRetentionSettings *settings)</span>
<a href="#l10.1897"></a><span id="l10.1897" class="difflineminus">-{</span>
<a href="#l10.1898"></a><span id="l10.1898" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetRetentionSettings(</span>
<a href="#l10.1899"></a><span id="l10.1899" class="difflineplus">+    nsIMsgRetentionSettings *settings) {</span>
<a href="#l10.1900"></a><span id="l10.1900">   bool useServerDefaults;</span>
<a href="#l10.1901"></a><span id="l10.1901">   nsCString useServerRetention;</span>
<a href="#l10.1902"></a><span id="l10.1902"> </span>
<a href="#l10.1903"></a><span id="l10.1903">   settings-&gt;GetUseServerDefaults(&amp;useServerDefaults);</span>
<a href="#l10.1904"></a><span id="l10.1904" class="difflineminus">-  if (useServerDefaults)</span>
<a href="#l10.1905"></a><span id="l10.1905" class="difflineminus">-  {</span>
<a href="#l10.1906"></a><span id="l10.1906" class="difflineplus">+  if (useServerDefaults) {</span>
<a href="#l10.1907"></a><span id="l10.1907">     useServerRetention.Assign('1');</span>
<a href="#l10.1908"></a><span id="l10.1908">     m_retentionSettings = nullptr;</span>
<a href="#l10.1909"></a><span id="l10.1909" class="difflineminus">-  }</span>
<a href="#l10.1910"></a><span id="l10.1910" class="difflineminus">-  else</span>
<a href="#l10.1911"></a><span id="l10.1911" class="difflineminus">-  {</span>
<a href="#l10.1912"></a><span id="l10.1912" class="difflineplus">+  } else {</span>
<a href="#l10.1913"></a><span id="l10.1913">     useServerRetention.Assign('0');</span>
<a href="#l10.1914"></a><span id="l10.1914">     m_retentionSettings = settings;</span>
<a href="#l10.1915"></a><span id="l10.1915">   }</span>
<a href="#l10.1916"></a><span id="l10.1916">   SetStringProperty(kUseServerRetentionProp, useServerRetention);</span>
<a href="#l10.1917"></a><span id="l10.1917">   GetDatabase();</span>
<a href="#l10.1918"></a><span id="l10.1918" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.1919"></a><span id="l10.1919" class="difflineminus">-    mDatabase-&gt;SetMsgRetentionSettings(settings);</span>
<a href="#l10.1920"></a><span id="l10.1920" class="difflineplus">+  if (mDatabase) mDatabase-&gt;SetMsgRetentionSettings(settings);</span>
<a href="#l10.1921"></a><span id="l10.1921">   return NS_OK;</span>
<a href="#l10.1922"></a><span id="l10.1922"> }</span>
<a href="#l10.1923"></a><span id="l10.1923"> </span>
<a href="#l10.1924"></a><span id="l10.1924" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetDownloadSettings(nsIMsgDownloadSettings **settings)</span>
<a href="#l10.1925"></a><span id="l10.1925" class="difflineminus">-{</span>
<a href="#l10.1926"></a><span id="l10.1926" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetDownloadSettings(</span>
<a href="#l10.1927"></a><span id="l10.1927" class="difflineplus">+    nsIMsgDownloadSettings **settings) {</span>
<a href="#l10.1928"></a><span id="l10.1928">   NS_ENSURE_ARG_POINTER(settings);</span>
<a href="#l10.1929"></a><span id="l10.1929">   nsresult rv = NS_OK;</span>
<a href="#l10.1930"></a><span id="l10.1930" class="difflineminus">-  if (!m_downloadSettings)</span>
<a href="#l10.1931"></a><span id="l10.1931" class="difflineminus">-  {</span>
<a href="#l10.1932"></a><span id="l10.1932" class="difflineplus">+  if (!m_downloadSettings) {</span>
<a href="#l10.1933"></a><span id="l10.1933">     GetDatabase();</span>
<a href="#l10.1934"></a><span id="l10.1934" class="difflineminus">-    if (mDatabase)</span>
<a href="#l10.1935"></a><span id="l10.1935" class="difflineminus">-    {</span>
<a href="#l10.1936"></a><span id="l10.1936" class="difflineminus">-      // get the settings from the db - if the settings from the db say the folder</span>
<a href="#l10.1937"></a><span id="l10.1937" class="difflineminus">-      // is not overriding the incoming server settings, get the settings from the</span>
<a href="#l10.1938"></a><span id="l10.1938" class="difflineminus">-      // server.</span>
<a href="#l10.1939"></a><span id="l10.1939" class="difflineminus">-      rv = mDatabase-&gt;GetMsgDownloadSettings(getter_AddRefs(m_downloadSettings));</span>
<a href="#l10.1940"></a><span id="l10.1940" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; m_downloadSettings)</span>
<a href="#l10.1941"></a><span id="l10.1941" class="difflineminus">-      {</span>
<a href="#l10.1942"></a><span id="l10.1942" class="difflineplus">+    if (mDatabase) {</span>
<a href="#l10.1943"></a><span id="l10.1943" class="difflineplus">+      // get the settings from the db - if the settings from the db say the</span>
<a href="#l10.1944"></a><span id="l10.1944" class="difflineplus">+      // folder is not overriding the incoming server settings, get the settings</span>
<a href="#l10.1945"></a><span id="l10.1945" class="difflineplus">+      // from the server.</span>
<a href="#l10.1946"></a><span id="l10.1946" class="difflineplus">+      rv =</span>
<a href="#l10.1947"></a><span id="l10.1947" class="difflineplus">+          mDatabase-&gt;GetMsgDownloadSettings(getter_AddRefs(m_downloadSettings));</span>
<a href="#l10.1948"></a><span id="l10.1948" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; m_downloadSettings) {</span>
<a href="#l10.1949"></a><span id="l10.1949">         bool useServerDefaults;</span>
<a href="#l10.1950"></a><span id="l10.1950">         m_downloadSettings-&gt;GetUseServerDefaults(&amp;useServerDefaults);</span>
<a href="#l10.1951"></a><span id="l10.1951" class="difflineminus">-        if (useServerDefaults)</span>
<a href="#l10.1952"></a><span id="l10.1952" class="difflineminus">-        {</span>
<a href="#l10.1953"></a><span id="l10.1953" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1954"></a><span id="l10.1954" class="difflineplus">+        if (useServerDefaults) {</span>
<a href="#l10.1955"></a><span id="l10.1955" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l10.1956"></a><span id="l10.1956">           rv = GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l10.1957"></a><span id="l10.1957">           if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer)</span>
<a href="#l10.1958"></a><span id="l10.1958" class="difflineminus">-            incomingServer-&gt;GetDownloadSettings(getter_AddRefs(m_downloadSettings));</span>
<a href="#l10.1959"></a><span id="l10.1959" class="difflineplus">+            incomingServer-&gt;GetDownloadSettings(</span>
<a href="#l10.1960"></a><span id="l10.1960" class="difflineplus">+                getter_AddRefs(m_downloadSettings));</span>
<a href="#l10.1961"></a><span id="l10.1961">         }</span>
<a href="#l10.1962"></a><span id="l10.1962">       }</span>
<a href="#l10.1963"></a><span id="l10.1963">     }</span>
<a href="#l10.1964"></a><span id="l10.1964">   }</span>
<a href="#l10.1965"></a><span id="l10.1965">   NS_IF_ADDREF(*settings = m_downloadSettings);</span>
<a href="#l10.1966"></a><span id="l10.1966">   return rv;</span>
<a href="#l10.1967"></a><span id="l10.1967"> }</span>
<a href="#l10.1968"></a><span id="l10.1968"> </span>
<a href="#l10.1969"></a><span id="l10.1969" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetDownloadSettings(nsIMsgDownloadSettings *settings)</span>
<a href="#l10.1970"></a><span id="l10.1970" class="difflineminus">-{</span>
<a href="#l10.1971"></a><span id="l10.1971" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetDownloadSettings(</span>
<a href="#l10.1972"></a><span id="l10.1972" class="difflineplus">+    nsIMsgDownloadSettings *settings) {</span>
<a href="#l10.1973"></a><span id="l10.1973">   m_downloadSettings = settings;</span>
<a href="#l10.1974"></a><span id="l10.1974">   return NS_OK;</span>
<a href="#l10.1975"></a><span id="l10.1975"> }</span>
<a href="#l10.1976"></a><span id="l10.1976"> </span>
<a href="#l10.1977"></a><span id="l10.1977" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::IsCommandEnabled(const nsACString&amp; command, bool *result)</span>
<a href="#l10.1978"></a><span id="l10.1978" class="difflineminus">-{</span>
<a href="#l10.1979"></a><span id="l10.1979" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::IsCommandEnabled(const nsACString &amp;command,</span>
<a href="#l10.1980"></a><span id="l10.1980" class="difflineplus">+                                              bool *result) {</span>
<a href="#l10.1981"></a><span id="l10.1981">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l10.1982"></a><span id="l10.1982">   *result = true;</span>
<a href="#l10.1983"></a><span id="l10.1983">   return NS_OK;</span>
<a href="#l10.1984"></a><span id="l10.1984"> }</span>
<a href="#l10.1985"></a><span id="l10.1985"> </span>
<a href="#l10.1986"></a><span id="l10.1986" class="difflineminus">-nsresult nsMsgDBFolder::WriteStartOfNewLocalMessage()</span>
<a href="#l10.1987"></a><span id="l10.1987" class="difflineminus">-{</span>
<a href="#l10.1988"></a><span id="l10.1988" class="difflineplus">+nsresult nsMsgDBFolder::WriteStartOfNewLocalMessage() {</span>
<a href="#l10.1989"></a><span id="l10.1989">   nsAutoCString result;</span>
<a href="#l10.1990"></a><span id="l10.1990">   uint32_t writeCount;</span>
<a href="#l10.1991"></a><span id="l10.1991" class="difflineminus">-  time_t now = time ((time_t*) 0);</span>
<a href="#l10.1992"></a><span id="l10.1992" class="difflineplus">+  time_t now = time((time_t *)0);</span>
<a href="#l10.1993"></a><span id="l10.1993">   char *ct = ctime(&amp;now);</span>
<a href="#l10.1994"></a><span id="l10.1994">   ct[24] = 0;</span>
<a href="#l10.1995"></a><span id="l10.1995">   result = &quot;From - &quot;;</span>
<a href="#l10.1996"></a><span id="l10.1996">   result += ct;</span>
<a href="#l10.1997"></a><span id="l10.1997">   result += MSG_LINEBREAK;</span>
<a href="#l10.1998"></a><span id="l10.1998">   m_bytesAddedToLocalMsg = result.Length();</span>
<a href="#l10.1999"></a><span id="l10.1999"> </span>
<a href="#l10.2000"></a><span id="l10.2000" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l10.2001"></a><span id="l10.2001" class="difflineminus">-</span>
<a href="#l10.2002"></a><span id="l10.2002" class="difflineminus">-  if (m_offlineHeader)</span>
<a href="#l10.2003"></a><span id="l10.2003" class="difflineminus">-    seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l10.2004"></a><span id="l10.2004" class="difflineminus">-</span>
<a href="#l10.2005"></a><span id="l10.2005" class="difflineminus">-  m_tempMessageStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l10.2006"></a><span id="l10.2006" class="difflineminus">-                             &amp;writeCount);</span>
<a href="#l10.2007"></a><span id="l10.2007" class="difflineminus">-</span>
<a href="#l10.2008"></a><span id="l10.2008" class="difflineminus">-  NS_NAMED_LITERAL_CSTRING(MozillaStatus, &quot;X-Mozilla-Status: 0001&quot; MSG_LINEBREAK);</span>
<a href="#l10.2009"></a><span id="l10.2009" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekable;</span>
<a href="#l10.2010"></a><span id="l10.2010" class="difflineplus">+</span>
<a href="#l10.2011"></a><span id="l10.2011" class="difflineplus">+  if (m_offlineHeader) seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l10.2012"></a><span id="l10.2012" class="difflineplus">+</span>
<a href="#l10.2013"></a><span id="l10.2013" class="difflineplus">+  m_tempMessageStream-&gt;Write(result.get(), result.Length(), &amp;writeCount);</span>
<a href="#l10.2014"></a><span id="l10.2014" class="difflineplus">+</span>
<a href="#l10.2015"></a><span id="l10.2015" class="difflineplus">+  NS_NAMED_LITERAL_CSTRING(MozillaStatus,</span>
<a href="#l10.2016"></a><span id="l10.2016" class="difflineplus">+                           &quot;X-Mozilla-Status: 0001&quot; MSG_LINEBREAK);</span>
<a href="#l10.2017"></a><span id="l10.2017">   m_tempMessageStream-&gt;Write(MozillaStatus.get(), MozillaStatus.Length(),</span>
<a href="#l10.2018"></a><span id="l10.2018">                              &amp;writeCount);</span>
<a href="#l10.2019"></a><span id="l10.2019">   m_bytesAddedToLocalMsg += writeCount;</span>
<a href="#l10.2020"></a><span id="l10.2020" class="difflineminus">-  NS_NAMED_LITERAL_CSTRING(MozillaStatus2, &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l10.2021"></a><span id="l10.2021" class="difflineplus">+  NS_NAMED_LITERAL_CSTRING(MozillaStatus2,</span>
<a href="#l10.2022"></a><span id="l10.2022" class="difflineplus">+                           &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l10.2023"></a><span id="l10.2023">   m_bytesAddedToLocalMsg += MozillaStatus2.Length();</span>
<a href="#l10.2024"></a><span id="l10.2024">   return m_tempMessageStream-&gt;Write(MozillaStatus2.get(),</span>
<a href="#l10.2025"></a><span id="l10.2025">                                     MozillaStatus2.Length(), &amp;writeCount);</span>
<a href="#l10.2026"></a><span id="l10.2026"> }</span>
<a href="#l10.2027"></a><span id="l10.2027"> </span>
<a href="#l10.2028"></a><span id="l10.2028" class="difflineminus">-nsresult nsMsgDBFolder::StartNewOfflineMessage()</span>
<a href="#l10.2029"></a><span id="l10.2029" class="difflineminus">-{</span>
<a href="#l10.2030"></a><span id="l10.2030" class="difflineminus">-    bool isLocked;</span>
<a href="#l10.2031"></a><span id="l10.2031" class="difflineminus">-    GetLocked(&amp;isLocked);</span>
<a href="#l10.2032"></a><span id="l10.2032" class="difflineminus">-    bool hasSemaphore = false;</span>
<a href="#l10.2033"></a><span id="l10.2033" class="difflineminus">-    if (isLocked)</span>
<a href="#l10.2034"></a><span id="l10.2034" class="difflineminus">-    {</span>
<a href="#l10.2035"></a><span id="l10.2035" class="difflineminus">-      // it's OK if we, the folder, have the semaphore.</span>
<a href="#l10.2036"></a><span id="l10.2036" class="difflineminus">-      TestSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this), &amp;hasSemaphore);</span>
<a href="#l10.2037"></a><span id="l10.2037" class="difflineminus">-      if (!hasSemaphore)</span>
<a href="#l10.2038"></a><span id="l10.2038" class="difflineminus">-      {</span>
<a href="#l10.2039"></a><span id="l10.2039" class="difflineminus">-        NS_WARNING(&quot;folder locked trying to download offline&quot;);</span>
<a href="#l10.2040"></a><span id="l10.2040" class="difflineminus">-        return NS_MSG_FOLDER_BUSY;</span>
<a href="#l10.2041"></a><span id="l10.2041" class="difflineminus">-      }</span>
<a href="#l10.2042"></a><span id="l10.2042" class="difflineplus">+nsresult nsMsgDBFolder::StartNewOfflineMessage() {</span>
<a href="#l10.2043"></a><span id="l10.2043" class="difflineplus">+  bool isLocked;</span>
<a href="#l10.2044"></a><span id="l10.2044" class="difflineplus">+  GetLocked(&amp;isLocked);</span>
<a href="#l10.2045"></a><span id="l10.2045" class="difflineplus">+  bool hasSemaphore = false;</span>
<a href="#l10.2046"></a><span id="l10.2046" class="difflineplus">+  if (isLocked) {</span>
<a href="#l10.2047"></a><span id="l10.2047" class="difflineplus">+    // it's OK if we, the folder, have the semaphore.</span>
<a href="#l10.2048"></a><span id="l10.2048" class="difflineplus">+    TestSemaphore(static_cast&lt;nsIMsgFolder *&gt;(this), &amp;hasSemaphore);</span>
<a href="#l10.2049"></a><span id="l10.2049" class="difflineplus">+    if (!hasSemaphore) {</span>
<a href="#l10.2050"></a><span id="l10.2050" class="difflineplus">+      NS_WARNING(&quot;folder locked trying to download offline&quot;);</span>
<a href="#l10.2051"></a><span id="l10.2051" class="difflineplus">+      return NS_MSG_FOLDER_BUSY;</span>
<a href="#l10.2052"></a><span id="l10.2052">     }</span>
<a href="#l10.2053"></a><span id="l10.2053" class="difflineminus">-  nsresult rv = GetOfflineStoreOutputStream(m_offlineHeader,</span>
<a href="#l10.2054"></a><span id="l10.2054" class="difflineminus">-                                     getter_AddRefs(m_tempMessageStream));</span>
<a href="#l10.2055"></a><span id="l10.2055" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !hasSemaphore)</span>
<a href="#l10.2056"></a><span id="l10.2056" class="difflineminus">-      AcquireSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l10.2057"></a><span id="l10.2057" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.2058"></a><span id="l10.2058" class="difflineminus">-    WriteStartOfNewLocalMessage();</span>
<a href="#l10.2059"></a><span id="l10.2059" class="difflineplus">+  }</span>
<a href="#l10.2060"></a><span id="l10.2060" class="difflineplus">+  nsresult rv = GetOfflineStoreOutputStream(</span>
<a href="#l10.2061"></a><span id="l10.2061" class="difflineplus">+      m_offlineHeader, getter_AddRefs(m_tempMessageStream));</span>
<a href="#l10.2062"></a><span id="l10.2062" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !hasSemaphore)</span>
<a href="#l10.2063"></a><span id="l10.2063" class="difflineplus">+    AcquireSemaphore(static_cast&lt;nsIMsgFolder *&gt;(this));</span>
<a href="#l10.2064"></a><span id="l10.2064" class="difflineplus">+  if (NS_SUCCEEDED(rv)) WriteStartOfNewLocalMessage();</span>
<a href="#l10.2065"></a><span id="l10.2065">   m_numOfflineMsgLines = 0;</span>
<a href="#l10.2066"></a><span id="l10.2066">   return rv;</span>
<a href="#l10.2067"></a><span id="l10.2067"> }</span>
<a href="#l10.2068"></a><span id="l10.2068"> </span>
<a href="#l10.2069"></a><span id="l10.2069" class="difflineminus">-nsresult nsMsgDBFolder::EndNewOfflineMessage()</span>
<a href="#l10.2070"></a><span id="l10.2070" class="difflineminus">-{</span>
<a href="#l10.2071"></a><span id="l10.2071" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l10.2072"></a><span id="l10.2072" class="difflineplus">+nsresult nsMsgDBFolder::EndNewOfflineMessage() {</span>
<a href="#l10.2073"></a><span id="l10.2073" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekable;</span>
<a href="#l10.2074"></a><span id="l10.2074">   int64_t curStorePos;</span>
<a href="#l10.2075"></a><span id="l10.2075">   uint64_t messageOffset;</span>
<a href="#l10.2076"></a><span id="l10.2076">   uint32_t messageSize;</span>
<a href="#l10.2077"></a><span id="l10.2077"> </span>
<a href="#l10.2078"></a><span id="l10.2078">   nsMsgKey messageKey;</span>
<a href="#l10.2079"></a><span id="l10.2079"> </span>
<a href="#l10.2080"></a><span id="l10.2080">   nsresult rv = GetDatabase();</span>
<a href="#l10.2081"></a><span id="l10.2081">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2082"></a><span id="l10.2082"> </span>
<a href="#l10.2083"></a><span id="l10.2083">   m_offlineHeader-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l10.2084"></a><span id="l10.2084" class="difflineminus">-  if (m_tempMessageStream)</span>
<a href="#l10.2085"></a><span id="l10.2085" class="difflineminus">-    seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l10.2086"></a><span id="l10.2086" class="difflineplus">+  if (m_tempMessageStream) seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l10.2087"></a><span id="l10.2087"> </span>
<a href="#l10.2088"></a><span id="l10.2088">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l10.2089"></a><span id="l10.2089">   GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l10.2090"></a><span id="l10.2090"> </span>
<a href="#l10.2091"></a><span id="l10.2091" class="difflineminus">-  if (seekable)</span>
<a href="#l10.2092"></a><span id="l10.2092" class="difflineminus">-  {</span>
<a href="#l10.2093"></a><span id="l10.2093" class="difflineplus">+  if (seekable) {</span>
<a href="#l10.2094"></a><span id="l10.2094">     mDatabase-&gt;MarkOffline(messageKey, true, nullptr);</span>
<a href="#l10.2095"></a><span id="l10.2095">     m_tempMessageStream-&gt;Flush();</span>
<a href="#l10.2096"></a><span id="l10.2096">     int64_t tellPos;</span>
<a href="#l10.2097"></a><span id="l10.2097">     seekable-&gt;Tell(&amp;tellPos);</span>
<a href="#l10.2098"></a><span id="l10.2098">     curStorePos = tellPos;</span>
<a href="#l10.2099"></a><span id="l10.2099"> </span>
<a href="#l10.2100"></a><span id="l10.2100">     // N.B. This only works if we've set the offline flag for the message,</span>
<a href="#l10.2101"></a><span id="l10.2101">     // so be careful about moving the call to MarkOffline above.</span>
<a href="#l10.2102"></a><span id="l10.2102">     m_offlineHeader-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l10.2103"></a><span id="l10.2103">     curStorePos -= messageOffset;</span>
<a href="#l10.2104"></a><span id="l10.2104">     m_offlineHeader-&gt;SetOfflineMessageSize(curStorePos);</span>
<a href="#l10.2105"></a><span id="l10.2105">     m_offlineHeader-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l10.2106"></a><span id="l10.2106">     messageSize += m_bytesAddedToLocalMsg;</span>
<a href="#l10.2107"></a><span id="l10.2107">     // unix/mac has a one byte line ending, but the imap server returns</span>
<a href="#l10.2108"></a><span id="l10.2108">     // crlf terminated lines.</span>
<a href="#l10.2109"></a><span id="l10.2109" class="difflineminus">-    if (MSG_LINEBREAK_LEN == 1)</span>
<a href="#l10.2110"></a><span id="l10.2110" class="difflineminus">-      messageSize -= m_numOfflineMsgLines;</span>
<a href="#l10.2111"></a><span id="l10.2111" class="difflineplus">+    if (MSG_LINEBREAK_LEN == 1) messageSize -= m_numOfflineMsgLines;</span>
<a href="#l10.2112"></a><span id="l10.2112"> </span>
<a href="#l10.2113"></a><span id="l10.2113">     // We clear the offline flag on the message if the size</span>
<a href="#l10.2114"></a><span id="l10.2114">     // looks wrong. Check if we're off by more than one byte per line.</span>
<a href="#l10.2115"></a><span id="l10.2115" class="difflineminus">-    if (messageSize &gt; (uint32_t) curStorePos &amp;&amp;</span>
<a href="#l10.2116"></a><span id="l10.2116" class="difflineminus">-       (messageSize - (uint32_t) curStorePos) &gt; (uint32_t) m_numOfflineMsgLines)</span>
<a href="#l10.2117"></a><span id="l10.2117" class="difflineminus">-    {</span>
<a href="#l10.2118"></a><span id="l10.2118" class="difflineminus">-       mDatabase-&gt;MarkOffline(messageKey, false, nullptr);</span>
<a href="#l10.2119"></a><span id="l10.2119" class="difflineminus">-       // we should truncate the offline store at messageOffset</span>
<a href="#l10.2120"></a><span id="l10.2120" class="difflineminus">-       ReleaseSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l10.2121"></a><span id="l10.2121" class="difflineminus">-       if (msgStore)</span>
<a href="#l10.2122"></a><span id="l10.2122" class="difflineminus">-         // this closes the stream</span>
<a href="#l10.2123"></a><span id="l10.2123" class="difflineminus">-         msgStore-&gt;DiscardNewMessage(m_tempMessageStream, m_offlineHeader);</span>
<a href="#l10.2124"></a><span id="l10.2124" class="difflineminus">-       else</span>
<a href="#l10.2125"></a><span id="l10.2125" class="difflineminus">-         m_tempMessageStream-&gt;Close();</span>
<a href="#l10.2126"></a><span id="l10.2126" class="difflineminus">-       m_tempMessageStream = nullptr;</span>
<a href="#l10.2127"></a><span id="l10.2127" class="difflineplus">+    if (messageSize &gt; (uint32_t)curStorePos &amp;&amp;</span>
<a href="#l10.2128"></a><span id="l10.2128" class="difflineplus">+        (messageSize - (uint32_t)curStorePos) &gt;</span>
<a href="#l10.2129"></a><span id="l10.2129" class="difflineplus">+            (uint32_t)m_numOfflineMsgLines) {</span>
<a href="#l10.2130"></a><span id="l10.2130" class="difflineplus">+      mDatabase-&gt;MarkOffline(messageKey, false, nullptr);</span>
<a href="#l10.2131"></a><span id="l10.2131" class="difflineplus">+      // we should truncate the offline store at messageOffset</span>
<a href="#l10.2132"></a><span id="l10.2132" class="difflineplus">+      ReleaseSemaphore(static_cast&lt;nsIMsgFolder *&gt;(this));</span>
<a href="#l10.2133"></a><span id="l10.2133" class="difflineplus">+      if (msgStore)</span>
<a href="#l10.2134"></a><span id="l10.2134" class="difflineplus">+        // this closes the stream</span>
<a href="#l10.2135"></a><span id="l10.2135" class="difflineplus">+        msgStore-&gt;DiscardNewMessage(m_tempMessageStream, m_offlineHeader);</span>
<a href="#l10.2136"></a><span id="l10.2136" class="difflineplus">+      else</span>
<a href="#l10.2137"></a><span id="l10.2137" class="difflineplus">+        m_tempMessageStream-&gt;Close();</span>
<a href="#l10.2138"></a><span id="l10.2138" class="difflineplus">+      m_tempMessageStream = nullptr;</span>
<a href="#l10.2139"></a><span id="l10.2139"> #ifdef _DEBUG</span>
<a href="#l10.2140"></a><span id="l10.2140" class="difflineminus">-       nsAutoCString message(&quot;Offline message too small: messageSize=&quot;);</span>
<a href="#l10.2141"></a><span id="l10.2141" class="difflineminus">-       message.AppendInt(messageSize);</span>
<a href="#l10.2142"></a><span id="l10.2142" class="difflineminus">-       message.AppendLiteral(&quot; curStorePos=&quot;);</span>
<a href="#l10.2143"></a><span id="l10.2143" class="difflineminus">-       message.AppendInt(curStorePos);</span>
<a href="#l10.2144"></a><span id="l10.2144" class="difflineminus">-       message.AppendLiteral(&quot; numOfflineMsgLines=&quot;);</span>
<a href="#l10.2145"></a><span id="l10.2145" class="difflineminus">-       message.AppendInt(m_numOfflineMsgLines);</span>
<a href="#l10.2146"></a><span id="l10.2146" class="difflineminus">-       message.AppendLiteral(&quot; bytesAdded=&quot;);</span>
<a href="#l10.2147"></a><span id="l10.2147" class="difflineminus">-       message.AppendInt(m_bytesAddedToLocalMsg);</span>
<a href="#l10.2148"></a><span id="l10.2148" class="difflineminus">-       NS_ERROR(message.get());</span>
<a href="#l10.2149"></a><span id="l10.2149" class="difflineplus">+      nsAutoCString message(&quot;Offline message too small: messageSize=&quot;);</span>
<a href="#l10.2150"></a><span id="l10.2150" class="difflineplus">+      message.AppendInt(messageSize);</span>
<a href="#l10.2151"></a><span id="l10.2151" class="difflineplus">+      message.AppendLiteral(&quot; curStorePos=&quot;);</span>
<a href="#l10.2152"></a><span id="l10.2152" class="difflineplus">+      message.AppendInt(curStorePos);</span>
<a href="#l10.2153"></a><span id="l10.2153" class="difflineplus">+      message.AppendLiteral(&quot; numOfflineMsgLines=&quot;);</span>
<a href="#l10.2154"></a><span id="l10.2154" class="difflineplus">+      message.AppendInt(m_numOfflineMsgLines);</span>
<a href="#l10.2155"></a><span id="l10.2155" class="difflineplus">+      message.AppendLiteral(&quot; bytesAdded=&quot;);</span>
<a href="#l10.2156"></a><span id="l10.2156" class="difflineplus">+      message.AppendInt(m_bytesAddedToLocalMsg);</span>
<a href="#l10.2157"></a><span id="l10.2157" class="difflineplus">+      NS_ERROR(message.get());</span>
<a href="#l10.2158"></a><span id="l10.2158"> #endif</span>
<a href="#l10.2159"></a><span id="l10.2159" class="difflineminus">-       m_offlineHeader = nullptr;</span>
<a href="#l10.2160"></a><span id="l10.2160" class="difflineminus">-       return NS_ERROR_FAILURE;</span>
<a href="#l10.2161"></a><span id="l10.2161" class="difflineminus">-    }</span>
<a href="#l10.2162"></a><span id="l10.2162" class="difflineminus">-    else</span>
<a href="#l10.2163"></a><span id="l10.2163" class="difflineplus">+      m_offlineHeader = nullptr;</span>
<a href="#l10.2164"></a><span id="l10.2164" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l10.2165"></a><span id="l10.2165" class="difflineplus">+    } else</span>
<a href="#l10.2166"></a><span id="l10.2166">       m_offlineHeader-&gt;SetLineCount(m_numOfflineMsgLines);</span>
<a href="#l10.2167"></a><span id="l10.2167">   }</span>
<a href="#l10.2168"></a><span id="l10.2168">   if (msgStore)</span>
<a href="#l10.2169"></a><span id="l10.2169">     msgStore-&gt;FinishNewMessage(m_tempMessageStream, m_offlineHeader);</span>
<a href="#l10.2170"></a><span id="l10.2170"> </span>
<a href="#l10.2171"></a><span id="l10.2171">   m_offlineHeader = nullptr;</span>
<a href="#l10.2172"></a><span id="l10.2172" class="difflineminus">-  if (m_tempMessageStream)</span>
<a href="#l10.2173"></a><span id="l10.2173" class="difflineminus">-  {</span>
<a href="#l10.2174"></a><span id="l10.2174" class="difflineplus">+  if (m_tempMessageStream) {</span>
<a href="#l10.2175"></a><span id="l10.2175">     m_tempMessageStream-&gt;Close();</span>
<a href="#l10.2176"></a><span id="l10.2176">     m_tempMessageStream = nullptr;</span>
<a href="#l10.2177"></a><span id="l10.2177">   }</span>
<a href="#l10.2178"></a><span id="l10.2178">   return NS_OK;</span>
<a href="#l10.2179"></a><span id="l10.2179"> }</span>
<a href="#l10.2180"></a><span id="l10.2180"> </span>
<a href="#l10.2181"></a><span id="l10.2181" class="difflineminus">-nsresult nsMsgDBFolder::CompactOfflineStore(nsIMsgWindow *inWindow, nsIUrlListener *aListener)</span>
<a href="#l10.2182"></a><span id="l10.2182" class="difflineminus">-{</span>
<a href="#l10.2183"></a><span id="l10.2183" class="difflineplus">+nsresult nsMsgDBFolder::CompactOfflineStore(nsIMsgWindow *inWindow,</span>
<a href="#l10.2184"></a><span id="l10.2184" class="difflineplus">+                                            nsIUrlListener *aListener) {</span>
<a href="#l10.2185"></a><span id="l10.2185">   nsresult rv;</span>
<a href="#l10.2186"></a><span id="l10.2186" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.2187"></a><span id="l10.2187" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l10.2188"></a><span id="l10.2188" class="difflineplus">+      do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.2189"></a><span id="l10.2189">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2190"></a><span id="l10.2190">   return folderCompactor-&gt;Compact(this, true, aListener, inWindow);</span>
<a href="#l10.2191"></a><span id="l10.2191"> }</span>
<a href="#l10.2192"></a><span id="l10.2192"> </span>
<a href="#l10.2193"></a><span id="l10.2193" class="difflineminus">-class AutoCompactEvent : public mozilla::Runnable</span>
<a href="#l10.2194"></a><span id="l10.2194" class="difflineminus">-{</span>
<a href="#l10.2195"></a><span id="l10.2195" class="difflineminus">-public:</span>
<a href="#l10.2196"></a><span id="l10.2196" class="difflineplus">+class AutoCompactEvent : public mozilla::Runnable {</span>
<a href="#l10.2197"></a><span id="l10.2197" class="difflineplus">+ public:</span>
<a href="#l10.2198"></a><span id="l10.2198">   AutoCompactEvent(nsIMsgWindow *aMsgWindow, nsMsgDBFolder *aFolder)</span>
<a href="#l10.2199"></a><span id="l10.2199" class="difflineminus">-    : mozilla::Runnable(&quot;AutoCompactEvent&quot;)</span>
<a href="#l10.2200"></a><span id="l10.2200" class="difflineminus">-    , mMsgWindow(aMsgWindow), mFolder(aFolder)</span>
<a href="#l10.2201"></a><span id="l10.2201" class="difflineminus">-  {}</span>
<a href="#l10.2202"></a><span id="l10.2202" class="difflineminus">-</span>
<a href="#l10.2203"></a><span id="l10.2203" class="difflineminus">-  NS_IMETHOD Run()</span>
<a href="#l10.2204"></a><span id="l10.2204" class="difflineminus">-  {</span>
<a href="#l10.2205"></a><span id="l10.2205" class="difflineminus">-    if (mFolder)</span>
<a href="#l10.2206"></a><span id="l10.2206" class="difflineminus">-      mFolder-&gt;HandleAutoCompactEvent(mMsgWindow);</span>
<a href="#l10.2207"></a><span id="l10.2207" class="difflineplus">+      : mozilla::Runnable(&quot;AutoCompactEvent&quot;),</span>
<a href="#l10.2208"></a><span id="l10.2208" class="difflineplus">+        mMsgWindow(aMsgWindow),</span>
<a href="#l10.2209"></a><span id="l10.2209" class="difflineplus">+        mFolder(aFolder) {}</span>
<a href="#l10.2210"></a><span id="l10.2210" class="difflineplus">+</span>
<a href="#l10.2211"></a><span id="l10.2211" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l10.2212"></a><span id="l10.2212" class="difflineplus">+    if (mFolder) mFolder-&gt;HandleAutoCompactEvent(mMsgWindow);</span>
<a href="#l10.2213"></a><span id="l10.2213">     return NS_OK;</span>
<a href="#l10.2214"></a><span id="l10.2214">   }</span>
<a href="#l10.2215"></a><span id="l10.2215"> </span>
<a href="#l10.2216"></a><span id="l10.2216" class="difflineminus">-private:</span>
<a href="#l10.2217"></a><span id="l10.2217" class="difflineplus">+ private:</span>
<a href="#l10.2218"></a><span id="l10.2218">   nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l10.2219"></a><span id="l10.2219">   RefPtr&lt;nsMsgDBFolder&gt; mFolder;</span>
<a href="#l10.2220"></a><span id="l10.2220"> };</span>
<a href="#l10.2221"></a><span id="l10.2221"> </span>
<a href="#l10.2222"></a><span id="l10.2222" class="difflineminus">-nsresult nsMsgDBFolder::HandleAutoCompactEvent(nsIMsgWindow *aWindow)</span>
<a href="#l10.2223"></a><span id="l10.2223" class="difflineminus">-{</span>
<a href="#l10.2224"></a><span id="l10.2224" class="difflineplus">+nsresult nsMsgDBFolder::HandleAutoCompactEvent(nsIMsgWindow *aWindow) {</span>
<a href="#l10.2225"></a><span id="l10.2225">   nsresult rv;</span>
<a href="#l10.2226"></a><span id="l10.2226" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.2227"></a><span id="l10.2227" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.2228"></a><span id="l10.2228" class="difflineminus">-  {</span>
<a href="#l10.2229"></a><span id="l10.2229" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l10.2230"></a><span id="l10.2230" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.2231"></a><span id="l10.2231" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.2232"></a><span id="l10.2232">     nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l10.2233"></a><span id="l10.2233">     rv = accountMgr-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l10.2234"></a><span id="l10.2234">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2235"></a><span id="l10.2235">     uint32_t numServers = 0, serverIndex = 0;</span>
<a href="#l10.2236"></a><span id="l10.2236">     rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l10.2237"></a><span id="l10.2237">     int32_t offlineSupportLevel;</span>
<a href="#l10.2238"></a><span id="l10.2238" class="difflineminus">-    if (numServers &gt; 0)</span>
<a href="#l10.2239"></a><span id="l10.2239" class="difflineminus">-    {</span>
<a href="#l10.2240"></a><span id="l10.2240" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; folderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.2241"></a><span id="l10.2241" class="difflineplus">+    if (numServers &gt; 0) {</span>
<a href="#l10.2242"></a><span id="l10.2242" class="difflineplus">+      nsCOMPtr&lt;nsIMutableArray&gt; folderArray =</span>
<a href="#l10.2243"></a><span id="l10.2243" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.2244"></a><span id="l10.2244">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2245"></a><span id="l10.2245" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; offlineFolderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.2246"></a><span id="l10.2246" class="difflineplus">+      nsCOMPtr&lt;nsIMutableArray&gt; offlineFolderArray =</span>
<a href="#l10.2247"></a><span id="l10.2247" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.2248"></a><span id="l10.2248">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2249"></a><span id="l10.2249">       int64_t totalExpungedBytes = 0;</span>
<a href="#l10.2250"></a><span id="l10.2250">       int64_t offlineExpungedBytes = 0;</span>
<a href="#l10.2251"></a><span id="l10.2251">       int64_t localExpungedBytes = 0;</span>
<a href="#l10.2252"></a><span id="l10.2252" class="difflineminus">-      do</span>
<a href="#l10.2253"></a><span id="l10.2253" class="difflineminus">-      {</span>
<a href="#l10.2254"></a><span id="l10.2254" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l10.2255"></a><span id="l10.2255" class="difflineplus">+      do {</span>
<a href="#l10.2256"></a><span id="l10.2256" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l10.2257"></a><span id="l10.2257" class="difflineplus">+            do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l10.2258"></a><span id="l10.2258">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2259"></a><span id="l10.2259">         nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l10.2260"></a><span id="l10.2260">         rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l10.2261"></a><span id="l10.2261">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2262"></a><span id="l10.2262" class="difflineminus">-        if (!msgStore)</span>
<a href="#l10.2263"></a><span id="l10.2263" class="difflineminus">-          continue;</span>
<a href="#l10.2264"></a><span id="l10.2264" class="difflineplus">+        if (!msgStore) continue;</span>
<a href="#l10.2265"></a><span id="l10.2265">         bool supportsCompaction;</span>
<a href="#l10.2266"></a><span id="l10.2266">         msgStore-&gt;GetSupportsCompaction(&amp;supportsCompaction);</span>
<a href="#l10.2267"></a><span id="l10.2267" class="difflineminus">-        if (!supportsCompaction)</span>
<a href="#l10.2268"></a><span id="l10.2268" class="difflineminus">-          continue;</span>
<a href="#l10.2269"></a><span id="l10.2269" class="difflineplus">+        if (!supportsCompaction) continue;</span>
<a href="#l10.2270"></a><span id="l10.2270">         nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l10.2271"></a><span id="l10.2271">         rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l10.2272"></a><span id="l10.2272" class="difflineminus">-        if(NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l10.2273"></a><span id="l10.2273" class="difflineminus">-        {</span>
<a href="#l10.2274"></a><span id="l10.2274" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l10.2275"></a><span id="l10.2275">           rv = server-&gt;GetOfflineSupportLevel(&amp;offlineSupportLevel);</span>
<a href="#l10.2276"></a><span id="l10.2276">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2277"></a><span id="l10.2277">           nsCOMPtr&lt;nsIArray&gt; allDescendents;</span>
<a href="#l10.2278"></a><span id="l10.2278">           rootFolder-&gt;GetDescendants(getter_AddRefs(allDescendents));</span>
<a href="#l10.2279"></a><span id="l10.2279">           uint32_t cnt = 0;</span>
<a href="#l10.2280"></a><span id="l10.2280">           rv = allDescendents-&gt;GetLength(&amp;cnt);</span>
<a href="#l10.2281"></a><span id="l10.2281">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2282"></a><span id="l10.2282">           int64_t expungedBytes = 0;</span>
<a href="#l10.2283"></a><span id="l10.2283" class="difflineminus">-          if (offlineSupportLevel &gt; 0)</span>
<a href="#l10.2284"></a><span id="l10.2284" class="difflineminus">-          {</span>
<a href="#l10.2285"></a><span id="l10.2285" class="difflineplus">+          if (offlineSupportLevel &gt; 0) {</span>
<a href="#l10.2286"></a><span id="l10.2286">             uint32_t flags;</span>
<a href="#l10.2287"></a><span id="l10.2287" class="difflineminus">-            for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l10.2288"></a><span id="l10.2288" class="difflineminus">-            {</span>
<a href="#l10.2289"></a><span id="l10.2289" class="difflineminus">-              nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i);</span>
<a href="#l10.2290"></a><span id="l10.2290" class="difflineplus">+            for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l10.2291"></a><span id="l10.2291" class="difflineplus">+              nsCOMPtr&lt;nsIMsgFolder&gt; folder =</span>
<a href="#l10.2292"></a><span id="l10.2292" class="difflineplus">+                  do_QueryElementAt(allDescendents, i);</span>
<a href="#l10.2293"></a><span id="l10.2293">               expungedBytes = 0;</span>
<a href="#l10.2294"></a><span id="l10.2294">               folder-&gt;GetFlags(&amp;flags);</span>
<a href="#l10.2295"></a><span id="l10.2295">               if (flags &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l10.2296"></a><span id="l10.2296">                 folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l10.2297"></a><span id="l10.2297" class="difflineminus">-              if (expungedBytes &gt; 0 )</span>
<a href="#l10.2298"></a><span id="l10.2298" class="difflineminus">-              {</span>
<a href="#l10.2299"></a><span id="l10.2299" class="difflineplus">+              if (expungedBytes &gt; 0) {</span>
<a href="#l10.2300"></a><span id="l10.2300">                 offlineFolderArray-&gt;AppendElement(folder);</span>
<a href="#l10.2301"></a><span id="l10.2301">                 offlineExpungedBytes += expungedBytes;</span>
<a href="#l10.2302"></a><span id="l10.2302">               }</span>
<a href="#l10.2303"></a><span id="l10.2303">             }</span>
<a href="#l10.2304"></a><span id="l10.2304" class="difflineminus">-          }</span>
<a href="#l10.2305"></a><span id="l10.2305" class="difflineminus">-          else  //pop or local</span>
<a href="#l10.2306"></a><span id="l10.2306" class="difflineplus">+          } else  // pop or local</span>
<a href="#l10.2307"></a><span id="l10.2307">           {</span>
<a href="#l10.2308"></a><span id="l10.2308" class="difflineminus">-            for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l10.2309"></a><span id="l10.2309" class="difflineminus">-            {</span>
<a href="#l10.2310"></a><span id="l10.2310" class="difflineminus">-              nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i);</span>
<a href="#l10.2311"></a><span id="l10.2311" class="difflineplus">+            for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l10.2312"></a><span id="l10.2312" class="difflineplus">+              nsCOMPtr&lt;nsIMsgFolder&gt; folder =</span>
<a href="#l10.2313"></a><span id="l10.2313" class="difflineplus">+                  do_QueryElementAt(allDescendents, i);</span>
<a href="#l10.2314"></a><span id="l10.2314">               expungedBytes = 0;</span>
<a href="#l10.2315"></a><span id="l10.2315">               folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l10.2316"></a><span id="l10.2316" class="difflineminus">-              if (expungedBytes &gt; 0 )</span>
<a href="#l10.2317"></a><span id="l10.2317" class="difflineminus">-              {</span>
<a href="#l10.2318"></a><span id="l10.2318" class="difflineplus">+              if (expungedBytes &gt; 0) {</span>
<a href="#l10.2319"></a><span id="l10.2319">                 folderArray-&gt;AppendElement(folder);</span>
<a href="#l10.2320"></a><span id="l10.2320">                 localExpungedBytes += expungedBytes;</span>
<a href="#l10.2321"></a><span id="l10.2321">               }</span>
<a href="#l10.2322"></a><span id="l10.2322">             }</span>
<a href="#l10.2323"></a><span id="l10.2323">           }</span>
<a href="#l10.2324"></a><span id="l10.2324">         }</span>
<a href="#l10.2325"></a><span id="l10.2325" class="difflineminus">-      }</span>
<a href="#l10.2326"></a><span id="l10.2326" class="difflineminus">-      while (++serverIndex &lt; numServers);</span>
<a href="#l10.2327"></a><span id="l10.2327" class="difflineplus">+      } while (++serverIndex &lt; numServers);</span>
<a href="#l10.2328"></a><span id="l10.2328">       totalExpungedBytes = localExpungedBytes + offlineExpungedBytes;</span>
<a href="#l10.2329"></a><span id="l10.2329">       int32_t purgeThreshold;</span>
<a href="#l10.2330"></a><span id="l10.2330">       rv = GetPurgeThreshold(&amp;purgeThreshold);</span>
<a href="#l10.2331"></a><span id="l10.2331">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2332"></a><span id="l10.2332" class="difflineminus">-      if (totalExpungedBytes &gt; (purgeThreshold * 1024))</span>
<a href="#l10.2333"></a><span id="l10.2333" class="difflineminus">-      {</span>
<a href="#l10.2334"></a><span id="l10.2334" class="difflineplus">+      if (totalExpungedBytes &gt; (purgeThreshold * 1024)) {</span>
<a href="#l10.2335"></a><span id="l10.2335">         bool okToCompact = false;</span>
<a href="#l10.2336"></a><span id="l10.2336" class="difflineminus">-        nsCOMPtr&lt;nsIPrefService&gt; pref = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l10.2337"></a><span id="l10.2337" class="difflineplus">+        nsCOMPtr&lt;nsIPrefService&gt; pref =</span>
<a href="#l10.2338"></a><span id="l10.2338" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l10.2339"></a><span id="l10.2339">         nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l10.2340"></a><span id="l10.2340">         pref-&gt;GetBranch(&quot;&quot;, getter_AddRefs(branch));</span>
<a href="#l10.2341"></a><span id="l10.2341"> </span>
<a href="#l10.2342"></a><span id="l10.2342">         bool askBeforePurge;</span>
<a href="#l10.2343"></a><span id="l10.2343">         branch-&gt;GetBoolPref(PREF_MAIL_PURGE_ASK, &amp;askBeforePurge);</span>
<a href="#l10.2344"></a><span id="l10.2344" class="difflineminus">-        if (askBeforePurge &amp;&amp; aWindow)</span>
<a href="#l10.2345"></a><span id="l10.2345" class="difflineminus">-        {</span>
<a href="#l10.2346"></a><span id="l10.2346" class="difflineminus">-          nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.2347"></a><span id="l10.2347" class="difflineplus">+        if (askBeforePurge &amp;&amp; aWindow) {</span>
<a href="#l10.2348"></a><span id="l10.2348" class="difflineplus">+          nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.2349"></a><span id="l10.2349">           rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l10.2350"></a><span id="l10.2350">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2351"></a><span id="l10.2351">           nsString dialogTitle;</span>
<a href="#l10.2352"></a><span id="l10.2352">           nsString confirmString;</span>
<a href="#l10.2353"></a><span id="l10.2353">           nsString checkboxText;</span>
<a href="#l10.2354"></a><span id="l10.2354">           nsString buttonCompactNowText;</span>
<a href="#l10.2355"></a><span id="l10.2355">           nsAutoString compactSize;</span>
<a href="#l10.2356"></a><span id="l10.2356">           FormatFileSize(totalExpungedBytes, true, compactSize);</span>
<a href="#l10.2357"></a><span id="l10.2357" class="difflineminus">-          const char16_t* params[] = { compactSize.get() };</span>
<a href="#l10.2358"></a><span id="l10.2358" class="difflineminus">-          rv = bundle-&gt;GetStringFromName(&quot;autoCompactAllFoldersTitle&quot;, dialogTitle);</span>
<a href="#l10.2359"></a><span id="l10.2359" class="difflineplus">+          const char16_t *params[] = {compactSize.get()};</span>
<a href="#l10.2360"></a><span id="l10.2360" class="difflineplus">+          rv = bundle-&gt;GetStringFromName(&quot;autoCompactAllFoldersTitle&quot;,</span>
<a href="#l10.2361"></a><span id="l10.2361" class="difflineplus">+                                         dialogTitle);</span>
<a href="#l10.2362"></a><span id="l10.2362">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2363"></a><span id="l10.2363" class="difflineminus">-          rv = bundle-&gt;FormatStringFromName(&quot;autoCompactAllFoldersText&quot;,</span>
<a href="#l10.2364"></a><span id="l10.2364" class="difflineminus">-                                            params, 1, confirmString);</span>
<a href="#l10.2365"></a><span id="l10.2365" class="difflineplus">+          rv = bundle-&gt;FormatStringFromName(&quot;autoCompactAllFoldersText&quot;, params,</span>
<a href="#l10.2366"></a><span id="l10.2366" class="difflineplus">+                                            1, confirmString);</span>
<a href="#l10.2367"></a><span id="l10.2367">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2368"></a><span id="l10.2368">           rv = bundle-&gt;GetStringFromName(&quot;autoCompactAlwaysAskCheckbox&quot;,</span>
<a href="#l10.2369"></a><span id="l10.2369">                                          checkboxText);</span>
<a href="#l10.2370"></a><span id="l10.2370">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2371"></a><span id="l10.2371">           rv = bundle-&gt;GetStringFromName(&quot;compactNowButton&quot;,</span>
<a href="#l10.2372"></a><span id="l10.2372">                                          buttonCompactNowText);</span>
<a href="#l10.2373"></a><span id="l10.2373">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2374"></a><span id="l10.2374" class="difflineminus">-          bool alwaysAsk = true; // &quot;Always ask...&quot; - checked by default.</span>
<a href="#l10.2375"></a><span id="l10.2375" class="difflineplus">+          bool alwaysAsk = true;  // &quot;Always ask...&quot; - checked by default.</span>
<a href="#l10.2376"></a><span id="l10.2376">           int32_t buttonPressed = 0;</span>
<a href="#l10.2377"></a><span id="l10.2377"> </span>
<a href="#l10.2378"></a><span id="l10.2378">           nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l10.2379"></a><span id="l10.2379">           rv = aWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l10.2380"></a><span id="l10.2380">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2381"></a><span id="l10.2381"> </span>
<a href="#l10.2382"></a><span id="l10.2382">           const uint32_t buttonFlags =</span>
<a href="#l10.2383"></a><span id="l10.2383" class="difflineminus">-            (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l10.2384"></a><span id="l10.2384" class="difflineminus">-            (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l10.2385"></a><span id="l10.2385" class="difflineminus">-          rv = dialog-&gt;ConfirmEx(dialogTitle.get(), confirmString.get(), buttonFlags,</span>
<a href="#l10.2386"></a><span id="l10.2386" class="difflineminus">-                                 buttonCompactNowText.get(), nullptr, nullptr,</span>
<a href="#l10.2387"></a><span id="l10.2387" class="difflineminus">-                                 checkboxText.get(), &amp;alwaysAsk, &amp;buttonPressed);</span>
<a href="#l10.2388"></a><span id="l10.2388" class="difflineplus">+              (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l10.2389"></a><span id="l10.2389" class="difflineplus">+              (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l10.2390"></a><span id="l10.2390" class="difflineplus">+          rv = dialog-&gt;ConfirmEx(dialogTitle.get(), confirmString.get(),</span>
<a href="#l10.2391"></a><span id="l10.2391" class="difflineplus">+                                 buttonFlags, buttonCompactNowText.get(),</span>
<a href="#l10.2392"></a><span id="l10.2392" class="difflineplus">+                                 nullptr, nullptr, checkboxText.get(),</span>
<a href="#l10.2393"></a><span id="l10.2393" class="difflineplus">+                                 &amp;alwaysAsk, &amp;buttonPressed);</span>
<a href="#l10.2394"></a><span id="l10.2394">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2395"></a><span id="l10.2395" class="difflineminus">-          if (!buttonPressed)</span>
<a href="#l10.2396"></a><span id="l10.2396" class="difflineminus">-          {</span>
<a href="#l10.2397"></a><span id="l10.2397" class="difflineplus">+          if (!buttonPressed) {</span>
<a href="#l10.2398"></a><span id="l10.2398">             okToCompact = true;</span>
<a href="#l10.2399"></a><span id="l10.2399" class="difflineminus">-            if (!alwaysAsk) // [ ] Always ask me before compacting folders automatically</span>
<a href="#l10.2400"></a><span id="l10.2400" class="difflineplus">+            if (!alwaysAsk)  // [ ] Always ask me before compacting folders</span>
<a href="#l10.2401"></a><span id="l10.2401" class="difflineplus">+                             // automatically</span>
<a href="#l10.2402"></a><span id="l10.2402">               branch-&gt;SetBoolPref(PREF_MAIL_PURGE_ASK, false);</span>
<a href="#l10.2403"></a><span id="l10.2403">           }</span>
<a href="#l10.2404"></a><span id="l10.2404" class="difflineminus">-        }</span>
<a href="#l10.2405"></a><span id="l10.2405" class="difflineminus">-        else</span>
<a href="#l10.2406"></a><span id="l10.2406" class="difflineplus">+        } else</span>
<a href="#l10.2407"></a><span id="l10.2407">           okToCompact = aWindow || !askBeforePurge;</span>
<a href="#l10.2408"></a><span id="l10.2408"> </span>
<a href="#l10.2409"></a><span id="l10.2409" class="difflineminus">-        if (okToCompact)</span>
<a href="#l10.2410"></a><span id="l10.2410" class="difflineminus">-        {</span>
<a href="#l10.2411"></a><span id="l10.2411" class="difflineplus">+        if (okToCompact) {</span>
<a href="#l10.2412"></a><span id="l10.2412">           NotifyFolderEvent(kAboutToCompact);</span>
<a href="#l10.2413"></a><span id="l10.2413"> </span>
<a href="#l10.2414"></a><span id="l10.2414" class="difflineminus">-         if (localExpungedBytes &gt; 0)</span>
<a href="#l10.2415"></a><span id="l10.2415" class="difflineminus">-         {</span>
<a href="#l10.2416"></a><span id="l10.2416" class="difflineplus">+          if (localExpungedBytes &gt; 0) {</span>
<a href="#l10.2417"></a><span id="l10.2417">             nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l10.2418"></a><span id="l10.2418" class="difflineminus">-              do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.2419"></a><span id="l10.2419" class="difflineplus">+                do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.2420"></a><span id="l10.2420">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2421"></a><span id="l10.2421"> </span>
<a href="#l10.2422"></a><span id="l10.2422">             if (offlineExpungedBytes &gt; 0)</span>
<a href="#l10.2423"></a><span id="l10.2423" class="difflineminus">-              folderCompactor-&gt;CompactFolders(folderArray, offlineFolderArray, nullptr, aWindow);</span>
<a href="#l10.2424"></a><span id="l10.2424" class="difflineplus">+              folderCompactor-&gt;CompactFolders(folderArray, offlineFolderArray,</span>
<a href="#l10.2425"></a><span id="l10.2425" class="difflineplus">+                                              nullptr, aWindow);</span>
<a href="#l10.2426"></a><span id="l10.2426">             else</span>
<a href="#l10.2427"></a><span id="l10.2427" class="difflineminus">-              folderCompactor-&gt;CompactFolders(folderArray, nullptr, nullptr, aWindow);</span>
<a href="#l10.2428"></a><span id="l10.2428" class="difflineminus">-          }</span>
<a href="#l10.2429"></a><span id="l10.2429" class="difflineminus">-          else if (offlineExpungedBytes &gt; 0)</span>
<a href="#l10.2430"></a><span id="l10.2430" class="difflineplus">+              folderCompactor-&gt;CompactFolders(folderArray, nullptr, nullptr,</span>
<a href="#l10.2431"></a><span id="l10.2431" class="difflineplus">+                                              aWindow);</span>
<a href="#l10.2432"></a><span id="l10.2432" class="difflineplus">+          } else if (offlineExpungedBytes &gt; 0)</span>
<a href="#l10.2433"></a><span id="l10.2433">             CompactAllOfflineStores(nullptr, aWindow, offlineFolderArray);</span>
<a href="#l10.2434"></a><span id="l10.2434">         }</span>
<a href="#l10.2435"></a><span id="l10.2435">       }</span>
<a href="#l10.2436"></a><span id="l10.2436">     }</span>
<a href="#l10.2437"></a><span id="l10.2437">   }</span>
<a href="#l10.2438"></a><span id="l10.2438">   return rv;</span>
<a href="#l10.2439"></a><span id="l10.2439"> }</span>
<a href="#l10.2440"></a><span id="l10.2440"> </span>
<a href="#l10.2441"></a><span id="l10.2441" class="difflineminus">-nsresult</span>
<a href="#l10.2442"></a><span id="l10.2442" class="difflineminus">-nsMsgDBFolder::AutoCompact(nsIMsgWindow *aWindow)</span>
<a href="#l10.2443"></a><span id="l10.2443" class="difflineminus">-{</span>
<a href="#l10.2444"></a><span id="l10.2444" class="difflineplus">+nsresult nsMsgDBFolder::AutoCompact(nsIMsgWindow *aWindow) {</span>
<a href="#l10.2445"></a><span id="l10.2445">   // we don't check for null aWindow, because this routine can get called</span>
<a href="#l10.2446"></a><span id="l10.2446">   // in unit tests where we have no window. Just assume not OK if no window.</span>
<a href="#l10.2447"></a><span id="l10.2447">   bool prompt;</span>
<a href="#l10.2448"></a><span id="l10.2448">   nsresult rv = GetPromptPurgeThreshold(&amp;prompt);</span>
<a href="#l10.2449"></a><span id="l10.2449">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2450"></a><span id="l10.2450" class="difflineminus">-  PRTime timeNow = PR_Now();   //time in microseconds</span>
<a href="#l10.2451"></a><span id="l10.2451" class="difflineplus">+  PRTime timeNow = PR_Now();  // time in microseconds</span>
<a href="#l10.2452"></a><span id="l10.2452">   PRTime timeAfterOneHourOfLastPurgeCheck = gtimeOfLastPurgeCheck + oneHour;</span>
<a href="#l10.2453"></a><span id="l10.2453" class="difflineminus">-  if (timeAfterOneHourOfLastPurgeCheck &lt; timeNow &amp;&amp; prompt)</span>
<a href="#l10.2454"></a><span id="l10.2454" class="difflineminus">-  {</span>
<a href="#l10.2455"></a><span id="l10.2455" class="difflineplus">+  if (timeAfterOneHourOfLastPurgeCheck &lt; timeNow &amp;&amp; prompt) {</span>
<a href="#l10.2456"></a><span id="l10.2456">     gtimeOfLastPurgeCheck = timeNow;</span>
<a href="#l10.2457"></a><span id="l10.2457">     nsCOMPtr&lt;nsIRunnable&gt; event = new AutoCompactEvent(aWindow, this);</span>
<a href="#l10.2458"></a><span id="l10.2458">     // Post this as an event because it can put up an alert, which</span>
<a href="#l10.2459"></a><span id="l10.2459">     // might cause issues depending on the stack when we are called.</span>
<a href="#l10.2460"></a><span id="l10.2460" class="difflineminus">-    if (event)</span>
<a href="#l10.2461"></a><span id="l10.2461" class="difflineminus">-      NS_DispatchToCurrentThread(event);</span>
<a href="#l10.2462"></a><span id="l10.2462" class="difflineplus">+    if (event) NS_DispatchToCurrentThread(event);</span>
<a href="#l10.2463"></a><span id="l10.2463">   }</span>
<a href="#l10.2464"></a><span id="l10.2464">   return rv;</span>
<a href="#l10.2465"></a><span id="l10.2465"> }</span>
<a href="#l10.2466"></a><span id="l10.2466"> </span>
<a href="#l10.2467"></a><span id="l10.2467"> NS_IMETHODIMP</span>
<a href="#l10.2468"></a><span id="l10.2468"> nsMsgDBFolder::CompactAllOfflineStores(nsIUrlListener *aUrlListener,</span>
<a href="#l10.2469"></a><span id="l10.2469">                                        nsIMsgWindow *aWindow,</span>
<a href="#l10.2470"></a><span id="l10.2470" class="difflineminus">-                                       nsIArray *aOfflineFolderArray)</span>
<a href="#l10.2471"></a><span id="l10.2471" class="difflineminus">-{</span>
<a href="#l10.2472"></a><span id="l10.2472" class="difflineplus">+                                       nsIArray *aOfflineFolderArray) {</span>
<a href="#l10.2473"></a><span id="l10.2473">   nsresult rv;</span>
<a href="#l10.2474"></a><span id="l10.2474" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor</span>
<a href="#l10.2475"></a><span id="l10.2475" class="difflineminus">-    = do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.2476"></a><span id="l10.2476" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l10.2477"></a><span id="l10.2477" class="difflineplus">+      do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.2478"></a><span id="l10.2478">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2479"></a><span id="l10.2479" class="difflineminus">-  return folderCompactor-&gt;CompactFolders(nullptr, aOfflineFolderArray, aUrlListener, aWindow);</span>
<a href="#l10.2480"></a><span id="l10.2480" class="difflineminus">-}</span>
<a href="#l10.2481"></a><span id="l10.2481" class="difflineminus">-</span>
<a href="#l10.2482"></a><span id="l10.2482" class="difflineminus">-nsresult</span>
<a href="#l10.2483"></a><span id="l10.2483" class="difflineminus">-nsMsgDBFolder::GetPromptPurgeThreshold(bool *aPrompt)</span>
<a href="#l10.2484"></a><span id="l10.2484" class="difflineminus">-{</span>
<a href="#l10.2485"></a><span id="l10.2485" class="difflineplus">+  return folderCompactor-&gt;CompactFolders(nullptr, aOfflineFolderArray,</span>
<a href="#l10.2486"></a><span id="l10.2486" class="difflineplus">+                                         aUrlListener, aWindow);</span>
<a href="#l10.2487"></a><span id="l10.2487" class="difflineplus">+}</span>
<a href="#l10.2488"></a><span id="l10.2488" class="difflineplus">+</span>
<a href="#l10.2489"></a><span id="l10.2489" class="difflineplus">+nsresult nsMsgDBFolder::GetPromptPurgeThreshold(bool *aPrompt) {</span>
<a href="#l10.2490"></a><span id="l10.2490">   NS_ENSURE_ARG(aPrompt);</span>
<a href="#l10.2491"></a><span id="l10.2491">   nsresult rv;</span>
<a href="#l10.2492"></a><span id="l10.2492" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.2493"></a><span id="l10.2493" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch)</span>
<a href="#l10.2494"></a><span id="l10.2494" class="difflineminus">-  {</span>
<a href="#l10.2495"></a><span id="l10.2495" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l10.2496"></a><span id="l10.2496" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.2497"></a><span id="l10.2497" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch) {</span>
<a href="#l10.2498"></a><span id="l10.2498">     rv = prefBranch-&gt;GetBoolPref(PREF_MAIL_PROMPT_PURGE_THRESHOLD, aPrompt);</span>
<a href="#l10.2499"></a><span id="l10.2499" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l10.2500"></a><span id="l10.2500" class="difflineminus">-    {</span>
<a href="#l10.2501"></a><span id="l10.2501" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l10.2502"></a><span id="l10.2502">       *aPrompt = false;</span>
<a href="#l10.2503"></a><span id="l10.2503">       rv = NS_OK;</span>
<a href="#l10.2504"></a><span id="l10.2504">     }</span>
<a href="#l10.2505"></a><span id="l10.2505">   }</span>
<a href="#l10.2506"></a><span id="l10.2506">   return rv;</span>
<a href="#l10.2507"></a><span id="l10.2507"> }</span>
<a href="#l10.2508"></a><span id="l10.2508"> </span>
<a href="#l10.2509"></a><span id="l10.2509" class="difflineminus">-nsresult</span>
<a href="#l10.2510"></a><span id="l10.2510" class="difflineminus">-nsMsgDBFolder::GetPurgeThreshold(int32_t *aThreshold)</span>
<a href="#l10.2511"></a><span id="l10.2511" class="difflineminus">-{</span>
<a href="#l10.2512"></a><span id="l10.2512" class="difflineplus">+nsresult nsMsgDBFolder::GetPurgeThreshold(int32_t *aThreshold) {</span>
<a href="#l10.2513"></a><span id="l10.2513">   NS_ENSURE_ARG(aThreshold);</span>
<a href="#l10.2514"></a><span id="l10.2514">   nsresult rv;</span>
<a href="#l10.2515"></a><span id="l10.2515" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.2516"></a><span id="l10.2516" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch)</span>
<a href="#l10.2517"></a><span id="l10.2517" class="difflineminus">-  {</span>
<a href="#l10.2518"></a><span id="l10.2518" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l10.2519"></a><span id="l10.2519" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.2520"></a><span id="l10.2520" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch) {</span>
<a href="#l10.2521"></a><span id="l10.2521">     int32_t thresholdMB = 20;</span>
<a href="#l10.2522"></a><span id="l10.2522">     bool thresholdMigrated = false;</span>
<a href="#l10.2523"></a><span id="l10.2523">     prefBranch-&gt;GetIntPref(PREF_MAIL_PURGE_THRESHOLD_MB, &amp;thresholdMB);</span>
<a href="#l10.2524"></a><span id="l10.2524">     prefBranch-&gt;GetBoolPref(PREF_MAIL_PURGE_MIGRATED, &amp;thresholdMigrated);</span>
<a href="#l10.2525"></a><span id="l10.2525" class="difflineminus">-    if (!thresholdMigrated)</span>
<a href="#l10.2526"></a><span id="l10.2526" class="difflineminus">-    {</span>
<a href="#l10.2527"></a><span id="l10.2527" class="difflineplus">+    if (!thresholdMigrated) {</span>
<a href="#l10.2528"></a><span id="l10.2528">       *aThreshold = 20480;</span>
<a href="#l10.2529"></a><span id="l10.2529" class="difflineminus">-      (void) prefBranch-&gt;GetIntPref(PREF_MAIL_PURGE_THRESHOLD, aThreshold);</span>
<a href="#l10.2530"></a><span id="l10.2530" class="difflineminus">-      if (*aThreshold/1024 != thresholdMB)</span>
<a href="#l10.2531"></a><span id="l10.2531" class="difflineminus">-      {</span>
<a href="#l10.2532"></a><span id="l10.2532" class="difflineminus">-        thresholdMB = std::max(1, *aThreshold/1024);</span>
<a href="#l10.2533"></a><span id="l10.2533" class="difflineplus">+      (void)prefBranch-&gt;GetIntPref(PREF_MAIL_PURGE_THRESHOLD, aThreshold);</span>
<a href="#l10.2534"></a><span id="l10.2534" class="difflineplus">+      if (*aThreshold / 1024 != thresholdMB) {</span>
<a href="#l10.2535"></a><span id="l10.2535" class="difflineplus">+        thresholdMB = std::max(1, *aThreshold / 1024);</span>
<a href="#l10.2536"></a><span id="l10.2536">         prefBranch-&gt;SetIntPref(PREF_MAIL_PURGE_THRESHOLD_MB, thresholdMB);</span>
<a href="#l10.2537"></a><span id="l10.2537">       }</span>
<a href="#l10.2538"></a><span id="l10.2538">       prefBranch-&gt;SetBoolPref(PREF_MAIL_PURGE_MIGRATED, true);</span>
<a href="#l10.2539"></a><span id="l10.2539">     }</span>
<a href="#l10.2540"></a><span id="l10.2540">     *aThreshold = thresholdMB * 1024;</span>
<a href="#l10.2541"></a><span id="l10.2541">   }</span>
<a href="#l10.2542"></a><span id="l10.2542">   return rv;</span>
<a href="#l10.2543"></a><span id="l10.2543"> }</span>
<a href="#l10.2544"></a><span id="l10.2544"> </span>
<a href="#l10.2545"></a><span id="l10.2545" class="difflineminus">-NS_IMETHODIMP //called on the folder that is renamed or about to be deleted</span>
<a href="#l10.2546"></a><span id="l10.2546" class="difflineminus">-nsMsgDBFolder::MatchOrChangeFilterDestination(nsIMsgFolder *newFolder, bool caseInsensitive, bool *found)</span>
<a href="#l10.2547"></a><span id="l10.2547" class="difflineminus">-{</span>
<a href="#l10.2548"></a><span id="l10.2548" class="difflineplus">+NS_IMETHODIMP  // called on the folder that is renamed or about to be deleted</span>
<a href="#l10.2549"></a><span id="l10.2549" class="difflineplus">+nsMsgDBFolder::MatchOrChangeFilterDestination(nsIMsgFolder *newFolder,</span>
<a href="#l10.2550"></a><span id="l10.2550" class="difflineplus">+                                              bool caseInsensitive,</span>
<a href="#l10.2551"></a><span id="l10.2551" class="difflineplus">+                                              bool *found) {</span>
<a href="#l10.2552"></a><span id="l10.2552">   NS_ENSURE_ARG_POINTER(found);</span>
<a href="#l10.2553"></a><span id="l10.2553">   nsCString oldUri;</span>
<a href="#l10.2554"></a><span id="l10.2554">   nsresult rv = GetURI(oldUri);</span>
<a href="#l10.2555"></a><span id="l10.2555" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.2556"></a><span id="l10.2556" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2557"></a><span id="l10.2557"> </span>
<a href="#l10.2558"></a><span id="l10.2558">   nsCString newUri;</span>
<a href="#l10.2559"></a><span id="l10.2559" class="difflineminus">-  if (newFolder) //for matching uri's this will be null</span>
<a href="#l10.2560"></a><span id="l10.2560" class="difflineplus">+  if (newFolder)  // for matching uri's this will be null</span>
<a href="#l10.2561"></a><span id="l10.2561">   {</span>
<a href="#l10.2562"></a><span id="l10.2562">     rv = newFolder-&gt;GetURI(newUri);</span>
<a href="#l10.2563"></a><span id="l10.2563" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.2564"></a><span id="l10.2564" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2565"></a><span id="l10.2565">   }</span>
<a href="#l10.2566"></a><span id="l10.2566"> </span>
<a href="#l10.2567"></a><span id="l10.2567">   nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l10.2568"></a><span id="l10.2568" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.2569"></a><span id="l10.2569" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l10.2570"></a><span id="l10.2570" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.2571"></a><span id="l10.2571">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2572"></a><span id="l10.2572"> </span>
<a href="#l10.2573"></a><span id="l10.2573">   nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l10.2574"></a><span id="l10.2574">   rv = accountMgr-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l10.2575"></a><span id="l10.2575">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2576"></a><span id="l10.2576"> </span>
<a href="#l10.2577"></a><span id="l10.2577">   uint32_t numServers;</span>
<a href="#l10.2578"></a><span id="l10.2578">   rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l10.2579"></a><span id="l10.2579" class="difflineminus">-  for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++)</span>
<a href="#l10.2580"></a><span id="l10.2580" class="difflineminus">-  {</span>
<a href="#l10.2581"></a><span id="l10.2581" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(allServers, serverIndex);</span>
<a href="#l10.2582"></a><span id="l10.2582" class="difflineminus">-    if (server)</span>
<a href="#l10.2583"></a><span id="l10.2583" class="difflineminus">-    {</span>
<a href="#l10.2584"></a><span id="l10.2584" class="difflineplus">+  for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++) {</span>
<a href="#l10.2585"></a><span id="l10.2585" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l10.2586"></a><span id="l10.2586" class="difflineplus">+        do_QueryElementAt(allServers, serverIndex);</span>
<a href="#l10.2587"></a><span id="l10.2587" class="difflineplus">+    if (server) {</span>
<a href="#l10.2588"></a><span id="l10.2588">       bool canHaveFilters;</span>
<a href="#l10.2589"></a><span id="l10.2589">       rv = server-&gt;GetCanHaveFilters(&amp;canHaveFilters);</span>
<a href="#l10.2590"></a><span id="l10.2590" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; canHaveFilters)</span>
<a href="#l10.2591"></a><span id="l10.2591" class="difflineminus">-      {</span>
<a href="#l10.2592"></a><span id="l10.2592" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; canHaveFilters) {</span>
<a href="#l10.2593"></a><span id="l10.2593">         // update the filterlist to match the new folder name</span>
<a href="#l10.2594"></a><span id="l10.2594">         rv = server-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l10.2595"></a><span id="l10.2595" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; filterList)</span>
<a href="#l10.2596"></a><span id="l10.2596" class="difflineminus">-        {</span>
<a href="#l10.2597"></a><span id="l10.2597" class="difflineminus">-          rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri, caseInsensitive, found);</span>
<a href="#l10.2598"></a><span id="l10.2598" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; filterList) {</span>
<a href="#l10.2599"></a><span id="l10.2599" class="difflineplus">+          rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri,</span>
<a href="#l10.2600"></a><span id="l10.2600" class="difflineplus">+                                                     caseInsensitive, found);</span>
<a href="#l10.2601"></a><span id="l10.2601">           if (NS_SUCCEEDED(rv) &amp;&amp; *found &amp;&amp; newFolder &amp;&amp; !newUri.IsEmpty())</span>
<a href="#l10.2602"></a><span id="l10.2602">             rv = filterList-&gt;SaveToDefaultFile();</span>
<a href="#l10.2603"></a><span id="l10.2603">         }</span>
<a href="#l10.2604"></a><span id="l10.2604">         // update the editable filterlist to match the new folder name</span>
<a href="#l10.2605"></a><span id="l10.2605">         rv = server-&gt;GetEditableFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l10.2606"></a><span id="l10.2606" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; filterList)</span>
<a href="#l10.2607"></a><span id="l10.2607" class="difflineminus">-        {</span>
<a href="#l10.2608"></a><span id="l10.2608" class="difflineminus">-          rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri, caseInsensitive, found);</span>
<a href="#l10.2609"></a><span id="l10.2609" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; filterList) {</span>
<a href="#l10.2610"></a><span id="l10.2610" class="difflineplus">+          rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri,</span>
<a href="#l10.2611"></a><span id="l10.2611" class="difflineplus">+                                                     caseInsensitive, found);</span>
<a href="#l10.2612"></a><span id="l10.2612">           if (NS_SUCCEEDED(rv) &amp;&amp; *found &amp;&amp; newFolder &amp;&amp; !newUri.IsEmpty())</span>
<a href="#l10.2613"></a><span id="l10.2613">             rv = filterList-&gt;SaveToDefaultFile();</span>
<a href="#l10.2614"></a><span id="l10.2614">         }</span>
<a href="#l10.2615"></a><span id="l10.2615">       }</span>
<a href="#l10.2616"></a><span id="l10.2616">     }</span>
<a href="#l10.2617"></a><span id="l10.2617">   }</span>
<a href="#l10.2618"></a><span id="l10.2618">   return rv;</span>
<a href="#l10.2619"></a><span id="l10.2619"> }</span>
<a href="#l10.2620"></a><span id="l10.2620"> </span>
<a href="#l10.2621"></a><span id="l10.2621"> NS_IMETHODIMP</span>
<a href="#l10.2622"></a><span id="l10.2622" class="difflineminus">-nsMsgDBFolder::GetDBTransferInfo(nsIDBFolderInfo **aTransferInfo)</span>
<a href="#l10.2623"></a><span id="l10.2623" class="difflineminus">-{</span>
<a href="#l10.2624"></a><span id="l10.2624" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l10.2625"></a><span id="l10.2625" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.2626"></a><span id="l10.2626" class="difflineplus">+nsMsgDBFolder::GetDBTransferInfo(nsIDBFolderInfo **aTransferInfo) {</span>
<a href="#l10.2627"></a><span id="l10.2627" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l10.2628"></a><span id="l10.2628" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.2629"></a><span id="l10.2629">   GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(db));</span>
<a href="#l10.2630"></a><span id="l10.2630" class="difflineminus">-  if (dbFolderInfo)</span>
<a href="#l10.2631"></a><span id="l10.2631" class="difflineminus">-    dbFolderInfo-&gt;GetTransferInfo(aTransferInfo);</span>
<a href="#l10.2632"></a><span id="l10.2632" class="difflineplus">+  if (dbFolderInfo) dbFolderInfo-&gt;GetTransferInfo(aTransferInfo);</span>
<a href="#l10.2633"></a><span id="l10.2633">   return NS_OK;</span>
<a href="#l10.2634"></a><span id="l10.2634"> }</span>
<a href="#l10.2635"></a><span id="l10.2635"> </span>
<a href="#l10.2636"></a><span id="l10.2636"> NS_IMETHODIMP</span>
<a href="#l10.2637"></a><span id="l10.2637" class="difflineminus">-nsMsgDBFolder::SetDBTransferInfo(nsIDBFolderInfo *aTransferInfo)</span>
<a href="#l10.2638"></a><span id="l10.2638" class="difflineminus">-{</span>
<a href="#l10.2639"></a><span id="l10.2639" class="difflineplus">+nsMsgDBFolder::SetDBTransferInfo(nsIDBFolderInfo *aTransferInfo) {</span>
<a href="#l10.2640"></a><span id="l10.2640">   NS_ENSURE_ARG(aTransferInfo);</span>
<a href="#l10.2641"></a><span id="l10.2641" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l10.2642"></a><span id="l10.2642" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.2643"></a><span id="l10.2643" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l10.2644"></a><span id="l10.2644" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.2645"></a><span id="l10.2645">   GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l10.2646"></a><span id="l10.2646" class="difflineminus">-  if (db)</span>
<a href="#l10.2647"></a><span id="l10.2647" class="difflineminus">-  {</span>
<a href="#l10.2648"></a><span id="l10.2648" class="difflineplus">+  if (db) {</span>
<a href="#l10.2649"></a><span id="l10.2649">     db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l10.2650"></a><span id="l10.2650" class="difflineminus">-    if(dbFolderInfo)</span>
<a href="#l10.2651"></a><span id="l10.2651" class="difflineminus">-    {</span>
<a href="#l10.2652"></a><span id="l10.2652" class="difflineplus">+    if (dbFolderInfo) {</span>
<a href="#l10.2653"></a><span id="l10.2653">       dbFolderInfo-&gt;InitFromTransferInfo(aTransferInfo);</span>
<a href="#l10.2654"></a><span id="l10.2654">       dbFolderInfo-&gt;SetBooleanProperty(&quot;forceReparse&quot;, false);</span>
<a href="#l10.2655"></a><span id="l10.2655">     }</span>
<a href="#l10.2656"></a><span id="l10.2656">     db-&gt;SetSummaryValid(true);</span>
<a href="#l10.2657"></a><span id="l10.2657">   }</span>
<a href="#l10.2658"></a><span id="l10.2658">   return NS_OK;</span>
<a href="#l10.2659"></a><span id="l10.2659"> }</span>
<a href="#l10.2660"></a><span id="l10.2660"> </span>
<a href="#l10.2661"></a><span id="l10.2661"> NS_IMETHODIMP</span>
<a href="#l10.2662"></a><span id="l10.2662" class="difflineminus">-nsMsgDBFolder::GetStringProperty(const char *propertyName, nsACString&amp; propertyValue)</span>
<a href="#l10.2663"></a><span id="l10.2663" class="difflineminus">-{</span>
<a href="#l10.2664"></a><span id="l10.2664" class="difflineplus">+nsMsgDBFolder::GetStringProperty(const char *propertyName,</span>
<a href="#l10.2665"></a><span id="l10.2665" class="difflineplus">+                                 nsACString &amp;propertyValue) {</span>
<a href="#l10.2666"></a><span id="l10.2666">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l10.2667"></a><span id="l10.2667" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; dbPath;</span>
<a href="#l10.2668"></a><span id="l10.2668" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l10.2669"></a><span id="l10.2669">   nsresult rv = GetFolderCacheKey(getter_AddRefs(dbPath));</span>
<a href="#l10.2670"></a><span id="l10.2670" class="difflineminus">-  if (dbPath)</span>
<a href="#l10.2671"></a><span id="l10.2671" class="difflineminus">-  {</span>
<a href="#l10.2672"></a><span id="l10.2672" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.2673"></a><span id="l10.2673" class="difflineplus">+  if (dbPath) {</span>
<a href="#l10.2674"></a><span id="l10.2674" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.2675"></a><span id="l10.2675">     rv = GetFolderCacheElemFromFile(dbPath, getter_AddRefs(cacheElement));</span>
<a href="#l10.2676"></a><span id="l10.2676" class="difflineminus">-    if (cacheElement)  //try to get from cache</span>
<a href="#l10.2677"></a><span id="l10.2677" class="difflineplus">+    if (cacheElement)  // try to get from cache</span>
<a href="#l10.2678"></a><span id="l10.2678">       rv = cacheElement-&gt;GetStringProperty(propertyName, propertyValue);</span>
<a href="#l10.2679"></a><span id="l10.2679" class="difflineminus">-    if (NS_FAILED(rv))  //if failed, then try to get from db</span>
<a href="#l10.2680"></a><span id="l10.2680" class="difflineplus">+    if (NS_FAILED(rv))  // if failed, then try to get from db</span>
<a href="#l10.2681"></a><span id="l10.2681">     {</span>
<a href="#l10.2682"></a><span id="l10.2682">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.2683"></a><span id="l10.2683">       nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.2684"></a><span id="l10.2684">       bool exists;</span>
<a href="#l10.2685"></a><span id="l10.2685">       rv = dbPath-&gt;Exists(&amp;exists);</span>
<a href="#l10.2686"></a><span id="l10.2686" class="difflineminus">-      if (NS_FAILED(rv) || !exists)</span>
<a href="#l10.2687"></a><span id="l10.2687" class="difflineminus">-        return NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l10.2688"></a><span id="l10.2688" class="difflineplus">+      if (NS_FAILED(rv) || !exists) return NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l10.2689"></a><span id="l10.2689">       rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.2690"></a><span id="l10.2690">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.2691"></a><span id="l10.2691">         rv = folderInfo-&gt;GetCharProperty(propertyName, propertyValue);</span>
<a href="#l10.2692"></a><span id="l10.2692">     }</span>
<a href="#l10.2693"></a><span id="l10.2693">   }</span>
<a href="#l10.2694"></a><span id="l10.2694">   return rv;</span>
<a href="#l10.2695"></a><span id="l10.2695"> }</span>
<a href="#l10.2696"></a><span id="l10.2696"> </span>
<a href="#l10.2697"></a><span id="l10.2697"> NS_IMETHODIMP</span>
<a href="#l10.2698"></a><span id="l10.2698" class="difflineminus">-nsMsgDBFolder::SetStringProperty(const char *propertyName, const nsACString&amp; propertyValue)</span>
<a href="#l10.2699"></a><span id="l10.2699" class="difflineminus">-{</span>
<a href="#l10.2700"></a><span id="l10.2700" class="difflineplus">+nsMsgDBFolder::SetStringProperty(const char *propertyName,</span>
<a href="#l10.2701"></a><span id="l10.2701" class="difflineplus">+                                 const nsACString &amp;propertyValue) {</span>
<a href="#l10.2702"></a><span id="l10.2702">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l10.2703"></a><span id="l10.2703" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; dbPath;</span>
<a href="#l10.2704"></a><span id="l10.2704" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l10.2705"></a><span id="l10.2705">   GetFolderCacheKey(getter_AddRefs(dbPath));</span>
<a href="#l10.2706"></a><span id="l10.2706" class="difflineminus">-  if (dbPath)</span>
<a href="#l10.2707"></a><span id="l10.2707" class="difflineminus">-  {</span>
<a href="#l10.2708"></a><span id="l10.2708" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.2709"></a><span id="l10.2709" class="difflineplus">+  if (dbPath) {</span>
<a href="#l10.2710"></a><span id="l10.2710" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l10.2711"></a><span id="l10.2711">     GetFolderCacheElemFromFile(dbPath, getter_AddRefs(cacheElement));</span>
<a href="#l10.2712"></a><span id="l10.2712" class="difflineminus">-    if (cacheElement)  //try to set in the cache</span>
<a href="#l10.2713"></a><span id="l10.2713" class="difflineplus">+    if (cacheElement)  // try to set in the cache</span>
<a href="#l10.2714"></a><span id="l10.2714">       cacheElement-&gt;SetStringProperty(propertyName, propertyValue);</span>
<a href="#l10.2715"></a><span id="l10.2715">   }</span>
<a href="#l10.2716"></a><span id="l10.2716">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.2717"></a><span id="l10.2717">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.2718"></a><span id="l10.2718" class="difflineminus">-  nsresult rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.2719"></a><span id="l10.2719" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l10.2720"></a><span id="l10.2720" class="difflineminus">-  {</span>
<a href="#l10.2721"></a><span id="l10.2721" class="difflineplus">+  nsresult rv =</span>
<a href="#l10.2722"></a><span id="l10.2722" class="difflineplus">+      GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.2723"></a><span id="l10.2723" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.2724"></a><span id="l10.2724">     folderInfo-&gt;SetCharProperty(propertyName, propertyValue);</span>
<a href="#l10.2725"></a><span id="l10.2725" class="difflineminus">-    db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);  //committing the db also commits the cache</span>
<a href="#l10.2726"></a><span id="l10.2726" class="difflineplus">+    db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);  // committing the db also</span>
<a href="#l10.2727"></a><span id="l10.2727" class="difflineplus">+                                                  // commits the cache</span>
<a href="#l10.2728"></a><span id="l10.2728">   }</span>
<a href="#l10.2729"></a><span id="l10.2729">   return NS_OK;</span>
<a href="#l10.2730"></a><span id="l10.2730"> }</span>
<a href="#l10.2731"></a><span id="l10.2731"> </span>
<a href="#l10.2732"></a><span id="l10.2732"> // Get/Set ForcePropertyEmpty is only used with inherited properties</span>
<a href="#l10.2733"></a><span id="l10.2733"> NS_IMETHODIMP</span>
<a href="#l10.2734"></a><span id="l10.2734" class="difflineminus">-nsMsgDBFolder::GetForcePropertyEmpty(const char *aPropertyName, bool *_retval)</span>
<a href="#l10.2735"></a><span id="l10.2735" class="difflineminus">-{</span>
<a href="#l10.2736"></a><span id="l10.2736" class="difflineplus">+nsMsgDBFolder::GetForcePropertyEmpty(const char *aPropertyName, bool *_retval) {</span>
<a href="#l10.2737"></a><span id="l10.2737">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l10.2738"></a><span id="l10.2738">   nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l10.2739"></a><span id="l10.2739">   nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l10.2740"></a><span id="l10.2740">   nsCString value;</span>
<a href="#l10.2741"></a><span id="l10.2741">   GetStringProperty(nameEmpty.get(), value);</span>
<a href="#l10.2742"></a><span id="l10.2742">   *_retval = value.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l10.2743"></a><span id="l10.2743">   return NS_OK;</span>
<a href="#l10.2744"></a><span id="l10.2744"> }</span>
<a href="#l10.2745"></a><span id="l10.2745"> </span>
<a href="#l10.2746"></a><span id="l10.2746"> NS_IMETHODIMP</span>
<a href="#l10.2747"></a><span id="l10.2747" class="difflineminus">-nsMsgDBFolder::SetForcePropertyEmpty(const char *aPropertyName, bool aValue)</span>
<a href="#l10.2748"></a><span id="l10.2748" class="difflineminus">-{</span>
<a href="#l10.2749"></a><span id="l10.2749" class="difflineminus">- nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l10.2750"></a><span id="l10.2750" class="difflineminus">- nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l10.2751"></a><span id="l10.2751" class="difflineminus">- return SetStringProperty(nameEmpty.get(),</span>
<a href="#l10.2752"></a><span id="l10.2752" class="difflineminus">-   aValue ? NS_LITERAL_CSTRING(&quot;true&quot;) : NS_LITERAL_CSTRING(&quot;&quot;));</span>
<a href="#l10.2753"></a><span id="l10.2753" class="difflineplus">+nsMsgDBFolder::SetForcePropertyEmpty(const char *aPropertyName, bool aValue) {</span>
<a href="#l10.2754"></a><span id="l10.2754" class="difflineplus">+  nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l10.2755"></a><span id="l10.2755" class="difflineplus">+  nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l10.2756"></a><span id="l10.2756" class="difflineplus">+  return SetStringProperty(nameEmpty.get(), aValue ? NS_LITERAL_CSTRING(&quot;true&quot;)</span>
<a href="#l10.2757"></a><span id="l10.2757" class="difflineplus">+                                                   : NS_LITERAL_CSTRING(&quot;&quot;));</span>
<a href="#l10.2758"></a><span id="l10.2758"> }</span>
<a href="#l10.2759"></a><span id="l10.2759"> </span>
<a href="#l10.2760"></a><span id="l10.2760"> NS_IMETHODIMP</span>
<a href="#l10.2761"></a><span id="l10.2761" class="difflineminus">-nsMsgDBFolder::GetInheritedStringProperty(const char *aPropertyName, nsACString&amp; aPropertyValue)</span>
<a href="#l10.2762"></a><span id="l10.2762" class="difflineminus">-{</span>
<a href="#l10.2763"></a><span id="l10.2763" class="difflineplus">+nsMsgDBFolder::GetInheritedStringProperty(const char *aPropertyName,</span>
<a href="#l10.2764"></a><span id="l10.2764" class="difflineplus">+                                          nsACString &amp;aPropertyValue) {</span>
<a href="#l10.2765"></a><span id="l10.2765">   NS_ENSURE_ARG_POINTER(aPropertyName);</span>
<a href="#l10.2766"></a><span id="l10.2766">   nsCString value;</span>
<a href="#l10.2767"></a><span id="l10.2767">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.2768"></a><span id="l10.2768"> </span>
<a href="#l10.2769"></a><span id="l10.2769">   bool forceEmpty = false;</span>
<a href="#l10.2770"></a><span id="l10.2770"> </span>
<a href="#l10.2771"></a><span id="l10.2771" class="difflineminus">-  if (!mIsServer)</span>
<a href="#l10.2772"></a><span id="l10.2772" class="difflineminus">-  {</span>
<a href="#l10.2773"></a><span id="l10.2773" class="difflineplus">+  if (!mIsServer) {</span>
<a href="#l10.2774"></a><span id="l10.2774">     GetForcePropertyEmpty(aPropertyName, &amp;forceEmpty);</span>
<a href="#l10.2775"></a><span id="l10.2775" class="difflineminus">-  }</span>
<a href="#l10.2776"></a><span id="l10.2776" class="difflineminus">-  else</span>
<a href="#l10.2777"></a><span id="l10.2777" class="difflineminus">-  {</span>
<a href="#l10.2778"></a><span id="l10.2778" class="difflineplus">+  } else {</span>
<a href="#l10.2779"></a><span id="l10.2779">     // root folders must get their values from the server</span>
<a href="#l10.2780"></a><span id="l10.2780">     GetServer(getter_AddRefs(server));</span>
<a href="#l10.2781"></a><span id="l10.2781" class="difflineminus">-    if (server)</span>
<a href="#l10.2782"></a><span id="l10.2782" class="difflineminus">-      server-&gt;GetForcePropertyEmpty(aPropertyName, &amp;forceEmpty);</span>
<a href="#l10.2783"></a><span id="l10.2783" class="difflineplus">+    if (server) server-&gt;GetForcePropertyEmpty(aPropertyName, &amp;forceEmpty);</span>
<a href="#l10.2784"></a><span id="l10.2784">   }</span>
<a href="#l10.2785"></a><span id="l10.2785"> </span>
<a href="#l10.2786"></a><span id="l10.2786" class="difflineminus">-  if (forceEmpty)</span>
<a href="#l10.2787"></a><span id="l10.2787" class="difflineminus">-  {</span>
<a href="#l10.2788"></a><span id="l10.2788" class="difflineplus">+  if (forceEmpty) {</span>
<a href="#l10.2789"></a><span id="l10.2789">     aPropertyValue.Truncate();</span>
<a href="#l10.2790"></a><span id="l10.2790">     return NS_OK;</span>
<a href="#l10.2791"></a><span id="l10.2791">   }</span>
<a href="#l10.2792"></a><span id="l10.2792"> </span>
<a href="#l10.2793"></a><span id="l10.2793" class="difflineminus">-  // servers will automatically inherit from the preference mail.server.default.(propertyName)</span>
<a href="#l10.2794"></a><span id="l10.2794" class="difflineminus">-  if (server)</span>
<a href="#l10.2795"></a><span id="l10.2795" class="difflineminus">-    return server-&gt;GetCharValue(aPropertyName, aPropertyValue);</span>
<a href="#l10.2796"></a><span id="l10.2796" class="difflineplus">+  // servers will automatically inherit from the preference</span>
<a href="#l10.2797"></a><span id="l10.2797" class="difflineplus">+  // mail.server.default.(propertyName)</span>
<a href="#l10.2798"></a><span id="l10.2798" class="difflineplus">+  if (server) return server-&gt;GetCharValue(aPropertyName, aPropertyValue);</span>
<a href="#l10.2799"></a><span id="l10.2799"> </span>
<a href="#l10.2800"></a><span id="l10.2800">   GetStringProperty(aPropertyName, value);</span>
<a href="#l10.2801"></a><span id="l10.2801" class="difflineminus">-  if (value.IsEmpty())</span>
<a href="#l10.2802"></a><span id="l10.2802" class="difflineminus">-  {</span>
<a href="#l10.2803"></a><span id="l10.2803" class="difflineplus">+  if (value.IsEmpty()) {</span>
<a href="#l10.2804"></a><span id="l10.2804">     // inherit from the parent</span>
<a href="#l10.2805"></a><span id="l10.2805">     nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l10.2806"></a><span id="l10.2806">     GetParent(getter_AddRefs(parent));</span>
<a href="#l10.2807"></a><span id="l10.2807">     if (parent)</span>
<a href="#l10.2808"></a><span id="l10.2808">       return parent-&gt;GetInheritedStringProperty(aPropertyName, aPropertyValue);</span>
<a href="#l10.2809"></a><span id="l10.2809">   }</span>
<a href="#l10.2810"></a><span id="l10.2810"> </span>
<a href="#l10.2811"></a><span id="l10.2811">   aPropertyValue.Assign(value);</span>
<a href="#l10.2812"></a><span id="l10.2812">   return NS_OK;</span>
<a href="#l10.2813"></a><span id="l10.2813"> }</span>
<a href="#l10.2814"></a><span id="l10.2814"> </span>
<a href="#l10.2815"></a><span id="l10.2815" class="difflineminus">-nsresult</span>
<a href="#l10.2816"></a><span id="l10.2816" class="difflineminus">-nsMsgDBFolder::SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l10.2817"></a><span id="l10.2817" class="difflineminus">-{</span>
<a href="#l10.2818"></a><span id="l10.2818" class="difflineplus">+nsresult nsMsgDBFolder::SpamFilterClassifyMessage(</span>
<a href="#l10.2819"></a><span id="l10.2819" class="difflineplus">+    const char *aURI, nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.2820"></a><span id="l10.2820" class="difflineplus">+    nsIJunkMailPlugin *aJunkMailPlugin) {</span>
<a href="#l10.2821"></a><span id="l10.2821">   nsresult rv;</span>
<a href="#l10.2822"></a><span id="l10.2822" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.2823"></a><span id="l10.2823" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(</span>
<a href="#l10.2824"></a><span id="l10.2824" class="difflineplus">+      do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.2825"></a><span id="l10.2825">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2826"></a><span id="l10.2826"> </span>
<a href="#l10.2827"></a><span id="l10.2827">   uint32_t count;</span>
<a href="#l10.2828"></a><span id="l10.2828">   uint32_t *proIndices;</span>
<a href="#l10.2829"></a><span id="l10.2829">   uint32_t *antiIndices;</span>
<a href="#l10.2830"></a><span id="l10.2830">   rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l10.2831"></a><span id="l10.2831">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2832"></a><span id="l10.2832"> </span>
<a href="#l10.2833"></a><span id="l10.2833" class="difflineminus">-  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(aURI, count, proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l10.2834"></a><span id="l10.2834" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(</span>
<a href="#l10.2835"></a><span id="l10.2835" class="difflineplus">+      aURI, count, proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l10.2836"></a><span id="l10.2836">   free(proIndices);</span>
<a href="#l10.2837"></a><span id="l10.2837">   free(antiIndices);</span>
<a href="#l10.2838"></a><span id="l10.2838">   return rv;</span>
<a href="#l10.2839"></a><span id="l10.2839"> }</span>
<a href="#l10.2840"></a><span id="l10.2840"> </span>
<a href="#l10.2841"></a><span id="l10.2841" class="difflineminus">-nsresult</span>
<a href="#l10.2842"></a><span id="l10.2842" class="difflineminus">-nsMsgDBFolder::SpamFilterClassifyMessages(const char **aURIArray, uint32_t aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l10.2843"></a><span id="l10.2843" class="difflineminus">-{</span>
<a href="#l10.2844"></a><span id="l10.2844" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running Spam classification on %&quot; PRIu32 &quot; messages&quot;, aURICount));</span>
<a href="#l10.2845"></a><span id="l10.2845" class="difflineplus">+nsresult nsMsgDBFolder::SpamFilterClassifyMessages(</span>
<a href="#l10.2846"></a><span id="l10.2846" class="difflineplus">+    const char **aURIArray, uint32_t aURICount, nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.2847"></a><span id="l10.2847" class="difflineplus">+    nsIJunkMailPlugin *aJunkMailPlugin) {</span>
<a href="#l10.2848"></a><span id="l10.2848" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.2849"></a><span id="l10.2849" class="difflineplus">+          (&quot;Running Spam classification on %&quot; PRIu32 &quot; messages&quot;, aURICount));</span>
<a href="#l10.2850"></a><span id="l10.2850"> </span>
<a href="#l10.2851"></a><span id="l10.2851">   nsresult rv;</span>
<a href="#l10.2852"></a><span id="l10.2852" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.2853"></a><span id="l10.2853" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(</span>
<a href="#l10.2854"></a><span id="l10.2854" class="difflineplus">+      do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.2855"></a><span id="l10.2855">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2856"></a><span id="l10.2856"> </span>
<a href="#l10.2857"></a><span id="l10.2857">   uint32_t count;</span>
<a href="#l10.2858"></a><span id="l10.2858">   uint32_t *proIndices;</span>
<a href="#l10.2859"></a><span id="l10.2859">   uint32_t *antiIndices;</span>
<a href="#l10.2860"></a><span id="l10.2860">   rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l10.2861"></a><span id="l10.2861">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2862"></a><span id="l10.2862"> </span>
<a href="#l10.2863"></a><span id="l10.2863">   rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessages(aURICount, aURIArray, count,</span>
<a href="#l10.2864"></a><span id="l10.2864" class="difflineminus">-      proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l10.2865"></a><span id="l10.2865" class="difflineplus">+                                                 proIndices, antiIndices, this,</span>
<a href="#l10.2866"></a><span id="l10.2866" class="difflineplus">+                                                 aMsgWindow, this);</span>
<a href="#l10.2867"></a><span id="l10.2867">   free(proIndices);</span>
<a href="#l10.2868"></a><span id="l10.2868">   free(antiIndices);</span>
<a href="#l10.2869"></a><span id="l10.2869">   return rv;</span>
<a href="#l10.2870"></a><span id="l10.2870"> }</span>
<a href="#l10.2871"></a><span id="l10.2871"> </span>
<a href="#l10.2872"></a><span id="l10.2872"> NS_IMETHODIMP</span>
<a href="#l10.2873"></a><span id="l10.2873"> nsMsgDBFolder::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l10.2874"></a><span id="l10.2874">                                    nsMsgJunkStatus aClassification,</span>
<a href="#l10.2875"></a><span id="l10.2875" class="difflineminus">-                                   uint32_t aJunkPercent)</span>
<a href="#l10.2876"></a><span id="l10.2876" class="difflineminus">-{</span>
<a href="#l10.2877"></a><span id="l10.2877" class="difflineminus">-  if (!aMsgURI) // This signifies end of batch.</span>
<a href="#l10.2878"></a><span id="l10.2878" class="difflineplus">+                                   uint32_t aJunkPercent) {</span>
<a href="#l10.2879"></a><span id="l10.2879" class="difflineplus">+  if (!aMsgURI)  // This signifies end of batch.</span>
<a href="#l10.2880"></a><span id="l10.2880">   {</span>
<a href="#l10.2881"></a><span id="l10.2881">     nsresult rv = NS_OK;</span>
<a href="#l10.2882"></a><span id="l10.2882">     // Apply filters if needed.</span>
<a href="#l10.2883"></a><span id="l10.2883">     uint32_t length;</span>
<a href="#l10.2884"></a><span id="l10.2884">     if (mPostBayesMessagesToFilter &amp;&amp;</span>
<a href="#l10.2885"></a><span id="l10.2885" class="difflineminus">-         NS_SUCCEEDED(mPostBayesMessagesToFilter-&gt;GetLength(&amp;length)) &amp;&amp;</span>
<a href="#l10.2886"></a><span id="l10.2886" class="difflineminus">-         length)</span>
<a href="#l10.2887"></a><span id="l10.2887" class="difflineminus">-    {</span>
<a href="#l10.2888"></a><span id="l10.2888" class="difflineplus">+        NS_SUCCEEDED(mPostBayesMessagesToFilter-&gt;GetLength(&amp;length)) &amp;&amp;</span>
<a href="#l10.2889"></a><span id="l10.2889" class="difflineplus">+        length) {</span>
<a href="#l10.2890"></a><span id="l10.2890">       // Apply post-bayes filtering.</span>
<a href="#l10.2891"></a><span id="l10.2891" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFilterService&gt;</span>
<a href="#l10.2892"></a><span id="l10.2892" class="difflineminus">-        filterService(do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.2893"></a><span id="l10.2893" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFilterService&gt; filterService(</span>
<a href="#l10.2894"></a><span id="l10.2894" class="difflineplus">+          do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.2895"></a><span id="l10.2895">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.2896"></a><span id="l10.2896">         // We use a null nsIMsgWindow because we don't want some sort of ui</span>
<a href="#l10.2897"></a><span id="l10.2897">         // appearing in the middle of automatic filtering (plus I really don't</span>
<a href="#l10.2898"></a><span id="l10.2898">         // want to propagate that value.)</span>
<a href="#l10.2899"></a><span id="l10.2899">         rv = filterService-&gt;ApplyFilters(nsMsgFilterType::PostPlugin,</span>
<a href="#l10.2900"></a><span id="l10.2900" class="difflineminus">-                                         mPostBayesMessagesToFilter,</span>
<a href="#l10.2901"></a><span id="l10.2901" class="difflineminus">-                                         this, nullptr, nullptr);</span>
<a href="#l10.2902"></a><span id="l10.2902" class="difflineplus">+                                         mPostBayesMessagesToFilter, this,</span>
<a href="#l10.2903"></a><span id="l10.2903" class="difflineplus">+                                         nullptr, nullptr);</span>
<a href="#l10.2904"></a><span id="l10.2904">       mPostBayesMessagesToFilter-&gt;Clear();</span>
<a href="#l10.2905"></a><span id="l10.2905">     }</span>
<a href="#l10.2906"></a><span id="l10.2906"> </span>
<a href="#l10.2907"></a><span id="l10.2907">     // Bail if we didn't actually classify any messages.</span>
<a href="#l10.2908"></a><span id="l10.2908" class="difflineminus">-    if (mClassifiedMsgKeys.IsEmpty())</span>
<a href="#l10.2909"></a><span id="l10.2909" class="difflineminus">-      return rv;</span>
<a href="#l10.2910"></a><span id="l10.2910" class="difflineplus">+    if (mClassifiedMsgKeys.IsEmpty()) return rv;</span>
<a href="#l10.2911"></a><span id="l10.2911"> </span>
<a href="#l10.2912"></a><span id="l10.2912">     // Notify that we classified some messages.</span>
<a href="#l10.2913"></a><span id="l10.2913" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l10.2914"></a><span id="l10.2914" class="difflineminus">-      notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.2915"></a><span id="l10.2915" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l10.2916"></a><span id="l10.2916" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.2917"></a><span id="l10.2917">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2918"></a><span id="l10.2918"> </span>
<a href="#l10.2919"></a><span id="l10.2919" class="difflineminus">-    nsCOMPtr &lt;nsIMutableArray&gt; classifiedMsgHdrs =</span>
<a href="#l10.2920"></a><span id="l10.2920" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.2921"></a><span id="l10.2921" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; classifiedMsgHdrs =</span>
<a href="#l10.2922"></a><span id="l10.2922" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l10.2923"></a><span id="l10.2923">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2924"></a><span id="l10.2924"> </span>
<a href="#l10.2925"></a><span id="l10.2925">     uint32_t numKeys = mClassifiedMsgKeys.Length();</span>
<a href="#l10.2926"></a><span id="l10.2926" class="difflineminus">-    for (uint32_t i = 0 ; i &lt; numKeys ; ++i)</span>
<a href="#l10.2927"></a><span id="l10.2927" class="difflineminus">-    {</span>
<a href="#l10.2928"></a><span id="l10.2928" class="difflineplus">+    for (uint32_t i = 0; i &lt; numKeys; ++i) {</span>
<a href="#l10.2929"></a><span id="l10.2929">       nsMsgKey msgKey = mClassifiedMsgKeys[i];</span>
<a href="#l10.2930"></a><span id="l10.2930">       bool hasKey;</span>
<a href="#l10.2931"></a><span id="l10.2931">       // It is very possible for a message header to no longer be around because</span>
<a href="#l10.2932"></a><span id="l10.2932">       // a filter moved it.</span>
<a href="#l10.2933"></a><span id="l10.2933">       rv = mDatabase-&gt;ContainsKey(msgKey, &amp;hasKey);</span>
<a href="#l10.2934"></a><span id="l10.2934" class="difflineminus">-      if (!NS_SUCCEEDED(rv) || !hasKey)</span>
<a href="#l10.2935"></a><span id="l10.2935" class="difflineminus">-        continue;</span>
<a href="#l10.2936"></a><span id="l10.2936" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.2937"></a><span id="l10.2937" class="difflineplus">+      if (!NS_SUCCEEDED(rv) || !hasKey) continue;</span>
<a href="#l10.2938"></a><span id="l10.2938" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.2939"></a><span id="l10.2939">       rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l10.2940"></a><span id="l10.2940" class="difflineminus">-      if (!NS_SUCCEEDED(rv))</span>
<a href="#l10.2941"></a><span id="l10.2941" class="difflineminus">-        continue;</span>
<a href="#l10.2942"></a><span id="l10.2942" class="difflineplus">+      if (!NS_SUCCEEDED(rv)) continue;</span>
<a href="#l10.2943"></a><span id="l10.2943">       classifiedMsgHdrs-&gt;AppendElement(msgHdr);</span>
<a href="#l10.2944"></a><span id="l10.2944">     }</span>
<a href="#l10.2945"></a><span id="l10.2945"> </span>
<a href="#l10.2946"></a><span id="l10.2946">     // only generate the notification if there are some classified messages</span>
<a href="#l10.2947"></a><span id="l10.2947">     if (NS_SUCCEEDED(classifiedMsgHdrs-&gt;GetLength(&amp;length)) &amp;&amp; length)</span>
<a href="#l10.2948"></a><span id="l10.2948" class="difflineminus">-      notifier-&gt;NotifyMsgsClassified(classifiedMsgHdrs,</span>
<a href="#l10.2949"></a><span id="l10.2949" class="difflineminus">-                                     mBayesJunkClassifying,</span>
<a href="#l10.2950"></a><span id="l10.2950" class="difflineplus">+      notifier-&gt;NotifyMsgsClassified(classifiedMsgHdrs, mBayesJunkClassifying,</span>
<a href="#l10.2951"></a><span id="l10.2951">                                      mBayesTraitClassifying);</span>
<a href="#l10.2952"></a><span id="l10.2952">     mClassifiedMsgKeys.Clear();</span>
<a href="#l10.2953"></a><span id="l10.2953"> </span>
<a href="#l10.2954"></a><span id="l10.2954">     return rv;</span>
<a href="#l10.2955"></a><span id="l10.2955">   }</span>
<a href="#l10.2956"></a><span id="l10.2956"> </span>
<a href="#l10.2957"></a><span id="l10.2957">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.2958"></a><span id="l10.2958">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.2959"></a><span id="l10.2959">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2960"></a><span id="l10.2960"> </span>
<a href="#l10.2961"></a><span id="l10.2961">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l10.2962"></a><span id="l10.2962">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l10.2963"></a><span id="l10.2963">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2964"></a><span id="l10.2964"> </span>
<a href="#l10.2965"></a><span id="l10.2965" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.2966"></a><span id="l10.2966" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.2967"></a><span id="l10.2967">   rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l10.2968"></a><span id="l10.2968">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2969"></a><span id="l10.2969"> </span>
<a href="#l10.2970"></a><span id="l10.2970">   nsMsgKey msgKey;</span>
<a href="#l10.2971"></a><span id="l10.2971">   rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.2972"></a><span id="l10.2972">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.2973"></a><span id="l10.2973"> </span>
<a href="#l10.2974"></a><span id="l10.2974">   // check if this message needs junk classification</span>
<a href="#l10.2975"></a><span id="l10.2975">   uint32_t processingFlags;</span>
<a href="#l10.2976"></a><span id="l10.2976">   GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l10.2977"></a><span id="l10.2977"> </span>
<a href="#l10.2978"></a><span id="l10.2978" class="difflineminus">-  if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l10.2979"></a><span id="l10.2979" class="difflineminus">-  {</span>
<a href="#l10.2980"></a><span id="l10.2980" class="difflineplus">+  if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk) {</span>
<a href="#l10.2981"></a><span id="l10.2981">     mClassifiedMsgKeys.AppendElement(msgKey);</span>
<a href="#l10.2982"></a><span id="l10.2982">     AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l10.2983"></a><span id="l10.2983"> </span>
<a href="#l10.2984"></a><span id="l10.2984">     nsAutoCString msgJunkScore;</span>
<a href="#l10.2985"></a><span id="l10.2985" class="difflineminus">-    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l10.2986"></a><span id="l10.2986" class="difflineminus">-          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l10.2987"></a><span id="l10.2987" class="difflineminus">-          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l10.2988"></a><span id="l10.2988" class="difflineplus">+    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK</span>
<a href="#l10.2989"></a><span id="l10.2989" class="difflineplus">+                               ? nsIJunkMailPlugin::IS_SPAM_SCORE</span>
<a href="#l10.2990"></a><span id="l10.2990" class="difflineplus">+                               : nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l10.2991"></a><span id="l10.2991">     mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l10.2992"></a><span id="l10.2992">     mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l10.2993"></a><span id="l10.2993"> </span>
<a href="#l10.2994"></a><span id="l10.2994">     nsAutoCString strPercent;</span>
<a href="#l10.2995"></a><span id="l10.2995">     strPercent.AppendInt(aJunkPercent);</span>
<a href="#l10.2996"></a><span id="l10.2996">     mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, strPercent.get());</span>
<a href="#l10.2997"></a><span id="l10.2997"> </span>
<a href="#l10.2998"></a><span id="l10.2998" class="difflineminus">-    if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l10.2999"></a><span id="l10.2999" class="difflineminus">-    {</span>
<a href="#l10.3000"></a><span id="l10.3000" class="difflineplus">+    if (aClassification == nsIJunkMailPlugin::JUNK) {</span>
<a href="#l10.3001"></a><span id="l10.3001">       // IMAP has its own way of marking read.</span>
<a href="#l10.3002"></a><span id="l10.3002" class="difflineminus">-      if (!(mFlags &amp; nsMsgFolderFlags::ImapBox))</span>
<a href="#l10.3003"></a><span id="l10.3003" class="difflineminus">-      {</span>
<a href="#l10.3004"></a><span id="l10.3004" class="difflineplus">+      if (!(mFlags &amp; nsMsgFolderFlags::ImapBox)) {</span>
<a href="#l10.3005"></a><span id="l10.3005">         bool markAsReadOnSpam;</span>
<a href="#l10.3006"></a><span id="l10.3006">         (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l10.3007"></a><span id="l10.3007" class="difflineminus">-        if (markAsReadOnSpam)</span>
<a href="#l10.3008"></a><span id="l10.3008" class="difflineminus">-        {</span>
<a href="#l10.3009"></a><span id="l10.3009" class="difflineplus">+        if (markAsReadOnSpam) {</span>
<a href="#l10.3010"></a><span id="l10.3010">           rv = mDatabase-&gt;MarkRead(msgKey, true, this);</span>
<a href="#l10.3011"></a><span id="l10.3011">           if (!NS_SUCCEEDED(rv))</span>
<a href="#l10.3012"></a><span id="l10.3012">             NS_WARNING(&quot;failed marking spam message as read&quot;);</span>
<a href="#l10.3013"></a><span id="l10.3013">         }</span>
<a href="#l10.3014"></a><span id="l10.3014">       }</span>
<a href="#l10.3015"></a><span id="l10.3015">       // mail folders will log junk hits with move info. Perhaps we should</span>
<a href="#l10.3016"></a><span id="l10.3016">       // add a log here for non-mail folders as well, that don't override</span>
<a href="#l10.3017"></a><span id="l10.3017">       // onMessageClassified</span>
<a href="#l10.3018"></a><span id="l10.3018" class="difflineminus">-      //rv = spamSettings-&gt;LogJunkHit(msgHdr, false);</span>
<a href="#l10.3019"></a><span id="l10.3019" class="difflineminus">-      //NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.3020"></a><span id="l10.3020" class="difflineplus">+      // rv = spamSettings-&gt;LogJunkHit(msgHdr, false);</span>
<a href="#l10.3021"></a><span id="l10.3021" class="difflineplus">+      // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.3022"></a><span id="l10.3022">     }</span>
<a href="#l10.3023"></a><span id="l10.3023">   }</span>
<a href="#l10.3024"></a><span id="l10.3024">   return NS_OK;</span>
<a href="#l10.3025"></a><span id="l10.3025"> }</span>
<a href="#l10.3026"></a><span id="l10.3026"> </span>
<a href="#l10.3027"></a><span id="l10.3027"> NS_IMETHODIMP</span>
<a href="#l10.3028"></a><span id="l10.3028"> nsMsgDBFolder::OnMessageTraitsClassified(const char *aMsgURI,</span>
<a href="#l10.3029"></a><span id="l10.3029">                                          uint32_t aTraitCount,</span>
<a href="#l10.3030"></a><span id="l10.3030">                                          uint32_t *aTraits,</span>
<a href="#l10.3031"></a><span id="l10.3031" class="difflineminus">-                                         uint32_t *aPercents)</span>
<a href="#l10.3032"></a><span id="l10.3032" class="difflineminus">-{</span>
<a href="#l10.3033"></a><span id="l10.3033" class="difflineminus">-  if (!aMsgURI) // This signifies end of batch</span>
<a href="#l10.3034"></a><span id="l10.3034" class="difflineminus">-    return NS_OK; // We are not handling batching</span>
<a href="#l10.3035"></a><span id="l10.3035" class="difflineplus">+                                         uint32_t *aPercents) {</span>
<a href="#l10.3036"></a><span id="l10.3036" class="difflineplus">+  if (!aMsgURI)    // This signifies end of batch</span>
<a href="#l10.3037"></a><span id="l10.3037" class="difflineplus">+    return NS_OK;  // We are not handling batching</span>
<a href="#l10.3038"></a><span id="l10.3038"> </span>
<a href="#l10.3039"></a><span id="l10.3039">   nsresult rv;</span>
<a href="#l10.3040"></a><span id="l10.3040" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.3041"></a><span id="l10.3041" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.3042"></a><span id="l10.3042">   rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l10.3043"></a><span id="l10.3043">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3044"></a><span id="l10.3044"> </span>
<a href="#l10.3045"></a><span id="l10.3045">   nsMsgKey msgKey;</span>
<a href="#l10.3046"></a><span id="l10.3046">   rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.3047"></a><span id="l10.3047">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3048"></a><span id="l10.3048"> </span>
<a href="#l10.3049"></a><span id="l10.3049">   uint32_t processingFlags;</span>
<a href="#l10.3050"></a><span id="l10.3050">   GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l10.3051"></a><span id="l10.3051" class="difflineminus">-  if (!(processingFlags &amp; nsMsgProcessingFlags::ClassifyTraits))</span>
<a href="#l10.3052"></a><span id="l10.3052" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.3053"></a><span id="l10.3053" class="difflineplus">+  if (!(processingFlags &amp; nsMsgProcessingFlags::ClassifyTraits)) return NS_OK;</span>
<a href="#l10.3054"></a><span id="l10.3054"> </span>
<a href="#l10.3055"></a><span id="l10.3055">   AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyTraits);</span>
<a href="#l10.3056"></a><span id="l10.3056"> </span>
<a href="#l10.3057"></a><span id="l10.3057">   nsCOMPtr&lt;nsIMsgTraitService&gt; traitService;</span>
<a href="#l10.3058"></a><span id="l10.3058">   traitService = do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv);</span>
<a href="#l10.3059"></a><span id="l10.3059">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3060"></a><span id="l10.3060"> </span>
<a href="#l10.3061"></a><span id="l10.3061" class="difflineminus">-  for (uint32_t i = 0; i &lt; aTraitCount; i++)</span>
<a href="#l10.3062"></a><span id="l10.3062" class="difflineminus">-  {</span>
<a href="#l10.3063"></a><span id="l10.3063" class="difflineplus">+  for (uint32_t i = 0; i &lt; aTraitCount; i++) {</span>
<a href="#l10.3064"></a><span id="l10.3064">     if (aTraits[i] == nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l10.3065"></a><span id="l10.3065" class="difflineminus">-      continue; // junk is processed by the junk listener</span>
<a href="#l10.3066"></a><span id="l10.3066" class="difflineplus">+      continue;  // junk is processed by the junk listener</span>
<a href="#l10.3067"></a><span id="l10.3067">     nsAutoCString traitId;</span>
<a href="#l10.3068"></a><span id="l10.3068">     rv = traitService-&gt;GetId(aTraits[i], traitId);</span>
<a href="#l10.3069"></a><span id="l10.3069">     traitId.InsertLiteral(&quot;bayespercent/&quot;, 0);</span>
<a href="#l10.3070"></a><span id="l10.3070">     nsAutoCString strPercent;</span>
<a href="#l10.3071"></a><span id="l10.3071">     strPercent.AppendInt(aPercents[i]);</span>
<a href="#l10.3072"></a><span id="l10.3072">     mDatabase-&gt;SetStringPropertyByHdr(msgHdr, traitId.get(), strPercent.get());</span>
<a href="#l10.3073"></a><span id="l10.3073">   }</span>
<a href="#l10.3074"></a><span id="l10.3074">   return NS_OK;</span>
<a href="#l10.3075"></a><span id="l10.3075"> }</span>
<a href="#l10.3076"></a><span id="l10.3076"> </span>
<a href="#l10.3077"></a><span id="l10.3077"> /**</span>
<a href="#l10.3078"></a><span id="l10.3078">  * Call the filter plugins (XXX currently just one)</span>
<a href="#l10.3079"></a><span id="l10.3079">  */</span>
<a href="#l10.3080"></a><span id="l10.3080"> NS_IMETHODIMP</span>
<a href="#l10.3081"></a><span id="l10.3081" class="difflineminus">-nsMsgDBFolder::CallFilterPlugins(nsIMsgWindow *aMsgWindow, bool *aFiltersRun)</span>
<a href="#l10.3082"></a><span id="l10.3082" class="difflineminus">-{</span>
<a href="#l10.3083"></a><span id="l10.3083" class="difflineplus">+nsMsgDBFolder::CallFilterPlugins(nsIMsgWindow *aMsgWindow, bool *aFiltersRun) {</span>
<a href="#l10.3084"></a><span id="l10.3084">   NS_ENSURE_ARG_POINTER(aFiltersRun);</span>
<a href="#l10.3085"></a><span id="l10.3085"> </span>
<a href="#l10.3086"></a><span id="l10.3086">   nsString folderName;</span>
<a href="#l10.3087"></a><span id="l10.3087">   GetPrettyName(folderName);</span>
<a href="#l10.3088"></a><span id="l10.3088" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running filter plugins on folder '%s'&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l10.3089"></a><span id="l10.3089" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3090"></a><span id="l10.3090" class="difflineplus">+          (&quot;Running filter plugins on folder '%s'&quot;,</span>
<a href="#l10.3091"></a><span id="l10.3091" class="difflineplus">+           NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l10.3092"></a><span id="l10.3092"> </span>
<a href="#l10.3093"></a><span id="l10.3093">   *aFiltersRun = false;</span>
<a href="#l10.3094"></a><span id="l10.3094">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.3095"></a><span id="l10.3095">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l10.3096"></a><span id="l10.3096">   int32_t spamLevel = 0;</span>
<a href="#l10.3097"></a><span id="l10.3097"> </span>
<a href="#l10.3098"></a><span id="l10.3098">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.3099"></a><span id="l10.3099">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3100"></a><span id="l10.3100"> </span>
<a href="#l10.3101"></a><span id="l10.3101">   nsCString serverType;</span>
<a href="#l10.3102"></a><span id="l10.3102">   server-&gt;GetType(serverType);</span>
<a href="#l10.3103"></a><span id="l10.3103"> </span>
<a href="#l10.3104"></a><span id="l10.3104">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l10.3105"></a><span id="l10.3105" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterPlugin&gt; filterPlugin;</span>
<a href="#l10.3106"></a><span id="l10.3106" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterPlugin&gt; filterPlugin;</span>
<a href="#l10.3107"></a><span id="l10.3107">   server-&gt;GetSpamFilterPlugin(getter_AddRefs(filterPlugin));</span>
<a href="#l10.3108"></a><span id="l10.3108" class="difflineminus">-  if (!filterPlugin) // it's not an error not to have the filter plugin.</span>
<a href="#l10.3109"></a><span id="l10.3109" class="difflineplus">+  if (!filterPlugin)  // it's not an error not to have the filter plugin.</span>
<a href="#l10.3110"></a><span id="l10.3110">     return NS_OK;</span>
<a href="#l10.3111"></a><span id="l10.3111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3112"></a><span id="l10.3112"> </span>
<a href="#l10.3113"></a><span id="l10.3113" class="difflineminus">-  nsCOMPtr &lt;nsIJunkMailPlugin&gt; junkMailPlugin = do_QueryInterface(filterPlugin);</span>
<a href="#l10.3114"></a><span id="l10.3114" class="difflineminus">-  if (!junkMailPlugin) // we currently only support the junk mail plugin</span>
<a href="#l10.3115"></a><span id="l10.3115" class="difflineplus">+  nsCOMPtr&lt;nsIJunkMailPlugin&gt; junkMailPlugin = do_QueryInterface(filterPlugin);</span>
<a href="#l10.3116"></a><span id="l10.3116" class="difflineplus">+  if (!junkMailPlugin)  // we currently only support the junk mail plugin</span>
<a href="#l10.3117"></a><span id="l10.3117">     return NS_OK;</span>
<a href="#l10.3118"></a><span id="l10.3118"> </span>
<a href="#l10.3119"></a><span id="l10.3119">   // if it's a news folder, then we really don't support junk in the ui</span>
<a href="#l10.3120"></a><span id="l10.3120">   // yet the legacy spamLevel seems to think we should analyze it.</span>
<a href="#l10.3121"></a><span id="l10.3121">   // Maybe we should upgrade that, but for now let's not analyze. We'll</span>
<a href="#l10.3122"></a><span id="l10.3122">   // let an extension set an inherited property if they really want us to</span>
<a href="#l10.3123"></a><span id="l10.3123">   // analyze this. We need that anyway to allow extension-based overrides.</span>
<a href="#l10.3124"></a><span id="l10.3124">   // When we finalize adding junk in news to core, we'll deal with the</span>
<a href="#l10.3125"></a><span id="l10.3125" class="difflineat">@@ -2544,194 +2338,192 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l10.3126"></a><span id="l10.3126">   //</span>
<a href="#l10.3127"></a><span id="l10.3127">   // if it's a public imap folder, or another users</span>
<a href="#l10.3128"></a><span id="l10.3128">   // imap folder, don't analyze for spam, because</span>
<a href="#l10.3129"></a><span id="l10.3129">   // it's not ours to analyze</span>
<a href="#l10.3130"></a><span id="l10.3130">   //</span>
<a href="#l10.3131"></a><span id="l10.3131"> </span>
<a href="#l10.3132"></a><span id="l10.3132">   bool filterForJunk = true;</span>
<a href="#l10.3133"></a><span id="l10.3133">   if (serverType.EqualsLiteral(&quot;rss&quot;) ||</span>
<a href="#l10.3134"></a><span id="l10.3134" class="difflineminus">-      (mFlags &amp; (nsMsgFolderFlags::SpecialUse |</span>
<a href="#l10.3135"></a><span id="l10.3135" class="difflineminus">-                 nsMsgFolderFlags::ImapPublic | nsMsgFolderFlags::Newsgroup |</span>
<a href="#l10.3136"></a><span id="l10.3136" class="difflineminus">-                 nsMsgFolderFlags::ImapOtherUser) &amp;&amp;</span>
<a href="#l10.3137"></a><span id="l10.3137" class="difflineplus">+      (mFlags &amp;</span>
<a href="#l10.3138"></a><span id="l10.3138" class="difflineplus">+           (nsMsgFolderFlags::SpecialUse | nsMsgFolderFlags::ImapPublic |</span>
<a href="#l10.3139"></a><span id="l10.3139" class="difflineplus">+            nsMsgFolderFlags::Newsgroup | nsMsgFolderFlags::ImapOtherUser) &amp;&amp;</span>
<a href="#l10.3140"></a><span id="l10.3140">        !(mFlags &amp; nsMsgFolderFlags::Inbox)))</span>
<a href="#l10.3141"></a><span id="l10.3141">     filterForJunk = false;</span>
<a href="#l10.3142"></a><span id="l10.3142"> </span>
<a href="#l10.3143"></a><span id="l10.3143">   spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l10.3144"></a><span id="l10.3144" class="difflineminus">-  if (!spamLevel)</span>
<a href="#l10.3145"></a><span id="l10.3145" class="difflineminus">-    filterForJunk = false;</span>
<a href="#l10.3146"></a><span id="l10.3146" class="difflineplus">+  if (!spamLevel) filterForJunk = false;</span>
<a href="#l10.3147"></a><span id="l10.3147"> </span>
<a href="#l10.3148"></a><span id="l10.3148">   /*</span>
<a href="#l10.3149"></a><span id="l10.3149">    * We'll use inherited folder properties for the junk trait to override the</span>
<a href="#l10.3150"></a><span id="l10.3150">    * standard server-based activation of junk processing. This provides a</span>
<a href="#l10.3151"></a><span id="l10.3151">    * hook for extensions to customize the application of junk filtering.</span>
<a href="#l10.3152"></a><span id="l10.3152">    * Set inherited property &quot;dobayes.mailnews@mozilla.org#junk&quot; to &quot;true&quot;</span>
<a href="#l10.3153"></a><span id="l10.3153">    * to force junk processing, and &quot;false&quot; to skip junk processing.</span>
<a href="#l10.3154"></a><span id="l10.3154">    */</span>
<a href="#l10.3155"></a><span id="l10.3155"> </span>
<a href="#l10.3156"></a><span id="l10.3156">   nsAutoCString junkEnableOverride;</span>
<a href="#l10.3157"></a><span id="l10.3157" class="difflineminus">-  GetInheritedStringProperty(&quot;dobayes.mailnews@mozilla.org#junk&quot;, junkEnableOverride);</span>
<a href="#l10.3158"></a><span id="l10.3158" class="difflineplus">+  GetInheritedStringProperty(&quot;dobayes.mailnews@mozilla.org#junk&quot;,</span>
<a href="#l10.3159"></a><span id="l10.3159" class="difflineplus">+                             junkEnableOverride);</span>
<a href="#l10.3160"></a><span id="l10.3160">   if (junkEnableOverride.EqualsLiteral(&quot;true&quot;))</span>
<a href="#l10.3161"></a><span id="l10.3161">     filterForJunk = true;</span>
<a href="#l10.3162"></a><span id="l10.3162">   else if (junkEnableOverride.EqualsLiteral(&quot;false&quot;))</span>
<a href="#l10.3163"></a><span id="l10.3163">     filterForJunk = false;</span>
<a href="#l10.3164"></a><span id="l10.3164"> </span>
<a href="#l10.3165"></a><span id="l10.3165">   bool userHasClassified = false;</span>
<a href="#l10.3166"></a><span id="l10.3166">   // if the user has not classified any messages yet, then we shouldn't bother</span>
<a href="#l10.3167"></a><span id="l10.3167">   // running the junk mail controls. This creates a better first use experience.</span>
<a href="#l10.3168"></a><span id="l10.3168">   // See Bug #250084.</span>
<a href="#l10.3169"></a><span id="l10.3169">   junkMailPlugin-&gt;GetUserHasClassified(&amp;userHasClassified);</span>
<a href="#l10.3170"></a><span id="l10.3170" class="difflineminus">-  if (!userHasClassified)</span>
<a href="#l10.3171"></a><span id="l10.3171" class="difflineminus">-    filterForJunk = false;</span>
<a href="#l10.3172"></a><span id="l10.3172" class="difflineminus">-</span>
<a href="#l10.3173"></a><span id="l10.3173" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Will run Spam filter: %s&quot;, filterForJunk ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l10.3174"></a><span id="l10.3174" class="difflineplus">+  if (!userHasClassified) filterForJunk = false;</span>
<a href="#l10.3175"></a><span id="l10.3175" class="difflineplus">+</span>
<a href="#l10.3176"></a><span id="l10.3176" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3177"></a><span id="l10.3177" class="difflineplus">+          (&quot;Will run Spam filter: %s&quot;, filterForJunk ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l10.3178"></a><span id="l10.3178"> </span>
<a href="#l10.3179"></a><span id="l10.3179">   nsCOMPtr&lt;nsIMsgDatabase&gt; database(mDatabase);</span>
<a href="#l10.3180"></a><span id="l10.3180">   rv = GetMsgDatabase(getter_AddRefs(database));</span>
<a href="#l10.3181"></a><span id="l10.3181">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3182"></a><span id="l10.3182"> </span>
<a href="#l10.3183"></a><span id="l10.3183">   // check if trait processing needed</span>
<a href="#l10.3184"></a><span id="l10.3184"> </span>
<a href="#l10.3185"></a><span id="l10.3185">   nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(</span>
<a href="#l10.3186"></a><span id="l10.3186">       do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.3187"></a><span id="l10.3187">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3188"></a><span id="l10.3188"> </span>
<a href="#l10.3189"></a><span id="l10.3189">   uint32_t count = 0, *proIndices, *antiIndices;</span>
<a href="#l10.3190"></a><span id="l10.3190">   rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l10.3191"></a><span id="l10.3191">   bool filterForOther = false;</span>
<a href="#l10.3192"></a><span id="l10.3192" class="difflineminus">-  if (NS_SUCCEEDED(rv)) // We just skip this on failure, since it is rarely used</span>
<a href="#l10.3193"></a><span id="l10.3193" class="difflineminus">-  {</span>
<a href="#l10.3194"></a><span id="l10.3194" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l10.3195"></a><span id="l10.3195" class="difflineminus">-    {</span>
<a href="#l10.3196"></a><span id="l10.3196" class="difflineplus">+  // We just skip this on failure, since it is rarely used.</span>
<a href="#l10.3197"></a><span id="l10.3197" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.3198"></a><span id="l10.3198" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l10.3199"></a><span id="l10.3199">       // The trait service determines which traits are globally enabled or</span>
<a href="#l10.3200"></a><span id="l10.3200">       // disabled. If a trait is enabled, it can still be made inactive</span>
<a href="#l10.3201"></a><span id="l10.3201">       // on a particular folder using an inherited property. To do that,</span>
<a href="#l10.3202"></a><span id="l10.3202">       // set &quot;dobayes.&quot; + trait proID as an inherited folder property with</span>
<a href="#l10.3203"></a><span id="l10.3203">       // the string value &quot;false&quot;</span>
<a href="#l10.3204"></a><span id="l10.3204">       //</span>
<a href="#l10.3205"></a><span id="l10.3205">       // If any non-junk traits are active on the folder, then the bayes</span>
<a href="#l10.3206"></a><span id="l10.3206">       // processing will calculate probabilities for all enabled traits.</span>
<a href="#l10.3207"></a><span id="l10.3207"> </span>
<a href="#l10.3208"></a><span id="l10.3208" class="difflineminus">-      if (proIndices[i] != nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l10.3209"></a><span id="l10.3209" class="difflineminus">-      {</span>
<a href="#l10.3210"></a><span id="l10.3210" class="difflineplus">+      if (proIndices[i] != nsIJunkMailPlugin::JUNK_TRAIT) {</span>
<a href="#l10.3211"></a><span id="l10.3211">         filterForOther = true;</span>
<a href="#l10.3212"></a><span id="l10.3212">         nsAutoCString traitId;</span>
<a href="#l10.3213"></a><span id="l10.3213">         nsAutoCString property(&quot;dobayes.&quot;);</span>
<a href="#l10.3214"></a><span id="l10.3214">         traitService-&gt;GetId(proIndices[i], traitId);</span>
<a href="#l10.3215"></a><span id="l10.3215">         property.Append(traitId);</span>
<a href="#l10.3216"></a><span id="l10.3216">         nsAutoCString isEnabledOnFolder;</span>
<a href="#l10.3217"></a><span id="l10.3217">         GetInheritedStringProperty(property.get(), isEnabledOnFolder);</span>
<a href="#l10.3218"></a><span id="l10.3218" class="difflineminus">-        if (isEnabledOnFolder.EqualsLiteral(&quot;false&quot;))</span>
<a href="#l10.3219"></a><span id="l10.3219" class="difflineminus">-          filterForOther = false;</span>
<a href="#l10.3220"></a><span id="l10.3220" class="difflineplus">+        if (isEnabledOnFolder.EqualsLiteral(&quot;false&quot;)) filterForOther = false;</span>
<a href="#l10.3221"></a><span id="l10.3221">         // We might have to allow a &quot;true&quot; override in the future, but</span>
<a href="#l10.3222"></a><span id="l10.3222">         // for now there is no way for that to affect the processing</span>
<a href="#l10.3223"></a><span id="l10.3223">         break;</span>
<a href="#l10.3224"></a><span id="l10.3224">       }</span>
<a href="#l10.3225"></a><span id="l10.3225">     }</span>
<a href="#l10.3226"></a><span id="l10.3226">     free(proIndices);</span>
<a href="#l10.3227"></a><span id="l10.3227">     free(antiIndices);</span>
<a href="#l10.3228"></a><span id="l10.3228">   }</span>
<a href="#l10.3229"></a><span id="l10.3229"> </span>
<a href="#l10.3230"></a><span id="l10.3230" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Will run Trait classification: %s&quot;, filterForOther ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l10.3231"></a><span id="l10.3231" class="difflineplus">+  // clang-format off</span>
<a href="#l10.3232"></a><span id="l10.3232" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3233"></a><span id="l10.3233" class="difflineplus">+          (&quot;Will run Trait classification: %s&quot;, filterForOther ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l10.3234"></a><span id="l10.3234" class="difflineplus">+  // clang-format on</span>
<a href="#l10.3235"></a><span id="l10.3235"> </span>
<a href="#l10.3236"></a><span id="l10.3236">   // Do we need to apply message filters?</span>
<a href="#l10.3237"></a><span id="l10.3237" class="difflineminus">-  bool filterPostPlugin = false; // Do we have a post-analysis filter?</span>
<a href="#l10.3238"></a><span id="l10.3238" class="difflineplus">+  bool filterPostPlugin = false;  // Do we have a post-analysis filter?</span>
<a href="#l10.3239"></a><span id="l10.3239">   nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l10.3240"></a><span id="l10.3240">   GetFilterList(aMsgWindow, getter_AddRefs(filterList));</span>
<a href="#l10.3241"></a><span id="l10.3241" class="difflineminus">-  if (filterList)</span>
<a href="#l10.3242"></a><span id="l10.3242" class="difflineminus">-  {</span>
<a href="#l10.3243"></a><span id="l10.3243" class="difflineplus">+  if (filterList) {</span>
<a href="#l10.3244"></a><span id="l10.3244">     uint32_t filterCount = 0;</span>
<a href="#l10.3245"></a><span id="l10.3245">     filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l10.3246"></a><span id="l10.3246" class="difflineminus">-    for (uint32_t index = 0; index &lt; filterCount &amp;&amp; !filterPostPlugin; ++index)</span>
<a href="#l10.3247"></a><span id="l10.3247" class="difflineminus">-    {</span>
<a href="#l10.3248"></a><span id="l10.3248" class="difflineplus">+    for (uint32_t index = 0; index &lt; filterCount &amp;&amp; !filterPostPlugin;</span>
<a href="#l10.3249"></a><span id="l10.3249" class="difflineplus">+         ++index) {</span>
<a href="#l10.3250"></a><span id="l10.3250">       nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l10.3251"></a><span id="l10.3251">       filterList-&gt;GetFilterAt(index, getter_AddRefs(filter));</span>
<a href="#l10.3252"></a><span id="l10.3252" class="difflineminus">-      if (!filter)</span>
<a href="#l10.3253"></a><span id="l10.3253" class="difflineminus">-        continue;</span>
<a href="#l10.3254"></a><span id="l10.3254" class="difflineplus">+      if (!filter) continue;</span>
<a href="#l10.3255"></a><span id="l10.3255">       nsMsgFilterTypeType filterType;</span>
<a href="#l10.3256"></a><span id="l10.3256">       filter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l10.3257"></a><span id="l10.3257" class="difflineminus">-      if (!(filterType &amp; nsMsgFilterType::PostPlugin))</span>
<a href="#l10.3258"></a><span id="l10.3258" class="difflineminus">-        continue;</span>
<a href="#l10.3259"></a><span id="l10.3259" class="difflineplus">+      if (!(filterType &amp; nsMsgFilterType::PostPlugin)) continue;</span>
<a href="#l10.3260"></a><span id="l10.3260">       bool enabled = false;</span>
<a href="#l10.3261"></a><span id="l10.3261">       filter-&gt;GetEnabled(&amp;enabled);</span>
<a href="#l10.3262"></a><span id="l10.3262" class="difflineminus">-      if (!enabled)</span>
<a href="#l10.3263"></a><span id="l10.3263" class="difflineminus">-        continue;</span>
<a href="#l10.3264"></a><span id="l10.3264" class="difflineplus">+      if (!enabled) continue;</span>
<a href="#l10.3265"></a><span id="l10.3265">       filterPostPlugin = true;</span>
<a href="#l10.3266"></a><span id="l10.3266">     }</span>
<a href="#l10.3267"></a><span id="l10.3267">   }</span>
<a href="#l10.3268"></a><span id="l10.3268"> </span>
<a href="#l10.3269"></a><span id="l10.3269" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Will run Post-classification filters: %s&quot;,</span>
<a href="#l10.3270"></a><span id="l10.3270" class="difflineminus">-                                            filterPostPlugin ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l10.3271"></a><span id="l10.3271" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3272"></a><span id="l10.3272" class="difflineplus">+          (&quot;Will run Post-classification filters: %s&quot;,</span>
<a href="#l10.3273"></a><span id="l10.3273" class="difflineplus">+           filterPostPlugin ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l10.3274"></a><span id="l10.3274"> </span>
<a href="#l10.3275"></a><span id="l10.3275">   // If there is nothing to do, leave now but let NotifyHdrsNotBeingClassified</span>
<a href="#l10.3276"></a><span id="l10.3276">   // generate the msgsClassified notification for all newly added messages as</span>
<a href="#l10.3277"></a><span id="l10.3277">   // tracked by the NotReportedClassified processing flag.</span>
<a href="#l10.3278"></a><span id="l10.3278" class="difflineminus">-  if (!filterForOther &amp;&amp; !filterForJunk &amp;&amp; !filterPostPlugin)</span>
<a href="#l10.3279"></a><span id="l10.3279" class="difflineminus">-  {</span>
<a href="#l10.3280"></a><span id="l10.3280" class="difflineplus">+  if (!filterForOther &amp;&amp; !filterForJunk &amp;&amp; !filterPostPlugin) {</span>
<a href="#l10.3281"></a><span id="l10.3281">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;No filters need to be run&quot;));</span>
<a href="#l10.3282"></a><span id="l10.3282">     NotifyHdrsNotBeingClassified();</span>
<a href="#l10.3283"></a><span id="l10.3283">     return NS_OK;</span>
<a href="#l10.3284"></a><span id="l10.3284">   }</span>
<a href="#l10.3285"></a><span id="l10.3285"> </span>
<a href="#l10.3286"></a><span id="l10.3286">   // get the list of new messages</span>
<a href="#l10.3287"></a><span id="l10.3287">   //</span>
<a href="#l10.3288"></a><span id="l10.3288">   uint32_t numNewKeys;</span>
<a href="#l10.3289"></a><span id="l10.3289">   nsMsgKey *newKeys;</span>
<a href="#l10.3290"></a><span id="l10.3290">   rv = database-&gt;GetNewList(&amp;numNewKeys, &amp;newKeys);</span>
<a href="#l10.3291"></a><span id="l10.3291">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3292"></a><span id="l10.3292"> </span>
<a href="#l10.3293"></a><span id="l10.3293" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running filters on %&quot; PRIu32 &quot; new messages&quot;, numNewKeys));</span>
<a href="#l10.3294"></a><span id="l10.3294" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3295"></a><span id="l10.3295" class="difflineplus">+          (&quot;Running filters on %&quot; PRIu32 &quot; new messages&quot;, numNewKeys));</span>
<a href="#l10.3296"></a><span id="l10.3296"> </span>
<a href="#l10.3297"></a><span id="l10.3297">   nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l10.3298"></a><span id="l10.3298">   // Start from m_saveNewMsgs (and clear its current state).  m_saveNewMsgs is</span>
<a href="#l10.3299"></a><span id="l10.3299">   // where we stash the list of new messages when we are told to clear the list</span>
<a href="#l10.3300"></a><span id="l10.3300">   // of new messages by the UI (which purges the list from the nsMsgDatabase).</span>
<a href="#l10.3301"></a><span id="l10.3301">   newMessageKeys.SwapElements(m_saveNewMsgs);</span>
<a href="#l10.3302"></a><span id="l10.3302" class="difflineminus">-  if (numNewKeys)</span>
<a href="#l10.3303"></a><span id="l10.3303" class="difflineminus">-    newMessageKeys.AppendElements(newKeys, numNewKeys);</span>
<a href="#l10.3304"></a><span id="l10.3304" class="difflineplus">+  if (numNewKeys) newMessageKeys.AppendElements(newKeys, numNewKeys);</span>
<a href="#l10.3305"></a><span id="l10.3305"> </span>
<a href="#l10.3306"></a><span id="l10.3306">   free(newKeys);</span>
<a href="#l10.3307"></a><span id="l10.3307"> </span>
<a href="#l10.3308"></a><span id="l10.3308">   // build up list of keys to classify</span>
<a href="#l10.3309"></a><span id="l10.3309">   nsTArray&lt;nsMsgKey&gt; classifyMsgKeys;</span>
<a href="#l10.3310"></a><span id="l10.3310">   nsCString uri;</span>
<a href="#l10.3311"></a><span id="l10.3311"> </span>
<a href="#l10.3312"></a><span id="l10.3312">   uint32_t numNewMessages = newMessageKeys.Length();</span>
<a href="#l10.3313"></a><span id="l10.3313" class="difflineminus">-  for (uint32_t i = 0 ; i &lt; numNewMessages ; ++i)</span>
<a href="#l10.3314"></a><span id="l10.3314" class="difflineminus">-  {</span>
<a href="#l10.3315"></a><span id="l10.3315" class="difflineplus">+  for (uint32_t i = 0; i &lt; numNewMessages; ++i) {</span>
<a href="#l10.3316"></a><span id="l10.3316">     nsMsgKey msgKey = newMessageKeys[i];</span>
<a href="#l10.3317"></a><span id="l10.3317" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running filters on message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l10.3318"></a><span id="l10.3318" class="difflineplus">+    // clang-format off</span>
<a href="#l10.3319"></a><span id="l10.3319" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3320"></a><span id="l10.3320" class="difflineplus">+            (&quot;Running filters on message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l10.3321"></a><span id="l10.3321" class="difflineplus">+    // clang-format on</span>
<a href="#l10.3322"></a><span id="l10.3322">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.3323"></a><span id="l10.3323">     rv = database-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l10.3324"></a><span id="l10.3324" class="difflineminus">-    if (!NS_SUCCEEDED(rv))</span>
<a href="#l10.3325"></a><span id="l10.3325" class="difflineminus">-      continue;</span>
<a href="#l10.3326"></a><span id="l10.3326" class="difflineplus">+    if (!NS_SUCCEEDED(rv)) continue;</span>
<a href="#l10.3327"></a><span id="l10.3327">     // per-message junk tests.</span>
<a href="#l10.3328"></a><span id="l10.3328">     bool filterMessageForJunk = false;</span>
<a href="#l10.3329"></a><span id="l10.3329">     while (filterForJunk)  // we'll break from this at the end</span>
<a href="#l10.3330"></a><span id="l10.3330">     {</span>
<a href="#l10.3331"></a><span id="l10.3331">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Spam filter&quot;));</span>
<a href="#l10.3332"></a><span id="l10.3332">       nsCString junkScore;</span>
<a href="#l10.3333"></a><span id="l10.3333">       msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScore));</span>
<a href="#l10.3334"></a><span id="l10.3334">       if (!junkScore.IsEmpty()) {</span>
<a href="#l10.3335"></a><span id="l10.3335">         // ignore already scored messages.</span>
<a href="#l10.3336"></a><span id="l10.3336" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Message already scored previously, skipping&quot;));</span>
<a href="#l10.3337"></a><span id="l10.3337" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3338"></a><span id="l10.3338" class="difflineplus">+                (&quot;Message already scored previously, skipping&quot;));</span>
<a href="#l10.3339"></a><span id="l10.3339">         break;</span>
<a href="#l10.3340"></a><span id="l10.3340">       }</span>
<a href="#l10.3341"></a><span id="l10.3341"> </span>
<a href="#l10.3342"></a><span id="l10.3342">       bool whiteListMessage = false;</span>
<a href="#l10.3343"></a><span id="l10.3343">       spamSettings-&gt;CheckWhiteList(msgHdr, &amp;whiteListMessage);</span>
<a href="#l10.3344"></a><span id="l10.3344" class="difflineminus">-      if (whiteListMessage)</span>
<a href="#l10.3345"></a><span id="l10.3345" class="difflineminus">-      {</span>
<a href="#l10.3346"></a><span id="l10.3346" class="difflineplus">+      if (whiteListMessage) {</span>
<a href="#l10.3347"></a><span id="l10.3347">         // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l10.3348"></a><span id="l10.3348">         nsAutoCString msgJunkScore;</span>
<a href="#l10.3349"></a><span id="l10.3349">         msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l10.3350"></a><span id="l10.3350">         database-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l10.3351"></a><span id="l10.3351">         database-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l10.3352"></a><span id="l10.3352" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Message whitelisted, skipping&quot;));</span>
<a href="#l10.3353"></a><span id="l10.3353" class="difflineminus">-        break; // skip this msg since it's in the white list</span>
<a href="#l10.3354"></a><span id="l10.3354" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3355"></a><span id="l10.3355" class="difflineplus">+                (&quot;Message whitelisted, skipping&quot;));</span>
<a href="#l10.3356"></a><span id="l10.3356" class="difflineplus">+        break;  // skip this msg since it's in the white list</span>
<a href="#l10.3357"></a><span id="l10.3357">       }</span>
<a href="#l10.3358"></a><span id="l10.3358">       filterMessageForJunk = true;</span>
<a href="#l10.3359"></a><span id="l10.3359"> </span>
<a href="#l10.3360"></a><span id="l10.3360">       MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Message is to be classified&quot;));</span>
<a href="#l10.3361"></a><span id="l10.3361">       OrProcessingFlags(msgKey, nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l10.3362"></a><span id="l10.3362">       // Since we are junk processing, we want to defer the msgsClassified</span>
<a href="#l10.3363"></a><span id="l10.3363">       // notification until the junk classification has occurred.  The event</span>
<a href="#l10.3364"></a><span id="l10.3364">       // is sufficiently reliable that we know this will be handled in</span>
<a href="#l10.3365"></a><span id="l10.3365" class="difflineat">@@ -2741,183 +2533,170 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l10.3366"></a><span id="l10.3366">       break;</span>
<a href="#l10.3367"></a><span id="l10.3367">     }</span>
<a href="#l10.3368"></a><span id="l10.3368"> </span>
<a href="#l10.3369"></a><span id="l10.3369">     uint32_t processingFlags;</span>
<a href="#l10.3370"></a><span id="l10.3370">     GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l10.3371"></a><span id="l10.3371"> </span>
<a href="#l10.3372"></a><span id="l10.3372">     bool filterMessageForOther = false;</span>
<a href="#l10.3373"></a><span id="l10.3373">     // trait processing</span>
<a href="#l10.3374"></a><span id="l10.3374" class="difflineminus">-    if (!(processingFlags &amp; nsMsgProcessingFlags::TraitsDone))</span>
<a href="#l10.3375"></a><span id="l10.3375" class="difflineminus">-    {</span>
<a href="#l10.3376"></a><span id="l10.3376" class="difflineplus">+    if (!(processingFlags &amp; nsMsgProcessingFlags::TraitsDone)) {</span>
<a href="#l10.3377"></a><span id="l10.3377">       // don't do trait processing on this message again</span>
<a href="#l10.3378"></a><span id="l10.3378">       OrProcessingFlags(msgKey, nsMsgProcessingFlags::TraitsDone);</span>
<a href="#l10.3379"></a><span id="l10.3379" class="difflineminus">-      if (filterForOther)</span>
<a href="#l10.3380"></a><span id="l10.3380" class="difflineminus">-      {</span>
<a href="#l10.3381"></a><span id="l10.3381" class="difflineplus">+      if (filterForOther) {</span>
<a href="#l10.3382"></a><span id="l10.3382">         filterMessageForOther = true;</span>
<a href="#l10.3383"></a><span id="l10.3383">         OrProcessingFlags(msgKey, nsMsgProcessingFlags::ClassifyTraits);</span>
<a href="#l10.3384"></a><span id="l10.3384">       }</span>
<a href="#l10.3385"></a><span id="l10.3385">     }</span>
<a href="#l10.3386"></a><span id="l10.3386"> </span>
<a href="#l10.3387"></a><span id="l10.3387">     if (filterMessageForJunk || filterMessageForOther)</span>
<a href="#l10.3388"></a><span id="l10.3388">       classifyMsgKeys.AppendElement(newMessageKeys[i]);</span>
<a href="#l10.3389"></a><span id="l10.3389"> </span>
<a href="#l10.3390"></a><span id="l10.3390">     // Set messages to filter post-bayes.</span>
<a href="#l10.3391"></a><span id="l10.3391">     // Have we already filtered this message?</span>
<a href="#l10.3392"></a><span id="l10.3392" class="difflineminus">-    if (!(processingFlags &amp; nsMsgProcessingFlags::FiltersDone))</span>
<a href="#l10.3393"></a><span id="l10.3393" class="difflineminus">-    {</span>
<a href="#l10.3394"></a><span id="l10.3394" class="difflineminus">-      if (filterPostPlugin)</span>
<a href="#l10.3395"></a><span id="l10.3395" class="difflineminus">-      {</span>
<a href="#l10.3396"></a><span id="l10.3396" class="difflineplus">+    if (!(processingFlags &amp; nsMsgProcessingFlags::FiltersDone)) {</span>
<a href="#l10.3397"></a><span id="l10.3397" class="difflineplus">+      if (filterPostPlugin) {</span>
<a href="#l10.3398"></a><span id="l10.3398">         // Don't do filters on this message again.</span>
<a href="#l10.3399"></a><span id="l10.3399">         // (Only set this if we are actually filtering since this is</span>
<a href="#l10.3400"></a><span id="l10.3400">         // tantamount to a memory leak.)</span>
<a href="#l10.3401"></a><span id="l10.3401" class="difflineminus">-        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Filters done on this message&quot;));</span>
<a href="#l10.3402"></a><span id="l10.3402" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3403"></a><span id="l10.3403" class="difflineplus">+                (&quot;Filters done on this message&quot;));</span>
<a href="#l10.3404"></a><span id="l10.3404">         OrProcessingFlags(msgKey, nsMsgProcessingFlags::FiltersDone);</span>
<a href="#l10.3405"></a><span id="l10.3405">         // Lazily create the array.</span>
<a href="#l10.3406"></a><span id="l10.3406">         if (!mPostBayesMessagesToFilter)</span>
<a href="#l10.3407"></a><span id="l10.3407">           mPostBayesMessagesToFilter = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l10.3408"></a><span id="l10.3408">         mPostBayesMessagesToFilter-&gt;AppendElement(msgHdr);</span>
<a href="#l10.3409"></a><span id="l10.3409">       }</span>
<a href="#l10.3410"></a><span id="l10.3410">     }</span>
<a href="#l10.3411"></a><span id="l10.3411">   }</span>
<a href="#l10.3412"></a><span id="l10.3412"> </span>
<a href="#l10.3413"></a><span id="l10.3413">   NotifyHdrsNotBeingClassified();</span>
<a href="#l10.3414"></a><span id="l10.3414">   // If there weren't any new messages, just return.</span>
<a href="#l10.3415"></a><span id="l10.3415" class="difflineminus">-  if (newMessageKeys.IsEmpty())</span>
<a href="#l10.3416"></a><span id="l10.3416" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.3417"></a><span id="l10.3417" class="difflineplus">+  if (newMessageKeys.IsEmpty()) return NS_OK;</span>
<a href="#l10.3418"></a><span id="l10.3418"> </span>
<a href="#l10.3419"></a><span id="l10.3419">   // If we do not need to do any work, leave.</span>
<a href="#l10.3420"></a><span id="l10.3420">   // (We needed to get the list of new messages so we could get their headers so</span>
<a href="#l10.3421"></a><span id="l10.3421">   // we can send notifications about them here.)</span>
<a href="#l10.3422"></a><span id="l10.3422"> </span>
<a href="#l10.3423"></a><span id="l10.3423" class="difflineminus">-  if (!classifyMsgKeys.IsEmpty())</span>
<a href="#l10.3424"></a><span id="l10.3424" class="difflineminus">-  {</span>
<a href="#l10.3425"></a><span id="l10.3425" class="difflineplus">+  if (!classifyMsgKeys.IsEmpty()) {</span>
<a href="#l10.3426"></a><span id="l10.3426">     // Remember what classifications are the source of this decision for when</span>
<a href="#l10.3427"></a><span id="l10.3427">     // we perform the notification in OnMessageClassified at the conclusion of</span>
<a href="#l10.3428"></a><span id="l10.3428">     // classification.</span>
<a href="#l10.3429"></a><span id="l10.3429">     mBayesJunkClassifying = filterForJunk;</span>
<a href="#l10.3430"></a><span id="l10.3430">     mBayesTraitClassifying = filterForOther;</span>
<a href="#l10.3431"></a><span id="l10.3431"> </span>
<a href="#l10.3432"></a><span id="l10.3432">     uint32_t numMessagesToClassify = classifyMsgKeys.Length();</span>
<a href="#l10.3433"></a><span id="l10.3433" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;%&quot; PRIu32 &quot; messages to be classified&quot;, numMessagesToClassify));</span>
<a href="#l10.3434"></a><span id="l10.3434" class="difflineminus">-    char ** messageURIs = (char **) PR_MALLOC(sizeof(const char *) * numMessagesToClassify);</span>
<a href="#l10.3435"></a><span id="l10.3435" class="difflineminus">-    if (!messageURIs)</span>
<a href="#l10.3436"></a><span id="l10.3436" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.3437"></a><span id="l10.3437" class="difflineminus">-</span>
<a href="#l10.3438"></a><span id="l10.3438" class="difflineminus">-    for (uint32_t msgIndex = 0; msgIndex &lt; numMessagesToClassify ; ++msgIndex )</span>
<a href="#l10.3439"></a><span id="l10.3439" class="difflineminus">-    {</span>
<a href="#l10.3440"></a><span id="l10.3440" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.3441"></a><span id="l10.3441" class="difflineplus">+            (&quot;%&quot; PRIu32 &quot; messages to be classified&quot;, numMessagesToClassify));</span>
<a href="#l10.3442"></a><span id="l10.3442" class="difflineplus">+    char **messageURIs =</span>
<a href="#l10.3443"></a><span id="l10.3443" class="difflineplus">+        (char **)PR_MALLOC(sizeof(const char *) * numMessagesToClassify);</span>
<a href="#l10.3444"></a><span id="l10.3444" class="difflineplus">+    if (!messageURIs) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.3445"></a><span id="l10.3445" class="difflineplus">+</span>
<a href="#l10.3446"></a><span id="l10.3446" class="difflineplus">+    for (uint32_t msgIndex = 0; msgIndex &lt; numMessagesToClassify; ++msgIndex) {</span>
<a href="#l10.3447"></a><span id="l10.3447">       nsCString tmpStr;</span>
<a href="#l10.3448"></a><span id="l10.3448">       rv = GenerateMessageURI(classifyMsgKeys[msgIndex], tmpStr);</span>
<a href="#l10.3449"></a><span id="l10.3449">       messageURIs[msgIndex] = ToNewCString(tmpStr);</span>
<a href="#l10.3450"></a><span id="l10.3450">       if (NS_FAILED(rv))</span>
<a href="#l10.3451"></a><span id="l10.3451" class="difflineminus">-          NS_WARNING(&quot;nsMsgDBFolder::CallFilterPlugins(): could not&quot;</span>
<a href="#l10.3452"></a><span id="l10.3452" class="difflineminus">-                     &quot; generate URI for message&quot;);</span>
<a href="#l10.3453"></a><span id="l10.3453" class="difflineplus">+        NS_WARNING(</span>
<a href="#l10.3454"></a><span id="l10.3454" class="difflineplus">+            &quot;nsMsgDBFolder::CallFilterPlugins(): could not&quot;</span>
<a href="#l10.3455"></a><span id="l10.3455" class="difflineplus">+            &quot; generate URI for message&quot;);</span>
<a href="#l10.3456"></a><span id="l10.3456">     }</span>
<a href="#l10.3457"></a><span id="l10.3457">     // filterMsgs</span>
<a href="#l10.3458"></a><span id="l10.3458">     *aFiltersRun = true;</span>
<a href="#l10.3459"></a><span id="l10.3459" class="difflineminus">-    rv = SpamFilterClassifyMessages((const char **) messageURIs, numMessagesToClassify, aMsgWindow, junkMailPlugin);</span>
<a href="#l10.3460"></a><span id="l10.3460" class="difflineminus">-    for ( uint32_t freeIndex=0 ; freeIndex &lt; numMessagesToClassify ; ++freeIndex )</span>
<a href="#l10.3461"></a><span id="l10.3461" class="difflineplus">+    rv = SpamFilterClassifyMessages((const char **)messageURIs,</span>
<a href="#l10.3462"></a><span id="l10.3462" class="difflineplus">+                                    numMessagesToClassify, aMsgWindow,</span>
<a href="#l10.3463"></a><span id="l10.3463" class="difflineplus">+                                    junkMailPlugin);</span>
<a href="#l10.3464"></a><span id="l10.3464" class="difflineplus">+    for (uint32_t freeIndex = 0; freeIndex &lt; numMessagesToClassify; ++freeIndex)</span>
<a href="#l10.3465"></a><span id="l10.3465">       PR_Free(messageURIs[freeIndex]);</span>
<a href="#l10.3466"></a><span id="l10.3466">     PR_Free(messageURIs);</span>
<a href="#l10.3467"></a><span id="l10.3467" class="difflineminus">-  }</span>
<a href="#l10.3468"></a><span id="l10.3468" class="difflineminus">-  else if (filterPostPlugin)</span>
<a href="#l10.3469"></a><span id="l10.3469" class="difflineminus">-  {</span>
<a href="#l10.3470"></a><span id="l10.3470" class="difflineplus">+  } else if (filterPostPlugin) {</span>
<a href="#l10.3471"></a><span id="l10.3471">     // Nothing to classify, so need to end batch ourselves. We do this so that</span>
<a href="#l10.3472"></a><span id="l10.3472">     // post analysis filters will run consistently on a folder, even if</span>
<a href="#l10.3473"></a><span id="l10.3473">     // disabled junk processing, which could be dynamic through whitelisting,</span>
<a href="#l10.3474"></a><span id="l10.3474">     // makes the bayes analysis unnecessary.</span>
<a href="#l10.3475"></a><span id="l10.3475">     OnMessageClassified(nullptr, nsIJunkMailPlugin::UNCLASSIFIED, 0);</span>
<a href="#l10.3476"></a><span id="l10.3476">   }</span>
<a href="#l10.3477"></a><span id="l10.3477"> </span>
<a href="#l10.3478"></a><span id="l10.3478">   return rv;</span>
<a href="#l10.3479"></a><span id="l10.3479"> }</span>
<a href="#l10.3480"></a><span id="l10.3480"> </span>
<a href="#l10.3481"></a><span id="l10.3481"> /**</span>
<a href="#l10.3482"></a><span id="l10.3482">  * Adds the messages in the NotReportedClassified mProcessing set to the</span>
<a href="#l10.3483"></a><span id="l10.3483">  * (possibly empty) array of msgHdrsNotBeingClassified, and send the</span>
<a href="#l10.3484"></a><span id="l10.3484">  * nsIMsgFolderNotificationService notification.</span>
<a href="#l10.3485"></a><span id="l10.3485">  */</span>
<a href="#l10.3486"></a><span id="l10.3486" class="difflineminus">-nsresult nsMsgDBFolder::NotifyHdrsNotBeingClassified()</span>
<a href="#l10.3487"></a><span id="l10.3487" class="difflineminus">-{</span>
<a href="#l10.3488"></a><span id="l10.3488" class="difflineplus">+nsresult nsMsgDBFolder::NotifyHdrsNotBeingClassified() {</span>
<a href="#l10.3489"></a><span id="l10.3489">   nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsNotBeingClassified;</span>
<a href="#l10.3490"></a><span id="l10.3490"> </span>
<a href="#l10.3491"></a><span id="l10.3491" class="difflineminus">-  if (mProcessingFlag[5].keys)</span>
<a href="#l10.3492"></a><span id="l10.3492" class="difflineminus">-  {</span>
<a href="#l10.3493"></a><span id="l10.3493" class="difflineplus">+  if (mProcessingFlag[5].keys) {</span>
<a href="#l10.3494"></a><span id="l10.3494">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l10.3495"></a><span id="l10.3495">     mProcessingFlag[5].keys-&gt;ToMsgKeyArray(keys);</span>
<a href="#l10.3496"></a><span id="l10.3496" class="difflineminus">-    if (keys.Length())</span>
<a href="#l10.3497"></a><span id="l10.3497" class="difflineminus">-    {</span>
<a href="#l10.3498"></a><span id="l10.3498" class="difflineplus">+    if (keys.Length()) {</span>
<a href="#l10.3499"></a><span id="l10.3499">       msgHdrsNotBeingClassified = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l10.3500"></a><span id="l10.3500" class="difflineminus">-      if (!msgHdrsNotBeingClassified)</span>
<a href="#l10.3501"></a><span id="l10.3501" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.3502"></a><span id="l10.3502" class="difflineplus">+      if (!msgHdrsNotBeingClassified) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.3503"></a><span id="l10.3503">       nsresult rv = GetDatabase();</span>
<a href="#l10.3504"></a><span id="l10.3504">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3505"></a><span id="l10.3505">       MsgGetHeadersFromKeys(mDatabase, keys, msgHdrsNotBeingClassified);</span>
<a href="#l10.3506"></a><span id="l10.3506"> </span>
<a href="#l10.3507"></a><span id="l10.3507">       // Since we know we've handled all the NotReportedClassified messages,</span>
<a href="#l10.3508"></a><span id="l10.3508">       // we clear the set by deleting and recreating it.</span>
<a href="#l10.3509"></a><span id="l10.3509">       delete mProcessingFlag[5].keys;</span>
<a href="#l10.3510"></a><span id="l10.3510">       mProcessingFlag[5].keys = nsMsgKeySetU::Create();</span>
<a href="#l10.3511"></a><span id="l10.3511" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l10.3512"></a><span id="l10.3512" class="difflineminus">-        notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l10.3513"></a><span id="l10.3513" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l10.3514"></a><span id="l10.3514" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l10.3515"></a><span id="l10.3515">       if (notifier)</span>
<a href="#l10.3516"></a><span id="l10.3516">         notifier-&gt;NotifyMsgsClassified(msgHdrsNotBeingClassified,</span>
<a href="#l10.3517"></a><span id="l10.3517">                                        // no classification is being performed</span>
<a href="#l10.3518"></a><span id="l10.3518">                                        false, false);</span>
<a href="#l10.3519"></a><span id="l10.3519">     }</span>
<a href="#l10.3520"></a><span id="l10.3520">   }</span>
<a href="#l10.3521"></a><span id="l10.3521">   return NS_OK;</span>
<a href="#l10.3522"></a><span id="l10.3522"> }</span>
<a href="#l10.3523"></a><span id="l10.3523"> </span>
<a href="#l10.3524"></a><span id="l10.3524"> NS_IMETHODIMP</span>
<a href="#l10.3525"></a><span id="l10.3525" class="difflineminus">-nsMsgDBFolder::GetLastMessageLoaded(nsMsgKey *aMsgKey)</span>
<a href="#l10.3526"></a><span id="l10.3526" class="difflineminus">-{</span>
<a href="#l10.3527"></a><span id="l10.3527" class="difflineplus">+nsMsgDBFolder::GetLastMessageLoaded(nsMsgKey *aMsgKey) {</span>
<a href="#l10.3528"></a><span id="l10.3528">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l10.3529"></a><span id="l10.3529">   *aMsgKey = mLastMessageLoaded;</span>
<a href="#l10.3530"></a><span id="l10.3530">   return NS_OK;</span>
<a href="#l10.3531"></a><span id="l10.3531"> }</span>
<a href="#l10.3532"></a><span id="l10.3532"> </span>
<a href="#l10.3533"></a><span id="l10.3533"> NS_IMETHODIMP</span>
<a href="#l10.3534"></a><span id="l10.3534" class="difflineminus">-nsMsgDBFolder::SetLastMessageLoaded(nsMsgKey aMsgKey)</span>
<a href="#l10.3535"></a><span id="l10.3535" class="difflineminus">-{</span>
<a href="#l10.3536"></a><span id="l10.3536" class="difflineplus">+nsMsgDBFolder::SetLastMessageLoaded(nsMsgKey aMsgKey) {</span>
<a href="#l10.3537"></a><span id="l10.3537">   mLastMessageLoaded = aMsgKey;</span>
<a href="#l10.3538"></a><span id="l10.3538">   return NS_OK;</span>
<a href="#l10.3539"></a><span id="l10.3539"> }</span>
<a href="#l10.3540"></a><span id="l10.3540"> </span>
<a href="#l10.3541"></a><span id="l10.3541"> // Returns true if: a) there is no need to prompt or b) the user is already</span>
<a href="#l10.3542"></a><span id="l10.3542"> // logged in or c) the user logged in successfully.</span>
<a href="#l10.3543"></a><span id="l10.3543" class="difflineminus">-bool nsMsgDBFolder::PromptForMasterPasswordIfNecessary()</span>
<a href="#l10.3544"></a><span id="l10.3544" class="difflineminus">-{</span>
<a href="#l10.3545"></a><span id="l10.3545" class="difflineplus">+bool nsMsgDBFolder::PromptForMasterPasswordIfNecessary() {</span>
<a href="#l10.3546"></a><span id="l10.3546">   nsresult rv;</span>
<a href="#l10.3547"></a><span id="l10.3547">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l10.3548"></a><span id="l10.3548" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.3549"></a><span id="l10.3549" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.3550"></a><span id="l10.3550">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l10.3551"></a><span id="l10.3551"> </span>
<a href="#l10.3552"></a><span id="l10.3552">   bool userNeedsToAuthenticate = false;</span>
<a href="#l10.3553"></a><span id="l10.3553">   // if we're PasswordProtectLocalCache, then we need to find out if the server</span>
<a href="#l10.3554"></a><span id="l10.3554">   // is authenticated.</span>
<a href="#l10.3555"></a><span id="l10.3555" class="difflineminus">-  (void) accountManager-&gt;GetUserNeedsToAuthenticate(&amp;userNeedsToAuthenticate);</span>
<a href="#l10.3556"></a><span id="l10.3556" class="difflineminus">-  if (!userNeedsToAuthenticate)</span>
<a href="#l10.3557"></a><span id="l10.3557" class="difflineminus">-    return true;</span>
<a href="#l10.3558"></a><span id="l10.3558" class="difflineplus">+  (void)accountManager-&gt;GetUserNeedsToAuthenticate(&amp;userNeedsToAuthenticate);</span>
<a href="#l10.3559"></a><span id="l10.3559" class="difflineplus">+  if (!userNeedsToAuthenticate) return true;</span>
<a href="#l10.3560"></a><span id="l10.3560"> </span>
<a href="#l10.3561"></a><span id="l10.3561">   // Do we have a master password?</span>
<a href="#l10.3562"></a><span id="l10.3562">   nsCOMPtr&lt;nsIPK11TokenDB&gt; tokenDB =</span>
<a href="#l10.3563"></a><span id="l10.3563" class="difflineminus">-    do_GetService(NS_PK11TOKENDB_CONTRACTID, &amp;rv);</span>
<a href="#l10.3564"></a><span id="l10.3564" class="difflineplus">+      do_GetService(NS_PK11TOKENDB_CONTRACTID, &amp;rv);</span>
<a href="#l10.3565"></a><span id="l10.3565">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l10.3566"></a><span id="l10.3566"> </span>
<a href="#l10.3567"></a><span id="l10.3567">   nsCOMPtr&lt;nsIPK11Token&gt; token;</span>
<a href="#l10.3568"></a><span id="l10.3568">   rv = tokenDB-&gt;GetInternalKeyToken(getter_AddRefs(token));</span>
<a href="#l10.3569"></a><span id="l10.3569">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l10.3570"></a><span id="l10.3570"> </span>
<a href="#l10.3571"></a><span id="l10.3571">   bool result;</span>
<a href="#l10.3572"></a><span id="l10.3572">   rv = token-&gt;CheckPassword(EmptyCString(), &amp;result);</span>
<a href="#l10.3573"></a><span id="l10.3573">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l10.3574"></a><span id="l10.3574"> </span>
<a href="#l10.3575"></a><span id="l10.3575" class="difflineminus">-  if (result)</span>
<a href="#l10.3576"></a><span id="l10.3576" class="difflineminus">-  {</span>
<a href="#l10.3577"></a><span id="l10.3577" class="difflineplus">+  if (result) {</span>
<a href="#l10.3578"></a><span id="l10.3578">     // We don't have a master password, so this function isn't supported,</span>
<a href="#l10.3579"></a><span id="l10.3579">     // therefore just tell account manager we've authenticated and return true.</span>
<a href="#l10.3580"></a><span id="l10.3580">     accountManager-&gt;SetUserNeedsToAuthenticate(false);</span>
<a href="#l10.3581"></a><span id="l10.3581">     return true;</span>
<a href="#l10.3582"></a><span id="l10.3582">   }</span>
<a href="#l10.3583"></a><span id="l10.3583"> </span>
<a href="#l10.3584"></a><span id="l10.3584">   // We have a master password, so try and login to the slot.</span>
<a href="#l10.3585"></a><span id="l10.3585">   rv = token-&gt;Login(false);</span>
<a href="#l10.3586"></a><span id="l10.3586" class="difflineat">@@ -2929,442 +2708,395 @@ bool nsMsgDBFolder::PromptForMasterPassw</span>
<a href="#l10.3587"></a><span id="l10.3587">   rv = token-&gt;IsLoggedIn(&amp;result);</span>
<a href="#l10.3588"></a><span id="l10.3588">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l10.3589"></a><span id="l10.3589"> </span>
<a href="#l10.3590"></a><span id="l10.3590">   accountManager-&gt;SetUserNeedsToAuthenticate(!result);</span>
<a href="#l10.3591"></a><span id="l10.3591">   return result;</span>
<a href="#l10.3592"></a><span id="l10.3592"> }</span>
<a href="#l10.3593"></a><span id="l10.3593"> </span>
<a href="#l10.3594"></a><span id="l10.3594"> // this gets called after the last junk mail classification has run.</span>
<a href="#l10.3595"></a><span id="l10.3595" class="difflineminus">-nsresult nsMsgDBFolder::PerformBiffNotifications(void)</span>
<a href="#l10.3596"></a><span id="l10.3596" class="difflineminus">-{</span>
<a href="#l10.3597"></a><span id="l10.3597" class="difflineplus">+nsresult nsMsgDBFolder::PerformBiffNotifications(void) {</span>
<a href="#l10.3598"></a><span id="l10.3598">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.3599"></a><span id="l10.3599">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.3600"></a><span id="l10.3600">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3601"></a><span id="l10.3601" class="difflineminus">-  int32_t  numBiffMsgs = 0;</span>
<a href="#l10.3602"></a><span id="l10.3602" class="difflineplus">+  int32_t numBiffMsgs = 0;</span>
<a href="#l10.3603"></a><span id="l10.3603">   nsCOMPtr&lt;nsIMsgFolder&gt; root;</span>
<a href="#l10.3604"></a><span id="l10.3604">   rv = GetRootFolder(getter_AddRefs(root));</span>
<a href="#l10.3605"></a><span id="l10.3605">   root-&gt;GetNumNewMessages(true, &amp;numBiffMsgs);</span>
<a href="#l10.3606"></a><span id="l10.3606" class="difflineminus">-  if (numBiffMsgs &gt; 0)</span>
<a href="#l10.3607"></a><span id="l10.3607" class="difflineminus">-  {</span>
<a href="#l10.3608"></a><span id="l10.3608" class="difflineplus">+  if (numBiffMsgs &gt; 0) {</span>
<a href="#l10.3609"></a><span id="l10.3609">     server-&gt;SetPerformingBiff(true);</span>
<a href="#l10.3610"></a><span id="l10.3610">     SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l10.3611"></a><span id="l10.3611">     server-&gt;SetPerformingBiff(false);</span>
<a href="#l10.3612"></a><span id="l10.3612">   }</span>
<a href="#l10.3613"></a><span id="l10.3613">   return NS_OK;</span>
<a href="#l10.3614"></a><span id="l10.3614"> }</span>
<a href="#l10.3615"></a><span id="l10.3615"> </span>
<a href="#l10.3616"></a><span id="l10.3616" class="difflineminus">-nsresult</span>
<a href="#l10.3617"></a><span id="l10.3617" class="difflineminus">-nsMsgDBFolder::initializeStrings()</span>
<a href="#l10.3618"></a><span id="l10.3618" class="difflineminus">-{</span>
<a href="#l10.3619"></a><span id="l10.3619" class="difflineplus">+nsresult nsMsgDBFolder::initializeStrings() {</span>
<a href="#l10.3620"></a><span id="l10.3620">   nsresult rv;</span>
<a href="#l10.3621"></a><span id="l10.3621">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l10.3622"></a><span id="l10.3622" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l10.3623"></a><span id="l10.3623" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l10.3624"></a><span id="l10.3624">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l10.3625"></a><span id="l10.3625">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.3626"></a><span id="l10.3626" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l10.3627"></a><span id="l10.3627" class="difflineminus">-                                   getter_AddRefs(bundle));</span>
<a href="#l10.3628"></a><span id="l10.3628" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l10.3629"></a><span id="l10.3629" class="difflineplus">+      &quot;chrome://messenger/locale/messenger.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l10.3630"></a><span id="l10.3630">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3631"></a><span id="l10.3631"> </span>
<a href="#l10.3632"></a><span id="l10.3632">   bundle-&gt;GetStringFromName(&quot;inboxFolderName&quot;, kLocalizedInboxName);</span>
<a href="#l10.3633"></a><span id="l10.3633">   bundle-&gt;GetStringFromName(&quot;trashFolderName&quot;, kLocalizedTrashName);</span>
<a href="#l10.3634"></a><span id="l10.3634">   bundle-&gt;GetStringFromName(&quot;sentFolderName&quot;, kLocalizedSentName);</span>
<a href="#l10.3635"></a><span id="l10.3635">   bundle-&gt;GetStringFromName(&quot;draftsFolderName&quot;, kLocalizedDraftsName);</span>
<a href="#l10.3636"></a><span id="l10.3636">   bundle-&gt;GetStringFromName(&quot;templatesFolderName&quot;, kLocalizedTemplatesName);</span>
<a href="#l10.3637"></a><span id="l10.3637">   bundle-&gt;GetStringFromName(&quot;junkFolderName&quot;, kLocalizedJunkName);</span>
<a href="#l10.3638"></a><span id="l10.3638">   bundle-&gt;GetStringFromName(&quot;outboxFolderName&quot;, kLocalizedUnsentName);</span>
<a href="#l10.3639"></a><span id="l10.3639">   bundle-&gt;GetStringFromName(&quot;archivesFolderName&quot;, kLocalizedArchivesName);</span>
<a href="#l10.3640"></a><span id="l10.3640"> </span>
<a href="#l10.3641"></a><span id="l10.3641">   nsCOMPtr&lt;nsIStringBundle&gt; brandBundle;</span>
<a href="#l10.3642"></a><span id="l10.3642" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://branding/locale/brand.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l10.3643"></a><span id="l10.3643" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(&quot;chrome://branding/locale/brand.properties&quot;,</span>
<a href="#l10.3644"></a><span id="l10.3644" class="difflineplus">+                                   getter_AddRefs(bundle));</span>
<a href="#l10.3645"></a><span id="l10.3645">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3646"></a><span id="l10.3646">   bundle-&gt;GetStringFromName(&quot;brandShortName&quot;, kLocalizedBrandShortName);</span>
<a href="#l10.3647"></a><span id="l10.3647">   return NS_OK;</span>
<a href="#l10.3648"></a><span id="l10.3648"> }</span>
<a href="#l10.3649"></a><span id="l10.3649"> </span>
<a href="#l10.3650"></a><span id="l10.3650" class="difflineminus">-nsresult</span>
<a href="#l10.3651"></a><span id="l10.3651" class="difflineminus">-nsMsgDBFolder::createCollationKeyGenerator()</span>
<a href="#l10.3652"></a><span id="l10.3652" class="difflineminus">-{</span>
<a href="#l10.3653"></a><span id="l10.3653" class="difflineplus">+nsresult nsMsgDBFolder::createCollationKeyGenerator() {</span>
<a href="#l10.3654"></a><span id="l10.3654">   nsresult rv = NS_OK;</span>
<a href="#l10.3655"></a><span id="l10.3655"> </span>
<a href="#l10.3656"></a><span id="l10.3656" class="difflineminus">-  nsCOMPtr &lt;nsICollationFactory&gt; factory = do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l10.3657"></a><span id="l10.3657" class="difflineplus">+  nsCOMPtr&lt;nsICollationFactory&gt; factory =</span>
<a href="#l10.3658"></a><span id="l10.3658" class="difflineplus">+      do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l10.3659"></a><span id="l10.3659">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3660"></a><span id="l10.3660"> </span>
<a href="#l10.3661"></a><span id="l10.3661">   return factory-&gt;CreateCollation(&amp;gCollationKeyGenerator);</span>
<a href="#l10.3662"></a><span id="l10.3662"> }</span>
<a href="#l10.3663"></a><span id="l10.3663"> </span>
<a href="#l10.3664"></a><span id="l10.3664"> NS_IMETHODIMP</span>
<a href="#l10.3665"></a><span id="l10.3665" class="difflineminus">-nsMsgDBFolder::Init(const char* aURI)</span>
<a href="#l10.3666"></a><span id="l10.3666" class="difflineminus">-{</span>
<a href="#l10.3667"></a><span id="l10.3667" class="difflineplus">+nsMsgDBFolder::Init(const char *aURI) {</span>
<a href="#l10.3668"></a><span id="l10.3668">   // for now, just initialize everything during Init()</span>
<a href="#l10.3669"></a><span id="l10.3669">   nsresult rv;</span>
<a href="#l10.3670"></a><span id="l10.3670">   rv = nsRDFResource::Init(aURI);</span>
<a href="#l10.3671"></a><span id="l10.3671">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3672"></a><span id="l10.3672">   return CreateBaseMessageURI(nsDependentCString(aURI));</span>
<a href="#l10.3673"></a><span id="l10.3673"> }</span>
<a href="#l10.3674"></a><span id="l10.3674"> </span>
<a href="#l10.3675"></a><span id="l10.3675" class="difflineminus">-nsresult nsMsgDBFolder::CreateBaseMessageURI(const nsACString&amp; aURI)</span>
<a href="#l10.3676"></a><span id="l10.3676" class="difflineminus">-{</span>
<a href="#l10.3677"></a><span id="l10.3677" class="difflineplus">+nsresult nsMsgDBFolder::CreateBaseMessageURI(const nsACString &amp;aURI) {</span>
<a href="#l10.3678"></a><span id="l10.3678">   // Each folder needs to implement this.</span>
<a href="#l10.3679"></a><span id="l10.3679">   return NS_OK;</span>
<a href="#l10.3680"></a><span id="l10.3680"> }</span>
<a href="#l10.3681"></a><span id="l10.3681"> </span>
<a href="#l10.3682"></a><span id="l10.3682"> NS_IMETHODIMP</span>
<a href="#l10.3683"></a><span id="l10.3683" class="difflineminus">-nsMsgDBFolder::GetURI(nsACString&amp; name)</span>
<a href="#l10.3684"></a><span id="l10.3684" class="difflineminus">-{</span>
<a href="#l10.3685"></a><span id="l10.3685" class="difflineplus">+nsMsgDBFolder::GetURI(nsACString &amp;name) {</span>
<a href="#l10.3686"></a><span id="l10.3686">   return nsRDFResource::GetValueUTF8(name);</span>
<a href="#l10.3687"></a><span id="l10.3687"> }</span>
<a href="#l10.3688"></a><span id="l10.3688"> </span>
<a href="#l10.3689"></a><span id="l10.3689"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.3690"></a><span id="l10.3690"> #if 0</span>
<a href="#l10.3691"></a><span id="l10.3691"> typedef bool</span>
<a href="#l10.3692"></a><span id="l10.3692"> (*nsArrayFilter)(nsISupports* element, void* data);</span>
<a href="#l10.3693"></a><span id="l10.3693"> #endif</span>
<a href="#l10.3694"></a><span id="l10.3694"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.3695"></a><span id="l10.3695"> </span>
<a href="#l10.3696"></a><span id="l10.3696"> NS_IMETHODIMP</span>
<a href="#l10.3697"></a><span id="l10.3697" class="difflineminus">-nsMsgDBFolder::GetSubFolders(nsISimpleEnumerator **aResult)</span>
<a href="#l10.3698"></a><span id="l10.3698" class="difflineminus">-{</span>
<a href="#l10.3699"></a><span id="l10.3699" class="difflineminus">-  return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders, NS_GET_IID(nsIMsgFolder)) : NS_ERROR_NULL_POINTER;</span>
<a href="#l10.3700"></a><span id="l10.3700" class="difflineplus">+nsMsgDBFolder::GetSubFolders(nsISimpleEnumerator **aResult) {</span>
<a href="#l10.3701"></a><span id="l10.3701" class="difflineplus">+  return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders,</span>
<a href="#l10.3702"></a><span id="l10.3702" class="difflineplus">+                                         NS_GET_IID(nsIMsgFolder))</span>
<a href="#l10.3703"></a><span id="l10.3703" class="difflineplus">+                 : NS_ERROR_NULL_POINTER;</span>
<a href="#l10.3704"></a><span id="l10.3704"> }</span>
<a href="#l10.3705"></a><span id="l10.3705"> </span>
<a href="#l10.3706"></a><span id="l10.3706"> NS_IMETHODIMP</span>
<a href="#l10.3707"></a><span id="l10.3707" class="difflineminus">-nsMsgDBFolder::FindSubFolder(const nsACString&amp; aEscapedSubFolderName, nsIMsgFolder **aFolder)</span>
<a href="#l10.3708"></a><span id="l10.3708" class="difflineminus">-{</span>
<a href="#l10.3709"></a><span id="l10.3709" class="difflineplus">+nsMsgDBFolder::FindSubFolder(const nsACString &amp;aEscapedSubFolderName,</span>
<a href="#l10.3710"></a><span id="l10.3710" class="difflineplus">+                             nsIMsgFolder **aFolder) {</span>
<a href="#l10.3711"></a><span id="l10.3711">   // XXX use necko here</span>
<a href="#l10.3712"></a><span id="l10.3712">   nsAutoCString uri;</span>
<a href="#l10.3713"></a><span id="l10.3713">   uri.Append(mURI);</span>
<a href="#l10.3714"></a><span id="l10.3714">   uri.Append('/');</span>
<a href="#l10.3715"></a><span id="l10.3715">   uri.Append(aEscapedSubFolderName);</span>
<a href="#l10.3716"></a><span id="l10.3716"> </span>
<a href="#l10.3717"></a><span id="l10.3717">   return GetOrCreateFolder(uri, aFolder);</span>
<a href="#l10.3718"></a><span id="l10.3718"> }</span>
<a href="#l10.3719"></a><span id="l10.3719"> </span>
<a href="#l10.3720"></a><span id="l10.3720"> NS_IMETHODIMP</span>
<a href="#l10.3721"></a><span id="l10.3721" class="difflineminus">-nsMsgDBFolder::GetHasSubFolders(bool *_retval)</span>
<a href="#l10.3722"></a><span id="l10.3722" class="difflineminus">-{</span>
<a href="#l10.3723"></a><span id="l10.3723" class="difflineplus">+nsMsgDBFolder::GetHasSubFolders(bool *_retval) {</span>
<a href="#l10.3724"></a><span id="l10.3724">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l10.3725"></a><span id="l10.3725">   *_retval = mSubFolders.Count() &gt; 0;</span>
<a href="#l10.3726"></a><span id="l10.3726">   return NS_OK;</span>
<a href="#l10.3727"></a><span id="l10.3727"> }</span>
<a href="#l10.3728"></a><span id="l10.3728"> </span>
<a href="#l10.3729"></a><span id="l10.3729"> NS_IMETHODIMP</span>
<a href="#l10.3730"></a><span id="l10.3730" class="difflineminus">-nsMsgDBFolder::GetNumSubFolders(uint32_t *aResult)</span>
<a href="#l10.3731"></a><span id="l10.3731" class="difflineminus">-{</span>
<a href="#l10.3732"></a><span id="l10.3732" class="difflineplus">+nsMsgDBFolder::GetNumSubFolders(uint32_t *aResult) {</span>
<a href="#l10.3733"></a><span id="l10.3733">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.3734"></a><span id="l10.3734">   *aResult = mSubFolders.Count();</span>
<a href="#l10.3735"></a><span id="l10.3735">   return NS_OK;</span>
<a href="#l10.3736"></a><span id="l10.3736"> }</span>
<a href="#l10.3737"></a><span id="l10.3737"> </span>
<a href="#l10.3738"></a><span id="l10.3738" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::AddFolderListener(nsIFolderListener * listener)</span>
<a href="#l10.3739"></a><span id="l10.3739" class="difflineminus">-{</span>
<a href="#l10.3740"></a><span id="l10.3740" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AddFolderListener(nsIFolderListener *listener) {</span>
<a href="#l10.3741"></a><span id="l10.3741">   NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l10.3742"></a><span id="l10.3742">   mListeners.AppendElement(listener);</span>
<a href="#l10.3743"></a><span id="l10.3743">   return NS_OK;</span>
<a href="#l10.3744"></a><span id="l10.3744"> }</span>
<a href="#l10.3745"></a><span id="l10.3745"> </span>
<a href="#l10.3746"></a><span id="l10.3746" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::RemoveFolderListener(nsIFolderListener * listener)</span>
<a href="#l10.3747"></a><span id="l10.3747" class="difflineminus">-{</span>
<a href="#l10.3748"></a><span id="l10.3748" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::RemoveFolderListener(nsIFolderListener *listener) {</span>
<a href="#l10.3749"></a><span id="l10.3749">   NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l10.3750"></a><span id="l10.3750">   mListeners.RemoveElement(listener);</span>
<a href="#l10.3751"></a><span id="l10.3751">   return NS_OK;</span>
<a href="#l10.3752"></a><span id="l10.3752"> }</span>
<a href="#l10.3753"></a><span id="l10.3753"> </span>
<a href="#l10.3754"></a><span id="l10.3754" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetParent(nsIMsgFolder *aParent)</span>
<a href="#l10.3755"></a><span id="l10.3755" class="difflineminus">-{</span>
<a href="#l10.3756"></a><span id="l10.3756" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetParent(nsIMsgFolder *aParent) {</span>
<a href="#l10.3757"></a><span id="l10.3757">   mParent = do_GetWeakReference(aParent);</span>
<a href="#l10.3758"></a><span id="l10.3758" class="difflineminus">-  if (aParent)</span>
<a href="#l10.3759"></a><span id="l10.3759" class="difflineminus">-  {</span>
<a href="#l10.3760"></a><span id="l10.3760" class="difflineplus">+  if (aParent) {</span>
<a href="#l10.3761"></a><span id="l10.3761">     nsresult rv;</span>
<a href="#l10.3762"></a><span id="l10.3762">     // servers do not have parents, so we must not be a server</span>
<a href="#l10.3763"></a><span id="l10.3763">     mIsServer = false;</span>
<a href="#l10.3764"></a><span id="l10.3764">     mIsServerIsValid = true;</span>
<a href="#l10.3765"></a><span id="l10.3765"> </span>
<a href="#l10.3766"></a><span id="l10.3766">     // also set the server itself while we're here.</span>
<a href="#l10.3767"></a><span id="l10.3767">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.3768"></a><span id="l10.3768">     rv = aParent-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l10.3769"></a><span id="l10.3769" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l10.3770"></a><span id="l10.3770" class="difflineminus">-      mServer = do_GetWeakReference(server);</span>
<a href="#l10.3771"></a><span id="l10.3771" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; server) mServer = do_GetWeakReference(server);</span>
<a href="#l10.3772"></a><span id="l10.3772">   }</span>
<a href="#l10.3773"></a><span id="l10.3773">   return NS_OK;</span>
<a href="#l10.3774"></a><span id="l10.3774"> }</span>
<a href="#l10.3775"></a><span id="l10.3775"> </span>
<a href="#l10.3776"></a><span id="l10.3776" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetParent(nsIMsgFolder **aParent)</span>
<a href="#l10.3777"></a><span id="l10.3777" class="difflineminus">-{</span>
<a href="#l10.3778"></a><span id="l10.3778" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetParent(nsIMsgFolder **aParent) {</span>
<a href="#l10.3779"></a><span id="l10.3779">   NS_ENSURE_ARG_POINTER(aParent);</span>
<a href="#l10.3780"></a><span id="l10.3780">   nsCOMPtr&lt;nsIMsgFolder&gt; parent = do_QueryReferent(mParent);</span>
<a href="#l10.3781"></a><span id="l10.3781">   parent.forget(aParent);</span>
<a href="#l10.3782"></a><span id="l10.3782">   return NS_OK;</span>
<a href="#l10.3783"></a><span id="l10.3783"> }</span>
<a href="#l10.3784"></a><span id="l10.3784"> </span>
<a href="#l10.3785"></a><span id="l10.3785"> NS_IMETHODIMP</span>
<a href="#l10.3786"></a><span id="l10.3786" class="difflineminus">-nsMsgDBFolder::GetMessages(nsISimpleEnumerator **result)</span>
<a href="#l10.3787"></a><span id="l10.3787" class="difflineminus">-{</span>
<a href="#l10.3788"></a><span id="l10.3788" class="difflineplus">+nsMsgDBFolder::GetMessages(nsISimpleEnumerator **result) {</span>
<a href="#l10.3789"></a><span id="l10.3789">   // XXX should this return an empty enumeration?</span>
<a href="#l10.3790"></a><span id="l10.3790">   return NS_ERROR_FAILURE;</span>
<a href="#l10.3791"></a><span id="l10.3791"> }</span>
<a href="#l10.3792"></a><span id="l10.3792"> </span>
<a href="#l10.3793"></a><span id="l10.3793"> NS_IMETHODIMP</span>
<a href="#l10.3794"></a><span id="l10.3794" class="difflineminus">-nsMsgDBFolder::UpdateFolder(nsIMsgWindow *)</span>
<a href="#l10.3795"></a><span id="l10.3795" class="difflineminus">-{</span>
<a href="#l10.3796"></a><span id="l10.3796" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.3797"></a><span id="l10.3797" class="difflineminus">-}</span>
<a href="#l10.3798"></a><span id="l10.3798" class="difflineplus">+nsMsgDBFolder::UpdateFolder(nsIMsgWindow *) { return NS_OK; }</span>
<a href="#l10.3799"></a><span id="l10.3799"> </span>
<a href="#l10.3800"></a><span id="l10.3800"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.3801"></a><span id="l10.3801"> </span>
<a href="#l10.3802"></a><span id="l10.3802" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetFolderURL(nsACString&amp; url)</span>
<a href="#l10.3803"></a><span id="l10.3803" class="difflineminus">-{</span>
<a href="#l10.3804"></a><span id="l10.3804" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetFolderURL(nsACString &amp;url) {</span>
<a href="#l10.3805"></a><span id="l10.3805">   url.Assign(EmptyCString());</span>
<a href="#l10.3806"></a><span id="l10.3806">   return NS_OK;</span>
<a href="#l10.3807"></a><span id="l10.3807"> }</span>
<a href="#l10.3808"></a><span id="l10.3808"> </span>
<a href="#l10.3809"></a><span id="l10.3809" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetServer(nsIMsgIncomingServer ** aServer)</span>
<a href="#l10.3810"></a><span id="l10.3810" class="difflineminus">-{</span>
<a href="#l10.3811"></a><span id="l10.3811" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetServer(nsIMsgIncomingServer **aServer) {</span>
<a href="#l10.3812"></a><span id="l10.3812">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l10.3813"></a><span id="l10.3813">   nsresult rv;</span>
<a href="#l10.3814"></a><span id="l10.3814">   // short circuit the server if we have it.</span>
<a href="#l10.3815"></a><span id="l10.3815">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryReferent(mServer, &amp;rv);</span>
<a href="#l10.3816"></a><span id="l10.3816" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.3817"></a><span id="l10.3817" class="difflineminus">-  {</span>
<a href="#l10.3818"></a><span id="l10.3818" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l10.3819"></a><span id="l10.3819">     // try again after parsing the URI</span>
<a href="#l10.3820"></a><span id="l10.3820">     rv = parseURI(true);</span>
<a href="#l10.3821"></a><span id="l10.3821">     server = do_QueryReferent(mServer);</span>
<a href="#l10.3822"></a><span id="l10.3822">   }</span>
<a href="#l10.3823"></a><span id="l10.3823">   server.forget(aServer);</span>
<a href="#l10.3824"></a><span id="l10.3824">   return *aServer ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l10.3825"></a><span id="l10.3825"> }</span>
<a href="#l10.3826"></a><span id="l10.3826"> </span>
<a href="#l10.3827"></a><span id="l10.3827" class="difflineminus">-nsresult</span>
<a href="#l10.3828"></a><span id="l10.3828" class="difflineminus">-nsMsgDBFolder::parseURI(bool needServer)</span>
<a href="#l10.3829"></a><span id="l10.3829" class="difflineminus">-{</span>
<a href="#l10.3830"></a><span id="l10.3830" class="difflineplus">+nsresult nsMsgDBFolder::parseURI(bool needServer) {</span>
<a href="#l10.3831"></a><span id="l10.3831">   nsresult rv;</span>
<a href="#l10.3832"></a><span id="l10.3832">   nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l10.3833"></a><span id="l10.3833" class="difflineminus">-  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(mURI).Finalize(url);</span>
<a href="#l10.3834"></a><span id="l10.3834" class="difflineplus">+  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l10.3835"></a><span id="l10.3835" class="difflineplus">+           .SetSpec(mURI)</span>
<a href="#l10.3836"></a><span id="l10.3836" class="difflineplus">+           .Finalize(url);</span>
<a href="#l10.3837"></a><span id="l10.3837">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3838"></a><span id="l10.3838"> </span>
<a href="#l10.3839"></a><span id="l10.3839">   // empty path tells us it's a server.</span>
<a href="#l10.3840"></a><span id="l10.3840" class="difflineminus">-  if (!mIsServerIsValid)</span>
<a href="#l10.3841"></a><span id="l10.3841" class="difflineminus">-  {</span>
<a href="#l10.3842"></a><span id="l10.3842" class="difflineplus">+  if (!mIsServerIsValid) {</span>
<a href="#l10.3843"></a><span id="l10.3843">     nsAutoCString path;</span>
<a href="#l10.3844"></a><span id="l10.3844">     rv = url-&gt;GetPathQueryRef(path);</span>
<a href="#l10.3845"></a><span id="l10.3845" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.3846"></a><span id="l10.3846" class="difflineminus">-      mIsServer = path.EqualsLiteral(&quot;/&quot;);</span>
<a href="#l10.3847"></a><span id="l10.3847" class="difflineplus">+    if (NS_SUCCEEDED(rv)) mIsServer = path.EqualsLiteral(&quot;/&quot;);</span>
<a href="#l10.3848"></a><span id="l10.3848">     mIsServerIsValid = true;</span>
<a href="#l10.3849"></a><span id="l10.3849">   }</span>
<a href="#l10.3850"></a><span id="l10.3850"> </span>
<a href="#l10.3851"></a><span id="l10.3851">   // grab the name off the leaf of the server</span>
<a href="#l10.3852"></a><span id="l10.3852" class="difflineminus">-  if (mName.IsEmpty())</span>
<a href="#l10.3853"></a><span id="l10.3853" class="difflineminus">-  {</span>
<a href="#l10.3854"></a><span id="l10.3854" class="difflineplus">+  if (mName.IsEmpty()) {</span>
<a href="#l10.3855"></a><span id="l10.3855">     // mName:</span>
<a href="#l10.3856"></a><span id="l10.3856">     // the name is the trailing directory in the path</span>
<a href="#l10.3857"></a><span id="l10.3857">     nsAutoCString fileName;</span>
<a href="#l10.3858"></a><span id="l10.3858">     nsAutoCString escapedFileName;</span>
<a href="#l10.3859"></a><span id="l10.3859">     url-&gt;GetFileName(escapedFileName);</span>
<a href="#l10.3860"></a><span id="l10.3860" class="difflineminus">-    if (!escapedFileName.IsEmpty())</span>
<a href="#l10.3861"></a><span id="l10.3861" class="difflineminus">-    {</span>
<a href="#l10.3862"></a><span id="l10.3862" class="difflineplus">+    if (!escapedFileName.IsEmpty()) {</span>
<a href="#l10.3863"></a><span id="l10.3863">       // XXX conversion to unicode here? is fileName in UTF8?</span>
<a href="#l10.3864"></a><span id="l10.3864">       // yes, let's say it is in utf8</span>
<a href="#l10.3865"></a><span id="l10.3865">       MsgUnescapeString(escapedFileName, 0, fileName);</span>
<a href="#l10.3866"></a><span id="l10.3866">       NS_ASSERTION(MsgIsUTF8(fileName), &quot;fileName is not in UTF-8&quot;);</span>
<a href="#l10.3867"></a><span id="l10.3867">       CopyUTF8toUTF16(fileName, mName);</span>
<a href="#l10.3868"></a><span id="l10.3868">     }</span>
<a href="#l10.3869"></a><span id="l10.3869">   }</span>
<a href="#l10.3870"></a><span id="l10.3870"> </span>
<a href="#l10.3871"></a><span id="l10.3871">   // grab the server by parsing the URI and looking it up</span>
<a href="#l10.3872"></a><span id="l10.3872">   // in the account manager...</span>
<a href="#l10.3873"></a><span id="l10.3873">   // But avoid this extra work by first asking the parent, if any</span>
<a href="#l10.3874"></a><span id="l10.3874">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryReferent(mServer, &amp;rv);</span>
<a href="#l10.3875"></a><span id="l10.3875" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.3876"></a><span id="l10.3876" class="difflineminus">-  {</span>
<a href="#l10.3877"></a><span id="l10.3877" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l10.3878"></a><span id="l10.3878">     // first try asking the parent instead of the URI</span>
<a href="#l10.3879"></a><span id="l10.3879">     nsCOMPtr&lt;nsIMsgFolder&gt; parentMsgFolder;</span>
<a href="#l10.3880"></a><span id="l10.3880">     GetParent(getter_AddRefs(parentMsgFolder));</span>
<a href="#l10.3881"></a><span id="l10.3881"> </span>
<a href="#l10.3882"></a><span id="l10.3882">     if (parentMsgFolder)</span>
<a href="#l10.3883"></a><span id="l10.3883">       rv = parentMsgFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l10.3884"></a><span id="l10.3884"> </span>
<a href="#l10.3885"></a><span id="l10.3885">     // no parent. do the extra work of asking</span>
<a href="#l10.3886"></a><span id="l10.3886" class="difflineminus">-    if (!server &amp;&amp; needServer)</span>
<a href="#l10.3887"></a><span id="l10.3887" class="difflineminus">-    {</span>
<a href="#l10.3888"></a><span id="l10.3888" class="difflineplus">+    if (!server &amp;&amp; needServer) {</span>
<a href="#l10.3889"></a><span id="l10.3889">       nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l10.3890"></a><span id="l10.3890" class="difflineminus">-               do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.3891"></a><span id="l10.3891" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.3892"></a><span id="l10.3892">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3893"></a><span id="l10.3893"> </span>
<a href="#l10.3894"></a><span id="l10.3894">       nsCString serverType;</span>
<a href="#l10.3895"></a><span id="l10.3895">       GetIncomingServerType(serverType);</span>
<a href="#l10.3896"></a><span id="l10.3896" class="difflineminus">-      if (serverType.IsEmpty())</span>
<a href="#l10.3897"></a><span id="l10.3897" class="difflineminus">-      {</span>
<a href="#l10.3898"></a><span id="l10.3898" class="difflineplus">+      if (serverType.IsEmpty()) {</span>
<a href="#l10.3899"></a><span id="l10.3899">         NS_WARNING(&quot;can't determine folder's server type&quot;);</span>
<a href="#l10.3900"></a><span id="l10.3900">         return NS_ERROR_FAILURE;</span>
<a href="#l10.3901"></a><span id="l10.3901">       }</span>
<a href="#l10.3902"></a><span id="l10.3902"> </span>
<a href="#l10.3903"></a><span id="l10.3903">       rv = NS_MutateURI(url).SetScheme(serverType).Finalize(url);</span>
<a href="#l10.3904"></a><span id="l10.3904">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3905"></a><span id="l10.3905" class="difflineminus">-      rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l10.3906"></a><span id="l10.3906" class="difflineminus">-                                      getter_AddRefs(server));</span>
<a href="#l10.3907"></a><span id="l10.3907" class="difflineplus">+      rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l10.3908"></a><span id="l10.3908">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3909"></a><span id="l10.3909">     }</span>
<a href="#l10.3910"></a><span id="l10.3910">     mServer = do_GetWeakReference(server);</span>
<a href="#l10.3911"></a><span id="l10.3911">   } /* !mServer */</span>
<a href="#l10.3912"></a><span id="l10.3912"> </span>
<a href="#l10.3913"></a><span id="l10.3913">   // now try to find the local path for this folder</span>
<a href="#l10.3914"></a><span id="l10.3914" class="difflineminus">-  if (server)</span>
<a href="#l10.3915"></a><span id="l10.3915" class="difflineminus">-  {</span>
<a href="#l10.3916"></a><span id="l10.3916" class="difflineplus">+  if (server) {</span>
<a href="#l10.3917"></a><span id="l10.3917">     nsAutoCString newPath;</span>
<a href="#l10.3918"></a><span id="l10.3918">     nsAutoCString escapedUrlPath;</span>
<a href="#l10.3919"></a><span id="l10.3919">     nsAutoCString urlPath;</span>
<a href="#l10.3920"></a><span id="l10.3920">     url-&gt;GetFilePath(escapedUrlPath);</span>
<a href="#l10.3921"></a><span id="l10.3921" class="difflineminus">-    if (!escapedUrlPath.IsEmpty())</span>
<a href="#l10.3922"></a><span id="l10.3922" class="difflineminus">-    {</span>
<a href="#l10.3923"></a><span id="l10.3923" class="difflineplus">+    if (!escapedUrlPath.IsEmpty()) {</span>
<a href="#l10.3924"></a><span id="l10.3924">       MsgUnescapeString(escapedUrlPath, 0, urlPath);</span>
<a href="#l10.3925"></a><span id="l10.3925"> </span>
<a href="#l10.3926"></a><span id="l10.3926">       // transform the filepath from the URI, such as</span>
<a href="#l10.3927"></a><span id="l10.3927">       // &quot;/folder1/folder2/foldern&quot;</span>
<a href="#l10.3928"></a><span id="l10.3928">       // to</span>
<a href="#l10.3929"></a><span id="l10.3929">       // &quot;folder1.sbd/folder2.sbd/foldern&quot;</span>
<a href="#l10.3930"></a><span id="l10.3930">       // (remove leading / and add .sbd to first n-1 folders)</span>
<a href="#l10.3931"></a><span id="l10.3931">       // to be appended onto the server's path</span>
<a href="#l10.3932"></a><span id="l10.3932">       bool isNewsFolder = false;</span>
<a href="#l10.3933"></a><span id="l10.3933">       nsAutoCString scheme;</span>
<a href="#l10.3934"></a><span id="l10.3934" class="difflineminus">-      if (NS_SUCCEEDED(url-&gt;GetScheme(scheme)))</span>
<a href="#l10.3935"></a><span id="l10.3935" class="difflineminus">-      {</span>
<a href="#l10.3936"></a><span id="l10.3936" class="difflineplus">+      if (NS_SUCCEEDED(url-&gt;GetScheme(scheme))) {</span>
<a href="#l10.3937"></a><span id="l10.3937">         isNewsFolder = scheme.EqualsLiteral(&quot;news&quot;) ||</span>
<a href="#l10.3938"></a><span id="l10.3938">                        scheme.EqualsLiteral(&quot;snews&quot;) ||</span>
<a href="#l10.3939"></a><span id="l10.3939">                        scheme.EqualsLiteral(&quot;nntp&quot;);</span>
<a href="#l10.3940"></a><span id="l10.3940">       }</span>
<a href="#l10.3941"></a><span id="l10.3941">       NS_MsgCreatePathStringFromFolderURI(urlPath.get(), newPath, scheme,</span>
<a href="#l10.3942"></a><span id="l10.3942">                                           isNewsFolder);</span>
<a href="#l10.3943"></a><span id="l10.3943">     }</span>
<a href="#l10.3944"></a><span id="l10.3944"> </span>
<a href="#l10.3945"></a><span id="l10.3945">     // now append munged path onto server path</span>
<a href="#l10.3946"></a><span id="l10.3946">     nsCOMPtr&lt;nsIFile&gt; serverPath;</span>
<a href="#l10.3947"></a><span id="l10.3947">     rv = server-&gt;GetLocalPath(getter_AddRefs(serverPath));</span>
<a href="#l10.3948"></a><span id="l10.3948">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.3949"></a><span id="l10.3949"> </span>
<a href="#l10.3950"></a><span id="l10.3950" class="difflineminus">-    if (!mPath &amp;&amp; serverPath)</span>
<a href="#l10.3951"></a><span id="l10.3951" class="difflineminus">-    {</span>
<a href="#l10.3952"></a><span id="l10.3952" class="difflineminus">-      if (!newPath.IsEmpty())</span>
<a href="#l10.3953"></a><span id="l10.3953" class="difflineminus">-      {</span>
<a href="#l10.3954"></a><span id="l10.3954" class="difflineplus">+    if (!mPath &amp;&amp; serverPath) {</span>
<a href="#l10.3955"></a><span id="l10.3955" class="difflineplus">+      if (!newPath.IsEmpty()) {</span>
<a href="#l10.3956"></a><span id="l10.3956">         // I hope this is temporary - Ultimately,</span>
<a href="#l10.3957"></a><span id="l10.3957">         // NS_MsgCreatePathStringFromFolderURI will need to be fixed.</span>
<a href="#l10.3958"></a><span id="l10.3958"> #if defined(XP_WIN)</span>
<a href="#l10.3959"></a><span id="l10.3959">         MsgReplaceChar(newPath, '/', '\\');</span>
<a href="#l10.3960"></a><span id="l10.3960"> #endif</span>
<a href="#l10.3961"></a><span id="l10.3961">         rv = serverPath-&gt;AppendRelativeNativePath(newPath);</span>
<a href="#l10.3962"></a><span id="l10.3962" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to append to the serverPath&quot;);</span>
<a href="#l10.3963"></a><span id="l10.3963" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l10.3964"></a><span id="l10.3964" class="difflineminus">-        {</span>
<a href="#l10.3965"></a><span id="l10.3965" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to append to the serverPath&quot;);</span>
<a href="#l10.3966"></a><span id="l10.3966" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l10.3967"></a><span id="l10.3967">           mPath = nullptr;</span>
<a href="#l10.3968"></a><span id="l10.3968">           return rv;</span>
<a href="#l10.3969"></a><span id="l10.3969">         }</span>
<a href="#l10.3970"></a><span id="l10.3970">       }</span>
<a href="#l10.3971"></a><span id="l10.3971">       mPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.3972"></a><span id="l10.3972">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.3973"></a><span id="l10.3973">       mPath-&gt;InitWithFile(serverPath);</span>
<a href="#l10.3974"></a><span id="l10.3974">     }</span>
<a href="#l10.3975"></a><span id="l10.3975">     // URI is completely parsed when we've attempted to get the server</span>
<a href="#l10.3976"></a><span id="l10.3976" class="difflineminus">-    mHaveParsedURI=true;</span>
<a href="#l10.3977"></a><span id="l10.3977" class="difflineplus">+    mHaveParsedURI = true;</span>
<a href="#l10.3978"></a><span id="l10.3978">   }</span>
<a href="#l10.3979"></a><span id="l10.3979">   return NS_OK;</span>
<a href="#l10.3980"></a><span id="l10.3980"> }</span>
<a href="#l10.3981"></a><span id="l10.3981"> </span>
<a href="#l10.3982"></a><span id="l10.3982"> NS_IMETHODIMP</span>
<a href="#l10.3983"></a><span id="l10.3983" class="difflineminus">-nsMsgDBFolder::GetIsServer(bool *aResult)</span>
<a href="#l10.3984"></a><span id="l10.3984" class="difflineminus">-{</span>
<a href="#l10.3985"></a><span id="l10.3985" class="difflineplus">+nsMsgDBFolder::GetIsServer(bool *aResult) {</span>
<a href="#l10.3986"></a><span id="l10.3986">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.3987"></a><span id="l10.3987">   // make sure we've parsed the URI</span>
<a href="#l10.3988"></a><span id="l10.3988" class="difflineminus">-  if (!mIsServerIsValid)</span>
<a href="#l10.3989"></a><span id="l10.3989" class="difflineminus">-  {</span>
<a href="#l10.3990"></a><span id="l10.3990" class="difflineplus">+  if (!mIsServerIsValid) {</span>
<a href="#l10.3991"></a><span id="l10.3991">     nsresult rv = parseURI();</span>
<a href="#l10.3992"></a><span id="l10.3992" class="difflineminus">-    if (NS_FAILED(rv) || !mIsServerIsValid)</span>
<a href="#l10.3993"></a><span id="l10.3993" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l10.3994"></a><span id="l10.3994" class="difflineplus">+    if (NS_FAILED(rv) || !mIsServerIsValid) return NS_ERROR_FAILURE;</span>
<a href="#l10.3995"></a><span id="l10.3995">   }</span>
<a href="#l10.3996"></a><span id="l10.3996"> </span>
<a href="#l10.3997"></a><span id="l10.3997">   *aResult = mIsServer;</span>
<a href="#l10.3998"></a><span id="l10.3998">   return NS_OK;</span>
<a href="#l10.3999"></a><span id="l10.3999"> }</span>
<a href="#l10.4000"></a><span id="l10.4000"> </span>
<a href="#l10.4001"></a><span id="l10.4001"> NS_IMETHODIMP</span>
<a href="#l10.4002"></a><span id="l10.4002" class="difflineminus">-nsMsgDBFolder::GetNoSelect(bool *aResult)</span>
<a href="#l10.4003"></a><span id="l10.4003" class="difflineminus">-{</span>
<a href="#l10.4004"></a><span id="l10.4004" class="difflineplus">+nsMsgDBFolder::GetNoSelect(bool *aResult) {</span>
<a href="#l10.4005"></a><span id="l10.4005">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4006"></a><span id="l10.4006">   *aResult = false;</span>
<a href="#l10.4007"></a><span id="l10.4007">   return NS_OK;</span>
<a href="#l10.4008"></a><span id="l10.4008"> }</span>
<a href="#l10.4009"></a><span id="l10.4009"> </span>
<a href="#l10.4010"></a><span id="l10.4010"> NS_IMETHODIMP</span>
<a href="#l10.4011"></a><span id="l10.4011" class="difflineminus">-nsMsgDBFolder::GetImapShared(bool *aResult)</span>
<a href="#l10.4012"></a><span id="l10.4012" class="difflineminus">-{</span>
<a href="#l10.4013"></a><span id="l10.4013" class="difflineplus">+nsMsgDBFolder::GetImapShared(bool *aResult) {</span>
<a href="#l10.4014"></a><span id="l10.4014">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4015"></a><span id="l10.4015">   return GetFlag(nsMsgFolderFlags::PersonalShared, aResult);</span>
<a href="#l10.4016"></a><span id="l10.4016"> }</span>
<a href="#l10.4017"></a><span id="l10.4017"> </span>
<a href="#l10.4018"></a><span id="l10.4018"> NS_IMETHODIMP</span>
<a href="#l10.4019"></a><span id="l10.4019" class="difflineminus">-nsMsgDBFolder::GetCanSubscribe(bool *aResult)</span>
<a href="#l10.4020"></a><span id="l10.4020" class="difflineminus">-{</span>
<a href="#l10.4021"></a><span id="l10.4021" class="difflineplus">+nsMsgDBFolder::GetCanSubscribe(bool *aResult) {</span>
<a href="#l10.4022"></a><span id="l10.4022">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4023"></a><span id="l10.4023">   // by default, you can't subscribe.</span>
<a href="#l10.4024"></a><span id="l10.4024">   // if otherwise, override it.</span>
<a href="#l10.4025"></a><span id="l10.4025">   *aResult = false;</span>
<a href="#l10.4026"></a><span id="l10.4026">   return NS_OK;</span>
<a href="#l10.4027"></a><span id="l10.4027"> }</span>
<a href="#l10.4028"></a><span id="l10.4028"> </span>
<a href="#l10.4029"></a><span id="l10.4029"> NS_IMETHODIMP</span>
<a href="#l10.4030"></a><span id="l10.4030" class="difflineminus">-nsMsgDBFolder::GetCanFileMessages(bool *aResult)</span>
<a href="#l10.4031"></a><span id="l10.4031" class="difflineminus">-{</span>
<a href="#l10.4032"></a><span id="l10.4032" class="difflineplus">+nsMsgDBFolder::GetCanFileMessages(bool *aResult) {</span>
<a href="#l10.4033"></a><span id="l10.4033">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4034"></a><span id="l10.4034"> </span>
<a href="#l10.4035"></a><span id="l10.4035" class="difflineminus">-  //varada - checking folder flag to see if it is the &quot;Unsent Messages&quot;</span>
<a href="#l10.4036"></a><span id="l10.4036" class="difflineminus">-  //and if so return FALSE</span>
<a href="#l10.4037"></a><span id="l10.4037" class="difflineminus">-  if (mFlags &amp; (nsMsgFolderFlags::Queue | nsMsgFolderFlags::Virtual))</span>
<a href="#l10.4038"></a><span id="l10.4038" class="difflineminus">-  {</span>
<a href="#l10.4039"></a><span id="l10.4039" class="difflineplus">+  // varada - checking folder flag to see if it is the &quot;Unsent Messages&quot;</span>
<a href="#l10.4040"></a><span id="l10.4040" class="difflineplus">+  // and if so return FALSE</span>
<a href="#l10.4041"></a><span id="l10.4041" class="difflineplus">+  if (mFlags &amp; (nsMsgFolderFlags::Queue | nsMsgFolderFlags::Virtual)) {</span>
<a href="#l10.4042"></a><span id="l10.4042">     *aResult = false;</span>
<a href="#l10.4043"></a><span id="l10.4043">     return NS_OK;</span>
<a href="#l10.4044"></a><span id="l10.4044">   }</span>
<a href="#l10.4045"></a><span id="l10.4045"> </span>
<a href="#l10.4046"></a><span id="l10.4046">   bool isServer = false;</span>
<a href="#l10.4047"></a><span id="l10.4047">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l10.4048"></a><span id="l10.4048">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4049"></a><span id="l10.4049"> </span>
<a href="#l10.4050"></a><span id="l10.4050">   // by default, you can't file messages into servers, only to folders</span>
<a href="#l10.4051"></a><span id="l10.4051">   // if otherwise, override it.</span>
<a href="#l10.4052"></a><span id="l10.4052">   *aResult = !isServer;</span>
<a href="#l10.4053"></a><span id="l10.4053">   return NS_OK;</span>
<a href="#l10.4054"></a><span id="l10.4054"> }</span>
<a href="#l10.4055"></a><span id="l10.4055"> </span>
<a href="#l10.4056"></a><span id="l10.4056"> NS_IMETHODIMP</span>
<a href="#l10.4057"></a><span id="l10.4057" class="difflineminus">-nsMsgDBFolder::GetCanDeleteMessages(bool *aResult)</span>
<a href="#l10.4058"></a><span id="l10.4058" class="difflineminus">-{</span>
<a href="#l10.4059"></a><span id="l10.4059" class="difflineplus">+nsMsgDBFolder::GetCanDeleteMessages(bool *aResult) {</span>
<a href="#l10.4060"></a><span id="l10.4060">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4061"></a><span id="l10.4061">   *aResult = true;</span>
<a href="#l10.4062"></a><span id="l10.4062">   return NS_OK;</span>
<a href="#l10.4063"></a><span id="l10.4063"> }</span>
<a href="#l10.4064"></a><span id="l10.4064"> </span>
<a href="#l10.4065"></a><span id="l10.4065"> NS_IMETHODIMP</span>
<a href="#l10.4066"></a><span id="l10.4066" class="difflineminus">-nsMsgDBFolder::GetCanCreateSubfolders(bool *aResult)</span>
<a href="#l10.4067"></a><span id="l10.4067" class="difflineminus">-{</span>
<a href="#l10.4068"></a><span id="l10.4068" class="difflineplus">+nsMsgDBFolder::GetCanCreateSubfolders(bool *aResult) {</span>
<a href="#l10.4069"></a><span id="l10.4069">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4070"></a><span id="l10.4070"> </span>
<a href="#l10.4071"></a><span id="l10.4071" class="difflineminus">-  //Checking folder flag to see if it is the &quot;Unsent Messages&quot;</span>
<a href="#l10.4072"></a><span id="l10.4072" class="difflineminus">-  //or a virtual folder, and if so return FALSE</span>
<a href="#l10.4073"></a><span id="l10.4073" class="difflineminus">-  if (mFlags &amp; (nsMsgFolderFlags::Queue | nsMsgFolderFlags::Virtual))</span>
<a href="#l10.4074"></a><span id="l10.4074" class="difflineminus">-  {</span>
<a href="#l10.4075"></a><span id="l10.4075" class="difflineplus">+  // Checking folder flag to see if it is the &quot;Unsent Messages&quot;</span>
<a href="#l10.4076"></a><span id="l10.4076" class="difflineplus">+  // or a virtual folder, and if so return FALSE</span>
<a href="#l10.4077"></a><span id="l10.4077" class="difflineplus">+  if (mFlags &amp; (nsMsgFolderFlags::Queue | nsMsgFolderFlags::Virtual)) {</span>
<a href="#l10.4078"></a><span id="l10.4078">     *aResult = false;</span>
<a href="#l10.4079"></a><span id="l10.4079">     return NS_OK;</span>
<a href="#l10.4080"></a><span id="l10.4080">   }</span>
<a href="#l10.4081"></a><span id="l10.4081"> </span>
<a href="#l10.4082"></a><span id="l10.4082">   // by default, you can create subfolders on server and folders</span>
<a href="#l10.4083"></a><span id="l10.4083">   // if otherwise, override it.</span>
<a href="#l10.4084"></a><span id="l10.4084">   *aResult = true;</span>
<a href="#l10.4085"></a><span id="l10.4085">   return NS_OK;</span>
<a href="#l10.4086"></a><span id="l10.4086"> }</span>
<a href="#l10.4087"></a><span id="l10.4087"> </span>
<a href="#l10.4088"></a><span id="l10.4088"> NS_IMETHODIMP</span>
<a href="#l10.4089"></a><span id="l10.4089" class="difflineminus">-nsMsgDBFolder::GetCanRename(bool *aResult)</span>
<a href="#l10.4090"></a><span id="l10.4090" class="difflineminus">-{</span>
<a href="#l10.4091"></a><span id="l10.4091" class="difflineplus">+nsMsgDBFolder::GetCanRename(bool *aResult) {</span>
<a href="#l10.4092"></a><span id="l10.4092">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4093"></a><span id="l10.4093"> </span>
<a href="#l10.4094"></a><span id="l10.4094">   bool isServer = false;</span>
<a href="#l10.4095"></a><span id="l10.4095">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l10.4096"></a><span id="l10.4096">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4097"></a><span id="l10.4097">   // by default, you can't rename servers, only folders</span>
<a href="#l10.4098"></a><span id="l10.4098">   // if otherwise, override it.</span>
<a href="#l10.4099"></a><span id="l10.4099">   //</span>
<a href="#l10.4100"></a><span id="l10.4100" class="difflineat">@@ -3378,232 +3110,210 @@ nsMsgDBFolder::GetCanRename(bool *aResul</span>
<a href="#l10.4101"></a><span id="l10.4101">   // instead of checking if the folder really is being used as a</span>
<a href="#l10.4102"></a><span id="l10.4102">   // special folder by looking at the &quot;copies and folders&quot; prefs on the</span>
<a href="#l10.4103"></a><span id="l10.4103">   // identities.</span>
<a href="#l10.4104"></a><span id="l10.4104">   *aResult = !(isServer || (mFlags &amp; nsMsgFolderFlags::SpecialUse));</span>
<a href="#l10.4105"></a><span id="l10.4105">   return NS_OK;</span>
<a href="#l10.4106"></a><span id="l10.4106"> }</span>
<a href="#l10.4107"></a><span id="l10.4107"> </span>
<a href="#l10.4108"></a><span id="l10.4108"> NS_IMETHODIMP</span>
<a href="#l10.4109"></a><span id="l10.4109" class="difflineminus">-nsMsgDBFolder::GetCanCompact(bool *aResult)</span>
<a href="#l10.4110"></a><span id="l10.4110" class="difflineminus">-{</span>
<a href="#l10.4111"></a><span id="l10.4111" class="difflineplus">+nsMsgDBFolder::GetCanCompact(bool *aResult) {</span>
<a href="#l10.4112"></a><span id="l10.4112">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.4113"></a><span id="l10.4113">   bool isServer = false;</span>
<a href="#l10.4114"></a><span id="l10.4114">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l10.4115"></a><span id="l10.4115" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.4116"></a><span id="l10.4116" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4117"></a><span id="l10.4117">   // servers cannot be compacted --&gt; 4.x</span>
<a href="#l10.4118"></a><span id="l10.4118">   // virtual search folders cannot be compacted</span>
<a href="#l10.4119"></a><span id="l10.4119">   *aResult = !isServer &amp;&amp; !(mFlags &amp; nsMsgFolderFlags::Virtual);</span>
<a href="#l10.4120"></a><span id="l10.4120">   // Check if the store supports compaction</span>
<a href="#l10.4121"></a><span id="l10.4121" class="difflineminus">-  if (*aResult)</span>
<a href="#l10.4122"></a><span id="l10.4122" class="difflineminus">-  {</span>
<a href="#l10.4123"></a><span id="l10.4123" class="difflineplus">+  if (*aResult) {</span>
<a href="#l10.4124"></a><span id="l10.4124">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l10.4125"></a><span id="l10.4125">     GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l10.4126"></a><span id="l10.4126" class="difflineminus">-    if (msgStore)</span>
<a href="#l10.4127"></a><span id="l10.4127" class="difflineminus">-      msgStore-&gt;GetSupportsCompaction(aResult);</span>
<a href="#l10.4128"></a><span id="l10.4128" class="difflineplus">+    if (msgStore) msgStore-&gt;GetSupportsCompaction(aResult);</span>
<a href="#l10.4129"></a><span id="l10.4129">   }</span>
<a href="#l10.4130"></a><span id="l10.4130">   return NS_OK;</span>
<a href="#l10.4131"></a><span id="l10.4131"> }</span>
<a href="#l10.4132"></a><span id="l10.4132"> </span>
<a href="#l10.4133"></a><span id="l10.4133" class="difflineminus">-</span>
<a href="#l10.4134"></a><span id="l10.4134" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetPrettyName(nsAString&amp; name)</span>
<a href="#l10.4135"></a><span id="l10.4135" class="difflineminus">-{</span>
<a href="#l10.4136"></a><span id="l10.4136" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetPrettyName(nsAString &amp;name) {</span>
<a href="#l10.4137"></a><span id="l10.4137">   return GetName(name);</span>
<a href="#l10.4138"></a><span id="l10.4138"> }</span>
<a href="#l10.4139"></a><span id="l10.4139"> </span>
<a href="#l10.4140"></a><span id="l10.4140"> // -1: not retrieved yet, 1: English, 0: non-English.</span>
<a href="#l10.4141"></a><span id="l10.4141"> static int isEnglish = -1;</span>
<a href="#l10.4142"></a><span id="l10.4142"> </span>
<a href="#l10.4143"></a><span id="l10.4143" class="difflineminus">-static bool</span>
<a href="#l10.4144"></a><span id="l10.4144" class="difflineminus">-nonEnglishApp()</span>
<a href="#l10.4145"></a><span id="l10.4145" class="difflineminus">-{</span>
<a href="#l10.4146"></a><span id="l10.4146" class="difflineplus">+static bool nonEnglishApp() {</span>
<a href="#l10.4147"></a><span id="l10.4147">   if (isEnglish == -1) {</span>
<a href="#l10.4148"></a><span id="l10.4148">     nsAutoCString locale;</span>
<a href="#l10.4149"></a><span id="l10.4149">     mozilla::intl::LocaleService::GetInstance()-&gt;GetAppLocaleAsLangTag(locale);</span>
<a href="#l10.4150"></a><span id="l10.4150">     isEnglish = (locale.EqualsLiteral(&quot;en&quot;) ||</span>
<a href="#l10.4151"></a><span id="l10.4151" class="difflineminus">-                 StringBeginsWith(locale, NS_LITERAL_CSTRING(&quot;en-&quot;))) ? 1 : 0;</span>
<a href="#l10.4152"></a><span id="l10.4152" class="difflineplus">+                 StringBeginsWith(locale, NS_LITERAL_CSTRING(&quot;en-&quot;)))</span>
<a href="#l10.4153"></a><span id="l10.4153" class="difflineplus">+                    ? 1</span>
<a href="#l10.4154"></a><span id="l10.4154" class="difflineplus">+                    : 0;</span>
<a href="#l10.4155"></a><span id="l10.4155">   }</span>
<a href="#l10.4156"></a><span id="l10.4156">   return isEnglish ? false : true;</span>
<a href="#l10.4157"></a><span id="l10.4157"> }</span>
<a href="#l10.4158"></a><span id="l10.4158"> </span>
<a href="#l10.4159"></a><span id="l10.4159" class="difflineminus">-static bool</span>
<a href="#l10.4160"></a><span id="l10.4160" class="difflineminus">-hasTrashName(const nsAString&amp; name)</span>
<a href="#l10.4161"></a><span id="l10.4161" class="difflineminus">-{</span>
<a href="#l10.4162"></a><span id="l10.4162" class="difflineplus">+static bool hasTrashName(const nsAString &amp;name) {</span>
<a href="#l10.4163"></a><span id="l10.4163">   // Microsoft calls the folder &quot;Deleted&quot;. If the application is non-English,</span>
<a href="#l10.4164"></a><span id="l10.4164">   // we want to use the localised name instead.</span>
<a href="#l10.4165"></a><span id="l10.4165">   return name.LowerCaseEqualsLiteral(&quot;trash&quot;) ||</span>
<a href="#l10.4166"></a><span id="l10.4166">          (name.LowerCaseEqualsLiteral(&quot;deleted&quot;) &amp;&amp; nonEnglishApp());</span>
<a href="#l10.4167"></a><span id="l10.4167"> }</span>
<a href="#l10.4168"></a><span id="l10.4168"> </span>
<a href="#l10.4169"></a><span id="l10.4169" class="difflineminus">-static bool</span>
<a href="#l10.4170"></a><span id="l10.4170" class="difflineminus">-hasDraftsName(const nsAString&amp; name)</span>
<a href="#l10.4171"></a><span id="l10.4171" class="difflineminus">-{</span>
<a href="#l10.4172"></a><span id="l10.4172" class="difflineminus">-  // Some IMAP providers call the folder &quot;Draft&quot;. If the application is non-English,</span>
<a href="#l10.4173"></a><span id="l10.4173" class="difflineminus">-  // we want to use the localised name instead.</span>
<a href="#l10.4174"></a><span id="l10.4174" class="difflineplus">+static bool hasDraftsName(const nsAString &amp;name) {</span>
<a href="#l10.4175"></a><span id="l10.4175" class="difflineplus">+  // Some IMAP providers call the folder &quot;Draft&quot;. If the application is</span>
<a href="#l10.4176"></a><span id="l10.4176" class="difflineplus">+  // non-English, we want to use the localised name instead.</span>
<a href="#l10.4177"></a><span id="l10.4177">   return name.LowerCaseEqualsLiteral(&quot;drafts&quot;) ||</span>
<a href="#l10.4178"></a><span id="l10.4178">          (name.LowerCaseEqualsLiteral(&quot;draft&quot;) &amp;&amp; nonEnglishApp());</span>
<a href="#l10.4179"></a><span id="l10.4179"> }</span>
<a href="#l10.4180"></a><span id="l10.4180"> </span>
<a href="#l10.4181"></a><span id="l10.4181" class="difflineminus">-static bool</span>
<a href="#l10.4182"></a><span id="l10.4182" class="difflineminus">-hasSentName(const nsAString&amp; name)</span>
<a href="#l10.4183"></a><span id="l10.4183" class="difflineminus">-{</span>
<a href="#l10.4184"></a><span id="l10.4184" class="difflineplus">+static bool hasSentName(const nsAString &amp;name) {</span>
<a href="#l10.4185"></a><span id="l10.4185">   // Some IMAP providers call the folder for sent messages &quot;Outbox&quot;. That IMAP</span>
<a href="#l10.4186"></a><span id="l10.4186">   // folder is not related to Thunderbird's local folder for queued messages.</span>
<a href="#l10.4187"></a><span id="l10.4187">   // If we find such a folder with the 'SentMail' flag, we can safely localize</span>
<a href="#l10.4188"></a><span id="l10.4188">   // its name if the application is non-English.</span>
<a href="#l10.4189"></a><span id="l10.4189">   return name.LowerCaseEqualsLiteral(&quot;sent&quot;) ||</span>
<a href="#l10.4190"></a><span id="l10.4190">          (name.LowerCaseEqualsLiteral(&quot;outbox&quot;) &amp;&amp; nonEnglishApp());</span>
<a href="#l10.4191"></a><span id="l10.4191"> }</span>
<a href="#l10.4192"></a><span id="l10.4192"> </span>
<a href="#l10.4193"></a><span id="l10.4193" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetPrettyName(const nsAString&amp; name)</span>
<a href="#l10.4194"></a><span id="l10.4194" class="difflineminus">-{</span>
<a href="#l10.4195"></a><span id="l10.4195" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetPrettyName(const nsAString &amp;name) {</span>
<a href="#l10.4196"></a><span id="l10.4196">   nsresult rv;</span>
<a href="#l10.4197"></a><span id="l10.4197"> </span>
<a href="#l10.4198"></a><span id="l10.4198" class="difflineminus">-  //Set pretty name only if special flag is set and if it the default folder name</span>
<a href="#l10.4199"></a><span id="l10.4199" class="difflineplus">+  // Set pretty name only if special flag is set and if it the default folder</span>
<a href="#l10.4200"></a><span id="l10.4200" class="difflineplus">+  // name</span>
<a href="#l10.4201"></a><span id="l10.4201">   if (mFlags &amp; nsMsgFolderFlags::Inbox &amp;&amp; name.LowerCaseEqualsLiteral(&quot;inbox&quot;))</span>
<a href="#l10.4202"></a><span id="l10.4202">     rv = SetName(kLocalizedInboxName);</span>
<a href="#l10.4203"></a><span id="l10.4203">   else if (mFlags &amp; nsMsgFolderFlags::SentMail &amp;&amp; hasSentName(name))</span>
<a href="#l10.4204"></a><span id="l10.4204">     rv = SetName(kLocalizedSentName);</span>
<a href="#l10.4205"></a><span id="l10.4205">   else if (mFlags &amp; nsMsgFolderFlags::Drafts &amp;&amp; hasDraftsName(name))</span>
<a href="#l10.4206"></a><span id="l10.4206">     rv = SetName(kLocalizedDraftsName);</span>
<a href="#l10.4207"></a><span id="l10.4207" class="difflineminus">-  else if (mFlags &amp; nsMsgFolderFlags::Templates &amp;&amp; name.LowerCaseEqualsLiteral(&quot;templates&quot;))</span>
<a href="#l10.4208"></a><span id="l10.4208" class="difflineplus">+  else if (mFlags &amp; nsMsgFolderFlags::Templates &amp;&amp;</span>
<a href="#l10.4209"></a><span id="l10.4209" class="difflineplus">+           name.LowerCaseEqualsLiteral(&quot;templates&quot;))</span>
<a href="#l10.4210"></a><span id="l10.4210">     rv = SetName(kLocalizedTemplatesName);</span>
<a href="#l10.4211"></a><span id="l10.4211">   else if (mFlags &amp; nsMsgFolderFlags::Trash &amp;&amp; hasTrashName(name))</span>
<a href="#l10.4212"></a><span id="l10.4212">     rv = SetName(kLocalizedTrashName);</span>
<a href="#l10.4213"></a><span id="l10.4213" class="difflineminus">-  else if (mFlags &amp; nsMsgFolderFlags::Queue &amp;&amp; name.LowerCaseEqualsLiteral(&quot;unsent messages&quot;))</span>
<a href="#l10.4214"></a><span id="l10.4214" class="difflineplus">+  else if (mFlags &amp; nsMsgFolderFlags::Queue &amp;&amp;</span>
<a href="#l10.4215"></a><span id="l10.4215" class="difflineplus">+           name.LowerCaseEqualsLiteral(&quot;unsent messages&quot;))</span>
<a href="#l10.4216"></a><span id="l10.4216">     rv = SetName(kLocalizedUnsentName);</span>
<a href="#l10.4217"></a><span id="l10.4217" class="difflineminus">-  else if (mFlags &amp; nsMsgFolderFlags::Junk &amp;&amp; name.LowerCaseEqualsLiteral(&quot;junk&quot;))</span>
<a href="#l10.4218"></a><span id="l10.4218" class="difflineplus">+  else if (mFlags &amp; nsMsgFolderFlags::Junk &amp;&amp;</span>
<a href="#l10.4219"></a><span id="l10.4219" class="difflineplus">+           name.LowerCaseEqualsLiteral(&quot;junk&quot;))</span>
<a href="#l10.4220"></a><span id="l10.4220">     rv = SetName(kLocalizedJunkName);</span>
<a href="#l10.4221"></a><span id="l10.4221" class="difflineminus">-  else if (mFlags &amp; nsMsgFolderFlags::Archive &amp;&amp; name.LowerCaseEqualsLiteral(&quot;archives&quot;))</span>
<a href="#l10.4222"></a><span id="l10.4222" class="difflineplus">+  else if (mFlags &amp; nsMsgFolderFlags::Archive &amp;&amp;</span>
<a href="#l10.4223"></a><span id="l10.4223" class="difflineplus">+           name.LowerCaseEqualsLiteral(&quot;archives&quot;))</span>
<a href="#l10.4224"></a><span id="l10.4224">     rv = SetName(kLocalizedArchivesName);</span>
<a href="#l10.4225"></a><span id="l10.4225">   else</span>
<a href="#l10.4226"></a><span id="l10.4226">     rv = SetName(name);</span>
<a href="#l10.4227"></a><span id="l10.4227">   return rv;</span>
<a href="#l10.4228"></a><span id="l10.4228"> }</span>
<a href="#l10.4229"></a><span id="l10.4229"> </span>
<a href="#l10.4230"></a><span id="l10.4230" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetName(nsAString&amp; name)</span>
<a href="#l10.4231"></a><span id="l10.4231" class="difflineminus">-{</span>
<a href="#l10.4232"></a><span id="l10.4232" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetName(nsAString &amp;name) {</span>
<a href="#l10.4233"></a><span id="l10.4233">   nsresult rv;</span>
<a href="#l10.4234"></a><span id="l10.4234" class="difflineminus">-  if (!mHaveParsedURI &amp;&amp; mName.IsEmpty())</span>
<a href="#l10.4235"></a><span id="l10.4235" class="difflineminus">-  {</span>
<a href="#l10.4236"></a><span id="l10.4236" class="difflineplus">+  if (!mHaveParsedURI &amp;&amp; mName.IsEmpty()) {</span>
<a href="#l10.4237"></a><span id="l10.4237">     rv = parseURI();</span>
<a href="#l10.4238"></a><span id="l10.4238">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4239"></a><span id="l10.4239">   }</span>
<a href="#l10.4240"></a><span id="l10.4240"> </span>
<a href="#l10.4241"></a><span id="l10.4241">   // if it's a server, just forward the call</span>
<a href="#l10.4242"></a><span id="l10.4242" class="difflineminus">-  if (mIsServer)</span>
<a href="#l10.4243"></a><span id="l10.4243" class="difflineminus">-  {</span>
<a href="#l10.4244"></a><span id="l10.4244" class="difflineplus">+  if (mIsServer) {</span>
<a href="#l10.4245"></a><span id="l10.4245">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.4246"></a><span id="l10.4246">     rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.4247"></a><span id="l10.4247" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l10.4248"></a><span id="l10.4248" class="difflineminus">-      return server-&gt;GetPrettyName(name);</span>
<a href="#l10.4249"></a><span id="l10.4249" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; server) return server-&gt;GetPrettyName(name);</span>
<a href="#l10.4250"></a><span id="l10.4250">   }</span>
<a href="#l10.4251"></a><span id="l10.4251"> </span>
<a href="#l10.4252"></a><span id="l10.4252">   name = mName;</span>
<a href="#l10.4253"></a><span id="l10.4253">   return NS_OK;</span>
<a href="#l10.4254"></a><span id="l10.4254"> }</span>
<a href="#l10.4255"></a><span id="l10.4255"> </span>
<a href="#l10.4256"></a><span id="l10.4256" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetName(const nsAString&amp; name)</span>
<a href="#l10.4257"></a><span id="l10.4257" class="difflineminus">-{</span>
<a href="#l10.4258"></a><span id="l10.4258" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetName(const nsAString &amp;name) {</span>
<a href="#l10.4259"></a><span id="l10.4259">   // override the URI-generated name</span>
<a href="#l10.4260"></a><span id="l10.4260" class="difflineminus">-  if (!mName.Equals(name))</span>
<a href="#l10.4261"></a><span id="l10.4261" class="difflineminus">-  {</span>
<a href="#l10.4262"></a><span id="l10.4262" class="difflineplus">+  if (!mName.Equals(name)) {</span>
<a href="#l10.4263"></a><span id="l10.4263">     mName = name;</span>
<a href="#l10.4264"></a><span id="l10.4264">     // old/new value doesn't matter here</span>
<a href="#l10.4265"></a><span id="l10.4265">     NotifyUnicharPropertyChanged(kName, name, name);</span>
<a href="#l10.4266"></a><span id="l10.4266">   }</span>
<a href="#l10.4267"></a><span id="l10.4267">   return NS_OK;</span>
<a href="#l10.4268"></a><span id="l10.4268"> }</span>
<a href="#l10.4269"></a><span id="l10.4269"> </span>
<a href="#l10.4270"></a><span id="l10.4270" class="difflineminus">-//For default, just return name</span>
<a href="#l10.4271"></a><span id="l10.4271" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetAbbreviatedName(nsAString&amp; aAbbreviatedName)</span>
<a href="#l10.4272"></a><span id="l10.4272" class="difflineminus">-{</span>
<a href="#l10.4273"></a><span id="l10.4273" class="difflineplus">+// For default, just return name</span>
<a href="#l10.4274"></a><span id="l10.4274" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetAbbreviatedName(nsAString &amp;aAbbreviatedName) {</span>
<a href="#l10.4275"></a><span id="l10.4275">   return GetName(aAbbreviatedName);</span>
<a href="#l10.4276"></a><span id="l10.4276"> }</span>
<a href="#l10.4277"></a><span id="l10.4277"> </span>
<a href="#l10.4278"></a><span id="l10.4278"> NS_IMETHODIMP</span>
<a href="#l10.4279"></a><span id="l10.4279" class="difflineminus">-nsMsgDBFolder::GetChildNamed(const nsAString&amp; aName, nsIMsgFolder **aChild)</span>
<a href="#l10.4280"></a><span id="l10.4280" class="difflineminus">-{</span>
<a href="#l10.4281"></a><span id="l10.4281" class="difflineplus">+nsMsgDBFolder::GetChildNamed(const nsAString &amp;aName, nsIMsgFolder **aChild) {</span>
<a href="#l10.4282"></a><span id="l10.4282">   NS_ENSURE_ARG_POINTER(aChild);</span>
<a href="#l10.4283"></a><span id="l10.4283">   nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l10.4284"></a><span id="l10.4284" class="difflineminus">-  GetSubFolders(getter_AddRefs(dummy)); // initialize mSubFolders</span>
<a href="#l10.4285"></a><span id="l10.4285" class="difflineplus">+  GetSubFolders(getter_AddRefs(dummy));  // initialize mSubFolders</span>
<a href="#l10.4286"></a><span id="l10.4286">   *aChild = nullptr;</span>
<a href="#l10.4287"></a><span id="l10.4287">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.4288"></a><span id="l10.4288"> </span>
<a href="#l10.4289"></a><span id="l10.4289" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.4290"></a><span id="l10.4290" class="difflineminus">-  {</span>
<a href="#l10.4291"></a><span id="l10.4291" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.4292"></a><span id="l10.4292">     nsString folderName;</span>
<a href="#l10.4293"></a><span id="l10.4293">     nsresult rv = mSubFolders[i]-&gt;GetName(folderName);</span>
<a href="#l10.4294"></a><span id="l10.4294">     // case-insensitive compare is probably LCD across OS filesystems</span>
<a href="#l10.4295"></a><span id="l10.4295">     if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l10.4296"></a><span id="l10.4296" class="difflineminus">-        folderName.Equals(aName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l10.4297"></a><span id="l10.4297" class="difflineminus">-    {</span>
<a href="#l10.4298"></a><span id="l10.4298" class="difflineplus">+        folderName.Equals(aName, nsCaseInsensitiveStringComparator())) {</span>
<a href="#l10.4299"></a><span id="l10.4299">       NS_ADDREF(*aChild = mSubFolders[i]);</span>
<a href="#l10.4300"></a><span id="l10.4300">       return NS_OK;</span>
<a href="#l10.4301"></a><span id="l10.4301">     }</span>
<a href="#l10.4302"></a><span id="l10.4302">   }</span>
<a href="#l10.4303"></a><span id="l10.4303">   // don't return NS_OK if we didn't find the folder</span>
<a href="#l10.4304"></a><span id="l10.4304">   // see http://bugzilla.mozilla.org/show_bug.cgi?id=210089#c15</span>
<a href="#l10.4305"></a><span id="l10.4305">   // and http://bugzilla.mozilla.org/show_bug.cgi?id=210089#c17</span>
<a href="#l10.4306"></a><span id="l10.4306">   return NS_ERROR_FAILURE;</span>
<a href="#l10.4307"></a><span id="l10.4307"> }</span>
<a href="#l10.4308"></a><span id="l10.4308"> </span>
<a href="#l10.4309"></a><span id="l10.4309" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetChildWithURI(const nsACString&amp; uri, bool deep, bool caseInsensitive, nsIMsgFolder ** child)</span>
<a href="#l10.4310"></a><span id="l10.4310" class="difflineminus">-{</span>
<a href="#l10.4311"></a><span id="l10.4311" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetChildWithURI(const nsACString &amp;uri, bool deep,</span>
<a href="#l10.4312"></a><span id="l10.4312" class="difflineplus">+                                             bool caseInsensitive,</span>
<a href="#l10.4313"></a><span id="l10.4313" class="difflineplus">+                                             nsIMsgFolder **child) {</span>
<a href="#l10.4314"></a><span id="l10.4314">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l10.4315"></a><span id="l10.4315">   // will return nullptr if we can't find it</span>
<a href="#l10.4316"></a><span id="l10.4316">   *child = nullptr;</span>
<a href="#l10.4317"></a><span id="l10.4317">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l10.4318"></a><span id="l10.4318">   nsresult rv = GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l10.4319"></a><span id="l10.4319" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.4320"></a><span id="l10.4320" class="difflineminus">-    return rv;</span>
<a href="#l10.4321"></a><span id="l10.4321" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4322"></a><span id="l10.4322"> </span>
<a href="#l10.4323"></a><span id="l10.4323">   bool hasMore;</span>
<a href="#l10.4324"></a><span id="l10.4324" class="difflineminus">-  while(NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l10.4325"></a><span id="l10.4325" class="difflineminus">-  {</span>
<a href="#l10.4326"></a><span id="l10.4326" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l10.4327"></a><span id="l10.4327">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l10.4328"></a><span id="l10.4328">     enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l10.4329"></a><span id="l10.4329"> </span>
<a href="#l10.4330"></a><span id="l10.4330">     nsCOMPtr&lt;nsIRDFResource&gt; folderResource(do_QueryInterface(item));</span>
<a href="#l10.4331"></a><span id="l10.4331">     nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l10.4332"></a><span id="l10.4332" class="difflineminus">-    if (folderResource &amp;&amp; folder)</span>
<a href="#l10.4333"></a><span id="l10.4333" class="difflineminus">-    {</span>
<a href="#l10.4334"></a><span id="l10.4334" class="difflineplus">+    if (folderResource &amp;&amp; folder) {</span>
<a href="#l10.4335"></a><span id="l10.4335">       const char *folderURI;</span>
<a href="#l10.4336"></a><span id="l10.4336">       rv = folderResource-&gt;GetValueConst(&amp;folderURI);</span>
<a href="#l10.4337"></a><span id="l10.4337">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4338"></a><span id="l10.4338" class="difflineminus">-      bool equal = folderURI &amp;&amp; (caseInsensitive ? uri.Equals(folderURI, nsCaseInsensitiveCStringComparator())</span>
<a href="#l10.4339"></a><span id="l10.4339" class="difflineminus">-                                                   : uri.Equals(folderURI));</span>
<a href="#l10.4340"></a><span id="l10.4340" class="difflineminus">-      if (equal)</span>
<a href="#l10.4341"></a><span id="l10.4341" class="difflineminus">-      {</span>
<a href="#l10.4342"></a><span id="l10.4342" class="difflineplus">+      bool equal =</span>
<a href="#l10.4343"></a><span id="l10.4343" class="difflineplus">+          folderURI &amp;&amp;</span>
<a href="#l10.4344"></a><span id="l10.4344" class="difflineplus">+          (caseInsensitive</span>
<a href="#l10.4345"></a><span id="l10.4345" class="difflineplus">+               ? uri.Equals(folderURI, nsCaseInsensitiveCStringComparator())</span>
<a href="#l10.4346"></a><span id="l10.4346" class="difflineplus">+               : uri.Equals(folderURI));</span>
<a href="#l10.4347"></a><span id="l10.4347" class="difflineplus">+      if (equal) {</span>
<a href="#l10.4348"></a><span id="l10.4348">         folder.forget(child);</span>
<a href="#l10.4349"></a><span id="l10.4349">         return NS_OK;</span>
<a href="#l10.4350"></a><span id="l10.4350">       }</span>
<a href="#l10.4351"></a><span id="l10.4351" class="difflineminus">-      if (deep)</span>
<a href="#l10.4352"></a><span id="l10.4352" class="difflineminus">-      {</span>
<a href="#l10.4353"></a><span id="l10.4353" class="difflineplus">+      if (deep) {</span>
<a href="#l10.4354"></a><span id="l10.4354">         rv = folder-&gt;GetChildWithURI(uri, deep, caseInsensitive, child);</span>
<a href="#l10.4355"></a><span id="l10.4355" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l10.4356"></a><span id="l10.4356" class="difflineminus">-          return rv;</span>
<a href="#l10.4357"></a><span id="l10.4357" class="difflineminus">-</span>
<a href="#l10.4358"></a><span id="l10.4358" class="difflineminus">-        if (*child)</span>
<a href="#l10.4359"></a><span id="l10.4359" class="difflineminus">-          return NS_OK;</span>
<a href="#l10.4360"></a><span id="l10.4360" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4361"></a><span id="l10.4361" class="difflineplus">+</span>
<a href="#l10.4362"></a><span id="l10.4362" class="difflineplus">+        if (*child) return NS_OK;</span>
<a href="#l10.4363"></a><span id="l10.4363">       }</span>
<a href="#l10.4364"></a><span id="l10.4364">     }</span>
<a href="#l10.4365"></a><span id="l10.4365">   }</span>
<a href="#l10.4366"></a><span id="l10.4366">   return NS_OK;</span>
<a href="#l10.4367"></a><span id="l10.4367"> }</span>
<a href="#l10.4368"></a><span id="l10.4368"> </span>
<a href="#l10.4369"></a><span id="l10.4369" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetShowDeletedMessages(bool *showDeletedMessages)</span>
<a href="#l10.4370"></a><span id="l10.4370" class="difflineminus">-{</span>
<a href="#l10.4371"></a><span id="l10.4371" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetShowDeletedMessages(bool *showDeletedMessages) {</span>
<a href="#l10.4372"></a><span id="l10.4372">   NS_ENSURE_ARG_POINTER(showDeletedMessages);</span>
<a href="#l10.4373"></a><span id="l10.4373">   *showDeletedMessages = false;</span>
<a href="#l10.4374"></a><span id="l10.4374">   return NS_OK;</span>
<a href="#l10.4375"></a><span id="l10.4375"> }</span>
<a href="#l10.4376"></a><span id="l10.4376"> </span>
<a href="#l10.4377"></a><span id="l10.4377" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::Delete()</span>
<a href="#l10.4378"></a><span id="l10.4378" class="difflineminus">-{</span>
<a href="#l10.4379"></a><span id="l10.4379" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::Delete() {</span>
<a href="#l10.4380"></a><span id="l10.4380">   ForceDBClosed();</span>
<a href="#l10.4381"></a><span id="l10.4381"> </span>
<a href="#l10.4382"></a><span id="l10.4382">   // Delete the .msf file.</span>
<a href="#l10.4383"></a><span id="l10.4383">   // NOTE: this doesn't remove .msf files in subfolders, but</span>
<a href="#l10.4384"></a><span id="l10.4384">   // both nsMsgBrkMBoxStore::DeleteFolder() and</span>
<a href="#l10.4385"></a><span id="l10.4385">   // nsMsgMaildirStore::DeleteFolder() will remove those .msf files</span>
<a href="#l10.4386"></a><span id="l10.4386">   // as a side-effect of deleting the .sbd directory.</span>
<a href="#l10.4387"></a><span id="l10.4387">   nsCOMPtr&lt;nsIFile&gt; summaryFile;</span>
<a href="#l10.4388"></a><span id="l10.4388" class="difflineat">@@ -3622,137 +3332,123 @@ NS_IMETHODIMP nsMsgDBFolder::Delete()</span>
<a href="#l10.4389"></a><span id="l10.4389">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l10.4390"></a><span id="l10.4390">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4391"></a><span id="l10.4391">   rv = msgStore-&gt;DeleteFolder(this);</span>
<a href="#l10.4392"></a><span id="l10.4392"> </span>
<a href="#l10.4393"></a><span id="l10.4393">   return rv;</span>
<a href="#l10.4394"></a><span id="l10.4394"> }</span>
<a href="#l10.4395"></a><span id="l10.4395"> </span>
<a href="#l10.4396"></a><span id="l10.4396"> NS_IMETHODIMP nsMsgDBFolder::DeleteSubFolders(nsIArray *folders,</span>
<a href="#l10.4397"></a><span id="l10.4397" class="difflineminus">-                                              nsIMsgWindow *msgWindow)</span>
<a href="#l10.4398"></a><span id="l10.4398" class="difflineminus">-{</span>
<a href="#l10.4399"></a><span id="l10.4399" class="difflineplus">+                                              nsIMsgWindow *msgWindow) {</span>
<a href="#l10.4400"></a><span id="l10.4400">   uint32_t count;</span>
<a href="#l10.4401"></a><span id="l10.4401">   nsresult rv = folders-&gt;GetLength(&amp;count);</span>
<a href="#l10.4402"></a><span id="l10.4402" class="difflineminus">-  for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.4403"></a><span id="l10.4403" class="difflineminus">-  {</span>
<a href="#l10.4404"></a><span id="l10.4404" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.4405"></a><span id="l10.4405">     nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryElementAt(folders, i, &amp;rv));</span>
<a href="#l10.4406"></a><span id="l10.4406" class="difflineminus">-    if (folder)</span>
<a href="#l10.4407"></a><span id="l10.4407" class="difflineminus">-      PropagateDelete(folder, true, msgWindow);</span>
<a href="#l10.4408"></a><span id="l10.4408" class="difflineplus">+    if (folder) PropagateDelete(folder, true, msgWindow);</span>
<a href="#l10.4409"></a><span id="l10.4409">   }</span>
<a href="#l10.4410"></a><span id="l10.4410">   return rv;</span>
<a href="#l10.4411"></a><span id="l10.4411"> }</span>
<a href="#l10.4412"></a><span id="l10.4412"> </span>
<a href="#l10.4413"></a><span id="l10.4413" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CreateStorageIfMissing(nsIUrlListener* /* urlListener */)</span>
<a href="#l10.4414"></a><span id="l10.4414" class="difflineminus">-{</span>
<a href="#l10.4415"></a><span id="l10.4415" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CreateStorageIfMissing(</span>
<a href="#l10.4416"></a><span id="l10.4416" class="difflineplus">+    nsIUrlListener * /* urlListener */) {</span>
<a href="#l10.4417"></a><span id="l10.4417">   NS_ASSERTION(false, &quot;needs to be overridden&quot;);</span>
<a href="#l10.4418"></a><span id="l10.4418">   return NS_OK;</span>
<a href="#l10.4419"></a><span id="l10.4419"> }</span>
<a href="#l10.4420"></a><span id="l10.4420"> </span>
<a href="#l10.4421"></a><span id="l10.4421" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::PropagateDelete(nsIMsgFolder *folder, bool deleteStorage, nsIMsgWindow *msgWindow)</span>
<a href="#l10.4422"></a><span id="l10.4422" class="difflineminus">-{</span>
<a href="#l10.4423"></a><span id="l10.4423" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::PropagateDelete(nsIMsgFolder *folder,</span>
<a href="#l10.4424"></a><span id="l10.4424" class="difflineplus">+                                             bool deleteStorage,</span>
<a href="#l10.4425"></a><span id="l10.4425" class="difflineplus">+                                             nsIMsgWindow *msgWindow) {</span>
<a href="#l10.4426"></a><span id="l10.4426">   // first, find the folder we're looking to delete</span>
<a href="#l10.4427"></a><span id="l10.4427">   nsresult rv = NS_OK;</span>
<a href="#l10.4428"></a><span id="l10.4428"> </span>
<a href="#l10.4429"></a><span id="l10.4429">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.4430"></a><span id="l10.4430" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.4431"></a><span id="l10.4431" class="difflineminus">-  {</span>
<a href="#l10.4432"></a><span id="l10.4432" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.4433"></a><span id="l10.4433">     nsCOMPtr&lt;nsIMsgFolder&gt; child(mSubFolders[i]);</span>
<a href="#l10.4434"></a><span id="l10.4434" class="difflineminus">-    if (folder == child.get())</span>
<a href="#l10.4435"></a><span id="l10.4435" class="difflineminus">-    {</span>
<a href="#l10.4436"></a><span id="l10.4436" class="difflineplus">+    if (folder == child.get()) {</span>
<a href="#l10.4437"></a><span id="l10.4437">       // Remove self as parent</span>
<a href="#l10.4438"></a><span id="l10.4438">       child-&gt;SetParent(nullptr);</span>
<a href="#l10.4439"></a><span id="l10.4439">       // maybe delete disk storage for it, and its subfolders</span>
<a href="#l10.4440"></a><span id="l10.4440">       rv = child-&gt;RecursiveDelete(deleteStorage, msgWindow);</span>
<a href="#l10.4441"></a><span id="l10.4441" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l10.4442"></a><span id="l10.4442" class="difflineminus">-      {</span>
<a href="#l10.4443"></a><span id="l10.4443" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.4444"></a><span id="l10.4444">         // Remove from list of subfolders.</span>
<a href="#l10.4445"></a><span id="l10.4445">         mSubFolders.RemoveObjectAt(i);</span>
<a href="#l10.4446"></a><span id="l10.4446">         NotifyItemRemoved(child);</span>
<a href="#l10.4447"></a><span id="l10.4447">         break;</span>
<a href="#l10.4448"></a><span id="l10.4448" class="difflineminus">-      }</span>
<a href="#l10.4449"></a><span id="l10.4449" class="difflineminus">-      else // setting parent back if we failed</span>
<a href="#l10.4450"></a><span id="l10.4450" class="difflineplus">+      } else  // setting parent back if we failed</span>
<a href="#l10.4451"></a><span id="l10.4451">         child-&gt;SetParent(this);</span>
<a href="#l10.4452"></a><span id="l10.4452" class="difflineminus">-    }</span>
<a href="#l10.4453"></a><span id="l10.4453" class="difflineminus">-    else</span>
<a href="#l10.4454"></a><span id="l10.4454" class="difflineplus">+    } else</span>
<a href="#l10.4455"></a><span id="l10.4455">       rv = child-&gt;PropagateDelete(folder, deleteStorage, msgWindow);</span>
<a href="#l10.4456"></a><span id="l10.4456">   }</span>
<a href="#l10.4457"></a><span id="l10.4457"> </span>
<a href="#l10.4458"></a><span id="l10.4458">   return rv;</span>
<a href="#l10.4459"></a><span id="l10.4459"> }</span>
<a href="#l10.4460"></a><span id="l10.4460"> </span>
<a href="#l10.4461"></a><span id="l10.4461" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::RecursiveDelete(bool deleteStorage, nsIMsgWindow *msgWindow)</span>
<a href="#l10.4462"></a><span id="l10.4462" class="difflineminus">-{</span>
<a href="#l10.4463"></a><span id="l10.4463" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::RecursiveDelete(bool deleteStorage,</span>
<a href="#l10.4464"></a><span id="l10.4464" class="difflineplus">+                                             nsIMsgWindow *msgWindow) {</span>
<a href="#l10.4465"></a><span id="l10.4465">   // If deleteStorage is true, recursively deletes disk storage for this folder</span>
<a href="#l10.4466"></a><span id="l10.4466">   // and all its subfolders.</span>
<a href="#l10.4467"></a><span id="l10.4467" class="difflineminus">-  // Regardless of deleteStorage, always unlinks them from the children lists and</span>
<a href="#l10.4468"></a><span id="l10.4468" class="difflineminus">-  // frees memory for the subfolders but NOT for _this_</span>
<a href="#l10.4469"></a><span id="l10.4469" class="difflineplus">+  // Regardless of deleteStorage, always unlinks them from the children lists</span>
<a href="#l10.4470"></a><span id="l10.4470" class="difflineplus">+  // and frees memory for the subfolders but NOT for _this_</span>
<a href="#l10.4471"></a><span id="l10.4471"> </span>
<a href="#l10.4472"></a><span id="l10.4472">   nsresult status = NS_OK;</span>
<a href="#l10.4473"></a><span id="l10.4473" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; dbPath;</span>
<a href="#l10.4474"></a><span id="l10.4474" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l10.4475"></a><span id="l10.4475"> </span>
<a href="#l10.4476"></a><span id="l10.4476">   // first remove the deleted folder from the folder cache;</span>
<a href="#l10.4477"></a><span id="l10.4477">   nsresult result = GetFolderCacheKey(getter_AddRefs(dbPath));</span>
<a href="#l10.4478"></a><span id="l10.4478"> </span>
<a href="#l10.4479"></a><span id="l10.4479">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l10.4480"></a><span id="l10.4480" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;result);</span>
<a href="#l10.4481"></a><span id="l10.4481" class="difflineminus">-  if(NS_SUCCEEDED(result))</span>
<a href="#l10.4482"></a><span id="l10.4482" class="difflineminus">-  {</span>
<a href="#l10.4483"></a><span id="l10.4483" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolderCache&gt; folderCache;</span>
<a href="#l10.4484"></a><span id="l10.4484" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;result);</span>
<a href="#l10.4485"></a><span id="l10.4485" class="difflineplus">+  if (NS_SUCCEEDED(result)) {</span>
<a href="#l10.4486"></a><span id="l10.4486" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderCache&gt; folderCache;</span>
<a href="#l10.4487"></a><span id="l10.4487">     result = accountMgr-&gt;GetFolderCache(getter_AddRefs(folderCache));</span>
<a href="#l10.4488"></a><span id="l10.4488" class="difflineminus">-    if (NS_SUCCEEDED(result) &amp;&amp; folderCache)</span>
<a href="#l10.4489"></a><span id="l10.4489" class="difflineminus">-    {</span>
<a href="#l10.4490"></a><span id="l10.4490" class="difflineplus">+    if (NS_SUCCEEDED(result) &amp;&amp; folderCache) {</span>
<a href="#l10.4491"></a><span id="l10.4491">       nsCString persistentPath;</span>
<a href="#l10.4492"></a><span id="l10.4492">       result = dbPath-&gt;GetPersistentDescriptor(persistentPath);</span>
<a href="#l10.4493"></a><span id="l10.4493" class="difflineminus">-      if (NS_SUCCEEDED(result))</span>
<a href="#l10.4494"></a><span id="l10.4494" class="difflineminus">-        folderCache-&gt;RemoveElement(persistentPath);</span>
<a href="#l10.4495"></a><span id="l10.4495" class="difflineplus">+      if (NS_SUCCEEDED(result)) folderCache-&gt;RemoveElement(persistentPath);</span>
<a href="#l10.4496"></a><span id="l10.4496">     }</span>
<a href="#l10.4497"></a><span id="l10.4497">   }</span>
<a href="#l10.4498"></a><span id="l10.4498"> </span>
<a href="#l10.4499"></a><span id="l10.4499">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.4500"></a><span id="l10.4500" class="difflineminus">-  while (count &gt; 0)</span>
<a href="#l10.4501"></a><span id="l10.4501" class="difflineminus">-  {</span>
<a href="#l10.4502"></a><span id="l10.4502" class="difflineplus">+  while (count &gt; 0) {</span>
<a href="#l10.4503"></a><span id="l10.4503">     nsIMsgFolder *child = mSubFolders[0];</span>
<a href="#l10.4504"></a><span id="l10.4504"> </span>
<a href="#l10.4505"></a><span id="l10.4505">     child-&gt;SetParent(nullptr);</span>
<a href="#l10.4506"></a><span id="l10.4506">     status = child-&gt;RecursiveDelete(deleteStorage, msgWindow);  // recur</span>
<a href="#l10.4507"></a><span id="l10.4507">     if (NS_SUCCEEDED(status))</span>
<a href="#l10.4508"></a><span id="l10.4508">       // unlink it from this child's list</span>
<a href="#l10.4509"></a><span id="l10.4509">       mSubFolders.RemoveObjectAt(0);</span>
<a href="#l10.4510"></a><span id="l10.4510" class="difflineminus">-    else</span>
<a href="#l10.4511"></a><span id="l10.4511" class="difflineminus">-    {</span>
<a href="#l10.4512"></a><span id="l10.4512" class="difflineplus">+    else {</span>
<a href="#l10.4513"></a><span id="l10.4513">       // setting parent back if we failed for some reason</span>
<a href="#l10.4514"></a><span id="l10.4514">       child-&gt;SetParent(this);</span>
<a href="#l10.4515"></a><span id="l10.4515">       break;</span>
<a href="#l10.4516"></a><span id="l10.4516">     }</span>
<a href="#l10.4517"></a><span id="l10.4517"> </span>
<a href="#l10.4518"></a><span id="l10.4518">     count--;</span>
<a href="#l10.4519"></a><span id="l10.4519">   }</span>
<a href="#l10.4520"></a><span id="l10.4520"> </span>
<a href="#l10.4521"></a><span id="l10.4521">   // now delete the disk storage for _this_</span>
<a href="#l10.4522"></a><span id="l10.4522" class="difflineminus">-  if (deleteStorage &amp;&amp; NS_SUCCEEDED(status))</span>
<a href="#l10.4523"></a><span id="l10.4523" class="difflineminus">-  {</span>
<a href="#l10.4524"></a><span id="l10.4524" class="difflineplus">+  if (deleteStorage &amp;&amp; NS_SUCCEEDED(status)) {</span>
<a href="#l10.4525"></a><span id="l10.4525">     // All delete commands use deleteStorage = true, and local moves use false.</span>
<a href="#l10.4526"></a><span id="l10.4526">     // IMAP moves use true, leaving this here in the hope that bug 439108</span>
<a href="#l10.4527"></a><span id="l10.4527">     // works out.</span>
<a href="#l10.4528"></a><span id="l10.4528" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l10.4529"></a><span id="l10.4529" class="difflineminus">-    if (notifier)</span>
<a href="#l10.4530"></a><span id="l10.4530" class="difflineminus">-      notifier-&gt;NotifyFolderDeleted(this);</span>
<a href="#l10.4531"></a><span id="l10.4531" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l10.4532"></a><span id="l10.4532" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l10.4533"></a><span id="l10.4533" class="difflineplus">+    if (notifier) notifier-&gt;NotifyFolderDeleted(this);</span>
<a href="#l10.4534"></a><span id="l10.4534">     status = Delete();</span>
<a href="#l10.4535"></a><span id="l10.4535">   }</span>
<a href="#l10.4536"></a><span id="l10.4536">   return status;</span>
<a href="#l10.4537"></a><span id="l10.4537"> }</span>
<a href="#l10.4538"></a><span id="l10.4538"> </span>
<a href="#l10.4539"></a><span id="l10.4539" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CreateSubfolder(const nsAString&amp; folderName, nsIMsgWindow *msgWindow)</span>
<a href="#l10.4540"></a><span id="l10.4540" class="difflineminus">-{</span>
<a href="#l10.4541"></a><span id="l10.4541" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CreateSubfolder(const nsAString &amp;folderName,</span>
<a href="#l10.4542"></a><span id="l10.4542" class="difflineplus">+                                             nsIMsgWindow *msgWindow) {</span>
<a href="#l10.4543"></a><span id="l10.4543">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.4544"></a><span id="l10.4544"> }</span>
<a href="#l10.4545"></a><span id="l10.4545"> </span>
<a href="#l10.4546"></a><span id="l10.4546" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::AddSubfolder(const nsAString&amp; name,</span>
<a href="#l10.4547"></a><span id="l10.4547" class="difflineminus">-                                          nsIMsgFolder** child)</span>
<a href="#l10.4548"></a><span id="l10.4548" class="difflineminus">-{</span>
<a href="#l10.4549"></a><span id="l10.4549" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AddSubfolder(const nsAString &amp;name,</span>
<a href="#l10.4550"></a><span id="l10.4550" class="difflineplus">+                                          nsIMsgFolder **child) {</span>
<a href="#l10.4551"></a><span id="l10.4551">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l10.4552"></a><span id="l10.4552"> </span>
<a href="#l10.4553"></a><span id="l10.4553">   int32_t flags = 0;</span>
<a href="#l10.4554"></a><span id="l10.4554">   nsresult rv;</span>
<a href="#l10.4555"></a><span id="l10.4555"> </span>
<a href="#l10.4556"></a><span id="l10.4556">   nsAutoCString uri(mURI);</span>
<a href="#l10.4557"></a><span id="l10.4557">   uri.Append('/');</span>
<a href="#l10.4558"></a><span id="l10.4558"> </span>
<a href="#l10.4559"></a><span id="l10.4559" class="difflineat">@@ -3761,999 +3457,898 @@ NS_IMETHODIMP nsMsgDBFolder::AddSubfolde</span>
<a href="#l10.4560"></a><span id="l10.4560">   nsAutoCString escapedName;</span>
<a href="#l10.4561"></a><span id="l10.4561">   rv = NS_MsgEscapeEncodeURLPath(name, escapedName);</span>
<a href="#l10.4562"></a><span id="l10.4562">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4563"></a><span id="l10.4563"> </span>
<a href="#l10.4564"></a><span id="l10.4564">   // fix for #192780</span>
<a href="#l10.4565"></a><span id="l10.4565">   // if this is the root folder</span>
<a href="#l10.4566"></a><span id="l10.4566">   // make sure the the special folders</span>
<a href="#l10.4567"></a><span id="l10.4567">   // have the right uri.</span>
<a href="#l10.4568"></a><span id="l10.4568" class="difflineminus">-  // on disk, host\INBOX should be a folder with the uri mailbox://user@host/Inbox&quot;</span>
<a href="#l10.4569"></a><span id="l10.4569" class="difflineminus">-  // as mailbox://user@host/Inbox != mailbox://user@host/INBOX</span>
<a href="#l10.4570"></a><span id="l10.4570" class="difflineplus">+  // on disk, host\INBOX should be a folder with the uri</span>
<a href="#l10.4571"></a><span id="l10.4571" class="difflineplus">+  // mailbox://user@host/Inbox&quot; as mailbox://user@host/Inbox !=</span>
<a href="#l10.4572"></a><span id="l10.4572" class="difflineplus">+  // mailbox://user@host/INBOX</span>
<a href="#l10.4573"></a><span id="l10.4573">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l10.4574"></a><span id="l10.4574">   rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l10.4575"></a><span id="l10.4575" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder &amp;&amp; (rootFolder.get() == (nsIMsgFolder *)this))</span>
<a href="#l10.4576"></a><span id="l10.4576" class="difflineminus">-  {</span>
<a href="#l10.4577"></a><span id="l10.4577" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder &amp;&amp;</span>
<a href="#l10.4578"></a><span id="l10.4578" class="difflineplus">+      (rootFolder.get() == (nsIMsgFolder *)this)) {</span>
<a href="#l10.4579"></a><span id="l10.4579">     if (MsgLowerCaseEqualsLiteral(escapedName, &quot;inbox&quot;))</span>
<a href="#l10.4580"></a><span id="l10.4580">       uri += &quot;Inbox&quot;;</span>
<a href="#l10.4581"></a><span id="l10.4581">     else if (MsgLowerCaseEqualsLiteral(escapedName, &quot;unsent%20messages&quot;))</span>
<a href="#l10.4582"></a><span id="l10.4582">       uri += &quot;Unsent%20Messages&quot;;</span>
<a href="#l10.4583"></a><span id="l10.4583">     else if (MsgLowerCaseEqualsLiteral(escapedName, &quot;drafts&quot;))</span>
<a href="#l10.4584"></a><span id="l10.4584">       uri += &quot;Drafts&quot;;</span>
<a href="#l10.4585"></a><span id="l10.4585">     else if (MsgLowerCaseEqualsLiteral(escapedName, &quot;trash&quot;))</span>
<a href="#l10.4586"></a><span id="l10.4586">       uri += &quot;Trash&quot;;</span>
<a href="#l10.4587"></a><span id="l10.4587">     else if (MsgLowerCaseEqualsLiteral(escapedName, &quot;sent&quot;))</span>
<a href="#l10.4588"></a><span id="l10.4588">       uri += &quot;Sent&quot;;</span>
<a href="#l10.4589"></a><span id="l10.4589">     else if (MsgLowerCaseEqualsLiteral(escapedName, &quot;templates&quot;))</span>
<a href="#l10.4590"></a><span id="l10.4590" class="difflineminus">-      uri +=&quot;Templates&quot;;</span>
<a href="#l10.4591"></a><span id="l10.4591" class="difflineplus">+      uri += &quot;Templates&quot;;</span>
<a href="#l10.4592"></a><span id="l10.4592">     else if (MsgLowerCaseEqualsLiteral(escapedName, &quot;archives&quot;))</span>
<a href="#l10.4593"></a><span id="l10.4593">       uri += &quot;Archives&quot;;</span>
<a href="#l10.4594"></a><span id="l10.4594">     else</span>
<a href="#l10.4595"></a><span id="l10.4595">       uri += escapedName.get();</span>
<a href="#l10.4596"></a><span id="l10.4596" class="difflineminus">-  }</span>
<a href="#l10.4597"></a><span id="l10.4597" class="difflineminus">-  else</span>
<a href="#l10.4598"></a><span id="l10.4598" class="difflineplus">+  } else</span>
<a href="#l10.4599"></a><span id="l10.4599">     uri += escapedName.get();</span>
<a href="#l10.4600"></a><span id="l10.4600"> </span>
<a href="#l10.4601"></a><span id="l10.4601" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l10.4602"></a><span id="l10.4602" class="difflineminus">-  rv = GetChildWithURI(uri, false/*deep*/, true /*case Insensitive*/, getter_AddRefs(msgFolder));</span>
<a href="#l10.4603"></a><span id="l10.4603" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l10.4604"></a><span id="l10.4604" class="difflineminus">-    return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l10.4605"></a><span id="l10.4605" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l10.4606"></a><span id="l10.4606" class="difflineplus">+  rv = GetChildWithURI(uri, false /*deep*/, true /*case Insensitive*/,</span>
<a href="#l10.4607"></a><span id="l10.4607" class="difflineplus">+                       getter_AddRefs(msgFolder));</span>
<a href="#l10.4608"></a><span id="l10.4608" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder) return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l10.4609"></a><span id="l10.4609"> </span>
<a href="#l10.4610"></a><span id="l10.4610">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.4611"></a><span id="l10.4611">   rv = GetOrCreateFolder(uri, getter_AddRefs(folder));</span>
<a href="#l10.4612"></a><span id="l10.4612">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4613"></a><span id="l10.4613"> </span>
<a href="#l10.4614"></a><span id="l10.4614">   folder-&gt;GetFlags((uint32_t *)&amp;flags);</span>
<a href="#l10.4615"></a><span id="l10.4615">   flags |= nsMsgFolderFlags::Mail;</span>
<a href="#l10.4616"></a><span id="l10.4616">   folder-&gt;SetParent(this);</span>
<a href="#l10.4617"></a><span id="l10.4617"> </span>
<a href="#l10.4618"></a><span id="l10.4618">   bool isServer;</span>
<a href="#l10.4619"></a><span id="l10.4619">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l10.4620"></a><span id="l10.4620"> </span>
<a href="#l10.4621"></a><span id="l10.4621" class="difflineminus">-  //Only set these if these are top level children.</span>
<a href="#l10.4622"></a><span id="l10.4622" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l10.4623"></a><span id="l10.4623" class="difflineminus">-  {</span>
<a href="#l10.4624"></a><span id="l10.4624" class="difflineminus">-    if(name.LowerCaseEqualsLiteral(&quot;inbox&quot;))</span>
<a href="#l10.4625"></a><span id="l10.4625" class="difflineminus">-    {</span>
<a href="#l10.4626"></a><span id="l10.4626" class="difflineplus">+  // Only set these if these are top level children.</span>
<a href="#l10.4627"></a><span id="l10.4627" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; isServer) {</span>
<a href="#l10.4628"></a><span id="l10.4628" class="difflineplus">+    if (name.LowerCaseEqualsLiteral(&quot;inbox&quot;)) {</span>
<a href="#l10.4629"></a><span id="l10.4629">       flags |= nsMsgFolderFlags::Inbox;</span>
<a href="#l10.4630"></a><span id="l10.4630">       SetBiffState(nsIMsgFolder::nsMsgBiffState_Unknown);</span>
<a href="#l10.4631"></a><span id="l10.4631" class="difflineminus">-    }</span>
<a href="#l10.4632"></a><span id="l10.4632" class="difflineminus">-    else if (name.LowerCaseEqualsLiteral(&quot;trash&quot;))</span>
<a href="#l10.4633"></a><span id="l10.4633" class="difflineplus">+    } else if (name.LowerCaseEqualsLiteral(&quot;trash&quot;))</span>
<a href="#l10.4634"></a><span id="l10.4634">       flags |= nsMsgFolderFlags::Trash;</span>
<a href="#l10.4635"></a><span id="l10.4635">     else if (name.LowerCaseEqualsLiteral(&quot;unsent messages&quot;) ||</span>
<a href="#l10.4636"></a><span id="l10.4636" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;outbox&quot;))</span>
<a href="#l10.4637"></a><span id="l10.4637" class="difflineplus">+             name.LowerCaseEqualsLiteral(&quot;outbox&quot;))</span>
<a href="#l10.4638"></a><span id="l10.4638">       flags |= nsMsgFolderFlags::Queue;</span>
<a href="#l10.4639"></a><span id="l10.4639">   }</span>
<a href="#l10.4640"></a><span id="l10.4640"> </span>
<a href="#l10.4641"></a><span id="l10.4641">   folder-&gt;SetFlags(flags);</span>
<a href="#l10.4642"></a><span id="l10.4642"> </span>
<a href="#l10.4643"></a><span id="l10.4643" class="difflineminus">-  if (folder)</span>
<a href="#l10.4644"></a><span id="l10.4644" class="difflineminus">-    mSubFolders.AppendObject(folder);</span>
<a href="#l10.4645"></a><span id="l10.4645" class="difflineplus">+  if (folder) mSubFolders.AppendObject(folder);</span>
<a href="#l10.4646"></a><span id="l10.4646"> </span>
<a href="#l10.4647"></a><span id="l10.4647">   folder.forget(child);</span>
<a href="#l10.4648"></a><span id="l10.4648">   // at this point we must be ok and we don't want to return failure in case</span>
<a href="#l10.4649"></a><span id="l10.4649">   // GetIsServer failed.</span>
<a href="#l10.4650"></a><span id="l10.4650">   return NS_OK;</span>
<a href="#l10.4651"></a><span id="l10.4651"> }</span>
<a href="#l10.4652"></a><span id="l10.4652"> </span>
<a href="#l10.4653"></a><span id="l10.4653" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.4654"></a><span id="l10.4654" class="difflineminus">-{</span>
<a href="#l10.4655"></a><span id="l10.4655" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::Compact(nsIUrlListener *aListener,</span>
<a href="#l10.4656"></a><span id="l10.4656" class="difflineplus">+                                     nsIMsgWindow *aMsgWindow) {</span>
<a href="#l10.4657"></a><span id="l10.4657">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.4658"></a><span id="l10.4658"> }</span>
<a href="#l10.4659"></a><span id="l10.4659"> </span>
<a href="#l10.4660"></a><span id="l10.4660" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CompactAll(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow, bool aCompactOfflineAlso)</span>
<a href="#l10.4661"></a><span id="l10.4661" class="difflineminus">-{</span>
<a href="#l10.4662"></a><span id="l10.4662" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CompactAll(nsIUrlListener *aListener,</span>
<a href="#l10.4663"></a><span id="l10.4663" class="difflineplus">+                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.4664"></a><span id="l10.4664" class="difflineplus">+                                        bool aCompactOfflineAlso) {</span>
<a href="#l10.4665"></a><span id="l10.4665">   NS_ASSERTION(false, &quot;should be overridden by child class&quot;);</span>
<a href="#l10.4666"></a><span id="l10.4666">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.4667"></a><span id="l10.4667"> }</span>
<a href="#l10.4668"></a><span id="l10.4668"> </span>
<a href="#l10.4669"></a><span id="l10.4669" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::EmptyTrash(nsIMsgWindow *msgWindow, nsIUrlListener *aListener)</span>
<a href="#l10.4670"></a><span id="l10.4670" class="difflineminus">-{</span>
<a href="#l10.4671"></a><span id="l10.4671" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::EmptyTrash(nsIMsgWindow *msgWindow,</span>
<a href="#l10.4672"></a><span id="l10.4672" class="difflineplus">+                                        nsIUrlListener *aListener) {</span>
<a href="#l10.4673"></a><span id="l10.4673">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.4674"></a><span id="l10.4674"> }</span>
<a href="#l10.4675"></a><span id="l10.4675"> </span>
<a href="#l10.4676"></a><span id="l10.4676" class="difflineminus">-nsresult</span>
<a href="#l10.4677"></a><span id="l10.4677" class="difflineminus">-nsMsgDBFolder::CheckIfFolderExists(const nsAString&amp; newFolderName, nsIMsgFolder *parentFolder, nsIMsgWindow *msgWindow)</span>
<a href="#l10.4678"></a><span id="l10.4678" class="difflineminus">-{</span>
<a href="#l10.4679"></a><span id="l10.4679" class="difflineplus">+nsresult nsMsgDBFolder::CheckIfFolderExists(const nsAString &amp;newFolderName,</span>
<a href="#l10.4680"></a><span id="l10.4680" class="difflineplus">+                                            nsIMsgFolder *parentFolder,</span>
<a href="#l10.4681"></a><span id="l10.4681" class="difflineplus">+                                            nsIMsgWindow *msgWindow) {</span>
<a href="#l10.4682"></a><span id="l10.4682">   NS_ENSURE_ARG_POINTER(parentFolder);</span>
<a href="#l10.4683"></a><span id="l10.4683">   nsCOMPtr&lt;nsISimpleEnumerator&gt; subFolders;</span>
<a href="#l10.4684"></a><span id="l10.4684">   nsresult rv = parentFolder-&gt;GetSubFolders(getter_AddRefs(subFolders));</span>
<a href="#l10.4685"></a><span id="l10.4685">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4686"></a><span id="l10.4686"> </span>
<a href="#l10.4687"></a><span id="l10.4687">   bool hasMore;</span>
<a href="#l10.4688"></a><span id="l10.4688" class="difflineminus">-  while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l10.4689"></a><span id="l10.4689" class="difflineminus">-  {</span>
<a href="#l10.4690"></a><span id="l10.4690" class="difflineplus">+  while (NS_SUCCEEDED(subFolders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l10.4691"></a><span id="l10.4691">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l10.4692"></a><span id="l10.4692">     rv = subFolders-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l10.4693"></a><span id="l10.4693"> </span>
<a href="#l10.4694"></a><span id="l10.4694">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryInterface(item));</span>
<a href="#l10.4695"></a><span id="l10.4695" class="difflineminus">-    if (!msgFolder)</span>
<a href="#l10.4696"></a><span id="l10.4696" class="difflineminus">-      break;</span>
<a href="#l10.4697"></a><span id="l10.4697" class="difflineplus">+    if (!msgFolder) break;</span>
<a href="#l10.4698"></a><span id="l10.4698"> </span>
<a href="#l10.4699"></a><span id="l10.4699">     nsString folderName;</span>
<a href="#l10.4700"></a><span id="l10.4700"> </span>
<a href="#l10.4701"></a><span id="l10.4701">     msgFolder-&gt;GetName(folderName);</span>
<a href="#l10.4702"></a><span id="l10.4702" class="difflineminus">-    if (folderName.Equals(newFolderName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l10.4703"></a><span id="l10.4703" class="difflineminus">-    {</span>
<a href="#l10.4704"></a><span id="l10.4704" class="difflineplus">+    if (folderName.Equals(newFolderName, nsCaseInsensitiveStringComparator())) {</span>
<a href="#l10.4705"></a><span id="l10.4705">       ThrowAlertMsg(&quot;folderExists&quot;, msgWindow);</span>
<a href="#l10.4706"></a><span id="l10.4706">       return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l10.4707"></a><span id="l10.4707">     }</span>
<a href="#l10.4708"></a><span id="l10.4708">   }</span>
<a href="#l10.4709"></a><span id="l10.4709">   return NS_OK;</span>
<a href="#l10.4710"></a><span id="l10.4710"> }</span>
<a href="#l10.4711"></a><span id="l10.4711"> </span>
<a href="#l10.4712"></a><span id="l10.4712" class="difflineminus">-bool</span>
<a href="#l10.4713"></a><span id="l10.4713" class="difflineminus">-nsMsgDBFolder::ConfirmAutoFolderRename(nsIMsgWindow *msgWindow,</span>
<a href="#l10.4714"></a><span id="l10.4714" class="difflineminus">-                                       const nsString&amp; aOldName,</span>
<a href="#l10.4715"></a><span id="l10.4715" class="difflineminus">-                                       const nsString&amp; aNewName)</span>
<a href="#l10.4716"></a><span id="l10.4716" class="difflineminus">-{</span>
<a href="#l10.4717"></a><span id="l10.4717" class="difflineplus">+bool nsMsgDBFolder::ConfirmAutoFolderRename(nsIMsgWindow *msgWindow,</span>
<a href="#l10.4718"></a><span id="l10.4718" class="difflineplus">+                                            const nsString &amp;aOldName,</span>
<a href="#l10.4719"></a><span id="l10.4719" class="difflineplus">+                                            const nsString &amp;aNewName) {</span>
<a href="#l10.4720"></a><span id="l10.4720">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.4721"></a><span id="l10.4721">   nsresult rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l10.4722"></a><span id="l10.4722">   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<a href="#l10.4723"></a><span id="l10.4723">     return false;</span>
<a href="#l10.4724"></a><span id="l10.4724">   }</span>
<a href="#l10.4725"></a><span id="l10.4725"> </span>
<a href="#l10.4726"></a><span id="l10.4726">   nsString folderName;</span>
<a href="#l10.4727"></a><span id="l10.4727">   GetName(folderName);</span>
<a href="#l10.4728"></a><span id="l10.4728" class="difflineminus">-  const char16_t *formatStrings[] =</span>
<a href="#l10.4729"></a><span id="l10.4729" class="difflineminus">-  {</span>
<a href="#l10.4730"></a><span id="l10.4730" class="difflineminus">-    aOldName.get(),</span>
<a href="#l10.4731"></a><span id="l10.4731" class="difflineminus">-    folderName.get(),</span>
<a href="#l10.4732"></a><span id="l10.4732" class="difflineminus">-    aNewName.get()</span>
<a href="#l10.4733"></a><span id="l10.4733" class="difflineminus">-  };</span>
<a href="#l10.4734"></a><span id="l10.4734" class="difflineplus">+  const char16_t *formatStrings[] = {aOldName.get(), folderName.get(),</span>
<a href="#l10.4735"></a><span id="l10.4735" class="difflineplus">+                                     aNewName.get()};</span>
<a href="#l10.4736"></a><span id="l10.4736"> </span>
<a href="#l10.4737"></a><span id="l10.4737">   nsString confirmString;</span>
<a href="#l10.4738"></a><span id="l10.4738">   rv = bundle-&gt;FormatStringFromName(&quot;confirmDuplicateFolderRename&quot;,</span>
<a href="#l10.4739"></a><span id="l10.4739">                                     formatStrings, 3, confirmString);</span>
<a href="#l10.4740"></a><span id="l10.4740">   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<a href="#l10.4741"></a><span id="l10.4741">     return false;</span>
<a href="#l10.4742"></a><span id="l10.4742">   }</span>
<a href="#l10.4743"></a><span id="l10.4743"> </span>
<a href="#l10.4744"></a><span id="l10.4744">   bool confirmed = false;</span>
<a href="#l10.4745"></a><span id="l10.4745">   rv = ThrowConfirmationPrompt(msgWindow, confirmString, &amp;confirmed);</span>
<a href="#l10.4746"></a><span id="l10.4746">   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<a href="#l10.4747"></a><span id="l10.4747">     return false;</span>
<a href="#l10.4748"></a><span id="l10.4748">   }</span>
<a href="#l10.4749"></a><span id="l10.4749">   return confirmed;</span>
<a href="#l10.4750"></a><span id="l10.4750"> }</span>
<a href="#l10.4751"></a><span id="l10.4751"> </span>
<a href="#l10.4752"></a><span id="l10.4752" class="difflineminus">-nsresult</span>
<a href="#l10.4753"></a><span id="l10.4753" class="difflineminus">-nsMsgDBFolder::AddDirectorySeparator(nsIFile *path)</span>
<a href="#l10.4754"></a><span id="l10.4754" class="difflineminus">-{</span>
<a href="#l10.4755"></a><span id="l10.4755" class="difflineplus">+nsresult nsMsgDBFolder::AddDirectorySeparator(nsIFile *path) {</span>
<a href="#l10.4756"></a><span id="l10.4756">   nsAutoString leafName;</span>
<a href="#l10.4757"></a><span id="l10.4757">   path-&gt;GetLeafName(leafName);</span>
<a href="#l10.4758"></a><span id="l10.4758">   leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l10.4759"></a><span id="l10.4759">   return path-&gt;SetLeafName(leafName);</span>
<a href="#l10.4760"></a><span id="l10.4760"> }</span>
<a href="#l10.4761"></a><span id="l10.4761"> </span>
<a href="#l10.4762"></a><span id="l10.4762"> /* Finds the directory associated with this folder.  That is if the path is</span>
<a href="#l10.4763"></a><span id="l10.4763">    c:\Inbox, it will return c:\Inbox.sbd if it succeeds.  If that path doesn't</span>
<a href="#l10.4764"></a><span id="l10.4764">    currently exist then it will create it. Path is strictly an out parameter.</span>
<a href="#l10.4765"></a><span id="l10.4765">   */</span>
<a href="#l10.4766"></a><span id="l10.4766" class="difflineminus">-nsresult nsMsgDBFolder::CreateDirectoryForFolder(nsIFile **resultFile)</span>
<a href="#l10.4767"></a><span id="l10.4767" class="difflineminus">-{</span>
<a href="#l10.4768"></a><span id="l10.4768" class="difflineplus">+nsresult nsMsgDBFolder::CreateDirectoryForFolder(nsIFile **resultFile) {</span>
<a href="#l10.4769"></a><span id="l10.4769">   nsresult rv = NS_OK;</span>
<a href="#l10.4770"></a><span id="l10.4770"> </span>
<a href="#l10.4771"></a><span id="l10.4771">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l10.4772"></a><span id="l10.4772">   rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l10.4773"></a><span id="l10.4773">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4774"></a><span id="l10.4774"> </span>
<a href="#l10.4775"></a><span id="l10.4775">   bool pathIsDirectory = false;</span>
<a href="#l10.4776"></a><span id="l10.4776">   path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l10.4777"></a><span id="l10.4777"> </span>
<a href="#l10.4778"></a><span id="l10.4778">   bool isServer;</span>
<a href="#l10.4779"></a><span id="l10.4779">   GetIsServer(&amp;isServer);</span>
<a href="#l10.4780"></a><span id="l10.4780"> </span>
<a href="#l10.4781"></a><span id="l10.4781">   // Make sure this is REALLY the parent for subdirectories</span>
<a href="#l10.4782"></a><span id="l10.4782" class="difflineminus">-  if (pathIsDirectory &amp;&amp; !isServer)</span>
<a href="#l10.4783"></a><span id="l10.4783" class="difflineminus">-  {</span>
<a href="#l10.4784"></a><span id="l10.4784" class="difflineplus">+  if (pathIsDirectory &amp;&amp; !isServer) {</span>
<a href="#l10.4785"></a><span id="l10.4785">     nsAutoString leafName;</span>
<a href="#l10.4786"></a><span id="l10.4786">     path-&gt;GetLeafName(leafName);</span>
<a href="#l10.4787"></a><span id="l10.4787">     nsAutoString ext;</span>
<a href="#l10.4788"></a><span id="l10.4788">     int32_t idx = leafName.RFindChar('.');</span>
<a href="#l10.4789"></a><span id="l10.4789" class="difflineminus">-    if (idx != -1)</span>
<a href="#l10.4790"></a><span id="l10.4790" class="difflineminus">-      ext = Substring(leafName, idx);</span>
<a href="#l10.4791"></a><span id="l10.4791" class="difflineminus">-    if (!ext.EqualsLiteral(FOLDER_SUFFIX8))  // No overload for char16_t available.</span>
<a href="#l10.4792"></a><span id="l10.4792" class="difflineplus">+    if (idx != -1) ext = Substring(leafName, idx);</span>
<a href="#l10.4793"></a><span id="l10.4793" class="difflineplus">+    if (!ext.EqualsLiteral(</span>
<a href="#l10.4794"></a><span id="l10.4794" class="difflineplus">+            FOLDER_SUFFIX8))  // No overload for char16_t available.</span>
<a href="#l10.4795"></a><span id="l10.4795">       pathIsDirectory = false;</span>
<a href="#l10.4796"></a><span id="l10.4796">   }</span>
<a href="#l10.4797"></a><span id="l10.4797"> </span>
<a href="#l10.4798"></a><span id="l10.4798" class="difflineminus">-  if(!pathIsDirectory)</span>
<a href="#l10.4799"></a><span id="l10.4799" class="difflineminus">-  {</span>
<a href="#l10.4800"></a><span id="l10.4800" class="difflineminus">-    //If the current path isn't a directory, add directory separator</span>
<a href="#l10.4801"></a><span id="l10.4801" class="difflineminus">-    //and test it out.</span>
<a href="#l10.4802"></a><span id="l10.4802" class="difflineplus">+  if (!pathIsDirectory) {</span>
<a href="#l10.4803"></a><span id="l10.4803" class="difflineplus">+    // If the current path isn't a directory, add directory separator</span>
<a href="#l10.4804"></a><span id="l10.4804" class="difflineplus">+    // and test it out.</span>
<a href="#l10.4805"></a><span id="l10.4805">     rv = AddDirectorySeparator(path);</span>
<a href="#l10.4806"></a><span id="l10.4806" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l10.4807"></a><span id="l10.4807" class="difflineminus">-      return rv;</span>
<a href="#l10.4808"></a><span id="l10.4808" class="difflineminus">-</span>
<a href="#l10.4809"></a><span id="l10.4809" class="difflineminus">-    //If that doesn't exist, then we have to create this directory</span>
<a href="#l10.4810"></a><span id="l10.4810" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4811"></a><span id="l10.4811" class="difflineplus">+</span>
<a href="#l10.4812"></a><span id="l10.4812" class="difflineplus">+    // If that doesn't exist, then we have to create this directory</span>
<a href="#l10.4813"></a><span id="l10.4813">     pathIsDirectory = false;</span>
<a href="#l10.4814"></a><span id="l10.4814">     path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l10.4815"></a><span id="l10.4815" class="difflineminus">-    if(!pathIsDirectory)</span>
<a href="#l10.4816"></a><span id="l10.4816" class="difflineminus">-    {</span>
<a href="#l10.4817"></a><span id="l10.4817" class="difflineplus">+    if (!pathIsDirectory) {</span>
<a href="#l10.4818"></a><span id="l10.4818">       bool pathExists;</span>
<a href="#l10.4819"></a><span id="l10.4819">       path-&gt;Exists(&amp;pathExists);</span>
<a href="#l10.4820"></a><span id="l10.4820" class="difflineminus">-      //If for some reason there's a file with the directory separator</span>
<a href="#l10.4821"></a><span id="l10.4821" class="difflineminus">-      //then we are going to fail.</span>
<a href="#l10.4822"></a><span id="l10.4822" class="difflineminus">-      rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY : path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l10.4823"></a><span id="l10.4823" class="difflineplus">+      // If for some reason there's a file with the directory separator</span>
<a href="#l10.4824"></a><span id="l10.4824" class="difflineplus">+      // then we are going to fail.</span>
<a href="#l10.4825"></a><span id="l10.4825" class="difflineplus">+      rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY</span>
<a href="#l10.4826"></a><span id="l10.4826" class="difflineplus">+                      : path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l10.4827"></a><span id="l10.4827">     }</span>
<a href="#l10.4828"></a><span id="l10.4828">   }</span>
<a href="#l10.4829"></a><span id="l10.4829" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.4830"></a><span id="l10.4830" class="difflineminus">-    path.forget(resultFile);</span>
<a href="#l10.4831"></a><span id="l10.4831" class="difflineplus">+  if (NS_SUCCEEDED(rv)) path.forget(resultFile);</span>
<a href="#l10.4832"></a><span id="l10.4832">   return rv;</span>
<a href="#l10.4833"></a><span id="l10.4833"> }</span>
<a href="#l10.4834"></a><span id="l10.4834"> </span>
<a href="#l10.4835"></a><span id="l10.4835"> /* Finds the backup directory associated with this folder, stored on the temp</span>
<a href="#l10.4836"></a><span id="l10.4836">    drive. If that path doesn't currently exist then it will create it. Path is</span>
<a href="#l10.4837"></a><span id="l10.4837">    strictly an out parameter.</span>
<a href="#l10.4838"></a><span id="l10.4838">   */</span>
<a href="#l10.4839"></a><span id="l10.4839" class="difflineminus">-nsresult nsMsgDBFolder::CreateBackupDirectory(nsIFile **resultFile)</span>
<a href="#l10.4840"></a><span id="l10.4840" class="difflineminus">-{</span>
<a href="#l10.4841"></a><span id="l10.4841" class="difflineplus">+nsresult nsMsgDBFolder::CreateBackupDirectory(nsIFile **resultFile) {</span>
<a href="#l10.4842"></a><span id="l10.4842">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l10.4843"></a><span id="l10.4843" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR,</span>
<a href="#l10.4844"></a><span id="l10.4844" class="difflineminus">-                                       getter_AddRefs(path));</span>
<a href="#l10.4845"></a><span id="l10.4845" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(path));</span>
<a href="#l10.4846"></a><span id="l10.4846">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4847"></a><span id="l10.4847"> </span>
<a href="#l10.4848"></a><span id="l10.4848">   rv = path-&gt;Append(NS_LITERAL_STRING(&quot;MozillaMailnews&quot;));</span>
<a href="#l10.4849"></a><span id="l10.4849">   bool pathIsDirectory;</span>
<a href="#l10.4850"></a><span id="l10.4850">   path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l10.4851"></a><span id="l10.4851"> </span>
<a href="#l10.4852"></a><span id="l10.4852">   // If that doesn't exist, then we have to create this directory</span>
<a href="#l10.4853"></a><span id="l10.4853" class="difflineminus">-  if (!pathIsDirectory)</span>
<a href="#l10.4854"></a><span id="l10.4854" class="difflineminus">-  {</span>
<a href="#l10.4855"></a><span id="l10.4855" class="difflineplus">+  if (!pathIsDirectory) {</span>
<a href="#l10.4856"></a><span id="l10.4856">     bool pathExists;</span>
<a href="#l10.4857"></a><span id="l10.4857">     path-&gt;Exists(&amp;pathExists);</span>
<a href="#l10.4858"></a><span id="l10.4858">     // If for some reason there's a file with the directory separator</span>
<a href="#l10.4859"></a><span id="l10.4859">     // then we are going to fail.</span>
<a href="#l10.4860"></a><span id="l10.4860" class="difflineminus">-    rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY :</span>
<a href="#l10.4861"></a><span id="l10.4861" class="difflineminus">-                      path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l10.4862"></a><span id="l10.4862" class="difflineplus">+    rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY</span>
<a href="#l10.4863"></a><span id="l10.4863" class="difflineplus">+                    : path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l10.4864"></a><span id="l10.4864">   }</span>
<a href="#l10.4865"></a><span id="l10.4865" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.4866"></a><span id="l10.4866" class="difflineminus">-    path.forget(resultFile);</span>
<a href="#l10.4867"></a><span id="l10.4867" class="difflineplus">+  if (NS_SUCCEEDED(rv)) path.forget(resultFile);</span>
<a href="#l10.4868"></a><span id="l10.4868">   return rv;</span>
<a href="#l10.4869"></a><span id="l10.4869"> }</span>
<a href="#l10.4870"></a><span id="l10.4870"> </span>
<a href="#l10.4871"></a><span id="l10.4871" class="difflineminus">-nsresult nsMsgDBFolder::GetBackupSummaryFile(nsIFile **aBackupFile, const nsACString&amp; newName)</span>
<a href="#l10.4872"></a><span id="l10.4872" class="difflineminus">-{</span>
<a href="#l10.4873"></a><span id="l10.4873" class="difflineplus">+nsresult nsMsgDBFolder::GetBackupSummaryFile(nsIFile **aBackupFile,</span>
<a href="#l10.4874"></a><span id="l10.4874" class="difflineplus">+                                             const nsACString &amp;newName) {</span>
<a href="#l10.4875"></a><span id="l10.4875">   nsCOMPtr&lt;nsIFile&gt; backupDir;</span>
<a href="#l10.4876"></a><span id="l10.4876">   nsresult rv = CreateBackupDirectory(getter_AddRefs(backupDir));</span>
<a href="#l10.4877"></a><span id="l10.4877">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4878"></a><span id="l10.4878"> </span>
<a href="#l10.4879"></a><span id="l10.4879">   // We use a dummy message folder file so we can use</span>
<a href="#l10.4880"></a><span id="l10.4880">   // GetSummaryFileLocation to get the db file name</span>
<a href="#l10.4881"></a><span id="l10.4881">   nsCOMPtr&lt;nsIFile&gt; backupDBDummyFolder;</span>
<a href="#l10.4882"></a><span id="l10.4882">   rv = CreateBackupDirectory(getter_AddRefs(backupDBDummyFolder));</span>
<a href="#l10.4883"></a><span id="l10.4883">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4884"></a><span id="l10.4884"> </span>
<a href="#l10.4885"></a><span id="l10.4885" class="difflineminus">-  if (!newName.IsEmpty())</span>
<a href="#l10.4886"></a><span id="l10.4886" class="difflineminus">-  {</span>
<a href="#l10.4887"></a><span id="l10.4887" class="difflineplus">+  if (!newName.IsEmpty()) {</span>
<a href="#l10.4888"></a><span id="l10.4888">     rv = backupDBDummyFolder-&gt;AppendNative(newName);</span>
<a href="#l10.4889"></a><span id="l10.4889" class="difflineminus">-  }</span>
<a href="#l10.4890"></a><span id="l10.4890" class="difflineminus">-  else // if newName is null, use the folder name</span>
<a href="#l10.4891"></a><span id="l10.4891" class="difflineplus">+  } else  // if newName is null, use the folder name</span>
<a href="#l10.4892"></a><span id="l10.4892">   {</span>
<a href="#l10.4893"></a><span id="l10.4893">     nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l10.4894"></a><span id="l10.4894">     rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l10.4895"></a><span id="l10.4895">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4896"></a><span id="l10.4896"> </span>
<a href="#l10.4897"></a><span id="l10.4897">     nsAutoCString folderName;</span>
<a href="#l10.4898"></a><span id="l10.4898">     rv = folderPath-&gt;GetNativeLeafName(folderName);</span>
<a href="#l10.4899"></a><span id="l10.4899">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4900"></a><span id="l10.4900">     rv = backupDBDummyFolder-&gt;AppendNative(folderName);</span>
<a href="#l10.4901"></a><span id="l10.4901">   }</span>
<a href="#l10.4902"></a><span id="l10.4902">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4903"></a><span id="l10.4903"> </span>
<a href="#l10.4904"></a><span id="l10.4904">   nsCOMPtr&lt;nsIFile&gt; backupDBFile;</span>
<a href="#l10.4905"></a><span id="l10.4905" class="difflineminus">-  rv = GetSummaryFileLocation(backupDBDummyFolder, getter_AddRefs(backupDBFile));</span>
<a href="#l10.4906"></a><span id="l10.4906" class="difflineplus">+  rv =</span>
<a href="#l10.4907"></a><span id="l10.4907" class="difflineplus">+      GetSummaryFileLocation(backupDBDummyFolder, getter_AddRefs(backupDBFile));</span>
<a href="#l10.4908"></a><span id="l10.4908">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4909"></a><span id="l10.4909"> </span>
<a href="#l10.4910"></a><span id="l10.4910">   backupDBFile.forget(aBackupFile);</span>
<a href="#l10.4911"></a><span id="l10.4911">   return NS_OK;</span>
<a href="#l10.4912"></a><span id="l10.4912"> }</span>
<a href="#l10.4913"></a><span id="l10.4913"> </span>
<a href="#l10.4914"></a><span id="l10.4914" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::Rename(const nsAString&amp; aNewName, nsIMsgWindow *msgWindow)</span>
<a href="#l10.4915"></a><span id="l10.4915" class="difflineminus">-{</span>
<a href="#l10.4916"></a><span id="l10.4916" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::Rename(const nsAString &amp;aNewName,</span>
<a href="#l10.4917"></a><span id="l10.4917" class="difflineplus">+                                    nsIMsgWindow *msgWindow) {</span>
<a href="#l10.4918"></a><span id="l10.4918">   nsCOMPtr&lt;nsIFile&gt; oldPathFile;</span>
<a href="#l10.4919"></a><span id="l10.4919">   nsresult rv = GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l10.4920"></a><span id="l10.4920" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.4921"></a><span id="l10.4921" class="difflineminus">-    return rv;</span>
<a href="#l10.4922"></a><span id="l10.4922" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4923"></a><span id="l10.4923">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l10.4924"></a><span id="l10.4924">   rv = GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l10.4925"></a><span id="l10.4925" class="difflineminus">-  if (!parentFolder)</span>
<a href="#l10.4926"></a><span id="l10.4926" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.4927"></a><span id="l10.4927" class="difflineplus">+  if (!parentFolder) return NS_ERROR_FAILURE;</span>
<a href="#l10.4928"></a><span id="l10.4928">   nsCOMPtr&lt;nsISupports&gt; parentSupport = do_QueryInterface(parentFolder);</span>
<a href="#l10.4929"></a><span id="l10.4929">   nsCOMPtr&lt;nsIFile&gt; oldSummaryFile;</span>
<a href="#l10.4930"></a><span id="l10.4930">   rv = GetSummaryFileLocation(oldPathFile, getter_AddRefs(oldSummaryFile));</span>
<a href="#l10.4931"></a><span id="l10.4931">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4932"></a><span id="l10.4932"> </span>
<a href="#l10.4933"></a><span id="l10.4933">   nsCOMPtr&lt;nsIFile&gt; dirFile;</span>
<a href="#l10.4934"></a><span id="l10.4934">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.4935"></a><span id="l10.4935"> </span>
<a href="#l10.4936"></a><span id="l10.4936" class="difflineminus">-  if (count &gt; 0)</span>
<a href="#l10.4937"></a><span id="l10.4937" class="difflineminus">-    rv = CreateDirectoryForFolder(getter_AddRefs(dirFile));</span>
<a href="#l10.4938"></a><span id="l10.4938" class="difflineplus">+  if (count &gt; 0) rv = CreateDirectoryForFolder(getter_AddRefs(dirFile));</span>
<a href="#l10.4939"></a><span id="l10.4939"> </span>
<a href="#l10.4940"></a><span id="l10.4940">   nsAutoString newDiskName(aNewName);</span>
<a href="#l10.4941"></a><span id="l10.4941">   NS_MsgHashIfNecessary(newDiskName);</span>
<a href="#l10.4942"></a><span id="l10.4942"> </span>
<a href="#l10.4943"></a><span id="l10.4943" class="difflineminus">-  if (mName.Equals(aNewName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l10.4944"></a><span id="l10.4944" class="difflineminus">-  {</span>
<a href="#l10.4945"></a><span id="l10.4945" class="difflineplus">+  if (mName.Equals(aNewName, nsCaseInsensitiveStringComparator())) {</span>
<a href="#l10.4946"></a><span id="l10.4946">     rv = ThrowAlertMsg(&quot;folderExists&quot;, msgWindow);</span>
<a href="#l10.4947"></a><span id="l10.4947">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l10.4948"></a><span id="l10.4948" class="difflineminus">-  }</span>
<a href="#l10.4949"></a><span id="l10.4949" class="difflineminus">-  else</span>
<a href="#l10.4950"></a><span id="l10.4950" class="difflineminus">-  {</span>
<a href="#l10.4951"></a><span id="l10.4951" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; parentPathFile;</span>
<a href="#l10.4952"></a><span id="l10.4952" class="difflineplus">+  } else {</span>
<a href="#l10.4953"></a><span id="l10.4953" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; parentPathFile;</span>
<a href="#l10.4954"></a><span id="l10.4954">     parentFolder-&gt;GetFilePath(getter_AddRefs(parentPathFile));</span>
<a href="#l10.4955"></a><span id="l10.4955" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.4956"></a><span id="l10.4956" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.4957"></a><span id="l10.4957">     bool isDirectory = false;</span>
<a href="#l10.4958"></a><span id="l10.4958">     parentPathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l10.4959"></a><span id="l10.4959" class="difflineminus">-    if (!isDirectory)</span>
<a href="#l10.4960"></a><span id="l10.4960" class="difflineminus">-      AddDirectorySeparator(parentPathFile);</span>
<a href="#l10.4961"></a><span id="l10.4961" class="difflineplus">+    if (!isDirectory) AddDirectorySeparator(parentPathFile);</span>
<a href="#l10.4962"></a><span id="l10.4962"> </span>
<a href="#l10.4963"></a><span id="l10.4963">     rv = CheckIfFolderExists(aNewName, parentFolder, msgWindow);</span>
<a href="#l10.4964"></a><span id="l10.4964" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l10.4965"></a><span id="l10.4965" class="difflineminus">-      return rv;</span>
<a href="#l10.4966"></a><span id="l10.4966" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.4967"></a><span id="l10.4967">   }</span>
<a href="#l10.4968"></a><span id="l10.4968"> </span>
<a href="#l10.4969"></a><span id="l10.4969">   ForceDBClosed();</span>
<a href="#l10.4970"></a><span id="l10.4970"> </span>
<a href="#l10.4971"></a><span id="l10.4971">   // Save of dir name before appending .msf</span>
<a href="#l10.4972"></a><span id="l10.4972">   nsAutoString newNameDirStr(newDiskName);</span>
<a href="#l10.4973"></a><span id="l10.4973"> </span>
<a href="#l10.4974"></a><span id="l10.4974" class="difflineminus">-  if (! (mFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.4975"></a><span id="l10.4975" class="difflineplus">+  if (!(mFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.4976"></a><span id="l10.4976">     rv = oldPathFile-&gt;MoveTo(nullptr, newDiskName);</span>
<a href="#l10.4977"></a><span id="l10.4977" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.4978"></a><span id="l10.4978" class="difflineminus">-  {</span>
<a href="#l10.4979"></a><span id="l10.4979" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.4980"></a><span id="l10.4980">     newDiskName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l10.4981"></a><span id="l10.4981">     oldSummaryFile-&gt;MoveTo(nullptr, newDiskName);</span>
<a href="#l10.4982"></a><span id="l10.4982" class="difflineminus">-  }</span>
<a href="#l10.4983"></a><span id="l10.4983" class="difflineminus">-  else</span>
<a href="#l10.4984"></a><span id="l10.4984" class="difflineminus">-  {</span>
<a href="#l10.4985"></a><span id="l10.4985" class="difflineplus">+  } else {</span>
<a href="#l10.4986"></a><span id="l10.4986">     ThrowAlertMsg(&quot;folderRenameFailed&quot;, msgWindow);</span>
<a href="#l10.4987"></a><span id="l10.4987">     return rv;</span>
<a href="#l10.4988"></a><span id="l10.4988">   }</span>
<a href="#l10.4989"></a><span id="l10.4989"> </span>
<a href="#l10.4990"></a><span id="l10.4990" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; count &gt; 0)</span>
<a href="#l10.4991"></a><span id="l10.4991" class="difflineminus">-  {</span>
<a href="#l10.4992"></a><span id="l10.4992" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; count &gt; 0) {</span>
<a href="#l10.4993"></a><span id="l10.4993">     // rename &quot;*.sbd&quot; directory</span>
<a href="#l10.4994"></a><span id="l10.4994">     newNameDirStr.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l10.4995"></a><span id="l10.4995">     dirFile-&gt;MoveTo(nullptr, newNameDirStr);</span>
<a href="#l10.4996"></a><span id="l10.4996">   }</span>
<a href="#l10.4997"></a><span id="l10.4997"> </span>
<a href="#l10.4998"></a><span id="l10.4998">   nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l10.4999"></a><span id="l10.4999" class="difflineminus">-  if (parentSupport)</span>
<a href="#l10.5000"></a><span id="l10.5000" class="difflineminus">-  {</span>
<a href="#l10.5001"></a><span id="l10.5001" class="difflineplus">+  if (parentSupport) {</span>
<a href="#l10.5002"></a><span id="l10.5002">     rv = parentFolder-&gt;AddSubfolder(aNewName, getter_AddRefs(newFolder));</span>
<a href="#l10.5003"></a><span id="l10.5003" class="difflineminus">-    if (newFolder)</span>
<a href="#l10.5004"></a><span id="l10.5004" class="difflineminus">-    {</span>
<a href="#l10.5005"></a><span id="l10.5005" class="difflineplus">+    if (newFolder) {</span>
<a href="#l10.5006"></a><span id="l10.5006">       newFolder-&gt;SetPrettyName(EmptyString());</span>
<a href="#l10.5007"></a><span id="l10.5007">       newFolder-&gt;SetPrettyName(aNewName);</span>
<a href="#l10.5008"></a><span id="l10.5008">       newFolder-&gt;SetFlags(mFlags);</span>
<a href="#l10.5009"></a><span id="l10.5009">       bool changed = false;</span>
<a href="#l10.5010"></a><span id="l10.5010" class="difflineminus">-      MatchOrChangeFilterDestination(newFolder, true /*case-insensitive*/, &amp;changed);</span>
<a href="#l10.5011"></a><span id="l10.5011" class="difflineminus">-      if (changed)</span>
<a href="#l10.5012"></a><span id="l10.5012" class="difflineminus">-        AlertFilterChanged(msgWindow);</span>
<a href="#l10.5013"></a><span id="l10.5013" class="difflineminus">-</span>
<a href="#l10.5014"></a><span id="l10.5014" class="difflineminus">-      if (count &gt; 0)</span>
<a href="#l10.5015"></a><span id="l10.5015" class="difflineminus">-        newFolder-&gt;RenameSubFolders(msgWindow, this);</span>
<a href="#l10.5016"></a><span id="l10.5016" class="difflineminus">-</span>
<a href="#l10.5017"></a><span id="l10.5017" class="difflineminus">-      if (parentFolder)</span>
<a href="#l10.5018"></a><span id="l10.5018" class="difflineminus">-      {</span>
<a href="#l10.5019"></a><span id="l10.5019" class="difflineplus">+      MatchOrChangeFilterDestination(newFolder, true /*case-insensitive*/,</span>
<a href="#l10.5020"></a><span id="l10.5020" class="difflineplus">+                                     &amp;changed);</span>
<a href="#l10.5021"></a><span id="l10.5021" class="difflineplus">+      if (changed) AlertFilterChanged(msgWindow);</span>
<a href="#l10.5022"></a><span id="l10.5022" class="difflineplus">+</span>
<a href="#l10.5023"></a><span id="l10.5023" class="difflineplus">+      if (count &gt; 0) newFolder-&gt;RenameSubFolders(msgWindow, this);</span>
<a href="#l10.5024"></a><span id="l10.5024" class="difflineplus">+</span>
<a href="#l10.5025"></a><span id="l10.5025" class="difflineplus">+      if (parentFolder) {</span>
<a href="#l10.5026"></a><span id="l10.5026">         SetParent(nullptr);</span>
<a href="#l10.5027"></a><span id="l10.5027">         parentFolder-&gt;PropagateDelete(this, false, msgWindow);</span>
<a href="#l10.5028"></a><span id="l10.5028">         parentFolder-&gt;NotifyItemAdded(newFolder);</span>
<a href="#l10.5029"></a><span id="l10.5029">       }</span>
<a href="#l10.5030"></a><span id="l10.5030">       newFolder-&gt;NotifyFolderEvent(kRenameCompleted);</span>
<a href="#l10.5031"></a><span id="l10.5031">     }</span>
<a href="#l10.5032"></a><span id="l10.5032">   }</span>
<a href="#l10.5033"></a><span id="l10.5033">   return rv;</span>
<a href="#l10.5034"></a><span id="l10.5034"> }</span>
<a href="#l10.5035"></a><span id="l10.5035"> </span>
<a href="#l10.5036"></a><span id="l10.5036" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::RenameSubFolders(nsIMsgWindow *msgWindow, nsIMsgFolder *oldFolder)</span>
<a href="#l10.5037"></a><span id="l10.5037" class="difflineminus">-{</span>
<a href="#l10.5038"></a><span id="l10.5038" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::RenameSubFolders(nsIMsgWindow *msgWindow,</span>
<a href="#l10.5039"></a><span id="l10.5039" class="difflineplus">+                                              nsIMsgFolder *oldFolder) {</span>
<a href="#l10.5040"></a><span id="l10.5040">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.5041"></a><span id="l10.5041"> }</span>
<a href="#l10.5042"></a><span id="l10.5042"> </span>
<a href="#l10.5043"></a><span id="l10.5043" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ContainsChildNamed(const nsAString&amp; name, bool* containsChild)</span>
<a href="#l10.5044"></a><span id="l10.5044" class="difflineminus">-{</span>
<a href="#l10.5045"></a><span id="l10.5045" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ContainsChildNamed(const nsAString &amp;name,</span>
<a href="#l10.5046"></a><span id="l10.5046" class="difflineplus">+                                                bool *containsChild) {</span>
<a href="#l10.5047"></a><span id="l10.5047">   NS_ENSURE_ARG_POINTER(containsChild);</span>
<a href="#l10.5048"></a><span id="l10.5048">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l10.5049"></a><span id="l10.5049">   GetChildNamed(name, getter_AddRefs(child));</span>
<a href="#l10.5050"></a><span id="l10.5050">   *containsChild = child != nullptr;</span>
<a href="#l10.5051"></a><span id="l10.5051">   return NS_OK;</span>
<a href="#l10.5052"></a><span id="l10.5052"> }</span>
<a href="#l10.5053"></a><span id="l10.5053"> </span>
<a href="#l10.5054"></a><span id="l10.5054" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::IsAncestorOf(nsIMsgFolder *child, bool *isAncestor)</span>
<a href="#l10.5055"></a><span id="l10.5055" class="difflineminus">-{</span>
<a href="#l10.5056"></a><span id="l10.5056" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::IsAncestorOf(nsIMsgFolder *child,</span>
<a href="#l10.5057"></a><span id="l10.5057" class="difflineplus">+                                          bool *isAncestor) {</span>
<a href="#l10.5058"></a><span id="l10.5058">   NS_ENSURE_ARG_POINTER(isAncestor);</span>
<a href="#l10.5059"></a><span id="l10.5059">   nsresult rv = NS_OK;</span>
<a href="#l10.5060"></a><span id="l10.5060"> </span>
<a href="#l10.5061"></a><span id="l10.5061">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.5062"></a><span id="l10.5062"> </span>
<a href="#l10.5063"></a><span id="l10.5063" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5064"></a><span id="l10.5064" class="difflineminus">-  {</span>
<a href="#l10.5065"></a><span id="l10.5065" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5066"></a><span id="l10.5066">     nsCOMPtr&lt;nsIMsgFolder&gt; folder(mSubFolders[i]);</span>
<a href="#l10.5067"></a><span id="l10.5067">     if (folder.get() == child)</span>
<a href="#l10.5068"></a><span id="l10.5068">       *isAncestor = true;</span>
<a href="#l10.5069"></a><span id="l10.5069">     else</span>
<a href="#l10.5070"></a><span id="l10.5070">       folder-&gt;IsAncestorOf(child, isAncestor);</span>
<a href="#l10.5071"></a><span id="l10.5071"> </span>
<a href="#l10.5072"></a><span id="l10.5072" class="difflineminus">-    if (*isAncestor)</span>
<a href="#l10.5073"></a><span id="l10.5073" class="difflineminus">-      return NS_OK;</span>
<a href="#l10.5074"></a><span id="l10.5074" class="difflineplus">+    if (*isAncestor) return NS_OK;</span>
<a href="#l10.5075"></a><span id="l10.5075">   }</span>
<a href="#l10.5076"></a><span id="l10.5076">   *isAncestor = false;</span>
<a href="#l10.5077"></a><span id="l10.5077">   return rv;</span>
<a href="#l10.5078"></a><span id="l10.5078"> }</span>
<a href="#l10.5079"></a><span id="l10.5079"> </span>
<a href="#l10.5080"></a><span id="l10.5080" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GenerateUniqueSubfolderName(const nsAString&amp; prefix,</span>
<a href="#l10.5081"></a><span id="l10.5081" class="difflineminus">-                                                         nsIMsgFolder *otherFolder,</span>
<a href="#l10.5082"></a><span id="l10.5082" class="difflineminus">-                                                         nsAString&amp; name)</span>
<a href="#l10.5083"></a><span id="l10.5083" class="difflineminus">-{</span>
<a href="#l10.5084"></a><span id="l10.5084" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GenerateUniqueSubfolderName(</span>
<a href="#l10.5085"></a><span id="l10.5085" class="difflineplus">+    const nsAString &amp;prefix, nsIMsgFolder *otherFolder, nsAString &amp;name) {</span>
<a href="#l10.5086"></a><span id="l10.5086">   /* only try 256 times */</span>
<a href="#l10.5087"></a><span id="l10.5087" class="difflineminus">-  for (int count = 0; count &lt; 256; count++)</span>
<a href="#l10.5088"></a><span id="l10.5088" class="difflineminus">-  {</span>
<a href="#l10.5089"></a><span id="l10.5089" class="difflineplus">+  for (int count = 0; count &lt; 256; count++) {</span>
<a href="#l10.5090"></a><span id="l10.5090">     nsAutoString uniqueName;</span>
<a href="#l10.5091"></a><span id="l10.5091">     uniqueName.Assign(prefix);</span>
<a href="#l10.5092"></a><span id="l10.5092">     uniqueName.AppendInt(count);</span>
<a href="#l10.5093"></a><span id="l10.5093">     bool containsChild;</span>
<a href="#l10.5094"></a><span id="l10.5094">     bool otherContainsChild = false;</span>
<a href="#l10.5095"></a><span id="l10.5095">     ContainsChildNamed(uniqueName, &amp;containsChild);</span>
<a href="#l10.5096"></a><span id="l10.5096">     if (otherFolder)</span>
<a href="#l10.5097"></a><span id="l10.5097">       otherFolder-&gt;ContainsChildNamed(uniqueName, &amp;otherContainsChild);</span>
<a href="#l10.5098"></a><span id="l10.5098"> </span>
<a href="#l10.5099"></a><span id="l10.5099" class="difflineminus">-    if (!containsChild &amp;&amp; !otherContainsChild)</span>
<a href="#l10.5100"></a><span id="l10.5100" class="difflineminus">-    {</span>
<a href="#l10.5101"></a><span id="l10.5101" class="difflineplus">+    if (!containsChild &amp;&amp; !otherContainsChild) {</span>
<a href="#l10.5102"></a><span id="l10.5102">       name = uniqueName;</span>
<a href="#l10.5103"></a><span id="l10.5103">       break;</span>
<a href="#l10.5104"></a><span id="l10.5104">     }</span>
<a href="#l10.5105"></a><span id="l10.5105">   }</span>
<a href="#l10.5106"></a><span id="l10.5106">   return NS_OK;</span>
<a href="#l10.5107"></a><span id="l10.5107"> }</span>
<a href="#l10.5108"></a><span id="l10.5108"> </span>
<a href="#l10.5109"></a><span id="l10.5109" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::UpdateSummaryTotals(bool force)</span>
<a href="#l10.5110"></a><span id="l10.5110" class="difflineminus">-{</span>
<a href="#l10.5111"></a><span id="l10.5111" class="difflineminus">-  if (!mNotifyCountChanges)</span>
<a href="#l10.5112"></a><span id="l10.5112" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.5113"></a><span id="l10.5113" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::UpdateSummaryTotals(bool force) {</span>
<a href="#l10.5114"></a><span id="l10.5114" class="difflineplus">+  if (!mNotifyCountChanges) return NS_OK;</span>
<a href="#l10.5115"></a><span id="l10.5115"> </span>
<a href="#l10.5116"></a><span id="l10.5116">   int32_t oldUnreadMessages = mNumUnreadMessages + mNumPendingUnreadMessages;</span>
<a href="#l10.5117"></a><span id="l10.5117">   int32_t oldTotalMessages = mNumTotalMessages + mNumPendingTotalMessages;</span>
<a href="#l10.5118"></a><span id="l10.5118" class="difflineminus">-  //We need to read this info from the database</span>
<a href="#l10.5119"></a><span id="l10.5119" class="difflineplus">+  // We need to read this info from the database</span>
<a href="#l10.5120"></a><span id="l10.5120">   nsresult rv = ReadDBFolderInfo(force);</span>
<a href="#l10.5121"></a><span id="l10.5121"> </span>
<a href="#l10.5122"></a><span id="l10.5122" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.5123"></a><span id="l10.5123" class="difflineminus">-  {</span>
<a href="#l10.5124"></a><span id="l10.5124" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.5125"></a><span id="l10.5125">     int32_t newUnreadMessages = mNumUnreadMessages + mNumPendingUnreadMessages;</span>
<a href="#l10.5126"></a><span id="l10.5126">     int32_t newTotalMessages = mNumTotalMessages + mNumPendingTotalMessages;</span>
<a href="#l10.5127"></a><span id="l10.5127"> </span>
<a href="#l10.5128"></a><span id="l10.5128" class="difflineminus">-    //Need to notify listeners that total count changed.</span>
<a href="#l10.5129"></a><span id="l10.5129" class="difflineminus">-    if(oldTotalMessages != newTotalMessages)</span>
<a href="#l10.5130"></a><span id="l10.5130" class="difflineminus">-      NotifyIntPropertyChanged(kTotalMessages, oldTotalMessages, newTotalMessages);</span>
<a href="#l10.5131"></a><span id="l10.5131" class="difflineminus">-</span>
<a href="#l10.5132"></a><span id="l10.5132" class="difflineminus">-    if(oldUnreadMessages != newUnreadMessages)</span>
<a href="#l10.5133"></a><span id="l10.5133" class="difflineminus">-      NotifyIntPropertyChanged(kTotalUnreadMessages, oldUnreadMessages, newUnreadMessages);</span>
<a href="#l10.5134"></a><span id="l10.5134" class="difflineplus">+    // Need to notify listeners that total count changed.</span>
<a href="#l10.5135"></a><span id="l10.5135" class="difflineplus">+    if (oldTotalMessages != newTotalMessages)</span>
<a href="#l10.5136"></a><span id="l10.5136" class="difflineplus">+      NotifyIntPropertyChanged(kTotalMessages, oldTotalMessages,</span>
<a href="#l10.5137"></a><span id="l10.5137" class="difflineplus">+                               newTotalMessages);</span>
<a href="#l10.5138"></a><span id="l10.5138" class="difflineplus">+</span>
<a href="#l10.5139"></a><span id="l10.5139" class="difflineplus">+    if (oldUnreadMessages != newUnreadMessages)</span>
<a href="#l10.5140"></a><span id="l10.5140" class="difflineplus">+      NotifyIntPropertyChanged(kTotalUnreadMessages, oldUnreadMessages,</span>
<a href="#l10.5141"></a><span id="l10.5141" class="difflineplus">+                               newUnreadMessages);</span>
<a href="#l10.5142"></a><span id="l10.5142"> </span>
<a href="#l10.5143"></a><span id="l10.5143">     FlushToFolderCache();</span>
<a href="#l10.5144"></a><span id="l10.5144">   }</span>
<a href="#l10.5145"></a><span id="l10.5145">   return rv;</span>
<a href="#l10.5146"></a><span id="l10.5146"> }</span>
<a href="#l10.5147"></a><span id="l10.5147"> </span>
<a href="#l10.5148"></a><span id="l10.5148" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SummaryChanged()</span>
<a href="#l10.5149"></a><span id="l10.5149" class="difflineminus">-{</span>
<a href="#l10.5150"></a><span id="l10.5150" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SummaryChanged() {</span>
<a href="#l10.5151"></a><span id="l10.5151">   UpdateSummaryTotals(false);</span>
<a href="#l10.5152"></a><span id="l10.5152">   return NS_OK;</span>
<a href="#l10.5153"></a><span id="l10.5153"> }</span>
<a href="#l10.5154"></a><span id="l10.5154"> </span>
<a href="#l10.5155"></a><span id="l10.5155" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetNumUnread(bool deep, int32_t *numUnread)</span>
<a href="#l10.5156"></a><span id="l10.5156" class="difflineminus">-{</span>
<a href="#l10.5157"></a><span id="l10.5157" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetNumUnread(bool deep, int32_t *numUnread) {</span>
<a href="#l10.5158"></a><span id="l10.5158">   NS_ENSURE_ARG_POINTER(numUnread);</span>
<a href="#l10.5159"></a><span id="l10.5159"> </span>
<a href="#l10.5160"></a><span id="l10.5160">   bool isServer = false;</span>
<a href="#l10.5161"></a><span id="l10.5161">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l10.5162"></a><span id="l10.5162">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5163"></a><span id="l10.5163">   int32_t total = isServer ? 0 : mNumUnreadMessages + mNumPendingUnreadMessages;</span>
<a href="#l10.5164"></a><span id="l10.5164"> </span>
<a href="#l10.5165"></a><span id="l10.5165" class="difflineminus">-  if (deep)</span>
<a href="#l10.5166"></a><span id="l10.5166" class="difflineminus">-  {</span>
<a href="#l10.5167"></a><span id="l10.5167" class="difflineminus">-    if (total &lt; 0) // deep search never returns negative counts</span>
<a href="#l10.5168"></a><span id="l10.5168" class="difflineplus">+  if (deep) {</span>
<a href="#l10.5169"></a><span id="l10.5169" class="difflineplus">+    if (total &lt; 0)  // deep search never returns negative counts</span>
<a href="#l10.5170"></a><span id="l10.5170">       total = 0;</span>
<a href="#l10.5171"></a><span id="l10.5171">     int32_t count = mSubFolders.Count();</span>
<a href="#l10.5172"></a><span id="l10.5172" class="difflineminus">-    for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5173"></a><span id="l10.5173" class="difflineminus">-    {</span>
<a href="#l10.5174"></a><span id="l10.5174" class="difflineplus">+    for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5175"></a><span id="l10.5175">       nsCOMPtr&lt;nsIMsgFolder&gt; folder(mSubFolders[i]);</span>
<a href="#l10.5176"></a><span id="l10.5176">       int32_t num;</span>
<a href="#l10.5177"></a><span id="l10.5177">       uint32_t folderFlags;</span>
<a href="#l10.5178"></a><span id="l10.5178">       folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l10.5179"></a><span id="l10.5179" class="difflineminus">-      if (!(folderFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.5180"></a><span id="l10.5180" class="difflineminus">-      {</span>
<a href="#l10.5181"></a><span id="l10.5181" class="difflineplus">+      if (!(folderFlags &amp; nsMsgFolderFlags::Virtual)) {</span>
<a href="#l10.5182"></a><span id="l10.5182">         folder-&gt;GetNumUnread(deep, &amp;num);</span>
<a href="#l10.5183"></a><span id="l10.5183">         total += num;</span>
<a href="#l10.5184"></a><span id="l10.5184">       }</span>
<a href="#l10.5185"></a><span id="l10.5185">     }</span>
<a href="#l10.5186"></a><span id="l10.5186">   }</span>
<a href="#l10.5187"></a><span id="l10.5187">   *numUnread = total;</span>
<a href="#l10.5188"></a><span id="l10.5188">   return NS_OK;</span>
<a href="#l10.5189"></a><span id="l10.5189"> }</span>
<a href="#l10.5190"></a><span id="l10.5190"> </span>
<a href="#l10.5191"></a><span id="l10.5191" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetTotalMessages(bool deep, int32_t *totalMessages)</span>
<a href="#l10.5192"></a><span id="l10.5192" class="difflineminus">-{</span>
<a href="#l10.5193"></a><span id="l10.5193" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetTotalMessages(bool deep,</span>
<a href="#l10.5194"></a><span id="l10.5194" class="difflineplus">+                                              int32_t *totalMessages) {</span>
<a href="#l10.5195"></a><span id="l10.5195">   NS_ENSURE_ARG_POINTER(totalMessages);</span>
<a href="#l10.5196"></a><span id="l10.5196"> </span>
<a href="#l10.5197"></a><span id="l10.5197">   bool isServer = false;</span>
<a href="#l10.5198"></a><span id="l10.5198">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l10.5199"></a><span id="l10.5199">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5200"></a><span id="l10.5200">   int32_t total = isServer ? 0 : mNumTotalMessages + mNumPendingTotalMessages;</span>
<a href="#l10.5201"></a><span id="l10.5201"> </span>
<a href="#l10.5202"></a><span id="l10.5202" class="difflineminus">-  if (deep)</span>
<a href="#l10.5203"></a><span id="l10.5203" class="difflineminus">-  {</span>
<a href="#l10.5204"></a><span id="l10.5204" class="difflineminus">-    if (total &lt; 0) // deep search never returns negative counts</span>
<a href="#l10.5205"></a><span id="l10.5205" class="difflineplus">+  if (deep) {</span>
<a href="#l10.5206"></a><span id="l10.5206" class="difflineplus">+    if (total &lt; 0)  // deep search never returns negative counts</span>
<a href="#l10.5207"></a><span id="l10.5207">       total = 0;</span>
<a href="#l10.5208"></a><span id="l10.5208">     int32_t count = mSubFolders.Count();</span>
<a href="#l10.5209"></a><span id="l10.5209" class="difflineminus">-    for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5210"></a><span id="l10.5210" class="difflineminus">-    {</span>
<a href="#l10.5211"></a><span id="l10.5211" class="difflineplus">+    for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5212"></a><span id="l10.5212">       nsCOMPtr&lt;nsIMsgFolder&gt; folder(mSubFolders[i]);</span>
<a href="#l10.5213"></a><span id="l10.5213">       int32_t num;</span>
<a href="#l10.5214"></a><span id="l10.5214">       uint32_t folderFlags;</span>
<a href="#l10.5215"></a><span id="l10.5215">       folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l10.5216"></a><span id="l10.5216" class="difflineminus">-      if (!(folderFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.5217"></a><span id="l10.5217" class="difflineminus">-      {</span>
<a href="#l10.5218"></a><span id="l10.5218" class="difflineplus">+      if (!(folderFlags &amp; nsMsgFolderFlags::Virtual)) {</span>
<a href="#l10.5219"></a><span id="l10.5219">         folder-&gt;GetTotalMessages(deep, &amp;num);</span>
<a href="#l10.5220"></a><span id="l10.5220">         total += num;</span>
<a href="#l10.5221"></a><span id="l10.5221">       }</span>
<a href="#l10.5222"></a><span id="l10.5222">     }</span>
<a href="#l10.5223"></a><span id="l10.5223">   }</span>
<a href="#l10.5224"></a><span id="l10.5224">   *totalMessages = total;</span>
<a href="#l10.5225"></a><span id="l10.5225">   return NS_OK;</span>
<a href="#l10.5226"></a><span id="l10.5226"> }</span>
<a href="#l10.5227"></a><span id="l10.5227"> </span>
<a href="#l10.5228"></a><span id="l10.5228" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetNumPendingUnread(int32_t *aPendingUnread)</span>
<a href="#l10.5229"></a><span id="l10.5229" class="difflineminus">-{</span>
<a href="#l10.5230"></a><span id="l10.5230" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetNumPendingUnread(int32_t *aPendingUnread) {</span>
<a href="#l10.5231"></a><span id="l10.5231">   *aPendingUnread = mNumPendingUnreadMessages;</span>
<a href="#l10.5232"></a><span id="l10.5232">   return NS_OK;</span>
<a href="#l10.5233"></a><span id="l10.5233"> }</span>
<a href="#l10.5234"></a><span id="l10.5234"> </span>
<a href="#l10.5235"></a><span id="l10.5235" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetNumPendingTotalMessages(int32_t *aPendingTotal)</span>
<a href="#l10.5236"></a><span id="l10.5236" class="difflineminus">-{</span>
<a href="#l10.5237"></a><span id="l10.5237" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetNumPendingTotalMessages(</span>
<a href="#l10.5238"></a><span id="l10.5238" class="difflineplus">+    int32_t *aPendingTotal) {</span>
<a href="#l10.5239"></a><span id="l10.5239">   *aPendingTotal = mNumPendingTotalMessages;</span>
<a href="#l10.5240"></a><span id="l10.5240">   return NS_OK;</span>
<a href="#l10.5241"></a><span id="l10.5241"> }</span>
<a href="#l10.5242"></a><span id="l10.5242"> </span>
<a href="#l10.5243"></a><span id="l10.5243" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ChangeNumPendingUnread(int32_t delta)</span>
<a href="#l10.5244"></a><span id="l10.5244" class="difflineminus">-{</span>
<a href="#l10.5245"></a><span id="l10.5245" class="difflineminus">-  if (delta)</span>
<a href="#l10.5246"></a><span id="l10.5246" class="difflineminus">-  {</span>
<a href="#l10.5247"></a><span id="l10.5247" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ChangeNumPendingUnread(int32_t delta) {</span>
<a href="#l10.5248"></a><span id="l10.5248" class="difflineplus">+  if (delta) {</span>
<a href="#l10.5249"></a><span id="l10.5249">     int32_t oldUnreadMessages = mNumUnreadMessages + mNumPendingUnreadMessages;</span>
<a href="#l10.5250"></a><span id="l10.5250">     mNumPendingUnreadMessages += delta;</span>
<a href="#l10.5251"></a><span id="l10.5251">     int32_t newUnreadMessages = mNumUnreadMessages + mNumPendingUnreadMessages;</span>
<a href="#l10.5252"></a><span id="l10.5252" class="difflineminus">-    NS_ASSERTION(newUnreadMessages &gt;= 0, &quot;shouldn't have negative unread message count&quot;);</span>
<a href="#l10.5253"></a><span id="l10.5253" class="difflineminus">-    if (newUnreadMessages &gt;= 0)</span>
<a href="#l10.5254"></a><span id="l10.5254" class="difflineminus">-    {</span>
<a href="#l10.5255"></a><span id="l10.5255" class="difflineplus">+    NS_ASSERTION(newUnreadMessages &gt;= 0,</span>
<a href="#l10.5256"></a><span id="l10.5256" class="difflineplus">+                 &quot;shouldn't have negative unread message count&quot;);</span>
<a href="#l10.5257"></a><span id="l10.5257" class="difflineplus">+    if (newUnreadMessages &gt;= 0) {</span>
<a href="#l10.5258"></a><span id="l10.5258">       nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.5259"></a><span id="l10.5259">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.5260"></a><span id="l10.5260" class="difflineminus">-      nsresult rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.5261"></a><span id="l10.5261" class="difflineplus">+      nsresult rv =</span>
<a href="#l10.5262"></a><span id="l10.5262" class="difflineplus">+          GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.5263"></a><span id="l10.5263">       if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l10.5264"></a><span id="l10.5264">         folderInfo-&gt;SetImapUnreadPendingMessages(mNumPendingUnreadMessages);</span>
<a href="#l10.5265"></a><span id="l10.5265" class="difflineminus">-      NotifyIntPropertyChanged(kTotalUnreadMessages, oldUnreadMessages, newUnreadMessages);</span>
<a href="#l10.5266"></a><span id="l10.5266" class="difflineplus">+      NotifyIntPropertyChanged(kTotalUnreadMessages, oldUnreadMessages,</span>
<a href="#l10.5267"></a><span id="l10.5267" class="difflineplus">+                               newUnreadMessages);</span>
<a href="#l10.5268"></a><span id="l10.5268">     }</span>
<a href="#l10.5269"></a><span id="l10.5269">   }</span>
<a href="#l10.5270"></a><span id="l10.5270">   return NS_OK;</span>
<a href="#l10.5271"></a><span id="l10.5271"> }</span>
<a href="#l10.5272"></a><span id="l10.5272"> </span>
<a href="#l10.5273"></a><span id="l10.5273" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ChangeNumPendingTotalMessages(int32_t delta)</span>
<a href="#l10.5274"></a><span id="l10.5274" class="difflineminus">-{</span>
<a href="#l10.5275"></a><span id="l10.5275" class="difflineminus">-  if (delta)</span>
<a href="#l10.5276"></a><span id="l10.5276" class="difflineminus">-  {</span>
<a href="#l10.5277"></a><span id="l10.5277" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ChangeNumPendingTotalMessages(int32_t delta) {</span>
<a href="#l10.5278"></a><span id="l10.5278" class="difflineplus">+  if (delta) {</span>
<a href="#l10.5279"></a><span id="l10.5279">     int32_t oldTotalMessages = mNumTotalMessages + mNumPendingTotalMessages;</span>
<a href="#l10.5280"></a><span id="l10.5280">     mNumPendingTotalMessages += delta;</span>
<a href="#l10.5281"></a><span id="l10.5281">     int32_t newTotalMessages = mNumTotalMessages + mNumPendingTotalMessages;</span>
<a href="#l10.5282"></a><span id="l10.5282"> </span>
<a href="#l10.5283"></a><span id="l10.5283">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.5284"></a><span id="l10.5284">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.5285"></a><span id="l10.5285" class="difflineminus">-    nsresult rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.5286"></a><span id="l10.5286" class="difflineplus">+    nsresult rv =</span>
<a href="#l10.5287"></a><span id="l10.5287" class="difflineplus">+        GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.5288"></a><span id="l10.5288">     if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l10.5289"></a><span id="l10.5289">       folderInfo-&gt;SetImapTotalPendingMessages(mNumPendingTotalMessages);</span>
<a href="#l10.5290"></a><span id="l10.5290" class="difflineminus">-    NotifyIntPropertyChanged(kTotalMessages, oldTotalMessages, newTotalMessages);</span>
<a href="#l10.5291"></a><span id="l10.5291" class="difflineplus">+    NotifyIntPropertyChanged(kTotalMessages, oldTotalMessages,</span>
<a href="#l10.5292"></a><span id="l10.5292" class="difflineplus">+                             newTotalMessages);</span>
<a href="#l10.5293"></a><span id="l10.5293">   }</span>
<a href="#l10.5294"></a><span id="l10.5294">   return NS_OK;</span>
<a href="#l10.5295"></a><span id="l10.5295"> }</span>
<a href="#l10.5296"></a><span id="l10.5296"> </span>
<a href="#l10.5297"></a><span id="l10.5297" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetFlag(uint32_t flag)</span>
<a href="#l10.5298"></a><span id="l10.5298" class="difflineminus">-{</span>
<a href="#l10.5299"></a><span id="l10.5299" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetFlag(uint32_t flag) {</span>
<a href="#l10.5300"></a><span id="l10.5300">   // If calling this function causes us to open the db (i.e., it was not</span>
<a href="#l10.5301"></a><span id="l10.5301">   // open before), we're going to close the db before returning.</span>
<a href="#l10.5302"></a><span id="l10.5302">   bool dbWasOpen = mDatabase != nullptr;</span>
<a href="#l10.5303"></a><span id="l10.5303"> </span>
<a href="#l10.5304"></a><span id="l10.5304">   ReadDBFolderInfo(false);</span>
<a href="#l10.5305"></a><span id="l10.5305">   // OnFlagChange can be expensive, so don't call it if we don't need to</span>
<a href="#l10.5306"></a><span id="l10.5306">   bool flagSet;</span>
<a href="#l10.5307"></a><span id="l10.5307">   nsresult rv;</span>
<a href="#l10.5308"></a><span id="l10.5308"> </span>
<a href="#l10.5309"></a><span id="l10.5309" class="difflineminus">-  if (NS_FAILED(rv = GetFlag(flag, &amp;flagSet)))</span>
<a href="#l10.5310"></a><span id="l10.5310" class="difflineminus">-    return rv;</span>
<a href="#l10.5311"></a><span id="l10.5311" class="difflineminus">-</span>
<a href="#l10.5312"></a><span id="l10.5312" class="difflineminus">-  if (!flagSet)</span>
<a href="#l10.5313"></a><span id="l10.5313" class="difflineminus">-  {</span>
<a href="#l10.5314"></a><span id="l10.5314" class="difflineplus">+  if (NS_FAILED(rv = GetFlag(flag, &amp;flagSet))) return rv;</span>
<a href="#l10.5315"></a><span id="l10.5315" class="difflineplus">+</span>
<a href="#l10.5316"></a><span id="l10.5316" class="difflineplus">+  if (!flagSet) {</span>
<a href="#l10.5317"></a><span id="l10.5317">     mFlags |= flag;</span>
<a href="#l10.5318"></a><span id="l10.5318">     OnFlagChange(flag);</span>
<a href="#l10.5319"></a><span id="l10.5319">   }</span>
<a href="#l10.5320"></a><span id="l10.5320" class="difflineminus">-  if (!dbWasOpen &amp;&amp; mDatabase)</span>
<a href="#l10.5321"></a><span id="l10.5321" class="difflineminus">-    SetMsgDatabase(nullptr);</span>
<a href="#l10.5322"></a><span id="l10.5322" class="difflineplus">+  if (!dbWasOpen &amp;&amp; mDatabase) SetMsgDatabase(nullptr);</span>
<a href="#l10.5323"></a><span id="l10.5323"> </span>
<a href="#l10.5324"></a><span id="l10.5324">   return NS_OK;</span>
<a href="#l10.5325"></a><span id="l10.5325"> }</span>
<a href="#l10.5326"></a><span id="l10.5326"> </span>
<a href="#l10.5327"></a><span id="l10.5327" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ClearFlag(uint32_t flag)</span>
<a href="#l10.5328"></a><span id="l10.5328" class="difflineminus">-{</span>
<a href="#l10.5329"></a><span id="l10.5329" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ClearFlag(uint32_t flag) {</span>
<a href="#l10.5330"></a><span id="l10.5330">   // OnFlagChange can be expensive, so don't call it if we don't need to</span>
<a href="#l10.5331"></a><span id="l10.5331">   bool flagSet;</span>
<a href="#l10.5332"></a><span id="l10.5332">   nsresult rv;</span>
<a href="#l10.5333"></a><span id="l10.5333"> </span>
<a href="#l10.5334"></a><span id="l10.5334" class="difflineminus">-  if (NS_FAILED(rv = GetFlag(flag, &amp;flagSet)))</span>
<a href="#l10.5335"></a><span id="l10.5335" class="difflineminus">-    return rv;</span>
<a href="#l10.5336"></a><span id="l10.5336" class="difflineminus">-</span>
<a href="#l10.5337"></a><span id="l10.5337" class="difflineminus">-  if (flagSet)</span>
<a href="#l10.5338"></a><span id="l10.5338" class="difflineminus">-  {</span>
<a href="#l10.5339"></a><span id="l10.5339" class="difflineplus">+  if (NS_FAILED(rv = GetFlag(flag, &amp;flagSet))) return rv;</span>
<a href="#l10.5340"></a><span id="l10.5340" class="difflineplus">+</span>
<a href="#l10.5341"></a><span id="l10.5341" class="difflineplus">+  if (flagSet) {</span>
<a href="#l10.5342"></a><span id="l10.5342">     mFlags &amp;= ~flag;</span>
<a href="#l10.5343"></a><span id="l10.5343" class="difflineminus">-    OnFlagChange (flag);</span>
<a href="#l10.5344"></a><span id="l10.5344" class="difflineplus">+    OnFlagChange(flag);</span>
<a href="#l10.5345"></a><span id="l10.5345">   }</span>
<a href="#l10.5346"></a><span id="l10.5346"> </span>
<a href="#l10.5347"></a><span id="l10.5347">   return NS_OK;</span>
<a href="#l10.5348"></a><span id="l10.5348"> }</span>
<a href="#l10.5349"></a><span id="l10.5349"> </span>
<a href="#l10.5350"></a><span id="l10.5350" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetFlag(uint32_t flag, bool *_retval)</span>
<a href="#l10.5351"></a><span id="l10.5351" class="difflineminus">-{</span>
<a href="#l10.5352"></a><span id="l10.5352" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetFlag(uint32_t flag, bool *_retval) {</span>
<a href="#l10.5353"></a><span id="l10.5353">   *_retval = ((mFlags &amp; flag) != 0);</span>
<a href="#l10.5354"></a><span id="l10.5354">   return NS_OK;</span>
<a href="#l10.5355"></a><span id="l10.5355"> }</span>
<a href="#l10.5356"></a><span id="l10.5356"> </span>
<a href="#l10.5357"></a><span id="l10.5357" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ToggleFlag(uint32_t flag)</span>
<a href="#l10.5358"></a><span id="l10.5358" class="difflineminus">-{</span>
<a href="#l10.5359"></a><span id="l10.5359" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ToggleFlag(uint32_t flag) {</span>
<a href="#l10.5360"></a><span id="l10.5360">   mFlags ^= flag;</span>
<a href="#l10.5361"></a><span id="l10.5361" class="difflineminus">-  OnFlagChange (flag);</span>
<a href="#l10.5362"></a><span id="l10.5362" class="difflineplus">+  OnFlagChange(flag);</span>
<a href="#l10.5363"></a><span id="l10.5363"> </span>
<a href="#l10.5364"></a><span id="l10.5364">   return NS_OK;</span>
<a href="#l10.5365"></a><span id="l10.5365"> }</span>
<a href="#l10.5366"></a><span id="l10.5366"> </span>
<a href="#l10.5367"></a><span id="l10.5367" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OnFlagChange(uint32_t flag)</span>
<a href="#l10.5368"></a><span id="l10.5368" class="difflineminus">-{</span>
<a href="#l10.5369"></a><span id="l10.5369" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OnFlagChange(uint32_t flag) {</span>
<a href="#l10.5370"></a><span id="l10.5370">   nsresult rv = NS_OK;</span>
<a href="#l10.5371"></a><span id="l10.5371">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.5372"></a><span id="l10.5372">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.5373"></a><span id="l10.5373">   rv = GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.5374"></a><span id="l10.5374" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l10.5375"></a><span id="l10.5375" class="difflineminus">-  {</span>
<a href="#l10.5376"></a><span id="l10.5376" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo) {</span>
<a href="#l10.5377"></a><span id="l10.5377"> #ifdef DEBUG_bienvenu1</span>
<a href="#l10.5378"></a><span id="l10.5378" class="difflineminus">-     nsString name;</span>
<a href="#l10.5379"></a><span id="l10.5379" class="difflineminus">-     rv = GetName(name);</span>
<a href="#l10.5380"></a><span id="l10.5380" class="difflineminus">-     NS_ASSERTION(Compare(name, kLocalizedTrashName) || (mFlags &amp; nsMsgFolderFlags::Trash), &quot;lost trash flag&quot;);</span>
<a href="#l10.5381"></a><span id="l10.5381" class="difflineplus">+    nsString name;</span>
<a href="#l10.5382"></a><span id="l10.5382" class="difflineplus">+    rv = GetName(name);</span>
<a href="#l10.5383"></a><span id="l10.5383" class="difflineplus">+    NS_ASSERTION(Compare(name, kLocalizedTrashName) ||</span>
<a href="#l10.5384"></a><span id="l10.5384" class="difflineplus">+                     (mFlags &amp; nsMsgFolderFlags::Trash),</span>
<a href="#l10.5385"></a><span id="l10.5385" class="difflineplus">+                 &quot;lost trash flag&quot;);</span>
<a href="#l10.5386"></a><span id="l10.5386"> #endif</span>
<a href="#l10.5387"></a><span id="l10.5387" class="difflineminus">-    folderInfo-&gt;SetFlags((int32_t) mFlags);</span>
<a href="#l10.5388"></a><span id="l10.5388" class="difflineminus">-    if (db)</span>
<a href="#l10.5389"></a><span id="l10.5389" class="difflineminus">-      db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.5390"></a><span id="l10.5390" class="difflineplus">+    folderInfo-&gt;SetFlags((int32_t)mFlags);</span>
<a href="#l10.5391"></a><span id="l10.5391" class="difflineplus">+    if (db) db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.5392"></a><span id="l10.5392"> </span>
<a href="#l10.5393"></a><span id="l10.5393">     if (mFlags &amp; flag)</span>
<a href="#l10.5394"></a><span id="l10.5394">       NotifyIntPropertyChanged(kFolderFlag, mFlags &amp; ~flag, mFlags);</span>
<a href="#l10.5395"></a><span id="l10.5395">     else</span>
<a href="#l10.5396"></a><span id="l10.5396">       NotifyIntPropertyChanged(kFolderFlag, mFlags | flag, mFlags);</span>
<a href="#l10.5397"></a><span id="l10.5397"> </span>
<a href="#l10.5398"></a><span id="l10.5398" class="difflineminus">-    if (flag &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l10.5399"></a><span id="l10.5399" class="difflineminus">-    {</span>
<a href="#l10.5400"></a><span id="l10.5400" class="difflineplus">+    if (flag &amp; nsMsgFolderFlags::Offline) {</span>
<a href="#l10.5401"></a><span id="l10.5401">       bool newValue = mFlags &amp; nsMsgFolderFlags::Offline;</span>
<a href="#l10.5402"></a><span id="l10.5402">       rv = NotifyBoolPropertyChanged(kSynchronize, !newValue, !!newValue);</span>
<a href="#l10.5403"></a><span id="l10.5403" class="difflineminus">-    }</span>
<a href="#l10.5404"></a><span id="l10.5404" class="difflineminus">-    else if (flag &amp; nsMsgFolderFlags::Elided)</span>
<a href="#l10.5405"></a><span id="l10.5405" class="difflineminus">-    {</span>
<a href="#l10.5406"></a><span id="l10.5406" class="difflineplus">+    } else if (flag &amp; nsMsgFolderFlags::Elided) {</span>
<a href="#l10.5407"></a><span id="l10.5407">       bool newValue = mFlags &amp; nsMsgFolderFlags::Elided;</span>
<a href="#l10.5408"></a><span id="l10.5408">       rv = NotifyBoolPropertyChanged(kOpen, !!newValue, !newValue);</span>
<a href="#l10.5409"></a><span id="l10.5409">     }</span>
<a href="#l10.5410"></a><span id="l10.5410">   }</span>
<a href="#l10.5411"></a><span id="l10.5411">   return rv;</span>
<a href="#l10.5412"></a><span id="l10.5412"> }</span>
<a href="#l10.5413"></a><span id="l10.5413"> </span>
<a href="#l10.5414"></a><span id="l10.5414" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetFlags(uint32_t aFlags)</span>
<a href="#l10.5415"></a><span id="l10.5415" class="difflineminus">-{</span>
<a href="#l10.5416"></a><span id="l10.5416" class="difflineminus">-  if (mFlags != aFlags)</span>
<a href="#l10.5417"></a><span id="l10.5417" class="difflineminus">-  {</span>
<a href="#l10.5418"></a><span id="l10.5418" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetFlags(uint32_t aFlags) {</span>
<a href="#l10.5419"></a><span id="l10.5419" class="difflineplus">+  if (mFlags != aFlags) {</span>
<a href="#l10.5420"></a><span id="l10.5420">     uint32_t changedFlags = aFlags ^ mFlags;</span>
<a href="#l10.5421"></a><span id="l10.5421">     mFlags = aFlags;</span>
<a href="#l10.5422"></a><span id="l10.5422">     OnFlagChange(changedFlags);</span>
<a href="#l10.5423"></a><span id="l10.5423">   }</span>
<a href="#l10.5424"></a><span id="l10.5424">   return NS_OK;</span>
<a href="#l10.5425"></a><span id="l10.5425"> }</span>
<a href="#l10.5426"></a><span id="l10.5426"> </span>
<a href="#l10.5427"></a><span id="l10.5427" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetFolderWithFlags(uint32_t aFlags, nsIMsgFolder** aResult)</span>
<a href="#l10.5428"></a><span id="l10.5428" class="difflineminus">-{</span>
<a href="#l10.5429"></a><span id="l10.5429" class="difflineminus">-  if ((mFlags &amp; aFlags) == aFlags)</span>
<a href="#l10.5430"></a><span id="l10.5430" class="difflineminus">-  {</span>
<a href="#l10.5431"></a><span id="l10.5431" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetFolderWithFlags(uint32_t aFlags,</span>
<a href="#l10.5432"></a><span id="l10.5432" class="difflineplus">+                                                nsIMsgFolder **aResult) {</span>
<a href="#l10.5433"></a><span id="l10.5433" class="difflineplus">+  if ((mFlags &amp; aFlags) == aFlags) {</span>
<a href="#l10.5434"></a><span id="l10.5434">     NS_ADDREF(*aResult = this);</span>
<a href="#l10.5435"></a><span id="l10.5435">     return NS_OK;</span>
<a href="#l10.5436"></a><span id="l10.5436">   }</span>
<a href="#l10.5437"></a><span id="l10.5437"> </span>
<a href="#l10.5438"></a><span id="l10.5438">   nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l10.5439"></a><span id="l10.5439" class="difflineminus">-  GetSubFolders(getter_AddRefs(dummy)); // initialize mSubFolders</span>
<a href="#l10.5440"></a><span id="l10.5440" class="difflineplus">+  GetSubFolders(getter_AddRefs(dummy));  // initialize mSubFolders</span>
<a href="#l10.5441"></a><span id="l10.5441"> </span>
<a href="#l10.5442"></a><span id="l10.5442">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.5443"></a><span id="l10.5443">   *aResult = nullptr;</span>
<a href="#l10.5444"></a><span id="l10.5444">   for (int32_t i = 0; !*aResult &amp;&amp; i &lt; count; ++i)</span>
<a href="#l10.5445"></a><span id="l10.5445">     mSubFolders[i]-&gt;GetFolderWithFlags(aFlags, aResult);</span>
<a href="#l10.5446"></a><span id="l10.5446"> </span>
<a href="#l10.5447"></a><span id="l10.5447">   return NS_OK;</span>
<a href="#l10.5448"></a><span id="l10.5448"> }</span>
<a href="#l10.5449"></a><span id="l10.5449"> </span>
<a href="#l10.5450"></a><span id="l10.5450" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetFoldersWithFlags(uint32_t aFlags, nsIArray** aResult)</span>
<a href="#l10.5451"></a><span id="l10.5451" class="difflineminus">-{</span>
<a href="#l10.5452"></a><span id="l10.5452" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetFoldersWithFlags(uint32_t aFlags,</span>
<a href="#l10.5453"></a><span id="l10.5453" class="difflineplus">+                                                 nsIArray **aResult) {</span>
<a href="#l10.5454"></a><span id="l10.5454">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.5455"></a><span id="l10.5455"> </span>
<a href="#l10.5456"></a><span id="l10.5456">   nsresult rv;</span>
<a href="#l10.5457"></a><span id="l10.5457">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l10.5458"></a><span id="l10.5458">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5459"></a><span id="l10.5459"> </span>
<a href="#l10.5460"></a><span id="l10.5460">   ListFoldersWithFlags(aFlags, array);</span>
<a href="#l10.5461"></a><span id="l10.5461">   array.forget(aResult);</span>
<a href="#l10.5462"></a><span id="l10.5462">   return NS_OK;</span>
<a href="#l10.5463"></a><span id="l10.5463"> }</span>
<a href="#l10.5464"></a><span id="l10.5464"> </span>
<a href="#l10.5465"></a><span id="l10.5465" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ListFoldersWithFlags(uint32_t aFlags, nsIMutableArray* aFolders)</span>
<a href="#l10.5466"></a><span id="l10.5466" class="difflineminus">-{</span>
<a href="#l10.5467"></a><span id="l10.5467" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ListFoldersWithFlags(uint32_t aFlags,</span>
<a href="#l10.5468"></a><span id="l10.5468" class="difflineplus">+                                                  nsIMutableArray *aFolders) {</span>
<a href="#l10.5469"></a><span id="l10.5469">   NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l10.5470"></a><span id="l10.5470">   if ((mFlags &amp; aFlags) == aFlags)</span>
<a href="#l10.5471"></a><span id="l10.5471" class="difflineminus">-    aFolders-&gt;AppendElement(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l10.5472"></a><span id="l10.5472" class="difflineplus">+    aFolders-&gt;AppendElement(static_cast&lt;nsIMsgFolder *&gt;(this));</span>
<a href="#l10.5473"></a><span id="l10.5473"> </span>
<a href="#l10.5474"></a><span id="l10.5474">   nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l10.5475"></a><span id="l10.5475" class="difflineminus">-  GetSubFolders(getter_AddRefs(dummy)); // initialize mSubFolders</span>
<a href="#l10.5476"></a><span id="l10.5476" class="difflineplus">+  GetSubFolders(getter_AddRefs(dummy));  // initialize mSubFolders</span>
<a href="#l10.5477"></a><span id="l10.5477"> </span>
<a href="#l10.5478"></a><span id="l10.5478">   int32_t count = mSubFolders.Count();</span>
<a href="#l10.5479"></a><span id="l10.5479">   for (int32_t i = 0; i &lt; count; ++i)</span>
<a href="#l10.5480"></a><span id="l10.5480">     mSubFolders[i]-&gt;ListFoldersWithFlags(aFlags, aFolders);</span>
<a href="#l10.5481"></a><span id="l10.5481"> </span>
<a href="#l10.5482"></a><span id="l10.5482">   return NS_OK;</span>
<a href="#l10.5483"></a><span id="l10.5483"> }</span>
<a href="#l10.5484"></a><span id="l10.5484"> </span>
<a href="#l10.5485"></a><span id="l10.5485"> NS_IMETHODIMP nsMsgDBFolder::IsSpecialFolder(uint32_t aFlags,</span>
<a href="#l10.5486"></a><span id="l10.5486">                                              bool aCheckAncestors,</span>
<a href="#l10.5487"></a><span id="l10.5487" class="difflineminus">-                                             bool *aIsSpecial)</span>
<a href="#l10.5488"></a><span id="l10.5488" class="difflineminus">-{</span>
<a href="#l10.5489"></a><span id="l10.5489" class="difflineplus">+                                             bool *aIsSpecial) {</span>
<a href="#l10.5490"></a><span id="l10.5490">   NS_ENSURE_ARG_POINTER(aIsSpecial);</span>
<a href="#l10.5491"></a><span id="l10.5491"> </span>
<a href="#l10.5492"></a><span id="l10.5492" class="difflineminus">-  if ((mFlags &amp; aFlags) == 0)</span>
<a href="#l10.5493"></a><span id="l10.5493" class="difflineminus">-  {</span>
<a href="#l10.5494"></a><span id="l10.5494" class="difflineplus">+  if ((mFlags &amp; aFlags) == 0) {</span>
<a href="#l10.5495"></a><span id="l10.5495">     nsCOMPtr&lt;nsIMsgFolder&gt; parentMsgFolder;</span>
<a href="#l10.5496"></a><span id="l10.5496">     GetParent(getter_AddRefs(parentMsgFolder));</span>
<a href="#l10.5497"></a><span id="l10.5497"> </span>
<a href="#l10.5498"></a><span id="l10.5498">     if (parentMsgFolder &amp;&amp; aCheckAncestors)</span>
<a href="#l10.5499"></a><span id="l10.5499">       parentMsgFolder-&gt;IsSpecialFolder(aFlags, aCheckAncestors, aIsSpecial);</span>
<a href="#l10.5500"></a><span id="l10.5500">     else</span>
<a href="#l10.5501"></a><span id="l10.5501">       *aIsSpecial = false;</span>
<a href="#l10.5502"></a><span id="l10.5502" class="difflineminus">-  }</span>
<a href="#l10.5503"></a><span id="l10.5503" class="difflineminus">-  else</span>
<a href="#l10.5504"></a><span id="l10.5504" class="difflineminus">-  {</span>
<a href="#l10.5505"></a><span id="l10.5505" class="difflineplus">+  } else {</span>
<a href="#l10.5506"></a><span id="l10.5506">     // The user can set their INBOX to be their SENT folder.</span>
<a href="#l10.5507"></a><span id="l10.5507">     // in that case, we want this folder to act like an INBOX,</span>
<a href="#l10.5508"></a><span id="l10.5508">     // and not a SENT folder</span>
<a href="#l10.5509"></a><span id="l10.5509">     *aIsSpecial = !((aFlags &amp; nsMsgFolderFlags::SentMail) &amp;&amp;</span>
<a href="#l10.5510"></a><span id="l10.5510">                     (mFlags &amp; nsMsgFolderFlags::Inbox));</span>
<a href="#l10.5511"></a><span id="l10.5511">   }</span>
<a href="#l10.5512"></a><span id="l10.5512">   return NS_OK;</span>
<a href="#l10.5513"></a><span id="l10.5513"> }</span>
<a href="#l10.5514"></a><span id="l10.5514"> </span>
<a href="#l10.5515"></a><span id="l10.5515" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetDeletable(bool *deletable)</span>
<a href="#l10.5516"></a><span id="l10.5516" class="difflineminus">-{</span>
<a href="#l10.5517"></a><span id="l10.5517" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetDeletable(bool *deletable) {</span>
<a href="#l10.5518"></a><span id="l10.5518">   NS_ENSURE_ARG_POINTER(deletable);</span>
<a href="#l10.5519"></a><span id="l10.5519">   *deletable = false;</span>
<a href="#l10.5520"></a><span id="l10.5520">   return NS_OK;</span>
<a href="#l10.5521"></a><span id="l10.5521"> }</span>
<a href="#l10.5522"></a><span id="l10.5522"> </span>
<a href="#l10.5523"></a><span id="l10.5523" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetDisplayRecipients(bool *displayRecipients)</span>
<a href="#l10.5524"></a><span id="l10.5524" class="difflineminus">-{</span>
<a href="#l10.5525"></a><span id="l10.5525" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetDisplayRecipients(bool *displayRecipients) {</span>
<a href="#l10.5526"></a><span id="l10.5526">   *displayRecipients = false;</span>
<a href="#l10.5527"></a><span id="l10.5527" class="difflineminus">-  if (mFlags &amp; nsMsgFolderFlags::SentMail &amp;&amp; !(mFlags &amp; nsMsgFolderFlags::Inbox))</span>
<a href="#l10.5528"></a><span id="l10.5528" class="difflineplus">+  if (mFlags &amp; nsMsgFolderFlags::SentMail &amp;&amp;</span>
<a href="#l10.5529"></a><span id="l10.5529" class="difflineplus">+      !(mFlags &amp; nsMsgFolderFlags::Inbox))</span>
<a href="#l10.5530"></a><span id="l10.5530">     *displayRecipients = true;</span>
<a href="#l10.5531"></a><span id="l10.5531">   else if (mFlags &amp; nsMsgFolderFlags::Queue)</span>
<a href="#l10.5532"></a><span id="l10.5532">     *displayRecipients = true;</span>
<a href="#l10.5533"></a><span id="l10.5533">   return NS_OK;</span>
<a href="#l10.5534"></a><span id="l10.5534"> }</span>
<a href="#l10.5535"></a><span id="l10.5535"> </span>
<a href="#l10.5536"></a><span id="l10.5536" class="difflineminus">-</span>
<a href="#l10.5537"></a><span id="l10.5537" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::AcquireSemaphore(nsISupports *semHolder)</span>
<a href="#l10.5538"></a><span id="l10.5538" class="difflineminus">-{</span>
<a href="#l10.5539"></a><span id="l10.5539" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AcquireSemaphore(nsISupports *semHolder) {</span>
<a href="#l10.5540"></a><span id="l10.5540">   nsresult rv = NS_OK;</span>
<a href="#l10.5541"></a><span id="l10.5541">   if (mSemaphoreHolder == NULL)</span>
<a href="#l10.5542"></a><span id="l10.5542" class="difflineminus">-    mSemaphoreHolder = semHolder; //Don't AddRef due to ownership issues.</span>
<a href="#l10.5543"></a><span id="l10.5543" class="difflineplus">+    mSemaphoreHolder = semHolder;  // Don't AddRef due to ownership issues.</span>
<a href="#l10.5544"></a><span id="l10.5544">   else</span>
<a href="#l10.5545"></a><span id="l10.5545">     rv = NS_MSG_FOLDER_BUSY;</span>
<a href="#l10.5546"></a><span id="l10.5546">   return rv;</span>
<a href="#l10.5547"></a><span id="l10.5547"> }</span>
<a href="#l10.5548"></a><span id="l10.5548"> </span>
<a href="#l10.5549"></a><span id="l10.5549" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ReleaseSemaphore(nsISupports *semHolder)</span>
<a href="#l10.5550"></a><span id="l10.5550" class="difflineminus">-{</span>
<a href="#l10.5551"></a><span id="l10.5551" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ReleaseSemaphore(nsISupports *semHolder) {</span>
<a href="#l10.5552"></a><span id="l10.5552">   if (!mSemaphoreHolder || mSemaphoreHolder == semHolder)</span>
<a href="#l10.5553"></a><span id="l10.5553">     mSemaphoreHolder = NULL;</span>
<a href="#l10.5554"></a><span id="l10.5554">   return NS_OK;</span>
<a href="#l10.5555"></a><span id="l10.5555"> }</span>
<a href="#l10.5556"></a><span id="l10.5556"> </span>
<a href="#l10.5557"></a><span id="l10.5557" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::TestSemaphore(nsISupports *semHolder, bool *result)</span>
<a href="#l10.5558"></a><span id="l10.5558" class="difflineminus">-{</span>
<a href="#l10.5559"></a><span id="l10.5559" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::TestSemaphore(nsISupports *semHolder,</span>
<a href="#l10.5560"></a><span id="l10.5560" class="difflineplus">+                                           bool *result) {</span>
<a href="#l10.5561"></a><span id="l10.5561">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l10.5562"></a><span id="l10.5562">   *result = (mSemaphoreHolder == semHolder);</span>
<a href="#l10.5563"></a><span id="l10.5563">   return NS_OK;</span>
<a href="#l10.5564"></a><span id="l10.5564"> }</span>
<a href="#l10.5565"></a><span id="l10.5565"> </span>
<a href="#l10.5566"></a><span id="l10.5566" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetLocked(bool *isLocked)</span>
<a href="#l10.5567"></a><span id="l10.5567" class="difflineminus">-{</span>
<a href="#l10.5568"></a><span id="l10.5568" class="difflineminus">-  *isLocked =  mSemaphoreHolder != NULL;</span>
<a href="#l10.5569"></a><span id="l10.5569" class="difflineminus">-  return  NS_OK;</span>
<a href="#l10.5570"></a><span id="l10.5570" class="difflineminus">-}</span>
<a href="#l10.5571"></a><span id="l10.5571" class="difflineminus">-</span>
<a href="#l10.5572"></a><span id="l10.5572" class="difflineminus">-</span>
<a href="#l10.5573"></a><span id="l10.5573" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetRelativePathName(nsACString&amp; pathName)</span>
<a href="#l10.5574"></a><span id="l10.5574" class="difflineminus">-{</span>
<a href="#l10.5575"></a><span id="l10.5575" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetLocked(bool *isLocked) {</span>
<a href="#l10.5576"></a><span id="l10.5576" class="difflineplus">+  *isLocked = mSemaphoreHolder != NULL;</span>
<a href="#l10.5577"></a><span id="l10.5577" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.5578"></a><span id="l10.5578" class="difflineplus">+}</span>
<a href="#l10.5579"></a><span id="l10.5579" class="difflineplus">+</span>
<a href="#l10.5580"></a><span id="l10.5580" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetRelativePathName(nsACString &amp;pathName) {</span>
<a href="#l10.5581"></a><span id="l10.5581">   pathName.Truncate();</span>
<a href="#l10.5582"></a><span id="l10.5582">   return NS_OK;</span>
<a href="#l10.5583"></a><span id="l10.5583"> }</span>
<a href="#l10.5584"></a><span id="l10.5584"> </span>
<a href="#l10.5585"></a><span id="l10.5585" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetSizeOnDisk(int64_t *size)</span>
<a href="#l10.5586"></a><span id="l10.5586" class="difflineminus">-{</span>
<a href="#l10.5587"></a><span id="l10.5587" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetSizeOnDisk(int64_t *size) {</span>
<a href="#l10.5588"></a><span id="l10.5588">   NS_ENSURE_ARG_POINTER(size);</span>
<a href="#l10.5589"></a><span id="l10.5589">   *size = kSizeUnknown;</span>
<a href="#l10.5590"></a><span id="l10.5590">   return NS_OK;</span>
<a href="#l10.5591"></a><span id="l10.5591"> }</span>
<a href="#l10.5592"></a><span id="l10.5592"> </span>
<a href="#l10.5593"></a><span id="l10.5593" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetSizeOnDisk(int64_t aSizeOnDisk)</span>
<a href="#l10.5594"></a><span id="l10.5594" class="difflineminus">-{</span>
<a href="#l10.5595"></a><span id="l10.5595" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetSizeOnDisk(int64_t aSizeOnDisk) {</span>
<a href="#l10.5596"></a><span id="l10.5596">   NotifyIntPropertyChanged(kFolderSize, mFolderSize, aSizeOnDisk);</span>
<a href="#l10.5597"></a><span id="l10.5597">   mFolderSize = aSizeOnDisk;</span>
<a href="#l10.5598"></a><span id="l10.5598">   return NS_OK;</span>
<a href="#l10.5599"></a><span id="l10.5599"> }</span>
<a href="#l10.5600"></a><span id="l10.5600"> </span>
<a href="#l10.5601"></a><span id="l10.5601" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetUsername(nsACString&amp; userName)</span>
<a href="#l10.5602"></a><span id="l10.5602" class="difflineminus">-{</span>
<a href="#l10.5603"></a><span id="l10.5603" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetUsername(nsACString &amp;userName) {</span>
<a href="#l10.5604"></a><span id="l10.5604">   nsresult rv;</span>
<a href="#l10.5605"></a><span id="l10.5605" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.5606"></a><span id="l10.5606" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.5607"></a><span id="l10.5607">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.5608"></a><span id="l10.5608">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5609"></a><span id="l10.5609">   return server-&gt;GetUsername(userName);</span>
<a href="#l10.5610"></a><span id="l10.5610"> }</span>
<a href="#l10.5611"></a><span id="l10.5611"> </span>
<a href="#l10.5612"></a><span id="l10.5612" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetHostname(nsACString&amp; hostName)</span>
<a href="#l10.5613"></a><span id="l10.5613" class="difflineminus">-{</span>
<a href="#l10.5614"></a><span id="l10.5614" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetHostname(nsACString &amp;hostName) {</span>
<a href="#l10.5615"></a><span id="l10.5615">   nsresult rv;</span>
<a href="#l10.5616"></a><span id="l10.5616">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.5617"></a><span id="l10.5617">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.5618"></a><span id="l10.5618">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5619"></a><span id="l10.5619">   return server-&gt;GetHostName(hostName);</span>
<a href="#l10.5620"></a><span id="l10.5620"> }</span>
<a href="#l10.5621"></a><span id="l10.5621"> </span>
<a href="#l10.5622"></a><span id="l10.5622" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetNewMessages(nsIMsgWindow *, nsIUrlListener * /* aListener */)</span>
<a href="#l10.5623"></a><span id="l10.5623" class="difflineminus">-{</span>
<a href="#l10.5624"></a><span id="l10.5624" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetNewMessages(nsIMsgWindow *,</span>
<a href="#l10.5625"></a><span id="l10.5625" class="difflineplus">+                                            nsIUrlListener * /* aListener */) {</span>
<a href="#l10.5626"></a><span id="l10.5626">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.5627"></a><span id="l10.5627"> }</span>
<a href="#l10.5628"></a><span id="l10.5628"> </span>
<a href="#l10.5629"></a><span id="l10.5629" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetBiffState(uint32_t *aBiffState)</span>
<a href="#l10.5630"></a><span id="l10.5630" class="difflineminus">-{</span>
<a href="#l10.5631"></a><span id="l10.5631" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetBiffState(uint32_t *aBiffState) {</span>
<a href="#l10.5632"></a><span id="l10.5632">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.5633"></a><span id="l10.5633">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.5634"></a><span id="l10.5634">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5635"></a><span id="l10.5635">   return server-&gt;GetBiffState(aBiffState);</span>
<a href="#l10.5636"></a><span id="l10.5636"> }</span>
<a href="#l10.5637"></a><span id="l10.5637"> </span>
<a href="#l10.5638"></a><span id="l10.5638" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetBiffState(uint32_t aBiffState)</span>
<a href="#l10.5639"></a><span id="l10.5639" class="difflineminus">-{</span>
<a href="#l10.5640"></a><span id="l10.5640" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetBiffState(uint32_t aBiffState) {</span>
<a href="#l10.5641"></a><span id="l10.5641">   uint32_t oldBiffState = nsMsgBiffState_Unknown;</span>
<a href="#l10.5642"></a><span id="l10.5642">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.5643"></a><span id="l10.5643">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.5644"></a><span id="l10.5644" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l10.5645"></a><span id="l10.5645" class="difflineminus">-    rv = server-&gt;GetBiffState(&amp;oldBiffState);</span>
<a href="#l10.5646"></a><span id="l10.5646" class="difflineminus">-</span>
<a href="#l10.5647"></a><span id="l10.5647" class="difflineminus">-  if (oldBiffState != aBiffState)</span>
<a href="#l10.5648"></a><span id="l10.5648" class="difflineminus">-  {</span>
<a href="#l10.5649"></a><span id="l10.5649" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; server) rv = server-&gt;GetBiffState(&amp;oldBiffState);</span>
<a href="#l10.5650"></a><span id="l10.5650" class="difflineplus">+</span>
<a href="#l10.5651"></a><span id="l10.5651" class="difflineplus">+  if (oldBiffState != aBiffState) {</span>
<a href="#l10.5652"></a><span id="l10.5652">     // Get the server and notify it and not inbox.</span>
<a href="#l10.5653"></a><span id="l10.5653" class="difflineminus">-    if (!mIsServer)</span>
<a href="#l10.5654"></a><span id="l10.5654" class="difflineminus">-    {</span>
<a href="#l10.5655"></a><span id="l10.5655" class="difflineplus">+    if (!mIsServer) {</span>
<a href="#l10.5656"></a><span id="l10.5656">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.5657"></a><span id="l10.5657">       rv = GetRootFolder(getter_AddRefs(folder));</span>
<a href="#l10.5658"></a><span id="l10.5658" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l10.5659"></a><span id="l10.5659" class="difflineminus">-        return folder-&gt;SetBiffState(aBiffState);</span>
<a href="#l10.5660"></a><span id="l10.5660" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; folder) return folder-&gt;SetBiffState(aBiffState);</span>
<a href="#l10.5661"></a><span id="l10.5661">     }</span>
<a href="#l10.5662"></a><span id="l10.5662" class="difflineminus">-    if (server)</span>
<a href="#l10.5663"></a><span id="l10.5663" class="difflineminus">-      server-&gt;SetBiffState(aBiffState);</span>
<a href="#l10.5664"></a><span id="l10.5664" class="difflineplus">+    if (server) server-&gt;SetBiffState(aBiffState);</span>
<a href="#l10.5665"></a><span id="l10.5665"> </span>
<a href="#l10.5666"></a><span id="l10.5666">     NotifyIntPropertyChanged(kBiffState, oldBiffState, aBiffState);</span>
<a href="#l10.5667"></a><span id="l10.5667" class="difflineminus">-  }</span>
<a href="#l10.5668"></a><span id="l10.5668" class="difflineminus">-  else if (aBiffState == oldBiffState &amp;&amp; aBiffState == nsMsgBiffState_NewMail)</span>
<a href="#l10.5669"></a><span id="l10.5669" class="difflineminus">-  {</span>
<a href="#l10.5670"></a><span id="l10.5670" class="difflineplus">+  } else if (aBiffState == oldBiffState &amp;&amp;</span>
<a href="#l10.5671"></a><span id="l10.5671" class="difflineplus">+             aBiffState == nsMsgBiffState_NewMail) {</span>
<a href="#l10.5672"></a><span id="l10.5672">     // The folder has been updated, so update the MRUTime</span>
<a href="#l10.5673"></a><span id="l10.5673">     SetMRUTime();</span>
<a href="#l10.5674"></a><span id="l10.5674" class="difflineminus">-    // biff is already set, but notify that there is additional new mail for the folder</span>
<a href="#l10.5675"></a><span id="l10.5675" class="difflineplus">+    // biff is already set, but notify that there is additional new mail for the</span>
<a href="#l10.5676"></a><span id="l10.5676" class="difflineplus">+    // folder</span>
<a href="#l10.5677"></a><span id="l10.5677">     NotifyIntPropertyChanged(kNewMailReceived, 0, mNumNewBiffMessages);</span>
<a href="#l10.5678"></a><span id="l10.5678" class="difflineminus">-  }</span>
<a href="#l10.5679"></a><span id="l10.5679" class="difflineminus">-  else if (aBiffState == nsMsgBiffState_NoMail)</span>
<a href="#l10.5680"></a><span id="l10.5680" class="difflineminus">-  {</span>
<a href="#l10.5681"></a><span id="l10.5681" class="difflineminus">-    // even if the old biff state equals the new biff state, it is still possible that we've never</span>
<a href="#l10.5682"></a><span id="l10.5682" class="difflineminus">-    // cleared the number of new messages for this particular folder. This happens when the new mail state</span>
<a href="#l10.5683"></a><span id="l10.5683" class="difflineminus">-    // got cleared by viewing a new message in folder that is different from this one. Biff state is stored per server</span>
<a href="#l10.5684"></a><span id="l10.5684" class="difflineplus">+  } else if (aBiffState == nsMsgBiffState_NoMail) {</span>
<a href="#l10.5685"></a><span id="l10.5685" class="difflineplus">+    // even if the old biff state equals the new biff state, it is still</span>
<a href="#l10.5686"></a><span id="l10.5686" class="difflineplus">+    // possible that we've never cleared the number of new messages for this</span>
<a href="#l10.5687"></a><span id="l10.5687" class="difflineplus">+    // particular folder. This happens when the new mail state got cleared by</span>
<a href="#l10.5688"></a><span id="l10.5688" class="difflineplus">+    // viewing a new message in folder that is different from this one. Biff</span>
<a href="#l10.5689"></a><span id="l10.5689" class="difflineplus">+    // state is stored per server</span>
<a href="#l10.5690"></a><span id="l10.5690">     //  the num. of new messages is per folder.</span>
<a href="#l10.5691"></a><span id="l10.5691">     SetNumNewMessages(0);</span>
<a href="#l10.5692"></a><span id="l10.5692">   }</span>
<a href="#l10.5693"></a><span id="l10.5693">   return NS_OK;</span>
<a href="#l10.5694"></a><span id="l10.5694"> }</span>
<a href="#l10.5695"></a><span id="l10.5695"> </span>
<a href="#l10.5696"></a><span id="l10.5696" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetNumNewMessages(bool deep, int32_t *aNumNewMessages)</span>
<a href="#l10.5697"></a><span id="l10.5697" class="difflineminus">-{</span>
<a href="#l10.5698"></a><span id="l10.5698" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetNumNewMessages(bool deep,</span>
<a href="#l10.5699"></a><span id="l10.5699" class="difflineplus">+                                               int32_t *aNumNewMessages) {</span>
<a href="#l10.5700"></a><span id="l10.5700">   NS_ENSURE_ARG_POINTER(aNumNewMessages);</span>
<a href="#l10.5701"></a><span id="l10.5701"> </span>
<a href="#l10.5702"></a><span id="l10.5702" class="difflineminus">-  int32_t numNewMessages = (!deep || ! (mFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.5703"></a><span id="l10.5703" class="difflineminus">-    ? mNumNewBiffMessages : 0;</span>
<a href="#l10.5704"></a><span id="l10.5704" class="difflineminus">-  if (deep)</span>
<a href="#l10.5705"></a><span id="l10.5705" class="difflineminus">-  {</span>
<a href="#l10.5706"></a><span id="l10.5706" class="difflineplus">+  int32_t numNewMessages = (!deep || !(mFlags &amp; nsMsgFolderFlags::Virtual))</span>
<a href="#l10.5707"></a><span id="l10.5707" class="difflineplus">+                               ? mNumNewBiffMessages</span>
<a href="#l10.5708"></a><span id="l10.5708" class="difflineplus">+                               : 0;</span>
<a href="#l10.5709"></a><span id="l10.5709" class="difflineplus">+  if (deep) {</span>
<a href="#l10.5710"></a><span id="l10.5710">     int32_t count = mSubFolders.Count();</span>
<a href="#l10.5711"></a><span id="l10.5711" class="difflineminus">-    for (int32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5712"></a><span id="l10.5712" class="difflineminus">-    {</span>
<a href="#l10.5713"></a><span id="l10.5713" class="difflineplus">+    for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5714"></a><span id="l10.5714">       int32_t num;</span>
<a href="#l10.5715"></a><span id="l10.5715">       mSubFolders[i]-&gt;GetNumNewMessages(deep, &amp;num);</span>
<a href="#l10.5716"></a><span id="l10.5716" class="difflineminus">-      if (num &gt; 0) // it's legal for counts to be negative if we don't know</span>
<a href="#l10.5717"></a><span id="l10.5717" class="difflineplus">+      if (num &gt; 0)  // it's legal for counts to be negative if we don't know</span>
<a href="#l10.5718"></a><span id="l10.5718">         numNewMessages += num;</span>
<a href="#l10.5719"></a><span id="l10.5719">     }</span>
<a href="#l10.5720"></a><span id="l10.5720">   }</span>
<a href="#l10.5721"></a><span id="l10.5721">   *aNumNewMessages = numNewMessages;</span>
<a href="#l10.5722"></a><span id="l10.5722">   return NS_OK;</span>
<a href="#l10.5723"></a><span id="l10.5723"> }</span>
<a href="#l10.5724"></a><span id="l10.5724"> </span>
<a href="#l10.5725"></a><span id="l10.5725" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetNumNewMessages(int32_t aNumNewMessages)</span>
<a href="#l10.5726"></a><span id="l10.5726" class="difflineminus">-{</span>
<a href="#l10.5727"></a><span id="l10.5727" class="difflineminus">-  if (aNumNewMessages != mNumNewBiffMessages)</span>
<a href="#l10.5728"></a><span id="l10.5728" class="difflineminus">-  {</span>
<a href="#l10.5729"></a><span id="l10.5729" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetNumNewMessages(int32_t aNumNewMessages) {</span>
<a href="#l10.5730"></a><span id="l10.5730" class="difflineplus">+  if (aNumNewMessages != mNumNewBiffMessages) {</span>
<a href="#l10.5731"></a><span id="l10.5731">     int32_t oldNumMessages = mNumNewBiffMessages;</span>
<a href="#l10.5732"></a><span id="l10.5732">     mNumNewBiffMessages = aNumNewMessages;</span>
<a href="#l10.5733"></a><span id="l10.5733"> </span>
<a href="#l10.5734"></a><span id="l10.5734">     nsAutoCString oldNumMessagesStr;</span>
<a href="#l10.5735"></a><span id="l10.5735">     oldNumMessagesStr.AppendInt(oldNumMessages);</span>
<a href="#l10.5736"></a><span id="l10.5736">     nsAutoCString newNumMessagesStr;</span>
<a href="#l10.5737"></a><span id="l10.5737">     newNumMessagesStr.AppendInt(aNumNewMessages);</span>
<a href="#l10.5738"></a><span id="l10.5738" class="difflineminus">-    NotifyPropertyChanged(kNumNewBiffMessages, oldNumMessagesStr, newNumMessagesStr);</span>
<a href="#l10.5739"></a><span id="l10.5739" class="difflineplus">+    NotifyPropertyChanged(kNumNewBiffMessages, oldNumMessagesStr,</span>
<a href="#l10.5740"></a><span id="l10.5740" class="difflineplus">+                          newNumMessagesStr);</span>
<a href="#l10.5741"></a><span id="l10.5741">   }</span>
<a href="#l10.5742"></a><span id="l10.5742">   return NS_OK;</span>
<a href="#l10.5743"></a><span id="l10.5743"> }</span>
<a href="#l10.5744"></a><span id="l10.5744"> </span>
<a href="#l10.5745"></a><span id="l10.5745" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetRootFolder(nsIMsgFolder * *aRootFolder)</span>
<a href="#l10.5746"></a><span id="l10.5746" class="difflineminus">-{</span>
<a href="#l10.5747"></a><span id="l10.5747" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetRootFolder(nsIMsgFolder **aRootFolder) {</span>
<a href="#l10.5748"></a><span id="l10.5748">   NS_ENSURE_ARG_POINTER(aRootFolder);</span>
<a href="#l10.5749"></a><span id="l10.5749">   nsresult rv;</span>
<a href="#l10.5750"></a><span id="l10.5750">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.5751"></a><span id="l10.5751">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.5752"></a><span id="l10.5752">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5753"></a><span id="l10.5753">   return server-&gt;GetRootMsgFolder(aRootFolder);</span>
<a href="#l10.5754"></a><span id="l10.5754"> }</span>
<a href="#l10.5755"></a><span id="l10.5755"> </span>
<a href="#l10.5756"></a><span id="l10.5756"> NS_IMETHODIMP</span>
<a href="#l10.5757"></a><span id="l10.5757" class="difflineminus">-nsMsgDBFolder::SetFilePath(nsIFile *aFile)</span>
<a href="#l10.5758"></a><span id="l10.5758" class="difflineminus">-{</span>
<a href="#l10.5759"></a><span id="l10.5759" class="difflineplus">+nsMsgDBFolder::SetFilePath(nsIFile *aFile) {</span>
<a href="#l10.5760"></a><span id="l10.5760">   mPath = aFile;</span>
<a href="#l10.5761"></a><span id="l10.5761">   return NS_OK;</span>
<a href="#l10.5762"></a><span id="l10.5762"> }</span>
<a href="#l10.5763"></a><span id="l10.5763"> </span>
<a href="#l10.5764"></a><span id="l10.5764"> NS_IMETHODIMP</span>
<a href="#l10.5765"></a><span id="l10.5765" class="difflineminus">-nsMsgDBFolder::GetFilePath(nsIFile * *aFile)</span>
<a href="#l10.5766"></a><span id="l10.5766" class="difflineminus">-{</span>
<a href="#l10.5767"></a><span id="l10.5767" class="difflineplus">+nsMsgDBFolder::GetFilePath(nsIFile **aFile) {</span>
<a href="#l10.5768"></a><span id="l10.5768">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l10.5769"></a><span id="l10.5769">   nsresult rv;</span>
<a href="#l10.5770"></a><span id="l10.5770">   // make a new nsIFile object in case the caller</span>
<a href="#l10.5771"></a><span id="l10.5771">   // alters the underlying file object.</span>
<a href="#l10.5772"></a><span id="l10.5772" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.5773"></a><span id="l10.5773" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.5774"></a><span id="l10.5774">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5775"></a><span id="l10.5775" class="difflineminus">-  if (!mPath)</span>
<a href="#l10.5776"></a><span id="l10.5776" class="difflineminus">-    parseURI(true);</span>
<a href="#l10.5777"></a><span id="l10.5777" class="difflineplus">+  if (!mPath) parseURI(true);</span>
<a href="#l10.5778"></a><span id="l10.5778">   rv = file-&gt;InitWithFile(mPath);</span>
<a href="#l10.5779"></a><span id="l10.5779">   file.forget(aFile);</span>
<a href="#l10.5780"></a><span id="l10.5780">   return NS_OK;</span>
<a href="#l10.5781"></a><span id="l10.5781"> }</span>
<a href="#l10.5782"></a><span id="l10.5782"> </span>
<a href="#l10.5783"></a><span id="l10.5783" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetSummaryFile(nsIFile **aSummaryFile)</span>
<a href="#l10.5784"></a><span id="l10.5784" class="difflineminus">-{</span>
<a href="#l10.5785"></a><span id="l10.5785" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetSummaryFile(nsIFile **aSummaryFile) {</span>
<a href="#l10.5786"></a><span id="l10.5786">   NS_ENSURE_ARG_POINTER(aSummaryFile);</span>
<a href="#l10.5787"></a><span id="l10.5787"> </span>
<a href="#l10.5788"></a><span id="l10.5788">   nsresult rv;</span>
<a href="#l10.5789"></a><span id="l10.5789" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; newSummaryLocation =</span>
<a href="#l10.5790"></a><span id="l10.5790" class="difflineminus">-    do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.5791"></a><span id="l10.5791" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; newSummaryLocation =</span>
<a href="#l10.5792"></a><span id="l10.5792" class="difflineplus">+      do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.5793"></a><span id="l10.5793">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5794"></a><span id="l10.5794"> </span>
<a href="#l10.5795"></a><span id="l10.5795">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l10.5796"></a><span id="l10.5796">   rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l10.5797"></a><span id="l10.5797">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5798"></a><span id="l10.5798"> </span>
<a href="#l10.5799"></a><span id="l10.5799">   newSummaryLocation-&gt;InitWithFile(pathFile);</span>
<a href="#l10.5800"></a><span id="l10.5800"> </span>
<a href="#l10.5801"></a><span id="l10.5801" class="difflineat">@@ -4765,643 +4360,569 @@ NS_IMETHODIMP nsMsgDBFolder::GetSummaryF</span>
<a href="#l10.5802"></a><span id="l10.5802">   rv = newSummaryLocation-&gt;SetLeafName(fileName);</span>
<a href="#l10.5803"></a><span id="l10.5803">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5804"></a><span id="l10.5804"> </span>
<a href="#l10.5805"></a><span id="l10.5805">   newSummaryLocation.forget(aSummaryFile);</span>
<a href="#l10.5806"></a><span id="l10.5806">   return NS_OK;</span>
<a href="#l10.5807"></a><span id="l10.5807"> }</span>
<a href="#l10.5808"></a><span id="l10.5808"> </span>
<a href="#l10.5809"></a><span id="l10.5809"> NS_IMETHODIMP</span>
<a href="#l10.5810"></a><span id="l10.5810" class="difflineminus">-nsMsgDBFolder::MarkMessagesRead(nsIArray *messages, bool markRead)</span>
<a href="#l10.5811"></a><span id="l10.5811" class="difflineminus">-{</span>
<a href="#l10.5812"></a><span id="l10.5812" class="difflineplus">+nsMsgDBFolder::MarkMessagesRead(nsIArray *messages, bool markRead) {</span>
<a href="#l10.5813"></a><span id="l10.5813">   uint32_t count;</span>
<a href="#l10.5814"></a><span id="l10.5814">   nsresult rv;</span>
<a href="#l10.5815"></a><span id="l10.5815"> </span>
<a href="#l10.5816"></a><span id="l10.5816">   rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l10.5817"></a><span id="l10.5817">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5818"></a><span id="l10.5818"> </span>
<a href="#l10.5819"></a><span id="l10.5819" class="difflineminus">-  for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5820"></a><span id="l10.5820" class="difflineminus">-  {</span>
<a href="#l10.5821"></a><span id="l10.5821" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5822"></a><span id="l10.5822">     nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l10.5823"></a><span id="l10.5823" class="difflineminus">-    if (message)</span>
<a href="#l10.5824"></a><span id="l10.5824" class="difflineminus">-      rv = message-&gt;MarkRead(markRead);</span>
<a href="#l10.5825"></a><span id="l10.5825" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l10.5826"></a><span id="l10.5826" class="difflineminus">-      return rv;</span>
<a href="#l10.5827"></a><span id="l10.5827" class="difflineplus">+    if (message) rv = message-&gt;MarkRead(markRead);</span>
<a href="#l10.5828"></a><span id="l10.5828" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.5829"></a><span id="l10.5829">   }</span>
<a href="#l10.5830"></a><span id="l10.5830">   return NS_OK;</span>
<a href="#l10.5831"></a><span id="l10.5831"> }</span>
<a href="#l10.5832"></a><span id="l10.5832"> </span>
<a href="#l10.5833"></a><span id="l10.5833"> NS_IMETHODIMP</span>
<a href="#l10.5834"></a><span id="l10.5834" class="difflineminus">-nsMsgDBFolder::MarkMessagesFlagged(nsIArray *messages, bool markFlagged)</span>
<a href="#l10.5835"></a><span id="l10.5835" class="difflineminus">-{</span>
<a href="#l10.5836"></a><span id="l10.5836" class="difflineplus">+nsMsgDBFolder::MarkMessagesFlagged(nsIArray *messages, bool markFlagged) {</span>
<a href="#l10.5837"></a><span id="l10.5837">   uint32_t count;</span>
<a href="#l10.5838"></a><span id="l10.5838">   nsresult rv;</span>
<a href="#l10.5839"></a><span id="l10.5839"> </span>
<a href="#l10.5840"></a><span id="l10.5840">   rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l10.5841"></a><span id="l10.5841">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5842"></a><span id="l10.5842"> </span>
<a href="#l10.5843"></a><span id="l10.5843" class="difflineminus">-  for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5844"></a><span id="l10.5844" class="difflineminus">-  {</span>
<a href="#l10.5845"></a><span id="l10.5845" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5846"></a><span id="l10.5846">     nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l10.5847"></a><span id="l10.5847" class="difflineminus">-    if (message)</span>
<a href="#l10.5848"></a><span id="l10.5848" class="difflineminus">-      rv = message-&gt;MarkFlagged(markFlagged);</span>
<a href="#l10.5849"></a><span id="l10.5849" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l10.5850"></a><span id="l10.5850" class="difflineminus">-      return rv;</span>
<a href="#l10.5851"></a><span id="l10.5851" class="difflineplus">+    if (message) rv = message-&gt;MarkFlagged(markFlagged);</span>
<a href="#l10.5852"></a><span id="l10.5852" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.5853"></a><span id="l10.5853">   }</span>
<a href="#l10.5854"></a><span id="l10.5854">   return NS_OK;</span>
<a href="#l10.5855"></a><span id="l10.5855"> }</span>
<a href="#l10.5856"></a><span id="l10.5856"> </span>
<a href="#l10.5857"></a><span id="l10.5857"> NS_IMETHODIMP</span>
<a href="#l10.5858"></a><span id="l10.5858" class="difflineminus">-nsMsgDBFolder::SetLabelForMessages(nsIArray *aMessages, nsMsgLabelValue aLabel)</span>
<a href="#l10.5859"></a><span id="l10.5859" class="difflineminus">-{</span>
<a href="#l10.5860"></a><span id="l10.5860" class="difflineplus">+nsMsgDBFolder::SetLabelForMessages(nsIArray *aMessages,</span>
<a href="#l10.5861"></a><span id="l10.5861" class="difflineplus">+                                   nsMsgLabelValue aLabel) {</span>
<a href="#l10.5862"></a><span id="l10.5862">   NS_ENSURE_ARG(aMessages);</span>
<a href="#l10.5863"></a><span id="l10.5863">   GetDatabase();</span>
<a href="#l10.5864"></a><span id="l10.5864" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.5865"></a><span id="l10.5865" class="difflineminus">-  {</span>
<a href="#l10.5866"></a><span id="l10.5866" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.5867"></a><span id="l10.5867">     uint32_t count;</span>
<a href="#l10.5868"></a><span id="l10.5868">     nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l10.5869"></a><span id="l10.5869">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5870"></a><span id="l10.5870" class="difflineminus">-    for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5871"></a><span id="l10.5871" class="difflineminus">-    {</span>
<a href="#l10.5872"></a><span id="l10.5872" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5873"></a><span id="l10.5873">       nsMsgKey msgKey;</span>
<a href="#l10.5874"></a><span id="l10.5874">       nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l10.5875"></a><span id="l10.5875">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5876"></a><span id="l10.5876" class="difflineminus">-      (void) message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.5877"></a><span id="l10.5877" class="difflineplus">+      (void)message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.5878"></a><span id="l10.5878">       rv = mDatabase-&gt;SetLabel(msgKey, aLabel);</span>
<a href="#l10.5879"></a><span id="l10.5879">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5880"></a><span id="l10.5880">     }</span>
<a href="#l10.5881"></a><span id="l10.5881">   }</span>
<a href="#l10.5882"></a><span id="l10.5882">   return NS_OK;</span>
<a href="#l10.5883"></a><span id="l10.5883"> }</span>
<a href="#l10.5884"></a><span id="l10.5884"> </span>
<a href="#l10.5885"></a><span id="l10.5885"> NS_IMETHODIMP</span>
<a href="#l10.5886"></a><span id="l10.5886" class="difflineminus">-nsMsgDBFolder::SetJunkScoreForMessages(nsIArray *aMessages, const nsACString&amp; junkScore)</span>
<a href="#l10.5887"></a><span id="l10.5887" class="difflineminus">-{</span>
<a href="#l10.5888"></a><span id="l10.5888" class="difflineplus">+nsMsgDBFolder::SetJunkScoreForMessages(nsIArray *aMessages,</span>
<a href="#l10.5889"></a><span id="l10.5889" class="difflineplus">+                                       const nsACString &amp;junkScore) {</span>
<a href="#l10.5890"></a><span id="l10.5890">   NS_ENSURE_ARG(aMessages);</span>
<a href="#l10.5891"></a><span id="l10.5891">   nsresult rv = NS_OK;</span>
<a href="#l10.5892"></a><span id="l10.5892">   GetDatabase();</span>
<a href="#l10.5893"></a><span id="l10.5893" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.5894"></a><span id="l10.5894" class="difflineminus">-  {</span>
<a href="#l10.5895"></a><span id="l10.5895" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.5896"></a><span id="l10.5896">     uint32_t count;</span>
<a href="#l10.5897"></a><span id="l10.5897">     nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l10.5898"></a><span id="l10.5898">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5899"></a><span id="l10.5899"> </span>
<a href="#l10.5900"></a><span id="l10.5900" class="difflineminus">-    for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.5901"></a><span id="l10.5901" class="difflineminus">-    {</span>
<a href="#l10.5902"></a><span id="l10.5902" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.5903"></a><span id="l10.5903">       nsMsgKey msgKey;</span>
<a href="#l10.5904"></a><span id="l10.5904">       nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l10.5905"></a><span id="l10.5905">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5906"></a><span id="l10.5906" class="difflineminus">-      (void) message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.5907"></a><span id="l10.5907" class="difflineminus">-      mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, nsCString(junkScore).get());</span>
<a href="#l10.5908"></a><span id="l10.5908" class="difflineplus">+      (void)message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.5909"></a><span id="l10.5909" class="difflineplus">+      mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;,</span>
<a href="#l10.5910"></a><span id="l10.5910" class="difflineplus">+                                   nsCString(junkScore).get());</span>
<a href="#l10.5911"></a><span id="l10.5911">       mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;filter&quot;);</span>
<a href="#l10.5912"></a><span id="l10.5912">     }</span>
<a href="#l10.5913"></a><span id="l10.5913">   }</span>
<a href="#l10.5914"></a><span id="l10.5914">   return rv;</span>
<a href="#l10.5915"></a><span id="l10.5915"> }</span>
<a href="#l10.5916"></a><span id="l10.5916"> </span>
<a href="#l10.5917"></a><span id="l10.5917"> NS_IMETHODIMP</span>
<a href="#l10.5918"></a><span id="l10.5918" class="difflineminus">-nsMsgDBFolder::ApplyRetentionSettings()</span>
<a href="#l10.5919"></a><span id="l10.5919" class="difflineminus">-{</span>
<a href="#l10.5920"></a><span id="l10.5920" class="difflineminus">-  return ApplyRetentionSettings(true);</span>
<a href="#l10.5921"></a><span id="l10.5921" class="difflineminus">-}</span>
<a href="#l10.5922"></a><span id="l10.5922" class="difflineminus">-</span>
<a href="#l10.5923"></a><span id="l10.5923" class="difflineminus">-nsresult nsMsgDBFolder::ApplyRetentionSettings(bool deleteViaFolder)</span>
<a href="#l10.5924"></a><span id="l10.5924" class="difflineminus">-{</span>
<a href="#l10.5925"></a><span id="l10.5925" class="difflineminus">-  if (mFlags &amp; nsMsgFolderFlags::Virtual) // ignore virtual folders.</span>
<a href="#l10.5926"></a><span id="l10.5926" class="difflineplus">+nsMsgDBFolder::ApplyRetentionSettings() { return ApplyRetentionSettings(true); }</span>
<a href="#l10.5927"></a><span id="l10.5927" class="difflineplus">+</span>
<a href="#l10.5928"></a><span id="l10.5928" class="difflineplus">+nsresult nsMsgDBFolder::ApplyRetentionSettings(bool deleteViaFolder) {</span>
<a href="#l10.5929"></a><span id="l10.5929" class="difflineplus">+  if (mFlags &amp; nsMsgFolderFlags::Virtual)  // ignore virtual folders.</span>
<a href="#l10.5930"></a><span id="l10.5930">     return NS_OK;</span>
<a href="#l10.5931"></a><span id="l10.5931">   bool weOpenedDB = !mDatabase;</span>
<a href="#l10.5932"></a><span id="l10.5932">   nsCOMPtr&lt;nsIMsgRetentionSettings&gt; retentionSettings;</span>
<a href="#l10.5933"></a><span id="l10.5933">   nsresult rv = GetRetentionSettings(getter_AddRefs(retentionSettings));</span>
<a href="#l10.5934"></a><span id="l10.5934" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.5935"></a><span id="l10.5935" class="difflineminus">-  {</span>
<a href="#l10.5936"></a><span id="l10.5936" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.5937"></a><span id="l10.5937">     nsMsgRetainByPreference retainByPreference =</span>
<a href="#l10.5938"></a><span id="l10.5938" class="difflineminus">-      nsIMsgRetentionSettings::nsMsgRetainAll;</span>
<a href="#l10.5939"></a><span id="l10.5939" class="difflineplus">+        nsIMsgRetentionSettings::nsMsgRetainAll;</span>
<a href="#l10.5940"></a><span id="l10.5940"> </span>
<a href="#l10.5941"></a><span id="l10.5941">     retentionSettings-&gt;GetRetainByPreference(&amp;retainByPreference);</span>
<a href="#l10.5942"></a><span id="l10.5942" class="difflineminus">-    if (retainByPreference != nsIMsgRetentionSettings::nsMsgRetainAll)</span>
<a href="#l10.5943"></a><span id="l10.5943" class="difflineminus">-    {</span>
<a href="#l10.5944"></a><span id="l10.5944" class="difflineplus">+    if (retainByPreference != nsIMsgRetentionSettings::nsMsgRetainAll) {</span>
<a href="#l10.5945"></a><span id="l10.5945">       rv = GetDatabase();</span>
<a href="#l10.5946"></a><span id="l10.5946">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.5947"></a><span id="l10.5947">       if (mDatabase)</span>
<a href="#l10.5948"></a><span id="l10.5948" class="difflineminus">-        rv = mDatabase-&gt;ApplyRetentionSettings(retentionSettings, deleteViaFolder);</span>
<a href="#l10.5949"></a><span id="l10.5949" class="difflineplus">+        rv = mDatabase-&gt;ApplyRetentionSettings(retentionSettings,</span>
<a href="#l10.5950"></a><span id="l10.5950" class="difflineplus">+                                               deleteViaFolder);</span>
<a href="#l10.5951"></a><span id="l10.5951">     }</span>
<a href="#l10.5952"></a><span id="l10.5952">   }</span>
<a href="#l10.5953"></a><span id="l10.5953">   // we don't want applying retention settings to keep the db open, because</span>
<a href="#l10.5954"></a><span id="l10.5954">   // if we try to purge a bunch of folders, that will leave the dbs all open.</span>
<a href="#l10.5955"></a><span id="l10.5955">   // So if we opened the db, close it.</span>
<a href="#l10.5956"></a><span id="l10.5956" class="difflineminus">-  if (weOpenedDB)</span>
<a href="#l10.5957"></a><span id="l10.5957" class="difflineminus">-    CloseDBIfFolderNotOpen();</span>
<a href="#l10.5958"></a><span id="l10.5958" class="difflineplus">+  if (weOpenedDB) CloseDBIfFolderNotOpen();</span>
<a href="#l10.5959"></a><span id="l10.5959">   return rv;</span>
<a href="#l10.5960"></a><span id="l10.5960"> }</span>
<a href="#l10.5961"></a><span id="l10.5961"> </span>
<a href="#l10.5962"></a><span id="l10.5962"> NS_IMETHODIMP</span>
<a href="#l10.5963"></a><span id="l10.5963" class="difflineminus">-nsMsgDBFolder::DeleteMessages(nsIArray *messages,</span>
<a href="#l10.5964"></a><span id="l10.5964" class="difflineminus">-                              nsIMsgWindow *msgWindow,</span>
<a href="#l10.5965"></a><span id="l10.5965" class="difflineminus">-                              bool deleteStorage,</span>
<a href="#l10.5966"></a><span id="l10.5966" class="difflineminus">-                              bool isMove,</span>
<a href="#l10.5967"></a><span id="l10.5967" class="difflineplus">+nsMsgDBFolder::DeleteMessages(nsIArray *messages, nsIMsgWindow *msgWindow,</span>
<a href="#l10.5968"></a><span id="l10.5968" class="difflineplus">+                              bool deleteStorage, bool isMove,</span>
<a href="#l10.5969"></a><span id="l10.5969">                               nsIMsgCopyServiceListener *listener,</span>
<a href="#l10.5970"></a><span id="l10.5970" class="difflineminus">-                              bool allowUndo)</span>
<a href="#l10.5971"></a><span id="l10.5971" class="difflineminus">-{</span>
<a href="#l10.5972"></a><span id="l10.5972" class="difflineplus">+                              bool allowUndo) {</span>
<a href="#l10.5973"></a><span id="l10.5973">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.5974"></a><span id="l10.5974"> }</span>
<a href="#l10.5975"></a><span id="l10.5975"> </span>
<a href="#l10.5976"></a><span id="l10.5976"> NS_IMETHODIMP</span>
<a href="#l10.5977"></a><span id="l10.5977" class="difflineminus">-nsMsgDBFolder::CopyMessages(nsIMsgFolder* srcFolder,</span>
<a href="#l10.5978"></a><span id="l10.5978" class="difflineminus">-                          nsIArray *messages,</span>
<a href="#l10.5979"></a><span id="l10.5979" class="difflineminus">-                          bool isMove,</span>
<a href="#l10.5980"></a><span id="l10.5980" class="difflineminus">-                          nsIMsgWindow *window,</span>
<a href="#l10.5981"></a><span id="l10.5981" class="difflineminus">-                          nsIMsgCopyServiceListener* listener,</span>
<a href="#l10.5982"></a><span id="l10.5982" class="difflineminus">-                          bool isFolder,</span>
<a href="#l10.5983"></a><span id="l10.5983" class="difflineminus">-                          bool allowUndo)</span>
<a href="#l10.5984"></a><span id="l10.5984" class="difflineminus">-{</span>
<a href="#l10.5985"></a><span id="l10.5985" class="difflineplus">+nsMsgDBFolder::CopyMessages(nsIMsgFolder *srcFolder, nsIArray *messages,</span>
<a href="#l10.5986"></a><span id="l10.5986" class="difflineplus">+                            bool isMove, nsIMsgWindow *window,</span>
<a href="#l10.5987"></a><span id="l10.5987" class="difflineplus">+                            nsIMsgCopyServiceListener *listener, bool isFolder,</span>
<a href="#l10.5988"></a><span id="l10.5988" class="difflineplus">+                            bool allowUndo) {</span>
<a href="#l10.5989"></a><span id="l10.5989">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.5990"></a><span id="l10.5990"> }</span>
<a href="#l10.5991"></a><span id="l10.5991"> </span>
<a href="#l10.5992"></a><span id="l10.5992"> NS_IMETHODIMP</span>
<a href="#l10.5993"></a><span id="l10.5993" class="difflineminus">-nsMsgDBFolder::CopyFolder(nsIMsgFolder* srcFolder,</span>
<a href="#l10.5994"></a><span id="l10.5994" class="difflineminus">-                        bool isMoveFolder,</span>
<a href="#l10.5995"></a><span id="l10.5995" class="difflineminus">-                        nsIMsgWindow *window,</span>
<a href="#l10.5996"></a><span id="l10.5996" class="difflineminus">-                        nsIMsgCopyServiceListener* listener)</span>
<a href="#l10.5997"></a><span id="l10.5997" class="difflineminus">-{</span>
<a href="#l10.5998"></a><span id="l10.5998" class="difflineplus">+nsMsgDBFolder::CopyFolder(nsIMsgFolder *srcFolder, bool isMoveFolder,</span>
<a href="#l10.5999"></a><span id="l10.5999" class="difflineplus">+                          nsIMsgWindow *window,</span>
<a href="#l10.6000"></a><span id="l10.6000" class="difflineplus">+                          nsIMsgCopyServiceListener *listener) {</span>
<a href="#l10.6001"></a><span id="l10.6001">   NS_ASSERTION(false, &quot;should be overridden by child class&quot;);</span>
<a href="#l10.6002"></a><span id="l10.6002">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.6003"></a><span id="l10.6003"> }</span>
<a href="#l10.6004"></a><span id="l10.6004"> </span>
<a href="#l10.6005"></a><span id="l10.6005"> NS_IMETHODIMP</span>
<a href="#l10.6006"></a><span id="l10.6006" class="difflineminus">-nsMsgDBFolder::CopyFileMessage(nsIFile* aFile,</span>
<a href="#l10.6007"></a><span id="l10.6007" class="difflineminus">-                             nsIMsgDBHdr* messageToReplace,</span>
<a href="#l10.6008"></a><span id="l10.6008" class="difflineminus">-                             bool isDraftOrTemplate,</span>
<a href="#l10.6009"></a><span id="l10.6009" class="difflineminus">-                             uint32_t aNewMsgFlags,</span>
<a href="#l10.6010"></a><span id="l10.6010" class="difflineminus">-                             const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l10.6011"></a><span id="l10.6011" class="difflineminus">-                             nsIMsgWindow *window,</span>
<a href="#l10.6012"></a><span id="l10.6012" class="difflineminus">-                             nsIMsgCopyServiceListener* listener)</span>
<a href="#l10.6013"></a><span id="l10.6013" class="difflineminus">-{</span>
<a href="#l10.6014"></a><span id="l10.6014" class="difflineplus">+nsMsgDBFolder::CopyFileMessage(nsIFile *aFile, nsIMsgDBHdr *messageToReplace,</span>
<a href="#l10.6015"></a><span id="l10.6015" class="difflineplus">+                               bool isDraftOrTemplate, uint32_t aNewMsgFlags,</span>
<a href="#l10.6016"></a><span id="l10.6016" class="difflineplus">+                               const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l10.6017"></a><span id="l10.6017" class="difflineplus">+                               nsIMsgWindow *window,</span>
<a href="#l10.6018"></a><span id="l10.6018" class="difflineplus">+                               nsIMsgCopyServiceListener *listener) {</span>
<a href="#l10.6019"></a><span id="l10.6019">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.6020"></a><span id="l10.6020"> }</span>
<a href="#l10.6021"></a><span id="l10.6021"> </span>
<a href="#l10.6022"></a><span id="l10.6022" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CopyDataToOutputStreamForAppend(nsIInputStream *aInStream,</span>
<a href="#l10.6023"></a><span id="l10.6023" class="difflineminus">-                     int32_t aLength, nsIOutputStream *aOutputStream)</span>
<a href="#l10.6024"></a><span id="l10.6024" class="difflineminus">-{</span>
<a href="#l10.6025"></a><span id="l10.6025" class="difflineminus">-  if (!aInStream)</span>
<a href="#l10.6026"></a><span id="l10.6026" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.6027"></a><span id="l10.6027" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CopyDataToOutputStreamForAppend(</span>
<a href="#l10.6028"></a><span id="l10.6028" class="difflineplus">+    nsIInputStream *aInStream, int32_t aLength,</span>
<a href="#l10.6029"></a><span id="l10.6029" class="difflineplus">+    nsIOutputStream *aOutputStream) {</span>
<a href="#l10.6030"></a><span id="l10.6030" class="difflineplus">+  if (!aInStream) return NS_OK;</span>
<a href="#l10.6031"></a><span id="l10.6031"> </span>
<a href="#l10.6032"></a><span id="l10.6032">   uint32_t uiWritten;</span>
<a href="#l10.6033"></a><span id="l10.6033">   return aOutputStream-&gt;WriteFrom(aInStream, aLength, &amp;uiWritten);</span>
<a href="#l10.6034"></a><span id="l10.6034"> }</span>
<a href="#l10.6035"></a><span id="l10.6035"> </span>
<a href="#l10.6036"></a><span id="l10.6036" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CopyDataDone()</span>
<a href="#l10.6037"></a><span id="l10.6037" class="difflineminus">-{</span>
<a href="#l10.6038"></a><span id="l10.6038" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.6039"></a><span id="l10.6039" class="difflineminus">-}</span>
<a href="#l10.6040"></a><span id="l10.6040" class="difflineminus">-</span>
<a href="#l10.6041"></a><span id="l10.6041" class="difflineminus">-#define NOTIFY_LISTENERS(propertyfunc_, params_) \</span>
<a href="#l10.6042"></a><span id="l10.6042" class="difflineminus">-  PR_BEGIN_MACRO \</span>
<a href="#l10.6043"></a><span id="l10.6043" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt;&gt;::ForwardIterator iter(mListeners); \</span>
<a href="#l10.6044"></a><span id="l10.6044" class="difflineminus">-  nsCOMPtr&lt;nsIFolderListener&gt; listener; \</span>
<a href="#l10.6045"></a><span id="l10.6045" class="difflineminus">-  while (iter.HasMore()) { \</span>
<a href="#l10.6046"></a><span id="l10.6046" class="difflineminus">-    listener = iter.GetNext(); \</span>
<a href="#l10.6047"></a><span id="l10.6047" class="difflineminus">-    listener-&gt;propertyfunc_ params_; \</span>
<a href="#l10.6048"></a><span id="l10.6048" class="difflineminus">-  } \</span>
<a href="#l10.6049"></a><span id="l10.6049" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CopyDataDone() { return NS_OK; }</span>
<a href="#l10.6050"></a><span id="l10.6050" class="difflineplus">+</span>
<a href="#l10.6051"></a><span id="l10.6051" class="difflineplus">+#define NOTIFY_LISTENERS(propertyfunc_, params_)                       \</span>
<a href="#l10.6052"></a><span id="l10.6052" class="difflineplus">+  PR_BEGIN_MACRO                                                       \</span>
<a href="#l10.6053"></a><span id="l10.6053" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt;&gt;::ForwardIterator iter( \</span>
<a href="#l10.6054"></a><span id="l10.6054" class="difflineplus">+      mListeners);                                                     \</span>
<a href="#l10.6055"></a><span id="l10.6055" class="difflineplus">+  nsCOMPtr&lt;nsIFolderListener&gt; listener;                                \</span>
<a href="#l10.6056"></a><span id="l10.6056" class="difflineplus">+  while (iter.HasMore()) {                                             \</span>
<a href="#l10.6057"></a><span id="l10.6057" class="difflineplus">+    listener = iter.GetNext();                                         \</span>
<a href="#l10.6058"></a><span id="l10.6058" class="difflineplus">+    listener-&gt;propertyfunc_ params_;                                   \</span>
<a href="#l10.6059"></a><span id="l10.6059" class="difflineplus">+  }                                                                    \</span>
<a href="#l10.6060"></a><span id="l10.6060">   PR_END_MACRO</span>
<a href="#l10.6061"></a><span id="l10.6061"> </span>
<a href="#l10.6062"></a><span id="l10.6062"> NS_IMETHODIMP</span>
<a href="#l10.6063"></a><span id="l10.6063"> nsMsgDBFolder::NotifyPropertyChanged(const nsACString &amp;aProperty,</span>
<a href="#l10.6064"></a><span id="l10.6064" class="difflineminus">-                                     const nsACString&amp; aOldValue,</span>
<a href="#l10.6065"></a><span id="l10.6065" class="difflineminus">-                                     const nsACString&amp; aNewValue)</span>
<a href="#l10.6066"></a><span id="l10.6066" class="difflineminus">-{</span>
<a href="#l10.6067"></a><span id="l10.6067" class="difflineplus">+                                     const nsACString &amp;aOldValue,</span>
<a href="#l10.6068"></a><span id="l10.6068" class="difflineplus">+                                     const nsACString &amp;aNewValue) {</span>
<a href="#l10.6069"></a><span id="l10.6069">   NOTIFY_LISTENERS(OnItemPropertyChanged,</span>
<a href="#l10.6070"></a><span id="l10.6070" class="difflineminus">-                   (this, aProperty,</span>
<a href="#l10.6071"></a><span id="l10.6071" class="difflineminus">-                    nsCString(aOldValue).get(),</span>
<a href="#l10.6072"></a><span id="l10.6072" class="difflineplus">+                   (this, aProperty, nsCString(aOldValue).get(),</span>
<a href="#l10.6073"></a><span id="l10.6073">                     nsCString(aNewValue).get()));</span>
<a href="#l10.6074"></a><span id="l10.6074"> </span>
<a href="#l10.6075"></a><span id="l10.6075">   // Notify listeners who listen to every folder</span>
<a href="#l10.6076"></a><span id="l10.6076">   nsresult rv;</span>
<a href="#l10.6077"></a><span id="l10.6077">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6078"></a><span id="l10.6078" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6079"></a><span id="l10.6079" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6080"></a><span id="l10.6080">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6081"></a><span id="l10.6081" class="difflineminus">-  return folderListenerManager-&gt;OnItemPropertyChanged(this, aProperty,</span>
<a href="#l10.6082"></a><span id="l10.6082" class="difflineminus">-                                                      nsCString(aOldValue).get(),</span>
<a href="#l10.6083"></a><span id="l10.6083" class="difflineminus">-                                                      nsCString(aNewValue).get());</span>
<a href="#l10.6084"></a><span id="l10.6084" class="difflineplus">+  return folderListenerManager-&gt;OnItemPropertyChanged(</span>
<a href="#l10.6085"></a><span id="l10.6085" class="difflineplus">+      this, aProperty, nsCString(aOldValue).get(), nsCString(aNewValue).get());</span>
<a href="#l10.6086"></a><span id="l10.6086"> }</span>
<a href="#l10.6087"></a><span id="l10.6087"> </span>
<a href="#l10.6088"></a><span id="l10.6088"> NS_IMETHODIMP</span>
<a href="#l10.6089"></a><span id="l10.6089"> nsMsgDBFolder::NotifyUnicharPropertyChanged(const nsACString &amp;aProperty,</span>
<a href="#l10.6090"></a><span id="l10.6090" class="difflineminus">-                                          const nsAString&amp; aOldValue,</span>
<a href="#l10.6091"></a><span id="l10.6091" class="difflineminus">-                                          const nsAString&amp; aNewValue)</span>
<a href="#l10.6092"></a><span id="l10.6092" class="difflineminus">-{</span>
<a href="#l10.6093"></a><span id="l10.6093" class="difflineminus">-  NOTIFY_LISTENERS(OnItemUnicharPropertyChanged,</span>
<a href="#l10.6094"></a><span id="l10.6094" class="difflineminus">-                   (this, aProperty,</span>
<a href="#l10.6095"></a><span id="l10.6095" class="difflineminus">-                    nsString(aOldValue).get(),</span>
<a href="#l10.6096"></a><span id="l10.6096" class="difflineminus">-                    nsString(aNewValue).get()));</span>
<a href="#l10.6097"></a><span id="l10.6097" class="difflineplus">+                                            const nsAString &amp;aOldValue,</span>
<a href="#l10.6098"></a><span id="l10.6098" class="difflineplus">+                                            const nsAString &amp;aNewValue) {</span>
<a href="#l10.6099"></a><span id="l10.6099" class="difflineplus">+  NOTIFY_LISTENERS(</span>
<a href="#l10.6100"></a><span id="l10.6100" class="difflineplus">+      OnItemUnicharPropertyChanged,</span>
<a href="#l10.6101"></a><span id="l10.6101" class="difflineplus">+      (this, aProperty, nsString(aOldValue).get(), nsString(aNewValue).get()));</span>
<a href="#l10.6102"></a><span id="l10.6102"> </span>
<a href="#l10.6103"></a><span id="l10.6103">   // Notify listeners who listen to every folder</span>
<a href="#l10.6104"></a><span id="l10.6104">   nsresult rv;</span>
<a href="#l10.6105"></a><span id="l10.6105">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6106"></a><span id="l10.6106" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6107"></a><span id="l10.6107" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6108"></a><span id="l10.6108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6109"></a><span id="l10.6109" class="difflineminus">-  return folderListenerManager-&gt;OnItemUnicharPropertyChanged(this,</span>
<a href="#l10.6110"></a><span id="l10.6110" class="difflineminus">-                                                 aProperty,</span>
<a href="#l10.6111"></a><span id="l10.6111" class="difflineminus">-                                                 nsString(aOldValue).get(),</span>
<a href="#l10.6112"></a><span id="l10.6112" class="difflineminus">-                                                 nsString(aNewValue).get());</span>
<a href="#l10.6113"></a><span id="l10.6113" class="difflineplus">+  return folderListenerManager-&gt;OnItemUnicharPropertyChanged(</span>
<a href="#l10.6114"></a><span id="l10.6114" class="difflineplus">+      this, aProperty, nsString(aOldValue).get(), nsString(aNewValue).get());</span>
<a href="#l10.6115"></a><span id="l10.6115"> }</span>
<a href="#l10.6116"></a><span id="l10.6116"> </span>
<a href="#l10.6117"></a><span id="l10.6117"> NS_IMETHODIMP</span>
<a href="#l10.6118"></a><span id="l10.6118" class="difflineminus">-nsMsgDBFolder::NotifyIntPropertyChanged(const nsACString &amp;aProperty, int64_t aOldValue,</span>
<a href="#l10.6119"></a><span id="l10.6119" class="difflineminus">-                                        int64_t aNewValue)</span>
<a href="#l10.6120"></a><span id="l10.6120" class="difflineminus">-{</span>
<a href="#l10.6121"></a><span id="l10.6121" class="difflineplus">+nsMsgDBFolder::NotifyIntPropertyChanged(const nsACString &amp;aProperty,</span>
<a href="#l10.6122"></a><span id="l10.6122" class="difflineplus">+                                        int64_t aOldValue, int64_t aNewValue) {</span>
<a href="#l10.6123"></a><span id="l10.6123">   // Don't send off count notifications if they are turned off.</span>
<a href="#l10.6124"></a><span id="l10.6124" class="difflineminus">-  if (!mNotifyCountChanges &amp;&amp;</span>
<a href="#l10.6125"></a><span id="l10.6125" class="difflineminus">-      (aProperty.Equals(kTotalMessages)  ||</span>
<a href="#l10.6126"></a><span id="l10.6126" class="difflineminus">-       aProperty.Equals(kTotalUnreadMessages)))</span>
<a href="#l10.6127"></a><span id="l10.6127" class="difflineplus">+  if (!mNotifyCountChanges &amp;&amp; (aProperty.Equals(kTotalMessages) ||</span>
<a href="#l10.6128"></a><span id="l10.6128" class="difflineplus">+                               aProperty.Equals(kTotalUnreadMessages)))</span>
<a href="#l10.6129"></a><span id="l10.6129">     return NS_OK;</span>
<a href="#l10.6130"></a><span id="l10.6130"> </span>
<a href="#l10.6131"></a><span id="l10.6131">   NOTIFY_LISTENERS(OnItemIntPropertyChanged,</span>
<a href="#l10.6132"></a><span id="l10.6132">                    (this, aProperty, aOldValue, aNewValue));</span>
<a href="#l10.6133"></a><span id="l10.6133"> </span>
<a href="#l10.6134"></a><span id="l10.6134">   // Notify listeners who listen to every folder</span>
<a href="#l10.6135"></a><span id="l10.6135">   nsresult rv;</span>
<a href="#l10.6136"></a><span id="l10.6136">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6137"></a><span id="l10.6137" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6138"></a><span id="l10.6138" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6139"></a><span id="l10.6139">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6140"></a><span id="l10.6140">   return folderListenerManager-&gt;OnItemIntPropertyChanged(this, aProperty,</span>
<a href="#l10.6141"></a><span id="l10.6141">                                                          aOldValue, aNewValue);</span>
<a href="#l10.6142"></a><span id="l10.6142"> }</span>
<a href="#l10.6143"></a><span id="l10.6143"> </span>
<a href="#l10.6144"></a><span id="l10.6144"> NS_IMETHODIMP</span>
<a href="#l10.6145"></a><span id="l10.6145"> nsMsgDBFolder::NotifyBoolPropertyChanged(const nsACString &amp;aProperty,</span>
<a href="#l10.6146"></a><span id="l10.6146" class="difflineminus">-                                         bool aOldValue, bool aNewValue)</span>
<a href="#l10.6147"></a><span id="l10.6147" class="difflineminus">-{</span>
<a href="#l10.6148"></a><span id="l10.6148" class="difflineplus">+                                         bool aOldValue, bool aNewValue) {</span>
<a href="#l10.6149"></a><span id="l10.6149">   NOTIFY_LISTENERS(OnItemBoolPropertyChanged,</span>
<a href="#l10.6150"></a><span id="l10.6150">                    (this, aProperty, aOldValue, aNewValue));</span>
<a href="#l10.6151"></a><span id="l10.6151"> </span>
<a href="#l10.6152"></a><span id="l10.6152">   // Notify listeners who listen to every folder</span>
<a href="#l10.6153"></a><span id="l10.6153">   nsresult rv;</span>
<a href="#l10.6154"></a><span id="l10.6154">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6155"></a><span id="l10.6155" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6156"></a><span id="l10.6156" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6157"></a><span id="l10.6157">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6158"></a><span id="l10.6158">   return folderListenerManager-&gt;OnItemBoolPropertyChanged(this, aProperty,</span>
<a href="#l10.6159"></a><span id="l10.6159">                                                           aOldValue, aNewValue);</span>
<a href="#l10.6160"></a><span id="l10.6160"> }</span>
<a href="#l10.6161"></a><span id="l10.6161"> </span>
<a href="#l10.6162"></a><span id="l10.6162"> NS_IMETHODIMP</span>
<a href="#l10.6163"></a><span id="l10.6163" class="difflineminus">-nsMsgDBFolder::NotifyPropertyFlagChanged(nsIMsgDBHdr *aItem, const nsACString &amp;aProperty,</span>
<a href="#l10.6164"></a><span id="l10.6164" class="difflineminus">-                                         uint32_t aOldValue, uint32_t aNewValue)</span>
<a href="#l10.6165"></a><span id="l10.6165" class="difflineminus">-{</span>
<a href="#l10.6166"></a><span id="l10.6166" class="difflineplus">+nsMsgDBFolder::NotifyPropertyFlagChanged(nsIMsgDBHdr *aItem,</span>
<a href="#l10.6167"></a><span id="l10.6167" class="difflineplus">+                                         const nsACString &amp;aProperty,</span>
<a href="#l10.6168"></a><span id="l10.6168" class="difflineplus">+                                         uint32_t aOldValue,</span>
<a href="#l10.6169"></a><span id="l10.6169" class="difflineplus">+                                         uint32_t aNewValue) {</span>
<a href="#l10.6170"></a><span id="l10.6170">   NOTIFY_LISTENERS(OnItemPropertyFlagChanged,</span>
<a href="#l10.6171"></a><span id="l10.6171">                    (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l10.6172"></a><span id="l10.6172"> </span>
<a href="#l10.6173"></a><span id="l10.6173">   // Notify listeners who listen to every folder</span>
<a href="#l10.6174"></a><span id="l10.6174">   nsresult rv;</span>
<a href="#l10.6175"></a><span id="l10.6175">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6176"></a><span id="l10.6176" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6177"></a><span id="l10.6177" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6178"></a><span id="l10.6178">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6179"></a><span id="l10.6179">   return folderListenerManager-&gt;OnItemPropertyFlagChanged(aItem, aProperty,</span>
<a href="#l10.6180"></a><span id="l10.6180">                                                           aOldValue, aNewValue);</span>
<a href="#l10.6181"></a><span id="l10.6181"> }</span>
<a href="#l10.6182"></a><span id="l10.6182"> </span>
<a href="#l10.6183"></a><span id="l10.6183" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::NotifyItemAdded(nsISupports *aItem)</span>
<a href="#l10.6184"></a><span id="l10.6184" class="difflineminus">-{</span>
<a href="#l10.6185"></a><span id="l10.6185" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::NotifyItemAdded(nsISupports *aItem) {</span>
<a href="#l10.6186"></a><span id="l10.6186">   static bool notify = true;</span>
<a href="#l10.6187"></a><span id="l10.6187"> </span>
<a href="#l10.6188"></a><span id="l10.6188" class="difflineminus">-  if (!notify)</span>
<a href="#l10.6189"></a><span id="l10.6189" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.6190"></a><span id="l10.6190" class="difflineminus">-</span>
<a href="#l10.6191"></a><span id="l10.6191" class="difflineminus">-  NOTIFY_LISTENERS(OnItemAdded,</span>
<a href="#l10.6192"></a><span id="l10.6192" class="difflineminus">-                   (this, aItem));</span>
<a href="#l10.6193"></a><span id="l10.6193" class="difflineplus">+  if (!notify) return NS_OK;</span>
<a href="#l10.6194"></a><span id="l10.6194" class="difflineplus">+</span>
<a href="#l10.6195"></a><span id="l10.6195" class="difflineplus">+  NOTIFY_LISTENERS(OnItemAdded, (this, aItem));</span>
<a href="#l10.6196"></a><span id="l10.6196"> </span>
<a href="#l10.6197"></a><span id="l10.6197">   // Notify listeners who listen to every folder</span>
<a href="#l10.6198"></a><span id="l10.6198">   nsresult rv;</span>
<a href="#l10.6199"></a><span id="l10.6199">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6200"></a><span id="l10.6200" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6201"></a><span id="l10.6201" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6202"></a><span id="l10.6202">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6203"></a><span id="l10.6203">   return folderListenerManager-&gt;OnItemAdded(this, aItem);</span>
<a href="#l10.6204"></a><span id="l10.6204"> }</span>
<a href="#l10.6205"></a><span id="l10.6205"> </span>
<a href="#l10.6206"></a><span id="l10.6206" class="difflineminus">-nsresult nsMsgDBFolder::NotifyItemRemoved(nsISupports *aItem)</span>
<a href="#l10.6207"></a><span id="l10.6207" class="difflineminus">-{</span>
<a href="#l10.6208"></a><span id="l10.6208" class="difflineminus">-  NOTIFY_LISTENERS(OnItemRemoved,</span>
<a href="#l10.6209"></a><span id="l10.6209" class="difflineminus">-                   (this, aItem));</span>
<a href="#l10.6210"></a><span id="l10.6210" class="difflineplus">+nsresult nsMsgDBFolder::NotifyItemRemoved(nsISupports *aItem) {</span>
<a href="#l10.6211"></a><span id="l10.6211" class="difflineplus">+  NOTIFY_LISTENERS(OnItemRemoved, (this, aItem));</span>
<a href="#l10.6212"></a><span id="l10.6212"> </span>
<a href="#l10.6213"></a><span id="l10.6213">   // Notify listeners who listen to every folder</span>
<a href="#l10.6214"></a><span id="l10.6214">   nsresult rv;</span>
<a href="#l10.6215"></a><span id="l10.6215">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6216"></a><span id="l10.6216" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6217"></a><span id="l10.6217" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6218"></a><span id="l10.6218">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6219"></a><span id="l10.6219">   return folderListenerManager-&gt;OnItemRemoved(this, aItem);</span>
<a href="#l10.6220"></a><span id="l10.6220"> }</span>
<a href="#l10.6221"></a><span id="l10.6221"> </span>
<a href="#l10.6222"></a><span id="l10.6222" class="difflineminus">-nsresult nsMsgDBFolder::NotifyFolderEvent(const nsACString &amp;aEvent)</span>
<a href="#l10.6223"></a><span id="l10.6223" class="difflineminus">-{</span>
<a href="#l10.6224"></a><span id="l10.6224" class="difflineminus">-  NOTIFY_LISTENERS(OnItemEvent,</span>
<a href="#l10.6225"></a><span id="l10.6225" class="difflineminus">-                   (this, aEvent));</span>
<a href="#l10.6226"></a><span id="l10.6226" class="difflineminus">-</span>
<a href="#l10.6227"></a><span id="l10.6227" class="difflineminus">-  //Notify listeners who listen to every folder</span>
<a href="#l10.6228"></a><span id="l10.6228" class="difflineplus">+nsresult nsMsgDBFolder::NotifyFolderEvent(const nsACString &amp;aEvent) {</span>
<a href="#l10.6229"></a><span id="l10.6229" class="difflineplus">+  NOTIFY_LISTENERS(OnItemEvent, (this, aEvent));</span>
<a href="#l10.6230"></a><span id="l10.6230" class="difflineplus">+</span>
<a href="#l10.6231"></a><span id="l10.6231" class="difflineplus">+  // Notify listeners who listen to every folder</span>
<a href="#l10.6232"></a><span id="l10.6232">   nsresult rv;</span>
<a href="#l10.6233"></a><span id="l10.6233">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l10.6234"></a><span id="l10.6234" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6235"></a><span id="l10.6235" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6236"></a><span id="l10.6236">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6237"></a><span id="l10.6237">   return folderListenerManager-&gt;OnItemEvent(this, aEvent);</span>
<a href="#l10.6238"></a><span id="l10.6238"> }</span>
<a href="#l10.6239"></a><span id="l10.6239"> </span>
<a href="#l10.6240"></a><span id="l10.6240"> NS_IMETHODIMP</span>
<a href="#l10.6241"></a><span id="l10.6241" class="difflineminus">-nsMsgDBFolder::GetFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l10.6242"></a><span id="l10.6242" class="difflineminus">-{</span>
<a href="#l10.6243"></a><span id="l10.6243" class="difflineplus">+nsMsgDBFolder::GetFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.6244"></a><span id="l10.6244" class="difflineplus">+                             nsIMsgFilterList **aResult) {</span>
<a href="#l10.6245"></a><span id="l10.6245">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.6246"></a><span id="l10.6246">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.6247"></a><span id="l10.6247">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6248"></a><span id="l10.6248">   return server-&gt;GetFilterList(aMsgWindow, aResult);</span>
<a href="#l10.6249"></a><span id="l10.6249"> }</span>
<a href="#l10.6250"></a><span id="l10.6250"> </span>
<a href="#l10.6251"></a><span id="l10.6251"> NS_IMETHODIMP</span>
<a href="#l10.6252"></a><span id="l10.6252" class="difflineminus">-nsMsgDBFolder::SetFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l10.6253"></a><span id="l10.6253" class="difflineminus">-{</span>
<a href="#l10.6254"></a><span id="l10.6254" class="difflineplus">+nsMsgDBFolder::SetFilterList(nsIMsgFilterList *aFilterList) {</span>
<a href="#l10.6255"></a><span id="l10.6255">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.6256"></a><span id="l10.6256">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.6257"></a><span id="l10.6257">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6258"></a><span id="l10.6258">   return server-&gt;SetFilterList(aFilterList);</span>
<a href="#l10.6259"></a><span id="l10.6259"> }</span>
<a href="#l10.6260"></a><span id="l10.6260"> </span>
<a href="#l10.6261"></a><span id="l10.6261"> NS_IMETHODIMP</span>
<a href="#l10.6262"></a><span id="l10.6262" class="difflineminus">-nsMsgDBFolder::GetEditableFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l10.6263"></a><span id="l10.6263" class="difflineminus">-{</span>
<a href="#l10.6264"></a><span id="l10.6264" class="difflineplus">+nsMsgDBFolder::GetEditableFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.6265"></a><span id="l10.6265" class="difflineplus">+                                     nsIMsgFilterList **aResult) {</span>
<a href="#l10.6266"></a><span id="l10.6266">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.6267"></a><span id="l10.6267">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.6268"></a><span id="l10.6268">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.6269"></a><span id="l10.6269">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6270"></a><span id="l10.6270">   return server-&gt;GetEditableFilterList(aMsgWindow, aResult);</span>
<a href="#l10.6271"></a><span id="l10.6271"> }</span>
<a href="#l10.6272"></a><span id="l10.6272"> </span>
<a href="#l10.6273"></a><span id="l10.6273"> NS_IMETHODIMP</span>
<a href="#l10.6274"></a><span id="l10.6274" class="difflineminus">-nsMsgDBFolder::SetEditableFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l10.6275"></a><span id="l10.6275" class="difflineminus">-{</span>
<a href="#l10.6276"></a><span id="l10.6276" class="difflineplus">+nsMsgDBFolder::SetEditableFilterList(nsIMsgFilterList *aFilterList) {</span>
<a href="#l10.6277"></a><span id="l10.6277">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.6278"></a><span id="l10.6278">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.6279"></a><span id="l10.6279">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6280"></a><span id="l10.6280">   return server-&gt;SetEditableFilterList(aFilterList);</span>
<a href="#l10.6281"></a><span id="l10.6281"> }</span>
<a href="#l10.6282"></a><span id="l10.6282"> </span>
<a href="#l10.6283"></a><span id="l10.6283"> /* void enableNotifications (in long notificationType, in boolean enable); */</span>
<a href="#l10.6284"></a><span id="l10.6284" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::EnableNotifications(int32_t notificationType, bool enable)</span>
<a href="#l10.6285"></a><span id="l10.6285" class="difflineminus">-{</span>
<a href="#l10.6286"></a><span id="l10.6286" class="difflineminus">-  if (notificationType == nsIMsgFolder::allMessageCountNotifications)</span>
<a href="#l10.6287"></a><span id="l10.6287" class="difflineminus">-  {</span>
<a href="#l10.6288"></a><span id="l10.6288" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::EnableNotifications(int32_t notificationType,</span>
<a href="#l10.6289"></a><span id="l10.6289" class="difflineplus">+                                                 bool enable) {</span>
<a href="#l10.6290"></a><span id="l10.6290" class="difflineplus">+  if (notificationType == nsIMsgFolder::allMessageCountNotifications) {</span>
<a href="#l10.6291"></a><span id="l10.6291">     mNotifyCountChanges = enable;</span>
<a href="#l10.6292"></a><span id="l10.6292" class="difflineminus">-    if (enable)</span>
<a href="#l10.6293"></a><span id="l10.6293" class="difflineminus">-    {</span>
<a href="#l10.6294"></a><span id="l10.6294" class="difflineplus">+    if (enable) {</span>
<a href="#l10.6295"></a><span id="l10.6295">       UpdateSummaryTotals(true);</span>
<a href="#l10.6296"></a><span id="l10.6296">     }</span>
<a href="#l10.6297"></a><span id="l10.6297">     return NS_OK;</span>
<a href="#l10.6298"></a><span id="l10.6298">   }</span>
<a href="#l10.6299"></a><span id="l10.6299">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.6300"></a><span id="l10.6300"> }</span>
<a href="#l10.6301"></a><span id="l10.6301"> </span>
<a href="#l10.6302"></a><span id="l10.6302" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetMessageHeader(nsMsgKey msgKey, nsIMsgDBHdr **aMsgHdr)</span>
<a href="#l10.6303"></a><span id="l10.6303" class="difflineminus">-{</span>
<a href="#l10.6304"></a><span id="l10.6304" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetMessageHeader(nsMsgKey msgKey,</span>
<a href="#l10.6305"></a><span id="l10.6305" class="difflineplus">+                                              nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l10.6306"></a><span id="l10.6306">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l10.6307"></a><span id="l10.6307" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; database;</span>
<a href="#l10.6308"></a><span id="l10.6308" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; database;</span>
<a href="#l10.6309"></a><span id="l10.6309">   nsresult rv = GetMsgDatabase(getter_AddRefs(database));</span>
<a href="#l10.6310"></a><span id="l10.6310">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6311"></a><span id="l10.6311" class="difflineminus">-  return (database) ? database-&gt;GetMsgHdrForKey(msgKey, aMsgHdr) : NS_ERROR_FAILURE;</span>
<a href="#l10.6312"></a><span id="l10.6312" class="difflineminus">-}</span>
<a href="#l10.6313"></a><span id="l10.6313" class="difflineminus">-</span>
<a href="#l10.6314"></a><span id="l10.6314" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetDescendants(nsIArray** aDescendants)</span>
<a href="#l10.6315"></a><span id="l10.6315" class="difflineminus">-{</span>
<a href="#l10.6316"></a><span id="l10.6316" class="difflineplus">+  return (database) ? database-&gt;GetMsgHdrForKey(msgKey, aMsgHdr)</span>
<a href="#l10.6317"></a><span id="l10.6317" class="difflineplus">+                    : NS_ERROR_FAILURE;</span>
<a href="#l10.6318"></a><span id="l10.6318" class="difflineplus">+}</span>
<a href="#l10.6319"></a><span id="l10.6319" class="difflineplus">+</span>
<a href="#l10.6320"></a><span id="l10.6320" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetDescendants(nsIArray **aDescendants) {</span>
<a href="#l10.6321"></a><span id="l10.6321">   NS_ENSURE_ARG_POINTER(aDescendants);</span>
<a href="#l10.6322"></a><span id="l10.6322"> </span>
<a href="#l10.6323"></a><span id="l10.6323">   nsresult rv;</span>
<a href="#l10.6324"></a><span id="l10.6324" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; allFolders(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l10.6325"></a><span id="l10.6325" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; allFolders(</span>
<a href="#l10.6326"></a><span id="l10.6326" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l10.6327"></a><span id="l10.6327">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6328"></a><span id="l10.6328"> </span>
<a href="#l10.6329"></a><span id="l10.6329">   rv = ListDescendants(allFolders);</span>
<a href="#l10.6330"></a><span id="l10.6330">   allFolders.forget(aDescendants);</span>
<a href="#l10.6331"></a><span id="l10.6331">   return NS_OK;</span>
<a href="#l10.6332"></a><span id="l10.6332"> }</span>
<a href="#l10.6333"></a><span id="l10.6333"> </span>
<a href="#l10.6334"></a><span id="l10.6334"> // this gets the deep sub-folders too, e.g., the children of the children</span>
<a href="#l10.6335"></a><span id="l10.6335" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ListDescendants(nsIMutableArray *aDescendants)</span>
<a href="#l10.6336"></a><span id="l10.6336" class="difflineminus">-{</span>
<a href="#l10.6337"></a><span id="l10.6337" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ListDescendants(nsIMutableArray *aDescendants) {</span>
<a href="#l10.6338"></a><span id="l10.6338">   NS_ENSURE_ARG_POINTER(aDescendants);</span>
<a href="#l10.6339"></a><span id="l10.6339"> </span>
<a href="#l10.6340"></a><span id="l10.6340">   nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l10.6341"></a><span id="l10.6341" class="difflineminus">-  GetSubFolders(getter_AddRefs(dummy)); // initialize mSubFolders</span>
<a href="#l10.6342"></a><span id="l10.6342" class="difflineplus">+  GetSubFolders(getter_AddRefs(dummy));  // initialize mSubFolders</span>
<a href="#l10.6343"></a><span id="l10.6343">   uint32_t count = mSubFolders.Count();</span>
<a href="#l10.6344"></a><span id="l10.6344" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.6345"></a><span id="l10.6345" class="difflineminus">-  {</span>
<a href="#l10.6346"></a><span id="l10.6346" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.6347"></a><span id="l10.6347">     nsCOMPtr&lt;nsIMsgFolder&gt; child(mSubFolders[i]);</span>
<a href="#l10.6348"></a><span id="l10.6348">     aDescendants-&gt;AppendElement(child);</span>
<a href="#l10.6349"></a><span id="l10.6349">     child-&gt;ListDescendants(aDescendants);  // recurse</span>
<a href="#l10.6350"></a><span id="l10.6350">   }</span>
<a href="#l10.6351"></a><span id="l10.6351">   return NS_OK;</span>
<a href="#l10.6352"></a><span id="l10.6352"> }</span>
<a href="#l10.6353"></a><span id="l10.6353"> </span>
<a href="#l10.6354"></a><span id="l10.6354" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetBaseMessageURI(nsACString&amp; baseMessageURI)</span>
<a href="#l10.6355"></a><span id="l10.6355" class="difflineminus">-{</span>
<a href="#l10.6356"></a><span id="l10.6356" class="difflineminus">-  if (mBaseMessageURI.IsEmpty())</span>
<a href="#l10.6357"></a><span id="l10.6357" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l10.6358"></a><span id="l10.6358" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetBaseMessageURI(nsACString &amp;baseMessageURI) {</span>
<a href="#l10.6359"></a><span id="l10.6359" class="difflineplus">+  if (mBaseMessageURI.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l10.6360"></a><span id="l10.6360">   baseMessageURI = mBaseMessageURI;</span>
<a href="#l10.6361"></a><span id="l10.6361">   return NS_OK;</span>
<a href="#l10.6362"></a><span id="l10.6362"> }</span>
<a href="#l10.6363"></a><span id="l10.6363"> </span>
<a href="#l10.6364"></a><span id="l10.6364" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetUriForMsg(nsIMsgDBHdr *msgHdr, nsACString&amp; aURI)</span>
<a href="#l10.6365"></a><span id="l10.6365" class="difflineminus">-{</span>
<a href="#l10.6366"></a><span id="l10.6366" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetUriForMsg(nsIMsgDBHdr *msgHdr,</span>
<a href="#l10.6367"></a><span id="l10.6367" class="difflineplus">+                                          nsACString &amp;aURI) {</span>
<a href="#l10.6368"></a><span id="l10.6368">   NS_ENSURE_ARG(msgHdr);</span>
<a href="#l10.6369"></a><span id="l10.6369">   nsMsgKey msgKey;</span>
<a href="#l10.6370"></a><span id="l10.6370">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.6371"></a><span id="l10.6371">   nsAutoCString uri;</span>
<a href="#l10.6372"></a><span id="l10.6372">   uri.Assign(mBaseMessageURI);</span>
<a href="#l10.6373"></a><span id="l10.6373"> </span>
<a href="#l10.6374"></a><span id="l10.6374">   // append a &quot;#&quot; followed by the message key.</span>
<a href="#l10.6375"></a><span id="l10.6375">   uri.Append('#');</span>
<a href="#l10.6376"></a><span id="l10.6376">   uri.AppendInt(msgKey);</span>
<a href="#l10.6377"></a><span id="l10.6377">   aURI = uri;</span>
<a href="#l10.6378"></a><span id="l10.6378">   return NS_OK;</span>
<a href="#l10.6379"></a><span id="l10.6379"> }</span>
<a href="#l10.6380"></a><span id="l10.6380"> </span>
<a href="#l10.6381"></a><span id="l10.6381" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GenerateMessageURI(nsMsgKey msgKey, nsACString&amp; aURI)</span>
<a href="#l10.6382"></a><span id="l10.6382" class="difflineminus">-{</span>
<a href="#l10.6383"></a><span id="l10.6383" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GenerateMessageURI(nsMsgKey msgKey,</span>
<a href="#l10.6384"></a><span id="l10.6384" class="difflineplus">+                                                nsACString &amp;aURI) {</span>
<a href="#l10.6385"></a><span id="l10.6385">   nsCString uri;</span>
<a href="#l10.6386"></a><span id="l10.6386" class="difflineminus">-  nsresult rv = GetBaseMessageURI( uri);</span>
<a href="#l10.6387"></a><span id="l10.6387" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.6388"></a><span id="l10.6388" class="difflineplus">+  nsresult rv = GetBaseMessageURI(uri);</span>
<a href="#l10.6389"></a><span id="l10.6389" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6390"></a><span id="l10.6390"> </span>
<a href="#l10.6391"></a><span id="l10.6391">   // append a &quot;#&quot; followed by the message key.</span>
<a href="#l10.6392"></a><span id="l10.6392">   uri.Append('#');</span>
<a href="#l10.6393"></a><span id="l10.6393">   uri.AppendInt(msgKey);</span>
<a href="#l10.6394"></a><span id="l10.6394">   aURI = uri;</span>
<a href="#l10.6395"></a><span id="l10.6395">   return NS_OK;</span>
<a href="#l10.6396"></a><span id="l10.6396"> }</span>
<a href="#l10.6397"></a><span id="l10.6397"> </span>
<a href="#l10.6398"></a><span id="l10.6398" class="difflineminus">-nsresult</span>
<a href="#l10.6399"></a><span id="l10.6399" class="difflineminus">-nsMsgDBFolder::GetBaseStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l10.6400"></a><span id="l10.6400" class="difflineminus">-{</span>
<a href="#l10.6401"></a><span id="l10.6401" class="difflineplus">+nsresult nsMsgDBFolder::GetBaseStringBundle(nsIStringBundle **aBundle) {</span>
<a href="#l10.6402"></a><span id="l10.6402">   NS_ENSURE_ARG_POINTER(aBundle);</span>
<a href="#l10.6403"></a><span id="l10.6403">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l10.6404"></a><span id="l10.6404" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l10.6405"></a><span id="l10.6405" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l10.6406"></a><span id="l10.6406">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l10.6407"></a><span id="l10.6407">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.6408"></a><span id="l10.6408">   bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l10.6409"></a><span id="l10.6409" class="difflineminus">-                                 getter_AddRefs(bundle));</span>
<a href="#l10.6410"></a><span id="l10.6410" class="difflineplus">+                              getter_AddRefs(bundle));</span>
<a href="#l10.6411"></a><span id="l10.6411">   bundle.forget(aBundle);</span>
<a href="#l10.6412"></a><span id="l10.6412">   return NS_OK;</span>
<a href="#l10.6413"></a><span id="l10.6413"> }</span>
<a href="#l10.6414"></a><span id="l10.6414"> </span>
<a href="#l10.6415"></a><span id="l10.6415" class="difflineminus">-nsresult //Do not use this routine if you have to call it very often because it creates a new bundle each time</span>
<a href="#l10.6416"></a><span id="l10.6416" class="difflineminus">-nsMsgDBFolder::GetStringFromBundle(const char *msgName, nsString&amp; aResult)</span>
<a href="#l10.6417"></a><span id="l10.6417" class="difflineminus">-{</span>
<a href="#l10.6418"></a><span id="l10.6418" class="difflineplus">+// Do not use this routine if you have to call it very often because</span>
<a href="#l10.6419"></a><span id="l10.6419" class="difflineplus">+// it creates a new bundle each time</span>
<a href="#l10.6420"></a><span id="l10.6420" class="difflineplus">+nsresult nsMsgDBFolder::GetStringFromBundle(const char *msgName,</span>
<a href="#l10.6421"></a><span id="l10.6421" class="difflineplus">+                                            nsString &amp;aResult) {</span>
<a href="#l10.6422"></a><span id="l10.6422">   nsresult rv;</span>
<a href="#l10.6423"></a><span id="l10.6423" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.6424"></a><span id="l10.6424" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.6425"></a><span id="l10.6425">   rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l10.6426"></a><span id="l10.6426">   if (NS_SUCCEEDED(rv) &amp;&amp; bundle)</span>
<a href="#l10.6427"></a><span id="l10.6427">     rv = bundle-&gt;GetStringFromName(msgName, aResult);</span>
<a href="#l10.6428"></a><span id="l10.6428">   return rv;</span>
<a href="#l10.6429"></a><span id="l10.6429"> }</span>
<a href="#l10.6430"></a><span id="l10.6430"> </span>
<a href="#l10.6431"></a><span id="l10.6431" class="difflineminus">-nsresult</span>
<a href="#l10.6432"></a><span id="l10.6432" class="difflineminus">-nsMsgDBFolder::ThrowConfirmationPrompt(nsIMsgWindow *msgWindow, const nsAString&amp; confirmString, bool *confirmed)</span>
<a href="#l10.6433"></a><span id="l10.6433" class="difflineminus">-{</span>
<a href="#l10.6434"></a><span id="l10.6434" class="difflineminus">-  if (msgWindow)</span>
<a href="#l10.6435"></a><span id="l10.6435" class="difflineminus">-  {</span>
<a href="#l10.6436"></a><span id="l10.6436" class="difflineminus">-    nsCOMPtr &lt;nsIDocShell&gt; docShell;</span>
<a href="#l10.6437"></a><span id="l10.6437" class="difflineplus">+nsresult nsMsgDBFolder::ThrowConfirmationPrompt(nsIMsgWindow *msgWindow,</span>
<a href="#l10.6438"></a><span id="l10.6438" class="difflineplus">+                                                const nsAString &amp;confirmString,</span>
<a href="#l10.6439"></a><span id="l10.6439" class="difflineplus">+                                                bool *confirmed) {</span>
<a href="#l10.6440"></a><span id="l10.6440" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l10.6441"></a><span id="l10.6441" class="difflineplus">+    nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l10.6442"></a><span id="l10.6442">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l10.6443"></a><span id="l10.6443" class="difflineminus">-    if (docShell)</span>
<a href="#l10.6444"></a><span id="l10.6444" class="difflineminus">-    {</span>
<a href="#l10.6445"></a><span id="l10.6445" class="difflineplus">+    if (docShell) {</span>
<a href="#l10.6446"></a><span id="l10.6446">       nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(docShell));</span>
<a href="#l10.6447"></a><span id="l10.6447">       if (dialog &amp;&amp; !confirmString.IsEmpty())</span>
<a href="#l10.6448"></a><span id="l10.6448">         dialog-&gt;Confirm(nullptr, nsString(confirmString).get(), confirmed);</span>
<a href="#l10.6449"></a><span id="l10.6449">     }</span>
<a href="#l10.6450"></a><span id="l10.6450">   }</span>
<a href="#l10.6451"></a><span id="l10.6451">   return NS_OK;</span>
<a href="#l10.6452"></a><span id="l10.6452"> }</span>
<a href="#l10.6453"></a><span id="l10.6453"> </span>
<a href="#l10.6454"></a><span id="l10.6454"> NS_IMETHODIMP</span>
<a href="#l10.6455"></a><span id="l10.6455" class="difflineminus">-nsMsgDBFolder::GetStringWithFolderNameFromBundle(const char * msgName, nsAString&amp; aResult)</span>
<a href="#l10.6456"></a><span id="l10.6456" class="difflineminus">-{</span>
<a href="#l10.6457"></a><span id="l10.6457" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.6458"></a><span id="l10.6458" class="difflineplus">+nsMsgDBFolder::GetStringWithFolderNameFromBundle(const char *msgName,</span>
<a href="#l10.6459"></a><span id="l10.6459" class="difflineplus">+                                                 nsAString &amp;aResult) {</span>
<a href="#l10.6460"></a><span id="l10.6460" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l10.6461"></a><span id="l10.6461">   nsresult rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l10.6462"></a><span id="l10.6462" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; bundle)</span>
<a href="#l10.6463"></a><span id="l10.6463" class="difflineminus">-  {</span>
<a href="#l10.6464"></a><span id="l10.6464" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; bundle) {</span>
<a href="#l10.6465"></a><span id="l10.6465">     nsString folderName;</span>
<a href="#l10.6466"></a><span id="l10.6466">     GetName(folderName);</span>
<a href="#l10.6467"></a><span id="l10.6467" class="difflineminus">-    const char16_t *formatStrings[] =</span>
<a href="#l10.6468"></a><span id="l10.6468" class="difflineminus">-    {</span>
<a href="#l10.6469"></a><span id="l10.6469" class="difflineminus">-      folderName.get(),</span>
<a href="#l10.6470"></a><span id="l10.6470" class="difflineminus">-      kLocalizedBrandShortName.get()</span>
<a href="#l10.6471"></a><span id="l10.6471" class="difflineminus">-    };</span>
<a href="#l10.6472"></a><span id="l10.6472" class="difflineplus">+    const char16_t *formatStrings[] = {folderName.get(),</span>
<a href="#l10.6473"></a><span id="l10.6473" class="difflineplus">+                                       kLocalizedBrandShortName.get()};</span>
<a href="#l10.6474"></a><span id="l10.6474"> </span>
<a href="#l10.6475"></a><span id="l10.6475">     nsString resultStr;</span>
<a href="#l10.6476"></a><span id="l10.6476" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(msgName,</span>
<a href="#l10.6477"></a><span id="l10.6477" class="difflineminus">-                                      formatStrings, 2, resultStr);</span>
<a href="#l10.6478"></a><span id="l10.6478" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.6479"></a><span id="l10.6479" class="difflineminus">-      aResult.Assign(resultStr);</span>
<a href="#l10.6480"></a><span id="l10.6480" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(msgName, formatStrings, 2, resultStr);</span>
<a href="#l10.6481"></a><span id="l10.6481" class="difflineplus">+    if (NS_SUCCEEDED(rv)) aResult.Assign(resultStr);</span>
<a href="#l10.6482"></a><span id="l10.6482">   }</span>
<a href="#l10.6483"></a><span id="l10.6483">   return rv;</span>
<a href="#l10.6484"></a><span id="l10.6484"> }</span>
<a href="#l10.6485"></a><span id="l10.6485"> </span>
<a href="#l10.6486"></a><span id="l10.6486" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ConfirmFolderDeletionForFilter(nsIMsgWindow *msgWindow, bool *confirmed)</span>
<a href="#l10.6487"></a><span id="l10.6487" class="difflineminus">-{</span>
<a href="#l10.6488"></a><span id="l10.6488" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ConfirmFolderDeletionForFilter(</span>
<a href="#l10.6489"></a><span id="l10.6489" class="difflineplus">+    nsIMsgWindow *msgWindow, bool *confirmed) {</span>
<a href="#l10.6490"></a><span id="l10.6490">   nsString confirmString;</span>
<a href="#l10.6491"></a><span id="l10.6491" class="difflineminus">-  nsresult rv = GetStringWithFolderNameFromBundle(&quot;confirmFolderDeletionForFilter&quot;, confirmString);</span>
<a href="#l10.6492"></a><span id="l10.6492" class="difflineplus">+  nsresult rv = GetStringWithFolderNameFromBundle(</span>
<a href="#l10.6493"></a><span id="l10.6493" class="difflineplus">+      &quot;confirmFolderDeletionForFilter&quot;, confirmString);</span>
<a href="#l10.6494"></a><span id="l10.6494">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6495"></a><span id="l10.6495">   return ThrowConfirmationPrompt(msgWindow, confirmString, confirmed);</span>
<a href="#l10.6496"></a><span id="l10.6496"> }</span>
<a href="#l10.6497"></a><span id="l10.6497"> </span>
<a href="#l10.6498"></a><span id="l10.6498" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::ThrowAlertMsg(const char * msgName, nsIMsgWindow *msgWindow)</span>
<a href="#l10.6499"></a><span id="l10.6499" class="difflineminus">-{</span>
<a href="#l10.6500"></a><span id="l10.6500" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::ThrowAlertMsg(const char *msgName,</span>
<a href="#l10.6501"></a><span id="l10.6501" class="difflineplus">+                                           nsIMsgWindow *msgWindow) {</span>
<a href="#l10.6502"></a><span id="l10.6502">   nsString alertString;</span>
<a href="#l10.6503"></a><span id="l10.6503">   nsresult rv = GetStringWithFolderNameFromBundle(msgName, alertString);</span>
<a href="#l10.6504"></a><span id="l10.6504" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !alertString.IsEmpty() &amp;&amp; msgWindow)</span>
<a href="#l10.6505"></a><span id="l10.6505" class="difflineminus">-  {</span>
<a href="#l10.6506"></a><span id="l10.6506" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !alertString.IsEmpty() &amp;&amp; msgWindow) {</span>
<a href="#l10.6507"></a><span id="l10.6507">     nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l10.6508"></a><span id="l10.6508">     msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l10.6509"></a><span id="l10.6509" class="difflineminus">-    if (dialog)</span>
<a href="#l10.6510"></a><span id="l10.6510" class="difflineminus">-      dialog-&gt;Alert(nullptr, alertString.get());</span>
<a href="#l10.6511"></a><span id="l10.6511" class="difflineplus">+    if (dialog) dialog-&gt;Alert(nullptr, alertString.get());</span>
<a href="#l10.6512"></a><span id="l10.6512">   }</span>
<a href="#l10.6513"></a><span id="l10.6513">   return rv;</span>
<a href="#l10.6514"></a><span id="l10.6514"> }</span>
<a href="#l10.6515"></a><span id="l10.6515"> </span>
<a href="#l10.6516"></a><span id="l10.6516" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::AlertFilterChanged(nsIMsgWindow *msgWindow)</span>
<a href="#l10.6517"></a><span id="l10.6517" class="difflineminus">-{</span>
<a href="#l10.6518"></a><span id="l10.6518" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AlertFilterChanged(nsIMsgWindow *msgWindow) {</span>
<a href="#l10.6519"></a><span id="l10.6519">   NS_ENSURE_ARG(msgWindow);</span>
<a href="#l10.6520"></a><span id="l10.6520">   nsresult rv = NS_OK;</span>
<a href="#l10.6521"></a><span id="l10.6521" class="difflineminus">-  bool checkBox=false;</span>
<a href="#l10.6522"></a><span id="l10.6522" class="difflineplus">+  bool checkBox = false;</span>
<a href="#l10.6523"></a><span id="l10.6523">   GetWarnFilterChanged(&amp;checkBox);</span>
<a href="#l10.6524"></a><span id="l10.6524" class="difflineminus">-  if (!checkBox)</span>
<a href="#l10.6525"></a><span id="l10.6525" class="difflineminus">-  {</span>
<a href="#l10.6526"></a><span id="l10.6526" class="difflineminus">-    nsCOMPtr &lt;nsIDocShell&gt; docShell;</span>
<a href="#l10.6527"></a><span id="l10.6527" class="difflineplus">+  if (!checkBox) {</span>
<a href="#l10.6528"></a><span id="l10.6528" class="difflineplus">+    nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l10.6529"></a><span id="l10.6529">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l10.6530"></a><span id="l10.6530">     nsString alertString;</span>
<a href="#l10.6531"></a><span id="l10.6531">     rv = GetStringFromBundle(&quot;alertFilterChanged&quot;, alertString);</span>
<a href="#l10.6532"></a><span id="l10.6532">     nsString alertCheckbox;</span>
<a href="#l10.6533"></a><span id="l10.6533">     rv = GetStringFromBundle(&quot;alertFilterCheckbox&quot;, alertCheckbox);</span>
<a href="#l10.6534"></a><span id="l10.6534" class="difflineminus">-    if (!alertString.IsEmpty() &amp;&amp; !alertCheckbox.IsEmpty() &amp;&amp; docShell)</span>
<a href="#l10.6535"></a><span id="l10.6535" class="difflineminus">-    {</span>
<a href="#l10.6536"></a><span id="l10.6536" class="difflineplus">+    if (!alertString.IsEmpty() &amp;&amp; !alertCheckbox.IsEmpty() &amp;&amp; docShell) {</span>
<a href="#l10.6537"></a><span id="l10.6537">       nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(docShell));</span>
<a href="#l10.6538"></a><span id="l10.6538" class="difflineminus">-      if (dialog)</span>
<a href="#l10.6539"></a><span id="l10.6539" class="difflineminus">-      {</span>
<a href="#l10.6540"></a><span id="l10.6540" class="difflineminus">-        dialog-&gt;AlertCheck(nullptr, alertString.get(), alertCheckbox.get(), &amp;checkBox);</span>
<a href="#l10.6541"></a><span id="l10.6541" class="difflineplus">+      if (dialog) {</span>
<a href="#l10.6542"></a><span id="l10.6542" class="difflineplus">+        dialog-&gt;AlertCheck(nullptr, alertString.get(), alertCheckbox.get(),</span>
<a href="#l10.6543"></a><span id="l10.6543" class="difflineplus">+                           &amp;checkBox);</span>
<a href="#l10.6544"></a><span id="l10.6544">         SetWarnFilterChanged(checkBox);</span>
<a href="#l10.6545"></a><span id="l10.6545">       }</span>
<a href="#l10.6546"></a><span id="l10.6546">     }</span>
<a href="#l10.6547"></a><span id="l10.6547">   }</span>
<a href="#l10.6548"></a><span id="l10.6548">   return rv;</span>
<a href="#l10.6549"></a><span id="l10.6549"> }</span>
<a href="#l10.6550"></a><span id="l10.6550"> </span>
<a href="#l10.6551"></a><span id="l10.6551" class="difflineminus">-nsresult</span>
<a href="#l10.6552"></a><span id="l10.6552" class="difflineminus">-nsMsgDBFolder::GetWarnFilterChanged(bool *aVal)</span>
<a href="#l10.6553"></a><span id="l10.6553" class="difflineminus">-{</span>
<a href="#l10.6554"></a><span id="l10.6554" class="difflineplus">+nsresult nsMsgDBFolder::GetWarnFilterChanged(bool *aVal) {</span>
<a href="#l10.6555"></a><span id="l10.6555">   NS_ENSURE_ARG(aVal);</span>
<a href="#l10.6556"></a><span id="l10.6556">   nsresult rv;</span>
<a href="#l10.6557"></a><span id="l10.6557" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.6558"></a><span id="l10.6558" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l10.6559"></a><span id="l10.6559" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.6560"></a><span id="l10.6560">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6561"></a><span id="l10.6561">   rv = prefBranch-&gt;GetBoolPref(PREF_MAIL_WARN_FILTER_CHANGED, aVal);</span>
<a href="#l10.6562"></a><span id="l10.6562" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l10.6563"></a><span id="l10.6563" class="difflineminus">-    *aVal = false;</span>
<a href="#l10.6564"></a><span id="l10.6564" class="difflineplus">+  if (NS_FAILED(rv)) *aVal = false;</span>
<a href="#l10.6565"></a><span id="l10.6565">   return NS_OK;</span>
<a href="#l10.6566"></a><span id="l10.6566"> }</span>
<a href="#l10.6567"></a><span id="l10.6567"> </span>
<a href="#l10.6568"></a><span id="l10.6568" class="difflineminus">-nsresult</span>
<a href="#l10.6569"></a><span id="l10.6569" class="difflineminus">-nsMsgDBFolder::SetWarnFilterChanged(bool aVal)</span>
<a href="#l10.6570"></a><span id="l10.6570" class="difflineminus">-{</span>
<a href="#l10.6571"></a><span id="l10.6571" class="difflineminus">-  nsresult rv=NS_OK;</span>
<a href="#l10.6572"></a><span id="l10.6572" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.6573"></a><span id="l10.6573" class="difflineplus">+nsresult nsMsgDBFolder::SetWarnFilterChanged(bool aVal) {</span>
<a href="#l10.6574"></a><span id="l10.6574" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l10.6575"></a><span id="l10.6575" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l10.6576"></a><span id="l10.6576" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.6577"></a><span id="l10.6577">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6578"></a><span id="l10.6578">   return prefBranch-&gt;SetBoolPref(PREF_MAIL_WARN_FILTER_CHANGED, aVal);</span>
<a href="#l10.6579"></a><span id="l10.6579"> }</span>
<a href="#l10.6580"></a><span id="l10.6580"> </span>
<a href="#l10.6581"></a><span id="l10.6581" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::NotifyCompactCompleted()</span>
<a href="#l10.6582"></a><span id="l10.6582" class="difflineminus">-{</span>
<a href="#l10.6583"></a><span id="l10.6583" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::NotifyCompactCompleted() {</span>
<a href="#l10.6584"></a><span id="l10.6584">   NS_ASSERTION(false, &quot;should be overridden by child class&quot;);</span>
<a href="#l10.6585"></a><span id="l10.6585">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.6586"></a><span id="l10.6586"> }</span>
<a href="#l10.6587"></a><span id="l10.6587"> </span>
<a href="#l10.6588"></a><span id="l10.6588" class="difflineminus">-nsresult nsMsgDBFolder::CloseDBIfFolderNotOpen()</span>
<a href="#l10.6589"></a><span id="l10.6589" class="difflineminus">-{</span>
<a href="#l10.6590"></a><span id="l10.6590" class="difflineplus">+nsresult nsMsgDBFolder::CloseDBIfFolderNotOpen() {</span>
<a href="#l10.6591"></a><span id="l10.6591">   nsresult rv;</span>
<a href="#l10.6592"></a><span id="l10.6592">   nsCOMPtr&lt;nsIMsgMailSession&gt; session =</span>
<a href="#l10.6593"></a><span id="l10.6593" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6594"></a><span id="l10.6594" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l10.6595"></a><span id="l10.6595">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6596"></a><span id="l10.6596">   bool folderOpen;</span>
<a href="#l10.6597"></a><span id="l10.6597">   session-&gt;IsFolderOpenInWindow(this, &amp;folderOpen);</span>
<a href="#l10.6598"></a><span id="l10.6598" class="difflineminus">-  if (!folderOpen &amp;&amp; ! (mFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Inbox)))</span>
<a href="#l10.6599"></a><span id="l10.6599" class="difflineplus">+  if (!folderOpen &amp;&amp;</span>
<a href="#l10.6600"></a><span id="l10.6600" class="difflineplus">+      !(mFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Inbox)))</span>
<a href="#l10.6601"></a><span id="l10.6601">     SetMsgDatabase(nullptr);</span>
<a href="#l10.6602"></a><span id="l10.6602">   return NS_OK;</span>
<a href="#l10.6603"></a><span id="l10.6603"> }</span>
<a href="#l10.6604"></a><span id="l10.6604"> </span>
<a href="#l10.6605"></a><span id="l10.6605" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetSortOrder(int32_t order)</span>
<a href="#l10.6606"></a><span id="l10.6606" class="difflineminus">-{</span>
<a href="#l10.6607"></a><span id="l10.6607" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetSortOrder(int32_t order) {</span>
<a href="#l10.6608"></a><span id="l10.6608">   NS_ASSERTION(false, &quot;not implemented&quot;);</span>
<a href="#l10.6609"></a><span id="l10.6609">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.6610"></a><span id="l10.6610"> }</span>
<a href="#l10.6611"></a><span id="l10.6611"> </span>
<a href="#l10.6612"></a><span id="l10.6612" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetSortOrder(int32_t *order)</span>
<a href="#l10.6613"></a><span id="l10.6613" class="difflineminus">-{</span>
<a href="#l10.6614"></a><span id="l10.6614" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetSortOrder(int32_t *order) {</span>
<a href="#l10.6615"></a><span id="l10.6615">   NS_ENSURE_ARG_POINTER(order);</span>
<a href="#l10.6616"></a><span id="l10.6616"> </span>
<a href="#l10.6617"></a><span id="l10.6617">   uint32_t flags;</span>
<a href="#l10.6618"></a><span id="l10.6618">   nsresult rv = GetFlags(&amp;flags);</span>
<a href="#l10.6619"></a><span id="l10.6619" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.6620"></a><span id="l10.6620" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6621"></a><span id="l10.6621"> </span>
<a href="#l10.6622"></a><span id="l10.6622">   if (flags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l10.6623"></a><span id="l10.6623">     *order = 0;</span>
<a href="#l10.6624"></a><span id="l10.6624">   else if (flags &amp; nsMsgFolderFlags::Drafts)</span>
<a href="#l10.6625"></a><span id="l10.6625">     *order = 1;</span>
<a href="#l10.6626"></a><span id="l10.6626">   else if (flags &amp; nsMsgFolderFlags::Templates)</span>
<a href="#l10.6627"></a><span id="l10.6627">     *order = 2;</span>
<a href="#l10.6628"></a><span id="l10.6628">   else if (flags &amp; nsMsgFolderFlags::SentMail)</span>
<a href="#l10.6629"></a><span id="l10.6629" class="difflineat">@@ -5417,79 +4938,80 @@ NS_IMETHODIMP nsMsgDBFolder::GetSortOrde</span>
<a href="#l10.6630"></a><span id="l10.6630">   else if (flags &amp; nsMsgFolderFlags::Queue)</span>
<a href="#l10.6631"></a><span id="l10.6631">     *order = 8;</span>
<a href="#l10.6632"></a><span id="l10.6632">   else</span>
<a href="#l10.6633"></a><span id="l10.6633">     *order = 9;</span>
<a href="#l10.6634"></a><span id="l10.6634"> </span>
<a href="#l10.6635"></a><span id="l10.6635">   return NS_OK;</span>
<a href="#l10.6636"></a><span id="l10.6636"> }</span>
<a href="#l10.6637"></a><span id="l10.6637"> </span>
<a href="#l10.6638"></a><span id="l10.6638" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetSortKey(uint32_t *aLength, uint8_t **aKey)</span>
<a href="#l10.6639"></a><span id="l10.6639" class="difflineminus">-{</span>
<a href="#l10.6640"></a><span id="l10.6640" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetSortKey(uint32_t *aLength, uint8_t **aKey) {</span>
<a href="#l10.6641"></a><span id="l10.6641">   NS_ENSURE_ARG(aKey);</span>
<a href="#l10.6642"></a><span id="l10.6642">   int32_t order;</span>
<a href="#l10.6643"></a><span id="l10.6643">   nsresult rv = GetSortOrder(&amp;order);</span>
<a href="#l10.6644"></a><span id="l10.6644" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.6645"></a><span id="l10.6645" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6646"></a><span id="l10.6646">   nsAutoString orderString;</span>
<a href="#l10.6647"></a><span id="l10.6647">   orderString.AppendInt(order);</span>
<a href="#l10.6648"></a><span id="l10.6648">   nsString folderName;</span>
<a href="#l10.6649"></a><span id="l10.6649">   rv = GetName(folderName);</span>
<a href="#l10.6650"></a><span id="l10.6650" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.6651"></a><span id="l10.6651" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6652"></a><span id="l10.6652">   orderString.Append(folderName);</span>
<a href="#l10.6653"></a><span id="l10.6653">   return CreateCollationKey(orderString, aKey, aLength);</span>
<a href="#l10.6654"></a><span id="l10.6654"> }</span>
<a href="#l10.6655"></a><span id="l10.6655"> </span>
<a href="#l10.6656"></a><span id="l10.6656" class="difflineminus">-nsresult</span>
<a href="#l10.6657"></a><span id="l10.6657" class="difflineminus">-nsMsgDBFolder::CreateCollationKey(const nsString &amp;aSource,  uint8_t **aKey, uint32_t *aLength)</span>
<a href="#l10.6658"></a><span id="l10.6658" class="difflineminus">-{</span>
<a href="#l10.6659"></a><span id="l10.6659" class="difflineplus">+nsresult nsMsgDBFolder::CreateCollationKey(const nsString &amp;aSource,</span>
<a href="#l10.6660"></a><span id="l10.6660" class="difflineplus">+                                           uint8_t **aKey, uint32_t *aLength) {</span>
<a href="#l10.6661"></a><span id="l10.6661">   NS_ENSURE_TRUE(gCollationKeyGenerator, NS_ERROR_NULL_POINTER);</span>
<a href="#l10.6662"></a><span id="l10.6662" class="difflineminus">-  return gCollationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive, aSource,</span>
<a href="#l10.6663"></a><span id="l10.6663" class="difflineminus">-                                                    aKey, aLength);</span>
<a href="#l10.6664"></a><span id="l10.6664" class="difflineminus">-}</span>
<a href="#l10.6665"></a><span id="l10.6665" class="difflineminus">-</span>
<a href="#l10.6666"></a><span id="l10.6666" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::CompareSortKeys(nsIMsgFolder *aFolder, int32_t *sortOrder)</span>
<a href="#l10.6667"></a><span id="l10.6667" class="difflineminus">-{</span>
<a href="#l10.6668"></a><span id="l10.6668" class="difflineminus">-  uint8_t *sortKey1=nullptr;</span>
<a href="#l10.6669"></a><span id="l10.6669" class="difflineminus">-  uint8_t *sortKey2=nullptr;</span>
<a href="#l10.6670"></a><span id="l10.6670" class="difflineplus">+  return gCollationKeyGenerator-&gt;AllocateRawSortKey(</span>
<a href="#l10.6671"></a><span id="l10.6671" class="difflineplus">+      nsICollation::kCollationCaseInSensitive, aSource, aKey, aLength);</span>
<a href="#l10.6672"></a><span id="l10.6672" class="difflineplus">+}</span>
<a href="#l10.6673"></a><span id="l10.6673" class="difflineplus">+</span>
<a href="#l10.6674"></a><span id="l10.6674" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CompareSortKeys(nsIMsgFolder *aFolder,</span>
<a href="#l10.6675"></a><span id="l10.6675" class="difflineplus">+                                             int32_t *sortOrder) {</span>
<a href="#l10.6676"></a><span id="l10.6676" class="difflineplus">+  uint8_t *sortKey1 = nullptr;</span>
<a href="#l10.6677"></a><span id="l10.6677" class="difflineplus">+  uint8_t *sortKey2 = nullptr;</span>
<a href="#l10.6678"></a><span id="l10.6678">   uint32_t sortKey1Length;</span>
<a href="#l10.6679"></a><span id="l10.6679">   uint32_t sortKey2Length;</span>
<a href="#l10.6680"></a><span id="l10.6680">   nsresult rv = GetSortKey(&amp;sortKey1Length, &amp;sortKey1);</span>
<a href="#l10.6681"></a><span id="l10.6681" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.6682"></a><span id="l10.6682" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6683"></a><span id="l10.6683">   aFolder-&gt;GetSortKey(&amp;sortKey2Length, &amp;sortKey2);</span>
<a href="#l10.6684"></a><span id="l10.6684" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.6685"></a><span id="l10.6685" class="difflineminus">-</span>
<a href="#l10.6686"></a><span id="l10.6686" class="difflineminus">-  rv = gCollationKeyGenerator-&gt;CompareRawSortKey(sortKey1, sortKey1Length, sortKey2, sortKey2Length, sortOrder);</span>
<a href="#l10.6687"></a><span id="l10.6687" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6688"></a><span id="l10.6688" class="difflineplus">+</span>
<a href="#l10.6689"></a><span id="l10.6689" class="difflineplus">+  rv = gCollationKeyGenerator-&gt;CompareRawSortKey(</span>
<a href="#l10.6690"></a><span id="l10.6690" class="difflineplus">+      sortKey1, sortKey1Length, sortKey2, sortKey2Length, sortOrder);</span>
<a href="#l10.6691"></a><span id="l10.6691">   PR_Free(sortKey1);</span>
<a href="#l10.6692"></a><span id="l10.6692">   PR_Free(sortKey2);</span>
<a href="#l10.6693"></a><span id="l10.6693">   return rv;</span>
<a href="#l10.6694"></a><span id="l10.6694"> }</span>
<a href="#l10.6695"></a><span id="l10.6695"> </span>
<a href="#l10.6696"></a><span id="l10.6696" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::FetchMsgPreviewText(nsMsgKey *aKeysToFetch, uint32_t aNumKeys,</span>
<a href="#l10.6697"></a><span id="l10.6697" class="difflineminus">-                                                 bool aLocalOnly, nsIUrlListener *aUrlListener,</span>
<a href="#l10.6698"></a><span id="l10.6698" class="difflineminus">-                                                 bool *aAsyncResults)</span>
<a href="#l10.6699"></a><span id="l10.6699" class="difflineminus">-{</span>
<a href="#l10.6700"></a><span id="l10.6700" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::FetchMsgPreviewText(nsMsgKey *aKeysToFetch,</span>
<a href="#l10.6701"></a><span id="l10.6701" class="difflineplus">+                                                 uint32_t aNumKeys,</span>
<a href="#l10.6702"></a><span id="l10.6702" class="difflineplus">+                                                 bool aLocalOnly,</span>
<a href="#l10.6703"></a><span id="l10.6703" class="difflineplus">+                                                 nsIUrlListener *aUrlListener,</span>
<a href="#l10.6704"></a><span id="l10.6704" class="difflineplus">+                                                 bool *aAsyncResults) {</span>
<a href="#l10.6705"></a><span id="l10.6705">   NS_ENSURE_ARG_POINTER(aKeysToFetch);</span>
<a href="#l10.6706"></a><span id="l10.6706">   NS_ENSURE_ARG_POINTER(aAsyncResults);</span>
<a href="#l10.6707"></a><span id="l10.6707">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.6708"></a><span id="l10.6708"> }</span>
<a href="#l10.6709"></a><span id="l10.6709"> </span>
<a href="#l10.6710"></a><span id="l10.6710" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetMsgTextFromStream(nsIInputStream *stream, const nsACString &amp;aCharset,</span>
<a href="#l10.6711"></a><span id="l10.6711" class="difflineminus">-                                                  uint32_t bytesToRead, uint32_t aMaxOutputLen,</span>
<a href="#l10.6712"></a><span id="l10.6712" class="difflineminus">-                                                  bool aCompressQuotes, bool aStripHTMLTags,</span>
<a href="#l10.6713"></a><span id="l10.6713" class="difflineminus">-                                                  nsACString &amp;aContentType, nsACString &amp;aMsgText)</span>
<a href="#l10.6714"></a><span id="l10.6714" class="difflineminus">-{</span>
<a href="#l10.6715"></a><span id="l10.6715" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetMsgTextFromStream(</span>
<a href="#l10.6716"></a><span id="l10.6716" class="difflineplus">+    nsIInputStream *stream, const nsACString &amp;aCharset, uint32_t bytesToRead,</span>
<a href="#l10.6717"></a><span id="l10.6717" class="difflineplus">+    uint32_t aMaxOutputLen, bool aCompressQuotes, bool aStripHTMLTags,</span>
<a href="#l10.6718"></a><span id="l10.6718" class="difflineplus">+    nsACString &amp;aContentType, nsACString &amp;aMsgText) {</span>
<a href="#l10.6719"></a><span id="l10.6719">   /*</span>
<a href="#l10.6720"></a><span id="l10.6720" class="difflineminus">-   1. non mime message - the message body starts after the blank line following the headers.</span>
<a href="#l10.6721"></a><span id="l10.6721" class="difflineminus">-   2. mime message, multipart/alternative - we could simply scan for the boundary line,</span>
<a href="#l10.6722"></a><span id="l10.6722" class="difflineminus">-   advance past its headers, and treat the next few lines as the text.</span>
<a href="#l10.6723"></a><span id="l10.6723" class="difflineminus">-   3. mime message, text/plain - body follows headers</span>
<a href="#l10.6724"></a><span id="l10.6724" class="difflineminus">-   4. multipart/mixed - scan past boundary, treat next part as body.</span>
<a href="#l10.6725"></a><span id="l10.6725" class="difflineplus">+     1. non mime message - the message body starts after the blank line</span>
<a href="#l10.6726"></a><span id="l10.6726" class="difflineplus">+        following the headers.</span>
<a href="#l10.6727"></a><span id="l10.6727" class="difflineplus">+     2. mime message, multipart/alternative - we could simply scan for the</span>
<a href="#l10.6728"></a><span id="l10.6728" class="difflineplus">+        boundary line, advance past its headers, and treat the next few lines</span>
<a href="#l10.6729"></a><span id="l10.6729" class="difflineplus">+        as the text.</span>
<a href="#l10.6730"></a><span id="l10.6730" class="difflineplus">+     3. mime message, text/plain - body follows headers</span>
<a href="#l10.6731"></a><span id="l10.6731" class="difflineplus">+     4. multipart/mixed - scan past boundary, treat next part as body.</span>
<a href="#l10.6732"></a><span id="l10.6732">    */</span>
<a href="#l10.6733"></a><span id="l10.6733"> </span>
<a href="#l10.6734"></a><span id="l10.6734" class="difflineminus">-  nsAutoPtr&lt;nsLineBuffer&lt;char&gt; &gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l10.6735"></a><span id="l10.6735" class="difflineplus">+  nsAutoPtr&lt;nsLineBuffer&lt;char&gt;&gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l10.6736"></a><span id="l10.6736">   NS_ENSURE_TRUE(lineBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l10.6737"></a><span id="l10.6737"> </span>
<a href="#l10.6738"></a><span id="l10.6738">   nsAutoCString msgText;</span>
<a href="#l10.6739"></a><span id="l10.6739">   nsAutoString contentType;</span>
<a href="#l10.6740"></a><span id="l10.6740">   nsAutoString encoding;</span>
<a href="#l10.6741"></a><span id="l10.6741">   nsAutoCString curLine;</span>
<a href="#l10.6742"></a><span id="l10.6742">   nsAutoCString charset(aCharset);</span>
<a href="#l10.6743"></a><span id="l10.6743"> </span>
<a href="#l10.6744"></a><span id="l10.6744" class="difflineat">@@ -5501,567 +5023,512 @@ NS_IMETHODIMP nsMsgDBFolder::GetMsgTextF</span>
<a href="#l10.6745"></a><span id="l10.6745">   bool inMsgBody = false;</span>
<a href="#l10.6746"></a><span id="l10.6746">   bool justPassedEndBoundary = false;</span>
<a href="#l10.6747"></a><span id="l10.6747"> </span>
<a href="#l10.6748"></a><span id="l10.6748">   uint32_t bytesRead = 0;</span>
<a href="#l10.6749"></a><span id="l10.6749"> </span>
<a href="#l10.6750"></a><span id="l10.6750">   nsresult rv;</span>
<a href="#l10.6751"></a><span id="l10.6751"> </span>
<a href="#l10.6752"></a><span id="l10.6752">   // Both are used to extract data from the headers</span>
<a href="#l10.6753"></a><span id="l10.6753" class="difflineminus">-  nsCOMPtr&lt;nsIMimeHeaders&gt; mimeHeaders(do_CreateInstance(NS_IMIMEHEADERS_CONTRACTID, &amp;rv));</span>
<a href="#l10.6754"></a><span id="l10.6754" class="difflineplus">+  nsCOMPtr&lt;nsIMimeHeaders&gt; mimeHeaders(</span>
<a href="#l10.6755"></a><span id="l10.6755" class="difflineplus">+      do_CreateInstance(NS_IMIMEHEADERS_CONTRACTID, &amp;rv));</span>
<a href="#l10.6756"></a><span id="l10.6756">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6757"></a><span id="l10.6757" class="difflineminus">-  nsCOMPtr&lt;nsIMIMEHeaderParam&gt; mimeHdrParam(do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv));</span>
<a href="#l10.6758"></a><span id="l10.6758" class="difflineplus">+  nsCOMPtr&lt;nsIMIMEHeaderParam&gt; mimeHdrParam(</span>
<a href="#l10.6759"></a><span id="l10.6759" class="difflineplus">+      do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv));</span>
<a href="#l10.6760"></a><span id="l10.6760">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6761"></a><span id="l10.6761"> </span>
<a href="#l10.6762"></a><span id="l10.6762">   // Stack of boundaries, used to figure out where we are</span>
<a href="#l10.6763"></a><span id="l10.6763">   nsTArray&lt;nsCString&gt; boundaryStack;</span>
<a href="#l10.6764"></a><span id="l10.6764"> </span>
<a href="#l10.6765"></a><span id="l10.6765" class="difflineminus">-  while (!inMsgBody &amp;&amp; bytesRead &lt;= bytesToRead)</span>
<a href="#l10.6766"></a><span id="l10.6766" class="difflineminus">-  {</span>
<a href="#l10.6767"></a><span id="l10.6767" class="difflineplus">+  while (!inMsgBody &amp;&amp; bytesRead &lt;= bytesToRead) {</span>
<a href="#l10.6768"></a><span id="l10.6768">     nsAutoCString msgHeaders;</span>
<a href="#l10.6769"></a><span id="l10.6769" class="difflineminus">-    // We want to NS_ReadLine until we get to a blank line (the end of the headers)</span>
<a href="#l10.6770"></a><span id="l10.6770" class="difflineminus">-    while (more)</span>
<a href="#l10.6771"></a><span id="l10.6771" class="difflineminus">-    {</span>
<a href="#l10.6772"></a><span id="l10.6772" class="difflineplus">+    // We want to NS_ReadLine until we get to a blank line (the end of the</span>
<a href="#l10.6773"></a><span id="l10.6773" class="difflineplus">+    // headers)</span>
<a href="#l10.6774"></a><span id="l10.6774" class="difflineplus">+    while (more) {</span>
<a href="#l10.6775"></a><span id="l10.6775">       rv = NS_ReadLine(stream, lineBuffer.get(), curLine, &amp;more);</span>
<a href="#l10.6776"></a><span id="l10.6776">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6777"></a><span id="l10.6777" class="difflineminus">-      if (curLine.IsEmpty())</span>
<a href="#l10.6778"></a><span id="l10.6778" class="difflineminus">-        break;</span>
<a href="#l10.6779"></a><span id="l10.6779" class="difflineplus">+      if (curLine.IsEmpty()) break;</span>
<a href="#l10.6780"></a><span id="l10.6780">       msgHeaders.Append(curLine);</span>
<a href="#l10.6781"></a><span id="l10.6781">       msgHeaders.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l10.6782"></a><span id="l10.6782">       bytesRead += curLine.Length();</span>
<a href="#l10.6783"></a><span id="l10.6783" class="difflineminus">-      if (bytesRead &gt; bytesToRead)</span>
<a href="#l10.6784"></a><span id="l10.6784" class="difflineminus">-        break;</span>
<a href="#l10.6785"></a><span id="l10.6785" class="difflineplus">+      if (bytesRead &gt; bytesToRead) break;</span>
<a href="#l10.6786"></a><span id="l10.6786">     }</span>
<a href="#l10.6787"></a><span id="l10.6787"> </span>
<a href="#l10.6788"></a><span id="l10.6788">     // There's no point in processing if we can't get the body</span>
<a href="#l10.6789"></a><span id="l10.6789" class="difflineminus">-    if (bytesRead &gt; bytesToRead)</span>
<a href="#l10.6790"></a><span id="l10.6790" class="difflineminus">-      break;</span>
<a href="#l10.6791"></a><span id="l10.6791" class="difflineplus">+    if (bytesRead &gt; bytesToRead) break;</span>
<a href="#l10.6792"></a><span id="l10.6792"> </span>
<a href="#l10.6793"></a><span id="l10.6793">     // Process the headers, looking for things we need</span>
<a href="#l10.6794"></a><span id="l10.6794">     rv = mimeHeaders-&gt;Initialize(msgHeaders);</span>
<a href="#l10.6795"></a><span id="l10.6795">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6796"></a><span id="l10.6796"> </span>
<a href="#l10.6797"></a><span id="l10.6797">     nsAutoCString contentTypeHdr;</span>
<a href="#l10.6798"></a><span id="l10.6798">     mimeHeaders-&gt;ExtractHeader(&quot;Content-Type&quot;, false, contentTypeHdr);</span>
<a href="#l10.6799"></a><span id="l10.6799"> </span>
<a href="#l10.6800"></a><span id="l10.6800">     // Get the content type</span>
<a href="#l10.6801"></a><span id="l10.6801">     // If we don't have a content type, then we assign text/plain</span>
<a href="#l10.6802"></a><span id="l10.6802">     // this is in violation of the RFC for multipart/digest, though</span>
<a href="#l10.6803"></a><span id="l10.6803">     // Also, if we've just passed an end boundary, we're going to ignore this.</span>
<a href="#l10.6804"></a><span id="l10.6804">     if (!justPassedEndBoundary &amp;&amp; contentTypeHdr.IsEmpty())</span>
<a href="#l10.6805"></a><span id="l10.6805">       contentType.AssignLiteral(u&quot;text/plain&quot;);</span>
<a href="#l10.6806"></a><span id="l10.6806">     else</span>
<a href="#l10.6807"></a><span id="l10.6807" class="difflineminus">-      mimeHdrParam-&gt;GetParameter(contentTypeHdr, nullptr, EmptyCString(), false, nullptr, contentType);</span>
<a href="#l10.6808"></a><span id="l10.6808" class="difflineplus">+      mimeHdrParam-&gt;GetParameter(contentTypeHdr, nullptr, EmptyCString(), false,</span>
<a href="#l10.6809"></a><span id="l10.6809" class="difflineplus">+                                 nullptr, contentType);</span>
<a href="#l10.6810"></a><span id="l10.6810"> </span>
<a href="#l10.6811"></a><span id="l10.6811">     justPassedEndBoundary = false;</span>
<a href="#l10.6812"></a><span id="l10.6812"> </span>
<a href="#l10.6813"></a><span id="l10.6813">     // If we are multipart, then we need to get the boundary</span>
<a href="#l10.6814"></a><span id="l10.6814" class="difflineminus">-    if (StringBeginsWith(contentType, NS_LITERAL_STRING(&quot;multipart/&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l10.6815"></a><span id="l10.6815" class="difflineminus">-    {</span>
<a href="#l10.6816"></a><span id="l10.6816" class="difflineplus">+    if (StringBeginsWith(contentType, NS_LITERAL_STRING(&quot;multipart/&quot;),</span>
<a href="#l10.6817"></a><span id="l10.6817" class="difflineplus">+                         nsCaseInsensitiveStringComparator())) {</span>
<a href="#l10.6818"></a><span id="l10.6818">       nsAutoString boundaryParam;</span>
<a href="#l10.6819"></a><span id="l10.6819" class="difflineminus">-      mimeHdrParam-&gt;GetParameter(contentTypeHdr, &quot;boundary&quot;, EmptyCString(), false, nullptr, boundaryParam);</span>
<a href="#l10.6820"></a><span id="l10.6820" class="difflineminus">-      if (!boundaryParam.IsEmpty())</span>
<a href="#l10.6821"></a><span id="l10.6821" class="difflineminus">-      {</span>
<a href="#l10.6822"></a><span id="l10.6822" class="difflineplus">+      mimeHdrParam-&gt;GetParameter(contentTypeHdr, &quot;boundary&quot;, EmptyCString(),</span>
<a href="#l10.6823"></a><span id="l10.6823" class="difflineplus">+                                 false, nullptr, boundaryParam);</span>
<a href="#l10.6824"></a><span id="l10.6824" class="difflineplus">+      if (!boundaryParam.IsEmpty()) {</span>
<a href="#l10.6825"></a><span id="l10.6825">         nsAutoCString boundary(NS_LITERAL_CSTRING(&quot;--&quot;));</span>
<a href="#l10.6826"></a><span id="l10.6826">         boundary.Append(NS_ConvertUTF16toUTF8(boundaryParam));</span>
<a href="#l10.6827"></a><span id="l10.6827">         boundaryStack.AppendElement(boundary);</span>
<a href="#l10.6828"></a><span id="l10.6828">       }</span>
<a href="#l10.6829"></a><span id="l10.6829">     }</span>
<a href="#l10.6830"></a><span id="l10.6830"> </span>
<a href="#l10.6831"></a><span id="l10.6831">     // If we are message/rfc822, then there's another header block coming up</span>
<a href="#l10.6832"></a><span id="l10.6832">     else if (contentType.LowerCaseEqualsLiteral(&quot;message/rfc822&quot;))</span>
<a href="#l10.6833"></a><span id="l10.6833">       continue;</span>
<a href="#l10.6834"></a><span id="l10.6834"> </span>
<a href="#l10.6835"></a><span id="l10.6835">     // If we are a text part, then we want it</span>
<a href="#l10.6836"></a><span id="l10.6836" class="difflineminus">-    else if (StringBeginsWith(contentType, NS_LITERAL_STRING(&quot;text/&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l10.6837"></a><span id="l10.6837" class="difflineminus">-    {</span>
<a href="#l10.6838"></a><span id="l10.6838" class="difflineplus">+    else if (StringBeginsWith(contentType, NS_LITERAL_STRING(&quot;text/&quot;),</span>
<a href="#l10.6839"></a><span id="l10.6839" class="difflineplus">+                              nsCaseInsensitiveStringComparator())) {</span>
<a href="#l10.6840"></a><span id="l10.6840">       inMsgBody = true;</span>
<a href="#l10.6841"></a><span id="l10.6841"> </span>
<a href="#l10.6842"></a><span id="l10.6842" class="difflineminus">-      if (contentType.LowerCaseEqualsLiteral(&quot;text/html&quot;))</span>
<a href="#l10.6843"></a><span id="l10.6843" class="difflineminus">-        msgBodyIsHtml = true;</span>
<a href="#l10.6844"></a><span id="l10.6844" class="difflineplus">+      if (contentType.LowerCaseEqualsLiteral(&quot;text/html&quot;)) msgBodyIsHtml = true;</span>
<a href="#l10.6845"></a><span id="l10.6845"> </span>
<a href="#l10.6846"></a><span id="l10.6846">       // Also get the charset if required</span>
<a href="#l10.6847"></a><span id="l10.6847" class="difflineminus">-      if (charset.IsEmpty())</span>
<a href="#l10.6848"></a><span id="l10.6848" class="difflineminus">-      {</span>
<a href="#l10.6849"></a><span id="l10.6849" class="difflineplus">+      if (charset.IsEmpty()) {</span>
<a href="#l10.6850"></a><span id="l10.6850">         nsAutoString charsetW;</span>
<a href="#l10.6851"></a><span id="l10.6851" class="difflineminus">-        mimeHdrParam-&gt;GetParameter(contentTypeHdr, &quot;charset&quot;, EmptyCString(), false, nullptr, charsetW);</span>
<a href="#l10.6852"></a><span id="l10.6852" class="difflineplus">+        mimeHdrParam-&gt;GetParameter(contentTypeHdr, &quot;charset&quot;, EmptyCString(),</span>
<a href="#l10.6853"></a><span id="l10.6853" class="difflineplus">+                                   false, nullptr, charsetW);</span>
<a href="#l10.6854"></a><span id="l10.6854">         charset.Assign(NS_ConvertUTF16toUTF8(charsetW));</span>
<a href="#l10.6855"></a><span id="l10.6855">       }</span>
<a href="#l10.6856"></a><span id="l10.6856"> </span>
<a href="#l10.6857"></a><span id="l10.6857">       // Finally, get the encoding</span>
<a href="#l10.6858"></a><span id="l10.6858">       nsAutoCString encodingHdr;</span>
<a href="#l10.6859"></a><span id="l10.6859" class="difflineminus">-      mimeHeaders-&gt;ExtractHeader(&quot;Content-Transfer-Encoding&quot;, false, encodingHdr);</span>
<a href="#l10.6860"></a><span id="l10.6860" class="difflineplus">+      mimeHeaders-&gt;ExtractHeader(&quot;Content-Transfer-Encoding&quot;, false,</span>
<a href="#l10.6861"></a><span id="l10.6861" class="difflineplus">+                                 encodingHdr);</span>
<a href="#l10.6862"></a><span id="l10.6862">       if (!encodingHdr.IsEmpty())</span>
<a href="#l10.6863"></a><span id="l10.6863" class="difflineminus">-        mimeHdrParam-&gt;GetParameter(encodingHdr, nullptr, EmptyCString(), false, nullptr, encoding);</span>
<a href="#l10.6864"></a><span id="l10.6864" class="difflineminus">-</span>
<a href="#l10.6865"></a><span id="l10.6865" class="difflineminus">-      if (encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l10.6866"></a><span id="l10.6866" class="difflineminus">-        isBase64 = true;</span>
<a href="#l10.6867"></a><span id="l10.6867" class="difflineplus">+        mimeHdrParam-&gt;GetParameter(encodingHdr, nullptr, EmptyCString(), false,</span>
<a href="#l10.6868"></a><span id="l10.6868" class="difflineplus">+                                   nullptr, encoding);</span>
<a href="#l10.6869"></a><span id="l10.6869" class="difflineplus">+</span>
<a href="#l10.6870"></a><span id="l10.6870" class="difflineplus">+      if (encoding.LowerCaseEqualsLiteral(ENCODING_BASE64)) isBase64 = true;</span>
<a href="#l10.6871"></a><span id="l10.6871">     }</span>
<a href="#l10.6872"></a><span id="l10.6872"> </span>
<a href="#l10.6873"></a><span id="l10.6873">     // We need to consume the rest, until the next headers</span>
<a href="#l10.6874"></a><span id="l10.6874">     uint32_t count = boundaryStack.Length();</span>
<a href="#l10.6875"></a><span id="l10.6875">     nsAutoCString boundary;</span>
<a href="#l10.6876"></a><span id="l10.6876">     nsAutoCString endBoundary;</span>
<a href="#l10.6877"></a><span id="l10.6877" class="difflineminus">-    if (count)</span>
<a href="#l10.6878"></a><span id="l10.6878" class="difflineminus">-    {</span>
<a href="#l10.6879"></a><span id="l10.6879" class="difflineplus">+    if (count) {</span>
<a href="#l10.6880"></a><span id="l10.6880">       boundary.Assign(boundaryStack.ElementAt(count - 1));</span>
<a href="#l10.6881"></a><span id="l10.6881">       endBoundary.Assign(boundary);</span>
<a href="#l10.6882"></a><span id="l10.6882">       endBoundary.AppendLiteral(&quot;--&quot;);</span>
<a href="#l10.6883"></a><span id="l10.6883">     }</span>
<a href="#l10.6884"></a><span id="l10.6884" class="difflineminus">-    while (more)</span>
<a href="#l10.6885"></a><span id="l10.6885" class="difflineminus">-    {</span>
<a href="#l10.6886"></a><span id="l10.6886" class="difflineplus">+    while (more) {</span>
<a href="#l10.6887"></a><span id="l10.6887">       rv = NS_ReadLine(stream, lineBuffer.get(), curLine, &amp;more);</span>
<a href="#l10.6888"></a><span id="l10.6888">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.6889"></a><span id="l10.6889"> </span>
<a href="#l10.6890"></a><span id="l10.6890" class="difflineminus">-      if (count)</span>
<a href="#l10.6891"></a><span id="l10.6891" class="difflineminus">-      {</span>
<a href="#l10.6892"></a><span id="l10.6892" class="difflineplus">+      if (count) {</span>
<a href="#l10.6893"></a><span id="l10.6893">         // If we've reached a MIME final delimiter, pop and break</span>
<a href="#l10.6894"></a><span id="l10.6894" class="difflineminus">-        if (StringBeginsWith(curLine, endBoundary))</span>
<a href="#l10.6895"></a><span id="l10.6895" class="difflineminus">-        {</span>
<a href="#l10.6896"></a><span id="l10.6896" class="difflineminus">-          if (inMsgBody)</span>
<a href="#l10.6897"></a><span id="l10.6897" class="difflineminus">-            reachedEndBody = true;</span>
<a href="#l10.6898"></a><span id="l10.6898" class="difflineplus">+        if (StringBeginsWith(curLine, endBoundary)) {</span>
<a href="#l10.6899"></a><span id="l10.6899" class="difflineplus">+          if (inMsgBody) reachedEndBody = true;</span>
<a href="#l10.6900"></a><span id="l10.6900">           boundaryStack.RemoveElementAt(count - 1);</span>
<a href="#l10.6901"></a><span id="l10.6901">           justPassedEndBoundary = true;</span>
<a href="#l10.6902"></a><span id="l10.6902">           break;</span>
<a href="#l10.6903"></a><span id="l10.6903">         }</span>
<a href="#l10.6904"></a><span id="l10.6904">         // If we've reached the end of this MIME part, we can break</span>
<a href="#l10.6905"></a><span id="l10.6905" class="difflineminus">-        if (StringBeginsWith(curLine, boundary))</span>
<a href="#l10.6906"></a><span id="l10.6906" class="difflineminus">-        {</span>
<a href="#l10.6907"></a><span id="l10.6907" class="difflineminus">-          if (inMsgBody)</span>
<a href="#l10.6908"></a><span id="l10.6908" class="difflineminus">-            reachedEndBody = true;</span>
<a href="#l10.6909"></a><span id="l10.6909" class="difflineplus">+        if (StringBeginsWith(curLine, boundary)) {</span>
<a href="#l10.6910"></a><span id="l10.6910" class="difflineplus">+          if (inMsgBody) reachedEndBody = true;</span>
<a href="#l10.6911"></a><span id="l10.6911">           break;</span>
<a href="#l10.6912"></a><span id="l10.6912">         }</span>
<a href="#l10.6913"></a><span id="l10.6913">       }</span>
<a href="#l10.6914"></a><span id="l10.6914"> </span>
<a href="#l10.6915"></a><span id="l10.6915">       // Only append the text if we're actually in the message body</span>
<a href="#l10.6916"></a><span id="l10.6916" class="difflineminus">-      if (inMsgBody)</span>
<a href="#l10.6917"></a><span id="l10.6917" class="difflineminus">-      {</span>
<a href="#l10.6918"></a><span id="l10.6918" class="difflineplus">+      if (inMsgBody) {</span>
<a href="#l10.6919"></a><span id="l10.6919">         msgText.Append(curLine);</span>
<a href="#l10.6920"></a><span id="l10.6920" class="difflineminus">-        if (!isBase64)</span>
<a href="#l10.6921"></a><span id="l10.6921" class="difflineminus">-          msgText.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l10.6922"></a><span id="l10.6922" class="difflineplus">+        if (!isBase64) msgText.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l10.6923"></a><span id="l10.6923">       }</span>
<a href="#l10.6924"></a><span id="l10.6924"> </span>
<a href="#l10.6925"></a><span id="l10.6925">       bytesRead += curLine.Length();</span>
<a href="#l10.6926"></a><span id="l10.6926" class="difflineminus">-      if (bytesRead &gt; bytesToRead)</span>
<a href="#l10.6927"></a><span id="l10.6927" class="difflineminus">-        break;</span>
<a href="#l10.6928"></a><span id="l10.6928" class="difflineplus">+      if (bytesRead &gt; bytesToRead) break;</span>
<a href="#l10.6929"></a><span id="l10.6929">     }</span>
<a href="#l10.6930"></a><span id="l10.6930">   }</span>
<a href="#l10.6931"></a><span id="l10.6931">   lineBuffer = nullptr;</span>
<a href="#l10.6932"></a><span id="l10.6932"> </span>
<a href="#l10.6933"></a><span id="l10.6933">   // if the snippet is encoded, decode it</span>
<a href="#l10.6934"></a><span id="l10.6934">   if (!encoding.IsEmpty())</span>
<a href="#l10.6935"></a><span id="l10.6935">     decodeMsgSnippet(NS_ConvertUTF16toUTF8(encoding), !reachedEndBody, msgText);</span>
<a href="#l10.6936"></a><span id="l10.6936"> </span>
<a href="#l10.6937"></a><span id="l10.6937" class="difflineminus">-  // In order to turn our snippet into unicode, we need to convert it from the charset we</span>
<a href="#l10.6938"></a><span id="l10.6938" class="difflineminus">-  // detected earlier.</span>
<a href="#l10.6939"></a><span id="l10.6939" class="difflineplus">+  // In order to turn our snippet into unicode, we need to convert it from the</span>
<a href="#l10.6940"></a><span id="l10.6940" class="difflineplus">+  // charset we detected earlier.</span>
<a href="#l10.6941"></a><span id="l10.6941">   nsString unicodeMsgBodyStr;</span>
<a href="#l10.6942"></a><span id="l10.6942">   nsMsgI18NConvertToUnicode(charset, msgText, unicodeMsgBodyStr);</span>
<a href="#l10.6943"></a><span id="l10.6943"> </span>
<a href="#l10.6944"></a><span id="l10.6944">   // now we've got a msg body. If it's html, convert it to plain text.</span>
<a href="#l10.6945"></a><span id="l10.6945">   if (msgBodyIsHtml &amp;&amp; aStripHTMLTags)</span>
<a href="#l10.6946"></a><span id="l10.6946">     ConvertMsgSnippetToPlainText(unicodeMsgBodyStr, unicodeMsgBodyStr);</span>
<a href="#l10.6947"></a><span id="l10.6947"> </span>
<a href="#l10.6948"></a><span id="l10.6948">   // We want to remove any whitespace from the beginning and end of the string</span>
<a href="#l10.6949"></a><span id="l10.6949">   unicodeMsgBodyStr.Trim(&quot; \t\r\n&quot;, true, true);</span>
<a href="#l10.6950"></a><span id="l10.6950"> </span>
<a href="#l10.6951"></a><span id="l10.6951">   // step 3, optionally remove quoted text from the snippet</span>
<a href="#l10.6952"></a><span id="l10.6952">   nsString compressedQuotesMsgStr;</span>
<a href="#l10.6953"></a><span id="l10.6953">   if (aCompressQuotes)</span>
<a href="#l10.6954"></a><span id="l10.6954">     compressQuotesInMsgSnippet(unicodeMsgBodyStr, compressedQuotesMsgStr);</span>
<a href="#l10.6955"></a><span id="l10.6955"> </span>
<a href="#l10.6956"></a><span id="l10.6956">   // now convert back to utf-8 which is more convenient for storage</span>
<a href="#l10.6957"></a><span id="l10.6957" class="difflineminus">-  CopyUTF16toUTF8(aCompressQuotes ? compressedQuotesMsgStr : unicodeMsgBodyStr, aMsgText);</span>
<a href="#l10.6958"></a><span id="l10.6958" class="difflineplus">+  CopyUTF16toUTF8(aCompressQuotes ? compressedQuotesMsgStr : unicodeMsgBodyStr,</span>
<a href="#l10.6959"></a><span id="l10.6959" class="difflineplus">+                  aMsgText);</span>
<a href="#l10.6960"></a><span id="l10.6960"> </span>
<a href="#l10.6961"></a><span id="l10.6961">   // finally, truncate the string based on aMaxOutputLen</span>
<a href="#l10.6962"></a><span id="l10.6962">   if (aMsgText.Length() &gt; aMaxOutputLen) {</span>
<a href="#l10.6963"></a><span id="l10.6963">     if (NS_IsAscii(aMsgText.BeginReading()))</span>
<a href="#l10.6964"></a><span id="l10.6964">       aMsgText.SetLength(aMaxOutputLen);</span>
<a href="#l10.6965"></a><span id="l10.6965">     else</span>
<a href="#l10.6966"></a><span id="l10.6966" class="difflineminus">-      nsMsgI18NShrinkUTF8Str(nsCString(aMsgText),</span>
<a href="#l10.6967"></a><span id="l10.6967" class="difflineminus">-                             aMaxOutputLen, aMsgText);</span>
<a href="#l10.6968"></a><span id="l10.6968" class="difflineplus">+      nsMsgI18NShrinkUTF8Str(nsCString(aMsgText), aMaxOutputLen, aMsgText);</span>
<a href="#l10.6969"></a><span id="l10.6969">   }</span>
<a href="#l10.6970"></a><span id="l10.6970"> </span>
<a href="#l10.6971"></a><span id="l10.6971">   // Also assign the content type being returned</span>
<a href="#l10.6972"></a><span id="l10.6972">   aContentType.Assign(NS_ConvertUTF16toUTF8(contentType));</span>
<a href="#l10.6973"></a><span id="l10.6973">   return rv;</span>
<a href="#l10.6974"></a><span id="l10.6974"> }</span>
<a href="#l10.6975"></a><span id="l10.6975"> </span>
<a href="#l10.6976"></a><span id="l10.6976"> /**</span>
<a href="#l10.6977"></a><span id="l10.6977" class="difflineminus">- * decodeMsgSnippet - helper function which applies the appropriate transfer decoding</span>
<a href="#l10.6978"></a><span id="l10.6978" class="difflineminus">- *                    to the message snippet based on aEncodingType. Currently handles</span>
<a href="#l10.6979"></a><span id="l10.6979" class="difflineminus">- *                    base64 and quoted-printable. If aEncodingType refers to an encoding we don't</span>
<a href="#l10.6980"></a><span id="l10.6980" class="difflineminus">- *                    handle, the message data is passed back unmodified.</span>
<a href="#l10.6981"></a><span id="l10.6981" class="difflineminus">- * @param aEncodingType the encoding type (base64, quoted-printable)</span>
<a href="#l10.6982"></a><span id="l10.6982" class="difflineminus">- * @param aIsComplete the snippet is actually the entire message so the decoder</span>
<a href="#l10.6983"></a><span id="l10.6983" class="difflineminus">- *                           doesn't have to worry about partial data</span>
<a href="#l10.6984"></a><span id="l10.6984" class="difflineminus">- * @param aMsgSnippet in/out argument. The encoded msg snippet and then the decoded snippet</span>
<a href="#l10.6985"></a><span id="l10.6985" class="difflineplus">+ * decodeMsgSnippet - helper function which applies the appropriate transfer</span>
<a href="#l10.6986"></a><span id="l10.6986" class="difflineplus">+ * decoding to the message snippet based on aEncodingType. Currently handles</span>
<a href="#l10.6987"></a><span id="l10.6987" class="difflineplus">+ * base64 and quoted-printable. If aEncodingType refers to an encoding we</span>
<a href="#l10.6988"></a><span id="l10.6988" class="difflineplus">+ * don't handle, the message data is passed back unmodified.</span>
<a href="#l10.6989"></a><span id="l10.6989" class="difflineplus">+ * @param aEncodingType  the encoding type (base64, quoted-printable)</span>
<a href="#l10.6990"></a><span id="l10.6990" class="difflineplus">+ * @param aIsComplete    the snippet is actually the entire message so the</span>
<a href="#l10.6991"></a><span id="l10.6991" class="difflineplus">+ *                       decoder doesn't have to worry about partial data</span>
<a href="#l10.6992"></a><span id="l10.6992" class="difflineplus">+ * @param aMsgSnippet in/out argument. The encoded msg snippet and then the</span>
<a href="#l10.6993"></a><span id="l10.6993" class="difflineplus">+ *                                     decoded snippet</span>
<a href="#l10.6994"></a><span id="l10.6994">  */</span>
<a href="#l10.6995"></a><span id="l10.6995" class="difflineminus">-void nsMsgDBFolder::decodeMsgSnippet(const nsACString&amp; aEncodingType, bool aIsComplete, nsCString&amp; aMsgSnippet)</span>
<a href="#l10.6996"></a><span id="l10.6996" class="difflineminus">-{</span>
<a href="#l10.6997"></a><span id="l10.6997" class="difflineminus">-  if (MsgLowerCaseEqualsLiteral(aEncodingType, ENCODING_BASE64))</span>
<a href="#l10.6998"></a><span id="l10.6998" class="difflineminus">-  {</span>
<a href="#l10.6999"></a><span id="l10.6999" class="difflineplus">+void nsMsgDBFolder::decodeMsgSnippet(const nsACString &amp;aEncodingType,</span>
<a href="#l10.7000"></a><span id="l10.7000" class="difflineplus">+                                     bool aIsComplete, nsCString &amp;aMsgSnippet) {</span>
<a href="#l10.7001"></a><span id="l10.7001" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(aEncodingType, ENCODING_BASE64)) {</span>
<a href="#l10.7002"></a><span id="l10.7002">     int32_t base64Len = aMsgSnippet.Length();</span>
<a href="#l10.7003"></a><span id="l10.7003" class="difflineminus">-    if (aIsComplete)</span>
<a href="#l10.7004"></a><span id="l10.7004" class="difflineminus">-      base64Len -= base64Len % 4;</span>
<a href="#l10.7005"></a><span id="l10.7005" class="difflineplus">+    if (aIsComplete) base64Len -= base64Len % 4;</span>
<a href="#l10.7006"></a><span id="l10.7006">     char *decodedBody = PL_Base64Decode(aMsgSnippet.get(), base64Len, nullptr);</span>
<a href="#l10.7007"></a><span id="l10.7007" class="difflineminus">-    if (decodedBody)</span>
<a href="#l10.7008"></a><span id="l10.7008" class="difflineminus">-      aMsgSnippet.Adopt(decodedBody);</span>
<a href="#l10.7009"></a><span id="l10.7009" class="difflineminus">-  }</span>
<a href="#l10.7010"></a><span id="l10.7010" class="difflineminus">-  else if (MsgLowerCaseEqualsLiteral(aEncodingType, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l10.7011"></a><span id="l10.7011" class="difflineminus">-  {</span>
<a href="#l10.7012"></a><span id="l10.7012" class="difflineplus">+    if (decodedBody) aMsgSnippet.Adopt(decodedBody);</span>
<a href="#l10.7013"></a><span id="l10.7013" class="difflineplus">+  } else if (MsgLowerCaseEqualsLiteral(aEncodingType,</span>
<a href="#l10.7014"></a><span id="l10.7014" class="difflineplus">+                                       ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l10.7015"></a><span id="l10.7015">     MsgStripQuotedPrintable(aMsgSnippet);</span>
<a href="#l10.7016"></a><span id="l10.7016">   }</span>
<a href="#l10.7017"></a><span id="l10.7017"> }</span>
<a href="#l10.7018"></a><span id="l10.7018"> </span>
<a href="#l10.7019"></a><span id="l10.7019"> /**</span>
<a href="#l10.7020"></a><span id="l10.7020" class="difflineminus">- * stripQuotesFromMsgSnippet - Reduces quoted reply text including the citation (Scott wrote:) from</span>
<a href="#l10.7021"></a><span id="l10.7021" class="difflineminus">- *                             the message snippet to &quot; ... &quot;. Assumes the snippet has been decoded and converted to</span>
<a href="#l10.7022"></a><span id="l10.7022" class="difflineminus">- *                             plain text.</span>
<a href="#l10.7023"></a><span id="l10.7023" class="difflineplus">+ * stripQuotesFromMsgSnippet - Reduces quoted reply text including the citation</span>
<a href="#l10.7024"></a><span id="l10.7024" class="difflineplus">+ * (Scott wrote:) from the message snippet to &quot; ... &quot;. Assumes the snippet has</span>
<a href="#l10.7025"></a><span id="l10.7025" class="difflineplus">+ * been decoded and converted to plain text.</span>
<a href="#l10.7026"></a><span id="l10.7026">  * @param aMsgSnippet in/out argument. The string to strip quotes from.</span>
<a href="#l10.7027"></a><span id="l10.7027">  */</span>
<a href="#l10.7028"></a><span id="l10.7028" class="difflineminus">-void nsMsgDBFolder::compressQuotesInMsgSnippet(const nsString&amp; aMsgSnippet, nsAString&amp; aCompressedQuotes)</span>
<a href="#l10.7029"></a><span id="l10.7029" class="difflineminus">-{</span>
<a href="#l10.7030"></a><span id="l10.7030" class="difflineplus">+void nsMsgDBFolder::compressQuotesInMsgSnippet(const nsString &amp;aMsgSnippet,</span>
<a href="#l10.7031"></a><span id="l10.7031" class="difflineplus">+                                               nsAString &amp;aCompressedQuotes) {</span>
<a href="#l10.7032"></a><span id="l10.7032">   int32_t msgBodyStrLen = aMsgSnippet.Length();</span>
<a href="#l10.7033"></a><span id="l10.7033">   bool lastLineWasAQuote = false;</span>
<a href="#l10.7034"></a><span id="l10.7034">   int32_t offset = 0;</span>
<a href="#l10.7035"></a><span id="l10.7035">   int32_t lineFeedPos = 0;</span>
<a href="#l10.7036"></a><span id="l10.7036" class="difflineminus">-  while (offset &lt; msgBodyStrLen)</span>
<a href="#l10.7037"></a><span id="l10.7037" class="difflineminus">-  {</span>
<a href="#l10.7038"></a><span id="l10.7038" class="difflineplus">+  while (offset &lt; msgBodyStrLen) {</span>
<a href="#l10.7039"></a><span id="l10.7039">     lineFeedPos = aMsgSnippet.FindChar('\n', offset);</span>
<a href="#l10.7040"></a><span id="l10.7040" class="difflineminus">-    if (lineFeedPos != -1)</span>
<a href="#l10.7041"></a><span id="l10.7041" class="difflineminus">-    {</span>
<a href="#l10.7042"></a><span id="l10.7042" class="difflineminus">-      const nsAString&amp; currentLine = Substring(aMsgSnippet, offset, lineFeedPos - offset);</span>
<a href="#l10.7043"></a><span id="l10.7043" class="difflineminus">-      // this catches quoted text (&quot;&gt; &quot;), nested quotes of any level (&quot;&gt;&gt; &quot;, &quot;&gt;&gt;&gt; &quot;, ...)</span>
<a href="#l10.7044"></a><span id="l10.7044" class="difflineminus">-      // it also catches empty line quoted text (&quot;&gt;&quot;). It might be over aggressive and require</span>
<a href="#l10.7045"></a><span id="l10.7045" class="difflineminus">-      // tweaking later.</span>
<a href="#l10.7046"></a><span id="l10.7046" class="difflineminus">-      // Try to strip the citation. If the current line ends with a ':' and the next line</span>
<a href="#l10.7047"></a><span id="l10.7047" class="difflineminus">-      // looks like a quoted reply (starts with a &quot;&gt;&quot;) skip the current line</span>
<a href="#l10.7048"></a><span id="l10.7048" class="difflineplus">+    if (lineFeedPos != -1) {</span>
<a href="#l10.7049"></a><span id="l10.7049" class="difflineplus">+      const nsAString &amp;currentLine =</span>
<a href="#l10.7050"></a><span id="l10.7050" class="difflineplus">+          Substring(aMsgSnippet, offset, lineFeedPos - offset);</span>
<a href="#l10.7051"></a><span id="l10.7051" class="difflineplus">+      // this catches quoted text (&quot;&gt; &quot;), nested quotes of any level (&quot;&gt;&gt; &quot;,</span>
<a href="#l10.7052"></a><span id="l10.7052" class="difflineplus">+      // &quot;&gt;&gt;&gt; &quot;, ...) it also catches empty line quoted text (&quot;&gt;&quot;). It might be</span>
<a href="#l10.7053"></a><span id="l10.7053" class="difflineplus">+      // over aggressive and require tweaking later. Try to strip the citation.</span>
<a href="#l10.7054"></a><span id="l10.7054" class="difflineplus">+      // If the current line ends with a ':' and the next line looks like a</span>
<a href="#l10.7055"></a><span id="l10.7055" class="difflineplus">+      // quoted reply (starts with a &quot;&gt;&quot;) skip the current line</span>
<a href="#l10.7056"></a><span id="l10.7056">       if (StringBeginsWith(currentLine, NS_LITERAL_STRING(&quot;&gt;&quot;)) ||</span>
<a href="#l10.7057"></a><span id="l10.7057" class="difflineminus">-          (lineFeedPos + 1 &lt; msgBodyStrLen  &amp;&amp; lineFeedPos</span>
<a href="#l10.7058"></a><span id="l10.7058" class="difflineminus">-          &amp;&amp; aMsgSnippet[lineFeedPos - 1] == char16_t(':')</span>
<a href="#l10.7059"></a><span id="l10.7059" class="difflineminus">-          &amp;&amp; aMsgSnippet[lineFeedPos + 1] == char16_t('&gt;')))</span>
<a href="#l10.7060"></a><span id="l10.7060" class="difflineminus">-      {</span>
<a href="#l10.7061"></a><span id="l10.7061" class="difflineplus">+          (lineFeedPos + 1 &lt; msgBodyStrLen &amp;&amp; lineFeedPos &amp;&amp;</span>
<a href="#l10.7062"></a><span id="l10.7062" class="difflineplus">+           aMsgSnippet[lineFeedPos - 1] == char16_t(':') &amp;&amp;</span>
<a href="#l10.7063"></a><span id="l10.7063" class="difflineplus">+           aMsgSnippet[lineFeedPos + 1] == char16_t('&gt;'))) {</span>
<a href="#l10.7064"></a><span id="l10.7064">         lastLineWasAQuote = true;</span>
<a href="#l10.7065"></a><span id="l10.7065" class="difflineminus">-      }</span>
<a href="#l10.7066"></a><span id="l10.7066" class="difflineminus">-      else if (!currentLine.IsEmpty())</span>
<a href="#l10.7067"></a><span id="l10.7067" class="difflineminus">-      {</span>
<a href="#l10.7068"></a><span id="l10.7068" class="difflineminus">-        if (lastLineWasAQuote)</span>
<a href="#l10.7069"></a><span id="l10.7069" class="difflineminus">-        {</span>
<a href="#l10.7070"></a><span id="l10.7070" class="difflineplus">+      } else if (!currentLine.IsEmpty()) {</span>
<a href="#l10.7071"></a><span id="l10.7071" class="difflineplus">+        if (lastLineWasAQuote) {</span>
<a href="#l10.7072"></a><span id="l10.7072">           aCompressedQuotes += NS_LITERAL_STRING(&quot; ... &quot;);</span>
<a href="#l10.7073"></a><span id="l10.7073">           lastLineWasAQuote = false;</span>
<a href="#l10.7074"></a><span id="l10.7074">         }</span>
<a href="#l10.7075"></a><span id="l10.7075"> </span>
<a href="#l10.7076"></a><span id="l10.7076">         aCompressedQuotes += currentLine;</span>
<a href="#l10.7077"></a><span id="l10.7077" class="difflineminus">-        aCompressedQuotes += char16_t(' '); // don't forget to substitute a space for the line feed</span>
<a href="#l10.7078"></a><span id="l10.7078" class="difflineplus">+        // Don't forget to substitute a space for the line feed.</span>
<a href="#l10.7079"></a><span id="l10.7079" class="difflineplus">+        aCompressedQuotes += char16_t(' ');</span>
<a href="#l10.7080"></a><span id="l10.7080">       }</span>
<a href="#l10.7081"></a><span id="l10.7081"> </span>
<a href="#l10.7082"></a><span id="l10.7082">       offset = lineFeedPos + 1;</span>
<a href="#l10.7083"></a><span id="l10.7083" class="difflineminus">-    }</span>
<a href="#l10.7084"></a><span id="l10.7084" class="difflineminus">-    else</span>
<a href="#l10.7085"></a><span id="l10.7085" class="difflineminus">-    {</span>
<a href="#l10.7086"></a><span id="l10.7086" class="difflineminus">-      aCompressedQuotes.Append(Substring(aMsgSnippet, offset, msgBodyStrLen - offset));</span>
<a href="#l10.7087"></a><span id="l10.7087" class="difflineplus">+    } else {</span>
<a href="#l10.7088"></a><span id="l10.7088" class="difflineplus">+      aCompressedQuotes.Append(</span>
<a href="#l10.7089"></a><span id="l10.7089" class="difflineplus">+          Substring(aMsgSnippet, offset, msgBodyStrLen - offset));</span>
<a href="#l10.7090"></a><span id="l10.7090">       break;</span>
<a href="#l10.7091"></a><span id="l10.7091">     }</span>
<a href="#l10.7092"></a><span id="l10.7092">   }</span>
<a href="#l10.7093"></a><span id="l10.7093"> }</span>
<a href="#l10.7094"></a><span id="l10.7094"> </span>
<a href="#l10.7095"></a><span id="l10.7095"> NS_IMETHODIMP nsMsgDBFolder::ConvertMsgSnippetToPlainText(</span>
<a href="#l10.7096"></a><span id="l10.7096" class="difflineminus">-    const nsAString&amp; aMessageText, nsAString&amp; aOutText)</span>
<a href="#l10.7097"></a><span id="l10.7097" class="difflineminus">-{</span>
<a href="#l10.7098"></a><span id="l10.7098" class="difflineminus">-  uint32_t flags = nsIDocumentEncoder::OutputLFLineBreak</span>
<a href="#l10.7099"></a><span id="l10.7099" class="difflineminus">-                   | nsIDocumentEncoder::OutputNoScriptContent</span>
<a href="#l10.7100"></a><span id="l10.7100" class="difflineminus">-                   | nsIDocumentEncoder::OutputNoFramesContent</span>
<a href="#l10.7101"></a><span id="l10.7101" class="difflineminus">-                   | nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l10.7102"></a><span id="l10.7102" class="difflineminus">-  nsCOMPtr&lt;nsIParserUtils&gt; utils =</span>
<a href="#l10.7103"></a><span id="l10.7103" class="difflineminus">-    do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l10.7104"></a><span id="l10.7104" class="difflineplus">+    const nsAString &amp;aMessageText, nsAString &amp;aOutText) {</span>
<a href="#l10.7105"></a><span id="l10.7105" class="difflineplus">+  uint32_t flags = nsIDocumentEncoder::OutputLFLineBreak |</span>
<a href="#l10.7106"></a><span id="l10.7106" class="difflineplus">+                   nsIDocumentEncoder::OutputNoScriptContent |</span>
<a href="#l10.7107"></a><span id="l10.7107" class="difflineplus">+                   nsIDocumentEncoder::OutputNoFramesContent |</span>
<a href="#l10.7108"></a><span id="l10.7108" class="difflineplus">+                   nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l10.7109"></a><span id="l10.7109" class="difflineplus">+  nsCOMPtr&lt;nsIParserUtils&gt; utils = do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l10.7110"></a><span id="l10.7110">   return utils-&gt;ConvertToPlainText(aMessageText, flags, 80, aOutText);</span>
<a href="#l10.7111"></a><span id="l10.7111"> }</span>
<a href="#l10.7112"></a><span id="l10.7112"> </span>
<a href="#l10.7113"></a><span id="l10.7113" class="difflineminus">-nsresult nsMsgDBFolder::GetMsgPreviewTextFromStream(nsIMsgDBHdr *msgHdr, nsIInputStream *stream)</span>
<a href="#l10.7114"></a><span id="l10.7114" class="difflineminus">-{</span>
<a href="#l10.7115"></a><span id="l10.7115" class="difflineplus">+nsresult nsMsgDBFolder::GetMsgPreviewTextFromStream(nsIMsgDBHdr *msgHdr,</span>
<a href="#l10.7116"></a><span id="l10.7116" class="difflineplus">+                                                    nsIInputStream *stream) {</span>
<a href="#l10.7117"></a><span id="l10.7117">   nsCString msgBody;</span>
<a href="#l10.7118"></a><span id="l10.7118">   nsAutoCString charset;</span>
<a href="#l10.7119"></a><span id="l10.7119">   msgHdr-&gt;GetCharset(getter_Copies(charset));</span>
<a href="#l10.7120"></a><span id="l10.7120">   nsAutoCString contentType;</span>
<a href="#l10.7121"></a><span id="l10.7121" class="difflineminus">-  nsresult rv = GetMsgTextFromStream(stream, charset, 4096, 255, true, true, contentType, msgBody);</span>
<a href="#l10.7122"></a><span id="l10.7122" class="difflineplus">+  nsresult rv = GetMsgTextFromStream(stream, charset, 4096, 255, true, true,</span>
<a href="#l10.7123"></a><span id="l10.7123" class="difflineplus">+                                     contentType, msgBody);</span>
<a href="#l10.7124"></a><span id="l10.7124">   // replaces all tabs and line returns with a space,</span>
<a href="#l10.7125"></a><span id="l10.7125">   // then trims off leading and trailing white space</span>
<a href="#l10.7126"></a><span id="l10.7126">   MsgCompressWhitespace(msgBody);</span>
<a href="#l10.7127"></a><span id="l10.7127">   msgHdr-&gt;SetStringProperty(&quot;preview&quot;, msgBody.get());</span>
<a href="#l10.7128"></a><span id="l10.7128">   return rv;</span>
<a href="#l10.7129"></a><span id="l10.7129"> }</span>
<a href="#l10.7130"></a><span id="l10.7130"> </span>
<a href="#l10.7131"></a><span id="l10.7131" class="difflineminus">-void nsMsgDBFolder::UpdateTimestamps(bool allowUndo)</span>
<a href="#l10.7132"></a><span id="l10.7132" class="difflineminus">-{</span>
<a href="#l10.7133"></a><span id="l10.7133" class="difflineminus">-  if (!(mFlags &amp; (nsMsgFolderFlags::Trash|nsMsgFolderFlags::Junk)))</span>
<a href="#l10.7134"></a><span id="l10.7134" class="difflineminus">-  {</span>
<a href="#l10.7135"></a><span id="l10.7135" class="difflineplus">+void nsMsgDBFolder::UpdateTimestamps(bool allowUndo) {</span>
<a href="#l10.7136"></a><span id="l10.7136" class="difflineplus">+  if (!(mFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Junk))) {</span>
<a href="#l10.7137"></a><span id="l10.7137">     SetMRUTime();</span>
<a href="#l10.7138"></a><span id="l10.7138" class="difflineminus">-    if (allowUndo) // This is a proxy for a user-initiated act.</span>
<a href="#l10.7139"></a><span id="l10.7139" class="difflineplus">+    if (allowUndo)  // This is a proxy for a user-initiated act.</span>
<a href="#l10.7140"></a><span id="l10.7140">     {</span>
<a href="#l10.7141"></a><span id="l10.7141">       bool isArchive;</span>
<a href="#l10.7142"></a><span id="l10.7142">       IsSpecialFolder(nsMsgFolderFlags::Archive, true, &amp;isArchive);</span>
<a href="#l10.7143"></a><span id="l10.7143" class="difflineminus">-      if (!isArchive)</span>
<a href="#l10.7144"></a><span id="l10.7144" class="difflineminus">-      {</span>
<a href="#l10.7145"></a><span id="l10.7145" class="difflineplus">+      if (!isArchive) {</span>
<a href="#l10.7146"></a><span id="l10.7146">         SetMRMTime();</span>
<a href="#l10.7147"></a><span id="l10.7147">         NotifyFolderEvent(kMRMTimeChanged);</span>
<a href="#l10.7148"></a><span id="l10.7148">       }</span>
<a href="#l10.7149"></a><span id="l10.7149">     }</span>
<a href="#l10.7150"></a><span id="l10.7150">   }</span>
<a href="#l10.7151"></a><span id="l10.7151"> }</span>
<a href="#l10.7152"></a><span id="l10.7152"> </span>
<a href="#l10.7153"></a><span id="l10.7153" class="difflineminus">-void nsMsgDBFolder::SetMRUTime()</span>
<a href="#l10.7154"></a><span id="l10.7154" class="difflineminus">-{</span>
<a href="#l10.7155"></a><span id="l10.7155" class="difflineplus">+void nsMsgDBFolder::SetMRUTime() {</span>
<a href="#l10.7156"></a><span id="l10.7156">   uint32_t seconds;</span>
<a href="#l10.7157"></a><span id="l10.7157">   PRTime2Seconds(PR_Now(), &amp;seconds);</span>
<a href="#l10.7158"></a><span id="l10.7158">   nsAutoCString nowStr;</span>
<a href="#l10.7159"></a><span id="l10.7159">   nowStr.AppendInt(seconds);</span>
<a href="#l10.7160"></a><span id="l10.7160">   SetStringProperty(MRU_TIME_PROPERTY, nowStr);</span>
<a href="#l10.7161"></a><span id="l10.7161"> }</span>
<a href="#l10.7162"></a><span id="l10.7162"> </span>
<a href="#l10.7163"></a><span id="l10.7163" class="difflineminus">-void nsMsgDBFolder::SetMRMTime()</span>
<a href="#l10.7164"></a><span id="l10.7164" class="difflineminus">-{</span>
<a href="#l10.7165"></a><span id="l10.7165" class="difflineplus">+void nsMsgDBFolder::SetMRMTime() {</span>
<a href="#l10.7166"></a><span id="l10.7166">   uint32_t seconds;</span>
<a href="#l10.7167"></a><span id="l10.7167">   PRTime2Seconds(PR_Now(), &amp;seconds);</span>
<a href="#l10.7168"></a><span id="l10.7168">   nsAutoCString nowStr;</span>
<a href="#l10.7169"></a><span id="l10.7169">   nowStr.AppendInt(seconds);</span>
<a href="#l10.7170"></a><span id="l10.7170">   SetStringProperty(MRM_TIME_PROPERTY, nowStr);</span>
<a href="#l10.7171"></a><span id="l10.7171"> }</span>
<a href="#l10.7172"></a><span id="l10.7172"> </span>
<a href="#l10.7173"></a><span id="l10.7173" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l10.7174"></a><span id="l10.7174" class="difflineminus">-{</span>
<a href="#l10.7175"></a><span id="l10.7175" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AddKeywordsToMessages(</span>
<a href="#l10.7176"></a><span id="l10.7176" class="difflineplus">+    nsIArray *aMessages, const nsACString &amp;aKeywords) {</span>
<a href="#l10.7177"></a><span id="l10.7177">   NS_ENSURE_ARG(aMessages);</span>
<a href="#l10.7178"></a><span id="l10.7178">   nsresult rv = NS_OK;</span>
<a href="#l10.7179"></a><span id="l10.7179">   GetDatabase();</span>
<a href="#l10.7180"></a><span id="l10.7180" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.7181"></a><span id="l10.7181" class="difflineminus">-  {</span>
<a href="#l10.7182"></a><span id="l10.7182" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.7183"></a><span id="l10.7183">     uint32_t count;</span>
<a href="#l10.7184"></a><span id="l10.7184">     nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l10.7185"></a><span id="l10.7185">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.7186"></a><span id="l10.7186">     nsCString keywords;</span>
<a href="#l10.7187"></a><span id="l10.7187"> </span>
<a href="#l10.7188"></a><span id="l10.7188" class="difflineminus">-    for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.7189"></a><span id="l10.7189" class="difflineminus">-    {</span>
<a href="#l10.7190"></a><span id="l10.7190" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.7191"></a><span id="l10.7191">       nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l10.7192"></a><span id="l10.7192">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.7193"></a><span id="l10.7193"> </span>
<a href="#l10.7194"></a><span id="l10.7194">       message-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l10.7195"></a><span id="l10.7195">       nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l10.7196"></a><span id="l10.7196">       ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l10.7197"></a><span id="l10.7197">       uint32_t addCount = 0;</span>
<a href="#l10.7198"></a><span id="l10.7198" class="difflineminus">-      for (uint32_t j = 0; j &lt; keywordArray.Length(); j++)</span>
<a href="#l10.7199"></a><span id="l10.7199" class="difflineminus">-      {</span>
<a href="#l10.7200"></a><span id="l10.7200" class="difflineplus">+      for (uint32_t j = 0; j &lt; keywordArray.Length(); j++) {</span>
<a href="#l10.7201"></a><span id="l10.7201">         int32_t start, length;</span>
<a href="#l10.7202"></a><span id="l10.7202" class="difflineminus">-        if (!MsgFindKeyword(keywordArray[j], keywords, &amp;start, &amp;length))</span>
<a href="#l10.7203"></a><span id="l10.7203" class="difflineminus">-        {</span>
<a href="#l10.7204"></a><span id="l10.7204" class="difflineminus">-          if (!keywords.IsEmpty())</span>
<a href="#l10.7205"></a><span id="l10.7205" class="difflineminus">-            keywords.Append(' ');</span>
<a href="#l10.7206"></a><span id="l10.7206" class="difflineplus">+        if (!MsgFindKeyword(keywordArray[j], keywords, &amp;start, &amp;length)) {</span>
<a href="#l10.7207"></a><span id="l10.7207" class="difflineplus">+          if (!keywords.IsEmpty()) keywords.Append(' ');</span>
<a href="#l10.7208"></a><span id="l10.7208">           keywords.Append(keywordArray[j]);</span>
<a href="#l10.7209"></a><span id="l10.7209">           addCount++;</span>
<a href="#l10.7210"></a><span id="l10.7210">         }</span>
<a href="#l10.7211"></a><span id="l10.7211">       }</span>
<a href="#l10.7212"></a><span id="l10.7212">       // avoid using the message key to set the string property, because</span>
<a href="#l10.7213"></a><span id="l10.7213">       // in the case of filters running on incoming pop3 mail with quarantining</span>
<a href="#l10.7214"></a><span id="l10.7214">       // turned on, the message key is wrong.</span>
<a href="#l10.7215"></a><span id="l10.7215">       mDatabase-&gt;SetStringPropertyByHdr(message, &quot;keywords&quot;, keywords.get());</span>
<a href="#l10.7216"></a><span id="l10.7216"> </span>
<a href="#l10.7217"></a><span id="l10.7217" class="difflineminus">-      if (addCount)</span>
<a href="#l10.7218"></a><span id="l10.7218" class="difflineminus">-        NotifyPropertyFlagChanged(message, kKeywords, 0, addCount);</span>
<a href="#l10.7219"></a><span id="l10.7219" class="difflineplus">+      if (addCount) NotifyPropertyFlagChanged(message, kKeywords, 0, addCount);</span>
<a href="#l10.7220"></a><span id="l10.7220">     }</span>
<a href="#l10.7221"></a><span id="l10.7221">   }</span>
<a href="#l10.7222"></a><span id="l10.7222">   return rv;</span>
<a href="#l10.7223"></a><span id="l10.7223"> }</span>
<a href="#l10.7224"></a><span id="l10.7224"> </span>
<a href="#l10.7225"></a><span id="l10.7225" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::RemoveKeywordsFromMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l10.7226"></a><span id="l10.7226" class="difflineminus">-{</span>
<a href="#l10.7227"></a><span id="l10.7227" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::RemoveKeywordsFromMessages(</span>
<a href="#l10.7228"></a><span id="l10.7228" class="difflineplus">+    nsIArray *aMessages, const nsACString &amp;aKeywords) {</span>
<a href="#l10.7229"></a><span id="l10.7229">   NS_ENSURE_ARG(aMessages);</span>
<a href="#l10.7230"></a><span id="l10.7230">   nsresult rv = NS_OK;</span>
<a href="#l10.7231"></a><span id="l10.7231">   GetDatabase();</span>
<a href="#l10.7232"></a><span id="l10.7232" class="difflineminus">-  if (mDatabase)</span>
<a href="#l10.7233"></a><span id="l10.7233" class="difflineminus">-  {</span>
<a href="#l10.7234"></a><span id="l10.7234" class="difflineplus">+  if (mDatabase) {</span>
<a href="#l10.7235"></a><span id="l10.7235">     uint32_t count;</span>
<a href="#l10.7236"></a><span id="l10.7236">     nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l10.7237"></a><span id="l10.7237">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.7238"></a><span id="l10.7238">     nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l10.7239"></a><span id="l10.7239">     ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l10.7240"></a><span id="l10.7240">     nsCString keywords;</span>
<a href="#l10.7241"></a><span id="l10.7241">     // If the tag is also a label, we should remove the label too...</span>
<a href="#l10.7242"></a><span id="l10.7242"> </span>
<a href="#l10.7243"></a><span id="l10.7243" class="difflineminus">-    for(uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l10.7244"></a><span id="l10.7244" class="difflineminus">-    {</span>
<a href="#l10.7245"></a><span id="l10.7245" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l10.7246"></a><span id="l10.7246">       nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l10.7247"></a><span id="l10.7247">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.7248"></a><span id="l10.7248">       rv = message-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l10.7249"></a><span id="l10.7249">       uint32_t removeCount = 0;</span>
<a href="#l10.7250"></a><span id="l10.7250" class="difflineminus">-      for (uint32_t j = 0; j &lt; keywordArray.Length(); j++)</span>
<a href="#l10.7251"></a><span id="l10.7251" class="difflineminus">-      {</span>
<a href="#l10.7252"></a><span id="l10.7252" class="difflineminus">-        bool keywordIsLabel = (StringBeginsWith(keywordArray[j], NS_LITERAL_CSTRING(&quot;$label&quot;))</span>
<a href="#l10.7253"></a><span id="l10.7253" class="difflineminus">-          &amp;&amp; keywordArray[j].CharAt(6) &gt;= '1' &amp;&amp; keywordArray[j].CharAt(6) &lt;= '5');</span>
<a href="#l10.7254"></a><span id="l10.7254" class="difflineminus">-        if (keywordIsLabel)</span>
<a href="#l10.7255"></a><span id="l10.7255" class="difflineminus">-        {</span>
<a href="#l10.7256"></a><span id="l10.7256" class="difflineplus">+      for (uint32_t j = 0; j &lt; keywordArray.Length(); j++) {</span>
<a href="#l10.7257"></a><span id="l10.7257" class="difflineplus">+        bool keywordIsLabel =</span>
<a href="#l10.7258"></a><span id="l10.7258" class="difflineplus">+            (StringBeginsWith(keywordArray[j], NS_LITERAL_CSTRING(&quot;$label&quot;)) &amp;&amp;</span>
<a href="#l10.7259"></a><span id="l10.7259" class="difflineplus">+             keywordArray[j].CharAt(6) &gt;= '1' &amp;&amp;</span>
<a href="#l10.7260"></a><span id="l10.7260" class="difflineplus">+             keywordArray[j].CharAt(6) &lt;= '5');</span>
<a href="#l10.7261"></a><span id="l10.7261" class="difflineplus">+        if (keywordIsLabel) {</span>
<a href="#l10.7262"></a><span id="l10.7262">           nsMsgLabelValue labelValue;</span>
<a href="#l10.7263"></a><span id="l10.7263">           message-&gt;GetLabel(&amp;labelValue);</span>
<a href="#l10.7264"></a><span id="l10.7264">           // if we're removing the keyword that corresponds to a pre 2.0 label,</span>
<a href="#l10.7265"></a><span id="l10.7265">           // we need to clear the old label attribute on the message.</span>
<a href="#l10.7266"></a><span id="l10.7266" class="difflineminus">-          if (labelValue == (nsMsgLabelValue) (keywordArray[j].CharAt(6) - '0'))</span>
<a href="#l10.7267"></a><span id="l10.7267" class="difflineminus">-            message-&gt;SetLabel((nsMsgLabelValue) 0);</span>
<a href="#l10.7268"></a><span id="l10.7268" class="difflineplus">+          if (labelValue == (nsMsgLabelValue)(keywordArray[j].CharAt(6) - '0'))</span>
<a href="#l10.7269"></a><span id="l10.7269" class="difflineplus">+            message-&gt;SetLabel((nsMsgLabelValue)0);</span>
<a href="#l10.7270"></a><span id="l10.7270">         }</span>
<a href="#l10.7271"></a><span id="l10.7271">         int32_t startOffset, length;</span>
<a href="#l10.7272"></a><span id="l10.7272" class="difflineminus">-        if (MsgFindKeyword(keywordArray[j], keywords, &amp;startOffset, &amp;length))</span>
<a href="#l10.7273"></a><span id="l10.7273" class="difflineminus">-        {</span>
<a href="#l10.7274"></a><span id="l10.7274" class="difflineplus">+        if (MsgFindKeyword(keywordArray[j], keywords, &amp;startOffset, &amp;length)) {</span>
<a href="#l10.7275"></a><span id="l10.7275">           // delete any leading space delimiters</span>
<a href="#l10.7276"></a><span id="l10.7276" class="difflineminus">-          while (startOffset &amp;&amp; keywords.CharAt(startOffset - 1) == ' ')</span>
<a href="#l10.7277"></a><span id="l10.7277" class="difflineminus">-          {</span>
<a href="#l10.7278"></a><span id="l10.7278" class="difflineplus">+          while (startOffset &amp;&amp; keywords.CharAt(startOffset - 1) == ' ') {</span>
<a href="#l10.7279"></a><span id="l10.7279">             startOffset--;</span>
<a href="#l10.7280"></a><span id="l10.7280">             length++;</span>
<a href="#l10.7281"></a><span id="l10.7281">           }</span>
<a href="#l10.7282"></a><span id="l10.7282">           // but if the keyword is at the start then delete the following space</span>
<a href="#l10.7283"></a><span id="l10.7283" class="difflineminus">-          if (!startOffset &amp;&amp; length &lt; static_cast&lt;int32_t&gt;(keywords.Length()) &amp;&amp;</span>
<a href="#l10.7284"></a><span id="l10.7284" class="difflineplus">+          if (!startOffset &amp;&amp;</span>
<a href="#l10.7285"></a><span id="l10.7285" class="difflineplus">+              length &lt; static_cast&lt;int32_t&gt;(keywords.Length()) &amp;&amp;</span>
<a href="#l10.7286"></a><span id="l10.7286">               keywords.CharAt(length) == ' ')</span>
<a href="#l10.7287"></a><span id="l10.7287">             length++;</span>
<a href="#l10.7288"></a><span id="l10.7288">           keywords.Cut(startOffset, length);</span>
<a href="#l10.7289"></a><span id="l10.7289">           removeCount++;</span>
<a href="#l10.7290"></a><span id="l10.7290">         }</span>
<a href="#l10.7291"></a><span id="l10.7291">       }</span>
<a href="#l10.7292"></a><span id="l10.7292"> </span>
<a href="#l10.7293"></a><span id="l10.7293" class="difflineminus">-      if (removeCount)</span>
<a href="#l10.7294"></a><span id="l10.7294" class="difflineminus">-      {</span>
<a href="#l10.7295"></a><span id="l10.7295" class="difflineplus">+      if (removeCount) {</span>
<a href="#l10.7296"></a><span id="l10.7296">         mDatabase-&gt;SetStringPropertyByHdr(message, &quot;keywords&quot;, keywords.get());</span>
<a href="#l10.7297"></a><span id="l10.7297">         NotifyPropertyFlagChanged(message, kKeywords, removeCount, 0);</span>
<a href="#l10.7298"></a><span id="l10.7298">       }</span>
<a href="#l10.7299"></a><span id="l10.7299">     }</span>
<a href="#l10.7300"></a><span id="l10.7300">   }</span>
<a href="#l10.7301"></a><span id="l10.7301">   return rv;</span>
<a href="#l10.7302"></a><span id="l10.7302"> }</span>
<a href="#l10.7303"></a><span id="l10.7303"> </span>
<a href="#l10.7304"></a><span id="l10.7304" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetCustomIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l10.7305"></a><span id="l10.7305" class="difflineminus">-{</span>
<a href="#l10.7306"></a><span id="l10.7306" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetCustomIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l10.7307"></a><span id="l10.7307">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l10.7308"></a><span id="l10.7308">   *aIdentity = nullptr;</span>
<a href="#l10.7309"></a><span id="l10.7309">   return NS_OK;</span>
<a href="#l10.7310"></a><span id="l10.7310"> }</span>
<a href="#l10.7311"></a><span id="l10.7311"> </span>
<a href="#l10.7312"></a><span id="l10.7312" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetProcessingFlags(nsMsgKey aKey, uint32_t *aFlags)</span>
<a href="#l10.7313"></a><span id="l10.7313" class="difflineminus">-{</span>
<a href="#l10.7314"></a><span id="l10.7314" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetProcessingFlags(nsMsgKey aKey,</span>
<a href="#l10.7315"></a><span id="l10.7315" class="difflineplus">+                                                uint32_t *aFlags) {</span>
<a href="#l10.7316"></a><span id="l10.7316">   NS_ENSURE_ARG_POINTER(aFlags);</span>
<a href="#l10.7317"></a><span id="l10.7317">   *aFlags = 0;</span>
<a href="#l10.7318"></a><span id="l10.7318">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l10.7319"></a><span id="l10.7319">     if (mProcessingFlag[i].keys &amp;&amp; mProcessingFlag[i].keys-&gt;IsMember(aKey))</span>
<a href="#l10.7320"></a><span id="l10.7320">       *aFlags |= mProcessingFlag[i].bit;</span>
<a href="#l10.7321"></a><span id="l10.7321">   return NS_OK;</span>
<a href="#l10.7322"></a><span id="l10.7322"> }</span>
<a href="#l10.7323"></a><span id="l10.7323"> </span>
<a href="#l10.7324"></a><span id="l10.7324" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::OrProcessingFlags(nsMsgKey aKey, uint32_t mask)</span>
<a href="#l10.7325"></a><span id="l10.7325" class="difflineminus">-{</span>
<a href="#l10.7326"></a><span id="l10.7326" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OrProcessingFlags(nsMsgKey aKey, uint32_t mask) {</span>
<a href="#l10.7327"></a><span id="l10.7327">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l10.7328"></a><span id="l10.7328">     if (mProcessingFlag[i].bit &amp; mask &amp;&amp; mProcessingFlag[i].keys)</span>
<a href="#l10.7329"></a><span id="l10.7329">       mProcessingFlag[i].keys-&gt;Add(aKey);</span>
<a href="#l10.7330"></a><span id="l10.7330">   return NS_OK;</span>
<a href="#l10.7331"></a><span id="l10.7331"> }</span>
<a href="#l10.7332"></a><span id="l10.7332"> </span>
<a href="#l10.7333"></a><span id="l10.7333" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::AndProcessingFlags(nsMsgKey aKey, uint32_t mask)</span>
<a href="#l10.7334"></a><span id="l10.7334" class="difflineminus">-{</span>
<a href="#l10.7335"></a><span id="l10.7335" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AndProcessingFlags(nsMsgKey aKey, uint32_t mask) {</span>
<a href="#l10.7336"></a><span id="l10.7336">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l10.7337"></a><span id="l10.7337">     if (!(mProcessingFlag[i].bit &amp; mask) &amp;&amp; mProcessingFlag[i].keys)</span>
<a href="#l10.7338"></a><span id="l10.7338">       mProcessingFlag[i].keys-&gt;Remove(aKey);</span>
<a href="#l10.7339"></a><span id="l10.7339">   return NS_OK;</span>
<a href="#l10.7340"></a><span id="l10.7340"> }</span>
<a href="#l10.7341"></a><span id="l10.7341"> </span>
<a href="#l10.7342"></a><span id="l10.7342"> // Each implementation must provide an override of this, connecting the folder</span>
<a href="#l10.7343"></a><span id="l10.7343"> // type to the corresponding incoming server type.</span>
<a href="#l10.7344"></a><span id="l10.7344" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetIncomingServerType(nsACString&amp; aIncomingServerType)</span>
<a href="#l10.7345"></a><span id="l10.7345" class="difflineminus">-{</span>
<a href="#l10.7346"></a><span id="l10.7346" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetIncomingServerType(</span>
<a href="#l10.7347"></a><span id="l10.7347" class="difflineplus">+    nsACString &amp;aIncomingServerType) {</span>
<a href="#l10.7348"></a><span id="l10.7348">   NS_ASSERTION(false, &quot;subclasses need to override this&quot;);</span>
<a href="#l10.7349"></a><span id="l10.7349">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.7350"></a><span id="l10.7350"> }</span>
<a href="#l10.7351"></a><span id="l10.7351"> </span>
<a href="#l10.7352"></a><span id="l10.7352" class="difflineminus">-void nsMsgDBFolder::ClearProcessingFlags()</span>
<a href="#l10.7353"></a><span id="l10.7353" class="difflineminus">-{</span>
<a href="#l10.7354"></a><span id="l10.7354" class="difflineminus">-  for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l10.7355"></a><span id="l10.7355" class="difflineminus">-  {</span>
<a href="#l10.7356"></a><span id="l10.7356" class="difflineplus">+void nsMsgDBFolder::ClearProcessingFlags() {</span>
<a href="#l10.7357"></a><span id="l10.7357" class="difflineplus">+  for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++) {</span>
<a href="#l10.7358"></a><span id="l10.7358">     // There is no clear method so we need to delete and re-create.</span>
<a href="#l10.7359"></a><span id="l10.7359">     delete mProcessingFlag[i].keys;</span>
<a href="#l10.7360"></a><span id="l10.7360">     mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l10.7361"></a><span id="l10.7361">   }</span>
<a href="#l10.7362"></a><span id="l10.7362"> }</span>
<a href="#l10.7363"></a><span id="l10.7363"> </span>
<a href="#l10.7364"></a><span id="l10.7364"> nsresult nsMsgDBFolder::MessagesInKeyOrder(nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray,</span>
<a href="#l10.7365"></a><span id="l10.7365" class="difflineminus">-  nsIMsgFolder *srcFolder, nsIMutableArray* messages)</span>
<a href="#l10.7366"></a><span id="l10.7366" class="difflineminus">-{</span>
<a href="#l10.7367"></a><span id="l10.7367" class="difflineplus">+                                           nsIMsgFolder *srcFolder,</span>
<a href="#l10.7368"></a><span id="l10.7368" class="difflineplus">+                                           nsIMutableArray *messages) {</span>
<a href="#l10.7369"></a><span id="l10.7369">   // XXX: the output messages - should really be and nsCOMArray&lt;nsIMsgDBHdr&gt;</span>
<a href="#l10.7370"></a><span id="l10.7370"> </span>
<a href="#l10.7371"></a><span id="l10.7371">   nsresult rv = NS_OK;</span>
<a href="#l10.7372"></a><span id="l10.7372">   uint32_t numMessages = aKeyArray.Length();</span>
<a href="#l10.7373"></a><span id="l10.7373"> </span>
<a href="#l10.7374"></a><span id="l10.7374">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.7375"></a><span id="l10.7375">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l10.7376"></a><span id="l10.7376">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l10.7377"></a><span id="l10.7377" class="difflineminus">-  rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l10.7378"></a><span id="l10.7378" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l10.7379"></a><span id="l10.7379" class="difflineminus">-  {</span>
<a href="#l10.7380"></a><span id="l10.7380" class="difflineminus">-    for (uint32_t i = 0; i &lt; numMessages; i++)</span>
<a href="#l10.7381"></a><span id="l10.7381" class="difflineminus">-    {</span>
<a href="#l10.7382"></a><span id="l10.7382" class="difflineplus">+  rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l10.7383"></a><span id="l10.7383" class="difflineplus">+                                       getter_AddRefs(db));</span>
<a href="#l10.7384"></a><span id="l10.7384" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l10.7385"></a><span id="l10.7385" class="difflineplus">+    for (uint32_t i = 0; i &lt; numMessages; i++) {</span>
<a href="#l10.7386"></a><span id="l10.7386">       rv = db-&gt;GetMsgHdrForKey(aKeyArray[i], getter_AddRefs(msgHdr));</span>
<a href="#l10.7387"></a><span id="l10.7387" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.7388"></a><span id="l10.7388" class="difflineminus">-      if (msgHdr)</span>
<a href="#l10.7389"></a><span id="l10.7389" class="difflineminus">-        messages-&gt;AppendElement(msgHdr);</span>
<a href="#l10.7390"></a><span id="l10.7390" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.7391"></a><span id="l10.7391" class="difflineplus">+      if (msgHdr) messages-&gt;AppendElement(msgHdr);</span>
<a href="#l10.7392"></a><span id="l10.7392">     }</span>
<a href="#l10.7393"></a><span id="l10.7393">   }</span>
<a href="#l10.7394"></a><span id="l10.7394">   return rv;</span>
<a href="#l10.7395"></a><span id="l10.7395"> }</span>
<a href="#l10.7396"></a><span id="l10.7396"> </span>
<a href="#l10.7397"></a><span id="l10.7397" class="difflineminus">-/* static */ nsMsgKeySetU* nsMsgKeySetU::Create()</span>
<a href="#l10.7398"></a><span id="l10.7398" class="difflineminus">-{</span>
<a href="#l10.7399"></a><span id="l10.7399" class="difflineminus">-  nsMsgKeySetU* set = new nsMsgKeySetU;</span>
<a href="#l10.7400"></a><span id="l10.7400" class="difflineminus">-  if (set)</span>
<a href="#l10.7401"></a><span id="l10.7401" class="difflineminus">-  {</span>
<a href="#l10.7402"></a><span id="l10.7402" class="difflineplus">+/* static */ nsMsgKeySetU *nsMsgKeySetU::Create() {</span>
<a href="#l10.7403"></a><span id="l10.7403" class="difflineplus">+  nsMsgKeySetU *set = new nsMsgKeySetU;</span>
<a href="#l10.7404"></a><span id="l10.7404" class="difflineplus">+  if (set) {</span>
<a href="#l10.7405"></a><span id="l10.7405">     set-&gt;loKeySet = nsMsgKeySet::Create();</span>
<a href="#l10.7406"></a><span id="l10.7406">     set-&gt;hiKeySet = nsMsgKeySet::Create();</span>
<a href="#l10.7407"></a><span id="l10.7407" class="difflineminus">-    if (!(set-&gt;loKeySet &amp;&amp; set-&gt;hiKeySet))</span>
<a href="#l10.7408"></a><span id="l10.7408" class="difflineminus">-    {</span>
<a href="#l10.7409"></a><span id="l10.7409" class="difflineplus">+    if (!(set-&gt;loKeySet &amp;&amp; set-&gt;hiKeySet)) {</span>
<a href="#l10.7410"></a><span id="l10.7410">       delete set;</span>
<a href="#l10.7411"></a><span id="l10.7411">       set = nullptr;</span>
<a href="#l10.7412"></a><span id="l10.7412">     }</span>
<a href="#l10.7413"></a><span id="l10.7413">   }</span>
<a href="#l10.7414"></a><span id="l10.7414">   return set;</span>
<a href="#l10.7415"></a><span id="l10.7415"> }</span>
<a href="#l10.7416"></a><span id="l10.7416"> </span>
<a href="#l10.7417"></a><span id="l10.7417" class="difflineminus">-nsMsgKeySetU::nsMsgKeySetU()</span>
<a href="#l10.7418"></a><span id="l10.7418" class="difflineminus">-{ }</span>
<a href="#l10.7419"></a><span id="l10.7419" class="difflineminus">-</span>
<a href="#l10.7420"></a><span id="l10.7420" class="difflineminus">-nsMsgKeySetU::~nsMsgKeySetU()</span>
<a href="#l10.7421"></a><span id="l10.7421" class="difflineminus">-{</span>
<a href="#l10.7422"></a><span id="l10.7422" class="difflineplus">+nsMsgKeySetU::nsMsgKeySetU() {}</span>
<a href="#l10.7423"></a><span id="l10.7423" class="difflineplus">+</span>
<a href="#l10.7424"></a><span id="l10.7424" class="difflineplus">+nsMsgKeySetU::~nsMsgKeySetU() {</span>
<a href="#l10.7425"></a><span id="l10.7425">   delete loKeySet;</span>
<a href="#l10.7426"></a><span id="l10.7426">   delete hiKeySet;</span>
<a href="#l10.7427"></a><span id="l10.7427"> }</span>
<a href="#l10.7428"></a><span id="l10.7428"> </span>
<a href="#l10.7429"></a><span id="l10.7429"> const uint32_t kLowerBits = 0x7fffffff;</span>
<a href="#l10.7430"></a><span id="l10.7430"> </span>
<a href="#l10.7431"></a><span id="l10.7431" class="difflineminus">-int nsMsgKeySetU::Add(nsMsgKey aKey)</span>
<a href="#l10.7432"></a><span id="l10.7432" class="difflineminus">-{</span>
<a href="#l10.7433"></a><span id="l10.7433" class="difflineplus">+int nsMsgKeySetU::Add(nsMsgKey aKey) {</span>
<a href="#l10.7434"></a><span id="l10.7434">   int32_t intKey = static_cast&lt;int32_t&gt;(aKey);</span>
<a href="#l10.7435"></a><span id="l10.7435" class="difflineminus">-  if (intKey &gt;= 0)</span>
<a href="#l10.7436"></a><span id="l10.7436" class="difflineminus">-    return loKeySet-&gt;Add(intKey);</span>
<a href="#l10.7437"></a><span id="l10.7437" class="difflineplus">+  if (intKey &gt;= 0) return loKeySet-&gt;Add(intKey);</span>
<a href="#l10.7438"></a><span id="l10.7438">   return hiKeySet-&gt;Add(intKey &amp; kLowerBits);</span>
<a href="#l10.7439"></a><span id="l10.7439"> }</span>
<a href="#l10.7440"></a><span id="l10.7440"> </span>
<a href="#l10.7441"></a><span id="l10.7441" class="difflineminus">-int nsMsgKeySetU::Remove(nsMsgKey aKey)</span>
<a href="#l10.7442"></a><span id="l10.7442" class="difflineminus">-{</span>
<a href="#l10.7443"></a><span id="l10.7443" class="difflineplus">+int nsMsgKeySetU::Remove(nsMsgKey aKey) {</span>
<a href="#l10.7444"></a><span id="l10.7444">   int32_t intKey = static_cast&lt;int32_t&gt;(aKey);</span>
<a href="#l10.7445"></a><span id="l10.7445" class="difflineminus">-  if (intKey &gt;= 0)</span>
<a href="#l10.7446"></a><span id="l10.7446" class="difflineminus">-    return loKeySet-&gt;Remove(intKey);</span>
<a href="#l10.7447"></a><span id="l10.7447" class="difflineplus">+  if (intKey &gt;= 0) return loKeySet-&gt;Remove(intKey);</span>
<a href="#l10.7448"></a><span id="l10.7448">   return hiKeySet-&gt;Remove(intKey &amp; kLowerBits);</span>
<a href="#l10.7449"></a><span id="l10.7449"> }</span>
<a href="#l10.7450"></a><span id="l10.7450"> </span>
<a href="#l10.7451"></a><span id="l10.7451" class="difflineminus">-bool nsMsgKeySetU::IsMember(nsMsgKey aKey)</span>
<a href="#l10.7452"></a><span id="l10.7452" class="difflineminus">-{</span>
<a href="#l10.7453"></a><span id="l10.7453" class="difflineplus">+bool nsMsgKeySetU::IsMember(nsMsgKey aKey) {</span>
<a href="#l10.7454"></a><span id="l10.7454">   int32_t intKey = static_cast&lt;int32_t&gt;(aKey);</span>
<a href="#l10.7455"></a><span id="l10.7455" class="difflineminus">-  if (intKey &gt;= 0)</span>
<a href="#l10.7456"></a><span id="l10.7456" class="difflineminus">-    return loKeySet-&gt;IsMember(intKey);</span>
<a href="#l10.7457"></a><span id="l10.7457" class="difflineplus">+  if (intKey &gt;= 0) return loKeySet-&gt;IsMember(intKey);</span>
<a href="#l10.7458"></a><span id="l10.7458">   return hiKeySet-&gt;IsMember(intKey &amp; kLowerBits);</span>
<a href="#l10.7459"></a><span id="l10.7459"> }</span>
<a href="#l10.7460"></a><span id="l10.7460"> </span>
<a href="#l10.7461"></a><span id="l10.7461" class="difflineminus">-nsresult nsMsgKeySetU::ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt; &amp;aArray)</span>
<a href="#l10.7462"></a><span id="l10.7462" class="difflineminus">-{</span>
<a href="#l10.7463"></a><span id="l10.7463" class="difflineplus">+nsresult nsMsgKeySetU::ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt; &amp;aArray) {</span>
<a href="#l10.7464"></a><span id="l10.7464">   nsresult rv = loKeySet-&gt;ToMsgKeyArray(aArray);</span>
<a href="#l10.7465"></a><span id="l10.7465">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.7466"></a><span id="l10.7466">   return hiKeySet-&gt;ToMsgKeyArray(aArray);</span>
<a href="#l10.7467"></a><span id="l10.7467"> }</span>
<a href="#l10.7468"></a><span id="l10.7468" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -67,167 +67,188 @@ extern const nsLiteralCString kFolderCre</span>
<a href="#l11.4"></a><span id="l11.4"> extern const nsLiteralCString kFolderLoaded;</span>
<a href="#l11.5"></a><span id="l11.5"> extern const nsLiteralCString kNumNewBiffMessages;</span>
<a href="#l11.6"></a><span id="l11.6"> extern const nsLiteralCString kRenameCompleted;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> class nsIMsgFolderCacheElement;</span>
<a href="#l11.9"></a><span id="l11.9"> class nsICollation;</span>
<a href="#l11.10"></a><span id="l11.10"> class nsMsgKeySetU;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- /*</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  * nsMsgDBFolder</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  * class derived from nsMsgFolder for those folders that use an nsIMsgDatabase</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  */</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+/*</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ * nsMsgDBFolder</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * class derived from nsMsgFolder for those folders that use an nsIMsgDatabase</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ */</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-class NS_MSG_BASE nsMsgDBFolder: public nsRDFResource,</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-                                 public nsSupportsWeakReference,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-                                 public nsIMsgFolder,</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-                                 public nsIDBChangeListener,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-                                 public nsIUrlListener,</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-                                 public nsIJunkMailClassificationListener,</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-                                 public nsIMsgTraitClassificationListener</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-{</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-public:</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+class NS_MSG_BASE nsMsgDBFolder : public nsRDFResource,</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+                                  public nsSupportsWeakReference,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+                                  public nsIMsgFolder,</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+                                  public nsIDBChangeListener,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+                                  public nsIUrlListener,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+                                  public nsIJunkMailClassificationListener,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+                                  public nsIMsgTraitClassificationListener {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ public:</span>
<a href="#l11.38"></a><span id="l11.38">   nsMsgDBFolder(void);</span>
<a href="#l11.39"></a><span id="l11.39">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l11.40"></a><span id="l11.40">   NS_DECL_NSIMSGFOLDER</span>
<a href="#l11.41"></a><span id="l11.41">   NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l11.42"></a><span id="l11.42">   NS_DECL_NSIURLLISTENER</span>
<a href="#l11.43"></a><span id="l11.43">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l11.44"></a><span id="l11.44">   NS_DECL_NSIMSGTRAITCLASSIFICATIONLISTENER</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   NS_IMETHOD WriteToFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l11.47"></a><span id="l11.47">   NS_IMETHOD ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">   // nsRDFResource overrides</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  NS_IMETHOD Init(const char* aURI) override;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  NS_IMETHOD Init(const char *aURI) override;</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">   nsresult CreateDirectoryForFolder(nsIFile **result);</span>
<a href="#l11.54"></a><span id="l11.54">   nsresult CreateBackupDirectory(nsIFile **result);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  nsresult GetBackupSummaryFile(nsIFile **result, const nsACString&amp; newName);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  nsresult GetMsgPreviewTextFromStream(nsIMsgDBHdr *msgHdr, nsIInputStream *stream);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  nsresult GetBackupSummaryFile(nsIFile **result, const nsACString &amp;newName);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  nsresult GetMsgPreviewTextFromStream(nsIMsgDBHdr *msgHdr,</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                                       nsIInputStream *stream);</span>
<a href="#l11.60"></a><span id="l11.60">   nsresult HandleAutoCompactEvent(nsIMsgWindow *aMsgWindow);</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-protected:</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+ protected:</span>
<a href="#l11.64"></a><span id="l11.64">   virtual ~nsMsgDBFolder();</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-  virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI);</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  virtual nsresult CreateBaseMessageURI(const nsACString &amp;aURI);</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  void compressQuotesInMsgSnippet(const nsString&amp; aMessageText, nsAString&amp; aCompressedQuotesStr);</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  void decodeMsgSnippet(const nsACString&amp; aEncodingType, bool aIsComplete, nsCString&amp; aMsgSnippet);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  void compressQuotesInMsgSnippet(const nsString &amp;aMessageText,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+                                  nsAString &amp;aCompressedQuotesStr);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  void decodeMsgSnippet(const nsACString &amp;aEncodingType, bool aIsComplete,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                        nsCString &amp;aMsgSnippet);</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76">   // helper routine to parse the URI and update member variables</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  nsresult parseURI(bool needServer=false);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  nsresult parseURI(bool needServer = false);</span>
<a href="#l11.79"></a><span id="l11.79">   nsresult GetBaseStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  nsresult GetStringFromBundle(const char* msgName, nsString&amp; aResult);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-  nsresult ThrowConfirmationPrompt(nsIMsgWindow *msgWindow, const nsAString&amp; confirmString, bool *confirmed);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+  nsresult GetStringFromBundle(const char *msgName, nsString &amp;aResult);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  nsresult ThrowConfirmationPrompt(nsIMsgWindow *msgWindow,</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+                                   const nsAString &amp;confirmString,</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+                                   bool *confirmed);</span>
<a href="#l11.86"></a><span id="l11.86">   nsresult GetWarnFilterChanged(bool *aVal);</span>
<a href="#l11.87"></a><span id="l11.87">   nsresult SetWarnFilterChanged(bool aVal);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  nsresult CreateCollationKey(const nsString &amp;aSource,  uint8_t **aKey, uint32_t *aLength);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  nsresult CreateCollationKey(const nsString &amp;aSource, uint8_t **aKey,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+                              uint32_t *aLength);</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92">   // all children will override this to create the right class of object.</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-  virtual nsresult CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder) = 0;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  virtual nsresult CreateChildFromURI(const nsCString &amp;uri,</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+                                      nsIMsgFolder **folder) = 0;</span>
<a href="#l11.96"></a><span id="l11.96">   virtual nsresult ReadDBFolderInfo(bool force);</span>
<a href="#l11.97"></a><span id="l11.97">   virtual nsresult FlushToFolderCache();</span>
<a href="#l11.98"></a><span id="l11.98">   virtual nsresult GetDatabase() = 0;</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  virtual nsresult SendFlagNotifications(nsIMsgDBHdr *item, uint32_t oldFlags, uint32_t newFlags);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+  virtual nsresult SendFlagNotifications(nsIMsgDBHdr *item, uint32_t oldFlags,</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+                                         uint32_t newFlags);</span>
<a href="#l11.102"></a><span id="l11.102">   nsresult CheckWithNewMessagesStatus(bool messageAdded);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  void     UpdateNewMessages();</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  void UpdateNewMessages();</span>
<a href="#l11.105"></a><span id="l11.105">   nsresult OnHdrAddedOrDeleted(nsIMsgDBHdr *hdrChanged, bool added);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  nsresult CreateFileForDB(const nsAString&amp; userLeafName, nsIFile *baseDir,</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  nsresult CreateFileForDB(const nsAString &amp;userLeafName, nsIFile *baseDir,</span>
<a href="#l11.108"></a><span id="l11.108">                            nsIFile **dbFile);</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110">   nsresult GetFolderCacheKey(nsIFile **aFile, bool createDBIfMissing = false);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-  nsresult GetFolderCacheElemFromFile(nsIFile *file, nsIMsgFolderCacheElement **cacheElement);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  nsresult GetFolderCacheElemFromFile(nsIFile *file,</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+                                      nsIMsgFolderCacheElement **cacheElement);</span>
<a href="#l11.114"></a><span id="l11.114">   nsresult AddDirectorySeparator(nsIFile *path);</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-  nsresult CheckIfFolderExists(const nsAString&amp; newFolderName, nsIMsgFolder *parentFolder, nsIMsgWindow *msgWindow);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  bool     ConfirmAutoFolderRename(nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-                                   const nsString&amp; aOldName,</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-                                   const nsString&amp; aNewName);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  nsresult CheckIfFolderExists(const nsAString &amp;newFolderName,</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+                               nsIMsgFolder *parentFolder,</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+                               nsIMsgWindow *msgWindow);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+  bool ConfirmAutoFolderRename(nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+                               const nsString &amp;aOldName,</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+                               const nsString &amp;aNewName);</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126">   // Returns true if: a) there is no need to prompt or b) the user is already</span>
<a href="#l11.127"></a><span id="l11.127">   // logged in or c) the user logged in successfully.</span>
<a href="#l11.128"></a><span id="l11.128">   static bool PromptForMasterPasswordIfNecessary();</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130">   // offline support methods.</span>
<a href="#l11.131"></a><span id="l11.131">   nsresult StartNewOfflineMessage();</span>
<a href="#l11.132"></a><span id="l11.132">   nsresult WriteStartOfNewLocalMessage();</span>
<a href="#l11.133"></a><span id="l11.133">   nsresult EndNewOfflineMessage();</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-  nsresult CompactOfflineStore(nsIMsgWindow *inWindow, nsIUrlListener *aUrlListener);</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  nsresult CompactOfflineStore(nsIMsgWindow *inWindow,</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+                               nsIUrlListener *aUrlListener);</span>
<a href="#l11.137"></a><span id="l11.137">   nsresult AutoCompact(nsIMsgWindow *aWindow);</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  // this is a helper routine that ignores whether nsMsgMessageFlags::Offline is set for the folder</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  // this is a helper routine that ignores whether nsMsgMessageFlags::Offline is</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  // set for the folder</span>
<a href="#l11.141"></a><span id="l11.141">   nsresult MsgFitsDownloadCriteria(nsMsgKey msgKey, bool *result);</span>
<a href="#l11.142"></a><span id="l11.142">   nsresult GetPromptPurgeThreshold(bool *aPrompt);</span>
<a href="#l11.143"></a><span id="l11.143">   nsresult GetPurgeThreshold(int32_t *aThreshold);</span>
<a href="#l11.144"></a><span id="l11.144">   nsresult ApplyRetentionSettings(bool deleteViaFolder);</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-  bool     VerifyOfflineMessage(nsIMsgDBHdr *msgHdr, nsIInputStream *fileStream);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  bool VerifyOfflineMessage(nsIMsgDBHdr *msgHdr, nsIInputStream *fileStream);</span>
<a href="#l11.147"></a><span id="l11.147">   nsresult AddMarkAllReadUndoAction(nsIMsgWindow *msgWindow,</span>
<a href="#l11.148"></a><span id="l11.148">                                     nsMsgKey *thoseMarked, uint32_t numMarked);</span>
<a href="#l11.149"></a><span id="l11.149"> </span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  nsresult PerformBiffNotifications(void); // if there are new, non spam messages, do biff</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+  nsresult PerformBiffNotifications(</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+      void);  // if there are new, non spam messages, do biff</span>
<a href="#l11.153"></a><span id="l11.153">   nsresult CloseDBIfFolderNotOpen();</span>
<a href="#l11.154"></a><span id="l11.154"> </span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  virtual nsresult SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-  virtual nsresult SpamFilterClassifyMessages(const char **aURIArray, uint32_t aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  virtual nsresult SpamFilterClassifyMessage(</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+      const char *aURI, nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+      nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+  virtual nsresult SpamFilterClassifyMessages(</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+      const char **aURIArray, uint32_t aURICount, nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+      nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.163"></a><span id="l11.163">   // Helper function for Move code to call to update the MRU and MRM time.</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-  void    UpdateTimestamps(bool allowUndo);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  void    SetMRUTime();</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-  void    SetMRMTime();</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+  void UpdateTimestamps(bool allowUndo);</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+  void SetMRUTime();</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+  void SetMRMTime();</span>
<a href="#l11.170"></a><span id="l11.170">   /**</span>
<a href="#l11.171"></a><span id="l11.171">    * Clear all processing flags, presumably because message keys are no longer</span>
<a href="#l11.172"></a><span id="l11.172">    * valid.</span>
<a href="#l11.173"></a><span id="l11.173">    */</span>
<a href="#l11.174"></a><span id="l11.174">   void ClearProcessingFlags();</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176">   nsresult NotifyHdrsNotBeingClassified();</span>
<a href="#l11.177"></a><span id="l11.177"> </span>
<a href="#l11.178"></a><span id="l11.178">   /**</span>
<a href="#l11.179"></a><span id="l11.179">    * Produce an array of messages ordered like the input keys.</span>
<a href="#l11.180"></a><span id="l11.180">    */</span>
<a href="#l11.181"></a><span id="l11.181">   nsresult MessagesInKeyOrder(nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray,</span>
<a href="#l11.182"></a><span id="l11.182">                               nsIMsgFolder *srcFolder,</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-                              nsIMutableArray* messages);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+                              nsIMutableArray *messages);</span>
<a href="#l11.185"></a><span id="l11.185"> </span>
<a href="#l11.186"></a><span id="l11.186">   nsCOMPtr&lt;nsIMsgDatabase&gt; mDatabase;</span>
<a href="#l11.187"></a><span id="l11.187">   nsCOMPtr&lt;nsIMsgDatabase&gt; mBackupDatabase;</span>
<a href="#l11.188"></a><span id="l11.188">   nsCString mCharset;</span>
<a href="#l11.189"></a><span id="l11.189">   bool mCharsetOverride;</span>
<a href="#l11.190"></a><span id="l11.190">   bool mAddListener;</span>
<a href="#l11.191"></a><span id="l11.191">   bool mNewMessages;</span>
<a href="#l11.192"></a><span id="l11.192">   bool mGettingNewMessages;</span>
<a href="#l11.193"></a><span id="l11.193">   nsMsgKey mLastMessageLoaded;</span>
<a href="#l11.194"></a><span id="l11.194"> </span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_offlineHeader;</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_offlineHeader;</span>
<a href="#l11.197"></a><span id="l11.197">   int32_t m_numOfflineMsgLines;</span>
<a href="#l11.198"></a><span id="l11.198">   int32_t m_bytesAddedToLocalMsg;</span>
<a href="#l11.199"></a><span id="l11.199">   // this is currently used when we do a save as of an imap or news message..</span>
<a href="#l11.200"></a><span id="l11.200">   nsCOMPtr&lt;nsIOutputStream&gt; m_tempMessageStream;</span>
<a href="#l11.201"></a><span id="l11.201"> </span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-  nsCOMPtr &lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l11.206"></a><span id="l11.206">   static NS_MSG_BASE_STATIC_MEMBER_(nsrefcnt) mInstanceCount;</span>
<a href="#l11.207"></a><span id="l11.207"> </span>
<a href="#l11.208"></a><span id="l11.208">   uint32_t mFlags;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-  nsWeakPtr mParent;     //This won't be refcounted for ownership reasons.</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-  int32_t mNumUnreadMessages;        /* count of unread messages (-1 means unknown; -2 means unknown but we already tried to find out.) */</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-  int32_t mNumTotalMessages;         /* count of existing messages. */</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+  nsWeakPtr mParent;          // This won't be refcounted for ownership reasons.</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+  int32_t mNumUnreadMessages; /* count of unread messages (-1 means unknown; -2</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+                                 means unknown but we already tried to find</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+                                 out.) */</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+  int32_t mNumTotalMessages;  /* count of existing messages. */</span>
<a href="#l11.217"></a><span id="l11.217">   bool mNotifyCountChanges;</span>
<a href="#l11.218"></a><span id="l11.218">   int64_t mExpungedBytes;</span>
<a href="#l11.219"></a><span id="l11.219">   nsCOMArray&lt;nsIMsgFolder&gt; mSubFolders;</span>
<a href="#l11.220"></a><span id="l11.220">   nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt;&gt; mListeners;</span>
<a href="#l11.221"></a><span id="l11.221"> </span>
<a href="#l11.222"></a><span id="l11.222">   bool mInitializedFromCache;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-  nsISupports *mSemaphoreHolder; // set when the folder is being written to</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-                                 //Due to ownership issues, this won't be AddRef'd.</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+  nsISupports *mSemaphoreHolder;  // set when the folder is being written to</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+                                  // Due to ownership issues, this won't be</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+                                  // AddRef'd.</span>
<a href="#l11.228"></a><span id="l11.228"> </span>
<a href="#l11.229"></a><span id="l11.229">   nsWeakPtr mServer;</span>
<a href="#l11.230"></a><span id="l11.230"> </span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-  // These values are used for tricking the front end into thinking that we have more</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-  // messages than are really in the DB.  This is usually after and IMAP message copy where</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-  // we don't want to do an expensive select until the user actually opens that folder</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+  // These values are used for tricking the front end into thinking that we have</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+  // more messages than are really in the DB.  This is usually after and IMAP</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+  // message copy where we don't want to do an expensive select until the user</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+  // actually opens that folder</span>
<a href="#l11.238"></a><span id="l11.238">   int32_t mNumPendingUnreadMessages;</span>
<a href="#l11.239"></a><span id="l11.239">   int32_t mNumPendingTotalMessages;</span>
<a href="#l11.240"></a><span id="l11.240">   int64_t mFolderSize;</span>
<a href="#l11.241"></a><span id="l11.241"> </span>
<a href="#l11.242"></a><span id="l11.242">   int32_t mNumNewBiffMessages;</span>
<a href="#l11.243"></a><span id="l11.243"> </span>
<a href="#l11.244"></a><span id="l11.244">   // these are previous set of new msgs, which we might</span>
<a href="#l11.245"></a><span id="l11.245">   // want to run junk controls on. This is in addition to &quot;new&quot; hdrs</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineat">@@ -238,22 +259,22 @@ protected:</span>
<a href="#l11.247"></a><span id="l11.247">   // These are the set of new messages for a folder who has had</span>
<a href="#l11.248"></a><span id="l11.248">   // its db closed, without the user reading the folder. This</span>
<a href="#l11.249"></a><span id="l11.249">   // happens with pop3 mail filtered to a different local folder.</span>
<a href="#l11.250"></a><span id="l11.250">   nsTArray&lt;nsMsgKey&gt; m_newMsgs;</span>
<a href="#l11.251"></a><span id="l11.251"> </span>
<a href="#l11.252"></a><span id="l11.252">   //</span>
<a href="#l11.253"></a><span id="l11.253">   // stuff from the uri</span>
<a href="#l11.254"></a><span id="l11.254">   //</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-  bool mHaveParsedURI;        // is the URI completely parsed?</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+  bool mHaveParsedURI;  // is the URI completely parsed?</span>
<a href="#l11.257"></a><span id="l11.257">   bool mIsServerIsValid;</span>
<a href="#l11.258"></a><span id="l11.258">   bool mIsServer;</span>
<a href="#l11.259"></a><span id="l11.259">   nsString mName;</span>
<a href="#l11.260"></a><span id="l11.260">   nsCOMPtr&lt;nsIFile&gt; mPath;</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-  nsCString mBaseMessageURI; //The uri with the message scheme</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  nsCString mBaseMessageURI;  // The uri with the message scheme</span>
<a href="#l11.263"></a><span id="l11.263"> </span>
<a href="#l11.264"></a><span id="l11.264">   // static stuff for cross-instance objects like atoms</span>
<a href="#l11.265"></a><span id="l11.265">   static NS_MSG_BASE_STATIC_MEMBER_(nsrefcnt) gInstanceCount;</span>
<a href="#l11.266"></a><span id="l11.266"> </span>
<a href="#l11.267"></a><span id="l11.267">   static nsresult initializeStrings();</span>
<a href="#l11.268"></a><span id="l11.268">   static nsresult createCollationKeyGenerator();</span>
<a href="#l11.269"></a><span id="l11.269"> </span>
<a href="#l11.270"></a><span id="l11.270">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedInboxName;</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineat">@@ -262,24 +283,22 @@ protected:</span>
<a href="#l11.272"></a><span id="l11.272">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedDraftsName;</span>
<a href="#l11.273"></a><span id="l11.273">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedTemplatesName;</span>
<a href="#l11.274"></a><span id="l11.274">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedUnsentName;</span>
<a href="#l11.275"></a><span id="l11.275">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedJunkName;</span>
<a href="#l11.276"></a><span id="l11.276">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedArchivesName;</span>
<a href="#l11.277"></a><span id="l11.277"> </span>
<a href="#l11.278"></a><span id="l11.278">   static NS_MSG_BASE_STATIC_MEMBER_(nsString) kLocalizedBrandShortName;</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-  static NS_MSG_BASE_STATIC_MEMBER_(nsICollation*) gCollationKeyGenerator;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+  static NS_MSG_BASE_STATIC_MEMBER_(nsICollation *) gCollationKeyGenerator;</span>
<a href="#l11.283"></a><span id="l11.283"> </span>
<a href="#l11.284"></a><span id="l11.284">   // store of keys that have a processing flag set</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-  struct</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-  {</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+  struct {</span>
<a href="#l11.288"></a><span id="l11.288">     uint32_t bit;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-    nsMsgKeySetU* keys;</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+    nsMsgKeySetU *keys;</span>
<a href="#l11.291"></a><span id="l11.291">   } mProcessingFlag[nsMsgProcessingFlags::NumberOfFlags];</span>
<a href="#l11.292"></a><span id="l11.292"> </span>
<a href="#l11.293"></a><span id="l11.293">   // list of nsIMsgDBHdrs for messages to process post-bayes</span>
<a href="#l11.294"></a><span id="l11.294">   nsCOMPtr&lt;nsIMutableArray&gt; mPostBayesMessagesToFilter;</span>
<a href="#l11.295"></a><span id="l11.295"> </span>
<a href="#l11.296"></a><span id="l11.296">   /**</span>
<a href="#l11.297"></a><span id="l11.297">    * The list of message keys that have been classified for msgsClassified</span>
<a href="#l11.298"></a><span id="l11.298">    * batch notification purposes.  We add to this list in OnMessageClassified</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineat">@@ -290,31 +309,30 @@ protected:</span>
<a href="#l11.300"></a><span id="l11.300">   nsTArray&lt;nsMsgKey&gt; mClassifiedMsgKeys;</span>
<a href="#l11.301"></a><span id="l11.301">   // Is the current bayes filtering doing junk classification?</span>
<a href="#l11.302"></a><span id="l11.302">   bool mBayesJunkClassifying;</span>
<a href="#l11.303"></a><span id="l11.303">   // Is the current bayes filtering doing trait classification?</span>
<a href="#l11.304"></a><span id="l11.304">   bool mBayesTraitClassifying;</span>
<a href="#l11.305"></a><span id="l11.305"> };</span>
<a href="#l11.306"></a><span id="l11.306"> </span>
<a href="#l11.307"></a><span id="l11.307"> // This class is a kludge to allow nsMsgKeySet to be used with uint32_t keys</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-class nsMsgKeySetU</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-{</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-public:</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-    // Creates an empty set.</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-  static nsMsgKeySetU* Create();</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+class nsMsgKeySetU {</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+ public:</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+  // Creates an empty set.</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+  static nsMsgKeySetU *Create();</span>
<a href="#l11.317"></a><span id="l11.317">   ~nsMsgKeySetU();</span>
<a href="#l11.318"></a><span id="l11.318">   // IsMember() returns whether the given key is a member of this set.</span>
<a href="#l11.319"></a><span id="l11.319">   bool IsMember(nsMsgKey key);</span>
<a href="#l11.320"></a><span id="l11.320">   // Add() adds the given key to the set.  (Returns 1 if a change was</span>
<a href="#l11.321"></a><span id="l11.321">   // made, 0 if it was already there, and negative on error.)</span>
<a href="#l11.322"></a><span id="l11.322">   int Add(nsMsgKey key);</span>
<a href="#l11.323"></a><span id="l11.323">   // Remove() removes the given article from the set.</span>
<a href="#l11.324"></a><span id="l11.324">   int Remove(nsMsgKey key);</span>
<a href="#l11.325"></a><span id="l11.325">   // Add the keys in the set to aArray.</span>
<a href="#l11.326"></a><span id="l11.326">   nsresult ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt; &amp;aArray);</span>
<a href="#l11.327"></a><span id="l11.327"> </span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-protected:</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+ protected:</span>
<a href="#l11.330"></a><span id="l11.330">   nsMsgKeySetU();</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-  nsMsgKeySet* loKeySet;</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-  nsMsgKeySet* hiKeySet;</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+  nsMsgKeySet *loKeySet;</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+  nsMsgKeySet *hiKeySet;</span>
<a href="#l11.335"></a><span id="l11.335"> };</span>
<a href="#l11.336"></a><span id="l11.336"> </span>
<a href="#l11.337"></a><span id="l11.337"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/util/nsMsgFileStream.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgFileStream.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -3,194 +3,184 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIFile.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsMsgFileStream.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;prerr.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;prerror.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> /* From nsDebugImpl.cpp: */</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-static nsresult</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-ErrorAccordingToNSPR()</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-{</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    PRErrorCode err = PR_GetError();</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-    switch (err) {</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-      case PR_OUT_OF_MEMORY_ERROR:              return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-      case PR_WOULD_BLOCK_ERROR:                return NS_BASE_STREAM_WOULD_BLOCK;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-      case PR_FILE_NOT_FOUND_ERROR:             return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-      case PR_READ_ONLY_FILESYSTEM_ERROR:       return NS_ERROR_FILE_READ_ONLY;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-      case PR_NOT_DIRECTORY_ERROR:              return NS_ERROR_FILE_NOT_DIRECTORY;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-      case PR_IS_DIRECTORY_ERROR:               return NS_ERROR_FILE_IS_DIRECTORY;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-      case PR_LOOP_ERROR:                       return NS_ERROR_FILE_UNRESOLVABLE_SYMLINK;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-      case PR_FILE_EXISTS_ERROR:                return NS_ERROR_FILE_ALREADY_EXISTS;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-      case PR_FILE_IS_LOCKED_ERROR:             return NS_ERROR_FILE_IS_LOCKED;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-      case PR_FILE_TOO_BIG_ERROR:               return NS_ERROR_FILE_TOO_BIG;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-      case PR_NO_DEVICE_SPACE_ERROR:            return NS_ERROR_FILE_NO_DEVICE_SPACE;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-      case PR_NAME_TOO_LONG_ERROR:              return NS_ERROR_FILE_NAME_TOO_LONG;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-      case PR_DIRECTORY_NOT_EMPTY_ERROR:        return NS_ERROR_FILE_DIR_NOT_EMPTY;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-      case PR_NO_ACCESS_RIGHTS_ERROR:           return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-      default:                                  return NS_ERROR_FAILURE;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+static nsresult ErrorAccordingToNSPR() {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  PRErrorCode err = PR_GetError();</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  switch (err) {</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    case PR_OUT_OF_MEMORY_ERROR:</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    case PR_WOULD_BLOCK_ERROR:</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+      return NS_BASE_STREAM_WOULD_BLOCK;</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    case PR_FILE_NOT_FOUND_ERROR:</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+      return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    case PR_READ_ONLY_FILESYSTEM_ERROR:</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+      return NS_ERROR_FILE_READ_ONLY;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    case PR_NOT_DIRECTORY_ERROR:</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+      return NS_ERROR_FILE_NOT_DIRECTORY;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    case PR_IS_DIRECTORY_ERROR:</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+      return NS_ERROR_FILE_IS_DIRECTORY;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    case PR_LOOP_ERROR:</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+      return NS_ERROR_FILE_UNRESOLVABLE_SYMLINK;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    case PR_FILE_EXISTS_ERROR:</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+      return NS_ERROR_FILE_ALREADY_EXISTS;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    case PR_FILE_IS_LOCKED_ERROR:</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+      return NS_ERROR_FILE_IS_LOCKED;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    case PR_FILE_TOO_BIG_ERROR:</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+      return NS_ERROR_FILE_TOO_BIG;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+    case PR_NO_DEVICE_SPACE_ERROR:</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+      return NS_ERROR_FILE_NO_DEVICE_SPACE;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+    case PR_NAME_TOO_LONG_ERROR:</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+      return NS_ERROR_FILE_NAME_TOO_LONG;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    case PR_DIRECTORY_NOT_EMPTY_ERROR:</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+      return NS_ERROR_FILE_DIR_NOT_EMPTY;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+    case PR_NO_ACCESS_RIGHTS_ERROR:</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+      return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+    default:</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  }</span>
<a href="#l12.67"></a><span id="l12.67"> }</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-nsMsgFileStream::nsMsgFileStream()</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-{</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+nsMsgFileStream::nsMsgFileStream() {</span>
<a href="#l12.72"></a><span id="l12.72">   mFileDesc = nullptr;</span>
<a href="#l12.73"></a><span id="l12.73">   mSeekedToEnd = false;</span>
<a href="#l12.74"></a><span id="l12.74"> }</span>
<a href="#l12.75"></a><span id="l12.75"> </span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-nsMsgFileStream::~nsMsgFileStream()</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-{</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  if (mFileDesc)</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-    PR_Close(mFileDesc);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+nsMsgFileStream::~nsMsgFileStream() {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  if (mFileDesc) PR_Close(mFileDesc);</span>
<a href="#l12.82"></a><span id="l12.82"> }</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgFileStream, nsIInputStream, nsIOutputStream, nsITellableStream, nsISeekableStream)</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgFileStream, nsIInputStream, nsIOutputStream,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+                  nsITellableStream, nsISeekableStream)</span>
<a href="#l12.87"></a><span id="l12.87"> </span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-nsresult nsMsgFileStream::InitWithFile(nsIFile *file)</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-{</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-  return file-&gt;OpenNSPRFileDesc(PR_RDWR|PR_CREATE_FILE, 0664, &amp;mFileDesc);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+nsresult nsMsgFileStream::InitWithFile(nsIFile *file) {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  return file-&gt;OpenNSPRFileDesc(PR_RDWR | PR_CREATE_FILE, 0664, &amp;mFileDesc);</span>
<a href="#l12.93"></a><span id="l12.93"> }</span>
<a href="#l12.94"></a><span id="l12.94"> </span>
<a href="#l12.95"></a><span id="l12.95"> NS_IMETHODIMP</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-nsMsgFileStream::Seek(int32_t whence, int64_t offset)</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-{</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-  if (mFileDesc == nullptr)</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+nsMsgFileStream::Seek(int32_t whence, int64_t offset) {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  if (mFileDesc == nullptr) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103">   bool seekingToEnd = whence == PR_SEEK_END &amp;&amp; offset == 0;</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  if (seekingToEnd &amp;&amp; mSeekedToEnd)</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  if (seekingToEnd &amp;&amp; mSeekedToEnd) return NS_OK;</span>
<a href="#l12.107"></a><span id="l12.107"> </span>
<a href="#l12.108"></a><span id="l12.108">   int64_t cnt = PR_Seek64(mFileDesc, offset, (PRSeekWhence)whence);</span>
<a href="#l12.109"></a><span id="l12.109">   if (cnt == int64_t(-1)) {</span>
<a href="#l12.110"></a><span id="l12.110">     return ErrorAccordingToNSPR();</span>
<a href="#l12.111"></a><span id="l12.111">   }</span>
<a href="#l12.112"></a><span id="l12.112"> </span>
<a href="#l12.113"></a><span id="l12.113">   mSeekedToEnd = seekingToEnd;</span>
<a href="#l12.114"></a><span id="l12.114">   return NS_OK;</span>
<a href="#l12.115"></a><span id="l12.115"> }</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117"> NS_IMETHODIMP</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-nsMsgFileStream::Tell(int64_t *result)</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-{</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-  if (mFileDesc == nullptr)</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+nsMsgFileStream::Tell(int64_t *result) {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  if (mFileDesc == nullptr) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.124"></a><span id="l12.124"> </span>
<a href="#l12.125"></a><span id="l12.125">   int64_t cnt = PR_Seek64(mFileDesc, 0, PR_SEEK_CUR);</span>
<a href="#l12.126"></a><span id="l12.126">   if (cnt == int64_t(-1)) {</span>
<a href="#l12.127"></a><span id="l12.127">     return ErrorAccordingToNSPR();</span>
<a href="#l12.128"></a><span id="l12.128">   }</span>
<a href="#l12.129"></a><span id="l12.129">   *result = cnt;</span>
<a href="#l12.130"></a><span id="l12.130">   return NS_OK;</span>
<a href="#l12.131"></a><span id="l12.131"> }</span>
<a href="#l12.132"></a><span id="l12.132"> </span>
<a href="#l12.133"></a><span id="l12.133"> NS_IMETHODIMP</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-nsMsgFileStream::SetEOF()</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-{</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  if (mFileDesc == nullptr)</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+nsMsgFileStream::SetEOF() {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  if (mFileDesc == nullptr) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.140"></a><span id="l12.140">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.141"></a><span id="l12.141"> }</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143"> /* void close (); */</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-NS_IMETHODIMP nsMsgFileStream::Close()</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-{</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+NS_IMETHODIMP nsMsgFileStream::Close() {</span>
<a href="#l12.147"></a><span id="l12.147">   nsresult rv = NS_OK;</span>
<a href="#l12.148"></a><span id="l12.148">   if (mFileDesc &amp;&amp; (PR_Close(mFileDesc) == PR_FAILURE))</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-        rv = NS_BASE_STREAM_OSERROR;</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-    mFileDesc = nullptr;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    rv = NS_BASE_STREAM_OSERROR;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  mFileDesc = nullptr;</span>
<a href="#l12.153"></a><span id="l12.153">   return rv;</span>
<a href="#l12.154"></a><span id="l12.154"> }</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156"> /* unsigned long long available (); */</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-NS_IMETHODIMP nsMsgFileStream::Available(uint64_t *aResult)</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-{</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-  if (!mFileDesc)</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+NS_IMETHODIMP nsMsgFileStream::Available(uint64_t *aResult) {</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  if (!mFileDesc) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.163"></a><span id="l12.163"> </span>
<a href="#l12.164"></a><span id="l12.164">   int64_t avail = PR_Available64(mFileDesc);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-  if (avail == -1)</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-    return ErrorAccordingToNSPR();</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  if (avail == -1) return ErrorAccordingToNSPR();</span>
<a href="#l12.168"></a><span id="l12.168"> </span>
<a href="#l12.169"></a><span id="l12.169">   *aResult = avail;</span>
<a href="#l12.170"></a><span id="l12.170">   return NS_OK;</span>
<a href="#l12.171"></a><span id="l12.171"> }</span>
<a href="#l12.172"></a><span id="l12.172"> </span>
<a href="#l12.173"></a><span id="l12.173"> /* [noscript] unsigned long read (in charPtr aBuf, in unsigned long aCount); */</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-NS_IMETHODIMP nsMsgFileStream::Read(char * aBuf, uint32_t aCount, uint32_t *aResult)</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-{</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-  if (!mFileDesc)</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-  {</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+NS_IMETHODIMP nsMsgFileStream::Read(char *aBuf, uint32_t aCount,</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+                                    uint32_t *aResult) {</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+  if (!mFileDesc) {</span>
<a href="#l12.181"></a><span id="l12.181">     *aResult = 0;</span>
<a href="#l12.182"></a><span id="l12.182">     return NS_OK;</span>
<a href="#l12.183"></a><span id="l12.183">   }</span>
<a href="#l12.184"></a><span id="l12.184"> </span>
<a href="#l12.185"></a><span id="l12.185">   int32_t bytesRead = PR_Read(mFileDesc, aBuf, aCount);</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  if (bytesRead == -1)</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-    return ErrorAccordingToNSPR();</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+  if (bytesRead == -1) return ErrorAccordingToNSPR();</span>
<a href="#l12.189"></a><span id="l12.189"> </span>
<a href="#l12.190"></a><span id="l12.190">   *aResult = bytesRead;</span>
<a href="#l12.191"></a><span id="l12.191">   return NS_OK;</span>
<a href="#l12.192"></a><span id="l12.192"> }</span>
<a href="#l12.193"></a><span id="l12.193"> </span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-/* [noscript] unsigned long readSegments (in nsWriteSegmentFun aWriter, in voidPtr aClosure, in unsigned long aCount); */</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-NS_IMETHODIMP nsMsgFileStream::ReadSegments(nsWriteSegmentFun aWriter, void * aClosure, uint32_t aCount, uint32_t *_retval)</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-{</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+/* [noscript] unsigned long readSegments (in nsWriteSegmentFun aWriter, in</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+ * voidPtr aClosure, in unsigned long aCount); */</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+NS_IMETHODIMP nsMsgFileStream::ReadSegments(nsWriteSegmentFun aWriter,</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+                                            void *aClosure, uint32_t aCount,</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+                                            uint32_t *_retval) {</span>
<a href="#l12.202"></a><span id="l12.202">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.203"></a><span id="l12.203"> }</span>
<a href="#l12.204"></a><span id="l12.204"> </span>
<a href="#l12.205"></a><span id="l12.205"> /* boolean isNonBlocking (); */</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-NS_IMETHODIMP nsMsgFileStream::IsNonBlocking(bool *aNonBlocking)</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-{</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+NS_IMETHODIMP nsMsgFileStream::IsNonBlocking(bool *aNonBlocking) {</span>
<a href="#l12.209"></a><span id="l12.209">   *aNonBlocking = false;</span>
<a href="#l12.210"></a><span id="l12.210">   return NS_OK;</span>
<a href="#l12.211"></a><span id="l12.211"> }</span>
<a href="#l12.212"></a><span id="l12.212"> </span>
<a href="#l12.213"></a><span id="l12.213"> NS_IMETHODIMP</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-nsMsgFileStream::Write(const char *buf, uint32_t count, uint32_t *result)</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-{</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-  if (mFileDesc == nullptr)</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+nsMsgFileStream::Write(const char *buf, uint32_t count, uint32_t *result) {</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+  if (mFileDesc == nullptr) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221">   int32_t cnt = PR_Write(mFileDesc, buf, count);</span>
<a href="#l12.222"></a><span id="l12.222">   if (cnt == -1) {</span>
<a href="#l12.223"></a><span id="l12.223">     return ErrorAccordingToNSPR();</span>
<a href="#l12.224"></a><span id="l12.224">   }</span>
<a href="#l12.225"></a><span id="l12.225">   *result = cnt;</span>
<a href="#l12.226"></a><span id="l12.226">   return NS_OK;</span>
<a href="#l12.227"></a><span id="l12.227"> }</span>
<a href="#l12.228"></a><span id="l12.228"> </span>
<a href="#l12.229"></a><span id="l12.229"> NS_IMETHODIMP</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-nsMsgFileStream::Flush(void)</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-{</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-  if (mFileDesc == nullptr)</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-    return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+nsMsgFileStream::Flush(void) {</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+  if (mFileDesc == nullptr) return NS_BASE_STREAM_CLOSED;</span>
<a href="#l12.236"></a><span id="l12.236"> </span>
<a href="#l12.237"></a><span id="l12.237">   int32_t cnt = PR_Sync(mFileDesc);</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-  if (cnt == -1)</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-    return ErrorAccordingToNSPR();</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+  if (cnt == -1) return ErrorAccordingToNSPR();</span>
<a href="#l12.241"></a><span id="l12.241"> </span>
<a href="#l12.242"></a><span id="l12.242">   return NS_OK;</span>
<a href="#l12.243"></a><span id="l12.243"> }</span>
<a href="#l12.244"></a><span id="l12.244"> </span>
<a href="#l12.245"></a><span id="l12.245"> NS_IMETHODIMP</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-nsMsgFileStream::WriteFrom(nsIInputStream *inStr, uint32_t count, uint32_t *_retval)</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-{</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+nsMsgFileStream::WriteFrom(nsIInputStream *inStr, uint32_t count,</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+                           uint32_t *_retval) {</span>
<a href="#l12.250"></a><span id="l12.250">   MOZ_ASSERT_UNREACHABLE(&quot;WriteFrom (see source comment)&quot;);</span>
<a href="#l12.251"></a><span id="l12.251">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.252"></a><span id="l12.252">   // File streams intentionally do not support this method.</span>
<a href="#l12.253"></a><span id="l12.253">   // If you need something like this, then you should wrap</span>
<a href="#l12.254"></a><span id="l12.254">   // the file stream using nsIBufferedOutputStream</span>
<a href="#l12.255"></a><span id="l12.255"> }</span>
<a href="#l12.256"></a><span id="l12.256"> </span>
<a href="#l12.257"></a><span id="l12.257"> NS_IMETHODIMP</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-nsMsgFileStream::WriteSegments(nsReadSegmentFun reader, void * closure, uint32_t count, uint32_t *_retval)</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-{</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+nsMsgFileStream::WriteSegments(nsReadSegmentFun reader, void *closure,</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+                               uint32_t count, uint32_t *_retval) {</span>
<a href="#l12.262"></a><span id="l12.262">   MOZ_ASSERT_UNREACHABLE(&quot;WriteSegments (see source comment)&quot;);</span>
<a href="#l12.263"></a><span id="l12.263">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.264"></a><span id="l12.264">   // File streams intentionally do not support this method.</span>
<a href="#l12.265"></a><span id="l12.265">   // If you need something like this, then you should wrap</span>
<a href="#l12.266"></a><span id="l12.266">   // the file stream using nsIBufferedOutputStream</span>
<a href="#l12.267"></a><span id="l12.267"> }</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineminus">-</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineminus">-</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/util/nsMsgFileStream.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgFileStream.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,29 +6,30 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;prio.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> class nsMsgFileStream final : public nsIInputStream,</span>
<a href="#l13.11"></a><span id="l13.11">                               public nsIOutputStream,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                              public nsISeekableStream</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-public:</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                              public nsISeekableStream {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ public:</span>
<a href="#l13.17"></a><span id="l13.17">   nsMsgFileStream();</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">   NS_DECL_ISUPPORTS</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">   NS_IMETHOD Available(uint64_t *_retval) override;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  NS_IMETHOD Read(char * aBuf, uint32_t aCount, uint32_t *_retval) override;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  NS_IMETHOD ReadSegments(nsWriteSegmentFun aWriter, void * aClosure, uint32_t aCount, uint32_t *_retval) override;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  NS_IMETHOD Read(char *aBuf, uint32_t aCount, uint32_t *_retval) override;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  NS_IMETHOD ReadSegments(nsWriteSegmentFun aWriter, void *aClosure,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+                          uint32_t aCount, uint32_t *_retval) override;</span>
<a href="#l13.27"></a><span id="l13.27">   NS_DECL_NSIOUTPUTSTREAM</span>
<a href="#l13.28"></a><span id="l13.28">   NS_DECL_NSISEEKABLESTREAM</span>
<a href="#l13.29"></a><span id="l13.29">   NS_DECL_NSITELLABLESTREAM</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31">   nsresult InitWithFile(nsIFile *localFile);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-protected:</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ protected:</span>
<a href="#l13.35"></a><span id="l13.35">   ~nsMsgFileStream();</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">   PRFileDesc *mFileDesc;</span>
<a href="#l13.38"></a><span id="l13.38">   bool mSeekedToEnd;</span>
<a href="#l13.39"></a><span id="l13.39"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/util/nsMsgI18N.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgI18N.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -32,18 +32,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> //</span>
<a href="#l14.6"></a><span id="l14.6"> // International functions necessary for composition</span>
<a href="#l14.7"></a><span id="l14.7"> //</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> nsresult nsMsgI18NConvertFromUnicode(const nsACString&amp; aCharset,</span>
<a href="#l14.10"></a><span id="l14.10">                                      const nsAString&amp; inString,</span>
<a href="#l14.11"></a><span id="l14.11">                                      nsACString&amp; outString,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                                     bool aReportUencNoMapping)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+                                     bool aReportUencNoMapping) {</span>
<a href="#l14.15"></a><span id="l14.15">   if (inString.IsEmpty()) {</span>
<a href="#l14.16"></a><span id="l14.16">     outString.Truncate();</span>
<a href="#l14.17"></a><span id="l14.17">     return NS_OK;</span>
<a href="#l14.18"></a><span id="l14.18">   }</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   auto encoding = mozilla::Encoding::ForLabelNoReplacement(aCharset);</span>
<a href="#l14.21"></a><span id="l14.21">   if (!encoding) {</span>
<a href="#l14.22"></a><span id="l14.22">     return NS_ERROR_UCONV_NOCONV;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -61,18 +60,17 @@ nsresult nsMsgI18NConvertFromUnicode(con</span>
<a href="#l14.24"></a><span id="l14.24">     rv = aReportUencNoMapping ? NS_ERROR_UENC_NOMAPPING : NS_OK;</span>
<a href="#l14.25"></a><span id="l14.25">   }</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   return rv;</span>
<a href="#l14.28"></a><span id="l14.28"> }</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30"> nsresult nsMsgI18NConvertToUnicode(const nsACString&amp; aCharset,</span>
<a href="#l14.31"></a><span id="l14.31">                                    const nsACString&amp; inString,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                                   nsAString&amp; outString)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-{</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+                                   nsAString&amp; outString) {</span>
<a href="#l14.35"></a><span id="l14.35">   if (inString.IsEmpty()) {</span>
<a href="#l14.36"></a><span id="l14.36">     outString.Truncate();</span>
<a href="#l14.37"></a><span id="l14.37">     return NS_OK;</span>
<a href="#l14.38"></a><span id="l14.38">   }</span>
<a href="#l14.39"></a><span id="l14.39">   if (aCharset.IsEmpty()) {</span>
<a href="#l14.40"></a><span id="l14.40">     // Despite its name, it also works for Latin-1.</span>
<a href="#l14.41"></a><span id="l14.41">     CopyASCIItoUTF16(inString, outString);</span>
<a href="#l14.42"></a><span id="l14.42">     return NS_OK;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineat">@@ -80,176 +78,174 @@ nsresult nsMsgI18NConvertToUnicode(const</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">   if (aCharset.Equals(&quot;UTF-8&quot;, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l14.46"></a><span id="l14.46">     return UTF_8_ENCODING-&gt;DecodeWithBOMRemoval(inString, outString);</span>
<a href="#l14.47"></a><span id="l14.47">   }</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49">   // Look up Thunderbird's special aliases from charsetalias.properties.</span>
<a href="#l14.50"></a><span id="l14.50">   nsresult rv;</span>
<a href="#l14.51"></a><span id="l14.51">   nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-    do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+      do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l14.54"></a><span id="l14.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">   nsCString newCharset;</span>
<a href="#l14.57"></a><span id="l14.57">   rv = ccm-&gt;GetCharsetAlias(PromiseFlatCString(aCharset).get(), newCharset);</span>
<a href="#l14.58"></a><span id="l14.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60">   if (newCharset.Equals(&quot;UTF-7&quot;, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-    // Special treatment for decoding UTF-7 since it's not handled by encoding_rs.</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+    // Special treatment for decoding UTF-7 since it's not handled by</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    // encoding_rs.</span>
<a href="#l14.64"></a><span id="l14.64">     return CopyUTF7toUTF16(inString, outString);</span>
<a href="#l14.65"></a><span id="l14.65">   }</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67">   auto encoding = mozilla::Encoding::ForLabelNoReplacement(newCharset);</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  if (!encoding)</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-    return NS_ERROR_UCONV_NOCONV;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  if (!encoding) return NS_ERROR_UCONV_NOCONV;</span>
<a href="#l14.71"></a><span id="l14.71">   return encoding-&gt;DecodeWithoutBOMHandlingAndWithoutReplacement(inString,</span>
<a href="#l14.72"></a><span id="l14.72">                                                                  outString);</span>
<a href="#l14.73"></a><span id="l14.73"> }</span>
<a href="#l14.74"></a><span id="l14.74"> </span>
<a href="#l14.75"></a><span id="l14.75"> // This is used to decode UTF-7. No support for encoding in UTF-7.</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-nsresult CopyUTF7toUTF16(const nsACString&amp; aSrc, nsAString&amp; aDest)</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-{</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+nsresult CopyUTF7toUTF16(const nsACString&amp; aSrc, nsAString&amp; aDest) {</span>
<a href="#l14.79"></a><span id="l14.79">   // UTF-7 encoding size cannot be larger than the size in UTF-16.</span>
<a href="#l14.80"></a><span id="l14.80">   nsUTF7ToUnicode converter;</span>
<a href="#l14.81"></a><span id="l14.81">   int32_t inLen = aSrc.Length();</span>
<a href="#l14.82"></a><span id="l14.82">   int32_t outLen = inLen;</span>
<a href="#l14.83"></a><span id="l14.83">   aDest.SetLength(outLen);</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-  converter.ConvertNoBuff(aSrc.BeginReading(), &amp;inLen, aDest.BeginWriting(), &amp;outLen);</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-  MOZ_ASSERT(inLen == (int32_t)aSrc.Length(), &quot;UTF-7 should not produce a longer output&quot;);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  converter.ConvertNoBuff(aSrc.BeginReading(), &amp;inLen, aDest.BeginWriting(),</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+                          &amp;outLen);</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  MOZ_ASSERT(inLen == (int32_t)aSrc.Length(),</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+             &quot;UTF-7 should not produce a longer output&quot;);</span>
<a href="#l14.90"></a><span id="l14.90">   aDest.SetLength(outLen);</span>
<a href="#l14.91"></a><span id="l14.91">   return NS_OK;</span>
<a href="#l14.92"></a><span id="l14.92"> }</span>
<a href="#l14.93"></a><span id="l14.93"> </span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-nsresult CopyUTF16toMUTF7(const nsAString &amp;aSrc, nsACString&amp; aDest)</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-{</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-  #define IMAP_UTF7_BUF_LENGTH 100</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+nsresult CopyUTF16toMUTF7(const nsAString&amp; aSrc, nsACString&amp; aDest) {</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+#define IMAP_UTF7_BUF_LENGTH 100</span>
<a href="#l14.99"></a><span id="l14.99">   nsUnicodeToMUTF7 converter;</span>
<a href="#l14.100"></a><span id="l14.100">   static char buffer[IMAP_UTF7_BUF_LENGTH];</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-  const char16_t *in = aSrc.BeginReading();</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  const char16_t* in = aSrc.BeginReading();</span>
<a href="#l14.103"></a><span id="l14.103">   int32_t inLen = aSrc.Length();</span>
<a href="#l14.104"></a><span id="l14.104">   int32_t outLen;</span>
<a href="#l14.105"></a><span id="l14.105">   aDest.Truncate();</span>
<a href="#l14.106"></a><span id="l14.106">   while (inLen &gt; 0) {</span>
<a href="#l14.107"></a><span id="l14.107">     outLen = IMAP_UTF7_BUF_LENGTH;</span>
<a href="#l14.108"></a><span id="l14.108">     int32_t remaining = inLen;</span>
<a href="#l14.109"></a><span id="l14.109">     converter.ConvertNoBuffNoErr(in, &amp;remaining, buffer, &amp;outLen);</span>
<a href="#l14.110"></a><span id="l14.110">     aDest.Append(buffer, outLen);</span>
<a href="#l14.111"></a><span id="l14.111">     in += remaining;</span>
<a href="#l14.112"></a><span id="l14.112">     inLen -= remaining;</span>
<a href="#l14.113"></a><span id="l14.113">   }</span>
<a href="#l14.114"></a><span id="l14.114">   outLen = IMAP_UTF7_BUF_LENGTH;</span>
<a href="#l14.115"></a><span id="l14.115">   converter.FinishNoBuff(buffer, &amp;outLen);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-  if (outLen &gt; 0)</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-    aDest.Append(buffer, outLen);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+  if (outLen &gt; 0) aDest.Append(buffer, outLen);</span>
<a href="#l14.119"></a><span id="l14.119">   return NS_OK;</span>
<a href="#l14.120"></a><span id="l14.120"> }</span>
<a href="#l14.121"></a><span id="l14.121"> </span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-nsresult CopyMUTF7toUTF16(const nsACString&amp; aSrc, nsAString&amp; aDest)</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-{</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+nsresult CopyMUTF7toUTF16(const nsACString&amp; aSrc, nsAString&amp; aDest) {</span>
<a href="#l14.125"></a><span id="l14.125">   // UTF-7 encoding size cannot be larger than the size in UTF-16.</span>
<a href="#l14.126"></a><span id="l14.126">   nsMUTF7ToUnicode converter;</span>
<a href="#l14.127"></a><span id="l14.127">   int32_t inLen = aSrc.Length();</span>
<a href="#l14.128"></a><span id="l14.128">   int32_t outLen = inLen;</span>
<a href="#l14.129"></a><span id="l14.129">   aDest.SetLength(outLen);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-  converter.ConvertNoBuff(aSrc.BeginReading(), &amp;inLen, aDest.BeginWriting(), &amp;outLen);</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-  MOZ_ASSERT(inLen == (int32_t)aSrc.Length(), &quot;UTF-7 should not produce a longer output&quot;);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+  converter.ConvertNoBuff(aSrc.BeginReading(), &amp;inLen, aDest.BeginWriting(),</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+                          &amp;outLen);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  MOZ_ASSERT(inLen == (int32_t)aSrc.Length(),</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+             &quot;UTF-7 should not produce a longer output&quot;);</span>
<a href="#l14.136"></a><span id="l14.136">   aDest.SetLength(outLen);</span>
<a href="#l14.137"></a><span id="l14.137">   return NS_OK;</span>
<a href="#l14.138"></a><span id="l14.138"> }</span>
<a href="#l14.139"></a><span id="l14.139"> </span>
<a href="#l14.140"></a><span id="l14.140"> // Charset used by the file system.</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-const nsACString&amp; nsMsgI18NFileSystemCharset()</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-{</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+const nsACString&amp; nsMsgI18NFileSystemCharset() {</span>
<a href="#l14.144"></a><span id="l14.144">   /* Get a charset used for the file. */</span>
<a href="#l14.145"></a><span id="l14.145">   static nsAutoCString fileSystemCharset;</span>
<a href="#l14.146"></a><span id="l14.146"> </span>
<a href="#l14.147"></a><span id="l14.147">   if (fileSystemCharset.IsEmpty())</span>
<a href="#l14.148"></a><span id="l14.148">     mozilla::dom::FallbackEncoding::FromLocale()-&gt;Name(fileSystemCharset);</span>
<a href="#l14.149"></a><span id="l14.149"> </span>
<a href="#l14.150"></a><span id="l14.150">   return fileSystemCharset;</span>
<a href="#l14.151"></a><span id="l14.151"> }</span>
<a href="#l14.152"></a><span id="l14.152"> </span>
<a href="#l14.153"></a><span id="l14.153"> // Charset used by the text file.</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-void nsMsgI18NTextFileCharset(nsACString&amp; aCharset)</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-{</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+void nsMsgI18NTextFileCharset(nsACString&amp; aCharset) {</span>
<a href="#l14.157"></a><span id="l14.157">   mozilla::dom::FallbackEncoding::FromLocale()-&gt;Name(aCharset);</span>
<a href="#l14.158"></a><span id="l14.158"> }</span>
<a href="#l14.159"></a><span id="l14.159"> </span>
<a href="#l14.160"></a><span id="l14.160"> // MIME encoder, output string should be freed by PR_FREE</span>
<a href="#l14.161"></a><span id="l14.161"> // XXX : fix callers later to avoid allocation and copy</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-char * nsMsgI18NEncodeMimePartIIStr(const char *header, bool structured, const char *charset, int32_t fieldnamelen, bool usemime)</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-{</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+char* nsMsgI18NEncodeMimePartIIStr(const char* header, bool structured,</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+                                   const char* charset, int32_t fieldnamelen,</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+                                   bool usemime) {</span>
<a href="#l14.167"></a><span id="l14.167">   // No MIME, convert to the outgoing mail charset.</span>
<a href="#l14.168"></a><span id="l14.168">   if (!usemime) {</span>
<a href="#l14.169"></a><span id="l14.169">     nsAutoCString convertedStr;</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-    if (NS_SUCCEEDED(nsMsgI18NConvertFromUnicode(charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-                                                 NS_ConvertUTF8toUTF16(header),</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-                                                 convertedStr)))</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+    if (NS_SUCCEEDED(nsMsgI18NConvertFromUnicode(</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+            charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+            NS_ConvertUTF8toUTF16(header), convertedStr)))</span>
<a href="#l14.176"></a><span id="l14.176">       return PL_strdup(convertedStr.get());</span>
<a href="#l14.177"></a><span id="l14.177">     else</span>
<a href="#l14.178"></a><span id="l14.178">       return PL_strdup(header);</span>
<a href="#l14.179"></a><span id="l14.179">   }</span>
<a href="#l14.180"></a><span id="l14.180"> </span>
<a href="#l14.181"></a><span id="l14.181">   nsAutoCString encodedString;</span>
<a href="#l14.182"></a><span id="l14.182">   nsresult res;</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;res);</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; converter =</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+      do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;res);</span>
<a href="#l14.186"></a><span id="l14.186">   if (NS_SUCCEEDED(res) &amp;&amp; nullptr != converter) {</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-    res = converter-&gt;EncodeMimePartIIStr_UTF8(nsDependentCString(header),</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-      structured, fieldnamelen,</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-      nsIMimeConverter::MIME_ENCODED_WORD_SIZE, encodedString);</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+    res = converter-&gt;EncodeMimePartIIStr_UTF8(</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+        nsDependentCString(header), structured, fieldnamelen,</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+        nsIMimeConverter::MIME_ENCODED_WORD_SIZE, encodedString);</span>
<a href="#l14.193"></a><span id="l14.193">   }</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">   return NS_SUCCEEDED(res) ? PL_strdup(encodedString.get()) : nullptr;</span>
<a href="#l14.196"></a><span id="l14.196"> }</span>
<a href="#l14.197"></a><span id="l14.197"> </span>
<a href="#l14.198"></a><span id="l14.198"> // Return True if a charset is stateful (e.g. JIS).</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-bool nsMsgI18Nstateful_charset(const char *charset)</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-{</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-  //TODO: use charset manager's service</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+bool nsMsgI18Nstateful_charset(const char* charset) {</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+  // TODO: use charset manager's service</span>
<a href="#l14.204"></a><span id="l14.204">   return (PL_strcasecmp(charset, &quot;ISO-2022-JP&quot;) == 0);</span>
<a href="#l14.205"></a><span id="l14.205"> }</span>
<a href="#l14.206"></a><span id="l14.206"> </span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-bool nsMsgI18Nmultibyte_charset(const char *charset)</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-{</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+bool nsMsgI18Nmultibyte_charset(const char* charset) {</span>
<a href="#l14.210"></a><span id="l14.210">   nsresult res;</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-  nsCOMPtr &lt;nsICharsetConverterManager&gt; ccm = do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;res);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+  nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+      do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;res);</span>
<a href="#l14.214"></a><span id="l14.214">   bool result = false;</span>
<a href="#l14.215"></a><span id="l14.215"> </span>
<a href="#l14.216"></a><span id="l14.216">   if (NS_SUCCEEDED(res)) {</span>
<a href="#l14.217"></a><span id="l14.217">     nsAutoString charsetData;</span>
<a href="#l14.218"></a><span id="l14.218">     res = ccm-&gt;GetCharsetData(charset, u&quot;.isMultibyte&quot;, charsetData);</span>
<a href="#l14.219"></a><span id="l14.219">     if (NS_SUCCEEDED(res)) {</span>
<a href="#l14.220"></a><span id="l14.220">       result = charsetData.LowerCaseEqualsLiteral(&quot;true&quot;);</span>
<a href="#l14.221"></a><span id="l14.221">     }</span>
<a href="#l14.222"></a><span id="l14.222">   }</span>
<a href="#l14.223"></a><span id="l14.223"> </span>
<a href="#l14.224"></a><span id="l14.224">   return result;</span>
<a href="#l14.225"></a><span id="l14.225"> }</span>
<a href="#l14.226"></a><span id="l14.226"> </span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">-bool nsMsgI18Ncheck_data_in_charset_range(const char *charset, const char16_t* inString)</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-{</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-  if (!charset || !*charset || !inString || !*inString)</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-    return true;</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+bool nsMsgI18Ncheck_data_in_charset_range(const char* charset,</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+                                          const char16_t* inString) {</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  if (!charset || !*charset || !inString || !*inString) return true;</span>
<a href="#l14.234"></a><span id="l14.234"> </span>
<a href="#l14.235"></a><span id="l14.235">   bool res = true;</span>
<a href="#l14.236"></a><span id="l14.236"> </span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-  auto encoding = mozilla::Encoding::ForLabelNoReplacement(nsDependentCString(charset));</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-  if (!encoding)</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-    return false;</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+  auto encoding =</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+      mozilla::Encoding::ForLabelNoReplacement(nsDependentCString(charset));</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+  if (!encoding) return false;</span>
<a href="#l14.243"></a><span id="l14.243">   auto encoder = encoding-&gt;NewEncoder();</span>
<a href="#l14.244"></a><span id="l14.244"> </span>
<a href="#l14.245"></a><span id="l14.245">   uint8_t buffer[512];</span>
<a href="#l14.246"></a><span id="l14.246">   auto src = mozilla::MakeStringSpan(inString);</span>
<a href="#l14.247"></a><span id="l14.247">   auto dst = mozilla::MakeSpan(buffer);</span>
<a href="#l14.248"></a><span id="l14.248">   while (true) {</span>
<a href="#l14.249"></a><span id="l14.249">     uint32_t result;</span>
<a href="#l14.250"></a><span id="l14.250">     size_t read;</span>
<a href="#l14.251"></a><span id="l14.251">     size_t written;</span>
<a href="#l14.252"></a><span id="l14.252">     mozilla::Tie(result, read, written) =</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-      encoder-&gt;EncodeFromUTF16WithoutReplacement(src, dst, false);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+        encoder-&gt;EncodeFromUTF16WithoutReplacement(src, dst, false);</span>
<a href="#l14.255"></a><span id="l14.255">     if (result == mozilla::kInputEmpty) {</span>
<a href="#l14.256"></a><span id="l14.256">       // All converted successfully.</span>
<a href="#l14.257"></a><span id="l14.257">       break;</span>
<a href="#l14.258"></a><span id="l14.258">     } else if (result != mozilla::kOutputFull) {</span>
<a href="#l14.259"></a><span id="l14.259">       // Didn't use all the input but the output isn't full, hence</span>
<a href="#l14.260"></a><span id="l14.260">       // there was an unencodable character.</span>
<a href="#l14.261"></a><span id="l14.261">       res = false;</span>
<a href="#l14.262"></a><span id="l14.262">       break;</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineat">@@ -258,85 +254,77 @@ bool nsMsgI18Ncheck_data_in_charset_rang</span>
<a href="#l14.264"></a><span id="l14.264">     // dst = dst.From(written); // Just overwrite output since we don't need it.</span>
<a href="#l14.265"></a><span id="l14.265">   }</span>
<a href="#l14.266"></a><span id="l14.266"> </span>
<a href="#l14.267"></a><span id="l14.267">   return res;</span>
<a href="#l14.268"></a><span id="l14.268"> }</span>
<a href="#l14.269"></a><span id="l14.269"> </span>
<a href="#l14.270"></a><span id="l14.270"> // Simple parser to parse META charset.</span>
<a href="#l14.271"></a><span id="l14.271"> // It only supports the case when the description is within one line.</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-const char *</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-nsMsgI18NParseMetaCharset(nsIFile* file)</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-{</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-  static char charset[nsIMimeConverter::MAX_CHARSET_NAME_LENGTH+1];</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+const char* nsMsgI18NParseMetaCharset(nsIFile* file) {</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+  static char charset[nsIMimeConverter::MAX_CHARSET_NAME_LENGTH + 1];</span>
<a href="#l14.278"></a><span id="l14.278"> </span>
<a href="#l14.279"></a><span id="l14.279">   *charset = '\0';</span>
<a href="#l14.280"></a><span id="l14.280"> </span>
<a href="#l14.281"></a><span id="l14.281">   bool isDirectory = false;</span>
<a href="#l14.282"></a><span id="l14.282">   file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l14.283"></a><span id="l14.283">   if (isDirectory) {</span>
<a href="#l14.284"></a><span id="l14.284">     NS_ERROR(&quot;file is a directory&quot;);</span>
<a href="#l14.285"></a><span id="l14.285">     return charset;</span>
<a href="#l14.286"></a><span id="l14.286">   }</span>
<a href="#l14.287"></a><span id="l14.287"> </span>
<a href="#l14.288"></a><span id="l14.288">   nsresult rv;</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-  nsCOMPtr &lt;nsIFileInputStream&gt; fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+  nsCOMPtr&lt;nsIFileInputStream&gt; fileStream =</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+      do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l14.292"></a><span id="l14.292">   NS_ENSURE_SUCCESS(rv, charset);</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294">   rv = fileStream-&gt;Init(file, PR_RDONLY, 0664, false);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-  nsCOMPtr &lt;nsILineInputStream&gt; lineStream = do_QueryInterface(fileStream, &amp;rv);</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineStream = do_QueryInterface(fileStream, &amp;rv);</span>
<a href="#l14.297"></a><span id="l14.297"> </span>
<a href="#l14.298"></a><span id="l14.298">   nsCString curLine;</span>
<a href="#l14.299"></a><span id="l14.299">   bool more = true;</span>
<a href="#l14.300"></a><span id="l14.300">   while (NS_SUCCEEDED(rv) &amp;&amp; more) {</span>
<a href="#l14.301"></a><span id="l14.301">     rv = lineStream-&gt;ReadLine(curLine, &amp;more);</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-    if (curLine.IsEmpty())</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-      continue;</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+    if (curLine.IsEmpty()) continue;</span>
<a href="#l14.305"></a><span id="l14.305"> </span>
<a href="#l14.306"></a><span id="l14.306">     ToUpperCase(curLine);</span>
<a href="#l14.307"></a><span id="l14.307"> </span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-    if (curLine.Find(&quot;/HEAD&quot;) != -1)</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-      break;</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+    if (curLine.Find(&quot;/HEAD&quot;) != -1) break;</span>
<a href="#l14.311"></a><span id="l14.311"> </span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-    if (curLine.Find(&quot;META&quot;) != -1 &amp;&amp;</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-        curLine.Find(&quot;HTTP-EQUIV&quot;) != -1 &amp;&amp;</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-        curLine.Find(&quot;CONTENT-TYPE&quot;) != -1 &amp;&amp;</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-        curLine.Find(&quot;CHARSET&quot;) != -1) {</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-      char *cp = (char *) PL_strchr(PL_strstr(curLine.get(), &quot;CHARSET&quot;), '=');</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-      char *token = nullptr;</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-      if (cp)</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-      {</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-        char *newStr = cp + 1;</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+    if (curLine.Find(&quot;META&quot;) != -1 &amp;&amp; curLine.Find(&quot;HTTP-EQUIV&quot;) != -1 &amp;&amp;</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+        curLine.Find(&quot;CONTENT-TYPE&quot;) != -1 &amp;&amp; curLine.Find(&quot;CHARSET&quot;) != -1) {</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+      char* cp = (char*)PL_strchr(PL_strstr(curLine.get(), &quot;CHARSET&quot;), '=');</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+      char* token = nullptr;</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+      if (cp) {</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+        char* newStr = cp + 1;</span>
<a href="#l14.327"></a><span id="l14.327">         token = NS_strtok(&quot; \&quot;\'&quot;, &amp;newStr);</span>
<a href="#l14.328"></a><span id="l14.328">       }</span>
<a href="#l14.329"></a><span id="l14.329">       if (token) {</span>
<a href="#l14.330"></a><span id="l14.330">         PL_strncpy(charset, token, sizeof(charset));</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-        charset[sizeof(charset)-1] = '\0';</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+        charset[sizeof(charset) - 1] = '\0';</span>
<a href="#l14.333"></a><span id="l14.333"> </span>
<a href="#l14.334"></a><span id="l14.334">         // this function cannot parse a file if it is really</span>
<a href="#l14.335"></a><span id="l14.335">         // encoded by one of the following charsets</span>
<a href="#l14.336"></a><span id="l14.336">         // so we can say that the charset label must be incorrect for</span>
<a href="#l14.337"></a><span id="l14.337">         // the .html if we actually see those charsets parsed</span>
<a href="#l14.338"></a><span id="l14.338">         // and we should ignore them</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-        if (!PL_strncasecmp(&quot;UTF-16&quot;, charset, sizeof(&quot;UTF-16&quot;)-1) ||</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-            !PL_strncasecmp(&quot;UTF-32&quot;, charset, sizeof(&quot;UTF-32&quot;)-1))</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+        if (!PL_strncasecmp(&quot;UTF-16&quot;, charset, sizeof(&quot;UTF-16&quot;) - 1) ||</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+            !PL_strncasecmp(&quot;UTF-32&quot;, charset, sizeof(&quot;UTF-32&quot;) - 1))</span>
<a href="#l14.343"></a><span id="l14.343">           charset[0] = '\0';</span>
<a href="#l14.344"></a><span id="l14.344"> </span>
<a href="#l14.345"></a><span id="l14.345">         break;</span>
<a href="#l14.346"></a><span id="l14.346">       }</span>
<a href="#l14.347"></a><span id="l14.347">     }</span>
<a href="#l14.348"></a><span id="l14.348">   }</span>
<a href="#l14.349"></a><span id="l14.349"> </span>
<a href="#l14.350"></a><span id="l14.350">   return charset;</span>
<a href="#l14.351"></a><span id="l14.351"> }</span>
<a href="#l14.352"></a><span id="l14.352"> </span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-nsresult nsMsgI18NShrinkUTF8Str(const nsCString &amp;inString,</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineminus">-                                uint32_t aMaxLength,</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-                                nsACString &amp;outString)</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineminus">-{</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+nsresult nsMsgI18NShrinkUTF8Str(const nsCString&amp; inString, uint32_t aMaxLength,</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+                                nsACString&amp; outString) {</span>
<a href="#l14.359"></a><span id="l14.359">   if (inString.IsEmpty()) {</span>
<a href="#l14.360"></a><span id="l14.360">     outString.Truncate();</span>
<a href="#l14.361"></a><span id="l14.361">     return NS_OK;</span>
<a href="#l14.362"></a><span id="l14.362">   }</span>
<a href="#l14.363"></a><span id="l14.363">   if (inString.Length() &lt; aMaxLength) {</span>
<a href="#l14.364"></a><span id="l14.364">     outString.Assign(inString);</span>
<a href="#l14.365"></a><span id="l14.365">     return NS_OK;</span>
<a href="#l14.366"></a><span id="l14.366">   }</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineat">@@ -344,68 +332,61 @@ nsresult nsMsgI18NShrinkUTF8Str(const ns</span>
<a href="#l14.368"></a><span id="l14.368">   const char* start = inString.get();</span>
<a href="#l14.369"></a><span id="l14.369">   const char* end = start + inString.Length();</span>
<a href="#l14.370"></a><span id="l14.370">   const char* last = start + aMaxLength;</span>
<a href="#l14.371"></a><span id="l14.371">   const char* cur = start;</span>
<a href="#l14.372"></a><span id="l14.372">   const char* prev = nullptr;</span>
<a href="#l14.373"></a><span id="l14.373">   bool err = false;</span>
<a href="#l14.374"></a><span id="l14.374">   while (cur &lt; last) {</span>
<a href="#l14.375"></a><span id="l14.375">     prev = cur;</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-    if (!UTF8CharEnumerator::NextChar(&amp;cur, end, &amp;err) || err)</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-      break;</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+    if (!UTF8CharEnumerator::NextChar(&amp;cur, end, &amp;err) || err) break;</span>
<a href="#l14.379"></a><span id="l14.379">   }</span>
<a href="#l14.380"></a><span id="l14.380">   if (!prev || err) {</span>
<a href="#l14.381"></a><span id="l14.381">     outString.Truncate();</span>
<a href="#l14.382"></a><span id="l14.382">     return NS_OK;</span>
<a href="#l14.383"></a><span id="l14.383">   }</span>
<a href="#l14.384"></a><span id="l14.384">   uint32_t len = prev - start;</span>
<a href="#l14.385"></a><span id="l14.385">   outString.Assign(Substring(inString, 0, len));</span>
<a href="#l14.386"></a><span id="l14.386">   return NS_OK;</span>
<a href="#l14.387"></a><span id="l14.387"> }</span>
<a href="#l14.388"></a><span id="l14.388"> </span>
<a href="#l14.389"></a><span id="l14.389"> void nsMsgI18NConvertRawBytesToUTF16(const nsCString&amp; inString,</span>
<a href="#l14.390"></a><span id="l14.390">                                      const nsACString&amp; charset,</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-                                     nsAString&amp; outString)</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-{</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineminus">-  if (MsgIsUTF8(inString))</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineminus">-  {</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+                                     nsAString&amp; outString) {</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+  if (MsgIsUTF8(inString)) {</span>
<a href="#l14.397"></a><span id="l14.397">     CopyUTF8toUTF16(inString, outString);</span>
<a href="#l14.398"></a><span id="l14.398">     return;</span>
<a href="#l14.399"></a><span id="l14.399">   }</span>
<a href="#l14.400"></a><span id="l14.400"> </span>
<a href="#l14.401"></a><span id="l14.401">   nsresult rv = nsMsgI18NConvertToUnicode(charset, inString, outString);</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-    return;</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return;</span>
<a href="#l14.405"></a><span id="l14.405"> </span>
<a href="#l14.406"></a><span id="l14.406">   const char* cur = inString.BeginReading();</span>
<a href="#l14.407"></a><span id="l14.407">   const char* end = inString.EndReading();</span>
<a href="#l14.408"></a><span id="l14.408">   outString.Truncate();</span>
<a href="#l14.409"></a><span id="l14.409">   while (cur &lt; end) {</span>
<a href="#l14.410"></a><span id="l14.410">     char c = *cur++;</span>
<a href="#l14.411"></a><span id="l14.411">     if (c &amp; char(0x80))</span>
<a href="#l14.412"></a><span id="l14.412">       outString.Append(UCS2_REPLACEMENT_CHAR);</span>
<a href="#l14.413"></a><span id="l14.413">     else</span>
<a href="#l14.414"></a><span id="l14.414">       outString.Append(c);</span>
<a href="#l14.415"></a><span id="l14.415">   }</span>
<a href="#l14.416"></a><span id="l14.416"> }</span>
<a href="#l14.417"></a><span id="l14.417"> </span>
<a href="#l14.418"></a><span id="l14.418"> void nsMsgI18NConvertRawBytesToUTF8(const nsCString&amp; inString,</span>
<a href="#l14.419"></a><span id="l14.419">                                     const nsACString&amp; charset,</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-                                    nsACString&amp; outString)</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-{</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineminus">-  if (MsgIsUTF8(inString))</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-  {</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+                                    nsACString&amp; outString) {</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+  if (MsgIsUTF8(inString)) {</span>
<a href="#l14.426"></a><span id="l14.426">     outString.Assign(inString);</span>
<a href="#l14.427"></a><span id="l14.427">     return;</span>
<a href="#l14.428"></a><span id="l14.428">   }</span>
<a href="#l14.429"></a><span id="l14.429"> </span>
<a href="#l14.430"></a><span id="l14.430">   nsAutoString utf16Text;</span>
<a href="#l14.431"></a><span id="l14.431">   nsresult rv = nsMsgI18NConvertToUnicode(charset, inString, utf16Text);</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineminus">-  {</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l14.435"></a><span id="l14.435">     CopyUTF16toUTF8(utf16Text, outString);</span>
<a href="#l14.436"></a><span id="l14.436">     return;</span>
<a href="#l14.437"></a><span id="l14.437">   }</span>
<a href="#l14.438"></a><span id="l14.438"> </span>
<a href="#l14.439"></a><span id="l14.439">   // EF BF BD (UTF-8 encoding of U+FFFD)</span>
<a href="#l14.440"></a><span id="l14.440">   NS_NAMED_LITERAL_CSTRING(utf8ReplacementChar, &quot;\357\277\275&quot;);</span>
<a href="#l14.441"></a><span id="l14.441">   const char* cur = inString.BeginReading();</span>
<a href="#l14.442"></a><span id="l14.442">   const char* end = inString.EndReading();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/util/nsMsgI18N.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgI18N.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -10,54 +10,63 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsString.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> class nsIFile;</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> /**</span>
<a href="#l15.9"></a><span id="l15.9">  * Encode an input string into RFC 2047 form.</span>
<a href="#l15.10"></a><span id="l15.10">  *</span>
<a href="#l15.11"></a><span id="l15.11">  * @param header       [IN] A header to encode.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">- * @param structured   [IN] Specify the header is structured or non-structured field (See RFC-822).</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * @param structured   [IN] Specify the header is structured or non-structured</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ *                          field (See RFC-822).</span>
<a href="#l15.15"></a><span id="l15.15">  * @param charset      [IN] Charset name to convert.</span>
<a href="#l15.16"></a><span id="l15.16">  * @param fieldnamelen [IN] Header field name length. (e.g. &quot;From: &quot; -&gt; 6)</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">- * @param usemime      [IN] If false then apply charset conversion only no MIME encoding.</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * @param usemime      [IN] If false then apply charset conversion only no MIME</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *                          encoding.</span>
<a href="#l15.20"></a><span id="l15.20">  * @return             Encoded buffer (in C string) or NULL in case of error.</span>
<a href="#l15.21"></a><span id="l15.21">  */</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-NS_MSG_BASE char      *nsMsgI18NEncodeMimePartIIStr(const char *header, bool structured, const char *charset, int32_t fieldnamelen, bool usemime);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+NS_MSG_BASE char* nsMsgI18NEncodeMimePartIIStr(const char* header,</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+                                               bool structured,</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+                                               const char* charset,</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+                                               int32_t fieldnamelen,</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+                                               bool usemime);</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29"> /**</span>
<a href="#l15.30"></a><span id="l15.30">  * Check if given charset is stateful (e.g. ISO-2022-JP).</span>
<a href="#l15.31"></a><span id="l15.31">  *</span>
<a href="#l15.32"></a><span id="l15.32">  * @param charset     [IN] Charset name.</span>
<a href="#l15.33"></a><span id="l15.33">  * @return            True if stateful</span>
<a href="#l15.34"></a><span id="l15.34">  */</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-NS_MSG_BASE bool      nsMsgI18Nstateful_charset(const char *charset);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+NS_MSG_BASE bool nsMsgI18Nstateful_charset(const char* charset);</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38"> /**</span>
<a href="#l15.39"></a><span id="l15.39">  * Check if given charset is multibye (e.g. Shift_JIS, Big5).</span>
<a href="#l15.40"></a><span id="l15.40">  *</span>
<a href="#l15.41"></a><span id="l15.41">  * @param charset     [IN] Charset name.</span>
<a href="#l15.42"></a><span id="l15.42">  * @return            True if multibyte</span>
<a href="#l15.43"></a><span id="l15.43">  */</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-NS_MSG_BASE bool nsMsgI18Nmultibyte_charset(const char *charset);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+NS_MSG_BASE bool nsMsgI18Nmultibyte_charset(const char* charset);</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47"> /**</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">- * Check the input (unicode) string is in a range of the given charset after the conversion.</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">- * Note, do not use this for large string (e.g. message body) since this actually applies the conversion to the buffer.</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+ * Check the input (unicode) string is in a range of the given charset after the</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+ * conversion. Note, do not use this for large string (e.g. message body) since</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+ * this actually applies the conversion to the buffer.</span>
<a href="#l15.53"></a><span id="l15.53">  *</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">- * @param charset     [IN] Charset to be converted.</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">- * @param inString    [IN] Input unicode string to be examined.</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">- * @param fallbackCharset [OUT]</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">- *                         null if fallback charset is not needed.</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">- *                         Otherwise, a fallback charset name may be set if that was used for the conversion.</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">- *                         Caller is responsible for freeing the memory.</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">- * @return            True if the string can be converted within the charset range.</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">- *                    False if one or more characters cannot be converted to the target charset.</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+ * @param charset  [IN] Charset to be converted.</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+ * @param inString [IN] Input unicode string to be examined.</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+ * @param fallbackCharset [OUT] null if fallback charset is not needed.</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+ *                      Otherwise, a fallback charset name may be set if that</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+ *                      was used for the conversion.</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+ *                      Caller is responsible for freeing the memory.</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+ * @return         True if the string can be converted within the charset range.</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+ *                 False if one or more characters cannot be converted to the</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+ *                 target charset.</span>
<a href="#l15.71"></a><span id="l15.71">  */</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-NS_MSG_BASE bool      nsMsgI18Ncheck_data_in_charset_range(const char *charset, const char16_t* inString);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+NS_MSG_BASE bool nsMsgI18Ncheck_data_in_charset_range(const char* charset,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                                                      const char16_t* inString);</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76"> /**</span>
<a href="#l15.77"></a><span id="l15.77">  * Return charset name of file system (OS dependent).</span>
<a href="#l15.78"></a><span id="l15.78">  *</span>
<a href="#l15.79"></a><span id="l15.79">  * @return            File system charset name.</span>
<a href="#l15.80"></a><span id="l15.80">  */</span>
<a href="#l15.81"></a><span id="l15.81"> NS_MSG_BASE const nsACString&amp; nsMsgI18NFileSystemCharset(void);</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83" class="difflineat">@@ -76,21 +85,19 @@ NS_MSG_BASE void nsMsgI18NTextFileCharse</span>
<a href="#l15.84"></a><span id="l15.84">  * @param outString   [OUT] Converted output string.</span>
<a href="#l15.85"></a><span id="l15.85">  * @param aReportUencNoMapping [IN] Set encoder to report (instead of using</span>
<a href="#l15.86"></a><span id="l15.86">  *                                  replacement char on errors). Set to true</span>
<a href="#l15.87"></a><span id="l15.87">  *                                  to receive NS_ERROR_UENC_NOMAPPING when</span>
<a href="#l15.88"></a><span id="l15.88">  *                                  that happens. Note that</span>
<a href="#l15.89"></a><span id="l15.89">  *                                  NS_ERROR_UENC_NOMAPPING is a success code!</span>
<a href="#l15.90"></a><span id="l15.90">  * @return            nsresult.</span>
<a href="#l15.91"></a><span id="l15.91">  */</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-NS_MSG_BASE nsresult nsMsgI18NConvertFromUnicode(const nsACString&amp; aCharset,</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-                                                 const nsAString&amp; inString,</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-                                                 nsACString&amp; outString,</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-                                                 bool reportUencNoMapping =</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-                                                        false);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+NS_MSG_BASE nsresult nsMsgI18NConvertFromUnicode(</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+    const nsACString&amp; aCharset, const nsAString&amp; inString,</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+    nsACString&amp; outString, bool reportUencNoMapping = false);</span>
<a href="#l15.100"></a><span id="l15.100"> /**</span>
<a href="#l15.101"></a><span id="l15.101">  * Convert from charset to unicode.</span>
<a href="#l15.102"></a><span id="l15.102">  *</span>
<a href="#l15.103"></a><span id="l15.103">  * @param charset     [IN] Charset name.</span>
<a href="#l15.104"></a><span id="l15.104">  * @param inString    [IN] Input string to convert.</span>
<a href="#l15.105"></a><span id="l15.105">  * @param outString   [OUT] Output unicode string.</span>
<a href="#l15.106"></a><span id="l15.106">  * @return            nsresult.</span>
<a href="#l15.107"></a><span id="l15.107">  */</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineat">@@ -98,30 +105,30 @@ NS_MSG_BASE nsresult nsMsgI18NConvertToU</span>
<a href="#l15.109"></a><span id="l15.109">                                                const nsACString&amp; inString,</span>
<a href="#l15.110"></a><span id="l15.110">                                                nsAString&amp; outString);</span>
<a href="#l15.111"></a><span id="l15.111"> /**</span>
<a href="#l15.112"></a><span id="l15.112">  * Parse for META charset.</span>
<a href="#l15.113"></a><span id="l15.113">  *</span>
<a href="#l15.114"></a><span id="l15.114">  * @param file    [IN] A nsIFile.</span>
<a href="#l15.115"></a><span id="l15.115">  * @return            A charset name or empty string if not found.</span>
<a href="#l15.116"></a><span id="l15.116">  */</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-NS_MSG_BASE const char *nsMsgI18NParseMetaCharset(nsIFile* file);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+NS_MSG_BASE const char* nsMsgI18NParseMetaCharset(nsIFile* file);</span>
<a href="#l15.119"></a><span id="l15.119"> </span>
<a href="#l15.120"></a><span id="l15.120"> /**</span>
<a href="#l15.121"></a><span id="l15.121">  * Shrink the aStr to aMaxLength bytes. Note that this doesn't check whether</span>
<a href="#l15.122"></a><span id="l15.122">  * the aUTF8Str is valid UTF-8 string.</span>
<a href="#l15.123"></a><span id="l15.123">  *</span>
<a href="#l15.124"></a><span id="l15.124">  * @param inString   [IN] Input UTF-8 string (it must be valid UTF-8 string)</span>
<a href="#l15.125"></a><span id="l15.125">  * @param aMaxLength [IN] Shrink to this length (it means bytes)</span>
<a href="#l15.126"></a><span id="l15.126">  * @param outString  [OUT] Shrunken UTF-8 string</span>
<a href="#l15.127"></a><span id="l15.127">  * @return           nsresult</span>
<a href="#l15.128"></a><span id="l15.128">  */</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-NS_MSG_BASE nsresult nsMsgI18NShrinkUTF8Str(const nsCString &amp;inString,</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+NS_MSG_BASE nsresult nsMsgI18NShrinkUTF8Str(const nsCString&amp; inString,</span>
<a href="#l15.131"></a><span id="l15.131">                                             uint32_t aMaxLength,</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-                                            nsACString &amp;outString);</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+                                            nsACString&amp; outString);</span>
<a href="#l15.134"></a><span id="l15.134"> </span>
<a href="#l15.135"></a><span id="l15.135"> /*</span>
<a href="#l15.136"></a><span id="l15.136">  * Convert raw bytes in header to UTF-16</span>
<a href="#l15.137"></a><span id="l15.137">  *</span>
<a href="#l15.138"></a><span id="l15.138">  * @param inString   [IN] Input raw octets</span>
<a href="#l15.139"></a><span id="l15.139">  * @param outString  [OUT] Output UTF-16 string</span>
<a href="#l15.140"></a><span id="l15.140">  */</span>
<a href="#l15.141"></a><span id="l15.141"> NS_MSG_BASE void nsMsgI18NConvertRawBytesToUTF16(const nsCString&amp; inString,</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineat">@@ -137,12 +144,12 @@ NS_MSG_BASE void nsMsgI18NConvertRawByte</span>
<a href="#l15.143"></a><span id="l15.143"> NS_MSG_BASE void nsMsgI18NConvertRawBytesToUTF8(const nsCString&amp; inString,</span>
<a href="#l15.144"></a><span id="l15.144">                                                 const nsACString&amp; charset,</span>
<a href="#l15.145"></a><span id="l15.145">                                                 nsACString&amp; outString);</span>
<a href="#l15.146"></a><span id="l15.146"> </span>
<a href="#l15.147"></a><span id="l15.147"> // Decode UTF-7 to UTF-16. No encoding supported.</span>
<a href="#l15.148"></a><span id="l15.148"> NS_MSG_BASE nsresult CopyUTF7toUTF16(const nsACString&amp; aSrc, nsAString&amp; aDest);</span>
<a href="#l15.149"></a><span id="l15.149"> </span>
<a href="#l15.150"></a><span id="l15.150"> // Convert between UTF-16 and modified UTF-7 used for IMAP.</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-NS_MSG_BASE nsresult CopyUTF16toMUTF7(const nsAString &amp;aSrc, nsACString&amp; aDest);</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+NS_MSG_BASE nsresult CopyUTF16toMUTF7(const nsAString&amp; aSrc, nsACString&amp; aDest);</span>
<a href="#l15.153"></a><span id="l15.153"> NS_MSG_BASE nsresult CopyMUTF7toUTF16(const nsACString&amp; aSrc, nsAString&amp; aDest);</span>
<a href="#l15.154"></a><span id="l15.154"> </span>
<a href="#l15.155"></a><span id="l15.155"> #endif /* _nsMsgI18N_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIdentity.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-#include &quot;msgCore.h&quot; // for pre-compiled headers</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsMsgIdentity.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;nsString.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineat">@@ -16,137 +16,126 @@</span>
<a href="#l16.20"></a><span id="l16.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21"> #include &quot;prprf.h&quot;</span>
<a href="#l16.22"></a><span id="l16.22"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l16.23"></a><span id="l16.23"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l16.24"></a><span id="l16.24"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.25"></a><span id="l16.25"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l16.26"></a><span id="l16.26"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-</span>
<a href="#l16.29"></a><span id="l16.29"> #define REL_FILE_PREF_SUFFIX &quot;-rel&quot;</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgIdentity,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                   nsIMsgIdentity)</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgIdentity, nsIMsgIdentity)</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35"> /*</span>
<a href="#l16.36"></a><span id="l16.36">  * accessors for pulling values directly out of preferences</span>
<a href="#l16.37"></a><span id="l16.37">  * instead of member variables, etc</span>
<a href="#l16.38"></a><span id="l16.38">  */</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40"> NS_IMETHODIMP</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-nsMsgIdentity::GetKey(nsACString&amp; aKey)</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-{</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+nsMsgIdentity::GetKey(nsACString &amp;aKey) {</span>
<a href="#l16.44"></a><span id="l16.44">   aKey = mKey;</span>
<a href="#l16.45"></a><span id="l16.45">   return NS_OK;</span>
<a href="#l16.46"></a><span id="l16.46"> }</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48"> NS_IMETHODIMP</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-nsMsgIdentity::SetKey(const nsACString&amp; identityKey)</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-{</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+nsMsgIdentity::SetKey(const nsACString &amp;identityKey) {</span>
<a href="#l16.52"></a><span id="l16.52">   mKey = identityKey;</span>
<a href="#l16.53"></a><span id="l16.53">   nsresult rv;</span>
<a href="#l16.54"></a><span id="l16.54">   nsCOMPtr&lt;nsIPrefService&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    return rv;</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59">   nsAutoCString branchName;</span>
<a href="#l16.60"></a><span id="l16.60">   branchName.AssignLiteral(&quot;mail.identity.&quot;);</span>
<a href="#l16.61"></a><span id="l16.61">   branchName += mKey;</span>
<a href="#l16.62"></a><span id="l16.62">   branchName.Append('.');</span>
<a href="#l16.63"></a><span id="l16.63">   rv = prefs-&gt;GetBranch(branchName.get(), getter_AddRefs(mPrefBranch));</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-    return rv;</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.67"></a><span id="l16.67"> </span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  rv = prefs-&gt;GetBranch(&quot;mail.identity.default.&quot;, getter_AddRefs(mDefPrefBranch));</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  rv = prefs-&gt;GetBranch(&quot;mail.identity.default.&quot;,</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+                        getter_AddRefs(mDefPrefBranch));</span>
<a href="#l16.71"></a><span id="l16.71">   return rv;</span>
<a href="#l16.72"></a><span id="l16.72"> }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-nsresult</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-nsMsgIdentity::GetIdentityName(nsAString&amp; idName)</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-{</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+nsresult nsMsgIdentity::GetIdentityName(nsAString &amp;idName) {</span>
<a href="#l16.78"></a><span id="l16.78">   idName.AssignLiteral(&quot;&quot;);</span>
<a href="#l16.79"></a><span id="l16.79">   // Try to use &quot;fullname &lt;email&gt;&quot; as the name.</span>
<a href="#l16.80"></a><span id="l16.80">   nsresult rv = GetFullAddress(idName);</span>
<a href="#l16.81"></a><span id="l16.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83">   // If a non-empty label exists, append it.</span>
<a href="#l16.84"></a><span id="l16.84">   nsString label;</span>
<a href="#l16.85"></a><span id="l16.85">   rv = GetLabel(label);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !label.IsEmpty())</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-  { // TODO: this should be localizable</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+      !label.IsEmpty()) {  // TODO: this should be localizable</span>
<a href="#l16.90"></a><span id="l16.90">     idName.AppendLiteral(&quot; (&quot;);</span>
<a href="#l16.91"></a><span id="l16.91">     idName.Append(label);</span>
<a href="#l16.92"></a><span id="l16.92">     idName.Append(')');</span>
<a href="#l16.93"></a><span id="l16.93">   }</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-  if (!idName.IsEmpty())</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  if (!idName.IsEmpty()) return NS_OK;</span>
<a href="#l16.98"></a><span id="l16.98"> </span>
<a href="#l16.99"></a><span id="l16.99">   // If we still found nothing to use, use our key.</span>
<a href="#l16.100"></a><span id="l16.100">   return ToString(idName);</span>
<a href="#l16.101"></a><span id="l16.101"> }</span>
<a href="#l16.102"></a><span id="l16.102"> </span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-nsresult</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-nsMsgIdentity::GetFullAddress(nsAString&amp; fullAddress)</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-{</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+nsresult nsMsgIdentity::GetFullAddress(nsAString &amp;fullAddress) {</span>
<a href="#l16.107"></a><span id="l16.107">   nsAutoString fullName;</span>
<a href="#l16.108"></a><span id="l16.108">   nsresult rv = GetFullName(fullName);</span>
<a href="#l16.109"></a><span id="l16.109">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.110"></a><span id="l16.110"> </span>
<a href="#l16.111"></a><span id="l16.111">   nsAutoCString email;</span>
<a href="#l16.112"></a><span id="l16.112">   rv = GetEmail(email);</span>
<a href="#l16.113"></a><span id="l16.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.114"></a><span id="l16.114"> </span>
<a href="#l16.115"></a><span id="l16.115">   if (fullName.IsEmpty() &amp;&amp; email.IsEmpty())</span>
<a href="#l16.116"></a><span id="l16.116">     fullAddress.Truncate();</span>
<a href="#l16.117"></a><span id="l16.117">   else</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-    mozilla::mailnews::MakeMimeAddress(fullName, NS_ConvertASCIItoUTF16(email), fullAddress);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+    mozilla::mailnews::MakeMimeAddress(fullName, NS_ConvertASCIItoUTF16(email),</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+                                       fullAddress);</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122">   return NS_OK;</span>
<a href="#l16.123"></a><span id="l16.123"> }</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125"> NS_IMETHODIMP</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-nsMsgIdentity::ToString(nsAString&amp; aResult)</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-{</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+nsMsgIdentity::ToString(nsAString &amp;aResult) {</span>
<a href="#l16.129"></a><span id="l16.129">   aResult.AssignLiteral(&quot;[nsIMsgIdentity: &quot;);</span>
<a href="#l16.130"></a><span id="l16.130">   aResult.Append(NS_ConvertASCIItoUTF16(mKey));</span>
<a href="#l16.131"></a><span id="l16.131">   aResult.Append(']');</span>
<a href="#l16.132"></a><span id="l16.132">   return NS_OK;</span>
<a href="#l16.133"></a><span id="l16.133"> }</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135"> /* Identity attribute accessors */</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137"> NS_IMETHODIMP</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-nsMsgIdentity::GetSignature(nsIFile **sig)</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-{</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+nsMsgIdentity::GetSignature(nsIFile **sig) {</span>
<a href="#l16.141"></a><span id="l16.141">   bool gotRelPref;</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-  nsresult rv = NS_GetPersistentFile(&quot;sig_file&quot; REL_FILE_PREF_SUFFIX, &quot;sig_file&quot;, nullptr, gotRelPref, sig, mPrefBranch);</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !gotRelPref)</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-  {</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-    rv = NS_SetPersistentFile(&quot;sig_file&quot; REL_FILE_PREF_SUFFIX, &quot;sig_file&quot;, *sig, mPrefBranch);</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+  nsresult rv =</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+      NS_GetPersistentFile(&quot;sig_file&quot; REL_FILE_PREF_SUFFIX, &quot;sig_file&quot;, nullptr,</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+                           gotRelPref, sig, mPrefBranch);</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !gotRelPref) {</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+    rv = NS_SetPersistentFile(&quot;sig_file&quot; REL_FILE_PREF_SUFFIX, &quot;sig_file&quot;, *sig,</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+                              mPrefBranch);</span>
<a href="#l16.152"></a><span id="l16.152">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to write signature file pref.&quot;);</span>
<a href="#l16.153"></a><span id="l16.153">   }</span>
<a href="#l16.154"></a><span id="l16.154">   return NS_OK;</span>
<a href="#l16.155"></a><span id="l16.155"> }</span>
<a href="#l16.156"></a><span id="l16.156"> </span>
<a href="#l16.157"></a><span id="l16.157"> NS_IMETHODIMP</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-nsMsgIdentity::SetSignature(nsIFile *sig)</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-{</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+nsMsgIdentity::SetSignature(nsIFile *sig) {</span>
<a href="#l16.161"></a><span id="l16.161">   nsresult rv = NS_OK;</span>
<a href="#l16.162"></a><span id="l16.162">   if (sig)</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-    rv = NS_SetPersistentFile(&quot;sig_file&quot; REL_FILE_PREF_SUFFIX, &quot;sig_file&quot;, sig, mPrefBranch);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+    rv = NS_SetPersistentFile(&quot;sig_file&quot; REL_FILE_PREF_SUFFIX, &quot;sig_file&quot;, sig,</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+                              mPrefBranch);</span>
<a href="#l16.166"></a><span id="l16.166">   return rv;</span>
<a href="#l16.167"></a><span id="l16.167"> }</span>
<a href="#l16.168"></a><span id="l16.168"> </span>
<a href="#l16.169"></a><span id="l16.169"> NS_IMETHODIMP</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-nsMsgIdentity::ClearAllValues()</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-{</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+nsMsgIdentity::ClearAllValues() {</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.176"></a><span id="l16.176"> </span>
<a href="#l16.177"></a><span id="l16.177">   return mPrefBranch-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l16.178"></a><span id="l16.178"> }</span>
<a href="#l16.179"></a><span id="l16.179"> </span>
<a href="#l16.180"></a><span id="l16.180"> NS_IMPL_IDPREF_STR(EscapedVCard, &quot;escapedVCard&quot;)</span>
<a href="#l16.181"></a><span id="l16.181"> NS_IMPL_IDPREF_STR(SmtpServerKey, &quot;smtpServer&quot;)</span>
<a href="#l16.182"></a><span id="l16.182"> NS_IMPL_IDPREF_WSTR(FullName, &quot;fullName&quot;)</span>
<a href="#l16.183"></a><span id="l16.183"> NS_IMPL_IDPREF_STR(Email, &quot;useremail&quot;)</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineat">@@ -160,469 +149,434 @@ NS_IMPL_IDPREF_WSTR(HtmlSigText, &quot;htmlSi</span>
<a href="#l16.185"></a><span id="l16.185"> NS_IMPL_IDPREF_BOOL(HtmlSigFormat, &quot;htmlSigFormat&quot;)</span>
<a href="#l16.186"></a><span id="l16.186"> </span>
<a href="#l16.187"></a><span id="l16.187"> NS_IMPL_IDPREF_BOOL(AutoQuote, &quot;auto_quote&quot;)</span>
<a href="#l16.188"></a><span id="l16.188"> NS_IMPL_IDPREF_INT(ReplyOnTop, &quot;reply_on_top&quot;)</span>
<a href="#l16.189"></a><span id="l16.189"> NS_IMPL_IDPREF_BOOL(SigBottom, &quot;sig_bottom&quot;)</span>
<a href="#l16.190"></a><span id="l16.190"> NS_IMPL_IDPREF_BOOL(SigOnForward, &quot;sig_on_fwd&quot;)</span>
<a href="#l16.191"></a><span id="l16.191"> NS_IMPL_IDPREF_BOOL(SigOnReply, &quot;sig_on_reply&quot;)</span>
<a href="#l16.192"></a><span id="l16.192"> </span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-NS_IMPL_IDPREF_INT(SignatureDate,&quot;sig_date&quot;)</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+NS_IMPL_IDPREF_INT(SignatureDate, &quot;sig_date&quot;)</span>
<a href="#l16.195"></a><span id="l16.195"> </span>
<a href="#l16.196"></a><span id="l16.196"> NS_IMPL_IDPREF_BOOL(DoFcc, &quot;fcc&quot;)</span>
<a href="#l16.197"></a><span id="l16.197"> </span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-NS_IMPL_FOLDERPREF_STR(FccFolder, &quot;fcc_folder&quot;, &quot;Sent&quot;, nsMsgFolderFlags::SentMail)</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+NS_IMPL_FOLDERPREF_STR(FccFolder, &quot;fcc_folder&quot;, &quot;Sent&quot;,</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+                       nsMsgFolderFlags::SentMail)</span>
<a href="#l16.201"></a><span id="l16.201"> NS_IMPL_IDPREF_STR(FccFolderPickerMode, &quot;fcc_folder_picker_mode&quot;)</span>
<a href="#l16.202"></a><span id="l16.202"> NS_IMPL_IDPREF_BOOL(FccReplyFollowsParent, &quot;fcc_reply_follows_parent&quot;)</span>
<a href="#l16.203"></a><span id="l16.203"> NS_IMPL_IDPREF_STR(DraftsFolderPickerMode, &quot;drafts_folder_picker_mode&quot;)</span>
<a href="#l16.204"></a><span id="l16.204"> NS_IMPL_IDPREF_STR(ArchivesFolderPickerMode, &quot;archives_folder_picker_mode&quot;)</span>
<a href="#l16.205"></a><span id="l16.205"> NS_IMPL_IDPREF_STR(TmplFolderPickerMode, &quot;tmpl_folder_picker_mode&quot;)</span>
<a href="#l16.206"></a><span id="l16.206"> </span>
<a href="#l16.207"></a><span id="l16.207"> NS_IMPL_IDPREF_BOOL(BccSelf, &quot;bcc_self&quot;)</span>
<a href="#l16.208"></a><span id="l16.208"> NS_IMPL_IDPREF_BOOL(BccOthers, &quot;bcc_other&quot;)</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-NS_IMPL_IDPREF_STR (BccList, &quot;bcc_other_list&quot;)</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+NS_IMPL_IDPREF_STR(BccList, &quot;bcc_other_list&quot;)</span>
<a href="#l16.211"></a><span id="l16.211"> </span>
<a href="#l16.212"></a><span id="l16.212"> NS_IMPL_IDPREF_BOOL(SuppressSigSep, &quot;suppress_signature_separator&quot;)</span>
<a href="#l16.213"></a><span id="l16.213"> </span>
<a href="#l16.214"></a><span id="l16.214"> NS_IMPL_IDPREF_BOOL(DoCc, &quot;doCc&quot;)</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-NS_IMPL_IDPREF_STR (DoCcList, &quot;doCcList&quot;)</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+NS_IMPL_IDPREF_STR(DoCcList, &quot;doCcList&quot;)</span>
<a href="#l16.217"></a><span id="l16.217"> </span>
<a href="#l16.218"></a><span id="l16.218"> NS_IMETHODIMP</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-nsMsgIdentity::GetDoBcc(bool *aValue)</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-{</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+nsMsgIdentity::GetDoBcc(bool *aValue) {</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.225"></a><span id="l16.225"> </span>
<a href="#l16.226"></a><span id="l16.226">   nsresult rv = mPrefBranch-&gt;GetBoolPref(&quot;doBcc&quot;, aValue);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-    return rv;</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l16.230"></a><span id="l16.230"> </span>
<a href="#l16.231"></a><span id="l16.231">   bool bccSelf = false;</span>
<a href="#l16.232"></a><span id="l16.232">   GetBccSelf(&amp;bccSelf);</span>
<a href="#l16.233"></a><span id="l16.233"> </span>
<a href="#l16.234"></a><span id="l16.234">   bool bccOthers = false;</span>
<a href="#l16.235"></a><span id="l16.235">   GetBccOthers(&amp;bccOthers);</span>
<a href="#l16.236"></a><span id="l16.236"> </span>
<a href="#l16.237"></a><span id="l16.237">   nsCString others;</span>
<a href="#l16.238"></a><span id="l16.238">   GetBccList(others);</span>
<a href="#l16.239"></a><span id="l16.239"> </span>
<a href="#l16.240"></a><span id="l16.240">   *aValue = bccSelf || (bccOthers &amp;&amp; !others.IsEmpty());</span>
<a href="#l16.241"></a><span id="l16.241"> </span>
<a href="#l16.242"></a><span id="l16.242">   return SetDoBcc(*aValue);</span>
<a href="#l16.243"></a><span id="l16.243"> }</span>
<a href="#l16.244"></a><span id="l16.244"> </span>
<a href="#l16.245"></a><span id="l16.245"> NS_IMETHODIMP</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-nsMsgIdentity::SetDoBcc(bool aValue)</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-{</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+nsMsgIdentity::SetDoBcc(bool aValue) {</span>
<a href="#l16.249"></a><span id="l16.249">   return SetBoolAttribute(&quot;doBcc&quot;, aValue);</span>
<a href="#l16.250"></a><span id="l16.250"> }</span>
<a href="#l16.251"></a><span id="l16.251"> </span>
<a href="#l16.252"></a><span id="l16.252"> NS_IMETHODIMP</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-nsMsgIdentity::GetDoBccList(nsACString&amp; aValue)</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-{</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+nsMsgIdentity::GetDoBccList(nsACString &amp;aValue) {</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.259"></a><span id="l16.259"> </span>
<a href="#l16.260"></a><span id="l16.260">   nsCString val;</span>
<a href="#l16.261"></a><span id="l16.261">   nsresult rv = mPrefBranch-&gt;GetCharPref(&quot;doBccList&quot;, val);</span>
<a href="#l16.262"></a><span id="l16.262">   aValue = val;</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-    return rv;</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l16.266"></a><span id="l16.266"> </span>
<a href="#l16.267"></a><span id="l16.267">   bool bccSelf = false;</span>
<a href="#l16.268"></a><span id="l16.268">   rv = GetBccSelf(&amp;bccSelf);</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.271"></a><span id="l16.271"> </span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-  if (bccSelf)</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-    GetEmail(aValue);</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+  if (bccSelf) GetEmail(aValue);</span>
<a href="#l16.275"></a><span id="l16.275"> </span>
<a href="#l16.276"></a><span id="l16.276">   bool bccOthers = false;</span>
<a href="#l16.277"></a><span id="l16.277">   rv = GetBccOthers(&amp;bccOthers);</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.280"></a><span id="l16.280"> </span>
<a href="#l16.281"></a><span id="l16.281">   nsCString others;</span>
<a href="#l16.282"></a><span id="l16.282">   rv = GetBccList(others);</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.285"></a><span id="l16.285"> </span>
<a href="#l16.286"></a><span id="l16.286">   if (bccOthers &amp;&amp; !others.IsEmpty()) {</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineminus">-    if (bccSelf)</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-      aValue.Append(',');</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+    if (bccSelf) aValue.Append(',');</span>
<a href="#l16.290"></a><span id="l16.290">     aValue.Append(others);</span>
<a href="#l16.291"></a><span id="l16.291">   }</span>
<a href="#l16.292"></a><span id="l16.292"> </span>
<a href="#l16.293"></a><span id="l16.293">   return SetDoBccList(aValue);</span>
<a href="#l16.294"></a><span id="l16.294"> }</span>
<a href="#l16.295"></a><span id="l16.295"> </span>
<a href="#l16.296"></a><span id="l16.296"> NS_IMETHODIMP</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-nsMsgIdentity::SetDoBccList(const nsACString&amp; aValue)</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-{</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+nsMsgIdentity::SetDoBccList(const nsACString &amp;aValue) {</span>
<a href="#l16.300"></a><span id="l16.300">   return SetCharAttribute(&quot;doBccList&quot;, aValue);</span>
<a href="#l16.301"></a><span id="l16.301"> }</span>
<a href="#l16.302"></a><span id="l16.302"> </span>
<a href="#l16.303"></a><span id="l16.303" class="difflineminus">-NS_IMPL_FOLDERPREF_STR(DraftFolder, &quot;draft_folder&quot;, &quot;Drafts&quot;, nsMsgFolderFlags::Drafts)</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineminus">-NS_IMPL_FOLDERPREF_STR(ArchiveFolder, &quot;archive_folder&quot;, &quot;Archives&quot;, nsMsgFolderFlags::Archive)</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineminus">-NS_IMPL_FOLDERPREF_STR(StationeryFolder, &quot;stationery_folder&quot;, &quot;Templates&quot;, nsMsgFolderFlags::Templates)</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+NS_IMPL_FOLDERPREF_STR(DraftFolder, &quot;draft_folder&quot;, &quot;Drafts&quot;,</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+                       nsMsgFolderFlags::Drafts)</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+NS_IMPL_FOLDERPREF_STR(ArchiveFolder, &quot;archive_folder&quot;, &quot;Archives&quot;,</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+                       nsMsgFolderFlags::Archive)</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+NS_IMPL_FOLDERPREF_STR(StationeryFolder, &quot;stationery_folder&quot;, &quot;Templates&quot;,</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+                       nsMsgFolderFlags::Templates)</span>
<a href="#l16.312"></a><span id="l16.312"> </span>
<a href="#l16.313"></a><span id="l16.313"> NS_IMPL_IDPREF_BOOL(ArchiveEnabled, &quot;archive_enabled&quot;)</span>
<a href="#l16.314"></a><span id="l16.314"> NS_IMPL_IDPREF_INT(ArchiveGranularity, &quot;archive_granularity&quot;)</span>
<a href="#l16.315"></a><span id="l16.315"> NS_IMPL_IDPREF_BOOL(ArchiveKeepFolderStructure, &quot;archive_keep_folder_structure&quot;)</span>
<a href="#l16.316"></a><span id="l16.316"> </span>
<a href="#l16.317"></a><span id="l16.317"> NS_IMPL_IDPREF_BOOL(ShowSaveMsgDlg, &quot;showSaveMsgDlg&quot;)</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-NS_IMPL_IDPREF_STR (DirectoryServer, &quot;directoryServer&quot;)</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+NS_IMPL_IDPREF_STR(DirectoryServer, &quot;directoryServer&quot;)</span>
<a href="#l16.320"></a><span id="l16.320"> NS_IMPL_IDPREF_BOOL(OverrideGlobalPref, &quot;overrideGlobal_Pref&quot;)</span>
<a href="#l16.321"></a><span id="l16.321"> NS_IMPL_IDPREF_BOOL(AutocompleteToMyDomain, &quot;autocompleteToMyDomain&quot;)</span>
<a href="#l16.322"></a><span id="l16.322"> </span>
<a href="#l16.323"></a><span id="l16.323"> NS_IMPL_IDPREF_BOOL(Valid, &quot;valid&quot;)</span>
<a href="#l16.324"></a><span id="l16.324"> </span>
<a href="#l16.325"></a><span id="l16.325" class="difflineminus">-nsresult</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineminus">-nsMsgIdentity::getFolderPref(const char *prefname, nsCString&amp; retval,</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineminus">-                             const char *folderName, uint32_t folderflag)</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineminus">-{</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+nsresult nsMsgIdentity::getFolderPref(const char *prefname, nsCString &amp;retval,</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+                                      const char *folderName,</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+                                      uint32_t folderflag) {</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.335"></a><span id="l16.335"> </span>
<a href="#l16.336"></a><span id="l16.336">   nsresult rv = mPrefBranch-&gt;GetCharPref(prefname, retval);</span>
<a href="#l16.337"></a><span id="l16.337">   if (NS_SUCCEEDED(rv) &amp;&amp; !retval.IsEmpty()) {</span>
<a href="#l16.338"></a><span id="l16.338">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l16.339"></a><span id="l16.339">     rv = GetOrCreateFolder(retval, getter_AddRefs(folder));</span>
<a href="#l16.340"></a><span id="l16.340">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.341"></a><span id="l16.341">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-    // Make sure that folder hierarchy is built so that legitimate parent-child relationship is established.</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+    // Make sure that folder hierarchy is built so that legitimate parent-child</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+    // relationship is established.</span>
<a href="#l16.345"></a><span id="l16.345">     folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-    if (server)</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-    {</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+    if (server) {</span>
<a href="#l16.349"></a><span id="l16.349">       nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l16.350"></a><span id="l16.350">       nsCOMPtr&lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l16.351"></a><span id="l16.351">       server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l16.352"></a><span id="l16.352">       server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l16.353"></a><span id="l16.353">       // check if we're using a deferred account - if not, use the uri;</span>
<a href="#l16.354"></a><span id="l16.354">       // otherwise, fall through to code that will fix this pref.</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineminus">-      if (rootFolder == deferredToRootFolder)</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineminus">-      {</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineplus">+      if (rootFolder == deferredToRootFolder) {</span>
<a href="#l16.358"></a><span id="l16.358">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineminus">-        rv = server-&gt;GetMsgFolderFromURI(folder, retval, getter_AddRefs(msgFolder));</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+        rv = server-&gt;GetMsgFolderFromURI(folder, retval,</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+                                         getter_AddRefs(msgFolder));</span>
<a href="#l16.362"></a><span id="l16.362">         return NS_SUCCEEDED(rv) ? msgFolder-&gt;GetURI(retval) : rv;</span>
<a href="#l16.363"></a><span id="l16.363">       }</span>
<a href="#l16.364"></a><span id="l16.364">     }</span>
<a href="#l16.365"></a><span id="l16.365">   }</span>
<a href="#l16.366"></a><span id="l16.366"> </span>
<a href="#l16.367"></a><span id="l16.367">   // if the server doesn't exist, fall back to the default pref.</span>
<a href="#l16.368"></a><span id="l16.368">   rv = mDefPrefBranch-&gt;GetCharPref(prefname, retval);</span>
<a href="#l16.369"></a><span id="l16.369">   if (NS_SUCCEEDED(rv) &amp;&amp; !retval.IsEmpty())</span>
<a href="#l16.370"></a><span id="l16.370">     return setFolderPref(prefname, retval, folderflag);</span>
<a href="#l16.371"></a><span id="l16.371"> </span>
<a href="#l16.372"></a><span id="l16.372">   // here I think we need to create a uri for the folder on the</span>
<a href="#l16.373"></a><span id="l16.373">   // default server for this identity.</span>
<a href="#l16.374"></a><span id="l16.374">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineminus">-  do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.379"></a><span id="l16.379"> </span>
<a href="#l16.380"></a><span id="l16.380">   nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l16.381"></a><span id="l16.381">   rv = accountManager-&gt;GetServersForIdentity(this, getter_AddRefs(servers));</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.384"></a><span id="l16.384">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryElementAt(servers, 0, &amp;rv));</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineminus">-  {</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.388"></a><span id="l16.388">     bool defaultToServer;</span>
<a href="#l16.389"></a><span id="l16.389">     server-&gt;GetDefaultCopiesAndFoldersPrefsToServer(&amp;defaultToServer);</span>
<a href="#l16.390"></a><span id="l16.390">     // if we should default to special folders on the server,</span>
<a href="#l16.391"></a><span id="l16.391">     // use the local folders server</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineminus">-    if (!defaultToServer)</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineminus">-    {</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+    if (!defaultToServer) {</span>
<a href="#l16.395"></a><span id="l16.395">       rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l16.396"></a><span id="l16.396">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.397"></a><span id="l16.397">     }</span>
<a href="#l16.398"></a><span id="l16.398">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l16.399"></a><span id="l16.399">     // this will get the deferred to server's root folder, if &quot;server&quot;</span>
<a href="#l16.400"></a><span id="l16.400">     // is deferred, e.g., using the pop3 global inbox.</span>
<a href="#l16.401"></a><span id="l16.401">     rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootFolder));</span>
<a href="#l16.402"></a><span id="l16.402">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineminus">-    if (rootFolder)</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineminus">-    {</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineplus">+    if (rootFolder) {</span>
<a href="#l16.406"></a><span id="l16.406">       rv = rootFolder-&gt;GetURI(retval);</span>
<a href="#l16.407"></a><span id="l16.407">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.408"></a><span id="l16.408">       retval.Append('/');</span>
<a href="#l16.409"></a><span id="l16.409">       retval.Append(folderName);</span>
<a href="#l16.410"></a><span id="l16.410">       return setFolderPref(prefname, retval, folderflag);</span>
<a href="#l16.411"></a><span id="l16.411">     }</span>
<a href="#l16.412"></a><span id="l16.412">   }</span>
<a href="#l16.413"></a><span id="l16.413">   // if there are no servers for this identity, return generic failure.</span>
<a href="#l16.414"></a><span id="l16.414">   return NS_ERROR_FAILURE;</span>
<a href="#l16.415"></a><span id="l16.415"> }</span>
<a href="#l16.416"></a><span id="l16.416"> </span>
<a href="#l16.417"></a><span id="l16.417" class="difflineminus">-nsresult</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineminus">-nsMsgIdentity::setFolderPref(const char *prefname, const nsACString&amp; value, uint32_t folderflag)</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineminus">-{</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+nsresult nsMsgIdentity::setFolderPref(const char *prefname,</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineplus">+                                      const nsACString &amp;value,</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineplus">+                                      uint32_t folderflag) {</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.426"></a><span id="l16.426"> </span>
<a href="#l16.427"></a><span id="l16.427">   nsCString oldpref;</span>
<a href="#l16.428"></a><span id="l16.428">   nsresult rv;</span>
<a href="#l16.429"></a><span id="l16.429">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l16.430"></a><span id="l16.430"> </span>
<a href="#l16.431"></a><span id="l16.431" class="difflineminus">-  if (folderflag == nsMsgFolderFlags::SentMail)</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineminus">-  {</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+  if (folderflag == nsMsgFolderFlags::SentMail) {</span>
<a href="#l16.434"></a><span id="l16.434">     // Clear the temporary return receipt filter so that the new filter</span>
<a href="#l16.435"></a><span id="l16.435">     // rule can be recreated (by ConfigureTemporaryFilters()).</span>
<a href="#l16.436"></a><span id="l16.436">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.441"></a><span id="l16.441"> </span>
<a href="#l16.442"></a><span id="l16.442">     nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l16.443"></a><span id="l16.443">     rv = accountManager-&gt;GetServersForIdentity(this, getter_AddRefs(servers));</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.446"></a><span id="l16.446">     uint32_t cnt = 0;</span>
<a href="#l16.447"></a><span id="l16.447">     servers-&gt;GetLength(&amp;cnt);</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineminus">-    if (cnt &gt; 0)</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineminus">-    {</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+    if (cnt &gt; 0) {</span>
<a href="#l16.451"></a><span id="l16.451">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryElementAt(servers, 0, &amp;rv));</span>
<a href="#l16.452"></a><span id="l16.452">       if (NS_SUCCEEDED(rv))</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineminus">-        server-&gt;ClearTemporaryReturnReceiptsFilter(); // okay to fail; no need to check for return code</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+        server</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+            -&gt;ClearTemporaryReturnReceiptsFilter();  // okay to fail; no need to</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+                                                     // check for return code</span>
<a href="#l16.457"></a><span id="l16.457">     }</span>
<a href="#l16.458"></a><span id="l16.458">   }</span>
<a href="#l16.459"></a><span id="l16.459"> </span>
<a href="#l16.460"></a><span id="l16.460">   // get the old folder, and clear the special folder flag on it</span>
<a href="#l16.461"></a><span id="l16.461">   rv = mPrefBranch-&gt;GetCharPref(prefname, oldpref);</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !oldpref.IsEmpty())</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineminus">-  {</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !oldpref.IsEmpty()) {</span>
<a href="#l16.465"></a><span id="l16.465">     rv = GetOrCreateFolder(oldpref, getter_AddRefs(folder));</span>
<a href="#l16.466"></a><span id="l16.466">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.467"></a><span id="l16.467">       rv = folder-&gt;ClearFlag(folderflag);</span>
<a href="#l16.468"></a><span id="l16.468">     }</span>
<a href="#l16.469"></a><span id="l16.469">   }</span>
<a href="#l16.470"></a><span id="l16.470"> </span>
<a href="#l16.471"></a><span id="l16.471">   // set the new folder, and set the special folder flags on it</span>
<a href="#l16.472"></a><span id="l16.472">   rv = SetCharAttribute(prefname, value);</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !value.IsEmpty())</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineminus">-  {</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !value.IsEmpty()) {</span>
<a href="#l16.476"></a><span id="l16.476">     rv = GetOrCreateFolder(value, getter_AddRefs(folder));</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineminus">-      rv = folder-&gt;SetFlag(folderflag);</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = folder-&gt;SetFlag(folderflag);</span>
<a href="#l16.480"></a><span id="l16.480">   }</span>
<a href="#l16.481"></a><span id="l16.481">   return rv;</span>
<a href="#l16.482"></a><span id="l16.482"> }</span>
<a href="#l16.483"></a><span id="l16.483"> </span>
<a href="#l16.484"></a><span id="l16.484" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::SetUnicharAttribute(const char *aName, const nsAString&amp; val)</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineminus">-{</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::SetUnicharAttribute(const char *aName,</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+                                                 const nsAString &amp;val) {</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.491"></a><span id="l16.491"> </span>
<a href="#l16.492"></a><span id="l16.492">   if (!val.IsEmpty())</span>
<a href="#l16.493"></a><span id="l16.493">     return mPrefBranch-&gt;SetStringPref(aName, NS_ConvertUTF16toUTF8(val));</span>
<a href="#l16.494"></a><span id="l16.494"> </span>
<a href="#l16.495"></a><span id="l16.495">   mPrefBranch-&gt;ClearUserPref(aName);</span>
<a href="#l16.496"></a><span id="l16.496">   return NS_OK;</span>
<a href="#l16.497"></a><span id="l16.497"> }</span>
<a href="#l16.498"></a><span id="l16.498"> </span>
<a href="#l16.499"></a><span id="l16.499" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::GetUnicharAttribute(const char *aName, nsAString&amp; val)</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineminus">-{</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::GetUnicharAttribute(const char *aName,</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+                                                 nsAString &amp;val) {</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.506"></a><span id="l16.506"> </span>
<a href="#l16.507"></a><span id="l16.507">   nsCString valueUtf8;</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineminus">-  if (NS_FAILED(mPrefBranch-&gt;GetStringPref(aName, EmptyCString(), 0, valueUtf8)))</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+  if (NS_FAILED(</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+          mPrefBranch-&gt;GetStringPref(aName, EmptyCString(), 0, valueUtf8)))</span>
<a href="#l16.511"></a><span id="l16.511">     mDefPrefBranch-&gt;GetStringPref(aName, EmptyCString(), 0, valueUtf8);</span>
<a href="#l16.512"></a><span id="l16.512">   CopyUTF8toUTF16(valueUtf8, val);</span>
<a href="#l16.513"></a><span id="l16.513">   return NS_OK;</span>
<a href="#l16.514"></a><span id="l16.514"> }</span>
<a href="#l16.515"></a><span id="l16.515"> </span>
<a href="#l16.516"></a><span id="l16.516" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::SetCharAttribute(const char *aName, const nsACString&amp; val)</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineminus">-{</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::SetCharAttribute(const char *aName,</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+                                              const nsACString &amp;val) {</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.523"></a><span id="l16.523"> </span>
<a href="#l16.524"></a><span id="l16.524" class="difflineminus">-  if (!val.IsEmpty())</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineminus">-    return mPrefBranch-&gt;SetCharPref(aName, val);</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineplus">+  if (!val.IsEmpty()) return mPrefBranch-&gt;SetCharPref(aName, val);</span>
<a href="#l16.527"></a><span id="l16.527"> </span>
<a href="#l16.528"></a><span id="l16.528">   mPrefBranch-&gt;ClearUserPref(aName);</span>
<a href="#l16.529"></a><span id="l16.529">   return NS_OK;</span>
<a href="#l16.530"></a><span id="l16.530"> }</span>
<a href="#l16.531"></a><span id="l16.531"> </span>
<a href="#l16.532"></a><span id="l16.532" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::GetCharAttribute(const char *aName, nsACString&amp; val)</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineminus">-{</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::GetCharAttribute(const char *aName,</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+                                              nsACString &amp;val) {</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.539"></a><span id="l16.539"> </span>
<a href="#l16.540"></a><span id="l16.540">   nsCString tmpVal;</span>
<a href="#l16.541"></a><span id="l16.541">   if (NS_FAILED(mPrefBranch-&gt;GetCharPref(aName, tmpVal)))</span>
<a href="#l16.542"></a><span id="l16.542">     mDefPrefBranch-&gt;GetCharPref(aName, tmpVal);</span>
<a href="#l16.543"></a><span id="l16.543">   val = tmpVal;</span>
<a href="#l16.544"></a><span id="l16.544">   return NS_OK;</span>
<a href="#l16.545"></a><span id="l16.545"> }</span>
<a href="#l16.546"></a><span id="l16.546"> </span>
<a href="#l16.547"></a><span id="l16.547" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::SetBoolAttribute(const char *aName, bool val)</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineminus">-{</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::SetBoolAttribute(const char *aName, bool val) {</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.553"></a><span id="l16.553"> </span>
<a href="#l16.554"></a><span id="l16.554">   return mPrefBranch-&gt;SetBoolPref(aName, val);</span>
<a href="#l16.555"></a><span id="l16.555"> }</span>
<a href="#l16.556"></a><span id="l16.556"> </span>
<a href="#l16.557"></a><span id="l16.557" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::GetBoolAttribute(const char *aName, bool *val)</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineminus">-{</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::GetBoolAttribute(const char *aName, bool *val) {</span>
<a href="#l16.560"></a><span id="l16.560">   NS_ENSURE_ARG_POINTER(val);</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.563"></a><span id="l16.563" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.564"></a><span id="l16.564"> </span>
<a href="#l16.565"></a><span id="l16.565">   *val = false;</span>
<a href="#l16.566"></a><span id="l16.566"> </span>
<a href="#l16.567"></a><span id="l16.567">   if (NS_FAILED(mPrefBranch-&gt;GetBoolPref(aName, val)))</span>
<a href="#l16.568"></a><span id="l16.568">     mDefPrefBranch-&gt;GetBoolPref(aName, val);</span>
<a href="#l16.569"></a><span id="l16.569"> </span>
<a href="#l16.570"></a><span id="l16.570">   return NS_OK;</span>
<a href="#l16.571"></a><span id="l16.571"> }</span>
<a href="#l16.572"></a><span id="l16.572"> </span>
<a href="#l16.573"></a><span id="l16.573" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::SetIntAttribute(const char *aName, int32_t val)</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineminus">-{</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::SetIntAttribute(const char *aName, int32_t val) {</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.579"></a><span id="l16.579"> </span>
<a href="#l16.580"></a><span id="l16.580">   return mPrefBranch-&gt;SetIntPref(aName, val);</span>
<a href="#l16.581"></a><span id="l16.581"> }</span>
<a href="#l16.582"></a><span id="l16.582"> </span>
<a href="#l16.583"></a><span id="l16.583" class="difflineminus">-NS_IMETHODIMP nsMsgIdentity::GetIntAttribute(const char *aName, int32_t *val)</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineminus">-{</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+NS_IMETHODIMP nsMsgIdentity::GetIntAttribute(const char *aName, int32_t *val) {</span>
<a href="#l16.586"></a><span id="l16.586">   NS_ENSURE_ARG_POINTER(val);</span>
<a href="#l16.587"></a><span id="l16.587"> </span>
<a href="#l16.588"></a><span id="l16.588" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l16.591"></a><span id="l16.591"> </span>
<a href="#l16.592"></a><span id="l16.592">   *val = 0;</span>
<a href="#l16.593"></a><span id="l16.593"> </span>
<a href="#l16.594"></a><span id="l16.594">   if (NS_FAILED(mPrefBranch-&gt;GetIntPref(aName, val)))</span>
<a href="#l16.595"></a><span id="l16.595">     mDefPrefBranch-&gt;GetIntPref(aName, val);</span>
<a href="#l16.596"></a><span id="l16.596"> </span>
<a href="#l16.597"></a><span id="l16.597">   return NS_OK;</span>
<a href="#l16.598"></a><span id="l16.598"> }</span>
<a href="#l16.599"></a><span id="l16.599"> </span>
<a href="#l16.600"></a><span id="l16.600" class="difflineminus">-#define COPY_IDENTITY_FILE_VALUE(SRC_ID,MACRO_GETTER,MACRO_SETTER)   \</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineminus">-  {  \</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-    nsresult macro_rv;  \</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt;macro_spec;   \</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineminus">-          macro_rv = SRC_ID-&gt;MACRO_GETTER(getter_AddRefs(macro_spec)); \</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineminus">-          if (NS_SUCCEEDED(macro_rv)) \</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineminus">-            this-&gt;MACRO_SETTER(macro_spec);     \</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineplus">+#define COPY_IDENTITY_FILE_VALUE(SRC_ID, MACRO_GETTER, MACRO_SETTER) \</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineplus">+  {                                                                  \</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+    nsresult macro_rv;                                               \</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; macro_spec;                                    \</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineplus">+    macro_rv = SRC_ID-&gt;MACRO_GETTER(getter_AddRefs(macro_spec));     \</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineplus">+    if (NS_SUCCEEDED(macro_rv)) this-&gt;MACRO_SETTER(macro_spec);      \</span>
<a href="#l16.613"></a><span id="l16.613">   }</span>
<a href="#l16.614"></a><span id="l16.614"> </span>
<a href="#l16.615"></a><span id="l16.615" class="difflineminus">-#define COPY_IDENTITY_INT_VALUE(SRC_ID,MACRO_GETTER,MACRO_SETTER)   \</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineminus">-  {  \</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineminus">-        nsresult macro_rv;  \</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineminus">-          int32_t macro_oldInt;  \</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineminus">-          macro_rv = SRC_ID-&gt;MACRO_GETTER(&amp;macro_oldInt);  \</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineminus">-          if (NS_SUCCEEDED(macro_rv)) \</span>
<a href="#l16.621"></a><span id="l16.621" class="difflineminus">-            this-&gt;MACRO_SETTER(macro_oldInt);     \</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineplus">+#define COPY_IDENTITY_INT_VALUE(SRC_ID, MACRO_GETTER, MACRO_SETTER) \</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineplus">+  {                                                                 \</span>
<a href="#l16.624"></a><span id="l16.624" class="difflineplus">+    nsresult macro_rv;                                              \</span>
<a href="#l16.625"></a><span id="l16.625" class="difflineplus">+    int32_t macro_oldInt;                                           \</span>
<a href="#l16.626"></a><span id="l16.626" class="difflineplus">+    macro_rv = SRC_ID-&gt;MACRO_GETTER(&amp;macro_oldInt);                 \</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineplus">+    if (NS_SUCCEEDED(macro_rv)) this-&gt;MACRO_SETTER(macro_oldInt);   \</span>
<a href="#l16.628"></a><span id="l16.628">   }</span>
<a href="#l16.629"></a><span id="l16.629"> </span>
<a href="#l16.630"></a><span id="l16.630" class="difflineminus">-#define COPY_IDENTITY_BOOL_VALUE(SRC_ID,MACRO_GETTER,MACRO_SETTER)   \</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineminus">-  {  \</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineminus">-        nsresult macro_rv;  \</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineminus">-          bool macro_oldBool;  \</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineminus">-          macro_rv = SRC_ID-&gt;MACRO_GETTER(&amp;macro_oldBool);  \</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineminus">-          if (NS_SUCCEEDED(macro_rv)) \</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineminus">-            this-&gt;MACRO_SETTER(macro_oldBool);     \</span>
<a href="#l16.637"></a><span id="l16.637" class="difflineplus">+#define COPY_IDENTITY_BOOL_VALUE(SRC_ID, MACRO_GETTER, MACRO_SETTER) \</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineplus">+  {                                                                  \</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineplus">+    nsresult macro_rv;                                               \</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineplus">+    bool macro_oldBool;                                              \</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineplus">+    macro_rv = SRC_ID-&gt;MACRO_GETTER(&amp;macro_oldBool);                 \</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineplus">+    if (NS_SUCCEEDED(macro_rv)) this-&gt;MACRO_SETTER(macro_oldBool);   \</span>
<a href="#l16.643"></a><span id="l16.643">   }</span>
<a href="#l16.644"></a><span id="l16.644"> </span>
<a href="#l16.645"></a><span id="l16.645" class="difflineminus">-#define COPY_IDENTITY_STR_VALUE(SRC_ID,MACRO_GETTER,MACRO_SETTER)   \</span>
<a href="#l16.646"></a><span id="l16.646" class="difflineminus">-  {  \</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineminus">-          nsCString macro_oldStr;  \</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineminus">-        nsresult macro_rv;  \</span>
<a href="#l16.649"></a><span id="l16.649" class="difflineminus">-          macro_rv = SRC_ID-&gt;MACRO_GETTER(macro_oldStr);  \</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineminus">-            if (NS_SUCCEEDED(macro_rv)) { \</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineminus">-                    this-&gt;MACRO_SETTER(macro_oldStr);  \</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineminus">-            } \</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineplus">+#define COPY_IDENTITY_STR_VALUE(SRC_ID, MACRO_GETTER, MACRO_SETTER) \</span>
<a href="#l16.654"></a><span id="l16.654" class="difflineplus">+  {                                                                 \</span>
<a href="#l16.655"></a><span id="l16.655" class="difflineplus">+    nsCString macro_oldStr;                                         \</span>
<a href="#l16.656"></a><span id="l16.656" class="difflineplus">+    nsresult macro_rv;                                              \</span>
<a href="#l16.657"></a><span id="l16.657" class="difflineplus">+    macro_rv = SRC_ID-&gt;MACRO_GETTER(macro_oldStr);                  \</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineplus">+    if (NS_SUCCEEDED(macro_rv)) {                                   \</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineplus">+      this-&gt;MACRO_SETTER(macro_oldStr);                             \</span>
<a href="#l16.660"></a><span id="l16.660" class="difflineplus">+    }                                                               \</span>
<a href="#l16.661"></a><span id="l16.661">   }</span>
<a href="#l16.662"></a><span id="l16.662"> </span>
<a href="#l16.663"></a><span id="l16.663" class="difflineminus">-#define COPY_IDENTITY_WSTR_VALUE(SRC_ID,MACRO_GETTER,MACRO_SETTER)   \</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineminus">-  {  \</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineminus">-          nsString macro_oldStr;  \</span>
<a href="#l16.666"></a><span id="l16.666" class="difflineminus">-        nsresult macro_rv;  \</span>
<a href="#l16.667"></a><span id="l16.667" class="difflineminus">-          macro_rv = SRC_ID-&gt;MACRO_GETTER(macro_oldStr); \</span>
<a href="#l16.668"></a><span id="l16.668" class="difflineminus">-          if (NS_SUCCEEDED(macro_rv)) { \</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineminus">-                  this-&gt;MACRO_SETTER(macro_oldStr);  \</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineminus">-              }  \</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineplus">+#define COPY_IDENTITY_WSTR_VALUE(SRC_ID, MACRO_GETTER, MACRO_SETTER) \</span>
<a href="#l16.672"></a><span id="l16.672" class="difflineplus">+  {                                                                  \</span>
<a href="#l16.673"></a><span id="l16.673" class="difflineplus">+    nsString macro_oldStr;                                           \</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineplus">+    nsresult macro_rv;                                               \</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineplus">+    macro_rv = SRC_ID-&gt;MACRO_GETTER(macro_oldStr);                   \</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineplus">+    if (NS_SUCCEEDED(macro_rv)) {                                    \</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineplus">+      this-&gt;MACRO_SETTER(macro_oldStr);                              \</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineplus">+    }                                                                \</span>
<a href="#l16.679"></a><span id="l16.679">   }</span>
<a href="#l16.680"></a><span id="l16.680"> </span>
<a href="#l16.681"></a><span id="l16.681"> NS_IMETHODIMP</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineminus">-nsMsgIdentity::Copy(nsIMsgIdentity *identity)</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineminus">-{</span>
<a href="#l16.684"></a><span id="l16.684" class="difflineminus">-    NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l16.685"></a><span id="l16.685" class="difflineplus">+nsMsgIdentity::Copy(nsIMsgIdentity *identity) {</span>
<a href="#l16.686"></a><span id="l16.686" class="difflineplus">+  NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l16.687"></a><span id="l16.687"> </span>
<a href="#l16.688"></a><span id="l16.688" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetComposeHtml,SetComposeHtml)</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetEmail,SetEmail)</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineminus">-    COPY_IDENTITY_WSTR_VALUE(identity,GetLabel,SetLabel)</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetReplyTo,SetReplyTo)</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineminus">-    COPY_IDENTITY_WSTR_VALUE(identity,GetFullName,SetFullName)</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineminus">-    COPY_IDENTITY_WSTR_VALUE(identity,GetOrganization,SetOrganization)</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetDraftFolder,SetDraftFolder)</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetArchiveFolder,SetArchiveFolder)</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetFccFolder,SetFccFolder)</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetFccReplyFollowsParent,</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineminus">-                             SetFccReplyFollowsParent)</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetStationeryFolder,SetStationeryFolder)</span>
<a href="#l16.700"></a><span id="l16.700" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetArchiveEnabled,SetArchiveEnabled)</span>
<a href="#l16.701"></a><span id="l16.701" class="difflineminus">-    COPY_IDENTITY_INT_VALUE(identity,GetArchiveGranularity,</span>
<a href="#l16.702"></a><span id="l16.702" class="difflineminus">-                            SetArchiveGranularity)</span>
<a href="#l16.703"></a><span id="l16.703" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetArchiveKeepFolderStructure,</span>
<a href="#l16.704"></a><span id="l16.704" class="difflineminus">-                             SetArchiveKeepFolderStructure)</span>
<a href="#l16.705"></a><span id="l16.705" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetAttachSignature,SetAttachSignature)</span>
<a href="#l16.706"></a><span id="l16.706" class="difflineminus">-    COPY_IDENTITY_FILE_VALUE(identity,GetSignature,SetSignature)</span>
<a href="#l16.707"></a><span id="l16.707" class="difflineminus">-    COPY_IDENTITY_WSTR_VALUE(identity,GetHtmlSigText,SetHtmlSigText)</span>
<a href="#l16.708"></a><span id="l16.708" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetHtmlSigFormat,SetHtmlSigFormat)</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetAutoQuote,SetAutoQuote)</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineminus">-    COPY_IDENTITY_INT_VALUE(identity,GetReplyOnTop,SetReplyOnTop)</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetSigBottom,SetSigBottom)</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetSigOnForward,SetSigOnForward)</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetSigOnReply,SetSigOnReply)</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineminus">-    COPY_IDENTITY_INT_VALUE(identity,GetSignatureDate,SetSignatureDate)</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetAttachVCard,SetAttachVCard)</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetEscapedVCard,SetEscapedVCard)</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineminus">-    COPY_IDENTITY_STR_VALUE(identity,GetSmtpServerKey,SetSmtpServerKey)</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineminus">-    COPY_IDENTITY_BOOL_VALUE(identity,GetSuppressSigSep,SetSuppressSigSep)</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetComposeHtml, SetComposeHtml)</span>
<a href="#l16.721"></a><span id="l16.721" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetEmail, SetEmail)</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineplus">+  COPY_IDENTITY_WSTR_VALUE(identity, GetLabel, SetLabel)</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetReplyTo, SetReplyTo)</span>
<a href="#l16.724"></a><span id="l16.724" class="difflineplus">+  COPY_IDENTITY_WSTR_VALUE(identity, GetFullName, SetFullName)</span>
<a href="#l16.725"></a><span id="l16.725" class="difflineplus">+  COPY_IDENTITY_WSTR_VALUE(identity, GetOrganization, SetOrganization)</span>
<a href="#l16.726"></a><span id="l16.726" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetDraftFolder, SetDraftFolder)</span>
<a href="#l16.727"></a><span id="l16.727" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetArchiveFolder, SetArchiveFolder)</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetFccFolder, SetFccFolder)</span>
<a href="#l16.729"></a><span id="l16.729" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetFccReplyFollowsParent,</span>
<a href="#l16.730"></a><span id="l16.730" class="difflineplus">+                           SetFccReplyFollowsParent)</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetStationeryFolder, SetStationeryFolder)</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetArchiveEnabled, SetArchiveEnabled)</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+  COPY_IDENTITY_INT_VALUE(identity, GetArchiveGranularity,</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineplus">+                          SetArchiveGranularity)</span>
<a href="#l16.735"></a><span id="l16.735" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetArchiveKeepFolderStructure,</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineplus">+                           SetArchiveKeepFolderStructure)</span>
<a href="#l16.737"></a><span id="l16.737" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetAttachSignature, SetAttachSignature)</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineplus">+  COPY_IDENTITY_FILE_VALUE(identity, GetSignature, SetSignature)</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineplus">+  COPY_IDENTITY_WSTR_VALUE(identity, GetHtmlSigText, SetHtmlSigText)</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetHtmlSigFormat, SetHtmlSigFormat)</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetAutoQuote, SetAutoQuote)</span>
<a href="#l16.742"></a><span id="l16.742" class="difflineplus">+  COPY_IDENTITY_INT_VALUE(identity, GetReplyOnTop, SetReplyOnTop)</span>
<a href="#l16.743"></a><span id="l16.743" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetSigBottom, SetSigBottom)</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetSigOnForward, SetSigOnForward)</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetSigOnReply, SetSigOnReply)</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineplus">+  COPY_IDENTITY_INT_VALUE(identity, GetSignatureDate, SetSignatureDate)</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetAttachVCard, SetAttachVCard)</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetEscapedVCard, SetEscapedVCard)</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineplus">+  COPY_IDENTITY_STR_VALUE(identity, GetSmtpServerKey, SetSmtpServerKey)</span>
<a href="#l16.750"></a><span id="l16.750" class="difflineplus">+  COPY_IDENTITY_BOOL_VALUE(identity, GetSuppressSigSep, SetSuppressSigSep)</span>
<a href="#l16.751"></a><span id="l16.751" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.752"></a><span id="l16.752"> }</span>
<a href="#l16.753"></a><span id="l16.753"> </span>
<a href="#l16.754"></a><span id="l16.754"> NS_IMETHODIMP</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineminus">-nsMsgIdentity::GetRequestReturnReceipt(bool *aVal)</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineminus">-{</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineplus">+nsMsgIdentity::GetRequestReturnReceipt(bool *aVal) {</span>
<a href="#l16.758"></a><span id="l16.758">   NS_ENSURE_ARG_POINTER(aVal);</span>
<a href="#l16.759"></a><span id="l16.759"> </span>
<a href="#l16.760"></a><span id="l16.760">   bool useCustomPrefs = false;</span>
<a href="#l16.761"></a><span id="l16.761">   nsresult rv = GetBoolAttribute(&quot;use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l16.762"></a><span id="l16.762">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.763"></a><span id="l16.763">   if (useCustomPrefs)</span>
<a href="#l16.764"></a><span id="l16.764">     return GetBoolAttribute(&quot;request_return_receipt_on&quot;, aVal);</span>
<a href="#l16.765"></a><span id="l16.765"> </span>
<a href="#l16.766"></a><span id="l16.766">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.767"></a><span id="l16.767">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.768"></a><span id="l16.768">   return prefs-&gt;GetBoolPref(&quot;mail.receipt.request_return_receipt_on&quot;, aVal);</span>
<a href="#l16.769"></a><span id="l16.769"> }</span>
<a href="#l16.770"></a><span id="l16.770"> </span>
<a href="#l16.771"></a><span id="l16.771"> NS_IMETHODIMP</span>
<a href="#l16.772"></a><span id="l16.772" class="difflineminus">-nsMsgIdentity::GetReceiptHeaderType(int32_t *aType)</span>
<a href="#l16.773"></a><span id="l16.773" class="difflineminus">-{</span>
<a href="#l16.774"></a><span id="l16.774" class="difflineplus">+nsMsgIdentity::GetReceiptHeaderType(int32_t *aType) {</span>
<a href="#l16.775"></a><span id="l16.775">   NS_ENSURE_ARG_POINTER(aType);</span>
<a href="#l16.776"></a><span id="l16.776"> </span>
<a href="#l16.777"></a><span id="l16.777">   bool useCustomPrefs = false;</span>
<a href="#l16.778"></a><span id="l16.778">   nsresult rv = GetBoolAttribute(&quot;use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l16.779"></a><span id="l16.779">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.780"></a><span id="l16.780">   if (useCustomPrefs)</span>
<a href="#l16.781"></a><span id="l16.781">     return GetIntAttribute(&quot;request_receipt_header_type&quot;, aType);</span>
<a href="#l16.782"></a><span id="l16.782"> </span>
<a href="#l16.783"></a><span id="l16.783">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.784"></a><span id="l16.784">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.785"></a><span id="l16.785">   return prefs-&gt;GetIntPref(&quot;mail.receipt.request_header_type&quot;, aType);</span>
<a href="#l16.786"></a><span id="l16.786"> }</span>
<a href="#l16.787"></a><span id="l16.787"> </span>
<a href="#l16.788"></a><span id="l16.788"> NS_IMETHODIMP</span>
<a href="#l16.789"></a><span id="l16.789" class="difflineminus">-nsMsgIdentity::GetRequestDSN(bool *aVal)</span>
<a href="#l16.790"></a><span id="l16.790" class="difflineminus">-{</span>
<a href="#l16.791"></a><span id="l16.791" class="difflineplus">+nsMsgIdentity::GetRequestDSN(bool *aVal) {</span>
<a href="#l16.792"></a><span id="l16.792">   NS_ENSURE_ARG_POINTER(aVal);</span>
<a href="#l16.793"></a><span id="l16.793"> </span>
<a href="#l16.794"></a><span id="l16.794">   bool useCustomPrefs = false;</span>
<a href="#l16.795"></a><span id="l16.795">   nsresult rv = GetBoolAttribute(&quot;dsn_use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l16.796"></a><span id="l16.796">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.797"></a><span id="l16.797" class="difflineminus">-  if (useCustomPrefs)</span>
<a href="#l16.798"></a><span id="l16.798" class="difflineminus">-    return GetBoolAttribute(&quot;dsn_always_request_on&quot;, aVal);</span>
<a href="#l16.799"></a><span id="l16.799" class="difflineplus">+  if (useCustomPrefs) return GetBoolAttribute(&quot;dsn_always_request_on&quot;, aVal);</span>
<a href="#l16.800"></a><span id="l16.800"> </span>
<a href="#l16.801"></a><span id="l16.801">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l16.802"></a><span id="l16.802">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.803"></a><span id="l16.803">   return prefs-&gt;GetBoolPref(&quot;mail.dsn.always_request_on&quot;, aVal);</span>
<a href="#l16.804"></a><span id="l16.804"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIdentity.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIdentity.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -7,91 +7,79 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #define nsMsgIdentity_h___</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsString.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-class NS_MSG_BASE nsMsgIdentity final : public nsIMsgIdentity</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-{</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-public:</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+class NS_MSG_BASE nsMsgIdentity final : public nsIMsgIdentity {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ public:</span>
<a href="#l17.17"></a><span id="l17.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l17.18"></a><span id="l17.18">   NS_DECL_NSIMSGIDENTITY</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-private:</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ private:</span>
<a href="#l17.22"></a><span id="l17.22">   ~nsMsgIdentity() {}</span>
<a href="#l17.23"></a><span id="l17.23">   nsCString mKey;</span>
<a href="#l17.24"></a><span id="l17.24">   nsCOMPtr&lt;nsIPrefBranch&gt; mPrefBranch;</span>
<a href="#l17.25"></a><span id="l17.25">   nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-protected:</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  nsresult getFolderPref(const char *pref, nsCString&amp;, const char *, uint32_t);</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-  nsresult setFolderPref(const char *pref, const nsACString&amp;, uint32_t);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ protected:</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  nsresult getFolderPref(const char* pref, nsCString&amp;, const char*, uint32_t);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  nsresult setFolderPref(const char* pref, const nsACString&amp;, uint32_t);</span>
<a href="#l17.33"></a><span id="l17.33"> };</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+#define NS_IMPL_IDPREF_STR(_postfix, _prefname)           \</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  NS_IMETHODIMP                                           \</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+  nsMsgIdentity::Get##_postfix(nsACString&amp; retval) {      \</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+    return GetCharAttribute(_prefname, retval);           \</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+  }                                                       \</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+  NS_IMETHODIMP                                           \</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+  nsMsgIdentity::Set##_postfix(const nsACString&amp; value) { \</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+    return SetCharAttribute(_prefname, value);            \</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+  }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-#define NS_IMPL_IDPREF_STR(_postfix, _prefname)       \</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-NS_IMETHODIMP                                         \</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-nsMsgIdentity::Get##_postfix(nsACString&amp; retval)      \</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-{                                                     \</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  return GetCharAttribute(_prefname, retval);         \</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-}                                                     \</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-NS_IMETHODIMP                                         \</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-nsMsgIdentity::Set##_postfix(const nsACString&amp; value) \</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-{                                                     \</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-  return SetCharAttribute(_prefname, value);          \</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-}</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-#define NS_IMPL_IDPREF_WSTR(_postfix, _prefname)     \</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-NS_IMETHODIMP                                        \</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-nsMsgIdentity::Get##_postfix(nsAString&amp; retval)      \</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-{                                                    \</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-  return GetUnicharAttribute(_prefname, retval);     \</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-}                                                    \</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-NS_IMETHODIMP                                        \</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-nsMsgIdentity::Set##_postfix(const nsAString&amp; value) \</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-{                                                    \</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  return SetUnicharAttribute(_prefname, value);      \</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-}</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+#define NS_IMPL_IDPREF_WSTR(_postfix, _prefname)         \</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  NS_IMETHODIMP                                          \</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  nsMsgIdentity::Get##_postfix(nsAString&amp; retval) {      \</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    return GetUnicharAttribute(_prefname, retval);       \</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  }                                                      \</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  NS_IMETHODIMP                                          \</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  nsMsgIdentity::Set##_postfix(const nsAString&amp; value) { \</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+    return SetUnicharAttribute(_prefname, value);        \</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  }</span>
<a href="#l17.77"></a><span id="l17.77"> </span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-#define NS_IMPL_IDPREF_BOOL(_postfix, _prefname)     \</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-NS_IMETHODIMP                                        \</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-nsMsgIdentity::Get##_postfix(bool *retval)         \</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-{                                                    \</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-  return GetBoolAttribute(_prefname, retval);        \</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-}                                                    \</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-NS_IMETHODIMP                                        \</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-nsMsgIdentity::Set##_postfix(bool value)           \</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-{                                                    \</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-  return mPrefBranch-&gt;SetBoolPref(_prefname, value); \</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-}</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+#define NS_IMPL_IDPREF_BOOL(_postfix, _prefname)       \</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  NS_IMETHODIMP                                        \</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  nsMsgIdentity::Get##_postfix(bool* retval) {         \</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    return GetBoolAttribute(_prefname, retval);        \</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  }                                                    \</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  NS_IMETHODIMP                                        \</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  nsMsgIdentity::Set##_postfix(bool value) {           \</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    return mPrefBranch-&gt;SetBoolPref(_prefname, value); \</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  }</span>
<a href="#l17.98"></a><span id="l17.98"> </span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-#define NS_IMPL_IDPREF_INT(_postfix, _prefname)     \</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-NS_IMETHODIMP                                       \</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-nsMsgIdentity::Get##_postfix(int32_t *retval)       \</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-{                                                   \</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-  return GetIntAttribute(_prefname, retval);        \</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-}                                                   \</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-NS_IMETHODIMP                                       \</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-nsMsgIdentity::Set##_postfix(int32_t value)         \</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-{                                                   \</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-  return mPrefBranch-&gt;SetIntPref(_prefname, value); \</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-}</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+#define NS_IMPL_IDPREF_INT(_postfix, _prefname)       \</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  NS_IMETHODIMP                                       \</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  nsMsgIdentity::Get##_postfix(int32_t* retval) {     \</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+    return GetIntAttribute(_prefname, retval);        \</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+  }                                                   \</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+  NS_IMETHODIMP                                       \</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+  nsMsgIdentity::Set##_postfix(int32_t value) {       \</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+    return mPrefBranch-&gt;SetIntPref(_prefname, value); \</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+  }</span>
<a href="#l17.119"></a><span id="l17.119"> </span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-#define NS_IMPL_FOLDERPREF_STR(_postfix, _prefname, _foldername, _flag)  \</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-NS_IMETHODIMP                                               \</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-nsMsgIdentity::Get##_postfix(nsACString&amp; retval)            \</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-{                                                           \</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-  nsresult rv;                                              \</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-  nsCString folderPref;                                     \</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-  rv = getFolderPref(_prefname, folderPref, _foldername, _flag); \</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-  retval = folderPref;                                      \</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-  return rv;                                                \</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-}                                                           \</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-NS_IMETHODIMP                                               \</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-nsMsgIdentity::Set##_postfix(const nsACString&amp; value)       \</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-{                                                           \</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-  return setFolderPref(_prefname, value, _flag); \</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-}</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+#define NS_IMPL_FOLDERPREF_STR(_postfix, _prefname, _foldername, _flag) \</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+  NS_IMETHODIMP                                                         \</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+  nsMsgIdentity::Get##_postfix(nsACString&amp; retval) {                    \</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+    nsresult rv;                                                        \</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    nsCString folderPref;                                               \</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+    rv = getFolderPref(_prefname, folderPref, _foldername, _flag);      \</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+    retval = folderPref;                                                \</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+    return rv;                                                          \</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  }                                                                     \</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  NS_IMETHODIMP                                                         \</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+  nsMsgIdentity::Set##_postfix(const nsACString&amp; value) {               \</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+    return setFolderPref(_prefname, value, _flag);                      \</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+  }</span>
<a href="#l17.148"></a><span id="l17.148"> </span>
<a href="#l17.149"></a><span id="l17.149"> #endif /* nsMsgIdentity_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -51,522 +51,454 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsIArray.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;mozilla/Unused.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> #define PORT_NOT_SET -1</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-nsMsgIncomingServer::nsMsgIncomingServer():</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-    m_rootFolder(nullptr),</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-    m_downloadedHdrs(50),</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-    m_numMsgsDownloaded(0),</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-    m_biffState(nsIMsgFolder::nsMsgBiffState_Unknown),</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-    m_serverBusy(false),</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-    m_canHaveFilters(true),</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-    m_displayStartupPage(true),</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-    mPerformingBiff(false)</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-{</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-}</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+nsMsgIncomingServer::nsMsgIncomingServer()</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+    : m_rootFolder(nullptr),</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+      m_downloadedHdrs(50),</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+      m_numMsgsDownloaded(0),</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+      m_biffState(nsIMsgFolder::nsMsgBiffState_Unknown),</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+      m_serverBusy(false),</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+      m_canHaveFilters(true),</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+      m_displayStartupPage(true),</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+      mPerformingBiff(false) {}</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-nsresult nsMsgIncomingServer::Init()</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-{</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+nsresult nsMsgIncomingServer::Init() {</span>
<a href="#l18.37"></a><span id="l18.37">   // We need to know when the password manager changes.</span>
<a href="#l18.38"></a><span id="l18.38">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-           mozilla::services::GetObserverService();</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l18.41"></a><span id="l18.41">   NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43">   observerService-&gt;AddObserver(this, &quot;passwordmgr-storage-changed&quot;, false);</span>
<a href="#l18.44"></a><span id="l18.44">   observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l18.45"></a><span id="l18.45">   return NS_OK;</span>
<a href="#l18.46"></a><span id="l18.46"> }</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-nsMsgIncomingServer::~nsMsgIncomingServer()</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-{</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-}</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+nsMsgIncomingServer::~nsMsgIncomingServer() {}</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53"> NS_IMPL_ISUPPORTS(nsMsgIncomingServer, nsIMsgIncomingServer,</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  nsISupportsWeakReference, nsIObserver)</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                  nsISupportsWeakReference, nsIObserver)</span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57"> NS_IMETHODIMP</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-nsMsgIncomingServer::Observe(nsISupports *aSubject, const char* aTopic,</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-                             const char16_t *aData)</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-{</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+nsMsgIncomingServer::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+                             const char16_t *aData) {</span>
<a href="#l18.63"></a><span id="l18.63">   nsresult rv;</span>
<a href="#l18.64"></a><span id="l18.64"> </span>
<a href="#l18.65"></a><span id="l18.65">   // When the state of the password manager changes we need to clear the</span>
<a href="#l18.66"></a><span id="l18.66">   // password from the cache in case the user just removed it.</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-  if (strcmp(aTopic, &quot;passwordmgr-storage-changed&quot;) == 0)</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-  {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  if (strcmp(aTopic, &quot;passwordmgr-storage-changed&quot;) == 0) {</span>
<a href="#l18.70"></a><span id="l18.70">     rv = ForgetSessionPassword();</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  }</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-  else if (strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0)</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-  {</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+  } else if (strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0) {</span>
<a href="#l18.77"></a><span id="l18.77">     // Now remove ourselves from the observer service as well.</span>
<a href="#l18.78"></a><span id="l18.78">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l18.81"></a><span id="l18.81">     NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.82"></a><span id="l18.82"> </span>
<a href="#l18.83"></a><span id="l18.83">     observerService-&gt;RemoveObserver(this, &quot;passwordmgr-storage-changed&quot;);</span>
<a href="#l18.84"></a><span id="l18.84">     observerService-&gt;RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<a href="#l18.85"></a><span id="l18.85">   }</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87">   return NS_OK;</span>
<a href="#l18.88"></a><span id="l18.88"> }</span>
<a href="#l18.89"></a><span id="l18.89"> </span>
<a href="#l18.90"></a><span id="l18.90"> NS_IMETHODIMP</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-nsMsgIncomingServer::SetServerBusy(bool aServerBusy)</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-{</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+nsMsgIncomingServer::SetServerBusy(bool aServerBusy) {</span>
<a href="#l18.94"></a><span id="l18.94">   m_serverBusy = aServerBusy;</span>
<a href="#l18.95"></a><span id="l18.95">   return NS_OK;</span>
<a href="#l18.96"></a><span id="l18.96"> }</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98"> NS_IMETHODIMP</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-nsMsgIncomingServer::GetServerBusy(bool * aServerBusy)</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-{</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+nsMsgIncomingServer::GetServerBusy(bool *aServerBusy) {</span>
<a href="#l18.102"></a><span id="l18.102">   NS_ENSURE_ARG_POINTER(aServerBusy);</span>
<a href="#l18.103"></a><span id="l18.103">   *aServerBusy = m_serverBusy;</span>
<a href="#l18.104"></a><span id="l18.104">   return NS_OK;</span>
<a href="#l18.105"></a><span id="l18.105"> }</span>
<a href="#l18.106"></a><span id="l18.106"> </span>
<a href="#l18.107"></a><span id="l18.107"> NS_IMETHODIMP</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-nsMsgIncomingServer::GetKey(nsACString&amp; serverKey)</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-{</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+nsMsgIncomingServer::GetKey(nsACString &amp;serverKey) {</span>
<a href="#l18.111"></a><span id="l18.111">   serverKey = m_serverKey;</span>
<a href="#l18.112"></a><span id="l18.112">   return NS_OK;</span>
<a href="#l18.113"></a><span id="l18.113"> }</span>
<a href="#l18.114"></a><span id="l18.114"> </span>
<a href="#l18.115"></a><span id="l18.115"> NS_IMETHODIMP</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-nsMsgIncomingServer::SetKey(const nsACString&amp; serverKey)</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-{</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+nsMsgIncomingServer::SetKey(const nsACString &amp;serverKey) {</span>
<a href="#l18.119"></a><span id="l18.119">   m_serverKey.Assign(serverKey);</span>
<a href="#l18.120"></a><span id="l18.120"> </span>
<a href="#l18.121"></a><span id="l18.121">   // in order to actually make use of the key, we need the prefs</span>
<a href="#l18.122"></a><span id="l18.122">   nsresult rv;</span>
<a href="#l18.123"></a><span id="l18.123">   nsCOMPtr&lt;nsIPrefService&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l18.124"></a><span id="l18.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.125"></a><span id="l18.125"> </span>
<a href="#l18.126"></a><span id="l18.126">   nsAutoCString branchName;</span>
<a href="#l18.127"></a><span id="l18.127">   branchName.AssignLiteral(&quot;mail.server.&quot;);</span>
<a href="#l18.128"></a><span id="l18.128">   branchName.Append(m_serverKey);</span>
<a href="#l18.129"></a><span id="l18.129">   branchName.Append('.');</span>
<a href="#l18.130"></a><span id="l18.130">   rv = prefs-&gt;GetBranch(branchName.get(), getter_AddRefs(mPrefBranch));</span>
<a href="#l18.131"></a><span id="l18.131">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.132"></a><span id="l18.132"> </span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  return prefs-&gt;GetBranch(&quot;mail.server.default.&quot;, getter_AddRefs(mDefPrefBranch));</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+  return prefs-&gt;GetBranch(&quot;mail.server.default.&quot;,</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+                          getter_AddRefs(mDefPrefBranch));</span>
<a href="#l18.136"></a><span id="l18.136"> }</span>
<a href="#l18.137"></a><span id="l18.137"> </span>
<a href="#l18.138"></a><span id="l18.138"> NS_IMETHODIMP</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-nsMsgIncomingServer::SetRootFolder(nsIMsgFolder * aRootFolder)</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-{</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+nsMsgIncomingServer::SetRootFolder(nsIMsgFolder *aRootFolder) {</span>
<a href="#l18.142"></a><span id="l18.142">   m_rootFolder = aRootFolder;</span>
<a href="#l18.143"></a><span id="l18.143">   return NS_OK;</span>
<a href="#l18.144"></a><span id="l18.144"> }</span>
<a href="#l18.145"></a><span id="l18.145"> </span>
<a href="#l18.146"></a><span id="l18.146"> // this will return the root folder of this account,</span>
<a href="#l18.147"></a><span id="l18.147"> // even if this server is deferred.</span>
<a href="#l18.148"></a><span id="l18.148"> NS_IMETHODIMP</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineminus">-nsMsgIncomingServer::GetRootFolder(nsIMsgFolder * *aRootFolder)</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-{</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+nsMsgIncomingServer::GetRootFolder(nsIMsgFolder **aRootFolder) {</span>
<a href="#l18.152"></a><span id="l18.152">   NS_ENSURE_ARG_POINTER(aRootFolder);</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-  if (!m_rootFolder)</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-  {</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+  if (!m_rootFolder) {</span>
<a href="#l18.156"></a><span id="l18.156">     nsresult rv = CreateRootFolder();</span>
<a href="#l18.157"></a><span id="l18.157">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.158"></a><span id="l18.158">   }</span>
<a href="#l18.159"></a><span id="l18.159"> </span>
<a href="#l18.160"></a><span id="l18.160">   NS_IF_ADDREF(*aRootFolder = m_rootFolder);</span>
<a href="#l18.161"></a><span id="l18.161">   return NS_OK;</span>
<a href="#l18.162"></a><span id="l18.162"> }</span>
<a href="#l18.163"></a><span id="l18.163"> </span>
<a href="#l18.164"></a><span id="l18.164"> // this will return the root folder of the deferred to account,</span>
<a href="#l18.165"></a><span id="l18.165"> // if this server is deferred.</span>
<a href="#l18.166"></a><span id="l18.166"> NS_IMETHODIMP</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-nsMsgIncomingServer::GetRootMsgFolder(nsIMsgFolder **aRootMsgFolder)</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-{</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+nsMsgIncomingServer::GetRootMsgFolder(nsIMsgFolder **aRootMsgFolder) {</span>
<a href="#l18.170"></a><span id="l18.170">   return GetRootFolder(aRootMsgFolder);</span>
<a href="#l18.171"></a><span id="l18.171"> }</span>
<a href="#l18.172"></a><span id="l18.172"> </span>
<a href="#l18.173"></a><span id="l18.173"> NS_IMETHODIMP</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-nsMsgIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow)</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-{</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-}</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+nsMsgIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow) { return NS_OK; }</span>
<a href="#l18.179"></a><span id="l18.179"> </span>
<a href="#l18.180"></a><span id="l18.180"> NS_IMETHODIMP</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-nsMsgIncomingServer::VerifyLogon(nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-                                 nsIURI **aURL)</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-{</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+nsMsgIncomingServer::VerifyLogon(nsIUrlListener *aUrlListener,</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+                                 nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l18.186"></a><span id="l18.186">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.187"></a><span id="l18.187"> }</span>
<a href="#l18.188"></a><span id="l18.188"> </span>
<a href="#l18.189"></a><span id="l18.189"> NS_IMETHODIMP</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-nsMsgIncomingServer::PerformBiff(nsIMsgWindow* aMsgWindow)</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-{</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-  //This has to be implemented in the derived class, but in case someone doesn't implement it</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-  //just return not implemented.</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+nsMsgIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+  // This has to be implemented in the derived class, but in case someone</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+  // doesn't implement it just return not implemented.</span>
<a href="#l18.197"></a><span id="l18.197">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.198"></a><span id="l18.198"> }</span>
<a href="#l18.199"></a><span id="l18.199"> </span>
<a href="#l18.200"></a><span id="l18.200"> NS_IMETHODIMP</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-nsMsgIncomingServer::GetNewMessages(nsIMsgFolder *aFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineminus">-                      nsIUrlListener *aUrlListener)</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-{</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+nsMsgIncomingServer::GetNewMessages(nsIMsgFolder *aFolder,</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+                                    nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+                                    nsIUrlListener *aUrlListener) {</span>
<a href="#l18.207"></a><span id="l18.207">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l18.208"></a><span id="l18.208">   return aFolder-&gt;GetNewMessages(aMsgWindow, aUrlListener);</span>
<a href="#l18.209"></a><span id="l18.209"> }</span>
<a href="#l18.210"></a><span id="l18.210"> </span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetPerformingBiff(bool *aPerformingBiff)</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-{</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetPerformingBiff(bool *aPerformingBiff) {</span>
<a href="#l18.214"></a><span id="l18.214">   NS_ENSURE_ARG_POINTER(aPerformingBiff);</span>
<a href="#l18.215"></a><span id="l18.215">   *aPerformingBiff = mPerformingBiff;</span>
<a href="#l18.216"></a><span id="l18.216">   return NS_OK;</span>
<a href="#l18.217"></a><span id="l18.217"> }</span>
<a href="#l18.218"></a><span id="l18.218"> </span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::SetPerformingBiff(bool aPerformingBiff)</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-{</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::SetPerformingBiff(bool aPerformingBiff) {</span>
<a href="#l18.222"></a><span id="l18.222">   mPerformingBiff = aPerformingBiff;</span>
<a href="#l18.223"></a><span id="l18.223">   return NS_OK;</span>
<a href="#l18.224"></a><span id="l18.224"> }</span>
<a href="#l18.225"></a><span id="l18.225"> </span>
<a href="#l18.226"></a><span id="l18.226"> NS_IMPL_GETSET(nsMsgIncomingServer, BiffState, uint32_t, m_biffState)</span>
<a href="#l18.227"></a><span id="l18.227"> </span>
<a href="#l18.228"></a><span id="l18.228" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::WriteToFolderCache(nsIMsgFolderCache *folderCache)</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineminus">-{</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::WriteToFolderCache(</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+    nsIMsgFolderCache *folderCache) {</span>
<a href="#l18.232"></a><span id="l18.232">   nsresult rv = NS_OK;</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineminus">-  if (m_rootFolder)</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-  {</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+  if (m_rootFolder) {</span>
<a href="#l18.236"></a><span id="l18.236">     rv = m_rootFolder-&gt;WriteToFolderCache(folderCache, true /* deep */);</span>
<a href="#l18.237"></a><span id="l18.237">   }</span>
<a href="#l18.238"></a><span id="l18.238">   return rv;</span>
<a href="#l18.239"></a><span id="l18.239"> }</span>
<a href="#l18.240"></a><span id="l18.240"> </span>
<a href="#l18.241"></a><span id="l18.241"> NS_IMETHODIMP</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-nsMsgIncomingServer::Shutdown()</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-{</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+nsMsgIncomingServer::Shutdown() {</span>
<a href="#l18.245"></a><span id="l18.245">   nsresult rv = CloseCachedConnections();</span>
<a href="#l18.246"></a><span id="l18.246">   mFilterPlugin = nullptr;</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.249"></a><span id="l18.249"> </span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-  if (mFilterList)</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-  {</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineplus">+  if (mFilterList) {</span>
<a href="#l18.253"></a><span id="l18.253">     // close the filter log stream</span>
<a href="#l18.254"></a><span id="l18.254">     rv = mFilterList-&gt;SetLogStream(nullptr);</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.257"></a><span id="l18.257">     mFilterList = nullptr;</span>
<a href="#l18.258"></a><span id="l18.258">   }</span>
<a href="#l18.259"></a><span id="l18.259"> </span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-  if (mSpamSettings)</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineminus">-  {</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+  if (mSpamSettings) {</span>
<a href="#l18.263"></a><span id="l18.263">     // close the spam log stream</span>
<a href="#l18.264"></a><span id="l18.264">     rv = mSpamSettings-&gt;SetLogStream(nullptr);</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.267"></a><span id="l18.267">     mSpamSettings = nullptr;</span>
<a href="#l18.268"></a><span id="l18.268">   }</span>
<a href="#l18.269"></a><span id="l18.269">   return rv;</span>
<a href="#l18.270"></a><span id="l18.270"> }</span>
<a href="#l18.271"></a><span id="l18.271"> </span>
<a href="#l18.272"></a><span id="l18.272"> NS_IMETHODIMP</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineminus">-nsMsgIncomingServer::CloseCachedConnections()</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-{</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+nsMsgIncomingServer::CloseCachedConnections() {</span>
<a href="#l18.276"></a><span id="l18.276">   // derived class should override if they cache connections.</span>
<a href="#l18.277"></a><span id="l18.277">   return NS_OK;</span>
<a href="#l18.278"></a><span id="l18.278"> }</span>
<a href="#l18.279"></a><span id="l18.279"> </span>
<a href="#l18.280"></a><span id="l18.280"> NS_IMETHODIMP</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineminus">-nsMsgIncomingServer::GetDownloadMessagesAtStartup(bool *getMessagesAtStartup)</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineminus">-{</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineplus">+nsMsgIncomingServer::GetDownloadMessagesAtStartup(bool *getMessagesAtStartup) {</span>
<a href="#l18.284"></a><span id="l18.284">   // derived class should override if they need to do this.</span>
<a href="#l18.285"></a><span id="l18.285">   *getMessagesAtStartup = false;</span>
<a href="#l18.286"></a><span id="l18.286">   return NS_OK;</span>
<a href="#l18.287"></a><span id="l18.287"> }</span>
<a href="#l18.288"></a><span id="l18.288"> </span>
<a href="#l18.289"></a><span id="l18.289"> NS_IMETHODIMP</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-nsMsgIncomingServer::GetCanHaveFilters(bool *canHaveFilters)</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-{</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+nsMsgIncomingServer::GetCanHaveFilters(bool *canHaveFilters) {</span>
<a href="#l18.293"></a><span id="l18.293">   NS_ENSURE_ARG_POINTER(canHaveFilters);</span>
<a href="#l18.294"></a><span id="l18.294">   *canHaveFilters = m_canHaveFilters;</span>
<a href="#l18.295"></a><span id="l18.295">   return NS_OK;</span>
<a href="#l18.296"></a><span id="l18.296"> }</span>
<a href="#l18.297"></a><span id="l18.297"> </span>
<a href="#l18.298"></a><span id="l18.298"> NS_IMETHODIMP</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineminus">-nsMsgIncomingServer::SetCanHaveFilters(bool aCanHaveFilters)</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineminus">-{</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineplus">+nsMsgIncomingServer::SetCanHaveFilters(bool aCanHaveFilters) {</span>
<a href="#l18.302"></a><span id="l18.302">   m_canHaveFilters = aCanHaveFilters;</span>
<a href="#l18.303"></a><span id="l18.303">   return NS_OK;</span>
<a href="#l18.304"></a><span id="l18.304"> }</span>
<a href="#l18.305"></a><span id="l18.305"> </span>
<a href="#l18.306"></a><span id="l18.306"> NS_IMETHODIMP</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineminus">-nsMsgIncomingServer::GetCanBeDefaultServer(bool *canBeDefaultServer)</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineminus">-{</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineplus">+nsMsgIncomingServer::GetCanBeDefaultServer(bool *canBeDefaultServer) {</span>
<a href="#l18.310"></a><span id="l18.310">   // derived class should override if they need to do this.</span>
<a href="#l18.311"></a><span id="l18.311">   *canBeDefaultServer = false;</span>
<a href="#l18.312"></a><span id="l18.312">   return NS_OK;</span>
<a href="#l18.313"></a><span id="l18.313"> }</span>
<a href="#l18.314"></a><span id="l18.314"> </span>
<a href="#l18.315"></a><span id="l18.315"> NS_IMETHODIMP</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineminus">-nsMsgIncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineminus">-{</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+nsMsgIncomingServer::GetCanSearchMessages(bool *canSearchMessages) {</span>
<a href="#l18.319"></a><span id="l18.319">   // derived class should override if they need to do this.</span>
<a href="#l18.320"></a><span id="l18.320">   NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l18.321"></a><span id="l18.321">   *canSearchMessages = false;</span>
<a href="#l18.322"></a><span id="l18.322">   return NS_OK;</span>
<a href="#l18.323"></a><span id="l18.323"> }</span>
<a href="#l18.324"></a><span id="l18.324"> </span>
<a href="#l18.325"></a><span id="l18.325"> NS_IMETHODIMP</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineminus">-nsMsgIncomingServer::GetCanCompactFoldersOnServer(bool *canCompactFoldersOnServer)</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineminus">-{</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineplus">+nsMsgIncomingServer::GetCanCompactFoldersOnServer(</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineplus">+    bool *canCompactFoldersOnServer) {</span>
<a href="#l18.330"></a><span id="l18.330">   // derived class should override if they need to do this.</span>
<a href="#l18.331"></a><span id="l18.331">   NS_ENSURE_ARG_POINTER(canCompactFoldersOnServer);</span>
<a href="#l18.332"></a><span id="l18.332">   *canCompactFoldersOnServer = true;</span>
<a href="#l18.333"></a><span id="l18.333">   return NS_OK;</span>
<a href="#l18.334"></a><span id="l18.334"> }</span>
<a href="#l18.335"></a><span id="l18.335"> </span>
<a href="#l18.336"></a><span id="l18.336"> NS_IMETHODIMP</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineminus">-nsMsgIncomingServer::GetCanUndoDeleteOnServer(bool *canUndoDeleteOnServer)</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineminus">-{</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+nsMsgIncomingServer::GetCanUndoDeleteOnServer(bool *canUndoDeleteOnServer) {</span>
<a href="#l18.340"></a><span id="l18.340">   // derived class should override if they need to do this.</span>
<a href="#l18.341"></a><span id="l18.341">   NS_ENSURE_ARG_POINTER(canUndoDeleteOnServer);</span>
<a href="#l18.342"></a><span id="l18.342">   *canUndoDeleteOnServer = true;</span>
<a href="#l18.343"></a><span id="l18.343">   return NS_OK;</span>
<a href="#l18.344"></a><span id="l18.344"> }</span>
<a href="#l18.345"></a><span id="l18.345"> </span>
<a href="#l18.346"></a><span id="l18.346"> NS_IMETHODIMP</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-nsMsgIncomingServer::GetCanEmptyTrashOnExit(bool *canEmptyTrashOnExit)</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineminus">-{</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineplus">+nsMsgIncomingServer::GetCanEmptyTrashOnExit(bool *canEmptyTrashOnExit) {</span>
<a href="#l18.350"></a><span id="l18.350">   // derived class should override if they need to do this.</span>
<a href="#l18.351"></a><span id="l18.351">   NS_ENSURE_ARG_POINTER(canEmptyTrashOnExit);</span>
<a href="#l18.352"></a><span id="l18.352">   *canEmptyTrashOnExit = true;</span>
<a href="#l18.353"></a><span id="l18.353">   return NS_OK;</span>
<a href="#l18.354"></a><span id="l18.354"> }</span>
<a href="#l18.355"></a><span id="l18.355"> </span>
<a href="#l18.356"></a><span id="l18.356"> // construct &lt;localStoreType&gt;://[&lt;username&gt;@]&lt;hostname</span>
<a href="#l18.357"></a><span id="l18.357"> NS_IMETHODIMP</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-nsMsgIncomingServer::GetServerURI(nsACString&amp; aResult)</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-{</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineplus">+nsMsgIncomingServer::GetServerURI(nsACString &amp;aResult) {</span>
<a href="#l18.361"></a><span id="l18.361">   nsresult rv;</span>
<a href="#l18.362"></a><span id="l18.362">   rv = GetLocalStoreType(aResult);</span>
<a href="#l18.363"></a><span id="l18.363">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.364"></a><span id="l18.364">   aResult.AppendLiteral(&quot;://&quot;);</span>
<a href="#l18.365"></a><span id="l18.365"> </span>
<a href="#l18.366"></a><span id="l18.366">   nsCString username;</span>
<a href="#l18.367"></a><span id="l18.367">   rv = GetUsername(username);</span>
<a href="#l18.368"></a><span id="l18.368">   if (NS_SUCCEEDED(rv) &amp;&amp; !username.IsEmpty()) {</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineminus">-      nsCString escapedUsername;</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineminus">-      MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineminus">-      // not all servers have a username</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineminus">-      aResult.Append(escapedUsername);</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineminus">-      aResult.Append('@');</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineplus">+    nsCString escapedUsername;</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineplus">+    MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineplus">+    // not all servers have a username</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineplus">+    aResult.Append(escapedUsername);</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineplus">+    aResult.Append('@');</span>
<a href="#l18.379"></a><span id="l18.379">   }</span>
<a href="#l18.380"></a><span id="l18.380"> </span>
<a href="#l18.381"></a><span id="l18.381">   nsCString hostname;</span>
<a href="#l18.382"></a><span id="l18.382">   rv = GetHostName(hostname);</span>
<a href="#l18.383"></a><span id="l18.383">   if (NS_SUCCEEDED(rv) &amp;&amp; !hostname.IsEmpty()) {</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-      nsCString escapedHostname;</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineminus">-      MsgEscapeString(hostname, nsINetUtil::ESCAPE_URL_PATH, escapedHostname);</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-      // not all servers have a hostname</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-      aResult.Append(escapedHostname);</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineplus">+    nsCString escapedHostname;</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineplus">+    MsgEscapeString(hostname, nsINetUtil::ESCAPE_URL_PATH, escapedHostname);</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineplus">+    // not all servers have a hostname</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineplus">+    aResult.Append(escapedHostname);</span>
<a href="#l18.392"></a><span id="l18.392">   }</span>
<a href="#l18.393"></a><span id="l18.393">   return NS_OK;</span>
<a href="#l18.394"></a><span id="l18.394"> }</span>
<a href="#l18.395"></a><span id="l18.395"> </span>
<a href="#l18.396"></a><span id="l18.396"> // helper routine to create local folder on disk, if it doesn't exist.</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineminus">-nsresult</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineminus">-nsMsgIncomingServer::CreateLocalFolder(const nsAString&amp; folderName)</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineminus">-{</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineplus">+nsresult nsMsgIncomingServer::CreateLocalFolder(const nsAString &amp;folderName) {</span>
<a href="#l18.401"></a><span id="l18.401">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l18.402"></a><span id="l18.402">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l18.403"></a><span id="l18.403">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.404"></a><span id="l18.404">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l18.405"></a><span id="l18.405">   rv = rootFolder-&gt;GetChildNamed(folderName, getter_AddRefs(child));</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineminus">-  if (child)</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineplus">+  if (child) return NS_OK;</span>
<a href="#l18.409"></a><span id="l18.409">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l18.410"></a><span id="l18.410">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l18.411"></a><span id="l18.411">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.412"></a><span id="l18.412">   return msgStore-&gt;CreateFolder(rootFolder, folderName, getter_AddRefs(child));</span>
<a href="#l18.413"></a><span id="l18.413"> }</span>
<a href="#l18.414"></a><span id="l18.414"> </span>
<a href="#l18.415"></a><span id="l18.415" class="difflineminus">-nsresult</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineminus">-nsMsgIncomingServer::CreateRootFolder()</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineminus">-{</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineplus">+nsresult nsMsgIncomingServer::CreateRootFolder() {</span>
<a href="#l18.419"></a><span id="l18.419">   nsresult rv;</span>
<a href="#l18.420"></a><span id="l18.420">   // get the URI from the incoming server</span>
<a href="#l18.421"></a><span id="l18.421">   nsCString serverUri;</span>
<a href="#l18.422"></a><span id="l18.422">   rv = GetServerURI(serverUri);</span>
<a href="#l18.423"></a><span id="l18.423">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.424"></a><span id="l18.424">   rv = GetOrCreateFolder(serverUri, getter_AddRefs(m_rootFolder));</span>
<a href="#l18.425"></a><span id="l18.425">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.426"></a><span id="l18.426">   return NS_OK;</span>
<a href="#l18.427"></a><span id="l18.427"> }</span>
<a href="#l18.428"></a><span id="l18.428"> </span>
<a href="#l18.429"></a><span id="l18.429"> NS_IMETHODIMP</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-nsMsgIncomingServer::GetBoolValue(const char *prefname,</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-                                 bool *val)</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-{</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineplus">+nsMsgIncomingServer::GetBoolValue(const char *prefname, bool *val) {</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.437"></a><span id="l18.437"> </span>
<a href="#l18.438"></a><span id="l18.438">   NS_ENSURE_ARG_POINTER(val);</span>
<a href="#l18.439"></a><span id="l18.439">   *val = false;</span>
<a href="#l18.440"></a><span id="l18.440"> </span>
<a href="#l18.441"></a><span id="l18.441">   if (NS_FAILED(mPrefBranch-&gt;GetBoolPref(prefname, val)))</span>
<a href="#l18.442"></a><span id="l18.442">     mDefPrefBranch-&gt;GetBoolPref(prefname, val);</span>
<a href="#l18.443"></a><span id="l18.443"> </span>
<a href="#l18.444"></a><span id="l18.444">   return NS_OK;</span>
<a href="#l18.445"></a><span id="l18.445"> }</span>
<a href="#l18.446"></a><span id="l18.446"> </span>
<a href="#l18.447"></a><span id="l18.447"> NS_IMETHODIMP</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-nsMsgIncomingServer::SetBoolValue(const char *prefname,</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineminus">-                                 bool val)</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineminus">-{</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineplus">+nsMsgIncomingServer::SetBoolValue(const char *prefname, bool val) {</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.455"></a><span id="l18.455"> </span>
<a href="#l18.456"></a><span id="l18.456">   bool defaultValue;</span>
<a href="#l18.457"></a><span id="l18.457">   nsresult rv = mDefPrefBranch-&gt;GetBoolPref(prefname, &amp;defaultValue);</span>
<a href="#l18.458"></a><span id="l18.458"> </span>
<a href="#l18.459"></a><span id="l18.459">   if (NS_SUCCEEDED(rv) &amp;&amp; val == defaultValue)</span>
<a href="#l18.460"></a><span id="l18.460">     mPrefBranch-&gt;ClearUserPref(prefname);</span>
<a href="#l18.461"></a><span id="l18.461">   else</span>
<a href="#l18.462"></a><span id="l18.462">     rv = mPrefBranch-&gt;SetBoolPref(prefname, val);</span>
<a href="#l18.463"></a><span id="l18.463"> </span>
<a href="#l18.464"></a><span id="l18.464">   return rv;</span>
<a href="#l18.465"></a><span id="l18.465"> }</span>
<a href="#l18.466"></a><span id="l18.466"> </span>
<a href="#l18.467"></a><span id="l18.467"> NS_IMETHODIMP</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineminus">-nsMsgIncomingServer::GetIntValue(const char *prefname,</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineminus">-                                int32_t *val)</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineminus">-{</span>
<a href="#l18.471"></a><span id="l18.471" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.472"></a><span id="l18.472" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineplus">+nsMsgIncomingServer::GetIntValue(const char *prefname, int32_t *val) {</span>
<a href="#l18.474"></a><span id="l18.474" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.475"></a><span id="l18.475"> </span>
<a href="#l18.476"></a><span id="l18.476">   NS_ENSURE_ARG_POINTER(val);</span>
<a href="#l18.477"></a><span id="l18.477">   *val = 0;</span>
<a href="#l18.478"></a><span id="l18.478"> </span>
<a href="#l18.479"></a><span id="l18.479">   if (NS_FAILED(mPrefBranch-&gt;GetIntPref(prefname, val)))</span>
<a href="#l18.480"></a><span id="l18.480">     mDefPrefBranch-&gt;GetIntPref(prefname, val);</span>
<a href="#l18.481"></a><span id="l18.481"> </span>
<a href="#l18.482"></a><span id="l18.482">   return NS_OK;</span>
<a href="#l18.483"></a><span id="l18.483"> }</span>
<a href="#l18.484"></a><span id="l18.484"> </span>
<a href="#l18.485"></a><span id="l18.485"> NS_IMETHODIMP</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineminus">-nsMsgIncomingServer::GetFileValue(const char* aRelPrefName,</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-                                  const char* aAbsPrefName,</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-                                  nsIFile** aLocalFile)</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineminus">-{</span>
<a href="#l18.490"></a><span id="l18.490" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.491"></a><span id="l18.491" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.492"></a><span id="l18.492" class="difflineplus">+nsMsgIncomingServer::GetFileValue(const char *aRelPrefName,</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineplus">+                                  const char *aAbsPrefName,</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineplus">+                                  nsIFile **aLocalFile) {</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.496"></a><span id="l18.496"> </span>
<a href="#l18.497"></a><span id="l18.497">   // Get the relative first</span>
<a href="#l18.498"></a><span id="l18.498">   nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref;</span>
<a href="#l18.499"></a><span id="l18.499">   nsresult rv = mPrefBranch-&gt;GetComplexValue(aRelPrefName,</span>
<a href="#l18.500"></a><span id="l18.500">                                              NS_GET_IID(nsIRelativeFilePref),</span>
<a href="#l18.501"></a><span id="l18.501">                                              getter_AddRefs(relFilePref));</span>
<a href="#l18.502"></a><span id="l18.502">   if (relFilePref) {</span>
<a href="#l18.503"></a><span id="l18.503">     rv = relFilePref-&gt;GetFile(aLocalFile);</span>
<a href="#l18.504"></a><span id="l18.504">     NS_ASSERTION(*aLocalFile, &quot;An nsIRelativeFilePref has no file.&quot;);</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineminus">-      (*aLocalFile)-&gt;Normalize();</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineplus">+    if (NS_SUCCEEDED(rv)) (*aLocalFile)-&gt;Normalize();</span>
<a href="#l18.508"></a><span id="l18.508">   } else {</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineminus">-    rv = mPrefBranch-&gt;GetComplexValue(aAbsPrefName,</span>
<a href="#l18.510"></a><span id="l18.510" class="difflineminus">-                                      NS_GET_IID(nsIFile),</span>
<a href="#l18.511"></a><span id="l18.511" class="difflineminus">-                                      reinterpret_cast&lt;void**&gt;(aLocalFile));</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineminus">-      return rv;</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineplus">+    rv = mPrefBranch-&gt;GetComplexValue(aAbsPrefName, NS_GET_IID(nsIFile),</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineplus">+                                      reinterpret_cast&lt;void **&gt;(aLocalFile));</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.517"></a><span id="l18.517"> </span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-    nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref = new mozilla::nsRelativeFilePref();</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineplus">+    nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref =</span>
<a href="#l18.520"></a><span id="l18.520" class="difflineplus">+        new mozilla::nsRelativeFilePref();</span>
<a href="#l18.521"></a><span id="l18.521">     mozilla::Unused &lt;&lt; relFilePref-&gt;SetFile(*aLocalFile);</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineminus">-    mozilla::Unused &lt;&lt; relFilePref-&gt;SetRelativeToKey(NS_LITERAL_CSTRING(NS_APP_USER_PROFILE_50_DIR));</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineplus">+    mozilla::Unused &lt;&lt; relFilePref-&gt;SetRelativeToKey(</span>
<a href="#l18.524"></a><span id="l18.524" class="difflineplus">+        NS_LITERAL_CSTRING(NS_APP_USER_PROFILE_50_DIR));</span>
<a href="#l18.525"></a><span id="l18.525"> </span>
<a href="#l18.526"></a><span id="l18.526" class="difflineminus">-    rv = mPrefBranch-&gt;SetComplexValue(aRelPrefName,</span>
<a href="#l18.527"></a><span id="l18.527" class="difflineminus">-                                      NS_GET_IID(nsIRelativeFilePref),</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineminus">-                                      relFilePref);</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineplus">+    rv = mPrefBranch-&gt;SetComplexValue(</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineplus">+        aRelPrefName, NS_GET_IID(nsIRelativeFilePref), relFilePref);</span>
<a href="#l18.531"></a><span id="l18.531">   }</span>
<a href="#l18.532"></a><span id="l18.532"> </span>
<a href="#l18.533"></a><span id="l18.533">   return rv;</span>
<a href="#l18.534"></a><span id="l18.534"> }</span>
<a href="#l18.535"></a><span id="l18.535"> </span>
<a href="#l18.536"></a><span id="l18.536"> NS_IMETHODIMP</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineminus">-nsMsgIncomingServer::SetFileValue(const char* aRelPrefName,</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineminus">-                                  const char* aAbsPrefName,</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineminus">-                                  nsIFile* aLocalFile)</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineminus">-{</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.542"></a><span id="l18.542" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.543"></a><span id="l18.543" class="difflineplus">+nsMsgIncomingServer::SetFileValue(const char *aRelPrefName,</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineplus">+                                  const char *aAbsPrefName,</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineplus">+                                  nsIFile *aLocalFile) {</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.547"></a><span id="l18.547"> </span>
<a href="#l18.548"></a><span id="l18.548">   // Write the relative path.</span>
<a href="#l18.549"></a><span id="l18.549">   nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref = new mozilla::nsRelativeFilePref();</span>
<a href="#l18.550"></a><span id="l18.550">   mozilla::Unused &lt;&lt; relFilePref-&gt;SetFile(aLocalFile);</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineminus">-  mozilla::Unused &lt;&lt; relFilePref-&gt;SetRelativeToKey(NS_LITERAL_CSTRING(NS_APP_USER_PROFILE_50_DIR));</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineplus">+  mozilla::Unused &lt;&lt; relFilePref-&gt;SetRelativeToKey(</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineplus">+      NS_LITERAL_CSTRING(NS_APP_USER_PROFILE_50_DIR));</span>
<a href="#l18.554"></a><span id="l18.554"> </span>
<a href="#l18.555"></a><span id="l18.555" class="difflineminus">-  nsresult rv = mPrefBranch-&gt;SetComplexValue(aRelPrefName,</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineminus">-                                             NS_GET_IID(nsIRelativeFilePref),</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineminus">-                                             relFilePref);</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l18.559"></a><span id="l18.559" class="difflineminus">-    return rv;</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineplus">+  nsresult rv = mPrefBranch-&gt;SetComplexValue(</span>
<a href="#l18.561"></a><span id="l18.561" class="difflineplus">+      aRelPrefName, NS_GET_IID(nsIRelativeFilePref), relFilePref);</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.563"></a><span id="l18.563"> </span>
<a href="#l18.564"></a><span id="l18.564" class="difflineminus">-  return mPrefBranch-&gt;SetComplexValue(aAbsPrefName, NS_GET_IID(nsIFile), aLocalFile);</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineplus">+  return mPrefBranch-&gt;SetComplexValue(aAbsPrefName, NS_GET_IID(nsIFile),</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineplus">+                                      aLocalFile);</span>
<a href="#l18.567"></a><span id="l18.567"> }</span>
<a href="#l18.568"></a><span id="l18.568"> </span>
<a href="#l18.569"></a><span id="l18.569"> NS_IMETHODIMP</span>
<a href="#l18.570"></a><span id="l18.570" class="difflineminus">-nsMsgIncomingServer::SetIntValue(const char *prefname,</span>
<a href="#l18.571"></a><span id="l18.571" class="difflineminus">-                                 int32_t val)</span>
<a href="#l18.572"></a><span id="l18.572" class="difflineminus">-{</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineplus">+nsMsgIncomingServer::SetIntValue(const char *prefname, int32_t val) {</span>
<a href="#l18.576"></a><span id="l18.576" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.577"></a><span id="l18.577"> </span>
<a href="#l18.578"></a><span id="l18.578">   int32_t defaultVal;</span>
<a href="#l18.579"></a><span id="l18.579">   nsresult rv = mDefPrefBranch-&gt;GetIntPref(prefname, &amp;defaultVal);</span>
<a href="#l18.580"></a><span id="l18.580"> </span>
<a href="#l18.581"></a><span id="l18.581">   if (NS_SUCCEEDED(rv) &amp;&amp; defaultVal == val)</span>
<a href="#l18.582"></a><span id="l18.582">     mPrefBranch-&gt;ClearUserPref(prefname);</span>
<a href="#l18.583"></a><span id="l18.583">   else</span>
<a href="#l18.584"></a><span id="l18.584">     rv = mPrefBranch-&gt;SetIntPref(prefname, val);</span>
<a href="#l18.585"></a><span id="l18.585"> </span>
<a href="#l18.586"></a><span id="l18.586">   return rv;</span>
<a href="#l18.587"></a><span id="l18.587"> }</span>
<a href="#l18.588"></a><span id="l18.588"> </span>
<a href="#l18.589"></a><span id="l18.589"> NS_IMETHODIMP</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineminus">-nsMsgIncomingServer::GetCharValue(const char *prefname,</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineminus">-                                  nsACString&amp; val)</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineminus">-{</span>
<a href="#l18.593"></a><span id="l18.593" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.594"></a><span id="l18.594" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineplus">+nsMsgIncomingServer::GetCharValue(const char *prefname, nsACString &amp;val) {</span>
<a href="#l18.596"></a><span id="l18.596" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.597"></a><span id="l18.597"> </span>
<a href="#l18.598"></a><span id="l18.598">   nsCString tmpVal;</span>
<a href="#l18.599"></a><span id="l18.599">   if (NS_FAILED(mPrefBranch-&gt;GetCharPref(prefname, tmpVal)))</span>
<a href="#l18.600"></a><span id="l18.600">     mDefPrefBranch-&gt;GetCharPref(prefname, tmpVal);</span>
<a href="#l18.601"></a><span id="l18.601">   val = tmpVal;</span>
<a href="#l18.602"></a><span id="l18.602">   return NS_OK;</span>
<a href="#l18.603"></a><span id="l18.603"> }</span>
<a href="#l18.604"></a><span id="l18.604"> </span>
<a href="#l18.605"></a><span id="l18.605"> NS_IMETHODIMP</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineminus">-nsMsgIncomingServer::GetUnicharValue(const char *prefname,</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineminus">-                                     nsAString&amp; val)</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineminus">-{</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.611"></a><span id="l18.611" class="difflineplus">+nsMsgIncomingServer::GetUnicharValue(const char *prefname, nsAString &amp;val) {</span>
<a href="#l18.612"></a><span id="l18.612" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.613"></a><span id="l18.613"> </span>
<a href="#l18.614"></a><span id="l18.614">   nsCString valueUtf8;</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineminus">-  if (NS_FAILED(mPrefBranch-&gt;GetStringPref(prefname, EmptyCString(), 0, valueUtf8)))</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineplus">+  if (NS_FAILED(</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineplus">+          mPrefBranch-&gt;GetStringPref(prefname, EmptyCString(), 0, valueUtf8)))</span>
<a href="#l18.618"></a><span id="l18.618">     mDefPrefBranch-&gt;GetStringPref(prefname, EmptyCString(), 0, valueUtf8);</span>
<a href="#l18.619"></a><span id="l18.619">   CopyUTF8toUTF16(valueUtf8, val);</span>
<a href="#l18.620"></a><span id="l18.620">   return NS_OK;</span>
<a href="#l18.621"></a><span id="l18.621"> }</span>
<a href="#l18.622"></a><span id="l18.622"> </span>
<a href="#l18.623"></a><span id="l18.623"> NS_IMETHODIMP</span>
<a href="#l18.624"></a><span id="l18.624" class="difflineminus">-nsMsgIncomingServer::SetCharValue(const char *prefname,</span>
<a href="#l18.625"></a><span id="l18.625" class="difflineminus">-                                  const nsACString&amp; val)</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineminus">-{</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.629"></a><span id="l18.629" class="difflineplus">+nsMsgIncomingServer::SetCharValue(const char *prefname, const nsACString &amp;val) {</span>
<a href="#l18.630"></a><span id="l18.630" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.631"></a><span id="l18.631"> </span>
<a href="#l18.632"></a><span id="l18.632">   if (val.IsEmpty()) {</span>
<a href="#l18.633"></a><span id="l18.633">     mPrefBranch-&gt;ClearUserPref(prefname);</span>
<a href="#l18.634"></a><span id="l18.634">     return NS_OK;</span>
<a href="#l18.635"></a><span id="l18.635">   }</span>
<a href="#l18.636"></a><span id="l18.636"> </span>
<a href="#l18.637"></a><span id="l18.637">   nsCString defaultVal;</span>
<a href="#l18.638"></a><span id="l18.638">   nsresult rv = mDefPrefBranch-&gt;GetCharPref(prefname, defaultVal);</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineat">@@ -576,65 +508,59 @@ nsMsgIncomingServer::SetCharValue(const </span>
<a href="#l18.640"></a><span id="l18.640">   else</span>
<a href="#l18.641"></a><span id="l18.641">     rv = mPrefBranch-&gt;SetCharPref(prefname, val);</span>
<a href="#l18.642"></a><span id="l18.642"> </span>
<a href="#l18.643"></a><span id="l18.643">   return rv;</span>
<a href="#l18.644"></a><span id="l18.644"> }</span>
<a href="#l18.645"></a><span id="l18.645"> </span>
<a href="#l18.646"></a><span id="l18.646"> NS_IMETHODIMP</span>
<a href="#l18.647"></a><span id="l18.647"> nsMsgIncomingServer::SetUnicharValue(const char *prefname,</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineminus">-                                     const nsAString&amp; val)</span>
<a href="#l18.649"></a><span id="l18.649" class="difflineminus">-{</span>
<a href="#l18.650"></a><span id="l18.650" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineplus">+                                     const nsAString &amp;val) {</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.654"></a><span id="l18.654"> </span>
<a href="#l18.655"></a><span id="l18.655">   if (val.IsEmpty()) {</span>
<a href="#l18.656"></a><span id="l18.656">     mPrefBranch-&gt;ClearUserPref(prefname);</span>
<a href="#l18.657"></a><span id="l18.657">     return NS_OK;</span>
<a href="#l18.658"></a><span id="l18.658">   }</span>
<a href="#l18.659"></a><span id="l18.659"> </span>
<a href="#l18.660"></a><span id="l18.660">   nsCString defaultVal;</span>
<a href="#l18.661"></a><span id="l18.661" class="difflineminus">-  nsresult rv = mDefPrefBranch-&gt;GetStringPref(prefname, EmptyCString(), 0, defaultVal);</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineplus">+  nsresult rv =</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineplus">+      mDefPrefBranch-&gt;GetStringPref(prefname, EmptyCString(), 0, defaultVal);</span>
<a href="#l18.664"></a><span id="l18.664"> </span>
<a href="#l18.665"></a><span id="l18.665">   if (NS_SUCCEEDED(rv) &amp;&amp; defaultVal.Equals(NS_ConvertUTF16toUTF8(val)))</span>
<a href="#l18.666"></a><span id="l18.666">     mPrefBranch-&gt;ClearUserPref(prefname);</span>
<a href="#l18.667"></a><span id="l18.667">   else</span>
<a href="#l18.668"></a><span id="l18.668">     rv = mPrefBranch-&gt;SetStringPref(prefname, NS_ConvertUTF16toUTF8(val));</span>
<a href="#l18.669"></a><span id="l18.669"> </span>
<a href="#l18.670"></a><span id="l18.670">   return rv;</span>
<a href="#l18.671"></a><span id="l18.671"> }</span>
<a href="#l18.672"></a><span id="l18.672"> </span>
<a href="#l18.673"></a><span id="l18.673"> // pretty name is the display name to show to the user</span>
<a href="#l18.674"></a><span id="l18.674"> NS_IMETHODIMP</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineminus">-nsMsgIncomingServer::GetPrettyName(nsAString&amp; retval)</span>
<a href="#l18.676"></a><span id="l18.676" class="difflineminus">-{</span>
<a href="#l18.677"></a><span id="l18.677" class="difflineplus">+nsMsgIncomingServer::GetPrettyName(nsAString &amp;retval) {</span>
<a href="#l18.678"></a><span id="l18.678">   nsresult rv = GetUnicharValue(&quot;name&quot;, retval);</span>
<a href="#l18.679"></a><span id="l18.679">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.680"></a><span id="l18.680"> </span>
<a href="#l18.681"></a><span id="l18.681">   // if there's no name, then just return the hostname</span>
<a href="#l18.682"></a><span id="l18.682">   return retval.IsEmpty() ? GetConstructedPrettyName(retval) : rv;</span>
<a href="#l18.683"></a><span id="l18.683"> }</span>
<a href="#l18.684"></a><span id="l18.684"> </span>
<a href="#l18.685"></a><span id="l18.685"> NS_IMETHODIMP</span>
<a href="#l18.686"></a><span id="l18.686" class="difflineminus">-nsMsgIncomingServer::SetPrettyName(const nsAString&amp; value)</span>
<a href="#l18.687"></a><span id="l18.687" class="difflineminus">-{</span>
<a href="#l18.688"></a><span id="l18.688" class="difflineplus">+nsMsgIncomingServer::SetPrettyName(const nsAString &amp;value) {</span>
<a href="#l18.689"></a><span id="l18.689">   SetUnicharValue(&quot;name&quot;, value);</span>
<a href="#l18.690"></a><span id="l18.690">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l18.691"></a><span id="l18.691">   GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l18.692"></a><span id="l18.692" class="difflineminus">-  if (rootFolder)</span>
<a href="#l18.693"></a><span id="l18.693" class="difflineminus">-    rootFolder-&gt;SetPrettyName(value);</span>
<a href="#l18.694"></a><span id="l18.694" class="difflineplus">+  if (rootFolder) rootFolder-&gt;SetPrettyName(value);</span>
<a href="#l18.695"></a><span id="l18.695">   return NS_OK;</span>
<a href="#l18.696"></a><span id="l18.696"> }</span>
<a href="#l18.697"></a><span id="l18.697"> </span>
<a href="#l18.698"></a><span id="l18.698" class="difflineminus">-</span>
<a href="#l18.699"></a><span id="l18.699"> // construct the pretty name to show to the user if they haven't</span>
<a href="#l18.700"></a><span id="l18.700"> // specified one. This should be overridden for news and mail.</span>
<a href="#l18.701"></a><span id="l18.701"> NS_IMETHODIMP</span>
<a href="#l18.702"></a><span id="l18.702" class="difflineminus">-nsMsgIncomingServer::GetConstructedPrettyName(nsAString&amp; retval)</span>
<a href="#l18.703"></a><span id="l18.703" class="difflineminus">-{</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineplus">+nsMsgIncomingServer::GetConstructedPrettyName(nsAString &amp;retval) {</span>
<a href="#l18.705"></a><span id="l18.705">   nsCString username;</span>
<a href="#l18.706"></a><span id="l18.706">   nsresult rv = GetUsername(username);</span>
<a href="#l18.707"></a><span id="l18.707">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.708"></a><span id="l18.708">   if (!username.IsEmpty()) {</span>
<a href="#l18.709"></a><span id="l18.709">     CopyASCIItoUTF16(username, retval);</span>
<a href="#l18.710"></a><span id="l18.710">     retval.AppendLiteral(&quot; on &quot;);</span>
<a href="#l18.711"></a><span id="l18.711">   }</span>
<a href="#l18.712"></a><span id="l18.712"> </span>
<a href="#l18.713"></a><span id="l18.713" class="difflineat">@@ -642,49 +568,45 @@ nsMsgIncomingServer::GetConstructedPrett</span>
<a href="#l18.714"></a><span id="l18.714">   rv = GetHostName(hostname);</span>
<a href="#l18.715"></a><span id="l18.715">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.716"></a><span id="l18.716"> </span>
<a href="#l18.717"></a><span id="l18.717">   retval.Append(NS_ConvertASCIItoUTF16(hostname));</span>
<a href="#l18.718"></a><span id="l18.718">   return NS_OK;</span>
<a href="#l18.719"></a><span id="l18.719"> }</span>
<a href="#l18.720"></a><span id="l18.720"> </span>
<a href="#l18.721"></a><span id="l18.721"> NS_IMETHODIMP</span>
<a href="#l18.722"></a><span id="l18.722" class="difflineminus">-nsMsgIncomingServer::ToString(nsAString&amp; aResult)</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineminus">-{</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineplus">+nsMsgIncomingServer::ToString(nsAString &amp;aResult) {</span>
<a href="#l18.725"></a><span id="l18.725">   aResult.AssignLiteral(&quot;[nsIMsgIncomingServer: &quot;);</span>
<a href="#l18.726"></a><span id="l18.726">   aResult.Append(NS_ConvertASCIItoUTF16(m_serverKey));</span>
<a href="#l18.727"></a><span id="l18.727">   aResult.Append(']');</span>
<a href="#l18.728"></a><span id="l18.728">   return NS_OK;</span>
<a href="#l18.729"></a><span id="l18.729"> }</span>
<a href="#l18.730"></a><span id="l18.730"> </span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::SetPassword(const nsAString&amp; aPassword)</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-{</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::SetPassword(const nsAString &amp;aPassword) {</span>
<a href="#l18.734"></a><span id="l18.734">   m_password = aPassword;</span>
<a href="#l18.735"></a><span id="l18.735">   return NS_OK;</span>
<a href="#l18.736"></a><span id="l18.736"> }</span>
<a href="#l18.737"></a><span id="l18.737"> </span>
<a href="#l18.738"></a><span id="l18.738" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetPassword(nsAString&amp; aPassword)</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineminus">-{</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetPassword(nsAString &amp;aPassword) {</span>
<a href="#l18.741"></a><span id="l18.741">   aPassword = m_password;</span>
<a href="#l18.742"></a><span id="l18.742">   return NS_OK;</span>
<a href="#l18.743"></a><span id="l18.743"> }</span>
<a href="#l18.744"></a><span id="l18.744"> </span>
<a href="#l18.745"></a><span id="l18.745" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l18.746"></a><span id="l18.746" class="difflineminus">-{</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetServerRequiresPasswordForBiff(</span>
<a href="#l18.748"></a><span id="l18.748" class="difflineplus">+    bool *aServerRequiresPasswordForBiff) {</span>
<a href="#l18.749"></a><span id="l18.749">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l18.750"></a><span id="l18.750">   *aServerRequiresPasswordForBiff = true;</span>
<a href="#l18.751"></a><span id="l18.751">   return NS_OK;</span>
<a href="#l18.752"></a><span id="l18.752"> }</span>
<a href="#l18.753"></a><span id="l18.753"> </span>
<a href="#l18.754"></a><span id="l18.754"> // This sets m_password if we find a password in the pw mgr.</span>
<a href="#l18.755"></a><span id="l18.755" class="difflineminus">-nsresult nsMsgIncomingServer::GetPasswordWithoutUI()</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineminus">-{</span>
<a href="#l18.757"></a><span id="l18.757" class="difflineplus">+nsresult nsMsgIncomingServer::GetPasswordWithoutUI() {</span>
<a href="#l18.758"></a><span id="l18.758">   nsresult rv;</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineminus">-  nsCOMPtr&lt;nsILoginManager&gt; loginMgr(do_GetService(NS_LOGINMANAGER_CONTRACTID,</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineminus">-                                                   &amp;rv));</span>
<a href="#l18.761"></a><span id="l18.761" class="difflineplus">+  nsCOMPtr&lt;nsILoginManager&gt; loginMgr(</span>
<a href="#l18.762"></a><span id="l18.762" class="difflineplus">+      do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l18.763"></a><span id="l18.763">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.764"></a><span id="l18.764"> </span>
<a href="#l18.765"></a><span id="l18.765">   // Get the current server URI</span>
<a href="#l18.766"></a><span id="l18.766">   nsCString currServerUri;</span>
<a href="#l18.767"></a><span id="l18.767">   rv = GetLocalStoreType(currServerUri);</span>
<a href="#l18.768"></a><span id="l18.768">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.769"></a><span id="l18.769"> </span>
<a href="#l18.770"></a><span id="l18.770">   currServerUri.AppendLiteral(&quot;://&quot;);</span>
<a href="#l18.771"></a><span id="l18.771" class="difflineat">@@ -693,274 +615,253 @@ nsresult nsMsgIncomingServer::GetPasswor</span>
<a href="#l18.772"></a><span id="l18.772">   rv = GetHostName(temp);</span>
<a href="#l18.773"></a><span id="l18.773">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.774"></a><span id="l18.774"> </span>
<a href="#l18.775"></a><span id="l18.775">   currServerUri.Append(temp);</span>
<a href="#l18.776"></a><span id="l18.776"> </span>
<a href="#l18.777"></a><span id="l18.777">   NS_ConvertUTF8toUTF16 currServer(currServerUri);</span>
<a href="#l18.778"></a><span id="l18.778"> </span>
<a href="#l18.779"></a><span id="l18.779">   uint32_t numLogins = 0;</span>
<a href="#l18.780"></a><span id="l18.780" class="difflineminus">-  nsILoginInfo** logins = nullptr;</span>
<a href="#l18.781"></a><span id="l18.781" class="difflineminus">-  rv = loginMgr-&gt;FindLogins(&amp;numLogins, currServer, EmptyString(),</span>
<a href="#l18.782"></a><span id="l18.782" class="difflineminus">-                            currServer, &amp;logins);</span>
<a href="#l18.783"></a><span id="l18.783" class="difflineplus">+  nsILoginInfo **logins = nullptr;</span>
<a href="#l18.784"></a><span id="l18.784" class="difflineplus">+  rv = loginMgr-&gt;FindLogins(&amp;numLogins, currServer, EmptyString(), currServer,</span>
<a href="#l18.785"></a><span id="l18.785" class="difflineplus">+                            &amp;logins);</span>
<a href="#l18.786"></a><span id="l18.786"> </span>
<a href="#l18.787"></a><span id="l18.787">   // Login manager can produce valid fails, e.g. NS_ERROR_ABORT when a user</span>
<a href="#l18.788"></a><span id="l18.788">   // cancels the master password dialog. Therefore handle that here, but don't</span>
<a href="#l18.789"></a><span id="l18.789">   // warn about it.</span>
<a href="#l18.790"></a><span id="l18.790" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l18.791"></a><span id="l18.791" class="difflineminus">-    return rv;</span>
<a href="#l18.792"></a><span id="l18.792" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.793"></a><span id="l18.793"> </span>
<a href="#l18.794"></a><span id="l18.794">   // Don't abort here, if we didn't find any or failed, then we'll just have</span>
<a href="#l18.795"></a><span id="l18.795">   // to prompt.</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineminus">-  if (numLogins &gt; 0)</span>
<a href="#l18.797"></a><span id="l18.797" class="difflineminus">-  {</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineplus">+  if (numLogins &gt; 0) {</span>
<a href="#l18.799"></a><span id="l18.799">     nsCString serverCUsername;</span>
<a href="#l18.800"></a><span id="l18.800">     rv = GetUsername(serverCUsername);</span>
<a href="#l18.801"></a><span id="l18.801">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.802"></a><span id="l18.802"> </span>
<a href="#l18.803"></a><span id="l18.803">     NS_ConvertUTF8toUTF16 serverUsername(serverCUsername);</span>
<a href="#l18.804"></a><span id="l18.804"> </span>
<a href="#l18.805"></a><span id="l18.805">     nsString username;</span>
<a href="#l18.806"></a><span id="l18.806" class="difflineminus">-    for (uint32_t i = 0; i &lt; numLogins; ++i)</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineminus">-    {</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineplus">+    for (uint32_t i = 0; i &lt; numLogins; ++i) {</span>
<a href="#l18.809"></a><span id="l18.809">       rv = logins[i]-&gt;GetUsername(username);</span>
<a href="#l18.810"></a><span id="l18.810">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.811"></a><span id="l18.811"> </span>
<a href="#l18.812"></a><span id="l18.812" class="difflineminus">-      if (username.Equals(serverUsername))</span>
<a href="#l18.813"></a><span id="l18.813" class="difflineminus">-      {</span>
<a href="#l18.814"></a><span id="l18.814" class="difflineplus">+      if (username.Equals(serverUsername)) {</span>
<a href="#l18.815"></a><span id="l18.815">         nsString password;</span>
<a href="#l18.816"></a><span id="l18.816">         rv = logins[i]-&gt;GetPassword(password);</span>
<a href="#l18.817"></a><span id="l18.817">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.818"></a><span id="l18.818"> </span>
<a href="#l18.819"></a><span id="l18.819">         m_password = password;</span>
<a href="#l18.820"></a><span id="l18.820">         break;</span>
<a href="#l18.821"></a><span id="l18.821">       }</span>
<a href="#l18.822"></a><span id="l18.822">     }</span>
<a href="#l18.823"></a><span id="l18.823">     NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numLogins, logins);</span>
<a href="#l18.824"></a><span id="l18.824">   }</span>
<a href="#l18.825"></a><span id="l18.825">   return NS_OK;</span>
<a href="#l18.826"></a><span id="l18.826"> }</span>
<a href="#l18.827"></a><span id="l18.827"> </span>
<a href="#l18.828"></a><span id="l18.828"> NS_IMETHODIMP</span>
<a href="#l18.829"></a><span id="l18.829" class="difflineminus">-nsMsgIncomingServer::GetPasswordWithUI(const nsAString&amp; aPromptMessage, const</span>
<a href="#l18.830"></a><span id="l18.830" class="difflineminus">-                                       nsAString&amp; aPromptTitle,</span>
<a href="#l18.831"></a><span id="l18.831" class="difflineminus">-                                       nsIMsgWindow* aMsgWindow,</span>
<a href="#l18.832"></a><span id="l18.832" class="difflineminus">-                                       nsAString&amp; aPassword)</span>
<a href="#l18.833"></a><span id="l18.833" class="difflineminus">-{</span>
<a href="#l18.834"></a><span id="l18.834" class="difflineplus">+nsMsgIncomingServer::GetPasswordWithUI(const nsAString &amp;aPromptMessage,</span>
<a href="#l18.835"></a><span id="l18.835" class="difflineplus">+                                       const nsAString &amp;aPromptTitle,</span>
<a href="#l18.836"></a><span id="l18.836" class="difflineplus">+                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.837"></a><span id="l18.837" class="difflineplus">+                                       nsAString &amp;aPassword) {</span>
<a href="#l18.838"></a><span id="l18.838">   nsresult rv = NS_OK;</span>
<a href="#l18.839"></a><span id="l18.839"> </span>
<a href="#l18.840"></a><span id="l18.840" class="difflineminus">-  if (m_password.IsEmpty())</span>
<a href="#l18.841"></a><span id="l18.841" class="difflineminus">-  {</span>
<a href="#l18.842"></a><span id="l18.842" class="difflineplus">+  if (m_password.IsEmpty()) {</span>
<a href="#l18.843"></a><span id="l18.843">     // let's see if we have the password in the password manager and</span>
<a href="#l18.844"></a><span id="l18.844">     // can avoid this prompting thing. This makes it easier to get embedders</span>
<a href="#l18.845"></a><span id="l18.845">     // to get up and running w/o a password prompting UI.</span>
<a href="#l18.846"></a><span id="l18.846">     rv = GetPasswordWithoutUI();</span>
<a href="#l18.847"></a><span id="l18.847">     // If GetPasswordWithoutUI returns NS_ERROR_ABORT, the most likely case</span>
<a href="#l18.848"></a><span id="l18.848">     // is the user canceled getting the master password, so just return</span>
<a href="#l18.849"></a><span id="l18.849">     // straight away, as they won't want to get prompted again.</span>
<a href="#l18.850"></a><span id="l18.850" class="difflineminus">-    if (rv == NS_ERROR_ABORT)</span>
<a href="#l18.851"></a><span id="l18.851" class="difflineminus">-      return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l18.852"></a><span id="l18.852" class="difflineplus">+    if (rv == NS_ERROR_ABORT) return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l18.853"></a><span id="l18.853">   }</span>
<a href="#l18.854"></a><span id="l18.854" class="difflineminus">-  if (m_password.IsEmpty())</span>
<a href="#l18.855"></a><span id="l18.855" class="difflineminus">-  {</span>
<a href="#l18.856"></a><span id="l18.856" class="difflineplus">+  if (m_password.IsEmpty()) {</span>
<a href="#l18.857"></a><span id="l18.857">     nsCOMPtr&lt;nsIAuthPrompt&gt; dialog;</span>
<a href="#l18.858"></a><span id="l18.858">     // aMsgWindow is required if we need to prompt</span>
<a href="#l18.859"></a><span id="l18.859" class="difflineminus">-    if (aMsgWindow)</span>
<a href="#l18.860"></a><span id="l18.860" class="difflineminus">-    {</span>
<a href="#l18.861"></a><span id="l18.861" class="difflineplus">+    if (aMsgWindow) {</span>
<a href="#l18.862"></a><span id="l18.862">       rv = aMsgWindow-&gt;GetAuthPrompt(getter_AddRefs(dialog));</span>
<a href="#l18.863"></a><span id="l18.863">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.864"></a><span id="l18.864">     }</span>
<a href="#l18.865"></a><span id="l18.865" class="difflineminus">-    if (dialog)</span>
<a href="#l18.866"></a><span id="l18.866" class="difflineminus">-    {</span>
<a href="#l18.867"></a><span id="l18.867" class="difflineplus">+    if (dialog) {</span>
<a href="#l18.868"></a><span id="l18.868">       // prompt the user for the password</span>
<a href="#l18.869"></a><span id="l18.869">       nsCString serverUri;</span>
<a href="#l18.870"></a><span id="l18.870">       rv = GetLocalStoreType(serverUri);</span>
<a href="#l18.871"></a><span id="l18.871">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.872"></a><span id="l18.872"> </span>
<a href="#l18.873"></a><span id="l18.873">       serverUri.AppendLiteral(&quot;://&quot;);</span>
<a href="#l18.874"></a><span id="l18.874">       nsCString temp;</span>
<a href="#l18.875"></a><span id="l18.875">       rv = GetUsername(temp);</span>
<a href="#l18.876"></a><span id="l18.876">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.877"></a><span id="l18.877"> </span>
<a href="#l18.878"></a><span id="l18.878" class="difflineminus">-      if (!temp.IsEmpty())</span>
<a href="#l18.879"></a><span id="l18.879" class="difflineminus">-      {</span>
<a href="#l18.880"></a><span id="l18.880" class="difflineplus">+      if (!temp.IsEmpty()) {</span>
<a href="#l18.881"></a><span id="l18.881">         nsCString escapedUsername;</span>
<a href="#l18.882"></a><span id="l18.882">         MsgEscapeString(temp, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l18.883"></a><span id="l18.883">         serverUri.Append(escapedUsername);</span>
<a href="#l18.884"></a><span id="l18.884">         serverUri.Append('@');</span>
<a href="#l18.885"></a><span id="l18.885">       }</span>
<a href="#l18.886"></a><span id="l18.886"> </span>
<a href="#l18.887"></a><span id="l18.887">       rv = GetHostName(temp);</span>
<a href="#l18.888"></a><span id="l18.888">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.889"></a><span id="l18.889"> </span>
<a href="#l18.890"></a><span id="l18.890">       serverUri.Append(temp);</span>
<a href="#l18.891"></a><span id="l18.891"> </span>
<a href="#l18.892"></a><span id="l18.892">       // we pass in the previously used password, if any, into PromptPassword</span>
<a href="#l18.893"></a><span id="l18.893">       // so that it will appear as ******. This means we can't use an nsString</span>
<a href="#l18.894"></a><span id="l18.894">       // and getter_Copies.</span>
<a href="#l18.895"></a><span id="l18.895">       char16_t *uniPassword = nullptr;</span>
<a href="#l18.896"></a><span id="l18.896" class="difflineminus">-      if (!aPassword.IsEmpty())</span>
<a href="#l18.897"></a><span id="l18.897" class="difflineminus">-        uniPassword = ToNewUnicode(aPassword);</span>
<a href="#l18.898"></a><span id="l18.898" class="difflineplus">+      if (!aPassword.IsEmpty()) uniPassword = ToNewUnicode(aPassword);</span>
<a href="#l18.899"></a><span id="l18.899"> </span>
<a href="#l18.900"></a><span id="l18.900">       bool okayValue = true;</span>
<a href="#l18.901"></a><span id="l18.901">       rv = dialog-&gt;PromptPassword(PromiseFlatString(aPromptTitle).get(),</span>
<a href="#l18.902"></a><span id="l18.902">                                   PromiseFlatString(aPromptMessage).get(),</span>
<a href="#l18.903"></a><span id="l18.903">                                   NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l18.904"></a><span id="l18.904">                                   nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l18.905"></a><span id="l18.905">                                   &amp;uniPassword, &amp;okayValue);</span>
<a href="#l18.906"></a><span id="l18.906">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.907"></a><span id="l18.907"> </span>
<a href="#l18.908"></a><span id="l18.908" class="difflineminus">-      if (!okayValue) // if the user pressed cancel, just return an empty string;</span>
<a href="#l18.909"></a><span id="l18.909" class="difflineplus">+      if (!okayValue)  // if the user pressed cancel, just return an empty</span>
<a href="#l18.910"></a><span id="l18.910" class="difflineplus">+                       // string;</span>
<a href="#l18.911"></a><span id="l18.911">       {</span>
<a href="#l18.912"></a><span id="l18.912">         aPassword.Truncate();</span>
<a href="#l18.913"></a><span id="l18.913">         return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l18.914"></a><span id="l18.914">       }</span>
<a href="#l18.915"></a><span id="l18.915"> </span>
<a href="#l18.916"></a><span id="l18.916">       // we got a password back...so remember it</span>
<a href="#l18.917"></a><span id="l18.917">       rv = SetPassword(nsDependentString(uniPassword));</span>
<a href="#l18.918"></a><span id="l18.918">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.919"></a><span id="l18.919"> </span>
<a href="#l18.920"></a><span id="l18.920">       PR_FREEIF(uniPassword);</span>
<a href="#l18.921"></a><span id="l18.921" class="difflineminus">-    } // if we got a prompt dialog</span>
<a href="#l18.922"></a><span id="l18.922" class="difflineplus">+    }  // if we got a prompt dialog</span>
<a href="#l18.923"></a><span id="l18.923">     else</span>
<a href="#l18.924"></a><span id="l18.924">       return NS_ERROR_FAILURE;</span>
<a href="#l18.925"></a><span id="l18.925" class="difflineminus">-  } // if the password is empty</span>
<a href="#l18.926"></a><span id="l18.926" class="difflineplus">+  }  // if the password is empty</span>
<a href="#l18.927"></a><span id="l18.927">   return GetPassword(aPassword);</span>
<a href="#l18.928"></a><span id="l18.928"> }</span>
<a href="#l18.929"></a><span id="l18.929"> </span>
<a href="#l18.930"></a><span id="l18.930"> NS_IMETHODIMP</span>
<a href="#l18.931"></a><span id="l18.931" class="difflineminus">-nsMsgIncomingServer::ForgetPassword()</span>
<a href="#l18.932"></a><span id="l18.932" class="difflineminus">-{</span>
<a href="#l18.933"></a><span id="l18.933" class="difflineplus">+nsMsgIncomingServer::ForgetPassword() {</span>
<a href="#l18.934"></a><span id="l18.934">   nsresult rv;</span>
<a href="#l18.935"></a><span id="l18.935">   nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l18.936"></a><span id="l18.936" class="difflineminus">-    do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.937"></a><span id="l18.937" class="difflineplus">+      do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.938"></a><span id="l18.938">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.939"></a><span id="l18.939"> </span>
<a href="#l18.940"></a><span id="l18.940">   // Get the current server URI</span>
<a href="#l18.941"></a><span id="l18.941">   nsCString currServerUri;</span>
<a href="#l18.942"></a><span id="l18.942">   rv = GetLocalStoreType(currServerUri);</span>
<a href="#l18.943"></a><span id="l18.943">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.944"></a><span id="l18.944"> </span>
<a href="#l18.945"></a><span id="l18.945">   currServerUri.AppendLiteral(&quot;://&quot;);</span>
<a href="#l18.946"></a><span id="l18.946"> </span>
<a href="#l18.947"></a><span id="l18.947">   nsCString temp;</span>
<a href="#l18.948"></a><span id="l18.948">   rv = GetHostName(temp);</span>
<a href="#l18.949"></a><span id="l18.949">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.950"></a><span id="l18.950"> </span>
<a href="#l18.951"></a><span id="l18.951">   currServerUri.Append(temp);</span>
<a href="#l18.952"></a><span id="l18.952"> </span>
<a href="#l18.953"></a><span id="l18.953">   uint32_t count;</span>
<a href="#l18.954"></a><span id="l18.954" class="difflineminus">-  nsILoginInfo** logins;</span>
<a href="#l18.955"></a><span id="l18.955" class="difflineplus">+  nsILoginInfo **logins;</span>
<a href="#l18.956"></a><span id="l18.956"> </span>
<a href="#l18.957"></a><span id="l18.957">   NS_ConvertUTF8toUTF16 currServer(currServerUri);</span>
<a href="#l18.958"></a><span id="l18.958"> </span>
<a href="#l18.959"></a><span id="l18.959">   nsCString serverCUsername;</span>
<a href="#l18.960"></a><span id="l18.960">   rv = GetUsername(serverCUsername);</span>
<a href="#l18.961"></a><span id="l18.961">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.962"></a><span id="l18.962"> </span>
<a href="#l18.963"></a><span id="l18.963">   NS_ConvertUTF8toUTF16 serverUsername(serverCUsername);</span>
<a href="#l18.964"></a><span id="l18.964"> </span>
<a href="#l18.965"></a><span id="l18.965" class="difflineminus">-  rv = loginMgr-&gt;FindLogins(&amp;count, currServer, EmptyString(),</span>
<a href="#l18.966"></a><span id="l18.966" class="difflineminus">-                            currServer, &amp;logins);</span>
<a href="#l18.967"></a><span id="l18.967" class="difflineplus">+  rv = loginMgr-&gt;FindLogins(&amp;count, currServer, EmptyString(), currServer,</span>
<a href="#l18.968"></a><span id="l18.968" class="difflineplus">+                            &amp;logins);</span>
<a href="#l18.969"></a><span id="l18.969">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.970"></a><span id="l18.970"> </span>
<a href="#l18.971"></a><span id="l18.971">   // There should only be one-login stored for this url, however just in case</span>
<a href="#l18.972"></a><span id="l18.972">   // there isn't.</span>
<a href="#l18.973"></a><span id="l18.973">   nsString username;</span>
<a href="#l18.974"></a><span id="l18.974" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l18.975"></a><span id="l18.975" class="difflineminus">-  {</span>
<a href="#l18.976"></a><span id="l18.976" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l18.977"></a><span id="l18.977">     if (NS_SUCCEEDED(logins[i]-&gt;GetUsername(username)) &amp;&amp;</span>
<a href="#l18.978"></a><span id="l18.978" class="difflineminus">-        username.Equals(serverUsername))</span>
<a href="#l18.979"></a><span id="l18.979" class="difflineminus">-    {</span>
<a href="#l18.980"></a><span id="l18.980" class="difflineplus">+        username.Equals(serverUsername)) {</span>
<a href="#l18.981"></a><span id="l18.981">       // If this fails, just continue, we'll still want to remove the password</span>
<a href="#l18.982"></a><span id="l18.982">       // from our local cache.</span>
<a href="#l18.983"></a><span id="l18.983">       loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l18.984"></a><span id="l18.984">     }</span>
<a href="#l18.985"></a><span id="l18.985">   }</span>
<a href="#l18.986"></a><span id="l18.986">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l18.987"></a><span id="l18.987"> </span>
<a href="#l18.988"></a><span id="l18.988">   return SetPassword(EmptyString());</span>
<a href="#l18.989"></a><span id="l18.989"> }</span>
<a href="#l18.990"></a><span id="l18.990"> </span>
<a href="#l18.991"></a><span id="l18.991"> NS_IMETHODIMP</span>
<a href="#l18.992"></a><span id="l18.992" class="difflineminus">-nsMsgIncomingServer::ForgetSessionPassword()</span>
<a href="#l18.993"></a><span id="l18.993" class="difflineminus">-{</span>
<a href="#l18.994"></a><span id="l18.994" class="difflineplus">+nsMsgIncomingServer::ForgetSessionPassword() {</span>
<a href="#l18.995"></a><span id="l18.995">   m_password.Truncate();</span>
<a href="#l18.996"></a><span id="l18.996">   return NS_OK;</span>
<a href="#l18.997"></a><span id="l18.997"> }</span>
<a href="#l18.998"></a><span id="l18.998"> </span>
<a href="#l18.999"></a><span id="l18.999"> NS_IMETHODIMP</span>
<a href="#l18.1000"></a><span id="l18.1000" class="difflineminus">-nsMsgIncomingServer::SetDefaultLocalPath(nsIFile *aDefaultLocalPath)</span>
<a href="#l18.1001"></a><span id="l18.1001" class="difflineminus">-{</span>
<a href="#l18.1002"></a><span id="l18.1002" class="difflineplus">+nsMsgIncomingServer::SetDefaultLocalPath(nsIFile *aDefaultLocalPath) {</span>
<a href="#l18.1003"></a><span id="l18.1003">   nsresult rv;</span>
<a href="#l18.1004"></a><span id="l18.1004">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l18.1005"></a><span id="l18.1005">   rv = GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l18.1006"></a><span id="l18.1006">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1007"></a><span id="l18.1007">   return protocolInfo-&gt;SetDefaultLocalPath(aDefaultLocalPath);</span>
<a href="#l18.1008"></a><span id="l18.1008"> }</span>
<a href="#l18.1009"></a><span id="l18.1009"> </span>
<a href="#l18.1010"></a><span id="l18.1010"> NS_IMETHODIMP</span>
<a href="#l18.1011"></a><span id="l18.1011" class="difflineminus">-nsMsgIncomingServer::GetLocalPath(nsIFile **aLocalPath)</span>
<a href="#l18.1012"></a><span id="l18.1012" class="difflineminus">-{</span>
<a href="#l18.1013"></a><span id="l18.1013" class="difflineplus">+nsMsgIncomingServer::GetLocalPath(nsIFile **aLocalPath) {</span>
<a href="#l18.1014"></a><span id="l18.1014">   nsresult rv;</span>
<a href="#l18.1015"></a><span id="l18.1015"> </span>
<a href="#l18.1016"></a><span id="l18.1016">   // if the local path has already been set, use it</span>
<a href="#l18.1017"></a><span id="l18.1017">   rv = GetFileValue(&quot;directory-rel&quot;, &quot;directory&quot;, aLocalPath);</span>
<a href="#l18.1018"></a><span id="l18.1018" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; *aLocalPath)</span>
<a href="#l18.1019"></a><span id="l18.1019" class="difflineminus">-    return rv;</span>
<a href="#l18.1020"></a><span id="l18.1020" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; *aLocalPath) return rv;</span>
<a href="#l18.1021"></a><span id="l18.1021"> </span>
<a href="#l18.1022"></a><span id="l18.1022">   // otherwise, create the path using the protocol info.</span>
<a href="#l18.1023"></a><span id="l18.1023">   // note we are using the</span>
<a href="#l18.1024"></a><span id="l18.1024">   // hostname, unless that directory exists.</span>
<a href="#l18.1025"></a><span id="l18.1025" class="difflineminus">-// this should prevent all collisions.</span>
<a href="#l18.1026"></a><span id="l18.1026" class="difflineplus">+  // this should prevent all collisions.</span>
<a href="#l18.1027"></a><span id="l18.1027">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l18.1028"></a><span id="l18.1028">   rv = GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l18.1029"></a><span id="l18.1029">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1030"></a><span id="l18.1030"> </span>
<a href="#l18.1031"></a><span id="l18.1031">   nsCOMPtr&lt;nsIFile&gt; localPath;</span>
<a href="#l18.1032"></a><span id="l18.1032">   rv = protocolInfo-&gt;GetDefaultLocalPath(getter_AddRefs(localPath));</span>
<a href="#l18.1033"></a><span id="l18.1033">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1034"></a><span id="l18.1034">   rv = localPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l18.1035"></a><span id="l18.1035" class="difflineminus">-  if (rv == NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l18.1036"></a><span id="l18.1036" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l18.1037"></a><span id="l18.1037" class="difflineplus">+  if (rv == NS_ERROR_FILE_ALREADY_EXISTS) rv = NS_OK;</span>
<a href="#l18.1038"></a><span id="l18.1038">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1039"></a><span id="l18.1039"> </span>
<a href="#l18.1040"></a><span id="l18.1040">   nsCString hostname;</span>
<a href="#l18.1041"></a><span id="l18.1041">   rv = GetHostName(hostname);</span>
<a href="#l18.1042"></a><span id="l18.1042">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1043"></a><span id="l18.1043"> </span>
<a href="#l18.1044"></a><span id="l18.1044" class="difflineminus">-  // set the leaf name to &quot;dummy&quot;, and then call MakeUnique with a suggested leaf name</span>
<a href="#l18.1045"></a><span id="l18.1045" class="difflineplus">+  // set the leaf name to &quot;dummy&quot;, and then call MakeUnique with a suggested</span>
<a href="#l18.1046"></a><span id="l18.1046" class="difflineplus">+  // leaf name</span>
<a href="#l18.1047"></a><span id="l18.1047">   rv = localPath-&gt;AppendNative(hostname);</span>
<a href="#l18.1048"></a><span id="l18.1048">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1049"></a><span id="l18.1049">   rv = localPath-&gt;CreateUnique(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l18.1050"></a><span id="l18.1050">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1051"></a><span id="l18.1051"> </span>
<a href="#l18.1052"></a><span id="l18.1052">   rv = SetLocalPath(localPath);</span>
<a href="#l18.1053"></a><span id="l18.1053">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1054"></a><span id="l18.1054"> </span>
<a href="#l18.1055"></a><span id="l18.1055">   localPath.forget(aLocalPath);</span>
<a href="#l18.1056"></a><span id="l18.1056">   return NS_OK;</span>
<a href="#l18.1057"></a><span id="l18.1057"> }</span>
<a href="#l18.1058"></a><span id="l18.1058"> </span>
<a href="#l18.1059"></a><span id="l18.1059"> NS_IMETHODIMP</span>
<a href="#l18.1060"></a><span id="l18.1060" class="difflineminus">-nsMsgIncomingServer::GetMsgStore(nsIMsgPluggableStore **aMsgStore)</span>
<a href="#l18.1061"></a><span id="l18.1061" class="difflineminus">-{</span>
<a href="#l18.1062"></a><span id="l18.1062" class="difflineplus">+nsMsgIncomingServer::GetMsgStore(nsIMsgPluggableStore **aMsgStore) {</span>
<a href="#l18.1063"></a><span id="l18.1063">   NS_ENSURE_ARG_POINTER(aMsgStore);</span>
<a href="#l18.1064"></a><span id="l18.1064" class="difflineminus">-  if (!m_msgStore)</span>
<a href="#l18.1065"></a><span id="l18.1065" class="difflineminus">-  {</span>
<a href="#l18.1066"></a><span id="l18.1066" class="difflineplus">+  if (!m_msgStore) {</span>
<a href="#l18.1067"></a><span id="l18.1067">     nsCString storeContractID;</span>
<a href="#l18.1068"></a><span id="l18.1068">     nsresult rv;</span>
<a href="#l18.1069"></a><span id="l18.1069">     // We don't want there to be a default pref, I think, since</span>
<a href="#l18.1070"></a><span id="l18.1070">     // we can't change the default. We may want no pref to mean</span>
<a href="#l18.1071"></a><span id="l18.1071">     // berkeley store, and then set the store pref off of some sort</span>
<a href="#l18.1072"></a><span id="l18.1072">     // of default when creating a server. But we need to make sure</span>
<a href="#l18.1073"></a><span id="l18.1073">     // that we do always write a store pref.</span>
<a href="#l18.1074"></a><span id="l18.1074">     GetCharValue(&quot;storeContractID&quot;, storeContractID);</span>
<a href="#l18.1075"></a><span id="l18.1075" class="difflineminus">-    if (storeContractID.IsEmpty())</span>
<a href="#l18.1076"></a><span id="l18.1076" class="difflineminus">-    {</span>
<a href="#l18.1077"></a><span id="l18.1077" class="difflineplus">+    if (storeContractID.IsEmpty()) {</span>
<a href="#l18.1078"></a><span id="l18.1078">       storeContractID.AssignLiteral(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l18.1079"></a><span id="l18.1079">       SetCharValue(&quot;storeContractID&quot;, storeContractID);</span>
<a href="#l18.1080"></a><span id="l18.1080">     }</span>
<a href="#l18.1081"></a><span id="l18.1081"> </span>
<a href="#l18.1082"></a><span id="l18.1082">     // After someone starts using the pluggable store, we can no longer</span>
<a href="#l18.1083"></a><span id="l18.1083">     // change the value.</span>
<a href="#l18.1084"></a><span id="l18.1084">     SetBoolValue(&quot;canChangeStoreType&quot;, false);</span>
<a href="#l18.1085"></a><span id="l18.1085"> </span>
<a href="#l18.1086"></a><span id="l18.1086" class="difflineat">@@ -970,50 +871,46 @@ nsMsgIncomingServer::GetMsgStore(nsIMsgP</span>
<a href="#l18.1087"></a><span id="l18.1087">     m_msgStore = do_CreateInstance(storeContractID.get(), &amp;rv);</span>
<a href="#l18.1088"></a><span id="l18.1088">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1089"></a><span id="l18.1089">   }</span>
<a href="#l18.1090"></a><span id="l18.1090">   NS_IF_ADDREF(*aMsgStore = m_msgStore);</span>
<a href="#l18.1091"></a><span id="l18.1091">   return NS_OK;</span>
<a href="#l18.1092"></a><span id="l18.1092"> }</span>
<a href="#l18.1093"></a><span id="l18.1093"> </span>
<a href="#l18.1094"></a><span id="l18.1094"> NS_IMETHODIMP</span>
<a href="#l18.1095"></a><span id="l18.1095" class="difflineminus">-nsMsgIncomingServer::SetLocalPath(nsIFile *aLocalPath)</span>
<a href="#l18.1096"></a><span id="l18.1096" class="difflineminus">-{</span>
<a href="#l18.1097"></a><span id="l18.1097" class="difflineplus">+nsMsgIncomingServer::SetLocalPath(nsIFile *aLocalPath) {</span>
<a href="#l18.1098"></a><span id="l18.1098">   NS_ENSURE_ARG_POINTER(aLocalPath);</span>
<a href="#l18.1099"></a><span id="l18.1099">   nsresult rv = aLocalPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l18.1100"></a><span id="l18.1100" class="difflineminus">-  if (rv == NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l18.1101"></a><span id="l18.1101" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l18.1102"></a><span id="l18.1102" class="difflineplus">+  if (rv == NS_ERROR_FILE_ALREADY_EXISTS) rv = NS_OK;</span>
<a href="#l18.1103"></a><span id="l18.1103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1104"></a><span id="l18.1104">   return SetFileValue(&quot;directory-rel&quot;, &quot;directory&quot;, aLocalPath);</span>
<a href="#l18.1105"></a><span id="l18.1105"> }</span>
<a href="#l18.1106"></a><span id="l18.1106"> </span>
<a href="#l18.1107"></a><span id="l18.1107"> NS_IMETHODIMP</span>
<a href="#l18.1108"></a><span id="l18.1108" class="difflineminus">-nsMsgIncomingServer::GetLocalStoreType(nsACString&amp; aResult)</span>
<a href="#l18.1109"></a><span id="l18.1109" class="difflineminus">-{</span>
<a href="#l18.1110"></a><span id="l18.1110" class="difflineminus">-  MOZ_ASSERT_UNREACHABLE(&quot;nsMsgIncomingServer superclass not implementing GetLocalStoreType!&quot;);</span>
<a href="#l18.1111"></a><span id="l18.1111" class="difflineplus">+nsMsgIncomingServer::GetLocalStoreType(nsACString &amp;aResult) {</span>
<a href="#l18.1112"></a><span id="l18.1112" class="difflineplus">+  MOZ_ASSERT_UNREACHABLE(</span>
<a href="#l18.1113"></a><span id="l18.1113" class="difflineplus">+      &quot;nsMsgIncomingServer superclass not implementing GetLocalStoreType!&quot;);</span>
<a href="#l18.1114"></a><span id="l18.1114">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l18.1115"></a><span id="l18.1115"> }</span>
<a href="#l18.1116"></a><span id="l18.1116"> </span>
<a href="#l18.1117"></a><span id="l18.1117"> NS_IMETHODIMP</span>
<a href="#l18.1118"></a><span id="l18.1118" class="difflineminus">-nsMsgIncomingServer::GetLocalDatabaseType(nsACString&amp; aResult)</span>
<a href="#l18.1119"></a><span id="l18.1119" class="difflineminus">-{</span>
<a href="#l18.1120"></a><span id="l18.1120" class="difflineminus">-  MOZ_ASSERT_UNREACHABLE(&quot;nsMsgIncomingServer superclass not implementing GetLocalDatabaseType!&quot;);</span>
<a href="#l18.1121"></a><span id="l18.1121" class="difflineplus">+nsMsgIncomingServer::GetLocalDatabaseType(nsACString &amp;aResult) {</span>
<a href="#l18.1122"></a><span id="l18.1122" class="difflineplus">+  MOZ_ASSERT_UNREACHABLE(</span>
<a href="#l18.1123"></a><span id="l18.1123" class="difflineplus">+      &quot;nsMsgIncomingServer superclass not implementing GetLocalDatabaseType!&quot;);</span>
<a href="#l18.1124"></a><span id="l18.1124">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l18.1125"></a><span id="l18.1125"> }</span>
<a href="#l18.1126"></a><span id="l18.1126"> </span>
<a href="#l18.1127"></a><span id="l18.1127"> NS_IMETHODIMP</span>
<a href="#l18.1128"></a><span id="l18.1128" class="difflineminus">-nsMsgIncomingServer::GetAccountManagerChrome(nsAString&amp; aResult)</span>
<a href="#l18.1129"></a><span id="l18.1129" class="difflineminus">-{</span>
<a href="#l18.1130"></a><span id="l18.1130" class="difflineplus">+nsMsgIncomingServer::GetAccountManagerChrome(nsAString &amp;aResult) {</span>
<a href="#l18.1131"></a><span id="l18.1131">   aResult.AssignLiteral(&quot;am-main.xul&quot;);</span>
<a href="#l18.1132"></a><span id="l18.1132">   return NS_OK;</span>
<a href="#l18.1133"></a><span id="l18.1133"> }</span>
<a href="#l18.1134"></a><span id="l18.1134"> </span>
<a href="#l18.1135"></a><span id="l18.1135"> NS_IMETHODIMP</span>
<a href="#l18.1136"></a><span id="l18.1136" class="difflineminus">-nsMsgIncomingServer::Equals(nsIMsgIncomingServer *server, bool *_retval)</span>
<a href="#l18.1137"></a><span id="l18.1137" class="difflineminus">-{</span>
<a href="#l18.1138"></a><span id="l18.1138" class="difflineplus">+nsMsgIncomingServer::Equals(nsIMsgIncomingServer *server, bool *_retval) {</span>
<a href="#l18.1139"></a><span id="l18.1139">   nsresult rv;</span>
<a href="#l18.1140"></a><span id="l18.1140"> </span>
<a href="#l18.1141"></a><span id="l18.1141">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l18.1142"></a><span id="l18.1142">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l18.1143"></a><span id="l18.1143"> </span>
<a href="#l18.1144"></a><span id="l18.1144">   nsCString key1;</span>
<a href="#l18.1145"></a><span id="l18.1145">   nsCString key2;</span>
<a href="#l18.1146"></a><span id="l18.1146"> </span>
<a href="#l18.1147"></a><span id="l18.1147" class="difflineat">@@ -1025,139 +922,133 @@ nsMsgIncomingServer::Equals(nsIMsgIncomi</span>
<a href="#l18.1148"></a><span id="l18.1148"> </span>
<a href="#l18.1149"></a><span id="l18.1149">   // compare the server keys</span>
<a href="#l18.1150"></a><span id="l18.1150">   *_retval = key1.Equals(key2, nsCaseInsensitiveCStringComparator());</span>
<a href="#l18.1151"></a><span id="l18.1151"> </span>
<a href="#l18.1152"></a><span id="l18.1152">   return rv;</span>
<a href="#l18.1153"></a><span id="l18.1153"> }</span>
<a href="#l18.1154"></a><span id="l18.1154"> </span>
<a href="#l18.1155"></a><span id="l18.1155"> NS_IMETHODIMP</span>
<a href="#l18.1156"></a><span id="l18.1156" class="difflineminus">-nsMsgIncomingServer::ClearAllValues()</span>
<a href="#l18.1157"></a><span id="l18.1157" class="difflineminus">-{</span>
<a href="#l18.1158"></a><span id="l18.1158" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.1159"></a><span id="l18.1159" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1160"></a><span id="l18.1160" class="difflineplus">+nsMsgIncomingServer::ClearAllValues() {</span>
<a href="#l18.1161"></a><span id="l18.1161" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1162"></a><span id="l18.1162"> </span>
<a href="#l18.1163"></a><span id="l18.1163">   return mPrefBranch-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l18.1164"></a><span id="l18.1164"> }</span>
<a href="#l18.1165"></a><span id="l18.1165"> </span>
<a href="#l18.1166"></a><span id="l18.1166"> NS_IMETHODIMP</span>
<a href="#l18.1167"></a><span id="l18.1167" class="difflineminus">-nsMsgIncomingServer::RemoveFiles()</span>
<a href="#l18.1168"></a><span id="l18.1168" class="difflineminus">-{</span>
<a href="#l18.1169"></a><span id="l18.1169" class="difflineplus">+nsMsgIncomingServer::RemoveFiles() {</span>
<a href="#l18.1170"></a><span id="l18.1170">   // IMPORTANT, see bug #77652</span>
<a href="#l18.1171"></a><span id="l18.1171">   // TODO: Decide what to do for deferred accounts.</span>
<a href="#l18.1172"></a><span id="l18.1172">   nsCString deferredToAccount;</span>
<a href="#l18.1173"></a><span id="l18.1173">   GetCharValue(&quot;deferred_to_account&quot;, deferredToAccount);</span>
<a href="#l18.1174"></a><span id="l18.1174">   bool isDeferredTo = true;</span>
<a href="#l18.1175"></a><span id="l18.1175">   GetIsDeferredTo(&amp;isDeferredTo);</span>
<a href="#l18.1176"></a><span id="l18.1176" class="difflineminus">-  if (!deferredToAccount.IsEmpty() || isDeferredTo)</span>
<a href="#l18.1177"></a><span id="l18.1177" class="difflineminus">-  {</span>
<a href="#l18.1178"></a><span id="l18.1178" class="difflineplus">+  if (!deferredToAccount.IsEmpty() || isDeferredTo) {</span>
<a href="#l18.1179"></a><span id="l18.1179">     NS_ASSERTION(false, &quot;shouldn't remove files for a deferred account&quot;);</span>
<a href="#l18.1180"></a><span id="l18.1180">     return NS_ERROR_FAILURE;</span>
<a href="#l18.1181"></a><span id="l18.1181">   }</span>
<a href="#l18.1182"></a><span id="l18.1182" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; localPath;</span>
<a href="#l18.1183"></a><span id="l18.1183" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localPath;</span>
<a href="#l18.1184"></a><span id="l18.1184">   nsresult rv = GetLocalPath(getter_AddRefs(localPath));</span>
<a href="#l18.1185"></a><span id="l18.1185">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1186"></a><span id="l18.1186">   return localPath-&gt;Remove(true);</span>
<a href="#l18.1187"></a><span id="l18.1187"> }</span>
<a href="#l18.1188"></a><span id="l18.1188"> </span>
<a href="#l18.1189"></a><span id="l18.1189"> NS_IMETHODIMP</span>
<a href="#l18.1190"></a><span id="l18.1190" class="difflineminus">-nsMsgIncomingServer::SetFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l18.1191"></a><span id="l18.1191" class="difflineminus">-{</span>
<a href="#l18.1192"></a><span id="l18.1192" class="difflineplus">+nsMsgIncomingServer::SetFilterList(nsIMsgFilterList *aFilterList) {</span>
<a href="#l18.1193"></a><span id="l18.1193">   mFilterList = aFilterList;</span>
<a href="#l18.1194"></a><span id="l18.1194">   return NS_OK;</span>
<a href="#l18.1195"></a><span id="l18.1195"> }</span>
<a href="#l18.1196"></a><span id="l18.1196"> </span>
<a href="#l18.1197"></a><span id="l18.1197"> NS_IMETHODIMP</span>
<a href="#l18.1198"></a><span id="l18.1198" class="difflineminus">-nsMsgIncomingServer::GetFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l18.1199"></a><span id="l18.1199" class="difflineminus">-{</span>
<a href="#l18.1200"></a><span id="l18.1200" class="difflineplus">+nsMsgIncomingServer::GetFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.1201"></a><span id="l18.1201" class="difflineplus">+                                   nsIMsgFilterList **aResult) {</span>
<a href="#l18.1202"></a><span id="l18.1202">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.1203"></a><span id="l18.1203" class="difflineminus">-  if (!mFilterList)</span>
<a href="#l18.1204"></a><span id="l18.1204" class="difflineminus">-  {</span>
<a href="#l18.1205"></a><span id="l18.1205" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l18.1206"></a><span id="l18.1206" class="difflineminus">-      // use GetRootFolder so for deferred pop3 accounts, we'll get the filters</span>
<a href="#l18.1207"></a><span id="l18.1207" class="difflineminus">-      // file from the deferred account, not the deferred to account,</span>
<a href="#l18.1208"></a><span id="l18.1208" class="difflineminus">-      // so that filters will still be per-server.</span>
<a href="#l18.1209"></a><span id="l18.1209" class="difflineminus">-      nsresult rv = GetRootFolder(getter_AddRefs(msgFolder));</span>
<a href="#l18.1210"></a><span id="l18.1210" class="difflineplus">+  if (!mFilterList) {</span>
<a href="#l18.1211"></a><span id="l18.1211" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l18.1212"></a><span id="l18.1212" class="difflineplus">+    // use GetRootFolder so for deferred pop3 accounts, we'll get the filters</span>
<a href="#l18.1213"></a><span id="l18.1213" class="difflineplus">+    // file from the deferred account, not the deferred to account,</span>
<a href="#l18.1214"></a><span id="l18.1214" class="difflineplus">+    // so that filters will still be per-server.</span>
<a href="#l18.1215"></a><span id="l18.1215" class="difflineplus">+    nsresult rv = GetRootFolder(getter_AddRefs(msgFolder));</span>
<a href="#l18.1216"></a><span id="l18.1216" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1217"></a><span id="l18.1217" class="difflineplus">+</span>
<a href="#l18.1218"></a><span id="l18.1218" class="difflineplus">+    nsCString filterType;</span>
<a href="#l18.1219"></a><span id="l18.1219" class="difflineplus">+    rv = GetCharValue(&quot;filter.type&quot;, filterType);</span>
<a href="#l18.1220"></a><span id="l18.1220" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1221"></a><span id="l18.1221" class="difflineplus">+</span>
<a href="#l18.1222"></a><span id="l18.1222" class="difflineplus">+    if (!filterType.IsEmpty() &amp;&amp; !filterType.EqualsLiteral(&quot;default&quot;)) {</span>
<a href="#l18.1223"></a><span id="l18.1223" class="difflineplus">+      nsAutoCString contractID(&quot;@mozilla.org/filterlist;1?type=&quot;);</span>
<a href="#l18.1224"></a><span id="l18.1224" class="difflineplus">+      contractID += filterType;</span>
<a href="#l18.1225"></a><span id="l18.1225" class="difflineplus">+      ToLowerCase(contractID);</span>
<a href="#l18.1226"></a><span id="l18.1226" class="difflineplus">+      mFilterList = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l18.1227"></a><span id="l18.1227">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1228"></a><span id="l18.1228"> </span>
<a href="#l18.1229"></a><span id="l18.1229" class="difflineminus">-      nsCString filterType;</span>
<a href="#l18.1230"></a><span id="l18.1230" class="difflineminus">-      rv = GetCharValue(&quot;filter.type&quot;, filterType);</span>
<a href="#l18.1231"></a><span id="l18.1231" class="difflineplus">+      rv = mFilterList-&gt;SetFolder(msgFolder);</span>
<a href="#l18.1232"></a><span id="l18.1232">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1233"></a><span id="l18.1233"> </span>
<a href="#l18.1234"></a><span id="l18.1234" class="difflineminus">-      if (!filterType.IsEmpty() &amp;&amp; !filterType.EqualsLiteral(&quot;default&quot;))</span>
<a href="#l18.1235"></a><span id="l18.1235" class="difflineminus">-      {</span>
<a href="#l18.1236"></a><span id="l18.1236" class="difflineminus">-        nsAutoCString contractID(&quot;@mozilla.org/filterlist;1?type=&quot;);</span>
<a href="#l18.1237"></a><span id="l18.1237" class="difflineminus">-        contractID += filterType;</span>
<a href="#l18.1238"></a><span id="l18.1238" class="difflineminus">-        ToLowerCase(contractID);</span>
<a href="#l18.1239"></a><span id="l18.1239" class="difflineminus">-        mFilterList = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l18.1240"></a><span id="l18.1240" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1241"></a><span id="l18.1241" class="difflineplus">+      NS_ADDREF(*aResult = mFilterList);</span>
<a href="#l18.1242"></a><span id="l18.1242" class="difflineplus">+      return NS_OK;</span>
<a href="#l18.1243"></a><span id="l18.1243" class="difflineplus">+    }</span>
<a href="#l18.1244"></a><span id="l18.1244"> </span>
<a href="#l18.1245"></a><span id="l18.1245" class="difflineminus">-        rv = mFilterList-&gt;SetFolder(msgFolder);</span>
<a href="#l18.1246"></a><span id="l18.1246" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1247"></a><span id="l18.1247" class="difflineplus">+    // The default case, a local folder, is a bit special. It requires</span>
<a href="#l18.1248"></a><span id="l18.1248" class="difflineplus">+    // more initialization.</span>
<a href="#l18.1249"></a><span id="l18.1249" class="difflineplus">+</span>
<a href="#l18.1250"></a><span id="l18.1250" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; thisFolder;</span>
<a href="#l18.1251"></a><span id="l18.1251" class="difflineplus">+    rv = msgFolder-&gt;GetFilePath(getter_AddRefs(thisFolder));</span>
<a href="#l18.1252"></a><span id="l18.1252" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1253"></a><span id="l18.1253"> </span>
<a href="#l18.1254"></a><span id="l18.1254" class="difflineminus">-        NS_ADDREF(*aResult = mFilterList);</span>
<a href="#l18.1255"></a><span id="l18.1255" class="difflineminus">-        return NS_OK;</span>
<a href="#l18.1256"></a><span id="l18.1256" class="difflineminus">-      }</span>
<a href="#l18.1257"></a><span id="l18.1257" class="difflineminus">-</span>
<a href="#l18.1258"></a><span id="l18.1258" class="difflineminus">-      // The default case, a local folder, is a bit special. It requires</span>
<a href="#l18.1259"></a><span id="l18.1259" class="difflineminus">-      // more initialization.</span>
<a href="#l18.1260"></a><span id="l18.1260" class="difflineplus">+    mFilterFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1261"></a><span id="l18.1261" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1262"></a><span id="l18.1262" class="difflineplus">+    rv = mFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l18.1263"></a><span id="l18.1263" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1264"></a><span id="l18.1264"> </span>
<a href="#l18.1265"></a><span id="l18.1265" class="difflineminus">-      nsCOMPtr&lt;nsIFile&gt; thisFolder;</span>
<a href="#l18.1266"></a><span id="l18.1266" class="difflineminus">-      rv = msgFolder-&gt;GetFilePath(getter_AddRefs(thisFolder));</span>
<a href="#l18.1267"></a><span id="l18.1267" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1268"></a><span id="l18.1268" class="difflineplus">+    mFilterFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;msgFilterRules.dat&quot;));</span>
<a href="#l18.1269"></a><span id="l18.1269"> </span>
<a href="#l18.1270"></a><span id="l18.1270" class="difflineminus">-      mFilterFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1271"></a><span id="l18.1271" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1272"></a><span id="l18.1272" class="difflineminus">-      rv = mFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l18.1273"></a><span id="l18.1273" class="difflineplus">+    bool fileExists;</span>
<a href="#l18.1274"></a><span id="l18.1274" class="difflineplus">+    mFilterFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l18.1275"></a><span id="l18.1275" class="difflineplus">+    if (!fileExists) {</span>
<a href="#l18.1276"></a><span id="l18.1276" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; oldFilterFile =</span>
<a href="#l18.1277"></a><span id="l18.1277" class="difflineplus">+          do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1278"></a><span id="l18.1278">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1279"></a><span id="l18.1279" class="difflineminus">-</span>
<a href="#l18.1280"></a><span id="l18.1280" class="difflineminus">-      mFilterFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;msgFilterRules.dat&quot;));</span>
<a href="#l18.1281"></a><span id="l18.1281" class="difflineminus">-</span>
<a href="#l18.1282"></a><span id="l18.1282" class="difflineminus">-      bool fileExists;</span>
<a href="#l18.1283"></a><span id="l18.1283" class="difflineminus">-      mFilterFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l18.1284"></a><span id="l18.1284" class="difflineminus">-      if (!fileExists)</span>
<a href="#l18.1285"></a><span id="l18.1285" class="difflineminus">-      {</span>
<a href="#l18.1286"></a><span id="l18.1286" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; oldFilterFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1287"></a><span id="l18.1287" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1288"></a><span id="l18.1288" class="difflineminus">-        rv = oldFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l18.1289"></a><span id="l18.1289" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1290"></a><span id="l18.1290" class="difflineminus">-        oldFilterFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;rules.dat&quot;));</span>
<a href="#l18.1291"></a><span id="l18.1291" class="difflineplus">+      rv = oldFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l18.1292"></a><span id="l18.1292" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1293"></a><span id="l18.1293" class="difflineplus">+      oldFilterFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;rules.dat&quot;));</span>
<a href="#l18.1294"></a><span id="l18.1294"> </span>
<a href="#l18.1295"></a><span id="l18.1295" class="difflineminus">-        oldFilterFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l18.1296"></a><span id="l18.1296" class="difflineminus">-        if (fileExists)  //copy rules.dat --&gt; msgFilterRules.dat</span>
<a href="#l18.1297"></a><span id="l18.1297" class="difflineminus">-        {</span>
<a href="#l18.1298"></a><span id="l18.1298" class="difflineminus">-          rv = oldFilterFile-&gt;CopyToNative(thisFolder, NS_LITERAL_CSTRING(&quot;msgFilterRules.dat&quot;));</span>
<a href="#l18.1299"></a><span id="l18.1299" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1300"></a><span id="l18.1300" class="difflineminus">-        }</span>
<a href="#l18.1301"></a><span id="l18.1301" class="difflineplus">+      oldFilterFile-&gt;Exists(&amp;fileExists);</span>
<a href="#l18.1302"></a><span id="l18.1302" class="difflineplus">+      if (fileExists)  // copy rules.dat --&gt; msgFilterRules.dat</span>
<a href="#l18.1303"></a><span id="l18.1303" class="difflineplus">+      {</span>
<a href="#l18.1304"></a><span id="l18.1304" class="difflineplus">+        rv = oldFilterFile-&gt;CopyToNative(</span>
<a href="#l18.1305"></a><span id="l18.1305" class="difflineplus">+            thisFolder, NS_LITERAL_CSTRING(&quot;msgFilterRules.dat&quot;));</span>
<a href="#l18.1306"></a><span id="l18.1306" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1307"></a><span id="l18.1307">       }</span>
<a href="#l18.1308"></a><span id="l18.1308" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l18.1309"></a><span id="l18.1309" class="difflineminus">-          do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1310"></a><span id="l18.1310" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1311"></a><span id="l18.1311" class="difflineplus">+    }</span>
<a href="#l18.1312"></a><span id="l18.1312" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l18.1313"></a><span id="l18.1313" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1314"></a><span id="l18.1314" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1315"></a><span id="l18.1315"> </span>
<a href="#l18.1316"></a><span id="l18.1316" class="difflineminus">-      rv = filterService-&gt;OpenFilterList(mFilterFile, msgFolder, aMsgWindow, getter_AddRefs(mFilterList));</span>
<a href="#l18.1317"></a><span id="l18.1317" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1318"></a><span id="l18.1318" class="difflineplus">+    rv = filterService-&gt;OpenFilterList(mFilterFile, msgFolder, aMsgWindow,</span>
<a href="#l18.1319"></a><span id="l18.1319" class="difflineplus">+                                       getter_AddRefs(mFilterList));</span>
<a href="#l18.1320"></a><span id="l18.1320" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1321"></a><span id="l18.1321">   }</span>
<a href="#l18.1322"></a><span id="l18.1322"> </span>
<a href="#l18.1323"></a><span id="l18.1323">   NS_IF_ADDREF(*aResult = mFilterList);</span>
<a href="#l18.1324"></a><span id="l18.1324">   return NS_OK;</span>
<a href="#l18.1325"></a><span id="l18.1325"> }</span>
<a href="#l18.1326"></a><span id="l18.1326"> </span>
<a href="#l18.1327"></a><span id="l18.1327"> NS_IMETHODIMP</span>
<a href="#l18.1328"></a><span id="l18.1328" class="difflineminus">-nsMsgIncomingServer::SetEditableFilterList(nsIMsgFilterList *aEditableFilterList)</span>
<a href="#l18.1329"></a><span id="l18.1329" class="difflineminus">-{</span>
<a href="#l18.1330"></a><span id="l18.1330" class="difflineplus">+nsMsgIncomingServer::SetEditableFilterList(</span>
<a href="#l18.1331"></a><span id="l18.1331" class="difflineplus">+    nsIMsgFilterList *aEditableFilterList) {</span>
<a href="#l18.1332"></a><span id="l18.1332">   mEditableFilterList = aEditableFilterList;</span>
<a href="#l18.1333"></a><span id="l18.1333">   return NS_OK;</span>
<a href="#l18.1334"></a><span id="l18.1334"> }</span>
<a href="#l18.1335"></a><span id="l18.1335"> </span>
<a href="#l18.1336"></a><span id="l18.1336"> NS_IMETHODIMP</span>
<a href="#l18.1337"></a><span id="l18.1337" class="difflineminus">-nsMsgIncomingServer::GetEditableFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l18.1338"></a><span id="l18.1338" class="difflineminus">-{</span>
<a href="#l18.1339"></a><span id="l18.1339" class="difflineplus">+nsMsgIncomingServer::GetEditableFilterList(nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.1340"></a><span id="l18.1340" class="difflineplus">+                                           nsIMsgFilterList **aResult) {</span>
<a href="#l18.1341"></a><span id="l18.1341">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.1342"></a><span id="l18.1342" class="difflineminus">-  if (!mEditableFilterList)</span>
<a href="#l18.1343"></a><span id="l18.1343" class="difflineminus">-  {</span>
<a href="#l18.1344"></a><span id="l18.1344" class="difflineplus">+  if (!mEditableFilterList) {</span>
<a href="#l18.1345"></a><span id="l18.1345">     bool editSeparate;</span>
<a href="#l18.1346"></a><span id="l18.1346">     nsresult rv = GetBoolValue(&quot;filter.editable.separate&quot;, &amp;editSeparate);</span>
<a href="#l18.1347"></a><span id="l18.1347">     if (NS_FAILED(rv) || !editSeparate)</span>
<a href="#l18.1348"></a><span id="l18.1348">       return GetFilterList(aMsgWindow, aResult);</span>
<a href="#l18.1349"></a><span id="l18.1349"> </span>
<a href="#l18.1350"></a><span id="l18.1350">     nsCString filterType;</span>
<a href="#l18.1351"></a><span id="l18.1351">     rv = GetCharValue(&quot;filter.editable.type&quot;, filterType);</span>
<a href="#l18.1352"></a><span id="l18.1352">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1353"></a><span id="l18.1353" class="difflineat">@@ -1183,206 +1074,189 @@ nsMsgIncomingServer::GetEditableFilterLi</span>
<a href="#l18.1354"></a><span id="l18.1354">   }</span>
<a href="#l18.1355"></a><span id="l18.1355"> </span>
<a href="#l18.1356"></a><span id="l18.1356">   NS_IF_ADDREF(*aResult = mEditableFilterList);</span>
<a href="#l18.1357"></a><span id="l18.1357">   return NS_OK;</span>
<a href="#l18.1358"></a><span id="l18.1358"> }</span>
<a href="#l18.1359"></a><span id="l18.1359"> </span>
<a href="#l18.1360"></a><span id="l18.1360"> // If the hostname contains ':' (like hostname:1431)</span>
<a href="#l18.1361"></a><span id="l18.1361"> // then parse and set the port number.</span>
<a href="#l18.1362"></a><span id="l18.1362" class="difflineminus">-nsresult</span>
<a href="#l18.1363"></a><span id="l18.1363" class="difflineminus">-nsMsgIncomingServer::InternalSetHostName(const nsACString&amp; aHostname, const char * prefName)</span>
<a href="#l18.1364"></a><span id="l18.1364" class="difflineminus">-{</span>
<a href="#l18.1365"></a><span id="l18.1365" class="difflineplus">+nsresult nsMsgIncomingServer::InternalSetHostName(const nsACString &amp;aHostname,</span>
<a href="#l18.1366"></a><span id="l18.1366" class="difflineplus">+                                                  const char *prefName) {</span>
<a href="#l18.1367"></a><span id="l18.1367">   nsCString hostname;</span>
<a href="#l18.1368"></a><span id="l18.1368">   hostname = aHostname;</span>
<a href="#l18.1369"></a><span id="l18.1369" class="difflineminus">-  if (MsgCountChar(hostname, ':') == 1)</span>
<a href="#l18.1370"></a><span id="l18.1370" class="difflineminus">-  {</span>
<a href="#l18.1371"></a><span id="l18.1371" class="difflineplus">+  if (MsgCountChar(hostname, ':') == 1) {</span>
<a href="#l18.1372"></a><span id="l18.1372">     int32_t colonPos = hostname.FindChar(':');</span>
<a href="#l18.1373"></a><span id="l18.1373">     nsAutoCString portString(Substring(hostname, colonPos));</span>
<a href="#l18.1374"></a><span id="l18.1374">     hostname.SetLength(colonPos);</span>
<a href="#l18.1375"></a><span id="l18.1375">     nsresult err;</span>
<a href="#l18.1376"></a><span id="l18.1376">     int32_t port = portString.ToInteger(&amp;err);</span>
<a href="#l18.1377"></a><span id="l18.1377" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l18.1378"></a><span id="l18.1378" class="difflineminus">-      SetPort(port);</span>
<a href="#l18.1379"></a><span id="l18.1379" class="difflineplus">+    if (NS_SUCCEEDED(err)) SetPort(port);</span>
<a href="#l18.1380"></a><span id="l18.1380">   }</span>
<a href="#l18.1381"></a><span id="l18.1381">   return SetCharValue(prefName, hostname);</span>
<a href="#l18.1382"></a><span id="l18.1382"> }</span>
<a href="#l18.1383"></a><span id="l18.1383"> </span>
<a href="#l18.1384"></a><span id="l18.1384"> NS_IMETHODIMP</span>
<a href="#l18.1385"></a><span id="l18.1385" class="difflineminus">-nsMsgIncomingServer::OnUserOrHostNameChanged(const nsACString&amp; oldName,</span>
<a href="#l18.1386"></a><span id="l18.1386" class="difflineminus">-                                             const nsACString&amp; newName,</span>
<a href="#l18.1387"></a><span id="l18.1387" class="difflineminus">-                                             bool hostnameChanged)</span>
<a href="#l18.1388"></a><span id="l18.1388" class="difflineminus">-{</span>
<a href="#l18.1389"></a><span id="l18.1389" class="difflineplus">+nsMsgIncomingServer::OnUserOrHostNameChanged(const nsACString &amp;oldName,</span>
<a href="#l18.1390"></a><span id="l18.1390" class="difflineplus">+                                             const nsACString &amp;newName,</span>
<a href="#l18.1391"></a><span id="l18.1391" class="difflineplus">+                                             bool hostnameChanged) {</span>
<a href="#l18.1392"></a><span id="l18.1392">   nsresult rv;</span>
<a href="#l18.1393"></a><span id="l18.1393"> </span>
<a href="#l18.1394"></a><span id="l18.1394" class="difflineminus">-  // 1. Reset password so that users are prompted for new password for the new user/host.</span>
<a href="#l18.1395"></a><span id="l18.1395" class="difflineplus">+  // 1. Reset password so that users are prompted for new password for the new</span>
<a href="#l18.1396"></a><span id="l18.1396" class="difflineplus">+  // user/host.</span>
<a href="#l18.1397"></a><span id="l18.1397">   int32_t atPos = newName.FindChar('@');</span>
<a href="#l18.1398"></a><span id="l18.1398">   // If only username changed and the new name just added a domain</span>
<a href="#l18.1399"></a><span id="l18.1399">   // we can keep the password.</span>
<a href="#l18.1400"></a><span id="l18.1400">   if (hostnameChanged || (atPos == kNotFound) ||</span>
<a href="#l18.1401"></a><span id="l18.1401">       !StringHead(NS_ConvertASCIItoUTF16(newName), atPos)</span>
<a href="#l18.1402"></a><span id="l18.1402" class="difflineminus">-                 .Equals(NS_ConvertASCIItoUTF16(oldName))) {</span>
<a href="#l18.1403"></a><span id="l18.1403" class="difflineminus">-</span>
<a href="#l18.1404"></a><span id="l18.1404" class="difflineplus">+           .Equals(NS_ConvertASCIItoUTF16(oldName))) {</span>
<a href="#l18.1405"></a><span id="l18.1405">     ForgetPassword();</span>
<a href="#l18.1406"></a><span id="l18.1406">   }</span>
<a href="#l18.1407"></a><span id="l18.1407"> </span>
<a href="#l18.1408"></a><span id="l18.1408">   // 2. Let the derived class close all cached connection to the old host.</span>
<a href="#l18.1409"></a><span id="l18.1409">   CloseCachedConnections();</span>
<a href="#l18.1410"></a><span id="l18.1410"> </span>
<a href="#l18.1411"></a><span id="l18.1411">   // 3. Notify any listeners for account server changes.</span>
<a href="#l18.1412"></a><span id="l18.1412" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(mozilla::services::GetAccountManager());</span>
<a href="#l18.1413"></a><span id="l18.1413" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(</span>
<a href="#l18.1414"></a><span id="l18.1414" class="difflineplus">+      mozilla::services::GetAccountManager());</span>
<a href="#l18.1415"></a><span id="l18.1415"> </span>
<a href="#l18.1416"></a><span id="l18.1416">   rv = accountManager-&gt;NotifyServerChanged(this);</span>
<a href="#l18.1417"></a><span id="l18.1417">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1418"></a><span id="l18.1418"> </span>
<a href="#l18.1419"></a><span id="l18.1419" class="difflineminus">-  // 4. Lastly, replace all occurrences of old name in the acct name with the new one.</span>
<a href="#l18.1420"></a><span id="l18.1420" class="difflineplus">+  // 4. Lastly, replace all occurrences of old name in the acct name with the</span>
<a href="#l18.1421"></a><span id="l18.1421" class="difflineplus">+  // new one.</span>
<a href="#l18.1422"></a><span id="l18.1422">   nsString acctName;</span>
<a href="#l18.1423"></a><span id="l18.1423">   rv = GetPrettyName(acctName);</span>
<a href="#l18.1424"></a><span id="l18.1424">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1425"></a><span id="l18.1425"> </span>
<a href="#l18.1426"></a><span id="l18.1426">   // If new username contains @ then better do not update the account name.</span>
<a href="#l18.1427"></a><span id="l18.1427">   if (acctName.IsEmpty() || (!hostnameChanged &amp;&amp; (atPos != kNotFound)))</span>
<a href="#l18.1428"></a><span id="l18.1428">     return NS_OK;</span>
<a href="#l18.1429"></a><span id="l18.1429"> </span>
<a href="#l18.1430"></a><span id="l18.1430">   atPos = acctName.FindChar('@');</span>
<a href="#l18.1431"></a><span id="l18.1431"> </span>
<a href="#l18.1432"></a><span id="l18.1432">   // get previous username and hostname</span>
<a href="#l18.1433"></a><span id="l18.1433">   nsCString userName, hostName;</span>
<a href="#l18.1434"></a><span id="l18.1434" class="difflineminus">-  if (hostnameChanged)</span>
<a href="#l18.1435"></a><span id="l18.1435" class="difflineminus">-  {</span>
<a href="#l18.1436"></a><span id="l18.1436" class="difflineplus">+  if (hostnameChanged) {</span>
<a href="#l18.1437"></a><span id="l18.1437">     rv = GetRealUsername(userName);</span>
<a href="#l18.1438"></a><span id="l18.1438">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1439"></a><span id="l18.1439">     hostName.Assign(oldName);</span>
<a href="#l18.1440"></a><span id="l18.1440" class="difflineminus">-  }</span>
<a href="#l18.1441"></a><span id="l18.1441" class="difflineminus">-  else</span>
<a href="#l18.1442"></a><span id="l18.1442" class="difflineminus">-  {</span>
<a href="#l18.1443"></a><span id="l18.1443" class="difflineplus">+  } else {</span>
<a href="#l18.1444"></a><span id="l18.1444">     userName.Assign(oldName);</span>
<a href="#l18.1445"></a><span id="l18.1445">     rv = GetRealHostName(hostName);</span>
<a href="#l18.1446"></a><span id="l18.1446">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1447"></a><span id="l18.1447">   }</span>
<a href="#l18.1448"></a><span id="l18.1448"> </span>
<a href="#l18.1449"></a><span id="l18.1449">   // switch corresponding part of the account name to the new name...</span>
<a href="#l18.1450"></a><span id="l18.1450" class="difflineminus">-  if (!hostnameChanged &amp;&amp; (atPos != kNotFound))</span>
<a href="#l18.1451"></a><span id="l18.1451" class="difflineminus">-  {</span>
<a href="#l18.1452"></a><span id="l18.1452" class="difflineplus">+  if (!hostnameChanged &amp;&amp; (atPos != kNotFound)) {</span>
<a href="#l18.1453"></a><span id="l18.1453">     // ...if username changed and the previous username was equal to the part</span>
<a href="#l18.1454"></a><span id="l18.1454">     // of the account name before @</span>
<a href="#l18.1455"></a><span id="l18.1455">     if (StringHead(acctName, atPos).Equals(NS_ConvertASCIItoUTF16(userName)))</span>
<a href="#l18.1456"></a><span id="l18.1456">       acctName.Replace(0, userName.Length(), NS_ConvertASCIItoUTF16(newName));</span>
<a href="#l18.1457"></a><span id="l18.1457">   }</span>
<a href="#l18.1458"></a><span id="l18.1458" class="difflineminus">-  if (hostnameChanged)</span>
<a href="#l18.1459"></a><span id="l18.1459" class="difflineminus">-  {</span>
<a href="#l18.1460"></a><span id="l18.1460" class="difflineplus">+  if (hostnameChanged) {</span>
<a href="#l18.1461"></a><span id="l18.1461">     // ...if hostname changed and the previous hostname was equal to the part</span>
<a href="#l18.1462"></a><span id="l18.1462">     // of the account name after @, or to the whole account name</span>
<a href="#l18.1463"></a><span id="l18.1463">     if (atPos == kNotFound)</span>
<a href="#l18.1464"></a><span id="l18.1464">       atPos = 0;</span>
<a href="#l18.1465"></a><span id="l18.1465">     else</span>
<a href="#l18.1466"></a><span id="l18.1466">       atPos += 1;</span>
<a href="#l18.1467"></a><span id="l18.1467">     if (Substring(acctName, atPos).Equals(NS_ConvertASCIItoUTF16(hostName))) {</span>
<a href="#l18.1468"></a><span id="l18.1468">       acctName.Replace(atPos, acctName.Length() - atPos,</span>
<a href="#l18.1469"></a><span id="l18.1469">                        NS_ConvertASCIItoUTF16(newName));</span>
<a href="#l18.1470"></a><span id="l18.1470">     }</span>
<a href="#l18.1471"></a><span id="l18.1471">   }</span>
<a href="#l18.1472"></a><span id="l18.1472"> </span>
<a href="#l18.1473"></a><span id="l18.1473">   return SetPrettyName(acctName);</span>
<a href="#l18.1474"></a><span id="l18.1474"> }</span>
<a href="#l18.1475"></a><span id="l18.1475"> </span>
<a href="#l18.1476"></a><span id="l18.1476"> NS_IMETHODIMP</span>
<a href="#l18.1477"></a><span id="l18.1477" class="difflineminus">-nsMsgIncomingServer::SetHostName(const nsACString&amp; aHostname)</span>
<a href="#l18.1478"></a><span id="l18.1478" class="difflineminus">-{</span>
<a href="#l18.1479"></a><span id="l18.1479" class="difflineplus">+nsMsgIncomingServer::SetHostName(const nsACString &amp;aHostname) {</span>
<a href="#l18.1480"></a><span id="l18.1480">   return (InternalSetHostName(aHostname, &quot;hostname&quot;));</span>
<a href="#l18.1481"></a><span id="l18.1481"> }</span>
<a href="#l18.1482"></a><span id="l18.1482"> </span>
<a href="#l18.1483"></a><span id="l18.1483"> // SetRealHostName() is called only when the server name is changed from the</span>
<a href="#l18.1484"></a><span id="l18.1484"> // UI (Account Settings page).  No one should call it in any circumstances.</span>
<a href="#l18.1485"></a><span id="l18.1485"> NS_IMETHODIMP</span>
<a href="#l18.1486"></a><span id="l18.1486" class="difflineminus">-nsMsgIncomingServer::SetRealHostName(const nsACString&amp; aHostname)</span>
<a href="#l18.1487"></a><span id="l18.1487" class="difflineminus">-{</span>
<a href="#l18.1488"></a><span id="l18.1488" class="difflineplus">+nsMsgIncomingServer::SetRealHostName(const nsACString &amp;aHostname) {</span>
<a href="#l18.1489"></a><span id="l18.1489">   nsCString oldName;</span>
<a href="#l18.1490"></a><span id="l18.1490">   nsresult rv = GetRealHostName(oldName);</span>
<a href="#l18.1491"></a><span id="l18.1491">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1492"></a><span id="l18.1492">   rv = InternalSetHostName(aHostname, &quot;realhostname&quot;);</span>
<a href="#l18.1493"></a><span id="l18.1493"> </span>
<a href="#l18.1494"></a><span id="l18.1494">   // A few things to take care of if we're changing the hostname.</span>
<a href="#l18.1495"></a><span id="l18.1495">   if (!aHostname.Equals(oldName, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l18.1496"></a><span id="l18.1496">     rv = OnUserOrHostNameChanged(oldName, aHostname, true);</span>
<a href="#l18.1497"></a><span id="l18.1497">   return rv;</span>
<a href="#l18.1498"></a><span id="l18.1498"> }</span>
<a href="#l18.1499"></a><span id="l18.1499"> </span>
<a href="#l18.1500"></a><span id="l18.1500"> NS_IMETHODIMP</span>
<a href="#l18.1501"></a><span id="l18.1501" class="difflineminus">-nsMsgIncomingServer::GetHostName(nsACString&amp; aResult)</span>
<a href="#l18.1502"></a><span id="l18.1502" class="difflineminus">-{</span>
<a href="#l18.1503"></a><span id="l18.1503" class="difflineplus">+nsMsgIncomingServer::GetHostName(nsACString &amp;aResult) {</span>
<a href="#l18.1504"></a><span id="l18.1504">   nsresult rv;</span>
<a href="#l18.1505"></a><span id="l18.1505">   rv = GetCharValue(&quot;hostname&quot;, aResult);</span>
<a href="#l18.1506"></a><span id="l18.1506" class="difflineminus">-  if (MsgCountChar(aResult, ':') == 1)</span>
<a href="#l18.1507"></a><span id="l18.1507" class="difflineminus">-  {</span>
<a href="#l18.1508"></a><span id="l18.1508" class="difflineplus">+  if (MsgCountChar(aResult, ':') == 1) {</span>
<a href="#l18.1509"></a><span id="l18.1509">     // gack, we need to reformat the hostname - SetHostName will do that</span>
<a href="#l18.1510"></a><span id="l18.1510">     SetHostName(aResult);</span>
<a href="#l18.1511"></a><span id="l18.1511">     rv = GetCharValue(&quot;hostname&quot;, aResult);</span>
<a href="#l18.1512"></a><span id="l18.1512">   }</span>
<a href="#l18.1513"></a><span id="l18.1513">   return rv;</span>
<a href="#l18.1514"></a><span id="l18.1514"> }</span>
<a href="#l18.1515"></a><span id="l18.1515"> </span>
<a href="#l18.1516"></a><span id="l18.1516"> NS_IMETHODIMP</span>
<a href="#l18.1517"></a><span id="l18.1517" class="difflineminus">-nsMsgIncomingServer::GetRealHostName(nsACString&amp; aResult)</span>
<a href="#l18.1518"></a><span id="l18.1518" class="difflineminus">-{</span>
<a href="#l18.1519"></a><span id="l18.1519" class="difflineminus">-  // If 'realhostname' is set (was changed) then use it, otherwise use 'hostname'</span>
<a href="#l18.1520"></a><span id="l18.1520" class="difflineplus">+nsMsgIncomingServer::GetRealHostName(nsACString &amp;aResult) {</span>
<a href="#l18.1521"></a><span id="l18.1521" class="difflineplus">+  // If 'realhostname' is set (was changed) then use it, otherwise use</span>
<a href="#l18.1522"></a><span id="l18.1522" class="difflineplus">+  // 'hostname'</span>
<a href="#l18.1523"></a><span id="l18.1523">   nsresult rv;</span>
<a href="#l18.1524"></a><span id="l18.1524">   rv = GetCharValue(&quot;realhostname&quot;, aResult);</span>
<a href="#l18.1525"></a><span id="l18.1525">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1526"></a><span id="l18.1526"> </span>
<a href="#l18.1527"></a><span id="l18.1527" class="difflineminus">-  if (aResult.IsEmpty())</span>
<a href="#l18.1528"></a><span id="l18.1528" class="difflineminus">-    return GetHostName(aResult);</span>
<a href="#l18.1529"></a><span id="l18.1529" class="difflineplus">+  if (aResult.IsEmpty()) return GetHostName(aResult);</span>
<a href="#l18.1530"></a><span id="l18.1530"> </span>
<a href="#l18.1531"></a><span id="l18.1531" class="difflineminus">-  if (MsgCountChar(aResult, ':') == 1)</span>
<a href="#l18.1532"></a><span id="l18.1532" class="difflineminus">-  {</span>
<a href="#l18.1533"></a><span id="l18.1533" class="difflineplus">+  if (MsgCountChar(aResult, ':') == 1) {</span>
<a href="#l18.1534"></a><span id="l18.1534">     SetRealHostName(aResult);</span>
<a href="#l18.1535"></a><span id="l18.1535">     rv = GetCharValue(&quot;realhostname&quot;, aResult);</span>
<a href="#l18.1536"></a><span id="l18.1536">   }</span>
<a href="#l18.1537"></a><span id="l18.1537"> </span>
<a href="#l18.1538"></a><span id="l18.1538">   return rv;</span>
<a href="#l18.1539"></a><span id="l18.1539"> }</span>
<a href="#l18.1540"></a><span id="l18.1540"> </span>
<a href="#l18.1541"></a><span id="l18.1541"> NS_IMETHODIMP</span>
<a href="#l18.1542"></a><span id="l18.1542" class="difflineminus">-nsMsgIncomingServer::GetRealUsername(nsACString&amp; aResult)</span>
<a href="#l18.1543"></a><span id="l18.1543" class="difflineminus">-{</span>
<a href="#l18.1544"></a><span id="l18.1544" class="difflineminus">-  // If 'realuserName' is set (was changed) then use it, otherwise use 'userName'</span>
<a href="#l18.1545"></a><span id="l18.1545" class="difflineplus">+nsMsgIncomingServer::GetRealUsername(nsACString &amp;aResult) {</span>
<a href="#l18.1546"></a><span id="l18.1546" class="difflineplus">+  // If 'realuserName' is set (was changed) then use it, otherwise use</span>
<a href="#l18.1547"></a><span id="l18.1547" class="difflineplus">+  // 'userName'</span>
<a href="#l18.1548"></a><span id="l18.1548">   nsresult rv;</span>
<a href="#l18.1549"></a><span id="l18.1549">   rv = GetCharValue(&quot;realuserName&quot;, aResult);</span>
<a href="#l18.1550"></a><span id="l18.1550">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1551"></a><span id="l18.1551">   return aResult.IsEmpty() ? GetUsername(aResult) : rv;</span>
<a href="#l18.1552"></a><span id="l18.1552"> }</span>
<a href="#l18.1553"></a><span id="l18.1553"> </span>
<a href="#l18.1554"></a><span id="l18.1554"> NS_IMETHODIMP</span>
<a href="#l18.1555"></a><span id="l18.1555" class="difflineminus">-nsMsgIncomingServer::SetRealUsername(const nsACString&amp; aUsername)</span>
<a href="#l18.1556"></a><span id="l18.1556" class="difflineminus">-{</span>
<a href="#l18.1557"></a><span id="l18.1557" class="difflineplus">+nsMsgIncomingServer::SetRealUsername(const nsACString &amp;aUsername) {</span>
<a href="#l18.1558"></a><span id="l18.1558">   // Need to take care of few things if we're changing the username.</span>
<a href="#l18.1559"></a><span id="l18.1559">   nsCString oldName;</span>
<a href="#l18.1560"></a><span id="l18.1560">   nsresult rv = GetRealUsername(oldName);</span>
<a href="#l18.1561"></a><span id="l18.1561">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1562"></a><span id="l18.1562">   rv = SetCharValue(&quot;realuserName&quot;, aUsername);</span>
<a href="#l18.1563"></a><span id="l18.1563">   if (!oldName.Equals(aUsername))</span>
<a href="#l18.1564"></a><span id="l18.1564">     rv = OnUserOrHostNameChanged(oldName, aUsername, false);</span>
<a href="#l18.1565"></a><span id="l18.1565">   return rv;</span>
<a href="#l18.1566"></a><span id="l18.1566"> }</span>
<a href="#l18.1567"></a><span id="l18.1567"> </span>
<a href="#l18.1568"></a><span id="l18.1568"> #define BIFF_PREF_NAME &quot;check_new_mail&quot;</span>
<a href="#l18.1569"></a><span id="l18.1569"> </span>
<a href="#l18.1570"></a><span id="l18.1570"> NS_IMETHODIMP</span>
<a href="#l18.1571"></a><span id="l18.1571" class="difflineminus">-nsMsgIncomingServer::GetDoBiff(bool *aDoBiff)</span>
<a href="#l18.1572"></a><span id="l18.1572" class="difflineminus">-{</span>
<a href="#l18.1573"></a><span id="l18.1573" class="difflineplus">+nsMsgIncomingServer::GetDoBiff(bool *aDoBiff) {</span>
<a href="#l18.1574"></a><span id="l18.1574">   NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l18.1575"></a><span id="l18.1575"> </span>
<a href="#l18.1576"></a><span id="l18.1576" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.1577"></a><span id="l18.1577" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1578"></a><span id="l18.1578" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1579"></a><span id="l18.1579"> </span>
<a href="#l18.1580"></a><span id="l18.1580">   nsresult rv;</span>
<a href="#l18.1581"></a><span id="l18.1581"> </span>
<a href="#l18.1582"></a><span id="l18.1582">   rv = mPrefBranch-&gt;GetBoolPref(BIFF_PREF_NAME, aDoBiff);</span>
<a href="#l18.1583"></a><span id="l18.1583" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l18.1584"></a><span id="l18.1584" class="difflineminus">-    return rv;</span>
<a href="#l18.1585"></a><span id="l18.1585" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l18.1586"></a><span id="l18.1586"> </span>
<a href="#l18.1587"></a><span id="l18.1587">   // if the pref isn't set, use the default</span>
<a href="#l18.1588"></a><span id="l18.1588">   // value based on the protocol</span>
<a href="#l18.1589"></a><span id="l18.1589">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l18.1590"></a><span id="l18.1590">   rv = GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l18.1591"></a><span id="l18.1591">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1592"></a><span id="l18.1592"> </span>
<a href="#l18.1593"></a><span id="l18.1593">   rv = protocolInfo-&gt;GetDefaultDoBiff(aDoBiff);</span>
<a href="#l18.1594"></a><span id="l18.1594" class="difflineat">@@ -1391,64 +1265,58 @@ nsMsgIncomingServer::GetDoBiff(bool *aDo</span>
<a href="#l18.1595"></a><span id="l18.1595">   // if biff should be on or off, let's keep the ability</span>
<a href="#l18.1596"></a><span id="l18.1596">   // to change the default in future builds.</span>
<a href="#l18.1597"></a><span id="l18.1597">   // if we call SetDoBiff() here, it will be in the users prefs.</span>
<a href="#l18.1598"></a><span id="l18.1598">   // and we can't do anything after that.</span>
<a href="#l18.1599"></a><span id="l18.1599">   return rv;</span>
<a href="#l18.1600"></a><span id="l18.1600"> }</span>
<a href="#l18.1601"></a><span id="l18.1601"> </span>
<a href="#l18.1602"></a><span id="l18.1602"> NS_IMETHODIMP</span>
<a href="#l18.1603"></a><span id="l18.1603" class="difflineminus">-nsMsgIncomingServer::SetDoBiff(bool aDoBiff)</span>
<a href="#l18.1604"></a><span id="l18.1604" class="difflineminus">-{</span>
<a href="#l18.1605"></a><span id="l18.1605" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.1606"></a><span id="l18.1606" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1607"></a><span id="l18.1607" class="difflineplus">+nsMsgIncomingServer::SetDoBiff(bool aDoBiff) {</span>
<a href="#l18.1608"></a><span id="l18.1608" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1609"></a><span id="l18.1609"> </span>
<a href="#l18.1610"></a><span id="l18.1610">   // Update biffManager immediately, no restart required. Adding/removing</span>
<a href="#l18.1611"></a><span id="l18.1611">   // existing/non-existing server is handled without error checking.</span>
<a href="#l18.1612"></a><span id="l18.1612">   nsresult rv;</span>
<a href="#l18.1613"></a><span id="l18.1613">   nsCOMPtr&lt;nsIMsgBiffManager&gt; biffService =</span>
<a href="#l18.1614"></a><span id="l18.1614" class="difflineminus">-    do_GetService(NS_MSGBIFFMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.1615"></a><span id="l18.1615" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; biffService)</span>
<a href="#l18.1616"></a><span id="l18.1616" class="difflineminus">-  {</span>
<a href="#l18.1617"></a><span id="l18.1617" class="difflineplus">+      do_GetService(NS_MSGBIFFMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.1618"></a><span id="l18.1618" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; biffService) {</span>
<a href="#l18.1619"></a><span id="l18.1619">     if (aDoBiff)</span>
<a href="#l18.1620"></a><span id="l18.1620" class="difflineminus">-      (void) biffService-&gt;AddServerBiff(this);</span>
<a href="#l18.1621"></a><span id="l18.1621" class="difflineplus">+      (void)biffService-&gt;AddServerBiff(this);</span>
<a href="#l18.1622"></a><span id="l18.1622">     else</span>
<a href="#l18.1623"></a><span id="l18.1623" class="difflineminus">-      (void) biffService-&gt;RemoveServerBiff(this);</span>
<a href="#l18.1624"></a><span id="l18.1624" class="difflineplus">+      (void)biffService-&gt;RemoveServerBiff(this);</span>
<a href="#l18.1625"></a><span id="l18.1625">   }</span>
<a href="#l18.1626"></a><span id="l18.1626"> </span>
<a href="#l18.1627"></a><span id="l18.1627">   return mPrefBranch-&gt;SetBoolPref(BIFF_PREF_NAME, aDoBiff);</span>
<a href="#l18.1628"></a><span id="l18.1628"> }</span>
<a href="#l18.1629"></a><span id="l18.1629"> </span>
<a href="#l18.1630"></a><span id="l18.1630"> NS_IMETHODIMP</span>
<a href="#l18.1631"></a><span id="l18.1631" class="difflineminus">-nsMsgIncomingServer::GetPort(int32_t *aPort)</span>
<a href="#l18.1632"></a><span id="l18.1632" class="difflineminus">-{</span>
<a href="#l18.1633"></a><span id="l18.1633" class="difflineplus">+nsMsgIncomingServer::GetPort(int32_t *aPort) {</span>
<a href="#l18.1634"></a><span id="l18.1634">   NS_ENSURE_ARG_POINTER(aPort);</span>
<a href="#l18.1635"></a><span id="l18.1635"> </span>
<a href="#l18.1636"></a><span id="l18.1636">   nsresult rv;</span>
<a href="#l18.1637"></a><span id="l18.1637">   rv = GetIntValue(&quot;port&quot;, aPort);</span>
<a href="#l18.1638"></a><span id="l18.1638">   // We can't use a port of 0, because the URI parsing code fails.</span>
<a href="#l18.1639"></a><span id="l18.1639" class="difflineminus">-  if (*aPort != PORT_NOT_SET &amp;&amp; *aPort)</span>
<a href="#l18.1640"></a><span id="l18.1640" class="difflineminus">-    return rv;</span>
<a href="#l18.1641"></a><span id="l18.1641" class="difflineplus">+  if (*aPort != PORT_NOT_SET &amp;&amp; *aPort) return rv;</span>
<a href="#l18.1642"></a><span id="l18.1642"> </span>
<a href="#l18.1643"></a><span id="l18.1643">   // if the port isn't set, use the default</span>
<a href="#l18.1644"></a><span id="l18.1644">   // port based on the protocol</span>
<a href="#l18.1645"></a><span id="l18.1645">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l18.1646"></a><span id="l18.1646">   rv = GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l18.1647"></a><span id="l18.1647">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1648"></a><span id="l18.1648"> </span>
<a href="#l18.1649"></a><span id="l18.1649">   int32_t socketType;</span>
<a href="#l18.1650"></a><span id="l18.1650">   rv = GetSocketType(&amp;socketType);</span>
<a href="#l18.1651"></a><span id="l18.1651">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1652"></a><span id="l18.1652">   bool useSSLPort = (socketType == nsMsgSocketType::SSL);</span>
<a href="#l18.1653"></a><span id="l18.1653">   return protocolInfo-&gt;GetDefaultServerPort(useSSLPort, aPort);</span>
<a href="#l18.1654"></a><span id="l18.1654"> }</span>
<a href="#l18.1655"></a><span id="l18.1655"> </span>
<a href="#l18.1656"></a><span id="l18.1656"> NS_IMETHODIMP</span>
<a href="#l18.1657"></a><span id="l18.1657" class="difflineminus">-nsMsgIncomingServer::SetPort(int32_t aPort)</span>
<a href="#l18.1658"></a><span id="l18.1658" class="difflineminus">-{</span>
<a href="#l18.1659"></a><span id="l18.1659" class="difflineplus">+nsMsgIncomingServer::SetPort(int32_t aPort) {</span>
<a href="#l18.1660"></a><span id="l18.1660">   nsresult rv;</span>
<a href="#l18.1661"></a><span id="l18.1661"> </span>
<a href="#l18.1662"></a><span id="l18.1662">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l18.1663"></a><span id="l18.1663">   rv = GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l18.1664"></a><span id="l18.1664">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1665"></a><span id="l18.1665"> </span>
<a href="#l18.1666"></a><span id="l18.1666">   int32_t socketType;</span>
<a href="#l18.1667"></a><span id="l18.1667">   rv = GetSocketType(&amp;socketType);</span>
<a href="#l18.1668"></a><span id="l18.1668" class="difflineat">@@ -1456,77 +1324,75 @@ nsMsgIncomingServer::SetPort(int32_t aPo</span>
<a href="#l18.1669"></a><span id="l18.1669">   bool useSSLPort = (socketType == nsMsgSocketType::SSL);</span>
<a href="#l18.1670"></a><span id="l18.1670"> </span>
<a href="#l18.1671"></a><span id="l18.1671">   int32_t defaultPort;</span>
<a href="#l18.1672"></a><span id="l18.1672">   protocolInfo-&gt;GetDefaultServerPort(useSSLPort, &amp;defaultPort);</span>
<a href="#l18.1673"></a><span id="l18.1673">   return SetIntValue(&quot;port&quot;, aPort == defaultPort ? PORT_NOT_SET : aPort);</span>
<a href="#l18.1674"></a><span id="l18.1674"> }</span>
<a href="#l18.1675"></a><span id="l18.1675"> </span>
<a href="#l18.1676"></a><span id="l18.1676"> NS_IMETHODIMP</span>
<a href="#l18.1677"></a><span id="l18.1677" class="difflineminus">-nsMsgIncomingServer::GetProtocolInfo(nsIMsgProtocolInfo **aResult)</span>
<a href="#l18.1678"></a><span id="l18.1678" class="difflineminus">-{</span>
<a href="#l18.1679"></a><span id="l18.1679" class="difflineplus">+nsMsgIncomingServer::GetProtocolInfo(nsIMsgProtocolInfo **aResult) {</span>
<a href="#l18.1680"></a><span id="l18.1680">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.1681"></a><span id="l18.1681"> </span>
<a href="#l18.1682"></a><span id="l18.1682">   nsCString type;</span>
<a href="#l18.1683"></a><span id="l18.1683">   nsresult rv = GetType(type);</span>
<a href="#l18.1684"></a><span id="l18.1684">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1685"></a><span id="l18.1685"> </span>
<a href="#l18.1686"></a><span id="l18.1686">   nsAutoCString contractid(NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX);</span>
<a href="#l18.1687"></a><span id="l18.1687">   contractid.Append(type);</span>
<a href="#l18.1688"></a><span id="l18.1688"> </span>
<a href="#l18.1689"></a><span id="l18.1689" class="difflineminus">-  nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo = do_GetService(contractid.get(), &amp;rv);</span>
<a href="#l18.1690"></a><span id="l18.1690" class="difflineplus">+  nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo =</span>
<a href="#l18.1691"></a><span id="l18.1691" class="difflineplus">+      do_GetService(contractid.get(), &amp;rv);</span>
<a href="#l18.1692"></a><span id="l18.1692">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1693"></a><span id="l18.1693"> </span>
<a href="#l18.1694"></a><span id="l18.1694">   protocolInfo.forget(aResult);</span>
<a href="#l18.1695"></a><span id="l18.1695">   return NS_OK;</span>
<a href="#l18.1696"></a><span id="l18.1696"> }</span>
<a href="#l18.1697"></a><span id="l18.1697"> </span>
<a href="#l18.1698"></a><span id="l18.1698" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetRetentionSettings(nsIMsgRetentionSettings **settings)</span>
<a href="#l18.1699"></a><span id="l18.1699" class="difflineminus">-{</span>
<a href="#l18.1700"></a><span id="l18.1700" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetRetentionSettings(</span>
<a href="#l18.1701"></a><span id="l18.1701" class="difflineplus">+    nsIMsgRetentionSettings **settings) {</span>
<a href="#l18.1702"></a><span id="l18.1702">   NS_ENSURE_ARG_POINTER(settings);</span>
<a href="#l18.1703"></a><span id="l18.1703">   nsMsgRetainByPreference retainByPreference;</span>
<a href="#l18.1704"></a><span id="l18.1704">   int32_t daysToKeepHdrs = 0;</span>
<a href="#l18.1705"></a><span id="l18.1705">   int32_t numHeadersToKeep = 0;</span>
<a href="#l18.1706"></a><span id="l18.1706">   int32_t daysToKeepBodies = 0;</span>
<a href="#l18.1707"></a><span id="l18.1707">   bool cleanupBodiesByDays = false;</span>
<a href="#l18.1708"></a><span id="l18.1708">   bool applyToFlaggedMessages = false;</span>
<a href="#l18.1709"></a><span id="l18.1709">   nsresult rv = NS_OK;</span>
<a href="#l18.1710"></a><span id="l18.1710">   // Create an empty retention settings object,</span>
<a href="#l18.1711"></a><span id="l18.1711">   // get the settings from the server prefs, and init the object from the prefs.</span>
<a href="#l18.1712"></a><span id="l18.1712" class="difflineminus">-  nsCOMPtr &lt;nsIMsgRetentionSettings&gt; retentionSettings =</span>
<a href="#l18.1713"></a><span id="l18.1713" class="difflineminus">-     do_CreateInstance(NS_MSG_RETENTIONSETTINGS_CONTRACTID);</span>
<a href="#l18.1714"></a><span id="l18.1714" class="difflineminus">-  if (retentionSettings)</span>
<a href="#l18.1715"></a><span id="l18.1715" class="difflineminus">-  {</span>
<a href="#l18.1716"></a><span id="l18.1716" class="difflineminus">-    rv = GetIntValue(&quot;retainBy&quot;, (int32_t*) &amp;retainByPreference);</span>
<a href="#l18.1717"></a><span id="l18.1717" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRetentionSettings&gt; retentionSettings =</span>
<a href="#l18.1718"></a><span id="l18.1718" class="difflineplus">+      do_CreateInstance(NS_MSG_RETENTIONSETTINGS_CONTRACTID);</span>
<a href="#l18.1719"></a><span id="l18.1719" class="difflineplus">+  if (retentionSettings) {</span>
<a href="#l18.1720"></a><span id="l18.1720" class="difflineplus">+    rv = GetIntValue(&quot;retainBy&quot;, (int32_t *)&amp;retainByPreference);</span>
<a href="#l18.1721"></a><span id="l18.1721">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1722"></a><span id="l18.1722">     rv = GetIntValue(&quot;numHdrsToKeep&quot;, &amp;numHeadersToKeep);</span>
<a href="#l18.1723"></a><span id="l18.1723">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1724"></a><span id="l18.1724">     rv = GetIntValue(&quot;daysToKeepHdrs&quot;, &amp;daysToKeepHdrs);</span>
<a href="#l18.1725"></a><span id="l18.1725">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1726"></a><span id="l18.1726">     rv = GetIntValue(&quot;daysToKeepBodies&quot;, &amp;daysToKeepBodies);</span>
<a href="#l18.1727"></a><span id="l18.1727">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1728"></a><span id="l18.1728">     rv = GetBoolValue(&quot;cleanupBodies&quot;, &amp;cleanupBodiesByDays);</span>
<a href="#l18.1729"></a><span id="l18.1729">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1730"></a><span id="l18.1730">     rv = GetBoolValue(&quot;applyToFlaggedMessages&quot;, &amp;applyToFlaggedMessages);</span>
<a href="#l18.1731"></a><span id="l18.1731">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1732"></a><span id="l18.1732">     retentionSettings-&gt;SetRetainByPreference(retainByPreference);</span>
<a href="#l18.1733"></a><span id="l18.1733" class="difflineminus">-    retentionSettings-&gt;SetNumHeadersToKeep((uint32_t) numHeadersToKeep);</span>
<a href="#l18.1734"></a><span id="l18.1734" class="difflineplus">+    retentionSettings-&gt;SetNumHeadersToKeep((uint32_t)numHeadersToKeep);</span>
<a href="#l18.1735"></a><span id="l18.1735">     retentionSettings-&gt;SetDaysToKeepBodies(daysToKeepBodies);</span>
<a href="#l18.1736"></a><span id="l18.1736">     retentionSettings-&gt;SetDaysToKeepHdrs(daysToKeepHdrs);</span>
<a href="#l18.1737"></a><span id="l18.1737">     retentionSettings-&gt;SetCleanupBodiesByDays(cleanupBodiesByDays);</span>
<a href="#l18.1738"></a><span id="l18.1738">     retentionSettings-&gt;SetApplyToFlaggedMessages(applyToFlaggedMessages);</span>
<a href="#l18.1739"></a><span id="l18.1739" class="difflineminus">-  }</span>
<a href="#l18.1740"></a><span id="l18.1740" class="difflineminus">-  else</span>
<a href="#l18.1741"></a><span id="l18.1741" class="difflineplus">+  } else</span>
<a href="#l18.1742"></a><span id="l18.1742">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.1743"></a><span id="l18.1743">   NS_IF_ADDREF(*settings = retentionSettings);</span>
<a href="#l18.1744"></a><span id="l18.1744">   return rv;</span>
<a href="#l18.1745"></a><span id="l18.1745"> }</span>
<a href="#l18.1746"></a><span id="l18.1746"> </span>
<a href="#l18.1747"></a><span id="l18.1747" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::SetRetentionSettings(nsIMsgRetentionSettings *settings)</span>
<a href="#l18.1748"></a><span id="l18.1748" class="difflineminus">-{</span>
<a href="#l18.1749"></a><span id="l18.1749" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::SetRetentionSettings(</span>
<a href="#l18.1750"></a><span id="l18.1750" class="difflineplus">+    nsIMsgRetentionSettings *settings) {</span>
<a href="#l18.1751"></a><span id="l18.1751">   nsMsgRetainByPreference retainByPreference;</span>
<a href="#l18.1752"></a><span id="l18.1752">   uint32_t daysToKeepHdrs = 0;</span>
<a href="#l18.1753"></a><span id="l18.1753">   uint32_t numHeadersToKeep = 0;</span>
<a href="#l18.1754"></a><span id="l18.1754">   uint32_t daysToKeepBodies = 0;</span>
<a href="#l18.1755"></a><span id="l18.1755">   bool cleanupBodiesByDays = false;</span>
<a href="#l18.1756"></a><span id="l18.1756">   bool applyToFlaggedMessages = false;</span>
<a href="#l18.1757"></a><span id="l18.1757">   settings-&gt;GetRetainByPreference(&amp;retainByPreference);</span>
<a href="#l18.1758"></a><span id="l18.1758">   settings-&gt;GetNumHeadersToKeep(&amp;numHeadersToKeep);</span>
<a href="#l18.1759"></a><span id="l18.1759" class="difflineat">@@ -1545,163 +1411,150 @@ NS_IMETHODIMP nsMsgIncomingServer::SetRe</span>
<a href="#l18.1760"></a><span id="l18.1760">   rv = SetBoolValue(&quot;cleanupBodies&quot;, cleanupBodiesByDays);</span>
<a href="#l18.1761"></a><span id="l18.1761">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1762"></a><span id="l18.1762">   rv = SetBoolValue(&quot;applyToFlaggedMessages&quot;, applyToFlaggedMessages);</span>
<a href="#l18.1763"></a><span id="l18.1763">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1764"></a><span id="l18.1764">   return NS_OK;</span>
<a href="#l18.1765"></a><span id="l18.1765"> }</span>
<a href="#l18.1766"></a><span id="l18.1766"> </span>
<a href="#l18.1767"></a><span id="l18.1767"> NS_IMETHODIMP</span>
<a href="#l18.1768"></a><span id="l18.1768" class="difflineminus">-nsMsgIncomingServer::GetDisplayStartupPage(bool *displayStartupPage)</span>
<a href="#l18.1769"></a><span id="l18.1769" class="difflineminus">-{</span>
<a href="#l18.1770"></a><span id="l18.1770" class="difflineplus">+nsMsgIncomingServer::GetDisplayStartupPage(bool *displayStartupPage) {</span>
<a href="#l18.1771"></a><span id="l18.1771">   NS_ENSURE_ARG_POINTER(displayStartupPage);</span>
<a href="#l18.1772"></a><span id="l18.1772">   *displayStartupPage = m_displayStartupPage;</span>
<a href="#l18.1773"></a><span id="l18.1773">   return NS_OK;</span>
<a href="#l18.1774"></a><span id="l18.1774"> }</span>
<a href="#l18.1775"></a><span id="l18.1775"> </span>
<a href="#l18.1776"></a><span id="l18.1776"> NS_IMETHODIMP</span>
<a href="#l18.1777"></a><span id="l18.1777" class="difflineminus">-nsMsgIncomingServer::SetDisplayStartupPage(bool displayStartupPage)</span>
<a href="#l18.1778"></a><span id="l18.1778" class="difflineminus">-{</span>
<a href="#l18.1779"></a><span id="l18.1779" class="difflineplus">+nsMsgIncomingServer::SetDisplayStartupPage(bool displayStartupPage) {</span>
<a href="#l18.1780"></a><span id="l18.1780">   m_displayStartupPage = displayStartupPage;</span>
<a href="#l18.1781"></a><span id="l18.1781">   return NS_OK;</span>
<a href="#l18.1782"></a><span id="l18.1782"> }</span>
<a href="#l18.1783"></a><span id="l18.1783"> </span>
<a href="#l18.1784"></a><span id="l18.1784" class="difflineminus">-</span>
<a href="#l18.1785"></a><span id="l18.1785" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetDownloadSettings(nsIMsgDownloadSettings **settings)</span>
<a href="#l18.1786"></a><span id="l18.1786" class="difflineminus">-{</span>
<a href="#l18.1787"></a><span id="l18.1787" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetDownloadSettings(</span>
<a href="#l18.1788"></a><span id="l18.1788" class="difflineplus">+    nsIMsgDownloadSettings **settings) {</span>
<a href="#l18.1789"></a><span id="l18.1789">   NS_ENSURE_ARG_POINTER(settings);</span>
<a href="#l18.1790"></a><span id="l18.1790">   bool downloadUnreadOnly = false;</span>
<a href="#l18.1791"></a><span id="l18.1791">   bool downloadByDate = false;</span>
<a href="#l18.1792"></a><span id="l18.1792">   uint32_t ageLimitOfMsgsToDownload = 0;</span>
<a href="#l18.1793"></a><span id="l18.1793">   nsresult rv = NS_OK;</span>
<a href="#l18.1794"></a><span id="l18.1794" class="difflineminus">-  if (!m_downloadSettings)</span>
<a href="#l18.1795"></a><span id="l18.1795" class="difflineminus">-  {</span>
<a href="#l18.1796"></a><span id="l18.1796" class="difflineplus">+  if (!m_downloadSettings) {</span>
<a href="#l18.1797"></a><span id="l18.1797">     m_downloadSettings = do_CreateInstance(NS_MSG_DOWNLOADSETTINGS_CONTRACTID);</span>
<a href="#l18.1798"></a><span id="l18.1798" class="difflineminus">-    if (m_downloadSettings)</span>
<a href="#l18.1799"></a><span id="l18.1799" class="difflineminus">-    {</span>
<a href="#l18.1800"></a><span id="l18.1800" class="difflineplus">+    if (m_downloadSettings) {</span>
<a href="#l18.1801"></a><span id="l18.1801">       rv = GetBoolValue(&quot;downloadUnreadOnly&quot;, &amp;downloadUnreadOnly);</span>
<a href="#l18.1802"></a><span id="l18.1802">       rv = GetBoolValue(&quot;downloadByDate&quot;, &amp;downloadByDate);</span>
<a href="#l18.1803"></a><span id="l18.1803" class="difflineminus">-      rv = GetIntValue(&quot;ageLimit&quot;, (int32_t *) &amp;ageLimitOfMsgsToDownload);</span>
<a href="#l18.1804"></a><span id="l18.1804" class="difflineplus">+      rv = GetIntValue(&quot;ageLimit&quot;, (int32_t *)&amp;ageLimitOfMsgsToDownload);</span>
<a href="#l18.1805"></a><span id="l18.1805">       m_downloadSettings-&gt;SetDownloadUnreadOnly(downloadUnreadOnly);</span>
<a href="#l18.1806"></a><span id="l18.1806">       m_downloadSettings-&gt;SetDownloadByDate(downloadByDate);</span>
<a href="#l18.1807"></a><span id="l18.1807">       m_downloadSettings-&gt;SetAgeLimitOfMsgsToDownload(ageLimitOfMsgsToDownload);</span>
<a href="#l18.1808"></a><span id="l18.1808" class="difflineminus">-    }</span>
<a href="#l18.1809"></a><span id="l18.1809" class="difflineminus">-    else</span>
<a href="#l18.1810"></a><span id="l18.1810" class="difflineplus">+    } else</span>
<a href="#l18.1811"></a><span id="l18.1811">       rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.1812"></a><span id="l18.1812">     // Create an empty download settings object,</span>
<a href="#l18.1813"></a><span id="l18.1813" class="difflineminus">-    // get the settings from the server prefs, and init the object from the prefs.</span>
<a href="#l18.1814"></a><span id="l18.1814" class="difflineplus">+    // get the settings from the server prefs, and init the object from the</span>
<a href="#l18.1815"></a><span id="l18.1815" class="difflineplus">+    // prefs.</span>
<a href="#l18.1816"></a><span id="l18.1816">   }</span>
<a href="#l18.1817"></a><span id="l18.1817">   NS_IF_ADDREF(*settings = m_downloadSettings);</span>
<a href="#l18.1818"></a><span id="l18.1818">   return rv;</span>
<a href="#l18.1819"></a><span id="l18.1819"> }</span>
<a href="#l18.1820"></a><span id="l18.1820"> </span>
<a href="#l18.1821"></a><span id="l18.1821" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::SetDownloadSettings(nsIMsgDownloadSettings *settings)</span>
<a href="#l18.1822"></a><span id="l18.1822" class="difflineminus">-{</span>
<a href="#l18.1823"></a><span id="l18.1823" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::SetDownloadSettings(</span>
<a href="#l18.1824"></a><span id="l18.1824" class="difflineplus">+    nsIMsgDownloadSettings *settings) {</span>
<a href="#l18.1825"></a><span id="l18.1825">   m_downloadSettings = settings;</span>
<a href="#l18.1826"></a><span id="l18.1826">   bool downloadUnreadOnly = false;</span>
<a href="#l18.1827"></a><span id="l18.1827">   bool downloadByDate = false;</span>
<a href="#l18.1828"></a><span id="l18.1828">   uint32_t ageLimitOfMsgsToDownload = 0;</span>
<a href="#l18.1829"></a><span id="l18.1829">   m_downloadSettings-&gt;GetDownloadUnreadOnly(&amp;downloadUnreadOnly);</span>
<a href="#l18.1830"></a><span id="l18.1830">   m_downloadSettings-&gt;GetDownloadByDate(&amp;downloadByDate);</span>
<a href="#l18.1831"></a><span id="l18.1831">   m_downloadSettings-&gt;GetAgeLimitOfMsgsToDownload(&amp;ageLimitOfMsgsToDownload);</span>
<a href="#l18.1832"></a><span id="l18.1832">   nsresult rv = SetBoolValue(&quot;downloadUnreadOnly&quot;, downloadUnreadOnly);</span>
<a href="#l18.1833"></a><span id="l18.1833">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1834"></a><span id="l18.1834">   SetBoolValue(&quot;downloadByDate&quot;, downloadByDate);</span>
<a href="#l18.1835"></a><span id="l18.1835">   return SetIntValue(&quot;ageLimit&quot;, ageLimitOfMsgsToDownload);</span>
<a href="#l18.1836"></a><span id="l18.1836"> }</span>
<a href="#l18.1837"></a><span id="l18.1837"> </span>
<a href="#l18.1838"></a><span id="l18.1838"> NS_IMETHODIMP</span>
<a href="#l18.1839"></a><span id="l18.1839" class="difflineminus">-nsMsgIncomingServer::GetSupportsDiskSpace(bool *aSupportsDiskSpace)</span>
<a href="#l18.1840"></a><span id="l18.1840" class="difflineminus">-{</span>
<a href="#l18.1841"></a><span id="l18.1841" class="difflineplus">+nsMsgIncomingServer::GetSupportsDiskSpace(bool *aSupportsDiskSpace) {</span>
<a href="#l18.1842"></a><span id="l18.1842">   NS_ENSURE_ARG_POINTER(aSupportsDiskSpace);</span>
<a href="#l18.1843"></a><span id="l18.1843">   *aSupportsDiskSpace = true;</span>
<a href="#l18.1844"></a><span id="l18.1844">   return NS_OK;</span>
<a href="#l18.1845"></a><span id="l18.1845"> }</span>
<a href="#l18.1846"></a><span id="l18.1846"> </span>
<a href="#l18.1847"></a><span id="l18.1847"> NS_IMETHODIMP</span>
<a href="#l18.1848"></a><span id="l18.1848" class="difflineminus">-nsMsgIncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel)</span>
<a href="#l18.1849"></a><span id="l18.1849" class="difflineminus">-{</span>
<a href="#l18.1850"></a><span id="l18.1850" class="difflineplus">+nsMsgIncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel) {</span>
<a href="#l18.1851"></a><span id="l18.1851">   NS_ENSURE_ARG_POINTER(aSupportLevel);</span>
<a href="#l18.1852"></a><span id="l18.1852"> </span>
<a href="#l18.1853"></a><span id="l18.1853">   nsresult rv = GetIntValue(&quot;offline_support_level&quot;, aSupportLevel);</span>
<a href="#l18.1854"></a><span id="l18.1854">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1855"></a><span id="l18.1855"> </span>
<a href="#l18.1856"></a><span id="l18.1856">   if (*aSupportLevel == OFFLINE_SUPPORT_LEVEL_UNDEFINED)</span>
<a href="#l18.1857"></a><span id="l18.1857">     *aSupportLevel = OFFLINE_SUPPORT_LEVEL_NONE;</span>
<a href="#l18.1858"></a><span id="l18.1858">   return NS_OK;</span>
<a href="#l18.1859"></a><span id="l18.1859"> }</span>
<a href="#l18.1860"></a><span id="l18.1860"> </span>
<a href="#l18.1861"></a><span id="l18.1861"> NS_IMETHODIMP</span>
<a href="#l18.1862"></a><span id="l18.1862" class="difflineminus">-nsMsgIncomingServer::SetOfflineSupportLevel(int32_t aSupportLevel)</span>
<a href="#l18.1863"></a><span id="l18.1863" class="difflineminus">-{</span>
<a href="#l18.1864"></a><span id="l18.1864" class="difflineplus">+nsMsgIncomingServer::SetOfflineSupportLevel(int32_t aSupportLevel) {</span>
<a href="#l18.1865"></a><span id="l18.1865">   SetIntValue(&quot;offline_support_level&quot;, aSupportLevel);</span>
<a href="#l18.1866"></a><span id="l18.1866">   return NS_OK;</span>
<a href="#l18.1867"></a><span id="l18.1867"> }</span>
<a href="#l18.1868"></a><span id="l18.1868" class="difflineminus">-#define BASE_MSGS_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l18.1869"></a><span id="l18.1869" class="difflineplus">+#define BASE_MSGS_URL &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l18.1870"></a><span id="l18.1870"> </span>
<a href="#l18.1871"></a><span id="l18.1871" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::DisplayOfflineMsg(nsIMsgWindow *aMsgWindow)</span>
<a href="#l18.1872"></a><span id="l18.1872" class="difflineminus">-{</span>
<a href="#l18.1873"></a><span id="l18.1873" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::DisplayOfflineMsg(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l18.1874"></a><span id="l18.1874">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l18.1875"></a><span id="l18.1875"> </span>
<a href="#l18.1876"></a><span id="l18.1876">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.1877"></a><span id="l18.1877" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l18.1878"></a><span id="l18.1878" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l18.1879"></a><span id="l18.1879">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.1880"></a><span id="l18.1880"> </span>
<a href="#l18.1881"></a><span id="l18.1881">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.1882"></a><span id="l18.1882" class="difflineminus">-  nsresult rv = bundleService-&gt;CreateBundle(BASE_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l18.1883"></a><span id="l18.1883" class="difflineplus">+  nsresult rv =</span>
<a href="#l18.1884"></a><span id="l18.1884" class="difflineplus">+      bundleService-&gt;CreateBundle(BASE_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l18.1885"></a><span id="l18.1885">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1886"></a><span id="l18.1886" class="difflineminus">-  if (bundle)</span>
<a href="#l18.1887"></a><span id="l18.1887" class="difflineminus">-  {</span>
<a href="#l18.1888"></a><span id="l18.1888" class="difflineplus">+  if (bundle) {</span>
<a href="#l18.1889"></a><span id="l18.1889">     nsString errorMsgTitle;</span>
<a href="#l18.1890"></a><span id="l18.1890">     nsString errorMsgBody;</span>
<a href="#l18.1891"></a><span id="l18.1891">     bundle-&gt;GetStringFromName(&quot;nocachedbodybody2&quot;, errorMsgBody);</span>
<a href="#l18.1892"></a><span id="l18.1892">     bundle-&gt;GetStringFromName(&quot;nocachedbodytitle&quot;, errorMsgTitle);</span>
<a href="#l18.1893"></a><span id="l18.1893">     aMsgWindow-&gt;DisplayHTMLInMessagePane(errorMsgTitle, errorMsgBody, true);</span>
<a href="#l18.1894"></a><span id="l18.1894">   }</span>
<a href="#l18.1895"></a><span id="l18.1895"> </span>
<a href="#l18.1896"></a><span id="l18.1896">   return NS_OK;</span>
<a href="#l18.1897"></a><span id="l18.1897"> }</span>
<a href="#l18.1898"></a><span id="l18.1898"> </span>
<a href="#l18.1899"></a><span id="l18.1899"> // Called only during the migration process. A unique name is generated for the</span>
<a href="#l18.1900"></a><span id="l18.1900"> // migrated account.</span>
<a href="#l18.1901"></a><span id="l18.1901"> NS_IMETHODIMP</span>
<a href="#l18.1902"></a><span id="l18.1902" class="difflineminus">-nsMsgIncomingServer::GeneratePrettyNameForMigration(nsAString&amp; aPrettyName)</span>
<a href="#l18.1903"></a><span id="l18.1903" class="difflineminus">-{</span>
<a href="#l18.1904"></a><span id="l18.1904" class="difflineminus">-/**</span>
<a href="#l18.1905"></a><span id="l18.1905" class="difflineplus">+nsMsgIncomingServer::GeneratePrettyNameForMigration(nsAString &amp;aPrettyName) {</span>
<a href="#l18.1906"></a><span id="l18.1906" class="difflineplus">+  /**</span>
<a href="#l18.1907"></a><span id="l18.1907">    * 4.x had provisions for multiple imap servers to be maintained under</span>
<a href="#l18.1908"></a><span id="l18.1908">    * single identity. So, when migrated each of those server accounts need</span>
<a href="#l18.1909"></a><span id="l18.1909">    * to be represented by unique account name. nsImapIncomingServer will</span>
<a href="#l18.1910"></a><span id="l18.1910">    * override the implementation for this to do the right thing.</span>
<a href="#l18.1911"></a><span id="l18.1911" class="difflineminus">-*/</span>
<a href="#l18.1912"></a><span id="l18.1912" class="difflineplus">+   */</span>
<a href="#l18.1913"></a><span id="l18.1913">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.1914"></a><span id="l18.1914"> }</span>
<a href="#l18.1915"></a><span id="l18.1915"> </span>
<a href="#l18.1916"></a><span id="l18.1916"> NS_IMETHODIMP</span>
<a href="#l18.1917"></a><span id="l18.1917" class="difflineminus">-nsMsgIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l18.1918"></a><span id="l18.1918" class="difflineminus">-{</span>
<a href="#l18.1919"></a><span id="l18.1919" class="difflineplus">+nsMsgIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope) {</span>
<a href="#l18.1920"></a><span id="l18.1920">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l18.1921"></a><span id="l18.1921">   *filterScope = nsMsgSearchScope::offlineMailFilter;</span>
<a href="#l18.1922"></a><span id="l18.1922">   return NS_OK;</span>
<a href="#l18.1923"></a><span id="l18.1923"> }</span>
<a href="#l18.1924"></a><span id="l18.1924"> </span>
<a href="#l18.1925"></a><span id="l18.1925"> NS_IMETHODIMP</span>
<a href="#l18.1926"></a><span id="l18.1926" class="difflineminus">-nsMsgIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope)</span>
<a href="#l18.1927"></a><span id="l18.1927" class="difflineminus">-{</span>
<a href="#l18.1928"></a><span id="l18.1928" class="difflineplus">+nsMsgIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope) {</span>
<a href="#l18.1929"></a><span id="l18.1929">   NS_ENSURE_ARG_POINTER(searchScope);</span>
<a href="#l18.1930"></a><span id="l18.1930">   *searchScope = nsMsgSearchScope::offlineMail;</span>
<a href="#l18.1931"></a><span id="l18.1931">   return NS_OK;</span>
<a href="#l18.1932"></a><span id="l18.1932"> }</span>
<a href="#l18.1933"></a><span id="l18.1933"> </span>
<a href="#l18.1934"></a><span id="l18.1934"> NS_IMETHODIMP</span>
<a href="#l18.1935"></a><span id="l18.1935" class="difflineminus">-nsMsgIncomingServer::GetIsSecure(bool *aIsSecure)</span>
<a href="#l18.1936"></a><span id="l18.1936" class="difflineminus">-{</span>
<a href="#l18.1937"></a><span id="l18.1937" class="difflineplus">+nsMsgIncomingServer::GetIsSecure(bool *aIsSecure) {</span>
<a href="#l18.1938"></a><span id="l18.1938">   NS_ENSURE_ARG_POINTER(aIsSecure);</span>
<a href="#l18.1939"></a><span id="l18.1939">   int32_t socketType;</span>
<a href="#l18.1940"></a><span id="l18.1940">   nsresult rv = GetSocketType(&amp;socketType);</span>
<a href="#l18.1941"></a><span id="l18.1941" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1942"></a><span id="l18.1942" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1943"></a><span id="l18.1943">   *aIsSecure = (socketType == nsMsgSocketType::alwaysSTARTTLS ||</span>
<a href="#l18.1944"></a><span id="l18.1944">                 socketType == nsMsgSocketType::SSL);</span>
<a href="#l18.1945"></a><span id="l18.1945">   return NS_OK;</span>
<a href="#l18.1946"></a><span id="l18.1946"> }</span>
<a href="#l18.1947"></a><span id="l18.1947"> </span>
<a href="#l18.1948"></a><span id="l18.1948"> // use the convenience macros to implement the accessors</span>
<a href="#l18.1949"></a><span id="l18.1949"> NS_IMPL_SERVERPREF_STR(nsMsgIncomingServer, Username, &quot;userName&quot;)</span>
<a href="#l18.1950"></a><span id="l18.1950"> NS_IMPL_SERVERPREF_INT(nsMsgIncomingServer, AuthMethod, &quot;authMethod&quot;)</span>
<a href="#l18.1951"></a><span id="l18.1951" class="difflineat">@@ -1713,177 +1566,157 @@ NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingSer</span>
<a href="#l18.1952"></a><span id="l18.1952"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, EmptyTrashOnExit,</span>
<a href="#l18.1953"></a><span id="l18.1953">                         &quot;empty_trash_on_exit&quot;)</span>
<a href="#l18.1954"></a><span id="l18.1954"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, CanDelete, &quot;canDelete&quot;)</span>
<a href="#l18.1955"></a><span id="l18.1955"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, LoginAtStartUp, &quot;login_at_startup&quot;)</span>
<a href="#l18.1956"></a><span id="l18.1956"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer,</span>
<a href="#l18.1957"></a><span id="l18.1957">                         DefaultCopiesAndFoldersPrefsToServer,</span>
<a href="#l18.1958"></a><span id="l18.1958">                         &quot;allows_specialfolders_usage&quot;)</span>
<a href="#l18.1959"></a><span id="l18.1959"> </span>
<a href="#l18.1960"></a><span id="l18.1960" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer,</span>
<a href="#l18.1961"></a><span id="l18.1961" class="difflineminus">-                        CanCreateFoldersOnServer,</span>
<a href="#l18.1962"></a><span id="l18.1962" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, CanCreateFoldersOnServer,</span>
<a href="#l18.1963"></a><span id="l18.1963">                         &quot;canCreateFolders&quot;)</span>
<a href="#l18.1964"></a><span id="l18.1964"> </span>
<a href="#l18.1965"></a><span id="l18.1965" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer,</span>
<a href="#l18.1966"></a><span id="l18.1966" class="difflineminus">-                        CanFileMessagesOnServer,</span>
<a href="#l18.1967"></a><span id="l18.1967" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, CanFileMessagesOnServer,</span>
<a href="#l18.1968"></a><span id="l18.1968">                         &quot;canFileMessages&quot;)</span>
<a href="#l18.1969"></a><span id="l18.1969"> </span>
<a href="#l18.1970"></a><span id="l18.1970" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer,</span>
<a href="#l18.1971"></a><span id="l18.1971" class="difflineminus">-      LimitOfflineMessageSize,</span>
<a href="#l18.1972"></a><span id="l18.1972" class="difflineminus">-      &quot;limit_offline_message_size&quot;)</span>
<a href="#l18.1973"></a><span id="l18.1973" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, LimitOfflineMessageSize,</span>
<a href="#l18.1974"></a><span id="l18.1974" class="difflineplus">+                        &quot;limit_offline_message_size&quot;)</span>
<a href="#l18.1975"></a><span id="l18.1975"> </span>
<a href="#l18.1976"></a><span id="l18.1976"> NS_IMPL_SERVERPREF_INT(nsMsgIncomingServer, MaxMessageSize, &quot;max_size&quot;)</span>
<a href="#l18.1977"></a><span id="l18.1977"> </span>
<a href="#l18.1978"></a><span id="l18.1978" class="difflineminus">-NS_IMPL_SERVERPREF_INT(nsMsgIncomingServer, IncomingDuplicateAction, &quot;dup_action&quot;)</span>
<a href="#l18.1979"></a><span id="l18.1979" class="difflineplus">+NS_IMPL_SERVERPREF_INT(nsMsgIncomingServer, IncomingDuplicateAction,</span>
<a href="#l18.1980"></a><span id="l18.1980" class="difflineplus">+                       &quot;dup_action&quot;)</span>
<a href="#l18.1981"></a><span id="l18.1981"> </span>
<a href="#l18.1982"></a><span id="l18.1982"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, Hidden, &quot;hidden&quot;)</span>
<a href="#l18.1983"></a><span id="l18.1983"> </span>
<a href="#l18.1984"></a><span id="l18.1984" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetSocketType(int32_t *aSocketType)</span>
<a href="#l18.1985"></a><span id="l18.1985" class="difflineminus">-{</span>
<a href="#l18.1986"></a><span id="l18.1986" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.1987"></a><span id="l18.1987" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1988"></a><span id="l18.1988" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetSocketType(int32_t *aSocketType) {</span>
<a href="#l18.1989"></a><span id="l18.1989" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.1990"></a><span id="l18.1990"> </span>
<a href="#l18.1991"></a><span id="l18.1991">   nsresult rv = mPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l18.1992"></a><span id="l18.1992"> </span>
<a href="#l18.1993"></a><span id="l18.1993">   // socketType is set to default value. Look at isSecure setting</span>
<a href="#l18.1994"></a><span id="l18.1994" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l18.1995"></a><span id="l18.1995" class="difflineminus">-  {</span>
<a href="#l18.1996"></a><span id="l18.1996" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l18.1997"></a><span id="l18.1997">     bool isSecure;</span>
<a href="#l18.1998"></a><span id="l18.1998">     rv = mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure);</span>
<a href="#l18.1999"></a><span id="l18.1999" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isSecure)</span>
<a href="#l18.2000"></a><span id="l18.2000" class="difflineminus">-    {</span>
<a href="#l18.2001"></a><span id="l18.2001" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isSecure) {</span>
<a href="#l18.2002"></a><span id="l18.2002">       *aSocketType = nsMsgSocketType::SSL;</span>
<a href="#l18.2003"></a><span id="l18.2003">       // don't call virtual method in case overrides call GetSocketType</span>
<a href="#l18.2004"></a><span id="l18.2004">       nsMsgIncomingServer::SetSocketType(*aSocketType);</span>
<a href="#l18.2005"></a><span id="l18.2005" class="difflineminus">-    }</span>
<a href="#l18.2006"></a><span id="l18.2006" class="difflineminus">-    else</span>
<a href="#l18.2007"></a><span id="l18.2007" class="difflineminus">-    {</span>
<a href="#l18.2008"></a><span id="l18.2008" class="difflineminus">-      if (!mDefPrefBranch)</span>
<a href="#l18.2009"></a><span id="l18.2009" class="difflineminus">-        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.2010"></a><span id="l18.2010" class="difflineplus">+    } else {</span>
<a href="#l18.2011"></a><span id="l18.2011" class="difflineplus">+      if (!mDefPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.2012"></a><span id="l18.2012">       rv = mDefPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l18.2013"></a><span id="l18.2013" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l18.2014"></a><span id="l18.2014" class="difflineminus">-        *aSocketType = nsMsgSocketType::plain;</span>
<a href="#l18.2015"></a><span id="l18.2015" class="difflineplus">+      if (NS_FAILED(rv)) *aSocketType = nsMsgSocketType::plain;</span>
<a href="#l18.2016"></a><span id="l18.2016">     }</span>
<a href="#l18.2017"></a><span id="l18.2017">   }</span>
<a href="#l18.2018"></a><span id="l18.2018">   return rv;</span>
<a href="#l18.2019"></a><span id="l18.2019"> }</span>
<a href="#l18.2020"></a><span id="l18.2020"> </span>
<a href="#l18.2021"></a><span id="l18.2021" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::SetSocketType(int32_t aSocketType)</span>
<a href="#l18.2022"></a><span id="l18.2022" class="difflineminus">-{</span>
<a href="#l18.2023"></a><span id="l18.2023" class="difflineminus">-  if (!mPrefBranch)</span>
<a href="#l18.2024"></a><span id="l18.2024" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.2025"></a><span id="l18.2025" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::SetSocketType(int32_t aSocketType) {</span>
<a href="#l18.2026"></a><span id="l18.2026" class="difflineplus">+  if (!mPrefBranch) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.2027"></a><span id="l18.2027"> </span>
<a href="#l18.2028"></a><span id="l18.2028">   int32_t socketType = nsMsgSocketType::plain;</span>
<a href="#l18.2029"></a><span id="l18.2029">   mPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, &amp;socketType);</span>
<a href="#l18.2030"></a><span id="l18.2030"> </span>
<a href="#l18.2031"></a><span id="l18.2031">   nsresult rv = mPrefBranch-&gt;SetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l18.2032"></a><span id="l18.2032">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2033"></a><span id="l18.2033"> </span>
<a href="#l18.2034"></a><span id="l18.2034">   bool isSecureOld = (socketType == nsMsgSocketType::alwaysSTARTTLS ||</span>
<a href="#l18.2035"></a><span id="l18.2035" class="difflineminus">-                        socketType == nsMsgSocketType::SSL);</span>
<a href="#l18.2036"></a><span id="l18.2036" class="difflineplus">+                      socketType == nsMsgSocketType::SSL);</span>
<a href="#l18.2037"></a><span id="l18.2037">   bool isSecureNew = (aSocketType == nsMsgSocketType::alwaysSTARTTLS ||</span>
<a href="#l18.2038"></a><span id="l18.2038" class="difflineminus">-                        aSocketType == nsMsgSocketType::SSL);</span>
<a href="#l18.2039"></a><span id="l18.2039" class="difflineplus">+                      aSocketType == nsMsgSocketType::SSL);</span>
<a href="#l18.2040"></a><span id="l18.2040">   if ((isSecureOld != isSecureNew) &amp;&amp; m_rootFolder) {</span>
<a href="#l18.2041"></a><span id="l18.2041" class="difflineminus">-    m_rootFolder-&gt;NotifyBoolPropertyChanged(kIsSecure,</span>
<a href="#l18.2042"></a><span id="l18.2042" class="difflineminus">-                                            isSecureOld, isSecureNew);</span>
<a href="#l18.2043"></a><span id="l18.2043" class="difflineplus">+    m_rootFolder-&gt;NotifyBoolPropertyChanged(kIsSecure, isSecureOld,</span>
<a href="#l18.2044"></a><span id="l18.2044" class="difflineplus">+                                            isSecureNew);</span>
<a href="#l18.2045"></a><span id="l18.2045">   }</span>
<a href="#l18.2046"></a><span id="l18.2046">   return NS_OK;</span>
<a href="#l18.2047"></a><span id="l18.2047"> }</span>
<a href="#l18.2048"></a><span id="l18.2048"> </span>
<a href="#l18.2049"></a><span id="l18.2049"> // Check if the password is available and return a boolean indicating whether</span>
<a href="#l18.2050"></a><span id="l18.2050"> // it is being authenticated or not.</span>
<a href="#l18.2051"></a><span id="l18.2051"> NS_IMETHODIMP</span>
<a href="#l18.2052"></a><span id="l18.2052" class="difflineminus">-nsMsgIncomingServer::GetPasswordPromptRequired(bool *aPasswordIsRequired)</span>
<a href="#l18.2053"></a><span id="l18.2053" class="difflineminus">-{</span>
<a href="#l18.2054"></a><span id="l18.2054" class="difflineplus">+nsMsgIncomingServer::GetPasswordPromptRequired(bool *aPasswordIsRequired) {</span>
<a href="#l18.2055"></a><span id="l18.2055">   NS_ENSURE_ARG_POINTER(aPasswordIsRequired);</span>
<a href="#l18.2056"></a><span id="l18.2056">   *aPasswordIsRequired = true;</span>
<a href="#l18.2057"></a><span id="l18.2057"> </span>
<a href="#l18.2058"></a><span id="l18.2058" class="difflineminus">-  // If the password is not even required for biff we don't need to check any further</span>
<a href="#l18.2059"></a><span id="l18.2059" class="difflineplus">+  // If the password is not even required for biff we don't need to check any</span>
<a href="#l18.2060"></a><span id="l18.2060" class="difflineplus">+  // further</span>
<a href="#l18.2061"></a><span id="l18.2061">   nsresult rv = GetServerRequiresPasswordForBiff(aPasswordIsRequired);</span>
<a href="#l18.2062"></a><span id="l18.2062">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2063"></a><span id="l18.2063" class="difflineminus">-  if (!*aPasswordIsRequired)</span>
<a href="#l18.2064"></a><span id="l18.2064" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2065"></a><span id="l18.2065" class="difflineplus">+  if (!*aPasswordIsRequired) return NS_OK;</span>
<a href="#l18.2066"></a><span id="l18.2066"> </span>
<a href="#l18.2067"></a><span id="l18.2067">   // If the password is empty, check to see if it is stored and to be retrieved</span>
<a href="#l18.2068"></a><span id="l18.2068" class="difflineminus">-  if (m_password.IsEmpty())</span>
<a href="#l18.2069"></a><span id="l18.2069" class="difflineminus">-    (void)GetPasswordWithoutUI();</span>
<a href="#l18.2070"></a><span id="l18.2070" class="difflineplus">+  if (m_password.IsEmpty()) (void)GetPasswordWithoutUI();</span>
<a href="#l18.2071"></a><span id="l18.2071"> </span>
<a href="#l18.2072"></a><span id="l18.2072">   *aPasswordIsRequired = m_password.IsEmpty();</span>
<a href="#l18.2073"></a><span id="l18.2073">   return rv;</span>
<a href="#l18.2074"></a><span id="l18.2074"> }</span>
<a href="#l18.2075"></a><span id="l18.2075"> </span>
<a href="#l18.2076"></a><span id="l18.2076" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::ConfigureTemporaryFilters(nsIMsgFilterList *aFilterList)</span>
<a href="#l18.2077"></a><span id="l18.2077" class="difflineminus">-{</span>
<a href="#l18.2078"></a><span id="l18.2078" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::ConfigureTemporaryFilters(</span>
<a href="#l18.2079"></a><span id="l18.2079" class="difflineplus">+    nsIMsgFilterList *aFilterList) {</span>
<a href="#l18.2080"></a><span id="l18.2080">   nsresult rv = ConfigureTemporaryReturnReceiptsFilter(aFilterList);</span>
<a href="#l18.2081"></a><span id="l18.2081" class="difflineminus">-  if (NS_FAILED(rv)) // shut up warnings...</span>
<a href="#l18.2082"></a><span id="l18.2082" class="difflineplus">+  if (NS_FAILED(rv))  // shut up warnings...</span>
<a href="#l18.2083"></a><span id="l18.2083">     return rv;</span>
<a href="#l18.2084"></a><span id="l18.2084">   return ConfigureTemporaryServerSpamFilters(aFilterList);</span>
<a href="#l18.2085"></a><span id="l18.2085"> }</span>
<a href="#l18.2086"></a><span id="l18.2086"> </span>
<a href="#l18.2087"></a><span id="l18.2087" class="difflineminus">-nsresult</span>
<a href="#l18.2088"></a><span id="l18.2088" class="difflineminus">-nsMsgIncomingServer::ConfigureTemporaryServerSpamFilters(nsIMsgFilterList *filterList)</span>
<a href="#l18.2089"></a><span id="l18.2089" class="difflineminus">-{</span>
<a href="#l18.2090"></a><span id="l18.2090" class="difflineplus">+nsresult nsMsgIncomingServer::ConfigureTemporaryServerSpamFilters(</span>
<a href="#l18.2091"></a><span id="l18.2091" class="difflineplus">+    nsIMsgFilterList *filterList) {</span>
<a href="#l18.2092"></a><span id="l18.2092">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l18.2093"></a><span id="l18.2093">   nsresult rv = GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l18.2094"></a><span id="l18.2094">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2095"></a><span id="l18.2095"> </span>
<a href="#l18.2096"></a><span id="l18.2096">   bool useServerFilter;</span>
<a href="#l18.2097"></a><span id="l18.2097">   rv = spamSettings-&gt;GetUseServerFilter(&amp;useServerFilter);</span>
<a href="#l18.2098"></a><span id="l18.2098">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2099"></a><span id="l18.2099"> </span>
<a href="#l18.2100"></a><span id="l18.2100">   // if we aren't configured to use server filters, then return early.</span>
<a href="#l18.2101"></a><span id="l18.2101" class="difflineminus">-  if (!useServerFilter)</span>
<a href="#l18.2102"></a><span id="l18.2102" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2103"></a><span id="l18.2103" class="difflineplus">+  if (!useServerFilter) return NS_OK;</span>
<a href="#l18.2104"></a><span id="l18.2104"> </span>
<a href="#l18.2105"></a><span id="l18.2105">   // For performance reasons, we'll handle clearing of filters if the user turns</span>
<a href="#l18.2106"></a><span id="l18.2106" class="difflineminus">-  // off the server-side filters from the junk mail controls, in the junk mail controls.</span>
<a href="#l18.2107"></a><span id="l18.2107" class="difflineplus">+  // off the server-side filters from the junk mail controls, in the junk mail</span>
<a href="#l18.2108"></a><span id="l18.2108" class="difflineplus">+  // controls.</span>
<a href="#l18.2109"></a><span id="l18.2109">   nsAutoCString serverFilterName;</span>
<a href="#l18.2110"></a><span id="l18.2110">   spamSettings-&gt;GetServerFilterName(serverFilterName);</span>
<a href="#l18.2111"></a><span id="l18.2111" class="difflineminus">-  if (serverFilterName.IsEmpty())</span>
<a href="#l18.2112"></a><span id="l18.2112" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2113"></a><span id="l18.2113" class="difflineplus">+  if (serverFilterName.IsEmpty()) return NS_OK;</span>
<a href="#l18.2114"></a><span id="l18.2114">   int32_t serverFilterTrustFlags = 0;</span>
<a href="#l18.2115"></a><span id="l18.2115" class="difflineminus">-  (void) spamSettings-&gt;GetServerFilterTrustFlags(&amp;serverFilterTrustFlags);</span>
<a href="#l18.2116"></a><span id="l18.2116" class="difflineminus">-  if (!serverFilterTrustFlags)</span>
<a href="#l18.2117"></a><span id="l18.2117" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2118"></a><span id="l18.2118" class="difflineplus">+  (void)spamSettings-&gt;GetServerFilterTrustFlags(&amp;serverFilterTrustFlags);</span>
<a href="#l18.2119"></a><span id="l18.2119" class="difflineplus">+  if (!serverFilterTrustFlags) return NS_OK;</span>
<a href="#l18.2120"></a><span id="l18.2120">   // check if filters have been setup already.</span>
<a href="#l18.2121"></a><span id="l18.2121">   nsAutoString yesFilterName, noFilterName;</span>
<a href="#l18.2122"></a><span id="l18.2122">   CopyASCIItoUTF16(serverFilterName, yesFilterName);</span>
<a href="#l18.2123"></a><span id="l18.2123">   yesFilterName.AppendLiteral(&quot;Yes&quot;);</span>
<a href="#l18.2124"></a><span id="l18.2124"> </span>
<a href="#l18.2125"></a><span id="l18.2125">   CopyASCIItoUTF16(serverFilterName, noFilterName);</span>
<a href="#l18.2126"></a><span id="l18.2126">   noFilterName.AppendLiteral(&quot;No&quot;);</span>
<a href="#l18.2127"></a><span id="l18.2127"> </span>
<a href="#l18.2128"></a><span id="l18.2128">   nsCOMPtr&lt;nsIMsgFilter&gt; newFilter;</span>
<a href="#l18.2129"></a><span id="l18.2129" class="difflineminus">-  (void) filterList-&gt;GetFilterNamed(yesFilterName,</span>
<a href="#l18.2130"></a><span id="l18.2130" class="difflineminus">-                                  getter_AddRefs(newFilter));</span>
<a href="#l18.2131"></a><span id="l18.2131" class="difflineplus">+  (void)filterList-&gt;GetFilterNamed(yesFilterName, getter_AddRefs(newFilter));</span>
<a href="#l18.2132"></a><span id="l18.2132"> </span>
<a href="#l18.2133"></a><span id="l18.2133">   if (!newFilter)</span>
<a href="#l18.2134"></a><span id="l18.2134" class="difflineminus">-    (void) filterList-&gt;GetFilterNamed(noFilterName,</span>
<a href="#l18.2135"></a><span id="l18.2135" class="difflineminus">-                                  getter_AddRefs(newFilter));</span>
<a href="#l18.2136"></a><span id="l18.2136" class="difflineminus">-  if (newFilter)</span>
<a href="#l18.2137"></a><span id="l18.2137" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2138"></a><span id="l18.2138" class="difflineplus">+    (void)filterList-&gt;GetFilterNamed(noFilterName, getter_AddRefs(newFilter));</span>
<a href="#l18.2139"></a><span id="l18.2139" class="difflineplus">+  if (newFilter) return NS_OK;</span>
<a href="#l18.2140"></a><span id="l18.2140"> </span>
<a href="#l18.2141"></a><span id="l18.2141">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l18.2142"></a><span id="l18.2142">   spamSettings-&gt;GetServerFilterFile(getter_AddRefs(file));</span>
<a href="#l18.2143"></a><span id="l18.2143"> </span>
<a href="#l18.2144"></a><span id="l18.2144" class="difflineminus">-  // it's possible that we can no longer find the sfd file (i.e. the user disabled an extnsion that</span>
<a href="#l18.2145"></a><span id="l18.2145" class="difflineminus">-  // was supplying the .sfd file.</span>
<a href="#l18.2146"></a><span id="l18.2146" class="difflineminus">-  if (!file)</span>
<a href="#l18.2147"></a><span id="l18.2147" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2148"></a><span id="l18.2148" class="difflineplus">+  // it's possible that we can no longer find the sfd file (i.e. the user</span>
<a href="#l18.2149"></a><span id="l18.2149" class="difflineplus">+  // disabled an extnsion that was supplying the .sfd file.</span>
<a href="#l18.2150"></a><span id="l18.2150" class="difflineplus">+  if (!file) return NS_OK;</span>
<a href="#l18.2151"></a><span id="l18.2151"> </span>
<a href="#l18.2152"></a><span id="l18.2152" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFilterService&gt; filterService = do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.2153"></a><span id="l18.2153" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l18.2154"></a><span id="l18.2154" class="difflineplus">+      do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.2155"></a><span id="l18.2155">   nsCOMPtr&lt;nsIMsgFilterList&gt; serverFilterList;</span>
<a href="#l18.2156"></a><span id="l18.2156"> </span>
<a href="#l18.2157"></a><span id="l18.2157" class="difflineminus">-  rv = filterService-&gt;OpenFilterList(file, NULL, NULL, getter_AddRefs(serverFilterList));</span>
<a href="#l18.2158"></a><span id="l18.2158" class="difflineplus">+  rv = filterService-&gt;OpenFilterList(file, NULL, NULL,</span>
<a href="#l18.2159"></a><span id="l18.2159" class="difflineplus">+                                     getter_AddRefs(serverFilterList));</span>
<a href="#l18.2160"></a><span id="l18.2160">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2161"></a><span id="l18.2161"> </span>
<a href="#l18.2162"></a><span id="l18.2162">   rv = serverFilterList-&gt;GetFilterNamed(yesFilterName,</span>
<a href="#l18.2163"></a><span id="l18.2163" class="difflineminus">-                                  getter_AddRefs(newFilter));</span>
<a href="#l18.2164"></a><span id="l18.2164" class="difflineminus">-  if (newFilter &amp;&amp; serverFilterTrustFlags &amp; nsISpamSettings::TRUST_POSITIVES)</span>
<a href="#l18.2165"></a><span id="l18.2165" class="difflineminus">-  {</span>
<a href="#l18.2166"></a><span id="l18.2166" class="difflineplus">+                                        getter_AddRefs(newFilter));</span>
<a href="#l18.2167"></a><span id="l18.2167" class="difflineplus">+  if (newFilter &amp;&amp; serverFilterTrustFlags &amp; nsISpamSettings::TRUST_POSITIVES) {</span>
<a href="#l18.2168"></a><span id="l18.2168">     newFilter-&gt;SetTemporary(true);</span>
<a href="#l18.2169"></a><span id="l18.2169">     // check if we're supposed to move junk mail to junk folder; if so,</span>
<a href="#l18.2170"></a><span id="l18.2170">     // add filter action to do so.</span>
<a href="#l18.2171"></a><span id="l18.2171"> </span>
<a href="#l18.2172"></a><span id="l18.2172">     /*</span>
<a href="#l18.2173"></a><span id="l18.2173">      * We don't want this filter to activate on messages that have</span>
<a href="#l18.2174"></a><span id="l18.2174">      *  been marked by the user as not spam. This occurs when messages that</span>
<a href="#l18.2175"></a><span id="l18.2175">      *  were marked as good are moved back into the inbox. But to</span>
<a href="#l18.2176"></a><span id="l18.2176" class="difflineat">@@ -1892,27 +1725,27 @@ nsMsgIncomingServer::ConfigureTemporaryS</span>
<a href="#l18.2177"></a><span id="l18.2177">      */</span>
<a href="#l18.2178"></a><span id="l18.2178"> </span>
<a href="#l18.2179"></a><span id="l18.2179">     // get the list of search terms from the filter</span>
<a href="#l18.2180"></a><span id="l18.2180">     nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l18.2181"></a><span id="l18.2181">     rv = newFilter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l18.2182"></a><span id="l18.2182">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2183"></a><span id="l18.2183">     uint32_t count = 0;</span>
<a href="#l18.2184"></a><span id="l18.2184">     searchTerms-&gt;Count(&amp;count);</span>
<a href="#l18.2185"></a><span id="l18.2185" class="difflineminus">-    if (count &gt; 1) // don't need to group a single term</span>
<a href="#l18.2186"></a><span id="l18.2186" class="difflineplus">+    if (count &gt; 1)  // don't need to group a single term</span>
<a href="#l18.2187"></a><span id="l18.2187">     {</span>
<a href="#l18.2188"></a><span id="l18.2188">       // beginGrouping the first term, and endGrouping the last term</span>
<a href="#l18.2189"></a><span id="l18.2189" class="difflineminus">-      nsCOMPtr&lt;nsIMsgSearchTerm&gt; firstTerm(do_QueryElementAt(searchTerms,</span>
<a href="#l18.2190"></a><span id="l18.2190" class="difflineminus">-                                                             0, &amp;rv));</span>
<a href="#l18.2191"></a><span id="l18.2191" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.2192"></a><span id="l18.2192" class="difflineplus">+      nsCOMPtr&lt;nsIMsgSearchTerm&gt; firstTerm(</span>
<a href="#l18.2193"></a><span id="l18.2193" class="difflineplus">+          do_QueryElementAt(searchTerms, 0, &amp;rv));</span>
<a href="#l18.2194"></a><span id="l18.2194" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2195"></a><span id="l18.2195">       firstTerm-&gt;SetBeginsGrouping(true);</span>
<a href="#l18.2196"></a><span id="l18.2196"> </span>
<a href="#l18.2197"></a><span id="l18.2197" class="difflineminus">-      nsCOMPtr&lt;nsIMsgSearchTerm&gt; lastTerm(do_QueryElementAt(searchTerms,</span>
<a href="#l18.2198"></a><span id="l18.2198" class="difflineminus">-                                                            count - 1, &amp;rv));</span>
<a href="#l18.2199"></a><span id="l18.2199" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.2200"></a><span id="l18.2200" class="difflineplus">+      nsCOMPtr&lt;nsIMsgSearchTerm&gt; lastTerm(</span>
<a href="#l18.2201"></a><span id="l18.2201" class="difflineplus">+          do_QueryElementAt(searchTerms, count - 1, &amp;rv));</span>
<a href="#l18.2202"></a><span id="l18.2202" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2203"></a><span id="l18.2203">       lastTerm-&gt;SetEndsGrouping(true);</span>
<a href="#l18.2204"></a><span id="l18.2204">     }</span>
<a href="#l18.2205"></a><span id="l18.2205"> </span>
<a href="#l18.2206"></a><span id="l18.2206">     // Create a new term, checking if the user set junk status. The term will</span>
<a href="#l18.2207"></a><span id="l18.2207">     // search for junkscoreorigin != &quot;user&quot;</span>
<a href="#l18.2208"></a><span id="l18.2208">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; searchTerm;</span>
<a href="#l18.2209"></a><span id="l18.2209">     rv = newFilter-&gt;CreateTerm(getter_AddRefs(searchTerm));</span>
<a href="#l18.2210"></a><span id="l18.2210">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2211"></a><span id="l18.2211" class="difflineat">@@ -1927,383 +1760,355 @@ nsMsgIncomingServer::ConfigureTemporaryS</span>
<a href="#l18.2212"></a><span id="l18.2212">     searchValue-&gt;SetAttrib(nsMsgSearchAttrib::JunkScoreOrigin);</span>
<a href="#l18.2213"></a><span id="l18.2213">     searchValue-&gt;SetStr(NS_LITERAL_STRING(&quot;user&quot;));</span>
<a href="#l18.2214"></a><span id="l18.2214">     searchTerm-&gt;SetValue(searchValue);</span>
<a href="#l18.2215"></a><span id="l18.2215"> </span>
<a href="#l18.2216"></a><span id="l18.2216">     searchTerms-&gt;InsertElementAt(searchTerm, count);</span>
<a href="#l18.2217"></a><span id="l18.2217"> </span>
<a href="#l18.2218"></a><span id="l18.2218">     bool moveOnSpam, markAsReadOnSpam;</span>
<a href="#l18.2219"></a><span id="l18.2219">     spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l18.2220"></a><span id="l18.2220" class="difflineminus">-    if (moveOnSpam)</span>
<a href="#l18.2221"></a><span id="l18.2221" class="difflineminus">-    {</span>
<a href="#l18.2222"></a><span id="l18.2222" class="difflineplus">+    if (moveOnSpam) {</span>
<a href="#l18.2223"></a><span id="l18.2223">       nsCString spamFolderURI;</span>
<a href="#l18.2224"></a><span id="l18.2224">       rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l18.2225"></a><span id="l18.2225" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; (!spamFolderURI.IsEmpty()))</span>
<a href="#l18.2226"></a><span id="l18.2226" class="difflineminus">-      {</span>
<a href="#l18.2227"></a><span id="l18.2227" class="difflineminus">-        nsCOMPtr &lt;nsIMsgRuleAction&gt; moveAction;</span>
<a href="#l18.2228"></a><span id="l18.2228" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; (!spamFolderURI.IsEmpty())) {</span>
<a href="#l18.2229"></a><span id="l18.2229" class="difflineplus">+        nsCOMPtr&lt;nsIMsgRuleAction&gt; moveAction;</span>
<a href="#l18.2230"></a><span id="l18.2230">         rv = newFilter-&gt;CreateAction(getter_AddRefs(moveAction));</span>
<a href="#l18.2231"></a><span id="l18.2231" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2232"></a><span id="l18.2232" class="difflineminus">-        {</span>
<a href="#l18.2233"></a><span id="l18.2233" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2234"></a><span id="l18.2234">           moveAction-&gt;SetType(nsMsgFilterAction::MoveToFolder);</span>
<a href="#l18.2235"></a><span id="l18.2235">           moveAction-&gt;SetTargetFolderUri(spamFolderURI);</span>
<a href="#l18.2236"></a><span id="l18.2236">           newFilter-&gt;AppendAction(moveAction);</span>
<a href="#l18.2237"></a><span id="l18.2237">         }</span>
<a href="#l18.2238"></a><span id="l18.2238">       }</span>
<a href="#l18.2239"></a><span id="l18.2239">     }</span>
<a href="#l18.2240"></a><span id="l18.2240">     spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l18.2241"></a><span id="l18.2241" class="difflineminus">-    if (markAsReadOnSpam)</span>
<a href="#l18.2242"></a><span id="l18.2242" class="difflineminus">-    {</span>
<a href="#l18.2243"></a><span id="l18.2243" class="difflineminus">-      nsCOMPtr &lt;nsIMsgRuleAction&gt; markAsReadAction;</span>
<a href="#l18.2244"></a><span id="l18.2244" class="difflineplus">+    if (markAsReadOnSpam) {</span>
<a href="#l18.2245"></a><span id="l18.2245" class="difflineplus">+      nsCOMPtr&lt;nsIMsgRuleAction&gt; markAsReadAction;</span>
<a href="#l18.2246"></a><span id="l18.2246">       rv = newFilter-&gt;CreateAction(getter_AddRefs(markAsReadAction));</span>
<a href="#l18.2247"></a><span id="l18.2247" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2248"></a><span id="l18.2248" class="difflineminus">-      {</span>
<a href="#l18.2249"></a><span id="l18.2249" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2250"></a><span id="l18.2250">         markAsReadAction-&gt;SetType(nsMsgFilterAction::MarkRead);</span>
<a href="#l18.2251"></a><span id="l18.2251">         newFilter-&gt;AppendAction(markAsReadAction);</span>
<a href="#l18.2252"></a><span id="l18.2252">       }</span>
<a href="#l18.2253"></a><span id="l18.2253">     }</span>
<a href="#l18.2254"></a><span id="l18.2254">     filterList-&gt;InsertFilterAt(0, newFilter);</span>
<a href="#l18.2255"></a><span id="l18.2255">   }</span>
<a href="#l18.2256"></a><span id="l18.2256"> </span>
<a href="#l18.2257"></a><span id="l18.2257" class="difflineminus">-  rv = serverFilterList-&gt;GetFilterNamed(noFilterName,</span>
<a href="#l18.2258"></a><span id="l18.2258" class="difflineminus">-                                  getter_AddRefs(newFilter));</span>
<a href="#l18.2259"></a><span id="l18.2259" class="difflineminus">-  if (newFilter &amp;&amp; serverFilterTrustFlags &amp; nsISpamSettings::TRUST_NEGATIVES)</span>
<a href="#l18.2260"></a><span id="l18.2260" class="difflineminus">-  {</span>
<a href="#l18.2261"></a><span id="l18.2261" class="difflineplus">+  rv =</span>
<a href="#l18.2262"></a><span id="l18.2262" class="difflineplus">+      serverFilterList-&gt;GetFilterNamed(noFilterName, getter_AddRefs(newFilter));</span>
<a href="#l18.2263"></a><span id="l18.2263" class="difflineplus">+  if (newFilter &amp;&amp; serverFilterTrustFlags &amp; nsISpamSettings::TRUST_NEGATIVES) {</span>
<a href="#l18.2264"></a><span id="l18.2264">     newFilter-&gt;SetTemporary(true);</span>
<a href="#l18.2265"></a><span id="l18.2265">     filterList-&gt;InsertFilterAt(0, newFilter);</span>
<a href="#l18.2266"></a><span id="l18.2266">   }</span>
<a href="#l18.2267"></a><span id="l18.2267"> </span>
<a href="#l18.2268"></a><span id="l18.2268">   return rv;</span>
<a href="#l18.2269"></a><span id="l18.2269"> }</span>
<a href="#l18.2270"></a><span id="l18.2270"> </span>
<a href="#l18.2271"></a><span id="l18.2271" class="difflineminus">-nsresult</span>
<a href="#l18.2272"></a><span id="l18.2272" class="difflineminus">-nsMsgIncomingServer::ConfigureTemporaryReturnReceiptsFilter(nsIMsgFilterList *filterList)</span>
<a href="#l18.2273"></a><span id="l18.2273" class="difflineminus">-{</span>
<a href="#l18.2274"></a><span id="l18.2274" class="difflineplus">+nsresult nsMsgIncomingServer::ConfigureTemporaryReturnReceiptsFilter(</span>
<a href="#l18.2275"></a><span id="l18.2275" class="difflineplus">+    nsIMsgFilterList *filterList) {</span>
<a href="#l18.2276"></a><span id="l18.2276">   nsresult rv;</span>
<a href="#l18.2277"></a><span id="l18.2277"> </span>
<a href="#l18.2278"></a><span id="l18.2278" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.2279"></a><span id="l18.2279" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l18.2280"></a><span id="l18.2280" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.2281"></a><span id="l18.2281">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2282"></a><span id="l18.2282"> </span>
<a href="#l18.2283"></a><span id="l18.2283">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l18.2284"></a><span id="l18.2284">   rv = accountMgr-&gt;GetFirstIdentityForServer(this, getter_AddRefs(identity));</span>
<a href="#l18.2285"></a><span id="l18.2285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2286"></a><span id="l18.2286">   // this can return success and a null identity...</span>
<a href="#l18.2287"></a><span id="l18.2287"> </span>
<a href="#l18.2288"></a><span id="l18.2288">   bool useCustomPrefs = false;</span>
<a href="#l18.2289"></a><span id="l18.2289">   int32_t incorp = nsIMsgMdnGenerator::eIncorporateInbox;</span>
<a href="#l18.2290"></a><span id="l18.2290">   NS_ENSURE_TRUE(identity, NS_ERROR_NULL_POINTER);</span>
<a href="#l18.2291"></a><span id="l18.2291"> </span>
<a href="#l18.2292"></a><span id="l18.2292">   identity-&gt;GetBoolAttribute(&quot;use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l18.2293"></a><span id="l18.2293">   if (useCustomPrefs)</span>
<a href="#l18.2294"></a><span id="l18.2294">     rv = GetIntValue(&quot;incorporate_return_receipt&quot;, &amp;incorp);</span>
<a href="#l18.2295"></a><span id="l18.2295" class="difflineminus">-  else</span>
<a href="#l18.2296"></a><span id="l18.2296" class="difflineminus">-  {</span>
<a href="#l18.2297"></a><span id="l18.2297" class="difflineplus">+  else {</span>
<a href="#l18.2298"></a><span id="l18.2298">     nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l18.2299"></a><span id="l18.2299" class="difflineminus">-    if (prefs)</span>
<a href="#l18.2300"></a><span id="l18.2300" class="difflineminus">-      prefs-&gt;GetIntPref(&quot;mail.incorporate.return_receipt&quot;, &amp;incorp);</span>
<a href="#l18.2301"></a><span id="l18.2301" class="difflineplus">+    if (prefs) prefs-&gt;GetIntPref(&quot;mail.incorporate.return_receipt&quot;, &amp;incorp);</span>
<a href="#l18.2302"></a><span id="l18.2302">   }</span>
<a href="#l18.2303"></a><span id="l18.2303"> </span>
<a href="#l18.2304"></a><span id="l18.2304">   bool enable = (incorp == nsIMsgMdnGenerator::eIncorporateSent);</span>
<a href="#l18.2305"></a><span id="l18.2305"> </span>
<a href="#l18.2306"></a><span id="l18.2306">   // this is a temporary, internal mozilla filter</span>
<a href="#l18.2307"></a><span id="l18.2307">   // it will not show up in the UI, it will not be written to disk</span>
<a href="#l18.2308"></a><span id="l18.2308" class="difflineminus">-  NS_NAMED_LITERAL_STRING(internalReturnReceiptFilterName, &quot;mozilla-temporary-internal-MDN-receipt-filter&quot;);</span>
<a href="#l18.2309"></a><span id="l18.2309" class="difflineplus">+  NS_NAMED_LITERAL_STRING(internalReturnReceiptFilterName,</span>
<a href="#l18.2310"></a><span id="l18.2310" class="difflineplus">+                          &quot;mozilla-temporary-internal-MDN-receipt-filter&quot;);</span>
<a href="#l18.2311"></a><span id="l18.2311"> </span>
<a href="#l18.2312"></a><span id="l18.2312">   nsCOMPtr&lt;nsIMsgFilter&gt; newFilter;</span>
<a href="#l18.2313"></a><span id="l18.2313">   rv = filterList-&gt;GetFilterNamed(internalReturnReceiptFilterName,</span>
<a href="#l18.2314"></a><span id="l18.2314">                                   getter_AddRefs(newFilter));</span>
<a href="#l18.2315"></a><span id="l18.2315">   if (newFilter)</span>
<a href="#l18.2316"></a><span id="l18.2316">     newFilter-&gt;SetEnabled(enable);</span>
<a href="#l18.2317"></a><span id="l18.2317" class="difflineminus">-  else if (enable)</span>
<a href="#l18.2318"></a><span id="l18.2318" class="difflineminus">-  {</span>
<a href="#l18.2319"></a><span id="l18.2319" class="difflineplus">+  else if (enable) {</span>
<a href="#l18.2320"></a><span id="l18.2320">     nsCString actionTargetFolderUri;</span>
<a href="#l18.2321"></a><span id="l18.2321">     rv = identity-&gt;GetFccFolder(actionTargetFolderUri);</span>
<a href="#l18.2322"></a><span id="l18.2322" class="difflineminus">-    if (!actionTargetFolderUri.IsEmpty())</span>
<a href="#l18.2323"></a><span id="l18.2323" class="difflineminus">-    {</span>
<a href="#l18.2324"></a><span id="l18.2324" class="difflineplus">+    if (!actionTargetFolderUri.IsEmpty()) {</span>
<a href="#l18.2325"></a><span id="l18.2325">       filterList-&gt;CreateFilter(internalReturnReceiptFilterName,</span>
<a href="#l18.2326"></a><span id="l18.2326">                                getter_AddRefs(newFilter));</span>
<a href="#l18.2327"></a><span id="l18.2327" class="difflineminus">-      if (newFilter)</span>
<a href="#l18.2328"></a><span id="l18.2328" class="difflineminus">-      {</span>
<a href="#l18.2329"></a><span id="l18.2329" class="difflineplus">+      if (newFilter) {</span>
<a href="#l18.2330"></a><span id="l18.2330">         newFilter-&gt;SetEnabled(true);</span>
<a href="#l18.2331"></a><span id="l18.2331">         // this internal filter is temporary</span>
<a href="#l18.2332"></a><span id="l18.2332">         // and should not show up in the UI or be written to disk</span>
<a href="#l18.2333"></a><span id="l18.2333">         newFilter-&gt;SetTemporary(true);</span>
<a href="#l18.2334"></a><span id="l18.2334"> </span>
<a href="#l18.2335"></a><span id="l18.2335">         nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l18.2336"></a><span id="l18.2336">         nsCOMPtr&lt;nsIMsgSearchValue&gt; value;</span>
<a href="#l18.2337"></a><span id="l18.2337"> </span>
<a href="#l18.2338"></a><span id="l18.2338">         rv = newFilter-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l18.2339"></a><span id="l18.2339" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2340"></a><span id="l18.2340" class="difflineminus">-        {</span>
<a href="#l18.2341"></a><span id="l18.2341" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2342"></a><span id="l18.2342">           rv = term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l18.2343"></a><span id="l18.2343" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2344"></a><span id="l18.2344" class="difflineminus">-          {</span>
<a href="#l18.2345"></a><span id="l18.2345" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2346"></a><span id="l18.2346">             // we need to use OtherHeader + 1 so nsMsgFilter::GetTerm will</span>
<a href="#l18.2347"></a><span id="l18.2347">             // return our custom header.</span>
<a href="#l18.2348"></a><span id="l18.2348">             value-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l18.2349"></a><span id="l18.2349">             value-&gt;SetStr(NS_LITERAL_STRING(&quot;multipart/report&quot;));</span>
<a href="#l18.2350"></a><span id="l18.2350">             term-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l18.2351"></a><span id="l18.2351">             term-&gt;SetOp(nsMsgSearchOp::Contains);</span>
<a href="#l18.2352"></a><span id="l18.2352">             term-&gt;SetBooleanAnd(true);</span>
<a href="#l18.2353"></a><span id="l18.2353">             term-&gt;SetArbitraryHeader(NS_LITERAL_CSTRING(&quot;Content-Type&quot;));</span>
<a href="#l18.2354"></a><span id="l18.2354">             term-&gt;SetValue(value);</span>
<a href="#l18.2355"></a><span id="l18.2355">             newFilter-&gt;AppendTerm(term);</span>
<a href="#l18.2356"></a><span id="l18.2356">           }</span>
<a href="#l18.2357"></a><span id="l18.2357">         }</span>
<a href="#l18.2358"></a><span id="l18.2358">         rv = newFilter-&gt;CreateTerm(getter_AddRefs(term));</span>
<a href="#l18.2359"></a><span id="l18.2359" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2360"></a><span id="l18.2360" class="difflineminus">-        {</span>
<a href="#l18.2361"></a><span id="l18.2361" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2362"></a><span id="l18.2362">           rv = term-&gt;GetValue(getter_AddRefs(value));</span>
<a href="#l18.2363"></a><span id="l18.2363" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2364"></a><span id="l18.2364" class="difflineminus">-          {</span>
<a href="#l18.2365"></a><span id="l18.2365" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2366"></a><span id="l18.2366">             // XXX todo</span>
<a href="#l18.2367"></a><span id="l18.2367">             // determine if ::OtherHeader is the best way to do this.</span>
<a href="#l18.2368"></a><span id="l18.2368">             // see nsMsgSearchOfflineMail::MatchTerms()</span>
<a href="#l18.2369"></a><span id="l18.2369">             value-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l18.2370"></a><span id="l18.2370">             value-&gt;SetStr(NS_LITERAL_STRING(&quot;disposition-notification&quot;));</span>
<a href="#l18.2371"></a><span id="l18.2371">             term-&gt;SetAttrib(nsMsgSearchAttrib::OtherHeader + 1);</span>
<a href="#l18.2372"></a><span id="l18.2372">             term-&gt;SetOp(nsMsgSearchOp::Contains);</span>
<a href="#l18.2373"></a><span id="l18.2373">             term-&gt;SetBooleanAnd(true);</span>
<a href="#l18.2374"></a><span id="l18.2374">             term-&gt;SetArbitraryHeader(NS_LITERAL_CSTRING(&quot;Content-Type&quot;));</span>
<a href="#l18.2375"></a><span id="l18.2375">             term-&gt;SetValue(value);</span>
<a href="#l18.2376"></a><span id="l18.2376">             newFilter-&gt;AppendTerm(term);</span>
<a href="#l18.2377"></a><span id="l18.2377">           }</span>
<a href="#l18.2378"></a><span id="l18.2378">         }</span>
<a href="#l18.2379"></a><span id="l18.2379">         nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction;</span>
<a href="#l18.2380"></a><span id="l18.2380">         rv = newFilter-&gt;CreateAction(getter_AddRefs(filterAction));</span>
<a href="#l18.2381"></a><span id="l18.2381" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l18.2382"></a><span id="l18.2382" class="difflineminus">-        {</span>
<a href="#l18.2383"></a><span id="l18.2383" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.2384"></a><span id="l18.2384">           filterAction-&gt;SetType(nsMsgFilterAction::MoveToFolder);</span>
<a href="#l18.2385"></a><span id="l18.2385">           filterAction-&gt;SetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l18.2386"></a><span id="l18.2386">           newFilter-&gt;AppendAction(filterAction);</span>
<a href="#l18.2387"></a><span id="l18.2387">           filterList-&gt;InsertFilterAt(0, newFilter);</span>
<a href="#l18.2388"></a><span id="l18.2388">         }</span>
<a href="#l18.2389"></a><span id="l18.2389">       }</span>
<a href="#l18.2390"></a><span id="l18.2390">     }</span>
<a href="#l18.2391"></a><span id="l18.2391">   }</span>
<a href="#l18.2392"></a><span id="l18.2392">   return rv;</span>
<a href="#l18.2393"></a><span id="l18.2393"> }</span>
<a href="#l18.2394"></a><span id="l18.2394"> </span>
<a href="#l18.2395"></a><span id="l18.2395"> NS_IMETHODIMP</span>
<a href="#l18.2396"></a><span id="l18.2396" class="difflineminus">-nsMsgIncomingServer::ClearTemporaryReturnReceiptsFilter()</span>
<a href="#l18.2397"></a><span id="l18.2397" class="difflineminus">-{</span>
<a href="#l18.2398"></a><span id="l18.2398" class="difflineminus">-  if (mFilterList)</span>
<a href="#l18.2399"></a><span id="l18.2399" class="difflineminus">-  {</span>
<a href="#l18.2400"></a><span id="l18.2400" class="difflineplus">+nsMsgIncomingServer::ClearTemporaryReturnReceiptsFilter() {</span>
<a href="#l18.2401"></a><span id="l18.2401" class="difflineplus">+  if (mFilterList) {</span>
<a href="#l18.2402"></a><span id="l18.2402">     nsCOMPtr&lt;nsIMsgFilter&gt; mdnFilter;</span>
<a href="#l18.2403"></a><span id="l18.2403" class="difflineminus">-    nsresult rv = mFilterList-&gt;GetFilterNamed(NS_LITERAL_STRING(&quot;mozilla-temporary-internal-MDN-receipt-filter&quot;),</span>
<a href="#l18.2404"></a><span id="l18.2404" class="difflineminus">-                                              getter_AddRefs(mdnFilter));</span>
<a href="#l18.2405"></a><span id="l18.2405" class="difflineminus">-   if (NS_SUCCEEDED(rv) &amp;&amp; mdnFilter)</span>
<a href="#l18.2406"></a><span id="l18.2406" class="difflineminus">-     return mFilterList-&gt;RemoveFilter(mdnFilter);</span>
<a href="#l18.2407"></a><span id="l18.2407" class="difflineplus">+    nsresult rv = mFilterList-&gt;GetFilterNamed(</span>
<a href="#l18.2408"></a><span id="l18.2408" class="difflineplus">+        NS_LITERAL_STRING(&quot;mozilla-temporary-internal-MDN-receipt-filter&quot;),</span>
<a href="#l18.2409"></a><span id="l18.2409" class="difflineplus">+        getter_AddRefs(mdnFilter));</span>
<a href="#l18.2410"></a><span id="l18.2410" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mdnFilter)</span>
<a href="#l18.2411"></a><span id="l18.2411" class="difflineplus">+      return mFilterList-&gt;RemoveFilter(mdnFilter);</span>
<a href="#l18.2412"></a><span id="l18.2412">   }</span>
<a href="#l18.2413"></a><span id="l18.2413">   return NS_OK;</span>
<a href="#l18.2414"></a><span id="l18.2414"> }</span>
<a href="#l18.2415"></a><span id="l18.2415"> </span>
<a href="#l18.2416"></a><span id="l18.2416"> NS_IMETHODIMP</span>
<a href="#l18.2417"></a><span id="l18.2417" class="difflineminus">-nsMsgIncomingServer::GetMsgFolderFromURI(nsIMsgFolder *aFolderResource, const nsACString&amp; aURI, nsIMsgFolder **aFolder)</span>
<a href="#l18.2418"></a><span id="l18.2418" class="difflineminus">-{</span>
<a href="#l18.2419"></a><span id="l18.2419" class="difflineplus">+nsMsgIncomingServer::GetMsgFolderFromURI(nsIMsgFolder *aFolderResource,</span>
<a href="#l18.2420"></a><span id="l18.2420" class="difflineplus">+                                         const nsACString &amp;aURI,</span>
<a href="#l18.2421"></a><span id="l18.2421" class="difflineplus">+                                         nsIMsgFolder **aFolder) {</span>
<a href="#l18.2422"></a><span id="l18.2422">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l18.2423"></a><span id="l18.2423">   nsresult rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l18.2424"></a><span id="l18.2424">   NS_ENSURE_TRUE(rootMsgFolder, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.2425"></a><span id="l18.2425"> </span>
<a href="#l18.2426"></a><span id="l18.2426" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l18.2427"></a><span id="l18.2427" class="difflineminus">-  rv = rootMsgFolder-&gt;GetChildWithURI(aURI, true, true /*caseInsensitive*/, getter_AddRefs(msgFolder));</span>
<a href="#l18.2428"></a><span id="l18.2428" class="difflineminus">-  if (NS_FAILED(rv) || !msgFolder)</span>
<a href="#l18.2429"></a><span id="l18.2429" class="difflineminus">-    msgFolder = aFolderResource;</span>
<a href="#l18.2430"></a><span id="l18.2430" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l18.2431"></a><span id="l18.2431" class="difflineplus">+  rv = rootMsgFolder-&gt;GetChildWithURI(aURI, true, true /*caseInsensitive*/,</span>
<a href="#l18.2432"></a><span id="l18.2432" class="difflineplus">+                                      getter_AddRefs(msgFolder));</span>
<a href="#l18.2433"></a><span id="l18.2433" class="difflineplus">+  if (NS_FAILED(rv) || !msgFolder) msgFolder = aFolderResource;</span>
<a href="#l18.2434"></a><span id="l18.2434">   NS_IF_ADDREF(*aFolder = msgFolder);</span>
<a href="#l18.2435"></a><span id="l18.2435">   return NS_OK;</span>
<a href="#l18.2436"></a><span id="l18.2436"> }</span>
<a href="#l18.2437"></a><span id="l18.2437"> </span>
<a href="#l18.2438"></a><span id="l18.2438"> NS_IMETHODIMP</span>
<a href="#l18.2439"></a><span id="l18.2439" class="difflineminus">-nsMsgIncomingServer::GetSpamSettings(nsISpamSettings **aSpamSettings)</span>
<a href="#l18.2440"></a><span id="l18.2440" class="difflineminus">-{</span>
<a href="#l18.2441"></a><span id="l18.2441" class="difflineplus">+nsMsgIncomingServer::GetSpamSettings(nsISpamSettings **aSpamSettings) {</span>
<a href="#l18.2442"></a><span id="l18.2442">   NS_ENSURE_ARG_POINTER(aSpamSettings);</span>
<a href="#l18.2443"></a><span id="l18.2443"> </span>
<a href="#l18.2444"></a><span id="l18.2444">   nsAutoCString spamActionTargetAccount;</span>
<a href="#l18.2445"></a><span id="l18.2445">   GetCharValue(&quot;spamActionTargetAccount&quot;, spamActionTargetAccount);</span>
<a href="#l18.2446"></a><span id="l18.2446" class="difflineminus">-  if (spamActionTargetAccount.IsEmpty())</span>
<a href="#l18.2447"></a><span id="l18.2447" class="difflineminus">-  {</span>
<a href="#l18.2448"></a><span id="l18.2448" class="difflineplus">+  if (spamActionTargetAccount.IsEmpty()) {</span>
<a href="#l18.2449"></a><span id="l18.2449">     GetServerURI(spamActionTargetAccount);</span>
<a href="#l18.2450"></a><span id="l18.2450">     SetCharValue(&quot;spamActionTargetAccount&quot;, spamActionTargetAccount);</span>
<a href="#l18.2451"></a><span id="l18.2451">   }</span>
<a href="#l18.2452"></a><span id="l18.2452"> </span>
<a href="#l18.2453"></a><span id="l18.2453">   if (!mSpamSettings) {</span>
<a href="#l18.2454"></a><span id="l18.2454">     nsresult rv;</span>
<a href="#l18.2455"></a><span id="l18.2455">     mSpamSettings = do_CreateInstance(NS_SPAMSETTINGS_CONTRACTID, &amp;rv);</span>
<a href="#l18.2456"></a><span id="l18.2456" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.2457"></a><span id="l18.2457" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2458"></a><span id="l18.2458">     mSpamSettings-&gt;Initialize(this);</span>
<a href="#l18.2459"></a><span id="l18.2459" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.2460"></a><span id="l18.2460" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2461"></a><span id="l18.2461">   }</span>
<a href="#l18.2462"></a><span id="l18.2462"> </span>
<a href="#l18.2463"></a><span id="l18.2463">   NS_ADDREF(*aSpamSettings = mSpamSettings);</span>
<a href="#l18.2464"></a><span id="l18.2464">   return NS_OK;</span>
<a href="#l18.2465"></a><span id="l18.2465"> }</span>
<a href="#l18.2466"></a><span id="l18.2466"> </span>
<a href="#l18.2467"></a><span id="l18.2467"> NS_IMETHODIMP</span>
<a href="#l18.2468"></a><span id="l18.2468" class="difflineminus">-nsMsgIncomingServer::GetSpamFilterPlugin(nsIMsgFilterPlugin **aFilterPlugin)</span>
<a href="#l18.2469"></a><span id="l18.2469" class="difflineminus">-{</span>
<a href="#l18.2470"></a><span id="l18.2470" class="difflineplus">+nsMsgIncomingServer::GetSpamFilterPlugin(nsIMsgFilterPlugin **aFilterPlugin) {</span>
<a href="#l18.2471"></a><span id="l18.2471">   NS_ENSURE_ARG_POINTER(aFilterPlugin);</span>
<a href="#l18.2472"></a><span id="l18.2472" class="difflineminus">-  if (!mFilterPlugin)</span>
<a href="#l18.2473"></a><span id="l18.2473" class="difflineminus">-  {</span>
<a href="#l18.2474"></a><span id="l18.2474" class="difflineplus">+  if (!mFilterPlugin) {</span>
<a href="#l18.2475"></a><span id="l18.2475">     nsresult rv;</span>
<a href="#l18.2476"></a><span id="l18.2476" class="difflineminus">-    mFilterPlugin = do_GetService(&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;, &amp;rv);</span>
<a href="#l18.2477"></a><span id="l18.2477" class="difflineplus">+    mFilterPlugin = do_GetService(</span>
<a href="#l18.2478"></a><span id="l18.2478" class="difflineplus">+        &quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;, &amp;rv);</span>
<a href="#l18.2479"></a><span id="l18.2479">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2480"></a><span id="l18.2480">   }</span>
<a href="#l18.2481"></a><span id="l18.2481"> </span>
<a href="#l18.2482"></a><span id="l18.2482">   NS_IF_ADDREF(*aFilterPlugin = mFilterPlugin);</span>
<a href="#l18.2483"></a><span id="l18.2483">   return NS_OK;</span>
<a href="#l18.2484"></a><span id="l18.2484"> }</span>
<a href="#l18.2485"></a><span id="l18.2485"> </span>
<a href="#l18.2486"></a><span id="l18.2486" class="difflineminus">-// get all the servers that defer to the account for the passed in server. Note that</span>
<a href="#l18.2487"></a><span id="l18.2487" class="difflineminus">-// destServer may not be &quot;this&quot;</span>
<a href="#l18.2488"></a><span id="l18.2488" class="difflineminus">-nsresult nsMsgIncomingServer::GetDeferredServers(nsIMsgIncomingServer *destServer, nsCOMArray&lt;nsIPop3IncomingServer&gt;&amp; aServers)</span>
<a href="#l18.2489"></a><span id="l18.2489" class="difflineminus">-{</span>
<a href="#l18.2490"></a><span id="l18.2490" class="difflineplus">+// get all the servers that defer to the account for the passed in server. Note</span>
<a href="#l18.2491"></a><span id="l18.2491" class="difflineplus">+// that destServer may not be &quot;this&quot;</span>
<a href="#l18.2492"></a><span id="l18.2492" class="difflineplus">+nsresult nsMsgIncomingServer::GetDeferredServers(</span>
<a href="#l18.2493"></a><span id="l18.2493" class="difflineplus">+    nsIMsgIncomingServer *destServer,</span>
<a href="#l18.2494"></a><span id="l18.2494" class="difflineplus">+    nsCOMArray&lt;nsIPop3IncomingServer&gt; &amp;aServers) {</span>
<a href="#l18.2495"></a><span id="l18.2495">   nsresult rv;</span>
<a href="#l18.2496"></a><span id="l18.2496" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager</span>
<a href="#l18.2497"></a><span id="l18.2497" class="difflineminus">-    = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.2498"></a><span id="l18.2498" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.2499"></a><span id="l18.2499" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.2500"></a><span id="l18.2500">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.2501"></a><span id="l18.2501"> </span>
<a href="#l18.2502"></a><span id="l18.2502" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccount&gt; thisAccount;</span>
<a href="#l18.2503"></a><span id="l18.2503" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; thisAccount;</span>
<a href="#l18.2504"></a><span id="l18.2504">   accountManager-&gt;FindAccountForServer(destServer, getter_AddRefs(thisAccount));</span>
<a href="#l18.2505"></a><span id="l18.2505" class="difflineminus">-  if (thisAccount)</span>
<a href="#l18.2506"></a><span id="l18.2506" class="difflineminus">-  {</span>
<a href="#l18.2507"></a><span id="l18.2507" class="difflineplus">+  if (thisAccount) {</span>
<a href="#l18.2508"></a><span id="l18.2508">     nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l18.2509"></a><span id="l18.2509">     nsCString accountKey;</span>
<a href="#l18.2510"></a><span id="l18.2510">     thisAccount-&gt;GetKey(accountKey);</span>
<a href="#l18.2511"></a><span id="l18.2511">     accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l18.2512"></a><span id="l18.2512" class="difflineminus">-    if (allServers)</span>
<a href="#l18.2513"></a><span id="l18.2513" class="difflineminus">-    {</span>
<a href="#l18.2514"></a><span id="l18.2514" class="difflineplus">+    if (allServers) {</span>
<a href="#l18.2515"></a><span id="l18.2515">       uint32_t serverCount;</span>
<a href="#l18.2516"></a><span id="l18.2516">       allServers-&gt;GetLength(&amp;serverCount);</span>
<a href="#l18.2517"></a><span id="l18.2517" class="difflineminus">-      for (uint32_t i = 0; i &lt; serverCount; i++)</span>
<a href="#l18.2518"></a><span id="l18.2518" class="difflineminus">-      {</span>
<a href="#l18.2519"></a><span id="l18.2519" class="difflineminus">-        nsCOMPtr&lt;nsIPop3IncomingServer&gt; server(do_QueryElementAt(allServers, i));</span>
<a href="#l18.2520"></a><span id="l18.2520" class="difflineminus">-        if (server)</span>
<a href="#l18.2521"></a><span id="l18.2521" class="difflineminus">-        {</span>
<a href="#l18.2522"></a><span id="l18.2522" class="difflineplus">+      for (uint32_t i = 0; i &lt; serverCount; i++) {</span>
<a href="#l18.2523"></a><span id="l18.2523" class="difflineplus">+        nsCOMPtr&lt;nsIPop3IncomingServer&gt; server(</span>
<a href="#l18.2524"></a><span id="l18.2524" class="difflineplus">+            do_QueryElementAt(allServers, i));</span>
<a href="#l18.2525"></a><span id="l18.2525" class="difflineplus">+        if (server) {</span>
<a href="#l18.2526"></a><span id="l18.2526">           nsCString deferredToAccount;</span>
<a href="#l18.2527"></a><span id="l18.2527">           server-&gt;GetDeferredToAccount(deferredToAccount);</span>
<a href="#l18.2528"></a><span id="l18.2528">           if (deferredToAccount.Equals(accountKey))</span>
<a href="#l18.2529"></a><span id="l18.2529">             aServers.AppendElement(server);</span>
<a href="#l18.2530"></a><span id="l18.2530">         }</span>
<a href="#l18.2531"></a><span id="l18.2531">       }</span>
<a href="#l18.2532"></a><span id="l18.2532">     }</span>
<a href="#l18.2533"></a><span id="l18.2533">   }</span>
<a href="#l18.2534"></a><span id="l18.2534">   return rv;</span>
<a href="#l18.2535"></a><span id="l18.2535"> }</span>
<a href="#l18.2536"></a><span id="l18.2536"> </span>
<a href="#l18.2537"></a><span id="l18.2537" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetIsDeferredTo(bool *aIsDeferredTo)</span>
<a href="#l18.2538"></a><span id="l18.2538" class="difflineminus">-{</span>
<a href="#l18.2539"></a><span id="l18.2539" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetIsDeferredTo(bool *aIsDeferredTo) {</span>
<a href="#l18.2540"></a><span id="l18.2540">   NS_ENSURE_ARG_POINTER(aIsDeferredTo);</span>
<a href="#l18.2541"></a><span id="l18.2541" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager</span>
<a href="#l18.2542"></a><span id="l18.2542" class="difflineminus">-    = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l18.2543"></a><span id="l18.2543" class="difflineminus">-  if (accountManager)</span>
<a href="#l18.2544"></a><span id="l18.2544" class="difflineminus">-  {</span>
<a href="#l18.2545"></a><span id="l18.2545" class="difflineminus">-    nsCOMPtr &lt;nsIMsgAccount&gt; thisAccount;</span>
<a href="#l18.2546"></a><span id="l18.2546" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.2547"></a><span id="l18.2547" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l18.2548"></a><span id="l18.2548" class="difflineplus">+  if (accountManager) {</span>
<a href="#l18.2549"></a><span id="l18.2549" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; thisAccount;</span>
<a href="#l18.2550"></a><span id="l18.2550">     accountManager-&gt;FindAccountForServer(this, getter_AddRefs(thisAccount));</span>
<a href="#l18.2551"></a><span id="l18.2551" class="difflineminus">-    if (thisAccount)</span>
<a href="#l18.2552"></a><span id="l18.2552" class="difflineminus">-    {</span>
<a href="#l18.2553"></a><span id="l18.2553" class="difflineplus">+    if (thisAccount) {</span>
<a href="#l18.2554"></a><span id="l18.2554">       nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l18.2555"></a><span id="l18.2555">       nsCString accountKey;</span>
<a href="#l18.2556"></a><span id="l18.2556">       thisAccount-&gt;GetKey(accountKey);</span>
<a href="#l18.2557"></a><span id="l18.2557">       accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l18.2558"></a><span id="l18.2558" class="difflineminus">-      if (allServers)</span>
<a href="#l18.2559"></a><span id="l18.2559" class="difflineminus">-      {</span>
<a href="#l18.2560"></a><span id="l18.2560" class="difflineplus">+      if (allServers) {</span>
<a href="#l18.2561"></a><span id="l18.2561">         uint32_t serverCount;</span>
<a href="#l18.2562"></a><span id="l18.2562">         allServers-&gt;GetLength(&amp;serverCount);</span>
<a href="#l18.2563"></a><span id="l18.2563" class="difflineminus">-        for (uint32_t i = 0; i &lt; serverCount; i++)</span>
<a href="#l18.2564"></a><span id="l18.2564" class="difflineminus">-        {</span>
<a href="#l18.2565"></a><span id="l18.2565" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIncomingServer&gt; server (do_QueryElementAt(allServers, i));</span>
<a href="#l18.2566"></a><span id="l18.2566" class="difflineminus">-          if (server)</span>
<a href="#l18.2567"></a><span id="l18.2567" class="difflineminus">-          {</span>
<a href="#l18.2568"></a><span id="l18.2568" class="difflineplus">+        for (uint32_t i = 0; i &lt; serverCount; i++) {</span>
<a href="#l18.2569"></a><span id="l18.2569" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(</span>
<a href="#l18.2570"></a><span id="l18.2570" class="difflineplus">+              do_QueryElementAt(allServers, i));</span>
<a href="#l18.2571"></a><span id="l18.2571" class="difflineplus">+          if (server) {</span>
<a href="#l18.2572"></a><span id="l18.2572">             nsCString deferredToAccount;</span>
<a href="#l18.2573"></a><span id="l18.2573">             server-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccount);</span>
<a href="#l18.2574"></a><span id="l18.2574" class="difflineminus">-            if (deferredToAccount.Equals(accountKey))</span>
<a href="#l18.2575"></a><span id="l18.2575" class="difflineminus">-            {</span>
<a href="#l18.2576"></a><span id="l18.2576" class="difflineplus">+            if (deferredToAccount.Equals(accountKey)) {</span>
<a href="#l18.2577"></a><span id="l18.2577">               *aIsDeferredTo = true;</span>
<a href="#l18.2578"></a><span id="l18.2578">               return NS_OK;</span>
<a href="#l18.2579"></a><span id="l18.2579">             }</span>
<a href="#l18.2580"></a><span id="l18.2580">           }</span>
<a href="#l18.2581"></a><span id="l18.2581">         }</span>
<a href="#l18.2582"></a><span id="l18.2582">       }</span>
<a href="#l18.2583"></a><span id="l18.2583">     }</span>
<a href="#l18.2584"></a><span id="l18.2584">   }</span>
<a href="#l18.2585"></a><span id="l18.2585">   *aIsDeferredTo = false;</span>
<a href="#l18.2586"></a><span id="l18.2586">   return NS_OK;</span>
<a href="#l18.2587"></a><span id="l18.2587"> }</span>
<a href="#l18.2588"></a><span id="l18.2588"> </span>
<a href="#l18.2589"></a><span id="l18.2589"> const long kMaxDownloadTableSize = 500;</span>
<a href="#l18.2590"></a><span id="l18.2590"> </span>
<a href="#l18.2591"></a><span id="l18.2591"> // hash the concatenation of the message-id and subject as the hash table key,</span>
<a href="#l18.2592"></a><span id="l18.2592" class="difflineminus">-// and store the arrival index as the value. To limit the size of the hash table,</span>
<a href="#l18.2593"></a><span id="l18.2593" class="difflineminus">-// we just throw out ones with a lower ordinal value than the cut-off point.</span>
<a href="#l18.2594"></a><span id="l18.2594" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::IsNewHdrDuplicate(nsIMsgDBHdr *aNewHdr, bool *aResult)</span>
<a href="#l18.2595"></a><span id="l18.2595" class="difflineminus">-{</span>
<a href="#l18.2596"></a><span id="l18.2596" class="difflineplus">+// and store the arrival index as the value. To limit the size of the hash</span>
<a href="#l18.2597"></a><span id="l18.2597" class="difflineplus">+// table, we just throw out ones with a lower ordinal value than the cut-off</span>
<a href="#l18.2598"></a><span id="l18.2598" class="difflineplus">+// point.</span>
<a href="#l18.2599"></a><span id="l18.2599" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::IsNewHdrDuplicate(nsIMsgDBHdr *aNewHdr,</span>
<a href="#l18.2600"></a><span id="l18.2600" class="difflineplus">+                                                     bool *aResult) {</span>
<a href="#l18.2601"></a><span id="l18.2601">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.2602"></a><span id="l18.2602">   NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l18.2603"></a><span id="l18.2603">   *aResult = false;</span>
<a href="#l18.2604"></a><span id="l18.2604"> </span>
<a href="#l18.2605"></a><span id="l18.2605">   // If the message has been partially downloaded, the message should not</span>
<a href="#l18.2606"></a><span id="l18.2606">   // be considered a duplicated message. See bug 714090.</span>
<a href="#l18.2607"></a><span id="l18.2607">   uint32_t flags;</span>
<a href="#l18.2608"></a><span id="l18.2608">   aNewHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l18.2609"></a><span id="l18.2609" class="difflineminus">-  if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l18.2610"></a><span id="l18.2610" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2611"></a><span id="l18.2611" class="difflineplus">+  if (flags &amp; nsMsgMessageFlags::Partial) return NS_OK;</span>
<a href="#l18.2612"></a><span id="l18.2612"> </span>
<a href="#l18.2613"></a><span id="l18.2613">   nsAutoCString strHashKey;</span>
<a href="#l18.2614"></a><span id="l18.2614">   nsCString messageId, subject;</span>
<a href="#l18.2615"></a><span id="l18.2615">   aNewHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l18.2616"></a><span id="l18.2616">   strHashKey.Append(messageId);</span>
<a href="#l18.2617"></a><span id="l18.2617">   aNewHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l18.2618"></a><span id="l18.2618">   // err on the side of caution and ignore messages w/o subject or messageid.</span>
<a href="#l18.2619"></a><span id="l18.2619" class="difflineminus">-  if (subject.IsEmpty() || messageId.IsEmpty())</span>
<a href="#l18.2620"></a><span id="l18.2620" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.2621"></a><span id="l18.2621" class="difflineplus">+  if (subject.IsEmpty() || messageId.IsEmpty()) return NS_OK;</span>
<a href="#l18.2622"></a><span id="l18.2622">   strHashKey.Append(subject);</span>
<a href="#l18.2623"></a><span id="l18.2623">   int32_t hashValue = 0;</span>
<a href="#l18.2624"></a><span id="l18.2624">   m_downloadedHdrs.Get(strHashKey, &amp;hashValue);</span>
<a href="#l18.2625"></a><span id="l18.2625">   if (hashValue)</span>
<a href="#l18.2626"></a><span id="l18.2626">     *aResult = true;</span>
<a href="#l18.2627"></a><span id="l18.2627" class="difflineminus">-  else</span>
<a href="#l18.2628"></a><span id="l18.2628" class="difflineminus">-  {</span>
<a href="#l18.2629"></a><span id="l18.2629" class="difflineplus">+  else {</span>
<a href="#l18.2630"></a><span id="l18.2630">     // we store the current size of the hash table as the hash</span>
<a href="#l18.2631"></a><span id="l18.2631">     // value - this allows us to delete older entries.</span>
<a href="#l18.2632"></a><span id="l18.2632">     m_downloadedHdrs.Put(strHashKey, ++m_numMsgsDownloaded);</span>
<a href="#l18.2633"></a><span id="l18.2633">     // Check if hash table is larger than some reasonable size</span>
<a href="#l18.2634"></a><span id="l18.2634">     // and if is it, iterate over hash table deleting messages</span>
<a href="#l18.2635"></a><span id="l18.2635" class="difflineminus">-    // with an arrival index &lt; number of msgs downloaded - half the reasonable size.</span>
<a href="#l18.2636"></a><span id="l18.2636" class="difflineplus">+    // with an arrival index &lt; number of msgs downloaded - half the reasonable</span>
<a href="#l18.2637"></a><span id="l18.2637" class="difflineplus">+    // size.</span>
<a href="#l18.2638"></a><span id="l18.2638">     if (m_downloadedHdrs.Count() &gt;= kMaxDownloadTableSize) {</span>
<a href="#l18.2639"></a><span id="l18.2639">       for (auto iter = m_downloadedHdrs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l18.2640"></a><span id="l18.2640" class="difflineminus">-        if (iter.Data() &lt; m_numMsgsDownloaded - kMaxDownloadTableSize/2) {</span>
<a href="#l18.2641"></a><span id="l18.2641" class="difflineplus">+        if (iter.Data() &lt; m_numMsgsDownloaded - kMaxDownloadTableSize / 2) {</span>
<a href="#l18.2642"></a><span id="l18.2642">           iter.Remove();</span>
<a href="#l18.2643"></a><span id="l18.2643" class="difflineminus">-        } else if (m_downloadedHdrs.Count() &lt;= kMaxDownloadTableSize/2) {</span>
<a href="#l18.2644"></a><span id="l18.2644" class="difflineplus">+        } else if (m_downloadedHdrs.Count() &lt;= kMaxDownloadTableSize / 2) {</span>
<a href="#l18.2645"></a><span id="l18.2645">           break;</span>
<a href="#l18.2646"></a><span id="l18.2646">         }</span>
<a href="#l18.2647"></a><span id="l18.2647">       }</span>
<a href="#l18.2648"></a><span id="l18.2648">     }</span>
<a href="#l18.2649"></a><span id="l18.2649">   }</span>
<a href="#l18.2650"></a><span id="l18.2650">   return NS_OK;</span>
<a href="#l18.2651"></a><span id="l18.2651"> }</span>
<a href="#l18.2652"></a><span id="l18.2652"> </span>
<a href="#l18.2653"></a><span id="l18.2653"> NS_IMETHODIMP</span>
<a href="#l18.2654"></a><span id="l18.2654" class="difflineminus">-nsMsgIncomingServer::GetForcePropertyEmpty(const char *aPropertyName, bool *_retval)</span>
<a href="#l18.2655"></a><span id="l18.2655" class="difflineminus">-{</span>
<a href="#l18.2656"></a><span id="l18.2656" class="difflineplus">+nsMsgIncomingServer::GetForcePropertyEmpty(const char *aPropertyName,</span>
<a href="#l18.2657"></a><span id="l18.2657" class="difflineplus">+                                           bool *_retval) {</span>
<a href="#l18.2658"></a><span id="l18.2658">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l18.2659"></a><span id="l18.2659">   nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l18.2660"></a><span id="l18.2660">   nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l18.2661"></a><span id="l18.2661">   nsCString value;</span>
<a href="#l18.2662"></a><span id="l18.2662">   GetCharValue(nameEmpty.get(), value);</span>
<a href="#l18.2663"></a><span id="l18.2663">   *_retval = value.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l18.2664"></a><span id="l18.2664">   return NS_OK;</span>
<a href="#l18.2665"></a><span id="l18.2665"> }</span>
<a href="#l18.2666"></a><span id="l18.2666"> </span>
<a href="#l18.2667"></a><span id="l18.2667"> NS_IMETHODIMP</span>
<a href="#l18.2668"></a><span id="l18.2668" class="difflineminus">-nsMsgIncomingServer::SetForcePropertyEmpty(const char *aPropertyName, bool aValue)</span>
<a href="#l18.2669"></a><span id="l18.2669" class="difflineminus">-{</span>
<a href="#l18.2670"></a><span id="l18.2670" class="difflineminus">- nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l18.2671"></a><span id="l18.2671" class="difflineminus">- nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l18.2672"></a><span id="l18.2672" class="difflineminus">- return SetCharValue(nameEmpty.get(),</span>
<a href="#l18.2673"></a><span id="l18.2673" class="difflineminus">-   aValue ? NS_LITERAL_CSTRING(&quot;true&quot;) : NS_LITERAL_CSTRING(&quot;&quot;));</span>
<a href="#l18.2674"></a><span id="l18.2674" class="difflineplus">+nsMsgIncomingServer::SetForcePropertyEmpty(const char *aPropertyName,</span>
<a href="#l18.2675"></a><span id="l18.2675" class="difflineplus">+                                           bool aValue) {</span>
<a href="#l18.2676"></a><span id="l18.2676" class="difflineplus">+  nsAutoCString nameEmpty(aPropertyName);</span>
<a href="#l18.2677"></a><span id="l18.2677" class="difflineplus">+  nameEmpty.AppendLiteral(&quot;.empty&quot;);</span>
<a href="#l18.2678"></a><span id="l18.2678" class="difflineplus">+  return SetCharValue(nameEmpty.get(), aValue ? NS_LITERAL_CSTRING(&quot;true&quot;)</span>
<a href="#l18.2679"></a><span id="l18.2679" class="difflineplus">+                                              : NS_LITERAL_CSTRING(&quot;&quot;));</span>
<a href="#l18.2680"></a><span id="l18.2680"> }</span>
<a href="#l18.2681"></a><span id="l18.2681"> </span>
<a href="#l18.2682"></a><span id="l18.2682"> NS_IMETHODIMP</span>
<a href="#l18.2683"></a><span id="l18.2683" class="difflineminus">-nsMsgIncomingServer::GetSortOrder(int32_t* aSortOrder)</span>
<a href="#l18.2684"></a><span id="l18.2684" class="difflineminus">-{</span>
<a href="#l18.2685"></a><span id="l18.2685" class="difflineplus">+nsMsgIncomingServer::GetSortOrder(int32_t *aSortOrder) {</span>
<a href="#l18.2686"></a><span id="l18.2686">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l18.2687"></a><span id="l18.2687">   *aSortOrder = 100000000;</span>
<a href="#l18.2688"></a><span id="l18.2688">   return NS_OK;</span>
<a href="#l18.2689"></a><span id="l18.2689"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -30,72 +30,74 @@ class nsIMsgProtocolInfo;</span>
<a href="#l19.4"></a><span id="l19.4">  * base class for nsIMsgIncomingServer - derive your class from here</span>
<a href="#l19.5"></a><span id="l19.5">  * if you want to get some free implementation</span>
<a href="#l19.6"></a><span id="l19.6">  *</span>
<a href="#l19.7"></a><span id="l19.7">  * this particular implementation is not meant to be used directly.</span>
<a href="#l19.8"></a><span id="l19.8">  */</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> class NS_MSG_BASE nsMsgIncomingServer : public nsIMsgIncomingServer,</span>
<a href="#l19.11"></a><span id="l19.11">                                         public nsSupportsWeakReference,</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                                        public nsIObserver</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+                                        public nsIObserver {</span>
<a href="#l19.15"></a><span id="l19.15">  public:</span>
<a href="#l19.16"></a><span id="l19.16">   nsMsgIncomingServer();</span>
<a href="#l19.17"></a><span id="l19.17">   nsresult Init();</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l19.20"></a><span id="l19.20">   NS_DECL_NSIMSGINCOMINGSERVER</span>
<a href="#l19.21"></a><span id="l19.21">   NS_DECL_NSIOBSERVER</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-protected:</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+ protected:</span>
<a href="#l19.25"></a><span id="l19.25">   virtual ~nsMsgIncomingServer();</span>
<a href="#l19.26"></a><span id="l19.26">   nsCString m_serverKey;</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28">   // Sets m_password, if password found. Can return NS_ERROR_ABORT if the</span>
<a href="#l19.29"></a><span id="l19.29">   // user cancels the master password dialog.</span>
<a href="#l19.30"></a><span id="l19.30">   nsresult GetPasswordWithoutUI();</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">   nsresult ConfigureTemporaryReturnReceiptsFilter(nsIMsgFilterList *filterList);</span>
<a href="#l19.33"></a><span id="l19.33">   nsresult ConfigureTemporaryServerSpamFilters(nsIMsgFilterList *filterList);</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_rootFolder;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_rootFolder;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40">   // For local servers, where we put messages. For imap/pop3, where we store</span>
<a href="#l19.41"></a><span id="l19.41">   // offline messages.</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-  nsCOMPtr &lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">   /// Helper routine to create local folder on disk if it doesn't exist</span>
<a href="#l19.46"></a><span id="l19.46">   /// under the account's rootFolder.</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-  nsresult CreateLocalFolder(const nsAString&amp; folderName);</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+  nsresult CreateLocalFolder(const nsAString &amp;folderName);</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-  static nsresult GetDeferredServers(nsIMsgIncomingServer *destServer, nsCOMArray&lt;nsIPop3IncomingServer&gt;&amp; aServers);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+  static nsresult GetDeferredServers(</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+      nsIMsgIncomingServer *destServer,</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+      nsCOMArray&lt;nsIPop3IncomingServer&gt; &amp;aServers);</span>
<a href="#l19.54"></a><span id="l19.54"> </span>
<a href="#l19.55"></a><span id="l19.55">   nsresult CreateRootFolder();</span>
<a href="#l19.56"></a><span id="l19.56">   virtual nsresult CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l19.57"></a><span id="l19.57">                                            nsIMsgFolder **rootFolder) = 0;</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-  nsresult InternalSetHostName(const nsACString&amp; aHostname, const char * prefName);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  nsresult InternalSetHostName(const nsACString &amp;aHostname,</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+                               const char *prefName);</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; mFilterFile;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; mFilterList;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; mEditableFilterList;</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mFilterFile;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; mFilterList;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; mEditableFilterList;</span>
<a href="#l19.69"></a><span id="l19.69">   nsCOMPtr&lt;nsIPrefBranch&gt; mPrefBranch;</span>
<a href="#l19.70"></a><span id="l19.70">   nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72">   // these allow us to handle duplicate incoming messages, e.g. delete them.</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-  nsDataHashtable&lt;nsCStringHashKey,int32_t&gt; m_downloadedHdrs;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-  int32_t  m_numMsgsDownloaded;</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+  nsDataHashtable&lt;nsCStringHashKey, int32_t&gt; m_downloadedHdrs;</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  int32_t m_numMsgsDownloaded;</span>
<a href="#l19.77"></a><span id="l19.77"> </span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-private:</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+ private:</span>
<a href="#l19.80"></a><span id="l19.80">   uint32_t m_biffState;</span>
<a href="#l19.81"></a><span id="l19.81">   bool m_serverBusy;</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  nsCOMPtr &lt;nsISpamSettings&gt; mSpamSettings;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  nsCOMPtr&lt;nsISpamSettings&gt; mSpamSettings;</span>
<a href="#l19.84"></a><span id="l19.84">   nsCOMPtr&lt;nsIMsgFilterPlugin&gt; mFilterPlugin;  // XXX should be a list</span>
<a href="#l19.85"></a><span id="l19.85"> </span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-protected:</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+ protected:</span>
<a href="#l19.88"></a><span id="l19.88">   nsString m_password;</span>
<a href="#l19.89"></a><span id="l19.89">   bool m_canHaveFilters;</span>
<a href="#l19.90"></a><span id="l19.90">   bool m_displayStartupPage;</span>
<a href="#l19.91"></a><span id="l19.91">   bool mPerformingBiff;</span>
<a href="#l19.92"></a><span id="l19.92"> };</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-#endif // nsMsgIncomingServer_h__</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+#endif  // nsMsgIncomingServer_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/util/nsMsgKeyArray.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgKeyArray.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -3,75 +3,64 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.5"></a><span id="l20.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsMemory.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> NS_IMPL_ISUPPORTS(nsMsgKeyArray, nsIMsgKeyArray)</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-nsMsgKeyArray::nsMsgKeyArray()</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-{</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+nsMsgKeyArray::nsMsgKeyArray() {</span>
<a href="#l20.15"></a><span id="l20.15"> #ifdef DEBUG</span>
<a href="#l20.16"></a><span id="l20.16">   m_sorted = false;</span>
<a href="#l20.17"></a><span id="l20.17"> #endif</span>
<a href="#l20.18"></a><span id="l20.18"> }</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-nsMsgKeyArray::~nsMsgKeyArray()</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-{</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-}</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+nsMsgKeyArray::~nsMsgKeyArray() {}</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::Sort()</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-{</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::Sort() {</span>
<a href="#l20.28"></a><span id="l20.28"> #ifdef DEBUG</span>
<a href="#l20.29"></a><span id="l20.29">   m_sorted = true;</span>
<a href="#l20.30"></a><span id="l20.30"> #endif</span>
<a href="#l20.31"></a><span id="l20.31">   m_keys.Sort();</span>
<a href="#l20.32"></a><span id="l20.32">   return NS_OK;</span>
<a href="#l20.33"></a><span id="l20.33"> }</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::GetKeyAt(int32_t aIndex, nsMsgKey *aKey)</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-{</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::GetKeyAt(int32_t aIndex, nsMsgKey *aKey) {</span>
<a href="#l20.38"></a><span id="l20.38">   NS_ENSURE_ARG_POINTER(aKey);</span>
<a href="#l20.39"></a><span id="l20.39">   *aKey = m_keys[aIndex];</span>
<a href="#l20.40"></a><span id="l20.40">   return NS_OK;</span>
<a href="#l20.41"></a><span id="l20.41"> }</span>
<a href="#l20.42"></a><span id="l20.42"> </span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::GetLength(uint32_t *aLength)</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-{</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::GetLength(uint32_t *aLength) {</span>
<a href="#l20.46"></a><span id="l20.46">   NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l20.47"></a><span id="l20.47">   *aLength = m_keys.Length();</span>
<a href="#l20.48"></a><span id="l20.48">   return NS_OK;</span>
<a href="#l20.49"></a><span id="l20.49"> }</span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::SetCapacity(uint32_t aCapacity)</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-{</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::SetCapacity(uint32_t aCapacity) {</span>
<a href="#l20.54"></a><span id="l20.54">   m_keys.SetCapacity(aCapacity);</span>
<a href="#l20.55"></a><span id="l20.55">   return NS_OK;</span>
<a href="#l20.56"></a><span id="l20.56"> }</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::AppendElement(nsMsgKey aKey)</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-{</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::AppendElement(nsMsgKey aKey) {</span>
<a href="#l20.61"></a><span id="l20.61"> #ifdef DEBUG</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  NS_ASSERTION(!m_sorted || m_keys.Length() == 0 ||</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-               aKey &gt; m_keys[m_keys.Length() - 1],</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-               &quot;Inserting a new key at wrong position in a sorted key list!&quot;);</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+      !m_sorted || m_keys.Length() == 0 || aKey &gt; m_keys[m_keys.Length() - 1],</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+      &quot;Inserting a new key at wrong position in a sorted key list!&quot;);</span>
<a href="#l20.68"></a><span id="l20.68"> #endif</span>
<a href="#l20.69"></a><span id="l20.69">   m_keys.AppendElement(aKey);</span>
<a href="#l20.70"></a><span id="l20.70">   return NS_OK;</span>
<a href="#l20.71"></a><span id="l20.71"> }</span>
<a href="#l20.72"></a><span id="l20.72"> </span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::InsertElementSorted(nsMsgKey aKey)</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-{</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::InsertElementSorted(nsMsgKey aKey) {</span>
<a href="#l20.76"></a><span id="l20.76">   // This function should be removed after interfaces are not frozen for TB38.</span>
<a href="#l20.77"></a><span id="l20.77">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.78"></a><span id="l20.78"> }</span>
<a href="#l20.79"></a><span id="l20.79"> </span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-NS_IMETHODIMP nsMsgKeyArray::GetArray(uint32_t *aCount, nsMsgKey **aKeys)</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-{</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+NS_IMETHODIMP nsMsgKeyArray::GetArray(uint32_t *aCount, nsMsgKey **aKeys) {</span>
<a href="#l20.83"></a><span id="l20.83">   NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l20.84"></a><span id="l20.84">   NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l20.85"></a><span id="l20.85">   *aCount = m_keys.Length();</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-  *aKeys =</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-    (nsMsgKey *) moz_xmemdup(m_keys.Elements(),</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-                             m_keys.Length() * sizeof(nsMsgKey));</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  *aKeys = (nsMsgKey *)moz_xmemdup(m_keys.Elements(),</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+                                   m_keys.Length() * sizeof(nsMsgKey));</span>
<a href="#l20.91"></a><span id="l20.91">   return (*aKeys) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.92"></a><span id="l20.92"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/util/nsMsgKeyArray.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgKeyArray.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -7,27 +7,26 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #define nsMsgKeyArray_h__</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIMsgKeyArray.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsTArray.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> /*</span>
<a href="#l21.10"></a><span id="l21.10">  * This class is a thin wrapper around an nsTArray&lt;nsMsgKey&gt;</span>
<a href="#l21.11"></a><span id="l21.11">  */</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-class nsMsgKeyArray : public nsIMsgKeyArray</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-public:</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+class nsMsgKeyArray : public nsIMsgKeyArray {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+ public:</span>
<a href="#l21.17"></a><span id="l21.17">   nsMsgKeyArray();</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19">   NS_DECL_ISUPPORTS</span>
<a href="#l21.20"></a><span id="l21.20">   NS_DECL_NSIMSGKEYARRAY</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">   nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-private:</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+ private:</span>
<a href="#l21.26"></a><span id="l21.26">   virtual ~nsMsgKeyArray();</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28"> #ifdef DEBUG</span>
<a href="#l21.29"></a><span id="l21.29">   bool m_sorted;</span>
<a href="#l21.30"></a><span id="l21.30"> #endif</span>
<a href="#l21.31"></a><span id="l21.31"> };</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/util/nsMsgKeySet.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgKeySet.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,26 +1,26 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l22.5"></a><span id="l22.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;prlog.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12"> </span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;prprf.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> #include &quot;prmem.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #include &quot;nsTArray.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18"> #include &quot;nsMemory.h&quot;</span>
<a href="#l22.19"></a><span id="l22.19"> #include &lt;ctype.h&gt;</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21"> #if defined(DEBUG_seth_) || defined(DEBUG_sspitzer_)</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-#define DEBUG_MSGKEYSET 1</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+#  define DEBUG_MSGKEYSET 1</span>
<a href="#l22.24"></a><span id="l22.24"> #endif</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26"> /* A compressed encoding for sets of article.  This is usually for lines from</span>
<a href="#l22.27"></a><span id="l22.27">    the newsrc, which have article lists like</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">    1-29627,29635,29658,32861-32863</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31">    so the data has these properties:</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineat">@@ -59,75 +59,67 @@</span>
<a href="#l22.33"></a><span id="l22.33">    two elements is represented as two literals, since they take up the same</span>
<a href="#l22.34"></a><span id="l22.34">    space.</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36">    Another optimization we make is to notice that we typically ask the</span>
<a href="#l22.37"></a><span id="l22.37">    question ``is N a member of the set'' for increasing values of N. So the</span>
<a href="#l22.38"></a><span id="l22.38">    set holds a cache of the last value asked for, and can simply resume the</span>
<a href="#l22.39"></a><span id="l22.39">    search from there.  */</span>
<a href="#l22.40"></a><span id="l22.40"> </span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-nsMsgKeySet::nsMsgKeySet(/* MSG_NewsHost* host*/)</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-{</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+nsMsgKeySet::nsMsgKeySet(/* MSG_NewsHost* host*/) {</span>
<a href="#l22.44"></a><span id="l22.44">   MOZ_COUNT_CTOR(nsMsgKeySet);</span>
<a href="#l22.45"></a><span id="l22.45">   m_cached_value = -1;</span>
<a href="#l22.46"></a><span id="l22.46">   m_cached_value_index = 0;</span>
<a href="#l22.47"></a><span id="l22.47">   m_length = 0;</span>
<a href="#l22.48"></a><span id="l22.48">   m_data_size = 10;</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  m_data = (int32_t *) PR_Malloc (sizeof (int32_t) * m_data_size);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  m_data = (int32_t *)PR_Malloc(sizeof(int32_t) * m_data_size);</span>
<a href="#l22.51"></a><span id="l22.51"> #ifdef NEWSRC_DOES_HOST_STUFF</span>
<a href="#l22.52"></a><span id="l22.52">   m_host = host;</span>
<a href="#l22.53"></a><span id="l22.53"> #endif</span>
<a href="#l22.54"></a><span id="l22.54"> }</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-nsMsgKeySet::~nsMsgKeySet()</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-{</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+nsMsgKeySet::~nsMsgKeySet() {</span>
<a href="#l22.60"></a><span id="l22.60">   MOZ_COUNT_DTOR(nsMsgKeySet);</span>
<a href="#l22.61"></a><span id="l22.61">   PR_FREEIF(m_data);</span>
<a href="#l22.62"></a><span id="l22.62"> }</span>
<a href="#l22.63"></a><span id="l22.63"> </span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-bool nsMsgKeySet::Grow()</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-{</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+bool nsMsgKeySet::Grow() {</span>
<a href="#l22.68"></a><span id="l22.68">   int32_t new_size;</span>
<a href="#l22.69"></a><span id="l22.69">   int32_t *new_data;</span>
<a href="#l22.70"></a><span id="l22.70">   new_size = m_data_size * 2;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-  new_data = (int32_t *) PR_REALLOC (m_data, sizeof (int32_t) * new_size);</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-  if (! new_data)</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-    return false;</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+  new_data = (int32_t *)PR_REALLOC(m_data, sizeof(int32_t) * new_size);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+  if (!new_data) return false;</span>
<a href="#l22.76"></a><span id="l22.76">   m_data_size = new_size;</span>
<a href="#l22.77"></a><span id="l22.77">   m_data = new_data;</span>
<a href="#l22.78"></a><span id="l22.78">   return true;</span>
<a href="#l22.79"></a><span id="l22.79"> }</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-nsMsgKeySet::nsMsgKeySet(const char* numbers /* , MSG_NewsHost* host */)</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-{</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+nsMsgKeySet::nsMsgKeySet(const char *numbers /* , MSG_NewsHost* host */) {</span>
<a href="#l22.85"></a><span id="l22.85">   int32_t *head, *tail, *end;</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-    MOZ_COUNT_CTOR(nsMsgKeySet);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+  MOZ_COUNT_CTOR(nsMsgKeySet);</span>
<a href="#l22.88"></a><span id="l22.88"> </span>
<a href="#l22.89"></a><span id="l22.89"> #ifdef NEWSRC_DOES_HOST_STUFF</span>
<a href="#l22.90"></a><span id="l22.90">   m_host = host;</span>
<a href="#l22.91"></a><span id="l22.91"> #endif</span>
<a href="#l22.92"></a><span id="l22.92">   m_cached_value = -1;</span>
<a href="#l22.93"></a><span id="l22.93">   m_cached_value_index = 0;</span>
<a href="#l22.94"></a><span id="l22.94">   m_length = 0;</span>
<a href="#l22.95"></a><span id="l22.95">   m_data_size = 10;</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-  m_data = (int32_t *) PR_Malloc (sizeof (int32_t) * m_data_size);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+  m_data = (int32_t *)PR_Malloc(sizeof(int32_t) * m_data_size);</span>
<a href="#l22.98"></a><span id="l22.98">   if (!m_data) return;</span>
<a href="#l22.99"></a><span id="l22.99"> </span>
<a href="#l22.100"></a><span id="l22.100">   head = m_data;</span>
<a href="#l22.101"></a><span id="l22.101">   tail = head;</span>
<a href="#l22.102"></a><span id="l22.102">   end = head + m_data_size;</span>
<a href="#l22.103"></a><span id="l22.103"> </span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-  if(!numbers) {</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+  if (!numbers) {</span>
<a href="#l22.106"></a><span id="l22.106">     return;</span>
<a href="#l22.107"></a><span id="l22.107">   }</span>
<a href="#l22.108"></a><span id="l22.108"> </span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-  while (isspace (*numbers)) numbers++;</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+  while (isspace(*numbers)) numbers++;</span>
<a href="#l22.111"></a><span id="l22.111">   while (*numbers) {</span>
<a href="#l22.112"></a><span id="l22.112">     int32_t from = 0;</span>
<a href="#l22.113"></a><span id="l22.113">     int32_t to;</span>
<a href="#l22.114"></a><span id="l22.114"> </span>
<a href="#l22.115"></a><span id="l22.115">     if (tail &gt;= end - 4) {</span>
<a href="#l22.116"></a><span id="l22.116">       /* out of room! */</span>
<a href="#l22.117"></a><span id="l22.117">       int32_t tailo = tail - head;</span>
<a href="#l22.118"></a><span id="l22.118">       if (!Grow()) {</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineat">@@ -137,19 +129,19 @@ nsMsgKeySet::nsMsgKeySet(const char* num</span>
<a href="#l22.120"></a><span id="l22.120">       /* data may have been relocated */</span>
<a href="#l22.121"></a><span id="l22.121">       head = m_data;</span>
<a href="#l22.122"></a><span id="l22.122">       tail = head + tailo;</span>
<a href="#l22.123"></a><span id="l22.123">       end = head + m_data_size;</span>
<a href="#l22.124"></a><span id="l22.124">     }</span>
<a href="#l22.125"></a><span id="l22.125"> </span>
<a href="#l22.126"></a><span id="l22.126">     while (isspace(*numbers)) numbers++;</span>
<a href="#l22.127"></a><span id="l22.127">     if (*numbers &amp;&amp; !isdigit(*numbers)) {</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-      break;      /* illegal character */</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+      break; /* illegal character */</span>
<a href="#l22.130"></a><span id="l22.130">     }</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-    while (isdigit (*numbers)) {</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+    while (isdigit(*numbers)) {</span>
<a href="#l22.133"></a><span id="l22.133">       from = (from * 10) + (*numbers++ - '0');</span>
<a href="#l22.134"></a><span id="l22.134">     }</span>
<a href="#l22.135"></a><span id="l22.135">     while (isspace(*numbers)) numbers++;</span>
<a href="#l22.136"></a><span id="l22.136">     if (*numbers != '-') {</span>
<a href="#l22.137"></a><span id="l22.137">       to = from;</span>
<a href="#l22.138"></a><span id="l22.138">     } else {</span>
<a href="#l22.139"></a><span id="l22.139">       to = 0;</span>
<a href="#l22.140"></a><span id="l22.140">       numbers++;</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineat">@@ -182,55 +174,44 @@ nsMsgKeySet::nsMsgKeySet(const char* num</span>
<a href="#l22.142"></a><span id="l22.142">     while (*numbers == ',' || isspace(*numbers)) {</span>
<a href="#l22.143"></a><span id="l22.143">       numbers++;</span>
<a href="#l22.144"></a><span id="l22.144">     }</span>
<a href="#l22.145"></a><span id="l22.145">   }</span>
<a href="#l22.146"></a><span id="l22.146"> </span>
<a href="#l22.147"></a><span id="l22.147">   m_length = tail - head; /* size of data */</span>
<a href="#l22.148"></a><span id="l22.148"> }</span>
<a href="#l22.149"></a><span id="l22.149"> </span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineminus">-nsMsgKeySet*</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-nsMsgKeySet::Create(/*MSG_NewsHost* host*/)</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-{</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-  nsMsgKeySet* set = new nsMsgKeySet(/* host */);</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+nsMsgKeySet *nsMsgKeySet::Create(/*MSG_NewsHost* host*/) {</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+  nsMsgKeySet *set = new nsMsgKeySet(/* host */);</span>
<a href="#l22.158"></a><span id="l22.158">   if (set &amp;&amp; set-&gt;m_data == NULL) {</span>
<a href="#l22.159"></a><span id="l22.159">     delete set;</span>
<a href="#l22.160"></a><span id="l22.160">     set = NULL;</span>
<a href="#l22.161"></a><span id="l22.161">   }</span>
<a href="#l22.162"></a><span id="l22.162">   return set;</span>
<a href="#l22.163"></a><span id="l22.163"> }</span>
<a href="#l22.164"></a><span id="l22.164"> </span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineminus">-nsMsgKeySet*</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-nsMsgKeySet::Create(const char* value /* , MSG_NewsHost* host */)</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-{</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+nsMsgKeySet *nsMsgKeySet::Create(const char *value /* , MSG_NewsHost* host */) {</span>
<a href="#l22.170"></a><span id="l22.170"> #ifdef DEBUG_MSGKEYSET</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-    printf(&quot;create from %s\n&quot;,value);</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+  printf(&quot;create from %s\n&quot;, value);</span>
<a href="#l22.173"></a><span id="l22.173"> #endif</span>
<a href="#l22.174"></a><span id="l22.174"> </span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-  nsMsgKeySet* set = new nsMsgKeySet(value /* , host */);</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+  nsMsgKeySet *set = new nsMsgKeySet(value /* , host */);</span>
<a href="#l22.177"></a><span id="l22.177">   if (set &amp;&amp; set-&gt;m_data == NULL) {</span>
<a href="#l22.178"></a><span id="l22.178">     delete set;</span>
<a href="#l22.179"></a><span id="l22.179">     set = NULL;</span>
<a href="#l22.180"></a><span id="l22.180">   }</span>
<a href="#l22.181"></a><span id="l22.181">   return set;</span>
<a href="#l22.182"></a><span id="l22.182"> }</span>
<a href="#l22.183"></a><span id="l22.183"> </span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-</span>
<a href="#l22.186"></a><span id="l22.186"> /* Returns the lowest non-member of the set greater than 0.</span>
<a href="#l22.187"></a><span id="l22.187">  */</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-int32_t</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-nsMsgKeySet::FirstNonMember ()</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-{</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+int32_t nsMsgKeySet::FirstNonMember() {</span>
<a href="#l22.192"></a><span id="l22.192">   if (m_length &lt;= 0) {</span>
<a href="#l22.193"></a><span id="l22.193">     return 1;</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-  } else if(m_data[0] &lt; 0 &amp;&amp; m_data[1] != 1 &amp;&amp; m_data[1] != 0) {</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+  } else if (m_data[0] &lt; 0 &amp;&amp; m_data[1] != 1 &amp;&amp; m_data[1] != 0) {</span>
<a href="#l22.196"></a><span id="l22.196">     /* first range not equal to 0 or 1, always return 1 */</span>
<a href="#l22.197"></a><span id="l22.197">     return 1;</span>
<a href="#l22.198"></a><span id="l22.198">   } else if (m_data[0] &lt; 0) {</span>
<a href="#l22.199"></a><span id="l22.199">     /* it's a range */</span>
<a href="#l22.200"></a><span id="l22.200">     /* If there is a range [N-M] we can presume that M+1 is not in the</span>
<a href="#l22.201"></a><span id="l22.201">        set. */</span>
<a href="#l22.202"></a><span id="l22.202">     return (m_data[1] - m_data[0] + 1);</span>
<a href="#l22.203"></a><span id="l22.203">   } else {</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineat">@@ -238,41 +219,36 @@ nsMsgKeySet::FirstNonMember ()</span>
<a href="#l22.205"></a><span id="l22.205">     if (m_data[0] == 1) {</span>
<a href="#l22.206"></a><span id="l22.206">       /* handle &quot;1,...&quot; */</span>
<a href="#l22.207"></a><span id="l22.207">       if (m_length &gt; 1 &amp;&amp; m_data[1] == 2) {</span>
<a href="#l22.208"></a><span id="l22.208">         /* This is &quot;1,2,M-N,...&quot; or &quot;1,2,M,...&quot;  where M &gt;= 4.  Note</span>
<a href="#l22.209"></a><span id="l22.209">            that M will never be 3, because in that case we would have</span>
<a href="#l22.210"></a><span id="l22.210">            started with a range: &quot;1-3,...&quot; */</span>
<a href="#l22.211"></a><span id="l22.211">         return 3;</span>
<a href="#l22.212"></a><span id="l22.212">       } else {</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineminus">-        return 2;              /* handle &quot;1,M-N,..&quot; or &quot;1,M,...&quot;</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineminus">-                      where M &gt;= 3; */</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+        return 2; /* handle &quot;1,M-N,..&quot; or &quot;1,M,...&quot;</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+         where M &gt;= 3; */</span>
<a href="#l22.217"></a><span id="l22.217">       }</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-    }</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-    else if (m_data[0] == 0) {</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+    } else if (m_data[0] == 0) {</span>
<a href="#l22.221"></a><span id="l22.221">       /* handle &quot;0,...&quot; */</span>
<a href="#l22.222"></a><span id="l22.222">       if (m_length &gt; 1 &amp;&amp; m_data[1] == 1) {</span>
<a href="#l22.223"></a><span id="l22.223">         /* this is 0,1, (see above) */</span>
<a href="#l22.224"></a><span id="l22.224">         return 2;</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-      }</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-      else {</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineplus">+      } else {</span>
<a href="#l22.228"></a><span id="l22.228">         return 1;</span>
<a href="#l22.229"></a><span id="l22.229">       }</span>
<a href="#l22.230"></a><span id="l22.230"> </span>
<a href="#l22.231"></a><span id="l22.231">     } else {</span>
<a href="#l22.232"></a><span id="l22.232">       /* handle &quot;M,...&quot; where M &gt;= 2. */</span>
<a href="#l22.233"></a><span id="l22.233">       return 1;</span>
<a href="#l22.234"></a><span id="l22.234">     }</span>
<a href="#l22.235"></a><span id="l22.235">   }</span>
<a href="#l22.236"></a><span id="l22.236"> }</span>
<a href="#l22.237"></a><span id="l22.237"> </span>
<a href="#l22.238"></a><span id="l22.238" class="difflineminus">-</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineminus">-nsresult</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineminus">-nsMsgKeySet::Output(char **outputStr)</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineminus">-{</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+nsresult nsMsgKeySet::Output(char **outputStr) {</span>
<a href="#l22.243"></a><span id="l22.243">   NS_ENSURE_ARG(outputStr);</span>
<a href="#l22.244"></a><span id="l22.244">   int32_t size;</span>
<a href="#l22.245"></a><span id="l22.245">   int32_t *head;</span>
<a href="#l22.246"></a><span id="l22.246">   int32_t *tail;</span>
<a href="#l22.247"></a><span id="l22.247">   int32_t *end;</span>
<a href="#l22.248"></a><span id="l22.248">   int32_t s_size;</span>
<a href="#l22.249"></a><span id="l22.249">   char *s_head;</span>
<a href="#l22.250"></a><span id="l22.250">   char *s, *s_end;</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineat">@@ -280,176 +256,153 @@ nsMsgKeySet::Output(char **outputStr)</span>
<a href="#l22.252"></a><span id="l22.252"> </span>
<a href="#l22.253"></a><span id="l22.253">   *outputStr = nullptr;</span>
<a href="#l22.254"></a><span id="l22.254"> </span>
<a href="#l22.255"></a><span id="l22.255">   size = m_length;</span>
<a href="#l22.256"></a><span id="l22.256">   head = m_data;</span>
<a href="#l22.257"></a><span id="l22.257">   tail = head;</span>
<a href="#l22.258"></a><span id="l22.258">   end = head + size;</span>
<a href="#l22.259"></a><span id="l22.259"> </span>
<a href="#l22.260"></a><span id="l22.260" class="difflineminus">-  s_size = (size * 12) + 10;  // dmb - try to make this allocation get used at least once.</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineminus">-  s_head = (char *) moz_xmalloc(s_size);</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineminus">-  if (! s_head) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+  s_size = (size * 12) +</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+           10;  // dmb - try to make this allocation get used at least once.</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+  s_head = (char *)moz_xmalloc(s_size);</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineplus">+  if (!s_head) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.267"></a><span id="l22.267"> </span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-  s_head[0] = '\0';      // otherwise, s_head will contain garbage.</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+  s_head[0] = '\0';  // otherwise, s_head will contain garbage.</span>
<a href="#l22.270"></a><span id="l22.270">   s = s_head;</span>
<a href="#l22.271"></a><span id="l22.271">   s_end = s + s_size;</span>
<a href="#l22.272"></a><span id="l22.272"> </span>
<a href="#l22.273"></a><span id="l22.273">   while (tail &lt; end) {</span>
<a href="#l22.274"></a><span id="l22.274">     int32_t from;</span>
<a href="#l22.275"></a><span id="l22.275">     int32_t to;</span>
<a href="#l22.276"></a><span id="l22.276"> </span>
<a href="#l22.277"></a><span id="l22.277">     if (s &gt; (s_end - (12 * 2 + 10))) { /* 12 bytes for each number (enough</span>
<a href="#l22.278"></a><span id="l22.278">                         for &quot;2147483647&quot; aka 2^31-1),</span>
<a href="#l22.279"></a><span id="l22.279">                         plus 10 bytes of slop. */</span>
<a href="#l22.280"></a><span id="l22.280">       int32_t so = s - s_head;</span>
<a href="#l22.281"></a><span id="l22.281">       s_size += 200;</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-      char* tmp = (char *) moz_xmalloc(s_size);</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+      char *tmp = (char *)moz_xmalloc(s_size);</span>
<a href="#l22.284"></a><span id="l22.284">       if (tmp) PL_strcpy(tmp, s_head);</span>
<a href="#l22.285"></a><span id="l22.285">       free(s_head);</span>
<a href="#l22.286"></a><span id="l22.286">       s_head = tmp;</span>
<a href="#l22.287"></a><span id="l22.287">       if (!s_head) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.288"></a><span id="l22.288">       s = s_head + so;</span>
<a href="#l22.289"></a><span id="l22.289">       s_end = s_head + s_size;</span>
<a href="#l22.290"></a><span id="l22.290">     }</span>
<a href="#l22.291"></a><span id="l22.291"> </span>
<a href="#l22.292"></a><span id="l22.292">     if (*tail &lt; 0) {</span>
<a href="#l22.293"></a><span id="l22.293">       /* it's a range */</span>
<a href="#l22.294"></a><span id="l22.294">       from = tail[1];</span>
<a href="#l22.295"></a><span id="l22.295">       to = from + (-(tail[0]));</span>
<a href="#l22.296"></a><span id="l22.296">       tail += 2;</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+    } else /* it's a literal */</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineplus">+    {</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+      from = *tail;</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+      to = from;</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+      tail++;</span>
<a href="#l22.302"></a><span id="l22.302">     }</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineminus">-    else /* it's a literal */</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineminus">-      {</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineminus">-        from = *tail;</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineminus">-        to = from;</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineminus">-        tail++;</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineminus">-      }</span>
<a href="#l22.309"></a><span id="l22.309">     if (from == 0) {</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineminus">-      from = 1;        /* See 'hack' comment above  ### */</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineplus">+      from = 1; /* See 'hack' comment above  ### */</span>
<a href="#l22.312"></a><span id="l22.312">     }</span>
<a href="#l22.313"></a><span id="l22.313">     if (from &lt;= last_art) from = last_art + 1;</span>
<a href="#l22.314"></a><span id="l22.314">     if (from &lt;= to) {</span>
<a href="#l22.315"></a><span id="l22.315">       if (from &lt; to) {</span>
<a href="#l22.316"></a><span id="l22.316">         PR_snprintf(s, s_end - s, &quot;%lu-%lu,&quot;, from, to);</span>
<a href="#l22.317"></a><span id="l22.317">       } else {</span>
<a href="#l22.318"></a><span id="l22.318">         PR_snprintf(s, s_end - s, &quot;%lu,&quot;, from);</span>
<a href="#l22.319"></a><span id="l22.319">       }</span>
<a href="#l22.320"></a><span id="l22.320">       s += PL_strlen(s);</span>
<a href="#l22.321"></a><span id="l22.321">       last_art = to;</span>
<a href="#l22.322"></a><span id="l22.322">     }</span>
<a href="#l22.323"></a><span id="l22.323">   }</span>
<a href="#l22.324"></a><span id="l22.324">   if (last_art &gt;= 0) {</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineminus">-    s--;              /* Strip off the last ',' */</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineplus">+    s--; /* Strip off the last ',' */</span>
<a href="#l22.327"></a><span id="l22.327">   }</span>
<a href="#l22.328"></a><span id="l22.328"> </span>
<a href="#l22.329"></a><span id="l22.329">   *s = 0;</span>
<a href="#l22.330"></a><span id="l22.330"> </span>
<a href="#l22.331"></a><span id="l22.331">   *outputStr = s_head;</span>
<a href="#l22.332"></a><span id="l22.332">   return NS_OK;</span>
<a href="#l22.333"></a><span id="l22.333"> }</span>
<a href="#l22.334"></a><span id="l22.334"> </span>
<a href="#l22.335"></a><span id="l22.335" class="difflineminus">-int32_t</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineminus">-nsMsgKeySet::GetLastMember()</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineminus">-{</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineminus">-  if (m_length &gt; 1)</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineminus">-  {</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineplus">+int32_t nsMsgKeySet::GetLastMember() {</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+  if (m_length &gt; 1) {</span>
<a href="#l22.342"></a><span id="l22.342">     int32_t nextToLast = m_data[m_length - 2];</span>
<a href="#l22.343"></a><span id="l22.343">     if (nextToLast &lt; 0)  // is range at end?</span>
<a href="#l22.344"></a><span id="l22.344">     {</span>
<a href="#l22.345"></a><span id="l22.345">       int32_t last = m_data[m_length - 1];</span>
<a href="#l22.346"></a><span id="l22.346">       return (-nextToLast + last - 1);</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineminus">-    }</span>
<a href="#l22.348"></a><span id="l22.348" class="difflineminus">-    else  // no, so last number must be last member</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineplus">+    } else  // no, so last number must be last member</span>
<a href="#l22.350"></a><span id="l22.350">     {</span>
<a href="#l22.351"></a><span id="l22.351">       return m_data[m_length - 1];</span>
<a href="#l22.352"></a><span id="l22.352">     }</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineminus">-  }</span>
<a href="#l22.354"></a><span id="l22.354" class="difflineminus">-  else if (m_length == 1)</span>
<a href="#l22.355"></a><span id="l22.355" class="difflineplus">+  } else if (m_length == 1)</span>
<a href="#l22.356"></a><span id="l22.356">     return m_data[0];  // must be only 1 read.</span>
<a href="#l22.357"></a><span id="l22.357">   else</span>
<a href="#l22.358"></a><span id="l22.358">     return 0;</span>
<a href="#l22.359"></a><span id="l22.359"> }</span>
<a href="#l22.360"></a><span id="l22.360"> </span>
<a href="#l22.361"></a><span id="l22.361" class="difflineminus">-void nsMsgKeySet::SetLastMember(int32_t newHighWaterMark)</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineminus">-{</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineminus">-  if (newHighWaterMark &lt; GetLastMember())</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineminus">-  {</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineminus">-    while (true)</span>
<a href="#l22.366"></a><span id="l22.366" class="difflineminus">-    {</span>
<a href="#l22.367"></a><span id="l22.367" class="difflineminus">-      if (m_length &gt; 1)</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineminus">-      {</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineplus">+void nsMsgKeySet::SetLastMember(int32_t newHighWaterMark) {</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineplus">+  if (newHighWaterMark &lt; GetLastMember()) {</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineplus">+    while (true) {</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineplus">+      if (m_length &gt; 1) {</span>
<a href="#l22.373"></a><span id="l22.373">         int32_t nextToLast = m_data[m_length - 2];</span>
<a href="#l22.374"></a><span id="l22.374">         int32_t curHighWater;</span>
<a href="#l22.375"></a><span id="l22.375">         if (nextToLast &lt; 0)  // is range at end?</span>
<a href="#l22.376"></a><span id="l22.376">         {</span>
<a href="#l22.377"></a><span id="l22.377">           int32_t rangeStart = m_data[m_length - 1];</span>
<a href="#l22.378"></a><span id="l22.378">           int32_t rangeLength = -nextToLast;</span>
<a href="#l22.379"></a><span id="l22.379">           curHighWater = (rangeLength + rangeStart - 1);</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineminus">-          if (curHighWater &gt; newHighWaterMark)</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineminus">-          {</span>
<a href="#l22.382"></a><span id="l22.382" class="difflineminus">-            if (rangeStart &gt; newHighWaterMark)</span>
<a href="#l22.383"></a><span id="l22.383" class="difflineminus">-            {</span>
<a href="#l22.384"></a><span id="l22.384" class="difflineplus">+          if (curHighWater &gt; newHighWaterMark) {</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineplus">+            if (rangeStart &gt; newHighWaterMark) {</span>
<a href="#l22.386"></a><span id="l22.386">               m_length -= 2;  // throw away whole range</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineminus">-            }</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineminus">-            else if (rangeStart == newHighWaterMark)</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineminus">-            {</span>
<a href="#l22.390"></a><span id="l22.390" class="difflineplus">+            } else if (rangeStart == newHighWaterMark) {</span>
<a href="#l22.391"></a><span id="l22.391">               // turn range into single element.</span>
<a href="#l22.392"></a><span id="l22.392">               m_data[m_length - 2] = newHighWaterMark;</span>
<a href="#l22.393"></a><span id="l22.393">               m_length--;</span>
<a href="#l22.394"></a><span id="l22.394">               break;</span>
<a href="#l22.395"></a><span id="l22.395" class="difflineminus">-            }</span>
<a href="#l22.396"></a><span id="l22.396" class="difflineminus">-            else  // just shorten range</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineplus">+            } else  // just shorten range</span>
<a href="#l22.398"></a><span id="l22.398">             {</span>
<a href="#l22.399"></a><span id="l22.399">               m_data[m_length - 2] = -(newHighWaterMark - rangeStart);</span>
<a href="#l22.400"></a><span id="l22.400">               break;</span>
<a href="#l22.401"></a><span id="l22.401">             }</span>
<a href="#l22.402"></a><span id="l22.402" class="difflineminus">-          }</span>
<a href="#l22.403"></a><span id="l22.403" class="difflineminus">-          else {</span>
<a href="#l22.404"></a><span id="l22.404" class="difflineplus">+          } else {</span>
<a href="#l22.405"></a><span id="l22.405">             // prevent the infinite loop</span>
<a href="#l22.406"></a><span id="l22.406">             // see bug #13062</span>
<a href="#l22.407"></a><span id="l22.407">             break;</span>
<a href="#l22.408"></a><span id="l22.408">           }</span>
<a href="#l22.409"></a><span id="l22.409" class="difflineminus">-        }</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineminus">-        else if (m_data[m_length - 1] &gt; newHighWaterMark)  // no, so last number must be last member</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineplus">+        } else if (m_data[m_length - 1] &gt;</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineplus">+                   newHighWaterMark)  // no, so last number must be last member</span>
<a href="#l22.413"></a><span id="l22.413">         {</span>
<a href="#l22.414"></a><span id="l22.414">           m_length--;</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineminus">-        }</span>
<a href="#l22.416"></a><span id="l22.416" class="difflineminus">-        else</span>
<a href="#l22.417"></a><span id="l22.417" class="difflineplus">+        } else</span>
<a href="#l22.418"></a><span id="l22.418">           break;</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineminus">-      }</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineminus">-      else</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineplus">+      } else</span>
<a href="#l22.422"></a><span id="l22.422">         break;</span>
<a href="#l22.423"></a><span id="l22.423">     }</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineminus">-    // well, the whole range is probably invalid, because the server probably re-ordered ids,</span>
<a href="#l22.425"></a><span id="l22.425" class="difflineminus">-    // but what can you do?</span>
<a href="#l22.426"></a><span id="l22.426" class="difflineplus">+    // well, the whole range is probably invalid, because the server probably</span>
<a href="#l22.427"></a><span id="l22.427" class="difflineplus">+    // re-ordered ids, but what can you do?</span>
<a href="#l22.428"></a><span id="l22.428"> #ifdef NEWSRC_DOES_HOST_STUFF</span>
<a href="#l22.429"></a><span id="l22.429" class="difflineminus">-    if (m_host)</span>
<a href="#l22.430"></a><span id="l22.430" class="difflineminus">-      m_host-&gt;MarkDirty();</span>
<a href="#l22.431"></a><span id="l22.431" class="difflineplus">+    if (m_host) m_host-&gt;MarkDirty();</span>
<a href="#l22.432"></a><span id="l22.432"> #endif</span>
<a href="#l22.433"></a><span id="l22.433">   }</span>
<a href="#l22.434"></a><span id="l22.434"> }</span>
<a href="#l22.435"></a><span id="l22.435"> </span>
<a href="#l22.436"></a><span id="l22.436" class="difflineminus">-int32_t</span>
<a href="#l22.437"></a><span id="l22.437" class="difflineminus">-nsMsgKeySet::GetFirstMember()</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineminus">-{</span>
<a href="#l22.439"></a><span id="l22.439" class="difflineminus">-  if (m_length &gt; 1)</span>
<a href="#l22.440"></a><span id="l22.440" class="difflineminus">-  {</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineplus">+int32_t nsMsgKeySet::GetFirstMember() {</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineplus">+  if (m_length &gt; 1) {</span>
<a href="#l22.443"></a><span id="l22.443">     int32_t first = m_data[0];</span>
<a href="#l22.444"></a><span id="l22.444">     if (first &lt; 0)  // is range at start?</span>
<a href="#l22.445"></a><span id="l22.445">     {</span>
<a href="#l22.446"></a><span id="l22.446">       int32_t second = m_data[1];</span>
<a href="#l22.447"></a><span id="l22.447">       return (second);</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineminus">-    }</span>
<a href="#l22.449"></a><span id="l22.449" class="difflineminus">-    else  // no, so first number must be first member</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineplus">+    } else  // no, so first number must be first member</span>
<a href="#l22.451"></a><span id="l22.451">     {</span>
<a href="#l22.452"></a><span id="l22.452">       return m_data[0];</span>
<a href="#l22.453"></a><span id="l22.453">     }</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineminus">-  }</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineminus">-  else if (m_length == 1)</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineplus">+  } else if (m_length == 1)</span>
<a href="#l22.457"></a><span id="l22.457">     return m_data[0];  // must be only 1 read.</span>
<a href="#l22.458"></a><span id="l22.458">   else</span>
<a href="#l22.459"></a><span id="l22.459">     return 0;</span>
<a href="#l22.460"></a><span id="l22.460"> }</span>
<a href="#l22.461"></a><span id="l22.461"> </span>
<a href="#l22.462"></a><span id="l22.462"> /* Re-compresses a `nsMsgKeySet' object.</span>
<a href="#l22.463"></a><span id="l22.463"> </span>
<a href="#l22.464"></a><span id="l22.464">    The assumption is made that the `nsMsgKeySet' is syntactically correct</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineat">@@ -461,31 +414,29 @@ nsMsgKeySet::GetFirstMember()</span>
<a href="#l22.466"></a><span id="l22.466">    allocate scratch space.</span>
<a href="#l22.467"></a><span id="l22.467"> </span>
<a href="#l22.468"></a><span id="l22.468">    #### This should be changed to modify the buffer in place.</span>
<a href="#l22.469"></a><span id="l22.469"> </span>
<a href="#l22.470"></a><span id="l22.470">    Also note that we never call Optimize() unless we actually changed</span>
<a href="#l22.471"></a><span id="l22.471">    something, so it's a great place to tell the MSG_NewsHost* that something</span>
<a href="#l22.472"></a><span id="l22.472">    changed.</span>
<a href="#l22.473"></a><span id="l22.473">    */</span>
<a href="#l22.474"></a><span id="l22.474" class="difflineminus">-bool</span>
<a href="#l22.475"></a><span id="l22.475" class="difflineminus">-nsMsgKeySet::Optimize()</span>
<a href="#l22.476"></a><span id="l22.476" class="difflineminus">-{</span>
<a href="#l22.477"></a><span id="l22.477" class="difflineplus">+bool nsMsgKeySet::Optimize() {</span>
<a href="#l22.478"></a><span id="l22.478">   int32_t input_size;</span>
<a href="#l22.479"></a><span id="l22.479">   int32_t output_size;</span>
<a href="#l22.480"></a><span id="l22.480">   int32_t *input_tail;</span>
<a href="#l22.481"></a><span id="l22.481">   int32_t *output_data;</span>
<a href="#l22.482"></a><span id="l22.482">   int32_t *output_tail;</span>
<a href="#l22.483"></a><span id="l22.483">   int32_t *input_end;</span>
<a href="#l22.484"></a><span id="l22.484">   int32_t *output_end;</span>
<a href="#l22.485"></a><span id="l22.485"> </span>
<a href="#l22.486"></a><span id="l22.486">   input_size = m_length;</span>
<a href="#l22.487"></a><span id="l22.487">   output_size = input_size + 1;</span>
<a href="#l22.488"></a><span id="l22.488">   input_tail = m_data;</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineminus">-  output_data = (int32_t *) PR_Malloc (sizeof (int32_t) * output_size);</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineplus">+  output_data = (int32_t *)PR_Malloc(sizeof(int32_t) * output_size);</span>
<a href="#l22.491"></a><span id="l22.491">   if (!output_data) return false;</span>
<a href="#l22.492"></a><span id="l22.492"> </span>
<a href="#l22.493"></a><span id="l22.493">   output_tail = output_data;</span>
<a href="#l22.494"></a><span id="l22.494">   input_end = input_tail + input_size;</span>
<a href="#l22.495"></a><span id="l22.495">   output_end = output_data + output_size;</span>
<a href="#l22.496"></a><span id="l22.496"> </span>
<a href="#l22.497"></a><span id="l22.497">   /* We're going to modify the set, so invalidate the cache. */</span>
<a href="#l22.498"></a><span id="l22.498">   m_cached_value = -1;</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineat">@@ -514,43 +465,43 @@ nsMsgKeySet::Optimize()</span>
<a href="#l22.500"></a><span id="l22.500">     if (output_tail &gt;= output_end) {</span>
<a href="#l22.501"></a><span id="l22.501">       PR_Free(output_data);</span>
<a href="#l22.502"></a><span id="l22.502">       return false;</span>
<a href="#l22.503"></a><span id="l22.503">     }</span>
<a href="#l22.504"></a><span id="l22.504"> </span>
<a href="#l22.505"></a><span id="l22.505">     /* As long as this chunk is followed by consecutive chunks,</span>
<a href="#l22.506"></a><span id="l22.506">        keep extending it. */</span>
<a href="#l22.507"></a><span id="l22.507">     while (input_tail &lt; input_end &amp;&amp;</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineminus">-         ((*input_tail &gt; 0 &amp;&amp; /* literal... */</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineminus">-         *input_tail == to + 1) || /* ...and consecutive, or */</span>
<a href="#l22.510"></a><span id="l22.510" class="difflineminus">-        (*input_tail &lt;= 0 &amp;&amp; /* range... */</span>
<a href="#l22.511"></a><span id="l22.511" class="difflineminus">-         input_tail[1] == to + 1)) /* ...and consecutive. */</span>
<a href="#l22.512"></a><span id="l22.512" class="difflineminus">-         ) {</span>
<a href="#l22.513"></a><span id="l22.513" class="difflineminus">-      if (! range_p) {</span>
<a href="#l22.514"></a><span id="l22.514" class="difflineplus">+           ((*input_tail &gt; 0 &amp;&amp;        /* literal... */</span>
<a href="#l22.515"></a><span id="l22.515" class="difflineplus">+             *input_tail == to + 1) || /* ...and consecutive, or */</span>
<a href="#l22.516"></a><span id="l22.516" class="difflineplus">+            (*input_tail &lt;= 0 &amp;&amp;       /* range... */</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineplus">+             input_tail[1] == to + 1)) /* ...and consecutive. */</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineplus">+    ) {</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineplus">+      if (!range_p) {</span>
<a href="#l22.520"></a><span id="l22.520">         /* convert the literal to a range. */</span>
<a href="#l22.521"></a><span id="l22.521">         output_tail++;</span>
<a href="#l22.522"></a><span id="l22.522" class="difflineminus">-        output_tail [-2] = 0;</span>
<a href="#l22.523"></a><span id="l22.523" class="difflineminus">-        output_tail [-1] = from;</span>
<a href="#l22.524"></a><span id="l22.524" class="difflineplus">+        output_tail[-2] = 0;</span>
<a href="#l22.525"></a><span id="l22.525" class="difflineplus">+        output_tail[-1] = from;</span>
<a href="#l22.526"></a><span id="l22.526">         range_p = true;</span>
<a href="#l22.527"></a><span id="l22.527">       }</span>
<a href="#l22.528"></a><span id="l22.528"> </span>
<a href="#l22.529"></a><span id="l22.529">       if (*input_tail &gt; 0) { /* literal */</span>
<a href="#l22.530"></a><span id="l22.530" class="difflineminus">-        output_tail[-2]--; /* increase length by 1 */</span>
<a href="#l22.531"></a><span id="l22.531" class="difflineplus">+        output_tail[-2]--;   /* increase length by 1 */</span>
<a href="#l22.532"></a><span id="l22.532">         to++;</span>
<a href="#l22.533"></a><span id="l22.533">         input_tail++;</span>
<a href="#l22.534"></a><span id="l22.534">       } else {</span>
<a href="#l22.535"></a><span id="l22.535" class="difflineminus">-        int32_t L2 = (- *input_tail) + 1;</span>
<a href="#l22.536"></a><span id="l22.536" class="difflineplus">+        int32_t L2 = (-*input_tail) + 1;</span>
<a href="#l22.537"></a><span id="l22.537">         output_tail[-2] -= L2; /* increase length by N */</span>
<a href="#l22.538"></a><span id="l22.538">         to += L2;</span>
<a href="#l22.539"></a><span id="l22.539">         input_tail += 2;</span>
<a href="#l22.540"></a><span id="l22.540">       }</span>
<a href="#l22.541"></a><span id="l22.541">     }</span>
<a href="#l22.542"></a><span id="l22.542">   }</span>
<a href="#l22.543"></a><span id="l22.543"> </span>
<a href="#l22.544"></a><span id="l22.544" class="difflineminus">-  PR_Free (m_data);</span>
<a href="#l22.545"></a><span id="l22.545" class="difflineplus">+  PR_Free(m_data);</span>
<a href="#l22.546"></a><span id="l22.546">   m_data = output_data;</span>
<a href="#l22.547"></a><span id="l22.547">   m_data_size = output_size;</span>
<a href="#l22.548"></a><span id="l22.548">   m_length = output_tail - output_data;</span>
<a href="#l22.549"></a><span id="l22.549"> </span>
<a href="#l22.550"></a><span id="l22.550">   /* One last pass to turn [N - N+1] into [N, N+1]. */</span>
<a href="#l22.551"></a><span id="l22.551">   output_tail = output_data;</span>
<a href="#l22.552"></a><span id="l22.552">   output_end = output_tail + m_length;</span>
<a href="#l22.553"></a><span id="l22.553">   while (output_tail &lt; output_end) {</span>
<a href="#l22.554"></a><span id="l22.554" class="difflineat">@@ -568,36 +519,31 @@ nsMsgKeySet::Optimize()</span>
<a href="#l22.555"></a><span id="l22.555">   }</span>
<a href="#l22.556"></a><span id="l22.556"> </span>
<a href="#l22.557"></a><span id="l22.557"> #ifdef NEWSRC_DOES_HOST_STUFF</span>
<a href="#l22.558"></a><span id="l22.558">   if (m_host) m_host-&gt;MarkDirty();</span>
<a href="#l22.559"></a><span id="l22.559"> #endif</span>
<a href="#l22.560"></a><span id="l22.560">   return true;</span>
<a href="#l22.561"></a><span id="l22.561"> }</span>
<a href="#l22.562"></a><span id="l22.562"> </span>
<a href="#l22.563"></a><span id="l22.563" class="difflineminus">-</span>
<a href="#l22.564"></a><span id="l22.564" class="difflineminus">-</span>
<a href="#l22.565"></a><span id="l22.565" class="difflineminus">-bool</span>
<a href="#l22.566"></a><span id="l22.566" class="difflineminus">-nsMsgKeySet::IsMember(int32_t number)</span>
<a href="#l22.567"></a><span id="l22.567" class="difflineminus">-{</span>
<a href="#l22.568"></a><span id="l22.568" class="difflineplus">+bool nsMsgKeySet::IsMember(int32_t number) {</span>
<a href="#l22.569"></a><span id="l22.569">   bool value = false;</span>
<a href="#l22.570"></a><span id="l22.570">   int32_t size;</span>
<a href="#l22.571"></a><span id="l22.571">   int32_t *head;</span>
<a href="#l22.572"></a><span id="l22.572">   int32_t *tail;</span>
<a href="#l22.573"></a><span id="l22.573">   int32_t *end;</span>
<a href="#l22.574"></a><span id="l22.574"> </span>
<a href="#l22.575"></a><span id="l22.575">   size = m_length;</span>
<a href="#l22.576"></a><span id="l22.576">   head = m_data;</span>
<a href="#l22.577"></a><span id="l22.577">   tail = head;</span>
<a href="#l22.578"></a><span id="l22.578">   end = head + size;</span>
<a href="#l22.579"></a><span id="l22.579"> </span>
<a href="#l22.580"></a><span id="l22.580">   /* If there is a value cached, and that value is smaller than the</span>
<a href="#l22.581"></a><span id="l22.581">      value we're looking for, skip forward that far. */</span>
<a href="#l22.582"></a><span id="l22.582" class="difflineminus">-  if (m_cached_value &gt; 0 &amp;&amp;</span>
<a href="#l22.583"></a><span id="l22.583" class="difflineminus">-    m_cached_value &lt; number) {</span>
<a href="#l22.584"></a><span id="l22.584" class="difflineplus">+  if (m_cached_value &gt; 0 &amp;&amp; m_cached_value &lt; number) {</span>
<a href="#l22.585"></a><span id="l22.585">     tail += m_cached_value_index;</span>
<a href="#l22.586"></a><span id="l22.586">   }</span>
<a href="#l22.587"></a><span id="l22.587"> </span>
<a href="#l22.588"></a><span id="l22.588">   while (tail &lt; end) {</span>
<a href="#l22.589"></a><span id="l22.589">     if (*tail &lt; 0) {</span>
<a href="#l22.590"></a><span id="l22.590">       /* it's a range */</span>
<a href="#l22.591"></a><span id="l22.591">       int32_t from = tail[1];</span>
<a href="#l22.592"></a><span id="l22.592">       int32_t to = from + (-(tail[0]));</span>
<a href="#l22.593"></a><span id="l22.593" class="difflineat">@@ -607,18 +553,17 @@ nsMsgKeySet::IsMember(int32_t number)</span>
<a href="#l22.594"></a><span id="l22.594">         goto DONE;</span>
<a href="#l22.595"></a><span id="l22.595">       } else if (to &gt;= number) {</span>
<a href="#l22.596"></a><span id="l22.596">         /* In range. */</span>
<a href="#l22.597"></a><span id="l22.597">         value = true;</span>
<a href="#l22.598"></a><span id="l22.598">         goto DONE;</span>
<a href="#l22.599"></a><span id="l22.599">       } else {</span>
<a href="#l22.600"></a><span id="l22.600">         tail += 2;</span>
<a href="#l22.601"></a><span id="l22.601">       }</span>
<a href="#l22.602"></a><span id="l22.602" class="difflineminus">-    }</span>
<a href="#l22.603"></a><span id="l22.603" class="difflineminus">-    else {</span>
<a href="#l22.604"></a><span id="l22.604" class="difflineplus">+    } else {</span>
<a href="#l22.605"></a><span id="l22.605">       /* it's a literal */</span>
<a href="#l22.606"></a><span id="l22.606">       if (*tail == number) {</span>
<a href="#l22.607"></a><span id="l22.607">         /* bang */</span>
<a href="#l22.608"></a><span id="l22.608">         value = true;</span>
<a href="#l22.609"></a><span id="l22.609">         goto DONE;</span>
<a href="#l22.610"></a><span id="l22.610">       } else if (*tail &gt; number) {</span>
<a href="#l22.611"></a><span id="l22.611">         /* This literal is after the number - we've passed it. */</span>
<a href="#l22.612"></a><span id="l22.612">         value = false;</span>
<a href="#l22.613"></a><span id="l22.613" class="difflineat">@@ -632,37 +577,33 @@ nsMsgKeySet::IsMember(int32_t number)</span>
<a href="#l22.614"></a><span id="l22.614"> DONE:</span>
<a href="#l22.615"></a><span id="l22.615">   /* Store the position of this chunk for next time. */</span>
<a href="#l22.616"></a><span id="l22.616">   m_cached_value = number;</span>
<a href="#l22.617"></a><span id="l22.617">   m_cached_value_index = tail - head;</span>
<a href="#l22.618"></a><span id="l22.618"> </span>
<a href="#l22.619"></a><span id="l22.619">   return value;</span>
<a href="#l22.620"></a><span id="l22.620"> }</span>
<a href="#l22.621"></a><span id="l22.621"> </span>
<a href="#l22.622"></a><span id="l22.622" class="difflineminus">-</span>
<a href="#l22.623"></a><span id="l22.623" class="difflineminus">-int</span>
<a href="#l22.624"></a><span id="l22.624" class="difflineminus">-nsMsgKeySet::Add(int32_t number)</span>
<a href="#l22.625"></a><span id="l22.625" class="difflineminus">-{</span>
<a href="#l22.626"></a><span id="l22.626" class="difflineplus">+int nsMsgKeySet::Add(int32_t number) {</span>
<a href="#l22.627"></a><span id="l22.627">   int32_t size;</span>
<a href="#l22.628"></a><span id="l22.628">   int32_t *head;</span>
<a href="#l22.629"></a><span id="l22.629">   int32_t *tail;</span>
<a href="#l22.630"></a><span id="l22.630">   int32_t *end;</span>
<a href="#l22.631"></a><span id="l22.631"> </span>
<a href="#l22.632"></a><span id="l22.632"> #ifdef DEBUG_MSGKEYSET</span>
<a href="#l22.633"></a><span id="l22.633" class="difflineminus">-    printf(&quot;add %d\n&quot;,number);</span>
<a href="#l22.634"></a><span id="l22.634" class="difflineplus">+  printf(&quot;add %d\n&quot;, number);</span>
<a href="#l22.635"></a><span id="l22.635"> #endif</span>
<a href="#l22.636"></a><span id="l22.636"> </span>
<a href="#l22.637"></a><span id="l22.637">   size = m_length;</span>
<a href="#l22.638"></a><span id="l22.638">   head = m_data;</span>
<a href="#l22.639"></a><span id="l22.639">   tail = head;</span>
<a href="#l22.640"></a><span id="l22.640">   end = head + size;</span>
<a href="#l22.641"></a><span id="l22.641"> </span>
<a href="#l22.642"></a><span id="l22.642" class="difflineminus">-  NS_ASSERTION (number &gt;= 0, &quot;can't have negative items&quot;);</span>
<a href="#l22.643"></a><span id="l22.643" class="difflineminus">-  if (number &lt; 0)</span>
<a href="#l22.644"></a><span id="l22.644" class="difflineminus">-    return 0;</span>
<a href="#l22.645"></a><span id="l22.645" class="difflineplus">+  NS_ASSERTION(number &gt;= 0, &quot;can't have negative items&quot;);</span>
<a href="#l22.646"></a><span id="l22.646" class="difflineplus">+  if (number &lt; 0) return 0;</span>
<a href="#l22.647"></a><span id="l22.647"> </span>
<a href="#l22.648"></a><span id="l22.648">   /* We're going to modify the set, so invalidate the cache. */</span>
<a href="#l22.649"></a><span id="l22.649">   m_cached_value = -1;</span>
<a href="#l22.650"></a><span id="l22.650"> </span>
<a href="#l22.651"></a><span id="l22.651">   while (tail &lt; end) {</span>
<a href="#l22.652"></a><span id="l22.652">     if (*tail &lt; 0) {</span>
<a href="#l22.653"></a><span id="l22.653">       /* it's a range */</span>
<a href="#l22.654"></a><span id="l22.654">       int32_t from = tail[1];</span>
<a href="#l22.655"></a><span id="l22.655" class="difflineat">@@ -719,37 +660,33 @@ nsMsgKeySet::Add(int32_t number)</span>
<a href="#l22.656"></a><span id="l22.656">   if (tail == end) {</span>
<a href="#l22.657"></a><span id="l22.657">     /* at the end */</span>
<a href="#l22.658"></a><span id="l22.658">     /* Add a literal to the end. */</span>
<a href="#l22.659"></a><span id="l22.659">     m_data[m_length++] = number;</span>
<a href="#l22.660"></a><span id="l22.660">   } else {</span>
<a href="#l22.661"></a><span id="l22.661">     /* need to insert (or edit) in the middle */</span>
<a href="#l22.662"></a><span id="l22.662">     int32_t i;</span>
<a href="#l22.663"></a><span id="l22.663">     for (i = size; i &gt; mid; i--) {</span>
<a href="#l22.664"></a><span id="l22.664" class="difflineminus">-      m_data[i] = m_data[i-1];</span>
<a href="#l22.665"></a><span id="l22.665" class="difflineplus">+      m_data[i] = m_data[i - 1];</span>
<a href="#l22.666"></a><span id="l22.666">     }</span>
<a href="#l22.667"></a><span id="l22.667">     m_data[i] = number;</span>
<a href="#l22.668"></a><span id="l22.668">     m_length++;</span>
<a href="#l22.669"></a><span id="l22.669">   }</span>
<a href="#l22.670"></a><span id="l22.670"> </span>
<a href="#l22.671"></a><span id="l22.671">   Optimize();</span>
<a href="#l22.672"></a><span id="l22.672">   return 1;</span>
<a href="#l22.673"></a><span id="l22.673"> }</span>
<a href="#l22.674"></a><span id="l22.674"> </span>
<a href="#l22.675"></a><span id="l22.675" class="difflineminus">-</span>
<a href="#l22.676"></a><span id="l22.676" class="difflineminus">-</span>
<a href="#l22.677"></a><span id="l22.677" class="difflineminus">-int</span>
<a href="#l22.678"></a><span id="l22.678" class="difflineminus">-nsMsgKeySet::Remove(int32_t number)</span>
<a href="#l22.679"></a><span id="l22.679" class="difflineminus">-{</span>
<a href="#l22.680"></a><span id="l22.680" class="difflineplus">+int nsMsgKeySet::Remove(int32_t number) {</span>
<a href="#l22.681"></a><span id="l22.681">   int32_t size;</span>
<a href="#l22.682"></a><span id="l22.682">   int32_t *head;</span>
<a href="#l22.683"></a><span id="l22.683">   int32_t *tail;</span>
<a href="#l22.684"></a><span id="l22.684">   int32_t *end;</span>
<a href="#l22.685"></a><span id="l22.685"> #ifdef DEBUG_MSGKEYSET</span>
<a href="#l22.686"></a><span id="l22.686" class="difflineminus">-    printf(&quot;remove %d\n&quot;,number);</span>
<a href="#l22.687"></a><span id="l22.687" class="difflineplus">+  printf(&quot;remove %d\n&quot;, number);</span>
<a href="#l22.688"></a><span id="l22.688"> #endif</span>
<a href="#l22.689"></a><span id="l22.689"> </span>
<a href="#l22.690"></a><span id="l22.690">   size = m_length;</span>
<a href="#l22.691"></a><span id="l22.691">   head = m_data;</span>
<a href="#l22.692"></a><span id="l22.692">   tail = head;</span>
<a href="#l22.693"></a><span id="l22.693">   end = head + size;</span>
<a href="#l22.694"></a><span id="l22.694"> </span>
<a href="#l22.695"></a><span id="l22.695">   // **** I am not sure this is a right thing to comment the following</span>
<a href="#l22.696"></a><span id="l22.696" class="difflineat">@@ -781,41 +718,41 @@ nsMsgKeySet::Remove(int32_t number)</span>
<a href="#l22.697"></a><span id="l22.697">       }</span>
<a href="#l22.698"></a><span id="l22.698"> </span>
<a href="#l22.699"></a><span id="l22.699">       if (to == from + 1) {</span>
<a href="#l22.700"></a><span id="l22.700">         /* If this is a range [N - N+1] and we are removing M</span>
<a href="#l22.701"></a><span id="l22.701">            (which must be either N or N+1) replace it with a</span>
<a href="#l22.702"></a><span id="l22.702">            literal. This reduces the length by 1. */</span>
<a href="#l22.703"></a><span id="l22.703">         m_data[mid] = (number == from ? to : from);</span>
<a href="#l22.704"></a><span id="l22.704">         while (++mid &lt; m_length) {</span>
<a href="#l22.705"></a><span id="l22.705" class="difflineminus">-          m_data[mid] = m_data[mid+1];</span>
<a href="#l22.706"></a><span id="l22.706" class="difflineplus">+          m_data[mid] = m_data[mid + 1];</span>
<a href="#l22.707"></a><span id="l22.707">         }</span>
<a href="#l22.708"></a><span id="l22.708">         m_length--;</span>
<a href="#l22.709"></a><span id="l22.709">         Optimize();</span>
<a href="#l22.710"></a><span id="l22.710">         return 1;</span>
<a href="#l22.711"></a><span id="l22.711">       } else if (to == from + 2) {</span>
<a href="#l22.712"></a><span id="l22.712">         /* If this is a range [N - N+2] and we are removing M,</span>
<a href="#l22.713"></a><span id="l22.713">            replace it with the literals L,M (that is, either</span>
<a href="#l22.714"></a><span id="l22.714">            (N, N+1), (N, N+2), or (N+1, N+2). The overall</span>
<a href="#l22.715"></a><span id="l22.715">            length remains the same. */</span>
<a href="#l22.716"></a><span id="l22.716">         m_data[mid] = from;</span>
<a href="#l22.717"></a><span id="l22.717" class="difflineminus">-        m_data[mid+1] = to;</span>
<a href="#l22.718"></a><span id="l22.718" class="difflineplus">+        m_data[mid + 1] = to;</span>
<a href="#l22.719"></a><span id="l22.719">         if (from == number) {</span>
<a href="#l22.720"></a><span id="l22.720" class="difflineminus">-          m_data[mid] = from+1;</span>
<a href="#l22.721"></a><span id="l22.721" class="difflineplus">+          m_data[mid] = from + 1;</span>
<a href="#l22.722"></a><span id="l22.722">         } else if (to == number) {</span>
<a href="#l22.723"></a><span id="l22.723" class="difflineminus">-          m_data[mid+1] = to-1;</span>
<a href="#l22.724"></a><span id="l22.724" class="difflineplus">+          m_data[mid + 1] = to - 1;</span>
<a href="#l22.725"></a><span id="l22.725">         }</span>
<a href="#l22.726"></a><span id="l22.726">         Optimize();</span>
<a href="#l22.727"></a><span id="l22.727">         return 1;</span>
<a href="#l22.728"></a><span id="l22.728">       } else if (from == number) {</span>
<a href="#l22.729"></a><span id="l22.729">         /* This number is at the beginning of a long range (meaning a</span>
<a href="#l22.730"></a><span id="l22.730">            range which will still be long enough to remain a range.)</span>
<a href="#l22.731"></a><span id="l22.731">            Increase start and reduce length of the range. */</span>
<a href="#l22.732"></a><span id="l22.732">         m_data[mid]++;</span>
<a href="#l22.733"></a><span id="l22.733" class="difflineminus">-        m_data[mid+1]++;</span>
<a href="#l22.734"></a><span id="l22.734" class="difflineplus">+        m_data[mid + 1]++;</span>
<a href="#l22.735"></a><span id="l22.735">         Optimize();</span>
<a href="#l22.736"></a><span id="l22.736">         return 1;</span>
<a href="#l22.737"></a><span id="l22.737">       } else if (to == number) {</span>
<a href="#l22.738"></a><span id="l22.738">         /* This number is at the end of a long range (meaning a range</span>
<a href="#l22.739"></a><span id="l22.739">            which will still be long enough to remain a range.)</span>
<a href="#l22.740"></a><span id="l22.740">            Just decrease the length of the range. */</span>
<a href="#l22.741"></a><span id="l22.741">         m_data[mid]++;</span>
<a href="#l22.742"></a><span id="l22.742">         Optimize();</span>
<a href="#l22.743"></a><span id="l22.743" class="difflineat">@@ -830,41 +767,41 @@ nsMsgKeySet::Remove(int32_t number)</span>
<a href="#l22.744"></a><span id="l22.744">           if (!Grow())</span>
<a href="#l22.745"></a><span id="l22.745">             // out of memory</span>
<a href="#l22.746"></a><span id="l22.746">             return -1;</span>
<a href="#l22.747"></a><span id="l22.747">         }</span>
<a href="#l22.748"></a><span id="l22.748">         head = m_data;</span>
<a href="#l22.749"></a><span id="l22.749">         end = head + endo;</span>
<a href="#l22.750"></a><span id="l22.750"> </span>
<a href="#l22.751"></a><span id="l22.751">         for (i = m_length + 2; i &gt; mid + 2; i--) {</span>
<a href="#l22.752"></a><span id="l22.752" class="difflineminus">-          m_data[i] = m_data[i-2];</span>
<a href="#l22.753"></a><span id="l22.753" class="difflineplus">+          m_data[i] = m_data[i - 2];</span>
<a href="#l22.754"></a><span id="l22.754">         }</span>
<a href="#l22.755"></a><span id="l22.755"> </span>
<a href="#l22.756"></a><span id="l22.756" class="difflineminus">-        m_data[mid] = (- (number - from - 1));</span>
<a href="#l22.757"></a><span id="l22.757" class="difflineminus">-        m_data[mid+1] = from;</span>
<a href="#l22.758"></a><span id="l22.758" class="difflineminus">-        m_data[mid+2] = (- (to - number - 1));</span>
<a href="#l22.759"></a><span id="l22.759" class="difflineminus">-        m_data[mid+3] = number + 1;</span>
<a href="#l22.760"></a><span id="l22.760" class="difflineplus">+        m_data[mid] = (-(number - from - 1));</span>
<a href="#l22.761"></a><span id="l22.761" class="difflineplus">+        m_data[mid + 1] = from;</span>
<a href="#l22.762"></a><span id="l22.762" class="difflineplus">+        m_data[mid + 2] = (-(to - number - 1));</span>
<a href="#l22.763"></a><span id="l22.763" class="difflineplus">+        m_data[mid + 3] = number + 1;</span>
<a href="#l22.764"></a><span id="l22.764">         m_length += 2;</span>
<a href="#l22.765"></a><span id="l22.765"> </span>
<a href="#l22.766"></a><span id="l22.766">         /* Oops, if we've ended up with a range with a 0 length,</span>
<a href="#l22.767"></a><span id="l22.767">            which is illegal, convert it to a literal, which reduces</span>
<a href="#l22.768"></a><span id="l22.768">            the overall length by 1. */</span>
<a href="#l22.769"></a><span id="l22.769">         if (m_data[mid] == 0) {</span>
<a href="#l22.770"></a><span id="l22.770">           /* first range */</span>
<a href="#l22.771"></a><span id="l22.771" class="difflineminus">-          m_data[mid] = m_data[mid+1];</span>
<a href="#l22.772"></a><span id="l22.772" class="difflineplus">+          m_data[mid] = m_data[mid + 1];</span>
<a href="#l22.773"></a><span id="l22.773">           for (i = mid + 1; i &lt; m_length; i++) {</span>
<a href="#l22.774"></a><span id="l22.774" class="difflineminus">-            m_data[i] = m_data[i+1];</span>
<a href="#l22.775"></a><span id="l22.775" class="difflineplus">+            m_data[i] = m_data[i + 1];</span>
<a href="#l22.776"></a><span id="l22.776">           }</span>
<a href="#l22.777"></a><span id="l22.777">           m_length--;</span>
<a href="#l22.778"></a><span id="l22.778">         }</span>
<a href="#l22.779"></a><span id="l22.779" class="difflineminus">-        if (m_data[mid+2] == 0) {</span>
<a href="#l22.780"></a><span id="l22.780" class="difflineplus">+        if (m_data[mid + 2] == 0) {</span>
<a href="#l22.781"></a><span id="l22.781">           /* second range */</span>
<a href="#l22.782"></a><span id="l22.782" class="difflineminus">-          m_data[mid+2] = m_data[mid+3];</span>
<a href="#l22.783"></a><span id="l22.783" class="difflineplus">+          m_data[mid + 2] = m_data[mid + 3];</span>
<a href="#l22.784"></a><span id="l22.784">           for (i = mid + 3; i &lt; m_length; i++) {</span>
<a href="#l22.785"></a><span id="l22.785" class="difflineminus">-            m_data[i] = m_data[i+1];</span>
<a href="#l22.786"></a><span id="l22.786" class="difflineplus">+            m_data[i] = m_data[i + 1];</span>
<a href="#l22.787"></a><span id="l22.787">           }</span>
<a href="#l22.788"></a><span id="l22.788">           m_length--;</span>
<a href="#l22.789"></a><span id="l22.789">         }</span>
<a href="#l22.790"></a><span id="l22.790">         Optimize();</span>
<a href="#l22.791"></a><span id="l22.791">         return 1;</span>
<a href="#l22.792"></a><span id="l22.792">       }</span>
<a href="#l22.793"></a><span id="l22.793">     } else {</span>
<a href="#l22.794"></a><span id="l22.794">       /* it's a literal */</span>
<a href="#l22.795"></a><span id="l22.795" class="difflineat">@@ -872,82 +809,76 @@ nsMsgKeySet::Remove(int32_t number)</span>
<a href="#l22.796"></a><span id="l22.796">         /* Not this literal */</span>
<a href="#l22.797"></a><span id="l22.797">         tail++;</span>
<a href="#l22.798"></a><span id="l22.798">         continue;</span>
<a href="#l22.799"></a><span id="l22.799">       }</span>
<a href="#l22.800"></a><span id="l22.800"> </span>
<a href="#l22.801"></a><span id="l22.801">       /* Excise this literal. */</span>
<a href="#l22.802"></a><span id="l22.802">       m_length--;</span>
<a href="#l22.803"></a><span id="l22.803">       while (mid &lt; m_length) {</span>
<a href="#l22.804"></a><span id="l22.804" class="difflineminus">-        m_data[mid] = m_data[mid+1];</span>
<a href="#l22.805"></a><span id="l22.805" class="difflineplus">+        m_data[mid] = m_data[mid + 1];</span>
<a href="#l22.806"></a><span id="l22.806">         mid++;</span>
<a href="#l22.807"></a><span id="l22.807">       }</span>
<a href="#l22.808"></a><span id="l22.808">       Optimize();</span>
<a href="#l22.809"></a><span id="l22.809">       return 1;</span>
<a href="#l22.810"></a><span id="l22.810">     }</span>
<a href="#l22.811"></a><span id="l22.811">   }</span>
<a href="#l22.812"></a><span id="l22.812"> </span>
<a href="#l22.813"></a><span id="l22.813">   /* It wasn't here at all. */</span>
<a href="#l22.814"></a><span id="l22.814">   return 0;</span>
<a href="#l22.815"></a><span id="l22.815"> }</span>
<a href="#l22.816"></a><span id="l22.816"> </span>
<a href="#l22.817"></a><span id="l22.817" class="difflineminus">-</span>
<a href="#l22.818"></a><span id="l22.818" class="difflineminus">-static int32_t*</span>
<a href="#l22.819"></a><span id="l22.819" class="difflineminus">-msg_emit_range(int32_t* tmp, int32_t a, int32_t b)</span>
<a href="#l22.820"></a><span id="l22.820" class="difflineminus">-{</span>
<a href="#l22.821"></a><span id="l22.821" class="difflineplus">+static int32_t *msg_emit_range(int32_t *tmp, int32_t a, int32_t b) {</span>
<a href="#l22.822"></a><span id="l22.822">   if (a == b) {</span>
<a href="#l22.823"></a><span id="l22.823">     *tmp++ = a;</span>
<a href="#l22.824"></a><span id="l22.824">   } else {</span>
<a href="#l22.825"></a><span id="l22.825">     NS_ASSERTION(a &lt; b &amp;&amp; a &gt;= 0, &quot;range is out of order&quot;);</span>
<a href="#l22.826"></a><span id="l22.826">     *tmp++ = -(b - a);</span>
<a href="#l22.827"></a><span id="l22.827">     *tmp++ = a;</span>
<a href="#l22.828"></a><span id="l22.828">   }</span>
<a href="#l22.829"></a><span id="l22.829">   return tmp;</span>
<a href="#l22.830"></a><span id="l22.830"> }</span>
<a href="#l22.831"></a><span id="l22.831"> </span>
<a href="#l22.832"></a><span id="l22.832" class="difflineminus">-</span>
<a href="#l22.833"></a><span id="l22.833" class="difflineminus">-int</span>
<a href="#l22.834"></a><span id="l22.834" class="difflineminus">-nsMsgKeySet::AddRange(int32_t start, int32_t end)</span>
<a href="#l22.835"></a><span id="l22.835" class="difflineminus">-{</span>
<a href="#l22.836"></a><span id="l22.836" class="difflineplus">+int nsMsgKeySet::AddRange(int32_t start, int32_t end) {</span>
<a href="#l22.837"></a><span id="l22.837">   int32_t tmplength;</span>
<a href="#l22.838"></a><span id="l22.838" class="difflineminus">-  int32_t* tmp;</span>
<a href="#l22.839"></a><span id="l22.839" class="difflineminus">-  int32_t* in;</span>
<a href="#l22.840"></a><span id="l22.840" class="difflineminus">-  int32_t* out;</span>
<a href="#l22.841"></a><span id="l22.841" class="difflineminus">-  int32_t* tail;</span>
<a href="#l22.842"></a><span id="l22.842" class="difflineplus">+  int32_t *tmp;</span>
<a href="#l22.843"></a><span id="l22.843" class="difflineplus">+  int32_t *in;</span>
<a href="#l22.844"></a><span id="l22.844" class="difflineplus">+  int32_t *out;</span>
<a href="#l22.845"></a><span id="l22.845" class="difflineplus">+  int32_t *tail;</span>
<a href="#l22.846"></a><span id="l22.846">   int32_t a;</span>
<a href="#l22.847"></a><span id="l22.847">   int32_t b;</span>
<a href="#l22.848"></a><span id="l22.848">   bool didit = false;</span>
<a href="#l22.849"></a><span id="l22.849"> </span>
<a href="#l22.850"></a><span id="l22.850">   /* We're going to modify the set, so invalidate the cache. */</span>
<a href="#l22.851"></a><span id="l22.851">   m_cached_value = -1;</span>
<a href="#l22.852"></a><span id="l22.852"> </span>
<a href="#l22.853"></a><span id="l22.853">   NS_ASSERTION(start &lt;= end, &quot;invalid range&quot;);</span>
<a href="#l22.854"></a><span id="l22.854">   if (start &gt; end) return -1;</span>
<a href="#l22.855"></a><span id="l22.855"> </span>
<a href="#l22.856"></a><span id="l22.856">   if (start == end) {</span>
<a href="#l22.857"></a><span id="l22.857">     return Add(start);</span>
<a href="#l22.858"></a><span id="l22.858">   }</span>
<a href="#l22.859"></a><span id="l22.859"> </span>
<a href="#l22.860"></a><span id="l22.860">   tmplength = m_length + 2;</span>
<a href="#l22.861"></a><span id="l22.861" class="difflineminus">-  tmp = (int32_t*) PR_Malloc(sizeof(int32_t) * tmplength);</span>
<a href="#l22.862"></a><span id="l22.862" class="difflineplus">+  tmp = (int32_t *)PR_Malloc(sizeof(int32_t) * tmplength);</span>
<a href="#l22.863"></a><span id="l22.863"> </span>
<a href="#l22.864"></a><span id="l22.864">   if (!tmp)</span>
<a href="#l22.865"></a><span id="l22.865">     // out of memory</span>
<a href="#l22.866"></a><span id="l22.866">     return -1;</span>
<a href="#l22.867"></a><span id="l22.867"> </span>
<a href="#l22.868"></a><span id="l22.868">   in = m_data;</span>
<a href="#l22.869"></a><span id="l22.869">   out = tmp;</span>
<a href="#l22.870"></a><span id="l22.870">   tail = in + m_length;</span>
<a href="#l22.871"></a><span id="l22.871"> </span>
<a href="#l22.872"></a><span id="l22.872"> #define EMIT(x, y) out = msg_emit_range(out, x, y)</span>
<a href="#l22.873"></a><span id="l22.873"> </span>
<a href="#l22.874"></a><span id="l22.874">   while (in &lt; tail) {</span>
<a href="#l22.875"></a><span id="l22.875">     // Set [a,b] to be this range.</span>
<a href="#l22.876"></a><span id="l22.876">     if (*in &lt; 0) {</span>
<a href="#l22.877"></a><span id="l22.877" class="difflineminus">-      b = - *in++;</span>
<a href="#l22.878"></a><span id="l22.878" class="difflineplus">+      b = -*in++;</span>
<a href="#l22.879"></a><span id="l22.879">       a = *in++;</span>
<a href="#l22.880"></a><span id="l22.880">       b += a;</span>
<a href="#l22.881"></a><span id="l22.881">     } else {</span>
<a href="#l22.882"></a><span id="l22.882">       a = b = *in++;</span>
<a href="#l22.883"></a><span id="l22.883">     }</span>
<a href="#l22.884"></a><span id="l22.884"> </span>
<a href="#l22.885"></a><span id="l22.885">     if (a &lt;= start &amp;&amp; b &gt;= end) {</span>
<a href="#l22.886"></a><span id="l22.886">       // We already have the entire range marked.</span>
<a href="#l22.887"></a><span id="l22.887" class="difflineat">@@ -982,60 +913,56 @@ nsMsgKeySet::AddRange(int32_t start, int</span>
<a href="#l22.888"></a><span id="l22.888">   m_length = out - tmp;</span>
<a href="#l22.889"></a><span id="l22.889">   m_data_size = tmplength;</span>
<a href="#l22.890"></a><span id="l22.890"> #ifdef NEWSRC_DOES_HOST_STUFF</span>
<a href="#l22.891"></a><span id="l22.891">   if (m_host) m_host-&gt;MarkDirty();</span>
<a href="#l22.892"></a><span id="l22.892"> #endif</span>
<a href="#l22.893"></a><span id="l22.893">   return 1;</span>
<a href="#l22.894"></a><span id="l22.894"> }</span>
<a href="#l22.895"></a><span id="l22.895"> </span>
<a href="#l22.896"></a><span id="l22.896" class="difflineminus">-int32_t</span>
<a href="#l22.897"></a><span id="l22.897" class="difflineminus">-nsMsgKeySet::CountMissingInRange(int32_t range_start, int32_t range_end)</span>
<a href="#l22.898"></a><span id="l22.898" class="difflineminus">-{</span>
<a href="#l22.899"></a><span id="l22.899" class="difflineplus">+int32_t nsMsgKeySet::CountMissingInRange(int32_t range_start,</span>
<a href="#l22.900"></a><span id="l22.900" class="difflineplus">+                                         int32_t range_end) {</span>
<a href="#l22.901"></a><span id="l22.901">   int32_t count;</span>
<a href="#l22.902"></a><span id="l22.902">   int32_t *head;</span>
<a href="#l22.903"></a><span id="l22.903">   int32_t *tail;</span>
<a href="#l22.904"></a><span id="l22.904">   int32_t *end;</span>
<a href="#l22.905"></a><span id="l22.905"> </span>
<a href="#l22.906"></a><span id="l22.906" class="difflineminus">-  NS_ASSERTION (range_start &gt;= 0 &amp;&amp; range_end &gt;= 0 &amp;&amp; range_end &gt;= range_start, &quot;invalid range&quot;);</span>
<a href="#l22.907"></a><span id="l22.907" class="difflineplus">+  NS_ASSERTION(range_start &gt;= 0 &amp;&amp; range_end &gt;= 0 &amp;&amp; range_end &gt;= range_start,</span>
<a href="#l22.908"></a><span id="l22.908" class="difflineplus">+               &quot;invalid range&quot;);</span>
<a href="#l22.909"></a><span id="l22.909">   if (range_start &lt; 0 || range_end &lt; 0 || range_end &lt; range_start) return -1;</span>
<a href="#l22.910"></a><span id="l22.910"> </span>
<a href="#l22.911"></a><span id="l22.911">   head = m_data;</span>
<a href="#l22.912"></a><span id="l22.912">   tail = head;</span>
<a href="#l22.913"></a><span id="l22.913">   end = head + m_length;</span>
<a href="#l22.914"></a><span id="l22.914"> </span>
<a href="#l22.915"></a><span id="l22.915">   count = range_end - range_start + 1;</span>
<a href="#l22.916"></a><span id="l22.916"> </span>
<a href="#l22.917"></a><span id="l22.917">   while (tail &lt; end) {</span>
<a href="#l22.918"></a><span id="l22.918">     if (*tail &lt; 0) {</span>
<a href="#l22.919"></a><span id="l22.919">       /* it's a range */</span>
<a href="#l22.920"></a><span id="l22.920">       int32_t from = tail[1];</span>
<a href="#l22.921"></a><span id="l22.921">       int32_t to = from + (-(tail[0]));</span>
<a href="#l22.922"></a><span id="l22.922">       if (from &lt; range_start) from = range_start;</span>
<a href="#l22.923"></a><span id="l22.923">       if (to &gt; range_end) to = range_end;</span>
<a href="#l22.924"></a><span id="l22.924"> </span>
<a href="#l22.925"></a><span id="l22.925" class="difflineminus">-      if (to &gt;= from)</span>
<a href="#l22.926"></a><span id="l22.926" class="difflineminus">-        count -= (to - from + 1);</span>
<a href="#l22.927"></a><span id="l22.927" class="difflineplus">+      if (to &gt;= from) count -= (to - from + 1);</span>
<a href="#l22.928"></a><span id="l22.928"> </span>
<a href="#l22.929"></a><span id="l22.929">       tail += 2;</span>
<a href="#l22.930"></a><span id="l22.930">     } else {</span>
<a href="#l22.931"></a><span id="l22.931">       /* it's a literal */</span>
<a href="#l22.932"></a><span id="l22.932">       if (*tail &gt;= range_start &amp;&amp; *tail &lt;= range_end) count--;</span>
<a href="#l22.933"></a><span id="l22.933">       tail++;</span>
<a href="#l22.934"></a><span id="l22.934">     }</span>
<a href="#l22.935"></a><span id="l22.935" class="difflineminus">-    NS_ASSERTION (count &gt;= 0, &quot;invalid count&quot;);</span>
<a href="#l22.936"></a><span id="l22.936" class="difflineplus">+    NS_ASSERTION(count &gt;= 0, &quot;invalid count&quot;);</span>
<a href="#l22.937"></a><span id="l22.937">   }</span>
<a href="#l22.938"></a><span id="l22.938">   return count;</span>
<a href="#l22.939"></a><span id="l22.939"> }</span>
<a href="#l22.940"></a><span id="l22.940"> </span>
<a href="#l22.941"></a><span id="l22.941" class="difflineminus">-</span>
<a href="#l22.942"></a><span id="l22.942" class="difflineminus">-int</span>
<a href="#l22.943"></a><span id="l22.943" class="difflineminus">-nsMsgKeySet::FirstMissingRange(int32_t min, int32_t max,</span>
<a href="#l22.944"></a><span id="l22.944" class="difflineminus">-                  int32_t* first, int32_t* last)</span>
<a href="#l22.945"></a><span id="l22.945" class="difflineminus">-{</span>
<a href="#l22.946"></a><span id="l22.946" class="difflineplus">+int nsMsgKeySet::FirstMissingRange(int32_t min, int32_t max, int32_t *first,</span>
<a href="#l22.947"></a><span id="l22.947" class="difflineplus">+                                   int32_t *last) {</span>
<a href="#l22.948"></a><span id="l22.948">   int32_t size;</span>
<a href="#l22.949"></a><span id="l22.949">   int32_t *head;</span>
<a href="#l22.950"></a><span id="l22.950">   int32_t *tail;</span>
<a href="#l22.951"></a><span id="l22.951">   int32_t *end;</span>
<a href="#l22.952"></a><span id="l22.952">   int32_t from = 0;</span>
<a href="#l22.953"></a><span id="l22.953">   int32_t to = 0;</span>
<a href="#l22.954"></a><span id="l22.954">   int32_t a;</span>
<a href="#l22.955"></a><span id="l22.955">   int32_t b;</span>
<a href="#l22.956"></a><span id="l22.956" class="difflineat">@@ -1050,29 +977,29 @@ nsMsgKeySet::FirstMissingRange(int32_t m</span>
<a href="#l22.957"></a><span id="l22.957"> </span>
<a href="#l22.958"></a><span id="l22.958">   size = m_length;</span>
<a href="#l22.959"></a><span id="l22.959">   head = m_data;</span>
<a href="#l22.960"></a><span id="l22.960">   tail = head;</span>
<a href="#l22.961"></a><span id="l22.961">   end = head + size;</span>
<a href="#l22.962"></a><span id="l22.962"> </span>
<a href="#l22.963"></a><span id="l22.963">   while (tail &lt; end) {</span>
<a href="#l22.964"></a><span id="l22.964">     a = to + 1;</span>
<a href="#l22.965"></a><span id="l22.965" class="difflineminus">-    if (*tail &lt; 0) {      /* We got a range. */</span>
<a href="#l22.966"></a><span id="l22.966" class="difflineplus">+    if (*tail &lt; 0) { /* We got a range. */</span>
<a href="#l22.967"></a><span id="l22.967">       from = tail[1];</span>
<a href="#l22.968"></a><span id="l22.968">       to = from + (-(tail[0]));</span>
<a href="#l22.969"></a><span id="l22.969">       tail += 2;</span>
<a href="#l22.970"></a><span id="l22.970">     } else {</span>
<a href="#l22.971"></a><span id="l22.971">       from = to = tail[0];</span>
<a href="#l22.972"></a><span id="l22.972">       tail++;</span>
<a href="#l22.973"></a><span id="l22.973">     }</span>
<a href="#l22.974"></a><span id="l22.974">     b = from - 1;</span>
<a href="#l22.975"></a><span id="l22.975">     /* At this point, [a,b] is the range of unread articles just before</span>
<a href="#l22.976"></a><span id="l22.976">        the current range of read articles [from,to].  See if this range</span>
<a href="#l22.977"></a><span id="l22.977">        intersects the [min,max] range we were given. */</span>
<a href="#l22.978"></a><span id="l22.978" class="difflineminus">-    if (a &gt; max) return 0;  /* It's hopeless; there are none. */</span>
<a href="#l22.979"></a><span id="l22.979" class="difflineplus">+    if (a &gt; max) return 0; /* It's hopeless; there are none. */</span>
<a href="#l22.980"></a><span id="l22.980">     if (a &lt;= b &amp;&amp; b &gt;= min) {</span>
<a href="#l22.981"></a><span id="l22.981">       /* Ah-hah!  We found an intersection. */</span>
<a href="#l22.982"></a><span id="l22.982">       *first = a &gt; min ? a : min;</span>
<a href="#l22.983"></a><span id="l22.983">       *last = b &lt; max ? b : max;</span>
<a href="#l22.984"></a><span id="l22.984">       return 0;</span>
<a href="#l22.985"></a><span id="l22.985">     }</span>
<a href="#l22.986"></a><span id="l22.986">   }</span>
<a href="#l22.987"></a><span id="l22.987">   /* We found no holes in the newsrc that overlaps the range, nor did we hit</span>
<a href="#l22.988"></a><span id="l22.988" class="difflineat">@@ -1082,173 +1009,157 @@ nsMsgKeySet::FirstMissingRange(int32_t m</span>
<a href="#l22.989"></a><span id="l22.989">   a = to + 1;</span>
<a href="#l22.990"></a><span id="l22.990">   *first = a &gt; min ? a : min;</span>
<a href="#l22.991"></a><span id="l22.991">   *last = max;</span>
<a href="#l22.992"></a><span id="l22.992">   return 0;</span>
<a href="#l22.993"></a><span id="l22.993"> }</span>
<a href="#l22.994"></a><span id="l22.994"> </span>
<a href="#l22.995"></a><span id="l22.995"> // I'm guessing we didn't include this because we didn't think we're going</span>
<a href="#l22.996"></a><span id="l22.996"> // to need it. I'm not so sure. I'm putting it in for now.</span>
<a href="#l22.997"></a><span id="l22.997" class="difflineminus">-int</span>
<a href="#l22.998"></a><span id="l22.998" class="difflineminus">-nsMsgKeySet::LastMissingRange(int32_t min, int32_t max,</span>
<a href="#l22.999"></a><span id="l22.999" class="difflineminus">-                  int32_t* first, int32_t* last)</span>
<a href="#l22.1000"></a><span id="l22.1000" class="difflineminus">-{</span>
<a href="#l22.1001"></a><span id="l22.1001" class="difflineplus">+int nsMsgKeySet::LastMissingRange(int32_t min, int32_t max, int32_t *first,</span>
<a href="#l22.1002"></a><span id="l22.1002" class="difflineplus">+                                  int32_t *last) {</span>
<a href="#l22.1003"></a><span id="l22.1003">   int32_t size;</span>
<a href="#l22.1004"></a><span id="l22.1004">   int32_t *head;</span>
<a href="#l22.1005"></a><span id="l22.1005">   int32_t *tail;</span>
<a href="#l22.1006"></a><span id="l22.1006">   int32_t *end;</span>
<a href="#l22.1007"></a><span id="l22.1007">   int32_t from = 0;</span>
<a href="#l22.1008"></a><span id="l22.1008">   int32_t to = 0;</span>
<a href="#l22.1009"></a><span id="l22.1009">   int32_t a;</span>
<a href="#l22.1010"></a><span id="l22.1010">   int32_t b;</span>
<a href="#l22.1011"></a><span id="l22.1011"> </span>
<a href="#l22.1012"></a><span id="l22.1012">   NS_ASSERTION(first &amp;&amp; last, &quot;invalid null param&quot;);</span>
<a href="#l22.1013"></a><span id="l22.1013">   if (!first || !last) return -1;</span>
<a href="#l22.1014"></a><span id="l22.1014"> </span>
<a href="#l22.1015"></a><span id="l22.1015">   *first = *last = 0;</span>
<a href="#l22.1016"></a><span id="l22.1016"> </span>
<a href="#l22.1017"></a><span id="l22.1017" class="difflineminus">-</span>
<a href="#l22.1018"></a><span id="l22.1018">   NS_ASSERTION(min &lt;= max &amp;&amp; min &gt; 0, &quot;invalid min or max&quot;);</span>
<a href="#l22.1019"></a><span id="l22.1019">   if (min &gt; max || min &lt;= 0) return -1;</span>
<a href="#l22.1020"></a><span id="l22.1020"> </span>
<a href="#l22.1021"></a><span id="l22.1021">   size = m_length;</span>
<a href="#l22.1022"></a><span id="l22.1022">   head = m_data;</span>
<a href="#l22.1023"></a><span id="l22.1023">   tail = head;</span>
<a href="#l22.1024"></a><span id="l22.1024">   end = head + size;</span>
<a href="#l22.1025"></a><span id="l22.1025"> </span>
<a href="#l22.1026"></a><span id="l22.1026">   while (tail &lt; end) {</span>
<a href="#l22.1027"></a><span id="l22.1027" class="difflineminus">-  a = to + 1;</span>
<a href="#l22.1028"></a><span id="l22.1028" class="difflineminus">-  if (*tail &lt; 0) {      /* We got a range. */</span>
<a href="#l22.1029"></a><span id="l22.1029" class="difflineminus">-    from = tail[1];</span>
<a href="#l22.1030"></a><span id="l22.1030" class="difflineminus">-    to = from + (-(tail[0]));</span>
<a href="#l22.1031"></a><span id="l22.1031" class="difflineminus">-    tail += 2;</span>
<a href="#l22.1032"></a><span id="l22.1032" class="difflineminus">-  } else {</span>
<a href="#l22.1033"></a><span id="l22.1033" class="difflineminus">-    from = to = tail[0];</span>
<a href="#l22.1034"></a><span id="l22.1034" class="difflineminus">-    tail++;</span>
<a href="#l22.1035"></a><span id="l22.1035" class="difflineminus">-  }</span>
<a href="#l22.1036"></a><span id="l22.1036" class="difflineminus">-  b = from - 1;</span>
<a href="#l22.1037"></a><span id="l22.1037" class="difflineminus">-  /* At this point, [a,b] is the range of unread articles just before</span>
<a href="#l22.1038"></a><span id="l22.1038" class="difflineminus">-     the current range of read articles [from,to].  See if this range</span>
<a href="#l22.1039"></a><span id="l22.1039" class="difflineminus">-     intersects the [min,max] range we were given. */</span>
<a href="#l22.1040"></a><span id="l22.1040" class="difflineminus">-  if (a &gt; max) return 0;  /* We're done.  If we found something, it's already</span>
<a href="#l22.1041"></a><span id="l22.1041" class="difflineminus">-                 sitting in [*first,*last]. */</span>
<a href="#l22.1042"></a><span id="l22.1042" class="difflineminus">-  if (a &lt;= b &amp;&amp; b &gt;= min) {</span>
<a href="#l22.1043"></a><span id="l22.1043" class="difflineminus">-    /* Ah-hah!  We found an intersection. */</span>
<a href="#l22.1044"></a><span id="l22.1044" class="difflineminus">-    *first = a &gt; min ? a : min;</span>
<a href="#l22.1045"></a><span id="l22.1045" class="difflineminus">-    *last = b &lt; max ? b : max;</span>
<a href="#l22.1046"></a><span id="l22.1046" class="difflineminus">-    /* Continue on, looking for a later range. */</span>
<a href="#l22.1047"></a><span id="l22.1047" class="difflineminus">-  }</span>
<a href="#l22.1048"></a><span id="l22.1048" class="difflineplus">+    a = to + 1;</span>
<a href="#l22.1049"></a><span id="l22.1049" class="difflineplus">+    if (*tail &lt; 0) { /* We got a range. */</span>
<a href="#l22.1050"></a><span id="l22.1050" class="difflineplus">+      from = tail[1];</span>
<a href="#l22.1051"></a><span id="l22.1051" class="difflineplus">+      to = from + (-(tail[0]));</span>
<a href="#l22.1052"></a><span id="l22.1052" class="difflineplus">+      tail += 2;</span>
<a href="#l22.1053"></a><span id="l22.1053" class="difflineplus">+    } else {</span>
<a href="#l22.1054"></a><span id="l22.1054" class="difflineplus">+      from = to = tail[0];</span>
<a href="#l22.1055"></a><span id="l22.1055" class="difflineplus">+      tail++;</span>
<a href="#l22.1056"></a><span id="l22.1056" class="difflineplus">+    }</span>
<a href="#l22.1057"></a><span id="l22.1057" class="difflineplus">+    b = from - 1;</span>
<a href="#l22.1058"></a><span id="l22.1058" class="difflineplus">+    /* At this point, [a,b] is the range of unread articles just before</span>
<a href="#l22.1059"></a><span id="l22.1059" class="difflineplus">+       the current range of read articles [from,to]. See if this range</span>
<a href="#l22.1060"></a><span id="l22.1060" class="difflineplus">+       intersects the [min,max] range we were given. */</span>
<a href="#l22.1061"></a><span id="l22.1061" class="difflineplus">+    if (a &gt; max)</span>
<a href="#l22.1062"></a><span id="l22.1062" class="difflineplus">+      return 0; /* We're done. If we found something, it's already</span>
<a href="#l22.1063"></a><span id="l22.1063" class="difflineplus">+                   sitting in [*first,*last]. */</span>
<a href="#l22.1064"></a><span id="l22.1064" class="difflineplus">+    if (a &lt;= b &amp;&amp; b &gt;= min) {</span>
<a href="#l22.1065"></a><span id="l22.1065" class="difflineplus">+      /* Ah-hah! We found an intersection. */</span>
<a href="#l22.1066"></a><span id="l22.1066" class="difflineplus">+      *first = a &gt; min ? a : min;</span>
<a href="#l22.1067"></a><span id="l22.1067" class="difflineplus">+      *last = b &lt; max ? b : max;</span>
<a href="#l22.1068"></a><span id="l22.1068" class="difflineplus">+      /* Continue on, looking for a later range. */</span>
<a href="#l22.1069"></a><span id="l22.1069" class="difflineplus">+    }</span>
<a href="#l22.1070"></a><span id="l22.1070">   }</span>
<a href="#l22.1071"></a><span id="l22.1071">   if (to &lt; max) {</span>
<a href="#l22.1072"></a><span id="l22.1072" class="difflineminus">-  /* The great infinite range of unread articles at the end of any newsrc</span>
<a href="#l22.1073"></a><span id="l22.1073" class="difflineminus">-     line intersects the range we want, and we just need to return that. */</span>
<a href="#l22.1074"></a><span id="l22.1074" class="difflineminus">-  a = to + 1;</span>
<a href="#l22.1075"></a><span id="l22.1075" class="difflineminus">-  *first = a &gt; min ? a : min;</span>
<a href="#l22.1076"></a><span id="l22.1076" class="difflineminus">-  *last = max;</span>
<a href="#l22.1077"></a><span id="l22.1077" class="difflineplus">+    /* The great infinite range of unread articles at the end of any newsrc</span>
<a href="#l22.1078"></a><span id="l22.1078" class="difflineplus">+       line intersects the range we want, and we just need to return that. */</span>
<a href="#l22.1079"></a><span id="l22.1079" class="difflineplus">+    a = to + 1;</span>
<a href="#l22.1080"></a><span id="l22.1080" class="difflineplus">+    *first = a &gt; min ? a : min;</span>
<a href="#l22.1081"></a><span id="l22.1081" class="difflineplus">+    *last = max;</span>
<a href="#l22.1082"></a><span id="l22.1082">   }</span>
<a href="#l22.1083"></a><span id="l22.1083">   return 0;</span>
<a href="#l22.1084"></a><span id="l22.1084"> }</span>
<a href="#l22.1085"></a><span id="l22.1085"> </span>
<a href="#l22.1086"></a><span id="l22.1086"> /**</span>
<a href="#l22.1087"></a><span id="l22.1087">  * Fill the passed in aArray with the keys in the message key set.</span>
<a href="#l22.1088"></a><span id="l22.1088">  */</span>
<a href="#l22.1089"></a><span id="l22.1089" class="difflineminus">-nsresult</span>
<a href="#l22.1090"></a><span id="l22.1090" class="difflineminus">-nsMsgKeySet::ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt; &amp;aArray)</span>
<a href="#l22.1091"></a><span id="l22.1091" class="difflineminus">-{</span>
<a href="#l22.1092"></a><span id="l22.1092" class="difflineminus">-    int32_t size;</span>
<a href="#l22.1093"></a><span id="l22.1093" class="difflineminus">-    int32_t *head;</span>
<a href="#l22.1094"></a><span id="l22.1094" class="difflineminus">-    int32_t *tail;</span>
<a href="#l22.1095"></a><span id="l22.1095" class="difflineminus">-    int32_t *end;</span>
<a href="#l22.1096"></a><span id="l22.1096" class="difflineminus">-    int32_t last_art = -1;</span>
<a href="#l22.1097"></a><span id="l22.1097" class="difflineplus">+nsresult nsMsgKeySet::ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt; &amp;aArray) {</span>
<a href="#l22.1098"></a><span id="l22.1098" class="difflineplus">+  int32_t size;</span>
<a href="#l22.1099"></a><span id="l22.1099" class="difflineplus">+  int32_t *head;</span>
<a href="#l22.1100"></a><span id="l22.1100" class="difflineplus">+  int32_t *tail;</span>
<a href="#l22.1101"></a><span id="l22.1101" class="difflineplus">+  int32_t *end;</span>
<a href="#l22.1102"></a><span id="l22.1102" class="difflineplus">+  int32_t last_art = -1;</span>
<a href="#l22.1103"></a><span id="l22.1103" class="difflineplus">+</span>
<a href="#l22.1104"></a><span id="l22.1104" class="difflineplus">+  size = m_length;</span>
<a href="#l22.1105"></a><span id="l22.1105" class="difflineplus">+  head = m_data;</span>
<a href="#l22.1106"></a><span id="l22.1106" class="difflineplus">+  tail = head;</span>
<a href="#l22.1107"></a><span id="l22.1107" class="difflineplus">+  end = head + size;</span>
<a href="#l22.1108"></a><span id="l22.1108" class="difflineplus">+</span>
<a href="#l22.1109"></a><span id="l22.1109" class="difflineplus">+  while (tail &lt; end) {</span>
<a href="#l22.1110"></a><span id="l22.1110" class="difflineplus">+    int32_t from;</span>
<a href="#l22.1111"></a><span id="l22.1111" class="difflineplus">+    int32_t to;</span>
<a href="#l22.1112"></a><span id="l22.1112"> </span>
<a href="#l22.1113"></a><span id="l22.1113" class="difflineminus">-    size = m_length;</span>
<a href="#l22.1114"></a><span id="l22.1114" class="difflineminus">-    head = m_data;</span>
<a href="#l22.1115"></a><span id="l22.1115" class="difflineminus">-    tail = head;</span>
<a href="#l22.1116"></a><span id="l22.1116" class="difflineminus">-    end = head + size;</span>
<a href="#l22.1117"></a><span id="l22.1117" class="difflineminus">-</span>
<a href="#l22.1118"></a><span id="l22.1118" class="difflineminus">-    while (tail &lt; end) {</span>
<a href="#l22.1119"></a><span id="l22.1119" class="difflineminus">-        int32_t from;</span>
<a href="#l22.1120"></a><span id="l22.1120" class="difflineminus">-        int32_t to;</span>
<a href="#l22.1121"></a><span id="l22.1121" class="difflineminus">-</span>
<a href="#l22.1122"></a><span id="l22.1122" class="difflineminus">-        if (*tail &lt; 0) {</span>
<a href="#l22.1123"></a><span id="l22.1123" class="difflineminus">-            /* it's a range */</span>
<a href="#l22.1124"></a><span id="l22.1124" class="difflineminus">-            from = tail[1];</span>
<a href="#l22.1125"></a><span id="l22.1125" class="difflineminus">-            to = from + (-(tail[0]));</span>
<a href="#l22.1126"></a><span id="l22.1126" class="difflineminus">-            tail += 2;</span>
<a href="#l22.1127"></a><span id="l22.1127" class="difflineplus">+    if (*tail &lt; 0) {</span>
<a href="#l22.1128"></a><span id="l22.1128" class="difflineplus">+      /* it's a range */</span>
<a href="#l22.1129"></a><span id="l22.1129" class="difflineplus">+      from = tail[1];</span>
<a href="#l22.1130"></a><span id="l22.1130" class="difflineplus">+      to = from + (-(tail[0]));</span>
<a href="#l22.1131"></a><span id="l22.1131" class="difflineplus">+      tail += 2;</span>
<a href="#l22.1132"></a><span id="l22.1132" class="difflineplus">+    } else /* it's a literal */</span>
<a href="#l22.1133"></a><span id="l22.1133" class="difflineplus">+    {</span>
<a href="#l22.1134"></a><span id="l22.1134" class="difflineplus">+      from = *tail;</span>
<a href="#l22.1135"></a><span id="l22.1135" class="difflineplus">+      to = from;</span>
<a href="#l22.1136"></a><span id="l22.1136" class="difflineplus">+      tail++;</span>
<a href="#l22.1137"></a><span id="l22.1137" class="difflineplus">+    }</span>
<a href="#l22.1138"></a><span id="l22.1138" class="difflineplus">+    // The horrible news-hack used to adjust from to 1 if it was zero right</span>
<a href="#l22.1139"></a><span id="l22.1139" class="difflineplus">+    // here, but there is no longer a consumer of this method with that</span>
<a href="#l22.1140"></a><span id="l22.1140" class="difflineplus">+    // broken use-case.</span>
<a href="#l22.1141"></a><span id="l22.1141" class="difflineplus">+    if (from &lt;= last_art) from = last_art + 1;</span>
<a href="#l22.1142"></a><span id="l22.1142" class="difflineplus">+    if (from &lt;= to) {</span>
<a href="#l22.1143"></a><span id="l22.1143" class="difflineplus">+      if (from &lt; to) {</span>
<a href="#l22.1144"></a><span id="l22.1144" class="difflineplus">+        for (int32_t i = from; i &lt;= to; ++i) {</span>
<a href="#l22.1145"></a><span id="l22.1145" class="difflineplus">+          aArray.AppendElement(i);</span>
<a href="#l22.1146"></a><span id="l22.1146">         }</span>
<a href="#l22.1147"></a><span id="l22.1147" class="difflineminus">-        else /* it's a literal */</span>
<a href="#l22.1148"></a><span id="l22.1148" class="difflineminus">-            {</span>
<a href="#l22.1149"></a><span id="l22.1149" class="difflineminus">-                from = *tail;</span>
<a href="#l22.1150"></a><span id="l22.1150" class="difflineminus">-                to = from;</span>
<a href="#l22.1151"></a><span id="l22.1151" class="difflineminus">-                tail++;</span>
<a href="#l22.1152"></a><span id="l22.1152" class="difflineminus">-            }</span>
<a href="#l22.1153"></a><span id="l22.1153" class="difflineminus">-        // The horrible news-hack used to adjust from to 1 if it was zero right</span>
<a href="#l22.1154"></a><span id="l22.1154" class="difflineminus">-        // here, but there is no longer a consumer of this method with that</span>
<a href="#l22.1155"></a><span id="l22.1155" class="difflineminus">-        // broken use-case.</span>
<a href="#l22.1156"></a><span id="l22.1156" class="difflineminus">-        if (from &lt;= last_art) from = last_art + 1;</span>
<a href="#l22.1157"></a><span id="l22.1157" class="difflineminus">-        if (from &lt;= to) {</span>
<a href="#l22.1158"></a><span id="l22.1158" class="difflineminus">-            if (from &lt; to) {</span>
<a href="#l22.1159"></a><span id="l22.1159" class="difflineminus">-                for (int32_t i = from; i &lt;= to ; ++i ) {</span>
<a href="#l22.1160"></a><span id="l22.1160" class="difflineminus">-                    aArray.AppendElement(i);</span>
<a href="#l22.1161"></a><span id="l22.1161" class="difflineminus">-                }</span>
<a href="#l22.1162"></a><span id="l22.1162" class="difflineminus">-            } else {</span>
<a href="#l22.1163"></a><span id="l22.1163" class="difflineminus">-                aArray.AppendElement(from);</span>
<a href="#l22.1164"></a><span id="l22.1164" class="difflineminus">-            }</span>
<a href="#l22.1165"></a><span id="l22.1165" class="difflineminus">-            last_art = to;</span>
<a href="#l22.1166"></a><span id="l22.1166" class="difflineminus">-        }</span>
<a href="#l22.1167"></a><span id="l22.1167" class="difflineplus">+      } else {</span>
<a href="#l22.1168"></a><span id="l22.1168" class="difflineplus">+        aArray.AppendElement(from);</span>
<a href="#l22.1169"></a><span id="l22.1169" class="difflineplus">+      }</span>
<a href="#l22.1170"></a><span id="l22.1170" class="difflineplus">+      last_art = to;</span>
<a href="#l22.1171"></a><span id="l22.1171">     }</span>
<a href="#l22.1172"></a><span id="l22.1172" class="difflineplus">+  }</span>
<a href="#l22.1173"></a><span id="l22.1173"> </span>
<a href="#l22.1174"></a><span id="l22.1174" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.1175"></a><span id="l22.1175" class="difflineplus">+  return NS_OK;</span>
<a href="#l22.1176"></a><span id="l22.1176"> }</span>
<a href="#l22.1177"></a><span id="l22.1177"> </span>
<a href="#l22.1178"></a><span id="l22.1178" class="difflineminus">-</span>
<a href="#l22.1179"></a><span id="l22.1179"> #ifdef DEBUG /* A lot of test cases for the above */</span>
<a href="#l22.1180"></a><span id="l22.1180"> </span>
<a href="#l22.1181"></a><span id="l22.1181" class="difflineminus">-#define countof(x) (sizeof(x) / sizeof(*(x)))</span>
<a href="#l22.1182"></a><span id="l22.1182" class="difflineplus">+#  define countof(x) (sizeof(x) / sizeof(*(x)))</span>
<a href="#l22.1183"></a><span id="l22.1183"> </span>
<a href="#l22.1184"></a><span id="l22.1184" class="difflineminus">-void</span>
<a href="#l22.1185"></a><span id="l22.1185" class="difflineminus">-nsMsgKeySet::test_decoder (const char *string)</span>
<a href="#l22.1186"></a><span id="l22.1186" class="difflineminus">-{</span>
<a href="#l22.1187"></a><span id="l22.1187" class="difflineplus">+void nsMsgKeySet::test_decoder(const char *string) {</span>
<a href="#l22.1188"></a><span id="l22.1188">   nsMsgKeySet set(string /* , NULL */);</span>
<a href="#l22.1189"></a><span id="l22.1189" class="difflineminus">-  char* tmp;</span>
<a href="#l22.1190"></a><span id="l22.1190" class="difflineplus">+  char *tmp;</span>
<a href="#l22.1191"></a><span id="l22.1191">   set.Output(&amp;tmp);</span>
<a href="#l22.1192"></a><span id="l22.1192" class="difflineminus">-  printf (&quot;\t\&quot;%s\&quot;\t--&gt; \&quot;%s\&quot;\n&quot;, string, tmp);</span>
<a href="#l22.1193"></a><span id="l22.1193" class="difflineplus">+  printf(&quot;\t\&quot;%s\&quot;\t--&gt; \&quot;%s\&quot;\n&quot;, string, tmp);</span>
<a href="#l22.1194"></a><span id="l22.1194">   free(tmp);</span>
<a href="#l22.1195"></a><span id="l22.1195"> }</span>
<a href="#l22.1196"></a><span id="l22.1196"> </span>
<a href="#l22.1197"></a><span id="l22.1197" class="difflineminus">-</span>
<a href="#l22.1198"></a><span id="l22.1198" class="difflineminus">-#define START(STRING) \</span>
<a href="#l22.1199"></a><span id="l22.1199" class="difflineminus">-  string = STRING;    \</span>
<a href="#l22.1200"></a><span id="l22.1200" class="difflineminus">-  if (!(set = nsMsgKeySet::Create(string))) abort ()</span>
<a href="#l22.1201"></a><span id="l22.1201" class="difflineplus">+#  define START(STRING) \</span>
<a href="#l22.1202"></a><span id="l22.1202" class="difflineplus">+    string = STRING;    \</span>
<a href="#l22.1203"></a><span id="l22.1203" class="difflineplus">+    if (!(set = nsMsgKeySet::Create(string))) abort()</span>
<a href="#l22.1204"></a><span id="l22.1204"> </span>
<a href="#l22.1205"></a><span id="l22.1205" class="difflineminus">-#define FROB(N,PUSHP)                  \</span>
<a href="#l22.1206"></a><span id="l22.1206" class="difflineminus">-  i = N;                        \</span>
<a href="#l22.1207"></a><span id="l22.1207" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1208"></a><span id="l22.1208" class="difflineminus">-  printf (&quot;%3lu: %-58s %c %3lu =\n&quot;, (unsigned long)set-&gt;m_length, s,  \</span>
<a href="#l22.1209"></a><span id="l22.1209" class="difflineminus">-      (PUSHP ? '+' : '-'), (unsigned long)i);            \</span>
<a href="#l22.1210"></a><span id="l22.1210" class="difflineminus">-  free(s);                      \</span>
<a href="#l22.1211"></a><span id="l22.1211" class="difflineminus">-  if (PUSHP                        \</span>
<a href="#l22.1212"></a><span id="l22.1212" class="difflineminus">-    ? set-&gt;Add(i) &lt; 0                  \</span>
<a href="#l22.1213"></a><span id="l22.1213" class="difflineminus">-    : set-&gt;Remove(i) &lt; 0)                \</span>
<a href="#l22.1214"></a><span id="l22.1214" class="difflineminus">-  abort ();                      \</span>
<a href="#l22.1215"></a><span id="l22.1215" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1216"></a><span id="l22.1216" class="difflineminus">-  printf (&quot;%3lu: %-58s optimized =\n&quot;, (unsigned long)set-&gt;m_length, s);  \</span>
<a href="#l22.1217"></a><span id="l22.1217" class="difflineminus">-  free(s);                      \</span>
<a href="#l22.1218"></a><span id="l22.1218" class="difflineplus">+#  define FROB(N, PUSHP)                                                  \</span>
<a href="#l22.1219"></a><span id="l22.1219" class="difflineplus">+    i = N;                                                                \</span>
<a href="#l22.1220"></a><span id="l22.1220" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();                        \</span>
<a href="#l22.1221"></a><span id="l22.1221" class="difflineplus">+    printf(&quot;%3lu: %-58s %c %3lu =\n&quot;, (unsigned long)set-&gt;m_length, s,    \</span>
<a href="#l22.1222"></a><span id="l22.1222" class="difflineplus">+           (PUSHP ? '+' : '-'), (unsigned long)i);                        \</span>
<a href="#l22.1223"></a><span id="l22.1223" class="difflineplus">+    free(s);                                                              \</span>
<a href="#l22.1224"></a><span id="l22.1224" class="difflineplus">+    if (PUSHP ? set-&gt;Add(i) &lt; 0 : set-&gt;Remove(i) &lt; 0) abort();            \</span>
<a href="#l22.1225"></a><span id="l22.1225" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();                        \</span>
<a href="#l22.1226"></a><span id="l22.1226" class="difflineplus">+    printf(&quot;%3lu: %-58s optimized =\n&quot;, (unsigned long)set-&gt;m_length, s); \</span>
<a href="#l22.1227"></a><span id="l22.1227" class="difflineplus">+    free(s);</span>
<a href="#l22.1228"></a><span id="l22.1228"> </span>
<a href="#l22.1229"></a><span id="l22.1229" class="difflineminus">-#define END()                 \</span>
<a href="#l22.1230"></a><span id="l22.1230" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1231"></a><span id="l22.1231" class="difflineminus">-  printf (&quot;%3lu: %s\n\n&quot;, (unsigned long)set-&gt;m_length, s); \</span>
<a href="#l22.1232"></a><span id="l22.1232" class="difflineminus">-  free(s);                      \</span>
<a href="#l22.1233"></a><span id="l22.1233" class="difflineminus">-  delete set;                 \</span>
<a href="#l22.1234"></a><span id="l22.1234" class="difflineplus">+#  define END()                                              \</span>
<a href="#l22.1235"></a><span id="l22.1235" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();           \</span>
<a href="#l22.1236"></a><span id="l22.1236" class="difflineplus">+    printf(&quot;%3lu: %s\n\n&quot;, (unsigned long)set-&gt;m_length, s); \</span>
<a href="#l22.1237"></a><span id="l22.1237" class="difflineplus">+    free(s);                                                 \</span>
<a href="#l22.1238"></a><span id="l22.1238" class="difflineplus">+    delete set;</span>
<a href="#l22.1239"></a><span id="l22.1239"> </span>
<a href="#l22.1240"></a><span id="l22.1240" class="difflineminus">-</span>
<a href="#l22.1241"></a><span id="l22.1241" class="difflineminus">-</span>
<a href="#l22.1242"></a><span id="l22.1242" class="difflineminus">-void</span>
<a href="#l22.1243"></a><span id="l22.1243" class="difflineminus">-nsMsgKeySet::test_adder (void)</span>
<a href="#l22.1244"></a><span id="l22.1244" class="difflineminus">-{</span>
<a href="#l22.1245"></a><span id="l22.1245" class="difflineplus">+void nsMsgKeySet::test_adder(void) {</span>
<a href="#l22.1246"></a><span id="l22.1246">   const char *string;</span>
<a href="#l22.1247"></a><span id="l22.1247">   nsMsgKeySet *set;</span>
<a href="#l22.1248"></a><span id="l22.1248">   char *s;</span>
<a href="#l22.1249"></a><span id="l22.1249">   int32_t i;</span>
<a href="#l22.1250"></a><span id="l22.1250"> </span>
<a href="#l22.1251"></a><span id="l22.1251">   START(&quot;0-70,72-99,105,107,110-111,117-200&quot;);</span>
<a href="#l22.1252"></a><span id="l22.1252"> </span>
<a href="#l22.1253"></a><span id="l22.1253">   FROB(205, true);</span>
<a href="#l22.1254"></a><span id="l22.1254" class="difflineat">@@ -1288,16 +1199,17 @@ nsMsgKeySet::test_adder (void)</span>
<a href="#l22.1255"></a><span id="l22.1255">   FROB(102, true);</span>
<a href="#l22.1256"></a><span id="l22.1256">   FROB(103, true);</span>
<a href="#l22.1257"></a><span id="l22.1257">   FROB(106, true);</span>
<a href="#l22.1258"></a><span id="l22.1258">   FROB(104, true);</span>
<a href="#l22.1259"></a><span id="l22.1259">   FROB(109, true);</span>
<a href="#l22.1260"></a><span id="l22.1260">   FROB(108, true);</span>
<a href="#l22.1261"></a><span id="l22.1261">   END();</span>
<a href="#l22.1262"></a><span id="l22.1262"> </span>
<a href="#l22.1263"></a><span id="l22.1263" class="difflineplus">+  // clang-format off</span>
<a href="#l22.1264"></a><span id="l22.1264">   START(&quot;1-6&quot;); FROB(7, false); END();</span>
<a href="#l22.1265"></a><span id="l22.1265">   START(&quot;1-6&quot;); FROB(6, false); END();</span>
<a href="#l22.1266"></a><span id="l22.1266">   START(&quot;1-6&quot;); FROB(5, false); END();</span>
<a href="#l22.1267"></a><span id="l22.1267">   START(&quot;1-6&quot;); FROB(4, false); END();</span>
<a href="#l22.1268"></a><span id="l22.1268">   START(&quot;1-6&quot;); FROB(3, false); END();</span>
<a href="#l22.1269"></a><span id="l22.1269">   START(&quot;1-6&quot;); FROB(2, false); END();</span>
<a href="#l22.1270"></a><span id="l22.1270">   START(&quot;1-6&quot;); FROB(1, false); END();</span>
<a href="#l22.1271"></a><span id="l22.1271">   START(&quot;1-6&quot;); FROB(0, false); END();</span>
<a href="#l22.1272"></a><span id="l22.1272" class="difflineat">@@ -1310,58 +1222,54 @@ nsMsgKeySet::test_adder (void)</span>
<a href="#l22.1273"></a><span id="l22.1273">   START(&quot;1,3,5-7,9,10&quot;); FROB(6, false); END();</span>
<a href="#l22.1274"></a><span id="l22.1274">   START(&quot;1,3,5-7,9,10&quot;); FROB(7, false); FROB(7, true); FROB(8, true);</span>
<a href="#l22.1275"></a><span id="l22.1275">   FROB (4, true); FROB (2, false); FROB (2, true);</span>
<a href="#l22.1276"></a><span id="l22.1276"> </span>
<a href="#l22.1277"></a><span id="l22.1277">   FROB (4, false); FROB (5, false); FROB (6, false); FROB (7, false);</span>
<a href="#l22.1278"></a><span id="l22.1278">   FROB (8, false); FROB (9, false); FROB (10, false); FROB (3, false);</span>
<a href="#l22.1279"></a><span id="l22.1279">   FROB (2, false); FROB (1, false); FROB (1, false); FROB (0, false);</span>
<a href="#l22.1280"></a><span id="l22.1280">   END();</span>
<a href="#l22.1281"></a><span id="l22.1281" class="difflineplus">+  // clang-format on</span>
<a href="#l22.1282"></a><span id="l22.1282"> }</span>
<a href="#l22.1283"></a><span id="l22.1283"> </span>
<a href="#l22.1284"></a><span id="l22.1284" class="difflineminus">-#undef START</span>
<a href="#l22.1285"></a><span id="l22.1285" class="difflineminus">-#undef FROB</span>
<a href="#l22.1286"></a><span id="l22.1286" class="difflineminus">-#undef END</span>
<a href="#l22.1287"></a><span id="l22.1287" class="difflineminus">-</span>
<a href="#l22.1288"></a><span id="l22.1288" class="difflineplus">+#  undef START</span>
<a href="#l22.1289"></a><span id="l22.1289" class="difflineplus">+#  undef FROB</span>
<a href="#l22.1290"></a><span id="l22.1290" class="difflineplus">+#  undef END</span>
<a href="#l22.1291"></a><span id="l22.1291"> </span>
<a href="#l22.1292"></a><span id="l22.1292" class="difflineminus">-</span>
<a href="#l22.1293"></a><span id="l22.1293" class="difflineminus">-#define START(STRING) \</span>
<a href="#l22.1294"></a><span id="l22.1294" class="difflineminus">-  string = STRING;    \</span>
<a href="#l22.1295"></a><span id="l22.1295" class="difflineminus">-  if (!(set = nsMsgKeySet::Create(string))) abort ()</span>
<a href="#l22.1296"></a><span id="l22.1296" class="difflineplus">+#  define START(STRING) \</span>
<a href="#l22.1297"></a><span id="l22.1297" class="difflineplus">+    string = STRING;    \</span>
<a href="#l22.1298"></a><span id="l22.1298" class="difflineplus">+    if (!(set = nsMsgKeySet::Create(string))) abort()</span>
<a href="#l22.1299"></a><span id="l22.1299"> </span>
<a href="#l22.1300"></a><span id="l22.1300" class="difflineminus">-#define FROB(N,M)                        \</span>
<a href="#l22.1301"></a><span id="l22.1301" class="difflineminus">-  i = N;                            \</span>
<a href="#l22.1302"></a><span id="l22.1302" class="difflineminus">-  j = M;                            \</span>
<a href="#l22.1303"></a><span id="l22.1303" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1304"></a><span id="l22.1304" class="difflineminus">-  printf (&quot;%3lu: %-58s + %3lu-%3lu =\n&quot;, (unsigned long)set-&gt;m_length, s, (unsigned long)i, (unsigned long)j);  \</span>
<a href="#l22.1305"></a><span id="l22.1305" class="difflineminus">-  free(s);                      \</span>
<a href="#l22.1306"></a><span id="l22.1306" class="difflineminus">-  switch (set-&gt;AddRange(i, j)) {                \</span>
<a href="#l22.1307"></a><span id="l22.1307" class="difflineminus">-  case 0:                            \</span>
<a href="#l22.1308"></a><span id="l22.1308" class="difflineminus">-  printf(&quot;(no-op)\n&quot;);                    \</span>
<a href="#l22.1309"></a><span id="l22.1309" class="difflineminus">-  break;                            \</span>
<a href="#l22.1310"></a><span id="l22.1310" class="difflineminus">-  case 1:                            \</span>
<a href="#l22.1311"></a><span id="l22.1311" class="difflineminus">-  break;                            \</span>
<a href="#l22.1312"></a><span id="l22.1312" class="difflineminus">-  default:                            \</span>
<a href="#l22.1313"></a><span id="l22.1313" class="difflineminus">-  abort();                          \</span>
<a href="#l22.1314"></a><span id="l22.1314" class="difflineminus">-  }                                \</span>
<a href="#l22.1315"></a><span id="l22.1315" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1316"></a><span id="l22.1316" class="difflineminus">-  printf (&quot;%3lu: %-58s\n&quot;, (unsigned long)set-&gt;m_length, s);            \</span>
<a href="#l22.1317"></a><span id="l22.1317" class="difflineminus">-  free(s);                      \</span>
<a href="#l22.1318"></a><span id="l22.1318" class="difflineplus">+#  define FROB(N, M)                                                       \</span>
<a href="#l22.1319"></a><span id="l22.1319" class="difflineplus">+    i = N;                                                                 \</span>
<a href="#l22.1320"></a><span id="l22.1320" class="difflineplus">+    j = M;                                                                 \</span>
<a href="#l22.1321"></a><span id="l22.1321" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();                         \</span>
<a href="#l22.1322"></a><span id="l22.1322" class="difflineplus">+    printf(&quot;%3lu: %-58s + %3lu-%3lu =\n&quot;, (unsigned long)set-&gt;m_length, s, \</span>
<a href="#l22.1323"></a><span id="l22.1323" class="difflineplus">+           (unsigned long)i, (unsigned long)j);                            \</span>
<a href="#l22.1324"></a><span id="l22.1324" class="difflineplus">+    free(s);                                                               \</span>
<a href="#l22.1325"></a><span id="l22.1325" class="difflineplus">+    switch (set-&gt;AddRange(i, j)) {                                         \</span>
<a href="#l22.1326"></a><span id="l22.1326" class="difflineplus">+      case 0:                                                              \</span>
<a href="#l22.1327"></a><span id="l22.1327" class="difflineplus">+        printf(&quot;(no-op)\n&quot;);                                               \</span>
<a href="#l22.1328"></a><span id="l22.1328" class="difflineplus">+        break;                                                             \</span>
<a href="#l22.1329"></a><span id="l22.1329" class="difflineplus">+      case 1:                                                              \</span>
<a href="#l22.1330"></a><span id="l22.1330" class="difflineplus">+        break;                                                             \</span>
<a href="#l22.1331"></a><span id="l22.1331" class="difflineplus">+      default:                                                             \</span>
<a href="#l22.1332"></a><span id="l22.1332" class="difflineplus">+        abort();                                                           \</span>
<a href="#l22.1333"></a><span id="l22.1333" class="difflineplus">+    }                                                                      \</span>
<a href="#l22.1334"></a><span id="l22.1334" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();                         \</span>
<a href="#l22.1335"></a><span id="l22.1335" class="difflineplus">+    printf(&quot;%3lu: %-58s\n&quot;, (unsigned long)set-&gt;m_length, s);              \</span>
<a href="#l22.1336"></a><span id="l22.1336" class="difflineplus">+    free(s);</span>
<a href="#l22.1337"></a><span id="l22.1337"> </span>
<a href="#l22.1338"></a><span id="l22.1338" class="difflineplus">+#  define END()                                              \</span>
<a href="#l22.1339"></a><span id="l22.1339" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();           \</span>
<a href="#l22.1340"></a><span id="l22.1340" class="difflineplus">+    printf(&quot;%3lu: %s\n\n&quot;, (unsigned long)set-&gt;m_length, s); \</span>
<a href="#l22.1341"></a><span id="l22.1341" class="difflineplus">+    free(s);                                                 \</span>
<a href="#l22.1342"></a><span id="l22.1342" class="difflineplus">+    delete set;</span>
<a href="#l22.1343"></a><span id="l22.1343"> </span>
<a href="#l22.1344"></a><span id="l22.1344" class="difflineminus">-#define END()                 \</span>
<a href="#l22.1345"></a><span id="l22.1345" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1346"></a><span id="l22.1346" class="difflineminus">-  printf (&quot;%3lu: %s\n\n&quot;, (unsigned long)set-&gt;m_length, s); \</span>
<a href="#l22.1347"></a><span id="l22.1347" class="difflineminus">-  free(s);                      \</span>
<a href="#l22.1348"></a><span id="l22.1348" class="difflineminus">-  delete set;</span>
<a href="#l22.1349"></a><span id="l22.1349" class="difflineminus">-</span>
<a href="#l22.1350"></a><span id="l22.1350" class="difflineminus">-</span>
<a href="#l22.1351"></a><span id="l22.1351" class="difflineminus">-void</span>
<a href="#l22.1352"></a><span id="l22.1352" class="difflineminus">-nsMsgKeySet::test_ranges(void)</span>
<a href="#l22.1353"></a><span id="l22.1353" class="difflineminus">-{</span>
<a href="#l22.1354"></a><span id="l22.1354" class="difflineplus">+void nsMsgKeySet::test_ranges(void) {</span>
<a href="#l22.1355"></a><span id="l22.1355">   const char *string;</span>
<a href="#l22.1356"></a><span id="l22.1356">   nsMsgKeySet *set;</span>
<a href="#l22.1357"></a><span id="l22.1357">   char *s;</span>
<a href="#l22.1358"></a><span id="l22.1358">   int32_t i;</span>
<a href="#l22.1359"></a><span id="l22.1359">   int32_t j;</span>
<a href="#l22.1360"></a><span id="l22.1360"> </span>
<a href="#l22.1361"></a><span id="l22.1361">   START(&quot;20-40,72-99,105,107,110-111,117-200&quot;);</span>
<a href="#l22.1362"></a><span id="l22.1362"> </span>
<a href="#l22.1363"></a><span id="l22.1363" class="difflineat">@@ -1372,52 +1280,45 @@ nsMsgKeySet::test_ranges(void)</span>
<a href="#l22.1364"></a><span id="l22.1364">   FROB(101, 101);</span>
<a href="#l22.1365"></a><span id="l22.1365">   FROB(5, 75);</span>
<a href="#l22.1366"></a><span id="l22.1366">   FROB(103, 109);</span>
<a href="#l22.1367"></a><span id="l22.1367">   FROB(2, 20);</span>
<a href="#l22.1368"></a><span id="l22.1368">   FROB(1, 9999);</span>
<a href="#l22.1369"></a><span id="l22.1369"> </span>
<a href="#l22.1370"></a><span id="l22.1370">   END();</span>
<a href="#l22.1371"></a><span id="l22.1371"> </span>
<a href="#l22.1372"></a><span id="l22.1372" class="difflineminus">-</span>
<a href="#l22.1373"></a><span id="l22.1373" class="difflineminus">-#undef START</span>
<a href="#l22.1374"></a><span id="l22.1374" class="difflineminus">-#undef FROB</span>
<a href="#l22.1375"></a><span id="l22.1375" class="difflineminus">-#undef END</span>
<a href="#l22.1376"></a><span id="l22.1376" class="difflineplus">+#  undef START</span>
<a href="#l22.1377"></a><span id="l22.1377" class="difflineplus">+#  undef FROB</span>
<a href="#l22.1378"></a><span id="l22.1378" class="difflineplus">+#  undef END</span>
<a href="#l22.1379"></a><span id="l22.1379"> }</span>
<a href="#l22.1380"></a><span id="l22.1380"> </span>
<a href="#l22.1381"></a><span id="l22.1381" class="difflineminus">-</span>
<a href="#l22.1382"></a><span id="l22.1382" class="difflineminus">-</span>
<a href="#l22.1383"></a><span id="l22.1383" class="difflineplus">+#  define TEST(N)                                                    \</span>
<a href="#l22.1384"></a><span id="l22.1384" class="difflineplus">+    if (!with_cache) set-&gt;m_cached_value = -1;                       \</span>
<a href="#l22.1385"></a><span id="l22.1385" class="difflineplus">+    if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort();                   \</span>
<a href="#l22.1386"></a><span id="l22.1386" class="difflineplus">+    printf(&quot; %3d = %s\n&quot;, N, (set-&gt;IsMember(N) ? &quot;true&quot; : &quot;false&quot;)); \</span>
<a href="#l22.1387"></a><span id="l22.1387" class="difflineplus">+    free(s);</span>
<a href="#l22.1388"></a><span id="l22.1388"> </span>
<a href="#l22.1389"></a><span id="l22.1389" class="difflineminus">-#define TEST(N)                    \</span>
<a href="#l22.1390"></a><span id="l22.1390" class="difflineminus">-  if (! with_cache) set-&gt;m_cached_value = -1;    \</span>
<a href="#l22.1391"></a><span id="l22.1391" class="difflineminus">-  if (!(NS_SUCCEEDED(set-&gt;Output(&amp;s)))) abort ();          \</span>
<a href="#l22.1392"></a><span id="l22.1392" class="difflineminus">-  printf (&quot; %3d = %s\n&quot;, N,              \</span>
<a href="#l22.1393"></a><span id="l22.1393" class="difflineminus">-      (set-&gt;IsMember(N) ? &quot;true&quot; : &quot;false&quot;)); \</span>
<a href="#l22.1394"></a><span id="l22.1394" class="difflineminus">-  free(s);</span>
<a href="#l22.1395"></a><span id="l22.1395" class="difflineminus">-</span>
<a href="#l22.1396"></a><span id="l22.1396" class="difflineminus">-void</span>
<a href="#l22.1397"></a><span id="l22.1397" class="difflineminus">-nsMsgKeySet::test_member(bool with_cache)</span>
<a href="#l22.1398"></a><span id="l22.1398" class="difflineminus">-{</span>
<a href="#l22.1399"></a><span id="l22.1399" class="difflineplus">+void nsMsgKeySet::test_member(bool with_cache) {</span>
<a href="#l22.1400"></a><span id="l22.1400">   nsMsgKeySet *set;</span>
<a href="#l22.1401"></a><span id="l22.1401">   char *s;</span>
<a href="#l22.1402"></a><span id="l22.1402"> </span>
<a href="#l22.1403"></a><span id="l22.1403">   const char *st1 = &quot;1-70,72-99,105,107,110-111,117-200&quot;;</span>
<a href="#l22.1404"></a><span id="l22.1404" class="difflineminus">-  printf (&quot;\n\nTesting %s (with%s cache)\n&quot;, st1, with_cache ? &quot;&quot; : &quot;out&quot;);</span>
<a href="#l22.1405"></a><span id="l22.1405" class="difflineplus">+  printf(&quot;\n\nTesting %s (with%s cache)\n&quot;, st1, with_cache ? &quot;&quot; : &quot;out&quot;);</span>
<a href="#l22.1406"></a><span id="l22.1406">   if (!(set = Create(st1))) {</span>
<a href="#l22.1407"></a><span id="l22.1407">     abort();</span>
<a href="#l22.1408"></a><span id="l22.1408">   }</span>
<a href="#l22.1409"></a><span id="l22.1409"> </span>
<a href="#l22.1410"></a><span id="l22.1410">   TEST(-1);</span>
<a href="#l22.1411"></a><span id="l22.1411">   TEST(0);</span>
<a href="#l22.1412"></a><span id="l22.1412">   TEST(1);</span>
<a href="#l22.1413"></a><span id="l22.1413">   TEST(20);</span>
<a href="#l22.1414"></a><span id="l22.1414"> </span>
<a href="#l22.1415"></a><span id="l22.1415">   delete set;</span>
<a href="#l22.1416"></a><span id="l22.1416">   const char *st2 = &quot;0-70,72-99,105,107,110-111,117-200&quot;;</span>
<a href="#l22.1417"></a><span id="l22.1417" class="difflineminus">-  printf (&quot;\n\nTesting %s (with%s cache)\n&quot;, st2, with_cache ? &quot;&quot; : &quot;out&quot;);</span>
<a href="#l22.1418"></a><span id="l22.1418" class="difflineplus">+  printf(&quot;\n\nTesting %s (with%s cache)\n&quot;, st2, with_cache ? &quot;&quot; : &quot;out&quot;);</span>
<a href="#l22.1419"></a><span id="l22.1419">   if (!(set = Create(st2))) {</span>
<a href="#l22.1420"></a><span id="l22.1420">     abort();</span>
<a href="#l22.1421"></a><span id="l22.1421">   }</span>
<a href="#l22.1422"></a><span id="l22.1422"> </span>
<a href="#l22.1423"></a><span id="l22.1423">   TEST(-1);</span>
<a href="#l22.1424"></a><span id="l22.1424">   TEST(0);</span>
<a href="#l22.1425"></a><span id="l22.1425">   TEST(1);</span>
<a href="#l22.1426"></a><span id="l22.1426">   TEST(20);</span>
<a href="#l22.1427"></a><span id="l22.1427" class="difflineat">@@ -1442,18 +1343,17 @@ nsMsgKeySet::test_member(bool with_cache</span>
<a href="#l22.1428"></a><span id="l22.1428">   TEST(119);</span>
<a href="#l22.1429"></a><span id="l22.1429">   TEST(200);</span>
<a href="#l22.1430"></a><span id="l22.1430">   TEST(201);</span>
<a href="#l22.1431"></a><span id="l22.1431">   TEST(65535);</span>
<a href="#l22.1432"></a><span id="l22.1432"> </span>
<a href="#l22.1433"></a><span id="l22.1433">   delete set;</span>
<a href="#l22.1434"></a><span id="l22.1434"> }</span>
<a href="#l22.1435"></a><span id="l22.1435"> </span>
<a href="#l22.1436"></a><span id="l22.1436" class="difflineminus">-#undef TEST</span>
<a href="#l22.1437"></a><span id="l22.1437" class="difflineminus">-</span>
<a href="#l22.1438"></a><span id="l22.1438" class="difflineplus">+#  undef TEST</span>
<a href="#l22.1439"></a><span id="l22.1439"> </span>
<a href="#l22.1440"></a><span id="l22.1440"> // static void</span>
<a href="#l22.1441"></a><span id="l22.1441"> // test_newsrc (char *file)</span>
<a href="#l22.1442"></a><span id="l22.1442"> // {</span>
<a href="#l22.1443"></a><span id="l22.1443"> //   FILE *fp = fopen (file, &quot;r&quot;);</span>
<a href="#l22.1444"></a><span id="l22.1444"> //   char buf [1024];</span>
<a href="#l22.1445"></a><span id="l22.1445"> //   if (! fp) abort ();</span>
<a href="#l22.1446"></a><span id="l22.1446"> //   while (fgets (buf, sizeof (buf), fp))</span>
<a href="#l22.1447"></a><span id="l22.1447" class="difflineat">@@ -1483,38 +1383,35 @@ nsMsgKeySet::test_member(bool with_cache</span>
<a href="#l22.1448"></a><span id="l22.1448"> //         free (s);</span>
<a href="#l22.1449"></a><span id="l22.1449"> //         fwrite (&quot;\n&quot;, 1, 1, stdout);</span>
<a href="#l22.1450"></a><span id="l22.1450"> //       }</span>
<a href="#l22.1451"></a><span id="l22.1451"> //     }</span>
<a href="#l22.1452"></a><span id="l22.1452"> //   }</span>
<a href="#l22.1453"></a><span id="l22.1453"> //   fclose (fp);</span>
<a href="#l22.1454"></a><span id="l22.1454"> // }</span>
<a href="#l22.1455"></a><span id="l22.1455"> </span>
<a href="#l22.1456"></a><span id="l22.1456" class="difflineminus">-void</span>
<a href="#l22.1457"></a><span id="l22.1457" class="difflineminus">-nsMsgKeySet::RunTests ()</span>
<a href="#l22.1458"></a><span id="l22.1458" class="difflineminus">-{</span>
<a href="#l22.1459"></a><span id="l22.1459" class="difflineminus">-</span>
<a href="#l22.1460"></a><span id="l22.1460" class="difflineminus">-  test_decoder (&quot;&quot;);</span>
<a href="#l22.1461"></a><span id="l22.1461" class="difflineminus">-  test_decoder (&quot; &quot;);</span>
<a href="#l22.1462"></a><span id="l22.1462" class="difflineminus">-  test_decoder (&quot;0&quot;);</span>
<a href="#l22.1463"></a><span id="l22.1463" class="difflineminus">-  test_decoder (&quot;1&quot;);</span>
<a href="#l22.1464"></a><span id="l22.1464" class="difflineminus">-  test_decoder (&quot;123&quot;);</span>
<a href="#l22.1465"></a><span id="l22.1465" class="difflineminus">-  test_decoder (&quot; 123 &quot;);</span>
<a href="#l22.1466"></a><span id="l22.1466" class="difflineminus">-  test_decoder (&quot; 123 4&quot;);</span>
<a href="#l22.1467"></a><span id="l22.1467" class="difflineminus">-  test_decoder (&quot; 1,2, 3, 4&quot;);</span>
<a href="#l22.1468"></a><span id="l22.1468" class="difflineminus">-  test_decoder (&quot;0-70,72-99,100,101&quot;);</span>
<a href="#l22.1469"></a><span id="l22.1469" class="difflineminus">-  test_decoder (&quot; 0-70 , 72 - 99 ,100,101 &quot;);</span>
<a href="#l22.1470"></a><span id="l22.1470" class="difflineminus">-  test_decoder (&quot;0 - 268435455&quot;);</span>
<a href="#l22.1471"></a><span id="l22.1471" class="difflineplus">+void nsMsgKeySet::RunTests() {</span>
<a href="#l22.1472"></a><span id="l22.1472" class="difflineplus">+  test_decoder(&quot;&quot;);</span>
<a href="#l22.1473"></a><span id="l22.1473" class="difflineplus">+  test_decoder(&quot; &quot;);</span>
<a href="#l22.1474"></a><span id="l22.1474" class="difflineplus">+  test_decoder(&quot;0&quot;);</span>
<a href="#l22.1475"></a><span id="l22.1475" class="difflineplus">+  test_decoder(&quot;1&quot;);</span>
<a href="#l22.1476"></a><span id="l22.1476" class="difflineplus">+  test_decoder(&quot;123&quot;);</span>
<a href="#l22.1477"></a><span id="l22.1477" class="difflineplus">+  test_decoder(&quot; 123 &quot;);</span>
<a href="#l22.1478"></a><span id="l22.1478" class="difflineplus">+  test_decoder(&quot; 123 4&quot;);</span>
<a href="#l22.1479"></a><span id="l22.1479" class="difflineplus">+  test_decoder(&quot; 1,2, 3, 4&quot;);</span>
<a href="#l22.1480"></a><span id="l22.1480" class="difflineplus">+  test_decoder(&quot;0-70,72-99,100,101&quot;);</span>
<a href="#l22.1481"></a><span id="l22.1481" class="difflineplus">+  test_decoder(&quot; 0-70 , 72 - 99 ,100,101 &quot;);</span>
<a href="#l22.1482"></a><span id="l22.1482" class="difflineplus">+  test_decoder(&quot;0 - 268435455&quot;);</span>
<a href="#l22.1483"></a><span id="l22.1483">   /* This one overflows - we can't help it.</span>
<a href="#l22.1484"></a><span id="l22.1484">    test_decoder (&quot;0 - 4294967295&quot;); */</span>
<a href="#l22.1485"></a><span id="l22.1485"> </span>
<a href="#l22.1486"></a><span id="l22.1486" class="difflineminus">-  test_adder ();</span>
<a href="#l22.1487"></a><span id="l22.1487" class="difflineplus">+  test_adder();</span>
<a href="#l22.1488"></a><span id="l22.1488"> </span>
<a href="#l22.1489"></a><span id="l22.1489">   test_ranges();</span>
<a href="#l22.1490"></a><span id="l22.1490"> </span>
<a href="#l22.1491"></a><span id="l22.1491" class="difflineminus">-  test_member (false);</span>
<a href="#l22.1492"></a><span id="l22.1492" class="difflineminus">-  test_member (true);</span>
<a href="#l22.1493"></a><span id="l22.1493" class="difflineplus">+  test_member(false);</span>
<a href="#l22.1494"></a><span id="l22.1494" class="difflineplus">+  test_member(true);</span>
<a href="#l22.1495"></a><span id="l22.1495"> </span>
<a href="#l22.1496"></a><span id="l22.1496">   // test_newsrc (&quot;/u/montulli/.newsrc&quot;);</span>
<a href="#l22.1497"></a><span id="l22.1497">   /* test_newsrc (&quot;/u/jwz/.newsrc&quot;);*/</span>
<a href="#l22.1498"></a><span id="l22.1498"> }</span>
<a href="#l22.1499"></a><span id="l22.1499"> </span>
<a href="#l22.1500"></a><span id="l22.1500"> #endif /* DEBUG */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/util/nsMsgKeySet.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgKeySet.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -15,32 +15,32 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> #if 0</span>
<a href="#l23.6"></a><span id="l23.6"> // If a MSG_NewsHost* is supplied to the creation routine, then that</span>
<a href="#l23.7"></a><span id="l23.7"> // MSG_NewsHost will be notified whenever a change is made to set.</span>
<a href="#l23.8"></a><span id="l23.8"> class MSG_NewsHost;</span>
<a href="#l23.9"></a><span id="l23.9"> #endif</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> class NS_MSG_BASE nsMsgKeySet {</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-public:</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+ public:</span>
<a href="#l23.14"></a><span id="l23.14">   // Creates an empty set.</span>
<a href="#l23.15"></a><span id="l23.15">   static nsMsgKeySet* Create(/* MSG_NewsHost* host = NULL*/);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">   // Creates a set from the list of numbers, as might be found in a</span>
<a href="#l23.18"></a><span id="l23.18">   // newsrc file.</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-  static nsMsgKeySet* Create(const char* str/* , MSG_NewsHost* host = NULL*/);</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+  static nsMsgKeySet* Create(const char* str /* , MSG_NewsHost* host = NULL*/);</span>
<a href="#l23.21"></a><span id="l23.21">   ~nsMsgKeySet();</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23">   // FirstNonMember() returns the lowest non-member of the set that is</span>
<a href="#l23.24"></a><span id="l23.24">   // greater than 0.</span>
<a href="#l23.25"></a><span id="l23.25">   int32_t FirstNonMember();</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27">   // Output() converts to a string representation suitable for writing to a</span>
<a href="#l23.28"></a><span id="l23.28">   // .newsrc file.</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-  nsresult Output(char **outputStr);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+  nsresult Output(char** outputStr);</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32">   // IsMember() returns whether the given article is a member of this set.</span>
<a href="#l23.33"></a><span id="l23.33">   bool IsMember(int32_t art);</span>
<a href="#l23.34"></a><span id="l23.34"> </span>
<a href="#l23.35"></a><span id="l23.35">   // Add() adds the given article to the set.  (Returns 1 if a change was</span>
<a href="#l23.36"></a><span id="l23.36">   // made, 0 if it was already there, and negative on error.)</span>
<a href="#l23.37"></a><span id="l23.37">   int Add(int32_t art);</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39" class="difflineat">@@ -51,58 +51,57 @@ public:</span>
<a href="#l23.40"></a><span id="l23.40">   int AddRange(int32_t first, int32_t last);</span>
<a href="#l23.41"></a><span id="l23.41"> </span>
<a href="#l23.42"></a><span id="l23.42">   // CountMissingInRange() takes an inclusive range of articles and returns</span>
<a href="#l23.43"></a><span id="l23.43">   // the number of articles in that range which are not in the set.</span>
<a href="#l23.44"></a><span id="l23.44">   int32_t CountMissingInRange(int32_t start, int32_t end);</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46">   // FirstMissingRange() takes an inclusive range and finds the first range</span>
<a href="#l23.47"></a><span id="l23.47">   // of articles that are not in the set.  If none, return zeros.</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-  int FirstMissingRange(int32_t min, int32_t max, int32_t* first, int32_t* last);</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+  int FirstMissingRange(int32_t min, int32_t max, int32_t* first,</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+                        int32_t* last);</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53">   // LastMissingRange() takes an inclusive range and finds the last range</span>
<a href="#l23.54"></a><span id="l23.54">   // of articles that are not in the set.  If none, return zeros.</span>
<a href="#l23.55"></a><span id="l23.55">   int LastMissingRange(int32_t min, int32_t max, int32_t* first, int32_t* last);</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57">   int32_t GetLastMember();</span>
<a href="#l23.58"></a><span id="l23.58">   int32_t GetFirstMember();</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-  void  SetLastMember(int32_t highWaterMark);</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+  void SetLastMember(int32_t highWaterMark);</span>
<a href="#l23.61"></a><span id="l23.61">   // For debugging only...</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-  int32_t getLength() {return m_length;}</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+  int32_t getLength() { return m_length; }</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-/**</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">- * Fill the passed in aArray with the keys in the message key set.</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">- */</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-  nsresult ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt; &amp;aArray);</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+  /**</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+   * Fill the passed in aArray with the keys in the message key set.</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+   */</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+  nsresult ToMsgKeyArray(nsTArray&lt;nsMsgKey&gt;&amp; aArray);</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74"> #ifdef DEBUG</span>
<a href="#l23.75"></a><span id="l23.75">   static void RunTests();</span>
<a href="#l23.76"></a><span id="l23.76"> #endif</span>
<a href="#l23.77"></a><span id="l23.77"> </span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-protected:</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+ protected:</span>
<a href="#l23.80"></a><span id="l23.80">   nsMsgKeySet(/* MSG_NewsHost* host */);</span>
<a href="#l23.81"></a><span id="l23.81">   explicit nsMsgKeySet(const char* /* , MSG_NewsHost* host */);</span>
<a href="#l23.82"></a><span id="l23.82">   bool Grow();</span>
<a href="#l23.83"></a><span id="l23.83">   bool Optimize();</span>
<a href="#l23.84"></a><span id="l23.84"> </span>
<a href="#l23.85"></a><span id="l23.85"> #ifdef DEBUG</span>
<a href="#l23.86"></a><span id="l23.86">   static void test_decoder(const char*);</span>
<a href="#l23.87"></a><span id="l23.87">   static void test_adder();</span>
<a href="#l23.88"></a><span id="l23.88">   static void test_ranges();</span>
<a href="#l23.89"></a><span id="l23.89">   static void test_member(bool with_cache);</span>
<a href="#l23.90"></a><span id="l23.90"> #endif</span>
<a href="#l23.91"></a><span id="l23.91"> </span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  int32_t *m_data;          /* the numbers composing the `chunks' */</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-  int32_t m_data_size;        /* size of that malloc'ed block */</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-  int32_t m_length;        /* active area */</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+  int32_t* m_data;     /* the numbers composing the `chunks' */</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+  int32_t m_data_size; /* size of that malloc'ed block */</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  int32_t m_length;    /* active area */</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-  int32_t m_cached_value;      /* a potential set member, or -1 if unset*/</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-  int32_t m_cached_value_index;    /* the index into `data' at which a search</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-                     to determine whether `cached_value' was</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-                     a member of the set ended. */</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+  int32_t m_cached_value;       /* a potential set member, or -1 if unset*/</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+  int32_t m_cached_value_index; /* the index into `data' at which a search</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+                                   to determine whether `cached_value' was</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+                                   a member of the set ended. */</span>
<a href="#l23.107"></a><span id="l23.107"> #ifdef NEWSRC_DOES_HOST_STUFF</span>
<a href="#l23.108"></a><span id="l23.108">   MSG_NewsHost* m_host;</span>
<a href="#l23.109"></a><span id="l23.109"> #endif</span>
<a href="#l23.110"></a><span id="l23.110"> };</span>
<a href="#l23.111"></a><span id="l23.111"> </span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-</span>
<a href="#l23.113"></a><span id="l23.113"> #endif /* _nsMsgKeySet_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/util/nsMsgLineBuffer.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgLineBuffer.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -3,435 +3,397 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.5"></a><span id="l24.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;prlog.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;prmem.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsIInputStream.h&quot; // used by nsMsgLineStreamBuffer</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+#include &quot;nsIInputStream.h&quot;  // used by nsMsgLineStreamBuffer</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-nsByteArray::nsByteArray()</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-{</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+nsByteArray::nsByteArray() {</span>
<a href="#l24.18"></a><span id="l24.18">   MOZ_COUNT_CTOR(nsByteArray);</span>
<a href="#l24.19"></a><span id="l24.19">   m_buffer = NULL;</span>
<a href="#l24.20"></a><span id="l24.20">   m_bufferSize = 0;</span>
<a href="#l24.21"></a><span id="l24.21">   m_bufferPos = 0;</span>
<a href="#l24.22"></a><span id="l24.22"> }</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-nsByteArray::~nsByteArray()</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-{</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+nsByteArray::~nsByteArray() {</span>
<a href="#l24.27"></a><span id="l24.27">   MOZ_COUNT_DTOR(nsByteArray);</span>
<a href="#l24.28"></a><span id="l24.28">   PR_FREEIF(m_buffer);</span>
<a href="#l24.29"></a><span id="l24.29"> }</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-nsresult nsByteArray::GrowBuffer(uint32_t desired_size, uint32_t quantum)</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-{</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  if (m_bufferSize &lt; desired_size)</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  {</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+nsresult nsByteArray::GrowBuffer(uint32_t desired_size, uint32_t quantum) {</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  if (m_bufferSize &lt; desired_size) {</span>
<a href="#l24.37"></a><span id="l24.37">     char *new_buf;</span>
<a href="#l24.38"></a><span id="l24.38">     uint32_t increment = desired_size - m_bufferSize;</span>
<a href="#l24.39"></a><span id="l24.39">     if (increment &lt; quantum) /* always grow by a minimum of N bytes */</span>
<a href="#l24.40"></a><span id="l24.40">       increment = quantum;</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-    new_buf = (m_buffer</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-      ? (char *) PR_REALLOC (m_buffer, (m_bufferSize + increment))</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-      : (char *) PR_MALLOC (m_bufferSize + increment));</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-    if (! new_buf)</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+    new_buf =</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+        (m_buffer ? (char *)PR_REALLOC(m_buffer, (m_bufferSize + increment))</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+                  : (char *)PR_MALLOC(m_bufferSize + increment));</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+    if (!new_buf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.51"></a><span id="l24.51">     m_buffer = new_buf;</span>
<a href="#l24.52"></a><span id="l24.52">     m_bufferSize += increment;</span>
<a href="#l24.53"></a><span id="l24.53">   }</span>
<a href="#l24.54"></a><span id="l24.54">   return NS_OK;</span>
<a href="#l24.55"></a><span id="l24.55"> }</span>
<a href="#l24.56"></a><span id="l24.56"> </span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-nsresult nsByteArray::AppendString(const char *string)</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-{</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+nsresult nsByteArray::AppendString(const char *string) {</span>
<a href="#l24.60"></a><span id="l24.60">   uint32_t strLength = (string) ? PL_strlen(string) : 0;</span>
<a href="#l24.61"></a><span id="l24.61">   return AppendBuffer(string, strLength);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-</span>
<a href="#l24.63"></a><span id="l24.63"> }</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-nsresult nsByteArray::AppendBuffer(const char *buffer, uint32_t length)</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-{</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+nsresult nsByteArray::AppendBuffer(const char *buffer, uint32_t length) {</span>
<a href="#l24.68"></a><span id="l24.68">   nsresult ret = NS_OK;</span>
<a href="#l24.69"></a><span id="l24.69">   if (m_bufferPos + length &gt; m_bufferSize)</span>
<a href="#l24.70"></a><span id="l24.70">     ret = GrowBuffer(m_bufferPos + length, 1024);</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-  if (NS_SUCCEEDED(ret))</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-  {</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  if (NS_SUCCEEDED(ret)) {</span>
<a href="#l24.74"></a><span id="l24.74">     memcpy(m_buffer + m_bufferPos, buffer, length);</span>
<a href="#l24.75"></a><span id="l24.75">     m_bufferPos += length;</span>
<a href="#l24.76"></a><span id="l24.76">   }</span>
<a href="#l24.77"></a><span id="l24.77">   return ret;</span>
<a href="#l24.78"></a><span id="l24.78"> }</span>
<a href="#l24.79"></a><span id="l24.79"> </span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-nsMsgLineBuffer::nsMsgLineBuffer(nsMsgLineBufferHandler *handler, bool convertNewlinesP)</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-{</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+nsMsgLineBuffer::nsMsgLineBuffer(nsMsgLineBufferHandler *handler,</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+                                 bool convertNewlinesP) {</span>
<a href="#l24.84"></a><span id="l24.84">   MOZ_COUNT_CTOR(nsMsgLineBuffer);</span>
<a href="#l24.85"></a><span id="l24.85">   m_handler = handler;</span>
<a href="#l24.86"></a><span id="l24.86">   m_convertNewlinesP = convertNewlinesP;</span>
<a href="#l24.87"></a><span id="l24.87">   m_lookingForCRLF = true;</span>
<a href="#l24.88"></a><span id="l24.88"> }</span>
<a href="#l24.89"></a><span id="l24.89"> </span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-nsMsgLineBuffer::~nsMsgLineBuffer()</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-{</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-  MOZ_COUNT_DTOR(nsMsgLineBuffer);</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-}</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+nsMsgLineBuffer::~nsMsgLineBuffer() { MOZ_COUNT_DTOR(nsMsgLineBuffer); }</span>
<a href="#l24.95"></a><span id="l24.95"> </span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-void</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-nsMsgLineBuffer::SetLookingForCRLF(bool b)</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-{</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-  m_lookingForCRLF = b;</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-}</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+void nsMsgLineBuffer::SetLookingForCRLF(bool b) { m_lookingForCRLF = b; }</span>
<a href="#l24.102"></a><span id="l24.102"> </span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-nsresult nsMsgLineBuffer::BufferInput(const char *net_buffer, int32_t net_buffer_size)</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-{</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-    nsresult status = NS_OK;</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-    if (m_bufferPos &gt; 0 &amp;&amp; m_buffer &amp;&amp; m_buffer[m_bufferPos - 1] == '\r' &amp;&amp;</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-        net_buffer_size &gt; 0 &amp;&amp; net_buffer[0] != '\n') {</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-        /* The last buffer ended with a CR.  The new buffer does not start</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-           with a LF.  This old buffer should be shipped out and discarded. */</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-        PR_ASSERT(m_bufferSize &gt; m_bufferPos);</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-        if (m_bufferSize &lt;= m_bufferPos)</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-          return NS_ERROR_UNEXPECTED;</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-        if (NS_FAILED(ConvertAndSendBuffer()))</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-           return NS_ERROR_FAILURE;</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-        m_bufferPos = 0;</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-    }</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-    while (net_buffer_size &gt; 0)</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-    {</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-        const char *net_buffer_end = net_buffer + net_buffer_size;</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-        const char *newline = 0;</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-        const char *s;</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+nsresult nsMsgLineBuffer::BufferInput(const char *net_buffer,</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+                                      int32_t net_buffer_size) {</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+  if (m_bufferPos &gt; 0 &amp;&amp; m_buffer &amp;&amp; m_buffer[m_bufferPos - 1] == '\r' &amp;&amp;</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+      net_buffer_size &gt; 0 &amp;&amp; net_buffer[0] != '\n') {</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+    /* The last buffer ended with a CR.  The new buffer does not start</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+       with a LF.  This old buffer should be shipped out and discarded. */</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+    PR_ASSERT(m_bufferSize &gt; m_bufferPos);</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+    if (m_bufferSize &lt;= m_bufferPos) return NS_ERROR_UNEXPECTED;</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+    if (NS_FAILED(ConvertAndSendBuffer())) return NS_ERROR_FAILURE;</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+    m_bufferPos = 0;</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+  }</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+  while (net_buffer_size &gt; 0) {</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+    const char *net_buffer_end = net_buffer + net_buffer_size;</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+    const char *newline = 0;</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+    const char *s;</span>
<a href="#l24.138"></a><span id="l24.138"> </span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-        for (s = net_buffer; s &lt; net_buffer_end; s++)</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-        {</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-          if (m_lookingForCRLF) {</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-            /* Move forward in the buffer until the first newline.</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-               Stop when we see CRLF, CR, or LF, or the end of the buffer.</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-               *But*, if we see a lone CR at the *very end* of the buffer,</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-               treat this as if we had reached the end of the buffer without</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-               seeing a line terminator.  This is to catch the case of the</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-               buffers splitting a CRLF pair, as in &quot;FOO\r\nBAR\r&quot; &quot;\nBAZ\r\n&quot;.</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-            */</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-            if (*s == '\r' || *s == '\n') {</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-              newline = s;</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-              if (newline[0] == '\r') {</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-                if (s == net_buffer_end - 1) {</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-                  /* CR at end - wait for the next character. */</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-                  newline = 0;</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-                  break;</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-                }</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-                else if (newline[1] == '\n') {</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-                  /* CRLF seen; swallow both. */</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-                  newline++;</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-                }</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-              }</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+    for (s = net_buffer; s &lt; net_buffer_end; s++) {</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+      if (m_lookingForCRLF) {</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+        /* Move forward in the buffer until the first newline.</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+           Stop when we see CRLF, CR, or LF, or the end of the buffer.</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineplus">+           *But*, if we see a lone CR at the *very end* of the buffer,</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineplus">+           treat this as if we had reached the end of the buffer without</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+           seeing a line terminator.  This is to catch the case of the</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+           buffers splitting a CRLF pair, as in &quot;FOO\r\nBAR\r&quot; &quot;\nBAZ\r\n&quot;.</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+        */</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+        if (*s == '\r' || *s == '\n') {</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+          newline = s;</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+          if (newline[0] == '\r') {</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+            if (s == net_buffer_end - 1) {</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+              /* CR at end - wait for the next character. */</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+              newline = 0;</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+              break;</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+            } else if (newline[1] == '\n') {</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+              /* CRLF seen; swallow both. */</span>
<a href="#l24.180"></a><span id="l24.180">               newline++;</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-              break;</span>
<a href="#l24.182"></a><span id="l24.182">             }</span>
<a href="#l24.183"></a><span id="l24.183">           }</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-          else {</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-            /* if not looking for a CRLF, stop at CR or LF.  (for example, when parsing the newsrc file).  this fixes #9896, where we'd lose the last line of anything we'd parse that used CR as the line break. */</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-            if (*s == '\r' || *s == '\n') {</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-              newline = s;</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineminus">-              newline++;</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">-              break;</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">-            }</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">-          }</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+          newline++;</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+          break;</span>
<a href="#l24.194"></a><span id="l24.194">         }</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineplus">+      } else {</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineplus">+        /* if not looking for a CRLF, stop at CR or LF.  (for example, when</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineplus">+         * parsing the newsrc file).  this fixes #9896, where we'd lose the last</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+         * line of anything we'd parse that used CR as the line break. */</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+        if (*s == '\r' || *s == '\n') {</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineplus">+          newline = s;</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineplus">+          newline++;</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineplus">+          break;</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+        }</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+      }</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+    }</span>
<a href="#l24.206"></a><span id="l24.206"> </span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-        /* Ensure room in the net_buffer and append some or all of the current</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-           chunk of data to it. */</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineminus">-        {</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-            const char *end = (newline ? newline : net_buffer_end);</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-            uint32_t desired_size = (end - net_buffer) + m_bufferPos + 1;</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+    /* Ensure room in the net_buffer and append some or all of the current</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+       chunk of data to it. */</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+    {</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+      const char *end = (newline ? newline : net_buffer_end);</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineplus">+      uint32_t desired_size = (end - net_buffer) + m_bufferPos + 1;</span>
<a href="#l24.217"></a><span id="l24.217"> </span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-            if (desired_size &gt;= m_bufferSize)</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-            {</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-                status = GrowBuffer (desired_size, 1024);</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-                if (NS_FAILED(status))</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-                    return status;</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-            }</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-            memcpy (m_buffer + m_bufferPos, net_buffer, (end - net_buffer));</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineminus">-            m_bufferPos += (end - net_buffer);</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-        }</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+      if (desired_size &gt;= m_bufferSize) {</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+        status = GrowBuffer(desired_size, 1024);</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+        if (NS_FAILED(status)) return status;</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+      }</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+      memcpy(m_buffer + m_bufferPos, net_buffer, (end - net_buffer));</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineplus">+      m_bufferPos += (end - net_buffer);</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineplus">+    }</span>
<a href="#l24.234"></a><span id="l24.234"> </span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-        /* Now m_buffer contains either a complete line, or as complete</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-           a line as we have read so far.</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineplus">+    /* Now m_buffer contains either a complete line, or as complete</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineplus">+       a line as we have read so far.</span>
<a href="#l24.239"></a><span id="l24.239"> </span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-           If we have a line, process it, and then remove it from `m_buffer'.</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-           Then go around the loop again, until we drain the incoming data.</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">-         */</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-        if (!newline)</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-            return NS_OK;</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineminus">-</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineminus">-        if (NS_FAILED(ConvertAndSendBuffer()))</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineplus">+       If we have a line, process it, and then remove it from `m_buffer'.</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineplus">+       Then go around the loop again, until we drain the incoming data.</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineplus">+     */</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineplus">+    if (!newline) return NS_OK;</span>
<a href="#l24.252"></a><span id="l24.252"> </span>
<a href="#l24.253"></a><span id="l24.253" class="difflineminus">-        net_buffer_size -= (newline - net_buffer);</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineminus">-        net_buffer = newline;</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineminus">-        m_bufferPos = 0;</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-    }</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-}</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineplus">+    if (NS_FAILED(ConvertAndSendBuffer())) return NS_ERROR_FAILURE;</span>
<a href="#l24.260"></a><span id="l24.260"> </span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-nsresult nsMsgLineBuffer::HandleLine(const char *line, uint32_t line_length)</span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-{</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineminus">-  NS_ASSERTION(false, &quot;must override this method if you don't provide a handler&quot;);</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineplus">+    net_buffer_size -= (newline - net_buffer);</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineplus">+    net_buffer = newline;</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineplus">+    m_bufferPos = 0;</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineplus">+  }</span>
<a href="#l24.268"></a><span id="l24.268">   return NS_OK;</span>
<a href="#l24.269"></a><span id="l24.269"> }</span>
<a href="#l24.270"></a><span id="l24.270"> </span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-nsresult nsMsgLineBuffer::ConvertAndSendBuffer()</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-{</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-    /* Convert the line terminator to the native form.</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineminus">-     */</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineplus">+nsresult nsMsgLineBuffer::HandleLine(const char *line, uint32_t line_length) {</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineplus">+  NS_ASSERTION(false,</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineplus">+               &quot;must override this method if you don't provide a handler&quot;);</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineplus">+  return NS_OK;</span>
<a href="#l24.279"></a><span id="l24.279" class="difflineplus">+}</span>
<a href="#l24.280"></a><span id="l24.280"> </span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-    char *buf = m_buffer;</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineminus">-    int32_t length = m_bufferPos;</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineminus">-</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-    char* newline;</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineplus">+nsresult nsMsgLineBuffer::ConvertAndSendBuffer() {</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineplus">+  /* Convert the line terminator to the native form.</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineplus">+   */</span>
<a href="#l24.288"></a><span id="l24.288"> </span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-    PR_ASSERT(buf &amp;&amp; length &gt; 0);</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineminus">-    if (!buf || length &lt;= 0)</span>
<a href="#l24.291"></a><span id="l24.291" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-    newline = buf + length;</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineplus">+  char *buf = m_buffer;</span>
<a href="#l24.294"></a><span id="l24.294" class="difflineplus">+  int32_t length = m_bufferPos;</span>
<a href="#l24.295"></a><span id="l24.295" class="difflineplus">+</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineplus">+  char *newline;</span>
<a href="#l24.297"></a><span id="l24.297"> </span>
<a href="#l24.298"></a><span id="l24.298" class="difflineminus">-    PR_ASSERT(newline[-1] == '\r' || newline[-1] == '\n');</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-    if (newline[-1] != '\r' &amp;&amp; newline[-1] != '\n')</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineplus">+  PR_ASSERT(buf &amp;&amp; length &gt; 0);</span>
<a href="#l24.302"></a><span id="l24.302" class="difflineplus">+  if (!buf || length &lt;= 0) return NS_ERROR_FAILURE;</span>
<a href="#l24.303"></a><span id="l24.303" class="difflineplus">+  newline = buf + length;</span>
<a href="#l24.304"></a><span id="l24.304"> </span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-    if (m_convertNewlinesP)</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-    {</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineplus">+  PR_ASSERT(newline[-1] == '\r' || newline[-1] == '\n');</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineplus">+  if (newline[-1] != '\r' &amp;&amp; newline[-1] != '\n') return NS_ERROR_FAILURE;</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineplus">+</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineplus">+  if (m_convertNewlinesP) {</span>
<a href="#l24.311"></a><span id="l24.311"> #if (MSG_LINEBREAK_LEN == 1)</span>
<a href="#l24.312"></a><span id="l24.312" class="difflineminus">-      if ((newline - buf) &gt;= 2 &amp;&amp;</span>
<a href="#l24.313"></a><span id="l24.313" class="difflineminus">-           newline[-2] == '\r' &amp;&amp;</span>
<a href="#l24.314"></a><span id="l24.314" class="difflineminus">-           newline[-1] == '\n')</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-      {</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-        /* CRLF -&gt; CR or LF */</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineminus">-        buf [length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-        length--;</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-      }</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineminus">-      else if (newline &gt; buf + 1 &amp;&amp;</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineminus">-             newline[-1] != MSG_LINEBREAK[0])</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineminus">-      {</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineminus">-        /* CR -&gt; LF or LF -&gt; CR */</span>
<a href="#l24.324"></a><span id="l24.324" class="difflineminus">-        buf [length - 1] = MSG_LINEBREAK[0];</span>
<a href="#l24.325"></a><span id="l24.325" class="difflineminus">-      }</span>
<a href="#l24.326"></a><span id="l24.326" class="difflineplus">+    if ((newline - buf) &gt;= 2 &amp;&amp; newline[-2] == '\r' &amp;&amp; newline[-1] == '\n') {</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineplus">+      /* CRLF -&gt; CR or LF */</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineplus">+      buf[length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineplus">+      length--;</span>
<a href="#l24.330"></a><span id="l24.330" class="difflineplus">+    } else if (newline &gt; buf + 1 &amp;&amp; newline[-1] != MSG_LINEBREAK[0]) {</span>
<a href="#l24.331"></a><span id="l24.331" class="difflineplus">+      /* CR -&gt; LF or LF -&gt; CR */</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineplus">+      buf[length - 1] = MSG_LINEBREAK[0];</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineplus">+    }</span>
<a href="#l24.334"></a><span id="l24.334"> #else</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineminus">-      if (((newline - buf) &gt;= 2 &amp;&amp; newline[-2] != '\r') ||</span>
<a href="#l24.336"></a><span id="l24.336" class="difflineminus">-               ((newline - buf) &gt;= 1 &amp;&amp; newline[-1] != '\n'))</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineminus">-      {</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineminus">-        /* LF -&gt; CRLF or CR -&gt; CRLF */</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineminus">-        length++;</span>
<a href="#l24.340"></a><span id="l24.340" class="difflineminus">-        buf[length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">-        buf[length - 1] = MSG_LINEBREAK[1];</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineminus">-      }</span>
<a href="#l24.343"></a><span id="l24.343" class="difflineplus">+    if (((newline - buf) &gt;= 2 &amp;&amp; newline[-2] != '\r') ||</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineplus">+        ((newline - buf) &gt;= 1 &amp;&amp; newline[-1] != '\n')) {</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineplus">+      /* LF -&gt; CRLF or CR -&gt; CRLF */</span>
<a href="#l24.346"></a><span id="l24.346" class="difflineplus">+      length++;</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineplus">+      buf[length - 2] = MSG_LINEBREAK[0];</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineplus">+      buf[length - 1] = MSG_LINEBREAK[1];</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineplus">+    }</span>
<a href="#l24.350"></a><span id="l24.350"> #endif</span>
<a href="#l24.351"></a><span id="l24.351" class="difflineminus">-    }</span>
<a href="#l24.352"></a><span id="l24.352" class="difflineminus">-    return (m_handler) ? m_handler-&gt;HandleLine(buf, length) : HandleLine(buf, length);</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineplus">+  }</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineplus">+  return (m_handler) ? m_handler-&gt;HandleLine(buf, length)</span>
<a href="#l24.355"></a><span id="l24.355" class="difflineplus">+                     : HandleLine(buf, length);</span>
<a href="#l24.356"></a><span id="l24.356"> }</span>
<a href="#l24.357"></a><span id="l24.357"> </span>
<a href="#l24.358"></a><span id="l24.358"> // If there's still some data (non CRLF terminated) flush it out</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-nsresult nsMsgLineBuffer::FlushLastLine()</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineminus">-{</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineplus">+nsresult nsMsgLineBuffer::FlushLastLine() {</span>
<a href="#l24.362"></a><span id="l24.362">   char *buf = m_buffer + m_bufferPos;</span>
<a href="#l24.363"></a><span id="l24.363">   int32_t length = m_bufferPos - 1;</span>
<a href="#l24.364"></a><span id="l24.364">   if (length &gt; 0)</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineminus">-    return (m_handler) ? m_handler-&gt;HandleLine(buf, length) : HandleLine(buf, length);</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineplus">+    return (m_handler) ? m_handler-&gt;HandleLine(buf, length)</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineplus">+                       : HandleLine(buf, length);</span>
<a href="#l24.368"></a><span id="l24.368">   else</span>
<a href="#l24.369"></a><span id="l24.369">     return NS_OK;</span>
<a href="#l24.370"></a><span id="l24.370"> }</span>
<a href="#l24.371"></a><span id="l24.371"> </span>
<a href="#l24.372"></a><span id="l24.372"> ///////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineminus">-// This is a utility class used to efficiently extract lines from an input stream by buffering</span>
<a href="#l24.374"></a><span id="l24.374" class="difflineminus">-// read but unprocessed stream data in a buffer.</span>
<a href="#l24.375"></a><span id="l24.375" class="difflineplus">+// This is a utility class used to efficiently extract lines from an input</span>
<a href="#l24.376"></a><span id="l24.376" class="difflineplus">+// stream by buffering read but unprocessed stream data in a buffer.</span>
<a href="#l24.377"></a><span id="l24.377"> ///////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.378"></a><span id="l24.378"> </span>
<a href="#l24.379"></a><span id="l24.379" class="difflineminus">-nsMsgLineStreamBuffer::nsMsgLineStreamBuffer(uint32_t aBufferSize, bool aAllocateNewLines, bool aEatCRLFs, char aLineToken)</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">-           : m_eatCRLFs(aEatCRLFs), m_allocateNewLines(aAllocateNewLines), m_lineToken(aLineToken)</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineminus">-{</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineplus">+nsMsgLineStreamBuffer::nsMsgLineStreamBuffer(uint32_t aBufferSize,</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineplus">+                                             bool aAllocateNewLines,</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineplus">+                                             bool aEatCRLFs, char aLineToken)</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineplus">+    : m_eatCRLFs(aEatCRLFs),</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineplus">+      m_allocateNewLines(aAllocateNewLines),</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineplus">+      m_lineToken(aLineToken) {</span>
<a href="#l24.388"></a><span id="l24.388">   NS_ASSERTION(aBufferSize &gt; 0, &quot;invalid buffer size!!!&quot;);</span>
<a href="#l24.389"></a><span id="l24.389">   m_dataBuffer = nullptr;</span>
<a href="#l24.390"></a><span id="l24.390">   m_startPos = 0;</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineminus">-    m_numBytesInBuffer = 0;</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineplus">+  m_numBytesInBuffer = 0;</span>
<a href="#l24.393"></a><span id="l24.393"> </span>
<a href="#l24.394"></a><span id="l24.394">   // used to buffer incoming data by ReadNextLineFromInput</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineminus">-  if (aBufferSize &gt; 0)</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineminus">-  {</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineminus">-    m_dataBuffer = (char *) PR_CALLOC(sizeof(char) * aBufferSize);</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+  if (aBufferSize &gt; 0) {</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineplus">+    m_dataBuffer = (char *)PR_CALLOC(sizeof(char) * aBufferSize);</span>
<a href="#l24.400"></a><span id="l24.400">   }</span>
<a href="#l24.401"></a><span id="l24.401"> </span>
<a href="#l24.402"></a><span id="l24.402">   m_dataBufferSize = aBufferSize;</span>
<a href="#l24.403"></a><span id="l24.403"> }</span>
<a href="#l24.404"></a><span id="l24.404"> </span>
<a href="#l24.405"></a><span id="l24.405" class="difflineminus">-nsMsgLineStreamBuffer::~nsMsgLineStreamBuffer()</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineminus">-{</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineminus">-  PR_FREEIF(m_dataBuffer); // release our buffer...</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineplus">+nsMsgLineStreamBuffer::~nsMsgLineStreamBuffer() {</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineplus">+  PR_FREEIF(m_dataBuffer);  // release our buffer...</span>
<a href="#l24.410"></a><span id="l24.410"> }</span>
<a href="#l24.411"></a><span id="l24.411"> </span>
<a href="#l24.412"></a><span id="l24.412" class="difflineminus">-nsresult nsMsgLineStreamBuffer::GrowBuffer(uint32_t desiredSize)</span>
<a href="#l24.413"></a><span id="l24.413" class="difflineminus">-{</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineminus">-  char* newBuffer = (char *) PR_REALLOC(m_dataBuffer, desiredSize);</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineplus">+nsresult nsMsgLineStreamBuffer::GrowBuffer(uint32_t desiredSize) {</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineplus">+  char *newBuffer = (char *)PR_REALLOC(m_dataBuffer, desiredSize);</span>
<a href="#l24.417"></a><span id="l24.417">   NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l24.418"></a><span id="l24.418">   m_dataBuffer = newBuffer;</span>
<a href="#l24.419"></a><span id="l24.419">   m_dataBufferSize = desiredSize;</span>
<a href="#l24.420"></a><span id="l24.420">   return NS_OK;</span>
<a href="#l24.421"></a><span id="l24.421"> }</span>
<a href="#l24.422"></a><span id="l24.422"> </span>
<a href="#l24.423"></a><span id="l24.423" class="difflineminus">-void nsMsgLineStreamBuffer::ClearBuffer()</span>
<a href="#l24.424"></a><span id="l24.424" class="difflineminus">-{</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineplus">+void nsMsgLineStreamBuffer::ClearBuffer() {</span>
<a href="#l24.426"></a><span id="l24.426">   m_startPos = 0;</span>
<a href="#l24.427"></a><span id="l24.427">   m_numBytesInBuffer = 0;</span>
<a href="#l24.428"></a><span id="l24.428"> }</span>
<a href="#l24.429"></a><span id="l24.429"> </span>
<a href="#l24.430"></a><span id="l24.430"> // aInputStream - the input stream we want to read a line from</span>
<a href="#l24.431"></a><span id="l24.431" class="difflineminus">-// aPauseForMoreData is returned as true if the stream does not yet contain a line and we must wait for more</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-// data to come into the stream.</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineminus">-// Note to people wishing to modify this function: Be *VERY CAREFUL* this is a critical function used by all of</span>
<a href="#l24.434"></a><span id="l24.434" class="difflineminus">-// our mail protocols including imap, nntp, and pop. If you screw it up, you could break a lot of stuff.....</span>
<a href="#l24.435"></a><span id="l24.435" class="difflineplus">+// aPauseForMoreData is returned as true if the stream does not yet contain a</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineplus">+// line and we must wait for more data to come into the stream. Note to people</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineplus">+// wishing to modify this function: Be *VERY CAREFUL* this is a critical</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineplus">+// function used by all of our mail protocols including imap, nntp, and pop. If</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineplus">+// you screw it up, you could break a lot of stuff.....</span>
<a href="#l24.440"></a><span id="l24.440"> </span>
<a href="#l24.441"></a><span id="l24.441" class="difflineminus">-char * nsMsgLineStreamBuffer::ReadNextLine(nsIInputStream * aInputStream, uint32_t &amp;aNumBytesInLine, bool &amp;aPauseForMoreData, nsresult *prv, bool addLineTerminator)</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineminus">-{</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineplus">+char *nsMsgLineStreamBuffer::ReadNextLine(nsIInputStream *aInputStream,</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineplus">+                                          uint32_t &amp;aNumBytesInLine,</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineplus">+                                          bool &amp;aPauseForMoreData,</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+                                          nsresult *prv,</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+                                          bool addLineTerminator) {</span>
<a href="#l24.448"></a><span id="l24.448">   // try to extract a line from m_inputBuffer. If we don't have an entire line,</span>
<a href="#l24.449"></a><span id="l24.449">   // then read more bytes out from the stream. If the stream is empty then wait</span>
<a href="#l24.450"></a><span id="l24.450">   // on the monitor for more data to come in.</span>
<a href="#l24.451"></a><span id="l24.451"> </span>
<a href="#l24.452"></a><span id="l24.452" class="difflineminus">-  NS_ASSERTION(m_dataBuffer &amp;&amp; m_dataBufferSize &gt; 0, &quot;invalid input arguments for read next line from input&quot;);</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineplus">+  NS_ASSERTION(m_dataBuffer &amp;&amp; m_dataBufferSize &gt; 0,</span>
<a href="#l24.454"></a><span id="l24.454" class="difflineplus">+               &quot;invalid input arguments for read next line from input&quot;);</span>
<a href="#l24.455"></a><span id="l24.455"> </span>
<a href="#l24.456"></a><span id="l24.456" class="difflineminus">-  if (prv)</span>
<a href="#l24.457"></a><span id="l24.457" class="difflineminus">-    *prv = NS_OK;</span>
<a href="#l24.458"></a><span id="l24.458" class="difflineplus">+  if (prv) *prv = NS_OK;</span>
<a href="#l24.459"></a><span id="l24.459">   // initialize out values</span>
<a href="#l24.460"></a><span id="l24.460">   aPauseForMoreData = false;</span>
<a href="#l24.461"></a><span id="l24.461">   aNumBytesInLine = 0;</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineminus">-  char * endOfLine = nullptr;</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineminus">-  char * startOfLine = m_dataBuffer+m_startPos;</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineplus">+  char *endOfLine = nullptr;</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+  char *startOfLine = m_dataBuffer + m_startPos;</span>
<a href="#l24.466"></a><span id="l24.466"> </span>
<a href="#l24.467"></a><span id="l24.467" class="difflineminus">-  if (m_numBytesInBuffer &gt; 0) // any data in our internal buffer?</span>
<a href="#l24.468"></a><span id="l24.468" class="difflineminus">-    endOfLine = PL_strchr(startOfLine, m_lineToken); // see if we already have a line ending...</span>
<a href="#l24.469"></a><span id="l24.469" class="difflineplus">+  if (m_numBytesInBuffer &gt; 0)  // any data in our internal buffer?</span>
<a href="#l24.470"></a><span id="l24.470" class="difflineplus">+    endOfLine = PL_strchr(startOfLine, m_lineToken);  // see if we already</span>
<a href="#l24.471"></a><span id="l24.471" class="difflineplus">+                                                      // have a line ending...</span>
<a href="#l24.472"></a><span id="l24.472"> </span>
<a href="#l24.473"></a><span id="l24.473" class="difflineminus">-  // it's possible that we got here before the first time we receive data from the server</span>
<a href="#l24.474"></a><span id="l24.474" class="difflineminus">-  // so aInputStream will be nullptr...</span>
<a href="#l24.475"></a><span id="l24.475" class="difflineminus">-  if (!endOfLine &amp;&amp; aInputStream) // get some more data from the server</span>
<a href="#l24.476"></a><span id="l24.476" class="difflineplus">+  // it's possible that we got here before the first time we receive data from</span>
<a href="#l24.477"></a><span id="l24.477" class="difflineplus">+  // the server so aInputStream will be nullptr...</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineplus">+  if (!endOfLine &amp;&amp; aInputStream)  // get some more data from the server</span>
<a href="#l24.479"></a><span id="l24.479">   {</span>
<a href="#l24.480"></a><span id="l24.480">     nsresult rv;</span>
<a href="#l24.481"></a><span id="l24.481">     uint64_t numBytesInStream = 0;</span>
<a href="#l24.482"></a><span id="l24.482">     uint32_t numBytesCopied = 0;</span>
<a href="#l24.483"></a><span id="l24.483">     bool nonBlockingStream;</span>
<a href="#l24.484"></a><span id="l24.484">     aInputStream-&gt;IsNonBlocking(&amp;nonBlockingStream);</span>
<a href="#l24.485"></a><span id="l24.485">     rv = aInputStream-&gt;Available(&amp;numBytesInStream);</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.487"></a><span id="l24.487" class="difflineminus">-    {</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineminus">-      if (prv)</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineminus">-        *prv = rv;</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineplus">+      if (prv) *prv = rv;</span>
<a href="#l24.492"></a><span id="l24.492">       aNumBytesInLine = -1;</span>
<a href="#l24.493"></a><span id="l24.493">       return nullptr;</span>
<a href="#l24.494"></a><span id="l24.494">     }</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineminus">-    if (!nonBlockingStream &amp;&amp; numBytesInStream == 0) // if no data available,</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineminus">-      numBytesInStream = m_dataBufferSize / 2; // ask for half the data buffer size.</span>
<a href="#l24.497"></a><span id="l24.497" class="difflineplus">+    if (!nonBlockingStream &amp;&amp; numBytesInStream == 0)  // if no data available,</span>
<a href="#l24.498"></a><span id="l24.498" class="difflineplus">+      numBytesInStream = m_dataBufferSize / 2;        // ask for half the data</span>
<a href="#l24.499"></a><span id="l24.499" class="difflineplus">+                                                      // buffer size.</span>
<a href="#l24.500"></a><span id="l24.500"> </span>
<a href="#l24.501"></a><span id="l24.501" class="difflineminus">-    // if the number of bytes we want to read from the stream, is greater than the number</span>
<a href="#l24.502"></a><span id="l24.502" class="difflineminus">-    // of bytes left in our buffer, then we need to shift the start pos and its contents</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineminus">-    // down to the beginning of m_dataBuffer...</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineminus">-    uint32_t numFreeBytesInBuffer = m_dataBufferSize - m_startPos - m_numBytesInBuffer;</span>
<a href="#l24.505"></a><span id="l24.505" class="difflineminus">-    if (numBytesInStream &gt;= numFreeBytesInBuffer)</span>
<a href="#l24.506"></a><span id="l24.506" class="difflineminus">-    {</span>
<a href="#l24.507"></a><span id="l24.507" class="difflineminus">-      if (m_startPos)</span>
<a href="#l24.508"></a><span id="l24.508" class="difflineminus">-      {</span>
<a href="#l24.509"></a><span id="l24.509" class="difflineplus">+    // if the number of bytes we want to read from the stream, is greater than</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineplus">+    // the number of bytes left in our buffer, then we need to shift the start</span>
<a href="#l24.511"></a><span id="l24.511" class="difflineplus">+    // pos and its contents down to the beginning of m_dataBuffer...</span>
<a href="#l24.512"></a><span id="l24.512" class="difflineplus">+    uint32_t numFreeBytesInBuffer =</span>
<a href="#l24.513"></a><span id="l24.513" class="difflineplus">+        m_dataBufferSize - m_startPos - m_numBytesInBuffer;</span>
<a href="#l24.514"></a><span id="l24.514" class="difflineplus">+    if (numBytesInStream &gt;= numFreeBytesInBuffer) {</span>
<a href="#l24.515"></a><span id="l24.515" class="difflineplus">+      if (m_startPos) {</span>
<a href="#l24.516"></a><span id="l24.516">         memmove(m_dataBuffer, startOfLine, m_numBytesInBuffer);</span>
<a href="#l24.517"></a><span id="l24.517">         // make sure the end of the buffer is terminated</span>
<a href="#l24.518"></a><span id="l24.518">         m_dataBuffer[m_numBytesInBuffer] = '\0';</span>
<a href="#l24.519"></a><span id="l24.519">         m_startPos = 0;</span>
<a href="#l24.520"></a><span id="l24.520">         startOfLine = m_dataBuffer;</span>
<a href="#l24.521"></a><span id="l24.521">         numFreeBytesInBuffer = m_dataBufferSize - m_numBytesInBuffer;</span>
<a href="#l24.522"></a><span id="l24.522" class="difflineminus">-        //printf(&quot;moving data in read line around because buffer filling up\n&quot;);</span>
<a href="#l24.523"></a><span id="l24.523">       }</span>
<a href="#l24.524"></a><span id="l24.524">       // If we didn't make enough space (or any), grow the buffer</span>
<a href="#l24.525"></a><span id="l24.525" class="difflineminus">-      if (numBytesInStream &gt;= numFreeBytesInBuffer)</span>
<a href="#l24.526"></a><span id="l24.526" class="difflineminus">-      {</span>
<a href="#l24.527"></a><span id="l24.527" class="difflineplus">+      if (numBytesInStream &gt;= numFreeBytesInBuffer) {</span>
<a href="#l24.528"></a><span id="l24.528">         int64_t growBy = (numBytesInStream - numFreeBytesInBuffer) * 2 + 1;</span>
<a href="#l24.529"></a><span id="l24.529">         // GrowBuffer cannot handles over 4GB size</span>
<a href="#l24.530"></a><span id="l24.530" class="difflineminus">-        if (m_dataBufferSize + growBy &gt; PR_UINT32_MAX)</span>
<a href="#l24.531"></a><span id="l24.531" class="difflineminus">-          return nullptr;</span>
<a href="#l24.532"></a><span id="l24.532" class="difflineplus">+        if (m_dataBufferSize + growBy &gt; PR_UINT32_MAX) return nullptr;</span>
<a href="#l24.533"></a><span id="l24.533">         // try growing buffer by twice as much as we need.</span>
<a href="#l24.534"></a><span id="l24.534">         nsresult rv = GrowBuffer(m_dataBufferSize + growBy);</span>
<a href="#l24.535"></a><span id="l24.535">         // if we can't grow the buffer, we have to bail.</span>
<a href="#l24.536"></a><span id="l24.536" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l24.537"></a><span id="l24.537" class="difflineminus">-          return nullptr;</span>
<a href="#l24.538"></a><span id="l24.538" class="difflineplus">+        if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l24.539"></a><span id="l24.539">         startOfLine = m_dataBuffer;</span>
<a href="#l24.540"></a><span id="l24.540">         numFreeBytesInBuffer += growBy;</span>
<a href="#l24.541"></a><span id="l24.541">       }</span>
<a href="#l24.542"></a><span id="l24.542">       NS_ASSERTION(m_startPos == 0, &quot;m_startPos should be 0 .....&quot;);</span>
<a href="#l24.543"></a><span id="l24.543">     }</span>
<a href="#l24.544"></a><span id="l24.544"> </span>
<a href="#l24.545"></a><span id="l24.545" class="difflineminus">-    uint32_t numBytesToCopy = std::min(uint64_t(numFreeBytesInBuffer - 1) /* leave one for a null terminator */, numBytesInStream);</span>
<a href="#l24.546"></a><span id="l24.546" class="difflineminus">-    if (numBytesToCopy &gt; 0)</span>
<a href="#l24.547"></a><span id="l24.547" class="difflineminus">-    {</span>
<a href="#l24.548"></a><span id="l24.548" class="difflineplus">+    uint32_t numBytesToCopy = /* leave one for a null terminator */</span>
<a href="#l24.549"></a><span id="l24.549" class="difflineplus">+        std::min(uint64_t(numFreeBytesInBuffer - 1), numBytesInStream);</span>
<a href="#l24.550"></a><span id="l24.550" class="difflineplus">+    if (numBytesToCopy &gt; 0) {</span>
<a href="#l24.551"></a><span id="l24.551">       // read the data into the end of our data buffer</span>
<a href="#l24.552"></a><span id="l24.552">       char *startOfNewData = startOfLine + m_numBytesInBuffer;</span>
<a href="#l24.553"></a><span id="l24.553">       rv = aInputStream-&gt;Read(startOfNewData, numBytesToCopy, &amp;numBytesCopied);</span>
<a href="#l24.554"></a><span id="l24.554" class="difflineminus">-      if (prv)</span>
<a href="#l24.555"></a><span id="l24.555" class="difflineminus">-        *prv = rv;</span>
<a href="#l24.556"></a><span id="l24.556" class="difflineplus">+      if (prv) *prv = rv;</span>
<a href="#l24.557"></a><span id="l24.557">       uint32_t i;</span>
<a href="#l24.558"></a><span id="l24.558">       for (i = 0; i &lt; numBytesCopied; i++)  // replace nulls with spaces</span>
<a href="#l24.559"></a><span id="l24.559">       {</span>
<a href="#l24.560"></a><span id="l24.560" class="difflineminus">-        if (!startOfNewData[i])</span>
<a href="#l24.561"></a><span id="l24.561" class="difflineminus">-          startOfNewData[i] = ' ';</span>
<a href="#l24.562"></a><span id="l24.562" class="difflineplus">+        if (!startOfNewData[i]) startOfNewData[i] = ' ';</span>
<a href="#l24.563"></a><span id="l24.563">       }</span>
<a href="#l24.564"></a><span id="l24.564">       m_numBytesInBuffer += numBytesCopied;</span>
<a href="#l24.565"></a><span id="l24.565">       m_dataBuffer[m_startPos + m_numBytesInBuffer] = '\0';</span>
<a href="#l24.566"></a><span id="l24.566"> </span>
<a href="#l24.567"></a><span id="l24.567">       // okay, now that we've tried to read in more data from the stream,</span>
<a href="#l24.568"></a><span id="l24.568">       // look for another end of line character in the new data</span>
<a href="#l24.569"></a><span id="l24.569">       endOfLine = PL_strchr(startOfNewData, m_lineToken);</span>
<a href="#l24.570"></a><span id="l24.570">     }</span>
<a href="#l24.571"></a><span id="l24.571">   }</span>
<a href="#l24.572"></a><span id="l24.572"> </span>
<a href="#l24.573"></a><span id="l24.573">   // okay, now check again for endOfLine.</span>
<a href="#l24.574"></a><span id="l24.574" class="difflineminus">-  if (endOfLine)</span>
<a href="#l24.575"></a><span id="l24.575" class="difflineminus">-  {</span>
<a href="#l24.576"></a><span id="l24.576" class="difflineminus">-    if (!m_eatCRLFs)</span>
<a href="#l24.577"></a><span id="l24.577" class="difflineminus">-      endOfLine += 1; // count for LF or CR</span>
<a href="#l24.578"></a><span id="l24.578" class="difflineplus">+  if (endOfLine) {</span>
<a href="#l24.579"></a><span id="l24.579" class="difflineplus">+    if (!m_eatCRLFs) endOfLine += 1;  // count for LF or CR</span>
<a href="#l24.580"></a><span id="l24.580"> </span>
<a href="#l24.581"></a><span id="l24.581">     aNumBytesInLine = endOfLine - startOfLine;</span>
<a href="#l24.582"></a><span id="l24.582"> </span>
<a href="#l24.583"></a><span id="l24.583" class="difflineminus">-    if (m_eatCRLFs &amp;&amp; aNumBytesInLine &gt; 0 &amp;&amp; startOfLine[aNumBytesInLine-1] == '\r') // Remove the CR in a CRLF sequence</span>
<a href="#l24.584"></a><span id="l24.584" class="difflineminus">-      aNumBytesInLine--;</span>
<a href="#l24.585"></a><span id="l24.585" class="difflineplus">+    if (m_eatCRLFs &amp;&amp; aNumBytesInLine &gt; 0 &amp;&amp;</span>
<a href="#l24.586"></a><span id="l24.586" class="difflineplus">+        startOfLine[aNumBytesInLine - 1] == '\r')</span>
<a href="#l24.587"></a><span id="l24.587" class="difflineplus">+      aNumBytesInLine--;  // Remove the CR in a CRLF sequence.</span>
<a href="#l24.588"></a><span id="l24.588"> </span>
<a href="#l24.589"></a><span id="l24.589">     // PR_CALLOC zeros out the allocated line</span>
<a href="#l24.590"></a><span id="l24.590" class="difflineminus">-    char* newLine = (char*) PR_CALLOC(aNumBytesInLine + (addLineTerminator ? MSG_LINEBREAK_LEN : 0) + 1);</span>
<a href="#l24.591"></a><span id="l24.591" class="difflineminus">-    if (!newLine)</span>
<a href="#l24.592"></a><span id="l24.592" class="difflineminus">-    {</span>
<a href="#l24.593"></a><span id="l24.593" class="difflineplus">+    char *newLine = (char *)PR_CALLOC(</span>
<a href="#l24.594"></a><span id="l24.594" class="difflineplus">+        aNumBytesInLine + (addLineTerminator ? MSG_LINEBREAK_LEN : 0) + 1);</span>
<a href="#l24.595"></a><span id="l24.595" class="difflineplus">+    if (!newLine) {</span>
<a href="#l24.596"></a><span id="l24.596">       aNumBytesInLine = 0;</span>
<a href="#l24.597"></a><span id="l24.597">       aPauseForMoreData = true;</span>
<a href="#l24.598"></a><span id="l24.598">       return nullptr;</span>
<a href="#l24.599"></a><span id="l24.599">     }</span>
<a href="#l24.600"></a><span id="l24.600"> </span>
<a href="#l24.601"></a><span id="l24.601" class="difflineminus">-    memcpy(newLine, startOfLine, aNumBytesInLine); // copy the string into the new line buffer</span>
<a href="#l24.602"></a><span id="l24.602" class="difflineminus">-    if (addLineTerminator)</span>
<a href="#l24.603"></a><span id="l24.603" class="difflineminus">-    {</span>
<a href="#l24.604"></a><span id="l24.604" class="difflineplus">+    memcpy(newLine, startOfLine,</span>
<a href="#l24.605"></a><span id="l24.605" class="difflineplus">+           aNumBytesInLine);  // copy the string into the new line buffer</span>
<a href="#l24.606"></a><span id="l24.606" class="difflineplus">+    if (addLineTerminator) {</span>
<a href="#l24.607"></a><span id="l24.607">       memcpy(newLine + aNumBytesInLine, MSG_LINEBREAK, MSG_LINEBREAK_LEN);</span>
<a href="#l24.608"></a><span id="l24.608">       aNumBytesInLine += MSG_LINEBREAK_LEN;</span>
<a href="#l24.609"></a><span id="l24.609">     }</span>
<a href="#l24.610"></a><span id="l24.610"> </span>
<a href="#l24.611"></a><span id="l24.611">     if (m_eatCRLFs)</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineminus">-      endOfLine += 1; // advance past LF or CR if we haven't already done so...</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineplus">+      endOfLine += 1;  // advance past LF or CR if we haven't already done so...</span>
<a href="#l24.614"></a><span id="l24.614"> </span>
<a href="#l24.615"></a><span id="l24.615" class="difflineminus">-    // now we need to update the data buffer to go past the line we just read out.</span>
<a href="#l24.616"></a><span id="l24.616" class="difflineplus">+    // now we need to update the data buffer to go past the line we just read</span>
<a href="#l24.617"></a><span id="l24.617" class="difflineplus">+    // out.</span>
<a href="#l24.618"></a><span id="l24.618">     m_numBytesInBuffer -= (endOfLine - startOfLine);</span>
<a href="#l24.619"></a><span id="l24.619">     if (m_numBytesInBuffer)</span>
<a href="#l24.620"></a><span id="l24.620">       m_startPos = endOfLine - m_dataBuffer;</span>
<a href="#l24.621"></a><span id="l24.621">     else</span>
<a href="#l24.622"></a><span id="l24.622">       m_startPos = 0;</span>
<a href="#l24.623"></a><span id="l24.623"> </span>
<a href="#l24.624"></a><span id="l24.624">     return newLine;</span>
<a href="#l24.625"></a><span id="l24.625">   }</span>
<a href="#l24.626"></a><span id="l24.626"> </span>
<a href="#l24.627"></a><span id="l24.627">   aPauseForMoreData = true;</span>
<a href="#l24.628"></a><span id="l24.628" class="difflineminus">-  return nullptr; // if we somehow got here. we don't have another line in the buffer yet...need to wait for more data...</span>
<a href="#l24.629"></a><span id="l24.629" class="difflineplus">+  return nullptr;  // if we somehow got here. we don't have another line in the</span>
<a href="#l24.630"></a><span id="l24.630" class="difflineplus">+                   // buffer yet...need to wait for more data...</span>
<a href="#l24.631"></a><span id="l24.631"> }</span>
<a href="#l24.632"></a><span id="l24.632"> </span>
<a href="#l24.633"></a><span id="l24.633" class="difflineminus">-bool nsMsgLineStreamBuffer::NextLineAvailable()</span>
<a href="#l24.634"></a><span id="l24.634" class="difflineminus">-{</span>
<a href="#l24.635"></a><span id="l24.635" class="difflineminus">-  return (m_numBytesInBuffer &gt; 0 &amp;&amp; PL_strchr(m_dataBuffer+m_startPos, m_lineToken));</span>
<a href="#l24.636"></a><span id="l24.636" class="difflineplus">+bool nsMsgLineStreamBuffer::NextLineAvailable() {</span>
<a href="#l24.637"></a><span id="l24.637" class="difflineplus">+  return (m_numBytesInBuffer &gt; 0 &amp;&amp;</span>
<a href="#l24.638"></a><span id="l24.638" class="difflineplus">+          PL_strchr(m_dataBuffer + m_startPos, m_lineToken));</span>
<a href="#l24.639"></a><span id="l24.639"> }</span>
<a href="#l24.640"></a><span id="l24.640" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/util/nsMsgLineBuffer.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgLineBuffer.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,110 +1,121 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l25.5"></a><span id="l25.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8"> #ifndef _nsMsgLineBuffer_H</span>
<a href="#l25.9"></a><span id="l25.9"> #define _nsMsgLineBuffer_H</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l25.13"></a><span id="l25.13"> </span>
<a href="#l25.14"></a><span id="l25.14"> // I can't believe I have to have this stupid class, but I can't find</span>
<a href="#l25.15"></a><span id="l25.15"> // anything suitable (nsStrImpl might be, when it's done). nsIByteBuffer</span>
<a href="#l25.16"></a><span id="l25.16"> // would do, if I had a stream for input, which I don't.</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-class NS_MSG_BASE nsByteArray</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-{</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-public:</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+class NS_MSG_BASE nsByteArray {</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+ public:</span>
<a href="#l25.23"></a><span id="l25.23">   nsByteArray();</span>
<a href="#l25.24"></a><span id="l25.24">   virtual ~nsByteArray();</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  uint32_t  GetSize() {return m_bufferSize;}</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-  uint32_t  GetBufferPos() {return m_bufferPos;}</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-  nsresult  GrowBuffer(uint32_t desired_size, uint32_t quantum = 1024);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-  nsresult  AppendString(const char *string);</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-  nsresult  AppendBuffer(const char *buffer, uint32_t length);</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-  void    ResetWritePos() {m_bufferPos = 0;}</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  char    *GetBuffer() {return m_buffer;}</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-protected:</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-  char    *m_buffer;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-  uint32_t  m_bufferSize;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-  uint32_t  m_bufferPos;  // write Pos in m_buffer - where the next byte should go.</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+  uint32_t GetSize() { return m_bufferSize; }</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+  uint32_t GetBufferPos() { return m_bufferPos; }</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+  nsresult GrowBuffer(uint32_t desired_size, uint32_t quantum = 1024);</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+  nsresult AppendString(const char *string);</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+  nsresult AppendBuffer(const char *buffer, uint32_t length);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+  void ResetWritePos() { m_bufferPos = 0; }</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+  char *GetBuffer() { return m_buffer; }</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+ protected:</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+  char *m_buffer;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+  uint32_t m_bufferSize;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+  uint32_t</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+      m_bufferPos;  // write Pos in m_buffer - where the next byte should go.</span>
<a href="#l25.49"></a><span id="l25.49"> };</span>
<a href="#l25.50"></a><span id="l25.50"> </span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-class NS_MSG_BASE nsMsgLineBufferHandler : public nsByteArray</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-{</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-public:</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+class NS_MSG_BASE nsMsgLineBufferHandler : public nsByteArray {</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+ public:</span>
<a href="#l25.57"></a><span id="l25.57">   virtual nsresult HandleLine(const char *line, uint32_t line_length) = 0;</span>
<a href="#l25.58"></a><span id="l25.58"> };</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-class NS_MSG_BASE nsMsgLineBuffer : public nsMsgLineBufferHandler</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-{</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-public:</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+class NS_MSG_BASE nsMsgLineBuffer : public nsMsgLineBufferHandler {</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+ public:</span>
<a href="#l25.65"></a><span id="l25.65">   nsMsgLineBuffer(nsMsgLineBufferHandler *handler, bool convertNewlinesP);</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-  virtual    ~nsMsgLineBuffer();</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-  nsresult    BufferInput(const char *net_buffer, int32_t net_buffer_size);</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+  virtual ~nsMsgLineBuffer();</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+  nsresult BufferInput(const char *net_buffer, int32_t net_buffer_size);</span>
<a href="#l25.71"></a><span id="l25.71">   // Not sure why anyone cares, by NNTPHost seems to want to know the buf pos.</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-  uint32_t    GetBufferPos() {return m_bufferPos;}</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+  uint32_t GetBufferPos() { return m_bufferPos; }</span>
<a href="#l25.74"></a><span id="l25.74"> </span>
<a href="#l25.75"></a><span id="l25.75">   virtual nsresult HandleLine(const char *line, uint32_t line_length);</span>
<a href="#l25.76"></a><span id="l25.76">   // flush last line, though it won't be CRLF terminated.</span>
<a href="#l25.77"></a><span id="l25.77">   virtual nsresult FlushLastLine();</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-protected:</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+ protected:</span>
<a href="#l25.81"></a><span id="l25.81">   explicit nsMsgLineBuffer(bool convertNewlinesP);</span>
<a href="#l25.82"></a><span id="l25.82"> </span>
<a href="#l25.83"></a><span id="l25.83">   nsresult ConvertAndSendBuffer();</span>
<a href="#l25.84"></a><span id="l25.84">   void SetLookingForCRLF(bool b);</span>
<a href="#l25.85"></a><span id="l25.85"> </span>
<a href="#l25.86"></a><span id="l25.86">   nsMsgLineBufferHandler *m_handler;</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-  bool        m_convertNewlinesP;</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-  bool        m_lookingForCRLF;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+  bool m_convertNewlinesP;</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+  bool m_lookingForCRLF;</span>
<a href="#l25.91"></a><span id="l25.91"> };</span>
<a href="#l25.92"></a><span id="l25.92"> </span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-// I'm adding this utility class here for lack of a better place. This utility class is similar to nsMsgLineBuffer</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-// except it works from an input stream. It is geared towards efficiently parsing new lines out of a stream by storing</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-// read but unprocessed bytes in a buffer. I envision the primary use of this to be our mail protocols such as imap, news and</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-// pop which need to process line by line data being returned in the form of a proxied stream from the server.</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+// I'm adding this utility class here for lack of a better place. This utility</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+// class is similar to nsMsgLineBuffer except it works from an input stream. It</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+// is geared towards efficiently parsing new lines out of a stream by storing</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+// read but unprocessed bytes in a buffer. I envision the primary use of this to</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+// be our mail protocols such as imap, news and pop which need to process line</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+// by line data being returned in the form of a proxied stream from the server.</span>
<a href="#l25.103"></a><span id="l25.103"> </span>
<a href="#l25.104"></a><span id="l25.104"> class nsIInputStream;</span>
<a href="#l25.105"></a><span id="l25.105"> </span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-class NS_MSG_BASE nsMsgLineStreamBuffer</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-{</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-public:</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+class NS_MSG_BASE nsMsgLineStreamBuffer {</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+ public:</span>
<a href="#l25.111"></a><span id="l25.111">   NS_INLINE_DECL_REFCOUNTING(nsMsgLineStreamBuffer)</span>
<a href="#l25.112"></a><span id="l25.112"> </span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-  // aBufferSize -- size of the buffer you want us to use for buffering stream data</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-  // aEndOfLinetoken -- The delimiter string to be used for determining the end of line. This</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-  //              allows us to parse platform specific end of line endings by making it</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-  //            a parameter.</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-  // aAllocateNewLines -- true if you want calls to ReadNextLine to allocate new memory for the line.</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-  //            if false, the char * returned is just a ptr into the buffer. Subsequent calls to</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-  //            ReadNextLine will alter the data so your ptr only has a life time of a per call.</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-  // aEatCRLFs  -- true if you don't want to see the CRLFs on the lines returned by ReadNextLine.</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-  //         false if you do want to see them.</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-  // aLineToken -- Specify the line token to look for, by default is LF ('\n') which cover as well CRLF. If</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-  //            lines are terminated with a CR only, you need to set aLineToken to CR ('\r')</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-  nsMsgLineStreamBuffer(uint32_t aBufferSize, bool aAllocateNewLines,</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-                        bool aEatCRLFs = true, char aLineToken = '\n'); // specify the size of the buffer you want the class to use....</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+  // aBufferSize -- size of the buffer you want us to use for buffering stream</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+  //                data</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+  // aEndOfLinetoken -- The delimiter string to be used for determining the end</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+  //                of line. This allows us to parse platform specific end of</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+  //                line endings by making it a parameter.</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+  // aAllocateNewLines -- true if you want calls to ReadNextLine to allocate new</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+  //                memory for the line.</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+  //                if false, the char * returned is just a ptr into the buffer.</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+  //                Subsequent calls to ReadNextLine will alter the data so your</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+  //                ptr only has a life time of a per call.</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+  // aEatCRLFs --   true if you don't want to see the CRLFs on the lines</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+  //                returned by ReadNextLine.</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+  //                false if you do want to see them.</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+  // aLineToken --  Specify the line token to look for, by default is LF ('\n')</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+  //                which cover as well CRLF. If lines are terminated with a CR</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+  //                only, you need to set aLineToken to CR ('\r')</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+  nsMsgLineStreamBuffer(</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+      uint32_t aBufferSize, bool aAllocateNewLines, bool aEatCRLFs = true,</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+      char aLineToken = '\n');  // specify the size of the buffer you want the</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+                                // class to use....</span>
<a href="#l25.146"></a><span id="l25.146"> </span>
<a href="#l25.147"></a><span id="l25.147">   // Caller must free the line returned using PR_Free</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-  // aEndOfLinetoken -- delimiter used to denote the end of a line.</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineminus">-  // aNumBytesInLine -- The number of bytes in the line returned</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineminus">-  // aPauseForMoreData -- There is not enough data in the stream to make a line at this time...</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-  char * ReadNextLine(nsIInputStream * aInputStream, uint32_t &amp;anumBytesInLine, bool &amp;aPauseForMoreData, nsresult *rv = nullptr, bool addLineTerminator = false);</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+  // aEndOfLinetoken   -- delimiter used to denote the end of a line.</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+  // aNumBytesInLine   -- The number of bytes in the line returned</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+  // aPauseForMoreData -- There is not enough data in the stream to make a line</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+  //                      at this time...</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+  char *ReadNextLine(nsIInputStream *aInputStream, uint32_t &amp;aNumBytesInLine,</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+                     bool &amp;aPauseForMoreData, nsresult *rv = nullptr,</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+                     bool addLineTerminator = false);</span>
<a href="#l25.159"></a><span id="l25.159">   nsresult GrowBuffer(uint32_t desiredSize);</span>
<a href="#l25.160"></a><span id="l25.160">   void ClearBuffer();</span>
<a href="#l25.161"></a><span id="l25.161">   bool NextLineAvailable();</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-private:</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+ private:</span>
<a href="#l25.165"></a><span id="l25.165">   virtual ~nsMsgLineStreamBuffer();</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineminus">-protected:</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+ protected:</span>
<a href="#l25.169"></a><span id="l25.169">   bool m_eatCRLFs;</span>
<a href="#l25.170"></a><span id="l25.170">   bool m_allocateNewLines;</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineminus">-  char * m_dataBuffer;</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineplus">+  char *m_dataBuffer;</span>
<a href="#l25.173"></a><span id="l25.173">   uint32_t m_dataBufferSize;</span>
<a href="#l25.174"></a><span id="l25.174">   uint32_t m_startPos;</span>
<a href="#l25.175"></a><span id="l25.175">   uint32_t m_numBytesInBuffer;</span>
<a href="#l25.176"></a><span id="l25.176">   char m_lineToken;</span>
<a href="#l25.177"></a><span id="l25.177"> };</span>
<a href="#l25.178"></a><span id="l25.178"> </span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-</span>
<a href="#l25.180"></a><span id="l25.180"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -28,92 +28,98 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l26.5"></a><span id="l26.5"> #include &quot;nsProxyRelease.h&quot;</span>
<a href="#l26.6"></a><span id="l26.6"> #include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l26.7"></a><span id="l26.7"> #include &quot;nsDocShellLoadState.h&quot;</span>
<a href="#l26.8"></a><span id="l26.8"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l26.9"></a><span id="l26.9"> #include &quot;nsIObjectInputStream.h&quot;</span>
<a href="#l26.10"></a><span id="l26.10"> #include &quot;nsIObjectOutputStream.h&quot;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-nsMsgMailNewsUrl::nsMsgMailNewsUrl()</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+nsMsgMailNewsUrl::nsMsgMailNewsUrl() {</span>
<a href="#l26.15"></a><span id="l26.15">   // nsIURI specific state</span>
<a href="#l26.16"></a><span id="l26.16">   m_runningUrl = false;</span>
<a href="#l26.17"></a><span id="l26.17">   m_updatingFolder = false;</span>
<a href="#l26.18"></a><span id="l26.18">   m_msgIsInLocalCache = false;</span>
<a href="#l26.19"></a><span id="l26.19">   m_suppressErrorMsgs = false;</span>
<a href="#l26.20"></a><span id="l26.20">   m_hasNormalizedOrigin = false;  // SetSpecInternal() will set this correctly.</span>
<a href="#l26.21"></a><span id="l26.21">   mMaxProgress = -1;</span>
<a href="#l26.22"></a><span id="l26.22"> }</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-#define NOTIFY_URL_LISTENERS(propertyfunc_, params_)                   \</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-  PR_BEGIN_MACRO                                                       \</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt; &gt;::ForwardIterator iter(mUrlListeners); \</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-  while (iter.HasMore()) {                                             \</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-    nsCOMPtr&lt;nsIUrlListener&gt; listener = iter.GetNext();                \</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-    listener-&gt;propertyfunc_ params_;                                   \</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-  }                                                                    \</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+#define NOTIFY_URL_LISTENERS(propertyfunc_, params_)                \</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+  PR_BEGIN_MACRO                                                    \</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt;&gt;::ForwardIterator iter( \</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+      mUrlListeners);                                               \</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  while (iter.HasMore()) {                                          \</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+    nsCOMPtr&lt;nsIUrlListener&gt; listener = iter.GetNext();             \</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+    listener-&gt;propertyfunc_ params_;                                \</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+  }                                                                 \</span>
<a href="#l26.39"></a><span id="l26.39">   PR_END_MACRO</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-nsMsgMailNewsUrl::~nsMsgMailNewsUrl()</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-{</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+nsMsgMailNewsUrl::~nsMsgMailNewsUrl() {</span>
<a href="#l26.44"></a><span id="l26.44">   // In IMAP this URL is created and destroyed on the imap thread,</span>
<a href="#l26.45"></a><span id="l26.45">   // so we must ensure that releases of XPCOM objects (which might be</span>
<a href="#l26.46"></a><span id="l26.46">   // implemented by non-threadsafe JS components) are released on the</span>
<a href="#l26.47"></a><span id="l26.47">   // main thread.</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::m_baseURL&quot;, m_baseURL.forget());</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::mMimeHeaders&quot;, mMimeHeaders.forget());</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::m_searchSession&quot;, m_searchSession.forget());</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::mMsgHeaderSink&quot;, mMsgHeaderSink.forget());</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::m_baseURL&quot;,</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+                                    m_baseURL.forget());</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::mMimeHeaders&quot;,</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+                                    mMimeHeaders.forget());</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::m_searchSession&quot;,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+                                    m_searchSession.forget());</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+  NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::mMsgHeaderSink&quot;,</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+                                    mMsgHeaderSink.forget());</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt;&gt;::ForwardIterator iter(mUrlListeners);</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt;&gt;::ForwardIterator iter(</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+      mUrlListeners);</span>
<a href="#l26.64"></a><span id="l26.64">   while (iter.HasMore()) {</span>
<a href="#l26.65"></a><span id="l26.65">     nsCOMPtr&lt;nsIUrlListener&gt; listener = iter.GetNext();</span>
<a href="#l26.66"></a><span id="l26.66">     if (listener)</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-      NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::mUrlListeners&quot;, listener.forget());</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+      NS_ReleaseOnMainThreadSystemGroup(&quot;nsMsgMailNewsUrl::mUrlListeners&quot;,</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+                                        listener.forget());</span>
<a href="#l26.70"></a><span id="l26.70">   }</span>
<a href="#l26.71"></a><span id="l26.71"> }</span>
<a href="#l26.72"></a><span id="l26.72"> </span>
<a href="#l26.73"></a><span id="l26.73"> NS_IMPL_ADDREF(nsMsgMailNewsUrl)</span>
<a href="#l26.74"></a><span id="l26.74"> NS_IMPL_RELEASE(nsMsgMailNewsUrl)</span>
<a href="#l26.75"></a><span id="l26.75"> </span>
<a href="#l26.76"></a><span id="l26.76"> // We want part URLs to QI to nsIURIWithSpecialOrigin so we can give</span>
<a href="#l26.77"></a><span id="l26.77"> // them a &quot;normalized&quot; origin. URLs that already have a &quot;normalized&quot;</span>
<a href="#l26.78"></a><span id="l26.78"> // origin should not QI to nsIURIWithSpecialOrigin.</span>
<a href="#l26.79"></a><span id="l26.79"> NS_INTERFACE_MAP_BEGIN(nsMsgMailNewsUrl)</span>
<a href="#l26.80"></a><span id="l26.80">   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMsgMailNewsUrl)</span>
<a href="#l26.81"></a><span id="l26.81">   NS_INTERFACE_MAP_ENTRY(nsIMsgMailNewsUrl)</span>
<a href="#l26.82"></a><span id="l26.82">   NS_INTERFACE_MAP_ENTRY(nsIURL)</span>
<a href="#l26.83"></a><span id="l26.83">   NS_INTERFACE_MAP_ENTRY(nsIURI)</span>
<a href="#l26.84"></a><span id="l26.84">   NS_INTERFACE_MAP_ENTRY(nsISerializable)</span>
<a href="#l26.85"></a><span id="l26.85">   NS_INTERFACE_MAP_ENTRY(nsIClassInfo)</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-  NS_INTERFACE_MAP_ENTRY_CONDITIONAL(nsIURIWithSpecialOrigin, m_hasNormalizedOrigin)</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_CONDITIONAL(nsIURIWithSpecialOrigin,</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+                                     m_hasNormalizedOrigin)</span>
<a href="#l26.89"></a><span id="l26.89"> NS_INTERFACE_MAP_END</span>
<a href="#l26.90"></a><span id="l26.90"> </span>
<a href="#l26.91"></a><span id="l26.91"> //--------------------------</span>
<a href="#l26.92"></a><span id="l26.92"> // Support for serialization</span>
<a href="#l26.93"></a><span id="l26.93"> //--------------------------</span>
<a href="#l26.94"></a><span id="l26.94"> // nsMsgMailNewsUrl is only partly serialized by serializing the &quot;base URL&quot;</span>
<a href="#l26.95"></a><span id="l26.95"> // which is an nsStandardURL, or by only serializing the Spec. This may</span>
<a href="#l26.96"></a><span id="l26.96"> // cause problems in the future. See bug 1512356 and bug 1515337 for details,</span>
<a href="#l26.97"></a><span id="l26.97"> // follow-up in bug 1512698.</span>
<a href="#l26.98"></a><span id="l26.98"> </span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-NS_IMETHODIMP_(void) nsMsgMailNewsUrl::Serialize(mozilla::ipc::URIParams &amp;aParams) {</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+NS_IMETHODIMP_(void)</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+nsMsgMailNewsUrl::Serialize(mozilla::ipc::URIParams &amp;aParams) {</span>
<a href="#l26.102"></a><span id="l26.102">   m_baseURL-&gt;Serialize(aParams);</span>
<a href="#l26.103"></a><span id="l26.103"> }</span>
<a href="#l26.104"></a><span id="l26.104"> </span>
<a href="#l26.105"></a><span id="l26.105"> //----------------------------</span>
<a href="#l26.106"></a><span id="l26.106"> // Support for nsISerializable</span>
<a href="#l26.107"></a><span id="l26.107"> //----------------------------</span>
<a href="#l26.108"></a><span id="l26.108"> NS_IMETHODIMP nsMsgMailNewsUrl::Read(nsIObjectInputStream *stream) {</span>
<a href="#l26.109"></a><span id="l26.109">   nsAutoCString urlstr;</span>
<a href="#l26.110"></a><span id="l26.110">   nsresult rv = NS_ReadOptionalCString(stream, urlstr);</span>
<a href="#l26.111"></a><span id="l26.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l26.115"></a><span id="l26.115">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l26.116"></a><span id="l26.116">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l26.117"></a><span id="l26.117">   rv = ioService-&gt;NewURI(urlstr, nullptr, nullptr, getter_AddRefs(url));</span>
<a href="#l26.118"></a><span id="l26.118">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.119"></a><span id="l26.119">   m_baseURL = do_QueryInterface(url);</span>
<a href="#l26.120"></a><span id="l26.120">   return NS_OK;</span>
<a href="#l26.121"></a><span id="l26.121"> }</span>
<a href="#l26.122"></a><span id="l26.122"> </span>
<a href="#l26.123"></a><span id="l26.123" class="difflineat">@@ -127,27 +133,29 @@ NS_IMETHODIMP nsMsgMailNewsUrl::Write(ns</span>
<a href="#l26.124"></a><span id="l26.124"> //-------------------------</span>
<a href="#l26.125"></a><span id="l26.125"> // Support for nsIClassInfo</span>
<a href="#l26.126"></a><span id="l26.126"> //-------------------------</span>
<a href="#l26.127"></a><span id="l26.127"> NS_IMETHODIMP nsMsgMailNewsUrl::GetInterfaces(nsTArray&lt;nsIID&gt; &amp;array) {</span>
<a href="#l26.128"></a><span id="l26.128">   array.Clear();</span>
<a href="#l26.129"></a><span id="l26.129">   return NS_OK;</span>
<a href="#l26.130"></a><span id="l26.130"> }</span>
<a href="#l26.131"></a><span id="l26.131"> </span>
<a href="#l26.132"></a><span id="l26.132" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetScriptableHelper(nsIXPCScriptable **_retval) {</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetScriptableHelper(</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineplus">+    nsIXPCScriptable **_retval) {</span>
<a href="#l26.135"></a><span id="l26.135">   *_retval = nullptr;</span>
<a href="#l26.136"></a><span id="l26.136">   return NS_OK;</span>
<a href="#l26.137"></a><span id="l26.137"> }</span>
<a href="#l26.138"></a><span id="l26.138"> </span>
<a href="#l26.139"></a><span id="l26.139"> NS_IMETHODIMP nsMsgMailNewsUrl::GetContractID(nsACString &amp;aContractID) {</span>
<a href="#l26.140"></a><span id="l26.140">   aContractID.SetIsVoid(true);</span>
<a href="#l26.141"></a><span id="l26.141">   return NS_OK;</span>
<a href="#l26.142"></a><span id="l26.142"> }</span>
<a href="#l26.143"></a><span id="l26.143"> </span>
<a href="#l26.144"></a><span id="l26.144" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetClassDescription(nsACString &amp;aClassDescription) {</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetClassDescription(</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineplus">+    nsACString &amp;aClassDescription) {</span>
<a href="#l26.147"></a><span id="l26.147">   aClassDescription.SetIsVoid(true);</span>
<a href="#l26.148"></a><span id="l26.148">   return NS_OK;</span>
<a href="#l26.149"></a><span id="l26.149"> }</span>
<a href="#l26.150"></a><span id="l26.150"> </span>
<a href="#l26.151"></a><span id="l26.151"> NS_IMETHODIMP nsMsgMailNewsUrl::GetClassID(nsCID **aClassID) {</span>
<a href="#l26.152"></a><span id="l26.152">   *aClassID = (nsCID *)moz_xmalloc(sizeof(nsCID));</span>
<a href="#l26.153"></a><span id="l26.153">   return GetClassIDNoAlloc(*aClassID);</span>
<a href="#l26.154"></a><span id="l26.154"> }</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineat">@@ -161,23 +169,23 @@ static NS_DEFINE_CID(kNS_MSGMAILNEWSURL_</span>
<a href="#l26.156"></a><span id="l26.156"> NS_IMETHODIMP nsMsgMailNewsUrl::GetClassIDNoAlloc(nsCID *aClassIDNoAlloc) {</span>
<a href="#l26.157"></a><span id="l26.157">   *aClassIDNoAlloc = kNS_MSGMAILNEWSURL_CID;</span>
<a href="#l26.158"></a><span id="l26.158">   return NS_OK;</span>
<a href="#l26.159"></a><span id="l26.159"> }</span>
<a href="#l26.160"></a><span id="l26.160"> </span>
<a href="#l26.161"></a><span id="l26.161"> //------------------------------------</span>
<a href="#l26.162"></a><span id="l26.162"> // Support for nsIURIWithSpecialOrigin</span>
<a href="#l26.163"></a><span id="l26.163"> //------------------------------------</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetOrigin(nsIURI **aOrigin)</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-{</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetOrigin(nsIURI **aOrigin) {</span>
<a href="#l26.167"></a><span id="l26.167">   MOZ_ASSERT(m_hasNormalizedOrigin,</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineminus">-    &quot;nsMsgMailNewsUrl::GetOrigin() can only be called for URLs with normalized spec&quot;);</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineplus">+             &quot;nsMsgMailNewsUrl::GetOrigin() can only be called for URLs with &quot;</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineplus">+             &quot;normalized spec&quot;);</span>
<a href="#l26.171"></a><span id="l26.171"> </span>
<a href="#l26.172"></a><span id="l26.172">   if (!m_normalizedOrigin) {</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMessageUrl&gt; msgUrl;</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl;</span>
<a href="#l26.175"></a><span id="l26.175">     QueryInterface(NS_GET_IID(nsIMsgMessageUrl), getter_AddRefs(msgUrl));</span>
<a href="#l26.176"></a><span id="l26.176"> </span>
<a href="#l26.177"></a><span id="l26.177">     nsAutoCString spec;</span>
<a href="#l26.178"></a><span id="l26.178">     if (!msgUrl || NS_FAILED(msgUrl-&gt;GetNormalizedSpec(spec))) {</span>
<a href="#l26.179"></a><span id="l26.179">       MOZ_ASSERT(false, &quot;Can't get normalized spec&quot;);</span>
<a href="#l26.180"></a><span id="l26.180">       // just use the normal spec.</span>
<a href="#l26.181"></a><span id="l26.181">       GetSpec(spec);</span>
<a href="#l26.182"></a><span id="l26.182">     }</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineat">@@ -189,898 +197,780 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetOrigi</span>
<a href="#l26.184"></a><span id="l26.184">   NS_IF_ADDREF(*aOrigin = m_normalizedOrigin);</span>
<a href="#l26.185"></a><span id="l26.185">   return NS_OK;</span>
<a href="#l26.186"></a><span id="l26.186"> }</span>
<a href="#l26.187"></a><span id="l26.187"> </span>
<a href="#l26.188"></a><span id="l26.188"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.189"></a><span id="l26.189"> // Begin nsIMsgMailNewsUrl specific support</span>
<a href="#l26.190"></a><span id="l26.190"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.191"></a><span id="l26.191"> </span>
<a href="#l26.192"></a><span id="l26.192" class="difflineminus">-nsresult nsMsgMailNewsUrl::GetUrlState(bool * aRunningUrl)</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineminus">-{</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineminus">-  if (aRunningUrl)</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-    *aRunningUrl = m_runningUrl;</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+nsresult nsMsgMailNewsUrl::GetUrlState(bool *aRunningUrl) {</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+  if (aRunningUrl) *aRunningUrl = m_runningUrl;</span>
<a href="#l26.198"></a><span id="l26.198"> </span>
<a href="#l26.199"></a><span id="l26.199">   return NS_OK;</span>
<a href="#l26.200"></a><span id="l26.200"> }</span>
<a href="#l26.201"></a><span id="l26.201"> </span>
<a href="#l26.202"></a><span id="l26.202" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetUrlState(bool aRunningUrl, nsresult aExitCode)</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-{</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetUrlState(bool aRunningUrl, nsresult aExitCode) {</span>
<a href="#l26.205"></a><span id="l26.205">   // if we already knew this running state, return, unless the url was aborted</span>
<a href="#l26.206"></a><span id="l26.206">   if (m_runningUrl == aRunningUrl &amp;&amp; aExitCode != NS_MSG_ERROR_URL_ABORTED)</span>
<a href="#l26.207"></a><span id="l26.207">     return NS_OK;</span>
<a href="#l26.208"></a><span id="l26.208">   m_runningUrl = aRunningUrl;</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineminus">-  nsCOMPtr &lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l26.211"></a><span id="l26.211"> </span>
<a href="#l26.212"></a><span id="l26.212">   // put this back - we need it for urls that don't run through the doc loader</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-  if (NS_SUCCEEDED(GetStatusFeedback(getter_AddRefs(statusFeedback))) &amp;&amp; statusFeedback)</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-  {</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineplus">+  if (NS_SUCCEEDED(GetStatusFeedback(getter_AddRefs(statusFeedback))) &amp;&amp;</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineplus">+      statusFeedback) {</span>
<a href="#l26.217"></a><span id="l26.217">     if (m_runningUrl)</span>
<a href="#l26.218"></a><span id="l26.218">       statusFeedback-&gt;StartMeteors();</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-    else</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-    {</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+    else {</span>
<a href="#l26.222"></a><span id="l26.222">       statusFeedback-&gt;ShowProgress(0);</span>
<a href="#l26.223"></a><span id="l26.223">       statusFeedback-&gt;StopMeteors();</span>
<a href="#l26.224"></a><span id="l26.224">     }</span>
<a href="#l26.225"></a><span id="l26.225">   }</span>
<a href="#l26.226"></a><span id="l26.226"> </span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-  if (m_runningUrl)</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-  {</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineplus">+  if (m_runningUrl) {</span>
<a href="#l26.230"></a><span id="l26.230">     NOTIFY_URL_LISTENERS(OnStartRunningUrl, (this));</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-  }</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-  else</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-  {</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineplus">+  } else {</span>
<a href="#l26.235"></a><span id="l26.235">     NOTIFY_URL_LISTENERS(OnStopRunningUrl, (this, aExitCode));</span>
<a href="#l26.236"></a><span id="l26.236">     mUrlListeners.Clear();</span>
<a href="#l26.237"></a><span id="l26.237">   }</span>
<a href="#l26.238"></a><span id="l26.238"> </span>
<a href="#l26.239"></a><span id="l26.239">   return NS_OK;</span>
<a href="#l26.240"></a><span id="l26.240"> }</span>
<a href="#l26.241"></a><span id="l26.241"> </span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::RegisterListener(nsIUrlListener *aUrlListener)</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-{</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::RegisterListener(nsIUrlListener *aUrlListener) {</span>
<a href="#l26.245"></a><span id="l26.245">   NS_ENSURE_ARG_POINTER(aUrlListener);</span>
<a href="#l26.246"></a><span id="l26.246">   mUrlListeners.AppendElement(aUrlListener);</span>
<a href="#l26.247"></a><span id="l26.247">   return NS_OK;</span>
<a href="#l26.248"></a><span id="l26.248"> }</span>
<a href="#l26.249"></a><span id="l26.249"> </span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-nsresult nsMsgMailNewsUrl::UnRegisterListener(nsIUrlListener *aUrlListener)</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineminus">-{</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+nsresult nsMsgMailNewsUrl::UnRegisterListener(nsIUrlListener *aUrlListener) {</span>
<a href="#l26.253"></a><span id="l26.253">   NS_ENSURE_ARG_POINTER(aUrlListener);</span>
<a href="#l26.254"></a><span id="l26.254"> </span>
<a href="#l26.255"></a><span id="l26.255">   // Due to the way mailnews is structured, some listeners attempt to remove</span>
<a href="#l26.256"></a><span id="l26.256">   // themselves twice. This may in fact be an error in the coding, however</span>
<a href="#l26.257"></a><span id="l26.257">   // if they didn't do it as they do currently, then they could fail to remove</span>
<a href="#l26.258"></a><span id="l26.258">   // their listeners.</span>
<a href="#l26.259"></a><span id="l26.259">   mUrlListeners.RemoveElement(aUrlListener);</span>
<a href="#l26.260"></a><span id="l26.260"> </span>
<a href="#l26.261"></a><span id="l26.261">   return NS_OK;</span>
<a href="#l26.262"></a><span id="l26.262"> }</span>
<a href="#l26.263"></a><span id="l26.263"> </span>
<a href="#l26.264"></a><span id="l26.264" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetServer(nsIMsgIncomingServer ** aIncomingServer)</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineminus">-{</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineminus">-  // mscott --&gt; we could cache a copy of the server here....but if we did, we run</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-  // the risk of leaking the server if any single url gets leaked....of course that</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineminus">-  // shouldn't happen...but it could. so i'm going to look it up every time and</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineminus">-  // we can look at caching it later.</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetServer(</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineplus">+    nsIMsgIncomingServer **aIncomingServer) {</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineplus">+  // mscott --&gt; we could cache a copy of the server here....but if we did, we</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineplus">+  // run the risk of leaking the server if any single url gets leaked....of</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineplus">+  // course that shouldn't happen...but it could. so i'm going to look it up</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineplus">+  // every time and we can look at caching it later.</span>
<a href="#l26.276"></a><span id="l26.276"> </span>
<a href="#l26.277"></a><span id="l26.277">   nsresult rv;</span>
<a href="#l26.278"></a><span id="l26.278"> </span>
<a href="#l26.279"></a><span id="l26.279">   nsAutoCString urlstr;</span>
<a href="#l26.280"></a><span id="l26.280">   rv = m_baseURL-&gt;GetSpec(urlstr);</span>
<a href="#l26.281"></a><span id="l26.281">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.282"></a><span id="l26.282"> </span>
<a href="#l26.283"></a><span id="l26.283">   nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l26.284"></a><span id="l26.284" class="difflineminus">-  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(urlstr).Finalize(url);</span>
<a href="#l26.285"></a><span id="l26.285" class="difflineplus">+  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l26.286"></a><span id="l26.286" class="difflineplus">+           .SetSpec(urlstr)</span>
<a href="#l26.287"></a><span id="l26.287" class="difflineplus">+           .Finalize(url);</span>
<a href="#l26.288"></a><span id="l26.288">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.289"></a><span id="l26.289"> </span>
<a href="#l26.290"></a><span id="l26.290">   nsAutoCString scheme;</span>
<a href="#l26.291"></a><span id="l26.291">   rv = GetScheme(scheme);</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineminus">-  {</span>
<a href="#l26.294"></a><span id="l26.294" class="difflineminus">-    if (scheme.EqualsLiteral(&quot;pop&quot;))</span>
<a href="#l26.295"></a><span id="l26.295" class="difflineminus">-      scheme.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l26.296"></a><span id="l26.296" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l26.297"></a><span id="l26.297" class="difflineplus">+    if (scheme.EqualsLiteral(&quot;pop&quot;)) scheme.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l26.298"></a><span id="l26.298">     // we use &quot;nntp&quot; in the server list so translate it here.</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineminus">-    if (scheme.EqualsLiteral(&quot;news&quot;))</span>
<a href="#l26.300"></a><span id="l26.300" class="difflineminus">-      scheme.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l26.301"></a><span id="l26.301" class="difflineplus">+    if (scheme.EqualsLiteral(&quot;news&quot;)) scheme.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l26.302"></a><span id="l26.302">     rv = NS_MutateURI(url).SetScheme(scheme).Finalize(url);</span>
<a href="#l26.303"></a><span id="l26.303">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.304"></a><span id="l26.304">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l26.305"></a><span id="l26.305" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l26.306"></a><span id="l26.306" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l26.307"></a><span id="l26.307">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.308"></a><span id="l26.308"> </span>
<a href="#l26.309"></a><span id="l26.309">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l26.310"></a><span id="l26.310">     rv = accountManager-&gt;FindServerByURI(url, false, aIncomingServer);</span>
<a href="#l26.311"></a><span id="l26.311" class="difflineminus">-    if (!*aIncomingServer &amp;&amp; scheme.EqualsLiteral(&quot;imap&quot;))</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineminus">-    {</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineplus">+    if (!*aIncomingServer &amp;&amp; scheme.EqualsLiteral(&quot;imap&quot;)) {</span>
<a href="#l26.314"></a><span id="l26.314">       // look for any imap server with this host name so clicking on</span>
<a href="#l26.315"></a><span id="l26.315">       // other users folder urls will work. We could override this method</span>
<a href="#l26.316"></a><span id="l26.316">       // for imap urls, or we could make caching of servers work and</span>
<a href="#l26.317"></a><span id="l26.317">       // just set the server in the imap code for this case.</span>
<a href="#l26.318"></a><span id="l26.318">       rv = NS_MutateURI(url).SetUserPass(EmptyCString()).Finalize(url);</span>
<a href="#l26.319"></a><span id="l26.319">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.320"></a><span id="l26.320">       rv = accountManager-&gt;FindServerByURI(url, false, aIncomingServer);</span>
<a href="#l26.321"></a><span id="l26.321">     }</span>
<a href="#l26.322"></a><span id="l26.322">   }</span>
<a href="#l26.323"></a><span id="l26.323"> </span>
<a href="#l26.324"></a><span id="l26.324">   return rv;</span>
<a href="#l26.325"></a><span id="l26.325"> }</span>
<a href="#l26.326"></a><span id="l26.326"> </span>
<a href="#l26.327"></a><span id="l26.327" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l26.328"></a><span id="l26.328" class="difflineminus">-{</span>
<a href="#l26.329"></a><span id="l26.329" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgWindow(nsIMsgWindow **aMsgWindow) {</span>
<a href="#l26.330"></a><span id="l26.330">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l26.331"></a><span id="l26.331">   *aMsgWindow = nullptr;</span>
<a href="#l26.332"></a><span id="l26.332"> </span>
<a href="#l26.333"></a><span id="l26.333">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l26.334"></a><span id="l26.334">   msgWindow.forget(aMsgWindow);</span>
<a href="#l26.335"></a><span id="l26.335">   return *aMsgWindow ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l26.336"></a><span id="l26.336"> }</span>
<a href="#l26.337"></a><span id="l26.337"> </span>
<a href="#l26.338"></a><span id="l26.338" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgWindow(nsIMsgWindow *aMsgWindow)</span>
<a href="#l26.339"></a><span id="l26.339" class="difflineminus">-{</span>
<a href="#l26.340"></a><span id="l26.340" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgWindow(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l26.341"></a><span id="l26.341"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l26.342"></a><span id="l26.342" class="difflineminus">-  NS_ASSERTION(aMsgWindow || !m_msgWindowWeak, &quot;someone crunching non-null msg window&quot;);</span>
<a href="#l26.343"></a><span id="l26.343" class="difflineplus">+  NS_ASSERTION(aMsgWindow || !m_msgWindowWeak,</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineplus">+               &quot;someone crunching non-null msg window&quot;);</span>
<a href="#l26.345"></a><span id="l26.345"> #endif</span>
<a href="#l26.346"></a><span id="l26.346">   m_msgWindowWeak = do_GetWeakReference(aMsgWindow);</span>
<a href="#l26.347"></a><span id="l26.347">   return NS_OK;</span>
<a href="#l26.348"></a><span id="l26.348"> }</span>
<a href="#l26.349"></a><span id="l26.349"> </span>
<a href="#l26.350"></a><span id="l26.350" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetStatusFeedback(nsIMsgStatusFeedback **aMsgFeedback)</span>
<a href="#l26.351"></a><span id="l26.351" class="difflineminus">-{</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetStatusFeedback(</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineplus">+    nsIMsgStatusFeedback **aMsgFeedback) {</span>
<a href="#l26.354"></a><span id="l26.354">   // note: it is okay to return a null status feedback and not return an error</span>
<a href="#l26.355"></a><span id="l26.355">   // it's possible the url really doesn't have status feedback</span>
<a href="#l26.356"></a><span id="l26.356">   *aMsgFeedback = nullptr;</span>
<a href="#l26.357"></a><span id="l26.357" class="difflineminus">-  if (!m_statusFeedbackWeak)</span>
<a href="#l26.358"></a><span id="l26.358" class="difflineminus">-  {</span>
<a href="#l26.359"></a><span id="l26.359" class="difflineplus">+  if (!m_statusFeedbackWeak) {</span>
<a href="#l26.360"></a><span id="l26.360">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l26.361"></a><span id="l26.361" class="difflineminus">-    if (msgWindow)</span>
<a href="#l26.362"></a><span id="l26.362" class="difflineminus">-      msgWindow-&gt;GetStatusFeedback(aMsgFeedback);</span>
<a href="#l26.363"></a><span id="l26.363" class="difflineminus">-  }</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineminus">-  else</span>
<a href="#l26.365"></a><span id="l26.365" class="difflineminus">-  {</span>
<a href="#l26.366"></a><span id="l26.366" class="difflineminus">-    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback(do_QueryReferent(m_statusFeedbackWeak));</span>
<a href="#l26.367"></a><span id="l26.367" class="difflineplus">+    if (msgWindow) msgWindow-&gt;GetStatusFeedback(aMsgFeedback);</span>
<a href="#l26.368"></a><span id="l26.368" class="difflineplus">+  } else {</span>
<a href="#l26.369"></a><span id="l26.369" class="difflineplus">+    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback(</span>
<a href="#l26.370"></a><span id="l26.370" class="difflineplus">+        do_QueryReferent(m_statusFeedbackWeak));</span>
<a href="#l26.371"></a><span id="l26.371">     statusFeedback.forget(aMsgFeedback);</span>
<a href="#l26.372"></a><span id="l26.372">   }</span>
<a href="#l26.373"></a><span id="l26.373">   return *aMsgFeedback ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l26.374"></a><span id="l26.374"> }</span>
<a href="#l26.375"></a><span id="l26.375"> </span>
<a href="#l26.376"></a><span id="l26.376" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetStatusFeedback(nsIMsgStatusFeedback *aMsgFeedback)</span>
<a href="#l26.377"></a><span id="l26.377" class="difflineminus">-{</span>
<a href="#l26.378"></a><span id="l26.378" class="difflineminus">-  if (aMsgFeedback)</span>
<a href="#l26.379"></a><span id="l26.379" class="difflineminus">-    m_statusFeedbackWeak = do_GetWeakReference(aMsgFeedback);</span>
<a href="#l26.380"></a><span id="l26.380" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetStatusFeedback(</span>
<a href="#l26.381"></a><span id="l26.381" class="difflineplus">+    nsIMsgStatusFeedback *aMsgFeedback) {</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineplus">+  if (aMsgFeedback) m_statusFeedbackWeak = do_GetWeakReference(aMsgFeedback);</span>
<a href="#l26.383"></a><span id="l26.383">   return NS_OK;</span>
<a href="#l26.384"></a><span id="l26.384"> }</span>
<a href="#l26.385"></a><span id="l26.385"> </span>
<a href="#l26.386"></a><span id="l26.386" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetMaxProgress(int64_t *aMaxProgress)</span>
<a href="#l26.387"></a><span id="l26.387" class="difflineminus">-{</span>
<a href="#l26.388"></a><span id="l26.388" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMaxProgress(int64_t *aMaxProgress) {</span>
<a href="#l26.389"></a><span id="l26.389">   *aMaxProgress = mMaxProgress;</span>
<a href="#l26.390"></a><span id="l26.390">   return NS_OK;</span>
<a href="#l26.391"></a><span id="l26.391"> }</span>
<a href="#l26.392"></a><span id="l26.392"> </span>
<a href="#l26.393"></a><span id="l26.393" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetMaxProgress(int64_t aMaxProgress)</span>
<a href="#l26.394"></a><span id="l26.394" class="difflineminus">-{</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMaxProgress(int64_t aMaxProgress) {</span>
<a href="#l26.396"></a><span id="l26.396">   mMaxProgress = aMaxProgress;</span>
<a href="#l26.397"></a><span id="l26.397">   return NS_OK;</span>
<a href="#l26.398"></a><span id="l26.398"> }</span>
<a href="#l26.399"></a><span id="l26.399"> </span>
<a href="#l26.400"></a><span id="l26.400" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetLoadGroup(nsILoadGroup **aLoadGroup)</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineminus">-{</span>
<a href="#l26.402"></a><span id="l26.402" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetLoadGroup(nsILoadGroup **aLoadGroup) {</span>
<a href="#l26.403"></a><span id="l26.403">   *aLoadGroup = nullptr;</span>
<a href="#l26.404"></a><span id="l26.404">   // note: it is okay to return a null load group and not return an error</span>
<a href="#l26.405"></a><span id="l26.405">   // it's possible the url really doesn't have load group</span>
<a href="#l26.406"></a><span id="l26.406" class="difflineminus">-  nsCOMPtr&lt;nsILoadGroup&gt; loadGroup (do_QueryReferent(m_loadGroupWeak));</span>
<a href="#l26.407"></a><span id="l26.407" class="difflineminus">-  if (!loadGroup)</span>
<a href="#l26.408"></a><span id="l26.408" class="difflineminus">-  {</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineplus">+  nsCOMPtr&lt;nsILoadGroup&gt; loadGroup(do_QueryReferent(m_loadGroupWeak));</span>
<a href="#l26.410"></a><span id="l26.410" class="difflineplus">+  if (!loadGroup) {</span>
<a href="#l26.411"></a><span id="l26.411">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l26.412"></a><span id="l26.412" class="difflineminus">-    if (msgWindow)</span>
<a href="#l26.413"></a><span id="l26.413" class="difflineminus">-    {</span>
<a href="#l26.414"></a><span id="l26.414" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l26.415"></a><span id="l26.415">       // XXXbz This is really weird... why are we getting some</span>
<a href="#l26.416"></a><span id="l26.416">       // random loadgroup we're not really a part of?</span>
<a href="#l26.417"></a><span id="l26.417">       nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l26.418"></a><span id="l26.418">       msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l26.419"></a><span id="l26.419">       loadGroup = do_GetInterface(docShell);</span>
<a href="#l26.420"></a><span id="l26.420">       m_loadGroupWeak = do_GetWeakReference(loadGroup);</span>
<a href="#l26.421"></a><span id="l26.421">     }</span>
<a href="#l26.422"></a><span id="l26.422">   }</span>
<a href="#l26.423"></a><span id="l26.423">   loadGroup.forget(aLoadGroup);</span>
<a href="#l26.424"></a><span id="l26.424">   return *aLoadGroup ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l26.425"></a><span id="l26.425"> }</span>
<a href="#l26.426"></a><span id="l26.426"> </span>
<a href="#l26.427"></a><span id="l26.427" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetUpdatingFolder(bool *aResult)</span>
<a href="#l26.428"></a><span id="l26.428" class="difflineminus">-{</span>
<a href="#l26.429"></a><span id="l26.429" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetUpdatingFolder(bool *aResult) {</span>
<a href="#l26.430"></a><span id="l26.430">   NS_ENSURE_ARG(aResult);</span>
<a href="#l26.431"></a><span id="l26.431">   *aResult = m_updatingFolder;</span>
<a href="#l26.432"></a><span id="l26.432">   return NS_OK;</span>
<a href="#l26.433"></a><span id="l26.433"> }</span>
<a href="#l26.434"></a><span id="l26.434"> </span>
<a href="#l26.435"></a><span id="l26.435" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetUpdatingFolder(bool updatingFolder)</span>
<a href="#l26.436"></a><span id="l26.436" class="difflineminus">-{</span>
<a href="#l26.437"></a><span id="l26.437" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetUpdatingFolder(bool updatingFolder) {</span>
<a href="#l26.438"></a><span id="l26.438">   m_updatingFolder = updatingFolder;</span>
<a href="#l26.439"></a><span id="l26.439">   return NS_OK;</span>
<a href="#l26.440"></a><span id="l26.440"> }</span>
<a href="#l26.441"></a><span id="l26.441"> </span>
<a href="#l26.442"></a><span id="l26.442" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgIsInLocalCache(bool *aMsgIsInLocalCache)</span>
<a href="#l26.443"></a><span id="l26.443" class="difflineminus">-{</span>
<a href="#l26.444"></a><span id="l26.444" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgIsInLocalCache(bool *aMsgIsInLocalCache) {</span>
<a href="#l26.445"></a><span id="l26.445">   NS_ENSURE_ARG(aMsgIsInLocalCache);</span>
<a href="#l26.446"></a><span id="l26.446">   *aMsgIsInLocalCache = m_msgIsInLocalCache;</span>
<a href="#l26.447"></a><span id="l26.447">   return NS_OK;</span>
<a href="#l26.448"></a><span id="l26.448"> }</span>
<a href="#l26.449"></a><span id="l26.449"> </span>
<a href="#l26.450"></a><span id="l26.450" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgIsInLocalCache(bool aMsgIsInLocalCache)</span>
<a href="#l26.451"></a><span id="l26.451" class="difflineminus">-{</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgIsInLocalCache(bool aMsgIsInLocalCache) {</span>
<a href="#l26.453"></a><span id="l26.453">   m_msgIsInLocalCache = aMsgIsInLocalCache;</span>
<a href="#l26.454"></a><span id="l26.454">   return NS_OK;</span>
<a href="#l26.455"></a><span id="l26.455"> }</span>
<a href="#l26.456"></a><span id="l26.456"> </span>
<a href="#l26.457"></a><span id="l26.457" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetSuppressErrorMsgs(bool *aSuppressErrorMsgs)</span>
<a href="#l26.458"></a><span id="l26.458" class="difflineminus">-{</span>
<a href="#l26.459"></a><span id="l26.459" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetSuppressErrorMsgs(bool *aSuppressErrorMsgs) {</span>
<a href="#l26.460"></a><span id="l26.460">   NS_ENSURE_ARG(aSuppressErrorMsgs);</span>
<a href="#l26.461"></a><span id="l26.461">   *aSuppressErrorMsgs = m_suppressErrorMsgs;</span>
<a href="#l26.462"></a><span id="l26.462">   return NS_OK;</span>
<a href="#l26.463"></a><span id="l26.463"> }</span>
<a href="#l26.464"></a><span id="l26.464"> </span>
<a href="#l26.465"></a><span id="l26.465" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetSuppressErrorMsgs(bool aSuppressErrorMsgs)</span>
<a href="#l26.466"></a><span id="l26.466" class="difflineminus">-{</span>
<a href="#l26.467"></a><span id="l26.467" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetSuppressErrorMsgs(bool aSuppressErrorMsgs) {</span>
<a href="#l26.468"></a><span id="l26.468">   m_suppressErrorMsgs = aSuppressErrorMsgs;</span>
<a href="#l26.469"></a><span id="l26.469">   return NS_OK;</span>
<a href="#l26.470"></a><span id="l26.470"> }</span>
<a href="#l26.471"></a><span id="l26.471"> </span>
<a href="#l26.472"></a><span id="l26.472" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::IsUrlType(uint32_t type, bool *isType)</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineminus">-{</span>
<a href="#l26.474"></a><span id="l26.474" class="difflineminus">-  //base class doesn't know about any specific types</span>
<a href="#l26.475"></a><span id="l26.475" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::IsUrlType(uint32_t type, bool *isType) {</span>
<a href="#l26.476"></a><span id="l26.476" class="difflineplus">+  // base class doesn't know about any specific types</span>
<a href="#l26.477"></a><span id="l26.477">   NS_ENSURE_ARG(isType);</span>
<a href="#l26.478"></a><span id="l26.478">   *isType = false;</span>
<a href="#l26.479"></a><span id="l26.479">   return NS_OK;</span>
<a href="#l26.480"></a><span id="l26.480" class="difflineminus">-</span>
<a href="#l26.481"></a><span id="l26.481"> }</span>
<a href="#l26.482"></a><span id="l26.482"> </span>
<a href="#l26.483"></a><span id="l26.483" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetSearchSession(nsIMsgSearchSession *aSearchSession)</span>
<a href="#l26.484"></a><span id="l26.484" class="difflineminus">-{</span>
<a href="#l26.485"></a><span id="l26.485" class="difflineminus">-  if (aSearchSession)</span>
<a href="#l26.486"></a><span id="l26.486" class="difflineminus">-    m_searchSession = aSearchSession;</span>
<a href="#l26.487"></a><span id="l26.487" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetSearchSession(</span>
<a href="#l26.488"></a><span id="l26.488" class="difflineplus">+    nsIMsgSearchSession *aSearchSession) {</span>
<a href="#l26.489"></a><span id="l26.489" class="difflineplus">+  if (aSearchSession) m_searchSession = aSearchSession;</span>
<a href="#l26.490"></a><span id="l26.490">   return NS_OK;</span>
<a href="#l26.491"></a><span id="l26.491"> }</span>
<a href="#l26.492"></a><span id="l26.492"> </span>
<a href="#l26.493"></a><span id="l26.493" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetSearchSession(nsIMsgSearchSession **aSearchSession)</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineminus">-{</span>
<a href="#l26.495"></a><span id="l26.495" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetSearchSession(</span>
<a href="#l26.496"></a><span id="l26.496" class="difflineplus">+    nsIMsgSearchSession **aSearchSession) {</span>
<a href="#l26.497"></a><span id="l26.497">   NS_ENSURE_ARG(aSearchSession);</span>
<a href="#l26.498"></a><span id="l26.498">   NS_IF_ADDREF(*aSearchSession = m_searchSession);</span>
<a href="#l26.499"></a><span id="l26.499">   return NS_OK;</span>
<a href="#l26.500"></a><span id="l26.500"> }</span>
<a href="#l26.501"></a><span id="l26.501"> </span>
<a href="#l26.502"></a><span id="l26.502"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.503"></a><span id="l26.503"> // End nsIMsgMailNewsUrl specific support</span>
<a href="#l26.504"></a><span id="l26.504"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.505"></a><span id="l26.505"> </span>
<a href="#l26.506"></a><span id="l26.506"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.507"></a><span id="l26.507"> // Begin nsIURI support</span>
<a href="#l26.508"></a><span id="l26.508"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.509"></a><span id="l26.509"> </span>
<a href="#l26.510"></a><span id="l26.510" class="difflineminus">-</span>
<a href="#l26.511"></a><span id="l26.511" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetSpec(nsACString &amp;aSpec)</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineminus">-{</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetSpec(nsACString &amp;aSpec) {</span>
<a href="#l26.514"></a><span id="l26.514">   return m_baseURL-&gt;GetSpec(aSpec);</span>
<a href="#l26.515"></a><span id="l26.515"> }</span>
<a href="#l26.516"></a><span id="l26.516"> </span>
<a href="#l26.517"></a><span id="l26.517" class="difflineminus">-nsresult nsMsgMailNewsUrl::CreateURL(const nsACString&amp; aSpec, nsIURL **aURL)</span>
<a href="#l26.518"></a><span id="l26.518" class="difflineminus">-{</span>
<a href="#l26.519"></a><span id="l26.519" class="difflineplus">+nsresult nsMsgMailNewsUrl::CreateURL(const nsACString &amp;aSpec, nsIURL **aURL) {</span>
<a href="#l26.520"></a><span id="l26.520">   nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l26.521"></a><span id="l26.521" class="difflineminus">-  nsresult rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(aSpec).Finalize(url);</span>
<a href="#l26.522"></a><span id="l26.522" class="difflineplus">+  nsresult rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l26.523"></a><span id="l26.523" class="difflineplus">+                    .SetSpec(aSpec)</span>
<a href="#l26.524"></a><span id="l26.524" class="difflineplus">+                    .Finalize(url);</span>
<a href="#l26.525"></a><span id="l26.525">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.526"></a><span id="l26.526">   url.forget(aURL);</span>
<a href="#l26.527"></a><span id="l26.527">   return NS_OK;</span>
<a href="#l26.528"></a><span id="l26.528"> }</span>
<a href="#l26.529"></a><span id="l26.529"> </span>
<a href="#l26.530"></a><span id="l26.530"> #define FILENAME_PART_LEN 10</span>
<a href="#l26.531"></a><span id="l26.531"> </span>
<a href="#l26.532"></a><span id="l26.532" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l26.533"></a><span id="l26.533" class="difflineminus">-{</span>
<a href="#l26.534"></a><span id="l26.534" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetSpecInternal(const nsACString &amp;aSpec) {</span>
<a href="#l26.535"></a><span id="l26.535">   nsAutoCString spec(aSpec);</span>
<a href="#l26.536"></a><span id="l26.536">   // Parse out &quot;filename&quot; attribute if present.</span>
<a href="#l26.537"></a><span id="l26.537">   char *start, *end;</span>
<a href="#l26.538"></a><span id="l26.538" class="difflineminus">-  start = PL_strcasestr(spec.BeginWriting(),&quot;?filename=&quot;);</span>
<a href="#l26.539"></a><span id="l26.539" class="difflineminus">-  if (!start)</span>
<a href="#l26.540"></a><span id="l26.540" class="difflineminus">-    start = PL_strcasestr(spec.BeginWriting(),&quot;&amp;filename=&quot;);</span>
<a href="#l26.541"></a><span id="l26.541" class="difflineminus">-  if (start)</span>
<a href="#l26.542"></a><span id="l26.542" class="difflineminus">-  { // Make sure we only get our own value.</span>
<a href="#l26.543"></a><span id="l26.543" class="difflineminus">-    end = PL_strcasestr((char*)(start+FILENAME_PART_LEN),&quot;&amp;&quot;);</span>
<a href="#l26.544"></a><span id="l26.544" class="difflineminus">-    if (end)</span>
<a href="#l26.545"></a><span id="l26.545" class="difflineminus">-    {</span>
<a href="#l26.546"></a><span id="l26.546" class="difflineplus">+  start = PL_strcasestr(spec.BeginWriting(), &quot;?filename=&quot;);</span>
<a href="#l26.547"></a><span id="l26.547" class="difflineplus">+  if (!start) start = PL_strcasestr(spec.BeginWriting(), &quot;&amp;filename=&quot;);</span>
<a href="#l26.548"></a><span id="l26.548" class="difflineplus">+  if (start) {  // Make sure we only get our own value.</span>
<a href="#l26.549"></a><span id="l26.549" class="difflineplus">+    end = PL_strcasestr((char *)(start + FILENAME_PART_LEN), &quot;&amp;&quot;);</span>
<a href="#l26.550"></a><span id="l26.550" class="difflineplus">+    if (end) {</span>
<a href="#l26.551"></a><span id="l26.551">       *end = 0;</span>
<a href="#l26.552"></a><span id="l26.552" class="difflineminus">-      mAttachmentFileName = start+FILENAME_PART_LEN;</span>
<a href="#l26.553"></a><span id="l26.553" class="difflineplus">+      mAttachmentFileName = start + FILENAME_PART_LEN;</span>
<a href="#l26.554"></a><span id="l26.554">       *end = '&amp;';</span>
<a href="#l26.555"></a><span id="l26.555" class="difflineminus">-    }</span>
<a href="#l26.556"></a><span id="l26.556" class="difflineminus">-    else</span>
<a href="#l26.557"></a><span id="l26.557" class="difflineminus">-      mAttachmentFileName = start+FILENAME_PART_LEN;</span>
<a href="#l26.558"></a><span id="l26.558" class="difflineplus">+    } else</span>
<a href="#l26.559"></a><span id="l26.559" class="difflineplus">+      mAttachmentFileName = start + FILENAME_PART_LEN;</span>
<a href="#l26.560"></a><span id="l26.560">   }</span>
<a href="#l26.561"></a><span id="l26.561"> </span>
<a href="#l26.562"></a><span id="l26.562">   // Now, set the rest.</span>
<a href="#l26.563"></a><span id="l26.563">   nsresult rv = CreateURL(aSpec, getter_AddRefs(m_baseURL));</span>
<a href="#l26.564"></a><span id="l26.564">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.565"></a><span id="l26.565"> </span>
<a href="#l26.566"></a><span id="l26.566">   // Check whether the URL is in normalized form.</span>
<a href="#l26.567"></a><span id="l26.567" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageUrl&gt; msgUrl;</span>
<a href="#l26.568"></a><span id="l26.568" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl;</span>
<a href="#l26.569"></a><span id="l26.569">   QueryInterface(NS_GET_IID(nsIMsgMessageUrl), getter_AddRefs(msgUrl));</span>
<a href="#l26.570"></a><span id="l26.570"> </span>
<a href="#l26.571"></a><span id="l26.571">   nsAutoCString normalizedSpec;</span>
<a href="#l26.572"></a><span id="l26.572">   if (!msgUrl || NS_FAILED(msgUrl-&gt;GetNormalizedSpec(normalizedSpec))) {</span>
<a href="#l26.573"></a><span id="l26.573" class="difflineminus">-    // If we can't get the normalized spec, never QI this to nsIURIWithSpecialOrigin.</span>
<a href="#l26.574"></a><span id="l26.574" class="difflineplus">+    // If we can't get the normalized spec, never QI this to</span>
<a href="#l26.575"></a><span id="l26.575" class="difflineplus">+    // nsIURIWithSpecialOrigin.</span>
<a href="#l26.576"></a><span id="l26.576">     m_hasNormalizedOrigin = false;</span>
<a href="#l26.577"></a><span id="l26.577">   } else {</span>
<a href="#l26.578"></a><span id="l26.578">     m_hasNormalizedOrigin = !spec.Equals(normalizedSpec);</span>
<a href="#l26.579"></a><span id="l26.579">   }</span>
<a href="#l26.580"></a><span id="l26.580">   return NS_OK;</span>
<a href="#l26.581"></a><span id="l26.581"> }</span>
<a href="#l26.582"></a><span id="l26.582"> </span>
<a href="#l26.583"></a><span id="l26.583" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetPrePath(nsACString &amp;aPrePath)</span>
<a href="#l26.584"></a><span id="l26.584" class="difflineminus">-{</span>
<a href="#l26.585"></a><span id="l26.585" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetPrePath(nsACString &amp;aPrePath) {</span>
<a href="#l26.586"></a><span id="l26.586">   return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l26.587"></a><span id="l26.587"> }</span>
<a href="#l26.588"></a><span id="l26.588"> </span>
<a href="#l26.589"></a><span id="l26.589" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l26.590"></a><span id="l26.590" class="difflineminus">-{</span>
<a href="#l26.591"></a><span id="l26.591" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l26.592"></a><span id="l26.592">   return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l26.593"></a><span id="l26.593"> }</span>
<a href="#l26.594"></a><span id="l26.594"> </span>
<a href="#l26.595"></a><span id="l26.595" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l26.596"></a><span id="l26.596" class="difflineminus">-{</span>
<a href="#l26.597"></a><span id="l26.597" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetScheme(const nsACString &amp;aScheme) {</span>
<a href="#l26.598"></a><span id="l26.598">   return NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l26.599"></a><span id="l26.599"> }</span>
<a href="#l26.600"></a><span id="l26.600"> </span>
<a href="#l26.601"></a><span id="l26.601" class="difflineminus">-</span>
<a href="#l26.602"></a><span id="l26.602" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l26.603"></a><span id="l26.603" class="difflineminus">-{</span>
<a href="#l26.604"></a><span id="l26.604" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetUserPass(nsACString &amp;aUserPass) {</span>
<a href="#l26.605"></a><span id="l26.605">   return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l26.606"></a><span id="l26.606"> }</span>
<a href="#l26.607"></a><span id="l26.607"> </span>
<a href="#l26.608"></a><span id="l26.608" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l26.609"></a><span id="l26.609" class="difflineminus">-{</span>
<a href="#l26.610"></a><span id="l26.610" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetUserPass(const nsACString &amp;aUserPass) {</span>
<a href="#l26.611"></a><span id="l26.611">   return NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l26.612"></a><span id="l26.612"> }</span>
<a href="#l26.613"></a><span id="l26.613"> </span>
<a href="#l26.614"></a><span id="l26.614" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l26.615"></a><span id="l26.615" class="difflineminus">-{</span>
<a href="#l26.616"></a><span id="l26.616" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetUsername(nsACString &amp;aUsername) {</span>
<a href="#l26.617"></a><span id="l26.617">   /* note:  this will return an escaped string */</span>
<a href="#l26.618"></a><span id="l26.618">   return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l26.619"></a><span id="l26.619"> }</span>
<a href="#l26.620"></a><span id="l26.620"> </span>
<a href="#l26.621"></a><span id="l26.621" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l26.622"></a><span id="l26.622" class="difflineminus">-{</span>
<a href="#l26.623"></a><span id="l26.623" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetUsername(const nsACString &amp;aUsername) {</span>
<a href="#l26.624"></a><span id="l26.624">   return NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l26.625"></a><span id="l26.625"> }</span>
<a href="#l26.626"></a><span id="l26.626"> </span>
<a href="#l26.627"></a><span id="l26.627" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetUsernameInternal(const nsACString &amp;aUsername)</span>
<a href="#l26.628"></a><span id="l26.628" class="difflineminus">-{</span>
<a href="#l26.629"></a><span id="l26.629" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetUsernameInternal(const nsACString &amp;aUsername) {</span>
<a href="#l26.630"></a><span id="l26.630">   return NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l26.631"></a><span id="l26.631"> }</span>
<a href="#l26.632"></a><span id="l26.632"> </span>
<a href="#l26.633"></a><span id="l26.633" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l26.634"></a><span id="l26.634" class="difflineminus">-{</span>
<a href="#l26.635"></a><span id="l26.635" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetPassword(nsACString &amp;aPassword) {</span>
<a href="#l26.636"></a><span id="l26.636">   return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l26.637"></a><span id="l26.637"> }</span>
<a href="#l26.638"></a><span id="l26.638"> </span>
<a href="#l26.639"></a><span id="l26.639" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l26.640"></a><span id="l26.640" class="difflineminus">-{</span>
<a href="#l26.641"></a><span id="l26.641" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPassword(const nsACString &amp;aPassword) {</span>
<a href="#l26.642"></a><span id="l26.642">   return NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l26.643"></a><span id="l26.643"> }</span>
<a href="#l26.644"></a><span id="l26.644"> </span>
<a href="#l26.645"></a><span id="l26.645" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l26.646"></a><span id="l26.646" class="difflineminus">-{</span>
<a href="#l26.647"></a><span id="l26.647" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetHostPort(nsACString &amp;aHostPort) {</span>
<a href="#l26.648"></a><span id="l26.648">   return m_baseURL-&gt;GetHostPort(aHostPort);</span>
<a href="#l26.649"></a><span id="l26.649"> }</span>
<a href="#l26.650"></a><span id="l26.650"> </span>
<a href="#l26.651"></a><span id="l26.651" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l26.652"></a><span id="l26.652" class="difflineminus">-{</span>
<a href="#l26.653"></a><span id="l26.653" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetHostPort(const nsACString &amp;aHostPort) {</span>
<a href="#l26.654"></a><span id="l26.654">   return NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l26.655"></a><span id="l26.655"> }</span>
<a href="#l26.656"></a><span id="l26.656"> </span>
<a href="#l26.657"></a><span id="l26.657" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l26.658"></a><span id="l26.658" class="difflineminus">-{</span>
<a href="#l26.659"></a><span id="l26.659" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetHost(nsACString &amp;aHost) {</span>
<a href="#l26.660"></a><span id="l26.660">   return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l26.661"></a><span id="l26.661"> }</span>
<a href="#l26.662"></a><span id="l26.662"> </span>
<a href="#l26.663"></a><span id="l26.663" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l26.664"></a><span id="l26.664" class="difflineminus">-{</span>
<a href="#l26.665"></a><span id="l26.665" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetHost(const nsACString &amp;aHost) {</span>
<a href="#l26.666"></a><span id="l26.666">   return NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l26.667"></a><span id="l26.667"> }</span>
<a href="#l26.668"></a><span id="l26.668"> </span>
<a href="#l26.669"></a><span id="l26.669" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetPort(int32_t *aPort)</span>
<a href="#l26.670"></a><span id="l26.670" class="difflineminus">-{</span>
<a href="#l26.671"></a><span id="l26.671" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetPort(int32_t *aPort) {</span>
<a href="#l26.672"></a><span id="l26.672">   return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l26.673"></a><span id="l26.673"> }</span>
<a href="#l26.674"></a><span id="l26.674"> </span>
<a href="#l26.675"></a><span id="l26.675" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetPort(int32_t aPort)</span>
<a href="#l26.676"></a><span id="l26.676" class="difflineminus">-{</span>
<a href="#l26.677"></a><span id="l26.677" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPort(int32_t aPort) {</span>
<a href="#l26.678"></a><span id="l26.678">   return NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l26.679"></a><span id="l26.679"> }</span>
<a href="#l26.680"></a><span id="l26.680"> </span>
<a href="#l26.681"></a><span id="l26.681" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetPortInternal(int32_t aPort)</span>
<a href="#l26.682"></a><span id="l26.682" class="difflineminus">-{</span>
<a href="#l26.683"></a><span id="l26.683" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPortInternal(int32_t aPort) {</span>
<a href="#l26.684"></a><span id="l26.684">   return NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l26.685"></a><span id="l26.685"> }</span>
<a href="#l26.686"></a><span id="l26.686"> </span>
<a href="#l26.687"></a><span id="l26.687" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l26.688"></a><span id="l26.688" class="difflineminus">-{</span>
<a href="#l26.689"></a><span id="l26.689" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetPathQueryRef(nsACString &amp;aPath) {</span>
<a href="#l26.690"></a><span id="l26.690">   return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l26.691"></a><span id="l26.691"> }</span>
<a href="#l26.692"></a><span id="l26.692"> </span>
<a href="#l26.693"></a><span id="l26.693" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l26.694"></a><span id="l26.694" class="difflineminus">-{</span>
<a href="#l26.695"></a><span id="l26.695" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetPathQueryRef(const nsACString &amp;aPath) {</span>
<a href="#l26.696"></a><span id="l26.696">   return NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l26.697"></a><span id="l26.697"> }</span>
<a href="#l26.698"></a><span id="l26.698"> </span>
<a href="#l26.699"></a><span id="l26.699" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l26.700"></a><span id="l26.700" class="difflineminus">-{</span>
<a href="#l26.701"></a><span id="l26.701" class="difflineminus">-    return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l26.702"></a><span id="l26.702" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiHost(nsACString &amp;aHostA) {</span>
<a href="#l26.703"></a><span id="l26.703" class="difflineplus">+  return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l26.704"></a><span id="l26.704"> }</span>
<a href="#l26.705"></a><span id="l26.705"> </span>
<a href="#l26.706"></a><span id="l26.706" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiHostPort(nsACString &amp;aHostPortA)</span>
<a href="#l26.707"></a><span id="l26.707" class="difflineminus">-{</span>
<a href="#l26.708"></a><span id="l26.708" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiHostPort(nsACString &amp;aHostPortA) {</span>
<a href="#l26.709"></a><span id="l26.709">   return m_baseURL-&gt;GetAsciiHostPort(aHostPortA);</span>
<a href="#l26.710"></a><span id="l26.710"> }</span>
<a href="#l26.711"></a><span id="l26.711"> </span>
<a href="#l26.712"></a><span id="l26.712" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiSpec(nsACString &amp;aSpecA)</span>
<a href="#l26.713"></a><span id="l26.713" class="difflineminus">-{</span>
<a href="#l26.714"></a><span id="l26.714" class="difflineminus">-    return m_baseURL-&gt;GetAsciiSpec(aSpecA);</span>
<a href="#l26.715"></a><span id="l26.715" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetAsciiSpec(nsACString &amp;aSpecA) {</span>
<a href="#l26.716"></a><span id="l26.716" class="difflineplus">+  return m_baseURL-&gt;GetAsciiSpec(aSpecA);</span>
<a href="#l26.717"></a><span id="l26.717"> }</span>
<a href="#l26.718"></a><span id="l26.718"> </span>
<a href="#l26.719"></a><span id="l26.719" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetBaseURI(nsIURI **aBaseURI)</span>
<a href="#l26.720"></a><span id="l26.720" class="difflineminus">-{</span>
<a href="#l26.721"></a><span id="l26.721" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetBaseURI(nsIURI **aBaseURI) {</span>
<a href="#l26.722"></a><span id="l26.722">   NS_ENSURE_ARG_POINTER(aBaseURI);</span>
<a href="#l26.723"></a><span id="l26.723" class="difflineminus">-  return m_baseURL-&gt;QueryInterface(NS_GET_IID(nsIURI), (void**) aBaseURI);</span>
<a href="#l26.724"></a><span id="l26.724" class="difflineplus">+  return m_baseURL-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **)aBaseURI);</span>
<a href="#l26.725"></a><span id="l26.725"> }</span>
<a href="#l26.726"></a><span id="l26.726"> </span>
<a href="#l26.727"></a><span id="l26.727" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::Equals(nsIURI *other, bool *_retval)</span>
<a href="#l26.728"></a><span id="l26.728" class="difflineminus">-{</span>
<a href="#l26.729"></a><span id="l26.729" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::Equals(nsIURI *other, bool *_retval) {</span>
<a href="#l26.730"></a><span id="l26.730">   // The passed-in URI might be a mail news url. Pass our inner URL to its</span>
<a href="#l26.731"></a><span id="l26.731">   // Equals method. The other mail news url will then pass its inner URL to</span>
<a href="#l26.732"></a><span id="l26.732">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l26.733"></a><span id="l26.733" class="difflineminus">-  if (other)</span>
<a href="#l26.734"></a><span id="l26.734" class="difflineminus">-    return other-&gt;Equals(m_baseURL, _retval);</span>
<a href="#l26.735"></a><span id="l26.735" class="difflineplus">+  if (other) return other-&gt;Equals(m_baseURL, _retval);</span>
<a href="#l26.736"></a><span id="l26.736"> </span>
<a href="#l26.737"></a><span id="l26.737">   return m_baseURL-&gt;Equals(other, _retval);</span>
<a href="#l26.738"></a><span id="l26.738"> }</span>
<a href="#l26.739"></a><span id="l26.739"> </span>
<a href="#l26.740"></a><span id="l26.740" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::EqualsExceptRef(nsIURI *other, bool *result)</span>
<a href="#l26.741"></a><span id="l26.741" class="difflineminus">-{</span>
<a href="#l26.742"></a><span id="l26.742" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::EqualsExceptRef(nsIURI *other, bool *result) {</span>
<a href="#l26.743"></a><span id="l26.743">   // The passed-in URI might be a mail news url. Pass our inner URL to its</span>
<a href="#l26.744"></a><span id="l26.744">   // Equals method. The other mail news url will then pass its inner URL to</span>
<a href="#l26.745"></a><span id="l26.745">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l26.746"></a><span id="l26.746" class="difflineminus">-  if (other)</span>
<a href="#l26.747"></a><span id="l26.747" class="difflineminus">-    return other-&gt;EqualsExceptRef(m_baseURL, result);</span>
<a href="#l26.748"></a><span id="l26.748" class="difflineplus">+  if (other) return other-&gt;EqualsExceptRef(m_baseURL, result);</span>
<a href="#l26.749"></a><span id="l26.749"> </span>
<a href="#l26.750"></a><span id="l26.750">   return m_baseURL-&gt;EqualsExceptRef(other, result);</span>
<a href="#l26.751"></a><span id="l26.751"> }</span>
<a href="#l26.752"></a><span id="l26.752"> </span>
<a href="#l26.753"></a><span id="l26.753"> NS_IMETHODIMP</span>
<a href="#l26.754"></a><span id="l26.754" class="difflineminus">-nsMsgMailNewsUrl::GetSpecIgnoringRef(nsACString &amp;result)</span>
<a href="#l26.755"></a><span id="l26.755" class="difflineminus">-{</span>
<a href="#l26.756"></a><span id="l26.756" class="difflineplus">+nsMsgMailNewsUrl::GetSpecIgnoringRef(nsACString &amp;result) {</span>
<a href="#l26.757"></a><span id="l26.757">   return m_baseURL-&gt;GetSpecIgnoringRef(result);</span>
<a href="#l26.758"></a><span id="l26.758"> }</span>
<a href="#l26.759"></a><span id="l26.759"> </span>
<a href="#l26.760"></a><span id="l26.760"> NS_IMETHODIMP</span>
<a href="#l26.761"></a><span id="l26.761" class="difflineminus">-nsMsgMailNewsUrl::GetDisplaySpec(nsACString&amp; aUnicodeSpec)</span>
<a href="#l26.762"></a><span id="l26.762" class="difflineminus">-{</span>
<a href="#l26.763"></a><span id="l26.763" class="difflineplus">+nsMsgMailNewsUrl::GetDisplaySpec(nsACString &amp;aUnicodeSpec) {</span>
<a href="#l26.764"></a><span id="l26.764">   return GetSpec(aUnicodeSpec);</span>
<a href="#l26.765"></a><span id="l26.765"> }</span>
<a href="#l26.766"></a><span id="l26.766"> </span>
<a href="#l26.767"></a><span id="l26.767"> NS_IMETHODIMP</span>
<a href="#l26.768"></a><span id="l26.768" class="difflineminus">-nsMsgMailNewsUrl::GetDisplayHostPort(nsACString&amp; aUnicodeHostPort)</span>
<a href="#l26.769"></a><span id="l26.769" class="difflineminus">-{</span>
<a href="#l26.770"></a><span id="l26.770" class="difflineplus">+nsMsgMailNewsUrl::GetDisplayHostPort(nsACString &amp;aUnicodeHostPort) {</span>
<a href="#l26.771"></a><span id="l26.771">   return GetHostPort(aUnicodeHostPort);</span>
<a href="#l26.772"></a><span id="l26.772"> }</span>
<a href="#l26.773"></a><span id="l26.773"> </span>
<a href="#l26.774"></a><span id="l26.774"> NS_IMETHODIMP</span>
<a href="#l26.775"></a><span id="l26.775" class="difflineminus">-nsMsgMailNewsUrl::GetDisplayHost(nsACString&amp; aUnicodeHost)</span>
<a href="#l26.776"></a><span id="l26.776" class="difflineminus">-{</span>
<a href="#l26.777"></a><span id="l26.777" class="difflineplus">+nsMsgMailNewsUrl::GetDisplayHost(nsACString &amp;aUnicodeHost) {</span>
<a href="#l26.778"></a><span id="l26.778">   return GetHost(aUnicodeHost);</span>
<a href="#l26.779"></a><span id="l26.779"> }</span>
<a href="#l26.780"></a><span id="l26.780"> </span>
<a href="#l26.781"></a><span id="l26.781"> NS_IMETHODIMP</span>
<a href="#l26.782"></a><span id="l26.782" class="difflineminus">-nsMsgMailNewsUrl::GetDisplayPrePath(nsACString&amp; aPrePath)</span>
<a href="#l26.783"></a><span id="l26.783" class="difflineminus">-{</span>
<a href="#l26.784"></a><span id="l26.784" class="difflineplus">+nsMsgMailNewsUrl::GetDisplayPrePath(nsACString &amp;aPrePath) {</span>
<a href="#l26.785"></a><span id="l26.785">   return GetPrePath(aPrePath);</span>
<a href="#l26.786"></a><span id="l26.786"> }</span>
<a href="#l26.787"></a><span id="l26.787"> </span>
<a href="#l26.788"></a><span id="l26.788"> NS_IMETHODIMP</span>
<a href="#l26.789"></a><span id="l26.789" class="difflineminus">-nsMsgMailNewsUrl::GetHasRef(bool *result)</span>
<a href="#l26.790"></a><span id="l26.790" class="difflineminus">-{</span>
<a href="#l26.791"></a><span id="l26.791" class="difflineplus">+nsMsgMailNewsUrl::GetHasRef(bool *result) {</span>
<a href="#l26.792"></a><span id="l26.792">   return m_baseURL-&gt;GetHasRef(result);</span>
<a href="#l26.793"></a><span id="l26.793"> }</span>
<a href="#l26.794"></a><span id="l26.794"> </span>
<a href="#l26.795"></a><span id="l26.795" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SchemeIs(const char *aScheme, bool *_retval)</span>
<a href="#l26.796"></a><span id="l26.796" class="difflineminus">-{</span>
<a href="#l26.797"></a><span id="l26.797" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SchemeIs(const char *aScheme, bool *_retval) {</span>
<a href="#l26.798"></a><span id="l26.798">   return m_baseURL-&gt;SchemeIs(aScheme, _retval);</span>
<a href="#l26.799"></a><span id="l26.799"> }</span>
<a href="#l26.800"></a><span id="l26.800"> </span>
<a href="#l26.801"></a><span id="l26.801" class="difflineminus">-nsresult</span>
<a href="#l26.802"></a><span id="l26.802" class="difflineminus">-nsMsgMailNewsUrl::Clone(nsIURI** _retval)</span>
<a href="#l26.803"></a><span id="l26.803" class="difflineminus">-{</span>
<a href="#l26.804"></a><span id="l26.804" class="difflineplus">+nsresult nsMsgMailNewsUrl::Clone(nsIURI **_retval) {</span>
<a href="#l26.805"></a><span id="l26.805">   nsresult rv;</span>
<a href="#l26.806"></a><span id="l26.806">   nsAutoCString urlSpec;</span>
<a href="#l26.807"></a><span id="l26.807" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l26.808"></a><span id="l26.808" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l26.809"></a><span id="l26.809" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l26.810"></a><span id="l26.810">   NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l26.811"></a><span id="l26.811">   rv = GetSpec(urlSpec);</span>
<a href="#l26.812"></a><span id="l26.812">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.813"></a><span id="l26.813">   nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l26.814"></a><span id="l26.814">   rv = ioService-&gt;NewURI(urlSpec, nullptr, nullptr, getter_AddRefs(newUri));</span>
<a href="#l26.815"></a><span id="l26.815">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.816"></a><span id="l26.816"> </span>
<a href="#l26.817"></a><span id="l26.817">   // add the msg window to the cloned url</span>
<a href="#l26.818"></a><span id="l26.818">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l26.819"></a><span id="l26.819" class="difflineminus">-  if (msgWindow)</span>
<a href="#l26.820"></a><span id="l26.820" class="difflineminus">-  {</span>
<a href="#l26.821"></a><span id="l26.821" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l26.822"></a><span id="l26.822">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgMailNewsUrl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l26.823"></a><span id="l26.823">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.824"></a><span id="l26.824">     msgMailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l26.825"></a><span id="l26.825">   }</span>
<a href="#l26.826"></a><span id="l26.826"> </span>
<a href="#l26.827"></a><span id="l26.827">   newUri.forget(_retval);</span>
<a href="#l26.828"></a><span id="l26.828">   return rv;</span>
<a href="#l26.829"></a><span id="l26.829"> }</span>
<a href="#l26.830"></a><span id="l26.830"> </span>
<a href="#l26.831"></a><span id="l26.831" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::Resolve(const nsACString &amp;relativePath, nsACString &amp;result)</span>
<a href="#l26.832"></a><span id="l26.832" class="difflineminus">-{</span>
<a href="#l26.833"></a><span id="l26.833" class="difflineminus">-  // only resolve anchor urls....i.e. urls which start with '#' against the mailnews url...</span>
<a href="#l26.834"></a><span id="l26.834" class="difflineminus">-  // everything else shouldn't be resolved against mailnews urls.</span>
<a href="#l26.835"></a><span id="l26.835" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::Resolve(const nsACString &amp;relativePath,</span>
<a href="#l26.836"></a><span id="l26.836" class="difflineplus">+                                        nsACString &amp;result) {</span>
<a href="#l26.837"></a><span id="l26.837" class="difflineplus">+  // only resolve anchor urls....i.e. urls which start with '#' against the</span>
<a href="#l26.838"></a><span id="l26.838" class="difflineplus">+  // mailnews url... everything else shouldn't be resolved against mailnews</span>
<a href="#l26.839"></a><span id="l26.839" class="difflineplus">+  // urls.</span>
<a href="#l26.840"></a><span id="l26.840">   nsresult rv = NS_OK;</span>
<a href="#l26.841"></a><span id="l26.841"> </span>
<a href="#l26.842"></a><span id="l26.842" class="difflineminus">-  if (relativePath.IsEmpty())</span>
<a href="#l26.843"></a><span id="l26.843" class="difflineminus">-  {</span>
<a href="#l26.844"></a><span id="l26.844" class="difflineplus">+  if (relativePath.IsEmpty()) {</span>
<a href="#l26.845"></a><span id="l26.845">     // Return base URL.</span>
<a href="#l26.846"></a><span id="l26.846">     rv = GetSpec(result);</span>
<a href="#l26.847"></a><span id="l26.847" class="difflineminus">-  }</span>
<a href="#l26.848"></a><span id="l26.848" class="difflineminus">-  else if (!relativePath.IsEmpty() &amp;&amp; relativePath.First() == '#') // an anchor</span>
<a href="#l26.849"></a><span id="l26.849" class="difflineplus">+  } else if (!relativePath.IsEmpty() &amp;&amp;</span>
<a href="#l26.850"></a><span id="l26.850" class="difflineplus">+             relativePath.First() == '#')  // an anchor</span>
<a href="#l26.851"></a><span id="l26.851">   {</span>
<a href="#l26.852"></a><span id="l26.852">     rv = m_baseURL-&gt;Resolve(relativePath, result);</span>
<a href="#l26.853"></a><span id="l26.853" class="difflineminus">-  }</span>
<a href="#l26.854"></a><span id="l26.854" class="difflineminus">-  else</span>
<a href="#l26.855"></a><span id="l26.855" class="difflineminus">-  {</span>
<a href="#l26.856"></a><span id="l26.856" class="difflineplus">+  } else {</span>
<a href="#l26.857"></a><span id="l26.857">     // if relativePath is a complete url with it's own scheme then allow it...</span>
<a href="#l26.858"></a><span id="l26.858" class="difflineminus">-    nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l26.859"></a><span id="l26.859" class="difflineminus">-      mozilla::services::GetIOService();</span>
<a href="#l26.860"></a><span id="l26.860" class="difflineplus">+    nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l26.861"></a><span id="l26.861">     NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l26.862"></a><span id="l26.862">     nsAutoCString scheme;</span>
<a href="#l26.863"></a><span id="l26.863"> </span>
<a href="#l26.864"></a><span id="l26.864">     rv = ioService-&gt;ExtractScheme(relativePath, scheme);</span>
<a href="#l26.865"></a><span id="l26.865" class="difflineminus">-    // if we have a fully qualified scheme then pass the relative path back as the result</span>
<a href="#l26.866"></a><span id="l26.866" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !scheme.IsEmpty())</span>
<a href="#l26.867"></a><span id="l26.867" class="difflineminus">-    {</span>
<a href="#l26.868"></a><span id="l26.868" class="difflineplus">+    // if we have a fully qualified scheme then pass the relative path back as</span>
<a href="#l26.869"></a><span id="l26.869" class="difflineplus">+    // the result</span>
<a href="#l26.870"></a><span id="l26.870" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !scheme.IsEmpty()) {</span>
<a href="#l26.871"></a><span id="l26.871">       result = relativePath;</span>
<a href="#l26.872"></a><span id="l26.872">       rv = NS_OK;</span>
<a href="#l26.873"></a><span id="l26.873" class="difflineminus">-    }</span>
<a href="#l26.874"></a><span id="l26.874" class="difflineminus">-    else</span>
<a href="#l26.875"></a><span id="l26.875" class="difflineminus">-    {</span>
<a href="#l26.876"></a><span id="l26.876" class="difflineplus">+    } else {</span>
<a href="#l26.877"></a><span id="l26.877">       result.Truncate();</span>
<a href="#l26.878"></a><span id="l26.878">       rv = NS_ERROR_FAILURE;</span>
<a href="#l26.879"></a><span id="l26.879">     }</span>
<a href="#l26.880"></a><span id="l26.880">   }</span>
<a href="#l26.881"></a><span id="l26.881"> </span>
<a href="#l26.882"></a><span id="l26.882">   return rv;</span>
<a href="#l26.883"></a><span id="l26.883"> }</span>
<a href="#l26.884"></a><span id="l26.884"> </span>
<a href="#l26.885"></a><span id="l26.885" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetDirectory(nsACString &amp;aDirectory)</span>
<a href="#l26.886"></a><span id="l26.886" class="difflineminus">-{</span>
<a href="#l26.887"></a><span id="l26.887" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetDirectory(nsACString &amp;aDirectory) {</span>
<a href="#l26.888"></a><span id="l26.888">   return m_baseURL-&gt;GetDirectory(aDirectory);</span>
<a href="#l26.889"></a><span id="l26.889"> }</span>
<a href="#l26.890"></a><span id="l26.890"> </span>
<a href="#l26.891"></a><span id="l26.891" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetFileName(nsACString &amp;aFileName)</span>
<a href="#l26.892"></a><span id="l26.892" class="difflineminus">-{</span>
<a href="#l26.893"></a><span id="l26.893" class="difflineminus">-  if (!mAttachmentFileName.IsEmpty())</span>
<a href="#l26.894"></a><span id="l26.894" class="difflineminus">-  {</span>
<a href="#l26.895"></a><span id="l26.895" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetFileName(nsACString &amp;aFileName) {</span>
<a href="#l26.896"></a><span id="l26.896" class="difflineplus">+  if (!mAttachmentFileName.IsEmpty()) {</span>
<a href="#l26.897"></a><span id="l26.897">     aFileName = mAttachmentFileName;</span>
<a href="#l26.898"></a><span id="l26.898">     return NS_OK;</span>
<a href="#l26.899"></a><span id="l26.899">   }</span>
<a href="#l26.900"></a><span id="l26.900">   return m_baseURL-&gt;GetFileName(aFileName);</span>
<a href="#l26.901"></a><span id="l26.901"> }</span>
<a href="#l26.902"></a><span id="l26.902"> </span>
<a href="#l26.903"></a><span id="l26.903" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetFileBaseName(nsACString &amp;aFileBaseName)</span>
<a href="#l26.904"></a><span id="l26.904" class="difflineminus">-{</span>
<a href="#l26.905"></a><span id="l26.905" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetFileBaseName(nsACString &amp;aFileBaseName) {</span>
<a href="#l26.906"></a><span id="l26.906">   return m_baseURL-&gt;GetFileBaseName(aFileBaseName);</span>
<a href="#l26.907"></a><span id="l26.907"> }</span>
<a href="#l26.908"></a><span id="l26.908"> </span>
<a href="#l26.909"></a><span id="l26.909" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetFileExtension(nsACString &amp;aFileExtension)</span>
<a href="#l26.910"></a><span id="l26.910" class="difflineminus">-{</span>
<a href="#l26.911"></a><span id="l26.911" class="difflineminus">-  if (!mAttachmentFileName.IsEmpty())</span>
<a href="#l26.912"></a><span id="l26.912" class="difflineminus">-  {</span>
<a href="#l26.913"></a><span id="l26.913" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetFileExtension(nsACString &amp;aFileExtension) {</span>
<a href="#l26.914"></a><span id="l26.914" class="difflineplus">+  if (!mAttachmentFileName.IsEmpty()) {</span>
<a href="#l26.915"></a><span id="l26.915">     int32_t pos = mAttachmentFileName.RFindChar(char16_t('.'));</span>
<a href="#l26.916"></a><span id="l26.916">     if (pos &gt; 0)</span>
<a href="#l26.917"></a><span id="l26.917" class="difflineminus">-      aFileExtension = Substring(mAttachmentFileName, pos + 1 /* skip the '.' */);</span>
<a href="#l26.918"></a><span id="l26.918" class="difflineplus">+      aFileExtension =</span>
<a href="#l26.919"></a><span id="l26.919" class="difflineplus">+          Substring(mAttachmentFileName, pos + 1 /* skip the '.' */);</span>
<a href="#l26.920"></a><span id="l26.920">     return NS_OK;</span>
<a href="#l26.921"></a><span id="l26.921">   }</span>
<a href="#l26.922"></a><span id="l26.922">   return m_baseURL-&gt;GetFileExtension(aFileExtension);</span>
<a href="#l26.923"></a><span id="l26.923"> }</span>
<a href="#l26.924"></a><span id="l26.924"> </span>
<a href="#l26.925"></a><span id="l26.925" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetFileNameInternal(const nsACString &amp;aFileName)</span>
<a href="#l26.926"></a><span id="l26.926" class="difflineminus">-{</span>
<a href="#l26.927"></a><span id="l26.927" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetFileNameInternal(const nsACString &amp;aFileName) {</span>
<a href="#l26.928"></a><span id="l26.928">   mAttachmentFileName = aFileName;</span>
<a href="#l26.929"></a><span id="l26.929">   return NS_OK;</span>
<a href="#l26.930"></a><span id="l26.930"> }</span>
<a href="#l26.931"></a><span id="l26.931"> </span>
<a href="#l26.932"></a><span id="l26.932" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l26.933"></a><span id="l26.933" class="difflineminus">-{</span>
<a href="#l26.934"></a><span id="l26.934" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetQuery(nsACString &amp;aQuery) {</span>
<a href="#l26.935"></a><span id="l26.935">   return m_baseURL-&gt;GetQuery(aQuery);</span>
<a href="#l26.936"></a><span id="l26.936"> }</span>
<a href="#l26.937"></a><span id="l26.937"> </span>
<a href="#l26.938"></a><span id="l26.938" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l26.939"></a><span id="l26.939" class="difflineminus">-{</span>
<a href="#l26.940"></a><span id="l26.940" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetQuery(const nsACString &amp;aQuery) {</span>
<a href="#l26.941"></a><span id="l26.941">   return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l26.942"></a><span id="l26.942"> }</span>
<a href="#l26.943"></a><span id="l26.943"> </span>
<a href="#l26.944"></a><span id="l26.944" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetQueryInternal(const nsACString &amp;aQuery)</span>
<a href="#l26.945"></a><span id="l26.945" class="difflineminus">-{</span>
<a href="#l26.946"></a><span id="l26.946" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetQueryInternal(const nsACString &amp;aQuery) {</span>
<a href="#l26.947"></a><span id="l26.947">   return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l26.948"></a><span id="l26.948"> }</span>
<a href="#l26.949"></a><span id="l26.949"> </span>
<a href="#l26.950"></a><span id="l26.950" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l26.951"></a><span id="l26.951" class="difflineminus">-{</span>
<a href="#l26.952"></a><span id="l26.952" class="difflineminus">-  return NS_MutateURI(m_baseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(m_baseURL);</span>
<a href="#l26.953"></a><span id="l26.953" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetQueryWithEncoding(</span>
<a href="#l26.954"></a><span id="l26.954" class="difflineplus">+    const nsACString &amp;aQuery, const mozilla::Encoding *aEncoding) {</span>
<a href="#l26.955"></a><span id="l26.955" class="difflineplus">+  return NS_MutateURI(m_baseURL)</span>
<a href="#l26.956"></a><span id="l26.956" class="difflineplus">+      .SetQueryWithEncoding(aQuery, aEncoding)</span>
<a href="#l26.957"></a><span id="l26.957" class="difflineplus">+      .Finalize(m_baseURL);</span>
<a href="#l26.958"></a><span id="l26.958"> }</span>
<a href="#l26.959"></a><span id="l26.959"> </span>
<a href="#l26.960"></a><span id="l26.960" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetRef(nsACString &amp;aRef)</span>
<a href="#l26.961"></a><span id="l26.961" class="difflineminus">-{</span>
<a href="#l26.962"></a><span id="l26.962" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetRef(nsACString &amp;aRef) {</span>
<a href="#l26.963"></a><span id="l26.963">   return m_baseURL-&gt;GetRef(aRef);</span>
<a href="#l26.964"></a><span id="l26.964"> }</span>
<a href="#l26.965"></a><span id="l26.965"> </span>
<a href="#l26.966"></a><span id="l26.966" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l26.967"></a><span id="l26.967" class="difflineminus">-{</span>
<a href="#l26.968"></a><span id="l26.968" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetRef(const nsACString &amp;aRef) {</span>
<a href="#l26.969"></a><span id="l26.969">   return NS_MutateURI(m_baseURL).SetRef(aRef).Finalize(m_baseURL);</span>
<a href="#l26.970"></a><span id="l26.970"> }</span>
<a href="#l26.971"></a><span id="l26.971"> </span>
<a href="#l26.972"></a><span id="l26.972" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetFilePath(nsACString &amp;o_DirFile)</span>
<a href="#l26.973"></a><span id="l26.973" class="difflineminus">-{</span>
<a href="#l26.974"></a><span id="l26.974" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetFilePath(nsACString &amp;o_DirFile) {</span>
<a href="#l26.975"></a><span id="l26.975">   return m_baseURL-&gt;GetFilePath(o_DirFile);</span>
<a href="#l26.976"></a><span id="l26.976"> }</span>
<a href="#l26.977"></a><span id="l26.977"> </span>
<a href="#l26.978"></a><span id="l26.978" class="difflineminus">-nsresult nsMsgMailNewsUrl::SetFilePath(const nsACString &amp;i_DirFile)</span>
<a href="#l26.979"></a><span id="l26.979" class="difflineminus">-{</span>
<a href="#l26.980"></a><span id="l26.980" class="difflineplus">+nsresult nsMsgMailNewsUrl::SetFilePath(const nsACString &amp;i_DirFile) {</span>
<a href="#l26.981"></a><span id="l26.981">   return NS_MutateURI(m_baseURL).SetFilePath(i_DirFile).Finalize(m_baseURL);</span>
<a href="#l26.982"></a><span id="l26.982"> }</span>
<a href="#l26.983"></a><span id="l26.983"> </span>
<a href="#l26.984"></a><span id="l26.984" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetCommonBaseSpec(nsIURI *uri2, nsACString &amp;result)</span>
<a href="#l26.985"></a><span id="l26.985" class="difflineminus">-{</span>
<a href="#l26.986"></a><span id="l26.986" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetCommonBaseSpec(nsIURI *uri2,</span>
<a href="#l26.987"></a><span id="l26.987" class="difflineplus">+                                                  nsACString &amp;result) {</span>
<a href="#l26.988"></a><span id="l26.988">   return m_baseURL-&gt;GetCommonBaseSpec(uri2, result);</span>
<a href="#l26.989"></a><span id="l26.989"> }</span>
<a href="#l26.990"></a><span id="l26.990"> </span>
<a href="#l26.991"></a><span id="l26.991" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetRelativeSpec(nsIURI *uri2, nsACString &amp;result)</span>
<a href="#l26.992"></a><span id="l26.992" class="difflineminus">-{</span>
<a href="#l26.993"></a><span id="l26.993" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetRelativeSpec(nsIURI *uri2,</span>
<a href="#l26.994"></a><span id="l26.994" class="difflineplus">+                                                nsACString &amp;result) {</span>
<a href="#l26.995"></a><span id="l26.995">   return m_baseURL-&gt;GetRelativeSpec(uri2, result);</span>
<a href="#l26.996"></a><span id="l26.996"> }</span>
<a href="#l26.997"></a><span id="l26.997"> </span>
<a href="#l26.998"></a><span id="l26.998" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetMemCacheEntry(nsICacheEntry *memCacheEntry)</span>
<a href="#l26.999"></a><span id="l26.999" class="difflineminus">-{</span>
<a href="#l26.1000"></a><span id="l26.1000" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMemCacheEntry(nsICacheEntry *memCacheEntry) {</span>
<a href="#l26.1001"></a><span id="l26.1001">   m_memCacheEntry = memCacheEntry;</span>
<a href="#l26.1002"></a><span id="l26.1002">   return NS_OK;</span>
<a href="#l26.1003"></a><span id="l26.1003"> }</span>
<a href="#l26.1004"></a><span id="l26.1004"> </span>
<a href="#l26.1005"></a><span id="l26.1005" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetMemCacheEntry(nsICacheEntry **memCacheEntry)</span>
<a href="#l26.1006"></a><span id="l26.1006" class="difflineminus">-{</span>
<a href="#l26.1007"></a><span id="l26.1007" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMemCacheEntry(</span>
<a href="#l26.1008"></a><span id="l26.1008" class="difflineplus">+    nsICacheEntry **memCacheEntry) {</span>
<a href="#l26.1009"></a><span id="l26.1009">   NS_ENSURE_ARG(memCacheEntry);</span>
<a href="#l26.1010"></a><span id="l26.1010">   nsresult rv = NS_OK;</span>
<a href="#l26.1011"></a><span id="l26.1011"> </span>
<a href="#l26.1012"></a><span id="l26.1012" class="difflineminus">-  if (m_memCacheEntry)</span>
<a href="#l26.1013"></a><span id="l26.1013" class="difflineminus">-  {</span>
<a href="#l26.1014"></a><span id="l26.1014" class="difflineplus">+  if (m_memCacheEntry) {</span>
<a href="#l26.1015"></a><span id="l26.1015">     NS_ADDREF(*memCacheEntry = m_memCacheEntry);</span>
<a href="#l26.1016"></a><span id="l26.1016" class="difflineminus">-  }</span>
<a href="#l26.1017"></a><span id="l26.1017" class="difflineminus">-  else</span>
<a href="#l26.1018"></a><span id="l26.1018" class="difflineminus">-  {</span>
<a href="#l26.1019"></a><span id="l26.1019" class="difflineplus">+  } else {</span>
<a href="#l26.1020"></a><span id="l26.1020">     *memCacheEntry = nullptr;</span>
<a href="#l26.1021"></a><span id="l26.1021">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1022"></a><span id="l26.1022">   }</span>
<a href="#l26.1023"></a><span id="l26.1023"> </span>
<a href="#l26.1024"></a><span id="l26.1024">   return rv;</span>
<a href="#l26.1025"></a><span id="l26.1025"> }</span>
<a href="#l26.1026"></a><span id="l26.1026"> </span>
<a href="#l26.1027"></a><span id="l26.1027" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetMimeHeaders(nsIMimeHeaders * *mimeHeaders)</span>
<a href="#l26.1028"></a><span id="l26.1028" class="difflineminus">-{</span>
<a href="#l26.1029"></a><span id="l26.1029" class="difflineminus">-    NS_ENSURE_ARG_POINTER(mimeHeaders);</span>
<a href="#l26.1030"></a><span id="l26.1030" class="difflineminus">-    NS_IF_ADDREF(*mimeHeaders = mMimeHeaders);</span>
<a href="#l26.1031"></a><span id="l26.1031" class="difflineminus">-    return (mMimeHeaders) ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1032"></a><span id="l26.1032" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMimeHeaders(nsIMimeHeaders **mimeHeaders) {</span>
<a href="#l26.1033"></a><span id="l26.1033" class="difflineplus">+  NS_ENSURE_ARG_POINTER(mimeHeaders);</span>
<a href="#l26.1034"></a><span id="l26.1034" class="difflineplus">+  NS_IF_ADDREF(*mimeHeaders = mMimeHeaders);</span>
<a href="#l26.1035"></a><span id="l26.1035" class="difflineplus">+  return (mMimeHeaders) ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1036"></a><span id="l26.1036"> }</span>
<a href="#l26.1037"></a><span id="l26.1037"> </span>
<a href="#l26.1038"></a><span id="l26.1038" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetMimeHeaders(nsIMimeHeaders *mimeHeaders)</span>
<a href="#l26.1039"></a><span id="l26.1039" class="difflineminus">-{</span>
<a href="#l26.1040"></a><span id="l26.1040" class="difflineminus">-    mMimeHeaders = mimeHeaders;</span>
<a href="#l26.1041"></a><span id="l26.1041" class="difflineminus">-    return NS_OK;</span>
<a href="#l26.1042"></a><span id="l26.1042" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMimeHeaders(nsIMimeHeaders *mimeHeaders) {</span>
<a href="#l26.1043"></a><span id="l26.1043" class="difflineplus">+  mMimeHeaders = mimeHeaders;</span>
<a href="#l26.1044"></a><span id="l26.1044" class="difflineplus">+  return NS_OK;</span>
<a href="#l26.1045"></a><span id="l26.1045"> }</span>
<a href="#l26.1046"></a><span id="l26.1046"> </span>
<a href="#l26.1047"></a><span id="l26.1047" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::LoadURI(nsIDocShell* docShell,</span>
<a href="#l26.1048"></a><span id="l26.1048" class="difflineminus">-                                        uint32_t aLoadFlags)</span>
<a href="#l26.1049"></a><span id="l26.1049" class="difflineminus">-{</span>
<a href="#l26.1050"></a><span id="l26.1050" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::LoadURI(nsIDocShell *docShell,</span>
<a href="#l26.1051"></a><span id="l26.1051" class="difflineplus">+                                        uint32_t aLoadFlags) {</span>
<a href="#l26.1052"></a><span id="l26.1052">   NS_ENSURE_ARG_POINTER(docShell);</span>
<a href="#l26.1053"></a><span id="l26.1053">   RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(this);</span>
<a href="#l26.1054"></a><span id="l26.1054">   loadState-&gt;SetLoadFlags(aLoadFlags);</span>
<a href="#l26.1055"></a><span id="l26.1055">   loadState-&gt;SetLoadType(MAKE_LOAD_TYPE(LOAD_NORMAL, aLoadFlags));</span>
<a href="#l26.1056"></a><span id="l26.1056">   loadState-&gt;SetFirstParty(false);</span>
<a href="#l26.1057"></a><span id="l26.1057">   loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l26.1058"></a><span id="l26.1058">   return docShell-&gt;LoadURI(loadState);</span>
<a href="#l26.1059"></a><span id="l26.1059"> }</span>
<a href="#l26.1060"></a><span id="l26.1060"> </span>
<a href="#l26.1061"></a><span id="l26.1061"> #define SAVE_BUF_SIZE FILE_IO_BUFFER_SIZE</span>
<a href="#l26.1062"></a><span id="l26.1062" class="difflineminus">-class nsMsgSaveAsListener : public nsIStreamListener</span>
<a href="#l26.1063"></a><span id="l26.1063" class="difflineminus">-{</span>
<a href="#l26.1064"></a><span id="l26.1064" class="difflineminus">-public:</span>
<a href="#l26.1065"></a><span id="l26.1065" class="difflineplus">+class nsMsgSaveAsListener : public nsIStreamListener {</span>
<a href="#l26.1066"></a><span id="l26.1066" class="difflineplus">+ public:</span>
<a href="#l26.1067"></a><span id="l26.1067">   NS_DECL_ISUPPORTS</span>
<a href="#l26.1068"></a><span id="l26.1068">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l26.1069"></a><span id="l26.1069">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l26.1070"></a><span id="l26.1070"> </span>
<a href="#l26.1071"></a><span id="l26.1071">   nsMsgSaveAsListener(nsIFile *aFile, bool addDummyEnvelope);</span>
<a href="#l26.1072"></a><span id="l26.1072">   nsresult SetupMsgWriteStream(nsIFile *aFile, bool addDummyEnvelope);</span>
<a href="#l26.1073"></a><span id="l26.1073" class="difflineminus">-protected:</span>
<a href="#l26.1074"></a><span id="l26.1074" class="difflineplus">+</span>
<a href="#l26.1075"></a><span id="l26.1075" class="difflineplus">+ protected:</span>
<a href="#l26.1076"></a><span id="l26.1076">   virtual ~nsMsgSaveAsListener();</span>
<a href="#l26.1077"></a><span id="l26.1077">   nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l26.1078"></a><span id="l26.1078">   nsCOMPtr&lt;nsIFile&gt; m_outputFile;</span>
<a href="#l26.1079"></a><span id="l26.1079">   bool m_addDummyEnvelope;</span>
<a href="#l26.1080"></a><span id="l26.1080">   bool m_writtenData;</span>
<a href="#l26.1081"></a><span id="l26.1081">   uint32_t m_leftOver;</span>
<a href="#l26.1082"></a><span id="l26.1082" class="difflineminus">-  char m_dataBuffer[SAVE_BUF_SIZE+1]; // temporary buffer for this save operation</span>
<a href="#l26.1083"></a><span id="l26.1083" class="difflineminus">-</span>
<a href="#l26.1084"></a><span id="l26.1084" class="difflineplus">+  char m_dataBuffer[SAVE_BUF_SIZE +</span>
<a href="#l26.1085"></a><span id="l26.1085" class="difflineplus">+                    1];  // temporary buffer for this save operation</span>
<a href="#l26.1086"></a><span id="l26.1086"> };</span>
<a href="#l26.1087"></a><span id="l26.1087"> </span>
<a href="#l26.1088"></a><span id="l26.1088" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgSaveAsListener,</span>
<a href="#l26.1089"></a><span id="l26.1089" class="difflineminus">-                   nsIStreamListener,</span>
<a href="#l26.1090"></a><span id="l26.1090" class="difflineminus">-                   nsIRequestObserver)</span>
<a href="#l26.1091"></a><span id="l26.1091" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgSaveAsListener, nsIStreamListener, nsIRequestObserver)</span>
<a href="#l26.1092"></a><span id="l26.1092"> </span>
<a href="#l26.1093"></a><span id="l26.1093" class="difflineminus">-nsMsgSaveAsListener::nsMsgSaveAsListener(nsIFile *aFile, bool addDummyEnvelope)</span>
<a href="#l26.1094"></a><span id="l26.1094" class="difflineminus">-{</span>
<a href="#l26.1095"></a><span id="l26.1095" class="difflineplus">+nsMsgSaveAsListener::nsMsgSaveAsListener(nsIFile *aFile,</span>
<a href="#l26.1096"></a><span id="l26.1096" class="difflineplus">+                                         bool addDummyEnvelope) {</span>
<a href="#l26.1097"></a><span id="l26.1097">   m_outputFile = aFile;</span>
<a href="#l26.1098"></a><span id="l26.1098">   m_writtenData = false;</span>
<a href="#l26.1099"></a><span id="l26.1099">   m_addDummyEnvelope = addDummyEnvelope;</span>
<a href="#l26.1100"></a><span id="l26.1100">   m_leftOver = 0;</span>
<a href="#l26.1101"></a><span id="l26.1101"> }</span>
<a href="#l26.1102"></a><span id="l26.1102"> </span>
<a href="#l26.1103"></a><span id="l26.1103" class="difflineminus">-nsMsgSaveAsListener::~nsMsgSaveAsListener()</span>
<a href="#l26.1104"></a><span id="l26.1104" class="difflineminus">-{</span>
<a href="#l26.1105"></a><span id="l26.1105" class="difflineminus">-}</span>
<a href="#l26.1106"></a><span id="l26.1106" class="difflineplus">+nsMsgSaveAsListener::~nsMsgSaveAsListener() {}</span>
<a href="#l26.1107"></a><span id="l26.1107"> </span>
<a href="#l26.1108"></a><span id="l26.1108" class="difflineminus">-NS_IMETHODIMP nsMsgSaveAsListener::OnStartRequest(nsIRequest *request)</span>
<a href="#l26.1109"></a><span id="l26.1109" class="difflineminus">-{</span>
<a href="#l26.1110"></a><span id="l26.1110" class="difflineplus">+NS_IMETHODIMP nsMsgSaveAsListener::OnStartRequest(nsIRequest *request) {</span>
<a href="#l26.1111"></a><span id="l26.1111">   return NS_OK;</span>
<a href="#l26.1112"></a><span id="l26.1112"> }</span>
<a href="#l26.1113"></a><span id="l26.1113"> </span>
<a href="#l26.1114"></a><span id="l26.1114"> NS_IMETHODIMP</span>
<a href="#l26.1115"></a><span id="l26.1115" class="difflineminus">-nsMsgSaveAsListener::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l26.1116"></a><span id="l26.1116" class="difflineminus">-{</span>
<a href="#l26.1117"></a><span id="l26.1117" class="difflineminus">-  if (m_outputStream)</span>
<a href="#l26.1118"></a><span id="l26.1118" class="difflineminus">-  {</span>
<a href="#l26.1119"></a><span id="l26.1119" class="difflineplus">+nsMsgSaveAsListener::OnStopRequest(nsIRequest *request, nsresult aStatus) {</span>
<a href="#l26.1120"></a><span id="l26.1120" class="difflineplus">+  if (m_outputStream) {</span>
<a href="#l26.1121"></a><span id="l26.1121">     m_outputStream-&gt;Flush();</span>
<a href="#l26.1122"></a><span id="l26.1122">     m_outputStream-&gt;Close();</span>
<a href="#l26.1123"></a><span id="l26.1123">   }</span>
<a href="#l26.1124"></a><span id="l26.1124">   return NS_OK;</span>
<a href="#l26.1125"></a><span id="l26.1125"> }</span>
<a href="#l26.1126"></a><span id="l26.1126"> </span>
<a href="#l26.1127"></a><span id="l26.1127" class="difflineminus">-NS_IMETHODIMP nsMsgSaveAsListener::OnDataAvailable(nsIRequest* request,</span>
<a href="#l26.1128"></a><span id="l26.1128" class="difflineminus">-                                  nsIInputStream* inStream,</span>
<a href="#l26.1129"></a><span id="l26.1129" class="difflineminus">-                                  uint64_t srcOffset,</span>
<a href="#l26.1130"></a><span id="l26.1130" class="difflineminus">-                                  uint32_t count)</span>
<a href="#l26.1131"></a><span id="l26.1131" class="difflineminus">-{</span>
<a href="#l26.1132"></a><span id="l26.1132" class="difflineplus">+NS_IMETHODIMP nsMsgSaveAsListener::OnDataAvailable(nsIRequest *request,</span>
<a href="#l26.1133"></a><span id="l26.1133" class="difflineplus">+                                                   nsIInputStream *inStream,</span>
<a href="#l26.1134"></a><span id="l26.1134" class="difflineplus">+                                                   uint64_t srcOffset,</span>
<a href="#l26.1135"></a><span id="l26.1135" class="difflineplus">+                                                   uint32_t count) {</span>
<a href="#l26.1136"></a><span id="l26.1136">   nsresult rv;</span>
<a href="#l26.1137"></a><span id="l26.1137">   uint64_t available;</span>
<a href="#l26.1138"></a><span id="l26.1138">   rv = inStream-&gt;Available(&amp;available);</span>
<a href="#l26.1139"></a><span id="l26.1139" class="difflineminus">-  if (!m_writtenData)</span>
<a href="#l26.1140"></a><span id="l26.1140" class="difflineminus">-  {</span>
<a href="#l26.1141"></a><span id="l26.1141" class="difflineplus">+  if (!m_writtenData) {</span>
<a href="#l26.1142"></a><span id="l26.1142">     m_writtenData = true;</span>
<a href="#l26.1143"></a><span id="l26.1143">     rv = SetupMsgWriteStream(m_outputFile, m_addDummyEnvelope);</span>
<a href="#l26.1144"></a><span id="l26.1144">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.1145"></a><span id="l26.1145">   }</span>
<a href="#l26.1146"></a><span id="l26.1146"> </span>
<a href="#l26.1147"></a><span id="l26.1147">   bool useCanonicalEnding = false;</span>
<a href="#l26.1148"></a><span id="l26.1148">   // We know the request is an nsIChannel we can get a URI from, but this is</span>
<a href="#l26.1149"></a><span id="l26.1149">   // probably bad form. See Bug 1528662.</span>
<a href="#l26.1150"></a><span id="l26.1150">   nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l26.1151"></a><span id="l26.1151" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l26.1152"></a><span id="l26.1152" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l26.1153"></a><span id="l26.1153" class="difflineplus">+                       &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l26.1154"></a><span id="l26.1154">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.1155"></a><span id="l26.1155">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l26.1156"></a><span id="l26.1156">   rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l26.1157"></a><span id="l26.1157">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.1158"></a><span id="l26.1158">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(uri);</span>
<a href="#l26.1159"></a><span id="l26.1159" class="difflineminus">-  if (msgUrl)</span>
<a href="#l26.1160"></a><span id="l26.1160" class="difflineminus">-    msgUrl-&gt;GetCanonicalLineEnding(&amp;useCanonicalEnding);</span>
<a href="#l26.1161"></a><span id="l26.1161" class="difflineplus">+  if (msgUrl) msgUrl-&gt;GetCanonicalLineEnding(&amp;useCanonicalEnding);</span>
<a href="#l26.1162"></a><span id="l26.1162"> </span>
<a href="#l26.1163"></a><span id="l26.1163">   const char *lineEnding = (useCanonicalEnding) ? CRLF : MSG_LINEBREAK;</span>
<a href="#l26.1164"></a><span id="l26.1164">   uint32_t lineEndingLength = (useCanonicalEnding) ? 2 : MSG_LINEBREAK_LEN;</span>
<a href="#l26.1165"></a><span id="l26.1165"> </span>
<a href="#l26.1166"></a><span id="l26.1166">   uint32_t readCount, maxReadCount = SAVE_BUF_SIZE - m_leftOver;</span>
<a href="#l26.1167"></a><span id="l26.1167">   uint32_t writeCount;</span>
<a href="#l26.1168"></a><span id="l26.1168">   char *start, *end, lastCharInPrevBuf = '\0';</span>
<a href="#l26.1169"></a><span id="l26.1169">   uint32_t linebreak_len = 0;</span>
<a href="#l26.1170"></a><span id="l26.1170"> </span>
<a href="#l26.1171"></a><span id="l26.1171" class="difflineminus">-  while (count &gt; 0)</span>
<a href="#l26.1172"></a><span id="l26.1172" class="difflineminus">-  {</span>
<a href="#l26.1173"></a><span id="l26.1173" class="difflineminus">-      if (count &lt; maxReadCount)</span>
<a href="#l26.1174"></a><span id="l26.1174" class="difflineminus">-          maxReadCount = count;</span>
<a href="#l26.1175"></a><span id="l26.1175" class="difflineminus">-      rv = inStream-&gt;Read(m_dataBuffer + m_leftOver,</span>
<a href="#l26.1176"></a><span id="l26.1176" class="difflineminus">-                          maxReadCount,</span>
<a href="#l26.1177"></a><span id="l26.1177" class="difflineminus">-                          &amp;readCount);</span>
<a href="#l26.1178"></a><span id="l26.1178" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1179"></a><span id="l26.1179" class="difflineplus">+  while (count &gt; 0) {</span>
<a href="#l26.1180"></a><span id="l26.1180" class="difflineplus">+    if (count &lt; maxReadCount) maxReadCount = count;</span>
<a href="#l26.1181"></a><span id="l26.1181" class="difflineplus">+    rv = inStream-&gt;Read(m_dataBuffer + m_leftOver, maxReadCount, &amp;readCount);</span>
<a href="#l26.1182"></a><span id="l26.1182" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1183"></a><span id="l26.1183"> </span>
<a href="#l26.1184"></a><span id="l26.1184" class="difflineminus">-      m_leftOver += readCount;</span>
<a href="#l26.1185"></a><span id="l26.1185" class="difflineminus">-      m_dataBuffer[m_leftOver] = '\0';</span>
<a href="#l26.1186"></a><span id="l26.1186" class="difflineplus">+    m_leftOver += readCount;</span>
<a href="#l26.1187"></a><span id="l26.1187" class="difflineplus">+    m_dataBuffer[m_leftOver] = '\0';</span>
<a href="#l26.1188"></a><span id="l26.1188"> </span>
<a href="#l26.1189"></a><span id="l26.1189" class="difflineminus">-      start = m_dataBuffer;</span>
<a href="#l26.1190"></a><span id="l26.1190" class="difflineminus">-      // make sure we don't insert another LF, accidentally, by ignoring</span>
<a href="#l26.1191"></a><span id="l26.1191" class="difflineminus">-      // second half of CRLF spanning blocks.</span>
<a href="#l26.1192"></a><span id="l26.1192" class="difflineminus">-      if (lastCharInPrevBuf == '\r' &amp;&amp; *start == '\n')</span>
<a href="#l26.1193"></a><span id="l26.1193" class="difflineminus">-        start++;</span>
<a href="#l26.1194"></a><span id="l26.1194" class="difflineplus">+    start = m_dataBuffer;</span>
<a href="#l26.1195"></a><span id="l26.1195" class="difflineplus">+    // make sure we don't insert another LF, accidentally, by ignoring</span>
<a href="#l26.1196"></a><span id="l26.1196" class="difflineplus">+    // second half of CRLF spanning blocks.</span>
<a href="#l26.1197"></a><span id="l26.1197" class="difflineplus">+    if (lastCharInPrevBuf == '\r' &amp;&amp; *start == '\n') start++;</span>
<a href="#l26.1198"></a><span id="l26.1198"> </span>
<a href="#l26.1199"></a><span id="l26.1199" class="difflineminus">-      end = PL_strpbrk(start, &quot;\r\n&quot;);</span>
<a href="#l26.1200"></a><span id="l26.1200" class="difflineminus">-      if (end)</span>
<a href="#l26.1201"></a><span id="l26.1201" class="difflineminus">-        linebreak_len = (end[0] == '\r' &amp;&amp; end[1] == '\n') ? 2 : 1;</span>
<a href="#l26.1202"></a><span id="l26.1202" class="difflineplus">+    end = PL_strpbrk(start, &quot;\r\n&quot;);</span>
<a href="#l26.1203"></a><span id="l26.1203" class="difflineplus">+    if (end) linebreak_len = (end[0] == '\r' &amp;&amp; end[1] == '\n') ? 2 : 1;</span>
<a href="#l26.1204"></a><span id="l26.1204"> </span>
<a href="#l26.1205"></a><span id="l26.1205" class="difflineminus">-      count -= readCount;</span>
<a href="#l26.1206"></a><span id="l26.1206" class="difflineminus">-      maxReadCount = SAVE_BUF_SIZE - m_leftOver;</span>
<a href="#l26.1207"></a><span id="l26.1207" class="difflineplus">+    count -= readCount;</span>
<a href="#l26.1208"></a><span id="l26.1208" class="difflineplus">+    maxReadCount = SAVE_BUF_SIZE - m_leftOver;</span>
<a href="#l26.1209"></a><span id="l26.1209"> </span>
<a href="#l26.1210"></a><span id="l26.1210" class="difflineminus">-      if (!end &amp;&amp; count &gt; maxReadCount)</span>
<a href="#l26.1211"></a><span id="l26.1211" class="difflineminus">-          // must be a very very long line; sorry cannot handle it</span>
<a href="#l26.1212"></a><span id="l26.1212" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l26.1213"></a><span id="l26.1213" class="difflineplus">+    if (!end &amp;&amp; count &gt; maxReadCount)</span>
<a href="#l26.1214"></a><span id="l26.1214" class="difflineplus">+      // must be a very very long line; sorry cannot handle it</span>
<a href="#l26.1215"></a><span id="l26.1215" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l26.1216"></a><span id="l26.1216"> </span>
<a href="#l26.1217"></a><span id="l26.1217" class="difflineminus">-      while (start &amp;&amp; end)</span>
<a href="#l26.1218"></a><span id="l26.1218" class="difflineminus">-      {</span>
<a href="#l26.1219"></a><span id="l26.1219" class="difflineminus">-          if (m_outputStream &amp;&amp;</span>
<a href="#l26.1220"></a><span id="l26.1220" class="difflineminus">-              PL_strncasecmp(start, &quot;X-Mozilla-Status:&quot;, 17) &amp;&amp;</span>
<a href="#l26.1221"></a><span id="l26.1221" class="difflineminus">-              PL_strncasecmp(start, &quot;X-Mozilla-Status2:&quot;, 18) &amp;&amp;</span>
<a href="#l26.1222"></a><span id="l26.1222" class="difflineminus">-              PL_strncmp(start, &quot;From - &quot;, 7))</span>
<a href="#l26.1223"></a><span id="l26.1223" class="difflineminus">-          {</span>
<a href="#l26.1224"></a><span id="l26.1224" class="difflineminus">-              rv = m_outputStream-&gt;Write(start, end-start, &amp;writeCount);</span>
<a href="#l26.1225"></a><span id="l26.1225" class="difflineminus">-              nsresult tmp = m_outputStream-&gt;Write(lineEnding, lineEndingLength, &amp;writeCount);</span>
<a href="#l26.1226"></a><span id="l26.1226" class="difflineminus">-              if (NS_FAILED(tmp)) {</span>
<a href="#l26.1227"></a><span id="l26.1227" class="difflineminus">-                rv = tmp;</span>
<a href="#l26.1228"></a><span id="l26.1228" class="difflineminus">-              }</span>
<a href="#l26.1229"></a><span id="l26.1229" class="difflineminus">-          }</span>
<a href="#l26.1230"></a><span id="l26.1230" class="difflineminus">-          start = end+linebreak_len;</span>
<a href="#l26.1231"></a><span id="l26.1231" class="difflineminus">-          if (start &gt;= m_dataBuffer + m_leftOver)</span>
<a href="#l26.1232"></a><span id="l26.1232" class="difflineminus">-          {</span>
<a href="#l26.1233"></a><span id="l26.1233" class="difflineminus">-              maxReadCount = SAVE_BUF_SIZE;</span>
<a href="#l26.1234"></a><span id="l26.1234" class="difflineminus">-              m_leftOver = 0;</span>
<a href="#l26.1235"></a><span id="l26.1235" class="difflineminus">-              break;</span>
<a href="#l26.1236"></a><span id="l26.1236" class="difflineminus">-          }</span>
<a href="#l26.1237"></a><span id="l26.1237" class="difflineminus">-          end = PL_strpbrk(start, &quot;\r\n&quot;);</span>
<a href="#l26.1238"></a><span id="l26.1238" class="difflineminus">-          if (end)</span>
<a href="#l26.1239"></a><span id="l26.1239" class="difflineminus">-            linebreak_len = (end[0] == '\r' &amp;&amp; end[1] == '\n') ? 2 : 1;</span>
<a href="#l26.1240"></a><span id="l26.1240" class="difflineminus">-          if (start &amp;&amp; !end)</span>
<a href="#l26.1241"></a><span id="l26.1241" class="difflineminus">-          {</span>
<a href="#l26.1242"></a><span id="l26.1242" class="difflineminus">-              m_leftOver -= (start - m_dataBuffer);</span>
<a href="#l26.1243"></a><span id="l26.1243" class="difflineminus">-              memcpy(m_dataBuffer, start,</span>
<a href="#l26.1244"></a><span id="l26.1244" class="difflineminus">-                            m_leftOver+1); // including null</span>
<a href="#l26.1245"></a><span id="l26.1245" class="difflineminus">-              maxReadCount = SAVE_BUF_SIZE - m_leftOver;</span>
<a href="#l26.1246"></a><span id="l26.1246" class="difflineminus">-          }</span>
<a href="#l26.1247"></a><span id="l26.1247" class="difflineplus">+    while (start &amp;&amp; end) {</span>
<a href="#l26.1248"></a><span id="l26.1248" class="difflineplus">+      if (m_outputStream &amp;&amp; PL_strncasecmp(start, &quot;X-Mozilla-Status:&quot;, 17) &amp;&amp;</span>
<a href="#l26.1249"></a><span id="l26.1249" class="difflineplus">+          PL_strncasecmp(start, &quot;X-Mozilla-Status2:&quot;, 18) &amp;&amp;</span>
<a href="#l26.1250"></a><span id="l26.1250" class="difflineplus">+          PL_strncmp(start, &quot;From - &quot;, 7)) {</span>
<a href="#l26.1251"></a><span id="l26.1251" class="difflineplus">+        rv = m_outputStream-&gt;Write(start, end - start, &amp;writeCount);</span>
<a href="#l26.1252"></a><span id="l26.1252" class="difflineplus">+        nsresult tmp =</span>
<a href="#l26.1253"></a><span id="l26.1253" class="difflineplus">+            m_outputStream-&gt;Write(lineEnding, lineEndingLength, &amp;writeCount);</span>
<a href="#l26.1254"></a><span id="l26.1254" class="difflineplus">+        if (NS_FAILED(tmp)) {</span>
<a href="#l26.1255"></a><span id="l26.1255" class="difflineplus">+          rv = tmp;</span>
<a href="#l26.1256"></a><span id="l26.1256" class="difflineplus">+        }</span>
<a href="#l26.1257"></a><span id="l26.1257">       }</span>
<a href="#l26.1258"></a><span id="l26.1258" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1259"></a><span id="l26.1259" class="difflineminus">-      if (end)</span>
<a href="#l26.1260"></a><span id="l26.1260" class="difflineminus">-          lastCharInPrevBuf = *end;</span>
<a href="#l26.1261"></a><span id="l26.1261" class="difflineplus">+      start = end + linebreak_len;</span>
<a href="#l26.1262"></a><span id="l26.1262" class="difflineplus">+      if (start &gt;= m_dataBuffer + m_leftOver) {</span>
<a href="#l26.1263"></a><span id="l26.1263" class="difflineplus">+        maxReadCount = SAVE_BUF_SIZE;</span>
<a href="#l26.1264"></a><span id="l26.1264" class="difflineplus">+        m_leftOver = 0;</span>
<a href="#l26.1265"></a><span id="l26.1265" class="difflineplus">+        break;</span>
<a href="#l26.1266"></a><span id="l26.1266" class="difflineplus">+      }</span>
<a href="#l26.1267"></a><span id="l26.1267" class="difflineplus">+      end = PL_strpbrk(start, &quot;\r\n&quot;);</span>
<a href="#l26.1268"></a><span id="l26.1268" class="difflineplus">+      if (end) linebreak_len = (end[0] == '\r' &amp;&amp; end[1] == '\n') ? 2 : 1;</span>
<a href="#l26.1269"></a><span id="l26.1269" class="difflineplus">+      if (start &amp;&amp; !end) {</span>
<a href="#l26.1270"></a><span id="l26.1270" class="difflineplus">+        m_leftOver -= (start - m_dataBuffer);</span>
<a href="#l26.1271"></a><span id="l26.1271" class="difflineplus">+        memcpy(m_dataBuffer, start,</span>
<a href="#l26.1272"></a><span id="l26.1272" class="difflineplus">+               m_leftOver + 1);  // including null</span>
<a href="#l26.1273"></a><span id="l26.1273" class="difflineplus">+        maxReadCount = SAVE_BUF_SIZE - m_leftOver;</span>
<a href="#l26.1274"></a><span id="l26.1274" class="difflineplus">+      }</span>
<a href="#l26.1275"></a><span id="l26.1275" class="difflineplus">+    }</span>
<a href="#l26.1276"></a><span id="l26.1276" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1277"></a><span id="l26.1277" class="difflineplus">+    if (end) lastCharInPrevBuf = *end;</span>
<a href="#l26.1278"></a><span id="l26.1278">   }</span>
<a href="#l26.1279"></a><span id="l26.1279">   return rv;</span>
<a href="#l26.1280"></a><span id="l26.1280"> </span>
<a href="#l26.1281"></a><span id="l26.1281" class="difflineminus">-  //  rv = m_outputStream-&gt;WriteFrom(inStream, std::min(available, count), &amp;bytesWritten);</span>
<a href="#l26.1282"></a><span id="l26.1282" class="difflineplus">+  //  rv = m_outputStream-&gt;WriteFrom(inStream, std::min(available, count),</span>
<a href="#l26.1283"></a><span id="l26.1283" class="difflineplus">+  //  &amp;bytesWritten);</span>
<a href="#l26.1284"></a><span id="l26.1284"> }</span>
<a href="#l26.1285"></a><span id="l26.1285"> </span>
<a href="#l26.1286"></a><span id="l26.1286" class="difflineminus">-nsresult nsMsgSaveAsListener::SetupMsgWriteStream(nsIFile *aFile, bool addDummyEnvelope)</span>
<a href="#l26.1287"></a><span id="l26.1287" class="difflineminus">-{</span>
<a href="#l26.1288"></a><span id="l26.1288" class="difflineplus">+nsresult nsMsgSaveAsListener::SetupMsgWriteStream(nsIFile *aFile,</span>
<a href="#l26.1289"></a><span id="l26.1289" class="difflineplus">+                                                  bool addDummyEnvelope) {</span>
<a href="#l26.1290"></a><span id="l26.1290">   // If the file already exists, delete it, but do this before</span>
<a href="#l26.1291"></a><span id="l26.1291">   // getting the outputstream.</span>
<a href="#l26.1292"></a><span id="l26.1292">   // Due to bug 328027, the nsSaveMsgListener created in</span>
<a href="#l26.1293"></a><span id="l26.1293">   // nsMessenger::SaveAs now opens the stream on the nsIFile</span>
<a href="#l26.1294"></a><span id="l26.1294">   // object, thus creating an empty file. Actual save operations for</span>
<a href="#l26.1295"></a><span id="l26.1295">   // IMAP and NNTP use this nsMsgSaveAsListener here, though, so we</span>
<a href="#l26.1296"></a><span id="l26.1296">   // have to close the stream before deleting the file, else data</span>
<a href="#l26.1297"></a><span id="l26.1297">   // would still be written happily into a now non-existing file.</span>
<a href="#l26.1298"></a><span id="l26.1298">   // (Windows doesn't care, btw, just unixoids do...)</span>
<a href="#l26.1299"></a><span id="l26.1299">   aFile-&gt;Remove(false);</span>
<a href="#l26.1300"></a><span id="l26.1300"> </span>
<a href="#l26.1301"></a><span id="l26.1301">   nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l26.1302"></a><span id="l26.1302">                                                aFile, -1, 0666);</span>
<a href="#l26.1303"></a><span id="l26.1303">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.1304"></a><span id="l26.1304"> </span>
<a href="#l26.1305"></a><span id="l26.1305" class="difflineminus">-  if (m_outputStream &amp;&amp; addDummyEnvelope)</span>
<a href="#l26.1306"></a><span id="l26.1306" class="difflineminus">-  {</span>
<a href="#l26.1307"></a><span id="l26.1307" class="difflineplus">+  if (m_outputStream &amp;&amp; addDummyEnvelope) {</span>
<a href="#l26.1308"></a><span id="l26.1308">     nsAutoCString result;</span>
<a href="#l26.1309"></a><span id="l26.1309">     uint32_t writeCount;</span>
<a href="#l26.1310"></a><span id="l26.1310"> </span>
<a href="#l26.1311"></a><span id="l26.1311" class="difflineminus">-    time_t now = time((time_t*) 0);</span>
<a href="#l26.1312"></a><span id="l26.1312" class="difflineplus">+    time_t now = time((time_t *)0);</span>
<a href="#l26.1313"></a><span id="l26.1313">     char *ct = ctime(&amp;now);</span>
<a href="#l26.1314"></a><span id="l26.1314">     // Remove the ending new-line character.</span>
<a href="#l26.1315"></a><span id="l26.1315">     ct[24] = '\0';</span>
<a href="#l26.1316"></a><span id="l26.1316">     result = &quot;From - &quot;;</span>
<a href="#l26.1317"></a><span id="l26.1317">     result += ct;</span>
<a href="#l26.1318"></a><span id="l26.1318">     result += MSG_LINEBREAK;</span>
<a href="#l26.1319"></a><span id="l26.1319">     m_outputStream-&gt;Write(result.get(), result.Length(), &amp;writeCount);</span>
<a href="#l26.1320"></a><span id="l26.1320"> </span>
<a href="#l26.1321"></a><span id="l26.1321" class="difflineat">@@ -1089,63 +979,58 @@ nsresult nsMsgSaveAsListener::SetupMsgWr</span>
<a href="#l26.1322"></a><span id="l26.1322">     result += &quot;X-Mozilla-Status2: 00000000&quot;;</span>
<a href="#l26.1323"></a><span id="l26.1323">     result += MSG_LINEBREAK;</span>
<a href="#l26.1324"></a><span id="l26.1324">     m_outputStream-&gt;Write(result.get(), result.Length(), &amp;writeCount);</span>
<a href="#l26.1325"></a><span id="l26.1325">   }</span>
<a href="#l26.1326"></a><span id="l26.1326"> </span>
<a href="#l26.1327"></a><span id="l26.1327">   return rv;</span>
<a href="#l26.1328"></a><span id="l26.1328"> }</span>
<a href="#l26.1329"></a><span id="l26.1329"> </span>
<a href="#l26.1330"></a><span id="l26.1330" class="difflineminus">-</span>
<a href="#l26.1331"></a><span id="l26.1331" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetSaveAsListener(bool addDummyEnvelope,</span>
<a href="#l26.1332"></a><span id="l26.1332" class="difflineminus">-                                                  nsIFile *aFile, nsIStreamListener **aSaveListener)</span>
<a href="#l26.1333"></a><span id="l26.1333" class="difflineminus">-{</span>
<a href="#l26.1334"></a><span id="l26.1334" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetSaveAsListener(</span>
<a href="#l26.1335"></a><span id="l26.1335" class="difflineplus">+    bool addDummyEnvelope, nsIFile *aFile, nsIStreamListener **aSaveListener) {</span>
<a href="#l26.1336"></a><span id="l26.1336">   NS_ENSURE_ARG_POINTER(aSaveListener);</span>
<a href="#l26.1337"></a><span id="l26.1337" class="difflineminus">-  nsMsgSaveAsListener *saveAsListener = new nsMsgSaveAsListener(aFile, addDummyEnvelope);</span>
<a href="#l26.1338"></a><span id="l26.1338" class="difflineminus">-  return saveAsListener-&gt;QueryInterface(NS_GET_IID(nsIStreamListener), (void **) aSaveListener);</span>
<a href="#l26.1339"></a><span id="l26.1339" class="difflineplus">+  nsMsgSaveAsListener *saveAsListener =</span>
<a href="#l26.1340"></a><span id="l26.1340" class="difflineplus">+      new nsMsgSaveAsListener(aFile, addDummyEnvelope);</span>
<a href="#l26.1341"></a><span id="l26.1341" class="difflineplus">+  return saveAsListener-&gt;QueryInterface(NS_GET_IID(nsIStreamListener),</span>
<a href="#l26.1342"></a><span id="l26.1342" class="difflineplus">+                                        (void **)aSaveListener);</span>
<a href="#l26.1343"></a><span id="l26.1343"> }</span>
<a href="#l26.1344"></a><span id="l26.1344"> </span>
<a href="#l26.1345"></a><span id="l26.1345" class="difflineminus">-</span>
<a href="#l26.1346"></a><span id="l26.1346" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetFolder(nsIMsgFolder * /* aFolder */)</span>
<a href="#l26.1347"></a><span id="l26.1347" class="difflineminus">-{</span>
<a href="#l26.1348"></a><span id="l26.1348" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetFolder(nsIMsgFolder * /* aFolder */) {</span>
<a href="#l26.1349"></a><span id="l26.1349">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l26.1350"></a><span id="l26.1350"> }</span>
<a href="#l26.1351"></a><span id="l26.1351"> </span>
<a href="#l26.1352"></a><span id="l26.1352" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetFolder(nsIMsgFolder ** /* aFolder */)</span>
<a href="#l26.1353"></a><span id="l26.1353" class="difflineminus">-{</span>
<a href="#l26.1354"></a><span id="l26.1354" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetFolder(nsIMsgFolder ** /* aFolder */) {</span>
<a href="#l26.1355"></a><span id="l26.1355">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l26.1356"></a><span id="l26.1356"> }</span>
<a href="#l26.1357"></a><span id="l26.1357"> </span>
<a href="#l26.1358"></a><span id="l26.1358" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgHeaderSink(nsIMsgHeaderSink * *aMsgHdrSink)</span>
<a href="#l26.1359"></a><span id="l26.1359" class="difflineminus">-{</span>
<a href="#l26.1360"></a><span id="l26.1360" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMsgHdrSink);</span>
<a href="#l26.1361"></a><span id="l26.1361" class="difflineminus">-    NS_IF_ADDREF(*aMsgHdrSink = mMsgHeaderSink);</span>
<a href="#l26.1362"></a><span id="l26.1362" class="difflineminus">-    return NS_OK;</span>
<a href="#l26.1363"></a><span id="l26.1363" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMsgHeaderSink(</span>
<a href="#l26.1364"></a><span id="l26.1364" class="difflineplus">+    nsIMsgHeaderSink **aMsgHdrSink) {</span>
<a href="#l26.1365"></a><span id="l26.1365" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgHdrSink);</span>
<a href="#l26.1366"></a><span id="l26.1366" class="difflineplus">+  NS_IF_ADDREF(*aMsgHdrSink = mMsgHeaderSink);</span>
<a href="#l26.1367"></a><span id="l26.1367" class="difflineplus">+  return NS_OK;</span>
<a href="#l26.1368"></a><span id="l26.1368"> }</span>
<a href="#l26.1369"></a><span id="l26.1369"> </span>
<a href="#l26.1370"></a><span id="l26.1370" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgHeaderSink(nsIMsgHeaderSink * aMsgHdrSink)</span>
<a href="#l26.1371"></a><span id="l26.1371" class="difflineminus">-{</span>
<a href="#l26.1372"></a><span id="l26.1372" class="difflineminus">-    mMsgHeaderSink = aMsgHdrSink;</span>
<a href="#l26.1373"></a><span id="l26.1373" class="difflineminus">-    return NS_OK;</span>
<a href="#l26.1374"></a><span id="l26.1374" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMsgHeaderSink(</span>
<a href="#l26.1375"></a><span id="l26.1375" class="difflineplus">+    nsIMsgHeaderSink *aMsgHdrSink) {</span>
<a href="#l26.1376"></a><span id="l26.1376" class="difflineplus">+  mMsgHeaderSink = aMsgHdrSink;</span>
<a href="#l26.1377"></a><span id="l26.1377" class="difflineplus">+  return NS_OK;</span>
<a href="#l26.1378"></a><span id="l26.1378"> }</span>
<a href="#l26.1379"></a><span id="l26.1379"> </span>
<a href="#l26.1380"></a><span id="l26.1380" class="difflineminus">-NS_IMETHODIMP nsMsgMailNewsUrl::GetIsMessageUri(bool *aIsMessageUri)</span>
<a href="#l26.1381"></a><span id="l26.1381" class="difflineminus">-{</span>
<a href="#l26.1382"></a><span id="l26.1382" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetIsMessageUri(bool *aIsMessageUri) {</span>
<a href="#l26.1383"></a><span id="l26.1383">   NS_ENSURE_ARG(aIsMessageUri);</span>
<a href="#l26.1384"></a><span id="l26.1384">   nsAutoCString scheme;</span>
<a href="#l26.1385"></a><span id="l26.1385">   m_baseURL-&gt;GetScheme(scheme);</span>
<a href="#l26.1386"></a><span id="l26.1386">   *aIsMessageUri = StringEndsWith(scheme, NS_LITERAL_CSTRING(&quot;-message&quot;));</span>
<a href="#l26.1387"></a><span id="l26.1387">   return NS_OK;</span>
<a href="#l26.1388"></a><span id="l26.1388"> }</span>
<a href="#l26.1389"></a><span id="l26.1389"> </span>
<a href="#l26.1390"></a><span id="l26.1390"> NS_IMPL_ISUPPORTS(nsMsgMailNewsUrl::Mutator, nsIURISetters, nsIURIMutator)</span>
<a href="#l26.1391"></a><span id="l26.1391"> </span>
<a href="#l26.1392"></a><span id="l26.1392"> NS_IMETHODIMP</span>
<a href="#l26.1393"></a><span id="l26.1393" class="difflineminus">-nsMsgMailNewsUrl::Mutate(nsIURIMutator** aMutator)</span>
<a href="#l26.1394"></a><span id="l26.1394" class="difflineminus">-{</span>
<a href="#l26.1395"></a><span id="l26.1395" class="difflineplus">+nsMsgMailNewsUrl::Mutate(nsIURIMutator **aMutator) {</span>
<a href="#l26.1396"></a><span id="l26.1396">   RefPtr&lt;nsMsgMailNewsUrl::Mutator&gt; mutator = new nsMsgMailNewsUrl::Mutator();</span>
<a href="#l26.1397"></a><span id="l26.1397">   nsresult rv = mutator-&gt;InitFromURI(this);</span>
<a href="#l26.1398"></a><span id="l26.1398">   if (NS_FAILED(rv)) {</span>
<a href="#l26.1399"></a><span id="l26.1399">     return rv;</span>
<a href="#l26.1400"></a><span id="l26.1400">   }</span>
<a href="#l26.1401"></a><span id="l26.1401">   mutator.forget(aMutator);</span>
<a href="#l26.1402"></a><span id="l26.1402">   return NS_OK;</span>
<a href="#l26.1403"></a><span id="l26.1403"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -35,80 +35,77 @@</span>
<a href="#l27.4"></a><span id="l27.4"> // So I decided to group them all in this implementation so we don't have to</span>
<a href="#l27.5"></a><span id="l27.5"> // duplicate the code.</span>
<a href="#l27.6"></a><span id="l27.6"> //</span>
<a href="#l27.7"></a><span id="l27.7"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> class NS_MSG_BASE nsMsgMailNewsUrl : public nsIMsgMailNewsUrl,</span>
<a href="#l27.10"></a><span id="l27.10">                                      public nsIURIWithSpecialOrigin,</span>
<a href="#l27.11"></a><span id="l27.11">                                      public nsISerializable,</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-                                     public nsIClassInfo</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-{</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-public:</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-    nsMsgMailNewsUrl();</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+                                     public nsIClassInfo {</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+ public:</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+  nsMsgMailNewsUrl();</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-    NS_DECL_NSIMSGMAILNEWSURL</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-    NS_DECL_NSIURI</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-    NS_DECL_NSIURL</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-    NS_DECL_NSIURIWITHSPECIALORIGIN</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-    NS_DECL_NSISERIALIZABLE</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-    NS_DECL_NSICLASSINFO</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+  NS_DECL_NSIMSGMAILNEWSURL</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+  NS_DECL_NSIURI</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+  NS_DECL_NSIURL</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+  NS_DECL_NSIURIWITHSPECIALORIGIN</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+  NS_DECL_NSISERIALIZABLE</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+  NS_DECL_NSICLASSINFO</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-protected:</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+ protected:</span>
<a href="#l27.37"></a><span id="l27.37">   virtual nsresult Clone(nsIURI **_retval);</span>
<a href="#l27.38"></a><span id="l27.38">   virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l27.39"></a><span id="l27.39">   virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l27.40"></a><span id="l27.40">   virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l27.41"></a><span id="l27.41">   virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l27.42"></a><span id="l27.42">   virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l27.43"></a><span id="l27.43">   virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l27.44"></a><span id="l27.44">   virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l27.45"></a><span id="l27.45">   virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l27.46"></a><span id="l27.46">   virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l27.47"></a><span id="l27.47">   virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l27.48"></a><span id="l27.48">   virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  virtual nsresult CreateURL(const nsACString&amp; aSpec, nsIURL **aURL);  // nsMailboxUrl overrides this.</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery,</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+                                        const mozilla::Encoding *aEncoding);</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+  virtual nsresult CreateURL(const nsACString &amp;aSpec,</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+                             nsIURL **aURL);  // nsMailboxUrl overrides this.</span>
<a href="#l27.55"></a><span id="l27.55"> </span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-public:</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-  class Mutator</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-      : public nsIURIMutator</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-      , public BaseURIMutator&lt;nsMsgMailNewsUrl&gt;</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-  {</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+ public:</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+  class Mutator : public nsIURIMutator,</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+                  public BaseURIMutator&lt;nsMsgMailNewsUrl&gt; {</span>
<a href="#l27.64"></a><span id="l27.64">     NS_DECL_ISUPPORTS</span>
<a href="#l27.65"></a><span id="l27.65">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l27.66"></a><span id="l27.66"> </span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-    NS_IMETHOD Deserialize(const mozilla::ipc::URIParams&amp; aParams) override</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-    {</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+    NS_IMETHOD Deserialize(const mozilla::ipc::URIParams &amp;aParams) override {</span>
<a href="#l27.70"></a><span id="l27.70">       return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l27.71"></a><span id="l27.71">     }</span>
<a href="#l27.72"></a><span id="l27.72"> </span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-    NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-    {</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+    NS_IMETHOD Finalize(nsIURI **aURI) override {</span>
<a href="#l27.76"></a><span id="l27.76">       mURI.forget(aURI);</span>
<a href="#l27.77"></a><span id="l27.77">       return NS_OK;</span>
<a href="#l27.78"></a><span id="l27.78">     }</span>
<a href="#l27.79"></a><span id="l27.79"> </span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-    NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-    {</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-      if (aMutator)</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-        NS_ADDREF(*aMutator = this);</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+    NS_IMETHOD SetSpec(const nsACString &amp;aSpec,</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+                       nsIURIMutator **aMutator) override {</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+      if (aMutator) NS_ADDREF(*aMutator = this);</span>
<a href="#l27.87"></a><span id="l27.87">       return InitFromSpec(aSpec);</span>
<a href="#l27.88"></a><span id="l27.88">     }</span>
<a href="#l27.89"></a><span id="l27.89"> </span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-    explicit Mutator() { }</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-  private:</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-    virtual ~Mutator() { }</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+    explicit Mutator() {}</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+   private:</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineplus">+    virtual ~Mutator() {}</span>
<a href="#l27.97"></a><span id="l27.97"> </span>
<a href="#l27.98"></a><span id="l27.98">     friend class nsMsgMailNewsUrl;</span>
<a href="#l27.99"></a><span id="l27.99">   };</span>
<a href="#l27.100"></a><span id="l27.100">   friend BaseURIMutator&lt;nsMsgMailNewsUrl&gt;;</span>
<a href="#l27.101"></a><span id="l27.101"> </span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-protected:</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+ protected:</span>
<a href="#l27.104"></a><span id="l27.104">   virtual ~nsMsgMailNewsUrl();</span>
<a href="#l27.105"></a><span id="l27.105"> </span>
<a href="#l27.106"></a><span id="l27.106">   nsCOMPtr&lt;nsIURL&gt; m_baseURL;</span>
<a href="#l27.107"></a><span id="l27.107">   nsCOMPtr&lt;nsIURI&gt; m_normalizedOrigin;</span>
<a href="#l27.108"></a><span id="l27.108">   nsWeakPtr m_statusFeedbackWeak;</span>
<a href="#l27.109"></a><span id="l27.109">   nsWeakPtr m_msgWindowWeak;</span>
<a href="#l27.110"></a><span id="l27.110">   nsWeakPtr m_loadGroupWeak;</span>
<a href="#l27.111"></a><span id="l27.111">   nsCOMPtr&lt;nsIMimeHeaders&gt; mMimeHeaders;</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineat">@@ -119,19 +116,20 @@ protected:</span>
<a href="#l27.113"></a><span id="l27.113">   int64_t mMaxProgress;</span>
<a href="#l27.114"></a><span id="l27.114">   bool m_runningUrl;</span>
<a href="#l27.115"></a><span id="l27.115">   bool m_updatingFolder;</span>
<a href="#l27.116"></a><span id="l27.116">   bool m_msgIsInLocalCache;</span>
<a href="#l27.117"></a><span id="l27.117">   bool m_suppressErrorMsgs;</span>
<a href="#l27.118"></a><span id="l27.118">   bool m_hasNormalizedOrigin;</span>
<a href="#l27.119"></a><span id="l27.119"> </span>
<a href="#l27.120"></a><span id="l27.120">   // the following field is really a bit of a hack to make</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-  // open attachments work. The external applications code sometimes tries to figure out the right</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-  // handler to use by looking at the file extension of the url we are trying to load. Unfortunately,</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-  // the attachment file name really isn't part of the url string....so we'll store it here...and if</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-  // the url we are running is an attachment url, we'll set it here. Then when the helper apps code</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineminus">-  // asks us for it, we'll return the right value.</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+  // open attachments work. The external applications code sometimes tries to</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+  // figure out the right handler to use by looking at the file extension of the</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+  // url we are trying to load. Unfortunately, the attachment file name really</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+  // isn't part of the url string....so we'll store it here...and if the url we</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+  // are running is an attachment url, we'll set it here. Then when the helper</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+  // apps code asks us for it, we'll return the right value.</span>
<a href="#l27.132"></a><span id="l27.132">   nsCString mAttachmentFileName;</span>
<a href="#l27.133"></a><span id="l27.133"> </span>
<a href="#l27.134"></a><span id="l27.134">   nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt; &gt; mUrlListeners;</span>
<a href="#l27.135"></a><span id="l27.135"> };</span>
<a href="#l27.136"></a><span id="l27.136"> </span>
<a href="#l27.137"></a><span id="l27.137"> #endif /* nsMsgMailNewsUrl_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -38,1416 +38,1321 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsIInputStreamPump.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsICancelable.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;mozilla/SlicedInputStream.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsContentSecurityManager.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsPrintfCString.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#undef PostMessage // avoid to collision with WinUser.h</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+#undef PostMessage  // avoid to collision with WinUser.h</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15"> using namespace mozilla;</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17"> NS_IMPL_ISUPPORTS(nsMsgProtocol, nsIChannel, nsIStreamListener,</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-  nsIRequestObserver, nsIRequest, nsITransportEventSink)</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-static char16_t *FormatStringWithHostNameByName(const char16_t* stringName, nsIMsgMailNewsUrl *msgUri);</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+                  nsIRequestObserver, nsIRequest, nsITransportEventSink)</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+static char16_t *FormatStringWithHostNameByName(const char16_t *stringName,</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+                                                nsIMsgMailNewsUrl *msgUri);</span>
<a href="#l28.25"></a><span id="l28.25"> </span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-nsMsgProtocol::nsMsgProtocol(nsIURI * aURL)</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-{</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+nsMsgProtocol::nsMsgProtocol(nsIURI *aURL) {</span>
<a href="#l28.29"></a><span id="l28.29">   m_flags = 0;</span>
<a href="#l28.30"></a><span id="l28.30">   m_readCount = 0;</span>
<a href="#l28.31"></a><span id="l28.31">   mLoadFlags = 0;</span>
<a href="#l28.32"></a><span id="l28.32">   m_socketIsOpen = false;</span>
<a href="#l28.33"></a><span id="l28.33">   mContentLength = -1;</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35">   GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;tempMessage.eml&quot;,</span>
<a href="#l28.36"></a><span id="l28.36">                                   getter_AddRefs(m_tempMsgFile));</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   mSuppressListenerNotifications = false;</span>
<a href="#l28.39"></a><span id="l28.39">   InitFromURI(aURL);</span>
<a href="#l28.40"></a><span id="l28.40"> }</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-nsresult nsMsgProtocol::InitFromURI(nsIURI *aUrl)</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-{</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+nsresult nsMsgProtocol::InitFromURI(nsIURI *aUrl) {</span>
<a href="#l28.45"></a><span id="l28.45">   m_url = aUrl;</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUrl);</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-  if (mailUrl)</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-  {</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUrl);</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  if (mailUrl) {</span>
<a href="#l28.52"></a><span id="l28.52">     mailUrl-&gt;GetLoadGroup(getter_AddRefs(m_loadGroup));</span>
<a href="#l28.53"></a><span id="l28.53">     nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l28.54"></a><span id="l28.54">     mailUrl-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l28.55"></a><span id="l28.55">     mProgressEventSink = do_QueryInterface(statusFeedback);</span>
<a href="#l28.56"></a><span id="l28.56">   }</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58">   // Reset channel data in case the object is reused and initialised again.</span>
<a href="#l28.59"></a><span id="l28.59">   mCharset.Truncate();</span>
<a href="#l28.60"></a><span id="l28.60"> </span>
<a href="#l28.61"></a><span id="l28.61">   return NS_OK;</span>
<a href="#l28.62"></a><span id="l28.62"> }</span>
<a href="#l28.63"></a><span id="l28.63"> </span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-nsMsgProtocol::~nsMsgProtocol()</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-{}</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+nsMsgProtocol::~nsMsgProtocol() {}</span>
<a href="#l28.68"></a><span id="l28.68"> </span>
<a href="#l28.69"></a><span id="l28.69"> static bool gGotTimeoutPref;</span>
<a href="#l28.70"></a><span id="l28.70"> static int32_t gSocketTimeout = 60;</span>
<a href="#l28.71"></a><span id="l28.71"> </span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-nsresult</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-nsMsgProtocol::GetQoSBits(uint8_t *aQoSBits)</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-{</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+nsresult nsMsgProtocol::GetQoSBits(uint8_t *aQoSBits) {</span>
<a href="#l28.76"></a><span id="l28.76">   NS_ENSURE_ARG_POINTER(aQoSBits);</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-  const char* protocol = GetType();</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+  const char *protocol = GetType();</span>
<a href="#l28.79"></a><span id="l28.79"> </span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-  if (!protocol)</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+  if (!protocol) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l28.83"></a><span id="l28.83"> </span>
<a href="#l28.84"></a><span id="l28.84">   nsAutoCString prefName(&quot;mail.&quot;);</span>
<a href="#l28.85"></a><span id="l28.85">   prefName.Append(protocol);</span>
<a href="#l28.86"></a><span id="l28.86">   prefName.AppendLiteral(&quot;.qos&quot;);</span>
<a href="#l28.87"></a><span id="l28.87"> </span>
<a href="#l28.88"></a><span id="l28.88">   nsresult rv;</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.94"></a><span id="l28.94"> </span>
<a href="#l28.95"></a><span id="l28.95">   int32_t val;</span>
<a href="#l28.96"></a><span id="l28.96">   rv = prefBranch-&gt;GetIntPref(prefName.get(), &amp;val);</span>
<a href="#l28.97"></a><span id="l28.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-  *aQoSBits = (uint8_t) clamped(val, 0, 0xff);</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+  *aQoSBits = (uint8_t)clamped(val, 0, 0xff);</span>
<a href="#l28.100"></a><span id="l28.100">   return NS_OK;</span>
<a href="#l28.101"></a><span id="l28.101"> }</span>
<a href="#l28.102"></a><span id="l28.102"> </span>
<a href="#l28.103"></a><span id="l28.103" class="difflineminus">-nsresult</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineminus">-nsMsgProtocol::OpenNetworkSocketWithInfo(const char * aHostName,</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineminus">-                                         int32_t aGetPort,</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineminus">-                                         const char *connectionType,</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-                                         nsIProxyInfo *aProxyInfo,</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-                                         nsIInterfaceRequestor* callbacks)</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineminus">-{</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+nsresult nsMsgProtocol::OpenNetworkSocketWithInfo(</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+    const char *aHostName, int32_t aGetPort, const char *connectionType,</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+    nsIProxyInfo *aProxyInfo, nsIInterfaceRequestor *callbacks) {</span>
<a href="#l28.113"></a><span id="l28.113">   NS_ENSURE_ARG(aHostName);</span>
<a href="#l28.114"></a><span id="l28.114"> </span>
<a href="#l28.115"></a><span id="l28.115">   nsresult rv = NS_OK;</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-  nsCOMPtr&lt;nsISocketTransportService&gt; socketService (do_GetService(NS_SOCKETTRANSPORTSERVICE_CONTRACTID));</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+  nsCOMPtr&lt;nsISocketTransportService&gt; socketService(</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+      do_GetService(NS_SOCKETTRANSPORTSERVICE_CONTRACTID));</span>
<a href="#l28.119"></a><span id="l28.119">   NS_ENSURE_TRUE(socketService, NS_ERROR_FAILURE);</span>
<a href="#l28.120"></a><span id="l28.120"> </span>
<a href="#l28.121"></a><span id="l28.121">   // with socket connections we want to read as much data as arrives</span>
<a href="#l28.122"></a><span id="l28.122">   m_readCount = -1;</span>
<a href="#l28.123"></a><span id="l28.123"> </span>
<a href="#l28.124"></a><span id="l28.124">   nsCOMPtr&lt;nsISocketTransport&gt; strans;</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineminus">-  rv = socketService-&gt;CreateTransport(&amp;connectionType, connectionType != nullptr,</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineminus">-                                      nsDependentCString(aHostName),</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-                                      aGetPort, aProxyInfo,</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineminus">-                                      getter_AddRefs(strans));</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+  rv = socketService-&gt;CreateTransport(</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+      &amp;connectionType, connectionType != nullptr, nsDependentCString(aHostName),</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineplus">+      aGetPort, aProxyInfo, getter_AddRefs(strans));</span>
<a href="#l28.132"></a><span id="l28.132">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.133"></a><span id="l28.133"> </span>
<a href="#l28.134"></a><span id="l28.134">   strans-&gt;SetSecurityCallbacks(callbacks);</span>
<a href="#l28.135"></a><span id="l28.135"> </span>
<a href="#l28.136"></a><span id="l28.136">   // creates cyclic reference!</span>
<a href="#l28.137"></a><span id="l28.137">   nsCOMPtr&lt;nsIThread&gt; currentThread(do_GetCurrentThread());</span>
<a href="#l28.138"></a><span id="l28.138">   strans-&gt;SetEventSink(this, currentThread);</span>
<a href="#l28.139"></a><span id="l28.139"> </span>
<a href="#l28.140"></a><span id="l28.140">   m_socketIsOpen = false;</span>
<a href="#l28.141"></a><span id="l28.141">   m_transport = strans;</span>
<a href="#l28.142"></a><span id="l28.142"> </span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-  if (!gGotTimeoutPref)</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-  {</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-    if (prefBranch)</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-    {</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineplus">+  if (!gGotTimeoutPref) {</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineplus">+    if (prefBranch) {</span>
<a href="#l28.152"></a><span id="l28.152">       prefBranch-&gt;GetIntPref(&quot;mailnews.tcptimeout&quot;, &amp;gSocketTimeout);</span>
<a href="#l28.153"></a><span id="l28.153">       gGotTimeoutPref = true;</span>
<a href="#l28.154"></a><span id="l28.154">     }</span>
<a href="#l28.155"></a><span id="l28.155">   }</span>
<a href="#l28.156"></a><span id="l28.156">   strans-&gt;SetTimeout(nsISocketTransport::TIMEOUT_CONNECT, gSocketTimeout + 60);</span>
<a href="#l28.157"></a><span id="l28.157">   strans-&gt;SetTimeout(nsISocketTransport::TIMEOUT_READ_WRITE, gSocketTimeout);</span>
<a href="#l28.158"></a><span id="l28.158"> </span>
<a href="#l28.159"></a><span id="l28.159">   uint8_t qos;</span>
<a href="#l28.160"></a><span id="l28.160">   rv = GetQoSBits(&amp;qos);</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-    strans-&gt;SetQoSBits(qos);</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineplus">+  if (NS_SUCCEEDED(rv)) strans-&gt;SetQoSBits(qos);</span>
<a href="#l28.164"></a><span id="l28.164"> </span>
<a href="#l28.165"></a><span id="l28.165">   return SetupTransportState();</span>
<a href="#l28.166"></a><span id="l28.166"> }</span>
<a href="#l28.167"></a><span id="l28.167"> </span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-nsresult nsMsgProtocol::GetFileFromURL(nsIURI * aURL, nsIFile **aResult)</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineminus">-{</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineplus">+nsresult nsMsgProtocol::GetFileFromURL(nsIURI *aURL, nsIFile **aResult) {</span>
<a href="#l28.171"></a><span id="l28.171">   NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l28.172"></a><span id="l28.172">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l28.173"></a><span id="l28.173">   // extract the file path from the uri...</span>
<a href="#l28.174"></a><span id="l28.174">   nsAutoCString urlSpec;</span>
<a href="#l28.175"></a><span id="l28.175">   aURL-&gt;GetPathQueryRef(urlSpec);</span>
<a href="#l28.176"></a><span id="l28.176">   urlSpec.InsertLiteral(&quot;file://&quot;, 0);</span>
<a href="#l28.177"></a><span id="l28.177">   nsresult rv;</span>
<a href="#l28.178"></a><span id="l28.178"> </span>
<a href="#l28.179"></a><span id="l28.179" class="difflineminus">-// dougt - there should be an easier way!</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineplus">+  // dougt - there should be an easier way!</span>
<a href="#l28.181"></a><span id="l28.181">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-  if (NS_FAILED(rv = NS_NewURI(getter_AddRefs(uri), urlSpec.get())))</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-      return rv;</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineplus">+  if (NS_FAILED(rv = NS_NewURI(getter_AddRefs(uri), urlSpec.get()))) return rv;</span>
<a href="#l28.185"></a><span id="l28.185"> </span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-  nsCOMPtr&lt;nsIFileURL&gt;    fileURL = do_QueryInterface(uri);</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-  if (!fileURL)   return NS_ERROR_FAILURE;</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineplus">+  nsCOMPtr&lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineplus">+  if (!fileURL) return NS_ERROR_FAILURE;</span>
<a href="#l28.190"></a><span id="l28.190"> </span>
<a href="#l28.191"></a><span id="l28.191">   return fileURL-&gt;GetFile(aResult);</span>
<a href="#l28.192"></a><span id="l28.192">   // dougt</span>
<a href="#l28.193"></a><span id="l28.193"> }</span>
<a href="#l28.194"></a><span id="l28.194"> </span>
<a href="#l28.195"></a><span id="l28.195" class="difflineminus">-nsresult nsMsgProtocol::OpenFileSocket(nsIURI *aURL, uint64_t aStartPosition, int64_t aReadCount)</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineminus">-{</span>
<a href="#l28.197"></a><span id="l28.197" class="difflineminus">-  // mscott - file needs to be encoded directly into aURL. I should be able to get</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineminus">-  // rid of this method completely.</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineplus">+nsresult nsMsgProtocol::OpenFileSocket(nsIURI *aURL, uint64_t aStartPosition,</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineplus">+                                       int64_t aReadCount) {</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+  // mscott - file needs to be encoded directly into aURL. I should be able to</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+  // get rid of this method completely.</span>
<a href="#l28.203"></a><span id="l28.203"> </span>
<a href="#l28.204"></a><span id="l28.204">   nsresult rv = NS_OK;</span>
<a href="#l28.205"></a><span id="l28.205">   m_readCount = aReadCount;</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l28.208"></a><span id="l28.208"> </span>
<a href="#l28.209"></a><span id="l28.209">   rv = GetFileFromURL(aURL, getter_AddRefs(file));</span>
<a href="#l28.210"></a><span id="l28.210">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.211"></a><span id="l28.211"> </span>
<a href="#l28.212"></a><span id="l28.212">   nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l28.213"></a><span id="l28.213">   rv = NS_NewLocalFileInputStream(getter_AddRefs(stream), file);</span>
<a href="#l28.214"></a><span id="l28.214">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.215"></a><span id="l28.215"> </span>
<a href="#l28.216"></a><span id="l28.216">   // create input stream transport</span>
<a href="#l28.217"></a><span id="l28.217">   nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l28.218"></a><span id="l28.218">       do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l28.219"></a><span id="l28.219">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.220"></a><span id="l28.220"> </span>
<a href="#l28.221"></a><span id="l28.221" class="difflineminus">-  // This can be called with aReadCount == -1 which means &quot;read as much as we can&quot;.</span>
<a href="#l28.222"></a><span id="l28.222" class="difflineminus">-  // We pass this on as UINT64_MAX, which is in fact uint64_t(-1).</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-  RefPtr&lt;SlicedInputStream&gt; slicedStream =</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineminus">-    new SlicedInputStream(stream.forget(), aStartPosition,</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineminus">-                          aReadCount == -1 ? UINT64_MAX : uint64_t(aReadCount));</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineplus">+  // This can be called with aReadCount == -1 which means &quot;read as much as we</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineplus">+  // can&quot;. We pass this on as UINT64_MAX, which is in fact uint64_t(-1).</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineplus">+  RefPtr&lt;SlicedInputStream&gt; slicedStream = new SlicedInputStream(</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineplus">+      stream.forget(), aStartPosition,</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineplus">+      aReadCount == -1 ? UINT64_MAX : uint64_t(aReadCount));</span>
<a href="#l28.231"></a><span id="l28.231">   rv = sts-&gt;CreateInputTransport(slicedStream, true,</span>
<a href="#l28.232"></a><span id="l28.232">                                  getter_AddRefs(m_transport));</span>
<a href="#l28.233"></a><span id="l28.233"> </span>
<a href="#l28.234"></a><span id="l28.234">   m_socketIsOpen = false;</span>
<a href="#l28.235"></a><span id="l28.235">   return rv;</span>
<a href="#l28.236"></a><span id="l28.236"> }</span>
<a href="#l28.237"></a><span id="l28.237"> </span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-nsresult nsMsgProtocol::GetTopmostMsgWindow(nsIMsgWindow **aWindow)</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineminus">-{</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineplus">+nsresult nsMsgProtocol::GetTopmostMsgWindow(nsIMsgWindow **aWindow) {</span>
<a href="#l28.241"></a><span id="l28.241">   nsresult rv;</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l28.245"></a><span id="l28.245">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.246"></a><span id="l28.246">   return mailSession-&gt;GetTopmostMsgWindow(aWindow);</span>
<a href="#l28.247"></a><span id="l28.247"> }</span>
<a href="#l28.248"></a><span id="l28.248"> </span>
<a href="#l28.249"></a><span id="l28.249" class="difflineminus">-nsresult nsMsgProtocol::SetupTransportState()</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineminus">-{</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineminus">-  if (!m_socketIsOpen &amp;&amp; m_transport)</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineminus">-  {</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineplus">+nsresult nsMsgProtocol::SetupTransportState() {</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineplus">+  if (!m_socketIsOpen &amp;&amp; m_transport) {</span>
<a href="#l28.255"></a><span id="l28.255">     nsresult rv;</span>
<a href="#l28.256"></a><span id="l28.256"> </span>
<a href="#l28.257"></a><span id="l28.257">     // open buffered, blocking output stream</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineminus">-    rv = m_transport-&gt;OpenOutputStream(nsITransport::OPEN_BLOCKING, 0, 0, getter_AddRefs(m_outputStream));</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+    rv = m_transport-&gt;OpenOutputStream(nsITransport::OPEN_BLOCKING, 0, 0,</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineplus">+                                       getter_AddRefs(m_outputStream));</span>
<a href="#l28.261"></a><span id="l28.261">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.262"></a><span id="l28.262">     // we want to open the stream</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineminus">-  } // if m_transport</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineplus">+  }  // if m_transport</span>
<a href="#l28.265"></a><span id="l28.265"> </span>
<a href="#l28.266"></a><span id="l28.266">   return NS_OK;</span>
<a href="#l28.267"></a><span id="l28.267"> }</span>
<a href="#l28.268"></a><span id="l28.268"> </span>
<a href="#l28.269"></a><span id="l28.269" class="difflineminus">-nsresult nsMsgProtocol::CloseSocket()</span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-{</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineplus">+nsresult nsMsgProtocol::CloseSocket() {</span>
<a href="#l28.272"></a><span id="l28.272">   nsresult rv = NS_OK;</span>
<a href="#l28.273"></a><span id="l28.273">   // release all of our socket state</span>
<a href="#l28.274"></a><span id="l28.274">   m_socketIsOpen = false;</span>
<a href="#l28.275"></a><span id="l28.275">   m_outputStream = nullptr;</span>
<a href="#l28.276"></a><span id="l28.276">   if (m_transport) {</span>
<a href="#l28.277"></a><span id="l28.277">     nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport);</span>
<a href="#l28.278"></a><span id="l28.278">     if (strans) {</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineminus">-      strans-&gt;SetEventSink(nullptr, nullptr); // break cyclic reference!</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+      strans-&gt;SetEventSink(nullptr, nullptr);  // break cyclic reference!</span>
<a href="#l28.281"></a><span id="l28.281">     }</span>
<a href="#l28.282"></a><span id="l28.282">   }</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineminus">-  // we need to call Cancel so that we remove the socket transport from the mActiveTransportList.  see bug #30648</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+  // we need to call Cancel so that we remove the socket transport from the</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineplus">+  // mActiveTransportList.  see bug #30648</span>
<a href="#l28.286"></a><span id="l28.286">   if (m_request) {</span>
<a href="#l28.287"></a><span id="l28.287">     rv = m_request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l28.288"></a><span id="l28.288">   }</span>
<a href="#l28.289"></a><span id="l28.289">   m_request = nullptr;</span>
<a href="#l28.290"></a><span id="l28.290">   if (m_transport) {</span>
<a href="#l28.291"></a><span id="l28.291">     m_transport-&gt;Close(NS_BINDING_ABORTED);</span>
<a href="#l28.292"></a><span id="l28.292">     m_transport = nullptr;</span>
<a href="#l28.293"></a><span id="l28.293">   }</span>
<a href="#l28.294"></a><span id="l28.294"> </span>
<a href="#l28.295"></a><span id="l28.295">   return rv;</span>
<a href="#l28.296"></a><span id="l28.296"> }</span>
<a href="#l28.297"></a><span id="l28.297"> </span>
<a href="#l28.298"></a><span id="l28.298"> /*</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineminus">-* Writes the data contained in dataBuffer into the current output stream. It also informs</span>
<a href="#l28.300"></a><span id="l28.300" class="difflineminus">-* the transport layer that this data is now available for transmission.</span>
<a href="#l28.301"></a><span id="l28.301" class="difflineminus">-* Returns a positive number for success, 0 for failure (not all the bytes were written to the</span>
<a href="#l28.302"></a><span id="l28.302" class="difflineminus">-* stream, etc). We need to make another pass through this file to install an error system (mscott)</span>
<a href="#l28.303"></a><span id="l28.303" class="difflineminus">-*</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineminus">-* No logging is done in the base implementation, so aSuppressLogging is ignored.</span>
<a href="#l28.305"></a><span id="l28.305" class="difflineminus">-*/</span>
<a href="#l28.306"></a><span id="l28.306" class="difflineplus">+ * Writes the data contained in dataBuffer into the current output stream. It</span>
<a href="#l28.307"></a><span id="l28.307" class="difflineplus">+ * also informs the transport layer that this data is now available for</span>
<a href="#l28.308"></a><span id="l28.308" class="difflineplus">+ * transmission. Returns a positive number for success, 0 for failure (not all</span>
<a href="#l28.309"></a><span id="l28.309" class="difflineplus">+ * the bytes were written to the stream, etc). We need to make another pass</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineplus">+ * through this file to install an error system (mscott)</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineplus">+ *</span>
<a href="#l28.312"></a><span id="l28.312" class="difflineplus">+ * No logging is done in the base implementation, so aSuppressLogging is</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineplus">+ * ignored.</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineplus">+ */</span>
<a href="#l28.315"></a><span id="l28.315"> </span>
<a href="#l28.316"></a><span id="l28.316" class="difflineminus">-nsresult nsMsgProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l28.317"></a><span id="l28.317" class="difflineminus">-{</span>
<a href="#l28.318"></a><span id="l28.318" class="difflineplus">+nsresult nsMsgProtocol::SendData(const char *dataBuffer,</span>
<a href="#l28.319"></a><span id="l28.319" class="difflineplus">+                                 bool aSuppressLogging) {</span>
<a href="#l28.320"></a><span id="l28.320">   uint32_t writeCount = 0;</span>
<a href="#l28.321"></a><span id="l28.321"> </span>
<a href="#l28.322"></a><span id="l28.322">   if (dataBuffer &amp;&amp; m_outputStream)</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineminus">-    return m_outputStream-&gt;Write(dataBuffer, PL_strlen(dataBuffer), &amp;writeCount);</span>
<a href="#l28.324"></a><span id="l28.324" class="difflineminus">-    // TODO make sure all the bytes in PL_strlen(dataBuffer) were written</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineplus">+    return m_outputStream-&gt;Write(dataBuffer, PL_strlen(dataBuffer),</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineplus">+                                 &amp;writeCount);</span>
<a href="#l28.327"></a><span id="l28.327" class="difflineplus">+  // TODO make sure all the bytes in PL_strlen(dataBuffer) were written</span>
<a href="#l28.328"></a><span id="l28.328">   else</span>
<a href="#l28.329"></a><span id="l28.329">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l28.330"></a><span id="l28.330"> }</span>
<a href="#l28.331"></a><span id="l28.331"> </span>
<a href="#l28.332"></a><span id="l28.332" class="difflineminus">-// Whenever data arrives from the connection, core netlib notifices the protocol by calling</span>
<a href="#l28.333"></a><span id="l28.333" class="difflineminus">-// OnDataAvailable. We then read and process the incoming data from the input stream.</span>
<a href="#l28.334"></a><span id="l28.334" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::OnDataAvailable(nsIRequest *request, nsIInputStream *inStr, uint64_t sourceOffset, uint32_t count)</span>
<a href="#l28.335"></a><span id="l28.335" class="difflineminus">-{</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineminus">-  // right now, this really just means turn around and churn through the state machine</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l28.338"></a><span id="l28.338" class="difflineplus">+// Whenever data arrives from the connection, core netlib notifices the protocol</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineplus">+// by calling OnDataAvailable. We then read and process the incoming data from</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineplus">+// the input stream.</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::OnDataAvailable(nsIRequest *request,</span>
<a href="#l28.342"></a><span id="l28.342" class="difflineplus">+                                             nsIInputStream *inStr,</span>
<a href="#l28.343"></a><span id="l28.343" class="difflineplus">+                                             uint64_t sourceOffset,</span>
<a href="#l28.344"></a><span id="l28.344" class="difflineplus">+                                             uint32_t count) {</span>
<a href="#l28.345"></a><span id="l28.345" class="difflineplus">+  // right now, this really just means turn around and churn through the state</span>
<a href="#l28.346"></a><span id="l28.346" class="difflineplus">+  // machine</span>
<a href="#l28.347"></a><span id="l28.347" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l28.348"></a><span id="l28.348">   GetURI(getter_AddRefs(uri));</span>
<a href="#l28.349"></a><span id="l28.349"> </span>
<a href="#l28.350"></a><span id="l28.350">   return ProcessProtocolState(uri, inStr, sourceOffset, count);</span>
<a href="#l28.351"></a><span id="l28.351"> }</span>
<a href="#l28.352"></a><span id="l28.352"> </span>
<a href="#l28.353"></a><span id="l28.353" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::OnStartRequest(nsIRequest *request)</span>
<a href="#l28.354"></a><span id="l28.354" class="difflineminus">-{</span>
<a href="#l28.355"></a><span id="l28.355" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::OnStartRequest(nsIRequest *request) {</span>
<a href="#l28.356"></a><span id="l28.356">   nsresult rv = NS_OK;</span>
<a href="#l28.357"></a><span id="l28.357" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l28.358"></a><span id="l28.358" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l28.359"></a><span id="l28.359">   GetURI(getter_AddRefs(uri));</span>
<a href="#l28.360"></a><span id="l28.360"> </span>
<a href="#l28.361"></a><span id="l28.361" class="difflineminus">-  if (uri)</span>
<a href="#l28.362"></a><span id="l28.362" class="difflineminus">-  {</span>
<a href="#l28.363"></a><span id="l28.363" class="difflineplus">+  if (uri) {</span>
<a href="#l28.364"></a><span id="l28.364">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; aMsgUrl = do_QueryInterface(uri);</span>
<a href="#l28.365"></a><span id="l28.365">     rv = aMsgUrl-&gt;SetUrlState(true, NS_OK);</span>
<a href="#l28.366"></a><span id="l28.366">     if (m_loadGroup)</span>
<a href="#l28.367"></a><span id="l28.367" class="difflineminus">-      m_loadGroup-&gt;AddRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr /* context isupports */);</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineplus">+      m_loadGroup-&gt;AddRequest(static_cast&lt;nsIRequest *&gt;(this),</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineplus">+                              nullptr /* context isupports */);</span>
<a href="#l28.370"></a><span id="l28.370">   }</span>
<a href="#l28.371"></a><span id="l28.371"> </span>
<a href="#l28.372"></a><span id="l28.372" class="difflineminus">-  // if we are set up as a channel, we should notify our channel listener that we are starting...</span>
<a href="#l28.373"></a><span id="l28.373" class="difflineminus">-  // so pass in ourself as the channel and not the underlying socket or file channel the protocol</span>
<a href="#l28.374"></a><span id="l28.374" class="difflineminus">-  // happens to be using</span>
<a href="#l28.375"></a><span id="l28.375" class="difflineminus">-  if (!mSuppressListenerNotifications &amp;&amp; m_channelListener)</span>
<a href="#l28.376"></a><span id="l28.376" class="difflineminus">-  {</span>
<a href="#l28.377"></a><span id="l28.377" class="difflineminus">-    if (!m_channelContext)</span>
<a href="#l28.378"></a><span id="l28.378" class="difflineminus">-      m_channelContext = uri;</span>
<a href="#l28.379"></a><span id="l28.379" class="difflineplus">+  // if we are set up as a channel, we should notify our channel listener that</span>
<a href="#l28.380"></a><span id="l28.380" class="difflineplus">+  // we are starting... so pass in ourself as the channel and not the underlying</span>
<a href="#l28.381"></a><span id="l28.381" class="difflineplus">+  // socket or file channel the protocol happens to be using</span>
<a href="#l28.382"></a><span id="l28.382" class="difflineplus">+  if (!mSuppressListenerNotifications &amp;&amp; m_channelListener) {</span>
<a href="#l28.383"></a><span id="l28.383" class="difflineplus">+    if (!m_channelContext) m_channelContext = uri;</span>
<a href="#l28.384"></a><span id="l28.384">     rv = m_channelListener-&gt;OnStartRequest(this);</span>
<a href="#l28.385"></a><span id="l28.385">   }</span>
<a href="#l28.386"></a><span id="l28.386"> </span>
<a href="#l28.387"></a><span id="l28.387">   nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport);</span>
<a href="#l28.388"></a><span id="l28.388"> </span>
<a href="#l28.389"></a><span id="l28.389">   if (strans)</span>
<a href="#l28.390"></a><span id="l28.390">     strans-&gt;SetTimeout(nsISocketTransport::TIMEOUT_READ_WRITE, gSocketTimeout);</span>
<a href="#l28.391"></a><span id="l28.391"> </span>
<a href="#l28.392"></a><span id="l28.392">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.393"></a><span id="l28.393">   return rv;</span>
<a href="#l28.394"></a><span id="l28.394"> }</span>
<a href="#l28.395"></a><span id="l28.395"> </span>
<a href="#l28.396"></a><span id="l28.396" class="difflineminus">-void nsMsgProtocol::ShowAlertMessage(nsIMsgMailNewsUrl *aMsgUrl, nsresult aStatus)</span>
<a href="#l28.397"></a><span id="l28.397" class="difflineminus">-{</span>
<a href="#l28.398"></a><span id="l28.398" class="difflineminus">-  const char16_t* errorString = nullptr;</span>
<a href="#l28.399"></a><span id="l28.399" class="difflineminus">-  switch (aStatus)</span>
<a href="#l28.400"></a><span id="l28.400" class="difflineminus">-  {</span>
<a href="#l28.401"></a><span id="l28.401" class="difflineminus">-  case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l28.402"></a><span id="l28.402" class="difflineminus">-  case NS_ERROR_UNKNOWN_PROXY_HOST:</span>
<a href="#l28.403"></a><span id="l28.403" class="difflineminus">-     errorString = u&quot;unknownHostError&quot;;</span>
<a href="#l28.404"></a><span id="l28.404" class="difflineminus">-     break;</span>
<a href="#l28.405"></a><span id="l28.405" class="difflineminus">-  case NS_ERROR_CONNECTION_REFUSED:</span>
<a href="#l28.406"></a><span id="l28.406" class="difflineminus">-  case NS_ERROR_PROXY_CONNECTION_REFUSED:</span>
<a href="#l28.407"></a><span id="l28.407" class="difflineminus">-     errorString = u&quot;connectionRefusedError&quot;;</span>
<a href="#l28.408"></a><span id="l28.408" class="difflineminus">-     break;</span>
<a href="#l28.409"></a><span id="l28.409" class="difflineminus">-  case NS_ERROR_NET_TIMEOUT:</span>
<a href="#l28.410"></a><span id="l28.410" class="difflineminus">-     errorString = u&quot;netTimeoutError&quot;;</span>
<a href="#l28.411"></a><span id="l28.411" class="difflineminus">-     break;</span>
<a href="#l28.412"></a><span id="l28.412" class="difflineminus">-  case NS_ERROR_NET_RESET:</span>
<a href="#l28.413"></a><span id="l28.413" class="difflineminus">-     errorString = u&quot;netResetError&quot;;</span>
<a href="#l28.414"></a><span id="l28.414" class="difflineminus">-     break;</span>
<a href="#l28.415"></a><span id="l28.415" class="difflineminus">-  case NS_ERROR_NET_INTERRUPT:</span>
<a href="#l28.416"></a><span id="l28.416" class="difflineminus">-     errorString = u&quot;netInterruptError&quot;;</span>
<a href="#l28.417"></a><span id="l28.417" class="difflineminus">-     break;</span>
<a href="#l28.418"></a><span id="l28.418" class="difflineminus">-  case NS_ERROR_OFFLINE:</span>
<a href="#l28.419"></a><span id="l28.419" class="difflineminus">-     // Don't alert when offline as that is already displayed in the UI.</span>
<a href="#l28.420"></a><span id="l28.420" class="difflineminus">-     return;</span>
<a href="#l28.421"></a><span id="l28.421" class="difflineminus">-  default:</span>
<a href="#l28.422"></a><span id="l28.422" class="difflineminus">-     nsPrintfCString msg(&quot;Unexpected status passed to ShowAlertMessage: %&quot; PRIx32,</span>
<a href="#l28.423"></a><span id="l28.423" class="difflineminus">-                         static_cast&lt;uint32_t&gt;(aStatus));</span>
<a href="#l28.424"></a><span id="l28.424" class="difflineminus">-     NS_WARNING(msg.get());</span>
<a href="#l28.425"></a><span id="l28.425" class="difflineminus">-     return;</span>
<a href="#l28.426"></a><span id="l28.426" class="difflineplus">+void nsMsgProtocol::ShowAlertMessage(nsIMsgMailNewsUrl *aMsgUrl,</span>
<a href="#l28.427"></a><span id="l28.427" class="difflineplus">+                                     nsresult aStatus) {</span>
<a href="#l28.428"></a><span id="l28.428" class="difflineplus">+  const char16_t *errorString = nullptr;</span>
<a href="#l28.429"></a><span id="l28.429" class="difflineplus">+  switch (aStatus) {</span>
<a href="#l28.430"></a><span id="l28.430" class="difflineplus">+    case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l28.431"></a><span id="l28.431" class="difflineplus">+    case NS_ERROR_UNKNOWN_PROXY_HOST:</span>
<a href="#l28.432"></a><span id="l28.432" class="difflineplus">+      errorString = u&quot;unknownHostError&quot;;</span>
<a href="#l28.433"></a><span id="l28.433" class="difflineplus">+      break;</span>
<a href="#l28.434"></a><span id="l28.434" class="difflineplus">+    case NS_ERROR_CONNECTION_REFUSED:</span>
<a href="#l28.435"></a><span id="l28.435" class="difflineplus">+    case NS_ERROR_PROXY_CONNECTION_REFUSED:</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineplus">+      errorString = u&quot;connectionRefusedError&quot;;</span>
<a href="#l28.437"></a><span id="l28.437" class="difflineplus">+      break;</span>
<a href="#l28.438"></a><span id="l28.438" class="difflineplus">+    case NS_ERROR_NET_TIMEOUT:</span>
<a href="#l28.439"></a><span id="l28.439" class="difflineplus">+      errorString = u&quot;netTimeoutError&quot;;</span>
<a href="#l28.440"></a><span id="l28.440" class="difflineplus">+      break;</span>
<a href="#l28.441"></a><span id="l28.441" class="difflineplus">+    case NS_ERROR_NET_RESET:</span>
<a href="#l28.442"></a><span id="l28.442" class="difflineplus">+      errorString = u&quot;netResetError&quot;;</span>
<a href="#l28.443"></a><span id="l28.443" class="difflineplus">+      break;</span>
<a href="#l28.444"></a><span id="l28.444" class="difflineplus">+    case NS_ERROR_NET_INTERRUPT:</span>
<a href="#l28.445"></a><span id="l28.445" class="difflineplus">+      errorString = u&quot;netInterruptError&quot;;</span>
<a href="#l28.446"></a><span id="l28.446" class="difflineplus">+      break;</span>
<a href="#l28.447"></a><span id="l28.447" class="difflineplus">+    case NS_ERROR_OFFLINE:</span>
<a href="#l28.448"></a><span id="l28.448" class="difflineplus">+      // Don't alert when offline as that is already displayed in the UI.</span>
<a href="#l28.449"></a><span id="l28.449" class="difflineplus">+      return;</span>
<a href="#l28.450"></a><span id="l28.450" class="difflineplus">+    default:</span>
<a href="#l28.451"></a><span id="l28.451" class="difflineplus">+      nsPrintfCString msg(</span>
<a href="#l28.452"></a><span id="l28.452" class="difflineplus">+          &quot;Unexpected status passed to ShowAlertMessage: %&quot; PRIx32,</span>
<a href="#l28.453"></a><span id="l28.453" class="difflineplus">+          static_cast&lt;uint32_t&gt;(aStatus));</span>
<a href="#l28.454"></a><span id="l28.454" class="difflineplus">+      NS_WARNING(msg.get());</span>
<a href="#l28.455"></a><span id="l28.455" class="difflineplus">+      return;</span>
<a href="#l28.456"></a><span id="l28.456">   }</span>
<a href="#l28.457"></a><span id="l28.457"> </span>
<a href="#l28.458"></a><span id="l28.458">   nsString errorMsg;</span>
<a href="#l28.459"></a><span id="l28.459">   errorMsg.Adopt(FormatStringWithHostNameByName(errorString, aMsgUrl));</span>
<a href="#l28.460"></a><span id="l28.460" class="difflineminus">-  if (errorMsg.IsEmpty())</span>
<a href="#l28.461"></a><span id="l28.461" class="difflineminus">-  {</span>
<a href="#l28.462"></a><span id="l28.462" class="difflineplus">+  if (errorMsg.IsEmpty()) {</span>
<a href="#l28.463"></a><span id="l28.463">     errorMsg.AssignLiteral(u&quot;[StringID &quot;);</span>
<a href="#l28.464"></a><span id="l28.464">     errorMsg.Append(errorString);</span>
<a href="#l28.465"></a><span id="l28.465">     errorMsg.AppendLiteral(u&quot;?]&quot;);</span>
<a href="#l28.466"></a><span id="l28.466">   }</span>
<a href="#l28.467"></a><span id="l28.467"> </span>
<a href="#l28.468"></a><span id="l28.468">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l28.469"></a><span id="l28.469" class="difflineminus">-    do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l28.470"></a><span id="l28.470" class="difflineminus">-  if (mailSession)</span>
<a href="#l28.471"></a><span id="l28.471" class="difflineminus">-    mailSession-&gt;AlertUser(errorMsg, aMsgUrl);</span>
<a href="#l28.472"></a><span id="l28.472" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l28.473"></a><span id="l28.473" class="difflineplus">+  if (mailSession) mailSession-&gt;AlertUser(errorMsg, aMsgUrl);</span>
<a href="#l28.474"></a><span id="l28.474"> }</span>
<a href="#l28.475"></a><span id="l28.475"> </span>
<a href="#l28.476"></a><span id="l28.476" class="difflineminus">-// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l28.477"></a><span id="l28.477" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l28.478"></a><span id="l28.478" class="difflineminus">-{</span>
<a href="#l28.479"></a><span id="l28.479" class="difflineplus">+// stop binding is a &quot;notification&quot; informing us that the stream associated with</span>
<a href="#l28.480"></a><span id="l28.480" class="difflineplus">+// aURL is going away.</span>
<a href="#l28.481"></a><span id="l28.481" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::OnStopRequest(nsIRequest *request,</span>
<a href="#l28.482"></a><span id="l28.482" class="difflineplus">+                                           nsresult aStatus) {</span>
<a href="#l28.483"></a><span id="l28.483">   nsresult rv = NS_OK;</span>
<a href="#l28.484"></a><span id="l28.484"> </span>
<a href="#l28.485"></a><span id="l28.485" class="difflineminus">-  // if we are set up as a channel, we should notify our channel listener that we are starting...</span>
<a href="#l28.486"></a><span id="l28.486" class="difflineminus">-  // so pass in ourself as the channel and not the underlying socket or file channel the protocol</span>
<a href="#l28.487"></a><span id="l28.487" class="difflineminus">-  // happens to be using</span>
<a href="#l28.488"></a><span id="l28.488" class="difflineplus">+  // if we are set up as a channel, we should notify our channel listener that</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineplus">+  // we are starting... so pass in ourself as the channel and not the underlying</span>
<a href="#l28.490"></a><span id="l28.490" class="difflineplus">+  // socket or file channel the protocol happens to be using</span>
<a href="#l28.491"></a><span id="l28.491">   if (!mSuppressListenerNotifications &amp;&amp; m_channelListener)</span>
<a href="#l28.492"></a><span id="l28.492">     rv = m_channelListener-&gt;OnStopRequest(this, aStatus);</span>
<a href="#l28.493"></a><span id="l28.493"> </span>
<a href="#l28.494"></a><span id="l28.494">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l28.495"></a><span id="l28.495">   GetURI(getter_AddRefs(uri));</span>
<a href="#l28.496"></a><span id="l28.496"> </span>
<a href="#l28.497"></a><span id="l28.497" class="difflineminus">-  if (uri)</span>
<a href="#l28.498"></a><span id="l28.498" class="difflineminus">-  {</span>
<a href="#l28.499"></a><span id="l28.499" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(uri);</span>
<a href="#l28.500"></a><span id="l28.500" class="difflineplus">+  if (uri) {</span>
<a href="#l28.501"></a><span id="l28.501" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(uri);</span>
<a href="#l28.502"></a><span id="l28.502">     rv = msgUrl-&gt;SetUrlState(false, aStatus);  // Always returns NS_OK.</span>
<a href="#l28.503"></a><span id="l28.503">     if (m_loadGroup)</span>
<a href="#l28.504"></a><span id="l28.504" class="difflineminus">-      m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr, aStatus);</span>
<a href="#l28.505"></a><span id="l28.505" class="difflineplus">+      m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr,</span>
<a href="#l28.506"></a><span id="l28.506" class="difflineplus">+                                 aStatus);</span>
<a href="#l28.507"></a><span id="l28.507"> </span>
<a href="#l28.508"></a><span id="l28.508">     // !m_channelContext because if we're set up as a channel, then the remove</span>
<a href="#l28.509"></a><span id="l28.509">     // request above will handle alerting the user, so we don't need to.</span>
<a href="#l28.510"></a><span id="l28.510">     //</span>
<a href="#l28.511"></a><span id="l28.511">     // !NS_BINDING_ABORTED because we don't want to see an alert if the user</span>
<a href="#l28.512"></a><span id="l28.512">     // cancelled the operation.  also, we'll get here because we call Cancel()</span>
<a href="#l28.513"></a><span id="l28.513">     // to force removal of the nsSocketTransport.  see CloseSocket()</span>
<a href="#l28.514"></a><span id="l28.514">     // bugs #30775 and #30648 relate to this</span>
<a href="#l28.515"></a><span id="l28.515">     if (!m_channelContext &amp;&amp; NS_FAILED(aStatus) &amp;&amp;</span>
<a href="#l28.516"></a><span id="l28.516">         (aStatus != NS_BINDING_ABORTED))</span>
<a href="#l28.517"></a><span id="l28.517">       ShowAlertMessage(msgUrl, aStatus);</span>
<a href="#l28.518"></a><span id="l28.518" class="difflineminus">-  } // if we have a mailnews url.</span>
<a href="#l28.519"></a><span id="l28.519" class="difflineplus">+  }  // if we have a mailnews url.</span>
<a href="#l28.520"></a><span id="l28.520"> </span>
<a href="#l28.521"></a><span id="l28.521">   // Drop notification callbacks to prevent cycles.</span>
<a href="#l28.522"></a><span id="l28.522">   mCallbacks = nullptr;</span>
<a href="#l28.523"></a><span id="l28.523">   mProgressEventSink = nullptr;</span>
<a href="#l28.524"></a><span id="l28.524">   // Call CloseSocket(), in case we got here because the server dropped the</span>
<a href="#l28.525"></a><span id="l28.525">   // connection while reading, and we never get a chance to get back into</span>
<a href="#l28.526"></a><span id="l28.526">   // the protocol state machine via OnDataAvailable.</span>
<a href="#l28.527"></a><span id="l28.527" class="difflineminus">-  if (m_socketIsOpen)</span>
<a href="#l28.528"></a><span id="l28.528" class="difflineminus">-    CloseSocket();</span>
<a href="#l28.529"></a><span id="l28.529" class="difflineplus">+  if (m_socketIsOpen) CloseSocket();</span>
<a href="#l28.530"></a><span id="l28.530"> </span>
<a href="#l28.531"></a><span id="l28.531">   return rv;</span>
<a href="#l28.532"></a><span id="l28.532"> }</span>
<a href="#l28.533"></a><span id="l28.533"> </span>
<a href="#l28.534"></a><span id="l28.534" class="difflineminus">-nsresult nsMsgProtocol::GetPromptDialogFromUrl(nsIMsgMailNewsUrl * aMsgUrl, nsIPrompt ** aPromptDialog)</span>
<a href="#l28.535"></a><span id="l28.535" class="difflineminus">-{</span>
<a href="#l28.536"></a><span id="l28.536" class="difflineminus">-  // get the nsIPrompt interface from the message window associated wit this url.</span>
<a href="#l28.537"></a><span id="l28.537" class="difflineplus">+nsresult nsMsgProtocol::GetPromptDialogFromUrl(nsIMsgMailNewsUrl *aMsgUrl,</span>
<a href="#l28.538"></a><span id="l28.538" class="difflineplus">+                                               nsIPrompt **aPromptDialog) {</span>
<a href="#l28.539"></a><span id="l28.539" class="difflineplus">+  // get the nsIPrompt interface from the message window associated wit this</span>
<a href="#l28.540"></a><span id="l28.540" class="difflineplus">+  // url.</span>
<a href="#l28.541"></a><span id="l28.541">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l28.542"></a><span id="l28.542">   aMsgUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l28.543"></a><span id="l28.543">   NS_ENSURE_TRUE(msgWindow, NS_ERROR_FAILURE);</span>
<a href="#l28.544"></a><span id="l28.544"> </span>
<a href="#l28.545"></a><span id="l28.545">   msgWindow-&gt;GetPromptDialog(aPromptDialog);</span>
<a href="#l28.546"></a><span id="l28.546"> </span>
<a href="#l28.547"></a><span id="l28.547">   NS_ENSURE_TRUE(*aPromptDialog, NS_ERROR_FAILURE);</span>
<a href="#l28.548"></a><span id="l28.548"> </span>
<a href="#l28.549"></a><span id="l28.549">   return NS_OK;</span>
<a href="#l28.550"></a><span id="l28.550"> }</span>
<a href="#l28.551"></a><span id="l28.551"> </span>
<a href="#l28.552"></a><span id="l28.552" class="difflineminus">-nsresult nsMsgProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer)</span>
<a href="#l28.553"></a><span id="l28.553" class="difflineminus">-{</span>
<a href="#l28.554"></a><span id="l28.554" class="difflineplus">+nsresult nsMsgProtocol::LoadUrl(nsIURI *aURL, nsISupports *aConsumer) {</span>
<a href="#l28.555"></a><span id="l28.555">   // okay now kick us off to the next state...</span>
<a href="#l28.556"></a><span id="l28.556">   // our first state is a process state so drive the state machine...</span>
<a href="#l28.557"></a><span id="l28.557">   nsresult rv = NS_OK;</span>
<a href="#l28.558"></a><span id="l28.558" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; aMsgUrl = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l28.559"></a><span id="l28.559" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; aMsgUrl = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l28.560"></a><span id="l28.560"> </span>
<a href="#l28.561"></a><span id="l28.561" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; aMsgUrl)</span>
<a href="#l28.562"></a><span id="l28.562" class="difflineminus">-  {</span>
<a href="#l28.563"></a><span id="l28.563" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; aMsgUrl) {</span>
<a href="#l28.564"></a><span id="l28.564">     bool msgIsInLocalCache;</span>
<a href="#l28.565"></a><span id="l28.565">     aMsgUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInLocalCache);</span>
<a href="#l28.566"></a><span id="l28.566"> </span>
<a href="#l28.567"></a><span id="l28.567" class="difflineminus">-    rv = aMsgUrl-&gt;SetUrlState(true, NS_OK); // set the url as a url currently being run...</span>
<a href="#l28.568"></a><span id="l28.568" class="difflineplus">+    // Set the url as a url currently being run...</span>
<a href="#l28.569"></a><span id="l28.569" class="difflineplus">+    rv = aMsgUrl-&gt;SetUrlState(true, NS_OK);</span>
<a href="#l28.570"></a><span id="l28.570"> </span>
<a href="#l28.571"></a><span id="l28.571" class="difflineminus">-    // if the url is given a stream consumer then we should use it to forward calls to...</span>
<a href="#l28.572"></a><span id="l28.572" class="difflineminus">-    if (!m_channelListener &amp;&amp; aConsumer) // if we don't have a registered listener already</span>
<a href="#l28.573"></a><span id="l28.573" class="difflineplus">+    // if the url is given a stream consumer then we should use it to forward</span>
<a href="#l28.574"></a><span id="l28.574" class="difflineplus">+    // calls to...</span>
<a href="#l28.575"></a><span id="l28.575" class="difflineplus">+    if (!m_channelListener &amp;&amp;</span>
<a href="#l28.576"></a><span id="l28.576" class="difflineplus">+        aConsumer)  // if we don't have a registered listener already</span>
<a href="#l28.577"></a><span id="l28.577">     {</span>
<a href="#l28.578"></a><span id="l28.578">       m_channelListener = do_QueryInterface(aConsumer);</span>
<a href="#l28.579"></a><span id="l28.579" class="difflineminus">-      if (!m_channelContext)</span>
<a href="#l28.580"></a><span id="l28.580" class="difflineminus">-        m_channelContext = do_QueryInterface(aURL);</span>
<a href="#l28.581"></a><span id="l28.581" class="difflineplus">+      if (!m_channelContext) m_channelContext = do_QueryInterface(aURL);</span>
<a href="#l28.582"></a><span id="l28.582">     }</span>
<a href="#l28.583"></a><span id="l28.583"> </span>
<a href="#l28.584"></a><span id="l28.584" class="difflineminus">-    if (!m_socketIsOpen)</span>
<a href="#l28.585"></a><span id="l28.585" class="difflineminus">-    {</span>
<a href="#l28.586"></a><span id="l28.586" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; urlSupports = do_QueryInterface(aURL);</span>
<a href="#l28.587"></a><span id="l28.587" class="difflineminus">-      if (m_transport)</span>
<a href="#l28.588"></a><span id="l28.588" class="difflineminus">-      {</span>
<a href="#l28.589"></a><span id="l28.589" class="difflineplus">+    if (!m_socketIsOpen) {</span>
<a href="#l28.590"></a><span id="l28.590" class="difflineplus">+      if (m_transport) {</span>
<a href="#l28.591"></a><span id="l28.591">         // open buffered, asynchronous input stream</span>
<a href="#l28.592"></a><span id="l28.592">         nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l28.593"></a><span id="l28.593">         rv = m_transport-&gt;OpenInputStream(0, 0, 0, getter_AddRefs(stream));</span>
<a href="#l28.594"></a><span id="l28.594" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l28.595"></a><span id="l28.595" class="difflineminus">-          return rv;</span>
<a href="#l28.596"></a><span id="l28.596" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.597"></a><span id="l28.597"> </span>
<a href="#l28.598"></a><span id="l28.598">         // m_readCount can be -1 which means &quot;read as much as we can&quot;.</span>
<a href="#l28.599"></a><span id="l28.599">         // We pass this on as UINT64_MAX, which is in fact uint64_t(-1).</span>
<a href="#l28.600"></a><span id="l28.600">         // We don't clone m_inputStream here, we simply give up ownership</span>
<a href="#l28.601"></a><span id="l28.601">         // since otherwise the original would never be closed.</span>
<a href="#l28.602"></a><span id="l28.602" class="difflineminus">-        RefPtr&lt;SlicedInputStream&gt; slicedStream =</span>
<a href="#l28.603"></a><span id="l28.603" class="difflineminus">-          new SlicedInputStream(stream.forget(), 0,</span>
<a href="#l28.604"></a><span id="l28.604" class="difflineminus">-                                m_readCount == -1 ? UINT64_MAX : uint64_t(m_readCount));</span>
<a href="#l28.605"></a><span id="l28.605" class="difflineplus">+        RefPtr&lt;SlicedInputStream&gt; slicedStream = new SlicedInputStream(</span>
<a href="#l28.606"></a><span id="l28.606" class="difflineplus">+            stream.forget(), 0,</span>
<a href="#l28.607"></a><span id="l28.607" class="difflineplus">+            m_readCount == -1 ? UINT64_MAX : uint64_t(m_readCount));</span>
<a href="#l28.608"></a><span id="l28.608">         nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l28.609"></a><span id="l28.609">         rv = NS_NewInputStreamPump(getter_AddRefs(pump), slicedStream.forget());</span>
<a href="#l28.610"></a><span id="l28.610">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.611"></a><span id="l28.611"> </span>
<a href="#l28.612"></a><span id="l28.612" class="difflineminus">-        m_request = pump; // keep a reference to the pump so we can cancel it</span>
<a href="#l28.613"></a><span id="l28.613" class="difflineplus">+        m_request = pump;  // keep a reference to the pump so we can cancel it</span>
<a href="#l28.614"></a><span id="l28.614"> </span>
<a href="#l28.615"></a><span id="l28.615">         // put us in a state where we are always notified of incoming data</span>
<a href="#l28.616"></a><span id="l28.616" class="difflineminus">-        rv = pump-&gt;AsyncRead(this, urlSupports);</span>
<a href="#l28.617"></a><span id="l28.617" class="difflineplus">+        rv = pump-&gt;AsyncRead(this, nullptr);</span>
<a href="#l28.618"></a><span id="l28.618">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;AsyncRead failed&quot;);</span>
<a href="#l28.619"></a><span id="l28.619" class="difflineminus">-        m_socketIsOpen = true; // mark the channel as open</span>
<a href="#l28.620"></a><span id="l28.620" class="difflineplus">+        m_socketIsOpen = true;  // mark the channel as open</span>
<a href="#l28.621"></a><span id="l28.621">       }</span>
<a href="#l28.622"></a><span id="l28.622" class="difflineminus">-    } // if we got an event queue service</span>
<a href="#l28.623"></a><span id="l28.623" class="difflineminus">-    else if (!msgIsInLocalCache) // the connection is already open so we should begin processing our new url...</span>
<a href="#l28.624"></a><span id="l28.624" class="difflineplus">+    } else if (!msgIsInLocalCache) {</span>
<a href="#l28.625"></a><span id="l28.625" class="difflineplus">+      // The connection is already open so we should begin processing our url.</span>
<a href="#l28.626"></a><span id="l28.626">       rv = ProcessProtocolState(aURL, nullptr, 0, 0);</span>
<a href="#l28.627"></a><span id="l28.627" class="difflineplus">+    }</span>
<a href="#l28.628"></a><span id="l28.628">   }</span>
<a href="#l28.629"></a><span id="l28.629"> </span>
<a href="#l28.630"></a><span id="l28.630">   return rv;</span>
<a href="#l28.631"></a><span id="l28.631"> }</span>
<a href="#l28.632"></a><span id="l28.632"> </span>
<a href="#l28.633"></a><span id="l28.633"> ///////////////////////////////////////////////////////////////////////</span>
<a href="#l28.634"></a><span id="l28.634"> // The rest of this file is mostly nsIChannel mumbo jumbo stuff</span>
<a href="#l28.635"></a><span id="l28.635"> ///////////////////////////////////////////////////////////////////////</span>
<a href="#l28.636"></a><span id="l28.636"> </span>
<a href="#l28.637"></a><span id="l28.637" class="difflineminus">-nsresult nsMsgProtocol::SetUrl(nsIURI * aURL)</span>
<a href="#l28.638"></a><span id="l28.638" class="difflineminus">-{</span>
<a href="#l28.639"></a><span id="l28.639" class="difflineplus">+nsresult nsMsgProtocol::SetUrl(nsIURI *aURL) {</span>
<a href="#l28.640"></a><span id="l28.640">   m_url = aURL;</span>
<a href="#l28.641"></a><span id="l28.641">   return NS_OK;</span>
<a href="#l28.642"></a><span id="l28.642"> }</span>
<a href="#l28.643"></a><span id="l28.643"> </span>
<a href="#l28.644"></a><span id="l28.644" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetLoadGroup(nsILoadGroup * aLoadGroup)</span>
<a href="#l28.645"></a><span id="l28.645" class="difflineminus">-{</span>
<a href="#l28.646"></a><span id="l28.646" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetLoadGroup(nsILoadGroup *aLoadGroup) {</span>
<a href="#l28.647"></a><span id="l28.647">   m_loadGroup = aLoadGroup;</span>
<a href="#l28.648"></a><span id="l28.648">   return NS_OK;</span>
<a href="#l28.649"></a><span id="l28.649"> }</span>
<a href="#l28.650"></a><span id="l28.650"> </span>
<a href="#l28.651"></a><span id="l28.651" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetOriginalURI(nsIURI* *aURI)</span>
<a href="#l28.652"></a><span id="l28.652" class="difflineminus">-{</span>
<a href="#l28.653"></a><span id="l28.653" class="difflineminus">-    NS_IF_ADDREF(*aURI = m_originalUrl ? m_originalUrl : m_url);</span>
<a href="#l28.654"></a><span id="l28.654" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.655"></a><span id="l28.655" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetOriginalURI(nsIURI **aURI) {</span>
<a href="#l28.656"></a><span id="l28.656" class="difflineplus">+  NS_IF_ADDREF(*aURI = m_originalUrl ? m_originalUrl : m_url);</span>
<a href="#l28.657"></a><span id="l28.657" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.658"></a><span id="l28.658" class="difflineplus">+}</span>
<a href="#l28.659"></a><span id="l28.659" class="difflineplus">+</span>
<a href="#l28.660"></a><span id="l28.660" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetOriginalURI(nsIURI *aURI) {</span>
<a href="#l28.661"></a><span id="l28.661" class="difflineplus">+  m_originalUrl = aURI;</span>
<a href="#l28.662"></a><span id="l28.662" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.663"></a><span id="l28.663"> }</span>
<a href="#l28.664"></a><span id="l28.664"> </span>
<a href="#l28.665"></a><span id="l28.665" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetOriginalURI(nsIURI* aURI)</span>
<a href="#l28.666"></a><span id="l28.666" class="difflineminus">-{</span>
<a href="#l28.667"></a><span id="l28.667" class="difflineminus">-    m_originalUrl = aURI;</span>
<a href="#l28.668"></a><span id="l28.668" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.669"></a><span id="l28.669" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetURI(nsIURI **aURI) {</span>
<a href="#l28.670"></a><span id="l28.670" class="difflineplus">+  NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l28.671"></a><span id="l28.671" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.672"></a><span id="l28.672"> }</span>
<a href="#l28.673"></a><span id="l28.673"> </span>
<a href="#l28.674"></a><span id="l28.674" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetURI(nsIURI* *aURI)</span>
<a href="#l28.675"></a><span id="l28.675" class="difflineminus">-{</span>
<a href="#l28.676"></a><span id="l28.676" class="difflineminus">-    NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l28.677"></a><span id="l28.677" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.678"></a><span id="l28.678" class="difflineminus">-}</span>
<a href="#l28.679"></a><span id="l28.679" class="difflineminus">-</span>
<a href="#l28.680"></a><span id="l28.680" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::Open(nsIInputStream **_retval)</span>
<a href="#l28.681"></a><span id="l28.681" class="difflineminus">-{</span>
<a href="#l28.682"></a><span id="l28.682" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::Open(nsIInputStream **_retval) {</span>
<a href="#l28.683"></a><span id="l28.683">   nsCOMPtr&lt;nsIStreamListener&gt; listener;</span>
<a href="#l28.684"></a><span id="l28.684" class="difflineminus">-  nsresult rv = nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l28.685"></a><span id="l28.685" class="difflineplus">+  nsresult rv =</span>
<a href="#l28.686"></a><span id="l28.686" class="difflineplus">+      nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l28.687"></a><span id="l28.687">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.688"></a><span id="l28.688">   return NS_ImplementChannelOpen(this, _retval);</span>
<a href="#l28.689"></a><span id="l28.689"> }</span>
<a href="#l28.690"></a><span id="l28.690"> </span>
<a href="#l28.691"></a><span id="l28.691" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::AsyncOpen(nsIStreamListener *aListener)</span>
<a href="#l28.692"></a><span id="l28.692" class="difflineminus">-{</span>
<a href="#l28.693"></a><span id="l28.693" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; listener = aListener;</span>
<a href="#l28.694"></a><span id="l28.694" class="difflineminus">-    nsresult rv = nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l28.695"></a><span id="l28.695" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.696"></a><span id="l28.696" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::AsyncOpen(nsIStreamListener *aListener) {</span>
<a href="#l28.697"></a><span id="l28.697" class="difflineplus">+  nsCOMPtr&lt;nsIStreamListener&gt; listener = aListener;</span>
<a href="#l28.698"></a><span id="l28.698" class="difflineplus">+  nsresult rv =</span>
<a href="#l28.699"></a><span id="l28.699" class="difflineplus">+      nsContentSecurityManager::doContentSecurityCheck(this, listener);</span>
<a href="#l28.700"></a><span id="l28.700" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.701"></a><span id="l28.701"> </span>
<a href="#l28.702"></a><span id="l28.702" class="difflineminus">-    int32_t port;</span>
<a href="#l28.703"></a><span id="l28.703" class="difflineminus">-    rv = m_url-&gt;GetPort(&amp;port);</span>
<a href="#l28.704"></a><span id="l28.704" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l28.705"></a><span id="l28.705" class="difflineminus">-        return rv;</span>
<a href="#l28.706"></a><span id="l28.706" class="difflineplus">+  int32_t port;</span>
<a href="#l28.707"></a><span id="l28.707" class="difflineplus">+  rv = m_url-&gt;GetPort(&amp;port);</span>
<a href="#l28.708"></a><span id="l28.708" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.709"></a><span id="l28.709"> </span>
<a href="#l28.710"></a><span id="l28.710" class="difflineminus">-    nsAutoCString scheme;</span>
<a href="#l28.711"></a><span id="l28.711" class="difflineminus">-    rv = m_url-&gt;GetScheme(scheme);</span>
<a href="#l28.712"></a><span id="l28.712" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l28.713"></a><span id="l28.713" class="difflineminus">-        return rv;</span>
<a href="#l28.714"></a><span id="l28.714" class="difflineplus">+  nsAutoCString scheme;</span>
<a href="#l28.715"></a><span id="l28.715" class="difflineplus">+  rv = m_url-&gt;GetScheme(scheme);</span>
<a href="#l28.716"></a><span id="l28.716" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.717"></a><span id="l28.717"> </span>
<a href="#l28.718"></a><span id="l28.718" class="difflineminus">-</span>
<a href="#l28.719"></a><span id="l28.719" class="difflineminus">-    rv = NS_CheckPortSafety(port, scheme.get());</span>
<a href="#l28.720"></a><span id="l28.720" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l28.721"></a><span id="l28.721" class="difflineminus">-        return rv;</span>
<a href="#l28.722"></a><span id="l28.722" class="difflineplus">+  rv = NS_CheckPortSafety(port, scheme.get());</span>
<a href="#l28.723"></a><span id="l28.723" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.724"></a><span id="l28.724"> </span>
<a href="#l28.725"></a><span id="l28.725" class="difflineminus">-    // set the stream listener and then load the url</span>
<a href="#l28.726"></a><span id="l28.726" class="difflineminus">-    m_channelContext = nullptr;</span>
<a href="#l28.727"></a><span id="l28.727" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l28.728"></a><span id="l28.728" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l28.729"></a><span id="l28.729" class="difflineminus">-    GetURI(getter_AddRefs(uri));</span>
<a href="#l28.730"></a><span id="l28.730" class="difflineminus">-    m_channelContext = uri;</span>
<a href="#l28.731"></a><span id="l28.731" class="difflineplus">+  // set the stream listener and then load the url</span>
<a href="#l28.732"></a><span id="l28.732" class="difflineplus">+  m_channelContext = nullptr;</span>
<a href="#l28.733"></a><span id="l28.733" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l28.734"></a><span id="l28.734" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l28.735"></a><span id="l28.735" class="difflineplus">+  GetURI(getter_AddRefs(uri));</span>
<a href="#l28.736"></a><span id="l28.736" class="difflineplus">+  m_channelContext = uri;</span>
<a href="#l28.737"></a><span id="l28.737"> </span>
<a href="#l28.738"></a><span id="l28.738" class="difflineminus">-    m_channelListener = listener;</span>
<a href="#l28.739"></a><span id="l28.739" class="difflineminus">-    return LoadUrl(m_url, nullptr);</span>
<a href="#l28.740"></a><span id="l28.740" class="difflineplus">+  m_channelListener = listener;</span>
<a href="#l28.741"></a><span id="l28.741" class="difflineplus">+  return LoadUrl(m_url, nullptr);</span>
<a href="#l28.742"></a><span id="l28.742"> }</span>
<a href="#l28.743"></a><span id="l28.743"> </span>
<a href="#l28.744"></a><span id="l28.744" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetLoadFlags(nsLoadFlags *aLoadFlags)</span>
<a href="#l28.745"></a><span id="l28.745" class="difflineminus">-{</span>
<a href="#l28.746"></a><span id="l28.746" class="difflineminus">-    *aLoadFlags = mLoadFlags;</span>
<a href="#l28.747"></a><span id="l28.747" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.748"></a><span id="l28.748" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetLoadFlags(nsLoadFlags *aLoadFlags) {</span>
<a href="#l28.749"></a><span id="l28.749" class="difflineplus">+  *aLoadFlags = mLoadFlags;</span>
<a href="#l28.750"></a><span id="l28.750" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.751"></a><span id="l28.751"> }</span>
<a href="#l28.752"></a><span id="l28.752"> </span>
<a href="#l28.753"></a><span id="l28.753" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetLoadFlags(nsLoadFlags aLoadFlags)</span>
<a href="#l28.754"></a><span id="l28.754" class="difflineminus">-{</span>
<a href="#l28.755"></a><span id="l28.755" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetLoadFlags(nsLoadFlags aLoadFlags) {</span>
<a href="#l28.756"></a><span id="l28.756">   mLoadFlags = aLoadFlags;</span>
<a href="#l28.757"></a><span id="l28.757" class="difflineminus">-  return NS_OK;       // don't fail when trying to set this</span>
<a href="#l28.758"></a><span id="l28.758" class="difflineplus">+  return NS_OK;  // don't fail when trying to set this</span>
<a href="#l28.759"></a><span id="l28.759"> }</span>
<a href="#l28.760"></a><span id="l28.760"> </span>
<a href="#l28.761"></a><span id="l28.761" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetContentType(nsACString &amp;aContentType)</span>
<a href="#l28.762"></a><span id="l28.762" class="difflineminus">-{</span>
<a href="#l28.763"></a><span id="l28.763" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetContentType(nsACString &amp;aContentType) {</span>
<a href="#l28.764"></a><span id="l28.764">   // as url dispatching matures, we'll be intelligent and actually start</span>
<a href="#l28.765"></a><span id="l28.765">   // opening the url before specifying the content type. This will allow</span>
<a href="#l28.766"></a><span id="l28.766">   // us to optimize the case where the message url actual refers to</span>
<a href="#l28.767"></a><span id="l28.767">   // a part in the message that has a content type that is not message/rfc822</span>
<a href="#l28.768"></a><span id="l28.768"> </span>
<a href="#l28.769"></a><span id="l28.769">   if (mContentType.IsEmpty())</span>
<a href="#l28.770"></a><span id="l28.770">     aContentType.AssignLiteral(&quot;message/rfc822&quot;);</span>
<a href="#l28.771"></a><span id="l28.771">   else</span>
<a href="#l28.772"></a><span id="l28.772">     aContentType = mContentType;</span>
<a href="#l28.773"></a><span id="l28.773">   return NS_OK;</span>
<a href="#l28.774"></a><span id="l28.774"> }</span>
<a href="#l28.775"></a><span id="l28.775"> </span>
<a href="#l28.776"></a><span id="l28.776" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetContentType(const nsACString &amp;aContentType)</span>
<a href="#l28.777"></a><span id="l28.777" class="difflineminus">-{</span>
<a href="#l28.778"></a><span id="l28.778" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetContentType(const nsACString &amp;aContentType) {</span>
<a href="#l28.779"></a><span id="l28.779">   nsAutoCString charset;</span>
<a href="#l28.780"></a><span id="l28.780" class="difflineminus">-  nsresult rv = NS_ParseResponseContentType(aContentType, mContentType, charset);</span>
<a href="#l28.781"></a><span id="l28.781" class="difflineplus">+  nsresult rv =</span>
<a href="#l28.782"></a><span id="l28.782" class="difflineplus">+      NS_ParseResponseContentType(aContentType, mContentType, charset);</span>
<a href="#l28.783"></a><span id="l28.783">   if (NS_FAILED(rv) || mContentType.IsEmpty())</span>
<a href="#l28.784"></a><span id="l28.784">     mContentType.AssignLiteral(UNKNOWN_CONTENT_TYPE);</span>
<a href="#l28.785"></a><span id="l28.785">   return rv;</span>
<a href="#l28.786"></a><span id="l28.786"> }</span>
<a href="#l28.787"></a><span id="l28.787"> </span>
<a href="#l28.788"></a><span id="l28.788" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetContentCharset(nsACString &amp;aContentCharset)</span>
<a href="#l28.789"></a><span id="l28.789" class="difflineminus">-{</span>
<a href="#l28.790"></a><span id="l28.790" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetContentCharset(nsACString &amp;aContentCharset) {</span>
<a href="#l28.791"></a><span id="l28.791">   aContentCharset.Assign(mCharset);</span>
<a href="#l28.792"></a><span id="l28.792">   return NS_OK;</span>
<a href="#l28.793"></a><span id="l28.793"> }</span>
<a href="#l28.794"></a><span id="l28.794"> </span>
<a href="#l28.795"></a><span id="l28.795" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetContentCharset(const nsACString &amp;aContentCharset)</span>
<a href="#l28.796"></a><span id="l28.796" class="difflineminus">-{</span>
<a href="#l28.797"></a><span id="l28.797" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetContentCharset(</span>
<a href="#l28.798"></a><span id="l28.798" class="difflineplus">+    const nsACString &amp;aContentCharset) {</span>
<a href="#l28.799"></a><span id="l28.799">   mCharset.Assign(aContentCharset);</span>
<a href="#l28.800"></a><span id="l28.800">   return NS_OK;</span>
<a href="#l28.801"></a><span id="l28.801"> }</span>
<a href="#l28.802"></a><span id="l28.802"> </span>
<a href="#l28.803"></a><span id="l28.803"> NS_IMETHODIMP</span>
<a href="#l28.804"></a><span id="l28.804" class="difflineminus">-nsMsgProtocol::GetContentDisposition(uint32_t *aContentDisposition)</span>
<a href="#l28.805"></a><span id="l28.805" class="difflineminus">-{</span>
<a href="#l28.806"></a><span id="l28.806" class="difflineplus">+nsMsgProtocol::GetContentDisposition(uint32_t *aContentDisposition) {</span>
<a href="#l28.807"></a><span id="l28.807">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.808"></a><span id="l28.808"> }</span>
<a href="#l28.809"></a><span id="l28.809"> </span>
<a href="#l28.810"></a><span id="l28.810"> NS_IMETHODIMP</span>
<a href="#l28.811"></a><span id="l28.811" class="difflineminus">-nsMsgProtocol::SetContentDisposition(uint32_t aContentDisposition)</span>
<a href="#l28.812"></a><span id="l28.812" class="difflineminus">-{</span>
<a href="#l28.813"></a><span id="l28.813" class="difflineplus">+nsMsgProtocol::SetContentDisposition(uint32_t aContentDisposition) {</span>
<a href="#l28.814"></a><span id="l28.814">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.815"></a><span id="l28.815"> }</span>
<a href="#l28.816"></a><span id="l28.816"> </span>
<a href="#l28.817"></a><span id="l28.817"> NS_IMETHODIMP</span>
<a href="#l28.818"></a><span id="l28.818" class="difflineminus">-nsMsgProtocol::GetContentDispositionFilename(nsAString &amp;aContentDispositionFilename)</span>
<a href="#l28.819"></a><span id="l28.819" class="difflineminus">-{</span>
<a href="#l28.820"></a><span id="l28.820" class="difflineplus">+nsMsgProtocol::GetContentDispositionFilename(</span>
<a href="#l28.821"></a><span id="l28.821" class="difflineplus">+    nsAString &amp;aContentDispositionFilename) {</span>
<a href="#l28.822"></a><span id="l28.822">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.823"></a><span id="l28.823"> }</span>
<a href="#l28.824"></a><span id="l28.824"> </span>
<a href="#l28.825"></a><span id="l28.825"> NS_IMETHODIMP</span>
<a href="#l28.826"></a><span id="l28.826" class="difflineminus">-nsMsgProtocol::SetContentDispositionFilename(const nsAString &amp;aContentDispositionFilename)</span>
<a href="#l28.827"></a><span id="l28.827" class="difflineminus">-{</span>
<a href="#l28.828"></a><span id="l28.828" class="difflineplus">+nsMsgProtocol::SetContentDispositionFilename(</span>
<a href="#l28.829"></a><span id="l28.829" class="difflineplus">+    const nsAString &amp;aContentDispositionFilename) {</span>
<a href="#l28.830"></a><span id="l28.830">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.831"></a><span id="l28.831"> }</span>
<a href="#l28.832"></a><span id="l28.832"> </span>
<a href="#l28.833"></a><span id="l28.833"> NS_IMETHODIMP</span>
<a href="#l28.834"></a><span id="l28.834" class="difflineminus">-nsMsgProtocol::GetContentDispositionHeader(nsACString &amp;aContentDispositionHeader)</span>
<a href="#l28.835"></a><span id="l28.835" class="difflineminus">-{</span>
<a href="#l28.836"></a><span id="l28.836" class="difflineplus">+nsMsgProtocol::GetContentDispositionHeader(</span>
<a href="#l28.837"></a><span id="l28.837" class="difflineplus">+    nsACString &amp;aContentDispositionHeader) {</span>
<a href="#l28.838"></a><span id="l28.838">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.839"></a><span id="l28.839"> }</span>
<a href="#l28.840"></a><span id="l28.840"> </span>
<a href="#l28.841"></a><span id="l28.841" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetContentLength(int64_t *aContentLength)</span>
<a href="#l28.842"></a><span id="l28.842" class="difflineminus">-{</span>
<a href="#l28.843"></a><span id="l28.843" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetContentLength(int64_t *aContentLength) {</span>
<a href="#l28.844"></a><span id="l28.844">   *aContentLength = mContentLength;</span>
<a href="#l28.845"></a><span id="l28.845">   return NS_OK;</span>
<a href="#l28.846"></a><span id="l28.846"> }</span>
<a href="#l28.847"></a><span id="l28.847"> </span>
<a href="#l28.848"></a><span id="l28.848" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetContentLength(int64_t aContentLength)</span>
<a href="#l28.849"></a><span id="l28.849" class="difflineminus">-{</span>
<a href="#l28.850"></a><span id="l28.850" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetContentLength(int64_t aContentLength) {</span>
<a href="#l28.851"></a><span id="l28.851">   mContentLength = aContentLength;</span>
<a href="#l28.852"></a><span id="l28.852">   return NS_OK;</span>
<a href="#l28.853"></a><span id="l28.853"> }</span>
<a href="#l28.854"></a><span id="l28.854"> </span>
<a href="#l28.855"></a><span id="l28.855" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetSecurityInfo(nsISupports * *aSecurityInfo)</span>
<a href="#l28.856"></a><span id="l28.856" class="difflineminus">-{</span>
<a href="#l28.857"></a><span id="l28.857" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetSecurityInfo(nsISupports **aSecurityInfo) {</span>
<a href="#l28.858"></a><span id="l28.858">   *aSecurityInfo = nullptr;</span>
<a href="#l28.859"></a><span id="l28.859">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l28.860"></a><span id="l28.860"> }</span>
<a href="#l28.861"></a><span id="l28.861"> </span>
<a href="#l28.862"></a><span id="l28.862" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetName(nsACString &amp;result)</span>
<a href="#l28.863"></a><span id="l28.863" class="difflineminus">-{</span>
<a href="#l28.864"></a><span id="l28.864" class="difflineminus">-  if (m_url)</span>
<a href="#l28.865"></a><span id="l28.865" class="difflineminus">-    return m_url-&gt;GetSpec(result);</span>
<a href="#l28.866"></a><span id="l28.866" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetName(nsACString &amp;result) {</span>
<a href="#l28.867"></a><span id="l28.867" class="difflineplus">+  if (m_url) return m_url-&gt;GetSpec(result);</span>
<a href="#l28.868"></a><span id="l28.868">   result.Truncate();</span>
<a href="#l28.869"></a><span id="l28.869">   return NS_OK;</span>
<a href="#l28.870"></a><span id="l28.870"> }</span>
<a href="#l28.871"></a><span id="l28.871"> </span>
<a href="#l28.872"></a><span id="l28.872" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetOwner(nsISupports * *aPrincipal)</span>
<a href="#l28.873"></a><span id="l28.873" class="difflineminus">-{</span>
<a href="#l28.874"></a><span id="l28.874" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetOwner(nsISupports **aPrincipal) {</span>
<a href="#l28.875"></a><span id="l28.875">   NS_IF_ADDREF(*aPrincipal = mOwner);</span>
<a href="#l28.876"></a><span id="l28.876">   return NS_OK;</span>
<a href="#l28.877"></a><span id="l28.877"> }</span>
<a href="#l28.878"></a><span id="l28.878"> </span>
<a href="#l28.879"></a><span id="l28.879" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetOwner(nsISupports * aPrincipal)</span>
<a href="#l28.880"></a><span id="l28.880" class="difflineminus">-{</span>
<a href="#l28.881"></a><span id="l28.881" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetOwner(nsISupports *aPrincipal) {</span>
<a href="#l28.882"></a><span id="l28.882">   mOwner = aPrincipal;</span>
<a href="#l28.883"></a><span id="l28.883">   return NS_OK;</span>
<a href="#l28.884"></a><span id="l28.884"> }</span>
<a href="#l28.885"></a><span id="l28.885"> </span>
<a href="#l28.886"></a><span id="l28.886" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetLoadGroup(nsILoadGroup * *aLoadGroup)</span>
<a href="#l28.887"></a><span id="l28.887" class="difflineminus">-{</span>
<a href="#l28.888"></a><span id="l28.888" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetLoadGroup(nsILoadGroup **aLoadGroup) {</span>
<a href="#l28.889"></a><span id="l28.889">   NS_IF_ADDREF(*aLoadGroup = m_loadGroup);</span>
<a href="#l28.890"></a><span id="l28.890">   return NS_OK;</span>
<a href="#l28.891"></a><span id="l28.891"> }</span>
<a href="#l28.892"></a><span id="l28.892"> </span>
<a href="#l28.893"></a><span id="l28.893" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetLoadInfo(nsILoadInfo **aLoadInfo)</span>
<a href="#l28.894"></a><span id="l28.894" class="difflineminus">-{</span>
<a href="#l28.895"></a><span id="l28.895" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetLoadInfo(nsILoadInfo **aLoadInfo) {</span>
<a href="#l28.896"></a><span id="l28.896">   NS_IF_ADDREF(*aLoadInfo = m_loadInfo);</span>
<a href="#l28.897"></a><span id="l28.897">   return NS_OK;</span>
<a href="#l28.898"></a><span id="l28.898"> }</span>
<a href="#l28.899"></a><span id="l28.899"> </span>
<a href="#l28.900"></a><span id="l28.900" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::SetLoadInfo(nsILoadInfo *aLoadInfo)</span>
<a href="#l28.901"></a><span id="l28.901" class="difflineminus">-{</span>
<a href="#l28.902"></a><span id="l28.902" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetLoadInfo(nsILoadInfo *aLoadInfo) {</span>
<a href="#l28.903"></a><span id="l28.903">   m_loadInfo = aLoadInfo;</span>
<a href="#l28.904"></a><span id="l28.904">   return NS_OK;</span>
<a href="#l28.905"></a><span id="l28.905"> }</span>
<a href="#l28.906"></a><span id="l28.906"> </span>
<a href="#l28.907"></a><span id="l28.907"> NS_IMETHODIMP</span>
<a href="#l28.908"></a><span id="l28.908" class="difflineminus">-nsMsgProtocol::GetNotificationCallbacks(nsIInterfaceRequestor* *aNotificationCallbacks)</span>
<a href="#l28.909"></a><span id="l28.909" class="difflineminus">-{</span>
<a href="#l28.910"></a><span id="l28.910" class="difflineplus">+nsMsgProtocol::GetNotificationCallbacks(</span>
<a href="#l28.911"></a><span id="l28.911" class="difflineplus">+    nsIInterfaceRequestor **aNotificationCallbacks) {</span>
<a href="#l28.912"></a><span id="l28.912">   NS_IF_ADDREF(*aNotificationCallbacks = mCallbacks.get());</span>
<a href="#l28.913"></a><span id="l28.913">   return NS_OK;</span>
<a href="#l28.914"></a><span id="l28.914"> }</span>
<a href="#l28.915"></a><span id="l28.915"> </span>
<a href="#l28.916"></a><span id="l28.916"> NS_IMETHODIMP</span>
<a href="#l28.917"></a><span id="l28.917" class="difflineminus">-nsMsgProtocol::SetNotificationCallbacks(nsIInterfaceRequestor* aNotificationCallbacks)</span>
<a href="#l28.918"></a><span id="l28.918" class="difflineminus">-{</span>
<a href="#l28.919"></a><span id="l28.919" class="difflineplus">+nsMsgProtocol::SetNotificationCallbacks(</span>
<a href="#l28.920"></a><span id="l28.920" class="difflineplus">+    nsIInterfaceRequestor *aNotificationCallbacks) {</span>
<a href="#l28.921"></a><span id="l28.921">   mCallbacks = aNotificationCallbacks;</span>
<a href="#l28.922"></a><span id="l28.922">   return NS_OK;</span>
<a href="#l28.923"></a><span id="l28.923"> }</span>
<a href="#l28.924"></a><span id="l28.924"> </span>
<a href="#l28.925"></a><span id="l28.925"> NS_IMETHODIMP</span>
<a href="#l28.926"></a><span id="l28.926"> nsMsgProtocol::OnTransportStatus(nsITransport *transport, nsresult status,</span>
<a href="#l28.927"></a><span id="l28.927" class="difflineminus">-                                 int64_t progress, int64_t progressMax)</span>
<a href="#l28.928"></a><span id="l28.928" class="difflineminus">-{</span>
<a href="#l28.929"></a><span id="l28.929" class="difflineminus">-  if ((mLoadFlags &amp; LOAD_BACKGROUND) || !m_url)</span>
<a href="#l28.930"></a><span id="l28.930" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.931"></a><span id="l28.931" class="difflineplus">+                                 int64_t progress, int64_t progressMax) {</span>
<a href="#l28.932"></a><span id="l28.932" class="difflineplus">+  if ((mLoadFlags &amp; LOAD_BACKGROUND) || !m_url) return NS_OK;</span>
<a href="#l28.933"></a><span id="l28.933"> </span>
<a href="#l28.934"></a><span id="l28.934">   // these transport events should not generate any status messages</span>
<a href="#l28.935"></a><span id="l28.935">   if (status == NS_NET_STATUS_RECEIVING_FROM ||</span>
<a href="#l28.936"></a><span id="l28.936">       status == NS_NET_STATUS_SENDING_TO)</span>
<a href="#l28.937"></a><span id="l28.937">     return NS_OK;</span>
<a href="#l28.938"></a><span id="l28.938"> </span>
<a href="#l28.939"></a><span id="l28.939" class="difflineminus">-  if (!mProgressEventSink)</span>
<a href="#l28.940"></a><span id="l28.940" class="difflineminus">-  {</span>
<a href="#l28.941"></a><span id="l28.941" class="difflineplus">+  if (!mProgressEventSink) {</span>
<a href="#l28.942"></a><span id="l28.942">     NS_QueryNotificationCallbacks(mCallbacks, m_loadGroup, mProgressEventSink);</span>
<a href="#l28.943"></a><span id="l28.943" class="difflineminus">-    if (!mProgressEventSink)</span>
<a href="#l28.944"></a><span id="l28.944" class="difflineminus">-      return NS_OK;</span>
<a href="#l28.945"></a><span id="l28.945" class="difflineplus">+    if (!mProgressEventSink) return NS_OK;</span>
<a href="#l28.946"></a><span id="l28.946">   }</span>
<a href="#l28.947"></a><span id="l28.947"> </span>
<a href="#l28.948"></a><span id="l28.948">   nsAutoCString host;</span>
<a href="#l28.949"></a><span id="l28.949">   m_url-&gt;GetHost(host);</span>
<a href="#l28.950"></a><span id="l28.950"> </span>
<a href="#l28.951"></a><span id="l28.951">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l28.952"></a><span id="l28.952" class="difflineminus">-  if (mailnewsUrl)</span>
<a href="#l28.953"></a><span id="l28.953" class="difflineminus">-  {</span>
<a href="#l28.954"></a><span id="l28.954" class="difflineplus">+  if (mailnewsUrl) {</span>
<a href="#l28.955"></a><span id="l28.955">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l28.956"></a><span id="l28.956">     mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l28.957"></a><span id="l28.957" class="difflineminus">-    if (server)</span>
<a href="#l28.958"></a><span id="l28.958" class="difflineminus">-      server-&gt;GetRealHostName(host);</span>
<a href="#l28.959"></a><span id="l28.959" class="difflineplus">+    if (server) server-&gt;GetRealHostName(host);</span>
<a href="#l28.960"></a><span id="l28.960">   }</span>
<a href="#l28.961"></a><span id="l28.961">   mProgressEventSink-&gt;OnStatus(this, nullptr, status,</span>
<a href="#l28.962"></a><span id="l28.962">                                NS_ConvertUTF8toUTF16(host).get());</span>
<a href="#l28.963"></a><span id="l28.963"> </span>
<a href="#l28.964"></a><span id="l28.964">   return NS_OK;</span>
<a href="#l28.965"></a><span id="l28.965"> }</span>
<a href="#l28.966"></a><span id="l28.966"> </span>
<a href="#l28.967"></a><span id="l28.967"> NS_IMETHODIMP</span>
<a href="#l28.968"></a><span id="l28.968" class="difflineminus">-nsMsgProtocol::GetIsDocument(bool *aIsDocument)</span>
<a href="#l28.969"></a><span id="l28.969" class="difflineminus">-{</span>
<a href="#l28.970"></a><span id="l28.970" class="difflineplus">+nsMsgProtocol::GetIsDocument(bool *aIsDocument) {</span>
<a href="#l28.971"></a><span id="l28.971">   return NS_GetIsDocumentChannel(this, aIsDocument);</span>
<a href="#l28.972"></a><span id="l28.972"> }</span>
<a href="#l28.973"></a><span id="l28.973"> </span>
<a href="#l28.974"></a><span id="l28.974"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.975"></a><span id="l28.975"> // From nsIRequest</span>
<a href="#l28.976"></a><span id="l28.976"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.977"></a><span id="l28.977"> </span>
<a href="#l28.978"></a><span id="l28.978" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::IsPending(bool *result)</span>
<a href="#l28.979"></a><span id="l28.979" class="difflineminus">-{</span>
<a href="#l28.980"></a><span id="l28.980" class="difflineminus">-    *result = m_channelListener != nullptr;</span>
<a href="#l28.981"></a><span id="l28.981" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.982"></a><span id="l28.982" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::IsPending(bool *result) {</span>
<a href="#l28.983"></a><span id="l28.983" class="difflineplus">+  *result = m_channelListener != nullptr;</span>
<a href="#l28.984"></a><span id="l28.984" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.985"></a><span id="l28.985"> }</span>
<a href="#l28.986"></a><span id="l28.986"> </span>
<a href="#l28.987"></a><span id="l28.987" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::GetStatus(nsresult *status)</span>
<a href="#l28.988"></a><span id="l28.988" class="difflineminus">-{</span>
<a href="#l28.989"></a><span id="l28.989" class="difflineminus">-  if (m_request)</span>
<a href="#l28.990"></a><span id="l28.990" class="difflineminus">-    return m_request-&gt;GetStatus(status);</span>
<a href="#l28.991"></a><span id="l28.991" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::GetStatus(nsresult *status) {</span>
<a href="#l28.992"></a><span id="l28.992" class="difflineplus">+  if (m_request) return m_request-&gt;GetStatus(status);</span>
<a href="#l28.993"></a><span id="l28.993"> </span>
<a href="#l28.994"></a><span id="l28.994">   *status = NS_OK;</span>
<a href="#l28.995"></a><span id="l28.995">   return *status;</span>
<a href="#l28.996"></a><span id="l28.996"> }</span>
<a href="#l28.997"></a><span id="l28.997"> </span>
<a href="#l28.998"></a><span id="l28.998" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::Cancel(nsresult status)</span>
<a href="#l28.999"></a><span id="l28.999" class="difflineminus">-{</span>
<a href="#l28.1000"></a><span id="l28.1000" class="difflineminus">-  if (m_proxyRequest)</span>
<a href="#l28.1001"></a><span id="l28.1001" class="difflineminus">-    m_proxyRequest-&gt;Cancel(status);</span>
<a href="#l28.1002"></a><span id="l28.1002" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::Cancel(nsresult status) {</span>
<a href="#l28.1003"></a><span id="l28.1003" class="difflineplus">+  if (m_proxyRequest) m_proxyRequest-&gt;Cancel(status);</span>
<a href="#l28.1004"></a><span id="l28.1004"> </span>
<a href="#l28.1005"></a><span id="l28.1005" class="difflineminus">-  if (m_request)</span>
<a href="#l28.1006"></a><span id="l28.1006" class="difflineminus">-    return m_request-&gt;Cancel(status);</span>
<a href="#l28.1007"></a><span id="l28.1007" class="difflineplus">+  if (m_request) return m_request-&gt;Cancel(status);</span>
<a href="#l28.1008"></a><span id="l28.1008"> </span>
<a href="#l28.1009"></a><span id="l28.1009">   NS_WARNING(&quot;no request to cancel&quot;);</span>
<a href="#l28.1010"></a><span id="l28.1010">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.1011"></a><span id="l28.1011"> }</span>
<a href="#l28.1012"></a><span id="l28.1012"> </span>
<a href="#l28.1013"></a><span id="l28.1013" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::Suspend()</span>
<a href="#l28.1014"></a><span id="l28.1014" class="difflineminus">-{</span>
<a href="#l28.1015"></a><span id="l28.1015" class="difflineminus">-  if (m_request)</span>
<a href="#l28.1016"></a><span id="l28.1016" class="difflineminus">-    return m_request-&gt;Suspend();</span>
<a href="#l28.1017"></a><span id="l28.1017" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::Suspend() {</span>
<a href="#l28.1018"></a><span id="l28.1018" class="difflineplus">+  if (m_request) return m_request-&gt;Suspend();</span>
<a href="#l28.1019"></a><span id="l28.1019"> </span>
<a href="#l28.1020"></a><span id="l28.1020">   NS_WARNING(&quot;no request to suspend&quot;);</span>
<a href="#l28.1021"></a><span id="l28.1021">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.1022"></a><span id="l28.1022"> }</span>
<a href="#l28.1023"></a><span id="l28.1023"> </span>
<a href="#l28.1024"></a><span id="l28.1024" class="difflineminus">-NS_IMETHODIMP nsMsgProtocol::Resume()</span>
<a href="#l28.1025"></a><span id="l28.1025" class="difflineminus">-{</span>
<a href="#l28.1026"></a><span id="l28.1026" class="difflineminus">-  if (m_request)</span>
<a href="#l28.1027"></a><span id="l28.1027" class="difflineminus">-    return m_request-&gt;Resume();</span>
<a href="#l28.1028"></a><span id="l28.1028" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::Resume() {</span>
<a href="#l28.1029"></a><span id="l28.1029" class="difflineplus">+  if (m_request) return m_request-&gt;Resume();</span>
<a href="#l28.1030"></a><span id="l28.1030"> </span>
<a href="#l28.1031"></a><span id="l28.1031">   NS_WARNING(&quot;no request to resume&quot;);</span>
<a href="#l28.1032"></a><span id="l28.1032">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l28.1033"></a><span id="l28.1033"> }</span>
<a href="#l28.1034"></a><span id="l28.1034"> </span>
<a href="#l28.1035"></a><span id="l28.1035" class="difflineminus">-nsresult nsMsgProtocol::PostMessage(nsIURI* url, nsIFile *postFile)</span>
<a href="#l28.1036"></a><span id="l28.1036" class="difflineminus">-{</span>
<a href="#l28.1037"></a><span id="l28.1037" class="difflineplus">+nsresult nsMsgProtocol::PostMessage(nsIURI *url, nsIFile *postFile) {</span>
<a href="#l28.1038"></a><span id="l28.1038">   if (!url || !postFile) return NS_ERROR_NULL_POINTER;</span>
<a href="#l28.1039"></a><span id="l28.1039"> </span>
<a href="#l28.1040"></a><span id="l28.1040"> #define POST_DATA_BUFFER_SIZE 2048</span>
<a href="#l28.1041"></a><span id="l28.1041"> </span>
<a href="#l28.1042"></a><span id="l28.1042">   // mscott -- this function should be re-written to use the file url code</span>
<a href="#l28.1043"></a><span id="l28.1043">   // so it can be asynch</span>
<a href="#l28.1044"></a><span id="l28.1044">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l28.1045"></a><span id="l28.1045" class="difflineminus">-  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), postFile);</span>
<a href="#l28.1046"></a><span id="l28.1046" class="difflineplus">+  nsresult rv =</span>
<a href="#l28.1047"></a><span id="l28.1047" class="difflineplus">+      NS_NewLocalFileInputStream(getter_AddRefs(inputStream), postFile);</span>
<a href="#l28.1048"></a><span id="l28.1048">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.1049"></a><span id="l28.1049" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l28.1050"></a><span id="l28.1050" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(</span>
<a href="#l28.1051"></a><span id="l28.1051" class="difflineplus">+      do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l28.1052"></a><span id="l28.1052">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.1053"></a><span id="l28.1053"> </span>
<a href="#l28.1054"></a><span id="l28.1054">   bool more = true;</span>
<a href="#l28.1055"></a><span id="l28.1055">   nsCString line;</span>
<a href="#l28.1056"></a><span id="l28.1056">   nsCString outputBuffer;</span>
<a href="#l28.1057"></a><span id="l28.1057"> </span>
<a href="#l28.1058"></a><span id="l28.1058" class="difflineminus">-  do</span>
<a href="#l28.1059"></a><span id="l28.1059" class="difflineminus">-  {</span>
<a href="#l28.1060"></a><span id="l28.1060" class="difflineplus">+  do {</span>
<a href="#l28.1061"></a><span id="l28.1061">     lineInputStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l28.1062"></a><span id="l28.1062"> </span>
<a href="#l28.1063"></a><span id="l28.1063">     /* escape starting periods</span>
<a href="#l28.1064"></a><span id="l28.1064">      */</span>
<a href="#l28.1065"></a><span id="l28.1065" class="difflineminus">-    if (line.CharAt(0) == '.')</span>
<a href="#l28.1066"></a><span id="l28.1066" class="difflineminus">-      line.Insert('.', 0);</span>
<a href="#l28.1067"></a><span id="l28.1067" class="difflineplus">+    if (line.CharAt(0) == '.') line.Insert('.', 0);</span>
<a href="#l28.1068"></a><span id="l28.1068">     line.Append(NS_LITERAL_CSTRING(CRLF));</span>
<a href="#l28.1069"></a><span id="l28.1069">     outputBuffer.Append(line);</span>
<a href="#l28.1070"></a><span id="l28.1070">     // test hack by mscott. If our buffer is almost full, then</span>
<a href="#l28.1071"></a><span id="l28.1071">     // send it off &amp; reset ourselves</span>
<a href="#l28.1072"></a><span id="l28.1072">     // to make more room.</span>
<a href="#l28.1073"></a><span id="l28.1073" class="difflineminus">-    if (outputBuffer.Length() &gt; POST_DATA_BUFFER_SIZE || !more)</span>
<a href="#l28.1074"></a><span id="l28.1074" class="difflineminus">-    {</span>
<a href="#l28.1075"></a><span id="l28.1075" class="difflineplus">+    if (outputBuffer.Length() &gt; POST_DATA_BUFFER_SIZE || !more) {</span>
<a href="#l28.1076"></a><span id="l28.1076">       rv = SendData(outputBuffer.get());</span>
<a href="#l28.1077"></a><span id="l28.1077">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.1078"></a><span id="l28.1078">       // does this keep the buffer around? That would be best.</span>
<a href="#l28.1079"></a><span id="l28.1079">       // Maybe SetLength(0) instead?</span>
<a href="#l28.1080"></a><span id="l28.1080">       outputBuffer.Truncate();</span>
<a href="#l28.1081"></a><span id="l28.1081">     }</span>
<a href="#l28.1082"></a><span id="l28.1082">   } while (more);</span>
<a href="#l28.1083"></a><span id="l28.1083"> </span>
<a href="#l28.1084"></a><span id="l28.1084">   return NS_OK;</span>
<a href="#l28.1085"></a><span id="l28.1085"> }</span>
<a href="#l28.1086"></a><span id="l28.1086"> </span>
<a href="#l28.1087"></a><span id="l28.1087" class="difflineminus">-nsresult nsMsgProtocol::DoGSSAPIStep1(const char *service, const char *username, nsCString &amp;response)</span>
<a href="#l28.1088"></a><span id="l28.1088" class="difflineminus">-{</span>
<a href="#l28.1089"></a><span id="l28.1089" class="difflineminus">-    nsresult rv;</span>
<a href="#l28.1090"></a><span id="l28.1090" class="difflineplus">+nsresult nsMsgProtocol::DoGSSAPIStep1(const char *service, const char *username,</span>
<a href="#l28.1091"></a><span id="l28.1091" class="difflineplus">+                                      nsCString &amp;response) {</span>
<a href="#l28.1092"></a><span id="l28.1092" class="difflineplus">+  nsresult rv;</span>
<a href="#l28.1093"></a><span id="l28.1093"> #ifdef DEBUG_BenB</span>
<a href="#l28.1094"></a><span id="l28.1094" class="difflineminus">-    printf(&quot;GSSAPI step 1 for service %s, username %s\n&quot;, service, username);</span>
<a href="#l28.1095"></a><span id="l28.1095" class="difflineplus">+  printf(&quot;GSSAPI step 1 for service %s, username %s\n&quot;, service, username);</span>
<a href="#l28.1096"></a><span id="l28.1096"> #endif</span>
<a href="#l28.1097"></a><span id="l28.1097"> </span>
<a href="#l28.1098"></a><span id="l28.1098" class="difflineminus">-    // if this fails, then it means that we cannot do GSSAPI SASL.</span>
<a href="#l28.1099"></a><span id="l28.1099" class="difflineminus">-    m_authModule = nsIAuthModule::CreateInstance(&quot;sasl-gssapi&quot;);</span>
<a href="#l28.1100"></a><span id="l28.1100" class="difflineplus">+  // if this fails, then it means that we cannot do GSSAPI SASL.</span>
<a href="#l28.1101"></a><span id="l28.1101" class="difflineplus">+  m_authModule = nsIAuthModule::CreateInstance(&quot;sasl-gssapi&quot;);</span>
<a href="#l28.1102"></a><span id="l28.1102"> </span>
<a href="#l28.1103"></a><span id="l28.1103" class="difflineminus">-    m_authModule-&gt;Init(service, nsIAuthModule::REQ_DEFAULT, nullptr, NS_ConvertUTF8toUTF16(username).get(), nullptr);</span>
<a href="#l28.1104"></a><span id="l28.1104" class="difflineplus">+  m_authModule-&gt;Init(service, nsIAuthModule::REQ_DEFAULT, nullptr,</span>
<a href="#l28.1105"></a><span id="l28.1105" class="difflineplus">+                     NS_ConvertUTF8toUTF16(username).get(), nullptr);</span>
<a href="#l28.1106"></a><span id="l28.1106"> </span>
<a href="#l28.1107"></a><span id="l28.1107" class="difflineminus">-    void *outBuf;</span>
<a href="#l28.1108"></a><span id="l28.1108" class="difflineminus">-    uint32_t outBufLen;</span>
<a href="#l28.1109"></a><span id="l28.1109" class="difflineminus">-    rv = m_authModule-&gt;GetNextToken((void *)nullptr, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l28.1110"></a><span id="l28.1110" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; outBuf)</span>
<a href="#l28.1111"></a><span id="l28.1111" class="difflineminus">-    {</span>
<a href="#l28.1112"></a><span id="l28.1112" class="difflineminus">-        char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1113"></a><span id="l28.1113" class="difflineminus">-        if (base64Str)</span>
<a href="#l28.1114"></a><span id="l28.1114" class="difflineminus">-            response.Adopt(base64Str);</span>
<a href="#l28.1115"></a><span id="l28.1115" class="difflineminus">-        else</span>
<a href="#l28.1116"></a><span id="l28.1116" class="difflineminus">-            rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1117"></a><span id="l28.1117" class="difflineminus">-        free(outBuf);</span>
<a href="#l28.1118"></a><span id="l28.1118" class="difflineminus">-    }</span>
<a href="#l28.1119"></a><span id="l28.1119" class="difflineplus">+  void *outBuf;</span>
<a href="#l28.1120"></a><span id="l28.1120" class="difflineplus">+  uint32_t outBufLen;</span>
<a href="#l28.1121"></a><span id="l28.1121" class="difflineplus">+  rv = m_authModule-&gt;GetNextToken((void *)nullptr, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l28.1122"></a><span id="l28.1122" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; outBuf) {</span>
<a href="#l28.1123"></a><span id="l28.1123" class="difflineplus">+    char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1124"></a><span id="l28.1124" class="difflineplus">+    if (base64Str)</span>
<a href="#l28.1125"></a><span id="l28.1125" class="difflineplus">+      response.Adopt(base64Str);</span>
<a href="#l28.1126"></a><span id="l28.1126" class="difflineplus">+    else</span>
<a href="#l28.1127"></a><span id="l28.1127" class="difflineplus">+      rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1128"></a><span id="l28.1128" class="difflineplus">+    free(outBuf);</span>
<a href="#l28.1129"></a><span id="l28.1129" class="difflineplus">+  }</span>
<a href="#l28.1130"></a><span id="l28.1130"> </span>
<a href="#l28.1131"></a><span id="l28.1131"> #ifdef DEBUG_BenB</span>
<a href="#l28.1132"></a><span id="l28.1132" class="difflineminus">-    printf(&quot;GSSAPI step 1 succeeded\n&quot;);</span>
<a href="#l28.1133"></a><span id="l28.1133" class="difflineplus">+  printf(&quot;GSSAPI step 1 succeeded\n&quot;);</span>
<a href="#l28.1134"></a><span id="l28.1134"> #endif</span>
<a href="#l28.1135"></a><span id="l28.1135" class="difflineminus">-    return rv;</span>
<a href="#l28.1136"></a><span id="l28.1136" class="difflineplus">+  return rv;</span>
<a href="#l28.1137"></a><span id="l28.1137"> }</span>
<a href="#l28.1138"></a><span id="l28.1138"> </span>
<a href="#l28.1139"></a><span id="l28.1139" class="difflineminus">-nsresult nsMsgProtocol::DoGSSAPIStep2(nsCString &amp;commandResponse, nsCString &amp;response)</span>
<a href="#l28.1140"></a><span id="l28.1140" class="difflineminus">-{</span>
<a href="#l28.1141"></a><span id="l28.1141" class="difflineplus">+nsresult nsMsgProtocol::DoGSSAPIStep2(nsCString &amp;commandResponse,</span>
<a href="#l28.1142"></a><span id="l28.1142" class="difflineplus">+                                      nsCString &amp;response) {</span>
<a href="#l28.1143"></a><span id="l28.1143"> #ifdef DEBUG_BenB</span>
<a href="#l28.1144"></a><span id="l28.1144" class="difflineminus">-    printf(&quot;GSSAPI step 2\n&quot;);</span>
<a href="#l28.1145"></a><span id="l28.1145" class="difflineplus">+  printf(&quot;GSSAPI step 2\n&quot;);</span>
<a href="#l28.1146"></a><span id="l28.1146"> #endif</span>
<a href="#l28.1147"></a><span id="l28.1147" class="difflineminus">-    nsresult rv;</span>
<a href="#l28.1148"></a><span id="l28.1148" class="difflineminus">-    void *inBuf, *outBuf;</span>
<a href="#l28.1149"></a><span id="l28.1149" class="difflineminus">-    uint32_t inBufLen, outBufLen;</span>
<a href="#l28.1150"></a><span id="l28.1150" class="difflineminus">-    uint32_t len = commandResponse.Length();</span>
<a href="#l28.1151"></a><span id="l28.1151" class="difflineplus">+  nsresult rv;</span>
<a href="#l28.1152"></a><span id="l28.1152" class="difflineplus">+  void *inBuf, *outBuf;</span>
<a href="#l28.1153"></a><span id="l28.1153" class="difflineplus">+  uint32_t inBufLen, outBufLen;</span>
<a href="#l28.1154"></a><span id="l28.1154" class="difflineplus">+  uint32_t len = commandResponse.Length();</span>
<a href="#l28.1155"></a><span id="l28.1155" class="difflineplus">+</span>
<a href="#l28.1156"></a><span id="l28.1156" class="difflineplus">+  // Cyrus SASL may send us zero length tokens (grrrr)</span>
<a href="#l28.1157"></a><span id="l28.1157" class="difflineplus">+  if (len &gt; 0) {</span>
<a href="#l28.1158"></a><span id="l28.1158" class="difflineplus">+    // decode into the input secbuffer</span>
<a href="#l28.1159"></a><span id="l28.1159" class="difflineplus">+    inBufLen = (len * 3) / 4;  // sufficient size (see plbase64.h)</span>
<a href="#l28.1160"></a><span id="l28.1160" class="difflineplus">+    inBuf = moz_xmalloc(inBufLen);</span>
<a href="#l28.1161"></a><span id="l28.1161" class="difflineplus">+    if (!inBuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1162"></a><span id="l28.1162"> </span>
<a href="#l28.1163"></a><span id="l28.1163" class="difflineminus">-    // Cyrus SASL may send us zero length tokens (grrrr)</span>
<a href="#l28.1164"></a><span id="l28.1164" class="difflineminus">-    if (len &gt; 0) {</span>
<a href="#l28.1165"></a><span id="l28.1165" class="difflineminus">-        // decode into the input secbuffer</span>
<a href="#l28.1166"></a><span id="l28.1166" class="difflineminus">-        inBufLen = (len * 3)/4;      // sufficient size (see plbase64.h)</span>
<a href="#l28.1167"></a><span id="l28.1167" class="difflineminus">-        inBuf = moz_xmalloc(inBufLen);</span>
<a href="#l28.1168"></a><span id="l28.1168" class="difflineminus">-        if (!inBuf)</span>
<a href="#l28.1169"></a><span id="l28.1169" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1170"></a><span id="l28.1170" class="difflineplus">+    // strip off any padding (see bug 230351)</span>
<a href="#l28.1171"></a><span id="l28.1171" class="difflineplus">+    const char *challenge = commandResponse.get();</span>
<a href="#l28.1172"></a><span id="l28.1172" class="difflineplus">+    while (challenge[len - 1] == '=') len--;</span>
<a href="#l28.1173"></a><span id="l28.1173" class="difflineplus">+</span>
<a href="#l28.1174"></a><span id="l28.1174" class="difflineplus">+    // We need to know the exact length of the decoded string to give to</span>
<a href="#l28.1175"></a><span id="l28.1175" class="difflineplus">+    // the GSSAPI libraries. But NSPR's base64 routine doesn't seem capable</span>
<a href="#l28.1176"></a><span id="l28.1176" class="difflineplus">+    // of telling us that. So, we figure it out for ourselves.</span>
<a href="#l28.1177"></a><span id="l28.1177"> </span>
<a href="#l28.1178"></a><span id="l28.1178" class="difflineminus">-        // strip off any padding (see bug 230351)</span>
<a href="#l28.1179"></a><span id="l28.1179" class="difflineminus">-        const char *challenge = commandResponse.get();</span>
<a href="#l28.1180"></a><span id="l28.1180" class="difflineminus">-        while (challenge[len - 1] == '=')</span>
<a href="#l28.1181"></a><span id="l28.1181" class="difflineminus">-            len--;</span>
<a href="#l28.1182"></a><span id="l28.1182" class="difflineplus">+    // For every 4 characters, add 3 to the destination</span>
<a href="#l28.1183"></a><span id="l28.1183" class="difflineplus">+    // If there are 3 remaining, add 2</span>
<a href="#l28.1184"></a><span id="l28.1184" class="difflineplus">+    // If there are 2 remaining, add 1</span>
<a href="#l28.1185"></a><span id="l28.1185" class="difflineplus">+    // 1 remaining is an error</span>
<a href="#l28.1186"></a><span id="l28.1186" class="difflineplus">+    inBufLen =</span>
<a href="#l28.1187"></a><span id="l28.1187" class="difflineplus">+        (len / 4) * 3 + ((len % 4 == 3) ? 2 : 0) + ((len % 4 == 2) ? 1 : 0);</span>
<a href="#l28.1188"></a><span id="l28.1188"> </span>
<a href="#l28.1189"></a><span id="l28.1189" class="difflineminus">-        // We need to know the exact length of the decoded string to give to</span>
<a href="#l28.1190"></a><span id="l28.1190" class="difflineminus">-        // the GSSAPI libraries. But NSPR's base64 routine doesn't seem capable</span>
<a href="#l28.1191"></a><span id="l28.1191" class="difflineminus">-        // of telling us that. So, we figure it out for ourselves.</span>
<a href="#l28.1192"></a><span id="l28.1192" class="difflineminus">-</span>
<a href="#l28.1193"></a><span id="l28.1193" class="difflineminus">-        // For every 4 characters, add 3 to the destination</span>
<a href="#l28.1194"></a><span id="l28.1194" class="difflineminus">-        // If there are 3 remaining, add 2</span>
<a href="#l28.1195"></a><span id="l28.1195" class="difflineminus">-        // If there are 2 remaining, add 1</span>
<a href="#l28.1196"></a><span id="l28.1196" class="difflineminus">-        // 1 remaining is an error</span>
<a href="#l28.1197"></a><span id="l28.1197" class="difflineminus">-        inBufLen = (len / 4)*3 + ((len % 4 == 3)?2:0) + ((len % 4 == 2)?1:0);</span>
<a href="#l28.1198"></a><span id="l28.1198" class="difflineminus">-</span>
<a href="#l28.1199"></a><span id="l28.1199" class="difflineminus">-        rv = (PL_Base64Decode(challenge, len, (char *)inBuf))</span>
<a href="#l28.1200"></a><span id="l28.1200" class="difflineplus">+    rv = (PL_Base64Decode(challenge, len, (char *)inBuf))</span>
<a href="#l28.1201"></a><span id="l28.1201">              ? m_authModule-&gt;GetNextToken(inBuf, inBufLen, &amp;outBuf, &amp;outBufLen)</span>
<a href="#l28.1202"></a><span id="l28.1202">              : NS_ERROR_FAILURE;</span>
<a href="#l28.1203"></a><span id="l28.1203"> </span>
<a href="#l28.1204"></a><span id="l28.1204" class="difflineminus">-        free(inBuf);</span>
<a href="#l28.1205"></a><span id="l28.1205" class="difflineminus">-    }</span>
<a href="#l28.1206"></a><span id="l28.1206" class="difflineminus">-    else</span>
<a href="#l28.1207"></a><span id="l28.1207" class="difflineminus">-    {</span>
<a href="#l28.1208"></a><span id="l28.1208" class="difflineminus">-        rv = m_authModule-&gt;GetNextToken(NULL, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l28.1209"></a><span id="l28.1209" class="difflineminus">-    }</span>
<a href="#l28.1210"></a><span id="l28.1210" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l28.1211"></a><span id="l28.1211" class="difflineminus">-    {</span>
<a href="#l28.1212"></a><span id="l28.1212" class="difflineminus">-        // And in return, we may need to send Cyrus zero length tokens back</span>
<a href="#l28.1213"></a><span id="l28.1213" class="difflineminus">-        if (outBuf)</span>
<a href="#l28.1214"></a><span id="l28.1214" class="difflineminus">-        {</span>
<a href="#l28.1215"></a><span id="l28.1215" class="difflineminus">-            char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1216"></a><span id="l28.1216" class="difflineminus">-            if (base64Str)</span>
<a href="#l28.1217"></a><span id="l28.1217" class="difflineminus">-                response.Adopt(base64Str);</span>
<a href="#l28.1218"></a><span id="l28.1218" class="difflineminus">-            else</span>
<a href="#l28.1219"></a><span id="l28.1219" class="difflineminus">-                rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1220"></a><span id="l28.1220" class="difflineminus">-        }</span>
<a href="#l28.1221"></a><span id="l28.1221" class="difflineminus">-        else</span>
<a href="#l28.1222"></a><span id="l28.1222" class="difflineminus">-            response.Adopt((char *)moz_xmemdup(&quot;&quot;,1));</span>
<a href="#l28.1223"></a><span id="l28.1223" class="difflineminus">-    }</span>
<a href="#l28.1224"></a><span id="l28.1224" class="difflineplus">+    free(inBuf);</span>
<a href="#l28.1225"></a><span id="l28.1225" class="difflineplus">+  } else {</span>
<a href="#l28.1226"></a><span id="l28.1226" class="difflineplus">+    rv = m_authModule-&gt;GetNextToken(NULL, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l28.1227"></a><span id="l28.1227" class="difflineplus">+  }</span>
<a href="#l28.1228"></a><span id="l28.1228" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l28.1229"></a><span id="l28.1229" class="difflineplus">+    // And in return, we may need to send Cyrus zero length tokens back</span>
<a href="#l28.1230"></a><span id="l28.1230" class="difflineplus">+    if (outBuf) {</span>
<a href="#l28.1231"></a><span id="l28.1231" class="difflineplus">+      char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1232"></a><span id="l28.1232" class="difflineplus">+      if (base64Str)</span>
<a href="#l28.1233"></a><span id="l28.1233" class="difflineplus">+        response.Adopt(base64Str);</span>
<a href="#l28.1234"></a><span id="l28.1234" class="difflineplus">+      else</span>
<a href="#l28.1235"></a><span id="l28.1235" class="difflineplus">+        rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1236"></a><span id="l28.1236" class="difflineplus">+    } else</span>
<a href="#l28.1237"></a><span id="l28.1237" class="difflineplus">+      response.Adopt((char *)moz_xmemdup(&quot;&quot;, 1));</span>
<a href="#l28.1238"></a><span id="l28.1238" class="difflineplus">+  }</span>
<a href="#l28.1239"></a><span id="l28.1239"> </span>
<a href="#l28.1240"></a><span id="l28.1240"> #ifdef DEBUG_BenB</span>
<a href="#l28.1241"></a><span id="l28.1241" class="difflineminus">-    printf(NS_SUCCEEDED(rv) ? &quot;GSSAPI step 2 succeeded\n&quot; : &quot;GSSAPI step 2 failed\n&quot;);</span>
<a href="#l28.1242"></a><span id="l28.1242" class="difflineplus">+  printf(NS_SUCCEEDED(rv) ? &quot;GSSAPI step 2 succeeded\n&quot;</span>
<a href="#l28.1243"></a><span id="l28.1243" class="difflineplus">+                          : &quot;GSSAPI step 2 failed\n&quot;);</span>
<a href="#l28.1244"></a><span id="l28.1244"> #endif</span>
<a href="#l28.1245"></a><span id="l28.1245" class="difflineminus">-    return rv;</span>
<a href="#l28.1246"></a><span id="l28.1246" class="difflineplus">+  return rv;</span>
<a href="#l28.1247"></a><span id="l28.1247"> }</span>
<a href="#l28.1248"></a><span id="l28.1248"> </span>
<a href="#l28.1249"></a><span id="l28.1249" class="difflineminus">-nsresult nsMsgProtocol::DoNtlmStep1(const nsACString &amp;username, const nsAString &amp;password, nsCString &amp;response)</span>
<a href="#l28.1250"></a><span id="l28.1250" class="difflineminus">-{</span>
<a href="#l28.1251"></a><span id="l28.1251" class="difflineminus">-    nsresult rv;</span>
<a href="#l28.1252"></a><span id="l28.1252" class="difflineplus">+nsresult nsMsgProtocol::DoNtlmStep1(const nsACString &amp;username,</span>
<a href="#l28.1253"></a><span id="l28.1253" class="difflineplus">+                                    const nsAString &amp;password,</span>
<a href="#l28.1254"></a><span id="l28.1254" class="difflineplus">+                                    nsCString &amp;response) {</span>
<a href="#l28.1255"></a><span id="l28.1255" class="difflineplus">+  nsresult rv;</span>
<a href="#l28.1256"></a><span id="l28.1256"> </span>
<a href="#l28.1257"></a><span id="l28.1257" class="difflineminus">-    m_authModule = nsIAuthModule::CreateInstance(&quot;ntlm&quot;);</span>
<a href="#l28.1258"></a><span id="l28.1258" class="difflineplus">+  m_authModule = nsIAuthModule::CreateInstance(&quot;ntlm&quot;);</span>
<a href="#l28.1259"></a><span id="l28.1259"> </span>
<a href="#l28.1260"></a><span id="l28.1260" class="difflineminus">-    m_authModule-&gt;Init(nullptr, 0, nullptr, NS_ConvertUTF8toUTF16(username).get(),</span>
<a href="#l28.1261"></a><span id="l28.1261" class="difflineminus">-                       PromiseFlatString(password).get());</span>
<a href="#l28.1262"></a><span id="l28.1262" class="difflineplus">+  m_authModule-&gt;Init(nullptr, 0, nullptr, NS_ConvertUTF8toUTF16(username).get(),</span>
<a href="#l28.1263"></a><span id="l28.1263" class="difflineplus">+                     PromiseFlatString(password).get());</span>
<a href="#l28.1264"></a><span id="l28.1264"> </span>
<a href="#l28.1265"></a><span id="l28.1265" class="difflineminus">-    void *outBuf;</span>
<a href="#l28.1266"></a><span id="l28.1266" class="difflineminus">-    uint32_t outBufLen;</span>
<a href="#l28.1267"></a><span id="l28.1267" class="difflineminus">-    rv = m_authModule-&gt;GetNextToken((void *)nullptr, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l28.1268"></a><span id="l28.1268" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; outBuf)</span>
<a href="#l28.1269"></a><span id="l28.1269" class="difflineminus">-    {</span>
<a href="#l28.1270"></a><span id="l28.1270" class="difflineminus">-        char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1271"></a><span id="l28.1271" class="difflineminus">-        if (base64Str)</span>
<a href="#l28.1272"></a><span id="l28.1272" class="difflineminus">-          response.Adopt(base64Str);</span>
<a href="#l28.1273"></a><span id="l28.1273" class="difflineminus">-        else</span>
<a href="#l28.1274"></a><span id="l28.1274" class="difflineminus">-          rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1275"></a><span id="l28.1275" class="difflineminus">-        free(outBuf);</span>
<a href="#l28.1276"></a><span id="l28.1276" class="difflineminus">-    }</span>
<a href="#l28.1277"></a><span id="l28.1277" class="difflineplus">+  void *outBuf;</span>
<a href="#l28.1278"></a><span id="l28.1278" class="difflineplus">+  uint32_t outBufLen;</span>
<a href="#l28.1279"></a><span id="l28.1279" class="difflineplus">+  rv = m_authModule-&gt;GetNextToken((void *)nullptr, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l28.1280"></a><span id="l28.1280" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; outBuf) {</span>
<a href="#l28.1281"></a><span id="l28.1281" class="difflineplus">+    char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1282"></a><span id="l28.1282" class="difflineplus">+    if (base64Str)</span>
<a href="#l28.1283"></a><span id="l28.1283" class="difflineplus">+      response.Adopt(base64Str);</span>
<a href="#l28.1284"></a><span id="l28.1284" class="difflineplus">+    else</span>
<a href="#l28.1285"></a><span id="l28.1285" class="difflineplus">+      rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1286"></a><span id="l28.1286" class="difflineplus">+    free(outBuf);</span>
<a href="#l28.1287"></a><span id="l28.1287" class="difflineplus">+  }</span>
<a href="#l28.1288"></a><span id="l28.1288"> </span>
<a href="#l28.1289"></a><span id="l28.1289" class="difflineminus">-    return rv;</span>
<a href="#l28.1290"></a><span id="l28.1290" class="difflineplus">+  return rv;</span>
<a href="#l28.1291"></a><span id="l28.1291"> }</span>
<a href="#l28.1292"></a><span id="l28.1292"> </span>
<a href="#l28.1293"></a><span id="l28.1293" class="difflineminus">-nsresult nsMsgProtocol::DoNtlmStep2(nsCString &amp;commandResponse, nsCString &amp;response)</span>
<a href="#l28.1294"></a><span id="l28.1294" class="difflineminus">-{</span>
<a href="#l28.1295"></a><span id="l28.1295" class="difflineminus">-    nsresult rv;</span>
<a href="#l28.1296"></a><span id="l28.1296" class="difflineminus">-    void *inBuf, *outBuf;</span>
<a href="#l28.1297"></a><span id="l28.1297" class="difflineminus">-    uint32_t inBufLen, outBufLen;</span>
<a href="#l28.1298"></a><span id="l28.1298" class="difflineminus">-    uint32_t len = commandResponse.Length();</span>
<a href="#l28.1299"></a><span id="l28.1299" class="difflineplus">+nsresult nsMsgProtocol::DoNtlmStep2(nsCString &amp;commandResponse,</span>
<a href="#l28.1300"></a><span id="l28.1300" class="difflineplus">+                                    nsCString &amp;response) {</span>
<a href="#l28.1301"></a><span id="l28.1301" class="difflineplus">+  nsresult rv;</span>
<a href="#l28.1302"></a><span id="l28.1302" class="difflineplus">+  void *inBuf, *outBuf;</span>
<a href="#l28.1303"></a><span id="l28.1303" class="difflineplus">+  uint32_t inBufLen, outBufLen;</span>
<a href="#l28.1304"></a><span id="l28.1304" class="difflineplus">+  uint32_t len = commandResponse.Length();</span>
<a href="#l28.1305"></a><span id="l28.1305"> </span>
<a href="#l28.1306"></a><span id="l28.1306" class="difflineminus">-    // decode into the input secbuffer</span>
<a href="#l28.1307"></a><span id="l28.1307" class="difflineminus">-    inBufLen = (len * 3)/4;      // sufficient size (see plbase64.h)</span>
<a href="#l28.1308"></a><span id="l28.1308" class="difflineminus">-    inBuf = moz_xmalloc(inBufLen);</span>
<a href="#l28.1309"></a><span id="l28.1309" class="difflineminus">-    if (!inBuf)</span>
<a href="#l28.1310"></a><span id="l28.1310" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1311"></a><span id="l28.1311" class="difflineplus">+  // decode into the input secbuffer</span>
<a href="#l28.1312"></a><span id="l28.1312" class="difflineplus">+  inBufLen = (len * 3) / 4;  // sufficient size (see plbase64.h)</span>
<a href="#l28.1313"></a><span id="l28.1313" class="difflineplus">+  inBuf = moz_xmalloc(inBufLen);</span>
<a href="#l28.1314"></a><span id="l28.1314" class="difflineplus">+  if (!inBuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1315"></a><span id="l28.1315"> </span>
<a href="#l28.1316"></a><span id="l28.1316" class="difflineminus">-    // strip off any padding (see bug 230351)</span>
<a href="#l28.1317"></a><span id="l28.1317" class="difflineminus">-    const char *challenge = commandResponse.get();</span>
<a href="#l28.1318"></a><span id="l28.1318" class="difflineminus">-    while (challenge[len - 1] == '=')</span>
<a href="#l28.1319"></a><span id="l28.1319" class="difflineminus">-        len--;</span>
<a href="#l28.1320"></a><span id="l28.1320" class="difflineplus">+  // strip off any padding (see bug 230351)</span>
<a href="#l28.1321"></a><span id="l28.1321" class="difflineplus">+  const char *challenge = commandResponse.get();</span>
<a href="#l28.1322"></a><span id="l28.1322" class="difflineplus">+  while (challenge[len - 1] == '=') len--;</span>
<a href="#l28.1323"></a><span id="l28.1323"> </span>
<a href="#l28.1324"></a><span id="l28.1324" class="difflineminus">-    rv = (PL_Base64Decode(challenge, len, (char *)inBuf))</span>
<a href="#l28.1325"></a><span id="l28.1325" class="difflineminus">-         ? m_authModule-&gt;GetNextToken(inBuf, inBufLen, &amp;outBuf, &amp;outBufLen)</span>
<a href="#l28.1326"></a><span id="l28.1326" class="difflineminus">-         : NS_ERROR_FAILURE;</span>
<a href="#l28.1327"></a><span id="l28.1327" class="difflineplus">+  rv = (PL_Base64Decode(challenge, len, (char *)inBuf))</span>
<a href="#l28.1328"></a><span id="l28.1328" class="difflineplus">+           ? m_authModule-&gt;GetNextToken(inBuf, inBufLen, &amp;outBuf, &amp;outBufLen)</span>
<a href="#l28.1329"></a><span id="l28.1329" class="difflineplus">+           : NS_ERROR_FAILURE;</span>
<a href="#l28.1330"></a><span id="l28.1330"> </span>
<a href="#l28.1331"></a><span id="l28.1331" class="difflineminus">-    free(inBuf);</span>
<a href="#l28.1332"></a><span id="l28.1332" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; outBuf)</span>
<a href="#l28.1333"></a><span id="l28.1333" class="difflineminus">-    {</span>
<a href="#l28.1334"></a><span id="l28.1334" class="difflineminus">-        char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1335"></a><span id="l28.1335" class="difflineminus">-        if (base64Str)</span>
<a href="#l28.1336"></a><span id="l28.1336" class="difflineminus">-          response.Adopt(base64Str);</span>
<a href="#l28.1337"></a><span id="l28.1337" class="difflineminus">-        else</span>
<a href="#l28.1338"></a><span id="l28.1338" class="difflineminus">-          rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1339"></a><span id="l28.1339" class="difflineminus">-    }</span>
<a href="#l28.1340"></a><span id="l28.1340" class="difflineplus">+  free(inBuf);</span>
<a href="#l28.1341"></a><span id="l28.1341" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; outBuf) {</span>
<a href="#l28.1342"></a><span id="l28.1342" class="difflineplus">+    char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l28.1343"></a><span id="l28.1343" class="difflineplus">+    if (base64Str)</span>
<a href="#l28.1344"></a><span id="l28.1344" class="difflineplus">+      response.Adopt(base64Str);</span>
<a href="#l28.1345"></a><span id="l28.1345" class="difflineplus">+    else</span>
<a href="#l28.1346"></a><span id="l28.1346" class="difflineplus">+      rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1347"></a><span id="l28.1347" class="difflineplus">+  }</span>
<a href="#l28.1348"></a><span id="l28.1348"> </span>
<a href="#l28.1349"></a><span id="l28.1349" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l28.1350"></a><span id="l28.1350" class="difflineminus">-        response = &quot;*&quot;;</span>
<a href="#l28.1351"></a><span id="l28.1351" class="difflineplus">+  if (NS_FAILED(rv)) response = &quot;*&quot;;</span>
<a href="#l28.1352"></a><span id="l28.1352"> </span>
<a href="#l28.1353"></a><span id="l28.1353" class="difflineminus">-    return rv;</span>
<a href="#l28.1354"></a><span id="l28.1354" class="difflineplus">+  return rv;</span>
<a href="#l28.1355"></a><span id="l28.1355"> }</span>
<a href="#l28.1356"></a><span id="l28.1356"> </span>
<a href="#l28.1357"></a><span id="l28.1357"> /////////////////////////////////////////////////////////////////////</span>
<a href="#l28.1358"></a><span id="l28.1358"> // nsMsgAsyncWriteProtocol subclass and related helper classes</span>
<a href="#l28.1359"></a><span id="l28.1359"> /////////////////////////////////////////////////////////////////////</span>
<a href="#l28.1360"></a><span id="l28.1360"> </span>
<a href="#l28.1361"></a><span id="l28.1361" class="difflineminus">-class nsMsgProtocolStreamProvider : public nsIOutputStreamCallback</span>
<a href="#l28.1362"></a><span id="l28.1362" class="difflineminus">-{</span>
<a href="#l28.1363"></a><span id="l28.1363" class="difflineminus">-public:</span>
<a href="#l28.1364"></a><span id="l28.1364" class="difflineminus">-    // XXX this probably doesn't need to be threadsafe</span>
<a href="#l28.1365"></a><span id="l28.1365" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.1366"></a><span id="l28.1366" class="difflineplus">+class nsMsgProtocolStreamProvider : public nsIOutputStreamCallback {</span>
<a href="#l28.1367"></a><span id="l28.1367" class="difflineplus">+ public:</span>
<a href="#l28.1368"></a><span id="l28.1368" class="difflineplus">+  // XXX this probably doesn't need to be threadsafe</span>
<a href="#l28.1369"></a><span id="l28.1369" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.1370"></a><span id="l28.1370" class="difflineplus">+</span>
<a href="#l28.1371"></a><span id="l28.1371" class="difflineplus">+  nsMsgProtocolStreamProvider() {}</span>
<a href="#l28.1372"></a><span id="l28.1372" class="difflineplus">+</span>
<a href="#l28.1373"></a><span id="l28.1373" class="difflineplus">+  void Init(nsMsgAsyncWriteProtocol *aProtInstance,</span>
<a href="#l28.1374"></a><span id="l28.1374" class="difflineplus">+            nsIInputStream *aInputStream) {</span>
<a href="#l28.1375"></a><span id="l28.1375" class="difflineplus">+    mMsgProtocol =</span>
<a href="#l28.1376"></a><span id="l28.1376" class="difflineplus">+        do_GetWeakReference(static_cast&lt;nsIStreamListener *&gt;(aProtInstance));</span>
<a href="#l28.1377"></a><span id="l28.1377" class="difflineplus">+    mInStream = aInputStream;</span>
<a href="#l28.1378"></a><span id="l28.1378" class="difflineplus">+  }</span>
<a href="#l28.1379"></a><span id="l28.1379" class="difflineplus">+</span>
<a href="#l28.1380"></a><span id="l28.1380" class="difflineplus">+  //</span>
<a href="#l28.1381"></a><span id="l28.1381" class="difflineplus">+  // nsIOutputStreamCallback implementation ...</span>
<a href="#l28.1382"></a><span id="l28.1382" class="difflineplus">+  //</span>
<a href="#l28.1383"></a><span id="l28.1383" class="difflineplus">+  NS_IMETHODIMP OnOutputStreamReady(nsIAsyncOutputStream *aOutStream) override {</span>
<a href="#l28.1384"></a><span id="l28.1384" class="difflineplus">+    NS_ASSERTION(mInStream, &quot;not initialized&quot;);</span>
<a href="#l28.1385"></a><span id="l28.1385" class="difflineplus">+</span>
<a href="#l28.1386"></a><span id="l28.1386" class="difflineplus">+    nsresult rv;</span>
<a href="#l28.1387"></a><span id="l28.1387" class="difflineplus">+    uint64_t avail;</span>
<a href="#l28.1388"></a><span id="l28.1388" class="difflineplus">+</span>
<a href="#l28.1389"></a><span id="l28.1389" class="difflineplus">+    // Write whatever is available in the pipe. If the pipe is empty, then</span>
<a href="#l28.1390"></a><span id="l28.1390" class="difflineplus">+    // return NS_BASE_STREAM_WOULD_BLOCK; we will resume the write when there</span>
<a href="#l28.1391"></a><span id="l28.1391" class="difflineplus">+    // is more data.</span>
<a href="#l28.1392"></a><span id="l28.1392"> </span>
<a href="#l28.1393"></a><span id="l28.1393" class="difflineminus">-    nsMsgProtocolStreamProvider() { }</span>
<a href="#l28.1394"></a><span id="l28.1394" class="difflineplus">+    rv = mInStream-&gt;Available(&amp;avail);</span>
<a href="#l28.1395"></a><span id="l28.1395" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1396"></a><span id="l28.1396" class="difflineplus">+</span>
<a href="#l28.1397"></a><span id="l28.1397" class="difflineplus">+    nsMsgAsyncWriteProtocol *protInst = nullptr;</span>
<a href="#l28.1398"></a><span id="l28.1398" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; callback = do_QueryReferent(mMsgProtocol);</span>
<a href="#l28.1399"></a><span id="l28.1399" class="difflineplus">+    if (!callback) return NS_ERROR_FAILURE;</span>
<a href="#l28.1400"></a><span id="l28.1400" class="difflineplus">+    protInst = static_cast&lt;nsMsgAsyncWriteProtocol *&gt;(callback.get());</span>
<a href="#l28.1401"></a><span id="l28.1401" class="difflineplus">+</span>
<a href="#l28.1402"></a><span id="l28.1402" class="difflineplus">+    if (avail == 0 &amp;&amp; !protInst-&gt;mAsyncBuffer.Length()) {</span>
<a href="#l28.1403"></a><span id="l28.1403" class="difflineplus">+      // ok, stop writing...</span>
<a href="#l28.1404"></a><span id="l28.1404" class="difflineplus">+      protInst-&gt;mSuspendedWrite = true;</span>
<a href="#l28.1405"></a><span id="l28.1405" class="difflineplus">+      return NS_OK;</span>
<a href="#l28.1406"></a><span id="l28.1406" class="difflineplus">+    }</span>
<a href="#l28.1407"></a><span id="l28.1407" class="difflineplus">+    protInst-&gt;mSuspendedWrite = false;</span>
<a href="#l28.1408"></a><span id="l28.1408"> </span>
<a href="#l28.1409"></a><span id="l28.1409" class="difflineminus">-    void Init(nsMsgAsyncWriteProtocol *aProtInstance, nsIInputStream *aInputStream)</span>
<a href="#l28.1410"></a><span id="l28.1410" class="difflineminus">-    {</span>
<a href="#l28.1411"></a><span id="l28.1411" class="difflineminus">-      mMsgProtocol = do_GetWeakReference(static_cast&lt;nsIStreamListener*&gt; (aProtInstance));</span>
<a href="#l28.1412"></a><span id="l28.1412" class="difflineminus">-      mInStream = aInputStream;</span>
<a href="#l28.1413"></a><span id="l28.1413" class="difflineplus">+    uint32_t bytesWritten;</span>
<a href="#l28.1414"></a><span id="l28.1414" class="difflineplus">+</span>
<a href="#l28.1415"></a><span id="l28.1415" class="difflineplus">+    if (avail) {</span>
<a href="#l28.1416"></a><span id="l28.1416" class="difflineplus">+      rv = aOutStream-&gt;WriteFrom(mInStream,</span>
<a href="#l28.1417"></a><span id="l28.1417" class="difflineplus">+                                 std::min(avail, uint64_t(FILE_IO_BUFFER_SIZE)),</span>
<a href="#l28.1418"></a><span id="l28.1418" class="difflineplus">+                                 &amp;bytesWritten);</span>
<a href="#l28.1419"></a><span id="l28.1419" class="difflineplus">+      // if were full at the time, the input stream may be backed up and we need</span>
<a href="#l28.1420"></a><span id="l28.1420" class="difflineplus">+      // to read any remains from the last ODA call before we'll get more ODA</span>
<a href="#l28.1421"></a><span id="l28.1421" class="difflineplus">+      // calls</span>
<a href="#l28.1422"></a><span id="l28.1422" class="difflineplus">+      if (protInst-&gt;mSuspendedRead) protInst-&gt;UnblockPostReader();</span>
<a href="#l28.1423"></a><span id="l28.1423" class="difflineplus">+    } else {</span>
<a href="#l28.1424"></a><span id="l28.1424" class="difflineplus">+      rv = aOutStream-&gt;Write(protInst-&gt;mAsyncBuffer.get(),</span>
<a href="#l28.1425"></a><span id="l28.1425" class="difflineplus">+                             protInst-&gt;mAsyncBuffer.Length(), &amp;bytesWritten);</span>
<a href="#l28.1426"></a><span id="l28.1426" class="difflineplus">+      protInst-&gt;mAsyncBuffer.Cut(0, bytesWritten);</span>
<a href="#l28.1427"></a><span id="l28.1427">     }</span>
<a href="#l28.1428"></a><span id="l28.1428"> </span>
<a href="#l28.1429"></a><span id="l28.1429" class="difflineminus">-    //</span>
<a href="#l28.1430"></a><span id="l28.1430" class="difflineminus">-    // nsIOutputStreamCallback implementation ...</span>
<a href="#l28.1431"></a><span id="l28.1431" class="difflineminus">-    //</span>
<a href="#l28.1432"></a><span id="l28.1432" class="difflineminus">-    NS_IMETHODIMP OnOutputStreamReady(nsIAsyncOutputStream *aOutStream) override</span>
<a href="#l28.1433"></a><span id="l28.1433" class="difflineminus">-    {</span>
<a href="#l28.1434"></a><span id="l28.1434" class="difflineminus">-        NS_ASSERTION(mInStream, &quot;not initialized&quot;);</span>
<a href="#l28.1435"></a><span id="l28.1435" class="difflineminus">-</span>
<a href="#l28.1436"></a><span id="l28.1436" class="difflineminus">-        nsresult rv;</span>
<a href="#l28.1437"></a><span id="l28.1437" class="difflineminus">-        uint64_t avail;</span>
<a href="#l28.1438"></a><span id="l28.1438" class="difflineminus">-</span>
<a href="#l28.1439"></a><span id="l28.1439" class="difflineminus">-        // Write whatever is available in the pipe. If the pipe is empty, then</span>
<a href="#l28.1440"></a><span id="l28.1440" class="difflineminus">-        // return NS_BASE_STREAM_WOULD_BLOCK; we will resume the write when there</span>
<a href="#l28.1441"></a><span id="l28.1441" class="difflineminus">-        // is more data.</span>
<a href="#l28.1442"></a><span id="l28.1442" class="difflineplus">+    protInst-&gt;UpdateProgress(bytesWritten);</span>
<a href="#l28.1443"></a><span id="l28.1443"> </span>
<a href="#l28.1444"></a><span id="l28.1444" class="difflineminus">-        rv = mInStream-&gt;Available(&amp;avail);</span>
<a href="#l28.1445"></a><span id="l28.1445" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1446"></a><span id="l28.1446" class="difflineminus">-</span>
<a href="#l28.1447"></a><span id="l28.1447" class="difflineminus">-        nsMsgAsyncWriteProtocol *protInst = nullptr;</span>
<a href="#l28.1448"></a><span id="l28.1448" class="difflineminus">-        nsCOMPtr&lt;nsIStreamListener&gt; callback = do_QueryReferent(mMsgProtocol);</span>
<a href="#l28.1449"></a><span id="l28.1449" class="difflineminus">-        if (!callback)</span>
<a href="#l28.1450"></a><span id="l28.1450" class="difflineminus">-          return NS_ERROR_FAILURE;</span>
<a href="#l28.1451"></a><span id="l28.1451" class="difflineminus">-        protInst = static_cast&lt;nsMsgAsyncWriteProtocol *&gt;(callback.get());</span>
<a href="#l28.1452"></a><span id="l28.1452" class="difflineminus">-</span>
<a href="#l28.1453"></a><span id="l28.1453" class="difflineminus">-        if (avail == 0 &amp;&amp; !protInst-&gt;mAsyncBuffer.Length())</span>
<a href="#l28.1454"></a><span id="l28.1454" class="difflineminus">-        {</span>
<a href="#l28.1455"></a><span id="l28.1455" class="difflineminus">-          // ok, stop writing...</span>
<a href="#l28.1456"></a><span id="l28.1456" class="difflineminus">-          protInst-&gt;mSuspendedWrite = true;</span>
<a href="#l28.1457"></a><span id="l28.1457" class="difflineminus">-          return NS_OK;</span>
<a href="#l28.1458"></a><span id="l28.1458" class="difflineminus">-        }</span>
<a href="#l28.1459"></a><span id="l28.1459" class="difflineminus">-        protInst-&gt;mSuspendedWrite = false;</span>
<a href="#l28.1460"></a><span id="l28.1460" class="difflineplus">+    // try to write again...</span>
<a href="#l28.1461"></a><span id="l28.1461" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l28.1462"></a><span id="l28.1462" class="difflineplus">+      rv = aOutStream-&gt;AsyncWait(this, 0, 0, protInst-&gt;mProviderThread);</span>
<a href="#l28.1463"></a><span id="l28.1463"> </span>
<a href="#l28.1464"></a><span id="l28.1464" class="difflineminus">-        uint32_t bytesWritten;</span>
<a href="#l28.1465"></a><span id="l28.1465" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv) || rv == NS_BINDING_ABORTED,</span>
<a href="#l28.1466"></a><span id="l28.1466" class="difflineplus">+                 &quot;unexpected error writing stream&quot;);</span>
<a href="#l28.1467"></a><span id="l28.1467" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.1468"></a><span id="l28.1468" class="difflineplus">+  }</span>
<a href="#l28.1469"></a><span id="l28.1469"> </span>
<a href="#l28.1470"></a><span id="l28.1470" class="difflineminus">-        if (avail)</span>
<a href="#l28.1471"></a><span id="l28.1471" class="difflineminus">-        {</span>
<a href="#l28.1472"></a><span id="l28.1472" class="difflineminus">-          rv = aOutStream-&gt;WriteFrom(mInStream, std::min(avail, uint64_t(FILE_IO_BUFFER_SIZE)), &amp;bytesWritten);</span>
<a href="#l28.1473"></a><span id="l28.1473" class="difflineminus">-          // if were full at the time, the input stream may be backed up and we need to read any remains from the last ODA call</span>
<a href="#l28.1474"></a><span id="l28.1474" class="difflineminus">-          // before we'll get more ODA calls</span>
<a href="#l28.1475"></a><span id="l28.1475" class="difflineminus">-          if (protInst-&gt;mSuspendedRead)</span>
<a href="#l28.1476"></a><span id="l28.1476" class="difflineminus">-            protInst-&gt;UnblockPostReader();</span>
<a href="#l28.1477"></a><span id="l28.1477" class="difflineminus">-        }</span>
<a href="#l28.1478"></a><span id="l28.1478" class="difflineminus">-        else</span>
<a href="#l28.1479"></a><span id="l28.1479" class="difflineminus">-        {</span>
<a href="#l28.1480"></a><span id="l28.1480" class="difflineminus">-          rv = aOutStream-&gt;Write(protInst-&gt;mAsyncBuffer.get(),</span>
<a href="#l28.1481"></a><span id="l28.1481" class="difflineminus">-                                 protInst-&gt;mAsyncBuffer.Length(),</span>
<a href="#l28.1482"></a><span id="l28.1482" class="difflineminus">-                                 &amp;bytesWritten);</span>
<a href="#l28.1483"></a><span id="l28.1483" class="difflineminus">-          protInst-&gt;mAsyncBuffer.Cut(0, bytesWritten);</span>
<a href="#l28.1484"></a><span id="l28.1484" class="difflineminus">-        }</span>
<a href="#l28.1485"></a><span id="l28.1485" class="difflineminus">-</span>
<a href="#l28.1486"></a><span id="l28.1486" class="difflineminus">-        protInst-&gt;UpdateProgress(bytesWritten);</span>
<a href="#l28.1487"></a><span id="l28.1487" class="difflineminus">-</span>
<a href="#l28.1488"></a><span id="l28.1488" class="difflineminus">-        // try to write again...</span>
<a href="#l28.1489"></a><span id="l28.1489" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l28.1490"></a><span id="l28.1490" class="difflineminus">-          rv = aOutStream-&gt;AsyncWait(this, 0, 0, protInst-&gt;mProviderThread);</span>
<a href="#l28.1491"></a><span id="l28.1491" class="difflineminus">-</span>
<a href="#l28.1492"></a><span id="l28.1492" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv) || rv == NS_BINDING_ABORTED, &quot;unexpected error writing stream&quot;);</span>
<a href="#l28.1493"></a><span id="l28.1493" class="difflineminus">-        return NS_OK;</span>
<a href="#l28.1494"></a><span id="l28.1494" class="difflineminus">-    }</span>
<a href="#l28.1495"></a><span id="l28.1495" class="difflineminus">-</span>
<a href="#l28.1496"></a><span id="l28.1496" class="difflineminus">-</span>
<a href="#l28.1497"></a><span id="l28.1497" class="difflineminus">-protected:</span>
<a href="#l28.1498"></a><span id="l28.1498" class="difflineplus">+ protected:</span>
<a href="#l28.1499"></a><span id="l28.1499">   virtual ~nsMsgProtocolStreamProvider() {}</span>
<a href="#l28.1500"></a><span id="l28.1500"> </span>
<a href="#l28.1501"></a><span id="l28.1501">   nsWeakPtr mMsgProtocol;</span>
<a href="#l28.1502"></a><span id="l28.1502" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt;  mInStream;</span>
<a href="#l28.1503"></a><span id="l28.1503" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; mInStream;</span>
<a href="#l28.1504"></a><span id="l28.1504"> };</span>
<a href="#l28.1505"></a><span id="l28.1505"> </span>
<a href="#l28.1506"></a><span id="l28.1506" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgProtocolStreamProvider,</span>
<a href="#l28.1507"></a><span id="l28.1507" class="difflineminus">-                              nsIOutputStreamCallback)</span>
<a href="#l28.1508"></a><span id="l28.1508" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgProtocolStreamProvider, nsIOutputStreamCallback)</span>
<a href="#l28.1509"></a><span id="l28.1509"> </span>
<a href="#l28.1510"></a><span id="l28.1510" class="difflineminus">-class nsMsgFilePostHelper : public nsIStreamListener</span>
<a href="#l28.1511"></a><span id="l28.1511" class="difflineminus">-{</span>
<a href="#l28.1512"></a><span id="l28.1512" class="difflineminus">-public:</span>
<a href="#l28.1513"></a><span id="l28.1513" class="difflineplus">+class nsMsgFilePostHelper : public nsIStreamListener {</span>
<a href="#l28.1514"></a><span id="l28.1514" class="difflineplus">+ public:</span>
<a href="#l28.1515"></a><span id="l28.1515">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.1516"></a><span id="l28.1516">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l28.1517"></a><span id="l28.1517">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l28.1518"></a><span id="l28.1518"> </span>
<a href="#l28.1519"></a><span id="l28.1519" class="difflineminus">-  nsMsgFilePostHelper() { mSuspendedPostFileRead = false;}</span>
<a href="#l28.1520"></a><span id="l28.1520" class="difflineminus">-  nsresult Init(nsIOutputStream * aOutStream, nsMsgAsyncWriteProtocol * aProtInstance, nsIFile *aFileToPost);</span>
<a href="#l28.1521"></a><span id="l28.1521" class="difflineplus">+  nsMsgFilePostHelper() { mSuspendedPostFileRead = false; }</span>
<a href="#l28.1522"></a><span id="l28.1522" class="difflineplus">+  nsresult Init(nsIOutputStream *aOutStream,</span>
<a href="#l28.1523"></a><span id="l28.1523" class="difflineplus">+                nsMsgAsyncWriteProtocol *aProtInstance, nsIFile *aFileToPost);</span>
<a href="#l28.1524"></a><span id="l28.1524">   nsCOMPtr&lt;nsIRequest&gt; mPostFileRequest;</span>
<a href="#l28.1525"></a><span id="l28.1525">   bool mSuspendedPostFileRead;</span>
<a href="#l28.1526"></a><span id="l28.1526">   void CloseSocket() { mProtInstance = nullptr; }</span>
<a href="#l28.1527"></a><span id="l28.1527" class="difflineminus">-protected:</span>
<a href="#l28.1528"></a><span id="l28.1528" class="difflineplus">+</span>
<a href="#l28.1529"></a><span id="l28.1529" class="difflineplus">+ protected:</span>
<a href="#l28.1530"></a><span id="l28.1530">   virtual ~nsMsgFilePostHelper() {}</span>
<a href="#l28.1531"></a><span id="l28.1531">   nsCOMPtr&lt;nsIOutputStream&gt; mOutStream;</span>
<a href="#l28.1532"></a><span id="l28.1532">   nsWeakPtr mProtInstance;</span>
<a href="#l28.1533"></a><span id="l28.1533"> };</span>
<a href="#l28.1534"></a><span id="l28.1534"> </span>
<a href="#l28.1535"></a><span id="l28.1535"> NS_IMPL_ISUPPORTS(nsMsgFilePostHelper, nsIStreamListener, nsIRequestObserver)</span>
<a href="#l28.1536"></a><span id="l28.1536"> </span>
<a href="#l28.1537"></a><span id="l28.1537" class="difflineminus">-nsresult nsMsgFilePostHelper::Init(nsIOutputStream * aOutStream, nsMsgAsyncWriteProtocol * aProtInstance, nsIFile *aFileToPost)</span>
<a href="#l28.1538"></a><span id="l28.1538" class="difflineminus">-{</span>
<a href="#l28.1539"></a><span id="l28.1539" class="difflineplus">+nsresult nsMsgFilePostHelper::Init(nsIOutputStream *aOutStream,</span>
<a href="#l28.1540"></a><span id="l28.1540" class="difflineplus">+                                   nsMsgAsyncWriteProtocol *aProtInstance,</span>
<a href="#l28.1541"></a><span id="l28.1541" class="difflineplus">+                                   nsIFile *aFileToPost) {</span>
<a href="#l28.1542"></a><span id="l28.1542">   nsresult rv = NS_OK;</span>
<a href="#l28.1543"></a><span id="l28.1543">   mOutStream = aOutStream;</span>
<a href="#l28.1544"></a><span id="l28.1544" class="difflineminus">-  mProtInstance = do_GetWeakReference(static_cast&lt;nsIStreamListener*&gt; (aProtInstance));</span>
<a href="#l28.1545"></a><span id="l28.1545" class="difflineplus">+  mProtInstance =</span>
<a href="#l28.1546"></a><span id="l28.1546" class="difflineplus">+      do_GetWeakReference(static_cast&lt;nsIStreamListener *&gt;(aProtInstance));</span>
<a href="#l28.1547"></a><span id="l28.1547"> </span>
<a href="#l28.1548"></a><span id="l28.1548">   nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l28.1549"></a><span id="l28.1549">   rv = NS_NewLocalFileInputStream(getter_AddRefs(stream), aFileToPost);</span>
<a href="#l28.1550"></a><span id="l28.1550">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1551"></a><span id="l28.1551"> </span>
<a href="#l28.1552"></a><span id="l28.1552">   nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l28.1553"></a><span id="l28.1553">   rv = NS_NewInputStreamPump(getter_AddRefs(pump), stream.forget());</span>
<a href="#l28.1554"></a><span id="l28.1554">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1555"></a><span id="l28.1555"> </span>
<a href="#l28.1556"></a><span id="l28.1556">   rv = pump-&gt;AsyncRead(this, nullptr);</span>
<a href="#l28.1557"></a><span id="l28.1557">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1558"></a><span id="l28.1558"> </span>
<a href="#l28.1559"></a><span id="l28.1559">   mPostFileRequest = pump;</span>
<a href="#l28.1560"></a><span id="l28.1560">   return NS_OK;</span>
<a href="#l28.1561"></a><span id="l28.1561"> }</span>
<a href="#l28.1562"></a><span id="l28.1562"> </span>
<a href="#l28.1563"></a><span id="l28.1563" class="difflineminus">-NS_IMETHODIMP nsMsgFilePostHelper::OnStartRequest(nsIRequest * aChannel)</span>
<a href="#l28.1564"></a><span id="l28.1564" class="difflineminus">-{</span>
<a href="#l28.1565"></a><span id="l28.1565" class="difflineplus">+NS_IMETHODIMP nsMsgFilePostHelper::OnStartRequest(nsIRequest *aChannel) {</span>
<a href="#l28.1566"></a><span id="l28.1566">   return NS_OK;</span>
<a href="#l28.1567"></a><span id="l28.1567"> }</span>
<a href="#l28.1568"></a><span id="l28.1568"> </span>
<a href="#l28.1569"></a><span id="l28.1569" class="difflineminus">-NS_IMETHODIMP nsMsgFilePostHelper::OnStopRequest(nsIRequest * aChannel, nsresult aStatus)</span>
<a href="#l28.1570"></a><span id="l28.1570" class="difflineminus">-{</span>
<a href="#l28.1571"></a><span id="l28.1571" class="difflineplus">+NS_IMETHODIMP nsMsgFilePostHelper::OnStopRequest(nsIRequest *aChannel,</span>
<a href="#l28.1572"></a><span id="l28.1572" class="difflineplus">+                                                 nsresult aStatus) {</span>
<a href="#l28.1573"></a><span id="l28.1573">   nsMsgAsyncWriteProtocol *protInst = nullptr;</span>
<a href="#l28.1574"></a><span id="l28.1574">   nsCOMPtr&lt;nsIStreamListener&gt; callback = do_QueryReferent(mProtInstance);</span>
<a href="#l28.1575"></a><span id="l28.1575" class="difflineminus">-  if (!callback)</span>
<a href="#l28.1576"></a><span id="l28.1576" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.1577"></a><span id="l28.1577" class="difflineplus">+  if (!callback) return NS_OK;</span>
<a href="#l28.1578"></a><span id="l28.1578">   protInst = static_cast&lt;nsMsgAsyncWriteProtocol *&gt;(callback.get());</span>
<a href="#l28.1579"></a><span id="l28.1579"> </span>
<a href="#l28.1580"></a><span id="l28.1580" class="difflineminus">-  if (!mSuspendedPostFileRead)</span>
<a href="#l28.1581"></a><span id="l28.1581" class="difflineminus">-    protInst-&gt;PostDataFinished();</span>
<a href="#l28.1582"></a><span id="l28.1582" class="difflineplus">+  if (!mSuspendedPostFileRead) protInst-&gt;PostDataFinished();</span>
<a href="#l28.1583"></a><span id="l28.1583"> </span>
<a href="#l28.1584"></a><span id="l28.1584">   mSuspendedPostFileRead = false;</span>
<a href="#l28.1585"></a><span id="l28.1585">   protInst-&gt;mFilePostHelper = nullptr;</span>
<a href="#l28.1586"></a><span id="l28.1586">   return NS_OK;</span>
<a href="#l28.1587"></a><span id="l28.1587"> }</span>
<a href="#l28.1588"></a><span id="l28.1588"> </span>
<a href="#l28.1589"></a><span id="l28.1589" class="difflineminus">-NS_IMETHODIMP nsMsgFilePostHelper::OnDataAvailable(nsIRequest * /* aChannel */, nsIInputStream *inStr, uint64_t sourceOffset, uint32_t count)</span>
<a href="#l28.1590"></a><span id="l28.1590" class="difflineminus">-{</span>
<a href="#l28.1591"></a><span id="l28.1591" class="difflineplus">+NS_IMETHODIMP nsMsgFilePostHelper::OnDataAvailable(nsIRequest * /* aChannel */,</span>
<a href="#l28.1592"></a><span id="l28.1592" class="difflineplus">+                                                   nsIInputStream *inStr,</span>
<a href="#l28.1593"></a><span id="l28.1593" class="difflineplus">+                                                   uint64_t sourceOffset,</span>
<a href="#l28.1594"></a><span id="l28.1594" class="difflineplus">+                                                   uint32_t count) {</span>
<a href="#l28.1595"></a><span id="l28.1595">   nsMsgAsyncWriteProtocol *protInst = nullptr;</span>
<a href="#l28.1596"></a><span id="l28.1596">   nsCOMPtr&lt;nsIStreamListener&gt; callback = do_QueryReferent(mProtInstance);</span>
<a href="#l28.1597"></a><span id="l28.1597" class="difflineminus">-  if (!callback)</span>
<a href="#l28.1598"></a><span id="l28.1598" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.1599"></a><span id="l28.1599" class="difflineplus">+  if (!callback) return NS_OK;</span>
<a href="#l28.1600"></a><span id="l28.1600"> </span>
<a href="#l28.1601"></a><span id="l28.1601">   protInst = static_cast&lt;nsMsgAsyncWriteProtocol *&gt;(callback.get());</span>
<a href="#l28.1602"></a><span id="l28.1602"> </span>
<a href="#l28.1603"></a><span id="l28.1603" class="difflineminus">-  if (mSuspendedPostFileRead)</span>
<a href="#l28.1604"></a><span id="l28.1604" class="difflineminus">-  {</span>
<a href="#l28.1605"></a><span id="l28.1605" class="difflineplus">+  if (mSuspendedPostFileRead) {</span>
<a href="#l28.1606"></a><span id="l28.1606">     protInst-&gt;UpdateSuspendedReadBytes(count, protInst-&gt;mInsertPeriodRequired);</span>
<a href="#l28.1607"></a><span id="l28.1607">     return NS_OK;</span>
<a href="#l28.1608"></a><span id="l28.1608">   }</span>
<a href="#l28.1609"></a><span id="l28.1609"> </span>
<a href="#l28.1610"></a><span id="l28.1610">   protInst-&gt;ProcessIncomingPostData(inStr, count);</span>
<a href="#l28.1611"></a><span id="l28.1611"> </span>
<a href="#l28.1612"></a><span id="l28.1612" class="difflineminus">-  if (protInst-&gt;mSuspendedWrite)</span>
<a href="#l28.1613"></a><span id="l28.1613" class="difflineminus">-  {</span>
<a href="#l28.1614"></a><span id="l28.1614" class="difflineminus">-    // if we got here then we had suspended the write 'cause we didn't have anymore</span>
<a href="#l28.1615"></a><span id="l28.1615" class="difflineminus">-    // data to write (i.e. the pipe went empty). So resume the channel to kick</span>
<a href="#l28.1616"></a><span id="l28.1616" class="difflineminus">-    // things off again.</span>
<a href="#l28.1617"></a><span id="l28.1617" class="difflineplus">+  if (protInst-&gt;mSuspendedWrite) {</span>
<a href="#l28.1618"></a><span id="l28.1618" class="difflineplus">+    // if we got here then we had suspended the write 'cause we didn't have</span>
<a href="#l28.1619"></a><span id="l28.1619" class="difflineplus">+    // anymore data to write (i.e. the pipe went empty). So resume the channel</span>
<a href="#l28.1620"></a><span id="l28.1620" class="difflineplus">+    // to kick things off again.</span>
<a href="#l28.1621"></a><span id="l28.1621">     protInst-&gt;mSuspendedWrite = false;</span>
<a href="#l28.1622"></a><span id="l28.1622">     protInst-&gt;mAsyncOutStream-&gt;AsyncWait(protInst-&gt;mProvider, 0, 0,</span>
<a href="#l28.1623"></a><span id="l28.1623">                                          protInst-&gt;mProviderThread);</span>
<a href="#l28.1624"></a><span id="l28.1624">   }</span>
<a href="#l28.1625"></a><span id="l28.1625"> </span>
<a href="#l28.1626"></a><span id="l28.1626">   return NS_OK;</span>
<a href="#l28.1627"></a><span id="l28.1627"> }</span>
<a href="#l28.1628"></a><span id="l28.1628"> </span>
<a href="#l28.1629"></a><span id="l28.1629"> NS_IMPL_ADDREF_INHERITED(nsMsgAsyncWriteProtocol, nsMsgProtocol)</span>
<a href="#l28.1630"></a><span id="l28.1630"> NS_IMPL_RELEASE_INHERITED(nsMsgAsyncWriteProtocol, nsMsgProtocol)</span>
<a href="#l28.1631"></a><span id="l28.1631"> </span>
<a href="#l28.1632"></a><span id="l28.1632"> NS_INTERFACE_MAP_BEGIN(nsMsgAsyncWriteProtocol)</span>
<a href="#l28.1633"></a><span id="l28.1633">   NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l28.1634"></a><span id="l28.1634"> NS_INTERFACE_MAP_END_INHERITING(nsMsgProtocol)</span>
<a href="#l28.1635"></a><span id="l28.1635"> </span>
<a href="#l28.1636"></a><span id="l28.1636" class="difflineminus">-nsMsgAsyncWriteProtocol::nsMsgAsyncWriteProtocol(nsIURI * aURL) : nsMsgProtocol(aURL)</span>
<a href="#l28.1637"></a><span id="l28.1637" class="difflineminus">-{</span>
<a href="#l28.1638"></a><span id="l28.1638" class="difflineplus">+nsMsgAsyncWriteProtocol::nsMsgAsyncWriteProtocol(nsIURI *aURL)</span>
<a href="#l28.1639"></a><span id="l28.1639" class="difflineplus">+    : nsMsgProtocol(aURL) {</span>
<a href="#l28.1640"></a><span id="l28.1640">   mSuspendedWrite = false;</span>
<a href="#l28.1641"></a><span id="l28.1641">   mSuspendedReadBytes = 0;</span>
<a href="#l28.1642"></a><span id="l28.1642">   mSuspendedRead = false;</span>
<a href="#l28.1643"></a><span id="l28.1643">   mInsertPeriodRequired = false;</span>
<a href="#l28.1644"></a><span id="l28.1644">   mGenerateProgressNotifications = false;</span>
<a href="#l28.1645"></a><span id="l28.1645">   mSuspendedReadBytesPostPeriod = 0;</span>
<a href="#l28.1646"></a><span id="l28.1646">   mFilePostHelper = nullptr;</span>
<a href="#l28.1647"></a><span id="l28.1647"> }</span>
<a href="#l28.1648"></a><span id="l28.1648"> </span>
<a href="#l28.1649"></a><span id="l28.1649" class="difflineminus">-nsMsgAsyncWriteProtocol::~nsMsgAsyncWriteProtocol()</span>
<a href="#l28.1650"></a><span id="l28.1650" class="difflineminus">-{}</span>
<a href="#l28.1651"></a><span id="l28.1651" class="difflineplus">+nsMsgAsyncWriteProtocol::~nsMsgAsyncWriteProtocol() {}</span>
<a href="#l28.1652"></a><span id="l28.1652"> </span>
<a href="#l28.1653"></a><span id="l28.1653" class="difflineminus">-NS_IMETHODIMP nsMsgAsyncWriteProtocol::Cancel(nsresult status)</span>
<a href="#l28.1654"></a><span id="l28.1654" class="difflineminus">-{</span>
<a href="#l28.1655"></a><span id="l28.1655" class="difflineplus">+NS_IMETHODIMP nsMsgAsyncWriteProtocol::Cancel(nsresult status) {</span>
<a href="#l28.1656"></a><span id="l28.1656">   mGenerateProgressNotifications = false;</span>
<a href="#l28.1657"></a><span id="l28.1657"> </span>
<a href="#l28.1658"></a><span id="l28.1658" class="difflineminus">-  if (m_proxyRequest)</span>
<a href="#l28.1659"></a><span id="l28.1659" class="difflineminus">-  {</span>
<a href="#l28.1660"></a><span id="l28.1660" class="difflineplus">+  if (m_proxyRequest) {</span>
<a href="#l28.1661"></a><span id="l28.1661">     m_proxyRequest-&gt;Cancel(status);</span>
<a href="#l28.1662"></a><span id="l28.1662">   }</span>
<a href="#l28.1663"></a><span id="l28.1663"> </span>
<a href="#l28.1664"></a><span id="l28.1664" class="difflineminus">-  if (m_request)</span>
<a href="#l28.1665"></a><span id="l28.1665" class="difflineminus">-    m_request-&gt;Cancel(status);</span>
<a href="#l28.1666"></a><span id="l28.1666" class="difflineplus">+  if (m_request) m_request-&gt;Cancel(status);</span>
<a href="#l28.1667"></a><span id="l28.1667"> </span>
<a href="#l28.1668"></a><span id="l28.1668" class="difflineminus">-  if (mAsyncOutStream)</span>
<a href="#l28.1669"></a><span id="l28.1669" class="difflineminus">-    mAsyncOutStream-&gt;CloseWithStatus(status);</span>
<a href="#l28.1670"></a><span id="l28.1670" class="difflineplus">+  if (mAsyncOutStream) mAsyncOutStream-&gt;CloseWithStatus(status);</span>
<a href="#l28.1671"></a><span id="l28.1671"> </span>
<a href="#l28.1672"></a><span id="l28.1672">   return NS_OK;</span>
<a href="#l28.1673"></a><span id="l28.1673"> }</span>
<a href="#l28.1674"></a><span id="l28.1674"> </span>
<a href="#l28.1675"></a><span id="l28.1675" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::PostMessage(nsIURI* url, nsIFile *file)</span>
<a href="#l28.1676"></a><span id="l28.1676" class="difflineminus">-{</span>
<a href="#l28.1677"></a><span id="l28.1677" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::PostMessage(nsIURI *url, nsIFile *file) {</span>
<a href="#l28.1678"></a><span id="l28.1678">   nsCOMPtr&lt;nsIStreamListener&gt; listener = new nsMsgFilePostHelper();</span>
<a href="#l28.1679"></a><span id="l28.1679"> </span>
<a href="#l28.1680"></a><span id="l28.1680">   if (!listener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1681"></a><span id="l28.1681"> </span>
<a href="#l28.1682"></a><span id="l28.1682">   // be sure to initialize some state before posting</span>
<a href="#l28.1683"></a><span id="l28.1683">   mSuspendedReadBytes = 0;</span>
<a href="#l28.1684"></a><span id="l28.1684">   mNumBytesPosted = 0;</span>
<a href="#l28.1685"></a><span id="l28.1685">   file-&gt;GetFileSize(&amp;mFilePostSize);</span>
<a href="#l28.1686"></a><span id="l28.1686">   mSuspendedRead = false;</span>
<a href="#l28.1687"></a><span id="l28.1687">   mInsertPeriodRequired = false;</span>
<a href="#l28.1688"></a><span id="l28.1688">   mSuspendedReadBytesPostPeriod = 0;</span>
<a href="#l28.1689"></a><span id="l28.1689">   mGenerateProgressNotifications = true;</span>
<a href="#l28.1690"></a><span id="l28.1690"> </span>
<a href="#l28.1691"></a><span id="l28.1691" class="difflineminus">-  mFilePostHelper = static_cast&lt;nsMsgFilePostHelper*&gt;(static_cast&lt;nsIStreamListener*&gt;(listener));</span>
<a href="#l28.1692"></a><span id="l28.1692" class="difflineplus">+  mFilePostHelper = static_cast&lt;nsMsgFilePostHelper *&gt;(</span>
<a href="#l28.1693"></a><span id="l28.1693" class="difflineplus">+      static_cast&lt;nsIStreamListener *&gt;(listener));</span>
<a href="#l28.1694"></a><span id="l28.1694"> </span>
<a href="#l28.1695"></a><span id="l28.1695" class="difflineminus">-  static_cast&lt;nsMsgFilePostHelper*&gt;(static_cast&lt;nsIStreamListener*&gt;(listener))-&gt;Init(m_outputStream, this, file);</span>
<a href="#l28.1696"></a><span id="l28.1696" class="difflineplus">+  static_cast&lt;nsMsgFilePostHelper *&gt;(static_cast&lt;nsIStreamListener *&gt;(listener))</span>
<a href="#l28.1697"></a><span id="l28.1697" class="difflineplus">+      -&gt;Init(m_outputStream, this, file);</span>
<a href="#l28.1698"></a><span id="l28.1698"> </span>
<a href="#l28.1699"></a><span id="l28.1699">   return NS_OK;</span>
<a href="#l28.1700"></a><span id="l28.1700"> }</span>
<a href="#l28.1701"></a><span id="l28.1701"> </span>
<a href="#l28.1702"></a><span id="l28.1702" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::SuspendPostFileRead()</span>
<a href="#l28.1703"></a><span id="l28.1703" class="difflineminus">-{</span>
<a href="#l28.1704"></a><span id="l28.1704" class="difflineminus">-  if (mFilePostHelper &amp;&amp; !mFilePostHelper-&gt;mSuspendedPostFileRead)</span>
<a href="#l28.1705"></a><span id="l28.1705" class="difflineminus">-  {</span>
<a href="#l28.1706"></a><span id="l28.1706" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::SuspendPostFileRead() {</span>
<a href="#l28.1707"></a><span id="l28.1707" class="difflineplus">+  if (mFilePostHelper &amp;&amp; !mFilePostHelper-&gt;mSuspendedPostFileRead) {</span>
<a href="#l28.1708"></a><span id="l28.1708">     // uhoh we need to pause reading in the file until we get unblocked...</span>
<a href="#l28.1709"></a><span id="l28.1709">     mFilePostHelper-&gt;mPostFileRequest-&gt;Suspend();</span>
<a href="#l28.1710"></a><span id="l28.1710">     mFilePostHelper-&gt;mSuspendedPostFileRead = true;</span>
<a href="#l28.1711"></a><span id="l28.1711">   }</span>
<a href="#l28.1712"></a><span id="l28.1712"> </span>
<a href="#l28.1713"></a><span id="l28.1713">   return NS_OK;</span>
<a href="#l28.1714"></a><span id="l28.1714"> }</span>
<a href="#l28.1715"></a><span id="l28.1715"> </span>
<a href="#l28.1716"></a><span id="l28.1716" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::ResumePostFileRead()</span>
<a href="#l28.1717"></a><span id="l28.1717" class="difflineminus">-{</span>
<a href="#l28.1718"></a><span id="l28.1718" class="difflineminus">-  if (mFilePostHelper)</span>
<a href="#l28.1719"></a><span id="l28.1719" class="difflineminus">-  {</span>
<a href="#l28.1720"></a><span id="l28.1720" class="difflineminus">-    if (mFilePostHelper-&gt;mSuspendedPostFileRead)</span>
<a href="#l28.1721"></a><span id="l28.1721" class="difflineminus">-    {</span>
<a href="#l28.1722"></a><span id="l28.1722" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::ResumePostFileRead() {</span>
<a href="#l28.1723"></a><span id="l28.1723" class="difflineplus">+  if (mFilePostHelper) {</span>
<a href="#l28.1724"></a><span id="l28.1724" class="difflineplus">+    if (mFilePostHelper-&gt;mSuspendedPostFileRead) {</span>
<a href="#l28.1725"></a><span id="l28.1725">       mFilePostHelper-&gt;mPostFileRequest-&gt;Resume();</span>
<a href="#l28.1726"></a><span id="l28.1726">       mFilePostHelper-&gt;mSuspendedPostFileRead = false;</span>
<a href="#l28.1727"></a><span id="l28.1727">     }</span>
<a href="#l28.1728"></a><span id="l28.1728" class="difflineminus">-  }</span>
<a href="#l28.1729"></a><span id="l28.1729" class="difflineminus">-  else // we must be done with the download so send the '.'</span>
<a href="#l28.1730"></a><span id="l28.1730" class="difflineplus">+  } else  // we must be done with the download so send the '.'</span>
<a href="#l28.1731"></a><span id="l28.1731">   {</span>
<a href="#l28.1732"></a><span id="l28.1732">     PostDataFinished();</span>
<a href="#l28.1733"></a><span id="l28.1733">   }</span>
<a href="#l28.1734"></a><span id="l28.1734"> </span>
<a href="#l28.1735"></a><span id="l28.1735">   return NS_OK;</span>
<a href="#l28.1736"></a><span id="l28.1736"> }</span>
<a href="#l28.1737"></a><span id="l28.1737"> </span>
<a href="#l28.1738"></a><span id="l28.1738" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::UpdateSuspendedReadBytes(uint32_t aNewBytes, bool aAddToPostPeriodByteCount)</span>
<a href="#l28.1739"></a><span id="l28.1739" class="difflineminus">-{</span>
<a href="#l28.1740"></a><span id="l28.1740" class="difflineminus">-  // depending on our current state, we'll either add aNewBytes to mSuspendedReadBytes</span>
<a href="#l28.1741"></a><span id="l28.1741" class="difflineminus">-  // or mSuspendedReadBytesAfterPeriod.</span>
<a href="#l28.1742"></a><span id="l28.1742" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::UpdateSuspendedReadBytes(</span>
<a href="#l28.1743"></a><span id="l28.1743" class="difflineplus">+    uint32_t aNewBytes, bool aAddToPostPeriodByteCount) {</span>
<a href="#l28.1744"></a><span id="l28.1744" class="difflineplus">+  // depending on our current state, we'll either add aNewBytes to</span>
<a href="#l28.1745"></a><span id="l28.1745" class="difflineplus">+  // mSuspendedReadBytes or mSuspendedReadBytesAfterPeriod.</span>
<a href="#l28.1746"></a><span id="l28.1746"> </span>
<a href="#l28.1747"></a><span id="l28.1747">   mSuspendedRead = true;</span>
<a href="#l28.1748"></a><span id="l28.1748">   if (aAddToPostPeriodByteCount)</span>
<a href="#l28.1749"></a><span id="l28.1749">     mSuspendedReadBytesPostPeriod += aNewBytes;</span>
<a href="#l28.1750"></a><span id="l28.1750">   else</span>
<a href="#l28.1751"></a><span id="l28.1751">     mSuspendedReadBytes += aNewBytes;</span>
<a href="#l28.1752"></a><span id="l28.1752"> </span>
<a href="#l28.1753"></a><span id="l28.1753">   return NS_OK;</span>
<a href="#l28.1754"></a><span id="l28.1754"> }</span>
<a href="#l28.1755"></a><span id="l28.1755"> </span>
<a href="#l28.1756"></a><span id="l28.1756" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::PostDataFinished()</span>
<a href="#l28.1757"></a><span id="l28.1757" class="difflineminus">-{</span>
<a href="#l28.1758"></a><span id="l28.1758" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::PostDataFinished() {</span>
<a href="#l28.1759"></a><span id="l28.1759">   nsresult rv = SendData(&quot;.&quot; CRLF);</span>
<a href="#l28.1760"></a><span id="l28.1760" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l28.1761"></a><span id="l28.1761" class="difflineminus">-    return rv;</span>
<a href="#l28.1762"></a><span id="l28.1762" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1763"></a><span id="l28.1763">   mGenerateProgressNotifications = false;</span>
<a href="#l28.1764"></a><span id="l28.1764">   mPostDataStream = nullptr;</span>
<a href="#l28.1765"></a><span id="l28.1765">   return NS_OK;</span>
<a href="#l28.1766"></a><span id="l28.1766"> }</span>
<a href="#l28.1767"></a><span id="l28.1767"> </span>
<a href="#l28.1768"></a><span id="l28.1768" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::ProcessIncomingPostData(nsIInputStream *inStr, uint32_t count)</span>
<a href="#l28.1769"></a><span id="l28.1769" class="difflineminus">-{</span>
<a href="#l28.1770"></a><span id="l28.1770" class="difflineminus">-  if (!m_socketIsOpen) return NS_OK; // kick out if the socket was canceled</span>
<a href="#l28.1771"></a><span id="l28.1771" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::ProcessIncomingPostData(nsIInputStream *inStr,</span>
<a href="#l28.1772"></a><span id="l28.1772" class="difflineplus">+                                                          uint32_t count) {</span>
<a href="#l28.1773"></a><span id="l28.1773" class="difflineplus">+  if (!m_socketIsOpen) return NS_OK;  // kick out if the socket was canceled</span>
<a href="#l28.1774"></a><span id="l28.1774"> </span>
<a href="#l28.1775"></a><span id="l28.1775">   // We need to quote any '.' that occur at the beginning of a line.</span>
<a href="#l28.1776"></a><span id="l28.1776" class="difflineminus">-  // but I don't want to waste time reading out the data into a buffer and searching</span>
<a href="#l28.1777"></a><span id="l28.1777" class="difflineminus">-  // let's try to leverage nsIBufferedInputStream and see if we can &quot;peek&quot; into the</span>
<a href="#l28.1778"></a><span id="l28.1778" class="difflineminus">-  // current contents for this particular case.</span>
<a href="#l28.1779"></a><span id="l28.1779" class="difflineplus">+  // but I don't want to waste time reading out the data into a buffer and</span>
<a href="#l28.1780"></a><span id="l28.1780" class="difflineplus">+  // searching let's try to leverage nsIBufferedInputStream and see if we can</span>
<a href="#l28.1781"></a><span id="l28.1781" class="difflineplus">+  // &quot;peek&quot; into the current contents for this particular case.</span>
<a href="#l28.1782"></a><span id="l28.1782"> </span>
<a href="#l28.1783"></a><span id="l28.1783">   nsCOMPtr&lt;nsISearchableInputStream&gt; bufferInputStr = do_QueryInterface(inStr);</span>
<a href="#l28.1784"></a><span id="l28.1784" class="difflineminus">-  NS_ASSERTION(bufferInputStr, &quot;i made a wrong assumption about the type of stream we are getting&quot;);</span>
<a href="#l28.1785"></a><span id="l28.1785" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l28.1786"></a><span id="l28.1786" class="difflineplus">+      bufferInputStr,</span>
<a href="#l28.1787"></a><span id="l28.1787" class="difflineplus">+      &quot;i made a wrong assumption about the type of stream we are getting&quot;);</span>
<a href="#l28.1788"></a><span id="l28.1788">   NS_ASSERTION(mSuspendedReadBytes == 0, &quot;oops, I missed something&quot;);</span>
<a href="#l28.1789"></a><span id="l28.1789"> </span>
<a href="#l28.1790"></a><span id="l28.1790">   if (!mPostDataStream) mPostDataStream = inStr;</span>
<a href="#l28.1791"></a><span id="l28.1791"> </span>
<a href="#l28.1792"></a><span id="l28.1792" class="difflineminus">-  if (bufferInputStr)</span>
<a href="#l28.1793"></a><span id="l28.1793" class="difflineminus">-  {</span>
<a href="#l28.1794"></a><span id="l28.1794" class="difflineplus">+  if (bufferInputStr) {</span>
<a href="#l28.1795"></a><span id="l28.1795">     uint32_t amountWritten;</span>
<a href="#l28.1796"></a><span id="l28.1796"> </span>
<a href="#l28.1797"></a><span id="l28.1797" class="difflineminus">-    while (count &gt; 0)</span>
<a href="#l28.1798"></a><span id="l28.1798" class="difflineminus">-    {</span>
<a href="#l28.1799"></a><span id="l28.1799" class="difflineplus">+    while (count &gt; 0) {</span>
<a href="#l28.1800"></a><span id="l28.1800">       bool found = false;</span>
<a href="#l28.1801"></a><span id="l28.1801">       uint32_t offset = 0;</span>
<a href="#l28.1802"></a><span id="l28.1802" class="difflineminus">-      bufferInputStr-&gt;Search(&quot;\012.&quot;, true,  &amp;found, &amp;offset); // LF.</span>
<a href="#l28.1803"></a><span id="l28.1803" class="difflineplus">+      bufferInputStr-&gt;Search(&quot;\012.&quot;, true, &amp;found, &amp;offset);  // LF.</span>
<a href="#l28.1804"></a><span id="l28.1804"> </span>
<a href="#l28.1805"></a><span id="l28.1805" class="difflineminus">-      if (!found || offset &gt; count)</span>
<a href="#l28.1806"></a><span id="l28.1806" class="difflineminus">-      {</span>
<a href="#l28.1807"></a><span id="l28.1807" class="difflineplus">+      if (!found || offset &gt; count) {</span>
<a href="#l28.1808"></a><span id="l28.1808">         // push this data into the output stream</span>
<a href="#l28.1809"></a><span id="l28.1809">         m_outputStream-&gt;WriteFrom(inStr, count, &amp;amountWritten);</span>
<a href="#l28.1810"></a><span id="l28.1810">         // store any remains which need read out at a later date</span>
<a href="#l28.1811"></a><span id="l28.1811" class="difflineminus">-        if (count &gt; amountWritten) // stream will block</span>
<a href="#l28.1812"></a><span id="l28.1812" class="difflineplus">+        if (count &gt; amountWritten)  // stream will block</span>
<a href="#l28.1813"></a><span id="l28.1813">         {</span>
<a href="#l28.1814"></a><span id="l28.1814">           UpdateSuspendedReadBytes(count - amountWritten, false);</span>
<a href="#l28.1815"></a><span id="l28.1815">           SuspendPostFileRead();</span>
<a href="#l28.1816"></a><span id="l28.1816">         }</span>
<a href="#l28.1817"></a><span id="l28.1817">         break;</span>
<a href="#l28.1818"></a><span id="l28.1818" class="difflineminus">-      }</span>
<a href="#l28.1819"></a><span id="l28.1819" class="difflineminus">-      else</span>
<a href="#l28.1820"></a><span id="l28.1820" class="difflineminus">-      {</span>
<a href="#l28.1821"></a><span id="l28.1821" class="difflineplus">+      } else {</span>
<a href="#l28.1822"></a><span id="l28.1822">         // count points to the LF in a LF followed by a '.'</span>
<a href="#l28.1823"></a><span id="l28.1823">         // go ahead and write up to offset..</span>
<a href="#l28.1824"></a><span id="l28.1824">         m_outputStream-&gt;WriteFrom(inStr, offset + 1, &amp;amountWritten);</span>
<a href="#l28.1825"></a><span id="l28.1825">         count -= amountWritten;</span>
<a href="#l28.1826"></a><span id="l28.1826" class="difflineminus">-        if (offset+1 &gt; amountWritten)</span>
<a href="#l28.1827"></a><span id="l28.1827" class="difflineminus">-        {</span>
<a href="#l28.1828"></a><span id="l28.1828" class="difflineminus">-          UpdateSuspendedReadBytes(offset+1 - amountWritten, false);</span>
<a href="#l28.1829"></a><span id="l28.1829" class="difflineplus">+        if (offset + 1 &gt; amountWritten) {</span>
<a href="#l28.1830"></a><span id="l28.1830" class="difflineplus">+          UpdateSuspendedReadBytes(offset + 1 - amountWritten, false);</span>
<a href="#l28.1831"></a><span id="l28.1831">           mInsertPeriodRequired = true;</span>
<a href="#l28.1832"></a><span id="l28.1832">           UpdateSuspendedReadBytes(count, mInsertPeriodRequired);</span>
<a href="#l28.1833"></a><span id="l28.1833">           SuspendPostFileRead();</span>
<a href="#l28.1834"></a><span id="l28.1834">           break;</span>
<a href="#l28.1835"></a><span id="l28.1835">         }</span>
<a href="#l28.1836"></a><span id="l28.1836"> </span>
<a href="#l28.1837"></a><span id="l28.1837">         // write out the extra '.'</span>
<a href="#l28.1838"></a><span id="l28.1838">         m_outputStream-&gt;Write(&quot;.&quot;, 1, &amp;amountWritten);</span>
<a href="#l28.1839"></a><span id="l28.1839" class="difflineminus">-        if (amountWritten != 1)</span>
<a href="#l28.1840"></a><span id="l28.1840" class="difflineminus">-        {</span>
<a href="#l28.1841"></a><span id="l28.1841" class="difflineplus">+        if (amountWritten != 1) {</span>
<a href="#l28.1842"></a><span id="l28.1842">           mInsertPeriodRequired = true;</span>
<a href="#l28.1843"></a><span id="l28.1843" class="difflineminus">-          // once we do write out the '.',  if we are now blocked we need to remember the remaining count that comes</span>
<a href="#l28.1844"></a><span id="l28.1844" class="difflineminus">-          // after the '.' so we can perform processing on that once we become unblocked.</span>
<a href="#l28.1845"></a><span id="l28.1845" class="difflineplus">+          // once we do write out the '.',  if we are now blocked we need to</span>
<a href="#l28.1846"></a><span id="l28.1846" class="difflineplus">+          // remember the remaining count that comes after the '.' so we can</span>
<a href="#l28.1847"></a><span id="l28.1847" class="difflineplus">+          // perform processing on that once we become unblocked.</span>
<a href="#l28.1848"></a><span id="l28.1848">           UpdateSuspendedReadBytes(count, mInsertPeriodRequired);</span>
<a href="#l28.1849"></a><span id="l28.1849">           SuspendPostFileRead();</span>
<a href="#l28.1850"></a><span id="l28.1850">           break;</span>
<a href="#l28.1851"></a><span id="l28.1851">         }</span>
<a href="#l28.1852"></a><span id="l28.1852">       }</span>
<a href="#l28.1853"></a><span id="l28.1853" class="difflineminus">-    } // while count &gt; 0</span>
<a href="#l28.1854"></a><span id="l28.1854" class="difflineplus">+    }  // while count &gt; 0</span>
<a href="#l28.1855"></a><span id="l28.1855">   }</span>
<a href="#l28.1856"></a><span id="l28.1856"> </span>
<a href="#l28.1857"></a><span id="l28.1857">   return NS_OK;</span>
<a href="#l28.1858"></a><span id="l28.1858"> }</span>
<a href="#l28.1859"></a><span id="l28.1859" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::UnblockPostReader()</span>
<a href="#l28.1860"></a><span id="l28.1860" class="difflineminus">-{</span>
<a href="#l28.1861"></a><span id="l28.1861" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::UnblockPostReader() {</span>
<a href="#l28.1862"></a><span id="l28.1862">   uint32_t amountWritten = 0;</span>
<a href="#l28.1863"></a><span id="l28.1863"> </span>
<a href="#l28.1864"></a><span id="l28.1864" class="difflineminus">-  if (!m_socketIsOpen) return NS_OK; // kick out if the socket was canceled</span>
<a href="#l28.1865"></a><span id="l28.1865" class="difflineplus">+  if (!m_socketIsOpen) return NS_OK;  // kick out if the socket was canceled</span>
<a href="#l28.1866"></a><span id="l28.1866"> </span>
<a href="#l28.1867"></a><span id="l28.1867" class="difflineminus">-  if (mSuspendedRead)</span>
<a href="#l28.1868"></a><span id="l28.1868" class="difflineminus">-  {</span>
<a href="#l28.1869"></a><span id="l28.1869" class="difflineminus">-    // (1) attempt to write out any remaining read bytes we need in order to unblock the reader</span>
<a href="#l28.1870"></a><span id="l28.1870" class="difflineminus">-    if (mSuspendedReadBytes &gt; 0 &amp;&amp; mPostDataStream)</span>
<a href="#l28.1871"></a><span id="l28.1871" class="difflineminus">-    {</span>
<a href="#l28.1872"></a><span id="l28.1872" class="difflineplus">+  if (mSuspendedRead) {</span>
<a href="#l28.1873"></a><span id="l28.1873" class="difflineplus">+    // (1) attempt to write out any remaining read bytes we need in order to</span>
<a href="#l28.1874"></a><span id="l28.1874" class="difflineplus">+    // unblock the reader</span>
<a href="#l28.1875"></a><span id="l28.1875" class="difflineplus">+    if (mSuspendedReadBytes &gt; 0 &amp;&amp; mPostDataStream) {</span>
<a href="#l28.1876"></a><span id="l28.1876">       uint64_t avail = 0;</span>
<a href="#l28.1877"></a><span id="l28.1877">       mPostDataStream-&gt;Available(&amp;avail);</span>
<a href="#l28.1878"></a><span id="l28.1878"> </span>
<a href="#l28.1879"></a><span id="l28.1879" class="difflineminus">-      m_outputStream-&gt;WriteFrom(mPostDataStream, std::min(avail, uint64_t(mSuspendedReadBytes)), &amp;amountWritten);</span>
<a href="#l28.1880"></a><span id="l28.1880" class="difflineminus">-      // hmm sometimes my mSuspendedReadBytes is getting out of whack...so for now, reset it</span>
<a href="#l28.1881"></a><span id="l28.1881" class="difflineminus">-      // if necessary.</span>
<a href="#l28.1882"></a><span id="l28.1882" class="difflineminus">-      if (mSuspendedReadBytes &gt; avail)</span>
<a href="#l28.1883"></a><span id="l28.1883" class="difflineminus">-        mSuspendedReadBytes = avail;</span>
<a href="#l28.1884"></a><span id="l28.1884" class="difflineplus">+      m_outputStream-&gt;WriteFrom(mPostDataStream,</span>
<a href="#l28.1885"></a><span id="l28.1885" class="difflineplus">+                                std::min(avail, uint64_t(mSuspendedReadBytes)),</span>
<a href="#l28.1886"></a><span id="l28.1886" class="difflineplus">+                                &amp;amountWritten);</span>
<a href="#l28.1887"></a><span id="l28.1887" class="difflineplus">+      // hmm sometimes my mSuspendedReadBytes is getting out of whack...so for</span>
<a href="#l28.1888"></a><span id="l28.1888" class="difflineplus">+      // now, reset it if necessary.</span>
<a href="#l28.1889"></a><span id="l28.1889" class="difflineplus">+      if (mSuspendedReadBytes &gt; avail) mSuspendedReadBytes = avail;</span>
<a href="#l28.1890"></a><span id="l28.1890"> </span>
<a href="#l28.1891"></a><span id="l28.1891">       if (mSuspendedReadBytes &gt; amountWritten)</span>
<a href="#l28.1892"></a><span id="l28.1892">         mSuspendedReadBytes -= amountWritten;</span>
<a href="#l28.1893"></a><span id="l28.1893">       else</span>
<a href="#l28.1894"></a><span id="l28.1894">         mSuspendedReadBytes = 0;</span>
<a href="#l28.1895"></a><span id="l28.1895">     }</span>
<a href="#l28.1896"></a><span id="l28.1896"> </span>
<a href="#l28.1897"></a><span id="l28.1897" class="difflineminus">-    // (2) if we are now unblocked, and we need to insert a '.' then do so now...</span>
<a href="#l28.1898"></a><span id="l28.1898" class="difflineminus">-    if (mInsertPeriodRequired &amp;&amp; mSuspendedReadBytes == 0)</span>
<a href="#l28.1899"></a><span id="l28.1899" class="difflineminus">-    {</span>
<a href="#l28.1900"></a><span id="l28.1900" class="difflineplus">+    // (2) if we are now unblocked, and we need to insert a '.' then do so</span>
<a href="#l28.1901"></a><span id="l28.1901" class="difflineplus">+    // now...</span>
<a href="#l28.1902"></a><span id="l28.1902" class="difflineplus">+    if (mInsertPeriodRequired &amp;&amp; mSuspendedReadBytes == 0) {</span>
<a href="#l28.1903"></a><span id="l28.1903">       amountWritten = 0;</span>
<a href="#l28.1904"></a><span id="l28.1904">       m_outputStream-&gt;Write(&quot;.&quot;, 1, &amp;amountWritten);</span>
<a href="#l28.1905"></a><span id="l28.1905" class="difflineminus">-      if (amountWritten == 1) // if we succeeded then clear pending '.' flag</span>
<a href="#l28.1906"></a><span id="l28.1906" class="difflineplus">+      if (amountWritten == 1)  // if we succeeded then clear pending '.' flag</span>
<a href="#l28.1907"></a><span id="l28.1907">         mInsertPeriodRequired = false;</span>
<a href="#l28.1908"></a><span id="l28.1908">     }</span>
<a href="#l28.1909"></a><span id="l28.1909"> </span>
<a href="#l28.1910"></a><span id="l28.1910" class="difflineminus">-    // (3) if we inserted a '.' and we still have bytes after the '.' which need processed before the stream is unblocked</span>
<a href="#l28.1911"></a><span id="l28.1911" class="difflineminus">-    // then fake an ODA call to handle this now...</span>
<a href="#l28.1912"></a><span id="l28.1912" class="difflineminus">-    if (!mInsertPeriodRequired &amp;&amp; mSuspendedReadBytesPostPeriod &gt; 0)</span>
<a href="#l28.1913"></a><span id="l28.1913" class="difflineminus">-    {</span>
<a href="#l28.1914"></a><span id="l28.1914" class="difflineplus">+    // (3) if we inserted a '.' and we still have bytes after the '.' which need</span>
<a href="#l28.1915"></a><span id="l28.1915" class="difflineplus">+    // processed before the stream is unblocked then fake an ODA call to handle</span>
<a href="#l28.1916"></a><span id="l28.1916" class="difflineplus">+    // this now...</span>
<a href="#l28.1917"></a><span id="l28.1917" class="difflineplus">+    if (!mInsertPeriodRequired &amp;&amp; mSuspendedReadBytesPostPeriod &gt; 0) {</span>
<a href="#l28.1918"></a><span id="l28.1918">       // these bytes actually need processed for extra '.''s.....</span>
<a href="#l28.1919"></a><span id="l28.1919">       uint32_t postbytes = mSuspendedReadBytesPostPeriod;</span>
<a href="#l28.1920"></a><span id="l28.1920">       mSuspendedReadBytesPostPeriod = 0;</span>
<a href="#l28.1921"></a><span id="l28.1921">       ProcessIncomingPostData(mPostDataStream, postbytes);</span>
<a href="#l28.1922"></a><span id="l28.1922">     }</span>
<a href="#l28.1923"></a><span id="l28.1923"> </span>
<a href="#l28.1924"></a><span id="l28.1924">     // (4) determine if we are out of the suspended read state...</span>
<a href="#l28.1925"></a><span id="l28.1925" class="difflineminus">-    if (mSuspendedReadBytes == 0 &amp;&amp; !mInsertPeriodRequired &amp;&amp; mSuspendedReadBytesPostPeriod == 0)</span>
<a href="#l28.1926"></a><span id="l28.1926" class="difflineminus">-    {</span>
<a href="#l28.1927"></a><span id="l28.1927" class="difflineplus">+    if (mSuspendedReadBytes == 0 &amp;&amp; !mInsertPeriodRequired &amp;&amp;</span>
<a href="#l28.1928"></a><span id="l28.1928" class="difflineplus">+        mSuspendedReadBytesPostPeriod == 0) {</span>
<a href="#l28.1929"></a><span id="l28.1929">       mSuspendedRead = false;</span>
<a href="#l28.1930"></a><span id="l28.1930">       ResumePostFileRead();</span>
<a href="#l28.1931"></a><span id="l28.1931">     }</span>
<a href="#l28.1932"></a><span id="l28.1932"> </span>
<a href="#l28.1933"></a><span id="l28.1933" class="difflineminus">-  } // if we are in the suspended read state</span>
<a href="#l28.1934"></a><span id="l28.1934" class="difflineplus">+  }  // if we are in the suspended read state</span>
<a href="#l28.1935"></a><span id="l28.1935"> </span>
<a href="#l28.1936"></a><span id="l28.1936">   return NS_OK;</span>
<a href="#l28.1937"></a><span id="l28.1937"> }</span>
<a href="#l28.1938"></a><span id="l28.1938"> </span>
<a href="#l28.1939"></a><span id="l28.1939" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::SetupTransportState()</span>
<a href="#l28.1940"></a><span id="l28.1940" class="difflineminus">-{</span>
<a href="#l28.1941"></a><span id="l28.1941" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::SetupTransportState() {</span>
<a href="#l28.1942"></a><span id="l28.1942">   nsresult rv = NS_OK;</span>
<a href="#l28.1943"></a><span id="l28.1943"> </span>
<a href="#l28.1944"></a><span id="l28.1944" class="difflineminus">-  if (!m_outputStream &amp;&amp; m_transport)</span>
<a href="#l28.1945"></a><span id="l28.1945" class="difflineminus">-  {</span>
<a href="#l28.1946"></a><span id="l28.1946" class="difflineplus">+  if (!m_outputStream &amp;&amp; m_transport) {</span>
<a href="#l28.1947"></a><span id="l28.1947">     // first create a pipe which we'll use to write the data we want to send</span>
<a href="#l28.1948"></a><span id="l28.1948">     // into.</span>
<a href="#l28.1949"></a><span id="l28.1949">     nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l28.1950"></a><span id="l28.1950">     rv = pipe-&gt;Init(true, true, 1024, 8);</span>
<a href="#l28.1951"></a><span id="l28.1951">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.1952"></a><span id="l28.1952"> </span>
<a href="#l28.1953"></a><span id="l28.1953">     nsIAsyncInputStream *inputStream = nullptr;</span>
<a href="#l28.1954"></a><span id="l28.1954">     // This always succeeds because the pipe is initialized above.</span>
<a href="#l28.1955"></a><span id="l28.1955" class="difflineat">@@ -1461,111 +1366,107 @@ nsresult nsMsgAsyncWriteProtocol::SetupT</span>
<a href="#l28.1956"></a><span id="l28.1956"> </span>
<a href="#l28.1957"></a><span id="l28.1957">     mProviderThread = do_GetCurrentThread();</span>
<a href="#l28.1958"></a><span id="l28.1958"> </span>
<a href="#l28.1959"></a><span id="l28.1959">     nsMsgProtocolStreamProvider *provider = new nsMsgProtocolStreamProvider();</span>
<a href="#l28.1960"></a><span id="l28.1960"> </span>
<a href="#l28.1961"></a><span id="l28.1961">     if (!provider) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l28.1962"></a><span id="l28.1962"> </span>
<a href="#l28.1963"></a><span id="l28.1963">     provider-&gt;Init(this, mInStream);</span>
<a href="#l28.1964"></a><span id="l28.1964" class="difflineminus">-    mProvider = provider; // ADDREF</span>
<a href="#l28.1965"></a><span id="l28.1965" class="difflineplus">+    mProvider = provider;  // ADDREF</span>
<a href="#l28.1966"></a><span id="l28.1966"> </span>
<a href="#l28.1967"></a><span id="l28.1967">     nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l28.1968"></a><span id="l28.1968">     rv = m_transport-&gt;OpenOutputStream(0, 0, 0, getter_AddRefs(stream));</span>
<a href="#l28.1969"></a><span id="l28.1969">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1970"></a><span id="l28.1970"> </span>
<a href="#l28.1971"></a><span id="l28.1971">     mAsyncOutStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l28.1972"></a><span id="l28.1972">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.1973"></a><span id="l28.1973"> </span>
<a href="#l28.1974"></a><span id="l28.1974">     // wait for the output stream to become writable</span>
<a href="#l28.1975"></a><span id="l28.1975">     rv = mAsyncOutStream-&gt;AsyncWait(mProvider, 0, 0, mProviderThread);</span>
<a href="#l28.1976"></a><span id="l28.1976" class="difflineminus">-  } // if m_transport</span>
<a href="#l28.1977"></a><span id="l28.1977" class="difflineplus">+  }  // if m_transport</span>
<a href="#l28.1978"></a><span id="l28.1978"> </span>
<a href="#l28.1979"></a><span id="l28.1979">   return rv;</span>
<a href="#l28.1980"></a><span id="l28.1980"> }</span>
<a href="#l28.1981"></a><span id="l28.1981"> </span>
<a href="#l28.1982"></a><span id="l28.1982" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::CloseSocket()</span>
<a href="#l28.1983"></a><span id="l28.1983" class="difflineminus">-{</span>
<a href="#l28.1984"></a><span id="l28.1984" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::CloseSocket() {</span>
<a href="#l28.1985"></a><span id="l28.1985">   nsresult rv = NS_OK;</span>
<a href="#l28.1986"></a><span id="l28.1986" class="difflineminus">-  if (mAsyncOutStream)</span>
<a href="#l28.1987"></a><span id="l28.1987" class="difflineminus">-    mAsyncOutStream-&gt;CloseWithStatus(NS_BINDING_ABORTED);</span>
<a href="#l28.1988"></a><span id="l28.1988" class="difflineplus">+  if (mAsyncOutStream) mAsyncOutStream-&gt;CloseWithStatus(NS_BINDING_ABORTED);</span>
<a href="#l28.1989"></a><span id="l28.1989"> </span>
<a href="#l28.1990"></a><span id="l28.1990">   nsMsgProtocol::CloseSocket();</span>
<a href="#l28.1991"></a><span id="l28.1991"> </span>
<a href="#l28.1992"></a><span id="l28.1992" class="difflineminus">-  if (mFilePostHelper)</span>
<a href="#l28.1993"></a><span id="l28.1993" class="difflineminus">-  {</span>
<a href="#l28.1994"></a><span id="l28.1994" class="difflineplus">+  if (mFilePostHelper) {</span>
<a href="#l28.1995"></a><span id="l28.1995">     mFilePostHelper-&gt;CloseSocket();</span>
<a href="#l28.1996"></a><span id="l28.1996">     mFilePostHelper = nullptr;</span>
<a href="#l28.1997"></a><span id="l28.1997">   }</span>
<a href="#l28.1998"></a><span id="l28.1998"> </span>
<a href="#l28.1999"></a><span id="l28.1999">   mAsyncOutStream = nullptr;</span>
<a href="#l28.2000"></a><span id="l28.2000">   mProvider = nullptr;</span>
<a href="#l28.2001"></a><span id="l28.2001">   mProviderThread = nullptr;</span>
<a href="#l28.2002"></a><span id="l28.2002">   mAsyncBuffer.Truncate();</span>
<a href="#l28.2003"></a><span id="l28.2003">   return rv;</span>
<a href="#l28.2004"></a><span id="l28.2004"> }</span>
<a href="#l28.2005"></a><span id="l28.2005"> </span>
<a href="#l28.2006"></a><span id="l28.2006" class="difflineminus">-void nsMsgAsyncWriteProtocol::UpdateProgress(uint32_t aNewBytes)</span>
<a href="#l28.2007"></a><span id="l28.2007" class="difflineminus">-{</span>
<a href="#l28.2008"></a><span id="l28.2008" class="difflineplus">+void nsMsgAsyncWriteProtocol::UpdateProgress(uint32_t aNewBytes) {</span>
<a href="#l28.2009"></a><span id="l28.2009">   if (!mGenerateProgressNotifications) return;</span>
<a href="#l28.2010"></a><span id="l28.2010"> </span>
<a href="#l28.2011"></a><span id="l28.2011">   mNumBytesPosted += aNewBytes;</span>
<a href="#l28.2012"></a><span id="l28.2012" class="difflineminus">-  if (mFilePostSize &gt; 0)</span>
<a href="#l28.2013"></a><span id="l28.2013" class="difflineminus">-  {</span>
<a href="#l28.2014"></a><span id="l28.2014" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(m_url);</span>
<a href="#l28.2015"></a><span id="l28.2015" class="difflineplus">+  if (mFilePostSize &gt; 0) {</span>
<a href="#l28.2016"></a><span id="l28.2016" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(m_url);</span>
<a href="#l28.2017"></a><span id="l28.2017">     if (!mailUrl) return;</span>
<a href="#l28.2018"></a><span id="l28.2018"> </span>
<a href="#l28.2019"></a><span id="l28.2019">     nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l28.2020"></a><span id="l28.2020">     mailUrl-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l28.2021"></a><span id="l28.2021">     if (!statusFeedback) return;</span>
<a href="#l28.2022"></a><span id="l28.2022"> </span>
<a href="#l28.2023"></a><span id="l28.2023" class="difflineminus">-    nsCOMPtr&lt;nsIWebProgressListener&gt; webProgressListener (do_QueryInterface(statusFeedback));</span>
<a href="#l28.2024"></a><span id="l28.2024" class="difflineplus">+    nsCOMPtr&lt;nsIWebProgressListener&gt; webProgressListener(</span>
<a href="#l28.2025"></a><span id="l28.2025" class="difflineplus">+        do_QueryInterface(statusFeedback));</span>
<a href="#l28.2026"></a><span id="l28.2026">     if (!webProgressListener) return;</span>
<a href="#l28.2027"></a><span id="l28.2027"> </span>
<a href="#l28.2028"></a><span id="l28.2028">     // XXX not sure if m_request is correct here</span>
<a href="#l28.2029"></a><span id="l28.2029">     webProgressListener-&gt;OnProgressChange(nullptr, m_request, mNumBytesPosted,</span>
<a href="#l28.2030"></a><span id="l28.2030" class="difflineminus">-      static_cast&lt;uint32_t&gt;(mFilePostSize), mNumBytesPosted, mFilePostSize);</span>
<a href="#l28.2031"></a><span id="l28.2031" class="difflineplus">+                                          static_cast&lt;uint32_t&gt;(mFilePostSize),</span>
<a href="#l28.2032"></a><span id="l28.2032" class="difflineplus">+                                          mNumBytesPosted, mFilePostSize);</span>
<a href="#l28.2033"></a><span id="l28.2033">   }</span>
<a href="#l28.2034"></a><span id="l28.2034"> </span>
<a href="#l28.2035"></a><span id="l28.2035">   return;</span>
<a href="#l28.2036"></a><span id="l28.2036"> }</span>
<a href="#l28.2037"></a><span id="l28.2037"> </span>
<a href="#l28.2038"></a><span id="l28.2038" class="difflineminus">-nsresult nsMsgAsyncWriteProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l28.2039"></a><span id="l28.2039" class="difflineminus">-{</span>
<a href="#l28.2040"></a><span id="l28.2040" class="difflineplus">+nsresult nsMsgAsyncWriteProtocol::SendData(const char *dataBuffer,</span>
<a href="#l28.2041"></a><span id="l28.2041" class="difflineplus">+                                           bool aSuppressLogging) {</span>
<a href="#l28.2042"></a><span id="l28.2042">   this-&gt;mAsyncBuffer.Append(dataBuffer);</span>
<a href="#l28.2043"></a><span id="l28.2043" class="difflineminus">-  if (!mAsyncOutStream)</span>
<a href="#l28.2044"></a><span id="l28.2044" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.2045"></a><span id="l28.2045" class="difflineplus">+  if (!mAsyncOutStream) return NS_ERROR_FAILURE;</span>
<a href="#l28.2046"></a><span id="l28.2046">   return mAsyncOutStream-&gt;AsyncWait(mProvider, 0, 0, mProviderThread);</span>
<a href="#l28.2047"></a><span id="l28.2047"> }</span>
<a href="#l28.2048"></a><span id="l28.2048"> </span>
<a href="#l28.2049"></a><span id="l28.2049" class="difflineminus">-char16_t *FormatStringWithHostNameByName(const char16_t* stringName, nsIMsgMailNewsUrl *msgUri)</span>
<a href="#l28.2050"></a><span id="l28.2050" class="difflineminus">-{</span>
<a href="#l28.2051"></a><span id="l28.2051" class="difflineminus">-  if (!msgUri)</span>
<a href="#l28.2052"></a><span id="l28.2052" class="difflineminus">-    return nullptr;</span>
<a href="#l28.2053"></a><span id="l28.2053" class="difflineplus">+char16_t *FormatStringWithHostNameByName(const char16_t *stringName,</span>
<a href="#l28.2054"></a><span id="l28.2054" class="difflineplus">+                                         nsIMsgMailNewsUrl *msgUri) {</span>
<a href="#l28.2055"></a><span id="l28.2055" class="difflineplus">+  if (!msgUri) return nullptr;</span>
<a href="#l28.2056"></a><span id="l28.2056"> </span>
<a href="#l28.2057"></a><span id="l28.2057">   nsresult rv;</span>
<a href="#l28.2058"></a><span id="l28.2058"> </span>
<a href="#l28.2059"></a><span id="l28.2059">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l28.2060"></a><span id="l28.2060" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l28.2061"></a><span id="l28.2061" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l28.2062"></a><span id="l28.2062">   NS_ENSURE_TRUE(sBundleService, nullptr);</span>
<a href="#l28.2063"></a><span id="l28.2063"> </span>
<a href="#l28.2064"></a><span id="l28.2064">   nsCOMPtr&lt;nsIStringBundle&gt; sBundle;</span>
<a href="#l28.2065"></a><span id="l28.2065">   rv = sBundleService-&gt;CreateBundle(MSGS_URL, getter_AddRefs(sBundle));</span>
<a href="#l28.2066"></a><span id="l28.2066">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l28.2067"></a><span id="l28.2067"> </span>
<a href="#l28.2068"></a><span id="l28.2068">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l28.2069"></a><span id="l28.2069">   rv = msgUri-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l28.2070"></a><span id="l28.2070">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l28.2071"></a><span id="l28.2071"> </span>
<a href="#l28.2072"></a><span id="l28.2072">   nsCString hostName;</span>
<a href="#l28.2073"></a><span id="l28.2073">   rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l28.2074"></a><span id="l28.2074">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l28.2075"></a><span id="l28.2075"> </span>
<a href="#l28.2076"></a><span id="l28.2076">   NS_ConvertASCIItoUTF16 hostStr(hostName);</span>
<a href="#l28.2077"></a><span id="l28.2077" class="difflineminus">-  const char16_t *params[] = { hostStr.get() };</span>
<a href="#l28.2078"></a><span id="l28.2078" class="difflineplus">+  const char16_t *params[] = {hostStr.get()};</span>
<a href="#l28.2079"></a><span id="l28.2079">   nsAutoString str;</span>
<a href="#l28.2080"></a><span id="l28.2080" class="difflineminus">-  rv = sBundle-&gt;FormatStringFromName(NS_ConvertUTF16toUTF8(stringName).get(), params, 1, str);</span>
<a href="#l28.2081"></a><span id="l28.2081" class="difflineplus">+  rv = sBundle-&gt;FormatStringFromName(NS_ConvertUTF16toUTF8(stringName).get(),</span>
<a href="#l28.2082"></a><span id="l28.2082" class="difflineplus">+                                     params, 1, str);</span>
<a href="#l28.2083"></a><span id="l28.2083">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l28.2084"></a><span id="l28.2084"> </span>
<a href="#l28.2085"></a><span id="l28.2085">   return ToNewUnicode(str);</span>
<a href="#l28.2086"></a><span id="l28.2086"> }</span>
<a href="#l28.2087"></a><span id="l28.2087"> </span>
<a href="#l28.2088"></a><span id="l28.2088"> // vim: ts=2 sw=2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -32,204 +32,231 @@ class nsMsgFilePostHelper;</span>
<a href="#l29.4"></a><span id="l29.4"> class nsIProxyInfo;</span>
<a href="#l29.5"></a><span id="l29.5"> class nsICancelable;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> // This is a helper class used to encapsulate code shared between all of the</span>
<a href="#l29.8"></a><span id="l29.8"> // mailnews protocol objects (imap, news, pop, smtp, etc.) In particular,</span>
<a href="#l29.9"></a><span id="l29.9"> // it unifies the core networking code for the protocols. My hope is that</span>
<a href="#l29.10"></a><span id="l29.10"> // this will make unification with Necko easier as we'll only have to change</span>
<a href="#l29.11"></a><span id="l29.11"> // this class and not all of the mailnews protocols.</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-class NS_MSG_BASE nsMsgProtocol : public nsIStreamListener</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-                                , public nsIChannel</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-                                , public nsITransportEventSink</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-{</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-public:</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-  nsMsgProtocol(nsIURI * aURL);</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+class NS_MSG_BASE nsMsgProtocol : public nsIStreamListener,</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+                                  public nsIChannel,</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+                                  public nsITransportEventSink {</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+ public:</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+  nsMsgProtocol(nsIURI *aURL);</span>
<a href="#l29.23"></a><span id="l29.23"> </span>
<a href="#l29.24"></a><span id="l29.24">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l29.25"></a><span id="l29.25">   // nsIChannel support</span>
<a href="#l29.26"></a><span id="l29.26">   NS_DECL_NSICHANNEL</span>
<a href="#l29.27"></a><span id="l29.27">   NS_DECL_NSIREQUEST</span>
<a href="#l29.28"></a><span id="l29.28"> </span>
<a href="#l29.29"></a><span id="l29.29">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l29.30"></a><span id="l29.30">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l29.31"></a><span id="l29.31">   NS_DECL_NSITRANSPORTEVENTSINK</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-  // LoadUrl -- A protocol typically overrides this function, sets up any local state for the url and</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  // then calls the base class which opens the socket if it needs opened. If the socket is</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-  // already opened then we just call ProcessProtocolState to start the churning process.</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-  // aConsumer is the consumer for the url. It can be null if this argument is not appropriate</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-  virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer = nullptr);</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+  // LoadUrl -- A protocol typically overrides this function, sets up any local</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  // state for the url and then calls the base class which opens the socket if</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+  // it needs opened. If the socket is already opened then we just call</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+  // ProcessProtocolState to start the churning process. aConsumer is the</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+  // consumer for the url. It can be null if this argument is not appropriate</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+  virtual nsresult LoadUrl(nsIURI *aURL, nsISupports *aConsumer = nullptr);</span>
<a href="#l29.44"></a><span id="l29.44"> </span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-  virtual nsresult SetUrl(nsIURI * aURL); // sometimes we want to set the url before we load it</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+  virtual nsresult SetUrl(</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+      nsIURI *aURL);  // sometimes we want to set the url before we load it</span>
<a href="#l29.48"></a><span id="l29.48">   void ShowAlertMessage(nsIMsgMailNewsUrl *aMsgUrl, nsresult aStatus);</span>
<a href="#l29.49"></a><span id="l29.49"> </span>
<a href="#l29.50"></a><span id="l29.50">   // Flag manipulators</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-  virtual bool TestFlag  (uint32_t flag) {return flag &amp; m_flags;}</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-  virtual void   SetFlag   (uint32_t flag) { m_flags |= flag; }</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-  virtual void   ClearFlag (uint32_t flag) { m_flags &amp;= ~flag; }</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+  virtual bool TestFlag(uint32_t flag) { return flag &amp; m_flags; }</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+  virtual void SetFlag(uint32_t flag) { m_flags |= flag; }</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+  virtual void ClearFlag(uint32_t flag) { m_flags &amp;= ~flag; }</span>
<a href="#l29.57"></a><span id="l29.57"> </span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-protected:</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+ protected:</span>
<a href="#l29.60"></a><span id="l29.60">   virtual ~nsMsgProtocol();</span>
<a href="#l29.61"></a><span id="l29.61"> </span>
<a href="#l29.62"></a><span id="l29.62">   // methods for opening and closing a socket with core netlib....</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-  // mscott -okay this is lame. I should break this up into a file protocol and a socket based</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-  // protocool class instead of cheating and putting both methods here...</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+  // mscott -okay this is lame. I should break this up into a file protocol and</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+  // a socket based protocool class instead of cheating and putting both methods</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+  // here...</span>
<a href="#l29.68"></a><span id="l29.68"> </span>
<a href="#l29.69"></a><span id="l29.69">   // open a connection with a specific host and port</span>
<a href="#l29.70"></a><span id="l29.70">   // aHostName must be UTF-8 encoded.</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-  virtual nsresult OpenNetworkSocketWithInfo(const char * aHostName,</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+  virtual nsresult OpenNetworkSocketWithInfo(const char *aHostName,</span>
<a href="#l29.73"></a><span id="l29.73">                                              int32_t aGetPort,</span>
<a href="#l29.74"></a><span id="l29.74">                                              const char *connectionType,</span>
<a href="#l29.75"></a><span id="l29.75">                                              nsIProxyInfo *aProxyInfo,</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-                                             nsIInterfaceRequestor* callbacks);</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+                                             nsIInterfaceRequestor *callbacks);</span>
<a href="#l29.78"></a><span id="l29.78">   // helper routine</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-  nsresult GetFileFromURL(nsIURI * aURL, nsIFile **aResult);</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-  virtual nsresult OpenFileSocket(nsIURI * aURL, uint64_t aStartPosition, int64_t aReadCount); // used to open a file socket connection</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+  nsresult GetFileFromURL(nsIURI *aURL, nsIFile **aResult);</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+  virtual nsresult OpenFileSocket(</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+      nsIURI *aURL, uint64_t aStartPosition,</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+      int64_t aReadCount);  // used to open a file socket connection</span>
<a href="#l29.85"></a><span id="l29.85"> </span>
<a href="#l29.86"></a><span id="l29.86">   nsresult GetTopmostMsgWindow(nsIMsgWindow **aWindow);</span>
<a href="#l29.87"></a><span id="l29.87"> </span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-  virtual const char* GetType() {return nullptr;}</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+  virtual const char *GetType() { return nullptr; }</span>
<a href="#l29.90"></a><span id="l29.90">   nsresult GetQoSBits(uint8_t *aQoSBits);</span>
<a href="#l29.91"></a><span id="l29.91"> </span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-  // a Protocol typically overrides this method. They free any of their own connection state and then</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-  // they call up into the base class to free the generic connection objects</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+  // a Protocol typically overrides this method. They free any of their own</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+  // connection state and then they call up into the base class to free the</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+  // generic connection objects</span>
<a href="#l29.97"></a><span id="l29.97">   virtual nsresult CloseSocket();</span>
<a href="#l29.98"></a><span id="l29.98"> </span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-  virtual nsresult SetupTransportState(); // private method used by OpenNetworkSocket and OpenFileSocket</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+  virtual nsresult</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+  SetupTransportState();  // private method used by OpenNetworkSocket and</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+                          // OpenFileSocket</span>
<a href="#l29.103"></a><span id="l29.103"> </span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-  // ProcessProtocolState - This is the function that gets churned by calls to OnDataAvailable.</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-  // As data arrives on the socket, OnDataAvailable calls ProcessProtocolState.</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-  virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-                                        uint64_t sourceOffset, uint32_t length) = 0;</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+  // ProcessProtocolState - This is the function that gets churned by calls to</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+  // OnDataAvailable. As data arrives on the socket, OnDataAvailable calls</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+  // ProcessProtocolState.</span>
<a href="#l29.112"></a><span id="l29.112"> </span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-  // SendData -- Writes the data contained in dataBuffer into the current output stream.</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineminus">-  // It also informs the transport layer that this data is now available for transmission.</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineminus">-  // Returns a positive number for success, 0 for failure (not all the bytes were written to the</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineminus">-  // stream, etc).</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineminus">-    // aSuppressLogging is a hint that sensitive data is being sent and should not be logged</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineminus">-  virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+  virtual nsresult ProcessProtocolState(nsIURI *url,</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+                                        nsIInputStream *inputStream,</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+                                        uint64_t sourceOffset,</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+                                        uint32_t length) = 0;</span>
<a href="#l29.123"></a><span id="l29.123"> </span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-  virtual nsresult PostMessage(nsIURI* url, nsIFile* aPostFile);</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+  // SendData -- Writes the data contained in dataBuffer into the current output</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineplus">+  // stream. It also informs the transport layer that this data is now available</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+  // for transmission. Returns a positive number for success, 0 for failure (not</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+  // all the bytes were written to the stream, etc). aSuppressLogging is a hint</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+  // that sensitive data is being sent and should not be logged</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+  virtual nsresult SendData(const char *dataBuffer,</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+                            bool aSuppressLogging = false);</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineplus">+</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineplus">+  virtual nsresult PostMessage(nsIURI *url, nsIFile *aPostFile);</span>
<a href="#l29.134"></a><span id="l29.134"> </span>
<a href="#l29.135"></a><span id="l29.135">   virtual nsresult InitFromURI(nsIURI *aUrl);</span>
<a href="#l29.136"></a><span id="l29.136"> </span>
<a href="#l29.137"></a><span id="l29.137" class="difflineminus">-  nsresult DoNtlmStep1(const nsACString &amp;username, const nsAString &amp;password, nsCString &amp;response);</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineplus">+  nsresult DoNtlmStep1(const nsACString &amp;username, const nsAString &amp;password,</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineplus">+                       nsCString &amp;response);</span>
<a href="#l29.140"></a><span id="l29.140">   nsresult DoNtlmStep2(nsCString &amp;commandResponse, nsCString &amp;response);</span>
<a href="#l29.141"></a><span id="l29.141"> </span>
<a href="#l29.142"></a><span id="l29.142" class="difflineminus">-  nsresult DoGSSAPIStep1(const char *service, const char *username, nsCString &amp;response);</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineplus">+  nsresult DoGSSAPIStep1(const char *service, const char *username,</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineplus">+                         nsCString &amp;response);</span>
<a href="#l29.145"></a><span id="l29.145">   nsresult DoGSSAPIStep2(nsCString &amp;commandResponse, nsCString &amp;response);</span>
<a href="#l29.146"></a><span id="l29.146">   // Output stream for writing commands to the socket</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt;   m_outputStream;   // this will be obtained from the transport interface</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt;</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineplus">+      m_outputStream;  // this will be obtained from the transport interface</span>
<a href="#l29.150"></a><span id="l29.150"> </span>
<a href="#l29.151"></a><span id="l29.151">   // Output stream for writing commands to the socket</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-  nsCOMPtr&lt;nsITransport&gt;  m_transport;</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-  nsCOMPtr&lt;nsIRequest&gt;    m_request;</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineplus">+  nsCOMPtr&lt;nsITransport&gt; m_transport;</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineplus">+  nsCOMPtr&lt;nsIRequest&gt; m_request;</span>
<a href="#l29.156"></a><span id="l29.156">   nsCOMPtr&lt;nsICancelable&gt; m_proxyRequest;</span>
<a href="#l29.157"></a><span id="l29.157"> </span>
<a href="#l29.158"></a><span id="l29.158" class="difflineminus">-  bool          m_socketIsOpen; // mscott: we should look into keeping this state in the nsSocketTransport...</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineminus">-                                  // I'm using it to make sure I open the socket the first time a URL is loaded into the connection</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineminus">-  uint32_t      m_flags; // used to store flag information</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineminus">-  //uint32_t  m_startPosition;</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineminus">-  int64_t       m_readCount;</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+  bool m_socketIsOpen;  // mscott: we should look into keeping this state in the</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineplus">+                        // nsSocketTransport... I'm using it to make sure I open</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineplus">+                        // the socket the first time a URL is loaded into the</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineplus">+                        // connection</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+  uint32_t m_flags;     // used to store flag information</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineplus">+  // uint32_t  m_startPosition;</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineplus">+  int64_t m_readCount;</span>
<a href="#l29.170"></a><span id="l29.170"> </span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; m_tempMsgFile;  // we currently have a hack where displaying a msg involves writing it to a temp file first</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt;</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineplus">+      m_tempMsgFile;  // we currently have a hack where displaying a msg</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineplus">+                      // involves writing it to a temp file first</span>
<a href="#l29.175"></a><span id="l29.175"> </span>
<a href="#l29.176"></a><span id="l29.176">   // auth module for access to NTLM functions</span>
<a href="#l29.177"></a><span id="l29.177">   nsCOMPtr&lt;nsIAuthModule&gt; m_authModule;</span>
<a href="#l29.178"></a><span id="l29.178"> </span>
<a href="#l29.179"></a><span id="l29.179">   // the following is a catch all for nsIChannel related data</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt;            m_originalUrl;  // the original url</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt;            m_url;          // the running url</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt;       m_consumer;</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_originalUrl;  // the original url</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_url;          // the running url</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; m_consumer;</span>
<a href="#l29.186"></a><span id="l29.186">   nsCOMPtr&lt;nsIStreamListener&gt; m_channelListener;</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt;        m_channelContext;</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineminus">-  nsCOMPtr&lt;nsILoadGroup&gt;      m_loadGroup;</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineminus">-  nsLoadFlags                 mLoadFlags;</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; m_channelContext;</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineplus">+  nsCOMPtr&lt;nsILoadGroup&gt; m_loadGroup;</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineplus">+  nsLoadFlags mLoadFlags;</span>
<a href="#l29.193"></a><span id="l29.193">   nsCOMPtr&lt;nsIProgressEventSink&gt; mProgressEventSink;</span>
<a href="#l29.194"></a><span id="l29.194">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; mCallbacks;</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt;       mOwner;</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineminus">-  nsCString                   mContentType;</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineminus">-  nsCString                   mCharset;</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineminus">-  int64_t                     mContentLength;</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-  nsCOMPtr&lt;nsILoadInfo&gt;       m_loadInfo;</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; mOwner;</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineplus">+  nsCString mContentType;</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineplus">+  nsCString mCharset;</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineplus">+  int64_t mContentLength;</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineplus">+  nsCOMPtr&lt;nsILoadInfo&gt; m_loadInfo;</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineplus">+</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+  nsString m_lastPasswordSent;  // used to prefill the password prompt</span>
<a href="#l29.207"></a><span id="l29.207"> </span>
<a href="#l29.208"></a><span id="l29.208" class="difflineminus">-  nsString m_lastPasswordSent; // used to prefill the password prompt</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineplus">+  // private helper routine used by subclasses to quickly get a reference to the</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineplus">+  // correct prompt dialog for a mailnews url.</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineplus">+  nsresult GetPromptDialogFromUrl(nsIMsgMailNewsUrl *aMsgUrl,</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineplus">+                                  nsIPrompt **aPromptDialog);</span>
<a href="#l29.213"></a><span id="l29.213"> </span>
<a href="#l29.214"></a><span id="l29.214" class="difflineminus">-  // private helper routine used by subclasses to quickly get a reference to the correct prompt dialog</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineminus">-  // for a mailnews url.</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineminus">-  nsresult GetPromptDialogFromUrl(nsIMsgMailNewsUrl * aMsgUrl, nsIPrompt ** aPromptDialog);</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineminus">-  // if a url isn't going to result in any content then we want to suppress calls to</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineminus">-  // OnStartRequest, OnDataAvailable and OnStopRequest</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineplus">+  // if a url isn't going to result in any content then we want to suppress</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineplus">+  // calls to OnStartRequest, OnDataAvailable and OnStopRequest</span>
<a href="#l29.222"></a><span id="l29.222">   bool mSuppressListenerNotifications;</span>
<a href="#l29.223"></a><span id="l29.223"> };</span>
<a href="#l29.224"></a><span id="l29.224"> </span>
<a href="#l29.225"></a><span id="l29.225" class="difflineminus">-</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-// This is is a subclass of nsMsgProtocol extends the parent class with AsyncWrite support. Protocols like smtp</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-// and news want to leverage aysnc write. We don't want everyone who inherits from nsMsgProtocol to have to</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineminus">-// pick up the extra overhead.</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-class NS_MSG_BASE nsMsgAsyncWriteProtocol : public nsMsgProtocol</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-                                          , public nsSupportsWeakReference</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineminus">-{</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineminus">-public:</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineplus">+// This is is a subclass of nsMsgProtocol extends the parent class with</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+// AsyncWrite support. Protocols like smtp and news want to leverage aysnc</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineplus">+// write. We don't want everyone who inherits from nsMsgProtocol to have to pick</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineplus">+// up the extra overhead.</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineplus">+class NS_MSG_BASE nsMsgAsyncWriteProtocol : public nsMsgProtocol,</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+                                            public nsSupportsWeakReference {</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+ public:</span>
<a href="#l29.240"></a><span id="l29.240">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l29.241"></a><span id="l29.241"> </span>
<a href="#l29.242"></a><span id="l29.242">   NS_IMETHOD Cancel(nsresult status) override;</span>
<a href="#l29.243"></a><span id="l29.243"> </span>
<a href="#l29.244"></a><span id="l29.244" class="difflineminus">-  nsMsgAsyncWriteProtocol(nsIURI * aURL);</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineplus">+  nsMsgAsyncWriteProtocol(nsIURI *aURL);</span>
<a href="#l29.246"></a><span id="l29.246"> </span>
<a href="#l29.247"></a><span id="l29.247">   // temporary over ride...</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineminus">-  virtual nsresult PostMessage(nsIURI* url, nsIFile *postFile) override;</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+  virtual nsresult PostMessage(nsIURI *url, nsIFile *postFile) override;</span>
<a href="#l29.250"></a><span id="l29.250"> </span>
<a href="#l29.251"></a><span id="l29.251">   // over ride the following methods from the base class</span>
<a href="#l29.252"></a><span id="l29.252">   virtual nsresult SetupTransportState() override;</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineminus">-  virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false) override;</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineplus">+  virtual nsresult SendData(const char *dataBuffer,</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineplus">+                            bool aSuppressLogging = false) override;</span>
<a href="#l29.256"></a><span id="l29.256">   nsCString mAsyncBuffer;</span>
<a href="#l29.257"></a><span id="l29.257"> </span>
<a href="#l29.258"></a><span id="l29.258" class="difflineminus">-  // if we suspended the asynch write while waiting for more data to write then this will be TRUE</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineplus">+  // if we suspended the asynch write while waiting for more data to write then</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineplus">+  // this will be TRUE</span>
<a href="#l29.261"></a><span id="l29.261">   bool mSuspendedWrite;</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineminus">-  nsCOMPtr&lt;nsIRequest&gt;     m_WriteRequest;</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineminus">-  nsCOMPtr&lt;nsIAsyncOutputStream&gt;    mAsyncOutStream;</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineplus">+  nsCOMPtr&lt;nsIRequest&gt; m_WriteRequest;</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineplus">+  nsCOMPtr&lt;nsIAsyncOutputStream&gt; mAsyncOutStream;</span>
<a href="#l29.266"></a><span id="l29.266">   nsCOMPtr&lt;nsIOutputStreamCallback&gt; mProvider;</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineminus">-  nsCOMPtr&lt;nsIThread&gt;               mProviderThread;</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; mProviderThread;</span>
<a href="#l29.269"></a><span id="l29.269"> </span>
<a href="#l29.270"></a><span id="l29.270" class="difflineminus">-  // because we are reading the post data in asynchronously, it's possible that we aren't sending it</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineminus">-  // out fast enough and the reading gets blocked. The following set of state variables are used to</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineminus">-  // track this.</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineminus">-  bool    mSuspendedRead;</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineminus">-  bool    mInsertPeriodRequired; // do we need to insert a '.' as part of the unblocking process</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineplus">+  // because we are reading the post data in asynchronously, it's possible that</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineplus">+  // we aren't sending it out fast enough and the reading gets blocked. The</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineplus">+  // following set of state variables are used to track this.</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineplus">+  bool mSuspendedRead;</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineplus">+  bool mInsertPeriodRequired;  // do we need to insert a '.' as part of the</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineplus">+                               // unblocking process</span>
<a href="#l29.281"></a><span id="l29.281"> </span>
<a href="#l29.282"></a><span id="l29.282">   nsresult ProcessIncomingPostData(nsIInputStream *inStr, uint32_t count);</span>
<a href="#l29.283"></a><span id="l29.283">   nsresult UnblockPostReader();</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineminus">-  nsresult UpdateSuspendedReadBytes(uint32_t aNewBytes, bool aAddToPostPeriodByteCount);</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineminus">-  nsresult PostDataFinished(); // this is so we'll send out a closing '.' and release any state related to the post</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineminus">-</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineplus">+  nsresult UpdateSuspendedReadBytes(uint32_t aNewBytes,</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineplus">+                                    bool aAddToPostPeriodByteCount);</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineplus">+  nsresult PostDataFinished();  // this is so we'll send out a closing '.' and</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineplus">+                                // release any state related to the post</span>
<a href="#l29.291"></a><span id="l29.291"> </span>
<a href="#l29.292"></a><span id="l29.292" class="difflineminus">-  // these two routines are used to pause and resume our loading of the file containing the contents</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineminus">-  // we are trying to post. We call these routines when we aren't sending the bits out fast enough</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineminus">-  // to keep up with the file read.</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineplus">+  // these two routines are used to pause and resume our loading of the file</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineplus">+  // containing the contents we are trying to post. We call these routines when</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineplus">+  // we aren't sending the bits out fast enough to keep up with the file read.</span>
<a href="#l29.298"></a><span id="l29.298">   nsresult SuspendPostFileRead();</span>
<a href="#l29.299"></a><span id="l29.299">   nsresult ResumePostFileRead();</span>
<a href="#l29.300"></a><span id="l29.300">   nsresult UpdateSuspendedReadBytes(uint32_t aNewBytes);</span>
<a href="#l29.301"></a><span id="l29.301">   void UpdateProgress(uint32_t aNewBytes);</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineminus">-  nsMsgFilePostHelper * mFilePostHelper; // needs to be a weak reference</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineminus">-protected:</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineplus">+  nsMsgFilePostHelper *mFilePostHelper;  // needs to be a weak reference</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineplus">+ protected:</span>
<a href="#l29.306"></a><span id="l29.306">   virtual ~nsMsgAsyncWriteProtocol();</span>
<a href="#l29.307"></a><span id="l29.307"> </span>
<a href="#l29.308"></a><span id="l29.308" class="difflineminus">-  // the streams for the pipe used to queue up data for the async write calls to the server.</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineminus">-  // we actually re-use the same mOutStream variable in our parent class for the output</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineminus">-  // stream to the socket channel. So no need for a new variable here.</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt;  mInStream;</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt;  mPostDataStream;</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineminus">-  uint32_t                  mSuspendedReadBytes;   // remaining # of bytes we need to read before</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineminus">-                                                   // the input stream becomes unblocked</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineminus">-  uint32_t                  mSuspendedReadBytesPostPeriod; // # of bytes which need processed after we insert a '.' before</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineminus">-                                                           // the input stream becomes unblocked.</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineminus">-  int64_t   mFilePostSize; // used for file size, we post a single message in a file</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineminus">-  uint32_t  mNumBytesPosted; // used for determining progress on posting files</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-  bool      mGenerateProgressNotifications; // set during a post operation after we've started sending the post data...</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineplus">+  // the streams for the pipe used to queue up data for the async write calls to</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineplus">+  // the server. we actually re-use the same mOutStream variable in our parent</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineplus">+  // class for the output stream to the socket channel. So no need for a new</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineplus">+  // variable here.</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; mInStream;</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; mPostDataStream;</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineplus">+  uint32_t mSuspendedReadBytes;  // remaining # of bytes we need to read before</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineplus">+                                 // the input stream becomes unblocked</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineplus">+  uint32_t mSuspendedReadBytesPostPeriod;  // # of bytes which need processed</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+                                           // after we insert a '.' before the</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineplus">+                                           // input stream becomes unblocked.</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineplus">+  int64_t</span>
<a href="#l29.332"></a><span id="l29.332" class="difflineplus">+      mFilePostSize;  // used for file size, we post a single message in a file</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineplus">+  uint32_t mNumBytesPosted;  // used for determining progress on posting files</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineplus">+  bool</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineplus">+      mGenerateProgressNotifications;  // set during a post operation after</span>
<a href="#l29.336"></a><span id="l29.336" class="difflineplus">+                                       // we've started sending the post data...</span>
<a href="#l29.337"></a><span id="l29.337"> </span>
<a href="#l29.338"></a><span id="l29.338">   virtual nsresult CloseSocket() override;</span>
<a href="#l29.339"></a><span id="l29.339"> };</span>
<a href="#l29.340"></a><span id="l29.340"> </span>
<a href="#l29.341"></a><span id="l29.341"> #endif /* nsMsgProtocol_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/util/nsMsgReadStateTxn.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgReadStateTxn.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -4,63 +4,47 @@</span>
<a href="#l30.4"></a><span id="l30.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsMsgReadStateTxn.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l30.9"></a><span id="l30.9"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l30.10"></a><span id="l30.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-nsMsgReadStateTxn::nsMsgReadStateTxn()</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-{</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-}</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+nsMsgReadStateTxn::nsMsgReadStateTxn() {}</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-nsMsgReadStateTxn::~nsMsgReadStateTxn()</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-{</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-}</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+nsMsgReadStateTxn::~nsMsgReadStateTxn() {}</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-nsresult</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-nsMsgReadStateTxn::Init(nsIMsgFolder *aParentFolder,</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-                        uint32_t aNumKeys,</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-                        nsMsgKey *aMsgKeyArray)</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-{</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+nsresult nsMsgReadStateTxn::Init(nsIMsgFolder *aParentFolder, uint32_t aNumKeys,</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+                                 nsMsgKey *aMsgKeyArray) {</span>
<a href="#l30.30"></a><span id="l30.30">   NS_ENSURE_ARG_POINTER(aParentFolder);</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32">   mParentFolder = aParentFolder;</span>
<a href="#l30.33"></a><span id="l30.33">   mMarkedMessages.AppendElements(aMsgKeyArray, aNumKeys);</span>
<a href="#l30.34"></a><span id="l30.34"> </span>
<a href="#l30.35"></a><span id="l30.35">   return nsMsgTxn::Init();</span>
<a href="#l30.36"></a><span id="l30.36"> }</span>
<a href="#l30.37"></a><span id="l30.37"> </span>
<a href="#l30.38"></a><span id="l30.38"> NS_IMETHODIMP</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-nsMsgReadStateTxn::UndoTransaction()</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-{</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-  return MarkMessages(false);</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-}</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+nsMsgReadStateTxn::UndoTransaction() { return MarkMessages(false); }</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45"> NS_IMETHODIMP</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-nsMsgReadStateTxn::RedoTransaction()</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-{</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-  return MarkMessages(true);</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-}</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+nsMsgReadStateTxn::RedoTransaction() { return MarkMessages(true); }</span>
<a href="#l30.51"></a><span id="l30.51"> </span>
<a href="#l30.52"></a><span id="l30.52"> NS_IMETHODIMP</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-nsMsgReadStateTxn::MarkMessages(bool aAsRead)</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-{</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+nsMsgReadStateTxn::MarkMessages(bool aAsRead) {</span>
<a href="#l30.56"></a><span id="l30.56">   nsresult rv;</span>
<a href="#l30.57"></a><span id="l30.57">   nsCOMPtr&lt;nsIMutableArray&gt; messageArray =</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-    do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l30.60"></a><span id="l30.60">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.61"></a><span id="l30.61"> </span>
<a href="#l30.62"></a><span id="l30.62">   uint32_t length = mMarkedMessages.Length();</span>
<a href="#l30.63"></a><span id="l30.63">   for (uint32_t i = 0; i &lt; length; i++) {</span>
<a href="#l30.64"></a><span id="l30.64">     nsCOMPtr&lt;nsIMsgDBHdr&gt; curMsgHdr;</span>
<a href="#l30.65"></a><span id="l30.65">     rv = mParentFolder-&gt;GetMessageHeader(mMarkedMessages[i],</span>
<a href="#l30.66"></a><span id="l30.66">                                          getter_AddRefs(curMsgHdr));</span>
<a href="#l30.67"></a><span id="l30.67">     if (NS_SUCCEEDED(rv) &amp;&amp; curMsgHdr) {</span>
<a href="#l30.68"></a><span id="l30.68">       messageArray-&gt;AppendElement(curMsgHdr);</span>
<a href="#l30.69"></a><span id="l30.69">     }</span>
<a href="#l30.70"></a><span id="l30.70">   }</span>
<a href="#l30.71"></a><span id="l30.71"> </span>
<a href="#l30.72"></a><span id="l30.72">   return mParentFolder-&gt;MarkMessagesRead(messageArray, aAsRead);</span>
<a href="#l30.73"></a><span id="l30.73"> }</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/util/nsMsgReadStateTxn.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgReadStateTxn.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -8,41 +8,37 @@</span>
<a href="#l31.4"></a><span id="l31.4"> </span>
<a href="#l31.5"></a><span id="l31.5"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> #include &quot;nsMsgTxn.h&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> #include &quot;nsTArray.h&quot;</span>
<a href="#l31.8"></a><span id="l31.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-#define NS_MSGREADSTATETXN_IID \</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-{ /* 121FCE4A-3EA1-455C-8161-839E1557D0CF */ \</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-  0x121FCE4A, 0x3EA1, 0x455C, \</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-  { 0x81, 0x61, 0x83, 0x9E, 0x15, 0x57, 0xD0, 0xCF } \</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-}</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+#define NS_MSGREADSTATETXN_IID                       \</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+  { /* 121FCE4A-3EA1-455C-8161-839E1557D0CF */       \</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+    0x121FCE4A, 0x3EA1, 0x455C, {                    \</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+      0x81, 0x61, 0x83, 0x9E, 0x15, 0x57, 0xD0, 0xCF \</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+    }                                                \</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+  }</span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26"> //------------------------------------------------------------------------------</span>
<a href="#l31.27"></a><span id="l31.27"> // A mark-all transaction handler. Helper for redo/undo of message read states.</span>
<a href="#l31.28"></a><span id="l31.28"> //------------------------------------------------------------------------------</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-class NS_MSG_BASE nsMsgReadStateTxn : public nsMsgTxn</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-{</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-public:</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+class NS_MSG_BASE nsMsgReadStateTxn : public nsMsgTxn {</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+ public:</span>
<a href="#l31.34"></a><span id="l31.34">   nsMsgReadStateTxn();</span>
<a href="#l31.35"></a><span id="l31.35">   virtual ~nsMsgReadStateTxn();</span>
<a href="#l31.36"></a><span id="l31.36"> </span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-  nsresult Init(nsIMsgFolder *aParentFolder,</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-                uint32_t aNumKeys,</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+  nsresult Init(nsIMsgFolder *aParentFolder, uint32_t aNumKeys,</span>
<a href="#l31.40"></a><span id="l31.40">                 nsMsgKey *aMsgKeyArray);</span>
<a href="#l31.41"></a><span id="l31.41">   NS_IMETHOD UndoTransaction() override;</span>
<a href="#l31.42"></a><span id="l31.42">   NS_IMETHOD RedoTransaction() override;</span>
<a href="#l31.43"></a><span id="l31.43"> </span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-protected:</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+ protected:</span>
<a href="#l31.46"></a><span id="l31.46">   NS_IMETHOD MarkMessages(bool aAsRead);</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-private:</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+ private:</span>
<a href="#l31.50"></a><span id="l31.50">   nsCOMPtr&lt;nsIMsgFolder&gt; mParentFolder;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt;     mMarkedMessages;</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; mMarkedMessages;</span>
<a href="#l31.53"></a><span id="l31.53"> };</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55"> #endif  // nsMsgBaseUndoTxn_h_</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/util/nsMsgTxn.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgTxn.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -20,274 +20,227 @@ NS_INTERFACE_MAP_BEGIN(nsMsgTxn)</span>
<a href="#l32.4"></a><span id="l32.4">   NS_INTERFACE_MAP_ENTRY(nsIWritablePropertyBag)</span>
<a href="#l32.5"></a><span id="l32.5">   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsIPropertyBag, nsIWritablePropertyBag)</span>
<a href="#l32.6"></a><span id="l32.6">   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIWritablePropertyBag)</span>
<a href="#l32.7"></a><span id="l32.7">   NS_INTERFACE_MAP_ENTRY(nsITransaction)</span>
<a href="#l32.8"></a><span id="l32.8">   NS_INTERFACE_MAP_ENTRY(nsIPropertyBag2)</span>
<a href="#l32.9"></a><span id="l32.9">   NS_INTERFACE_MAP_ENTRY(nsIWritablePropertyBag2)</span>
<a href="#l32.10"></a><span id="l32.10"> NS_INTERFACE_MAP_END</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-nsMsgTxn::nsMsgTxn()</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-{</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-  m_txnType = 0;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-}</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+nsMsgTxn::nsMsgTxn() { m_txnType = 0; }</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+nsMsgTxn::~nsMsgTxn() {}</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-nsMsgTxn::~nsMsgTxn()</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-{</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-}</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+nsresult nsMsgTxn::Init() { return NS_OK; }</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-nsresult nsMsgTxn::Init()</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-{</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-}</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::HasKey(const nsAString&amp; name, bool *aResult)</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-{</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::HasKey(const nsAString&amp; name, bool* aResult) {</span>
<a href="#l32.33"></a><span id="l32.33">   *aResult = mPropertyHash.Get(name, nullptr);</span>
<a href="#l32.34"></a><span id="l32.34">   return NS_OK;</span>
<a href="#l32.35"></a><span id="l32.35"> }</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::Get(const nsAString&amp; name, nsIVariant* *_retval)</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-{</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::Get(const nsAString&amp; name, nsIVariant** _retval) {</span>
<a href="#l32.40"></a><span id="l32.40">   mPropertyHash.Get(name, _retval);</span>
<a href="#l32.41"></a><span id="l32.41">   return NS_OK;</span>
<a href="#l32.42"></a><span id="l32.42"> }</span>
<a href="#l32.43"></a><span id="l32.43"> </span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetProperty(const nsAString&amp; name, nsIVariant* * _retval)</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-{</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetProperty(const nsAString&amp; name,</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+                                    nsIVariant** _retval) {</span>
<a href="#l32.48"></a><span id="l32.48">   return mPropertyHash.Get(name, _retval) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l32.49"></a><span id="l32.49"> }</span>
<a href="#l32.50"></a><span id="l32.50"> </span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::SetProperty(const nsAString&amp; name, nsIVariant *value)</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-{</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::SetProperty(const nsAString&amp; name, nsIVariant* value) {</span>
<a href="#l32.54"></a><span id="l32.54">   NS_ENSURE_ARG_POINTER(value);</span>
<a href="#l32.55"></a><span id="l32.55">   mPropertyHash.Put(name, value);</span>
<a href="#l32.56"></a><span id="l32.56">   return NS_OK;</span>
<a href="#l32.57"></a><span id="l32.57"> }</span>
<a href="#l32.58"></a><span id="l32.58"> </span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::DeleteProperty(const nsAString&amp; name)</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-{</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-  if (!mPropertyHash.Get(name, nullptr))</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::DeleteProperty(const nsAString&amp; name) {</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+  if (!mPropertyHash.Get(name, nullptr)) return NS_ERROR_FAILURE;</span>
<a href="#l32.65"></a><span id="l32.65"> </span>
<a href="#l32.66"></a><span id="l32.66">   mPropertyHash.Remove(name);</span>
<a href="#l32.67"></a><span id="l32.67">   return mPropertyHash.Get(name, nullptr) ? NS_ERROR_FAILURE : NS_OK;</span>
<a href="#l32.68"></a><span id="l32.68"> }</span>
<a href="#l32.69"></a><span id="l32.69"> </span>
<a href="#l32.70"></a><span id="l32.70"> //</span>
<a href="#l32.71"></a><span id="l32.71"> // nsMailSimpleProperty class and impl; used for GetEnumerator</span>
<a href="#l32.72"></a><span id="l32.72"> // This is same as nsSimpleProperty but for external API use.</span>
<a href="#l32.73"></a><span id="l32.73"> //</span>
<a href="#l32.74"></a><span id="l32.74"> </span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-class nsMailSimpleProperty final : public nsIProperty</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-{</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-public:</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+class nsMailSimpleProperty final : public nsIProperty {</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+ public:</span>
<a href="#l32.80"></a><span id="l32.80">   nsMailSimpleProperty(const nsAString&amp; aName, nsIVariant* aValue)</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-      : mName(aName), mValue(aValue)</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-  {</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-  }</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+      : mName(aName), mValue(aValue) {}</span>
<a href="#l32.85"></a><span id="l32.85"> </span>
<a href="#l32.86"></a><span id="l32.86">   NS_DECL_ISUPPORTS</span>
<a href="#l32.87"></a><span id="l32.87">   NS_DECL_NSIPROPERTY</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-protected:</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+ protected:</span>
<a href="#l32.90"></a><span id="l32.90">   ~nsMailSimpleProperty() {}</span>
<a href="#l32.91"></a><span id="l32.91"> </span>
<a href="#l32.92"></a><span id="l32.92">   nsString mName;</span>
<a href="#l32.93"></a><span id="l32.93">   nsCOMPtr&lt;nsIVariant&gt; mValue;</span>
<a href="#l32.94"></a><span id="l32.94"> };</span>
<a href="#l32.95"></a><span id="l32.95"> </span>
<a href="#l32.96"></a><span id="l32.96"> NS_IMPL_ISUPPORTS(nsMailSimpleProperty, nsIProperty)</span>
<a href="#l32.97"></a><span id="l32.97"> </span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-NS_IMETHODIMP nsMailSimpleProperty::GetName(nsAString&amp; aName)</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-{</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+NS_IMETHODIMP nsMailSimpleProperty::GetName(nsAString&amp; aName) {</span>
<a href="#l32.101"></a><span id="l32.101">   aName.Assign(mName);</span>
<a href="#l32.102"></a><span id="l32.102">   return NS_OK;</span>
<a href="#l32.103"></a><span id="l32.103"> }</span>
<a href="#l32.104"></a><span id="l32.104"> </span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-NS_IMETHODIMP nsMailSimpleProperty::GetValue(nsIVariant* *aValue)</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-{</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+NS_IMETHODIMP nsMailSimpleProperty::GetValue(nsIVariant** aValue) {</span>
<a href="#l32.108"></a><span id="l32.108">   NS_IF_ADDREF(*aValue = mValue);</span>
<a href="#l32.109"></a><span id="l32.109">   return NS_OK;</span>
<a href="#l32.110"></a><span id="l32.110"> }</span>
<a href="#l32.111"></a><span id="l32.111"> </span>
<a href="#l32.112"></a><span id="l32.112"> // end nsMailSimpleProperty</span>
<a href="#l32.113"></a><span id="l32.113"> </span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetEnumerator(nsISimpleEnumerator* *_retval)</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-{</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetEnumerator(nsISimpleEnumerator** _retval) {</span>
<a href="#l32.117"></a><span id="l32.117">   nsCOMArray&lt;nsIProperty&gt; propertyArray;</span>
<a href="#l32.118"></a><span id="l32.118">   for (auto iter = mPropertyHash.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-    nsMailSimpleProperty *sprop = new nsMailSimpleProperty(iter.Key(),</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-                                                           iter.Data());</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+    nsMailSimpleProperty* sprop =</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+        new nsMailSimpleProperty(iter.Key(), iter.Data());</span>
<a href="#l32.123"></a><span id="l32.123">     propertyArray.AppendObject(sprop);</span>
<a href="#l32.124"></a><span id="l32.124">   }</span>
<a href="#l32.125"></a><span id="l32.125">   return NS_NewArrayEnumerator(_retval, propertyArray, NS_GET_IID(nsIProperty));</span>
<a href="#l32.126"></a><span id="l32.126"> }</span>
<a href="#l32.127"></a><span id="l32.127"> </span>
<a href="#l32.128"></a><span id="l32.128" class="difflineminus">-#define IMPL_GETSETPROPERTY_AS(Name, Type) \</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-nsMsgTxn::GetPropertyAs ## Name (const nsAString &amp; prop, Type *_retval) \</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-{ \</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-    nsIVariant* v = mPropertyHash.GetWeak(prop); \</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineminus">-    if (!v) \</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineminus">-        return NS_ERROR_NOT_AVAILABLE; \</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineminus">-    return v-&gt;GetAs ## Name(_retval); \</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineminus">-} \</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineminus">-\</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineminus">-nsMsgTxn::SetPropertyAs ## Name (const nsAString &amp; prop, Type value) \</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-{ \</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineminus">-    nsCOMPtr&lt;nsIWritableVariant&gt; var = new nsVariant(); \</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineminus">-    var-&gt;SetAs ## Name(value); \</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineminus">-    return SetProperty(prop, var); \</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineminus">-}</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+#define IMPL_GETSETPROPERTY_AS(Name, Type)                              \</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+  NS_IMETHODIMP                                                         \</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+  nsMsgTxn::GetPropertyAs##Name(const nsAString&amp; prop, Type* _retval) { \</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+    nsIVariant* v = mPropertyHash.GetWeak(prop);                        \</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+    if (!v) return NS_ERROR_NOT_AVAILABLE;                              \</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+    return v-&gt;GetAs##Name(_retval);                                     \</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+  }                                                                     \</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+                                                                        \</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+  NS_IMETHODIMP                                                         \</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+  nsMsgTxn::SetPropertyAs##Name(const nsAString&amp; prop, Type value) {    \</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+    nsCOMPtr&lt;nsIWritableVariant&gt; var = new nsVariant();                 \</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+    var-&gt;SetAs##Name(value);                                            \</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+    return SetProperty(prop, var);                                      \</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineplus">+  }</span>
<a href="#l32.159"></a><span id="l32.159"> </span>
<a href="#l32.160"></a><span id="l32.160"> IMPL_GETSETPROPERTY_AS(Int32, int32_t)</span>
<a href="#l32.161"></a><span id="l32.161"> IMPL_GETSETPROPERTY_AS(Uint32, uint32_t)</span>
<a href="#l32.162"></a><span id="l32.162"> IMPL_GETSETPROPERTY_AS(Int64, int64_t)</span>
<a href="#l32.163"></a><span id="l32.163"> IMPL_GETSETPROPERTY_AS(Uint64, uint64_t)</span>
<a href="#l32.164"></a><span id="l32.164"> IMPL_GETSETPROPERTY_AS(Double, double)</span>
<a href="#l32.165"></a><span id="l32.165"> IMPL_GETSETPROPERTY_AS(Bool, bool)</span>
<a href="#l32.166"></a><span id="l32.166"> </span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetPropertyAsAString(const nsAString &amp; prop,</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-                                             nsAString &amp; _retval)</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineminus">-{</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetPropertyAsAString(const nsAString&amp; prop,</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineplus">+                                             nsAString&amp; _retval) {</span>
<a href="#l32.172"></a><span id="l32.172">   nsIVariant* v = mPropertyHash.GetWeak(prop);</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-  if (!v)</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineplus">+  if (!v) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.176"></a><span id="l32.176">   return v-&gt;GetAsAString(_retval);</span>
<a href="#l32.177"></a><span id="l32.177"> }</span>
<a href="#l32.178"></a><span id="l32.178"> </span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetPropertyAsACString(const nsAString &amp; prop,</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineminus">-                                              nsACString &amp; _retval)</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineminus">-{</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetPropertyAsACString(const nsAString&amp; prop,</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+                                              nsACString&amp; _retval) {</span>
<a href="#l32.184"></a><span id="l32.184">   nsIVariant* v = mPropertyHash.GetWeak(prop);</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineminus">-  if (!v)</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+  if (!v) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.188"></a><span id="l32.188">   return v-&gt;GetAsACString(_retval);</span>
<a href="#l32.189"></a><span id="l32.189"> }</span>
<a href="#l32.190"></a><span id="l32.190"> </span>
<a href="#l32.191"></a><span id="l32.191" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetPropertyAsAUTF8String(const nsAString &amp; prop,</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineminus">-                                                 nsACString &amp; _retval)</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineminus">-{</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetPropertyAsAUTF8String(const nsAString&amp; prop,</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineplus">+                                                 nsACString&amp; _retval) {</span>
<a href="#l32.196"></a><span id="l32.196">   nsIVariant* v = mPropertyHash.GetWeak(prop);</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-  if (!v)</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+  if (!v) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.200"></a><span id="l32.200">   return v-&gt;GetAsAUTF8String(_retval);</span>
<a href="#l32.201"></a><span id="l32.201"> }</span>
<a href="#l32.202"></a><span id="l32.202"> </span>
<a href="#l32.203"></a><span id="l32.203" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetPropertyAsInterface(const nsAString &amp; prop,</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineminus">-                                               const nsIID &amp; aIID,</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineminus">-                                               void** _retval)</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineminus">-{</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetPropertyAsInterface(const nsAString&amp; prop,</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineplus">+                                               const nsIID&amp; aIID,</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineplus">+                                               void** _retval) {</span>
<a href="#l32.210"></a><span id="l32.210">   nsIVariant* v = mPropertyHash.GetWeak(prop);</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineminus">-  if (!v)</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineplus">+  if (!v) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.214"></a><span id="l32.214">   nsCOMPtr&lt;nsISupports&gt; val;</span>
<a href="#l32.215"></a><span id="l32.215">   nsresult rv = v-&gt;GetAsISupports(getter_AddRefs(val));</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineminus">-    return rv;</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.219"></a><span id="l32.219">   if (!val) {</span>
<a href="#l32.220"></a><span id="l32.220">     // We have a value, but it's null</span>
<a href="#l32.221"></a><span id="l32.221">     *_retval = nullptr;</span>
<a href="#l32.222"></a><span id="l32.222">     return NS_OK;</span>
<a href="#l32.223"></a><span id="l32.223">   }</span>
<a href="#l32.224"></a><span id="l32.224">   return val-&gt;QueryInterface(aIID, _retval);</span>
<a href="#l32.225"></a><span id="l32.225"> }</span>
<a href="#l32.226"></a><span id="l32.226"> </span>
<a href="#l32.227"></a><span id="l32.227" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::SetPropertyAsAString(const nsAString &amp; prop,</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineminus">-                                             const nsAString &amp; value)</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineminus">-{</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::SetPropertyAsAString(const nsAString&amp; prop,</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineplus">+                                             const nsAString&amp; value) {</span>
<a href="#l32.232"></a><span id="l32.232">   nsCOMPtr&lt;nsIWritableVariant&gt; var = new nsVariant();</span>
<a href="#l32.233"></a><span id="l32.233">   var-&gt;SetAsAString(value);</span>
<a href="#l32.234"></a><span id="l32.234">   return SetProperty(prop, var);</span>
<a href="#l32.235"></a><span id="l32.235"> }</span>
<a href="#l32.236"></a><span id="l32.236"> </span>
<a href="#l32.237"></a><span id="l32.237" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::SetPropertyAsACString(const nsAString &amp; prop,</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineminus">-                                              const nsACString &amp; value)</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineminus">-{</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::SetPropertyAsACString(const nsAString&amp; prop,</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineplus">+                                              const nsACString&amp; value) {</span>
<a href="#l32.242"></a><span id="l32.242">   nsCOMPtr&lt;nsIWritableVariant&gt; var = new nsVariant();</span>
<a href="#l32.243"></a><span id="l32.243">   var-&gt;SetAsACString(value);</span>
<a href="#l32.244"></a><span id="l32.244">   return SetProperty(prop, var);</span>
<a href="#l32.245"></a><span id="l32.245"> }</span>
<a href="#l32.246"></a><span id="l32.246"> </span>
<a href="#l32.247"></a><span id="l32.247" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::SetPropertyAsAUTF8String(const nsAString &amp; prop,</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineminus">-                                                 const nsACString &amp; value)</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineminus">-{</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::SetPropertyAsAUTF8String(const nsAString&amp; prop,</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineplus">+                                                 const nsACString&amp; value) {</span>
<a href="#l32.252"></a><span id="l32.252">   nsCOMPtr&lt;nsIWritableVariant&gt; var = new nsVariant();</span>
<a href="#l32.253"></a><span id="l32.253">   var-&gt;SetAsAUTF8String(value);</span>
<a href="#l32.254"></a><span id="l32.254">   return SetProperty(prop, var);</span>
<a href="#l32.255"></a><span id="l32.255"> }</span>
<a href="#l32.256"></a><span id="l32.256"> </span>
<a href="#l32.257"></a><span id="l32.257" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::SetPropertyAsInterface(const nsAString &amp; prop,</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineminus">-                                               nsISupports* value)</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineminus">-{</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::SetPropertyAsInterface(const nsAString&amp; prop,</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineplus">+                                               nsISupports* value) {</span>
<a href="#l32.262"></a><span id="l32.262">   nsCOMPtr&lt;nsIWritableVariant&gt; var = new nsVariant();</span>
<a href="#l32.263"></a><span id="l32.263">   var-&gt;SetAsISupports(value);</span>
<a href="#l32.264"></a><span id="l32.264">   return SetProperty(prop, var);</span>
<a href="#l32.265"></a><span id="l32.265"> }</span>
<a href="#l32.266"></a><span id="l32.266"> </span>
<a href="#l32.267"></a><span id="l32.267"> /////////////////////// Transaction Stuff //////////////////</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::DoTransaction(void)</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineminus">-{</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineminus">-}</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::DoTransaction(void) { return NS_OK; }</span>
<a href="#l32.273"></a><span id="l32.273"> </span>
<a href="#l32.274"></a><span id="l32.274" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::GetIsTransient(bool *aIsTransient)</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineminus">-{</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineminus">-  if (nullptr!=aIsTransient)</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::GetIsTransient(bool* aIsTransient) {</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineplus">+  if (nullptr != aIsTransient)</span>
<a href="#l32.279"></a><span id="l32.279">     *aIsTransient = false;</span>
<a href="#l32.280"></a><span id="l32.280">   else</span>
<a href="#l32.281"></a><span id="l32.281">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.282"></a><span id="l32.282">   return NS_OK;</span>
<a href="#l32.283"></a><span id="l32.283"> }</span>
<a href="#l32.284"></a><span id="l32.284"> </span>
<a href="#l32.285"></a><span id="l32.285" class="difflineminus">-NS_IMETHODIMP nsMsgTxn::Merge(nsITransaction *aTransaction, bool *aDidMerge)</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineminus">-{</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineplus">+NS_IMETHODIMP nsMsgTxn::Merge(nsITransaction* aTransaction, bool* aDidMerge) {</span>
<a href="#l32.288"></a><span id="l32.288">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l32.289"></a><span id="l32.289"> }</span>
<a href="#l32.290"></a><span id="l32.290"> </span>
<a href="#l32.291"></a><span id="l32.291" class="difflineminus">-</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-nsresult nsMsgTxn::GetMsgWindow(nsIMsgWindow **msgWindow)</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-{</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineminus">-    if (!msgWindow || !m_msgWindow)</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineminus">-    NS_ADDREF(*msgWindow = m_msgWindow);</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineplus">+nsresult nsMsgTxn::GetMsgWindow(nsIMsgWindow** msgWindow) {</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineplus">+  if (!msgWindow || !m_msgWindow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineplus">+  NS_ADDREF(*msgWindow = m_msgWindow);</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.302"></a><span id="l32.302"> }</span>
<a href="#l32.303"></a><span id="l32.303"> </span>
<a href="#l32.304"></a><span id="l32.304" class="difflineminus">-nsresult nsMsgTxn::SetMsgWindow(nsIMsgWindow *msgWindow)</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineminus">-{</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineminus">-    m_msgWindow = msgWindow;</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineplus">+nsresult nsMsgTxn::SetMsgWindow(nsIMsgWindow* msgWindow) {</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineplus">+  m_msgWindow = msgWindow;</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.311"></a><span id="l32.311"> }</span>
<a href="#l32.312"></a><span id="l32.312"> </span>
<a href="#l32.313"></a><span id="l32.313" class="difflineminus">-</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineminus">-nsresult</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineminus">-nsMsgTxn::SetTransactionType(uint32_t txnType)</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineminus">-{</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineplus">+nsresult nsMsgTxn::SetTransactionType(uint32_t txnType) {</span>
<a href="#l32.318"></a><span id="l32.318">   return SetPropertyAsUint32(NS_LITERAL_STRING(&quot;type&quot;), txnType);</span>
<a href="#l32.319"></a><span id="l32.319"> }</span>
<a href="#l32.320"></a><span id="l32.320"> </span>
<a href="#l32.321"></a><span id="l32.321"> /*none of the callers pass null aFolder,</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineminus">-  we always initialize aResult (before we pass in) for the case where the key is not in the db*/</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineminus">-nsresult</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineminus">-nsMsgTxn::CheckForToggleDelete(nsIMsgFolder *aFolder, const nsMsgKey &amp;aMsgKey, bool *aResult)</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineminus">-{</span>
<a href="#l32.326"></a><span id="l32.326" class="difflineplus">+  we always initialize aResult (before we pass in) for the case where the key is</span>
<a href="#l32.327"></a><span id="l32.327" class="difflineplus">+  not in the db*/</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineplus">+nsresult nsMsgTxn::CheckForToggleDelete(nsIMsgFolder* aFolder,</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineplus">+                                        const nsMsgKey&amp; aMsgKey,</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineplus">+                                        bool* aResult) {</span>
<a href="#l32.331"></a><span id="l32.331">   NS_ENSURE_ARG(aResult);</span>
<a href="#l32.332"></a><span id="l32.332">   nsCOMPtr&lt;nsIMsgDBHdr&gt; message;</span>
<a href="#l32.333"></a><span id="l32.333">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l32.334"></a><span id="l32.334">   nsresult rv = aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineminus">-  if (db)</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineminus">-  {</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineplus">+  if (db) {</span>
<a href="#l32.338"></a><span id="l32.338">     bool containsKey;</span>
<a href="#l32.339"></a><span id="l32.339">     rv = db-&gt;ContainsKey(aMsgKey, &amp;containsKey);</span>
<a href="#l32.340"></a><span id="l32.340" class="difflineminus">-    if (NS_FAILED(rv) || !containsKey)   // the message has been deleted from db, so we cannot do toggle here</span>
<a href="#l32.341"></a><span id="l32.341" class="difflineplus">+    if (NS_FAILED(rv) || !containsKey)  // the message has been deleted from db,</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineplus">+                                        // so we cannot do toggle here</span>
<a href="#l32.343"></a><span id="l32.343">       return NS_OK;</span>
<a href="#l32.344"></a><span id="l32.344">     rv = db-&gt;GetMsgHdrForKey(aMsgKey, getter_AddRefs(message));</span>
<a href="#l32.345"></a><span id="l32.345">     uint32_t flags;</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; message)</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineminus">-    {</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; message) {</span>
<a href="#l32.349"></a><span id="l32.349">       message-&gt;GetFlags(&amp;flags);</span>
<a href="#l32.350"></a><span id="l32.350">       *aResult = (flags &amp; nsMsgMessageFlags::IMAPDeleted) != 0;</span>
<a href="#l32.351"></a><span id="l32.351">     }</span>
<a href="#l32.352"></a><span id="l32.352">   }</span>
<a href="#l32.353"></a><span id="l32.353">   return rv;</span>
<a href="#l32.354"></a><span id="l32.354"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/util/nsMsgTxn.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgTxn.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -12,56 +12,58 @@</span>
<a href="#l33.4"></a><span id="l33.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l33.5"></a><span id="l33.5"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l33.6"></a><span id="l33.6"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l33.7"></a><span id="l33.7"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l33.8"></a><span id="l33.8"> #include &quot;nsIVariant.h&quot;</span>
<a href="#l33.9"></a><span id="l33.9"> #include &quot;nsIWritablePropertyBag.h&quot;</span>
<a href="#l33.10"></a><span id="l33.10"> #include &quot;nsIWritablePropertyBag2.h&quot;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#define NS_MESSAGETRANSACTION_IID \</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-{ /* da621b30-1efc-11d3-abe4-00805f8ac968 */ \</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-    0xda621b30, 0x1efc, 0x11d3, \</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-  { 0xab, 0xe4, 0x00, 0x80, 0x5f, 0x8a, 0xc9, 0x68 } }</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+#define NS_MESSAGETRANSACTION_IID                    \</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  { /* da621b30-1efc-11d3-abe4-00805f8ac968 */       \</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+    0xda621b30, 0x1efc, 0x11d3, {                    \</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+      0xab, 0xe4, 0x00, 0x80, 0x5f, 0x8a, 0xc9, 0x68 \</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+    }                                                \</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+  }</span>
<a href="#l33.22"></a><span id="l33.22"> /**</span>
<a href="#l33.23"></a><span id="l33.23">  * base class for all message undo/redo transactions.</span>
<a href="#l33.24"></a><span id="l33.24">  */</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26"> class NS_MSG_BASE nsMsgTxn : public nsITransaction,</span>
<a href="#l33.27"></a><span id="l33.27">                              public nsIWritablePropertyBag,</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-                             public nsIWritablePropertyBag2</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-{</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-public:</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-    nsMsgTxn();</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+                             public nsIWritablePropertyBag2 {</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+ public:</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+  nsMsgTxn();</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-    nsresult Init();</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+  nsresult Init();</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+  NS_IMETHOD DoTransaction(void) override;</span>
<a href="#l33.40"></a><span id="l33.40"> </span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-    NS_IMETHOD DoTransaction(void) override;</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+  NS_IMETHOD UndoTransaction(void) override = 0;</span>
<a href="#l33.43"></a><span id="l33.43"> </span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-    NS_IMETHOD UndoTransaction(void) override = 0;</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+  NS_IMETHOD RedoTransaction(void) override = 0;</span>
<a href="#l33.46"></a><span id="l33.46"> </span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-    NS_IMETHOD RedoTransaction(void) override = 0;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+  NS_IMETHOD GetIsTransient(bool *aIsTransient) override;</span>
<a href="#l33.49"></a><span id="l33.49"> </span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-    NS_IMETHOD GetIsTransient(bool *aIsTransient) override;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-    NS_IMETHOD Merge(nsITransaction *aTransaction, bool *aDidMerge) override;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+  NS_IMETHOD Merge(nsITransaction *aTransaction, bool *aDidMerge) override;</span>
<a href="#l33.54"></a><span id="l33.54"> </span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-    nsresult GetMsgWindow(nsIMsgWindow **msgWindow);</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-    nsresult SetMsgWindow(nsIMsgWindow *msgWindow);</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">-    nsresult SetTransactionType(uint32_t txnType);</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+  nsresult GetMsgWindow(nsIMsgWindow **msgWindow);</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  nsresult SetMsgWindow(nsIMsgWindow *msgWindow);</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+  nsresult SetTransactionType(uint32_t txnType);</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+  NS_DECL_NSIPROPERTYBAG</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+  NS_DECL_NSIPROPERTYBAG2</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+  NS_DECL_NSIWRITABLEPROPERTYBAG</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+  NS_DECL_NSIWRITABLEPROPERTYBAG2</span>
<a href="#l33.67"></a><span id="l33.67"> </span>
<a href="#l33.68"></a><span id="l33.68" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-    NS_DECL_NSIPROPERTYBAG</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-    NS_DECL_NSIPROPERTYBAG2</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-    NS_DECL_NSIWRITABLEPROPERTYBAG</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-    NS_DECL_NSIWRITABLEPROPERTYBAG2</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+ protected:</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+  virtual ~nsMsgTxn();</span>
<a href="#l33.75"></a><span id="l33.75"> </span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-protected:</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-    virtual ~nsMsgTxn();</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-    // a hash table of string -&gt; nsIVariant</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-    nsInterfaceHashtable&lt;nsStringHashKey, nsIVariant&gt; mPropertyHash;</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-    uint32_t m_txnType;</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-    nsresult CheckForToggleDelete(nsIMsgFolder *aFolder, const nsMsgKey &amp;aMsgKey, bool *aResult);</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+  // a hash table of string -&gt; nsIVariant</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+  nsInterfaceHashtable&lt;nsStringHashKey, nsIVariant&gt; mPropertyHash;</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+  uint32_t m_txnType;</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+  nsresult CheckForToggleDelete(nsIMsgFolder *aFolder, const nsMsgKey &amp;aMsgKey,</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+                                bool *aResult);</span>
<a href="#l33.90"></a><span id="l33.90"> };</span>
<a href="#l33.91"></a><span id="l33.91"> </span>
<a href="#l33.92"></a><span id="l33.92"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -90,103 +90,92 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #include &quot;nsIScriptError.h&quot;</span>
<a href="#l34.5"></a><span id="l34.5"> #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> // Log an error string to the error console</span>
<a href="#l34.8"></a><span id="l34.8"> // (adapted from nsContentUtils::LogSimpleConsoleError).</span>
<a href="#l34.9"></a><span id="l34.9"> // Flag can indicate error, warning or info.</span>
<a href="#l34.10"></a><span id="l34.10"> NS_MSG_BASE void MsgLogToConsole4(const nsAString &amp;aErrorText,</span>
<a href="#l34.11"></a><span id="l34.11">                                   const nsAString &amp;aFilename,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-                                  uint32_t aLinenumber,</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-                                  uint32_t aFlag)</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-{</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+                                  uint32_t aLinenumber, uint32_t aFlag) {</span>
<a href="#l34.16"></a><span id="l34.16">   nsCOMPtr&lt;nsIScriptError&gt; scriptError =</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-    do_CreateInstance(NS_SCRIPTERROR_CONTRACTID);</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-  if (NS_WARN_IF(!scriptError))</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-    return;</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+      do_CreateInstance(NS_SCRIPTERROR_CONTRACTID);</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+  if (NS_WARN_IF(!scriptError)) return;</span>
<a href="#l34.22"></a><span id="l34.22">   nsCOMPtr&lt;nsIConsoleService&gt; console =</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-    do_GetService(NS_CONSOLESERVICE_CONTRACTID);</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-  if (NS_WARN_IF(!console))</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-    return;</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-  if (NS_FAILED(scriptError-&gt;Init(aErrorText,</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-                                  aFilename,</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-                                  EmptyString(),</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-                                  aLinenumber,</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-                                  0,</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-                                  aFlag,</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-                                  &quot;mailnews&quot;,</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-                                  false,</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+      do_GetService(NS_CONSOLESERVICE_CONTRACTID);</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+  if (NS_WARN_IF(!console)) return;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+  if (NS_FAILED(scriptError-&gt;Init(aErrorText, aFilename, EmptyString(),</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+                                  aLinenumber, 0, aFlag, &quot;mailnews&quot;, false,</span>
<a href="#l34.38"></a><span id="l34.38">                                   false)))</span>
<a href="#l34.39"></a><span id="l34.39">     return;</span>
<a href="#l34.40"></a><span id="l34.40">   console-&gt;LogMessage(scriptError);</span>
<a href="#l34.41"></a><span id="l34.41">   return;</span>
<a href="#l34.42"></a><span id="l34.42"> }</span>
<a href="#l34.43"></a><span id="l34.43"> </span>
<a href="#l34.44"></a><span id="l34.44"> using namespace mozilla;</span>
<a href="#l34.45"></a><span id="l34.45"> using namespace mozilla::net;</span>
<a href="#l34.46"></a><span id="l34.46"> </span>
<a href="#l34.47"></a><span id="l34.47"> #define ILLEGAL_FOLDER_CHARS &quot;;#&quot;</span>
<a href="#l34.48"></a><span id="l34.48"> #define ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER &quot;.&quot;</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineminus">-#define ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER  &quot;.~ &quot;</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+#define ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER &quot;.~ &quot;</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52" class="difflineminus">-nsresult GetMessageServiceContractIDForURI(const char *uri, nsCString &amp;contractID)</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-{</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+nsresult GetMessageServiceContractIDForURI(const char *uri,</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+                                           nsCString &amp;contractID) {</span>
<a href="#l34.56"></a><span id="l34.56">   nsresult rv = NS_OK;</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-  //Find protocol</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+  // Find protocol</span>
<a href="#l34.59"></a><span id="l34.59">   nsAutoCString uriStr(uri);</span>
<a href="#l34.60"></a><span id="l34.60">   int32_t pos = uriStr.FindChar(':');</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-  if (pos == -1)</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+  if (pos == -1) return NS_ERROR_FAILURE;</span>
<a href="#l34.64"></a><span id="l34.64"> </span>
<a href="#l34.65"></a><span id="l34.65">   nsAutoCString protocol(StringHead(uriStr, pos));</span>
<a href="#l34.66"></a><span id="l34.66"> </span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-  if (protocol.EqualsLiteral(&quot;file&quot;) &amp;&amp; uriStr.Find(&quot;application/x-message-display&quot;) != -1)</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+  if (protocol.EqualsLiteral(&quot;file&quot;) &amp;&amp;</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+      uriStr.Find(&quot;application/x-message-display&quot;) != -1)</span>
<a href="#l34.70"></a><span id="l34.70">     protocol.AssignLiteral(&quot;mailbox&quot;);</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-  //Build message service contractid</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+  // Build message service contractid</span>
<a href="#l34.73"></a><span id="l34.73">   contractID = &quot;@mozilla.org/messenger/messageservice;1?type=&quot;;</span>
<a href="#l34.74"></a><span id="l34.74">   contractID += protocol.get();</span>
<a href="#l34.75"></a><span id="l34.75"> </span>
<a href="#l34.76"></a><span id="l34.76">   return rv;</span>
<a href="#l34.77"></a><span id="l34.77"> }</span>
<a href="#l34.78"></a><span id="l34.78"> </span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-nsresult GetMessageServiceFromURI(const nsACString&amp; uri, nsIMsgMessageService **aMessageService)</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-{</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+nsresult GetMessageServiceFromURI(const nsACString &amp;uri,</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+                                  nsIMsgMessageService **aMessageService) {</span>
<a href="#l34.83"></a><span id="l34.83">   nsresult rv;</span>
<a href="#l34.84"></a><span id="l34.84"> </span>
<a href="#l34.85"></a><span id="l34.85">   nsAutoCString contractID;</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-  rv = GetMessageServiceContractIDForURI(PromiseFlatCString(uri).get(), contractID);</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  rv = GetMessageServiceContractIDForURI(PromiseFlatCString(uri).get(),</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+                                         contractID);</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.91"></a><span id="l34.91"> </span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService = do_GetService(contractID.get(), &amp;rv);</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService =</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+      do_GetService(contractID.get(), &amp;rv);</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98">   msgService.forget(aMessageService);</span>
<a href="#l34.99"></a><span id="l34.99">   return rv;</span>
<a href="#l34.100"></a><span id="l34.100"> }</span>
<a href="#l34.101"></a><span id="l34.101"> </span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-nsresult GetMsgDBHdrFromURI(const char *uri, nsIMsgDBHdr **msgHdr)</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-{</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-  nsresult rv = GetMessageServiceFromURI(nsDependentCString(uri), getter_AddRefs(msgMessageService));</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+nsresult GetMsgDBHdrFromURI(const char *uri, nsIMsgDBHdr **msgHdr) {</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+  nsresult rv = GetMessageServiceFromURI(nsDependentCString(uri),</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineplus">+                                         getter_AddRefs(msgMessageService));</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.112"></a><span id="l34.112">   if (!msgMessageService) return NS_ERROR_FAILURE;</span>
<a href="#l34.113"></a><span id="l34.113"> </span>
<a href="#l34.114"></a><span id="l34.114">   return msgMessageService-&gt;MessageURIToMsgHdr(uri, msgHdr);</span>
<a href="#l34.115"></a><span id="l34.115"> }</span>
<a href="#l34.116"></a><span id="l34.116"> </span>
<a href="#l34.117"></a><span id="l34.117"> // Where should this live? It's a utility used to convert a string priority,</span>
<a href="#l34.118"></a><span id="l34.118"> //  e.g., &quot;High, Low, Normal&quot; to an enum.</span>
<a href="#l34.119"></a><span id="l34.119"> // Perhaps we should have an interface that groups together all these</span>
<a href="#l34.120"></a><span id="l34.120"> //  utilities...</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-nsresult NS_MsgGetPriorityFromString(</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-           const char * const priority,</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-           nsMsgPriorityValue &amp; outPriority)</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-{</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-  if (!priority)</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineplus">+nsresult NS_MsgGetPriorityFromString(const char *const priority,</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineplus">+                                     nsMsgPriorityValue &amp;outPriority) {</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineplus">+  if (!priority) return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.130"></a><span id="l34.130"> </span>
<a href="#l34.131"></a><span id="l34.131">   // Note: Checking the values separately and _before_ the names,</span>
<a href="#l34.132"></a><span id="l34.132">   //        hoping for a much faster match;</span>
<a href="#l34.133"></a><span id="l34.133">   //       Only _drawback_, as &quot;priority&quot; handling is not truly specified:</span>
<a href="#l34.134"></a><span id="l34.134">   //        some software may have the number meanings reversed (1=Lowest) !?</span>
<a href="#l34.135"></a><span id="l34.135">   if (PL_strchr(priority, '1'))</span>
<a href="#l34.136"></a><span id="l34.136">     outPriority = nsMsgPriority::highest;</span>
<a href="#l34.137"></a><span id="l34.137">   else if (PL_strchr(priority, '2'))</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineat">@@ -194,41 +183,37 @@ nsresult NS_MsgGetPriorityFromString(</span>
<a href="#l34.139"></a><span id="l34.139">   else if (PL_strchr(priority, '3'))</span>
<a href="#l34.140"></a><span id="l34.140">     outPriority = nsMsgPriority::normal;</span>
<a href="#l34.141"></a><span id="l34.141">   else if (PL_strchr(priority, '4'))</span>
<a href="#l34.142"></a><span id="l34.142">     outPriority = nsMsgPriority::low;</span>
<a href="#l34.143"></a><span id="l34.143">   else if (PL_strchr(priority, '5'))</span>
<a href="#l34.144"></a><span id="l34.144">     outPriority = nsMsgPriority::lowest;</span>
<a href="#l34.145"></a><span id="l34.145">   else if (PL_strcasestr(priority, &quot;Highest&quot;))</span>
<a href="#l34.146"></a><span id="l34.146">     outPriority = nsMsgPriority::highest;</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-       // Important: &quot;High&quot; must be tested after &quot;Highest&quot; !</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-  else if (PL_strcasestr(priority, &quot;High&quot;) ||</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-           PL_strcasestr(priority, &quot;Urgent&quot;))</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineplus">+  // Important: &quot;High&quot; must be tested after &quot;Highest&quot; !</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineplus">+  else if (PL_strcasestr(priority, &quot;High&quot;) || PL_strcasestr(priority, &quot;Urgent&quot;))</span>
<a href="#l34.152"></a><span id="l34.152">     outPriority = nsMsgPriority::high;</span>
<a href="#l34.153"></a><span id="l34.153">   else if (PL_strcasestr(priority, &quot;Normal&quot;))</span>
<a href="#l34.154"></a><span id="l34.154">     outPriority = nsMsgPriority::normal;</span>
<a href="#l34.155"></a><span id="l34.155">   else if (PL_strcasestr(priority, &quot;Lowest&quot;))</span>
<a href="#l34.156"></a><span id="l34.156">     outPriority = nsMsgPriority::lowest;</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-       // Important: &quot;Low&quot; must be tested after &quot;Lowest&quot; !</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+  // Important: &quot;Low&quot; must be tested after &quot;Lowest&quot; !</span>
<a href="#l34.159"></a><span id="l34.159">   else if (PL_strcasestr(priority, &quot;Low&quot;) ||</span>
<a href="#l34.160"></a><span id="l34.160">            PL_strcasestr(priority, &quot;Non-urgent&quot;))</span>
<a href="#l34.161"></a><span id="l34.161">     outPriority = nsMsgPriority::low;</span>
<a href="#l34.162"></a><span id="l34.162">   else</span>
<a href="#l34.163"></a><span id="l34.163">     // &quot;Default&quot; case gets default value.</span>
<a href="#l34.164"></a><span id="l34.164">     outPriority = nsMsgPriority::Default;</span>
<a href="#l34.165"></a><span id="l34.165"> </span>
<a href="#l34.166"></a><span id="l34.166">   return NS_OK;</span>
<a href="#l34.167"></a><span id="l34.167"> }</span>
<a href="#l34.168"></a><span id="l34.168"> </span>
<a href="#l34.169"></a><span id="l34.169" class="difflineminus">-nsresult NS_MsgGetPriorityValueString(</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineminus">-           const nsMsgPriorityValue p,</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-           nsACString &amp; outValueString)</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineminus">-{</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineminus">-  switch (p)</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineminus">-  {</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineplus">+nsresult NS_MsgGetPriorityValueString(const nsMsgPriorityValue p,</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineplus">+                                      nsACString &amp;outValueString) {</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineplus">+  switch (p) {</span>
<a href="#l34.178"></a><span id="l34.178">     case nsMsgPriority::highest:</span>
<a href="#l34.179"></a><span id="l34.179">       outValueString.Assign('1');</span>
<a href="#l34.180"></a><span id="l34.180">       break;</span>
<a href="#l34.181"></a><span id="l34.181">     case nsMsgPriority::high:</span>
<a href="#l34.182"></a><span id="l34.182">       outValueString.Assign('2');</span>
<a href="#l34.183"></a><span id="l34.183">       break;</span>
<a href="#l34.184"></a><span id="l34.184">     case nsMsgPriority::normal:</span>
<a href="#l34.185"></a><span id="l34.185">       outValueString.Assign('3');</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineat">@@ -246,22 +231,19 @@ nsresult NS_MsgGetPriorityValueString(</span>
<a href="#l34.187"></a><span id="l34.187">       break;</span>
<a href="#l34.188"></a><span id="l34.188">     default:</span>
<a href="#l34.189"></a><span id="l34.189">       NS_ASSERTION(false, &quot;invalid priority value&quot;);</span>
<a href="#l34.190"></a><span id="l34.190">   }</span>
<a href="#l34.191"></a><span id="l34.191"> </span>
<a href="#l34.192"></a><span id="l34.192">   return NS_OK;</span>
<a href="#l34.193"></a><span id="l34.193"> }</span>
<a href="#l34.194"></a><span id="l34.194"> </span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-nsresult NS_MsgGetUntranslatedPriorityName(</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-           const nsMsgPriorityValue p,</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-           nsACString &amp; outName)</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-{</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-  switch (p)</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-  {</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineplus">+nsresult NS_MsgGetUntranslatedPriorityName(const nsMsgPriorityValue p,</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineplus">+                                           nsACString &amp;outName) {</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineplus">+  switch (p) {</span>
<a href="#l34.204"></a><span id="l34.204">     case nsMsgPriority::highest:</span>
<a href="#l34.205"></a><span id="l34.205">       outName.AssignLiteral(&quot;Highest&quot;);</span>
<a href="#l34.206"></a><span id="l34.206">       break;</span>
<a href="#l34.207"></a><span id="l34.207">     case nsMsgPriority::high:</span>
<a href="#l34.208"></a><span id="l34.208">       outName.AssignLiteral(&quot;High&quot;);</span>
<a href="#l34.209"></a><span id="l34.209">       break;</span>
<a href="#l34.210"></a><span id="l34.210">     case nsMsgPriority::normal:</span>
<a href="#l34.211"></a><span id="l34.211">       outName.AssignLiteral(&quot;Normal&quot;);</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineat">@@ -279,484 +261,436 @@ nsresult NS_MsgGetUntranslatedPriorityNa</span>
<a href="#l34.213"></a><span id="l34.213">       break;</span>
<a href="#l34.214"></a><span id="l34.214">     default:</span>
<a href="#l34.215"></a><span id="l34.215">       NS_ASSERTION(false, &quot;invalid priority value&quot;);</span>
<a href="#l34.216"></a><span id="l34.216">   }</span>
<a href="#l34.217"></a><span id="l34.217"> </span>
<a href="#l34.218"></a><span id="l34.218">   return NS_OK;</span>
<a href="#l34.219"></a><span id="l34.219"> }</span>
<a href="#l34.220"></a><span id="l34.220"> </span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-</span>
<a href="#l34.222"></a><span id="l34.222"> /* this used to be XP_StringHash2 from xp_hash.c */</span>
<a href="#l34.223"></a><span id="l34.223"> /* phong's linear congruential hash  */</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineminus">-static uint32_t StringHash(const char *ubuf, int32_t len = -1)</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-{</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineminus">-  unsigned char * buf = (unsigned char*) ubuf;</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineminus">-  uint32_t h=1;</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineplus">+static uint32_t StringHash(const char *ubuf, int32_t len = -1) {</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineplus">+  unsigned char *buf = (unsigned char *)ubuf;</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+  uint32_t h = 1;</span>
<a href="#l34.231"></a><span id="l34.231">   unsigned char *end = buf + (len == -1 ? strlen(ubuf) : len);</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineminus">-  while(buf &lt; end) {</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-    h = 0x63c63cd9*h + 0x9c39c33d + (int32_t)*buf;</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineplus">+  while (buf &lt; end) {</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+    h = 0x63c63cd9 * h + 0x9c39c33d + (int32_t)*buf;</span>
<a href="#l34.236"></a><span id="l34.236">     buf++;</span>
<a href="#l34.237"></a><span id="l34.237">   }</span>
<a href="#l34.238"></a><span id="l34.238">   return h;</span>
<a href="#l34.239"></a><span id="l34.239"> }</span>
<a href="#l34.240"></a><span id="l34.240"> </span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-inline uint32_t StringHash(const nsAutoString&amp; str)</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-{</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineminus">-    const char16_t *strbuf = str.get();</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineminus">-    return StringHash(reinterpret_cast&lt;const char*&gt;(strbuf),</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineminus">-                      str.Length() * 2);</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineplus">+inline uint32_t StringHash(const nsAutoString &amp;str) {</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineplus">+  const char16_t *strbuf = str.get();</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineplus">+  return StringHash(reinterpret_cast&lt;const char *&gt;(strbuf), str.Length() * 2);</span>
<a href="#l34.249"></a><span id="l34.249"> }</span>
<a href="#l34.250"></a><span id="l34.250"> </span>
<a href="#l34.251"></a><span id="l34.251"> /* Utility functions used in a few places in mailnews */</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineminus">-int32_t</span>
<a href="#l34.253"></a><span id="l34.253" class="difflineminus">-MsgFindCharInSet(const nsCString &amp;aString,</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineminus">-                 const char* aChars, uint32_t aOffset)</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-{</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineplus">+int32_t MsgFindCharInSet(const nsCString &amp;aString, const char *aChars,</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineplus">+                         uint32_t aOffset) {</span>
<a href="#l34.258"></a><span id="l34.258">   return aString.FindCharInSet(aChars, aOffset);</span>
<a href="#l34.259"></a><span id="l34.259"> }</span>
<a href="#l34.260"></a><span id="l34.260"> </span>
<a href="#l34.261"></a><span id="l34.261" class="difflineminus">-int32_t</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineminus">-MsgFindCharInSet(const nsString &amp;aString,</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-                 const char* aChars, uint32_t aOffset)</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineminus">-{</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineplus">+int32_t MsgFindCharInSet(const nsString &amp;aString, const char *aChars,</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineplus">+                         uint32_t aOffset) {</span>
<a href="#l34.267"></a><span id="l34.267">   return aString.FindCharInSet(aChars, aOffset);</span>
<a href="#l34.268"></a><span id="l34.268"> }</span>
<a href="#l34.269"></a><span id="l34.269"> </span>
<a href="#l34.270"></a><span id="l34.270" class="difflineminus">-static bool ConvertibleToNative(const nsAutoString&amp; str)</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineminus">-{</span>
<a href="#l34.272"></a><span id="l34.272" class="difflineminus">-    nsAutoCString native;</span>
<a href="#l34.273"></a><span id="l34.273" class="difflineminus">-    nsAutoString roundTripped;</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-    NS_CopyUnicodeToNative(str, native);</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineminus">-    NS_CopyNativeToUnicode(native, roundTripped);</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineminus">-    return str.Equals(roundTripped);</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineplus">+static bool ConvertibleToNative(const nsAutoString &amp;str) {</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineplus">+  nsAutoCString native;</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineplus">+  nsAutoString roundTripped;</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineplus">+  NS_CopyUnicodeToNative(str, native);</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineplus">+  NS_CopyNativeToUnicode(native, roundTripped);</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineplus">+  return str.Equals(roundTripped);</span>
<a href="#l34.283"></a><span id="l34.283"> }</span>
<a href="#l34.284"></a><span id="l34.284"> </span>
<a href="#l34.285"></a><span id="l34.285"> #if defined(XP_UNIX)</span>
<a href="#l34.286"></a><span id="l34.286" class="difflineminus">-  const static uint32_t MAX_LEN = 55;</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineplus">+const static uint32_t MAX_LEN = 55;</span>
<a href="#l34.288"></a><span id="l34.288"> #elif defined(XP_WIN)</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineminus">-  const static uint32_t MAX_LEN = 55;</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineplus">+const static uint32_t MAX_LEN = 55;</span>
<a href="#l34.291"></a><span id="l34.291"> #else</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineminus">-  #error need_to_define_your_max_filename_length</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineplus">+#  error need_to_define_your_max_filename_length</span>
<a href="#l34.294"></a><span id="l34.294"> #endif</span>
<a href="#l34.295"></a><span id="l34.295"> </span>
<a href="#l34.296"></a><span id="l34.296" class="difflineminus">-nsresult NS_MsgHashIfNecessary(nsAutoCString &amp;name)</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineminus">-{</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineminus">-  if (name.IsEmpty())</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineminus">-    return NS_OK; // Nothing to do.</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineplus">+nsresult NS_MsgHashIfNecessary(nsAutoCString &amp;name) {</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineplus">+  if (name.IsEmpty()) return NS_OK;  // Nothing to do.</span>
<a href="#l34.302"></a><span id="l34.302">   nsAutoCString str(name);</span>
<a href="#l34.303"></a><span id="l34.303"> </span>
<a href="#l34.304"></a><span id="l34.304">   // Given a filename, make it safe for filesystem</span>
<a href="#l34.305"></a><span id="l34.305">   // certain filenames require hashing because they</span>
<a href="#l34.306"></a><span id="l34.306">   // are too long or contain illegal characters</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineminus">-  int32_t illegalCharacterIndex = MsgFindCharInSet(str,</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineminus">-                                                   FILE_PATH_SEPARATOR</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineminus">-                                                   FILE_ILLEGAL_CHARACTERS</span>
<a href="#l34.310"></a><span id="l34.310" class="difflineminus">-                                                   ILLEGAL_FOLDER_CHARS, 0);</span>
<a href="#l34.311"></a><span id="l34.311" class="difflineplus">+  int32_t illegalCharacterIndex = MsgFindCharInSet(</span>
<a href="#l34.312"></a><span id="l34.312" class="difflineplus">+      str, FILE_PATH_SEPARATOR FILE_ILLEGAL_CHARACTERS ILLEGAL_FOLDER_CHARS, 0);</span>
<a href="#l34.313"></a><span id="l34.313"> </span>
<a href="#l34.314"></a><span id="l34.314">   // Need to check the first ('.') and last ('.', '~' and ' ') char</span>
<a href="#l34.315"></a><span id="l34.315" class="difflineminus">-  if (illegalCharacterIndex == -1)</span>
<a href="#l34.316"></a><span id="l34.316" class="difflineminus">-  {</span>
<a href="#l34.317"></a><span id="l34.317" class="difflineplus">+  if (illegalCharacterIndex == -1) {</span>
<a href="#l34.318"></a><span id="l34.318">     int32_t lastIndex = str.Length() - 1;</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineminus">-    if (NS_LITERAL_CSTRING(ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER).FindChar(str[0]) != -1)</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineplus">+    if (NS_LITERAL_CSTRING(ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER)</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineplus">+            .FindChar(str[0]) != -1)</span>
<a href="#l34.322"></a><span id="l34.322">       illegalCharacterIndex = 0;</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineminus">-    else if (NS_LITERAL_CSTRING(ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER).FindChar(str[lastIndex]) != -1)</span>
<a href="#l34.324"></a><span id="l34.324" class="difflineplus">+    else if (NS_LITERAL_CSTRING(ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER)</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineplus">+                 .FindChar(str[lastIndex]) != -1)</span>
<a href="#l34.326"></a><span id="l34.326">       illegalCharacterIndex = lastIndex;</span>
<a href="#l34.327"></a><span id="l34.327">     else</span>
<a href="#l34.328"></a><span id="l34.328">       illegalCharacterIndex = -1;</span>
<a href="#l34.329"></a><span id="l34.329">   }</span>
<a href="#l34.330"></a><span id="l34.330"> </span>
<a href="#l34.331"></a><span id="l34.331">   char hashedname[MAX_LEN + 1];</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineminus">-  if (illegalCharacterIndex == -1)</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineminus">-  {</span>
<a href="#l34.334"></a><span id="l34.334" class="difflineplus">+  if (illegalCharacterIndex == -1) {</span>
<a href="#l34.335"></a><span id="l34.335">     // no illegal chars, it's just too long</span>
<a href="#l34.336"></a><span id="l34.336">     // keep the initial part of the string, but hash to make it fit</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineminus">-    if (str.Length() &gt; MAX_LEN)</span>
<a href="#l34.338"></a><span id="l34.338" class="difflineminus">-    {</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineplus">+    if (str.Length() &gt; MAX_LEN) {</span>
<a href="#l34.340"></a><span id="l34.340">       PL_strncpy(hashedname, str.get(), MAX_LEN + 1);</span>
<a href="#l34.341"></a><span id="l34.341">       PR_snprintf(hashedname + MAX_LEN - 8, 9, &quot;%08lx&quot;,</span>
<a href="#l34.342"></a><span id="l34.342" class="difflineminus">-                (unsigned long) StringHash(str.get()));</span>
<a href="#l34.343"></a><span id="l34.343" class="difflineplus">+                  (unsigned long)StringHash(str.get()));</span>
<a href="#l34.344"></a><span id="l34.344">       name = hashedname;</span>
<a href="#l34.345"></a><span id="l34.345">     }</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineminus">-  }</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineminus">-  else</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineminus">-  {</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineminus">-      // found illegal chars, hash the whole thing</span>
<a href="#l34.350"></a><span id="l34.350" class="difflineminus">-      // if we do substitution, then hash, two strings</span>
<a href="#l34.351"></a><span id="l34.351" class="difflineminus">-      // could hash to the same value.</span>
<a href="#l34.352"></a><span id="l34.352" class="difflineminus">-      // for example, on mac:  &quot;foo__bar&quot;, &quot;foo:_bar&quot;, &quot;foo::bar&quot;</span>
<a href="#l34.353"></a><span id="l34.353" class="difflineminus">-      // would map to &quot;foo_bar&quot;.  this way, all three will map to</span>
<a href="#l34.354"></a><span id="l34.354" class="difflineminus">-      // different values</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineminus">-      PR_snprintf(hashedname, 9, &quot;%08lx&quot;,</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineminus">-                (unsigned long) StringHash(str.get()));</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineminus">-      name = hashedname;</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineplus">+  } else {</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineplus">+    // found illegal chars, hash the whole thing</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineplus">+    // if we do substitution, then hash, two strings</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineplus">+    // could hash to the same value.</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineplus">+    // for example, on mac:  &quot;foo__bar&quot;, &quot;foo:_bar&quot;, &quot;foo::bar&quot;</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineplus">+    // would map to &quot;foo_bar&quot;.  this way, all three will map to</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineplus">+    // different values</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+    PR_snprintf(hashedname, 9, &quot;%08lx&quot;, (unsigned long)StringHash(str.get()));</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineplus">+    name = hashedname;</span>
<a href="#l34.367"></a><span id="l34.367">   }</span>
<a href="#l34.368"></a><span id="l34.368"> </span>
<a href="#l34.369"></a><span id="l34.369">   return NS_OK;</span>
<a href="#l34.370"></a><span id="l34.370"> }</span>
<a href="#l34.371"></a><span id="l34.371"> </span>
<a href="#l34.372"></a><span id="l34.372"> // XXX : The number of UTF-16 2byte code units are half the number of</span>
<a href="#l34.373"></a><span id="l34.373"> // bytes in legacy encodings for CJK strings and non-Latin1 in UTF-8.</span>
<a href="#l34.374"></a><span id="l34.374"> // The ratio can be 1/3 for CJK strings in UTF-8. However, we can</span>
<a href="#l34.375"></a><span id="l34.375"> // get away with using the same MAX_LEN for nsCString and nsString</span>
<a href="#l34.376"></a><span id="l34.376"> // because MAX_LEN is defined rather conservatively in the first place.</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineminus">-nsresult NS_MsgHashIfNecessary(nsAutoString &amp;name)</span>
<a href="#l34.378"></a><span id="l34.378" class="difflineminus">-{</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineminus">-  if (name.IsEmpty())</span>
<a href="#l34.380"></a><span id="l34.380" class="difflineminus">-    return NS_OK; // Nothing to do.</span>
<a href="#l34.381"></a><span id="l34.381" class="difflineminus">-  int32_t illegalCharacterIndex = MsgFindCharInSet(name,</span>
<a href="#l34.382"></a><span id="l34.382" class="difflineminus">-                                                   FILE_PATH_SEPARATOR</span>
<a href="#l34.383"></a><span id="l34.383" class="difflineminus">-                                                   FILE_ILLEGAL_CHARACTERS</span>
<a href="#l34.384"></a><span id="l34.384" class="difflineminus">-                                                   ILLEGAL_FOLDER_CHARS, 0);</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineplus">+nsresult NS_MsgHashIfNecessary(nsAutoString &amp;name) {</span>
<a href="#l34.386"></a><span id="l34.386" class="difflineplus">+  if (name.IsEmpty()) return NS_OK;  // Nothing to do.</span>
<a href="#l34.387"></a><span id="l34.387" class="difflineplus">+  int32_t illegalCharacterIndex = MsgFindCharInSet(</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineplus">+      name, FILE_PATH_SEPARATOR FILE_ILLEGAL_CHARACTERS ILLEGAL_FOLDER_CHARS,</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineplus">+      0);</span>
<a href="#l34.390"></a><span id="l34.390"> </span>
<a href="#l34.391"></a><span id="l34.391">   // Need to check the first ('.') and last ('.', '~' and ' ') char</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineminus">-  if (illegalCharacterIndex == -1)</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineminus">-  {</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineplus">+  if (illegalCharacterIndex == -1) {</span>
<a href="#l34.395"></a><span id="l34.395">     int32_t lastIndex = name.Length() - 1;</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineminus">-    if (NS_LITERAL_STRING(ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER).FindChar(name[0]) != -1)</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineplus">+    if (NS_LITERAL_STRING(ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER)</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineplus">+            .FindChar(name[0]) != -1)</span>
<a href="#l34.399"></a><span id="l34.399">       illegalCharacterIndex = 0;</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineminus">-    else if (NS_LITERAL_STRING(ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER).FindChar(name[lastIndex]) != -1)</span>
<a href="#l34.401"></a><span id="l34.401" class="difflineplus">+    else if (NS_LITERAL_STRING(ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER)</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineplus">+                 .FindChar(name[lastIndex]) != -1)</span>
<a href="#l34.403"></a><span id="l34.403">       illegalCharacterIndex = lastIndex;</span>
<a href="#l34.404"></a><span id="l34.404">     else</span>
<a href="#l34.405"></a><span id="l34.405">       illegalCharacterIndex = -1;</span>
<a href="#l34.406"></a><span id="l34.406">   }</span>
<a href="#l34.407"></a><span id="l34.407"> </span>
<a href="#l34.408"></a><span id="l34.408">   char hashedname[9];</span>
<a href="#l34.409"></a><span id="l34.409">   int32_t keptLength = -1;</span>
<a href="#l34.410"></a><span id="l34.410">   if (illegalCharacterIndex != -1)</span>
<a href="#l34.411"></a><span id="l34.411">     keptLength = illegalCharacterIndex;</span>
<a href="#l34.412"></a><span id="l34.412">   else if (!ConvertibleToNative(name))</span>
<a href="#l34.413"></a><span id="l34.413">     keptLength = 0;</span>
<a href="#l34.414"></a><span id="l34.414">   else if (name.Length() &gt; MAX_LEN) {</span>
<a href="#l34.415"></a><span id="l34.415" class="difflineminus">-    keptLength = MAX_LEN-8;</span>
<a href="#l34.416"></a><span id="l34.416" class="difflineplus">+    keptLength = MAX_LEN - 8;</span>
<a href="#l34.417"></a><span id="l34.417">     // To avoid keeping only the high surrogate of a surrogate pair</span>
<a href="#l34.418"></a><span id="l34.418" class="difflineminus">-    if (NS_IS_HIGH_SURROGATE(name.CharAt(keptLength-1)))</span>
<a href="#l34.419"></a><span id="l34.419" class="difflineminus">-        --keptLength;</span>
<a href="#l34.420"></a><span id="l34.420" class="difflineplus">+    if (NS_IS_HIGH_SURROGATE(name.CharAt(keptLength - 1))) --keptLength;</span>
<a href="#l34.421"></a><span id="l34.421">   }</span>
<a href="#l34.422"></a><span id="l34.422"> </span>
<a href="#l34.423"></a><span id="l34.423">   if (keptLength &gt;= 0) {</span>
<a href="#l34.424"></a><span id="l34.424" class="difflineminus">-    PR_snprintf(hashedname, 9, &quot;%08lx&quot;, (unsigned long) StringHash(name));</span>
<a href="#l34.425"></a><span id="l34.425" class="difflineplus">+    PR_snprintf(hashedname, 9, &quot;%08lx&quot;, (unsigned long)StringHash(name));</span>
<a href="#l34.426"></a><span id="l34.426">     name.SetLength(keptLength);</span>
<a href="#l34.427"></a><span id="l34.427">     name.Append(NS_ConvertASCIItoUTF16(hashedname));</span>
<a href="#l34.428"></a><span id="l34.428">   }</span>
<a href="#l34.429"></a><span id="l34.429"> </span>
<a href="#l34.430"></a><span id="l34.430">   return NS_OK;</span>
<a href="#l34.431"></a><span id="l34.431"> }</span>
<a href="#l34.432"></a><span id="l34.432"> </span>
<a href="#l34.433"></a><span id="l34.433" class="difflineminus">-nsresult FormatFileSize(int64_t size, bool useKB, nsAString &amp;formattedSize)</span>
<a href="#l34.434"></a><span id="l34.434" class="difflineminus">-{</span>
<a href="#l34.435"></a><span id="l34.435" class="difflineplus">+nsresult FormatFileSize(int64_t size, bool useKB, nsAString &amp;formattedSize) {</span>
<a href="#l34.436"></a><span id="l34.436">   const char *sizeAbbrNames[] = {</span>
<a href="#l34.437"></a><span id="l34.437" class="difflineminus">-    &quot;byteAbbreviation2&quot;,</span>
<a href="#l34.438"></a><span id="l34.438" class="difflineminus">-    &quot;kiloByteAbbreviation2&quot;,</span>
<a href="#l34.439"></a><span id="l34.439" class="difflineminus">-    &quot;megaByteAbbreviation2&quot;,</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineminus">-    &quot;gigaByteAbbreviation2&quot;,</span>
<a href="#l34.441"></a><span id="l34.441" class="difflineplus">+      &quot;byteAbbreviation2&quot;,</span>
<a href="#l34.442"></a><span id="l34.442" class="difflineplus">+      &quot;kiloByteAbbreviation2&quot;,</span>
<a href="#l34.443"></a><span id="l34.443" class="difflineplus">+      &quot;megaByteAbbreviation2&quot;,</span>
<a href="#l34.444"></a><span id="l34.444" class="difflineplus">+      &quot;gigaByteAbbreviation2&quot;,</span>
<a href="#l34.445"></a><span id="l34.445">   };</span>
<a href="#l34.446"></a><span id="l34.446"> </span>
<a href="#l34.447"></a><span id="l34.447">   nsresult rv;</span>
<a href="#l34.448"></a><span id="l34.448"> </span>
<a href="#l34.449"></a><span id="l34.449">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleSvc =</span>
<a href="#l34.450"></a><span id="l34.450" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l34.451"></a><span id="l34.451" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l34.452"></a><span id="l34.452">   NS_ENSURE_TRUE(bundleSvc, NS_ERROR_UNEXPECTED);</span>
<a href="#l34.453"></a><span id="l34.453"> </span>
<a href="#l34.454"></a><span id="l34.454">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l34.455"></a><span id="l34.455">   rv = bundleSvc-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l34.456"></a><span id="l34.456">                                getter_AddRefs(bundle));</span>
<a href="#l34.457"></a><span id="l34.457">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.458"></a><span id="l34.458"> </span>
<a href="#l34.459"></a><span id="l34.459">   double unitSize = size &lt; 0 ? 0.0 : size;</span>
<a href="#l34.460"></a><span id="l34.460">   uint32_t unitIndex = 0;</span>
<a href="#l34.461"></a><span id="l34.461"> </span>
<a href="#l34.462"></a><span id="l34.462">   if (useKB) {</span>
<a href="#l34.463"></a><span id="l34.463">     // Start by formatting in kilobytes</span>
<a href="#l34.464"></a><span id="l34.464">     unitSize /= 1024;</span>
<a href="#l34.465"></a><span id="l34.465" class="difflineminus">-    if (unitSize &lt; 0.1 &amp;&amp; unitSize != 0)</span>
<a href="#l34.466"></a><span id="l34.466" class="difflineminus">-      unitSize = 0.1;</span>
<a href="#l34.467"></a><span id="l34.467" class="difflineplus">+    if (unitSize &lt; 0.1 &amp;&amp; unitSize != 0) unitSize = 0.1;</span>
<a href="#l34.468"></a><span id="l34.468">     unitIndex++;</span>
<a href="#l34.469"></a><span id="l34.469">   }</span>
<a href="#l34.470"></a><span id="l34.470"> </span>
<a href="#l34.471"></a><span id="l34.471">   // Convert to next unit if it needs 4 digits (after rounding), but only if</span>
<a href="#l34.472"></a><span id="l34.472">   // we know the name of the next unit</span>
<a href="#l34.473"></a><span id="l34.473" class="difflineminus">-  while ((unitSize &gt;= 999.5) &amp;&amp; (unitIndex &lt; ArrayLength(sizeAbbrNames) - 1))</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineminus">-  {</span>
<a href="#l34.475"></a><span id="l34.475" class="difflineminus">-      unitSize /= 1024;</span>
<a href="#l34.476"></a><span id="l34.476" class="difflineminus">-      unitIndex++;</span>
<a href="#l34.477"></a><span id="l34.477" class="difflineplus">+  while ((unitSize &gt;= 999.5) &amp;&amp; (unitIndex &lt; ArrayLength(sizeAbbrNames) - 1)) {</span>
<a href="#l34.478"></a><span id="l34.478" class="difflineplus">+    unitSize /= 1024;</span>
<a href="#l34.479"></a><span id="l34.479" class="difflineplus">+    unitIndex++;</span>
<a href="#l34.480"></a><span id="l34.480">   }</span>
<a href="#l34.481"></a><span id="l34.481"> </span>
<a href="#l34.482"></a><span id="l34.482">   // Grab the string for the appropriate unit</span>
<a href="#l34.483"></a><span id="l34.483">   nsString sizeAbbr;</span>
<a href="#l34.484"></a><span id="l34.484">   rv = bundle-&gt;GetStringFromName(sizeAbbrNames[unitIndex], sizeAbbr);</span>
<a href="#l34.485"></a><span id="l34.485">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.486"></a><span id="l34.486"> </span>
<a href="#l34.487"></a><span id="l34.487">   // Get rid of insignificant bits by truncating to 1 or 0 decimal points</span>
<a href="#l34.488"></a><span id="l34.488">   // 0.1 -&gt; 0.1; 1.2 -&gt; 1.2; 12.3 -&gt; 12.3; 123.4 -&gt; 123; 234.5 -&gt; 235</span>
<a href="#l34.489"></a><span id="l34.489">   nsTextFormatter::ssprintf(</span>
<a href="#l34.490"></a><span id="l34.490" class="difflineminus">-    formattedSize, sizeAbbr.get(),</span>
<a href="#l34.491"></a><span id="l34.491" class="difflineminus">-    (unitIndex != 0) &amp;&amp; (unitSize &lt; 99.95 &amp;&amp; unitSize != 0) ? 1 : 0, unitSize);</span>
<a href="#l34.492"></a><span id="l34.492" class="difflineplus">+      formattedSize, sizeAbbr.get(),</span>
<a href="#l34.493"></a><span id="l34.493" class="difflineplus">+      (unitIndex != 0) &amp;&amp; (unitSize &lt; 99.95 &amp;&amp; unitSize != 0) ? 1 : 0,</span>
<a href="#l34.494"></a><span id="l34.494" class="difflineplus">+      unitSize);</span>
<a href="#l34.495"></a><span id="l34.495"> </span>
<a href="#l34.496"></a><span id="l34.496">   int32_t separatorPos = formattedSize.FindChar('.');</span>
<a href="#l34.497"></a><span id="l34.497">   if (separatorPos != kNotFound) {</span>
<a href="#l34.498"></a><span id="l34.498">     // The ssprintf returned a decimal number using a dot (.) as the decimal</span>
<a href="#l34.499"></a><span id="l34.499">     // separator. Now we try to localize the separator.</span>
<a href="#l34.500"></a><span id="l34.500">     // Try to get the decimal separator from the system's locale.</span>
<a href="#l34.501"></a><span id="l34.501">     char *decimalPoint;</span>
<a href="#l34.502"></a><span id="l34.502"> #ifdef HAVE_LOCALECONV</span>
<a href="#l34.503"></a><span id="l34.503">     struct lconv *locale = localeconv();</span>
<a href="#l34.504"></a><span id="l34.504">     decimalPoint = locale-&gt;decimal_point;</span>
<a href="#l34.505"></a><span id="l34.505"> #else</span>
<a href="#l34.506"></a><span id="l34.506">     decimalPoint = getenv(&quot;LOCALE_DECIMAL_POINT&quot;);</span>
<a href="#l34.507"></a><span id="l34.507"> #endif</span>
<a href="#l34.508"></a><span id="l34.508">     NS_ConvertUTF8toUTF16 decimalSeparator(decimalPoint);</span>
<a href="#l34.509"></a><span id="l34.509" class="difflineminus">-    if (decimalSeparator.IsEmpty())</span>
<a href="#l34.510"></a><span id="l34.510" class="difflineminus">-      decimalSeparator.Assign('.');</span>
<a href="#l34.511"></a><span id="l34.511" class="difflineplus">+    if (decimalSeparator.IsEmpty()) decimalSeparator.Assign('.');</span>
<a href="#l34.512"></a><span id="l34.512"> </span>
<a href="#l34.513"></a><span id="l34.513">     formattedSize.Replace(separatorPos, 1, decimalSeparator);</span>
<a href="#l34.514"></a><span id="l34.514">   }</span>
<a href="#l34.515"></a><span id="l34.515"> </span>
<a href="#l34.516"></a><span id="l34.516">   return NS_OK;</span>
<a href="#l34.517"></a><span id="l34.517"> }</span>
<a href="#l34.518"></a><span id="l34.518"> </span>
<a href="#l34.519"></a><span id="l34.519"> nsresult NS_MsgCreatePathStringFromFolderURI(const char *aFolderURI,</span>
<a href="#l34.520"></a><span id="l34.520" class="difflineminus">-                                             nsCString&amp; aPathCString,</span>
<a href="#l34.521"></a><span id="l34.521" class="difflineplus">+                                             nsCString &amp;aPathCString,</span>
<a href="#l34.522"></a><span id="l34.522">                                              const nsCString &amp;aScheme,</span>
<a href="#l34.523"></a><span id="l34.523" class="difflineminus">-                                             bool aIsNewsFolder)</span>
<a href="#l34.524"></a><span id="l34.524" class="difflineminus">-{</span>
<a href="#l34.525"></a><span id="l34.525" class="difflineplus">+                                             bool aIsNewsFolder) {</span>
<a href="#l34.526"></a><span id="l34.526">   // A file name has to be in native charset. Here we convert</span>
<a href="#l34.527"></a><span id="l34.527">   // to UTF-16 and check for 'unsafe' characters before converting</span>
<a href="#l34.528"></a><span id="l34.528">   // to native charset.</span>
<a href="#l34.529"></a><span id="l34.529" class="difflineminus">-  NS_ENSURE_TRUE(MsgIsUTF8(nsDependentCString(aFolderURI)), NS_ERROR_UNEXPECTED);</span>
<a href="#l34.530"></a><span id="l34.530" class="difflineplus">+  NS_ENSURE_TRUE(MsgIsUTF8(nsDependentCString(aFolderURI)),</span>
<a href="#l34.531"></a><span id="l34.531" class="difflineplus">+                 NS_ERROR_UNEXPECTED);</span>
<a href="#l34.532"></a><span id="l34.532">   NS_ConvertUTF8toUTF16 oldPath(aFolderURI);</span>
<a href="#l34.533"></a><span id="l34.533"> </span>
<a href="#l34.534"></a><span id="l34.534">   nsAutoString pathPiece, path;</span>
<a href="#l34.535"></a><span id="l34.535"> </span>
<a href="#l34.536"></a><span id="l34.536">   int32_t startSlashPos = oldPath.FindChar('/');</span>
<a href="#l34.537"></a><span id="l34.537">   int32_t endSlashPos = (startSlashPos &gt;= 0)</span>
<a href="#l34.538"></a><span id="l34.538" class="difflineminus">-    ? oldPath.FindChar('/', startSlashPos + 1) - 1 : oldPath.Length() - 1;</span>
<a href="#l34.539"></a><span id="l34.539" class="difflineminus">-  if (endSlashPos &lt; 0)</span>
<a href="#l34.540"></a><span id="l34.540" class="difflineminus">-    endSlashPos = oldPath.Length();</span>
<a href="#l34.541"></a><span id="l34.541" class="difflineplus">+                            ? oldPath.FindChar('/', startSlashPos + 1) - 1</span>
<a href="#l34.542"></a><span id="l34.542" class="difflineplus">+                            : oldPath.Length() - 1;</span>
<a href="#l34.543"></a><span id="l34.543" class="difflineplus">+  if (endSlashPos &lt; 0) endSlashPos = oldPath.Length();</span>
<a href="#l34.544"></a><span id="l34.544"> #if defined(XP_UNIX) || defined(XP_MACOSX)</span>
<a href="#l34.545"></a><span id="l34.545">   bool isLocalUri = aScheme.EqualsLiteral(&quot;none&quot;) ||</span>
<a href="#l34.546"></a><span id="l34.546">                     aScheme.EqualsLiteral(&quot;pop3&quot;) ||</span>
<a href="#l34.547"></a><span id="l34.547">                     aScheme.EqualsLiteral(&quot;rss&quot;);</span>
<a href="#l34.548"></a><span id="l34.548"> #endif</span>
<a href="#l34.549"></a><span id="l34.549">   // trick to make sure we only add the path to the first n-1 folders</span>
<a href="#l34.550"></a><span id="l34.550" class="difflineminus">-  bool haveFirst=false;</span>
<a href="#l34.551"></a><span id="l34.551" class="difflineplus">+  bool haveFirst = false;</span>
<a href="#l34.552"></a><span id="l34.552">   while (startSlashPos != -1) {</span>
<a href="#l34.553"></a><span id="l34.553" class="difflineminus">-    pathPiece.Assign(Substring(oldPath, startSlashPos + 1, endSlashPos - startSlashPos));</span>
<a href="#l34.554"></a><span id="l34.554" class="difflineplus">+    pathPiece.Assign(</span>
<a href="#l34.555"></a><span id="l34.555" class="difflineplus">+        Substring(oldPath, startSlashPos + 1, endSlashPos - startSlashPos));</span>
<a href="#l34.556"></a><span id="l34.556">     // skip leading '/' (and other // style things)</span>
<a href="#l34.557"></a><span id="l34.557" class="difflineminus">-    if (!pathPiece.IsEmpty())</span>
<a href="#l34.558"></a><span id="l34.558" class="difflineminus">-    {</span>
<a href="#l34.559"></a><span id="l34.559" class="difflineminus">-</span>
<a href="#l34.560"></a><span id="l34.560" class="difflineplus">+    if (!pathPiece.IsEmpty()) {</span>
<a href="#l34.561"></a><span id="l34.561">       // add .sbd onto the previous path</span>
<a href="#l34.562"></a><span id="l34.562" class="difflineminus">-      if (haveFirst)</span>
<a href="#l34.563"></a><span id="l34.563" class="difflineminus">-      {</span>
<a href="#l34.564"></a><span id="l34.564" class="difflineplus">+      if (haveFirst) {</span>
<a href="#l34.565"></a><span id="l34.565">         path.AppendLiteral(FOLDER_SUFFIX &quot;/&quot;);</span>
<a href="#l34.566"></a><span id="l34.566">       }</span>
<a href="#l34.567"></a><span id="l34.567"> </span>
<a href="#l34.568"></a><span id="l34.568" class="difflineminus">-      if (aIsNewsFolder)</span>
<a href="#l34.569"></a><span id="l34.569" class="difflineminus">-      {</span>
<a href="#l34.570"></a><span id="l34.570" class="difflineminus">-          nsAutoCString tmp;</span>
<a href="#l34.571"></a><span id="l34.571" class="difflineminus">-          CopyUTF16toMUTF7(pathPiece, tmp);</span>
<a href="#l34.572"></a><span id="l34.572" class="difflineminus">-          CopyASCIItoUTF16(tmp, pathPiece);</span>
<a href="#l34.573"></a><span id="l34.573" class="difflineplus">+      if (aIsNewsFolder) {</span>
<a href="#l34.574"></a><span id="l34.574" class="difflineplus">+        nsAutoCString tmp;</span>
<a href="#l34.575"></a><span id="l34.575" class="difflineplus">+        CopyUTF16toMUTF7(pathPiece, tmp);</span>
<a href="#l34.576"></a><span id="l34.576" class="difflineplus">+        CopyASCIItoUTF16(tmp, pathPiece);</span>
<a href="#l34.577"></a><span id="l34.577">       }</span>
<a href="#l34.578"></a><span id="l34.578"> #if defined(XP_UNIX) || defined(XP_MACOSX)</span>
<a href="#l34.579"></a><span id="l34.579">       // Don't hash path pieces because local mail folder uri's have already</span>
<a href="#l34.580"></a><span id="l34.580">       // been hashed. We're only doing this on the mac to limit potential</span>
<a href="#l34.581"></a><span id="l34.581">       // regressions.</span>
<a href="#l34.582"></a><span id="l34.582">       if (!isLocalUri)</span>
<a href="#l34.583"></a><span id="l34.583"> #endif</span>
<a href="#l34.584"></a><span id="l34.584" class="difflineminus">-      NS_MsgHashIfNecessary(pathPiece);</span>
<a href="#l34.585"></a><span id="l34.585" class="difflineplus">+        NS_MsgHashIfNecessary(pathPiece);</span>
<a href="#l34.586"></a><span id="l34.586">       path += pathPiece;</span>
<a href="#l34.587"></a><span id="l34.587" class="difflineminus">-      haveFirst=true;</span>
<a href="#l34.588"></a><span id="l34.588" class="difflineplus">+      haveFirst = true;</span>
<a href="#l34.589"></a><span id="l34.589">     }</span>
<a href="#l34.590"></a><span id="l34.590">     // look for the next slash</span>
<a href="#l34.591"></a><span id="l34.591">     startSlashPos = endSlashPos + 1;</span>
<a href="#l34.592"></a><span id="l34.592"> </span>
<a href="#l34.593"></a><span id="l34.593">     endSlashPos = (startSlashPos &gt;= 0)</span>
<a href="#l34.594"></a><span id="l34.594" class="difflineminus">-      ? oldPath.FindChar('/', startSlashPos + 1)  - 1: oldPath.Length() - 1;</span>
<a href="#l34.595"></a><span id="l34.595" class="difflineminus">-    if (endSlashPos &lt; 0)</span>
<a href="#l34.596"></a><span id="l34.596" class="difflineminus">-      endSlashPos = oldPath.Length();</span>
<a href="#l34.597"></a><span id="l34.597" class="difflineplus">+                      ? oldPath.FindChar('/', startSlashPos + 1) - 1</span>
<a href="#l34.598"></a><span id="l34.598" class="difflineplus">+                      : oldPath.Length() - 1;</span>
<a href="#l34.599"></a><span id="l34.599" class="difflineplus">+    if (endSlashPos &lt; 0) endSlashPos = oldPath.Length();</span>
<a href="#l34.600"></a><span id="l34.600"> </span>
<a href="#l34.601"></a><span id="l34.601" class="difflineminus">-    if (startSlashPos &gt;= endSlashPos)</span>
<a href="#l34.602"></a><span id="l34.602" class="difflineminus">-      break;</span>
<a href="#l34.603"></a><span id="l34.603" class="difflineplus">+    if (startSlashPos &gt;= endSlashPos) break;</span>
<a href="#l34.604"></a><span id="l34.604">   }</span>
<a href="#l34.605"></a><span id="l34.605">   return NS_CopyUnicodeToNative(path, aPathCString);</span>
<a href="#l34.606"></a><span id="l34.606"> }</span>
<a href="#l34.607"></a><span id="l34.607"> </span>
<a href="#l34.608"></a><span id="l34.608" class="difflineminus">-bool NS_MsgStripRE(const nsCString&amp; subject, nsCString&amp; modifiedSubject)</span>
<a href="#l34.609"></a><span id="l34.609" class="difflineminus">-{</span>
<a href="#l34.610"></a><span id="l34.610" class="difflineplus">+bool NS_MsgStripRE(const nsCString &amp;subject, nsCString &amp;modifiedSubject) {</span>
<a href="#l34.611"></a><span id="l34.611">   bool result = false;</span>
<a href="#l34.612"></a><span id="l34.612"> </span>
<a href="#l34.613"></a><span id="l34.613">   // Get localizedRe pref.</span>
<a href="#l34.614"></a><span id="l34.614">   nsresult rv;</span>
<a href="#l34.615"></a><span id="l34.615">   nsString utf16LocalizedRe;</span>
<a href="#l34.616"></a><span id="l34.616" class="difflineminus">-  NS_GetLocalizedUnicharPreferenceWithDefault(nullptr,</span>
<a href="#l34.617"></a><span id="l34.617" class="difflineminus">-                                              &quot;mailnews.localizedRe&quot;,</span>
<a href="#l34.618"></a><span id="l34.618" class="difflineminus">-                                              EmptyString(),</span>
<a href="#l34.619"></a><span id="l34.619" class="difflineminus">-                                              utf16LocalizedRe);</span>
<a href="#l34.620"></a><span id="l34.620" class="difflineplus">+  NS_GetLocalizedUnicharPreferenceWithDefault(nullptr, &quot;mailnews.localizedRe&quot;,</span>
<a href="#l34.621"></a><span id="l34.621" class="difflineplus">+                                              EmptyString(), utf16LocalizedRe);</span>
<a href="#l34.622"></a><span id="l34.622">   NS_ConvertUTF16toUTF8 localizedRe(utf16LocalizedRe);</span>
<a href="#l34.623"></a><span id="l34.623"> </span>
<a href="#l34.624"></a><span id="l34.624">   // Hardcoded &quot;Re&quot; so that no one can configure Mozilla standards incompatible.</span>
<a href="#l34.625"></a><span id="l34.625">   nsAutoCString checkString(&quot;Re,RE,re,rE&quot;);</span>
<a href="#l34.626"></a><span id="l34.626">   if (!localizedRe.IsEmpty()) {</span>
<a href="#l34.627"></a><span id="l34.627">     checkString.Append(',');</span>
<a href="#l34.628"></a><span id="l34.628">     checkString.Append(localizedRe);</span>
<a href="#l34.629"></a><span id="l34.629">   }</span>
<a href="#l34.630"></a><span id="l34.630"> </span>
<a href="#l34.631"></a><span id="l34.631">   // Decode the string.</span>
<a href="#l34.632"></a><span id="l34.632">   nsCString decodedString;</span>
<a href="#l34.633"></a><span id="l34.633">   nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter;</span>
<a href="#l34.634"></a><span id="l34.634" class="difflineminus">-  // We cannot strip &quot;Re:&quot; for RFC2047-encoded subject without modifying the original.</span>
<a href="#l34.635"></a><span id="l34.635" class="difflineminus">-  if (subject.Find(&quot;=?&quot;) != kNotFound)</span>
<a href="#l34.636"></a><span id="l34.636" class="difflineminus">-  {</span>
<a href="#l34.637"></a><span id="l34.637" class="difflineplus">+  // We cannot strip &quot;Re:&quot; for RFC2047-encoded subject without modifying the</span>
<a href="#l34.638"></a><span id="l34.638" class="difflineplus">+  // original.</span>
<a href="#l34.639"></a><span id="l34.639" class="difflineplus">+  if (subject.Find(&quot;=?&quot;) != kNotFound) {</span>
<a href="#l34.640"></a><span id="l34.640">     mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l34.641"></a><span id="l34.641">     if (NS_SUCCEEDED(rv))</span>
<a href="#l34.642"></a><span id="l34.642" class="difflineminus">-      rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(subject,</span>
<a href="#l34.643"></a><span id="l34.643" class="difflineminus">-        nullptr, false, true, decodedString);</span>
<a href="#l34.644"></a><span id="l34.644" class="difflineplus">+      rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(subject, nullptr, false, true,</span>
<a href="#l34.645"></a><span id="l34.645" class="difflineplus">+                                                 decodedString);</span>
<a href="#l34.646"></a><span id="l34.646">   }</span>
<a href="#l34.647"></a><span id="l34.647"> </span>
<a href="#l34.648"></a><span id="l34.648">   const char *s, *s_end;</span>
<a href="#l34.649"></a><span id="l34.649">   if (decodedString.IsEmpty()) {</span>
<a href="#l34.650"></a><span id="l34.650">     s = subject.BeginReading();</span>
<a href="#l34.651"></a><span id="l34.651">     s_end = s + subject.Length();</span>
<a href="#l34.652"></a><span id="l34.652">   } else {</span>
<a href="#l34.653"></a><span id="l34.653">     s = decodedString.BeginReading();</span>
<a href="#l34.654"></a><span id="l34.654">     s_end = s + decodedString.Length();</span>
<a href="#l34.655"></a><span id="l34.655">   }</span>
<a href="#l34.656"></a><span id="l34.656"> </span>
<a href="#l34.657"></a><span id="l34.657"> AGAIN:</span>
<a href="#l34.658"></a><span id="l34.658" class="difflineminus">-  while (s &lt; s_end &amp;&amp; IS_SPACE(*s))</span>
<a href="#l34.659"></a><span id="l34.659" class="difflineminus">-    s++;</span>
<a href="#l34.660"></a><span id="l34.660" class="difflineplus">+  while (s &lt; s_end &amp;&amp; IS_SPACE(*s)) s++;</span>
<a href="#l34.661"></a><span id="l34.661"> </span>
<a href="#l34.662"></a><span id="l34.662">   const char *tokPtr = checkString.get();</span>
<a href="#l34.663"></a><span id="l34.663" class="difflineminus">-  while (*tokPtr)</span>
<a href="#l34.664"></a><span id="l34.664" class="difflineminus">-  {</span>
<a href="#l34.665"></a><span id="l34.665" class="difflineplus">+  while (*tokPtr) {</span>
<a href="#l34.666"></a><span id="l34.666">     // Tokenize the comma separated list.</span>
<a href="#l34.667"></a><span id="l34.667">     size_t tokenLength = 0;</span>
<a href="#l34.668"></a><span id="l34.668">     while (*tokPtr &amp;&amp; *tokPtr != ',') {</span>
<a href="#l34.669"></a><span id="l34.669">       tokenLength++;</span>
<a href="#l34.670"></a><span id="l34.670">       tokPtr++;</span>
<a href="#l34.671"></a><span id="l34.671">     }</span>
<a href="#l34.672"></a><span id="l34.672">     // Check if the beginning of s is the actual token.</span>
<a href="#l34.673"></a><span id="l34.673" class="difflineminus">-    if (tokenLength &amp;&amp; !strncmp(s, tokPtr - tokenLength, tokenLength))</span>
<a href="#l34.674"></a><span id="l34.674" class="difflineminus">-    {</span>
<a href="#l34.675"></a><span id="l34.675" class="difflineminus">-      if (s[tokenLength] == ':')</span>
<a href="#l34.676"></a><span id="l34.676" class="difflineminus">-      {</span>
<a href="#l34.677"></a><span id="l34.677" class="difflineplus">+    if (tokenLength &amp;&amp; !strncmp(s, tokPtr - tokenLength, tokenLength)) {</span>
<a href="#l34.678"></a><span id="l34.678" class="difflineplus">+      if (s[tokenLength] == ':') {</span>
<a href="#l34.679"></a><span id="l34.679">         s = s + tokenLength + 1; /* Skip over &quot;Re:&quot; */</span>
<a href="#l34.680"></a><span id="l34.680">         result = true;           /* Yes, we stripped it. */</span>
<a href="#l34.681"></a><span id="l34.681">         goto AGAIN;              /* Skip whitespace and try again. */</span>
<a href="#l34.682"></a><span id="l34.682" class="difflineminus">-      }</span>
<a href="#l34.683"></a><span id="l34.683" class="difflineminus">-      else if (s[tokenLength] == '[' || s[tokenLength] == '(')</span>
<a href="#l34.684"></a><span id="l34.684" class="difflineminus">-      {</span>
<a href="#l34.685"></a><span id="l34.685" class="difflineplus">+      } else if (s[tokenLength] == '[' || s[tokenLength] == '(') {</span>
<a href="#l34.686"></a><span id="l34.686">         const char *s2 = s + tokenLength + 1; /* Skip over &quot;Re[&quot; */</span>
<a href="#l34.687"></a><span id="l34.687"> </span>
<a href="#l34.688"></a><span id="l34.688">         // Skip forward over digits after the &quot;[&quot;.</span>
<a href="#l34.689"></a><span id="l34.689" class="difflineminus">-        while (s2 &lt; (s_end - 2) &amp;&amp; isdigit((unsigned char)*s2))</span>
<a href="#l34.690"></a><span id="l34.690" class="difflineminus">-          s2++;</span>
<a href="#l34.691"></a><span id="l34.691" class="difflineplus">+        while (s2 &lt; (s_end - 2) &amp;&amp; isdigit((unsigned char)*s2)) s2++;</span>
<a href="#l34.692"></a><span id="l34.692"> </span>
<a href="#l34.693"></a><span id="l34.693">         // Now ensure that the following thing is &quot;]:&quot;.</span>
<a href="#l34.694"></a><span id="l34.694">         // Only if it is do we alter `s`.</span>
<a href="#l34.695"></a><span id="l34.695" class="difflineminus">-        if ((s2[0] == ']' || s2[0] == ')') &amp;&amp; s2[1] == ':')</span>
<a href="#l34.696"></a><span id="l34.696" class="difflineminus">-        {</span>
<a href="#l34.697"></a><span id="l34.697" class="difflineminus">-          s = s2 + 2;       /* Skip over &quot;]:&quot; */</span>
<a href="#l34.698"></a><span id="l34.698" class="difflineminus">-          result = true;    /* Yes, we stripped it. */</span>
<a href="#l34.699"></a><span id="l34.699" class="difflineminus">-          goto AGAIN;       /* Skip whitespace and try again. */</span>
<a href="#l34.700"></a><span id="l34.700" class="difflineplus">+        if ((s2[0] == ']' || s2[0] == ')') &amp;&amp; s2[1] == ':') {</span>
<a href="#l34.701"></a><span id="l34.701" class="difflineplus">+          s = s2 + 2;    /* Skip over &quot;]:&quot; */</span>
<a href="#l34.702"></a><span id="l34.702" class="difflineplus">+          result = true; /* Yes, we stripped it. */</span>
<a href="#l34.703"></a><span id="l34.703" class="difflineplus">+          goto AGAIN;    /* Skip whitespace and try again. */</span>
<a href="#l34.704"></a><span id="l34.704">         }</span>
<a href="#l34.705"></a><span id="l34.705">       }</span>
<a href="#l34.706"></a><span id="l34.706">     }</span>
<a href="#l34.707"></a><span id="l34.707" class="difflineminus">-    if (*tokPtr)</span>
<a href="#l34.708"></a><span id="l34.708" class="difflineminus">-      tokPtr++;</span>
<a href="#l34.709"></a><span id="l34.709" class="difflineplus">+    if (*tokPtr) tokPtr++;</span>
<a href="#l34.710"></a><span id="l34.710">   }</span>
<a href="#l34.711"></a><span id="l34.711"> </span>
<a href="#l34.712"></a><span id="l34.712">   // If we didn't strip anything, we can return here.</span>
<a href="#l34.713"></a><span id="l34.713" class="difflineminus">-  if (!result)</span>
<a href="#l34.714"></a><span id="l34.714" class="difflineminus">-    return false;</span>
<a href="#l34.715"></a><span id="l34.715" class="difflineplus">+  if (!result) return false;</span>
<a href="#l34.716"></a><span id="l34.716"> </span>
<a href="#l34.717"></a><span id="l34.717">   if (decodedString.IsEmpty()) {</span>
<a href="#l34.718"></a><span id="l34.718">     // We didn't decode anything, so just return a new string.</span>
<a href="#l34.719"></a><span id="l34.719">     modifiedSubject.Assign(s);</span>
<a href="#l34.720"></a><span id="l34.720">     return true;</span>
<a href="#l34.721"></a><span id="l34.721">   }</span>
<a href="#l34.722"></a><span id="l34.722"> </span>
<a href="#l34.723"></a><span id="l34.723" class="difflineminus">-  // We decoded the string, so we need to encode it again. We always encode in UTF-8.</span>
<a href="#l34.724"></a><span id="l34.724" class="difflineminus">-  mimeConverter-&gt;EncodeMimePartIIStr_UTF8(nsDependentCString(s),</span>
<a href="#l34.725"></a><span id="l34.725" class="difflineminus">-    false, sizeof(&quot;Subject:&quot;),</span>
<a href="#l34.726"></a><span id="l34.726" class="difflineminus">-    nsIMimeConverter::MIME_ENCODED_WORD_SIZE, modifiedSubject);</span>
<a href="#l34.727"></a><span id="l34.727" class="difflineplus">+  // We decoded the string, so we need to encode it again. We always encode in</span>
<a href="#l34.728"></a><span id="l34.728" class="difflineplus">+  // UTF-8.</span>
<a href="#l34.729"></a><span id="l34.729" class="difflineplus">+  mimeConverter-&gt;EncodeMimePartIIStr_UTF8(</span>
<a href="#l34.730"></a><span id="l34.730" class="difflineplus">+      nsDependentCString(s), false, sizeof(&quot;Subject:&quot;),</span>
<a href="#l34.731"></a><span id="l34.731" class="difflineplus">+      nsIMimeConverter::MIME_ENCODED_WORD_SIZE, modifiedSubject);</span>
<a href="#l34.732"></a><span id="l34.732">   return true;</span>
<a href="#l34.733"></a><span id="l34.733"> }</span>
<a href="#l34.734"></a><span id="l34.734"> </span>
<a href="#l34.735"></a><span id="l34.735"> /*  Very similar to strdup except it free's too</span>
<a href="#l34.736"></a><span id="l34.736">  */</span>
<a href="#l34.737"></a><span id="l34.737" class="difflineminus">-char * NS_MsgSACopy (char **destination, const char *source)</span>
<a href="#l34.738"></a><span id="l34.738" class="difflineminus">-{</span>
<a href="#l34.739"></a><span id="l34.739" class="difflineminus">-  if(*destination)</span>
<a href="#l34.740"></a><span id="l34.740" class="difflineminus">-  {</span>
<a href="#l34.741"></a><span id="l34.741" class="difflineplus">+char *NS_MsgSACopy(char **destination, const char *source) {</span>
<a href="#l34.742"></a><span id="l34.742" class="difflineplus">+  if (*destination) {</span>
<a href="#l34.743"></a><span id="l34.743">     PR_Free(*destination);</span>
<a href="#l34.744"></a><span id="l34.744">     *destination = 0;</span>
<a href="#l34.745"></a><span id="l34.745">   }</span>
<a href="#l34.746"></a><span id="l34.746" class="difflineminus">-  if (! source)</span>
<a href="#l34.747"></a><span id="l34.747" class="difflineplus">+  if (!source)</span>
<a href="#l34.748"></a><span id="l34.748">     *destination = nullptr;</span>
<a href="#l34.749"></a><span id="l34.749" class="difflineminus">-  else</span>
<a href="#l34.750"></a><span id="l34.750" class="difflineminus">-  {</span>
<a href="#l34.751"></a><span id="l34.751" class="difflineminus">-    *destination = (char *) PR_Malloc (PL_strlen(source) + 1);</span>
<a href="#l34.752"></a><span id="l34.752" class="difflineminus">-    if (*destination == nullptr)</span>
<a href="#l34.753"></a><span id="l34.753" class="difflineminus">-      return(nullptr);</span>
<a href="#l34.754"></a><span id="l34.754" class="difflineplus">+  else {</span>
<a href="#l34.755"></a><span id="l34.755" class="difflineplus">+    *destination = (char *)PR_Malloc(PL_strlen(source) + 1);</span>
<a href="#l34.756"></a><span id="l34.756" class="difflineplus">+    if (*destination == nullptr) return (nullptr);</span>
<a href="#l34.757"></a><span id="l34.757"> </span>
<a href="#l34.758"></a><span id="l34.758" class="difflineminus">-    PL_strcpy (*destination, source);</span>
<a href="#l34.759"></a><span id="l34.759" class="difflineplus">+    PL_strcpy(*destination, source);</span>
<a href="#l34.760"></a><span id="l34.760">   }</span>
<a href="#l34.761"></a><span id="l34.761">   return *destination;</span>
<a href="#l34.762"></a><span id="l34.762"> }</span>
<a href="#l34.763"></a><span id="l34.763"> </span>
<a href="#l34.764"></a><span id="l34.764"> /*  Again like strdup but it concatenates and free's and uses Realloc.</span>
<a href="#l34.765"></a><span id="l34.765" class="difflineminus">-*/</span>
<a href="#l34.766"></a><span id="l34.766" class="difflineminus">-char * NS_MsgSACat (char **destination, const char *source)</span>
<a href="#l34.767"></a><span id="l34.767" class="difflineminus">-{</span>
<a href="#l34.768"></a><span id="l34.768" class="difflineminus">-  if (source &amp;&amp; *source)</span>
<a href="#l34.769"></a><span id="l34.769" class="difflineminus">-  {</span>
<a href="#l34.770"></a><span id="l34.770" class="difflineplus">+ */</span>
<a href="#l34.771"></a><span id="l34.771" class="difflineplus">+char *NS_MsgSACat(char **destination, const char *source) {</span>
<a href="#l34.772"></a><span id="l34.772" class="difflineplus">+  if (source &amp;&amp; *source) {</span>
<a href="#l34.773"></a><span id="l34.773">     int destLength = *destination ? PL_strlen(*destination) : 0;</span>
<a href="#l34.774"></a><span id="l34.774" class="difflineminus">-    char* newDestination = (char*) PR_Realloc(*destination, destLength + PL_strlen(source) + 1);</span>
<a href="#l34.775"></a><span id="l34.775" class="difflineminus">-    if (newDestination == nullptr)</span>
<a href="#l34.776"></a><span id="l34.776" class="difflineminus">-      return nullptr;</span>
<a href="#l34.777"></a><span id="l34.777" class="difflineplus">+    char *newDestination =</span>
<a href="#l34.778"></a><span id="l34.778" class="difflineplus">+        (char *)PR_Realloc(*destination, destLength + PL_strlen(source) + 1);</span>
<a href="#l34.779"></a><span id="l34.779" class="difflineplus">+    if (newDestination == nullptr) return nullptr;</span>
<a href="#l34.780"></a><span id="l34.780"> </span>
<a href="#l34.781"></a><span id="l34.781">     *destination = newDestination;</span>
<a href="#l34.782"></a><span id="l34.782">     PL_strcpy(*destination + destLength, source);</span>
<a href="#l34.783"></a><span id="l34.783">   }</span>
<a href="#l34.784"></a><span id="l34.784">   return *destination;</span>
<a href="#l34.785"></a><span id="l34.785"> }</span>
<a href="#l34.786"></a><span id="l34.786"> </span>
<a href="#l34.787"></a><span id="l34.787" class="difflineminus">-nsresult NS_MsgEscapeEncodeURLPath(const nsAString&amp; aStr, nsCString&amp; aResult)</span>
<a href="#l34.788"></a><span id="l34.788" class="difflineminus">-{</span>
<a href="#l34.789"></a><span id="l34.789" class="difflineminus">-  return MsgEscapeString(NS_ConvertUTF16toUTF8(aStr), nsINetUtil::ESCAPE_URL_PATH, aResult);</span>
<a href="#l34.790"></a><span id="l34.790" class="difflineplus">+nsresult NS_MsgEscapeEncodeURLPath(const nsAString &amp;aStr, nsCString &amp;aResult) {</span>
<a href="#l34.791"></a><span id="l34.791" class="difflineplus">+  return MsgEscapeString(NS_ConvertUTF16toUTF8(aStr),</span>
<a href="#l34.792"></a><span id="l34.792" class="difflineplus">+                         nsINetUtil::ESCAPE_URL_PATH, aResult);</span>
<a href="#l34.793"></a><span id="l34.793"> }</span>
<a href="#l34.794"></a><span id="l34.794"> </span>
<a href="#l34.795"></a><span id="l34.795" class="difflineminus">-nsresult NS_MsgDecodeUnescapeURLPath(const nsACString&amp; aPath,</span>
<a href="#l34.796"></a><span id="l34.796" class="difflineminus">-                                     nsAString&amp; aResult)</span>
<a href="#l34.797"></a><span id="l34.797" class="difflineminus">-{</span>
<a href="#l34.798"></a><span id="l34.798" class="difflineplus">+nsresult NS_MsgDecodeUnescapeURLPath(const nsACString &amp;aPath,</span>
<a href="#l34.799"></a><span id="l34.799" class="difflineplus">+                                     nsAString &amp;aResult) {</span>
<a href="#l34.800"></a><span id="l34.800">   nsAutoCString unescapedName;</span>
<a href="#l34.801"></a><span id="l34.801" class="difflineminus">-  MsgUnescapeString(aPath, nsINetUtil::ESCAPE_URL_FILE_BASENAME |</span>
<a href="#l34.802"></a><span id="l34.802" class="difflineminus">-                 nsINetUtil::ESCAPE_URL_FORCED, unescapedName);</span>
<a href="#l34.803"></a><span id="l34.803" class="difflineplus">+  MsgUnescapeString(</span>
<a href="#l34.804"></a><span id="l34.804" class="difflineplus">+      aPath,</span>
<a href="#l34.805"></a><span id="l34.805" class="difflineplus">+      nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l34.806"></a><span id="l34.806" class="difflineplus">+      unescapedName);</span>
<a href="#l34.807"></a><span id="l34.807">   CopyUTF8toUTF16(unescapedName, aResult);</span>
<a href="#l34.808"></a><span id="l34.808">   return NS_OK;</span>
<a href="#l34.809"></a><span id="l34.809"> }</span>
<a href="#l34.810"></a><span id="l34.810"> </span>
<a href="#l34.811"></a><span id="l34.811" class="difflineminus">-bool WeAreOffline()</span>
<a href="#l34.812"></a><span id="l34.812" class="difflineminus">-{</span>
<a href="#l34.813"></a><span id="l34.813" class="difflineplus">+bool WeAreOffline() {</span>
<a href="#l34.814"></a><span id="l34.814">   bool offline = false;</span>
<a href="#l34.815"></a><span id="l34.815"> </span>
<a href="#l34.816"></a><span id="l34.816" class="difflineminus">-  nsCOMPtr &lt;nsIIOService&gt; ioService =</span>
<a href="#l34.817"></a><span id="l34.817" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l34.818"></a><span id="l34.818" class="difflineminus">-  if (ioService)</span>
<a href="#l34.819"></a><span id="l34.819" class="difflineminus">-    ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l34.820"></a><span id="l34.820" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l34.821"></a><span id="l34.821" class="difflineplus">+  if (ioService) ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l34.822"></a><span id="l34.822"> </span>
<a href="#l34.823"></a><span id="l34.823">   return offline;</span>
<a href="#l34.824"></a><span id="l34.824"> }</span>
<a href="#l34.825"></a><span id="l34.825"> </span>
<a href="#l34.826"></a><span id="l34.826"> // Find a folder by URL. If it doesn't exist, null will be returned</span>
<a href="#l34.827"></a><span id="l34.827"> // via aFolder.</span>
<a href="#l34.828"></a><span id="l34.828" class="difflineminus">-nsresult FindFolder(const nsACString&amp; aFolderURI, nsIMsgFolder **aFolder)</span>
<a href="#l34.829"></a><span id="l34.829" class="difflineminus">-{</span>
<a href="#l34.830"></a><span id="l34.830" class="difflineplus">+nsresult FindFolder(const nsACString &amp;aFolderURI, nsIMsgFolder **aFolder) {</span>
<a href="#l34.831"></a><span id="l34.831">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l34.832"></a><span id="l34.832"> </span>
<a href="#l34.833"></a><span id="l34.833">   *aFolder = nullptr;</span>
<a href="#l34.834"></a><span id="l34.834"> </span>
<a href="#l34.835"></a><span id="l34.835">   nsresult rv;</span>
<a href="#l34.836"></a><span id="l34.836">   nsCOMPtr&lt;nsIFolderLookupService&gt; fls(do_GetService(NSIFLS_CONTRACTID, &amp;rv));</span>
<a href="#l34.837"></a><span id="l34.837">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.838"></a><span id="l34.838"> </span>
<a href="#l34.839"></a><span id="l34.839" class="difflineat">@@ -766,210 +700,195 @@ nsresult FindFolder(const nsACString&amp; aF</span>
<a href="#l34.840"></a><span id="l34.840"> </span>
<a href="#l34.841"></a><span id="l34.841">   return NS_OK;</span>
<a href="#l34.842"></a><span id="l34.842"> }</span>
<a href="#l34.843"></a><span id="l34.843"> </span>
<a href="#l34.844"></a><span id="l34.844"> // Fetch an existing folder by URL</span>
<a href="#l34.845"></a><span id="l34.845"> // The returned aFolder will be non-null if and only if result is NS_OK.</span>
<a href="#l34.846"></a><span id="l34.846"> // NS_OK - folder was found</span>
<a href="#l34.847"></a><span id="l34.847"> // NS_MSG_FOLDER_MISSING - if aFolderURI not found</span>
<a href="#l34.848"></a><span id="l34.848" class="difflineminus">-nsresult GetExistingFolder(const nsACString&amp; aFolderURI, nsIMsgFolder **aFolder)</span>
<a href="#l34.849"></a><span id="l34.849" class="difflineminus">-{</span>
<a href="#l34.850"></a><span id="l34.850" class="difflineplus">+nsresult GetExistingFolder(const nsACString &amp;aFolderURI,</span>
<a href="#l34.851"></a><span id="l34.851" class="difflineplus">+                           nsIMsgFolder **aFolder) {</span>
<a href="#l34.852"></a><span id="l34.852">   nsresult rv = FindFolder(aFolderURI, aFolder);</span>
<a href="#l34.853"></a><span id="l34.853">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.854"></a><span id="l34.854">   return *aFolder ? NS_OK : NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l34.855"></a><span id="l34.855"> }</span>
<a href="#l34.856"></a><span id="l34.856"> </span>
<a href="#l34.857"></a><span id="l34.857" class="difflineminus">-</span>
<a href="#l34.858"></a><span id="l34.858" class="difflineminus">-nsresult GetOrCreateFolder(const nsACString&amp; aFolderURI, nsIMsgFolder **aFolder)</span>
<a href="#l34.859"></a><span id="l34.859" class="difflineminus">-{</span>
<a href="#l34.860"></a><span id="l34.860" class="difflineplus">+nsresult GetOrCreateFolder(const nsACString &amp;aFolderURI,</span>
<a href="#l34.861"></a><span id="l34.861" class="difflineplus">+                           nsIMsgFolder **aFolder) {</span>
<a href="#l34.862"></a><span id="l34.862">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l34.863"></a><span id="l34.863"> </span>
<a href="#l34.864"></a><span id="l34.864">   *aFolder = nullptr;</span>
<a href="#l34.865"></a><span id="l34.865"> </span>
<a href="#l34.866"></a><span id="l34.866">   nsresult rv;</span>
<a href="#l34.867"></a><span id="l34.867">   nsCOMPtr&lt;nsIFolderLookupService&gt; fls(do_GetService(NSIFLS_CONTRACTID, &amp;rv));</span>
<a href="#l34.868"></a><span id="l34.868">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.869"></a><span id="l34.869"> </span>
<a href="#l34.870"></a><span id="l34.870">   rv = fls-&gt;GetOrCreateFolderForURL(aFolderURI, aFolder);</span>
<a href="#l34.871"></a><span id="l34.871">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.872"></a><span id="l34.872"> </span>
<a href="#l34.873"></a><span id="l34.873">   return *aFolder ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l34.874"></a><span id="l34.874"> }</span>
<a href="#l34.875"></a><span id="l34.875"> </span>
<a href="#l34.876"></a><span id="l34.876" class="difflineminus">-bool IsAFromSpaceLine(char *start, const char *end)</span>
<a href="#l34.877"></a><span id="l34.877" class="difflineminus">-{</span>
<a href="#l34.878"></a><span id="l34.878" class="difflineplus">+bool IsAFromSpaceLine(char *start, const char *end) {</span>
<a href="#l34.879"></a><span id="l34.879">   bool rv = false;</span>
<a href="#l34.880"></a><span id="l34.880" class="difflineminus">-  while ((start &lt; end) &amp;&amp; (*start == '&gt;'))</span>
<a href="#l34.881"></a><span id="l34.881" class="difflineminus">-    start++;</span>
<a href="#l34.882"></a><span id="l34.882" class="difflineminus">-  // If the leading '&gt;'s are followed by an 'F' then we have a possible case here.</span>
<a href="#l34.883"></a><span id="l34.883" class="difflineminus">-  if ( (*start == 'F') &amp;&amp; (end-start &gt; 4) &amp;&amp; !strncmp(start, &quot;From &quot;, 5) )</span>
<a href="#l34.884"></a><span id="l34.884" class="difflineplus">+  while ((start &lt; end) &amp;&amp; (*start == '&gt;')) start++;</span>
<a href="#l34.885"></a><span id="l34.885" class="difflineplus">+  // If the leading '&gt;'s are followed by an 'F' then we have a possible case</span>
<a href="#l34.886"></a><span id="l34.886" class="difflineplus">+  // here.</span>
<a href="#l34.887"></a><span id="l34.887" class="difflineplus">+  if ((*start == 'F') &amp;&amp; (end - start &gt; 4) &amp;&amp; !strncmp(start, &quot;From &quot;, 5))</span>
<a href="#l34.888"></a><span id="l34.888">     rv = true;</span>
<a href="#l34.889"></a><span id="l34.889">   return rv;</span>
<a href="#l34.890"></a><span id="l34.890"> }</span>
<a href="#l34.891"></a><span id="l34.891"> </span>
<a href="#l34.892"></a><span id="l34.892"> //</span>
<a href="#l34.893"></a><span id="l34.893"> // This function finds all lines starting with &quot;From &quot; or &quot;From &quot; preceding</span>
<a href="#l34.894"></a><span id="l34.894"> // with one or more '&gt;' (ie, &quot;&gt;From&quot;, &quot;&gt;&gt;From&quot;, etc) in the input buffer</span>
<a href="#l34.895"></a><span id="l34.895"> // (between 'start' and 'end') and prefix them with a &quot;&gt;&quot; .</span>
<a href="#l34.896"></a><span id="l34.896"> //</span>
<a href="#l34.897"></a><span id="l34.897" class="difflineminus">-nsresult EscapeFromSpaceLine(nsIOutputStream *outputStream, char *start, const char *end)</span>
<a href="#l34.898"></a><span id="l34.898" class="difflineminus">-{</span>
<a href="#l34.899"></a><span id="l34.899" class="difflineplus">+nsresult EscapeFromSpaceLine(nsIOutputStream *outputStream, char *start,</span>
<a href="#l34.900"></a><span id="l34.900" class="difflineplus">+                             const char *end) {</span>
<a href="#l34.901"></a><span id="l34.901">   nsresult rv;</span>
<a href="#l34.902"></a><span id="l34.902">   char *pChar;</span>
<a href="#l34.903"></a><span id="l34.903">   uint32_t written;</span>
<a href="#l34.904"></a><span id="l34.904"> </span>
<a href="#l34.905"></a><span id="l34.905">   pChar = start;</span>
<a href="#l34.906"></a><span id="l34.906" class="difflineminus">-  while (start &lt; end)</span>
<a href="#l34.907"></a><span id="l34.907" class="difflineminus">-  {</span>
<a href="#l34.908"></a><span id="l34.908" class="difflineplus">+  while (start &lt; end) {</span>
<a href="#l34.909"></a><span id="l34.909">     while ((pChar &lt; end) &amp;&amp; (*pChar != '\r') &amp;&amp; ((pChar + 1) &lt; end) &amp;&amp;</span>
<a href="#l34.910"></a><span id="l34.910">            (*(pChar + 1) != '\n'))</span>
<a href="#l34.911"></a><span id="l34.911">       pChar++;</span>
<a href="#l34.912"></a><span id="l34.912" class="difflineminus">-    if ((pChar + 1) == end)</span>
<a href="#l34.913"></a><span id="l34.913" class="difflineminus">-      pChar++;</span>
<a href="#l34.914"></a><span id="l34.914" class="difflineplus">+    if ((pChar + 1) == end) pChar++;</span>
<a href="#l34.915"></a><span id="l34.915"> </span>
<a href="#l34.916"></a><span id="l34.916" class="difflineminus">-    if (pChar &lt; end)</span>
<a href="#l34.917"></a><span id="l34.917" class="difflineminus">-    {</span>
<a href="#l34.918"></a><span id="l34.918" class="difflineplus">+    if (pChar &lt; end) {</span>
<a href="#l34.919"></a><span id="l34.919">       // Found a line so check if it's a qualified &quot;From &quot; line.</span>
<a href="#l34.920"></a><span id="l34.920">       if (IsAFromSpaceLine(start, pChar))</span>
<a href="#l34.921"></a><span id="l34.921">         rv = outputStream-&gt;Write(&quot;&gt;&quot;, 1, &amp;written);</span>
<a href="#l34.922"></a><span id="l34.922">       int32_t lineTerminatorCount = (*(pChar + 1) == '\n') ? 2 : 1;</span>
<a href="#l34.923"></a><span id="l34.923" class="difflineminus">-      rv = outputStream-&gt;Write(start, pChar - start + lineTerminatorCount, &amp;written);</span>
<a href="#l34.924"></a><span id="l34.924" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.925"></a><span id="l34.925" class="difflineplus">+      rv = outputStream-&gt;Write(start, pChar - start + lineTerminatorCount,</span>
<a href="#l34.926"></a><span id="l34.926" class="difflineplus">+                               &amp;written);</span>
<a href="#l34.927"></a><span id="l34.927" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.928"></a><span id="l34.928">       pChar += lineTerminatorCount;</span>
<a href="#l34.929"></a><span id="l34.929">       start = pChar;</span>
<a href="#l34.930"></a><span id="l34.930" class="difflineminus">-    }</span>
<a href="#l34.931"></a><span id="l34.931" class="difflineminus">-    else if (start &lt; end)</span>
<a href="#l34.932"></a><span id="l34.932" class="difflineminus">-    {</span>
<a href="#l34.933"></a><span id="l34.933" class="difflineplus">+    } else if (start &lt; end) {</span>
<a href="#l34.934"></a><span id="l34.934">       // Check and flush out the remaining data and we're done.</span>
<a href="#l34.935"></a><span id="l34.935">       if (IsAFromSpaceLine(start, end))</span>
<a href="#l34.936"></a><span id="l34.936">         rv = outputStream-&gt;Write(&quot;&gt;&quot;, 1, &amp;written);</span>
<a href="#l34.937"></a><span id="l34.937" class="difflineminus">-      rv = outputStream-&gt;Write(start, end-start, &amp;written);</span>
<a href="#l34.938"></a><span id="l34.938" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.939"></a><span id="l34.939" class="difflineplus">+      rv = outputStream-&gt;Write(start, end - start, &amp;written);</span>
<a href="#l34.940"></a><span id="l34.940" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.941"></a><span id="l34.941">       break;</span>
<a href="#l34.942"></a><span id="l34.942">     }</span>
<a href="#l34.943"></a><span id="l34.943">   }</span>
<a href="#l34.944"></a><span id="l34.944">   return NS_OK;</span>
<a href="#l34.945"></a><span id="l34.945"> }</span>
<a href="#l34.946"></a><span id="l34.946"> </span>
<a href="#l34.947"></a><span id="l34.947" class="difflineminus">-nsresult IsRFC822HeaderFieldName(const char *aHdr, bool *aResult)</span>
<a href="#l34.948"></a><span id="l34.948" class="difflineminus">-{</span>
<a href="#l34.949"></a><span id="l34.949" class="difflineplus">+nsresult IsRFC822HeaderFieldName(const char *aHdr, bool *aResult) {</span>
<a href="#l34.950"></a><span id="l34.950">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l34.951"></a><span id="l34.951">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l34.952"></a><span id="l34.952">   uint32_t length = strlen(aHdr);</span>
<a href="#l34.953"></a><span id="l34.953" class="difflineminus">-  for(uint32_t i=0; i&lt;length; i++)</span>
<a href="#l34.954"></a><span id="l34.954" class="difflineminus">-  {</span>
<a href="#l34.955"></a><span id="l34.955" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; i++) {</span>
<a href="#l34.956"></a><span id="l34.956">     char c = aHdr[i];</span>
<a href="#l34.957"></a><span id="l34.957" class="difflineminus">-    if ( c &lt; '!' || c == ':' || c &gt; '~')</span>
<a href="#l34.958"></a><span id="l34.958" class="difflineminus">-    {</span>
<a href="#l34.959"></a><span id="l34.959" class="difflineplus">+    if (c &lt; '!' || c == ':' || c &gt; '~') {</span>
<a href="#l34.960"></a><span id="l34.960">       *aResult = false;</span>
<a href="#l34.961"></a><span id="l34.961">       return NS_OK;</span>
<a href="#l34.962"></a><span id="l34.962">     }</span>
<a href="#l34.963"></a><span id="l34.963">   }</span>
<a href="#l34.964"></a><span id="l34.964">   *aResult = true;</span>
<a href="#l34.965"></a><span id="l34.965">   return NS_OK;</span>
<a href="#l34.966"></a><span id="l34.966"> }</span>
<a href="#l34.967"></a><span id="l34.967"> </span>
<a href="#l34.968"></a><span id="l34.968"> // Warning, currently this routine only works for the Junk Folder</span>
<a href="#l34.969"></a><span id="l34.969" class="difflineminus">-nsresult</span>
<a href="#l34.970"></a><span id="l34.970" class="difflineminus">-GetOrCreateJunkFolder(const nsACString &amp;aURI, nsIUrlListener *aListener)</span>
<a href="#l34.971"></a><span id="l34.971" class="difflineminus">-{</span>
<a href="#l34.972"></a><span id="l34.972" class="difflineplus">+nsresult GetOrCreateJunkFolder(const nsACString &amp;aURI,</span>
<a href="#l34.973"></a><span id="l34.973" class="difflineplus">+                               nsIUrlListener *aListener) {</span>
<a href="#l34.974"></a><span id="l34.974">   nsresult rv;</span>
<a href="#l34.975"></a><span id="l34.975"> </span>
<a href="#l34.976"></a><span id="l34.976">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l34.977"></a><span id="l34.977">   rv = GetOrCreateFolder(aURI, getter_AddRefs(folder));</span>
<a href="#l34.978"></a><span id="l34.978">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.979"></a><span id="l34.979"> </span>
<a href="#l34.980"></a><span id="l34.980">   // don't check validity of folder - caller will handle creating it</span>
<a href="#l34.981"></a><span id="l34.981">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l34.982"></a><span id="l34.982" class="difflineminus">-  // make sure that folder hierarchy is built so that legitimate parent-child relationship is established</span>
<a href="#l34.983"></a><span id="l34.983" class="difflineplus">+  // make sure that folder hierarchy is built so that legitimate parent-child</span>
<a href="#l34.984"></a><span id="l34.984" class="difflineplus">+  // relationship is established</span>
<a href="#l34.985"></a><span id="l34.985">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l34.986"></a><span id="l34.986">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.987"></a><span id="l34.987" class="difflineminus">-  if (!server)</span>
<a href="#l34.988"></a><span id="l34.988" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l34.989"></a><span id="l34.989" class="difflineplus">+  if (!server) return NS_ERROR_UNEXPECTED;</span>
<a href="#l34.990"></a><span id="l34.990"> </span>
<a href="#l34.991"></a><span id="l34.991" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l34.992"></a><span id="l34.992" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l34.993"></a><span id="l34.993">   rv = server-&gt;GetMsgFolderFromURI(folder, aURI, getter_AddRefs(msgFolder));</span>
<a href="#l34.994"></a><span id="l34.994" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.995"></a><span id="l34.995" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.996"></a><span id="l34.996"> </span>
<a href="#l34.997"></a><span id="l34.997" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l34.998"></a><span id="l34.998" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l34.999"></a><span id="l34.999">   rv = msgFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l34.1000"></a><span id="l34.1000" class="difflineminus">-  if (NS_FAILED(rv) || !parent)</span>
<a href="#l34.1001"></a><span id="l34.1001" class="difflineminus">-  {</span>
<a href="#l34.1002"></a><span id="l34.1002" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; folderPath;</span>
<a href="#l34.1003"></a><span id="l34.1003" class="difflineplus">+  if (NS_FAILED(rv) || !parent) {</span>
<a href="#l34.1004"></a><span id="l34.1004" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l34.1005"></a><span id="l34.1005">     // for local folders, path is to the berkeley mailbox.</span>
<a href="#l34.1006"></a><span id="l34.1006">     // for imap folders, path needs to have .msf appended to the name</span>
<a href="#l34.1007"></a><span id="l34.1007">     msgFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l34.1008"></a><span id="l34.1008"> </span>
<a href="#l34.1009"></a><span id="l34.1009">     nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l34.1010"></a><span id="l34.1010">     rv = server-&gt;GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l34.1011"></a><span id="l34.1011">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1012"></a><span id="l34.1012"> </span>
<a href="#l34.1013"></a><span id="l34.1013">     bool isAsyncFolder;</span>
<a href="#l34.1014"></a><span id="l34.1014">     rv = protocolInfo-&gt;GetFoldersCreatedAsync(&amp;isAsyncFolder);</span>
<a href="#l34.1015"></a><span id="l34.1015">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1016"></a><span id="l34.1016"> </span>
<a href="#l34.1017"></a><span id="l34.1017">     // if we can't get the path from the folder, then try to create the storage.</span>
<a href="#l34.1018"></a><span id="l34.1018">     // for imap, it doesn't matter if the .msf file exists - it still might not</span>
<a href="#l34.1019"></a><span id="l34.1019">     // exist on the server, so we should try to create it</span>
<a href="#l34.1020"></a><span id="l34.1020">     bool exists = false;</span>
<a href="#l34.1021"></a><span id="l34.1021" class="difflineminus">-    if (!isAsyncFolder &amp;&amp; folderPath)</span>
<a href="#l34.1022"></a><span id="l34.1022" class="difflineminus">-      folderPath-&gt;Exists(&amp;exists);</span>
<a href="#l34.1023"></a><span id="l34.1023" class="difflineminus">-    if (!exists)</span>
<a href="#l34.1024"></a><span id="l34.1024" class="difflineminus">-    {</span>
<a href="#l34.1025"></a><span id="l34.1025" class="difflineplus">+    if (!isAsyncFolder &amp;&amp; folderPath) folderPath-&gt;Exists(&amp;exists);</span>
<a href="#l34.1026"></a><span id="l34.1026" class="difflineplus">+    if (!exists) {</span>
<a href="#l34.1027"></a><span id="l34.1027">       // Hack to work around a localization bug with the Junk Folder.</span>
<a href="#l34.1028"></a><span id="l34.1028">       // Please see Bug #270261 for more information...</span>
<a href="#l34.1029"></a><span id="l34.1029">       nsString localizedJunkName;</span>
<a href="#l34.1030"></a><span id="l34.1030">       msgFolder-&gt;GetName(localizedJunkName);</span>
<a href="#l34.1031"></a><span id="l34.1031"> </span>
<a href="#l34.1032"></a><span id="l34.1032" class="difflineminus">-      // force the junk folder name to be Junk so it gets created on disk correctly...</span>
<a href="#l34.1033"></a><span id="l34.1033" class="difflineplus">+      // force the junk folder name to be Junk so it gets created on disk</span>
<a href="#l34.1034"></a><span id="l34.1034" class="difflineplus">+      // correctly...</span>
<a href="#l34.1035"></a><span id="l34.1035">       msgFolder-&gt;SetName(NS_LITERAL_STRING(&quot;Junk&quot;));</span>
<a href="#l34.1036"></a><span id="l34.1036">       msgFolder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l34.1037"></a><span id="l34.1037">       rv = msgFolder-&gt;CreateStorageIfMissing(aListener);</span>
<a href="#l34.1038"></a><span id="l34.1038" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.1039"></a><span id="l34.1039" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1040"></a><span id="l34.1040"> </span>
<a href="#l34.1041"></a><span id="l34.1041">       // now restore the localized folder name...</span>
<a href="#l34.1042"></a><span id="l34.1042">       msgFolder-&gt;SetName(localizedJunkName);</span>
<a href="#l34.1043"></a><span id="l34.1043"> </span>
<a href="#l34.1044"></a><span id="l34.1044">       // XXX TODO</span>
<a href="#l34.1045"></a><span id="l34.1045">       // JUNK MAIL RELATED</span>
<a href="#l34.1046"></a><span id="l34.1046">       // ugh, I hate this hack</span>
<a href="#l34.1047"></a><span id="l34.1047">       // we have to do this (for now)</span>
<a href="#l34.1048"></a><span id="l34.1048" class="difflineminus">-      // because imap and local are different (one creates folder asynch, the other synch)</span>
<a href="#l34.1049"></a><span id="l34.1049" class="difflineminus">-      // one will notify the listener, one will not.</span>
<a href="#l34.1050"></a><span id="l34.1050" class="difflineminus">-      // I blame nsMsgCopy.</span>
<a href="#l34.1051"></a><span id="l34.1051" class="difflineminus">-      // we should look into making it so no matter what the folder type</span>
<a href="#l34.1052"></a><span id="l34.1052" class="difflineminus">-      // we always call the listener</span>
<a href="#l34.1053"></a><span id="l34.1053" class="difflineminus">-      // this code should move into local folder's version of CreateStorageIfMissing()</span>
<a href="#l34.1054"></a><span id="l34.1054" class="difflineplus">+      // because imap and local are different (one creates folder asynch, the</span>
<a href="#l34.1055"></a><span id="l34.1055" class="difflineplus">+      // other synch) one will notify the listener, one will not. I blame</span>
<a href="#l34.1056"></a><span id="l34.1056" class="difflineplus">+      // nsMsgCopy. we should look into making it so no matter what the folder</span>
<a href="#l34.1057"></a><span id="l34.1057" class="difflineplus">+      // type we always call the listener this code should move into local</span>
<a href="#l34.1058"></a><span id="l34.1058" class="difflineplus">+      // folder's version of CreateStorageIfMissing()</span>
<a href="#l34.1059"></a><span id="l34.1059">       if (!isAsyncFolder &amp;&amp; aListener) {</span>
<a href="#l34.1060"></a><span id="l34.1060">         rv = aListener-&gt;OnStartRunningUrl(nullptr);</span>
<a href="#l34.1061"></a><span id="l34.1061" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.1062"></a><span id="l34.1062" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1063"></a><span id="l34.1063"> </span>
<a href="#l34.1064"></a><span id="l34.1064">         rv = aListener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l34.1065"></a><span id="l34.1065" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.1066"></a><span id="l34.1066" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1067"></a><span id="l34.1067">       }</span>
<a href="#l34.1068"></a><span id="l34.1068">     }</span>
<a href="#l34.1069"></a><span id="l34.1069" class="difflineminus">-  }</span>
<a href="#l34.1070"></a><span id="l34.1070" class="difflineminus">-  else {</span>
<a href="#l34.1071"></a><span id="l34.1071" class="difflineplus">+  } else {</span>
<a href="#l34.1072"></a><span id="l34.1072">     // if the folder exists, we should set the junk flag on it</span>
<a href="#l34.1073"></a><span id="l34.1073">     // which is what the listener will do</span>
<a href="#l34.1074"></a><span id="l34.1074">     if (aListener) {</span>
<a href="#l34.1075"></a><span id="l34.1075">       rv = aListener-&gt;OnStartRunningUrl(nullptr);</span>
<a href="#l34.1076"></a><span id="l34.1076" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.1077"></a><span id="l34.1077" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1078"></a><span id="l34.1078"> </span>
<a href="#l34.1079"></a><span id="l34.1079">       rv = aListener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l34.1080"></a><span id="l34.1080" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.1081"></a><span id="l34.1081" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1082"></a><span id="l34.1082">     }</span>
<a href="#l34.1083"></a><span id="l34.1083">   }</span>
<a href="#l34.1084"></a><span id="l34.1084"> </span>
<a href="#l34.1085"></a><span id="l34.1085">   return NS_OK;</span>
<a href="#l34.1086"></a><span id="l34.1086"> }</span>
<a href="#l34.1087"></a><span id="l34.1087"> </span>
<a href="#l34.1088"></a><span id="l34.1088" class="difflineminus">-nsresult IsRSSArticle(nsIURI * aMsgURI, bool *aIsRSSArticle)</span>
<a href="#l34.1089"></a><span id="l34.1089" class="difflineminus">-{</span>
<a href="#l34.1090"></a><span id="l34.1090" class="difflineplus">+nsresult IsRSSArticle(nsIURI *aMsgURI, bool *aIsRSSArticle) {</span>
<a href="#l34.1091"></a><span id="l34.1091">   nsresult rv;</span>
<a href="#l34.1092"></a><span id="l34.1092">   *aIsRSSArticle = false;</span>
<a href="#l34.1093"></a><span id="l34.1093"> </span>
<a href="#l34.1094"></a><span id="l34.1094">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(aMsgURI, &amp;rv);</span>
<a href="#l34.1095"></a><span id="l34.1095">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.1096"></a><span id="l34.1096"> </span>
<a href="#l34.1097"></a><span id="l34.1097">   nsCString resourceURI;</span>
<a href="#l34.1098"></a><span id="l34.1098">   msgUrl-&gt;GetUri(getter_Copies(resourceURI));</span>
<a href="#l34.1099"></a><span id="l34.1099" class="difflineat">@@ -977,69 +896,65 @@ nsresult IsRSSArticle(nsIURI * aMsgURI, </span>
<a href="#l34.1100"></a><span id="l34.1100">   // get the msg service for this URI</span>
<a href="#l34.1101"></a><span id="l34.1101">   nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l34.1102"></a><span id="l34.1102">   rv = GetMessageServiceFromURI(resourceURI, getter_AddRefs(msgService));</span>
<a href="#l34.1103"></a><span id="l34.1103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1104"></a><span id="l34.1104"> </span>
<a href="#l34.1105"></a><span id="l34.1105">   // Check if the message is a feed message, regardless of folder.</span>
<a href="#l34.1106"></a><span id="l34.1106">   uint32_t flags;</span>
<a href="#l34.1107"></a><span id="l34.1107">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l34.1108"></a><span id="l34.1108" class="difflineminus">-  rv = msgService-&gt;MessageURIToMsgHdr(resourceURI.get(), getter_AddRefs(msgHdr));</span>
<a href="#l34.1109"></a><span id="l34.1109" class="difflineplus">+  rv =</span>
<a href="#l34.1110"></a><span id="l34.1110" class="difflineplus">+      msgService-&gt;MessageURIToMsgHdr(resourceURI.get(), getter_AddRefs(msgHdr));</span>
<a href="#l34.1111"></a><span id="l34.1111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1112"></a><span id="l34.1112">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l34.1113"></a><span id="l34.1113" class="difflineminus">-  if (flags &amp; nsMsgMessageFlags::FeedMsg)</span>
<a href="#l34.1114"></a><span id="l34.1114" class="difflineminus">-  {</span>
<a href="#l34.1115"></a><span id="l34.1115" class="difflineplus">+  if (flags &amp; nsMsgMessageFlags::FeedMsg) {</span>
<a href="#l34.1116"></a><span id="l34.1116">     *aIsRSSArticle = true;</span>
<a href="#l34.1117"></a><span id="l34.1117">     return rv;</span>
<a href="#l34.1118"></a><span id="l34.1118">   }</span>
<a href="#l34.1119"></a><span id="l34.1119"> </span>
<a href="#l34.1120"></a><span id="l34.1120">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aMsgURI, &amp;rv);</span>
<a href="#l34.1121"></a><span id="l34.1121">   mozilla::Unused &lt;&lt; mailnewsUrl;</span>
<a href="#l34.1122"></a><span id="l34.1122">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1123"></a><span id="l34.1123"> </span>
<a href="#l34.1124"></a><span id="l34.1124">   // get the folder and the server from the msghdr</span>
<a href="#l34.1125"></a><span id="l34.1125">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l34.1126"></a><span id="l34.1126">   rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l34.1127"></a><span id="l34.1127" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l34.1128"></a><span id="l34.1128" class="difflineminus">-  {</span>
<a href="#l34.1129"></a><span id="l34.1129" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l34.1130"></a><span id="l34.1130">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l34.1131"></a><span id="l34.1131">     folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l34.1132"></a><span id="l34.1132">     nsCOMPtr&lt;nsIRssIncomingServer&gt; rssServer = do_QueryInterface(server);</span>
<a href="#l34.1133"></a><span id="l34.1133"> </span>
<a href="#l34.1134"></a><span id="l34.1134" class="difflineminus">-    if (rssServer)</span>
<a href="#l34.1135"></a><span id="l34.1135" class="difflineminus">-      *aIsRSSArticle = true;</span>
<a href="#l34.1136"></a><span id="l34.1136" class="difflineplus">+    if (rssServer) *aIsRSSArticle = true;</span>
<a href="#l34.1137"></a><span id="l34.1137">   }</span>
<a href="#l34.1138"></a><span id="l34.1138"> </span>
<a href="#l34.1139"></a><span id="l34.1139">   return rv;</span>
<a href="#l34.1140"></a><span id="l34.1140"> }</span>
<a href="#l34.1141"></a><span id="l34.1141"> </span>
<a href="#l34.1142"></a><span id="l34.1142" class="difflineminus">-</span>
<a href="#l34.1143"></a><span id="l34.1143"> // digest needs to be a pointer to a DIGEST_LENGTH (16) byte buffer</span>
<a href="#l34.1144"></a><span id="l34.1144" class="difflineminus">-nsresult MSGCramMD5(const char *text, int32_t text_len, const char *key, int32_t key_len, unsigned char *digest)</span>
<a href="#l34.1145"></a><span id="l34.1145" class="difflineminus">-{</span>
<a href="#l34.1146"></a><span id="l34.1146" class="difflineplus">+nsresult MSGCramMD5(const char *text, int32_t text_len, const char *key,</span>
<a href="#l34.1147"></a><span id="l34.1147" class="difflineplus">+                    int32_t key_len, unsigned char *digest) {</span>
<a href="#l34.1148"></a><span id="l34.1148">   nsresult rv;</span>
<a href="#l34.1149"></a><span id="l34.1149"> </span>
<a href="#l34.1150"></a><span id="l34.1150">   nsAutoCString hash;</span>
<a href="#l34.1151"></a><span id="l34.1151" class="difflineminus">-  nsCOMPtr&lt;nsICryptoHash&gt; hasher = do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l34.1152"></a><span id="l34.1152" class="difflineplus">+  nsCOMPtr&lt;nsICryptoHash&gt; hasher =</span>
<a href="#l34.1153"></a><span id="l34.1153" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l34.1154"></a><span id="l34.1154">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1155"></a><span id="l34.1155"> </span>
<a href="#l34.1156"></a><span id="l34.1156" class="difflineminus">-</span>
<a href="#l34.1157"></a><span id="l34.1157" class="difflineminus">-  // this code adapted from http://www.cis.ohio-state.edu/cgi-bin/rfc/rfc2104.html</span>
<a href="#l34.1158"></a><span id="l34.1158" class="difflineplus">+  // this code adapted from</span>
<a href="#l34.1159"></a><span id="l34.1159" class="difflineplus">+  // http://www.cis.ohio-state.edu/cgi-bin/rfc/rfc2104.html</span>
<a href="#l34.1160"></a><span id="l34.1160"> </span>
<a href="#l34.1161"></a><span id="l34.1161" class="difflineminus">-  char innerPad[65];    /* inner padding - key XORd with innerPad */</span>
<a href="#l34.1162"></a><span id="l34.1162" class="difflineminus">-  char outerPad[65];    /* outer padding - key XORd with outerPad */</span>
<a href="#l34.1163"></a><span id="l34.1163" class="difflineplus">+  char innerPad[65]; /* inner padding - key XORd with innerPad */</span>
<a href="#l34.1164"></a><span id="l34.1164" class="difflineplus">+  char outerPad[65]; /* outer padding - key XORd with outerPad */</span>
<a href="#l34.1165"></a><span id="l34.1165">   int i;</span>
<a href="#l34.1166"></a><span id="l34.1166">   /* if key is longer than 64 bytes reset it to key=MD5(key) */</span>
<a href="#l34.1167"></a><span id="l34.1167" class="difflineminus">-  if (key_len &gt; 64)</span>
<a href="#l34.1168"></a><span id="l34.1168" class="difflineminus">-  {</span>
<a href="#l34.1169"></a><span id="l34.1169" class="difflineminus">-</span>
<a href="#l34.1170"></a><span id="l34.1170" class="difflineplus">+  if (key_len &gt; 64) {</span>
<a href="#l34.1171"></a><span id="l34.1171">     rv = hasher-&gt;Init(nsICryptoHash::MD5);</span>
<a href="#l34.1172"></a><span id="l34.1172">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1173"></a><span id="l34.1173"> </span>
<a href="#l34.1174"></a><span id="l34.1174" class="difflineminus">-    rv = hasher-&gt;Update((const uint8_t*) key, key_len);</span>
<a href="#l34.1175"></a><span id="l34.1175" class="difflineplus">+    rv = hasher-&gt;Update((const uint8_t *)key, key_len);</span>
<a href="#l34.1176"></a><span id="l34.1176">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1177"></a><span id="l34.1177"> </span>
<a href="#l34.1178"></a><span id="l34.1178">     rv = hasher-&gt;Finish(false, hash);</span>
<a href="#l34.1179"></a><span id="l34.1179">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1180"></a><span id="l34.1180"> </span>
<a href="#l34.1181"></a><span id="l34.1181">     key = hash.get();</span>
<a href="#l34.1182"></a><span id="l34.1182">     key_len = DIGEST_LENGTH;</span>
<a href="#l34.1183"></a><span id="l34.1183">   }</span>
<a href="#l34.1184"></a><span id="l34.1184" class="difflineat">@@ -1053,792 +968,737 @@ nsresult MSGCramMD5(const char *text, in</span>
<a href="#l34.1185"></a><span id="l34.1185">    * innerPad is the byte 0x36 repeated 64 times</span>
<a href="#l34.1186"></a><span id="l34.1186">    * outerPad is the byte 0x5c repeated 64 times</span>
<a href="#l34.1187"></a><span id="l34.1187">    * and text is the data being protected</span>
<a href="#l34.1188"></a><span id="l34.1188">    */</span>
<a href="#l34.1189"></a><span id="l34.1189"> </span>
<a href="#l34.1190"></a><span id="l34.1190">   /* start out by storing key in pads */</span>
<a href="#l34.1191"></a><span id="l34.1191">   memset(innerPad, 0, sizeof innerPad);</span>
<a href="#l34.1192"></a><span id="l34.1192">   memset(outerPad, 0, sizeof outerPad);</span>
<a href="#l34.1193"></a><span id="l34.1193" class="difflineminus">-  memcpy(innerPad, key,  key_len);</span>
<a href="#l34.1194"></a><span id="l34.1194" class="difflineplus">+  memcpy(innerPad, key, key_len);</span>
<a href="#l34.1195"></a><span id="l34.1195">   memcpy(outerPad, key, key_len);</span>
<a href="#l34.1196"></a><span id="l34.1196"> </span>
<a href="#l34.1197"></a><span id="l34.1197">   /* XOR key with innerPad and outerPad values */</span>
<a href="#l34.1198"></a><span id="l34.1198" class="difflineminus">-  for (i=0; i&lt;64; i++)</span>
<a href="#l34.1199"></a><span id="l34.1199" class="difflineminus">-  {</span>
<a href="#l34.1200"></a><span id="l34.1200" class="difflineplus">+  for (i = 0; i &lt; 64; i++) {</span>
<a href="#l34.1201"></a><span id="l34.1201">     innerPad[i] ^= 0x36;</span>
<a href="#l34.1202"></a><span id="l34.1202">     outerPad[i] ^= 0x5c;</span>
<a href="#l34.1203"></a><span id="l34.1203">   }</span>
<a href="#l34.1204"></a><span id="l34.1204">   /*</span>
<a href="#l34.1205"></a><span id="l34.1205">    * perform inner MD5</span>
<a href="#l34.1206"></a><span id="l34.1206">    */</span>
<a href="#l34.1207"></a><span id="l34.1207">   nsAutoCString result;</span>
<a href="#l34.1208"></a><span id="l34.1208">   rv = hasher-&gt;Init(nsICryptoHash::MD5); /* init context for 1st pass */</span>
<a href="#l34.1209"></a><span id="l34.1209" class="difflineminus">-  rv = hasher-&gt;Update((const uint8_t*)innerPad, 64);       /* start with inner pad */</span>
<a href="#l34.1210"></a><span id="l34.1210" class="difflineminus">-  rv = hasher-&gt;Update((const uint8_t*)text, text_len);     /* then text of datagram */</span>
<a href="#l34.1211"></a><span id="l34.1211" class="difflineminus">-  rv = hasher-&gt;Finish(false, result);   /* finish up 1st pass */</span>
<a href="#l34.1212"></a><span id="l34.1212" class="difflineplus">+  rv = hasher-&gt;Update((const uint8_t *)innerPad, 64); /* start with inner pad */</span>
<a href="#l34.1213"></a><span id="l34.1213" class="difflineplus">+  rv = hasher-&gt;Update((const uint8_t *)text,</span>
<a href="#l34.1214"></a><span id="l34.1214" class="difflineplus">+                      text_len);      /* then text of datagram */</span>
<a href="#l34.1215"></a><span id="l34.1215" class="difflineplus">+  rv = hasher-&gt;Finish(false, result); /* finish up 1st pass */</span>
<a href="#l34.1216"></a><span id="l34.1216"> </span>
<a href="#l34.1217"></a><span id="l34.1217">   /*</span>
<a href="#l34.1218"></a><span id="l34.1218">    * perform outer MD5</span>
<a href="#l34.1219"></a><span id="l34.1219">    */</span>
<a href="#l34.1220"></a><span id="l34.1220" class="difflineminus">-  hasher-&gt;Init(nsICryptoHash::MD5);       /* init context for 2nd pass */</span>
<a href="#l34.1221"></a><span id="l34.1221" class="difflineminus">-  rv = hasher-&gt;Update((const uint8_t*)outerPad, 64);    /* start with outer pad */</span>
<a href="#l34.1222"></a><span id="l34.1222" class="difflineminus">-  rv = hasher-&gt;Update((const uint8_t*)result.get(), 16);/* then results of 1st hash */</span>
<a href="#l34.1223"></a><span id="l34.1223" class="difflineminus">-  rv = hasher-&gt;Finish(false, result);    /* finish up 2nd pass */</span>
<a href="#l34.1224"></a><span id="l34.1224" class="difflineplus">+  hasher-&gt;Init(nsICryptoHash::MD5); /* init context for 2nd pass */</span>
<a href="#l34.1225"></a><span id="l34.1225" class="difflineplus">+  rv = hasher-&gt;Update((const uint8_t *)outerPad, 64); /* start with outer pad */</span>
<a href="#l34.1226"></a><span id="l34.1226" class="difflineplus">+  rv = hasher-&gt;Update((const uint8_t *)result.get(),</span>
<a href="#l34.1227"></a><span id="l34.1227" class="difflineplus">+                      16);            /* then results of 1st hash */</span>
<a href="#l34.1228"></a><span id="l34.1228" class="difflineplus">+  rv = hasher-&gt;Finish(false, result); /* finish up 2nd pass */</span>
<a href="#l34.1229"></a><span id="l34.1229"> </span>
<a href="#l34.1230"></a><span id="l34.1230" class="difflineminus">-  if (result.Length() != DIGEST_LENGTH)</span>
<a href="#l34.1231"></a><span id="l34.1231" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l34.1232"></a><span id="l34.1232" class="difflineplus">+  if (result.Length() != DIGEST_LENGTH) return NS_ERROR_UNEXPECTED;</span>
<a href="#l34.1233"></a><span id="l34.1233"> </span>
<a href="#l34.1234"></a><span id="l34.1234">   memcpy(digest, result.get(), DIGEST_LENGTH);</span>
<a href="#l34.1235"></a><span id="l34.1235"> </span>
<a href="#l34.1236"></a><span id="l34.1236">   return rv;</span>
<a href="#l34.1237"></a><span id="l34.1237" class="difflineminus">-</span>
<a href="#l34.1238"></a><span id="l34.1238"> }</span>
<a href="#l34.1239"></a><span id="l34.1239"> </span>
<a href="#l34.1240"></a><span id="l34.1240" class="difflineminus">-</span>
<a href="#l34.1241"></a><span id="l34.1241"> // digest needs to be a pointer to a DIGEST_LENGTH (16) byte buffer</span>
<a href="#l34.1242"></a><span id="l34.1242" class="difflineminus">-nsresult MSGApopMD5(const char *text, int32_t text_len, const char *password, int32_t password_len, unsigned char *digest)</span>
<a href="#l34.1243"></a><span id="l34.1243" class="difflineminus">-{</span>
<a href="#l34.1244"></a><span id="l34.1244" class="difflineplus">+nsresult MSGApopMD5(const char *text, int32_t text_len, const char *password,</span>
<a href="#l34.1245"></a><span id="l34.1245" class="difflineplus">+                    int32_t password_len, unsigned char *digest) {</span>
<a href="#l34.1246"></a><span id="l34.1246">   nsresult rv;</span>
<a href="#l34.1247"></a><span id="l34.1247">   nsAutoCString result;</span>
<a href="#l34.1248"></a><span id="l34.1248"> </span>
<a href="#l34.1249"></a><span id="l34.1249" class="difflineminus">-  nsCOMPtr&lt;nsICryptoHash&gt; hasher = do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l34.1250"></a><span id="l34.1250" class="difflineplus">+  nsCOMPtr&lt;nsICryptoHash&gt; hasher =</span>
<a href="#l34.1251"></a><span id="l34.1251" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l34.1252"></a><span id="l34.1252">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1253"></a><span id="l34.1253"> </span>
<a href="#l34.1254"></a><span id="l34.1254">   rv = hasher-&gt;Init(nsICryptoHash::MD5);</span>
<a href="#l34.1255"></a><span id="l34.1255">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1256"></a><span id="l34.1256"> </span>
<a href="#l34.1257"></a><span id="l34.1257" class="difflineminus">-  rv = hasher-&gt;Update((const uint8_t*) text, text_len);</span>
<a href="#l34.1258"></a><span id="l34.1258" class="difflineplus">+  rv = hasher-&gt;Update((const uint8_t *)text, text_len);</span>
<a href="#l34.1259"></a><span id="l34.1259">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1260"></a><span id="l34.1260"> </span>
<a href="#l34.1261"></a><span id="l34.1261" class="difflineminus">-  rv = hasher-&gt;Update((const uint8_t*) password, password_len);</span>
<a href="#l34.1262"></a><span id="l34.1262" class="difflineplus">+  rv = hasher-&gt;Update((const uint8_t *)password, password_len);</span>
<a href="#l34.1263"></a><span id="l34.1263">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1264"></a><span id="l34.1264"> </span>
<a href="#l34.1265"></a><span id="l34.1265">   rv = hasher-&gt;Finish(false, result);</span>
<a href="#l34.1266"></a><span id="l34.1266">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1267"></a><span id="l34.1267"> </span>
<a href="#l34.1268"></a><span id="l34.1268" class="difflineminus">-  if (result.Length() != DIGEST_LENGTH)</span>
<a href="#l34.1269"></a><span id="l34.1269" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l34.1270"></a><span id="l34.1270" class="difflineplus">+  if (result.Length() != DIGEST_LENGTH) return NS_ERROR_UNEXPECTED;</span>
<a href="#l34.1271"></a><span id="l34.1271"> </span>
<a href="#l34.1272"></a><span id="l34.1272">   memcpy(digest, result.get(), DIGEST_LENGTH);</span>
<a href="#l34.1273"></a><span id="l34.1273">   return rv;</span>
<a href="#l34.1274"></a><span id="l34.1274"> }</span>
<a href="#l34.1275"></a><span id="l34.1275"> </span>
<a href="#l34.1276"></a><span id="l34.1276"> NS_MSG_BASE nsresult NS_GetPersistentFile(const char *relPrefName,</span>
<a href="#l34.1277"></a><span id="l34.1277">                                           const char *absPrefName,</span>
<a href="#l34.1278"></a><span id="l34.1278">                                           const char *dirServiceProp,</span>
<a href="#l34.1279"></a><span id="l34.1279" class="difflineminus">-                                          bool&amp; gotRelPref,</span>
<a href="#l34.1280"></a><span id="l34.1280" class="difflineminus">-                                          nsIFile **aFile,</span>
<a href="#l34.1281"></a><span id="l34.1281" class="difflineminus">-                                          nsIPrefBranch *prefBranch)</span>
<a href="#l34.1282"></a><span id="l34.1282" class="difflineminus">-{</span>
<a href="#l34.1283"></a><span id="l34.1283" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l34.1284"></a><span id="l34.1284" class="difflineminus">-    *aFile = nullptr;</span>
<a href="#l34.1285"></a><span id="l34.1285" class="difflineminus">-    NS_ENSURE_ARG(relPrefName);</span>
<a href="#l34.1286"></a><span id="l34.1286" class="difflineminus">-    NS_ENSURE_ARG(absPrefName);</span>
<a href="#l34.1287"></a><span id="l34.1287" class="difflineminus">-    gotRelPref = false;</span>
<a href="#l34.1288"></a><span id="l34.1288" class="difflineplus">+                                          bool &amp;gotRelPref, nsIFile **aFile,</span>
<a href="#l34.1289"></a><span id="l34.1289" class="difflineplus">+                                          nsIPrefBranch *prefBranch) {</span>
<a href="#l34.1290"></a><span id="l34.1290" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l34.1291"></a><span id="l34.1291" class="difflineplus">+  *aFile = nullptr;</span>
<a href="#l34.1292"></a><span id="l34.1292" class="difflineplus">+  NS_ENSURE_ARG(relPrefName);</span>
<a href="#l34.1293"></a><span id="l34.1293" class="difflineplus">+  NS_ENSURE_ARG(absPrefName);</span>
<a href="#l34.1294"></a><span id="l34.1294" class="difflineplus">+  gotRelPref = false;</span>
<a href="#l34.1295"></a><span id="l34.1295"> </span>
<a href="#l34.1296"></a><span id="l34.1296" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; mainBranch;</span>
<a href="#l34.1297"></a><span id="l34.1297" class="difflineminus">-    if (!prefBranch) {</span>
<a href="#l34.1298"></a><span id="l34.1298" class="difflineminus">-        nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l34.1299"></a><span id="l34.1299" class="difflineminus">-        if (!prefService) return NS_ERROR_FAILURE;</span>
<a href="#l34.1300"></a><span id="l34.1300" class="difflineminus">-        prefService-&gt;GetBranch(nullptr, getter_AddRefs(mainBranch));</span>
<a href="#l34.1301"></a><span id="l34.1301" class="difflineminus">-        if (!mainBranch) return NS_ERROR_FAILURE;</span>
<a href="#l34.1302"></a><span id="l34.1302" class="difflineminus">-        prefBranch = mainBranch;</span>
<a href="#l34.1303"></a><span id="l34.1303" class="difflineminus">-    }</span>
<a href="#l34.1304"></a><span id="l34.1304" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; mainBranch;</span>
<a href="#l34.1305"></a><span id="l34.1305" class="difflineplus">+  if (!prefBranch) {</span>
<a href="#l34.1306"></a><span id="l34.1306" class="difflineplus">+    nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l34.1307"></a><span id="l34.1307" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l34.1308"></a><span id="l34.1308" class="difflineplus">+    if (!prefService) return NS_ERROR_FAILURE;</span>
<a href="#l34.1309"></a><span id="l34.1309" class="difflineplus">+    prefService-&gt;GetBranch(nullptr, getter_AddRefs(mainBranch));</span>
<a href="#l34.1310"></a><span id="l34.1310" class="difflineplus">+    if (!mainBranch) return NS_ERROR_FAILURE;</span>
<a href="#l34.1311"></a><span id="l34.1311" class="difflineplus">+    prefBranch = mainBranch;</span>
<a href="#l34.1312"></a><span id="l34.1312" class="difflineplus">+  }</span>
<a href="#l34.1313"></a><span id="l34.1313"> </span>
<a href="#l34.1314"></a><span id="l34.1314" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l34.1315"></a><span id="l34.1315" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l34.1316"></a><span id="l34.1316"> </span>
<a href="#l34.1317"></a><span id="l34.1317" class="difflineminus">-    // Get the relative first</span>
<a href="#l34.1318"></a><span id="l34.1318" class="difflineminus">-    nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref;</span>
<a href="#l34.1319"></a><span id="l34.1319" class="difflineminus">-    prefBranch-&gt;GetComplexValue(relPrefName,</span>
<a href="#l34.1320"></a><span id="l34.1320" class="difflineminus">-                                NS_GET_IID(nsIRelativeFilePref), getter_AddRefs(relFilePref));</span>
<a href="#l34.1321"></a><span id="l34.1321" class="difflineminus">-    if (relFilePref) {</span>
<a href="#l34.1322"></a><span id="l34.1322" class="difflineminus">-        relFilePref-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l34.1323"></a><span id="l34.1323" class="difflineminus">-        NS_ASSERTION(localFile, &quot;An nsIRelativeFilePref has no file.&quot;);</span>
<a href="#l34.1324"></a><span id="l34.1324" class="difflineminus">-        if (localFile)</span>
<a href="#l34.1325"></a><span id="l34.1325" class="difflineminus">-          gotRelPref = true;</span>
<a href="#l34.1326"></a><span id="l34.1326" class="difflineminus">-    }</span>
<a href="#l34.1327"></a><span id="l34.1327" class="difflineplus">+  // Get the relative first</span>
<a href="#l34.1328"></a><span id="l34.1328" class="difflineplus">+  nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref;</span>
<a href="#l34.1329"></a><span id="l34.1329" class="difflineplus">+  prefBranch-&gt;GetComplexValue(relPrefName, NS_GET_IID(nsIRelativeFilePref),</span>
<a href="#l34.1330"></a><span id="l34.1330" class="difflineplus">+                              getter_AddRefs(relFilePref));</span>
<a href="#l34.1331"></a><span id="l34.1331" class="difflineplus">+  if (relFilePref) {</span>
<a href="#l34.1332"></a><span id="l34.1332" class="difflineplus">+    relFilePref-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l34.1333"></a><span id="l34.1333" class="difflineplus">+    NS_ASSERTION(localFile, &quot;An nsIRelativeFilePref has no file.&quot;);</span>
<a href="#l34.1334"></a><span id="l34.1334" class="difflineplus">+    if (localFile) gotRelPref = true;</span>
<a href="#l34.1335"></a><span id="l34.1335" class="difflineplus">+  }</span>
<a href="#l34.1336"></a><span id="l34.1336"> </span>
<a href="#l34.1337"></a><span id="l34.1337" class="difflineminus">-    // If not, get the old absolute</span>
<a href="#l34.1338"></a><span id="l34.1338" class="difflineminus">-    if (!localFile) {</span>
<a href="#l34.1339"></a><span id="l34.1339" class="difflineminus">-        prefBranch-&gt;GetComplexValue(absPrefName,</span>
<a href="#l34.1340"></a><span id="l34.1340" class="difflineminus">-                                    NS_GET_IID(nsIFile), getter_AddRefs(localFile));</span>
<a href="#l34.1341"></a><span id="l34.1341" class="difflineplus">+  // If not, get the old absolute</span>
<a href="#l34.1342"></a><span id="l34.1342" class="difflineplus">+  if (!localFile) {</span>
<a href="#l34.1343"></a><span id="l34.1343" class="difflineplus">+    prefBranch-&gt;GetComplexValue(absPrefName, NS_GET_IID(nsIFile),</span>
<a href="#l34.1344"></a><span id="l34.1344" class="difflineplus">+                                getter_AddRefs(localFile));</span>
<a href="#l34.1345"></a><span id="l34.1345"> </span>
<a href="#l34.1346"></a><span id="l34.1346" class="difflineminus">-        // If not, and given a dirServiceProp, use directory service.</span>
<a href="#l34.1347"></a><span id="l34.1347" class="difflineminus">-        if (!localFile &amp;&amp; dirServiceProp) {</span>
<a href="#l34.1348"></a><span id="l34.1348" class="difflineminus">-            nsCOMPtr&lt;nsIProperties&gt; dirService(do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l34.1349"></a><span id="l34.1349" class="difflineminus">-            if (!dirService) return NS_ERROR_FAILURE;</span>
<a href="#l34.1350"></a><span id="l34.1350" class="difflineminus">-            dirService-&gt;Get(dirServiceProp, NS_GET_IID(nsIFile), getter_AddRefs(localFile));</span>
<a href="#l34.1351"></a><span id="l34.1351" class="difflineminus">-            if (!localFile) return NS_ERROR_FAILURE;</span>
<a href="#l34.1352"></a><span id="l34.1352" class="difflineminus">-        }</span>
<a href="#l34.1353"></a><span id="l34.1353" class="difflineplus">+    // If not, and given a dirServiceProp, use directory service.</span>
<a href="#l34.1354"></a><span id="l34.1354" class="difflineplus">+    if (!localFile &amp;&amp; dirServiceProp) {</span>
<a href="#l34.1355"></a><span id="l34.1355" class="difflineplus">+      nsCOMPtr&lt;nsIProperties&gt; dirService(</span>
<a href="#l34.1356"></a><span id="l34.1356" class="difflineplus">+          do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l34.1357"></a><span id="l34.1357" class="difflineplus">+      if (!dirService) return NS_ERROR_FAILURE;</span>
<a href="#l34.1358"></a><span id="l34.1358" class="difflineplus">+      dirService-&gt;Get(dirServiceProp, NS_GET_IID(nsIFile),</span>
<a href="#l34.1359"></a><span id="l34.1359" class="difflineplus">+                      getter_AddRefs(localFile));</span>
<a href="#l34.1360"></a><span id="l34.1360" class="difflineplus">+      if (!localFile) return NS_ERROR_FAILURE;</span>
<a href="#l34.1361"></a><span id="l34.1361">     }</span>
<a href="#l34.1362"></a><span id="l34.1362" class="difflineplus">+  }</span>
<a href="#l34.1363"></a><span id="l34.1363"> </span>
<a href="#l34.1364"></a><span id="l34.1364" class="difflineminus">-    if (localFile) {</span>
<a href="#l34.1365"></a><span id="l34.1365" class="difflineminus">-        localFile-&gt;Normalize();</span>
<a href="#l34.1366"></a><span id="l34.1366" class="difflineminus">-        localFile.forget(aFile);</span>
<a href="#l34.1367"></a><span id="l34.1367" class="difflineminus">-        return NS_OK;</span>
<a href="#l34.1368"></a><span id="l34.1368" class="difflineminus">-    }</span>
<a href="#l34.1369"></a><span id="l34.1369" class="difflineplus">+  if (localFile) {</span>
<a href="#l34.1370"></a><span id="l34.1370" class="difflineplus">+    localFile-&gt;Normalize();</span>
<a href="#l34.1371"></a><span id="l34.1371" class="difflineplus">+    localFile.forget(aFile);</span>
<a href="#l34.1372"></a><span id="l34.1372" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.1373"></a><span id="l34.1373" class="difflineplus">+  }</span>
<a href="#l34.1374"></a><span id="l34.1374"> </span>
<a href="#l34.1375"></a><span id="l34.1375" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l34.1376"></a><span id="l34.1376" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l34.1377"></a><span id="l34.1377"> }</span>
<a href="#l34.1378"></a><span id="l34.1378"> </span>
<a href="#l34.1379"></a><span id="l34.1379"> NS_MSG_BASE nsresult NS_SetPersistentFile(const char *relPrefName,</span>
<a href="#l34.1380"></a><span id="l34.1380">                                           const char *absPrefName,</span>
<a href="#l34.1381"></a><span id="l34.1381">                                           nsIFile *aFile,</span>
<a href="#l34.1382"></a><span id="l34.1382" class="difflineminus">-                                          nsIPrefBranch *prefBranch)</span>
<a href="#l34.1383"></a><span id="l34.1383" class="difflineminus">-{</span>
<a href="#l34.1384"></a><span id="l34.1384" class="difflineminus">-    NS_ENSURE_ARG(relPrefName);</span>
<a href="#l34.1385"></a><span id="l34.1385" class="difflineminus">-    NS_ENSURE_ARG(absPrefName);</span>
<a href="#l34.1386"></a><span id="l34.1386" class="difflineminus">-    NS_ENSURE_ARG(aFile);</span>
<a href="#l34.1387"></a><span id="l34.1387" class="difflineplus">+                                          nsIPrefBranch *prefBranch) {</span>
<a href="#l34.1388"></a><span id="l34.1388" class="difflineplus">+  NS_ENSURE_ARG(relPrefName);</span>
<a href="#l34.1389"></a><span id="l34.1389" class="difflineplus">+  NS_ENSURE_ARG(absPrefName);</span>
<a href="#l34.1390"></a><span id="l34.1390" class="difflineplus">+  NS_ENSURE_ARG(aFile);</span>
<a href="#l34.1391"></a><span id="l34.1391"> </span>
<a href="#l34.1392"></a><span id="l34.1392" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; mainBranch;</span>
<a href="#l34.1393"></a><span id="l34.1393" class="difflineminus">-    if (!prefBranch) {</span>
<a href="#l34.1394"></a><span id="l34.1394" class="difflineminus">-        nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l34.1395"></a><span id="l34.1395" class="difflineminus">-        if (!prefService) return NS_ERROR_FAILURE;</span>
<a href="#l34.1396"></a><span id="l34.1396" class="difflineminus">-        prefService-&gt;GetBranch(nullptr, getter_AddRefs(mainBranch));</span>
<a href="#l34.1397"></a><span id="l34.1397" class="difflineminus">-        if (!mainBranch) return NS_ERROR_FAILURE;</span>
<a href="#l34.1398"></a><span id="l34.1398" class="difflineminus">-        prefBranch = mainBranch;</span>
<a href="#l34.1399"></a><span id="l34.1399" class="difflineminus">-    }</span>
<a href="#l34.1400"></a><span id="l34.1400" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; mainBranch;</span>
<a href="#l34.1401"></a><span id="l34.1401" class="difflineplus">+  if (!prefBranch) {</span>
<a href="#l34.1402"></a><span id="l34.1402" class="difflineplus">+    nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l34.1403"></a><span id="l34.1403" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l34.1404"></a><span id="l34.1404" class="difflineplus">+    if (!prefService) return NS_ERROR_FAILURE;</span>
<a href="#l34.1405"></a><span id="l34.1405" class="difflineplus">+    prefService-&gt;GetBranch(nullptr, getter_AddRefs(mainBranch));</span>
<a href="#l34.1406"></a><span id="l34.1406" class="difflineplus">+    if (!mainBranch) return NS_ERROR_FAILURE;</span>
<a href="#l34.1407"></a><span id="l34.1407" class="difflineplus">+    prefBranch = mainBranch;</span>
<a href="#l34.1408"></a><span id="l34.1408" class="difflineplus">+  }</span>
<a href="#l34.1409"></a><span id="l34.1409"> </span>
<a href="#l34.1410"></a><span id="l34.1410" class="difflineminus">-    // Write the absolute for backwards compatibilty's sake.</span>
<a href="#l34.1411"></a><span id="l34.1411" class="difflineminus">-    // Or, if aPath is on a different drive than the profile dir.</span>
<a href="#l34.1412"></a><span id="l34.1412" class="difflineminus">-    nsresult rv = prefBranch-&gt;SetComplexValue(absPrefName, NS_GET_IID(nsIFile), aFile);</span>
<a href="#l34.1413"></a><span id="l34.1413" class="difflineplus">+  // Write the absolute for backwards compatibilty's sake.</span>
<a href="#l34.1414"></a><span id="l34.1414" class="difflineplus">+  // Or, if aPath is on a different drive than the profile dir.</span>
<a href="#l34.1415"></a><span id="l34.1415" class="difflineplus">+  nsresult rv =</span>
<a href="#l34.1416"></a><span id="l34.1416" class="difflineplus">+      prefBranch-&gt;SetComplexValue(absPrefName, NS_GET_IID(nsIFile), aFile);</span>
<a href="#l34.1417"></a><span id="l34.1417"> </span>
<a href="#l34.1418"></a><span id="l34.1418" class="difflineminus">-    // Write the relative path.</span>
<a href="#l34.1419"></a><span id="l34.1419" class="difflineminus">-    nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref = new nsRelativeFilePref();</span>
<a href="#l34.1420"></a><span id="l34.1420" class="difflineminus">-    mozilla::Unused &lt;&lt; relFilePref-&gt;SetFile(aFile);</span>
<a href="#l34.1421"></a><span id="l34.1421" class="difflineminus">-    mozilla::Unused &lt;&lt; relFilePref-&gt;SetRelativeToKey(NS_LITERAL_CSTRING(NS_APP_USER_PROFILE_50_DIR));</span>
<a href="#l34.1422"></a><span id="l34.1422" class="difflineplus">+  // Write the relative path.</span>
<a href="#l34.1423"></a><span id="l34.1423" class="difflineplus">+  nsCOMPtr&lt;nsIRelativeFilePref&gt; relFilePref = new nsRelativeFilePref();</span>
<a href="#l34.1424"></a><span id="l34.1424" class="difflineplus">+  mozilla::Unused &lt;&lt; relFilePref-&gt;SetFile(aFile);</span>
<a href="#l34.1425"></a><span id="l34.1425" class="difflineplus">+  mozilla::Unused &lt;&lt; relFilePref-&gt;SetRelativeToKey(</span>
<a href="#l34.1426"></a><span id="l34.1426" class="difflineplus">+      NS_LITERAL_CSTRING(NS_APP_USER_PROFILE_50_DIR));</span>
<a href="#l34.1427"></a><span id="l34.1427"> </span>
<a href="#l34.1428"></a><span id="l34.1428" class="difflineminus">-    nsresult rv2 = prefBranch-&gt;SetComplexValue(relPrefName, NS_GET_IID(nsIRelativeFilePref), relFilePref);</span>
<a href="#l34.1429"></a><span id="l34.1429" class="difflineminus">-    if (NS_FAILED(rv2) &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l34.1430"></a><span id="l34.1430" class="difflineminus">-        prefBranch-&gt;ClearUserPref(relPrefName);</span>
<a href="#l34.1431"></a><span id="l34.1431" class="difflineplus">+  nsresult rv2 = prefBranch-&gt;SetComplexValue(</span>
<a href="#l34.1432"></a><span id="l34.1432" class="difflineplus">+      relPrefName, NS_GET_IID(nsIRelativeFilePref), relFilePref);</span>
<a href="#l34.1433"></a><span id="l34.1433" class="difflineplus">+  if (NS_FAILED(rv2) &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l34.1434"></a><span id="l34.1434" class="difflineplus">+    prefBranch-&gt;ClearUserPref(relPrefName);</span>
<a href="#l34.1435"></a><span id="l34.1435"> </span>
<a href="#l34.1436"></a><span id="l34.1436" class="difflineminus">-    return rv;</span>
<a href="#l34.1437"></a><span id="l34.1437" class="difflineplus">+  return rv;</span>
<a href="#l34.1438"></a><span id="l34.1438"> }</span>
<a href="#l34.1439"></a><span id="l34.1439"> </span>
<a href="#l34.1440"></a><span id="l34.1440" class="difflineminus">-NS_MSG_BASE nsresult NS_GetUnicharPreferenceWithDefault(nsIPrefBranch *prefBranch,  //can be null, if so uses the root branch</span>
<a href="#l34.1441"></a><span id="l34.1441" class="difflineminus">-                                                        const char *prefName,</span>
<a href="#l34.1442"></a><span id="l34.1442" class="difflineminus">-                                                        const nsAString&amp; defValue,</span>
<a href="#l34.1443"></a><span id="l34.1443" class="difflineminus">-                                                        nsAString&amp; prefValue)</span>
<a href="#l34.1444"></a><span id="l34.1444" class="difflineminus">-{</span>
<a href="#l34.1445"></a><span id="l34.1445" class="difflineplus">+NS_MSG_BASE nsresult NS_GetUnicharPreferenceWithDefault(</span>
<a href="#l34.1446"></a><span id="l34.1446" class="difflineplus">+    nsIPrefBranch *prefBranch,  // can be null, if so uses the root branch</span>
<a href="#l34.1447"></a><span id="l34.1447" class="difflineplus">+    const char *prefName, const nsAString &amp;defValue, nsAString &amp;prefValue) {</span>
<a href="#l34.1448"></a><span id="l34.1448">   NS_ENSURE_ARG(prefName);</span>
<a href="#l34.1449"></a><span id="l34.1449"> </span>
<a href="#l34.1450"></a><span id="l34.1450">   nsCOMPtr&lt;nsIPrefBranch&gt; pbr;</span>
<a href="#l34.1451"></a><span id="l34.1451" class="difflineminus">-  if(!prefBranch) {</span>
<a href="#l34.1452"></a><span id="l34.1452" class="difflineplus">+  if (!prefBranch) {</span>
<a href="#l34.1453"></a><span id="l34.1453">     pbr = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l34.1454"></a><span id="l34.1454">     prefBranch = pbr;</span>
<a href="#l34.1455"></a><span id="l34.1455">   }</span>
<a href="#l34.1456"></a><span id="l34.1456"> </span>
<a href="#l34.1457"></a><span id="l34.1457">   nsCString valueUtf8;</span>
<a href="#l34.1458"></a><span id="l34.1458" class="difflineminus">-  nsresult rv = prefBranch-&gt;GetStringPref(prefName, EmptyCString(), 0, valueUtf8);</span>
<a href="#l34.1459"></a><span id="l34.1459" class="difflineplus">+  nsresult rv =</span>
<a href="#l34.1460"></a><span id="l34.1460" class="difflineplus">+      prefBranch-&gt;GetStringPref(prefName, EmptyCString(), 0, valueUtf8);</span>
<a href="#l34.1461"></a><span id="l34.1461">   if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1462"></a><span id="l34.1462">     CopyUTF8toUTF16(valueUtf8, prefValue);</span>
<a href="#l34.1463"></a><span id="l34.1463">   else</span>
<a href="#l34.1464"></a><span id="l34.1464">     prefValue = defValue;</span>
<a href="#l34.1465"></a><span id="l34.1465">   return NS_OK;</span>
<a href="#l34.1466"></a><span id="l34.1466"> }</span>
<a href="#l34.1467"></a><span id="l34.1467"> </span>
<a href="#l34.1468"></a><span id="l34.1468" class="difflineminus">-NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreferenceWithDefault(nsIPrefBranch *prefBranch,  //can be null, if so uses the root branch</span>
<a href="#l34.1469"></a><span id="l34.1469" class="difflineminus">-                                                                 const char *prefName,</span>
<a href="#l34.1470"></a><span id="l34.1470" class="difflineminus">-                                                                 const nsAString&amp; defValue,</span>
<a href="#l34.1471"></a><span id="l34.1471" class="difflineminus">-                                                                 nsAString&amp; prefValue)</span>
<a href="#l34.1472"></a><span id="l34.1472" class="difflineminus">-{</span>
<a href="#l34.1473"></a><span id="l34.1473" class="difflineminus">-    NS_ENSURE_ARG(prefName);</span>
<a href="#l34.1474"></a><span id="l34.1474" class="difflineplus">+NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l34.1475"></a><span id="l34.1475" class="difflineplus">+    nsIPrefBranch *prefBranch,  // can be null, if so uses the root branch</span>
<a href="#l34.1476"></a><span id="l34.1476" class="difflineplus">+    const char *prefName, const nsAString &amp;defValue, nsAString &amp;prefValue) {</span>
<a href="#l34.1477"></a><span id="l34.1477" class="difflineplus">+  NS_ENSURE_ARG(prefName);</span>
<a href="#l34.1478"></a><span id="l34.1478"> </span>
<a href="#l34.1479"></a><span id="l34.1479" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pbr;</span>
<a href="#l34.1480"></a><span id="l34.1480" class="difflineminus">-    if(!prefBranch) {</span>
<a href="#l34.1481"></a><span id="l34.1481" class="difflineminus">-        pbr = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l34.1482"></a><span id="l34.1482" class="difflineminus">-        prefBranch = pbr;</span>
<a href="#l34.1483"></a><span id="l34.1483" class="difflineminus">-    }</span>
<a href="#l34.1484"></a><span id="l34.1484" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pbr;</span>
<a href="#l34.1485"></a><span id="l34.1485" class="difflineplus">+  if (!prefBranch) {</span>
<a href="#l34.1486"></a><span id="l34.1486" class="difflineplus">+    pbr = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l34.1487"></a><span id="l34.1487" class="difflineplus">+    prefBranch = pbr;</span>
<a href="#l34.1488"></a><span id="l34.1488" class="difflineplus">+  }</span>
<a href="#l34.1489"></a><span id="l34.1489"> </span>
<a href="#l34.1490"></a><span id="l34.1490" class="difflineminus">-    nsCOMPtr&lt;nsIPrefLocalizedString&gt; str;</span>
<a href="#l34.1491"></a><span id="l34.1491" class="difflineminus">-    nsresult rv = prefBranch-&gt;GetComplexValue(prefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(str));</span>
<a href="#l34.1492"></a><span id="l34.1492" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1493"></a><span id="l34.1493" class="difflineminus">-  {</span>
<a href="#l34.1494"></a><span id="l34.1494" class="difflineplus">+  nsCOMPtr&lt;nsIPrefLocalizedString&gt; str;</span>
<a href="#l34.1495"></a><span id="l34.1495" class="difflineplus">+  nsresult rv = prefBranch-&gt;GetComplexValue(</span>
<a href="#l34.1496"></a><span id="l34.1496" class="difflineplus">+      prefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(str));</span>
<a href="#l34.1497"></a><span id="l34.1497" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.1498"></a><span id="l34.1498">     nsString tmpValue;</span>
<a href="#l34.1499"></a><span id="l34.1499">     str-&gt;ToString(getter_Copies(tmpValue));</span>
<a href="#l34.1500"></a><span id="l34.1500">     prefValue.Assign(tmpValue);</span>
<a href="#l34.1501"></a><span id="l34.1501" class="difflineminus">-  }</span>
<a href="#l34.1502"></a><span id="l34.1502" class="difflineminus">-    else</span>
<a href="#l34.1503"></a><span id="l34.1503" class="difflineminus">-        prefValue = defValue;</span>
<a href="#l34.1504"></a><span id="l34.1504" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.1505"></a><span id="l34.1505" class="difflineplus">+  } else</span>
<a href="#l34.1506"></a><span id="l34.1506" class="difflineplus">+    prefValue = defValue;</span>
<a href="#l34.1507"></a><span id="l34.1507" class="difflineplus">+  return NS_OK;</span>
<a href="#l34.1508"></a><span id="l34.1508"> }</span>
<a href="#l34.1509"></a><span id="l34.1509"> </span>
<a href="#l34.1510"></a><span id="l34.1510" class="difflineminus">-NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreference(nsIPrefBranch *prefBranch,  //can be null, if so uses the root branch</span>
<a href="#l34.1511"></a><span id="l34.1511" class="difflineminus">-                                                      const char *prefName,</span>
<a href="#l34.1512"></a><span id="l34.1512" class="difflineminus">-                                                      nsAString&amp; prefValue)</span>
<a href="#l34.1513"></a><span id="l34.1513" class="difflineminus">-{</span>
<a href="#l34.1514"></a><span id="l34.1514" class="difflineplus">+NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreference(</span>
<a href="#l34.1515"></a><span id="l34.1515" class="difflineplus">+    nsIPrefBranch *prefBranch,  // can be null, if so uses the root branch</span>
<a href="#l34.1516"></a><span id="l34.1516" class="difflineplus">+    const char *prefName, nsAString &amp;prefValue) {</span>
<a href="#l34.1517"></a><span id="l34.1517">   NS_ENSURE_ARG_POINTER(prefName);</span>
<a href="#l34.1518"></a><span id="l34.1518"> </span>
<a href="#l34.1519"></a><span id="l34.1519">   nsCOMPtr&lt;nsIPrefBranch&gt; pbr;</span>
<a href="#l34.1520"></a><span id="l34.1520">   if (!prefBranch) {</span>
<a href="#l34.1521"></a><span id="l34.1521">     pbr = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l34.1522"></a><span id="l34.1522">     prefBranch = pbr;</span>
<a href="#l34.1523"></a><span id="l34.1523">   }</span>
<a href="#l34.1524"></a><span id="l34.1524"> </span>
<a href="#l34.1525"></a><span id="l34.1525">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; str;</span>
<a href="#l34.1526"></a><span id="l34.1526" class="difflineminus">-  nsresult rv = prefBranch-&gt;GetComplexValue(prefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(str));</span>
<a href="#l34.1527"></a><span id="l34.1527" class="difflineplus">+  nsresult rv = prefBranch-&gt;GetComplexValue(</span>
<a href="#l34.1528"></a><span id="l34.1528" class="difflineplus">+      prefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(str));</span>
<a href="#l34.1529"></a><span id="l34.1529">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1530"></a><span id="l34.1530"> </span>
<a href="#l34.1531"></a><span id="l34.1531">   nsString tmpValue;</span>
<a href="#l34.1532"></a><span id="l34.1532">   str-&gt;ToString(getter_Copies(tmpValue));</span>
<a href="#l34.1533"></a><span id="l34.1533">   prefValue.Assign(tmpValue);</span>
<a href="#l34.1534"></a><span id="l34.1534">   return NS_OK;</span>
<a href="#l34.1535"></a><span id="l34.1535"> }</span>
<a href="#l34.1536"></a><span id="l34.1536"> </span>
<a href="#l34.1537"></a><span id="l34.1537" class="difflineminus">-void PRTime2Seconds(PRTime prTime, uint32_t *seconds)</span>
<a href="#l34.1538"></a><span id="l34.1538" class="difflineminus">-{</span>
<a href="#l34.1539"></a><span id="l34.1539" class="difflineplus">+void PRTime2Seconds(PRTime prTime, uint32_t *seconds) {</span>
<a href="#l34.1540"></a><span id="l34.1540">   *seconds = (uint32_t)(prTime / PR_USEC_PER_SEC);</span>
<a href="#l34.1541"></a><span id="l34.1541"> }</span>
<a href="#l34.1542"></a><span id="l34.1542"> </span>
<a href="#l34.1543"></a><span id="l34.1543" class="difflineminus">-void PRTime2Seconds(PRTime prTime, int32_t *seconds)</span>
<a href="#l34.1544"></a><span id="l34.1544" class="difflineminus">-{</span>
<a href="#l34.1545"></a><span id="l34.1545" class="difflineplus">+void PRTime2Seconds(PRTime prTime, int32_t *seconds) {</span>
<a href="#l34.1546"></a><span id="l34.1546">   *seconds = (int32_t)(prTime / PR_USEC_PER_SEC);</span>
<a href="#l34.1547"></a><span id="l34.1547"> }</span>
<a href="#l34.1548"></a><span id="l34.1548"> </span>
<a href="#l34.1549"></a><span id="l34.1549" class="difflineminus">-void Seconds2PRTime(uint32_t seconds, PRTime *prTime)</span>
<a href="#l34.1550"></a><span id="l34.1550" class="difflineminus">-{</span>
<a href="#l34.1551"></a><span id="l34.1551" class="difflineplus">+void Seconds2PRTime(uint32_t seconds, PRTime *prTime) {</span>
<a href="#l34.1552"></a><span id="l34.1552">   *prTime = (PRTime)seconds * PR_USEC_PER_SEC;</span>
<a href="#l34.1553"></a><span id="l34.1553"> }</span>
<a href="#l34.1554"></a><span id="l34.1554"> </span>
<a href="#l34.1555"></a><span id="l34.1555" class="difflineminus">-nsresult GetSummaryFileLocation(nsIFile* fileLocation, nsIFile** summaryLocation)</span>
<a href="#l34.1556"></a><span id="l34.1556" class="difflineminus">-{</span>
<a href="#l34.1557"></a><span id="l34.1557" class="difflineplus">+nsresult GetSummaryFileLocation(nsIFile *fileLocation,</span>
<a href="#l34.1558"></a><span id="l34.1558" class="difflineplus">+                                nsIFile **summaryLocation) {</span>
<a href="#l34.1559"></a><span id="l34.1559">   nsresult rv;</span>
<a href="#l34.1560"></a><span id="l34.1560" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; newSummaryLocation = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l34.1561"></a><span id="l34.1561" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; newSummaryLocation =</span>
<a href="#l34.1562"></a><span id="l34.1562" class="difflineplus">+      do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l34.1563"></a><span id="l34.1563">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1564"></a><span id="l34.1564"> </span>
<a href="#l34.1565"></a><span id="l34.1565">   newSummaryLocation-&gt;InitWithFile(fileLocation);</span>
<a href="#l34.1566"></a><span id="l34.1566">   nsString fileName;</span>
<a href="#l34.1567"></a><span id="l34.1567"> </span>
<a href="#l34.1568"></a><span id="l34.1568">   rv = newSummaryLocation-&gt;GetLeafName(fileName);</span>
<a href="#l34.1569"></a><span id="l34.1569" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.1570"></a><span id="l34.1570" class="difflineminus">-    return rv;</span>
<a href="#l34.1571"></a><span id="l34.1571" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.1572"></a><span id="l34.1572"> </span>
<a href="#l34.1573"></a><span id="l34.1573">   fileName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l34.1574"></a><span id="l34.1574">   rv = newSummaryLocation-&gt;SetLeafName(fileName);</span>
<a href="#l34.1575"></a><span id="l34.1575">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1576"></a><span id="l34.1576"> </span>
<a href="#l34.1577"></a><span id="l34.1577">   newSummaryLocation.forget(summaryLocation);</span>
<a href="#l34.1578"></a><span id="l34.1578">   return NS_OK;</span>
<a href="#l34.1579"></a><span id="l34.1579"> }</span>
<a href="#l34.1580"></a><span id="l34.1580"> </span>
<a href="#l34.1581"></a><span id="l34.1581" class="difflineminus">-void MsgGenerateNowStr(nsACString &amp;nowStr)</span>
<a href="#l34.1582"></a><span id="l34.1582" class="difflineminus">-{</span>
<a href="#l34.1583"></a><span id="l34.1583" class="difflineplus">+void MsgGenerateNowStr(nsACString &amp;nowStr) {</span>
<a href="#l34.1584"></a><span id="l34.1584">   char dateBuf[100];</span>
<a href="#l34.1585"></a><span id="l34.1585">   dateBuf[0] = '\0';</span>
<a href="#l34.1586"></a><span id="l34.1586">   PRExplodedTime exploded;</span>
<a href="#l34.1587"></a><span id="l34.1587">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l34.1588"></a><span id="l34.1588" class="difflineminus">-  PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;exploded);</span>
<a href="#l34.1589"></a><span id="l34.1589" class="difflineplus">+  PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l34.1590"></a><span id="l34.1590" class="difflineplus">+                         &amp;exploded);</span>
<a href="#l34.1591"></a><span id="l34.1591">   nowStr.Assign(dateBuf);</span>
<a href="#l34.1592"></a><span id="l34.1592"> }</span>
<a href="#l34.1593"></a><span id="l34.1593"> </span>
<a href="#l34.1594"></a><span id="l34.1594" class="difflineminus">-</span>
<a href="#l34.1595"></a><span id="l34.1595"> // Gets a special directory and appends the supplied file name onto it.</span>
<a href="#l34.1596"></a><span id="l34.1596" class="difflineminus">-nsresult GetSpecialDirectoryWithFileName(const char* specialDirName,</span>
<a href="#l34.1597"></a><span id="l34.1597" class="difflineminus">-                                         const char* fileName,</span>
<a href="#l34.1598"></a><span id="l34.1598" class="difflineminus">-                                         nsIFile** result)</span>
<a href="#l34.1599"></a><span id="l34.1599" class="difflineminus">-{</span>
<a href="#l34.1600"></a><span id="l34.1600" class="difflineplus">+nsresult GetSpecialDirectoryWithFileName(const char *specialDirName,</span>
<a href="#l34.1601"></a><span id="l34.1601" class="difflineplus">+                                         const char *fileName,</span>
<a href="#l34.1602"></a><span id="l34.1602" class="difflineplus">+                                         nsIFile **result) {</span>
<a href="#l34.1603"></a><span id="l34.1603">   nsresult rv = NS_GetSpecialDirectory(specialDirName, result);</span>
<a href="#l34.1604"></a><span id="l34.1604">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1605"></a><span id="l34.1605"> </span>
<a href="#l34.1606"></a><span id="l34.1606">   return (*result)-&gt;AppendNative(nsDependentCString(fileName));</span>
<a href="#l34.1607"></a><span id="l34.1607"> }</span>
<a href="#l34.1608"></a><span id="l34.1608"> </span>
<a href="#l34.1609"></a><span id="l34.1609"> // Cleans up temp files with matching names</span>
<a href="#l34.1610"></a><span id="l34.1610" class="difflineminus">-nsresult MsgCleanupTempFiles(const char *fileName, const char *extension)</span>
<a href="#l34.1611"></a><span id="l34.1611" class="difflineminus">-{</span>
<a href="#l34.1612"></a><span id="l34.1612" class="difflineplus">+nsresult MsgCleanupTempFiles(const char *fileName, const char *extension) {</span>
<a href="#l34.1613"></a><span id="l34.1613">   nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l34.1614"></a><span id="l34.1614">   nsCString rootName(fileName);</span>
<a href="#l34.1615"></a><span id="l34.1615">   rootName.Append('.');</span>
<a href="#l34.1616"></a><span id="l34.1616">   rootName.Append(extension);</span>
<a href="#l34.1617"></a><span id="l34.1617" class="difflineminus">-  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l34.1618"></a><span id="l34.1618" class="difflineminus">-                                                rootName.get(),</span>
<a href="#l34.1619"></a><span id="l34.1619" class="difflineplus">+  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, rootName.get(),</span>
<a href="#l34.1620"></a><span id="l34.1620">                                                 getter_AddRefs(tmpFile));</span>
<a href="#l34.1621"></a><span id="l34.1621"> </span>
<a href="#l34.1622"></a><span id="l34.1622">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1623"></a><span id="l34.1623">   int index = 1;</span>
<a href="#l34.1624"></a><span id="l34.1624">   bool exists;</span>
<a href="#l34.1625"></a><span id="l34.1625" class="difflineminus">-  do</span>
<a href="#l34.1626"></a><span id="l34.1626" class="difflineminus">-  {</span>
<a href="#l34.1627"></a><span id="l34.1627" class="difflineplus">+  do {</span>
<a href="#l34.1628"></a><span id="l34.1628">     tmpFile-&gt;Exists(&amp;exists);</span>
<a href="#l34.1629"></a><span id="l34.1629" class="difflineminus">-    if (exists)</span>
<a href="#l34.1630"></a><span id="l34.1630" class="difflineminus">-    {</span>
<a href="#l34.1631"></a><span id="l34.1631" class="difflineplus">+    if (exists) {</span>
<a href="#l34.1632"></a><span id="l34.1632">       tmpFile-&gt;Remove(false);</span>
<a href="#l34.1633"></a><span id="l34.1633">       nsCString leafName(fileName);</span>
<a href="#l34.1634"></a><span id="l34.1634">       leafName.Append('-');</span>
<a href="#l34.1635"></a><span id="l34.1635">       leafName.AppendInt(index);</span>
<a href="#l34.1636"></a><span id="l34.1636">       leafName.Append('.');</span>
<a href="#l34.1637"></a><span id="l34.1637">       leafName.Append(extension);</span>
<a href="#l34.1638"></a><span id="l34.1638" class="difflineminus">-        // start with &quot;Picture-1.jpg&quot; after &quot;Picture.jpg&quot; exists</span>
<a href="#l34.1639"></a><span id="l34.1639" class="difflineplus">+      // start with &quot;Picture-1.jpg&quot; after &quot;Picture.jpg&quot; exists</span>
<a href="#l34.1640"></a><span id="l34.1640">       tmpFile-&gt;SetNativeLeafName(leafName);</span>
<a href="#l34.1641"></a><span id="l34.1641">     }</span>
<a href="#l34.1642"></a><span id="l34.1642" class="difflineminus">-  }</span>
<a href="#l34.1643"></a><span id="l34.1643" class="difflineminus">-  while (exists &amp;&amp; ++index &lt; 10000);</span>
<a href="#l34.1644"></a><span id="l34.1644" class="difflineplus">+  } while (exists &amp;&amp; ++index &lt; 10000);</span>
<a href="#l34.1645"></a><span id="l34.1645">   return NS_OK;</span>
<a href="#l34.1646"></a><span id="l34.1646"> }</span>
<a href="#l34.1647"></a><span id="l34.1647"> </span>
<a href="#l34.1648"></a><span id="l34.1648" class="difflineminus">-nsresult MsgGetFileStream(nsIFile *file, nsIOutputStream **fileStream)</span>
<a href="#l34.1649"></a><span id="l34.1649" class="difflineminus">-{</span>
<a href="#l34.1650"></a><span id="l34.1650" class="difflineplus">+nsresult MsgGetFileStream(nsIFile *file, nsIOutputStream **fileStream) {</span>
<a href="#l34.1651"></a><span id="l34.1651">   nsMsgFileStream *newFileStream = new nsMsgFileStream;</span>
<a href="#l34.1652"></a><span id="l34.1652">   NS_ENSURE_TRUE(newFileStream, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l34.1653"></a><span id="l34.1653">   nsresult rv = newFileStream-&gt;InitWithFile(file);</span>
<a href="#l34.1654"></a><span id="l34.1654">   if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1655"></a><span id="l34.1655" class="difflineminus">-    rv = newFileStream-&gt;QueryInterface(NS_GET_IID(nsIOutputStream), (void **) fileStream);</span>
<a href="#l34.1656"></a><span id="l34.1656" class="difflineplus">+    rv = newFileStream-&gt;QueryInterface(NS_GET_IID(nsIOutputStream),</span>
<a href="#l34.1657"></a><span id="l34.1657" class="difflineplus">+                                       (void **)fileStream);</span>
<a href="#l34.1658"></a><span id="l34.1658">   return rv;</span>
<a href="#l34.1659"></a><span id="l34.1659"> }</span>
<a href="#l34.1660"></a><span id="l34.1660"> </span>
<a href="#l34.1661"></a><span id="l34.1661" class="difflineminus">-nsresult MsgReopenFileStream(nsIFile *file, nsIInputStream *fileStream)</span>
<a href="#l34.1662"></a><span id="l34.1662" class="difflineminus">-{</span>
<a href="#l34.1663"></a><span id="l34.1663" class="difflineplus">+nsresult MsgReopenFileStream(nsIFile *file, nsIInputStream *fileStream) {</span>
<a href="#l34.1664"></a><span id="l34.1664">   nsMsgFileStream *msgFileStream = static_cast&lt;nsMsgFileStream *&gt;(fileStream);</span>
<a href="#l34.1665"></a><span id="l34.1665">   if (msgFileStream)</span>
<a href="#l34.1666"></a><span id="l34.1666">     return msgFileStream-&gt;InitWithFile(file);</span>
<a href="#l34.1667"></a><span id="l34.1667">   else</span>
<a href="#l34.1668"></a><span id="l34.1668">     return NS_ERROR_FAILURE;</span>
<a href="#l34.1669"></a><span id="l34.1669"> }</span>
<a href="#l34.1670"></a><span id="l34.1670"> </span>
<a href="#l34.1671"></a><span id="l34.1671"> nsresult MsgNewBufferedFileOutputStream(nsIOutputStream **aResult,</span>
<a href="#l34.1672"></a><span id="l34.1672" class="difflineminus">-                                        nsIFile* aFile,</span>
<a href="#l34.1673"></a><span id="l34.1673" class="difflineminus">-                                        int32_t aIOFlags,</span>
<a href="#l34.1674"></a><span id="l34.1674" class="difflineminus">-                                        int32_t aPerm)</span>
<a href="#l34.1675"></a><span id="l34.1675" class="difflineminus">-{</span>
<a href="#l34.1676"></a><span id="l34.1676" class="difflineplus">+                                        nsIFile *aFile, int32_t aIOFlags,</span>
<a href="#l34.1677"></a><span id="l34.1677" class="difflineplus">+                                        int32_t aPerm) {</span>
<a href="#l34.1678"></a><span id="l34.1678">   nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l34.1679"></a><span id="l34.1679" class="difflineminus">-  nsresult rv = NS_NewLocalFileOutputStream(getter_AddRefs(stream), aFile, aIOFlags, aPerm);</span>
<a href="#l34.1680"></a><span id="l34.1680" class="difflineplus">+  nsresult rv = NS_NewLocalFileOutputStream(getter_AddRefs(stream), aFile,</span>
<a href="#l34.1681"></a><span id="l34.1681" class="difflineplus">+                                            aIOFlags, aPerm);</span>
<a href="#l34.1682"></a><span id="l34.1682">   if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1683"></a><span id="l34.1683" class="difflineminus">-    rv = NS_NewBufferedOutputStream(aResult, stream.forget(), FILE_IO_BUFFER_SIZE);</span>
<a href="#l34.1684"></a><span id="l34.1684" class="difflineplus">+    rv = NS_NewBufferedOutputStream(aResult, stream.forget(),</span>
<a href="#l34.1685"></a><span id="l34.1685" class="difflineplus">+                                    FILE_IO_BUFFER_SIZE);</span>
<a href="#l34.1686"></a><span id="l34.1686">   return rv;</span>
<a href="#l34.1687"></a><span id="l34.1687"> }</span>
<a href="#l34.1688"></a><span id="l34.1688"> </span>
<a href="#l34.1689"></a><span id="l34.1689"> nsresult MsgNewSafeBufferedFileOutputStream(nsIOutputStream **aResult,</span>
<a href="#l34.1690"></a><span id="l34.1690" class="difflineminus">-                                        nsIFile* aFile,</span>
<a href="#l34.1691"></a><span id="l34.1691" class="difflineminus">-                                        int32_t aIOFlags,</span>
<a href="#l34.1692"></a><span id="l34.1692" class="difflineminus">-                                        int32_t aPerm)</span>
<a href="#l34.1693"></a><span id="l34.1693" class="difflineminus">-{</span>
<a href="#l34.1694"></a><span id="l34.1694" class="difflineplus">+                                            nsIFile *aFile, int32_t aIOFlags,</span>
<a href="#l34.1695"></a><span id="l34.1695" class="difflineplus">+                                            int32_t aPerm) {</span>
<a href="#l34.1696"></a><span id="l34.1696">   nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l34.1697"></a><span id="l34.1697" class="difflineminus">-  nsresult rv = NS_NewSafeLocalFileOutputStream(getter_AddRefs(stream), aFile, aIOFlags, aPerm);</span>
<a href="#l34.1698"></a><span id="l34.1698" class="difflineplus">+  nsresult rv = NS_NewSafeLocalFileOutputStream(getter_AddRefs(stream), aFile,</span>
<a href="#l34.1699"></a><span id="l34.1699" class="difflineplus">+                                                aIOFlags, aPerm);</span>
<a href="#l34.1700"></a><span id="l34.1700">   if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1701"></a><span id="l34.1701" class="difflineminus">-    rv = NS_NewBufferedOutputStream(aResult, stream.forget(), FILE_IO_BUFFER_SIZE);</span>
<a href="#l34.1702"></a><span id="l34.1702" class="difflineplus">+    rv = NS_NewBufferedOutputStream(aResult, stream.forget(),</span>
<a href="#l34.1703"></a><span id="l34.1703" class="difflineplus">+                                    FILE_IO_BUFFER_SIZE);</span>
<a href="#l34.1704"></a><span id="l34.1704">   return rv;</span>
<a href="#l34.1705"></a><span id="l34.1705"> }</span>
<a href="#l34.1706"></a><span id="l34.1706"> </span>
<a href="#l34.1707"></a><span id="l34.1707" class="difflineminus">-bool MsgFindKeyword(const nsCString &amp;keyword, nsCString &amp;keywords, int32_t *aStartOfKeyword, int32_t *aLength)</span>
<a href="#l34.1708"></a><span id="l34.1708" class="difflineminus">-{</span>
<a href="#l34.1709"></a><span id="l34.1709" class="difflineplus">+bool MsgFindKeyword(const nsCString &amp;keyword, nsCString &amp;keywords,</span>
<a href="#l34.1710"></a><span id="l34.1710" class="difflineplus">+                    int32_t *aStartOfKeyword, int32_t *aLength) {</span>
<a href="#l34.1711"></a><span id="l34.1711"> // nsTString_CharT::Find(const nsCString&amp; aString,</span>
<a href="#l34.1712"></a><span id="l34.1712"> //                       bool aIgnoreCase=false,</span>
<a href="#l34.1713"></a><span id="l34.1713"> //                       int32_t aOffset=0,</span>
<a href="#l34.1714"></a><span id="l34.1714"> //                       int32_t aCount=-1 ) const;</span>
<a href="#l34.1715"></a><span id="l34.1715" class="difflineminus">-#define FIND_KEYWORD(keywords,keyword,offset) ((keywords).Find((keyword), false, (offset)))</span>
<a href="#l34.1716"></a><span id="l34.1716" class="difflineplus">+#define FIND_KEYWORD(keywords, keyword, offset) \</span>
<a href="#l34.1717"></a><span id="l34.1717" class="difflineplus">+  ((keywords).Find((keyword), false, (offset)))</span>
<a href="#l34.1718"></a><span id="l34.1718">   // 'keyword' is the single keyword we're looking for</span>
<a href="#l34.1719"></a><span id="l34.1719">   // 'keywords' is a space delimited list of keywords to be searched,</span>
<a href="#l34.1720"></a><span id="l34.1720">   // which may be just a single keyword or even be empty</span>
<a href="#l34.1721"></a><span id="l34.1721">   const int32_t kKeywordLen = keyword.Length();</span>
<a href="#l34.1722"></a><span id="l34.1722" class="difflineminus">-  const char* start = keywords.BeginReading();</span>
<a href="#l34.1723"></a><span id="l34.1723" class="difflineminus">-  const char* end = keywords.EndReading();</span>
<a href="#l34.1724"></a><span id="l34.1724" class="difflineplus">+  const char *start = keywords.BeginReading();</span>
<a href="#l34.1725"></a><span id="l34.1725" class="difflineplus">+  const char *end = keywords.EndReading();</span>
<a href="#l34.1726"></a><span id="l34.1726">   *aStartOfKeyword = FIND_KEYWORD(keywords, keyword, 0);</span>
<a href="#l34.1727"></a><span id="l34.1727" class="difflineminus">-  while (*aStartOfKeyword &gt;= 0)</span>
<a href="#l34.1728"></a><span id="l34.1728" class="difflineminus">-  {</span>
<a href="#l34.1729"></a><span id="l34.1729" class="difflineminus">-    const char* matchStart = start + *aStartOfKeyword;</span>
<a href="#l34.1730"></a><span id="l34.1730" class="difflineminus">-    const char* matchEnd = matchStart + kKeywordLen;</span>
<a href="#l34.1731"></a><span id="l34.1731" class="difflineplus">+  while (*aStartOfKeyword &gt;= 0) {</span>
<a href="#l34.1732"></a><span id="l34.1732" class="difflineplus">+    const char *matchStart = start + *aStartOfKeyword;</span>
<a href="#l34.1733"></a><span id="l34.1733" class="difflineplus">+    const char *matchEnd = matchStart + kKeywordLen;</span>
<a href="#l34.1734"></a><span id="l34.1734">     // For a real match, matchStart must be the start of keywords or preceded</span>
<a href="#l34.1735"></a><span id="l34.1735">     // by a space and matchEnd must be the end of keywords or point to a space.</span>
<a href="#l34.1736"></a><span id="l34.1736">     if ((matchStart == start || *(matchStart - 1) == ' ') &amp;&amp;</span>
<a href="#l34.1737"></a><span id="l34.1737" class="difflineminus">-        (matchEnd == end || *matchEnd == ' '))</span>
<a href="#l34.1738"></a><span id="l34.1738" class="difflineminus">-    {</span>
<a href="#l34.1739"></a><span id="l34.1739" class="difflineplus">+        (matchEnd == end || *matchEnd == ' ')) {</span>
<a href="#l34.1740"></a><span id="l34.1740">       *aLength = kKeywordLen;</span>
<a href="#l34.1741"></a><span id="l34.1741">       return true;</span>
<a href="#l34.1742"></a><span id="l34.1742">     }</span>
<a href="#l34.1743"></a><span id="l34.1743" class="difflineminus">-    *aStartOfKeyword = FIND_KEYWORD(keywords, keyword, *aStartOfKeyword + kKeywordLen);</span>
<a href="#l34.1744"></a><span id="l34.1744" class="difflineplus">+    *aStartOfKeyword =</span>
<a href="#l34.1745"></a><span id="l34.1745" class="difflineplus">+        FIND_KEYWORD(keywords, keyword, *aStartOfKeyword + kKeywordLen);</span>
<a href="#l34.1746"></a><span id="l34.1746">   }</span>
<a href="#l34.1747"></a><span id="l34.1747"> </span>
<a href="#l34.1748"></a><span id="l34.1748">   *aLength = 0;</span>
<a href="#l34.1749"></a><span id="l34.1749">   return false;</span>
<a href="#l34.1750"></a><span id="l34.1750"> #undef FIND_KEYWORD</span>
<a href="#l34.1751"></a><span id="l34.1751"> }</span>
<a href="#l34.1752"></a><span id="l34.1752"> </span>
<a href="#l34.1753"></a><span id="l34.1753" class="difflineminus">-bool MsgHostDomainIsTrusted(nsCString &amp;host, nsCString &amp;trustedMailDomains)</span>
<a href="#l34.1754"></a><span id="l34.1754" class="difflineminus">-{</span>
<a href="#l34.1755"></a><span id="l34.1755" class="difflineplus">+bool MsgHostDomainIsTrusted(nsCString &amp;host, nsCString &amp;trustedMailDomains) {</span>
<a href="#l34.1756"></a><span id="l34.1756">   const char *end;</span>
<a href="#l34.1757"></a><span id="l34.1757">   uint32_t hostLen, domainLen;</span>
<a href="#l34.1758"></a><span id="l34.1758">   bool domainIsTrusted = false;</span>
<a href="#l34.1759"></a><span id="l34.1759"> </span>
<a href="#l34.1760"></a><span id="l34.1760">   const char *domain = trustedMailDomains.BeginReading();</span>
<a href="#l34.1761"></a><span id="l34.1761">   const char *domainEnd = trustedMailDomains.EndReading();</span>
<a href="#l34.1762"></a><span id="l34.1762">   const char *hostStart = host.BeginReading();</span>
<a href="#l34.1763"></a><span id="l34.1763">   hostLen = host.Length();</span>
<a href="#l34.1764"></a><span id="l34.1764"> </span>
<a href="#l34.1765"></a><span id="l34.1765">   do {</span>
<a href="#l34.1766"></a><span id="l34.1766">     // skip any whitespace</span>
<a href="#l34.1767"></a><span id="l34.1767" class="difflineminus">-    while (*domain == ' ' || *domain == '\t')</span>
<a href="#l34.1768"></a><span id="l34.1768" class="difflineminus">-      ++domain;</span>
<a href="#l34.1769"></a><span id="l34.1769" class="difflineplus">+    while (*domain == ' ' || *domain == '\t') ++domain;</span>
<a href="#l34.1770"></a><span id="l34.1770"> </span>
<a href="#l34.1771"></a><span id="l34.1771">     // find end of this domain in the string</span>
<a href="#l34.1772"></a><span id="l34.1772">     end = strchr(domain, ',');</span>
<a href="#l34.1773"></a><span id="l34.1773" class="difflineminus">-    if (!end)</span>
<a href="#l34.1774"></a><span id="l34.1774" class="difflineminus">-      end = domainEnd;</span>
<a href="#l34.1775"></a><span id="l34.1775" class="difflineplus">+    if (!end) end = domainEnd;</span>
<a href="#l34.1776"></a><span id="l34.1776"> </span>
<a href="#l34.1777"></a><span id="l34.1777">     // to see if the hostname is in the domain, check if the domain</span>
<a href="#l34.1778"></a><span id="l34.1778">     // matches the end of the hostname.</span>
<a href="#l34.1779"></a><span id="l34.1779">     domainLen = end - domain;</span>
<a href="#l34.1780"></a><span id="l34.1780">     if (domainLen &amp;&amp; hostLen &gt;= domainLen) {</span>
<a href="#l34.1781"></a><span id="l34.1781">       const char *hostTail = hostStart + hostLen - domainLen;</span>
<a href="#l34.1782"></a><span id="l34.1782" class="difflineminus">-      if (PL_strncasecmp(domain, hostTail, domainLen) == 0)</span>
<a href="#l34.1783"></a><span id="l34.1783" class="difflineminus">-      {</span>
<a href="#l34.1784"></a><span id="l34.1784" class="difflineplus">+      if (PL_strncasecmp(domain, hostTail, domainLen) == 0) {</span>
<a href="#l34.1785"></a><span id="l34.1785">         // now, make sure either that the hostname is a direct match or</span>
<a href="#l34.1786"></a><span id="l34.1786">         // that the hostname begins with a dot.</span>
<a href="#l34.1787"></a><span id="l34.1787" class="difflineminus">-        if (hostLen == domainLen || *hostTail == '.' || *(hostTail - 1) == '.')</span>
<a href="#l34.1788"></a><span id="l34.1788" class="difflineminus">-        {</span>
<a href="#l34.1789"></a><span id="l34.1789" class="difflineplus">+        if (hostLen == domainLen || *hostTail == '.' ||</span>
<a href="#l34.1790"></a><span id="l34.1790" class="difflineplus">+            *(hostTail - 1) == '.') {</span>
<a href="#l34.1791"></a><span id="l34.1791">           domainIsTrusted = true;</span>
<a href="#l34.1792"></a><span id="l34.1792">           break;</span>
<a href="#l34.1793"></a><span id="l34.1793">         }</span>
<a href="#l34.1794"></a><span id="l34.1794">       }</span>
<a href="#l34.1795"></a><span id="l34.1795">     }</span>
<a href="#l34.1796"></a><span id="l34.1796"> </span>
<a href="#l34.1797"></a><span id="l34.1797">     domain = end + 1;</span>
<a href="#l34.1798"></a><span id="l34.1798">   } while (*end);</span>
<a href="#l34.1799"></a><span id="l34.1799">   return domainIsTrusted;</span>
<a href="#l34.1800"></a><span id="l34.1800"> }</span>
<a href="#l34.1801"></a><span id="l34.1801"> </span>
<a href="#l34.1802"></a><span id="l34.1802" class="difflineminus">-nsresult MsgGetLocalFileFromURI(const nsACString &amp;aUTF8Path, nsIFile **aFile)</span>
<a href="#l34.1803"></a><span id="l34.1803" class="difflineminus">-{</span>
<a href="#l34.1804"></a><span id="l34.1804" class="difflineplus">+nsresult MsgGetLocalFileFromURI(const nsACString &amp;aUTF8Path, nsIFile **aFile) {</span>
<a href="#l34.1805"></a><span id="l34.1805">   nsresult rv;</span>
<a href="#l34.1806"></a><span id="l34.1806">   nsCOMPtr&lt;nsIURI&gt; argURI;</span>
<a href="#l34.1807"></a><span id="l34.1807">   rv = NS_NewURI(getter_AddRefs(argURI), aUTF8Path);</span>
<a href="#l34.1808"></a><span id="l34.1808">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1809"></a><span id="l34.1809">   nsCOMPtr&lt;nsIFileURL&gt; argFileURL(do_QueryInterface(argURI, &amp;rv));</span>
<a href="#l34.1810"></a><span id="l34.1810">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1811"></a><span id="l34.1811"> </span>
<a href="#l34.1812"></a><span id="l34.1812">   nsCOMPtr&lt;nsIFile&gt; argFile;</span>
<a href="#l34.1813"></a><span id="l34.1813">   rv = argFileURL-&gt;GetFile(getter_AddRefs(argFile));</span>
<a href="#l34.1814"></a><span id="l34.1814">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1815"></a><span id="l34.1815"> </span>
<a href="#l34.1816"></a><span id="l34.1816">   argFile.forget(aFile);</span>
<a href="#l34.1817"></a><span id="l34.1817">   return NS_OK;</span>
<a href="#l34.1818"></a><span id="l34.1818"> }</span>
<a href="#l34.1819"></a><span id="l34.1819"> </span>
<a href="#l34.1820"></a><span id="l34.1820" class="difflineminus">-NS_MSG_BASE void MsgStripQuotedPrintable (nsCString&amp; aSrc)</span>
<a href="#l34.1821"></a><span id="l34.1821" class="difflineminus">-{</span>
<a href="#l34.1822"></a><span id="l34.1822" class="difflineplus">+NS_MSG_BASE void MsgStripQuotedPrintable(nsCString &amp;aSrc) {</span>
<a href="#l34.1823"></a><span id="l34.1823">   // decode quoted printable text in place</span>
<a href="#l34.1824"></a><span id="l34.1824"> </span>
<a href="#l34.1825"></a><span id="l34.1825" class="difflineminus">-  if (aSrc.IsEmpty())</span>
<a href="#l34.1826"></a><span id="l34.1826" class="difflineminus">-    return;</span>
<a href="#l34.1827"></a><span id="l34.1827" class="difflineplus">+  if (aSrc.IsEmpty()) return;</span>
<a href="#l34.1828"></a><span id="l34.1828"> </span>
<a href="#l34.1829"></a><span id="l34.1829">   char *src = aSrc.BeginWriting();</span>
<a href="#l34.1830"></a><span id="l34.1830">   char *dest = src;</span>
<a href="#l34.1831"></a><span id="l34.1831">   int srcIdx = 0, destIdx = 0;</span>
<a href="#l34.1832"></a><span id="l34.1832"> </span>
<a href="#l34.1833"></a><span id="l34.1833" class="difflineminus">-  while (src[srcIdx] != 0)</span>
<a href="#l34.1834"></a><span id="l34.1834" class="difflineminus">-  {</span>
<a href="#l34.1835"></a><span id="l34.1835" class="difflineplus">+  while (src[srcIdx] != 0) {</span>
<a href="#l34.1836"></a><span id="l34.1836">     // Decode sequence of '=XY' into a character with code XY.</span>
<a href="#l34.1837"></a><span id="l34.1837" class="difflineminus">-    if (src[srcIdx] == '=')</span>
<a href="#l34.1838"></a><span id="l34.1838" class="difflineminus">-    {</span>
<a href="#l34.1839"></a><span id="l34.1839" class="difflineminus">-      if (MsgIsHex((const char*)src + srcIdx + 1, 2)) {</span>
<a href="#l34.1840"></a><span id="l34.1840" class="difflineplus">+    if (src[srcIdx] == '=') {</span>
<a href="#l34.1841"></a><span id="l34.1841" class="difflineplus">+      if (MsgIsHex((const char *)src + srcIdx + 1, 2)) {</span>
<a href="#l34.1842"></a><span id="l34.1842">         // If we got here, we successfully decoded a quoted printable sequence,</span>
<a href="#l34.1843"></a><span id="l34.1843">         // so bump each pointer past it and move on to the next char.</span>
<a href="#l34.1844"></a><span id="l34.1844" class="difflineminus">-        dest[destIdx++] = MsgUnhex((const char*)src + srcIdx + 1, 2);</span>
<a href="#l34.1845"></a><span id="l34.1845" class="difflineplus">+        dest[destIdx++] = MsgUnhex((const char *)src + srcIdx + 1, 2);</span>
<a href="#l34.1846"></a><span id="l34.1846">         srcIdx += 3;</span>
<a href="#l34.1847"></a><span id="l34.1847" class="difflineminus">-      }</span>
<a href="#l34.1848"></a><span id="l34.1848" class="difflineminus">-      else</span>
<a href="#l34.1849"></a><span id="l34.1849" class="difflineminus">-      {</span>
<a href="#l34.1850"></a><span id="l34.1850" class="difflineplus">+      } else {</span>
<a href="#l34.1851"></a><span id="l34.1851">         // If first char after '=' isn't hex check if it's a normal char</span>
<a href="#l34.1852"></a><span id="l34.1852">         // or a soft line break. If it's a soft line break, eat the</span>
<a href="#l34.1853"></a><span id="l34.1853">         // CR/LF/CRLF.</span>
<a href="#l34.1854"></a><span id="l34.1854" class="difflineminus">-        if (src[srcIdx + 1] == '\r' || src[srcIdx + 1] == '\n')</span>
<a href="#l34.1855"></a><span id="l34.1855" class="difflineminus">-        {</span>
<a href="#l34.1856"></a><span id="l34.1856" class="difflineminus">-          srcIdx++; // soft line break, ignore the '=';</span>
<a href="#l34.1857"></a><span id="l34.1857" class="difflineminus">-          if (src[srcIdx] == '\r' || src[srcIdx] == '\n')</span>
<a href="#l34.1858"></a><span id="l34.1858" class="difflineminus">-          {</span>
<a href="#l34.1859"></a><span id="l34.1859" class="difflineplus">+        if (src[srcIdx + 1] == '\r' || src[srcIdx + 1] == '\n') {</span>
<a href="#l34.1860"></a><span id="l34.1860" class="difflineplus">+          srcIdx++;  // soft line break, ignore the '=';</span>
<a href="#l34.1861"></a><span id="l34.1861" class="difflineplus">+          if (src[srcIdx] == '\r' || src[srcIdx] == '\n') {</span>
<a href="#l34.1862"></a><span id="l34.1862">             srcIdx++;</span>
<a href="#l34.1863"></a><span id="l34.1863" class="difflineminus">-            if (src[srcIdx] == '\n')</span>
<a href="#l34.1864"></a><span id="l34.1864" class="difflineminus">-              srcIdx++;</span>
<a href="#l34.1865"></a><span id="l34.1865" class="difflineplus">+            if (src[srcIdx] == '\n') srcIdx++;</span>
<a href="#l34.1866"></a><span id="l34.1866">           }</span>
<a href="#l34.1867"></a><span id="l34.1867" class="difflineminus">-        }</span>
<a href="#l34.1868"></a><span id="l34.1868" class="difflineminus">-        else // The first or second char after '=' isn't hex, just copy the '='.</span>
<a href="#l34.1869"></a><span id="l34.1869" class="difflineplus">+        } else  // The first or second char after '=' isn't hex, just copy the</span>
<a href="#l34.1870"></a><span id="l34.1870" class="difflineplus">+                // '='.</span>
<a href="#l34.1871"></a><span id="l34.1871">         {</span>
<a href="#l34.1872"></a><span id="l34.1872">           dest[destIdx++] = src[srcIdx++];</span>
<a href="#l34.1873"></a><span id="l34.1873">         }</span>
<a href="#l34.1874"></a><span id="l34.1874">         continue;</span>
<a href="#l34.1875"></a><span id="l34.1875">       }</span>
<a href="#l34.1876"></a><span id="l34.1876" class="difflineminus">-    }</span>
<a href="#l34.1877"></a><span id="l34.1877" class="difflineminus">-    else</span>
<a href="#l34.1878"></a><span id="l34.1878" class="difflineplus">+    } else</span>
<a href="#l34.1879"></a><span id="l34.1879">       dest[destIdx++] = src[srcIdx++];</span>
<a href="#l34.1880"></a><span id="l34.1880">   }</span>
<a href="#l34.1881"></a><span id="l34.1881"> </span>
<a href="#l34.1882"></a><span id="l34.1882" class="difflineminus">-  dest[destIdx] = src[srcIdx]; // null terminate</span>
<a href="#l34.1883"></a><span id="l34.1883" class="difflineplus">+  dest[destIdx] = src[srcIdx];  // null terminate</span>
<a href="#l34.1884"></a><span id="l34.1884">   aSrc.SetLength(destIdx);</span>
<a href="#l34.1885"></a><span id="l34.1885"> }</span>
<a href="#l34.1886"></a><span id="l34.1886"> </span>
<a href="#l34.1887"></a><span id="l34.1887" class="difflineminus">-NS_MSG_BASE nsresult MsgEscapeString(const nsACString &amp;aStr,</span>
<a href="#l34.1888"></a><span id="l34.1888" class="difflineminus">-                                     uint32_t aType, nsACString &amp;aResult)</span>
<a href="#l34.1889"></a><span id="l34.1889" class="difflineminus">-{</span>
<a href="#l34.1890"></a><span id="l34.1890" class="difflineplus">+NS_MSG_BASE nsresult MsgEscapeString(const nsACString &amp;aStr, uint32_t aType,</span>
<a href="#l34.1891"></a><span id="l34.1891" class="difflineplus">+                                     nsACString &amp;aResult) {</span>
<a href="#l34.1892"></a><span id="l34.1892">   nsresult rv;</span>
<a href="#l34.1893"></a><span id="l34.1893">   nsCOMPtr&lt;nsINetUtil&gt; nu = do_GetService(NS_NETUTIL_CONTRACTID, &amp;rv);</span>
<a href="#l34.1894"></a><span id="l34.1894">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1895"></a><span id="l34.1895"> </span>
<a href="#l34.1896"></a><span id="l34.1896">   return nu-&gt;EscapeString(aStr, aType, aResult);</span>
<a href="#l34.1897"></a><span id="l34.1897"> }</span>
<a href="#l34.1898"></a><span id="l34.1898"> </span>
<a href="#l34.1899"></a><span id="l34.1899"> NS_MSG_BASE nsresult MsgUnescapeString(const nsACString &amp;aStr, uint32_t aFlags,</span>
<a href="#l34.1900"></a><span id="l34.1900" class="difflineminus">-                                       nsACString &amp;aResult)</span>
<a href="#l34.1901"></a><span id="l34.1901" class="difflineminus">-{</span>
<a href="#l34.1902"></a><span id="l34.1902" class="difflineplus">+                                       nsACString &amp;aResult) {</span>
<a href="#l34.1903"></a><span id="l34.1903">   nsresult rv;</span>
<a href="#l34.1904"></a><span id="l34.1904">   nsCOMPtr&lt;nsINetUtil&gt; nu = do_GetService(NS_NETUTIL_CONTRACTID, &amp;rv);</span>
<a href="#l34.1905"></a><span id="l34.1905">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1906"></a><span id="l34.1906"> </span>
<a href="#l34.1907"></a><span id="l34.1907">   return nu-&gt;UnescapeString(aStr, aFlags, aResult);</span>
<a href="#l34.1908"></a><span id="l34.1908"> }</span>
<a href="#l34.1909"></a><span id="l34.1909"> </span>
<a href="#l34.1910"></a><span id="l34.1910"> NS_MSG_BASE nsresult MsgEscapeURL(const nsACString &amp;aStr, uint32_t aFlags,</span>
<a href="#l34.1911"></a><span id="l34.1911" class="difflineminus">-                                  nsACString &amp;aResult)</span>
<a href="#l34.1912"></a><span id="l34.1912" class="difflineminus">-{</span>
<a href="#l34.1913"></a><span id="l34.1913" class="difflineplus">+                                  nsACString &amp;aResult) {</span>
<a href="#l34.1914"></a><span id="l34.1914">   nsresult rv;</span>
<a href="#l34.1915"></a><span id="l34.1915">   nsCOMPtr&lt;nsINetUtil&gt; nu = do_GetService(NS_NETUTIL_CONTRACTID, &amp;rv);</span>
<a href="#l34.1916"></a><span id="l34.1916">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1917"></a><span id="l34.1917"> </span>
<a href="#l34.1918"></a><span id="l34.1918">   return nu-&gt;EscapeURL(aStr, aFlags, aResult);</span>
<a href="#l34.1919"></a><span id="l34.1919"> }</span>
<a href="#l34.1920"></a><span id="l34.1920"> </span>
<a href="#l34.1921"></a><span id="l34.1921" class="difflineminus">-NS_MSG_BASE nsresult MsgGetHeadersFromKeys(nsIMsgDatabase *aDB, const nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeys,</span>
<a href="#l34.1922"></a><span id="l34.1922" class="difflineminus">-                                           nsIMutableArray *aHeaders)</span>
<a href="#l34.1923"></a><span id="l34.1923" class="difflineminus">-{</span>
<a href="#l34.1924"></a><span id="l34.1924" class="difflineplus">+NS_MSG_BASE nsresult MsgGetHeadersFromKeys(nsIMsgDatabase *aDB,</span>
<a href="#l34.1925"></a><span id="l34.1925" class="difflineplus">+                                           const nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeys,</span>
<a href="#l34.1926"></a><span id="l34.1926" class="difflineplus">+                                           nsIMutableArray *aHeaders) {</span>
<a href="#l34.1927"></a><span id="l34.1927">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l34.1928"></a><span id="l34.1928"> </span>
<a href="#l34.1929"></a><span id="l34.1929">   uint32_t count = aMsgKeys.Length();</span>
<a href="#l34.1930"></a><span id="l34.1930">   nsresult rv = NS_OK;</span>
<a href="#l34.1931"></a><span id="l34.1931"> </span>
<a href="#l34.1932"></a><span id="l34.1932" class="difflineminus">-  for (uint32_t kindex = 0; kindex &lt; count; kindex++)</span>
<a href="#l34.1933"></a><span id="l34.1933" class="difflineminus">-  {</span>
<a href="#l34.1934"></a><span id="l34.1934" class="difflineplus">+  for (uint32_t kindex = 0; kindex &lt; count; kindex++) {</span>
<a href="#l34.1935"></a><span id="l34.1935">     nsMsgKey key = aMsgKeys.ElementAt(kindex);</span>
<a href="#l34.1936"></a><span id="l34.1936"> </span>
<a href="#l34.1937"></a><span id="l34.1937">     bool hasKey;</span>
<a href="#l34.1938"></a><span id="l34.1938">     rv = aDB-&gt;ContainsKey(key, &amp;hasKey);</span>
<a href="#l34.1939"></a><span id="l34.1939">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1940"></a><span id="l34.1940"> </span>
<a href="#l34.1941"></a><span id="l34.1941" class="difflineminus">-    // This function silently skips when the key is not found. This is an expected case.</span>
<a href="#l34.1942"></a><span id="l34.1942" class="difflineminus">-    if (hasKey)</span>
<a href="#l34.1943"></a><span id="l34.1943" class="difflineminus">-    {</span>
<a href="#l34.1944"></a><span id="l34.1944" class="difflineplus">+    // This function silently skips when the key is not found. This is an</span>
<a href="#l34.1945"></a><span id="l34.1945" class="difflineplus">+    // expected case.</span>
<a href="#l34.1946"></a><span id="l34.1946" class="difflineplus">+    if (hasKey) {</span>
<a href="#l34.1947"></a><span id="l34.1947">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l34.1948"></a><span id="l34.1948">       rv = aDB-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l34.1949"></a><span id="l34.1949">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1950"></a><span id="l34.1950"> </span>
<a href="#l34.1951"></a><span id="l34.1951">       aHeaders-&gt;AppendElement(msgHdr);</span>
<a href="#l34.1952"></a><span id="l34.1952">     }</span>
<a href="#l34.1953"></a><span id="l34.1953">   }</span>
<a href="#l34.1954"></a><span id="l34.1954"> </span>
<a href="#l34.1955"></a><span id="l34.1955">   return rv;</span>
<a href="#l34.1956"></a><span id="l34.1956"> }</span>
<a href="#l34.1957"></a><span id="l34.1957"> </span>
<a href="#l34.1958"></a><span id="l34.1958"> NS_MSG_BASE nsresult MsgGetHdrsFromKeys(nsIMsgDatabase *aDB, nsMsgKey *aMsgKeys,</span>
<a href="#l34.1959"></a><span id="l34.1959" class="difflineminus">-                                        uint32_t aNumKeys, nsIMutableArray **aHeaders)</span>
<a href="#l34.1960"></a><span id="l34.1960" class="difflineminus">-{</span>
<a href="#l34.1961"></a><span id="l34.1961" class="difflineplus">+                                        uint32_t aNumKeys,</span>
<a href="#l34.1962"></a><span id="l34.1962" class="difflineplus">+                                        nsIMutableArray **aHeaders) {</span>
<a href="#l34.1963"></a><span id="l34.1963">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l34.1964"></a><span id="l34.1964">   NS_ENSURE_ARG_POINTER(aMsgKeys);</span>
<a href="#l34.1965"></a><span id="l34.1965">   NS_ENSURE_ARG_POINTER(aHeaders);</span>
<a href="#l34.1966"></a><span id="l34.1966"> </span>
<a href="#l34.1967"></a><span id="l34.1967">   nsresult rv;</span>
<a href="#l34.1968"></a><span id="l34.1968" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l34.1969"></a><span id="l34.1969" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l34.1970"></a><span id="l34.1970" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l34.1971"></a><span id="l34.1971">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1972"></a><span id="l34.1972"> </span>
<a href="#l34.1973"></a><span id="l34.1973">   for (uint32_t kindex = 0; kindex &lt; aNumKeys; kindex++) {</span>
<a href="#l34.1974"></a><span id="l34.1974">     nsMsgKey key = aMsgKeys[kindex];</span>
<a href="#l34.1975"></a><span id="l34.1975">     bool hasKey;</span>
<a href="#l34.1976"></a><span id="l34.1976">     rv = aDB-&gt;ContainsKey(key, &amp;hasKey);</span>
<a href="#l34.1977"></a><span id="l34.1977" class="difflineminus">-    // This function silently skips when the key is not found. This is an expected case.</span>
<a href="#l34.1978"></a><span id="l34.1978" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; hasKey)</span>
<a href="#l34.1979"></a><span id="l34.1979" class="difflineminus">-    {</span>
<a href="#l34.1980"></a><span id="l34.1980" class="difflineplus">+    // This function silently skips when the key is not found. This is an</span>
<a href="#l34.1981"></a><span id="l34.1981" class="difflineplus">+    // expected case.</span>
<a href="#l34.1982"></a><span id="l34.1982" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; hasKey) {</span>
<a href="#l34.1983"></a><span id="l34.1983">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l34.1984"></a><span id="l34.1984">       rv = aDB-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l34.1985"></a><span id="l34.1985" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1986"></a><span id="l34.1986" class="difflineminus">-        messages-&gt;AppendElement(msgHdr);</span>
<a href="#l34.1987"></a><span id="l34.1987" class="difflineplus">+      if (NS_SUCCEEDED(rv)) messages-&gt;AppendElement(msgHdr);</span>
<a href="#l34.1988"></a><span id="l34.1988">     }</span>
<a href="#l34.1989"></a><span id="l34.1989">   }</span>
<a href="#l34.1990"></a><span id="l34.1990"> </span>
<a href="#l34.1991"></a><span id="l34.1991">   messages.forget(aHeaders);</span>
<a href="#l34.1992"></a><span id="l34.1992">   return NS_OK;</span>
<a href="#l34.1993"></a><span id="l34.1993"> }</span>
<a href="#l34.1994"></a><span id="l34.1994"> </span>
<a href="#l34.1995"></a><span id="l34.1995" class="difflineminus">-bool MsgAdvanceToNextLine(const char *buffer, uint32_t &amp;bufferOffset, uint32_t maxBufferOffset)</span>
<a href="#l34.1996"></a><span id="l34.1996" class="difflineminus">-{</span>
<a href="#l34.1997"></a><span id="l34.1997" class="difflineplus">+bool MsgAdvanceToNextLine(const char *buffer, uint32_t &amp;bufferOffset,</span>
<a href="#l34.1998"></a><span id="l34.1998" class="difflineplus">+                          uint32_t maxBufferOffset) {</span>
<a href="#l34.1999"></a><span id="l34.1999">   bool result = false;</span>
<a href="#l34.2000"></a><span id="l34.2000" class="difflineminus">-  for (; bufferOffset &lt; maxBufferOffset; bufferOffset++)</span>
<a href="#l34.2001"></a><span id="l34.2001" class="difflineminus">-  {</span>
<a href="#l34.2002"></a><span id="l34.2002" class="difflineminus">-    if (buffer[bufferOffset] == '\r' || buffer[bufferOffset] == '\n')</span>
<a href="#l34.2003"></a><span id="l34.2003" class="difflineminus">-    {</span>
<a href="#l34.2004"></a><span id="l34.2004" class="difflineplus">+  for (; bufferOffset &lt; maxBufferOffset; bufferOffset++) {</span>
<a href="#l34.2005"></a><span id="l34.2005" class="difflineplus">+    if (buffer[bufferOffset] == '\r' || buffer[bufferOffset] == '\n') {</span>
<a href="#l34.2006"></a><span id="l34.2006">       bufferOffset++;</span>
<a href="#l34.2007"></a><span id="l34.2007" class="difflineminus">-      if (buffer[bufferOffset- 1] == '\r' &amp;&amp; buffer[bufferOffset] == '\n')</span>
<a href="#l34.2008"></a><span id="l34.2008" class="difflineplus">+      if (buffer[bufferOffset - 1] == '\r' &amp;&amp; buffer[bufferOffset] == '\n')</span>
<a href="#l34.2009"></a><span id="l34.2009">         bufferOffset++;</span>
<a href="#l34.2010"></a><span id="l34.2010">       result = true;</span>
<a href="#l34.2011"></a><span id="l34.2011">       break;</span>
<a href="#l34.2012"></a><span id="l34.2012">     }</span>
<a href="#l34.2013"></a><span id="l34.2013">   }</span>
<a href="#l34.2014"></a><span id="l34.2014">   return result;</span>
<a href="#l34.2015"></a><span id="l34.2015"> }</span>
<a href="#l34.2016"></a><span id="l34.2016"> </span>
<a href="#l34.2017"></a><span id="l34.2017" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l34.2018"></a><span id="l34.2018" class="difflineminus">-MsgExamineForProxyAsync(nsIChannel *channel, nsIProtocolProxyCallback *listener,</span>
<a href="#l34.2019"></a><span id="l34.2019" class="difflineminus">-                        nsICancelable **result)</span>
<a href="#l34.2020"></a><span id="l34.2020" class="difflineminus">-{</span>
<a href="#l34.2021"></a><span id="l34.2021" class="difflineplus">+NS_MSG_BASE nsresult MsgExamineForProxyAsync(nsIChannel *channel,</span>
<a href="#l34.2022"></a><span id="l34.2022" class="difflineplus">+                                             nsIProtocolProxyCallback *listener,</span>
<a href="#l34.2023"></a><span id="l34.2023" class="difflineplus">+                                             nsICancelable **result) {</span>
<a href="#l34.2024"></a><span id="l34.2024">   nsresult rv;</span>
<a href="#l34.2025"></a><span id="l34.2025"> </span>
<a href="#l34.2026"></a><span id="l34.2026"> #ifdef DEBUG</span>
<a href="#l34.2027"></a><span id="l34.2027">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l34.2028"></a><span id="l34.2028">   rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l34.2029"></a><span id="l34.2029">   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; uri,</span>
<a href="#l34.2030"></a><span id="l34.2030" class="difflineminus">-    &quot;The URI needs to be set before calling the proxy service&quot;);</span>
<a href="#l34.2031"></a><span id="l34.2031" class="difflineplus">+               &quot;The URI needs to be set before calling the proxy service&quot;);</span>
<a href="#l34.2032"></a><span id="l34.2032"> #endif</span>
<a href="#l34.2033"></a><span id="l34.2033"> </span>
<a href="#l34.2034"></a><span id="l34.2034">   nsCOMPtr&lt;nsIProtocolProxyService&gt; pps =</span>
<a href="#l34.2035"></a><span id="l34.2035" class="difflineminus">-    do_GetService(NS_PROTOCOLPROXYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l34.2036"></a><span id="l34.2036" class="difflineplus">+      do_GetService(NS_PROTOCOLPROXYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l34.2037"></a><span id="l34.2037">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2038"></a><span id="l34.2038"> </span>
<a href="#l34.2039"></a><span id="l34.2039">   return pps-&gt;AsyncResolve(channel, 0, listener, nullptr, result);</span>
<a href="#l34.2040"></a><span id="l34.2040"> }</span>
<a href="#l34.2041"></a><span id="l34.2041"> </span>
<a href="#l34.2042"></a><span id="l34.2042"> NS_MSG_BASE nsresult MsgPromptLoginFailed(nsIMsgWindow *aMsgWindow,</span>
<a href="#l34.2043"></a><span id="l34.2043">                                           const nsACString &amp;aHostname,</span>
<a href="#l34.2044"></a><span id="l34.2044">                                           const nsACString &amp;aUsername,</span>
<a href="#l34.2045"></a><span id="l34.2045">                                           const nsAString &amp;aAccountname,</span>
<a href="#l34.2046"></a><span id="l34.2046" class="difflineminus">-                                          int32_t *aResult)</span>
<a href="#l34.2047"></a><span id="l34.2047" class="difflineminus">-{</span>
<a href="#l34.2048"></a><span id="l34.2048" class="difflineplus">+                                          int32_t *aResult) {</span>
<a href="#l34.2049"></a><span id="l34.2049">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l34.2050"></a><span id="l34.2050" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l34.2051"></a><span id="l34.2051" class="difflineminus">-    aMsgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l34.2052"></a><span id="l34.2052" class="difflineplus">+  if (aMsgWindow) aMsgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l34.2053"></a><span id="l34.2053"> </span>
<a href="#l34.2054"></a><span id="l34.2054">   nsresult rv;</span>
<a href="#l34.2055"></a><span id="l34.2055"> </span>
<a href="#l34.2056"></a><span id="l34.2056">   // If we haven't got one, use a default dialog.</span>
<a href="#l34.2057"></a><span id="l34.2057" class="difflineminus">-  if (!dialog)</span>
<a href="#l34.2058"></a><span id="l34.2058" class="difflineminus">-  {</span>
<a href="#l34.2059"></a><span id="l34.2059" class="difflineplus">+  if (!dialog) {</span>
<a href="#l34.2060"></a><span id="l34.2060">     nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch =</span>
<a href="#l34.2061"></a><span id="l34.2061" class="difflineminus">-      do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l34.2062"></a><span id="l34.2062" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv);</span>
<a href="#l34.2063"></a><span id="l34.2063">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2064"></a><span id="l34.2064"> </span>
<a href="#l34.2065"></a><span id="l34.2065">     rv = wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l34.2066"></a><span id="l34.2066">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2067"></a><span id="l34.2067">   }</span>
<a href="#l34.2068"></a><span id="l34.2068"> </span>
<a href="#l34.2069"></a><span id="l34.2069">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleSvc =</span>
<a href="#l34.2070"></a><span id="l34.2070" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l34.2071"></a><span id="l34.2071" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l34.2072"></a><span id="l34.2072">   NS_ENSURE_TRUE(bundleSvc, NS_ERROR_UNEXPECTED);</span>
<a href="#l34.2073"></a><span id="l34.2073"> </span>
<a href="#l34.2074"></a><span id="l34.2074">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l34.2075"></a><span id="l34.2075">   rv = bundleSvc-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l34.2076"></a><span id="l34.2076">                                getter_AddRefs(bundle));</span>
<a href="#l34.2077"></a><span id="l34.2077">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2078"></a><span id="l34.2078"> </span>
<a href="#l34.2079"></a><span id="l34.2079">   nsString message;</span>
<a href="#l34.2080"></a><span id="l34.2080">   NS_ConvertUTF8toUTF16 hostNameUTF16(aHostname);</span>
<a href="#l34.2081"></a><span id="l34.2081">   NS_ConvertUTF8toUTF16 userNameUTF16(aUsername);</span>
<a href="#l34.2082"></a><span id="l34.2082" class="difflineminus">-  const char16_t *formatStrings[] = { hostNameUTF16.get(), userNameUTF16.get() };</span>
<a href="#l34.2083"></a><span id="l34.2083" class="difflineplus">+  const char16_t *formatStrings[] = {hostNameUTF16.get(), userNameUTF16.get()};</span>
<a href="#l34.2084"></a><span id="l34.2084"> </span>
<a href="#l34.2085"></a><span id="l34.2085" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(&quot;mailServerLoginFailed2&quot;,</span>
<a href="#l34.2086"></a><span id="l34.2086" class="difflineminus">-                                    formatStrings, 2,</span>
<a href="#l34.2087"></a><span id="l34.2087" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(&quot;mailServerLoginFailed2&quot;, formatStrings, 2,</span>
<a href="#l34.2088"></a><span id="l34.2088">                                     message);</span>
<a href="#l34.2089"></a><span id="l34.2089">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2090"></a><span id="l34.2090"> </span>
<a href="#l34.2091"></a><span id="l34.2091">   nsString title;</span>
<a href="#l34.2092"></a><span id="l34.2092">   if (aAccountname.IsEmpty()) {</span>
<a href="#l34.2093"></a><span id="l34.2093">     // Account name may be empty e.g. on a SMTP server.</span>
<a href="#l34.2094"></a><span id="l34.2094" class="difflineminus">-    rv = bundle-&gt;GetStringFromName(</span>
<a href="#l34.2095"></a><span id="l34.2095" class="difflineminus">-      &quot;mailServerLoginFailedTitle&quot;, title);</span>
<a href="#l34.2096"></a><span id="l34.2096" class="difflineplus">+    rv = bundle-&gt;GetStringFromName(&quot;mailServerLoginFailedTitle&quot;, title);</span>
<a href="#l34.2097"></a><span id="l34.2097">   } else {</span>
<a href="#l34.2098"></a><span id="l34.2098" class="difflineminus">-    const char16_t *formatStrings[] = { aAccountname.BeginReading() };</span>
<a href="#l34.2099"></a><span id="l34.2099" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l34.2100"></a><span id="l34.2100" class="difflineminus">-      &quot;mailServerLoginFailedTitleWithAccount&quot;,</span>
<a href="#l34.2101"></a><span id="l34.2101" class="difflineminus">-      formatStrings, 1, title);</span>
<a href="#l34.2102"></a><span id="l34.2102" class="difflineplus">+    const char16_t *formatStrings[] = {aAccountname.BeginReading()};</span>
<a href="#l34.2103"></a><span id="l34.2103" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;mailServerLoginFailedTitleWithAccount&quot;,</span>
<a href="#l34.2104"></a><span id="l34.2104" class="difflineplus">+                                      formatStrings, 1, title);</span>
<a href="#l34.2105"></a><span id="l34.2105">   }</span>
<a href="#l34.2106"></a><span id="l34.2106">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2107"></a><span id="l34.2107"> </span>
<a href="#l34.2108"></a><span id="l34.2108">   nsString button0;</span>
<a href="#l34.2109"></a><span id="l34.2109" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(</span>
<a href="#l34.2110"></a><span id="l34.2110" class="difflineminus">-    &quot;mailServerLoginFailedRetryButton&quot;,</span>
<a href="#l34.2111"></a><span id="l34.2111" class="difflineminus">-    button0);</span>
<a href="#l34.2112"></a><span id="l34.2112" class="difflineplus">+  rv = bundle-&gt;GetStringFromName(&quot;mailServerLoginFailedRetryButton&quot;, button0);</span>
<a href="#l34.2113"></a><span id="l34.2113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2114"></a><span id="l34.2114"> </span>
<a href="#l34.2115"></a><span id="l34.2115">   nsString button2;</span>
<a href="#l34.2116"></a><span id="l34.2116" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(</span>
<a href="#l34.2117"></a><span id="l34.2117" class="difflineminus">-    &quot;mailServerLoginFailedEnterNewPasswordButton&quot;,</span>
<a href="#l34.2118"></a><span id="l34.2118" class="difflineminus">-    button2);</span>
<a href="#l34.2119"></a><span id="l34.2119" class="difflineplus">+  rv = bundle-&gt;GetStringFromName(&quot;mailServerLoginFailedEnterNewPasswordButton&quot;,</span>
<a href="#l34.2120"></a><span id="l34.2120" class="difflineplus">+                                 button2);</span>
<a href="#l34.2121"></a><span id="l34.2121">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2122"></a><span id="l34.2122"> </span>
<a href="#l34.2123"></a><span id="l34.2123">   bool dummyValue = false;</span>
<a href="#l34.2124"></a><span id="l34.2124">   return dialog-&gt;ConfirmEx(</span>
<a href="#l34.2125"></a><span id="l34.2125" class="difflineminus">-    title.get(), message.get(),</span>
<a href="#l34.2126"></a><span id="l34.2126" class="difflineminus">-    (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l34.2127"></a><span id="l34.2127" class="difflineminus">-    (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1) +</span>
<a href="#l34.2128"></a><span id="l34.2128" class="difflineminus">-    (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_2),</span>
<a href="#l34.2129"></a><span id="l34.2129" class="difflineminus">-    button0.get(), nullptr, button2.get(), nullptr, &amp;dummyValue, aResult);</span>
<a href="#l34.2130"></a><span id="l34.2130" class="difflineplus">+      title.get(), message.get(),</span>
<a href="#l34.2131"></a><span id="l34.2131" class="difflineplus">+      (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l34.2132"></a><span id="l34.2132" class="difflineplus">+          (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1) +</span>
<a href="#l34.2133"></a><span id="l34.2133" class="difflineplus">+          (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_2),</span>
<a href="#l34.2134"></a><span id="l34.2134" class="difflineplus">+      button0.get(), nullptr, button2.get(), nullptr, &amp;dummyValue, aResult);</span>
<a href="#l34.2135"></a><span id="l34.2135"> }</span>
<a href="#l34.2136"></a><span id="l34.2136"> </span>
<a href="#l34.2137"></a><span id="l34.2137" class="difflineminus">-NS_MSG_BASE PRTime MsgConvertAgeInDaysToCutoffDate(int32_t ageInDays)</span>
<a href="#l34.2138"></a><span id="l34.2138" class="difflineminus">-{</span>
<a href="#l34.2139"></a><span id="l34.2139" class="difflineplus">+NS_MSG_BASE PRTime MsgConvertAgeInDaysToCutoffDate(int32_t ageInDays) {</span>
<a href="#l34.2140"></a><span id="l34.2140">   PRTime now = PR_Now();</span>
<a href="#l34.2141"></a><span id="l34.2141"> </span>
<a href="#l34.2142"></a><span id="l34.2142">   return now - PR_USEC_PER_DAY * ageInDays;</span>
<a href="#l34.2143"></a><span id="l34.2143"> }</span>
<a href="#l34.2144"></a><span id="l34.2144"> </span>
<a href="#l34.2145"></a><span id="l34.2145" class="difflineminus">-NS_MSG_BASE nsresult MsgTermListToString(nsIArray *aTermList, nsCString &amp;aOutString)</span>
<a href="#l34.2146"></a><span id="l34.2146" class="difflineminus">-{</span>
<a href="#l34.2147"></a><span id="l34.2147" class="difflineplus">+NS_MSG_BASE nsresult MsgTermListToString(nsIArray *aTermList,</span>
<a href="#l34.2148"></a><span id="l34.2148" class="difflineplus">+                                         nsCString &amp;aOutString) {</span>
<a href="#l34.2149"></a><span id="l34.2149">   uint32_t count;</span>
<a href="#l34.2150"></a><span id="l34.2150">   aTermList-&gt;GetLength(&amp;count);</span>
<a href="#l34.2151"></a><span id="l34.2151">   nsresult rv = NS_OK;</span>
<a href="#l34.2152"></a><span id="l34.2152"> </span>
<a href="#l34.2153"></a><span id="l34.2153" class="difflineminus">-  for (uint32_t searchIndex = 0; searchIndex &lt; count;</span>
<a href="#l34.2154"></a><span id="l34.2154" class="difflineminus">-       searchIndex++)</span>
<a href="#l34.2155"></a><span id="l34.2155" class="difflineminus">-  {</span>
<a href="#l34.2156"></a><span id="l34.2156" class="difflineplus">+  for (uint32_t searchIndex = 0; searchIndex &lt; count; searchIndex++) {</span>
<a href="#l34.2157"></a><span id="l34.2157">     nsAutoCString stream;</span>
<a href="#l34.2158"></a><span id="l34.2158"> </span>
<a href="#l34.2159"></a><span id="l34.2159">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; term = do_QueryElementAt(aTermList, searchIndex);</span>
<a href="#l34.2160"></a><span id="l34.2160" class="difflineminus">-    if (!term)</span>
<a href="#l34.2161"></a><span id="l34.2161" class="difflineminus">-      continue;</span>
<a href="#l34.2162"></a><span id="l34.2162" class="difflineplus">+    if (!term) continue;</span>
<a href="#l34.2163"></a><span id="l34.2163"> </span>
<a href="#l34.2164"></a><span id="l34.2164" class="difflineminus">-    if (aOutString.Length() &gt; 1)</span>
<a href="#l34.2165"></a><span id="l34.2165" class="difflineminus">-      aOutString += ' ';</span>
<a href="#l34.2166"></a><span id="l34.2166" class="difflineplus">+    if (aOutString.Length() &gt; 1) aOutString += ' ';</span>
<a href="#l34.2167"></a><span id="l34.2167"> </span>
<a href="#l34.2168"></a><span id="l34.2168">     bool booleanAnd;</span>
<a href="#l34.2169"></a><span id="l34.2169">     bool matchAll;</span>
<a href="#l34.2170"></a><span id="l34.2170">     term-&gt;GetBooleanAnd(&amp;booleanAnd);</span>
<a href="#l34.2171"></a><span id="l34.2171">     term-&gt;GetMatchAll(&amp;matchAll);</span>
<a href="#l34.2172"></a><span id="l34.2172" class="difflineminus">-    if (matchAll)</span>
<a href="#l34.2173"></a><span id="l34.2173" class="difflineminus">-    {</span>
<a href="#l34.2174"></a><span id="l34.2174" class="difflineplus">+    if (matchAll) {</span>
<a href="#l34.2175"></a><span id="l34.2175">       aOutString += &quot;ALL&quot;;</span>
<a href="#l34.2176"></a><span id="l34.2176">       continue;</span>
<a href="#l34.2177"></a><span id="l34.2177" class="difflineminus">-    }</span>
<a href="#l34.2178"></a><span id="l34.2178" class="difflineminus">-    else if (booleanAnd)</span>
<a href="#l34.2179"></a><span id="l34.2179" class="difflineplus">+    } else if (booleanAnd)</span>
<a href="#l34.2180"></a><span id="l34.2180">       aOutString += &quot;AND (&quot;;</span>
<a href="#l34.2181"></a><span id="l34.2181">     else</span>
<a href="#l34.2182"></a><span id="l34.2182">       aOutString += &quot;OR (&quot;;</span>
<a href="#l34.2183"></a><span id="l34.2183"> </span>
<a href="#l34.2184"></a><span id="l34.2184">     rv = term-&gt;GetTermAsString(stream);</span>
<a href="#l34.2185"></a><span id="l34.2185">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2186"></a><span id="l34.2186"> </span>
<a href="#l34.2187"></a><span id="l34.2187">     aOutString += stream;</span>
<a href="#l34.2188"></a><span id="l34.2188">     aOutString += ')';</span>
<a href="#l34.2189"></a><span id="l34.2189">   }</span>
<a href="#l34.2190"></a><span id="l34.2190">   return rv;</span>
<a href="#l34.2191"></a><span id="l34.2191"> }</span>
<a href="#l34.2192"></a><span id="l34.2192"> </span>
<a href="#l34.2193"></a><span id="l34.2193" class="difflineminus">-NS_MSG_BASE uint64_t ParseUint64Str(const char *str)</span>
<a href="#l34.2194"></a><span id="l34.2194" class="difflineminus">-{</span>
<a href="#l34.2195"></a><span id="l34.2195" class="difflineplus">+NS_MSG_BASE uint64_t ParseUint64Str(const char *str) {</span>
<a href="#l34.2196"></a><span id="l34.2196"> #ifdef XP_WIN</span>
<a href="#l34.2197"></a><span id="l34.2197">   {</span>
<a href="#l34.2198"></a><span id="l34.2198">     char *endPtr;</span>
<a href="#l34.2199"></a><span id="l34.2199">     return _strtoui64(str, &amp;endPtr, 10);</span>
<a href="#l34.2200"></a><span id="l34.2200">   }</span>
<a href="#l34.2201"></a><span id="l34.2201"> #else</span>
<a href="#l34.2202"></a><span id="l34.2202">   return strtoull(str, nullptr, 10);</span>
<a href="#l34.2203"></a><span id="l34.2203"> #endif</span>
<a href="#l34.2204"></a><span id="l34.2204"> }</span>
<a href="#l34.2205"></a><span id="l34.2205"> </span>
<a href="#l34.2206"></a><span id="l34.2206" class="difflineminus">-NS_MSG_BASE uint64_t MsgUnhex(const char *aHexString, size_t aNumChars)</span>
<a href="#l34.2207"></a><span id="l34.2207" class="difflineminus">-{</span>
<a href="#l34.2208"></a><span id="l34.2208" class="difflineplus">+NS_MSG_BASE uint64_t MsgUnhex(const char *aHexString, size_t aNumChars) {</span>
<a href="#l34.2209"></a><span id="l34.2209">   // Large numbers will not fit into uint64_t.</span>
<a href="#l34.2210"></a><span id="l34.2210">   NS_ASSERTION(aNumChars &lt;= 16, &quot;Hex literal too long to convert!&quot;);</span>
<a href="#l34.2211"></a><span id="l34.2211"> </span>
<a href="#l34.2212"></a><span id="l34.2212">   uint64_t result = 0;</span>
<a href="#l34.2213"></a><span id="l34.2213" class="difflineminus">-  for (size_t i = 0; i &lt; aNumChars; i++)</span>
<a href="#l34.2214"></a><span id="l34.2214" class="difflineminus">-  {</span>
<a href="#l34.2215"></a><span id="l34.2215" class="difflineplus">+  for (size_t i = 0; i &lt; aNumChars; i++) {</span>
<a href="#l34.2216"></a><span id="l34.2216">     unsigned char c = aHexString[i];</span>
<a href="#l34.2217"></a><span id="l34.2217">     uint8_t digit;</span>
<a href="#l34.2218"></a><span id="l34.2218">     if ((c &gt;= '0') &amp;&amp; (c &lt;= '9'))</span>
<a href="#l34.2219"></a><span id="l34.2219">       digit = (c - '0');</span>
<a href="#l34.2220"></a><span id="l34.2220">     else if ((c &gt;= 'a') &amp;&amp; (c &lt;= 'f'))</span>
<a href="#l34.2221"></a><span id="l34.2221">       digit = ((c - 'a') + 10);</span>
<a href="#l34.2222"></a><span id="l34.2222">     else if ((c &gt;= 'A') &amp;&amp; (c &lt;= 'F'))</span>
<a href="#l34.2223"></a><span id="l34.2223">       digit = ((c - 'A') + 10);</span>
<a href="#l34.2224"></a><span id="l34.2224" class="difflineat">@@ -1846,153 +1706,139 @@ NS_MSG_BASE uint64_t MsgUnhex(const char</span>
<a href="#l34.2225"></a><span id="l34.2225">       break;</span>
<a href="#l34.2226"></a><span id="l34.2226"> </span>
<a href="#l34.2227"></a><span id="l34.2227">     result = (result &lt;&lt; 4) | digit;</span>
<a href="#l34.2228"></a><span id="l34.2228">   }</span>
<a href="#l34.2229"></a><span id="l34.2229"> </span>
<a href="#l34.2230"></a><span id="l34.2230">   return result;</span>
<a href="#l34.2231"></a><span id="l34.2231"> }</span>
<a href="#l34.2232"></a><span id="l34.2232"> </span>
<a href="#l34.2233"></a><span id="l34.2233" class="difflineminus">-NS_MSG_BASE bool MsgIsHex(const char *aHexString, size_t aNumChars)</span>
<a href="#l34.2234"></a><span id="l34.2234" class="difflineminus">-{</span>
<a href="#l34.2235"></a><span id="l34.2235" class="difflineminus">-  for (size_t i = 0; i &lt; aNumChars; i++)</span>
<a href="#l34.2236"></a><span id="l34.2236" class="difflineminus">-  {</span>
<a href="#l34.2237"></a><span id="l34.2237" class="difflineminus">-    if (!isxdigit(aHexString[i]))</span>
<a href="#l34.2238"></a><span id="l34.2238" class="difflineminus">-      return false;</span>
<a href="#l34.2239"></a><span id="l34.2239" class="difflineplus">+NS_MSG_BASE bool MsgIsHex(const char *aHexString, size_t aNumChars) {</span>
<a href="#l34.2240"></a><span id="l34.2240" class="difflineplus">+  for (size_t i = 0; i &lt; aNumChars; i++) {</span>
<a href="#l34.2241"></a><span id="l34.2241" class="difflineplus">+    if (!isxdigit(aHexString[i])) return false;</span>
<a href="#l34.2242"></a><span id="l34.2242">   }</span>
<a href="#l34.2243"></a><span id="l34.2243">   return true;</span>
<a href="#l34.2244"></a><span id="l34.2244"> }</span>
<a href="#l34.2245"></a><span id="l34.2245"> </span>
<a href="#l34.2246"></a><span id="l34.2246" class="difflineminus">-</span>
<a href="#l34.2247"></a><span id="l34.2247" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l34.2248"></a><span id="l34.2248" class="difflineminus">-MsgStreamMsgHeaders(nsIInputStream *aInputStream, nsIStreamListener *aConsumer)</span>
<a href="#l34.2249"></a><span id="l34.2249" class="difflineminus">-{</span>
<a href="#l34.2250"></a><span id="l34.2250" class="difflineplus">+NS_MSG_BASE nsresult MsgStreamMsgHeaders(nsIInputStream *aInputStream,</span>
<a href="#l34.2251"></a><span id="l34.2251" class="difflineplus">+                                         nsIStreamListener *aConsumer) {</span>
<a href="#l34.2252"></a><span id="l34.2252">   nsAutoPtr&lt;nsLineBuffer&lt;char&gt; &gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l34.2253"></a><span id="l34.2253">   NS_ENSURE_TRUE(lineBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l34.2254"></a><span id="l34.2254"> </span>
<a href="#l34.2255"></a><span id="l34.2255">   nsresult rv;</span>
<a href="#l34.2256"></a><span id="l34.2256"> </span>
<a href="#l34.2257"></a><span id="l34.2257">   nsAutoCString msgHeaders;</span>
<a href="#l34.2258"></a><span id="l34.2258">   nsAutoCString curLine;</span>
<a href="#l34.2259"></a><span id="l34.2259"> </span>
<a href="#l34.2260"></a><span id="l34.2260">   bool more = true;</span>
<a href="#l34.2261"></a><span id="l34.2261"> </span>
<a href="#l34.2262"></a><span id="l34.2262" class="difflineminus">-  // We want to NS_ReadLine until we get to a blank line (the end of the headers)</span>
<a href="#l34.2263"></a><span id="l34.2263" class="difflineminus">-  while (more)</span>
<a href="#l34.2264"></a><span id="l34.2264" class="difflineminus">-  {</span>
<a href="#l34.2265"></a><span id="l34.2265" class="difflineplus">+  // We want to NS_ReadLine until we get to a blank line (the end of the</span>
<a href="#l34.2266"></a><span id="l34.2266" class="difflineplus">+  // headers)</span>
<a href="#l34.2267"></a><span id="l34.2267" class="difflineplus">+  while (more) {</span>
<a href="#l34.2268"></a><span id="l34.2268">     rv = NS_ReadLine(aInputStream, lineBuffer.get(), curLine, &amp;more);</span>
<a href="#l34.2269"></a><span id="l34.2269">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2270"></a><span id="l34.2270" class="difflineminus">-    if (curLine.IsEmpty())</span>
<a href="#l34.2271"></a><span id="l34.2271" class="difflineminus">-      break;</span>
<a href="#l34.2272"></a><span id="l34.2272" class="difflineplus">+    if (curLine.IsEmpty()) break;</span>
<a href="#l34.2273"></a><span id="l34.2273">     msgHeaders.Append(curLine);</span>
<a href="#l34.2274"></a><span id="l34.2274">     msgHeaders.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l34.2275"></a><span id="l34.2275">   }</span>
<a href="#l34.2276"></a><span id="l34.2276">   lineBuffer = nullptr;</span>
<a href="#l34.2277"></a><span id="l34.2277">   nsCOMPtr&lt;nsIStringInputStream&gt; hdrsStream =</span>
<a href="#l34.2278"></a><span id="l34.2278" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv);</span>
<a href="#l34.2279"></a><span id="l34.2279" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv);</span>
<a href="#l34.2280"></a><span id="l34.2280">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2281"></a><span id="l34.2281">   hdrsStream-&gt;SetData(msgHeaders.get(), msgHeaders.Length());</span>
<a href="#l34.2282"></a><span id="l34.2282"> </span>
<a href="#l34.2283"></a><span id="l34.2283">   nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l34.2284"></a><span id="l34.2284">   rv = NS_NewInputStreamPump(getter_AddRefs(pump), hdrsStream.forget());</span>
<a href="#l34.2285"></a><span id="l34.2285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2286"></a><span id="l34.2286"> </span>
<a href="#l34.2287"></a><span id="l34.2287">   return pump-&gt;AsyncRead(aConsumer, nullptr);</span>
<a href="#l34.2288"></a><span id="l34.2288"> }</span>
<a href="#l34.2289"></a><span id="l34.2289"> </span>
<a href="#l34.2290"></a><span id="l34.2290" class="difflineminus">-class CharsetDetectionObserver : public nsICharsetDetectionObserver</span>
<a href="#l34.2291"></a><span id="l34.2291" class="difflineminus">-{</span>
<a href="#l34.2292"></a><span id="l34.2292" class="difflineminus">-public:</span>
<a href="#l34.2293"></a><span id="l34.2293" class="difflineplus">+class CharsetDetectionObserver : public nsICharsetDetectionObserver {</span>
<a href="#l34.2294"></a><span id="l34.2294" class="difflineplus">+ public:</span>
<a href="#l34.2295"></a><span id="l34.2295">   NS_DECL_ISUPPORTS</span>
<a href="#l34.2296"></a><span id="l34.2296" class="difflineminus">-  CharsetDetectionObserver() {};</span>
<a href="#l34.2297"></a><span id="l34.2297" class="difflineminus">-  NS_IMETHOD Notify(const char* aCharset, nsDetectionConfident aConf) override</span>
<a href="#l34.2298"></a><span id="l34.2298" class="difflineminus">-  {</span>
<a href="#l34.2299"></a><span id="l34.2299" class="difflineplus">+  CharsetDetectionObserver(){};</span>
<a href="#l34.2300"></a><span id="l34.2300" class="difflineplus">+  NS_IMETHOD Notify(const char *aCharset, nsDetectionConfident aConf) override {</span>
<a href="#l34.2301"></a><span id="l34.2301">     mCharset.AssignASCII(aCharset);</span>
<a href="#l34.2302"></a><span id="l34.2302">     return NS_OK;</span>
<a href="#l34.2303"></a><span id="l34.2303">   };</span>
<a href="#l34.2304"></a><span id="l34.2304" class="difflineminus">-  void GetDetectedCharset(nsACString&amp; aCharset) { aCharset = mCharset; }</span>
<a href="#l34.2305"></a><span id="l34.2305" class="difflineplus">+  void GetDetectedCharset(nsACString &amp;aCharset) { aCharset = mCharset; }</span>
<a href="#l34.2306"></a><span id="l34.2306"> </span>
<a href="#l34.2307"></a><span id="l34.2307" class="difflineminus">-private:</span>
<a href="#l34.2308"></a><span id="l34.2308" class="difflineplus">+ private:</span>
<a href="#l34.2309"></a><span id="l34.2309">   virtual ~CharsetDetectionObserver() {}</span>
<a href="#l34.2310"></a><span id="l34.2310">   nsCString mCharset;</span>
<a href="#l34.2311"></a><span id="l34.2311"> };</span>
<a href="#l34.2312"></a><span id="l34.2312"> </span>
<a href="#l34.2313"></a><span id="l34.2313"> NS_IMPL_ISUPPORTS(CharsetDetectionObserver, nsICharsetDetectionObserver)</span>
<a href="#l34.2314"></a><span id="l34.2314"> </span>
<a href="#l34.2315"></a><span id="l34.2315" class="difflineminus">-static bool IsStreamUTF8(nsIInputStream* aStream) {</span>
<a href="#l34.2316"></a><span id="l34.2316" class="difflineplus">+static bool IsStreamUTF8(nsIInputStream *aStream) {</span>
<a href="#l34.2317"></a><span id="l34.2317">   mozilla::Array&lt;uint8_t, 1024&gt; bufferArr;</span>
<a href="#l34.2318"></a><span id="l34.2318" class="difflineminus">-  mozilla::Array&lt;uint8_t, 1028&gt; discardedArr; // 4 slots longer than buffer</span>
<a href="#l34.2319"></a><span id="l34.2319" class="difflineplus">+  mozilla::Array&lt;uint8_t, 1028&gt; discardedArr;  // 4 slots longer than buffer</span>
<a href="#l34.2320"></a><span id="l34.2320">   auto buffer = MakeSpan(bufferArr);</span>
<a href="#l34.2321"></a><span id="l34.2321">   auto discarded = MakeSpan(discardedArr);</span>
<a href="#l34.2322"></a><span id="l34.2322">   auto decoder = UTF_8_ENCODING-&gt;NewDecoderWithoutBOMHandling();</span>
<a href="#l34.2323"></a><span id="l34.2323">   for (;;) {</span>
<a href="#l34.2324"></a><span id="l34.2324">     uint32_t numRead = 0;</span>
<a href="#l34.2325"></a><span id="l34.2325" class="difflineminus">-    nsresult rv = aStream-&gt;Read(reinterpret_cast&lt;char*&gt;(buffer.Elements()),</span>
<a href="#l34.2326"></a><span id="l34.2326" class="difflineplus">+    nsresult rv = aStream-&gt;Read(reinterpret_cast&lt;char *&gt;(buffer.Elements()),</span>
<a href="#l34.2327"></a><span id="l34.2327">                                 buffer.Length(), &amp;numRead);</span>
<a href="#l34.2328"></a><span id="l34.2328">     if (NS_FAILED(rv)) {</span>
<a href="#l34.2329"></a><span id="l34.2329">       return false;</span>
<a href="#l34.2330"></a><span id="l34.2330">     }</span>
<a href="#l34.2331"></a><span id="l34.2331">     uint32_t result;</span>
<a href="#l34.2332"></a><span id="l34.2332">     size_t read;</span>
<a href="#l34.2333"></a><span id="l34.2333">     size_t written;</span>
<a href="#l34.2334"></a><span id="l34.2334">     bool last = (numRead == 0);</span>
<a href="#l34.2335"></a><span id="l34.2335">     mozilla::Tie(result, read, written) =</span>
<a href="#l34.2336"></a><span id="l34.2336" class="difflineminus">-      decoder-&gt;DecodeToUTF8WithoutReplacement(buffer.To(numRead), discarded, last);</span>
<a href="#l34.2337"></a><span id="l34.2337" class="difflineplus">+        decoder-&gt;DecodeToUTF8WithoutReplacement(buffer.To(numRead), discarded,</span>
<a href="#l34.2338"></a><span id="l34.2338" class="difflineplus">+                                                last);</span>
<a href="#l34.2339"></a><span id="l34.2339">     MOZ_ASSERT(result != kOutputFull);</span>
<a href="#l34.2340"></a><span id="l34.2340">     if (last) {</span>
<a href="#l34.2341"></a><span id="l34.2341">       return (result == kInputEmpty);</span>
<a href="#l34.2342"></a><span id="l34.2342">     }</span>
<a href="#l34.2343"></a><span id="l34.2343">     if (result != kInputEmpty) {</span>
<a href="#l34.2344"></a><span id="l34.2344">       return false;</span>
<a href="#l34.2345"></a><span id="l34.2345">     }</span>
<a href="#l34.2346"></a><span id="l34.2346">   }</span>
<a href="#l34.2347"></a><span id="l34.2347"> }</span>
<a href="#l34.2348"></a><span id="l34.2348"> </span>
<a href="#l34.2349"></a><span id="l34.2349" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l34.2350"></a><span id="l34.2350" class="difflineminus">-MsgDetectCharsetFromFile(nsIFile *aFile, nsACString &amp;aCharset)</span>
<a href="#l34.2351"></a><span id="l34.2351" class="difflineminus">-{</span>
<a href="#l34.2352"></a><span id="l34.2352" class="difflineplus">+NS_MSG_BASE nsresult MsgDetectCharsetFromFile(nsIFile *aFile,</span>
<a href="#l34.2353"></a><span id="l34.2353" class="difflineplus">+                                              nsACString &amp;aCharset) {</span>
<a href="#l34.2354"></a><span id="l34.2354">   // We do the detection in this order:</span>
<a href="#l34.2355"></a><span id="l34.2355">   // Check BOM.</span>
<a href="#l34.2356"></a><span id="l34.2356">   // If no BOM, run localized detection (Russian, Ukranian or Japanese).</span>
<a href="#l34.2357"></a><span id="l34.2357" class="difflineminus">-  // We need to run this first, since ISO-2022-JP is 7bit ASCII and would be detected as UTF-8.</span>
<a href="#l34.2358"></a><span id="l34.2358" class="difflineminus">-  // If ISO-2022-JP not detected, check for UTF-8.</span>
<a href="#l34.2359"></a><span id="l34.2359" class="difflineminus">-  // If no UTF-8, but detector detected something, use that, otherwise return an error.</span>
<a href="#l34.2360"></a><span id="l34.2360" class="difflineplus">+  // We need to run this first, since ISO-2022-JP is 7bit ASCII and would be</span>
<a href="#l34.2361"></a><span id="l34.2361" class="difflineplus">+  // detected as UTF-8. If ISO-2022-JP not detected, check for UTF-8. If no</span>
<a href="#l34.2362"></a><span id="l34.2362" class="difflineplus">+  // UTF-8, but detector detected something, use that, otherwise return an</span>
<a href="#l34.2363"></a><span id="l34.2363" class="difflineplus">+  // error.</span>
<a href="#l34.2364"></a><span id="l34.2364">   aCharset.Truncate();</span>
<a href="#l34.2365"></a><span id="l34.2365"> </span>
<a href="#l34.2366"></a><span id="l34.2366">   nsresult rv;</span>
<a href="#l34.2367"></a><span id="l34.2367">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l34.2368"></a><span id="l34.2368">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l34.2369"></a><span id="l34.2369">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2370"></a><span id="l34.2370"> </span>
<a href="#l34.2371"></a><span id="l34.2371">   // Check the BOM.</span>
<a href="#l34.2372"></a><span id="l34.2372">   char sniffBuf[3];</span>
<a href="#l34.2373"></a><span id="l34.2373">   uint32_t numRead;</span>
<a href="#l34.2374"></a><span id="l34.2374">   rv = inputStream-&gt;Read(sniffBuf, sizeof(sniffBuf), &amp;numRead);</span>
<a href="#l34.2375"></a><span id="l34.2375"> </span>
<a href="#l34.2376"></a><span id="l34.2376" class="difflineminus">-  if (numRead &gt;= 2 &amp;&amp;</span>
<a href="#l34.2377"></a><span id="l34.2377" class="difflineminus">-             sniffBuf[0] == (char)0xfe &amp;&amp;</span>
<a href="#l34.2378"></a><span id="l34.2378" class="difflineminus">-             sniffBuf[1] == (char)0xff) {</span>
<a href="#l34.2379"></a><span id="l34.2379" class="difflineplus">+  if (numRead &gt;= 2 &amp;&amp; sniffBuf[0] == (char)0xfe &amp;&amp; sniffBuf[1] == (char)0xff) {</span>
<a href="#l34.2380"></a><span id="l34.2380">     aCharset = &quot;UTF-16BE&quot;;</span>
<a href="#l34.2381"></a><span id="l34.2381" class="difflineminus">-  } else if (numRead &gt;= 2 &amp;&amp;</span>
<a href="#l34.2382"></a><span id="l34.2382" class="difflineminus">-             sniffBuf[0] == (char)0xff &amp;&amp;</span>
<a href="#l34.2383"></a><span id="l34.2383" class="difflineplus">+  } else if (numRead &gt;= 2 &amp;&amp; sniffBuf[0] == (char)0xff &amp;&amp;</span>
<a href="#l34.2384"></a><span id="l34.2384">              sniffBuf[1] == (char)0xfe) {</span>
<a href="#l34.2385"></a><span id="l34.2385">     aCharset = &quot;UTF-16LE&quot;;</span>
<a href="#l34.2386"></a><span id="l34.2386" class="difflineminus">-  } else if (numRead &gt;= 3 &amp;&amp;</span>
<a href="#l34.2387"></a><span id="l34.2387" class="difflineminus">-             sniffBuf[0] == (char)0xef &amp;&amp;</span>
<a href="#l34.2388"></a><span id="l34.2388" class="difflineminus">-             sniffBuf[1] == (char)0xbb &amp;&amp;</span>
<a href="#l34.2389"></a><span id="l34.2389" class="difflineminus">-             sniffBuf[2] == (char)0xbf) {</span>
<a href="#l34.2390"></a><span id="l34.2390" class="difflineplus">+  } else if (numRead &gt;= 3 &amp;&amp; sniffBuf[0] == (char)0xef &amp;&amp;</span>
<a href="#l34.2391"></a><span id="l34.2391" class="difflineplus">+             sniffBuf[1] == (char)0xbb &amp;&amp; sniffBuf[2] == (char)0xbf) {</span>
<a href="#l34.2392"></a><span id="l34.2392">     aCharset = &quot;UTF-8&quot;;</span>
<a href="#l34.2393"></a><span id="l34.2393">   }</span>
<a href="#l34.2394"></a><span id="l34.2394" class="difflineminus">-  if (!aCharset.IsEmpty())</span>
<a href="#l34.2395"></a><span id="l34.2395" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.2396"></a><span id="l34.2396" class="difflineplus">+  if (!aCharset.IsEmpty()) return NS_OK;</span>
<a href="#l34.2397"></a><span id="l34.2397"> </span>
<a href="#l34.2398"></a><span id="l34.2398">   // Position back to the beginning.</span>
<a href="#l34.2399"></a><span id="l34.2399">   nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(inputStream);</span>
<a href="#l34.2400"></a><span id="l34.2400" class="difflineminus">-  if (seekStream)</span>
<a href="#l34.2401"></a><span id="l34.2401" class="difflineminus">-    seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l34.2402"></a><span id="l34.2402" class="difflineplus">+  if (seekStream) seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l34.2403"></a><span id="l34.2403"> </span>
<a href="#l34.2404"></a><span id="l34.2404">   // Use detector.</span>
<a href="#l34.2405"></a><span id="l34.2405">   nsCOMPtr&lt;nsICharsetDetector&gt; detector;</span>
<a href="#l34.2406"></a><span id="l34.2406">   nsAutoCString detectorName;</span>
<a href="#l34.2407"></a><span id="l34.2407">   Preferences::GetLocalizedCString(&quot;intl.charset.detector&quot;, detectorName);</span>
<a href="#l34.2408"></a><span id="l34.2408">   if (!detectorName.IsEmpty()) {</span>
<a href="#l34.2409"></a><span id="l34.2409">     // We recognize one of the three magic strings for the following languages.</span>
<a href="#l34.2410"></a><span id="l34.2410">     if (detectorName.EqualsLiteral(&quot;ruprob&quot;)) {</span>
<a href="#l34.2411"></a><span id="l34.2411" class="difflineat">@@ -2012,120 +1858,99 @@ MsgDetectCharsetFromFile(nsIFile *aFile,</span>
<a href="#l34.2412"></a><span id="l34.2412"> </span>
<a href="#l34.2413"></a><span id="l34.2413">     char buffer[1024];</span>
<a href="#l34.2414"></a><span id="l34.2414">     uint32_t numRead = 0;</span>
<a href="#l34.2415"></a><span id="l34.2415">     bool dontFeed = false;</span>
<a href="#l34.2416"></a><span id="l34.2416">     while (NS_SUCCEEDED(inputStream-&gt;Read(buffer, sizeof(buffer), &amp;numRead))) {</span>
<a href="#l34.2417"></a><span id="l34.2417">       // XXX: We need to break early here to work around a problem in Shift-JIS</span>
<a href="#l34.2418"></a><span id="l34.2418">       // detection. If we call `DoIt()` with any empty buffer, Shift-JIS is not</span>
<a href="#l34.2419"></a><span id="l34.2419">       // detected, however ISO-2022-JP is detected.</span>
<a href="#l34.2420"></a><span id="l34.2420" class="difflineminus">-      if (numRead == 0)</span>
<a href="#l34.2421"></a><span id="l34.2421" class="difflineminus">-        break;</span>
<a href="#l34.2422"></a><span id="l34.2422" class="difflineplus">+      if (numRead == 0) break;</span>
<a href="#l34.2423"></a><span id="l34.2423">       detector-&gt;DoIt(buffer, numRead, &amp;dontFeed);</span>
<a href="#l34.2424"></a><span id="l34.2424">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2425"></a><span id="l34.2425" class="difflineminus">-      if (dontFeed)  // XXX: We should really break here with: if (dontFeed || numRead == 0).</span>
<a href="#l34.2426"></a><span id="l34.2426" class="difflineplus">+      if (dontFeed)  // XXX: We should really break here with: if (dontFeed ||</span>
<a href="#l34.2427"></a><span id="l34.2427" class="difflineplus">+                     // numRead == 0).</span>
<a href="#l34.2428"></a><span id="l34.2428">         break;</span>
<a href="#l34.2429"></a><span id="l34.2429">     }</span>
<a href="#l34.2430"></a><span id="l34.2430">     rv = detector-&gt;Done();</span>
<a href="#l34.2431"></a><span id="l34.2431">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.2432"></a><span id="l34.2432"> </span>
<a href="#l34.2433"></a><span id="l34.2433">     observer-&gt;GetDetectedCharset(aCharset);</span>
<a href="#l34.2434"></a><span id="l34.2434">   }</span>
<a href="#l34.2435"></a><span id="l34.2435"> </span>
<a href="#l34.2436"></a><span id="l34.2436" class="difflineminus">-  if (aCharset.EqualsLiteral(&quot;ISO-2022-JP&quot;))</span>
<a href="#l34.2437"></a><span id="l34.2437" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.2438"></a><span id="l34.2438" class="difflineplus">+  if (aCharset.EqualsLiteral(&quot;ISO-2022-JP&quot;)) return NS_OK;</span>
<a href="#l34.2439"></a><span id="l34.2439"> </span>
<a href="#l34.2440"></a><span id="l34.2440">   // Rewind file again.</span>
<a href="#l34.2441"></a><span id="l34.2441">   seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l34.2442"></a><span id="l34.2442"> </span>
<a href="#l34.2443"></a><span id="l34.2443">   // Check UTF-8.</span>
<a href="#l34.2444"></a><span id="l34.2444">   if (IsStreamUTF8(inputStream)) {</span>
<a href="#l34.2445"></a><span id="l34.2445">     aCharset.AssignLiteral(&quot;UTF-8&quot;);</span>
<a href="#l34.2446"></a><span id="l34.2446">     return NS_OK;</span>
<a href="#l34.2447"></a><span id="l34.2447">   }</span>
<a href="#l34.2448"></a><span id="l34.2448"> </span>
<a href="#l34.2449"></a><span id="l34.2449">   // No UTF-8 detected, use previous detection result.</span>
<a href="#l34.2450"></a><span id="l34.2450" class="difflineminus">-  if (!aCharset.IsEmpty())</span>
<a href="#l34.2451"></a><span id="l34.2451" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.2452"></a><span id="l34.2452" class="difflineplus">+  if (!aCharset.IsEmpty()) return NS_OK;</span>
<a href="#l34.2453"></a><span id="l34.2453"> </span>
<a href="#l34.2454"></a><span id="l34.2454">   // Nothing found, leave it to the caller.</span>
<a href="#l34.2455"></a><span id="l34.2455">   return NS_ERROR_FAILURE;</span>
<a href="#l34.2456"></a><span id="l34.2456"> }</span>
<a href="#l34.2457"></a><span id="l34.2457"> </span>
<a href="#l34.2458"></a><span id="l34.2458"> /*</span>
<a href="#l34.2459"></a><span id="l34.2459">  * Converts a buffer to plain text. Some conversions may</span>
<a href="#l34.2460"></a><span id="l34.2460">  * or may not work with certain end charsets which is why we</span>
<a href="#l34.2461"></a><span id="l34.2461">  * need that as an argument to the function. If charset is</span>
<a href="#l34.2462"></a><span id="l34.2462">  * unknown or deemed of no importance NULL could be passed.</span>
<a href="#l34.2463"></a><span id="l34.2463">  */</span>
<a href="#l34.2464"></a><span id="l34.2464" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l34.2465"></a><span id="l34.2465" class="difflineminus">-ConvertBufToPlainText(nsString &amp;aConBuf, bool formatFlowed, bool delsp,</span>
<a href="#l34.2466"></a><span id="l34.2466" class="difflineminus">-                                         bool formatOutput, bool disallowBreaks)</span>
<a href="#l34.2467"></a><span id="l34.2467" class="difflineminus">-{</span>
<a href="#l34.2468"></a><span id="l34.2468" class="difflineminus">-  if (aConBuf.IsEmpty())</span>
<a href="#l34.2469"></a><span id="l34.2469" class="difflineminus">-    return NS_OK;</span>
<a href="#l34.2470"></a><span id="l34.2470" class="difflineplus">+NS_MSG_BASE nsresult ConvertBufToPlainText(nsString &amp;aConBuf, bool formatFlowed,</span>
<a href="#l34.2471"></a><span id="l34.2471" class="difflineplus">+                                           bool delsp, bool formatOutput,</span>
<a href="#l34.2472"></a><span id="l34.2472" class="difflineplus">+                                           bool disallowBreaks) {</span>
<a href="#l34.2473"></a><span id="l34.2473" class="difflineplus">+  if (aConBuf.IsEmpty()) return NS_OK;</span>
<a href="#l34.2474"></a><span id="l34.2474"> </span>
<a href="#l34.2475"></a><span id="l34.2475">   int32_t wrapWidth = 72;</span>
<a href="#l34.2476"></a><span id="l34.2476">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l34.2477"></a><span id="l34.2477"> </span>
<a href="#l34.2478"></a><span id="l34.2478" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l34.2479"></a><span id="l34.2479" class="difflineminus">-  {</span>
<a href="#l34.2480"></a><span id="l34.2480" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l34.2481"></a><span id="l34.2481">     pPrefBranch-&gt;GetIntPref(&quot;mailnews.wraplength&quot;, &amp;wrapWidth);</span>
<a href="#l34.2482"></a><span id="l34.2482">     // Let sanity reign!</span>
<a href="#l34.2483"></a><span id="l34.2483">     if (wrapWidth == 0 || wrapWidth &gt; 990)</span>
<a href="#l34.2484"></a><span id="l34.2484">       wrapWidth = 990;</span>
<a href="#l34.2485"></a><span id="l34.2485">     else if (wrapWidth &lt; 10)</span>
<a href="#l34.2486"></a><span id="l34.2486">       wrapWidth = 10;</span>
<a href="#l34.2487"></a><span id="l34.2487">   }</span>
<a href="#l34.2488"></a><span id="l34.2488"> </span>
<a href="#l34.2489"></a><span id="l34.2489">   uint32_t converterFlags = nsIDocumentEncoder::OutputPersistNBSP;</span>
<a href="#l34.2490"></a><span id="l34.2490" class="difflineminus">-  if (formatFlowed)</span>
<a href="#l34.2491"></a><span id="l34.2491" class="difflineminus">-    converterFlags |= nsIDocumentEncoder::OutputFormatFlowed;</span>
<a href="#l34.2492"></a><span id="l34.2492" class="difflineminus">-  if (delsp)</span>
<a href="#l34.2493"></a><span id="l34.2493" class="difflineminus">-    converterFlags |= nsIDocumentEncoder::OutputFormatDelSp;</span>
<a href="#l34.2494"></a><span id="l34.2494" class="difflineminus">-  if (formatOutput)</span>
<a href="#l34.2495"></a><span id="l34.2495" class="difflineminus">-    converterFlags |= nsIDocumentEncoder::OutputFormatted;</span>
<a href="#l34.2496"></a><span id="l34.2496" class="difflineplus">+  if (formatFlowed) converterFlags |= nsIDocumentEncoder::OutputFormatFlowed;</span>
<a href="#l34.2497"></a><span id="l34.2497" class="difflineplus">+  if (delsp) converterFlags |= nsIDocumentEncoder::OutputFormatDelSp;</span>
<a href="#l34.2498"></a><span id="l34.2498" class="difflineplus">+  if (formatOutput) converterFlags |= nsIDocumentEncoder::OutputFormatted;</span>
<a href="#l34.2499"></a><span id="l34.2499">   if (disallowBreaks)</span>
<a href="#l34.2500"></a><span id="l34.2500">     converterFlags |= nsIDocumentEncoder::OutputDisallowLineBreaking;</span>
<a href="#l34.2501"></a><span id="l34.2501"> </span>
<a href="#l34.2502"></a><span id="l34.2502" class="difflineminus">-  nsCOMPtr&lt;nsIParserUtils&gt; utils =</span>
<a href="#l34.2503"></a><span id="l34.2503" class="difflineminus">-    do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l34.2504"></a><span id="l34.2504" class="difflineminus">-  return utils-&gt;ConvertToPlainText(aConBuf,</span>
<a href="#l34.2505"></a><span id="l34.2505" class="difflineminus">-                                   converterFlags,</span>
<a href="#l34.2506"></a><span id="l34.2506" class="difflineminus">-                                   wrapWidth,</span>
<a href="#l34.2507"></a><span id="l34.2507" class="difflineminus">-                                   aConBuf);</span>
<a href="#l34.2508"></a><span id="l34.2508" class="difflineplus">+  nsCOMPtr&lt;nsIParserUtils&gt; utils = do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l34.2509"></a><span id="l34.2509" class="difflineplus">+  return utils-&gt;ConvertToPlainText(aConBuf, converterFlags, wrapWidth, aConBuf);</span>
<a href="#l34.2510"></a><span id="l34.2510"> }</span>
<a href="#l34.2511"></a><span id="l34.2511"> </span>
<a href="#l34.2512"></a><span id="l34.2512" class="difflineminus">-NS_MSG_BASE nsMsgKey msgKeyFromInt(uint32_t aValue)</span>
<a href="#l34.2513"></a><span id="l34.2513" class="difflineminus">-{</span>
<a href="#l34.2514"></a><span id="l34.2514" class="difflineminus">-  return aValue;</span>
<a href="#l34.2515"></a><span id="l34.2515" class="difflineminus">-}</span>
<a href="#l34.2516"></a><span id="l34.2516" class="difflineplus">+NS_MSG_BASE nsMsgKey msgKeyFromInt(uint32_t aValue) { return aValue; }</span>
<a href="#l34.2517"></a><span id="l34.2517"> </span>
<a href="#l34.2518"></a><span id="l34.2518" class="difflineminus">-NS_MSG_BASE nsMsgKey msgKeyFromInt(uint64_t aValue)</span>
<a href="#l34.2519"></a><span id="l34.2519" class="difflineminus">-{</span>
<a href="#l34.2520"></a><span id="l34.2520" class="difflineplus">+NS_MSG_BASE nsMsgKey msgKeyFromInt(uint64_t aValue) {</span>
<a href="#l34.2521"></a><span id="l34.2521">   NS_ASSERTION(aValue &lt;= PR_UINT32_MAX, &quot;Msg key value too big!&quot;);</span>
<a href="#l34.2522"></a><span id="l34.2522">   return aValue;</span>
<a href="#l34.2523"></a><span id="l34.2523"> }</span>
<a href="#l34.2524"></a><span id="l34.2524"> </span>
<a href="#l34.2525"></a><span id="l34.2525" class="difflineminus">-NS_MSG_BASE uint32_t msgKeyToInt(nsMsgKey aMsgKey)</span>
<a href="#l34.2526"></a><span id="l34.2526" class="difflineminus">-{</span>
<a href="#l34.2527"></a><span id="l34.2527" class="difflineminus">-  return (uint32_t)aMsgKey;</span>
<a href="#l34.2528"></a><span id="l34.2528" class="difflineminus">-}</span>
<a href="#l34.2529"></a><span id="l34.2529" class="difflineplus">+NS_MSG_BASE uint32_t msgKeyToInt(nsMsgKey aMsgKey) { return (uint32_t)aMsgKey; }</span>
<a href="#l34.2530"></a><span id="l34.2530"> </span>
<a href="#l34.2531"></a><span id="l34.2531"> // Helper function to extract a query qualifier.</span>
<a href="#l34.2532"></a><span id="l34.2532" class="difflineminus">-nsCString MsgExtractQueryPart(const nsACString&amp; spec, const char* queryToExtract)</span>
<a href="#l34.2533"></a><span id="l34.2533" class="difflineminus">-{</span>
<a href="#l34.2534"></a><span id="l34.2534" class="difflineplus">+nsCString MsgExtractQueryPart(const nsACString &amp;spec,</span>
<a href="#l34.2535"></a><span id="l34.2535" class="difflineplus">+                              const char *queryToExtract) {</span>
<a href="#l34.2536"></a><span id="l34.2536">   nsCString queryPart;</span>
<a href="#l34.2537"></a><span id="l34.2537">   int32_t queryIndex = PromiseFlatCString(spec).Find(queryToExtract);</span>
<a href="#l34.2538"></a><span id="l34.2538" class="difflineminus">-  if (queryIndex == kNotFound)</span>
<a href="#l34.2539"></a><span id="l34.2539" class="difflineminus">-    return queryPart;</span>
<a href="#l34.2540"></a><span id="l34.2540" class="difflineplus">+  if (queryIndex == kNotFound) return queryPart;</span>
<a href="#l34.2541"></a><span id="l34.2541"> </span>
<a href="#l34.2542"></a><span id="l34.2542">   int32_t queryEnd = spec.FindChar('&amp;', queryIndex + 1);</span>
<a href="#l34.2543"></a><span id="l34.2543" class="difflineminus">-  if (queryEnd == kNotFound)</span>
<a href="#l34.2544"></a><span id="l34.2544" class="difflineminus">-    queryEnd = spec.FindChar('?', queryIndex + 1);</span>
<a href="#l34.2545"></a><span id="l34.2545" class="difflineplus">+  if (queryEnd == kNotFound) queryEnd = spec.FindChar('?', queryIndex + 1);</span>
<a href="#l34.2546"></a><span id="l34.2546">   if (queryEnd == kNotFound) {</span>
<a href="#l34.2547"></a><span id="l34.2547">     // Nothing follows, so return from where the query qualifier started.</span>
<a href="#l34.2548"></a><span id="l34.2548">     queryPart.Assign(Substring(spec, queryIndex));</span>
<a href="#l34.2549"></a><span id="l34.2549">   } else {</span>
<a href="#l34.2550"></a><span id="l34.2550">     // Return the substring that represents the query qualifier.</span>
<a href="#l34.2551"></a><span id="l34.2551">     queryPart.Assign(Substring(spec, queryIndex, queryEnd - queryIndex));</span>
<a href="#l34.2552"></a><span id="l34.2552">   }</span>
<a href="#l34.2553"></a><span id="l34.2553">   return queryPart;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -33,233 +33,249 @@ class nsIInputStream;</span>
<a href="#l35.4"></a><span id="l35.4"> class nsIMsgDatabase;</span>
<a href="#l35.5"></a><span id="l35.5"> class nsIMutableArray;</span>
<a href="#l35.6"></a><span id="l35.6"> class nsIProxyInfo;</span>
<a href="#l35.7"></a><span id="l35.7"> class nsIMsgWindow;</span>
<a href="#l35.8"></a><span id="l35.8"> class nsIStreamListener;</span>
<a href="#l35.9"></a><span id="l35.9"> class nsICancelable;</span>
<a href="#l35.10"></a><span id="l35.10"> class nsIProtocolProxyCallback;</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#define FILE_IO_BUFFER_SIZE (16*1024)</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-#define MSGS_URL    &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+#define FILE_IO_BUFFER_SIZE (16 * 1024)</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+#define MSGS_URL &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+// These are utility functions that can used throughout the mailnews code</span>
<a href="#l35.18"></a><span id="l35.18"> </span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-//These are utility functions that can used throughout the mailnews code</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+NS_MSG_BASE nsresult GetMessageServiceContractIDForURI(const char *uri,</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+                                                       nsCString &amp;contractID);</span>
<a href="#l35.22"></a><span id="l35.22"> </span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-NS_MSG_BASE nsresult GetMessageServiceContractIDForURI(const char *uri, nsCString &amp;contractID);</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-NS_MSG_BASE nsresult GetMessageServiceFromURI(const nsACString&amp; uri, nsIMsgMessageService **aMessageService);</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+NS_MSG_BASE nsresult GetMessageServiceFromURI(</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+    const nsACString &amp;uri, nsIMsgMessageService **aMessageService);</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29"> NS_MSG_BASE nsresult GetMsgDBHdrFromURI(const char *uri, nsIMsgDBHdr **msgHdr);</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31"> NS_MSG_BASE nsresult NS_MsgGetPriorityFromString(</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-                       const char * const priority,</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-                       nsMsgPriorityValue &amp; outPriority);</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+    const char *const priority, nsMsgPriorityValue &amp;outPriority);</span>
<a href="#l35.35"></a><span id="l35.35"> </span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-NS_MSG_BASE nsresult NS_MsgGetPriorityValueString(</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-                       const nsMsgPriorityValue p,</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-                       nsACString &amp; outValueString);</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+NS_MSG_BASE nsresult NS_MsgGetPriorityValueString(const nsMsgPriorityValue p,</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+                                                  nsACString &amp;outValueString);</span>
<a href="#l35.41"></a><span id="l35.41"> </span>
<a href="#l35.42"></a><span id="l35.42"> NS_MSG_BASE nsresult NS_MsgGetUntranslatedPriorityName(</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-                       const nsMsgPriorityValue p,</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-                       nsACString &amp; outName);</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+    const nsMsgPriorityValue p, nsACString &amp;outName);</span>
<a href="#l35.46"></a><span id="l35.46"> </span>
<a href="#l35.47"></a><span id="l35.47"> NS_MSG_BASE nsresult NS_MsgHashIfNecessary(nsAutoString &amp;name);</span>
<a href="#l35.48"></a><span id="l35.48"> NS_MSG_BASE nsresult NS_MsgHashIfNecessary(nsAutoCString &amp;name);</span>
<a href="#l35.49"></a><span id="l35.49"> </span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-NS_MSG_BASE nsresult FormatFileSize(int64_t size, bool useKB, nsAString &amp;formattedSize);</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+NS_MSG_BASE nsresult FormatFileSize(int64_t size, bool useKB,</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+                                    nsAString &amp;formattedSize);</span>
<a href="#l35.54"></a><span id="l35.54"> </span>
<a href="#l35.55"></a><span id="l35.55"> /**</span>
<a href="#l35.56"></a><span id="l35.56">  * given a folder uri, return the path to folder in the user profile directory.</span>
<a href="#l35.57"></a><span id="l35.57">  *</span>
<a href="#l35.58"></a><span id="l35.58">  * @param aFolderURI uri of folder we want the path to, without the scheme</span>
<a href="#l35.59"></a><span id="l35.59">  * @param[out] aPathString result path string</span>
<a href="#l35.60"></a><span id="l35.60">  * @param aScheme scheme of the uri</span>
<a href="#l35.61"></a><span id="l35.61">  * @param[optional] aIsNewsFolder is this a news folder?</span>
<a href="#l35.62"></a><span id="l35.62">  */</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineminus">-NS_MsgCreatePathStringFromFolderURI(const char *aFolderURI,</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineminus">-                                    nsCString&amp; aPathString,</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-                                    const nsCString &amp;aScheme,</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineminus">-                                    bool aIsNewsFolder=false);</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+NS_MSG_BASE nsresult NS_MsgCreatePathStringFromFolderURI(</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+    const char *aFolderURI, nsCString &amp;aPathString, const nsCString &amp;aScheme,</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+    bool aIsNewsFolder = false);</span>
<a href="#l35.71"></a><span id="l35.71"> </span>
<a href="#l35.72"></a><span id="l35.72"> /**</span>
<a href="#l35.73"></a><span id="l35.73">  * Given a string and a length, removes any &quot;Re:&quot; strings from the front.</span>
<a href="#l35.74"></a><span id="l35.74">  * It also deals with that dumbass &quot;Re[2]:&quot; thing that some losing mailers do.</span>
<a href="#l35.75"></a><span id="l35.75">  *</span>
<a href="#l35.76"></a><span id="l35.76">  * If mailnews.localizedRe is set, it will also remove localized &quot;Re:&quot; strings.</span>
<a href="#l35.77"></a><span id="l35.77">  *</span>
<a href="#l35.78"></a><span id="l35.78">  * @return true if it made a change (in which case the caller should look to</span>
<a href="#l35.79"></a><span id="l35.79">  *         modifiedSubject for the result) and false otherwise (in which</span>
<a href="#l35.80"></a><span id="l35.80">  *         case the caller should look at subject for the result)</span>
<a href="#l35.81"></a><span id="l35.81">  */</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineminus">-NS_MSG_BASE bool NS_MsgStripRE(const nsCString&amp; subject, nsCString&amp; modifiedSubject);</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+NS_MSG_BASE bool NS_MsgStripRE(const nsCString &amp;subject,</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+                               nsCString &amp;modifiedSubject);</span>
<a href="#l35.85"></a><span id="l35.85"> </span>
<a href="#l35.86"></a><span id="l35.86" class="difflineminus">-NS_MSG_BASE char * NS_MsgSACopy(char **destination, const char *source);</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineminus">-</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineminus">-NS_MSG_BASE char * NS_MsgSACat(char **destination, const char *source);</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+NS_MSG_BASE char *NS_MsgSACopy(char **destination, const char *source);</span>
<a href="#l35.90"></a><span id="l35.90"> </span>
<a href="#l35.91"></a><span id="l35.91" class="difflineminus">-NS_MSG_BASE nsresult NS_MsgEscapeEncodeURLPath(const nsAString&amp; aStr,</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineminus">-                                               nsCString&amp; aResult);</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+NS_MSG_BASE char *NS_MsgSACat(char **destination, const char *source);</span>
<a href="#l35.94"></a><span id="l35.94"> </span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-NS_MSG_BASE nsresult NS_MsgDecodeUnescapeURLPath(const nsACString&amp; aPath,</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineminus">-                                                 nsAString&amp; aResult);</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+NS_MSG_BASE nsresult NS_MsgEscapeEncodeURLPath(const nsAString &amp;aStr,</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+                                               nsCString &amp;aResult);</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+NS_MSG_BASE nsresult NS_MsgDecodeUnescapeURLPath(const nsACString &amp;aPath,</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+                                                 nsAString &amp;aResult);</span>
<a href="#l35.102"></a><span id="l35.102"> </span>
<a href="#l35.103"></a><span id="l35.103"> NS_MSG_BASE bool WeAreOffline();</span>
<a href="#l35.104"></a><span id="l35.104"> </span>
<a href="#l35.105"></a><span id="l35.105"> // Get a folder by Uri, returning null if it doesn't exist (or if some</span>
<a href="#l35.106"></a><span id="l35.106"> // error occurs). A missing folder is not considered an error.</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineminus">-NS_MSG_BASE nsresult FindFolder(const nsACString&amp; aFolderURI, nsIMsgFolder **aFolder);</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+NS_MSG_BASE nsresult FindFolder(const nsACString &amp;aFolderURI,</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+                                nsIMsgFolder **aFolder);</span>
<a href="#l35.110"></a><span id="l35.110"> </span>
<a href="#l35.111"></a><span id="l35.111"> // Get a folder by Uri.</span>
<a href="#l35.112"></a><span id="l35.112"> // A missing folder is considered to be an error.</span>
<a href="#l35.113"></a><span id="l35.113"> // Returns a non-null folder if and only if result is NS_OK.</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineminus">-NS_MSG_BASE nsresult GetExistingFolder(const nsACString&amp; aFolderURI, nsIMsgFolder **aFolder);</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+NS_MSG_BASE nsresult GetExistingFolder(const nsACString &amp;aFolderURI,</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+                                       nsIMsgFolder **aFolder);</span>
<a href="#l35.117"></a><span id="l35.117"> </span>
<a href="#l35.118"></a><span id="l35.118"> // Get a folder by Uri, creating it if it doesn't already exist.</span>
<a href="#l35.119"></a><span id="l35.119"> // An error is returned if a folder cannot be found or created.</span>
<a href="#l35.120"></a><span id="l35.120"> // Created folders will be 'dangling' folders (ie not connected to a</span>
<a href="#l35.121"></a><span id="l35.121"> // parent).</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineminus">-NS_MSG_BASE nsresult GetOrCreateFolder(const nsACString&amp; aFolderURI, nsIMsgFolder **aFolder);</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+NS_MSG_BASE nsresult GetOrCreateFolder(const nsACString &amp;aFolderURI,</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+                                       nsIMsgFolder **aFolder);</span>
<a href="#l35.125"></a><span id="l35.125"> </span>
<a href="#l35.126"></a><span id="l35.126"> // Escape lines starting with &quot;From &quot;, &quot;&gt;From &quot;, etc. in a buffer.</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineminus">-NS_MSG_BASE nsresult EscapeFromSpaceLine(nsIOutputStream *ouputStream, char *start, const char *end);</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+NS_MSG_BASE nsresult EscapeFromSpaceLine(nsIOutputStream *ouputStream,</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+                                         char *start, const char *end);</span>
<a href="#l35.130"></a><span id="l35.130"> NS_MSG_BASE bool IsAFromSpaceLine(char *start, const char *end);</span>
<a href="#l35.131"></a><span id="l35.131"> </span>
<a href="#l35.132"></a><span id="l35.132" class="difflineminus">-NS_MSG_BASE nsresult NS_GetPersistentFile(const char *relPrefName,</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineminus">-                                          const char *absPrefName,</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineminus">-                                          const char *dirServiceProp, // Can be NULL</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-                                          bool&amp; gotRelPref,</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-                                          nsIFile **aFile,</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-                                          nsIPrefBranch *prefBranch = nullptr);</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+NS_MSG_BASE nsresult NS_GetPersistentFile(</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+    const char *relPrefName, const char *absPrefName,</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+    const char *dirServiceProp,  // Can be NULL</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+    bool &amp;gotRelPref, nsIFile **aFile, nsIPrefBranch *prefBranch = nullptr);</span>
<a href="#l35.142"></a><span id="l35.142"> </span>
<a href="#l35.143"></a><span id="l35.143"> NS_MSG_BASE nsresult NS_SetPersistentFile(const char *relPrefName,</span>
<a href="#l35.144"></a><span id="l35.144">                                           const char *absPrefName,</span>
<a href="#l35.145"></a><span id="l35.145">                                           nsIFile *aFile,</span>
<a href="#l35.146"></a><span id="l35.146">                                           nsIPrefBranch *prefBranch = nullptr);</span>
<a href="#l35.147"></a><span id="l35.147"> </span>
<a href="#l35.148"></a><span id="l35.148"> NS_MSG_BASE nsresult IsRFC822HeaderFieldName(const char *aHdr, bool *aResult);</span>
<a href="#l35.149"></a><span id="l35.149"> </span>
<a href="#l35.150"></a><span id="l35.150" class="difflineminus">-NS_MSG_BASE nsresult NS_GetUnicharPreferenceWithDefault(nsIPrefBranch *prefBranch,   //can be null, if so uses the root branch</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineminus">-                                                        const char *prefName,</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineminus">-                                                        const nsAString&amp; defValue,</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineminus">-                                                        nsAString&amp; prefValue);</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+NS_MSG_BASE nsresult NS_GetUnicharPreferenceWithDefault(</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+    nsIPrefBranch *prefBranch,  // can be null, if so uses the root branch</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    const char *prefName, const nsAString &amp;defValue, nsAString &amp;prefValue);</span>
<a href="#l35.157"></a><span id="l35.157"> </span>
<a href="#l35.158"></a><span id="l35.158" class="difflineminus">-NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreferenceWithDefault(nsIPrefBranch *prefBranch,   //can be null, if so uses the root branch</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineminus">-                                                                 const char *prefName,</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineminus">-                                                                 const nsAString&amp; defValue,</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineminus">-                                                                 nsAString&amp; prefValue);</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+    nsIPrefBranch *prefBranch,  // can be null, if so uses the root branch</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+    const char *prefName, const nsAString &amp;defValue, nsAString &amp;prefValue);</span>
<a href="#l35.165"></a><span id="l35.165"> </span>
<a href="#l35.166"></a><span id="l35.166" class="difflineminus">-NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreference(nsIPrefBranch *prefBranch,   //can be null, if so uses the root branch</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineminus">-                                                      const char *prefName,</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineminus">-                                                      nsAString&amp; prefValue);</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+NS_MSG_BASE nsresult NS_GetLocalizedUnicharPreference(</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+    nsIPrefBranch *prefBranch,  // can be null, if so uses the root branch</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+    const char *prefName, nsAString &amp;prefValue);</span>
<a href="#l35.172"></a><span id="l35.172"> </span>
<a href="#l35.173"></a><span id="l35.173" class="difflineminus">-  /**</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-   * this needs a listener, because we might have to create the folder</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineminus">-   * on the server, and that is asynchronous</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineminus">-   */</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineminus">-NS_MSG_BASE nsresult GetOrCreateJunkFolder(const nsACString &amp; aURI, nsIUrlListener *aListener);</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+/**</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+ * this needs a listener, because we might have to create the folder</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+ * on the server, and that is asynchronous</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+ */</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+NS_MSG_BASE nsresult GetOrCreateJunkFolder(const nsACString &amp;aURI,</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+                                           nsIUrlListener *aListener);</span>
<a href="#l35.184"></a><span id="l35.184"> </span>
<a href="#l35.185"></a><span id="l35.185"> // Returns true if the nsIURI is a message under an RSS account</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineminus">-NS_MSG_BASE nsresult IsRSSArticle(nsIURI * aMsgURI, bool *aIsRSSArticle);</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+NS_MSG_BASE nsresult IsRSSArticle(nsIURI *aMsgURI, bool *aIsRSSArticle);</span>
<a href="#l35.188"></a><span id="l35.188"> </span>
<a href="#l35.189"></a><span id="l35.189"> // digest needs to be a pointer to a 16 byte buffer</span>
<a href="#l35.190"></a><span id="l35.190"> #define DIGEST_LENGTH 16</span>
<a href="#l35.191"></a><span id="l35.191"> </span>
<a href="#l35.192"></a><span id="l35.192" class="difflineminus">-NS_MSG_BASE nsresult MSGCramMD5(const char *text, int32_t text_len, const char *key, int32_t key_len, unsigned char *digest);</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineminus">-NS_MSG_BASE nsresult MSGApopMD5(const char *text, int32_t text_len, const char *password, int32_t password_len, unsigned char *digest);</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+NS_MSG_BASE nsresult MSGCramMD5(const char *text, int32_t text_len,</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+                                const char *key, int32_t key_len,</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+                                unsigned char *digest);</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+NS_MSG_BASE nsresult MSGApopMD5(const char *text, int32_t text_len,</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+                                const char *password, int32_t password_len,</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+                                unsigned char *digest);</span>
<a href="#l35.200"></a><span id="l35.200"> </span>
<a href="#l35.201"></a><span id="l35.201" class="difflineminus">-// helper functions to convert a 64bits PRTime into a 32bits value (compatible time_t) and vice versa.</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+// helper functions to convert a 64bits PRTime into a 32bits value (compatible</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+// time_t) and vice versa.</span>
<a href="#l35.204"></a><span id="l35.204"> NS_MSG_BASE void PRTime2Seconds(PRTime prTime, uint32_t *seconds);</span>
<a href="#l35.205"></a><span id="l35.205"> NS_MSG_BASE void PRTime2Seconds(PRTime prTime, int32_t *seconds);</span>
<a href="#l35.206"></a><span id="l35.206"> NS_MSG_BASE void Seconds2PRTime(uint32_t seconds, PRTime *prTime);</span>
<a href="#l35.207"></a><span id="l35.207"> // helper function to generate current date+time as a string</span>
<a href="#l35.208"></a><span id="l35.208"> NS_MSG_BASE void MsgGenerateNowStr(nsACString &amp;nowStr);</span>
<a href="#l35.209"></a><span id="l35.209"> </span>
<a href="#l35.210"></a><span id="l35.210"> // Appends the correct summary file extension onto the supplied fileLocation</span>
<a href="#l35.211"></a><span id="l35.211"> // and returns it in summaryLocation.</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineminus">-NS_MSG_BASE nsresult GetSummaryFileLocation(nsIFile* fileLocation,</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineminus">-                                            nsIFile** summaryLocation);</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+NS_MSG_BASE nsresult GetSummaryFileLocation(nsIFile *fileLocation,</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+                                            nsIFile **summaryLocation);</span>
<a href="#l35.216"></a><span id="l35.216"> </span>
<a href="#l35.217"></a><span id="l35.217"> // Gets a special directory and appends the supplied file name onto it.</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineminus">-NS_MSG_BASE nsresult GetSpecialDirectoryWithFileName(const char* specialDirName,</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineminus">-                                                     const char* fileName,</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineminus">-                                                     nsIFile** result);</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+NS_MSG_BASE nsresult GetSpecialDirectoryWithFileName(const char *specialDirName,</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+                                                     const char *fileName,</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+                                                     nsIFile **result);</span>
<a href="#l35.224"></a><span id="l35.224"> </span>
<a href="#l35.225"></a><span id="l35.225"> // cleanup temp files with the given filename and extension, including</span>
<a href="#l35.226"></a><span id="l35.226"> // the consecutive -NNNN ones that we can find. If there are holes, e.g.,</span>
<a href="#l35.227"></a><span id="l35.227"> // &lt;filename&gt;-1-10,12.&lt;extension&gt; exist, but &lt;filename&gt;-11.&lt;extension&gt; does not</span>
<a href="#l35.228"></a><span id="l35.228"> // we'll clean up 1-10. If the leaks are common, I think the gaps will tend to</span>
<a href="#l35.229"></a><span id="l35.229"> // be filled.</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineminus">-NS_MSG_BASE nsresult MsgCleanupTempFiles(const char *fileName, const char *extension);</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+NS_MSG_BASE nsresult MsgCleanupTempFiles(const char *fileName,</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+                                         const char *extension);</span>
<a href="#l35.233"></a><span id="l35.233"> </span>
<a href="#l35.234"></a><span id="l35.234" class="difflineminus">-NS_MSG_BASE nsresult MsgGetFileStream(nsIFile *file, nsIOutputStream **fileStream);</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+NS_MSG_BASE nsresult MsgGetFileStream(nsIFile *file,</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+                                      nsIOutputStream **fileStream);</span>
<a href="#l35.237"></a><span id="l35.237"> </span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-NS_MSG_BASE nsresult MsgReopenFileStream(nsIFile *file, nsIInputStream *fileStream);</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+NS_MSG_BASE nsresult MsgReopenFileStream(nsIFile *file,</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+                                         nsIInputStream *fileStream);</span>
<a href="#l35.241"></a><span id="l35.241"> </span>
<a href="#l35.242"></a><span id="l35.242"> // Automatically creates an output stream with a suitable buffer</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineminus">-NS_MSG_BASE nsresult MsgNewBufferedFileOutputStream(nsIOutputStream **aResult, nsIFile *aFile, int32_t aIOFlags = -1, int32_t aPerm = -1);</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+NS_MSG_BASE nsresult MsgNewBufferedFileOutputStream(nsIOutputStream **aResult,</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+                                                    nsIFile *aFile,</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+                                                    int32_t aIOFlags = -1,</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+                                                    int32_t aPerm = -1);</span>
<a href="#l35.248"></a><span id="l35.248"> </span>
<a href="#l35.249"></a><span id="l35.249" class="difflineminus">-// Automatically creates an output stream with a suitable buffer, but write to a temporary file first, then rename to aFile</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineminus">-NS_MSG_BASE nsresult MsgNewSafeBufferedFileOutputStream(nsIOutputStream **aResult, nsIFile *aFile, int32_t aIOFlags = -1, int32_t aPerm = -1);</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+// Automatically creates an output stream with a suitable buffer, but write to a</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+// temporary file first, then rename to aFile</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+NS_MSG_BASE nsresult</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+MsgNewSafeBufferedFileOutputStream(nsIOutputStream **aResult, nsIFile *aFile,</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+                                   int32_t aIOFlags = -1, int32_t aPerm = -1);</span>
<a href="#l35.256"></a><span id="l35.256"> </span>
<a href="#l35.257"></a><span id="l35.257"> // fills in the position of the passed in keyword in the passed in keyword list</span>
<a href="#l35.258"></a><span id="l35.258"> // and returns false if the keyword isn't present</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineminus">-NS_MSG_BASE bool MsgFindKeyword(const nsCString &amp;keyword, nsCString &amp;keywords, int32_t *aStartOfKeyword, int32_t *aLength);</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+NS_MSG_BASE bool MsgFindKeyword(const nsCString &amp;keyword, nsCString &amp;keywords,</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+                                int32_t *aStartOfKeyword, int32_t *aLength);</span>
<a href="#l35.262"></a><span id="l35.262"> </span>
<a href="#l35.263"></a><span id="l35.263" class="difflineminus">-NS_MSG_BASE bool MsgHostDomainIsTrusted(nsCString &amp;host, nsCString &amp;trustedMailDomains);</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+NS_MSG_BASE bool MsgHostDomainIsTrusted(nsCString &amp;host,</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+                                        nsCString &amp;trustedMailDomains);</span>
<a href="#l35.266"></a><span id="l35.266"> </span>
<a href="#l35.267"></a><span id="l35.267"> // gets an nsIFile from a UTF-8 file:// path</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineminus">-NS_MSG_BASE nsresult MsgGetLocalFileFromURI(const nsACString &amp;aUTF8Path, nsIFile **aFile);</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+NS_MSG_BASE nsresult MsgGetLocalFileFromURI(const nsACString &amp;aUTF8Path,</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+                                            nsIFile **aFile);</span>
<a href="#l35.271"></a><span id="l35.271"> </span>
<a href="#l35.272"></a><span id="l35.272" class="difflineminus">-NS_MSG_BASE void MsgStripQuotedPrintable (nsCString&amp; aSrc);</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+NS_MSG_BASE void MsgStripQuotedPrintable(nsCString &amp;aSrc);</span>
<a href="#l35.274"></a><span id="l35.274"> </span>
<a href="#l35.275"></a><span id="l35.275"> /*</span>
<a href="#l35.276"></a><span id="l35.276">  * Utility function copied from nsReadableUtils</span>
<a href="#l35.277"></a><span id="l35.277">  */</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineminus">-NS_MSG_BASE bool MsgIsUTF8(const nsACString&amp; aString);</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+NS_MSG_BASE bool MsgIsUTF8(const nsACString &amp;aString);</span>
<a href="#l35.280"></a><span id="l35.280"> </span>
<a href="#l35.281"></a><span id="l35.281"> /*</span>
<a href="#l35.282"></a><span id="l35.282">  * Utility functions that call functions from nsINetUtil</span>
<a href="#l35.283"></a><span id="l35.283">  */</span>
<a href="#l35.284"></a><span id="l35.284"> </span>
<a href="#l35.285"></a><span id="l35.285" class="difflineminus">-NS_MSG_BASE nsresult MsgEscapeString(const nsACString &amp;aStr,</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineminus">-                                     uint32_t aType, nsACString &amp;aResult);</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+NS_MSG_BASE nsresult MsgEscapeString(const nsACString &amp;aStr, uint32_t aType,</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+                                     nsACString &amp;aResult);</span>
<a href="#l35.289"></a><span id="l35.289"> </span>
<a href="#l35.290"></a><span id="l35.290" class="difflineminus">-NS_MSG_BASE nsresult MsgUnescapeString(const nsACString &amp;aStr,</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineminus">-                                       uint32_t aFlags, nsACString &amp;aResult);</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+NS_MSG_BASE nsresult MsgUnescapeString(const nsACString &amp;aStr, uint32_t aFlags,</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+                                       nsACString &amp;aResult);</span>
<a href="#l35.294"></a><span id="l35.294"> </span>
<a href="#l35.295"></a><span id="l35.295"> NS_MSG_BASE nsresult MsgEscapeURL(const nsACString &amp;aStr, uint32_t aFlags,</span>
<a href="#l35.296"></a><span id="l35.296">                                   nsACString &amp;aResult);</span>
<a href="#l35.297"></a><span id="l35.297"> </span>
<a href="#l35.298"></a><span id="l35.298" class="difflineminus">-// Converts an nsTArray of nsMsgKeys plus a database, to an array of nsIMsgDBHdrs.</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+// Converts an nsTArray of nsMsgKeys plus a database, to an array of</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineplus">+// nsIMsgDBHdrs.</span>
<a href="#l35.301"></a><span id="l35.301"> NS_MSG_BASE nsresult MsgGetHeadersFromKeys(nsIMsgDatabase *aDB,</span>
<a href="#l35.302"></a><span id="l35.302">                                            const nsTArray&lt;nsMsgKey&gt; &amp;aKeys,</span>
<a href="#l35.303"></a><span id="l35.303">                                            nsIMutableArray *aHeaders);</span>
<a href="#l35.304"></a><span id="l35.304"> // Converts an array of nsMsgKeys plus a database, to an array of nsIMsgDBHdrs.</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineminus">-NS_MSG_BASE nsresult MsgGetHdrsFromKeys(nsIMsgDatabase *aDB,</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineminus">-                                        nsMsgKey *aKeys,</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+NS_MSG_BASE nsresult MsgGetHdrsFromKeys(nsIMsgDatabase *aDB, nsMsgKey *aKeys,</span>
<a href="#l35.308"></a><span id="l35.308">                                         uint32_t aNumKeys,</span>
<a href="#l35.309"></a><span id="l35.309">                                         nsIMutableArray **aHeaders);</span>
<a href="#l35.310"></a><span id="l35.310"> </span>
<a href="#l35.311"></a><span id="l35.311"> NS_MSG_BASE nsresult MsgExamineForProxyAsync(nsIChannel *channel,</span>
<a href="#l35.312"></a><span id="l35.312">                                              nsIProtocolProxyCallback *listener,</span>
<a href="#l35.313"></a><span id="l35.313">                                              nsICancelable **result);</span>
<a href="#l35.314"></a><span id="l35.314"> </span>
<a href="#l35.315"></a><span id="l35.315"> NS_MSG_BASE int32_t MsgFindCharInSet(const nsCString &amp;aString,</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineminus">-                                     const char* aChars, uint32_t aOffset = 0);</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineplus">+                                     const char *aChars, uint32_t aOffset = 0);</span>
<a href="#l35.318"></a><span id="l35.318"> NS_MSG_BASE int32_t MsgFindCharInSet(const nsString &amp;aString,</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineminus">-                                     const char* aChars, uint32_t aOffset = 0);</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineminus">-</span>
<a href="#l35.321"></a><span id="l35.321" class="difflineplus">+                                     const char *aChars, uint32_t aOffset = 0);</span>
<a href="#l35.322"></a><span id="l35.322"> </span>
<a href="#l35.323"></a><span id="l35.323"> // advances bufferOffset to the beginning of the next line, if we don't</span>
<a href="#l35.324"></a><span id="l35.324"> // get to maxBufferOffset first. Returns false if we didn't get to the</span>
<a href="#l35.325"></a><span id="l35.325"> // next line.</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineminus">-NS_MSG_BASE bool MsgAdvanceToNextLine(const char *buffer, uint32_t &amp;bufferOffset,</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineminus">-                                   uint32_t maxBufferOffset);</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineplus">+NS_MSG_BASE bool MsgAdvanceToNextLine(const char *buffer,</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineplus">+                                      uint32_t &amp;bufferOffset,</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineplus">+                                      uint32_t maxBufferOffset);</span>
<a href="#l35.331"></a><span id="l35.331"> </span>
<a href="#l35.332"></a><span id="l35.332"> /**</span>
<a href="#l35.333"></a><span id="l35.333">  * Alerts the user that the login to the server failed. Asks whether the</span>
<a href="#l35.334"></a><span id="l35.334">  * connection should: retry, cancel, or request a new password.</span>
<a href="#l35.335"></a><span id="l35.335">  *</span>
<a href="#l35.336"></a><span id="l35.336">  * @param aMsgWindow The message window associated with this action (cannot</span>
<a href="#l35.337"></a><span id="l35.337">  *                   be null).</span>
<a href="#l35.338"></a><span id="l35.338">  * @param aHostname  The hostname of the server for which the login failed.</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineat">@@ -282,88 +298,87 @@ NS_MSG_BASE PRTime MsgConvertAgeInDaysTo</span>
<a href="#l35.340"></a><span id="l35.340"> </span>
<a href="#l35.341"></a><span id="l35.341"> /**</span>
<a href="#l35.342"></a><span id="l35.342">  * Converts the passed in term list to its string representation.</span>
<a href="#l35.343"></a><span id="l35.343">  *</span>
<a href="#l35.344"></a><span id="l35.344">  * @param      aTermList    Array of nsIMsgSearchTerms</span>
<a href="#l35.345"></a><span id="l35.345">  * @param[out] aOutString   result representation of search terms.</span>
<a href="#l35.346"></a><span id="l35.346">  *</span>
<a href="#l35.347"></a><span id="l35.347">  */</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineminus">-NS_MSG_BASE nsresult MsgTermListToString(nsIArray *aTermList, nsCString &amp;aOutString);</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineplus">+NS_MSG_BASE nsresult MsgTermListToString(nsIArray *aTermList,</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineplus">+                                         nsCString &amp;aOutString);</span>
<a href="#l35.351"></a><span id="l35.351"> </span>
<a href="#l35.352"></a><span id="l35.352" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineminus">-MsgStreamMsgHeaders(nsIInputStream *aInputStream, nsIStreamListener *aConsumer);</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineplus">+NS_MSG_BASE nsresult MsgStreamMsgHeaders(nsIInputStream *aInputStream,</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+                                         nsIStreamListener *aConsumer);</span>
<a href="#l35.356"></a><span id="l35.356"> </span>
<a href="#l35.357"></a><span id="l35.357"> /**</span>
<a href="#l35.358"></a><span id="l35.358">  * convert string to uint64_t</span>
<a href="#l35.359"></a><span id="l35.359">  *</span>
<a href="#l35.360"></a><span id="l35.360">  * @param str converted string</span>
<a href="#l35.361"></a><span id="l35.361">  * @returns   uint64_t value for success, 0 for parse failure</span>
<a href="#l35.362"></a><span id="l35.362">  */</span>
<a href="#l35.363"></a><span id="l35.363"> NS_MSG_BASE uint64_t ParseUint64Str(const char *str);</span>
<a href="#l35.364"></a><span id="l35.364"> </span>
<a href="#l35.365"></a><span id="l35.365"> /**</span>
<a href="#l35.366"></a><span id="l35.366">  * Detect charset of file</span>
<a href="#l35.367"></a><span id="l35.367">  *</span>
<a href="#l35.368"></a><span id="l35.368">  * @param      aFile    The target of nsIFile</span>
<a href="#l35.369"></a><span id="l35.369">  * @param[out] aCharset The charset string</span>
<a href="#l35.370"></a><span id="l35.370">  */</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineminus">-NS_MSG_BASE nsresult MsgDetectCharsetFromFile(nsIFile *aFile, nsACString &amp;aCharset);</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+NS_MSG_BASE nsresult MsgDetectCharsetFromFile(nsIFile *aFile,</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineplus">+                                              nsACString &amp;aCharset);</span>
<a href="#l35.374"></a><span id="l35.374"> </span>
<a href="#l35.375"></a><span id="l35.375"> /*</span>
<a href="#l35.376"></a><span id="l35.376">  * Converts a buffer to plain text. Some conversions may</span>
<a href="#l35.377"></a><span id="l35.377">  * or may not work with certain end charsets which is why we</span>
<a href="#l35.378"></a><span id="l35.378">  * need that as an argument to the function. If charset is</span>
<a href="#l35.379"></a><span id="l35.379">  * unknown or deemed of no importance NULL could be passed.</span>
<a href="#l35.380"></a><span id="l35.380">  * @param[in/out] aConBuf        Variable with the text to convert</span>
<a href="#l35.381"></a><span id="l35.381">  * @param         formatFlowed   Use format flowed?</span>
<a href="#l35.382"></a><span id="l35.382">  * @param         delsp          Use delsp=yes when flowed</span>
<a href="#l35.383"></a><span id="l35.383">  * @param         formatOutput   Reformat the output?</span>
<a href="#l35.384"></a><span id="l35.384">  &amp; @param         disallowBreaks Disallow breaks when formatting</span>
<a href="#l35.385"></a><span id="l35.385">  */</span>
<a href="#l35.386"></a><span id="l35.386" class="difflineminus">-NS_MSG_BASE nsresult</span>
<a href="#l35.387"></a><span id="l35.387" class="difflineminus">-ConvertBufToPlainText(nsString &amp;aConBuf, bool formatFlowed, bool delsp,</span>
<a href="#l35.388"></a><span id="l35.388" class="difflineminus">-                                         bool formatOutput, bool disallowBreaks);</span>
<a href="#l35.389"></a><span id="l35.389" class="difflineplus">+NS_MSG_BASE nsresult ConvertBufToPlainText(nsString &amp;aConBuf, bool formatFlowed,</span>
<a href="#l35.390"></a><span id="l35.390" class="difflineplus">+                                           bool delsp, bool formatOutput,</span>
<a href="#l35.391"></a><span id="l35.391" class="difflineplus">+                                           bool disallowBreaks);</span>
<a href="#l35.392"></a><span id="l35.392"> </span>
<a href="#l35.393"></a><span id="l35.393"> #include &quot;nsEscape.h&quot;</span>
<a href="#l35.394"></a><span id="l35.394"> </span>
<a href="#l35.395"></a><span id="l35.395"> /**</span>
<a href="#l35.396"></a><span id="l35.396">  * The following methods are not exposed to the external API, but when we're</span>
<a href="#l35.397"></a><span id="l35.397">  * using the internal API we can simply redirect the calls appropriately.</span>
<a href="#l35.398"></a><span id="l35.398">  */</span>
<a href="#l35.399"></a><span id="l35.399" class="difflineminus">-#define MsgLowerCaseEqualsLiteral(str, l) \</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineminus">-        (str).LowerCaseEqualsLiteral(l)</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineminus">-#define MsgRFindChar(str, ch, len) \</span>
<a href="#l35.402"></a><span id="l35.402" class="difflineminus">-        (str).RFindChar(ch, len)</span>
<a href="#l35.403"></a><span id="l35.403" class="difflineminus">-#define MsgCompressWhitespace(str) \</span>
<a href="#l35.404"></a><span id="l35.404" class="difflineminus">-        (str).CompressWhitespace()</span>
<a href="#l35.405"></a><span id="l35.405" class="difflineplus">+#define MsgLowerCaseEqualsLiteral(str, l) (str).LowerCaseEqualsLiteral(l)</span>
<a href="#l35.406"></a><span id="l35.406" class="difflineplus">+#define MsgRFindChar(str, ch, len) (str).RFindChar(ch, len)</span>
<a href="#l35.407"></a><span id="l35.407" class="difflineplus">+#define MsgCompressWhitespace(str) (str).CompressWhitespace()</span>
<a href="#l35.408"></a><span id="l35.408"> #define MsgReplaceSubstring(str, what, replacement) \</span>
<a href="#l35.409"></a><span id="l35.409" class="difflineminus">-        (str).ReplaceSubstring(what, replacement)</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineminus">-#define MsgIsUTF8(str) \</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineminus">-        IsUTF8(str)</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineplus">+  (str).ReplaceSubstring(what, replacement)</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineplus">+#define MsgIsUTF8(str) IsUTF8(str)</span>
<a href="#l35.414"></a><span id="l35.414"> #define MsgNewInterfaceRequestorAggregation(aFirst, aSecond, aResult) \</span>
<a href="#l35.415"></a><span id="l35.415" class="difflineminus">-        NS_NewInterfaceRequestorAggregation(aFirst, aSecond, aResult)</span>
<a href="#l35.416"></a><span id="l35.416" class="difflineminus">-#define MsgNewNotificationCallbacksAggregation(aCallbacks, aLoadGroup, aResult) \</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineminus">-        NS_NewNotificationCallbacksAggregation(aCallbacks, aLoadGroup, aResult)</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineplus">+  NS_NewInterfaceRequestorAggregation(aFirst, aSecond, aResult)</span>
<a href="#l35.419"></a><span id="l35.419" class="difflineplus">+#define MsgNewNotificationCallbacksAggregation(aCallbacks, aLoadGroup, \</span>
<a href="#l35.420"></a><span id="l35.420" class="difflineplus">+                                               aResult)                \</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineplus">+  NS_NewNotificationCallbacksAggregation(aCallbacks, aLoadGroup, aResult)</span>
<a href="#l35.422"></a><span id="l35.422"> #define MsgReplaceChar(aString, aNeedle, aReplacement) \</span>
<a href="#l35.423"></a><span id="l35.423" class="difflineminus">-        (aString).ReplaceChar(aNeedle, aReplacement)</span>
<a href="#l35.424"></a><span id="l35.424" class="difflineplus">+  (aString).ReplaceChar(aNeedle, aReplacement)</span>
<a href="#l35.425"></a><span id="l35.425"> #define MsgFind(str, what, ignore_case, offset) \</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineminus">-        (str).Find(what, ignore_case, offset)</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineminus">-#define MsgCountChar(aString, aChar) \</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineminus">-        (aString).CountChar(aChar)</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineplus">+  (str).Find(what, ignore_case, offset)</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineplus">+#define MsgCountChar(aString, aChar) (aString).CountChar(aChar)</span>
<a href="#l35.431"></a><span id="l35.431"> </span>
<a href="#l35.432"></a><span id="l35.432"> /**</span>
<a href="#l35.433"></a><span id="l35.433">  * Converts a hex string into an integer.</span>
<a href="#l35.434"></a><span id="l35.434">  * Processes up to aNumChars characters or the first non-hex char.</span>
<a href="#l35.435"></a><span id="l35.435">  * It is not an error if less than aNumChars valid hex digits are found.</span>
<a href="#l35.436"></a><span id="l35.436">  */</span>
<a href="#l35.437"></a><span id="l35.437"> NS_MSG_BASE uint64_t MsgUnhex(const char *aHexString, size_t aNumChars);</span>
<a href="#l35.438"></a><span id="l35.438"> </span>
<a href="#l35.439"></a><span id="l35.439"> /**</span>
<a href="#l35.440"></a><span id="l35.440" class="difflineminus">- * Checks if a string is a valid hex literal containing at least aNumChars digits.</span>
<a href="#l35.441"></a><span id="l35.441" class="difflineplus">+ * Checks if a string is a valid hex literal containing at least aNumChars</span>
<a href="#l35.442"></a><span id="l35.442" class="difflineplus">+ * digits.</span>
<a href="#l35.443"></a><span id="l35.443">  */</span>
<a href="#l35.444"></a><span id="l35.444"> NS_MSG_BASE bool MsgIsHex(const char *aHexString, size_t aNumChars);</span>
<a href="#l35.445"></a><span id="l35.445"> </span>
<a href="#l35.446"></a><span id="l35.446"> /**</span>
<a href="#l35.447"></a><span id="l35.447">  * Convert an uint32_t to a nsMsgKey.</span>
<a href="#l35.448"></a><span id="l35.448">  * Currently they are mostly the same but we need to preserve the notion that</span>
<a href="#l35.449"></a><span id="l35.449">  * nsMsgKey is an opaque value that can't be treated as a generic integer</span>
<a href="#l35.450"></a><span id="l35.450">  * (except when storing it into the database). It enables type safety checks and</span>
<a href="#l35.451"></a><span id="l35.451" class="difflineat">@@ -373,54 +388,75 @@ NS_MSG_BASE nsMsgKey msgKeyFromInt(uint3</span>
<a href="#l35.452"></a><span id="l35.452"> </span>
<a href="#l35.453"></a><span id="l35.453"> NS_MSG_BASE nsMsgKey msgKeyFromInt(uint64_t aValue);</span>
<a href="#l35.454"></a><span id="l35.454"> </span>
<a href="#l35.455"></a><span id="l35.455"> NS_MSG_BASE uint32_t msgKeyToInt(nsMsgKey aMsgKey);</span>
<a href="#l35.456"></a><span id="l35.456"> </span>
<a href="#l35.457"></a><span id="l35.457"> /**</span>
<a href="#l35.458"></a><span id="l35.458">  * Helper function to extract query part from URL spec.</span>
<a href="#l35.459"></a><span id="l35.459">  */</span>
<a href="#l35.460"></a><span id="l35.460" class="difflineminus">-nsCString MsgExtractQueryPart(const nsACString&amp; spec, const char* queryToExtract);</span>
<a href="#l35.461"></a><span id="l35.461" class="difflineplus">+nsCString MsgExtractQueryPart(const nsACString &amp;spec,</span>
<a href="#l35.462"></a><span id="l35.462" class="difflineplus">+                              const char *queryToExtract);</span>
<a href="#l35.463"></a><span id="l35.463"> </span>
<a href="#l35.464"></a><span id="l35.464"> /**</span>
<a href="#l35.465"></a><span id="l35.465">  * Helper macro for defining getter/setters. Ported from nsISupportsObsolete.h</span>
<a href="#l35.466"></a><span id="l35.466">  */</span>
<a href="#l35.467"></a><span id="l35.467"> #define NS_IMPL_GETSET(clazz, attr, type, member) \</span>
<a href="#l35.468"></a><span id="l35.468" class="difflineminus">-  NS_IMETHODIMP clazz::Get##attr(type *result) \</span>
<a href="#l35.469"></a><span id="l35.469" class="difflineminus">-  { \</span>
<a href="#l35.470"></a><span id="l35.470" class="difflineminus">-    NS_ENSURE_ARG_POINTER(result); \</span>
<a href="#l35.471"></a><span id="l35.471" class="difflineminus">-    *result = member; \</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineminus">-    return NS_OK; \</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineminus">-  } \</span>
<a href="#l35.474"></a><span id="l35.474" class="difflineminus">-  NS_IMETHODIMP clazz::Set##attr(type aValue) \</span>
<a href="#l35.475"></a><span id="l35.475" class="difflineminus">-  { \</span>
<a href="#l35.476"></a><span id="l35.476" class="difflineminus">-    member = aValue; \</span>
<a href="#l35.477"></a><span id="l35.477" class="difflineminus">-    return NS_OK; \</span>
<a href="#l35.478"></a><span id="l35.478" class="difflineplus">+  NS_IMETHODIMP clazz::Get##attr(type *result) {  \</span>
<a href="#l35.479"></a><span id="l35.479" class="difflineplus">+    NS_ENSURE_ARG_POINTER(result);                \</span>
<a href="#l35.480"></a><span id="l35.480" class="difflineplus">+    *result = member;                             \</span>
<a href="#l35.481"></a><span id="l35.481" class="difflineplus">+    return NS_OK;                                 \</span>
<a href="#l35.482"></a><span id="l35.482" class="difflineplus">+  }                                               \</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineplus">+  NS_IMETHODIMP clazz::Set##attr(type aValue) {   \</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineplus">+    member = aValue;                              \</span>
<a href="#l35.485"></a><span id="l35.485" class="difflineplus">+    return NS_OK;                                 \</span>
<a href="#l35.486"></a><span id="l35.486">   }</span>
<a href="#l35.487"></a><span id="l35.487"> </span>
<a href="#l35.488"></a><span id="l35.488" class="difflineminus">-#endif</span>
<a href="#l35.489"></a><span id="l35.489" class="difflineminus">-</span>
<a href="#l35.490"></a><span id="l35.490" class="difflineminus">- /**</span>
<a href="#l35.491"></a><span id="l35.491" class="difflineplus">+/**</span>
<a href="#l35.492"></a><span id="l35.492">  * Macro and helper function for reporting an error, warning or</span>
<a href="#l35.493"></a><span id="l35.493">  * informational message to the Error Console</span>
<a href="#l35.494"></a><span id="l35.494">  *</span>
<a href="#l35.495"></a><span id="l35.495">  * This will require the inclusion of the following files in the source file</span>
<a href="#l35.496"></a><span id="l35.496">  * #include &quot;nsIScriptError.h&quot;</span>
<a href="#l35.497"></a><span id="l35.497">  * #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l35.498"></a><span id="l35.498">  *</span>
<a href="#l35.499"></a><span id="l35.499">  */</span>
<a href="#l35.500"></a><span id="l35.500"> </span>
<a href="#l35.501"></a><span id="l35.501"> NS_MSG_BASE</span>
<a href="#l35.502"></a><span id="l35.502"> void MsgLogToConsole4(const nsAString &amp;aErrorText, const nsAString &amp;aFilename,</span>
<a href="#l35.503"></a><span id="l35.503">                       uint32_t aLine, uint32_t flags);</span>
<a href="#l35.504"></a><span id="l35.504"> </span>
<a href="#l35.505"></a><span id="l35.505"> // Macro with filename and line number</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineminus">-#define MSG_LOG_TO_CONSOLE(_text, _flag) MsgLogToConsole4(NS_LITERAL_STRING(_text), NS_LITERAL_STRING(__FILE__), __LINE__, _flag)</span>
<a href="#l35.507"></a><span id="l35.507" class="difflineminus">-#define MSG_LOG_ERR_TO_CONSOLE(_text) MSG_LOG_TO_CONSOLE(_text, nsIScriptError::errorFlag)</span>
<a href="#l35.508"></a><span id="l35.508" class="difflineminus">-#define MSG_LOG_WARN_TO_CONSOLE(_text) MSG_LOG_TO_CONSOLE(_text, nsIScriptError::warningFlag)</span>
<a href="#l35.509"></a><span id="l35.509" class="difflineminus">-#define MSG_LOG_INFO_TO_CONSOLE(_text) MSG_LOG_TO_CONSOLE(_text, nsIScriptError::infoFlag)</span>
<a href="#l35.510"></a><span id="l35.510" class="difflineplus">+#define MSG_LOG_TO_CONSOLE(_text, _flag)                                  \</span>
<a href="#l35.511"></a><span id="l35.511" class="difflineplus">+  MsgLogToConsole4(NS_LITERAL_STRING(_text), NS_LITERAL_STRING(__FILE__), \</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineplus">+                   __LINE__, _flag)</span>
<a href="#l35.513"></a><span id="l35.513" class="difflineplus">+#define MSG_LOG_ERR_TO_CONSOLE(_text) \</span>
<a href="#l35.514"></a><span id="l35.514" class="difflineplus">+  MSG_LOG_TO_CONSOLE(_text, nsIScriptError::errorFlag)</span>
<a href="#l35.515"></a><span id="l35.515" class="difflineplus">+#define MSG_LOG_WARN_TO_CONSOLE(_text) \</span>
<a href="#l35.516"></a><span id="l35.516" class="difflineplus">+  MSG_LOG_TO_CONSOLE(_text, nsIScriptError::warningFlag)</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineplus">+#define MSG_LOG_INFO_TO_CONSOLE(_text) \</span>
<a href="#l35.518"></a><span id="l35.518" class="difflineplus">+  MSG_LOG_TO_CONSOLE(_text, nsIScriptError::infoFlag)</span>
<a href="#l35.519"></a><span id="l35.519"> </span>
<a href="#l35.520"></a><span id="l35.520"> // Helper macros to cope with shoddy I/O error reporting (or lack thereof)</span>
<a href="#l35.521"></a><span id="l35.521" class="difflineminus">-#define MSG_NS_ERROR(_txt) do { NS_ERROR(_txt); MSG_LOG_ERR_TO_CONSOLE(_txt); } while(0)</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineminus">-#define MSG_NS_WARNING(_txt) do { NS_WARNING(_txt); MSG_LOG_WARN_TO_CONSOLE(_txt); } while (0)</span>
<a href="#l35.523"></a><span id="l35.523" class="difflineminus">-#define MSG_NS_WARN_IF_FALSE(_val, _txt) do { if (!(_val)) { NS_WARNING(_txt); MSG_LOG_WARN_TO_CONSOLE(_txt); } } while (0)</span>
<a href="#l35.524"></a><span id="l35.524" class="difflineminus">-#define MSG_NS_INFO(_txt) do { MSG_LOCAL_INFO_TO_CONSOLE(_txt); \</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineminus">-  fprintf(stderr,&quot;(info) %s (%s:%d)\n&quot;, _txt, __FILE__, __LINE__); } while(0)</span>
<a href="#l35.526"></a><span id="l35.526" class="difflineplus">+#define MSG_NS_ERROR(_txt)        \</span>
<a href="#l35.527"></a><span id="l35.527" class="difflineplus">+  do {                            \</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineplus">+    NS_ERROR(_txt);               \</span>
<a href="#l35.529"></a><span id="l35.529" class="difflineplus">+    MSG_LOG_ERR_TO_CONSOLE(_txt); \</span>
<a href="#l35.530"></a><span id="l35.530" class="difflineplus">+  } while (0)</span>
<a href="#l35.531"></a><span id="l35.531" class="difflineplus">+#define MSG_NS_WARNING(_txt)       \</span>
<a href="#l35.532"></a><span id="l35.532" class="difflineplus">+  do {                             \</span>
<a href="#l35.533"></a><span id="l35.533" class="difflineplus">+    NS_WARNING(_txt);              \</span>
<a href="#l35.534"></a><span id="l35.534" class="difflineplus">+    MSG_LOG_WARN_TO_CONSOLE(_txt); \</span>
<a href="#l35.535"></a><span id="l35.535" class="difflineplus">+  } while (0)</span>
<a href="#l35.536"></a><span id="l35.536" class="difflineplus">+#define MSG_NS_WARN_IF_FALSE(_val, _txt) \</span>
<a href="#l35.537"></a><span id="l35.537" class="difflineplus">+  do {                                   \</span>
<a href="#l35.538"></a><span id="l35.538" class="difflineplus">+    if (!(_val)) {                       \</span>
<a href="#l35.539"></a><span id="l35.539" class="difflineplus">+      NS_WARNING(_txt);                  \</span>
<a href="#l35.540"></a><span id="l35.540" class="difflineplus">+      MSG_LOG_WARN_TO_CONSOLE(_txt);     \</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineplus">+    }                                    \</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineplus">+  } while (0)</span>
<a href="#l35.543"></a><span id="l35.543" class="difflineplus">+#define MSG_NS_INFO(_txt)                                             \</span>
<a href="#l35.544"></a><span id="l35.544" class="difflineplus">+  do {                                                                \</span>
<a href="#l35.545"></a><span id="l35.545" class="difflineplus">+    MSG_LOCAL_INFO_TO_CONSOLE(_txt);                                  \</span>
<a href="#l35.546"></a><span id="l35.546" class="difflineplus">+    fprintf(stderr, &quot;(info) %s (%s:%d)\n&quot;, _txt, __FILE__, __LINE__); \</span>
<a href="#l35.547"></a><span id="l35.547" class="difflineplus">+  } while (0)</span>
<a href="#l35.548"></a><span id="l35.548" class="difflineplus">+</span>
<a href="#l35.549"></a><span id="l35.549" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/base/util/nsStopwatch.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/base/util/nsStopwatch.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -2,23 +2,23 @@</span>
<a href="#l36.4"></a><span id="l36.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.5"></a><span id="l36.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> #include &quot;nsStopwatch.h&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9"> #include &lt;stdio.h&gt;</span>
<a href="#l36.10"></a><span id="l36.10"> #include &lt;time.h&gt;</span>
<a href="#l36.11"></a><span id="l36.11"> #if defined(XP_UNIX)</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#include &lt;unistd.h&gt;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-#include &lt;sys/times.h&gt;</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-#include &lt;sys/time.h&gt;</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-#include &lt;errno.h&gt;</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+#  include &lt;unistd.h&gt;</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+#  include &lt;sys/times.h&gt;</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+#  include &lt;sys/time.h&gt;</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+#  include &lt;errno.h&gt;</span>
<a href="#l36.20"></a><span id="l36.20"> #elif defined(XP_WIN)</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-#include &quot;windows.h&quot;</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">-#endif // elif defined(XP_WIN)</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+#  include &quot;windows.h&quot;</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+#endif  // elif defined(XP_WIN)</span>
<a href="#l36.25"></a><span id="l36.25"> </span>
<a href="#l36.26"></a><span id="l36.26"> #include &quot;nsMemory.h&quot;</span>
<a href="#l36.27"></a><span id="l36.27"> /*</span>
<a href="#l36.28"></a><span id="l36.28">  * This basis for the logic in this file comes from (will used to come from):</span>
<a href="#l36.29"></a><span id="l36.29">  *  (mozilla/)modules/libutil/public/stopwatch.cpp.</span>
<a href="#l36.30"></a><span id="l36.30">  *</span>
<a href="#l36.31"></a><span id="l36.31">  * It was no longer used in the mozilla tree, and is being migrated to</span>
<a href="#l36.32"></a><span id="l36.32">  * comm-central where we actually have a need for it.  (&quot;Being&quot; in the sense</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineat">@@ -28,147 +28,137 @@</span>
<a href="#l36.34"></a><span id="l36.34">  * bug 96669 has been integrated.</span>
<a href="#l36.35"></a><span id="l36.35">  */</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37"> NS_IMPL_ISUPPORTS(nsStopwatch, nsIStopwatch)</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39"> #if defined(XP_UNIX)</span>
<a href="#l36.40"></a><span id="l36.40"> /** the number of ticks per second */</span>
<a href="#l36.41"></a><span id="l36.41"> static double gTicks = 0;</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-#define MICRO_SECONDS_TO_SECONDS_MULT static_cast&lt;double&gt;(1.0e-6)</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+#  define MICRO_SECONDS_TO_SECONDS_MULT static_cast&lt;double&gt;(1.0e-6)</span>
<a href="#l36.44"></a><span id="l36.44"> #elif defined(WIN32)</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-#include &quot;nsPrintfCString.h&quot;</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-#endif</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-// 1 tick per 100ns = 10 per us = 10 * 1,000 per ms = 10 * 1,000 * 1,000 per sec.</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-#define WIN32_TICK_RESOLUTION static_cast&lt;double&gt;(1.0e-7)</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+#  ifdef DEBUG</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+#    include &quot;nsPrintfCString.h&quot;</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+#  endif</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+// 1 tick per 100ns = 10 per us = 10 * 1,000 per ms = 10 * 1,000 * 1,000 per</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+// sec.</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+#  define WIN32_TICK_RESOLUTION static_cast&lt;double&gt;(1.0e-7)</span>
<a href="#l36.56"></a><span id="l36.56"> // subtract off to get to the unix epoch</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-#define UNIX_EPOCH_IN_FILE_TIME 116444736000000000L</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-#endif // elif defined(WIN32)</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+#  define UNIX_EPOCH_IN_FILE_TIME 116444736000000000L</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+#endif  // elif defined(WIN32)</span>
<a href="#l36.61"></a><span id="l36.61"> </span>
<a href="#l36.62"></a><span id="l36.62"> nsStopwatch::nsStopwatch()</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">- : fTotalRealTimeSecs(0.0)</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">- , fTotalCpuTimeSecs(0.0)</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">- , fRunning(false)</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-{</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+    : fTotalRealTimeSecs(0.0), fTotalCpuTimeSecs(0.0), fRunning(false) {</span>
<a href="#l36.68"></a><span id="l36.68"> #if defined(XP_UNIX)</span>
<a href="#l36.69"></a><span id="l36.69">   // idempotent in the event of a race under all coherency models</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-  if (!gTicks)</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-  {</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+  if (!gTicks) {</span>
<a href="#l36.73"></a><span id="l36.73">     // we need to clear errno because sysconf's spec says it leaves it the same</span>
<a href="#l36.74"></a><span id="l36.74">     //  on success and only sets it on failure.</span>
<a href="#l36.75"></a><span id="l36.75">     errno = 0;</span>
<a href="#l36.76"></a><span id="l36.76">     gTicks = (clock_t)sysconf(_SC_CLK_TCK);</span>
<a href="#l36.77"></a><span id="l36.77">     // in event of failure, pick an arbitrary value so we don't divide by zero.</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-    if (errno)</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-      gTicks = 1000000L;</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+    if (errno) gTicks = 1000000L;</span>
<a href="#l36.81"></a><span id="l36.81">   }</span>
<a href="#l36.82"></a><span id="l36.82"> #endif</span>
<a href="#l36.83"></a><span id="l36.83"> }</span>
<a href="#l36.84"></a><span id="l36.84"> </span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-nsStopwatch::~nsStopwatch()</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-{</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-}</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+nsStopwatch::~nsStopwatch() {}</span>
<a href="#l36.89"></a><span id="l36.89"> </span>
<a href="#l36.90"></a><span id="l36.90" class="difflineminus">-NS_IMETHODIMP nsStopwatch::Start()</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineminus">-{</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+NS_IMETHODIMP nsStopwatch::Start() {</span>
<a href="#l36.93"></a><span id="l36.93">   fTotalRealTimeSecs = 0.0;</span>
<a href="#l36.94"></a><span id="l36.94">   fTotalCpuTimeSecs = 0.0;</span>
<a href="#l36.95"></a><span id="l36.95">   return Resume();</span>
<a href="#l36.96"></a><span id="l36.96"> }</span>
<a href="#l36.97"></a><span id="l36.97"> </span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-NS_IMETHODIMP nsStopwatch::Stop()</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-{</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+NS_IMETHODIMP nsStopwatch::Stop() {</span>
<a href="#l36.101"></a><span id="l36.101">   fStopRealTimeSecs = GetRealTime();</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-  fStopCpuTimeSecs  = GetCPUTime();</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-  if (fRunning)</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-  {</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineminus">-    fTotalCpuTimeSecs  += fStopCpuTimeSecs  - fStartCpuTimeSecs;</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+  fStopCpuTimeSecs = GetCPUTime();</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+  if (fRunning) {</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+    fTotalCpuTimeSecs += fStopCpuTimeSecs - fStartCpuTimeSecs;</span>
<a href="#l36.109"></a><span id="l36.109">     fTotalRealTimeSecs += fStopRealTimeSecs - fStartRealTimeSecs;</span>
<a href="#l36.110"></a><span id="l36.110">   }</span>
<a href="#l36.111"></a><span id="l36.111">   fRunning = false;</span>
<a href="#l36.112"></a><span id="l36.112">   return NS_OK;</span>
<a href="#l36.113"></a><span id="l36.113"> }</span>
<a href="#l36.114"></a><span id="l36.114"> </span>
<a href="#l36.115"></a><span id="l36.115" class="difflineminus">-NS_IMETHODIMP nsStopwatch::Resume()</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineminus">-{</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineminus">-  if (!fRunning)</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineminus">-  {</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+NS_IMETHODIMP nsStopwatch::Resume() {</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+  if (!fRunning) {</span>
<a href="#l36.121"></a><span id="l36.121">     fStartRealTimeSecs = GetRealTime();</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-    fStartCpuTimeSecs  = GetCPUTime();</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+    fStartCpuTimeSecs = GetCPUTime();</span>
<a href="#l36.124"></a><span id="l36.124">   }</span>
<a href="#l36.125"></a><span id="l36.125">   fRunning = true;</span>
<a href="#l36.126"></a><span id="l36.126">   return NS_OK;</span>
<a href="#l36.127"></a><span id="l36.127"> }</span>
<a href="#l36.128"></a><span id="l36.128"> </span>
<a href="#l36.129"></a><span id="l36.129" class="difflineminus">-NS_IMETHODIMP nsStopwatch::GetCpuTimeSeconds(double *result)</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineminus">-{</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+NS_IMETHODIMP nsStopwatch::GetCpuTimeSeconds(double *result) {</span>
<a href="#l36.132"></a><span id="l36.132">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l36.133"></a><span id="l36.133">   *result = fTotalCpuTimeSecs;</span>
<a href="#l36.134"></a><span id="l36.134">   return NS_OK;</span>
<a href="#l36.135"></a><span id="l36.135"> }</span>
<a href="#l36.136"></a><span id="l36.136"> </span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-NS_IMETHODIMP nsStopwatch::GetRealTimeSeconds(double *result)</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineminus">-{</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+NS_IMETHODIMP nsStopwatch::GetRealTimeSeconds(double *result) {</span>
<a href="#l36.140"></a><span id="l36.140">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l36.141"></a><span id="l36.141">   *result = fTotalRealTimeSecs;</span>
<a href="#l36.142"></a><span id="l36.142">   return NS_OK;</span>
<a href="#l36.143"></a><span id="l36.143"> }</span>
<a href="#l36.144"></a><span id="l36.144"> </span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-double nsStopwatch::GetRealTime()</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-{</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+double nsStopwatch::GetRealTime() {</span>
<a href="#l36.148"></a><span id="l36.148"> #if defined(XP_UNIX)</span>
<a href="#l36.149"></a><span id="l36.149">   struct timeval t;</span>
<a href="#l36.150"></a><span id="l36.150">   gettimeofday(&amp;t, NULL);</span>
<a href="#l36.151"></a><span id="l36.151">   return t.tv_sec + t.tv_usec * MICRO_SECONDS_TO_SECONDS_MULT;</span>
<a href="#l36.152"></a><span id="l36.152"> #elif defined(WIN32)</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-  union     {FILETIME ftFileTime;</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineminus">-             __int64  ftInt64;</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineminus">-            } ftRealTime; // time the process has spent in kernel mode</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+  union {</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+    FILETIME ftFileTime;</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+    __int64 ftInt64;</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+  } ftRealTime;  // time the process has spent in kernel mode</span>
<a href="#l36.160"></a><span id="l36.160">   SYSTEMTIME st;</span>
<a href="#l36.161"></a><span id="l36.161">   GetSystemTime(&amp;st);</span>
<a href="#l36.162"></a><span id="l36.162">   SystemTimeToFileTime(&amp;st, &amp;ftRealTime.ftFileTime);</span>
<a href="#l36.163"></a><span id="l36.163">   return (ftRealTime.ftInt64 - UNIX_EPOCH_IN_FILE_TIME) * WIN32_TICK_RESOLUTION;</span>
<a href="#l36.164"></a><span id="l36.164"> #else</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineminus">-#error &quot;nsStopwatch not supported on this platform.&quot;</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+#  error &quot;nsStopwatch not supported on this platform.&quot;</span>
<a href="#l36.167"></a><span id="l36.167"> #endif</span>
<a href="#l36.168"></a><span id="l36.168"> }</span>
<a href="#l36.169"></a><span id="l36.169"> </span>
<a href="#l36.170"></a><span id="l36.170" class="difflineminus">-double nsStopwatch::GetCPUTime()</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-{</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+double nsStopwatch::GetCPUTime() {</span>
<a href="#l36.173"></a><span id="l36.173"> #if defined(XP_UNIX)</span>
<a href="#l36.174"></a><span id="l36.174">   struct tms cpt;</span>
<a href="#l36.175"></a><span id="l36.175">   times(&amp;cpt);</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineminus">-  return (double)(cpt.tms_utime+cpt.tms_stime) / gTicks;</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+  return (double)(cpt.tms_utime + cpt.tms_stime) / gTicks;</span>
<a href="#l36.178"></a><span id="l36.178"> #elif defined(WIN32)</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineminus">-  FILETIME    ftCreate,       // when the process was created</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineminus">-              ftExit;         // when the process exited</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+  FILETIME ftCreate,  // when the process was created</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+      ftExit;         // when the process exited</span>
<a href="#l36.183"></a><span id="l36.183"> </span>
<a href="#l36.184"></a><span id="l36.184" class="difflineminus">-  union     {FILETIME ftFileTime;</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineminus">-             __int64  ftInt64;</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineminus">-            } ftKernel; // time the process has spent in kernel mode</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineplus">+  union {</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineplus">+    FILETIME ftFileTime;</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineplus">+    __int64 ftInt64;</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineplus">+  } ftKernel;  // time the process has spent in kernel mode</span>
<a href="#l36.191"></a><span id="l36.191"> </span>
<a href="#l36.192"></a><span id="l36.192" class="difflineminus">-  union     {FILETIME ftFileTime;</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineminus">-             __int64  ftInt64;</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineminus">-            } ftUser;   // time the process has spent in user mode</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+  union {</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+    FILETIME ftFileTime;</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+    __int64 ftInt64;</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+  } ftUser;  // time the process has spent in user mode</span>
<a href="#l36.199"></a><span id="l36.199"> </span>
<a href="#l36.200"></a><span id="l36.200">   HANDLE hProcess = GetCurrentProcess();</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineplus">+#  ifdef DEBUG</span>
<a href="#l36.203"></a><span id="l36.203">   BOOL ret =</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineminus">-#endif</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineminus">-    GetProcessTimes(hProcess, &amp;ftCreate, &amp;ftExit,</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineminus">-                              &amp;ftKernel.ftFileTime, &amp;ftUser.ftFileTime);</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineplus">+#  endif</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineplus">+      GetProcessTimes(hProcess, &amp;ftCreate, &amp;ftExit, &amp;ftKernel.ftFileTime,</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+                      &amp;ftUser.ftFileTime);</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineplus">+#  ifdef DEBUG</span>
<a href="#l36.212"></a><span id="l36.212">   if (!ret)</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineminus">-    NS_ERROR(nsPrintfCString(&quot;GetProcessTimes() failed, error=0x%lx.&quot;, GetLastError()).get());</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineminus">-#endif</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+    NS_ERROR(nsPrintfCString(&quot;GetProcessTimes() failed, error=0x%lx.&quot;,</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+                             GetLastError())</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineplus">+                 .get());</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+#  endif</span>
<a href="#l36.219"></a><span id="l36.219"> </span>
<a href="#l36.220"></a><span id="l36.220">   /*</span>
<a href="#l36.221"></a><span id="l36.221">    * Process times are returned in a 64-bit structure, as the number of</span>
<a href="#l36.222"></a><span id="l36.222">    * 100 nanosecond ticks since 1 January 1601.  User mode and kernel mode</span>
<a href="#l36.223"></a><span id="l36.223">    * times for this process are in separate 64-bit structures.</span>
<a href="#l36.224"></a><span id="l36.224">    * Add them and convert the result to seconds.</span>
<a href="#l36.225"></a><span id="l36.225">    */</span>
<a href="#l36.226"></a><span id="l36.226">   return (ftKernel.ftInt64 + ftUser.ftInt64) * WIN32_TICK_RESOLUTION;</span>
<a href="#l36.227"></a><span id="l36.227"> #else</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineminus">-#error &quot;nsStopwatch not supported on this platform.&quot;</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+#  error &quot;nsStopwatch not supported on this platform.&quot;</span>
<a href="#l36.230"></a><span id="l36.230"> #endif</span>
<a href="#l36.231"></a><span id="l36.231"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/base/util/nsStopwatch.h</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/base/util/nsStopwatch.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -4,29 +4,33 @@</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5"> #ifndef _nsStopwatch_h_</span>
<a href="#l37.6"></a><span id="l37.6"> #define _nsStopwatch_h_</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> #include &quot;nsIStopwatch.h&quot;</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> #include &quot;msgCore.h&quot;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-#define NS_STOPWATCH_CID \</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-{0x6ef7eafd, 0x72d0, 0x4c56, {0x94, 0x09, 0x67, 0xe1, 0x6d, 0x0f, 0x25, 0x5b}}</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+#define NS_STOPWATCH_CID                             \</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+  {                                                  \</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+    0x6ef7eafd, 0x72d0, 0x4c56, {                    \</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+      0x94, 0x09, 0x67, 0xe1, 0x6d, 0x0f, 0x25, 0x5b \</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+    }                                                \</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+  }</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21"> #define NS_STOPWATCH_CONTRACTID &quot;@mozilla.org/stopwatch;1&quot;</span>
<a href="#l37.22"></a><span id="l37.22"> </span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-class NS_MSG_BASE nsStopwatch : public nsIStopwatch</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-{</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-public:</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+class NS_MSG_BASE nsStopwatch : public nsIStopwatch {</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+ public:</span>
<a href="#l37.28"></a><span id="l37.28">   NS_DECL_ISUPPORTS</span>
<a href="#l37.29"></a><span id="l37.29">   NS_DECL_NSISTOPWATCH</span>
<a href="#l37.30"></a><span id="l37.30"> </span>
<a href="#l37.31"></a><span id="l37.31">   nsStopwatch();</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-private:</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+ private:</span>
<a href="#l37.35"></a><span id="l37.35">   virtual ~nsStopwatch();</span>
<a href="#l37.36"></a><span id="l37.36"> </span>
<a href="#l37.37"></a><span id="l37.37">   /// Wall-clock start time in seconds since unix epoch.</span>
<a href="#l37.38"></a><span id="l37.38">   double fStartRealTimeSecs;</span>
<a href="#l37.39"></a><span id="l37.39">   /// Wall-clock stop time in seconds since unix epoch.</span>
<a href="#l37.40"></a><span id="l37.40">   double fStopRealTimeSecs;</span>
<a href="#l37.41"></a><span id="l37.41">   /// CPU-clock start time in seconds (of CPU time used since app start)</span>
<a href="#l37.42"></a><span id="l37.42">   double fStartCpuTimeSecs;</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineat">@@ -39,9 +43,9 @@ private:</span>
<a href="#l37.44"></a><span id="l37.44"> </span>
<a href="#l37.45"></a><span id="l37.45">   /// Is the timer running?</span>
<a href="#l37.46"></a><span id="l37.46">   bool fRunning;</span>
<a href="#l37.47"></a><span id="l37.47"> </span>
<a href="#l37.48"></a><span id="l37.48">   static double GetRealTime();</span>
<a href="#l37.49"></a><span id="l37.49">   static double GetCPUTime();</span>
<a href="#l37.50"></a><span id="l37.50"> };</span>
<a href="#l37.51"></a><span id="l37.51"> </span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-#endif // _nsStopwatch_h_</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+#endif  // _nsStopwatch_h_</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

