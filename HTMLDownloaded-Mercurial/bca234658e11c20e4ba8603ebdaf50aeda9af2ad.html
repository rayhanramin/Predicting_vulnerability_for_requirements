<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 58:bca234658e11c20e4ba8603ebdaf50aeda9af2ad</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ bca234658e11c20e4ba8603ebdaf50aeda9af2ad" />
<meta property="og:url" content="/comm-central/rev/bca234658e11c20e4ba8603ebdaf50aeda9af2ad" />
<meta property="og:description" content="Bug 404609 - Update Thunderbird installer with changes made to the Firefox installer. r=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / bca234658e11c20e4ba8603ebdaf50aeda9af2ad 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/bca234658e11c20e4ba8603ebdaf50aeda9af2ad">shortlog</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/bca234658e11c20e4ba8603ebdaf50aeda9af2ad">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad">files</a> |
changeset |
<a href="/comm-central/raw-rev/bca234658e11c20e4ba8603ebdaf50aeda9af2ad">raw</a>  | <a href="/comm-central/archive/bca234658e11c20e4ba8603ebdaf50aeda9af2ad.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=404609">Bug 404609</a> - Update Thunderbird installer with changes made to the Firefox installer. r=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#101;&#114;&#116;&#32;&#83;&#116;&#114;&#111;&#110;&#103;&#32;&#60;&#114;&#111;&#98;&#101;&#114;&#116;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 05 Aug 2008 14:20:17 -0700</td></tr>

<tr>
 <td>changeset 58</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/bca234658e11c20e4ba8603ebdaf50aeda9af2ad">bca234658e11c20e4ba8603ebdaf50aeda9af2ad</a></td>
</tr>



<tr>
<td>parent 57</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/81120c50a9b3859e2efb1a6732afd0f0c38b9b68">81120c50a9b3859e2efb1a6732afd0f0c38b9b68</a>
</td>
</tr>

<tr>
<td>child 59</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9a0a4988f2324d61a034d9526e36361a33960c7b">9a0a4988f2324d61a034d9526e36361a33960c7b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=bca234658e11c20e4ba8603ebdaf50aeda9af2ad">52</a></td></tr>
<tr><td>push user</td><td>rstrong@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 05 Aug 2008 21:21:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@bca234658e11 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&newProject=comm-central&newRevision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&newProject=comm-central&newRevision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&newProject=comm-central&newRevision=bca234658e11c20e4ba8603ebdaf50aeda9af2ad&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=404609">404609</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=404609">Bug 404609</a> - Update Thunderbird installer with changes made to the Firefox installer. r=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/nsMailDefaultHandler.js">mail/components/nsMailDefaultHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/nsMailDefaultHandler.js">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/nsMailDefaultHandler.js">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/nsMailDefaultHandler.js">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/nsMailDefaultHandler.js">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/nsMailDefaultHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/Makefile.in">mail/components/shell/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/Makefile.in">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/Makefile.in">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/Makefile.in">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/Makefile.in">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.cpp">mail/components/shell/nsMailWinIntegration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.cpp">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.cpp">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.cpp">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.cpp">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.h">mail/components/shell/nsMailWinIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.h">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.h">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.h">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.h">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/components/shell/nsMailWinIntegration.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/defines.nsi.in">mail/installer/windows/nsis/defines.nsi.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/defines.nsi.in">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/defines.nsi.in">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/defines.nsi.in">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/defines.nsi.in">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/defines.nsi.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/installer.nsi">mail/installer/windows/nsis/installer.nsi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/installer.nsi">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/installer.nsi">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/installer.nsi">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/installer.nsi">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/installer.nsi">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/shared.nsh">mail/installer/windows/nsis/shared.nsh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/shared.nsh">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/shared.nsh">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/shared.nsh">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/shared.nsh">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/shared.nsh">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/uninstaller.nsi">mail/installer/windows/nsis/uninstaller.nsi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/uninstaller.nsi">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/uninstaller.nsi">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/uninstaller.nsi">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/uninstaller.nsi">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/installer/windows/nsis/uninstaller.nsi">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/locales/en-US/installer/custom.properties">mail/locales/en-US/installer/custom.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/locales/en-US/installer/custom.properties">file</a> |
<a href="/comm-central/annotate/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/locales/en-US/installer/custom.properties">annotate</a> |
<a href="/comm-central/diff/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/locales/en-US/installer/custom.properties">diff</a> |
<a href="/comm-central/comparison/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/locales/en-US/installer/custom.properties">comparison</a> |
<a href="/comm-central/log/bca234658e11c20e4ba8603ebdaf50aeda9af2ad/mail/locales/en-US/installer/custom.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/nsMailDefaultHandler.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/nsMailDefaultHandler.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -340,21 +340,26 @@ var nsMailDefaultHandler = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">       wwatch.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l1.6"></a><span id="l1.6">                         &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8">   },</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   /* nsICommandLineValidator */</span>
<a href="#l1.11"></a><span id="l1.11">   validate : function mdh_validate(cmdLine) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    var osintFlagIdx = cmdLine.findFlag(&quot;osint&quot;, false);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    if (osintFlagIdx == -1)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+      return;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16">     // Other handlers may use osint so only handle the osint flag if the mail</span>
<a href="#l1.17"></a><span id="l1.17">     // or compose flag is also present and the command line is valid.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-    var osintFlagIdx = cmdLine.findFlag(&quot;osint&quot;, false);</span>
<a href="#l1.19"></a><span id="l1.19">     var mailFlagIdx = cmdLine.findFlag(&quot;mail&quot;, false);</span>
<a href="#l1.20"></a><span id="l1.20">     var composeFlagIdx = cmdLine.findFlag(&quot;compose&quot;, false);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    if (mailFlagIdx == -1 &amp;&amp; composeFlagIdx == -1)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+      return;</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">     // If both flags are present use the first flag found so the command line</span>
<a href="#l1.25"></a><span id="l1.25">     // length test will fail.</span>
<a href="#l1.26"></a><span id="l1.26">     if (mailFlagIdx &gt; -1 &amp;&amp; composeFlagIdx &gt; -1)</span>
<a href="#l1.27"></a><span id="l1.27">       var actionFlagIdx = mailFlagIdx &gt; composeFlagIdx ? composeFlagIdx : mailFlagIdx;</span>
<a href="#l1.28"></a><span id="l1.28">     else</span>
<a href="#l1.29"></a><span id="l1.29">       actionFlagIdx = mailFlagIdx &gt; -1 ? mailFlagIdx : composeFlagIdx;</span>
<a href="#l1.30"></a><span id="l1.30"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/shell/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/shell/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -59,16 +59,17 @@ endif</span>
<a href="#l2.4"></a><span id="l2.4"> REQUIRES = \</span>
<a href="#l2.5"></a><span id="l2.5"> 	xpcom \</span>
<a href="#l2.6"></a><span id="l2.6"> 	string \</span>
<a href="#l2.7"></a><span id="l2.7"> 	mozgnome \</span>
<a href="#l2.8"></a><span id="l2.8"> 	msgbase \</span>
<a href="#l2.9"></a><span id="l2.9"> 	appcomps \</span>
<a href="#l2.10"></a><span id="l2.10"> 	appshell \</span>
<a href="#l2.11"></a><span id="l2.11"> 	intl \</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+	unicharutil \</span>
<a href="#l2.13"></a><span id="l2.13"> 	windowwatcher \</span>
<a href="#l2.14"></a><span id="l2.14"> 	pref \</span>
<a href="#l2.15"></a><span id="l2.15"> 	embed_base \</span>
<a href="#l2.16"></a><span id="l2.16"> 	msgMapi \</span>
<a href="#l2.17"></a><span id="l2.17"> 	$(NULL)</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l2.20"></a><span id="l2.20"> CPPSRCS = nsMailWinIntegration.cpp</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/shell/nsMailWinIntegration.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/shell/nsMailWinIntegration.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * The Original Code is Thunderbird Windows Integration.</span>
<a href="#l3.5"></a><span id="l3.5">  *</span>
<a href="#l3.6"></a><span id="l3.6">  * The Initial Developer of the Original Code is</span>
<a href="#l3.7"></a><span id="l3.7">  *   Scott MacGregor &lt;mscott@mozilla.org&gt;.</span>
<a href="#l3.8"></a><span id="l3.8">  * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l3.9"></a><span id="l3.9">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.10"></a><span id="l3.10">  *</span>
<a href="#l3.11"></a><span id="l3.11">  * Contributor(s):</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *   Robert Strong  &lt;robert.bugzilla@gmail.com&gt;</span>
<a href="#l3.13"></a><span id="l3.13">  *</span>
<a href="#l3.14"></a><span id="l3.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.15"></a><span id="l3.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.16"></a><span id="l3.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.17"></a><span id="l3.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.18"></a><span id="l3.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.19"></a><span id="l3.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.20"></a><span id="l3.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -33,25 +34,23 @@</span>
<a href="#l3.22"></a><span id="l3.22">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.23"></a><span id="l3.23">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.24"></a><span id="l3.24">  *</span>
<a href="#l3.25"></a><span id="l3.25">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> #include &quot;nsMailWinIntegration.h&quot;</span>
<a href="#l3.28"></a><span id="l3.28"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l3.29"></a><span id="l3.29"> #include &quot;nsICategoryManager.h&quot;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l3.31"></a><span id="l3.31"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l3.32"></a><span id="l3.32"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-#ifndef __MINGW32__</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-#include &quot;nsIMapiSupport.h&quot;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-#endif</span>
<a href="#l3.36"></a><span id="l3.36"> #include &quot;windows.h&quot;</span>
<a href="#l3.37"></a><span id="l3.37"> #include &quot;shellapi.h&quot;</span>
<a href="#l3.38"></a><span id="l3.38"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42"> #ifdef _WIN32_WINNT</span>
<a href="#l3.43"></a><span id="l3.43"> #undef _WIN32_WINNT</span>
<a href="#l3.44"></a><span id="l3.44"> #endif</span>
<a href="#l3.45"></a><span id="l3.45"> #define _WIN32_WINNT 0x0600</span>
<a href="#l3.46"></a><span id="l3.46"> #define INITGUID</span>
<a href="#l3.47"></a><span id="l3.47"> #include &lt;shlobj.h&gt;</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineat">@@ -62,343 +61,200 @@</span>
<a href="#l3.50"></a><span id="l3.50"> #endif</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52"> #define REG_FAILED(val) \</span>
<a href="#l3.53"></a><span id="l3.53">   (val != ERROR_SUCCESS)</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55"> NS_IMPL_ISUPPORTS1(nsWindowsShellService, nsIShellService)</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> static nsresult</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-OpenUserKeyForReading(HKEY aStartKey, const char* aKeyName, HKEY* aKey)</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+OpenKeyForReading(HKEY aKeyRoot, const nsAString&amp; aKeyName, HKEY* aKey)</span>
<a href="#l3.60"></a><span id="l3.60"> {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  DWORD result = ::RegOpenKeyEx(aStartKey, aKeyName, 0, KEY_READ, aKey);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  switch (result)</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    case ERROR_SUCCESS:</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      break;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    case ERROR_ACCESS_DENIED:</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-      return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    case ERROR_FILE_NOT_FOUND:</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-      if (aStartKey == HKEY_LOCAL_MACHINE)</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-      {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-        // prevent infinite recursion on the second pass through here if</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-        // ::RegOpenKeyEx fails in the all-users case.</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-        return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-      }</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-      return OpenUserKeyForReading(HKEY_LOCAL_MACHINE, aKeyName, aKey);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  }</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-}</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  const nsString &amp;flatName = PromiseFlatString(aKeyName);</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-// Sets the default mail registry keys for Windows versions prior to Vista.</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-// Try to open / create the key in HKLM and if that fails try to do the same</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-// in HKCU. Though this is not strictly the behavior I would expect it is the</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-// same behavior that Firefox and IE has when setting the default browser previous to Vista.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-static nsresult OpenKeyForWriting(HKEY aStartKey, const char* aKeyName, HKEY* aKey, PRBool aHKLMOnly)</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-{</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  DWORD dwDisp = 0;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  DWORD rv = ::RegCreateKeyEx(aStartKey, aKeyName, 0, NULL, 0,</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-                              KEY_READ | KEY_WRITE, NULL, aKey, &amp;dwDisp);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-  switch (rv)</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-  {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-    case ERROR_SUCCESS:</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      break;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    case ERROR_ACCESS_DENIED:</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-      if (aHKLMOnly || aStartKey == HKEY_CURRENT_USER)</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-        return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-      // fallback to HKCU immediately on access denied since we won't be able</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-      // to create the key.</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      return OpenKeyForWriting(HKEY_CURRENT_USER, aKeyName, aKey, aHKLMOnly);</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-    case ERROR_FILE_NOT_FOUND:</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-      rv = ::RegCreateKey(aStartKey, aKeyName, aKey);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-      if (rv != ERROR_SUCCESS)</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-      {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-        if (aHKLMOnly || aStartKey == HKEY_CURRENT_USER)</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-        {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-          // prevent infinite recursion on the second pass through here if</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-          // ::RegCreateKey fails in the current user case.</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-          return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-        }</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-        return OpenKeyForWriting(HKEY_CURRENT_USER, aKeyName, aKey, aHKLMOnly);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-      }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+  DWORD res = ::RegOpenKeyExW(aKeyRoot, flatName.get(), 0, KEY_READ, aKey);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+  switch (res) {</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  case ERROR_SUCCESS:</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    break;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  case ERROR_ACCESS_DENIED:</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+    return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+  case ERROR_FILE_NOT_FOUND:</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.122"></a><span id="l3.122">   }</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">   return NS_OK;</span>
<a href="#l3.125"></a><span id="l3.125"> }</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.128"></a><span id="l3.128"> // Default Mail Registry Settings</span>
<a href="#l3.129"></a><span id="l3.129"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-typedef enum { NO_SUBSTITUTION    = 0x00,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-               APP_PATH_SUBSTITUTION  = 0x01,</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-               APPNAME_SUBSTITUTION = 0x02,</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-               UNINST_PATH_SUBSTITUTION  = 0x04,</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-               MAPIDLL_PATH_SUBSTITUTION = 0x08,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-               HKLM_ONLY = 0x10,</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-               USE_FOR_DEFAULT_TEST = 0x20} SettingFlags;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-#define CLS &quot;SOFTWARE\\Classes\\&quot;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-#define MAILCLIENTS &quot;SOFTWARE\\Clients\\Mail\\&quot;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-#define NEWSCLIENTS &quot;SOFTWARE\\Clients\\News\\&quot;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-#define MOZ_CLIENT_MAIL_KEY &quot;Software\\Clients\\Mail&quot;</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-#define MOZ_CLIENT_NEWS_KEY &quot;Software\\Clients\\News&quot;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-#define DI &quot;\\DefaultIcon&quot;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-#define II &quot;\\InstallInfo&quot;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+typedef enum {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  NO_SUBSTITUTION    = 0x00,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  APP_PATH_SUBSTITUTION  = 0x01</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+} SettingFlags;</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151"> // APP_REG_NAME_MAIL and APP_REG_NAME_NEWS should be kept in synch with</span>
<a href="#l3.152"></a><span id="l3.152"> // AppRegNameMail and AppRegNameNews in the installer file: defines.nsi.in</span>
<a href="#l3.153"></a><span id="l3.153"> #define APP_REG_NAME_MAIL L&quot;Thunderbird&quot;</span>
<a href="#l3.154"></a><span id="l3.154"> #define APP_REG_NAME_NEWS L&quot;Thunderbird (News)&quot;</span>
<a href="#l3.155"></a><span id="l3.155"> #define CLS_EML &quot;ThunderbirdEML&quot;</span>
<a href="#l3.156"></a><span id="l3.156"> #define CLS_MAILTOURL &quot;Thunderbird.Url.mailto&quot;</span>
<a href="#l3.157"></a><span id="l3.157"> #define CLS_NEWSURL &quot;Thunderbird.Url.news&quot;</span>
<a href="#l3.158"></a><span id="l3.158"> #define CLS_FEEDURL &quot;Thunderbird.Url.feed&quot;</span>
<a href="#l3.159"></a><span id="l3.159"> #define SOP &quot;\\shell\\open\\command&quot;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-// For the InstallInfo HideIconsCommand, ShowIconsCommand, and ReinstallCommand</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-// registry keys. This must be kept in sync with the uninstaller.</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-#define UNINSTALL_EXE &quot;\\uninstall\\helper.exe&quot;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-#define EXE &quot;thunderbird.exe&quot;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-#define VAL_ICON &quot;%APPPATH%,0&quot;</span>
<a href="#l3.167"></a><span id="l3.167"> #define VAL_OPEN &quot;\&quot;%APPPATH%\&quot; \&quot;%1\&quot;&quot;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+#define VAL_MAIL_OPEN &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+#define VAL_COMPOSE_OPEN &quot;\&quot;%APPPATH%\&quot; -osint -compose \&quot;%1\&quot;&quot;</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171"> #define MAKE_KEY_NAME1(PREFIX, MID) \</span>
<a href="#l3.172"></a><span id="l3.172">   PREFIX MID</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-#define MAKE_KEY_NAME2(PREFIX, MID, SUFFIX) \</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  PREFIX MID SUFFIX</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-</span>
<a href="#l3.177"></a><span id="l3.177"> static SETTING gMailSettings[] = {</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-  // File Extension Aliases</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-  { MAKE_KEY_NAME1(CLS, &quot;.eml&quot;),    &quot;&quot;, CLS_EML, NO_SUBSTITUTION },</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  // File Extension Class</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  { &quot;.eml&quot;, &quot;&quot;,  CLS_EML, NO_SUBSTITUTION },</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183">   // File Extension Class</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_EML, DI),  &quot;&quot;,  VAL_ICON, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_EML, SOP), &quot;&quot;,  VAL_OPEN, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  { MAKE_KEY_NAME1(CLS_EML, SOP), &quot;&quot;,  VAL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188">   // Protocol Handler Class - for Vista and above</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_MAILTOURL, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_MAILTOURL, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -compose \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  { MAKE_KEY_NAME1(CLS_MAILTOURL, SOP), &quot;&quot;, VAL_COMPOSE_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193">   // Protocol Handlers</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;mailto&quot;, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;mailto&quot;, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -compose \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION | USE_FOR_DEFAULT_TEST},</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-  // Mail Client Keys</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-  { MAKE_KEY_NAME1(MAILCLIENTS, &quot;%APPNAME%&quot;),</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-    &quot;DLLPath&quot;,</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-    &quot;%MAPIDLLPATH%&quot;,</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-    MAPIDLL_PATH_SUBSTITUTION | HKLM_ONLY | APPNAME_SUBSTITUTION },</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-  { MAKE_KEY_NAME2(MAILCLIENTS, &quot;%APPNAME%&quot;, II),</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    &quot;HideIconsCommand&quot;,</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    &quot;\&quot;%UNINSTPATH%\&quot; /HideShortcuts&quot;,</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    UNINST_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  { MAKE_KEY_NAME2(MAILCLIENTS, &quot;%APPNAME%&quot;, II),</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-    &quot;ReinstallCommand&quot;,</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-    &quot;\&quot;%UNINSTPATH%\&quot; /SetAsDefaultAppGlobal&quot;,</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-    UNINST_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-  { MAKE_KEY_NAME2(MAILCLIENTS, &quot;%APPNAME%&quot;, II),</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    &quot;ShowIconsCommand&quot;,</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    &quot;\&quot;%UNINSTPATH%\&quot; /ShowShortcuts&quot;,</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    UNINST_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-  { MAKE_KEY_NAME2(MAILCLIENTS, &quot;%APPNAME%&quot;, DI),</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-    &quot;%APPPATH%,0&quot;,</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-    APP_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-  { MAKE_KEY_NAME2(MAILCLIENTS, &quot;%APPNAME%&quot;, SOP),</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    &quot;\&quot;%APPPATH%\&quot; -mail&quot;,</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-    APP_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-  { MAKE_KEY_NAME1(MAILCLIENTS, &quot;%APPNAME%\\shell\\properties\\command&quot;),</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-    &quot;\&quot;%APPPATH%\&quot; -options&quot;,</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-    APP_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  { MAKE_KEY_NAME1(&quot;mailto&quot;, SOP), &quot;&quot;, VAL_COMPOSE_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.227"></a><span id="l3.227"> };</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229"> static SETTING gNewsSettings[] = {</span>
<a href="#l3.230"></a><span id="l3.230">    // Protocol Handler Class - for Vista and above</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_NEWSURL, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_NEWSURL, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+  { MAKE_KEY_NAME1(CLS_NEWSURL, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235">   // Protocol Handlers</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;news&quot;, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;news&quot;, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION | USE_FOR_DEFAULT_TEST},</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;nntp&quot;, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;nntp&quot;, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION | USE_FOR_DEFAULT_TEST},</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;snews&quot;, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;snews&quot;, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-  // News Client Keys</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-  { MAKE_KEY_NAME1(NEWSCLIENTS, &quot;%APPNAME%&quot;),</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    &quot;DLLPath&quot;,</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-    &quot;%MAPIDLLPATH%&quot;,</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-    MAPIDLL_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-  { MAKE_KEY_NAME2(NEWSCLIENTS, &quot;%APPNAME%&quot;, DI),</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    &quot;%APPPATH%,0&quot;,</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    APP_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-  { MAKE_KEY_NAME2(NEWSCLIENTS, &quot;%APPNAME%&quot;, SOP),</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-    &quot;\&quot;%APPPATH%\&quot; -mail&quot;,</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-    APP_PATH_SUBSTITUTION | APPNAME_SUBSTITUTION | HKLM_ONLY },</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  { MAKE_KEY_NAME1(&quot;news&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  { MAKE_KEY_NAME1(&quot;nntp&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.258"></a><span id="l3.258"> };</span>
<a href="#l3.259"></a><span id="l3.259"> </span>
<a href="#l3.260"></a><span id="l3.260"> static SETTING gFeedSettings[] = {</span>
<a href="#l3.261"></a><span id="l3.261">    // Protocol Handler Class - for Vista and above</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_FEEDURL, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, CLS_FEEDURL, SOP), &quot;&quot;, VAL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  { MAKE_KEY_NAME1(CLS_FEEDURL, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266">   // Protocol Handlers</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;feed&quot;, DI),  &quot;&quot;, VAL_ICON, APP_PATH_SUBSTITUTION},</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-  { MAKE_KEY_NAME2(CLS, &quot;feed&quot;, SOP), &quot;&quot;, &quot;\&quot;%APPPATH%\&quot; -osint -mail \&quot;%1\&quot;&quot;, APP_PATH_SUBSTITUTION | USE_FOR_DEFAULT_TEST},</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  { MAKE_KEY_NAME1(&quot;feed&quot;, SOP), &quot;&quot;, VAL_MAIL_OPEN, APP_PATH_SUBSTITUTION },</span>
<a href="#l3.270"></a><span id="l3.270"> };</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272"> nsresult nsWindowsShellService::Init()</span>
<a href="#l3.273"></a><span id="l3.273"> {</span>
<a href="#l3.274"></a><span id="l3.274">   nsresult rv;</span>
<a href="#l3.275"></a><span id="l3.275"> </span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle, brandBundle;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://branding/locale/brand.properties&quot;, getter_AddRefs(brandBundle));</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-  brandBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;brandFullName&quot;).get(),</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-                                 getter_Copies(mBrandFullName));</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-  brandBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;brandShortName&quot;).get(),</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-                                 getter_Copies(mBrandShortName));</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-  char appPath[MAX_BUF];</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-  if (!::GetModuleFileName(0, appPath, MAX_BUF))</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+  PRUnichar appPath[MAX_BUF];</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+  if (!::GetModuleFileNameW(0, appPath, MAX_BUF))</span>
<a href="#l3.292"></a><span id="l3.292">     return NS_ERROR_FAILURE;</span>
<a href="#l3.293"></a><span id="l3.293"> </span>
<a href="#l3.294"></a><span id="l3.294">   mAppLongPath = appPath;</span>
<a href="#l3.295"></a><span id="l3.295"> </span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; lf;</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-  rv = NS_NewNativeLocalFile(mAppLongPath, PR_TRUE,</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-                                      getter_AddRefs(lf));</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; appDir;</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-  rv = lf-&gt;GetParent(getter_AddRefs(appDir));</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-  appDir-&gt;GetNativePath(mUninstallPath);</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-  mUninstallPath.Append(UNINSTALL_EXE);</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-</span>
<a href="#l3.308"></a><span id="l3.308">   // Support short path to the exe so if it is already set the user is not</span>
<a href="#l3.309"></a><span id="l3.309">   // prompted to set the default mail client again.</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-  if (!::GetShortPathName(appPath, appPath, MAX_BUF))</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+  if (!::GetShortPathNameW(appPath, appPath, sizeof(appPath)))</span>
<a href="#l3.312"></a><span id="l3.312">     return NS_ERROR_FAILURE;</span>
<a href="#l3.313"></a><span id="l3.313"> </span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-  ToUpperCase(mAppShortPath = appPath);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-  rv = NS_NewNativeLocalFile(mAppLongPath, PR_TRUE, getter_AddRefs(lf));</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+  mAppShortPath = appPath;</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-  rv = lf-&gt;SetNativeLeafName(nsDependentCString(&quot;mozMapi32.dll&quot;));</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-  return lf-&gt;GetNativePath(mMapiDLLPath);</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.325"></a><span id="l3.325"> }</span>
<a href="#l3.326"></a><span id="l3.326"> </span>
<a href="#l3.327"></a><span id="l3.327"> nsWindowsShellService::nsWindowsShellService()</span>
<a href="#l3.328"></a><span id="l3.328"> :mCheckedThisSession(PR_FALSE)</span>
<a href="#l3.329"></a><span id="l3.329"> {</span>
<a href="#l3.330"></a><span id="l3.330"> }</span>
<a href="#l3.331"></a><span id="l3.331"> </span>
<a href="#l3.332"></a><span id="l3.332"> NS_IMETHODIMP</span>
<a href="#l3.333"></a><span id="l3.333"> nsWindowsShellService::IsDefaultClient(PRBool aStartupCheck, PRUint16 aApps, PRBool *aIsDefaultClient)</span>
<a href="#l3.334"></a><span id="l3.334"> {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-  if (IsDefaultClientVista(aStartupCheck, aApps, aIsDefaultClient))</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-  *aIsDefaultClient = PR_TRUE;</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-  // for each type,</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-  if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-    *aIsDefaultClient &amp;= TestForDefault(gMailSettings, sizeof(gMailSettings)/sizeof(SETTING));</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-  if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-    *aIsDefaultClient &amp;= TestForDefault(gNewsSettings, sizeof(gNewsSettings)/sizeof(SETTING));</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-  if (aApps &amp; nsIShellService::RSS)</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-    *aIsDefaultClient &amp;= TestForDefault(gFeedSettings, sizeof(gFeedSettings)/sizeof(SETTING));</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-</span>
<a href="#l3.348"></a><span id="l3.348">   // If this is the first mail window, maintain internal state that we've</span>
<a href="#l3.349"></a><span id="l3.349">   // checked this session (so that subsequent window opens don't show the</span>
<a href="#l3.350"></a><span id="l3.350">   // default client dialog).</span>
<a href="#l3.351"></a><span id="l3.351">   if (aStartupCheck)</span>
<a href="#l3.352"></a><span id="l3.352">     mCheckedThisSession = PR_TRUE;</span>
<a href="#l3.353"></a><span id="l3.353"> </span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-}</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+  *aIsDefaultClient = PR_TRUE;</span>
<a href="#l3.357"></a><span id="l3.357"> </span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-DWORD</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-nsWindowsShellService::DeleteRegKeyDefaultValue(HKEY baseKey, const char *keyName)</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-{</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-  HKEY key;</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-  DWORD rc = ::RegOpenKeyEx(baseKey, keyName, 0, KEY_WRITE, &amp;key);</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-  if (rc == ERROR_SUCCESS) {</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-    rc = ::RegDeleteValue(key, &quot;&quot;);</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-    ::RegCloseKey(key);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+  // for each type,</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+  if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+  {</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+    *aIsDefaultClient &amp;= TestForDefault(gMailSettings, sizeof(gMailSettings)/sizeof(SETTING));</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+    // Only check if this app is default on Vista if the previous checks</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+    // indicate that this app is the default.</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+    if (*aIsDefaultClient)</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+      IsDefaultClientVista(nsIShellService::MAIL, aIsDefaultClient);</span>
<a href="#l3.374"></a><span id="l3.374">   }</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-  return rc;</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+  if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+  {</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+    *aIsDefaultClient &amp;= TestForDefault(gNewsSettings, sizeof(gNewsSettings)/sizeof(SETTING));</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+    // Only check if this app is default on Vista if the previous checks</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+    // indicate that this app is the default.</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+    if (*aIsDefaultClient)</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+      IsDefaultClientVista(nsIShellService::NEWS, aIsDefaultClient);</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+  }</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+  // RSS / feed protocol shell integration is not working so return PR_TRUE</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+  // until it is fixed (bug 445823).</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+  if (aApps &amp; nsIShellService::RSS)</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+    *aIsDefaultClient &amp;= PR_TRUE;</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+//    *aIsDefaultClient &amp;= TestForDefault(gFeedSettings, sizeof(gFeedSettings)/sizeof(SETTING));</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.391"></a><span id="l3.391"> }</span>
<a href="#l3.392"></a><span id="l3.392"> </span>
<a href="#l3.393"></a><span id="l3.393"> NS_IMETHODIMP</span>
<a href="#l3.394"></a><span id="l3.394"> nsWindowsShellService::SetDefaultClient(PRBool aForAllUsers, PRUint16 aApps)</span>
<a href="#l3.395"></a><span id="l3.395"> {</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-  // Delete the protocol and file handlers under HKCU if they exist. This way</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-  // the HKCU registry is cleaned up when HKLM is writeable or if it isn't</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-  // the values will then be added under HKCU.</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-  if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+  nsCOMPtr&lt;nsIProperties&gt; directoryService = </span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+    do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; appHelper;</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  rv = directoryService-&gt;Get(NS_XPCOM_CURRENT_PROCESS_DIR, NS_GET_IID(nsILocalFile), getter_AddRefs(appHelper));</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+  rv = appHelper-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;uninstall&quot;));</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+  rv = appHelper-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;helper.exe&quot;));</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  nsAutoString appHelperPath;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+  rv = appHelper-&gt;GetPath(appHelperPath);</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+  if (aForAllUsers)</span>
<a href="#l3.420"></a><span id="l3.420">   {</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\ThunderbirdEML&quot;);</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-    (void)DeleteRegKeyDefaultValue(HKEY_CURRENT_USER, &quot;Software\\Classes\\.eml&quot;);</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\mailto\\shell\\open&quot;);</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\mailto\\DefaultIcon&quot;);</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+    appHelperPath.AppendLiteral(&quot; /SetAsDefaultAppGlobal&quot;);</span>
<a href="#l3.426"></a><span id="l3.426">   }</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-  if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+  else</span>
<a href="#l3.430"></a><span id="l3.430">   {</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\news\\shell\\open&quot;);</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\news\\DefaultIcon&quot;);</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\snews\\shell\\open&quot;);</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\snews\\DefaultIcon&quot;);</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\nntp\\shell\\open&quot;);</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\nntp\\DefaultIcon&quot;);</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+    appHelperPath.AppendLiteral(&quot; /SetAsDefaultAppUser&quot;);</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+    if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+      appHelperPath.AppendLiteral(&quot; Mail&quot;);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+    if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+      appHelperPath.AppendLiteral(&quot; News&quot;);</span>
<a href="#l3.443"></a><span id="l3.443">   }</span>
<a href="#l3.444"></a><span id="l3.444"> </span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-  if (aApps &amp; nsIShellService::RSS)</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-  {</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\feed\\shell\\open&quot;);</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-    (void)DeleteRegKey(HKEY_CURRENT_USER, &quot;Software\\Classes\\feed\\DefaultIcon&quot;);</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-  }</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+  STARTUPINFOW si = {sizeof(si), 0};</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+  PROCESS_INFORMATION pi = {0};</span>
<a href="#l3.452"></a><span id="l3.452"> </span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-  if (SetDefaultClientVista(aApps))</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+  BOOL ok = CreateProcessW(NULL, (LPWSTR)appHelperPath.get(), NULL, NULL,</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+                           FALSE, 0, NULL, NULL, &amp;si, &amp;pi);</span>
<a href="#l3.457"></a><span id="l3.457"> </span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-  if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-    rv |= setDefaultMail();</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-  if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-    rv |= setDefaultNews();</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+  if (!ok)</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.466"></a><span id="l3.466"> </span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-  if (aApps &amp; nsIShellService::RSS)</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-    setKeysForSettings(gFeedSettings, sizeof(gFeedSettings)/sizeof(SETTING),</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-                       NS_ConvertUTF16toUTF8(mBrandFullName).get());</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+  CloseHandle(pi.hProcess);</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+  CloseHandle(pi.hThread);</span>
<a href="#l3.472"></a><span id="l3.472"> </span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-  // Refresh the Shell</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-  SHChangeNotify(SHCNE_ASSOCCHANGED, SHCNF_IDLIST, 0, 0);</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-  return rv;</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.477"></a><span id="l3.477"> }</span>
<a href="#l3.478"></a><span id="l3.478"> </span>
<a href="#l3.479"></a><span id="l3.479"> NS_IMETHODIMP</span>
<a href="#l3.480"></a><span id="l3.480"> nsWindowsShellService::GetShouldCheckDefaultClient(PRBool* aResult)</span>
<a href="#l3.481"></a><span id="l3.481"> {</span>
<a href="#l3.482"></a><span id="l3.482">   if (mCheckedThisSession)</span>
<a href="#l3.483"></a><span id="l3.483">   {</span>
<a href="#l3.484"></a><span id="l3.484">     *aResult = PR_FALSE;</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineat">@@ -411,251 +267,71 @@ nsWindowsShellService::GetShouldCheckDef</span>
<a href="#l3.486"></a><span id="l3.486"> </span>
<a href="#l3.487"></a><span id="l3.487"> NS_IMETHODIMP</span>
<a href="#l3.488"></a><span id="l3.488"> nsWindowsShellService::SetShouldCheckDefaultClient(PRBool aShouldCheck)</span>
<a href="#l3.489"></a><span id="l3.489"> {</span>
<a href="#l3.490"></a><span id="l3.490">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l3.491"></a><span id="l3.491">   return prefs-&gt;SetBoolPref(&quot;mail.shell.checkDefaultClient&quot;, aShouldCheck);</span>
<a href="#l3.492"></a><span id="l3.492"> }</span>
<a href="#l3.493"></a><span id="l3.493"> </span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-nsresult</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-nsWindowsShellService::setDefaultMail()</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-{</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-  nsresult rv;</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-  NS_ConvertUTF16toUTF8 appName(mBrandFullName);</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-  setKeysForSettings(gMailSettings, sizeof(gMailSettings)/sizeof(SETTING), appName.get());</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-  // at least for now, this key needs to be written to HKLM instead of HKCU</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-  // which is where the windows operating system looks (at least on Win XP and earlier)</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-  SetRegKey(NS_LITERAL_CSTRING(MOZ_CLIENT_MAIL_KEY).get(), &quot;&quot;, appName.get(), PR_TRUE);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-  nsCAutoString nativeFullName;</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-  // For now, we use 'A' APIs (see bug 240272, 239279)</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-  NS_CopyUnicodeToNative(mBrandFullName, nativeFullName);</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-  nsCAutoString key1(NS_LITERAL_CSTRING(MAILCLIENTS));</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-  key1.Append(appName);</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-  key1.Append(&quot;\\&quot;);</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-  SetRegKey(key1.get(), &quot;&quot;, nativeFullName.get(), PR_TRUE);</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-  // Set the Options and Safe Mode start menu context menu item labels</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/shellservice.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-  nsCAutoString optionsKey(NS_LITERAL_CSTRING(MAILCLIENTS &quot;%APPNAME%\\shell\\properties&quot;));</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-  optionsKey.ReplaceSubstring(&quot;%APPNAME%&quot;, appName.get());</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-  const PRUnichar* brandNameStrings[] = { mBrandShortName.get() };</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-  // Set the Options menu item</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-  nsString optionsTitle;</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-  bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;optionsLabel&quot;).get(),</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-                               brandNameStrings, 1, getter_Copies(optionsTitle));</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-  // Set the registry keys</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-  nsCAutoString nativeTitle;</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-  // For the now, we use 'A' APIs (see bug 240272,  239279)</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-  NS_CopyUnicodeToNative(optionsTitle, nativeTitle);</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-  SetRegKey(optionsKey.get(), &quot;&quot;, nativeTitle.get(), PR_TRUE);</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-#ifndef __MINGW32__</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-  // Tell the MAPI Service to register the mapi proxy dll now that we are the default mail application</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-  nsCOMPtr&lt;nsIMapiSupport&gt; mapiService (do_GetService(NS_IMAPISUPPORT_CONTRACTID, &amp;rv));</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-  return mapiService-&gt;RegisterServer();</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-#else</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-#endif</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-}</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-nsresult</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-nsWindowsShellService::setDefaultNews()</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-{</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-  NS_ConvertUTF16toUTF8 appName(mBrandFullName);</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-  setKeysForSettings(gNewsSettings, sizeof(gNewsSettings)/sizeof(SETTING), appName.get());</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-  // at least for now, this key needs to be written to HKLM instead of HKCU</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-  // which is where the windows operating system looks (at least on Win XP and earlier)</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-  SetRegKey(NS_LITERAL_CSTRING(MOZ_CLIENT_NEWS_KEY).get(), &quot;&quot;, appName.get(), PR_TRUE);</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-  nsCAutoString nativeFullName;</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-  // For now, we use 'A' APIs (see bug 240272, 239279)</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-  NS_CopyUnicodeToNative(mBrandFullName, nativeFullName);</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-  nsCAutoString key1(NS_LITERAL_CSTRING(NEWSCLIENTS));</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-  key1.Append(appName);</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-  key1.Append(&quot;\\&quot;);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-  SetRegKey(key1.get(), &quot;&quot;, nativeFullName.get(), PR_TRUE);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-}</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-// Utility function to delete a registry subkey.</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-DWORD</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-nsWindowsShellService::DeleteRegKey(HKEY baseKey, const char *keyName)</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-{</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">- // Make sure input subkey isn't null.</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">- if (!keyName || !::strlen(keyName))</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-   return ERROR_BADKEY;</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">- DWORD rc;</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">- // Open subkey.</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">- HKEY key;</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">- rc = ::RegOpenKeyEx(baseKey, keyName, 0, KEY_ENUMERATE_SUB_KEYS | DELETE, &amp;key);</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">- // Continue till we get an error or are done.</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">- while (rc == ERROR_SUCCESS)</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">- {</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-   char subkeyName[_MAX_PATH];</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-   DWORD len = sizeof subkeyName;</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-   // Get first subkey name.  Note that we always get the</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-   // first one, then delete it.  So we need to get</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-   // the first one next time, also.</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-   rc = ::RegEnumKeyEx(key, 0, subkeyName, &amp;len, 0, 0, 0, 0);</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-   if (rc == ERROR_NO_MORE_ITEMS)</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-   {</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-     // No more subkeys.  Delete the main one.</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-     rc = ::RegDeleteKey(baseKey, keyName);</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-     break;</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-   }</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-   if (rc == ERROR_SUCCESS)</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-   {</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-     // Another subkey, delete it, recursively.</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-     rc = DeleteRegKey(key, subkeyName);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-   }</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">- }</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">- // Close the key we opened.</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">- ::RegCloseKey(key);</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">- return rc;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-}</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-void</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-nsWindowsShellService::SetRegKey(const char* aKeyName, const char* aValueName,</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-                                 const char* aValue, PRBool aHKLMOnly)</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-{</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-  char buf[MAX_BUF];</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-  DWORD len = sizeof buf;</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-  HKEY theKey;</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-  nsresult rv = OpenKeyForWriting(HKEY_LOCAL_MACHINE, aKeyName, &amp;theKey, aHKLMOnly);</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-    return;</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-  // Get the old value</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-  DWORD result = ::RegQueryValueEx(theKey, aValueName, NULL, NULL, (LPBYTE)buf, &amp;len);</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-  // Set the new value</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-  if (REG_FAILED(result) || strcmp(buf, aValue) != 0)</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-    ::RegSetValueEx(theKey, aValueName, 0, REG_SZ,</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-                    (LPBYTE)aValue, nsDependentCString(aValue).Length());</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-  // Close the key we opened.</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-  ::RegCloseKey(theKey);</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-}</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-/* helper routine. Iterate over the passed in settings object,</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-   testing each key with the USE_FOR_DEFAULT_TEST to see if</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-   we are handling it.</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-*/</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+/* helper routine. Iterate over the passed in settings object. */</span>
<a href="#l3.634"></a><span id="l3.634"> PRBool</span>
<a href="#l3.635"></a><span id="l3.635"> nsWindowsShellService::TestForDefault(SETTING aSettings[], PRInt32 aSize)</span>
<a href="#l3.636"></a><span id="l3.636"> {</span>
<a href="#l3.637"></a><span id="l3.637">   PRBool isDefault = PR_TRUE;</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-  NS_ConvertUTF16toUTF8 appName(mBrandFullName);</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-  char currValue[MAX_BUF];</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+  PRUnichar currValue[MAX_BUF];</span>
<a href="#l3.641"></a><span id="l3.641">   SETTING* end = aSettings + aSize;</span>
<a href="#l3.642"></a><span id="l3.642">   for (SETTING * settings = aSettings; settings &lt; end; ++settings)</span>
<a href="#l3.643"></a><span id="l3.643">   {</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-    if (settings-&gt;flags &amp; USE_FOR_DEFAULT_TEST)</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+    NS_ConvertUTF8toUTF16 dataLongPath(settings-&gt;valueData);</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+    NS_ConvertUTF8toUTF16 dataShortPath(settings-&gt;valueData);</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+    NS_ConvertUTF8toUTF16 key(settings-&gt;keyName);</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+    NS_ConvertUTF8toUTF16 value(settings-&gt;valueName);</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+    if (settings-&gt;flags &amp; APP_PATH_SUBSTITUTION)</span>
<a href="#l3.650"></a><span id="l3.650">     {</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-      nsCAutoString dataLongPath(settings-&gt;valueData);</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-      nsCAutoString dataShortPath(settings-&gt;valueData);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-      if (settings-&gt;flags &amp; APP_PATH_SUBSTITUTION) {</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-        PRInt32 offset = dataLongPath.Find(&quot;%APPPATH%&quot;);</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-        dataLongPath.Replace(offset, 9, mAppLongPath);</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-        // Remove the quotes around %APPPATH% in VAL_OPEN for short paths</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-        PRInt32 offsetQuoted = dataShortPath.Find(&quot;\&quot;%APPPATH%\&quot;&quot;);</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-        if (offsetQuoted != -1)</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-          dataShortPath.Replace(offsetQuoted, 11, mAppShortPath);</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-        else</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-          dataShortPath.Replace(offset, 9, mAppShortPath);</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-      }</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+      PRInt32 offset = dataLongPath.Find(&quot;%APPPATH%&quot;);</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+      dataLongPath.Replace(offset, 9, mAppLongPath);</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+      // Remove the quotes around %APPPATH% for short paths</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+      PRInt32 offsetQuoted = dataShortPath.Find(&quot;\&quot;%APPPATH%\&quot;&quot;);</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+      if (offsetQuoted != -1)</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+        dataShortPath.Replace(offsetQuoted, 11, mAppShortPath);</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+      else</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+        dataShortPath.Replace(offset, 9, mAppShortPath);</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+    }</span>
<a href="#l3.672"></a><span id="l3.672"> </span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-      nsCAutoString key(settings-&gt;keyName);</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-      if (settings-&gt;flags &amp; APPNAME_SUBSTITUTION)</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-      {</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-        PRInt32 offset = key.Find(&quot;%APPNAME%&quot;);</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-        key.Replace(offset, 9, appName);</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-      }</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+    ::ZeroMemory(currValue, sizeof(currValue));</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+    HKEY theKey;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+    nsresult rv = OpenKeyForReading(HKEY_CLASSES_ROOT, key, &amp;theKey);</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+    {</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+      // Key doesn't exist</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+      isDefault = PR_FALSE;</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+      break;</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+    }</span>
<a href="#l3.688"></a><span id="l3.688"> </span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-      ::ZeroMemory(currValue, sizeof(currValue));</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-      HKEY theKey;</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-      nsresult rv = OpenUserKeyForReading(HKEY_CURRENT_USER, key.get(), &amp;theKey);</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-      {</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-        DWORD len = sizeof currValue;</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-        DWORD result = ::RegQueryValueEx(theKey, settings-&gt;valueName, NULL, NULL, (LPBYTE)currValue, &amp;len);</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-        // Close the key we opened.</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-        ::RegCloseKey(theKey);</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-        if (REG_FAILED(result) || !dataLongPath.EqualsIgnoreCase(currValue) &amp;&amp; !dataShortPath.EqualsIgnoreCase(currValue))</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-        {</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-          // Key wasn't set, or was set to something else (something else became the default client)</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-          isDefault = PR_FALSE;</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-          break;</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-        }</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-      }</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+    DWORD len = sizeof currValue;</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+    DWORD result = ::RegQueryValueExW(theKey, PromiseFlatString(value).get(),</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+                                      NULL, NULL, (LPBYTE)currValue, &amp;len);</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+    // Close the key we opened.</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+    ::RegCloseKey(theKey);</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+    if (REG_FAILED(result) ||</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+        !dataLongPath.Equals(currValue, nsCaseInsensitiveStringComparator()) &amp;&amp;</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+        !dataShortPath.Equals(currValue, nsCaseInsensitiveStringComparator()))</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+    {</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+      // Key wasn't set, or was set to something else (something else became the default client)</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+      isDefault = PR_FALSE;</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+      break;</span>
<a href="#l3.717"></a><span id="l3.717">     }</span>
<a href="#l3.718"></a><span id="l3.718">   }  // for each registry key we want to look at</span>
<a href="#l3.719"></a><span id="l3.719"> </span>
<a href="#l3.720"></a><span id="l3.720">   return isDefault;</span>
<a href="#l3.721"></a><span id="l3.721"> }</span>
<a href="#l3.722"></a><span id="l3.722"> </span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-/* helper routine. Iterate over the passed in settings array, setting each key</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">- * in the windows registry.</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-*/</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-void</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-nsWindowsShellService::setKeysForSettings(SETTING aSettings[], PRInt32 aSize, const char * aAppName)</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-{</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-  SETTING* settings;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-  SETTING* end = aSettings + aSize;</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-  PRInt32 offset;</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-  for (settings = aSettings; settings &lt; end; ++settings)</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-  {</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-    nsCAutoString data(settings-&gt;valueData);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-    nsCAutoString key(settings-&gt;keyName);</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-    if (settings-&gt;flags &amp; APP_PATH_SUBSTITUTION)</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-    {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-      offset = data.Find(&quot;%APPPATH%&quot;);</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-      data.Replace(offset, 9, mAppLongPath);</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-    }</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-    if (settings-&gt;flags &amp; MAPIDLL_PATH_SUBSTITUTION)</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-    {</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-      offset = data.Find(&quot;%MAPIDLLPATH%&quot;);</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-      data.Replace(offset, 13, mMapiDLLPath);</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-    }</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-    if (settings-&gt;flags &amp; APPNAME_SUBSTITUTION)</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-    {</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-      offset = key.Find(&quot;%APPNAME%&quot;);</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-      key.Replace(offset, 9, aAppName);</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-    }</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-    if (settings-&gt;flags &amp; UNINST_PATH_SUBSTITUTION)</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-    {</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-      offset = data.Find(&quot;%UNINSTPATH%&quot;);</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-      data.Replace(offset, 12, mUninstallPath);</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-    }</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-    SetRegKey(key.get(), settings-&gt;valueName, data.get(), settings-&gt;flags &amp; HKLM_ONLY);</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-  }</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-}</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-</span>
<a href="#l3.764"></a><span id="l3.764"> PRBool</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-nsWindowsShellService::IsDefaultClientVista(PRBool aStartupCheck, PRUint16 aApps, PRBool* aIsDefaultClient)</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+nsWindowsShellService::IsDefaultClientVista(PRUint16 aApps, PRBool* aIsDefaultClient)</span>
<a href="#l3.767"></a><span id="l3.767"> {</span>
<a href="#l3.768"></a><span id="l3.768"> #if !defined(MOZ_DISABLE_VISTA_SDK_REQUIREMENTS)</span>
<a href="#l3.769"></a><span id="l3.769">   IApplicationAssociationRegistration* pAAR;</span>
<a href="#l3.770"></a><span id="l3.770"> </span>
<a href="#l3.771"></a><span id="l3.771">   HRESULT hr = CoCreateInstance (CLSID_ApplicationAssociationRegistration,</span>
<a href="#l3.772"></a><span id="l3.772">                                  NULL,</span>
<a href="#l3.773"></a><span id="l3.773">                                  CLSCTX_INPROC,</span>
<a href="#l3.774"></a><span id="l3.774">                                  IID_IApplicationAssociationRegistration,</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineat">@@ -667,46 +343,14 @@ nsWindowsShellService::IsDefaultClientVi</span>
<a href="#l3.776"></a><span id="l3.776">     PRBool isDefaultNews = PR_TRUE;</span>
<a href="#l3.777"></a><span id="l3.777">     if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.778"></a><span id="l3.778">       pAAR-&gt;QueryAppIsDefaultAll(AL_EFFECTIVE, APP_REG_NAME_MAIL, &amp;isDefaultMail);</span>
<a href="#l3.779"></a><span id="l3.779">     if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.780"></a><span id="l3.780">       pAAR-&gt;QueryAppIsDefaultAll(AL_EFFECTIVE, APP_REG_NAME_NEWS, &amp;isDefaultNews);</span>
<a href="#l3.781"></a><span id="l3.781"> </span>
<a href="#l3.782"></a><span id="l3.782">     *aIsDefaultClient = isDefaultNews &amp;&amp; isDefaultMail;</span>
<a href="#l3.783"></a><span id="l3.783"> </span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-    // If this is the first mail window, maintain internal state that we've</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-    // checked this session (so that subsequent window opens don't show the</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-    // default browser dialog).</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-    if (aStartupCheck)</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-      mCheckedThisSession = PR_TRUE;</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-</span>
<a href="#l3.790"></a><span id="l3.790">     pAAR-&gt;Release();</span>
<a href="#l3.791"></a><span id="l3.791">     return PR_TRUE;</span>
<a href="#l3.792"></a><span id="l3.792">   }</span>
<a href="#l3.793"></a><span id="l3.793"> #endif</span>
<a href="#l3.794"></a><span id="l3.794">   return PR_FALSE;</span>
<a href="#l3.795"></a><span id="l3.795"> }</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-PRBool</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-nsWindowsShellService::SetDefaultClientVista(PRUint16 aApps)</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-{</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-#if !defined(MOZ_DISABLE_VISTA_SDK_REQUIREMENTS)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-  IApplicationAssociationRegistration* pAAR;</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-  HRESULT hr = CoCreateInstance (CLSID_ApplicationAssociationRegistration,</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-                                 NULL,</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-                                 CLSCTX_INPROC,</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-                                 IID_IApplicationAssociationRegistration,</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-                                 (void**)&amp;pAAR);</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-  if (SUCCEEDED(hr))</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-  {</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-    if (aApps &amp; nsIShellService::MAIL)</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-      hr = pAAR-&gt;SetAppAsDefaultAll(APP_REG_NAME_MAIL);</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-    if (aApps &amp; nsIShellService::NEWS)</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-      hr = pAAR-&gt;SetAppAsDefaultAll(APP_REG_NAME_NEWS);</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-    pAAR-&gt;Release();</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-    return PR_TRUE;</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-  }</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-#endif</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-  return PR_FALSE;</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/shell/nsMailWinIntegration.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/shell/nsMailWinIntegration.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -63,33 +63,18 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4">   nsWindowsShellService();</span>
<a href="#l4.5"></a><span id="l4.5">   virtual ~nsWindowsShellService() {};</span>
<a href="#l4.6"></a><span id="l4.6">   NS_HIDDEN_(nsresult) Init();</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   NS_DECL_ISUPPORTS</span>
<a href="#l4.9"></a><span id="l4.9">   NS_DECL_NSISHELLSERVICE</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> protected:</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  void SetRegKey(const char* aKeyName, const char* aValueName, </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                 const char* aValue, PRBool aHKLMOnly);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  DWORD DeleteRegKey(HKEY baseKey, const char *keyName);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-  DWORD DeleteRegKeyDefaultValue(HKEY baseKey, const char *keyName);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-</span>
<a href="#l4.17"></a><span id="l4.17">   PRBool TestForDefault(SETTING aSettings[], PRInt32 aSize);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  void setKeysForSettings(SETTING aSettings[], PRInt32 aSize, </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-                          const char * aAppname);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  nsresult setDefaultMail();</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  nsresult setDefaultNews();</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  PRBool IsDefaultClientVista(PRBool aStartupCheck, PRUint16 aApps, PRBool* aIsDefaultClient);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  PRBool SetDefaultClientVista(PRUint16 aApps);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  PRBool IsDefaultClientVista(PRUint16 aApps, PRBool* aIsDefaultClient);</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> private:</span>
<a href="#l4.28"></a><span id="l4.28">   PRBool mCheckedThisSession;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  nsCString mAppLongPath;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  nsCString mAppShortPath;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  nsCString mMapiDLLPath;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  nsCString mUninstallPath;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  nsString mBrandFullName;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  nsString mBrandShortName;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  nsAutoString mAppLongPath;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  nsAutoString mAppShortPath;</span>
<a href="#l4.37"></a><span id="l4.37">  };</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/installer/windows/nsis/defines.nsi.in</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/installer/windows/nsis/defines.nsi.in</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -7,9 +7,11 @@</span>
<a href="#l5.4"></a><span id="l5.4"> !define FileInstallerNETRoot  &quot;@PKG_BASENAME@.net-installer&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> !define FileMainEXE           &quot;thunderbird.exe&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> !define WindowClass           &quot;ThunderbirdMessageWindow&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> !define AppRegNameMail        &quot;Thunderbird&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> !define AppRegNameNews        &quot;Thunderbird (News)&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+!define ClientsRegName        &quot;Mozilla Thunderbird&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14"> !define MinUnsupportedVer     &quot;Microsoft Windows 2000&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/installer/windows/nsis/installer.nsi</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/installer/windows/nsis/installer.nsi</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -31,100 +31,108 @@</span>
<a href="#l6.4"></a><span id="l6.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.5"></a><span id="l6.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.6"></a><span id="l6.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.7"></a><span id="l6.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.8"></a><span id="l6.8"> #</span>
<a href="#l6.9"></a><span id="l6.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> # Required Plugins:</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-# ShellLink    http://nsis.sourceforge.net/ShellLink_plug-in</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+# AppAssocReg http://nsis.sourceforge.net/Application_Association_Registration_plug-in</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+# ShellLink   http://nsis.sourceforge.net/ShellLink_plug-in</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+# UAC         http://nsis.sourceforge.net/UAC_plug-in</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> ; Set verbosity to 3 (e.g. no script) to lessen the noise in the build logs</span>
<a href="#l6.18"></a><span id="l6.18"> !verbose 3</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> ; 7-Zip provides better compression than the lzma from NSIS so we add the files</span>
<a href="#l6.21"></a><span id="l6.21"> ; uncompressed and use 7-Zip to create a SFX archive of it</span>
<a href="#l6.22"></a><span id="l6.22"> SetDatablockOptimize on</span>
<a href="#l6.23"></a><span id="l6.23"> SetCompress off</span>
<a href="#l6.24"></a><span id="l6.24"> CRCCheck on</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+RequestExecutionLevel user</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+</span>
<a href="#l6.28"></a><span id="l6.28"> !addplugindir ./</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> ; empty files - except for the comment line - for generating custom pages.</span>
<a href="#l6.31"></a><span id="l6.31"> !system 'echo ; &gt; options.ini'</span>
<a href="#l6.32"></a><span id="l6.32"> !system 'echo ; &gt; components.ini'</span>
<a href="#l6.33"></a><span id="l6.33"> !system 'echo ; &gt; shortcuts.ini'</span>
<a href="#l6.34"></a><span id="l6.34"> !system 'echo ; &gt; summary.ini'</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+; USE_UAC_PLUGIN is temporary until other apps have been updated to use the UAC plugin</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+!define USE_UAC_PLUGIN</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+</span>
<a href="#l6.39"></a><span id="l6.39"> Var TmpVal</span>
<a href="#l6.40"></a><span id="l6.40"> Var StartMenuDir</span>
<a href="#l6.41"></a><span id="l6.41"> Var InstallType</span>
<a href="#l6.42"></a><span id="l6.42"> Var AddStartMenuSC</span>
<a href="#l6.43"></a><span id="l6.43"> Var AddQuickLaunchSC</span>
<a href="#l6.44"></a><span id="l6.44"> Var AddDesktopSC</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46"> ; Other included files may depend upon these includes!</span>
<a href="#l6.47"></a><span id="l6.47"> ; The following includes are provided by NSIS.</span>
<a href="#l6.48"></a><span id="l6.48"> !include FileFunc.nsh</span>
<a href="#l6.49"></a><span id="l6.49"> !include LogicLib.nsh</span>
<a href="#l6.50"></a><span id="l6.50"> !include TextFunc.nsh</span>
<a href="#l6.51"></a><span id="l6.51"> !include WinMessages.nsh</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+!include WinVer.nsh</span>
<a href="#l6.53"></a><span id="l6.53"> !include WordFunc.nsh</span>
<a href="#l6.54"></a><span id="l6.54"> !include MUI.nsh</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-; WinVer.nsh was added in the same release that RequestExecutionLevel so check</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-; if ___WINVER__NSH___ is defined to determine if RequestExecutionLevel is</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-; available.</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-!include /NONFATAL WinVer.nsh</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-!ifdef ___WINVER__NSH___</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  RequestExecutionLevel admin</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-!else</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  !warning &quot;Installer will be created without Vista compatibility.$\n            \</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-            Upgrade your NSIS installation to at least version 2.22 to resolve.&quot;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-!endif</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+!insertmacro GetOptions</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+!insertmacro GetParameters</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+!insertmacro GetSize</span>
<a href="#l6.70"></a><span id="l6.70"> !insertmacro WordFind</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-!insertmacro WordReplace</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-!insertmacro GetSize</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74"> ; NSIS provided macros that we have overridden</span>
<a href="#l6.75"></a><span id="l6.75"> !include overrides.nsh</span>
<a href="#l6.76"></a><span id="l6.76"> !insertmacro LocateNoDetails</span>
<a href="#l6.77"></a><span id="l6.77"> !insertmacro TextCompareNoDetails</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79"> ; The following includes are custom.</span>
<a href="#l6.80"></a><span id="l6.80"> !include branding.nsi</span>
<a href="#l6.81"></a><span id="l6.81"> !include defines.nsi</span>
<a href="#l6.82"></a><span id="l6.82"> !include common.nsh</span>
<a href="#l6.83"></a><span id="l6.83"> !include locales.nsi</span>
<a href="#l6.84"></a><span id="l6.84"> !include version.nsh</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-VIAddVersionKey &quot;FileDescription&quot; &quot;${BrandShortName} Installer&quot;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+VIAddVersionKey &quot;FileDescription&quot;  &quot;${BrandShortName} Installer&quot;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+VIAddVersionKey &quot;OriginalFilename&quot; &quot;setup.exe&quot;</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90"> ; Must be inserted before other macros that use logging</span>
<a href="#l6.91"></a><span id="l6.91"> !insertmacro _LoggingCommon</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93"> !insertmacro AddHandlerValues</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+!insertmacro ChangeMUIHeaderImage</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+!insertmacro CheckForFilesInUse</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+!insertmacro CleanUpdatesDir</span>
<a href="#l6.97"></a><span id="l6.97"> !insertmacro CloseApp</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+!insertmacro CopyFilesFromDir</span>
<a href="#l6.99"></a><span id="l6.99"> !insertmacro GetPathFromString</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+!insertmacro GetParent</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+!insertmacro IsHandlerForInstallDir</span>
<a href="#l6.102"></a><span id="l6.102"> !insertmacro ManualCloseAppPrompt</span>
<a href="#l6.103"></a><span id="l6.103"> !insertmacro RegCleanMain</span>
<a href="#l6.104"></a><span id="l6.104"> !insertmacro RegCleanUninstall</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+!insertmacro SetBrandNameVars</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+!insertmacro UnloadUAC</span>
<a href="#l6.107"></a><span id="l6.107"> !insertmacro WriteRegStr2</span>
<a href="#l6.108"></a><span id="l6.108"> !insertmacro WriteRegDWORD2</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110"> !include shared.nsh</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112"> ; Helper macros for ui callbacks. Insert these after shared.nsh</span>
<a href="#l6.113"></a><span id="l6.113"> !insertmacro CheckCustomCommon</span>
<a href="#l6.114"></a><span id="l6.114"> !insertmacro InstallEndCleanupCommon</span>
<a href="#l6.115"></a><span id="l6.115"> !insertmacro InstallOnInitCommon</span>
<a href="#l6.116"></a><span id="l6.116"> !insertmacro InstallStartCleanupCommon</span>
<a href="#l6.117"></a><span id="l6.117"> !insertmacro LeaveDirectoryCommon</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+!insertmacro OnEndCommon</span>
<a href="#l6.119"></a><span id="l6.119"> !insertmacro PreDirectoryCommon</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121"> Name &quot;${BrandFullName}&quot;</span>
<a href="#l6.122"></a><span id="l6.122"> OutFile &quot;setup.exe&quot;</span>
<a href="#l6.123"></a><span id="l6.123"> InstallDirRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${BrandFullNameInternal} (${AppVersion})&quot; &quot;InstallLocation&quot;</span>
<a href="#l6.124"></a><span id="l6.124"> InstallDir &quot;$PROGRAMFILES\${BrandFullName}\&quot;</span>
<a href="#l6.125"></a><span id="l6.125"> ShowInstDetails nevershow</span>
<a href="#l6.126"></a><span id="l6.126"> </span>
<a href="#l6.127"></a><span id="l6.127" class="difflineat">@@ -150,19 +158,21 @@ ReserveFile summary.ini</span>
<a href="#l6.128"></a><span id="l6.128"> !else</span>
<a href="#l6.129"></a><span id="l6.129"> !define MUI_HEADERIMAGE_BITMAP wizHeader.bmp</span>
<a href="#l6.130"></a><span id="l6.130"> !endif</span>
<a href="#l6.131"></a><span id="l6.131"> </span>
<a href="#l6.132"></a><span id="l6.132"> /**</span>
<a href="#l6.133"></a><span id="l6.133">  * Installation Pages</span>
<a href="#l6.134"></a><span id="l6.134">  */</span>
<a href="#l6.135"></a><span id="l6.135"> ; Welcome Page</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+!define MUI_PAGE_CUSTOMFUNCTION_PRE preWelcome</span>
<a href="#l6.137"></a><span id="l6.137"> !insertmacro MUI_PAGE_WELCOME</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139"> ; License Page</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+!define MUI_PAGE_CUSTOMFUNCTION_SHOW showLicense</span>
<a href="#l6.141"></a><span id="l6.141"> !define MUI_LICENSEPAGE_CHECKBOX</span>
<a href="#l6.142"></a><span id="l6.142"> !insertmacro MUI_PAGE_LICENSE license.rtf</span>
<a href="#l6.143"></a><span id="l6.143"> </span>
<a href="#l6.144"></a><span id="l6.144"> ; Custom Options Page</span>
<a href="#l6.145"></a><span id="l6.145"> Page custom preOptions leaveOptions</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147"> ; Custom Components Page</span>
<a href="#l6.148"></a><span id="l6.148"> Page custom preComponents leaveComponents</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineat">@@ -173,145 +183,92 @@ Page custom preComponents leaveComponent</span>
<a href="#l6.150"></a><span id="l6.150"> !define MUI_DIRECTORYPAGE_VERIFYONLEAVE</span>
<a href="#l6.151"></a><span id="l6.151"> !insertmacro MUI_PAGE_DIRECTORY</span>
<a href="#l6.152"></a><span id="l6.152"> </span>
<a href="#l6.153"></a><span id="l6.153"> ; Custom Shortcuts Page</span>
<a href="#l6.154"></a><span id="l6.154"> Page custom preShortcuts leaveShortcuts</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156"> ; Start Menu Folder Page Configuration</span>
<a href="#l6.157"></a><span id="l6.157"> !define MUI_PAGE_CUSTOMFUNCTION_PRE preStartMenu</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+!define MUI_PAGE_CUSTOMFUNCTION_LEAVE leaveStartMenu</span>
<a href="#l6.159"></a><span id="l6.159"> !define MUI_STARTMENUPAGE_NODISABLE</span>
<a href="#l6.160"></a><span id="l6.160"> !define MUI_STARTMENUPAGE_REGISTRY_ROOT &quot;HKLM&quot;</span>
<a href="#l6.161"></a><span id="l6.161"> !define MUI_STARTMENUPAGE_REGISTRY_KEY &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})\Main&quot;</span>
<a href="#l6.162"></a><span id="l6.162"> !define MUI_STARTMENUPAGE_REGISTRY_VALUENAME &quot;Start Menu Folder&quot;</span>
<a href="#l6.163"></a><span id="l6.163"> !insertmacro MUI_PAGE_STARTMENU Application $StartMenuDir</span>
<a href="#l6.164"></a><span id="l6.164"> </span>
<a href="#l6.165"></a><span id="l6.165"> ; Custom Summary Page</span>
<a href="#l6.166"></a><span id="l6.166"> Page custom preSummary leaveSummary</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168"> ; Install Files Page</span>
<a href="#l6.169"></a><span id="l6.169"> !insertmacro MUI_PAGE_INSTFILES</span>
<a href="#l6.170"></a><span id="l6.170"> </span>
<a href="#l6.171"></a><span id="l6.171"> ; Finish Page</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-!define MUI_FINISHPAGE_NOREBOOTSUPPORT</span>
<a href="#l6.173"></a><span id="l6.173"> !define MUI_FINISHPAGE_TITLE_3LINES</span>
<a href="#l6.174"></a><span id="l6.174"> !define MUI_FINISHPAGE_RUN</span>
<a href="#l6.175"></a><span id="l6.175"> !define MUI_FINISHPAGE_RUN_FUNCTION LaunchApp</span>
<a href="#l6.176"></a><span id="l6.176"> !define MUI_FINISHPAGE_RUN_TEXT $(LAUNCH_TEXT)</span>
<a href="#l6.177"></a><span id="l6.177"> !define MUI_PAGE_CUSTOMFUNCTION_PRE preFinish</span>
<a href="#l6.178"></a><span id="l6.178"> !insertmacro MUI_PAGE_FINISH</span>
<a href="#l6.179"></a><span id="l6.179"> </span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+; Use the default dialog for IDD_VERIFY for a simple Banner</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+ChangeUI IDD_VERIFY &quot;${NSISDIR}\Contrib\UIs\default.exe&quot;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+</span>
<a href="#l6.183"></a><span id="l6.183"> ################################################################################</span>
<a href="#l6.184"></a><span id="l6.184"> # Install Sections</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186"> ; Cleanup operations to perform at the start of the installation.</span>
<a href="#l6.187"></a><span id="l6.187"> Section &quot;-InstallStartCleanup&quot;</span>
<a href="#l6.188"></a><span id="l6.188">   SetDetailsPrint both</span>
<a href="#l6.189"></a><span id="l6.189">   DetailPrint $(STATUS_CLEANUP)</span>
<a href="#l6.190"></a><span id="l6.190">   SetDetailsPrint none</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-  SetOutPath $INSTDIR</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  SetOutPath &quot;$INSTDIR&quot;</span>
<a href="#l6.194"></a><span id="l6.194">   ${StartInstallLog} &quot;${BrandFullName}&quot; &quot;${AB_CD}&quot; &quot;${AppVersion}&quot; &quot;${GREVersion}&quot;</span>
<a href="#l6.195"></a><span id="l6.195"> </span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-  ; Try to delete the app's main executable and if we can't delete it try to</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  ; close the app. This allows running an instance that is located in another</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  ; directory and prevents the launching of the app during the installation.</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-  ; A copy of the executable is placed in a temporary directory so it can be</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  ; copied back in the case where a specific file is checked / found to be in</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  ; use that would prevent a successful install.</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-  ; Create a temporary backup directory.</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-  GetTempFileName $TmpVal &quot;$TEMP&quot;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-  ${DeleteFile} $TmpVal</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-  SetOutPath $TmpVal</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+  ; Delete the app exe to prevent launching the app while we are installing.</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  ClearErrors</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    ; If the user closed the application it can take several seconds for it to</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    ; shut down completely. If the application is being used by another user we</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+    ; can rename the file and then delete is when the system is restarted.</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+    Sleep 5000</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.218"></a><span id="l6.218">     ClearErrors</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    CopyFiles /SILENT &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$TmpVal\${FileMainEXE}&quot;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-    Delete &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-    ${If} ${Errors}</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-      ClearErrors</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-      ${CloseApp} &quot;true&quot; $(WARN_APP_RUNNING_INSTALL)</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-      ; Try to delete it again to prevent launching the app while we are</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-      ; installing.</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-      ClearErrors</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-      CopyFiles /SILENT &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$TmpVal\${FileMainEXE}&quot;</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-      Delete &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-      ${If} ${Errors}</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-        ClearErrors</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-        ; Try closing the app a second time</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-        ${CloseApp} &quot;true&quot; $(WARN_APP_RUNNING_INSTALL)</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-        StrCpy $R1 &quot;${FileMainEXE}&quot;</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-        Call CheckInUse</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-      ${EndIf}</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-    ${EndIf}</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-  ${EndIf}</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-  StrCpy $R1 &quot;freebl3.dll&quot;</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-  Call CheckInUse</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-  StrCpy $R1 &quot;nssckbi.dll&quot;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-  Call CheckInUse</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-  StrCpy $R1 &quot;nspr4.dll&quot;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-  Call CheckInUse</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-  StrCpy $R1 &quot;xpicleanup.exe&quot;</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-  Call CheckInUse</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-  SetOutPath $INSTDIR</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-  RmDir /r &quot;$TmpVal&quot;</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-  ClearErrors</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-  Call CleanupOldLogs</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\uninstall\uninstall.log&quot;</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-    ; Diff cleanup.log with uninstall.bak</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-    ${LogHeader} &quot;Updating Uninstall Log With XPInstall Wizard Logs&quot;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-    StrCpy $R0 &quot;$INSTDIR\uninstall\uninstall.log&quot;</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-    StrCpy $R1 &quot;$INSTDIR\uninstall\cleanup.log&quot;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-    GetTempFileName $R2</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-    FileOpen $R3 $R2 w</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-    ${TextCompareNoDetails} &quot;$R1&quot; &quot;$R0&quot; &quot;SlowDiff&quot; &quot;GetDiff&quot;</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-    FileClose $R3</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-    ${Unless} ${Errors}</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-      ${FileJoin} &quot;$INSTDIR\uninstall\uninstall.log&quot; &quot;$R2&quot; &quot;$INSTDIR\uninstall\uninstall.log&quot;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-    ${EndUnless}</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-    ${DeleteFile} &quot;$INSTDIR\uninstall\cleanup.log&quot;</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-    ${DeleteFile} &quot;$R2&quot;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-    ${DeleteFile} &quot;$INSTDIR\uninstall\uninstall.bak&quot;</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-    Rename &quot;$INSTDIR\uninstall\uninstall.log&quot; &quot;$INSTDIR\uninstall\uninstall.bak&quot;</span>
<a href="#l6.274"></a><span id="l6.274">   ${EndIf}</span>
<a href="#l6.275"></a><span id="l6.275"> </span>
<a href="#l6.276"></a><span id="l6.276">   ${If} $InstallType == ${INSTALLTYPE_CUSTOM}</span>
<a href="#l6.277"></a><span id="l6.277">     ; Custom installs.</span>
<a href="#l6.278"></a><span id="l6.278">     ; If DOMi is installed and this install includes DOMi remove it from</span>
<a href="#l6.279"></a><span id="l6.279">     ; the installation directory. This will remove it if the user deselected</span>
<a href="#l6.280"></a><span id="l6.280">     ; DOMi on the components page.</span>
<a href="#l6.281"></a><span id="l6.281">     ${If} ${FileExists} &quot;$INSTDIR\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.282"></a><span id="l6.282">     ${AndIf} ${FileExists} &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.283"></a><span id="l6.283">       RmDir /r &quot;$INSTDIR\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.284"></a><span id="l6.284">     ${EndIf}</span>
<a href="#l6.285"></a><span id="l6.285">   ${EndIf}</span>
<a href="#l6.286"></a><span id="l6.286"> </span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+  ; Remove the updates directory for Vista and above</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+  ${CleanUpdatesDir} &quot;Thunderbird&quot;</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+</span>
<a href="#l6.290"></a><span id="l6.290">   ${InstallStartCleanupCommon}</span>
<a href="#l6.291"></a><span id="l6.291"> SectionEnd</span>
<a href="#l6.292"></a><span id="l6.292"> </span>
<a href="#l6.293"></a><span id="l6.293"> Section &quot;-Application&quot; APP_IDX</span>
<a href="#l6.294"></a><span id="l6.294">   ${StartUninstallLog}</span>
<a href="#l6.295"></a><span id="l6.295"> </span>
<a href="#l6.296"></a><span id="l6.296">   SetDetailsPrint both</span>
<a href="#l6.297"></a><span id="l6.297">   DetailPrint $(STATUS_INSTALL_APP)</span>
<a href="#l6.298"></a><span id="l6.298">   SetDetailsPrint none</span>
<a href="#l6.299"></a><span id="l6.299"> </span>
<a href="#l6.300"></a><span id="l6.300">   ${LogHeader} &quot;Installing Main Files&quot;</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-  StrCpy $R0 &quot;$EXEDIR\nonlocalized&quot;</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-  StrCpy $R1 &quot;$INSTDIR&quot;</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-  Call DoCopyFiles</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+  ${CopyFilesFromDir} &quot;$EXEDIR\nonlocalized&quot; &quot;$INSTDIR&quot; \</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+                      &quot;$(ERROR_CREATE_DIRECTORY_PREFIX)&quot; \</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+                      &quot;$(ERROR_CREATE_DIRECTORY_SUFFIX)&quot;</span>
<a href="#l6.307"></a><span id="l6.307"> </span>
<a href="#l6.308"></a><span id="l6.308">   ; Register DLLs</span>
<a href="#l6.309"></a><span id="l6.309">   ; XXXrstrong - AccessibleMarshal.dll can be used by multiple applications but</span>
<a href="#l6.310"></a><span id="l6.310">   ; is only registered for the last application installed. When the last</span>
<a href="#l6.311"></a><span id="l6.311">   ; application installed is uninstalled AccessibleMarshal.dll will no longer be</span>
<a href="#l6.312"></a><span id="l6.312">   ; registered. bug 338878</span>
<a href="#l6.313"></a><span id="l6.313">   ${LogHeader} &quot;DLL Registration&quot;</span>
<a href="#l6.314"></a><span id="l6.314">   ClearErrors</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineat">@@ -336,19 +293,19 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l6.316"></a><span id="l6.316">   ${LogUninstall} &quot;File: \install_wizard.log&quot;</span>
<a href="#l6.317"></a><span id="l6.317">   ${LogUninstall} &quot;File: \updates.xml&quot;</span>
<a href="#l6.318"></a><span id="l6.318"> </span>
<a href="#l6.319"></a><span id="l6.319">   SetDetailsPrint both</span>
<a href="#l6.320"></a><span id="l6.320">   DetailPrint $(STATUS_INSTALL_LANG)</span>
<a href="#l6.321"></a><span id="l6.321">   SetDetailsPrint none</span>
<a href="#l6.322"></a><span id="l6.322"> </span>
<a href="#l6.323"></a><span id="l6.323">   ${LogHeader} &quot;Installing Localized Files&quot;</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-  StrCpy $R0 &quot;$EXEDIR\localized&quot;</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-  StrCpy $R1 &quot;$INSTDIR&quot;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-  Call DoCopyFiles</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+  ${CopyFilesFromDir} &quot;$EXEDIR\localized&quot; &quot;$INSTDIR&quot; \</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+                      &quot;$(ERROR_CREATE_DIRECTORY_PREFIX)&quot; \</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+                      &quot;$(ERROR_CREATE_DIRECTORY_SUFFIX)&quot;</span>
<a href="#l6.330"></a><span id="l6.330"> </span>
<a href="#l6.331"></a><span id="l6.331">   ; Default for creating Start Menu folder and shortcuts</span>
<a href="#l6.332"></a><span id="l6.332">   ; (1 = create, 0 = don't create)</span>
<a href="#l6.333"></a><span id="l6.333">   ${If} $AddStartMenuSC == &quot;&quot;</span>
<a href="#l6.334"></a><span id="l6.334">     StrCpy $AddStartMenuSC &quot;1&quot;</span>
<a href="#l6.335"></a><span id="l6.335">   ${EndIf}</span>
<a href="#l6.336"></a><span id="l6.336"> </span>
<a href="#l6.337"></a><span id="l6.337">   ; Default for creating Quick Launch shortcut (1 = create, 0 = don't create)</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineat">@@ -356,69 +313,74 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l6.339"></a><span id="l6.339">     StrCpy $AddQuickLaunchSC &quot;1&quot;</span>
<a href="#l6.340"></a><span id="l6.340">   ${EndIf}</span>
<a href="#l6.341"></a><span id="l6.341"> </span>
<a href="#l6.342"></a><span id="l6.342">   ; Default for creating Desktop shortcut (1 = create, 0 = don't create)</span>
<a href="#l6.343"></a><span id="l6.343">   ${If} $AddDesktopSC == &quot;&quot;</span>
<a href="#l6.344"></a><span id="l6.344">     StrCpy $AddDesktopSC &quot;1&quot;</span>
<a href="#l6.345"></a><span id="l6.345">   ${EndIf}</span>
<a href="#l6.346"></a><span id="l6.346"> </span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-  ; Remove registry entries for non-existent apps and for apps that point to our</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-  ; install location in the Software\Mozilla key and uninstall registry entries</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-  ; that point to our install location for both HKCU and HKLM.</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+  ${LogHeader} &quot;Adding Registry Entries&quot;</span>
<a href="#l6.351"></a><span id="l6.351">   SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l6.352"></a><span id="l6.352">   ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l6.353"></a><span id="l6.353">   ${RegCleanUninstall}</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-  SetShellVarContext all  ; Set SHCTX to HKLM</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-  ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-  ${RegCleanUninstall}</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+  ${UpdateProtocolHandlers}</span>
<a href="#l6.359"></a><span id="l6.359"> </span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-  ${LogHeader} &quot;Adding Registry Entries&quot;</span>
<a href="#l6.361"></a><span id="l6.361">   ClearErrors</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-  WriteRegStr HKLM &quot;Software\Mozilla\InstallerTest&quot; &quot;InstallerTest&quot; &quot;Test&quot;</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+  WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l6.364"></a><span id="l6.364">   ${If} ${Errors}</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-    SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l6.366"></a><span id="l6.366">     StrCpy $TmpVal &quot;HKCU&quot; ; used primarily for logging</span>
<a href="#l6.367"></a><span id="l6.367">   ${Else}</span>
<a href="#l6.368"></a><span id="l6.368">     SetShellVarContext all  ; Set SHCTX to HKLM</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-    DeleteRegKey HKLM &quot;Software\Mozilla\InstallerTest&quot;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+    DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l6.371"></a><span id="l6.371">     StrCpy $TmpVal &quot;HKLM&quot; ; used primarily for logging</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+    ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+    ${RegCleanUninstall}</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+    ${UpdateProtocolHandlers}</span>
<a href="#l6.375"></a><span id="l6.375">   ${EndIf}</span>
<a href="#l6.376"></a><span id="l6.376"> </span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+  ${RemoveDeprecatedKeys}</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+</span>
<a href="#l6.379"></a><span id="l6.379">   ; The previous installer adds several regsitry values to both HKLM and HKCU.</span>
<a href="#l6.380"></a><span id="l6.380">   ; We now try to add to HKLM and if that fails to HKCU</span>
<a href="#l6.381"></a><span id="l6.381"> </span>
<a href="#l6.382"></a><span id="l6.382">   ; The order that reg keys and values are added is important if you use the</span>
<a href="#l6.383"></a><span id="l6.383">   ; uninstall log to remove them on uninstall. When using the uninstall log you</span>
<a href="#l6.384"></a><span id="l6.384">   ; MUST add children first so they will be removed first on uninstall so they</span>
<a href="#l6.385"></a><span id="l6.385">   ; will be empty when the key is deleted. This allows the uninstaller to</span>
<a href="#l6.386"></a><span id="l6.386">   ; specify that only empty keys will be deleted.</span>
<a href="#l6.387"></a><span id="l6.387">   ${SetAppKeys}</span>
<a href="#l6.388"></a><span id="l6.388"> </span>
<a href="#l6.389"></a><span id="l6.389">   ; XXXrstrong - this should be set in shared.nsh along with &quot;Create Quick</span>
<a href="#l6.390"></a><span id="l6.390">   ; Launch Shortcut&quot; and Create Desktop Shortcut.</span>
<a href="#l6.391"></a><span id="l6.391">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})\Uninstall&quot;</span>
<a href="#l6.392"></a><span id="l6.392">   ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;Create Start Menu Shortcut&quot; $AddStartMenuSC 0</span>
<a href="#l6.393"></a><span id="l6.393"> </span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-  ${FixClassKeys}</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+  ; On install always add the ThunderbirdEML, Thunderbird.Url.mailto, and</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+  ; Thunderbird.Url.news keys.</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+  ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot;  &quot;$2&quot; &quot;$8,0&quot; \</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+                      &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+  ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot;  &quot;$3&quot; &quot;$8,0&quot; \</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+                      &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+  ${AddHandlerValues} &quot;$0\Thunderbird.Url.news&quot; &quot;$2&quot; &quot;$8,0&quot; \</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+                      &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l6.403"></a><span id="l6.403"> </span>
<a href="#l6.404"></a><span id="l6.404">   ; The following keys should only be set if we can write to HKLM</span>
<a href="#l6.405"></a><span id="l6.405">   ${If} $TmpVal == &quot;HKLM&quot;</span>
<a href="#l6.406"></a><span id="l6.406">     ; Uninstall keys can only exist under HKLM on some versions of windows.</span>
<a href="#l6.407"></a><span id="l6.407">     ${SetUninstallKeys}</span>
<a href="#l6.408"></a><span id="l6.408"> </span>
<a href="#l6.409"></a><span id="l6.409">     ; Set the Start Menu Internet and Vista Registered App HKLM registry keys.</span>
<a href="#l6.410"></a><span id="l6.410">     ${SetClientsMail}</span>
<a href="#l6.411"></a><span id="l6.411"> </span>
<a href="#l6.412"></a><span id="l6.412">     ; If we are writing to HKLM and create the quick launch and the desktop</span>
<a href="#l6.413"></a><span id="l6.413">     ; shortcuts set IconsVisible to 1 otherwise to 0.</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+    StrCpy $0 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l6.415"></a><span id="l6.415">     ${If} $AddQuickLaunchSC == 1</span>
<a href="#l6.416"></a><span id="l6.416">     ${OrIf} $AddDesktopSC == 1</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-      StrCpy $0 &quot;Software\Clients\Mail\${BrandFullNameInternal}\InstallInfo&quot;</span>
<a href="#l6.418"></a><span id="l6.418">       WriteRegDWORD HKLM &quot;$0&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l6.419"></a><span id="l6.419">     ${Else}</span>
<a href="#l6.420"></a><span id="l6.420">       WriteRegDWORD HKLM &quot;$0&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l6.421"></a><span id="l6.421">     ${EndIf}</span>
<a href="#l6.422"></a><span id="l6.422">   ${EndIf}</span>
<a href="#l6.423"></a><span id="l6.423"> </span>
<a href="#l6.424"></a><span id="l6.424">   ; These need special handling on uninstall since they may be overwritten by</span>
<a href="#l6.425"></a><span id="l6.425">   ; an install into a different location.</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineat">@@ -463,225 +425,132 @@ Section /o &quot;Developer Tools&quot; DOMI_IDX</span>
<a href="#l6.427"></a><span id="l6.427">   ${If} ${FileExists} &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.428"></a><span id="l6.428">     SetDetailsPrint both</span>
<a href="#l6.429"></a><span id="l6.429">     DetailPrint $(STATUS_INSTALL_OPTIONAL)</span>
<a href="#l6.430"></a><span id="l6.430">     SetDetailsPrint none</span>
<a href="#l6.431"></a><span id="l6.431"> </span>
<a href="#l6.432"></a><span id="l6.432">     ${RemoveDir} &quot;$INSTDIR\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.433"></a><span id="l6.433">     ClearErrors</span>
<a href="#l6.434"></a><span id="l6.434">     ${LogHeader} &quot;Installing Developer Tools&quot;</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-    StrCpy $R0 &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-    StrCpy $R1 &quot;$INSTDIR\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-    Call DoCopyFiles</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+    ${CopyFilesFromDir} &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot; \</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+                        &quot;$INSTDIR\extensions\inspector@mozilla.org&quot; \</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+                        &quot;$(ERROR_CREATE_DIRECTORY_PREFIX)&quot; \</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+                        &quot;$(ERROR_CREATE_DIRECTORY_SUFFIX)&quot;</span>
<a href="#l6.442"></a><span id="l6.442">   ${EndIf}</span>
<a href="#l6.443"></a><span id="l6.443"> SectionEnd</span>
<a href="#l6.444"></a><span id="l6.444"> </span>
<a href="#l6.445"></a><span id="l6.445"> ; Cleanup operations to perform at the end of the installation.</span>
<a href="#l6.446"></a><span id="l6.446"> Section &quot;-InstallEndCleanup&quot;</span>
<a href="#l6.447"></a><span id="l6.447">   SetDetailsPrint both</span>
<a href="#l6.448"></a><span id="l6.448">   DetailPrint &quot;$(STATUS_CLEANUP)&quot;</span>
<a href="#l6.449"></a><span id="l6.449">   SetDetailsPrint none</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+</span>
<a href="#l6.451"></a><span id="l6.451">   ${LogHeader} &quot;Updating Uninstall Log With Previous Uninstall Log&quot;</span>
<a href="#l6.452"></a><span id="l6.452"> </span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+  ; Refresh desktop icons</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+  System::Call &quot;shell32::SHChangeNotify(i, i, i, i) v (0x08000000, 0, 0, 0)&quot;</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+</span>
<a href="#l6.456"></a><span id="l6.456">   ${InstallEndCleanupCommon}</span>
<a href="#l6.457"></a><span id="l6.457"> </span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-  ; Refresh desktop icons</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-  System::Call &quot;shell32::SHChangeNotify(i, i, i, i) v (0x08000000, 0, 0, 0)&quot;</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+  ; If we have to reboot give SHChangeNotify time to finish the refreshing</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+  ; the icons so the OS doesn't display the icons from helper.exe</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+  ${If} ${RebootFlag}</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+    Sleep 10000</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+    ${LogHeader} &quot;Reboot Required To Finish Installation&quot;</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+    ; ${FileMainEXE}.moz-upgrade should never exist but just in case...</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+    ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+      Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+    ${EndUnless}</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+    ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+      ClearErrors</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+      Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+      ${Unless} ${Errors}</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+        Delete /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+      ${EndUnless}</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+    ${EndUnless}</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+    ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+      CopyFiles /SILENT &quot;$INSTDIR\uninstall\helper.exe&quot; &quot;$INSTDIR&quot;</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+      FileOpen $0 &quot;$INSTDIR\${FileMainEXE}&quot; w</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+      FileWrite $0 &quot;Will be deleted on restart&quot;</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+      Rename /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+      FileClose $0</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+      Delete &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+      Rename &quot;$INSTDIR\helper.exe&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+    ${EndUnless}</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.488"></a><span id="l6.488"> SectionEnd</span>
<a href="#l6.489"></a><span id="l6.489"> </span>
<a href="#l6.490"></a><span id="l6.490"> ################################################################################</span>
<a href="#l6.491"></a><span id="l6.491"> # Helper Functions</span>
<a href="#l6.492"></a><span id="l6.492"> </span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-; Copies a file to a temporary backup directory and then checks if it is in use</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-; by attempting to delete the file. If the file is in use an error is displayed</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-; and the user is given the options to either retry or cancel. If cancel is</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-; selected then the files are restored.</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-Function CheckInUse</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\$R1&quot;</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-    retry:</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-    ClearErrors</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-    CopyFiles /SILENT &quot;$INSTDIR\$R1&quot; &quot;$TmpVal\$R1&quot;</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-    ${Unless} ${Errors}</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-      Delete &quot;$INSTDIR\$R1&quot;</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-    ${EndUnless}</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-    ${If} ${Errors}</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineminus">-      StrCpy $0 &quot;$INSTDIR\$R1&quot;</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-      ${WordReplace} &quot;$(^FileError_NoIgnore)&quot; &quot;\r\n&quot; &quot;$\r$\n&quot; &quot;+*&quot; $0</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-      MessageBox MB_RETRYCANCEL|MB_ICONQUESTION &quot;$0&quot; IDRETRY retry</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-      Delete &quot;$TmpVal\$R1&quot;</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-      CopyFiles /SILENT &quot;$TmpVal\*&quot; &quot;$INSTDIR\&quot;</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-      SetOutPath $INSTDIR</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-      RmDir /r &quot;$TmpVal&quot;</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-      Quit</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+Function CheckExistingInstall</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+  ; If there is a pending file copy from a previous uninstall don't allow</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+  ; installing until after the system has rebooted.</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+  IfFileExists &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; +1 +4</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+  MessageBox MB_YESNO &quot;$(WARN_RESTART_REQUIRED_UPGRADE)&quot; IDNO +2</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineplus">+  Reboot</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+  Quit</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineplus">+</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineplus">+  ; If there is a pending file deletion from a previous uninstall don't allow</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineplus">+  ; installing until after the system has rebooted.</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineplus">+  IfFileExists &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot; +1 +4</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineplus">+  MessageBox MB_YESNO &quot;$(WARN_RESTART_REQUIRED_UNINSTALL)&quot; IDNO +2</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineplus">+  Reboot</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+  Quit</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+    Banner::show /NOUNLOAD &quot;$(BANNER_CHECK_EXISTING)&quot;</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+    ${If} &quot;$TmpVal&quot; == &quot;FoundMessageWindow&quot;</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+      Sleep 5000</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+    ${EndIf}</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+    ${PushFilesToCheck}</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+    ; Store the return value in $TmpVal so it is less likely to be accidentally</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+    ; overwritten elsewhere.</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+    ${CheckForFilesInUse} $TmpVal</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+    Banner::destroy</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineplus">+</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+    ${If} &quot;$TmpVal&quot; == &quot;true&quot;</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineplus">+      StrCpy $TmpVal &quot;FoundMessageWindow&quot;</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+      ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_INSTALL)&quot;</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+      StrCpy $TmpVal &quot;true&quot;</span>
<a href="#l6.548"></a><span id="l6.548">     ${EndIf}</span>
<a href="#l6.549"></a><span id="l6.549">   ${EndIf}</span>
<a href="#l6.550"></a><span id="l6.550"> FunctionEnd</span>
<a href="#l6.551"></a><span id="l6.551"> </span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-Function GetDiff</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-  ${TrimNewLines} &quot;$9&quot; &quot;$9&quot;</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-  ${If} $9 != &quot;&quot;</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-    FileWrite $R3 &quot;$9$\r$\n&quot;</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-    ${LogMsg} &quot;Added To Uninstall Log: $9&quot;</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-  ${EndIf}</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-  Push 0</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-FunctionEnd</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-Function DoCopyFiles</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-  StrLen $R2 $R0</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-  ${LocateNoDetails} &quot;$R0&quot; &quot;/L=FD&quot; &quot;CopyFile&quot;</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-FunctionEnd</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-Function CopyFile</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-  StrCpy $R3 $R8 &quot;&quot; $R2</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-  retry:</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+Function LaunchApp</span>
<a href="#l6.570"></a><span id="l6.570">   ClearErrors</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-  ${If} $R6 ==  &quot;&quot;</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-    ${Unless} ${FileExists} &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-      ClearErrors</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-      CreateDirectory &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-      ${If} ${Errors}</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-        ${LogMsg}  &quot;** ERROR Creating Directory: $R1$R3\$R7 **&quot;</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-        StrCpy $0 &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-        StrCpy $0 &quot;$(ERROR_CREATE_DIRECTORY)&quot;</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-        MessageBox MB_RETRYCANCEL|MB_ICONQUESTION &quot;$0&quot; IDRETRY retry</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-        Quit</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-      ${Else}</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-        ${LogMsg}  &quot;Created Directory: $R1$R3\$R7&quot;</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-      ${EndIf}</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-    ${EndUnless}</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineplus">+  ${GetParameters} $0</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineplus">+  ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $1</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+    ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_LAUNCH)&quot;</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineplus">+    Exec &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.590"></a><span id="l6.590">   ${Else}</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-    ${Unless} ${FileExists} &quot;$R1$R3&quot;</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-      ClearErrors</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-      CreateDirectory &quot;$R1$R3&quot;</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-      ${If} ${Errors}</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-        ${LogMsg}  &quot;** ERROR Creating Directory: $R1$R3 **&quot;</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-        StrCpy $0 &quot;$R1$R3&quot;</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-        StrCpy $0 &quot;$(ERROR_CREATE_DIRECTORY)&quot;</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-        MessageBox MB_RETRYCANCEL|MB_ICONQUESTION &quot;$0&quot; IDRETRY retry</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-        Quit</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-      ${Else}</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-        ${LogMsg}  &quot;Created Directory: $R1$R3&quot;</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-      ${EndIf}</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-    ${EndUnless}</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-    ${If} ${FileExists} &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-      ClearErrors</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-      Delete &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-      ${If} ${Errors}</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-        ${LogMsg} &quot;** ERROR Deleting File: $R1$R3\$R7 **&quot;</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-        StrCpy $0 &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-        ${WordReplace} &quot;$(^FileError_NoIgnore)&quot; &quot;\r\n&quot; &quot;$\r$\n&quot; &quot;+*&quot; $0</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-        MessageBox MB_RETRYCANCEL|MB_ICONQUESTION &quot;$0&quot; IDRETRY retry</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-        Quit</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-      ${EndIf}</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-    ${EndIf}</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-    ClearErrors</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-    CopyFiles /SILENT $R9 &quot;$R1$R3&quot;</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-    ${If} ${Errors}</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-      ${LogMsg} &quot;** ERROR Installing File: $R1$R3\$R7 **&quot;</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-      StrCpy $0 &quot;$R1$R3\$R7&quot;</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-      ${WordReplace} &quot;$(^FileError_NoIgnore)&quot; &quot;\r\n&quot; &quot;$\r$\n&quot; &quot;+*&quot; $0</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-      MessageBox MB_RETRYCANCEL|MB_ICONQUESTION &quot;$0&quot; IDRETRY retry</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-      Quit</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-    ${Else}</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-      ${LogMsg} &quot;Installed File: $R1$R3\$R7&quot;</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-    ${EndIf}</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-    ; If the file is installed into the installation directory remove the</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-    ; installation directory's path from the file path when writing to the</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-    ; uninstall.log so it will be a relative path. This allows the same</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-    ; helper.exe to be used with zip builds if we supply an uninstall.log.</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-    ${WordReplace} &quot;$R1$R3\$R7&quot; &quot;$INSTDIR&quot; &quot;&quot; &quot;+&quot; $R3</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-    ${LogUninstall} &quot;File: $R3&quot;</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineplus">+    GetFunctionAddress $0 LaunchAppFromElevatedProcess</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineplus">+    UAC::ExecCodeSegment $0</span>
<a href="#l6.636"></a><span id="l6.636">   ${EndIf}</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-  Push 0</span>
<a href="#l6.638"></a><span id="l6.638"> FunctionEnd</span>
<a href="#l6.639"></a><span id="l6.639"> </span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-; Clean up the old log files. We only diff the first two found since it is</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-; possible for there to be several MB and comparing that many would take a very</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-; long time to diff.</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-Function CleanupOldLogs</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-  FindFirst $0 $TmpVal &quot;$INSTDIR\uninstall\*wizard*&quot;</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-  StrCmp $TmpVal &quot;&quot; done</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-  StrCpy $TmpVal &quot;$INSTDIR\uninstall\$TmpVal&quot;</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">-</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">-  FindNext $0 $1</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">-  StrCmp $1 &quot;&quot; cleanup</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-  StrCpy $1 &quot;$INSTDIR\uninstall\$1&quot;</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-  Push $1</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-  Call DiffOldLogFiles</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-  FindClose $0</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-  ${DeleteFile} &quot;$1&quot;</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-  cleanup:</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-    StrCpy $2 &quot;$INSTDIR\uninstall\cleanup.log&quot;</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-    ${DeleteFile} &quot;$2&quot;</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-    FileOpen $R2 $2 w</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-    Push $TmpVal</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-    ${LineFind} &quot;$INSTDIR\uninstall\$TmpVal&quot; &quot;/NUL&quot; &quot;1:-1&quot; &quot;CleanOldLogFilesCallback&quot;</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-    ${DeleteFile} &quot;$INSTDIR\uninstall\$TmpVal&quot;</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-  done:</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-    FindClose $0</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-    FileClose $R2</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-    FileClose $R3</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-FunctionEnd</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-Function DiffOldLogFiles</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-  StrCpy $R1 &quot;$1&quot;</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-  GetTempFileName $R2</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-  FileOpen $R3 $R2 w</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-  ${TextCompareNoDetails} &quot;$R1&quot; &quot;$TmpVal&quot; &quot;SlowDiff&quot; &quot;GetDiff&quot;</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-  FileClose $R3</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-  ${FileJoin} &quot;$TmpVal&quot; &quot;$R2&quot; &quot;$TmpVal&quot;</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-  ${DeleteFile} &quot;$R2&quot;</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-FunctionEnd</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineplus">+Function LaunchAppFromElevatedProcess</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineplus">+  ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_LAUNCH)&quot;</span>
<a href="#l6.680"></a><span id="l6.680"> </span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-Function CleanOldLogFilesCallback</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-  ${TrimNewLines} &quot;$R9&quot; $R9</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-  ${WordReplace} &quot;$R9&quot; &quot;$INSTDIR&quot; &quot;&quot; &quot;+&quot; $R3</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-  ${WordFind} &quot;$R9&quot; &quot;	&quot; &quot;E+1}&quot; $R0</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-  IfErrors updater 0</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-  ${WordFind} &quot;$R0&quot; &quot;Installing: &quot; &quot;E+1}&quot; $R1</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-    FileWrite $R2 &quot;File: $R1$\r$\n&quot;</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-    GoTo done</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-  ${EndUnless}</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-  ${WordFind} &quot;$R0&quot; &quot;Replacing: &quot; &quot;E+1}&quot; $R1</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-    FileWrite $R2 &quot;File: $R1$\r$\n&quot;</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-    GoTo done</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-  ${EndUnless}</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-  ${WordFind} &quot;$R0&quot; &quot;Windows Shortcut: &quot; &quot;E+1}&quot; $R1</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-    FileWrite $R2 &quot;File: $R1.lnk$\r$\n&quot;</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-    GoTo done</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-  ${EndUnless}</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-  ${WordFind} &quot;$R0&quot; &quot;Create Folder: &quot; &quot;E+1}&quot; $R1</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-    FileWrite $R2 &quot;Dir: $R1$\r$\n&quot;</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineminus">-    GoTo done</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineminus">-  ${EndUnless}</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineminus">-</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-  updater:</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-    ${WordFind} &quot;$R9&quot; &quot;installing: &quot; &quot;E+1}&quot; $R0</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-    ${Unless} ${Errors}</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-      FileWrite $R2 &quot;File: $R0$\r$\n&quot;</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-    ${EndUnless}</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-  done:</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-    Push 0</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-FunctionEnd</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-Function LaunchApp</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-  ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_LAUNCH)&quot;</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-  Exec &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineplus">+  ; Find the installation directory when launching using GetFunctionAddress</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineplus">+  ; from an elevated installer since $INSTDIR will not be set in this installer</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+  ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+  ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+  ${GetParent} &quot;$0&quot; $1</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+  ; Set our current working directory to the application's install directory</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+  ; otherwise the 7-Zip temp directory will be in use and won't be deleted.</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+  SetOutPath &quot;$1&quot;</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+  Exec &quot;$0&quot;</span>
<a href="#l6.733"></a><span id="l6.733"> FunctionEnd</span>
<a href="#l6.734"></a><span id="l6.734"> </span>
<a href="#l6.735"></a><span id="l6.735"> ################################################################################</span>
<a href="#l6.736"></a><span id="l6.736"> # Language</span>
<a href="#l6.737"></a><span id="l6.737"> </span>
<a href="#l6.738"></a><span id="l6.738"> !insertmacro MOZ_MUI_LANGUAGE 'baseLocale'</span>
<a href="#l6.739"></a><span id="l6.739"> !verbose push</span>
<a href="#l6.740"></a><span id="l6.740"> !verbose 3</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineat">@@ -689,17 +558,33 @@ FunctionEnd</span>
<a href="#l6.742"></a><span id="l6.742"> !include &quot;customLocale.nsh&quot;</span>
<a href="#l6.743"></a><span id="l6.743"> !verbose pop</span>
<a href="#l6.744"></a><span id="l6.744"> </span>
<a href="#l6.745"></a><span id="l6.745"> ; Set this after the locale files to override it if it is in the locale</span>
<a href="#l6.746"></a><span id="l6.746"> ; using &quot; &quot; for BrandingText will hide the &quot;Nullsoft Install System...&quot; branding</span>
<a href="#l6.747"></a><span id="l6.747"> BrandingText &quot; &quot;</span>
<a href="#l6.748"></a><span id="l6.748"> </span>
<a href="#l6.749"></a><span id="l6.749"> ################################################################################</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-# Page pre and leave functions</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineplus">+# Page pre, show, and leave functions</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineplus">+</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineplus">+Function preWelcome</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineplus">+  ${If} ${FileExists} &quot;$EXEDIR\localized\distribution\modern-wizard.bmp&quot;</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineplus">+    Delete &quot;$PLUGINSDIR\modern-wizard.bmp&quot;</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineplus">+    CopyFiles /SILENT &quot;$EXEDIR\localized\distribution\modern-wizard.bmp&quot; &quot;$PLUGINSDIR\modern-wizard.bmp&quot;</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineplus">+FunctionEnd</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineplus">+</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineplus">+Function showLicense</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineplus">+  ${If} ${FileExists} &quot;$EXEDIR\localized\distribution\modern-header.bmp&quot;</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineplus">+  ${AndIf} $hHeaderBitmap == &quot;&quot;</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineplus">+    Delete &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineplus">+    CopyFiles /SILENT &quot;$EXEDIR\localized\distribution\modern-header.bmp&quot; &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineplus">+    ${ChangeMUIHeaderImage} &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineplus">+FunctionEnd</span>
<a href="#l6.768"></a><span id="l6.768"> </span>
<a href="#l6.769"></a><span id="l6.769"> Function preOptions</span>
<a href="#l6.770"></a><span id="l6.770">   !insertmacro MUI_HEADER_TEXT &quot;$(OPTIONS_PAGE_TITLE)&quot; &quot;$(OPTIONS_PAGE_SUBTITLE)&quot;</span>
<a href="#l6.771"></a><span id="l6.771">   !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;options.ini&quot;</span>
<a href="#l6.772"></a><span id="l6.772"> FunctionEnd</span>
<a href="#l6.773"></a><span id="l6.773"> </span>
<a href="#l6.774"></a><span id="l6.774"> Function leaveOptions</span>
<a href="#l6.775"></a><span id="l6.775">   ${MUI_INSTALLOPTIONS_READ} $0 &quot;options.ini&quot; &quot;Settings&quot; &quot;State&quot;</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineat">@@ -707,16 +592,34 @@ Function leaveOptions</span>
<a href="#l6.777"></a><span id="l6.777">     Abort</span>
<a href="#l6.778"></a><span id="l6.778">   ${EndIf}</span>
<a href="#l6.779"></a><span id="l6.779">   ${MUI_INSTALLOPTIONS_READ} $R0 &quot;options.ini&quot; &quot;Field 2&quot; &quot;State&quot;</span>
<a href="#l6.780"></a><span id="l6.780">   StrCmp $R0 &quot;1&quot; +1 +2</span>
<a href="#l6.781"></a><span id="l6.781">   StrCpy $InstallType ${INSTALLTYPE_BASIC}</span>
<a href="#l6.782"></a><span id="l6.782">   ${MUI_INSTALLOPTIONS_READ} $R0 &quot;options.ini&quot; &quot;Field 3&quot; &quot;State&quot;</span>
<a href="#l6.783"></a><span id="l6.783">   StrCmp $R0 &quot;1&quot; +1 +2</span>
<a href="#l6.784"></a><span id="l6.784">   StrCpy $InstallType ${INSTALLTYPE_CUSTOM}</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineplus">+</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineplus">+  ${If} $InstallType != ${INSTALLTYPE_CUSTOM}</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineplus">+!ifndef NO_INSTDIR_FROM_REG</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineplus">+    SetShellVarContext all      ; Set SHCTX to HKLM</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineplus">+    ${GetSingleInstallPath} &quot;Software\Mozilla\${BrandFullNameInternal}&quot; $R9</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineplus">+</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineplus">+    StrCmp &quot;$R9&quot; &quot;false&quot; +1 fix_install_dir</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineplus">+</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineplus">+    SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineplus">+    ${GetSingleInstallPath} &quot;Software\Mozilla\${BrandFullNameInternal}&quot; $R9</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineplus">+</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineplus">+    fix_install_dir:</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineplus">+    StrCmp &quot;$R9&quot; &quot;false&quot; +2 +1</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineplus">+    StrCpy $INSTDIR &quot;$R9&quot;</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineplus">+!endif</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineplus">+</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineplus">+    Call CheckExistingInstall</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.803"></a><span id="l6.803"> FunctionEnd</span>
<a href="#l6.804"></a><span id="l6.804"> </span>
<a href="#l6.805"></a><span id="l6.805"> Function preComponents</span>
<a href="#l6.806"></a><span id="l6.806">   ${CheckCustomCommon}</span>
<a href="#l6.807"></a><span id="l6.807">   ; If DOMi isn't available skip the components page</span>
<a href="#l6.808"></a><span id="l6.808">   ${Unless} ${FileExists} &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.809"></a><span id="l6.809">     Abort</span>
<a href="#l6.810"></a><span id="l6.810">   ${EndUnless}</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineat">@@ -757,74 +660,127 @@ FunctionEnd</span>
<a href="#l6.812"></a><span id="l6.812"> </span>
<a href="#l6.813"></a><span id="l6.813"> Function preStartMenu</span>
<a href="#l6.814"></a><span id="l6.814">   ${CheckCustomCommon}</span>
<a href="#l6.815"></a><span id="l6.815">   ${If} $AddStartMenuSC != 1</span>
<a href="#l6.816"></a><span id="l6.816">     Abort</span>
<a href="#l6.817"></a><span id="l6.817">   ${EndIf}</span>
<a href="#l6.818"></a><span id="l6.818"> FunctionEnd</span>
<a href="#l6.819"></a><span id="l6.819"> </span>
<a href="#l6.820"></a><span id="l6.820" class="difflineplus">+Function leaveStartMenu</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineplus">+  ${If} $InstallType == ${INSTALLTYPE_CUSTOM}</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineplus">+    Call CheckExistingInstall</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineplus">+FunctionEnd</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineplus">+</span>
<a href="#l6.826"></a><span id="l6.826"> Function preSummary</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-  !insertmacro createSummaryINI</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Settings&quot; NumFields &quot;3&quot;</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineplus">+</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 1&quot; Type   &quot;label&quot;</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 1&quot; Text   &quot;$(SUMMARY_INSTALLED_TO)&quot;</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 1&quot; Left   &quot;0&quot;</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 1&quot; Right  &quot;-1&quot;</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 1&quot; Top    &quot;5&quot;</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 1&quot; Bottom &quot;15&quot;</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineplus">+</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Type   &quot;text&quot;</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; state  &quot;&quot;</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Left   &quot;0&quot;</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Right  &quot;-1&quot;</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Top    &quot;17&quot;</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Bottom &quot;30&quot;</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; flags  &quot;READONLY&quot;</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineplus">+</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Type   &quot;label&quot;</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Text   &quot;$(SUMMARY_CLICK)&quot;</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Left   &quot;0&quot;</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Right  &quot;-1&quot;</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Top    &quot;130&quot;</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Bottom &quot;150&quot;</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineplus">+</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineplus">+  ${If} &quot;$TmpVal&quot; == &quot;true&quot;</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Type   &quot;label&quot;</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Text   &quot;$(SUMMARY_REBOOT_REQUIRED_INSTALL)&quot;</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Left   &quot;0&quot;</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Right  &quot;-1&quot;</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Top    &quot;35&quot;</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Bottom &quot;45&quot;</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Settings&quot; NumFields &quot;4&quot;</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineplus">+</span>
<a href="#l6.863"></a><span id="l6.863">   !insertmacro MUI_HEADER_TEXT &quot;$(SUMMARY_PAGE_TITLE)&quot; &quot;$(SUMMARY_PAGE_SUBTITLE)&quot;</span>
<a href="#l6.864"></a><span id="l6.864"> </span>
<a href="#l6.865"></a><span id="l6.865">   ; The Summary custom page has a textbox that will automatically receive</span>
<a href="#l6.866"></a><span id="l6.866">   ; focus. This sets the focus to the Install button instead.</span>
<a href="#l6.867"></a><span id="l6.867">   !insertmacro MUI_INSTALLOPTIONS_INITDIALOG &quot;summary.ini&quot;</span>
<a href="#l6.868"></a><span id="l6.868">   GetDlgItem $0 $HWNDPARENT 1</span>
<a href="#l6.869"></a><span id="l6.869">   System::Call &quot;user32::SetFocus(i r0, i 0x0007, i,i)i&quot;</span>
<a href="#l6.870"></a><span id="l6.870">   ${MUI_INSTALLOPTIONS_READ} $1 &quot;summary.ini&quot; &quot;Field 2&quot; &quot;HWND&quot;</span>
<a href="#l6.871"></a><span id="l6.871">   SendMessage $1 ${WM_SETTEXT} 0 &quot;STR:$INSTDIR&quot;</span>
<a href="#l6.872"></a><span id="l6.872">   !insertmacro MUI_INSTALLOPTIONS_SHOW</span>
<a href="#l6.873"></a><span id="l6.873"> FunctionEnd</span>
<a href="#l6.874"></a><span id="l6.874"> </span>
<a href="#l6.875"></a><span id="l6.875"> Function leaveSummary</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-  ; If there is a pending deletion from a previous uninstall don't allow</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-  ; installing until after the system has rebooted.</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-  IfFileExists &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot; +1 +4</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-  MessageBox MB_YESNO &quot;$(WARN_RESTART_REQUIRED_UNINSTALL)&quot; IDNO +2</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-  Reboot</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineminus">-  Quit</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-</span>
<a href="#l6.883"></a><span id="l6.883">   ${If} $InstallType != ${INSTALLTYPE_CUSTOM}</span>
<a href="#l6.884"></a><span id="l6.884">     ; Set DOMi to be installed</span>
<a href="#l6.885"></a><span id="l6.885">     SectionSetFlags ${DOMI_IDX} 1</span>
<a href="#l6.886"></a><span id="l6.886">   ${EndIf}</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineplus">+</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineplus">+  ; Try to delete the app executable and if we can't delete it try to find the</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineplus">+  ; app's message window and prompt the user to close the app. This allows</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineplus">+  ; running an instance that is located in another directory. If for whatever</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineplus">+  ; reason there is no message window we will just rename the app's files and</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineplus">+  ; then remove them on restart.</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineplus">+  ClearErrors</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineplus">+  ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineplus">+    ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_INSTALL)&quot;</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineplus">+  ${EndIf}</span>
<a href="#l6.898"></a><span id="l6.898"> FunctionEnd</span>
<a href="#l6.899"></a><span id="l6.899"> </span>
<a href="#l6.900"></a><span id="l6.900"> ; When we add an optional action to the finish page the cancel button is</span>
<a href="#l6.901"></a><span id="l6.901"> ; enabled. This disables it and leaves the finish button as the only choice.</span>
<a href="#l6.902"></a><span id="l6.902"> Function preFinish</span>
<a href="#l6.903"></a><span id="l6.903">   ${EndInstallLog} &quot;${BrandFullName}&quot;</span>
<a href="#l6.904"></a><span id="l6.904">   !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;settings&quot; &quot;cancelenabled&quot; &quot;0&quot;</span>
<a href="#l6.905"></a><span id="l6.905"> FunctionEnd</span>
<a href="#l6.906"></a><span id="l6.906"> </span>
<a href="#l6.907"></a><span id="l6.907"> ################################################################################</span>
<a href="#l6.908"></a><span id="l6.908"> # Initialization Functions</span>
<a href="#l6.909"></a><span id="l6.909"> </span>
<a href="#l6.910"></a><span id="l6.910"> Function .onInit</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineplus">+  StrCpy $LANGUAGE 0</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineplus">+  ${SetBrandNameVars} &quot;$EXEDIR\localized\distribution\setup.ini&quot;</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineplus">+</span>
<a href="#l6.914"></a><span id="l6.914">   ${InstallOnInitCommon} &quot;$(WARN_UNSUPPORTED_MSG)&quot;</span>
<a href="#l6.915"></a><span id="l6.915"> </span>
<a href="#l6.916"></a><span id="l6.916">   !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;options.ini&quot;</span>
<a href="#l6.917"></a><span id="l6.917">   !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;components.ini&quot;</span>
<a href="#l6.918"></a><span id="l6.918">   !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;shortcuts.ini&quot;</span>
<a href="#l6.919"></a><span id="l6.919">   !insertmacro MUI_INSTALLOPTIONS_EXTRACT &quot;summary.ini&quot;</span>
<a href="#l6.920"></a><span id="l6.920">   !insertmacro createBasicCustomOptionsINI</span>
<a href="#l6.921"></a><span id="l6.921">   !insertmacro createComponentsINI</span>
<a href="#l6.922"></a><span id="l6.922">   !insertmacro createShortcutsINI</span>
<a href="#l6.923"></a><span id="l6.923"> </span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-  StrCpy $LANGUAGE 0</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-</span>
<a href="#l6.926"></a><span id="l6.926">   ; There must always be nonlocalized and localized directories.</span>
<a href="#l6.927"></a><span id="l6.927">   ${GetSize} &quot;$EXEDIR\nonlocalized\&quot; &quot;/S=0K&quot; $R5 $R7 $R8</span>
<a href="#l6.928"></a><span id="l6.928">   ${GetSize} &quot;$EXEDIR\localized\&quot; &quot;/S=0K&quot; $R6 $R7 $R8</span>
<a href="#l6.929"></a><span id="l6.929">   IntOp $R8 $R5 + $R6</span>
<a href="#l6.930"></a><span id="l6.930">   SectionSetSize ${APP_IDX} $R8</span>
<a href="#l6.931"></a><span id="l6.931"> </span>
<a href="#l6.932"></a><span id="l6.932">   ${If} ${FileExists} &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot;</span>
<a href="#l6.933"></a><span id="l6.933">     ; Set the section size for DOMi.</span>
<a href="#l6.934"></a><span id="l6.934">     ${GetSize} &quot;$EXEDIR\optional\extensions\inspector@mozilla.org&quot; &quot;/S=0K&quot; $0 $8 $9</span>
<a href="#l6.935"></a><span id="l6.935">     SectionSetSize ${DOMI_IDX} $0</span>
<a href="#l6.936"></a><span id="l6.936">   ${Else}</span>
<a href="#l6.937"></a><span id="l6.937">     ; Hide DOMi in the components page if it isn't available.</span>
<a href="#l6.938"></a><span id="l6.938">     SectionSetText ${DOMI_IDX} &quot;&quot;</span>
<a href="#l6.939"></a><span id="l6.939">   ${EndIf}</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineplus">+</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineplus">+  ; Initialize $hHeaderBitmap to prevent redundant changing of the bitmap if</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineplus">+  ; the user clicks the back button</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineplus">+  StrCpy $hHeaderBitmap &quot;&quot;</span>
<a href="#l6.944"></a><span id="l6.944"> FunctionEnd</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineplus">+</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineplus">+Function .onGUIEnd</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineplus">+  ${OnEndCommon}</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineplus">+FunctionEnd</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/installer/windows/nsis/shared.nsh</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/installer/windows/nsis/shared.nsh</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -31,102 +31,216 @@</span>
<a href="#l7.4"></a><span id="l7.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.5"></a><span id="l7.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.6"></a><span id="l7.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.7"></a><span id="l7.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.8"></a><span id="l7.8"> #</span>
<a href="#l7.9"></a><span id="l7.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> !macro PostUpdate</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  SetShellVarContext all</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  ${SetClientsMail}</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15">   ; Remove registry entries for non-existent apps and for apps that point to our</span>
<a href="#l7.16"></a><span id="l7.16">   ; install location in the Software\Mozilla key and uninstall registry entries</span>
<a href="#l7.17"></a><span id="l7.17">   ; that point to our install location for both HKCU and HKLM.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l7.20"></a><span id="l7.20">   ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l7.21"></a><span id="l7.21">   ${RegCleanUninstall}</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  ${UpdateProtocolHandlers}</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  SetShellVarContext all  ; Set SHCTX to HKLM</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  ${RegCleanUninstall}</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  ClearErrors</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    StrCpy $TmpVal &quot;HKCU&quot; ; used primarily for logging</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+  ${Else}</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    SetShellVarContext all    ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    StrCpy $TmpVal &quot;HKLM&quot; ; used primarily for logging</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    ${RegCleanUninstall}</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    ${UpdateProtocolHandlers}</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    ; Only update the Clients\Mail registry key values if they don't exist or</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    ; this installation is the same as the one set in those keys.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+      ${SetClientsMail}</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    ; Only update the Clients\News registry key values if they don't exist or</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    ; this installation is the same as the one set in those keys.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+      ${SetClientsNews}</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    ${SetUninstallKeys}</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  ${RemoveDeprecatedKeys}</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">   ; Add Software\Mozilla\ registry entries</span>
<a href="#l7.69"></a><span id="l7.69">   ${SetAppKeys}</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  ${SetUninstallKeys}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  ${FixClassKeys}</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-</span>
<a href="#l7.75"></a><span id="l7.75">   ; Remove files that may be left behind by the application in the</span>
<a href="#l7.76"></a><span id="l7.76">   ; VirtualStore directory.</span>
<a href="#l7.77"></a><span id="l7.77">   ${CleanVirtualStore}</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79">   ; Remove talkback if it is present (remove after bug 386760 is fixed)</span>
<a href="#l7.80"></a><span id="l7.80">   ${If} ${FileExists} &quot;$INSTDIR\extensions\talkback@mozilla.org\&quot;</span>
<a href="#l7.81"></a><span id="l7.81">     RmDir /r &quot;$INSTDIR\extensions\talkback@mozilla.org\&quot;</span>
<a href="#l7.82"></a><span id="l7.82">   ${EndIf}</span>
<a href="#l7.83"></a><span id="l7.83"> !macroend</span>
<a href="#l7.84"></a><span id="l7.84"> !define PostUpdate &quot;!insertmacro PostUpdate&quot;</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86"> !macro SetAsDefaultAppUser</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  SetShellVarContext current</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  ${SetHandlers}</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  ; It is only possible to set this installation of the application as the</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  ; Start Menu Mail handler if it was added to the HKLM Clients\Mail registry</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  ; keys.</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  ; http://support.microsoft.com/kb/297878</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  ${GetParameters} $R0</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  ClearErrors</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  ${GetOptions} &quot;$R0&quot; &quot;Mail&quot; $R1</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    ${If} &quot;$0&quot; != &quot;$INSTDIR&quot;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+      ClearErrors</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+      WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+      ${If} ${Errors}</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        ; Prevent multiple elevation requests</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+        ClearErrors</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+        ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+        ${Unless} ${Errors}</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+          Quit</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+        ${EndUnless}</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+        ${ElevateUAC}</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      ${EndIf}</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+      ${SetClientsMail}</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+    ClearErrors</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+    ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    ${If} ${Errors}</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+      Call SetAsDefaultMailAppUser</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    ${Else}</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+      GetFunctionAddress $0 SetAsDefaultMailAppUser</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+      UAC::ExecCodeSegment $0</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  ${EndUnless}</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  ClearErrors</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  ${GetOptions} &quot;$R0&quot; &quot;News&quot; $R1</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    ${GetParent} &quot;$0&quot; $0</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    ${If} &quot;$0&quot; != &quot;$INSTDIR&quot;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+      ClearErrors</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+      WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+      ${If} ${Errors}</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+        ; Prevent multiple elevation requests</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+        ClearErrors</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+        ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+        ${Unless} ${Errors}</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+          DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+          Quit</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+        ${EndUnless}</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+        ${ElevateUAC}</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+      ${EndIf}</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+      DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+      SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      ${SetClientsNews}</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    ClearErrors</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    ${GetOptions} &quot;$R0&quot; &quot;/UAC:&quot; $R1</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    ${If} ${Errors}</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+      Call SetAsDefaultNewsAppUser</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+    ${Else}</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+      GetFunctionAddress $0 SetAsDefaultNewsAppUser</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+      UAC::ExecCodeSegment $0</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  ${EndUnless}</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+  ${RemoveDeprecatedKeys}</span>
<a href="#l7.170"></a><span id="l7.170"> !macroend</span>
<a href="#l7.171"></a><span id="l7.171"> !define SetAsDefaultAppUser &quot;!insertmacro SetAsDefaultAppUser&quot;</span>
<a href="#l7.172"></a><span id="l7.172"> </span>
<a href="#l7.173"></a><span id="l7.173"> !macro SetAsDefaultAppGlobal</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-  SetShellVarContext all</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  ${SetHandlers}</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  ${RemoveDeprecatedKeys}</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+  SetShellVarContext all      ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+  ${SetHandlersMail}</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  ${SetHandlersNews}</span>
<a href="#l7.181"></a><span id="l7.181">   ${SetClientsMail}</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-  WriteRegStr HKLM &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${BrandFullNameInternal}&quot;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  ${SetClientsNews}</span>
<a href="#l7.184"></a><span id="l7.184">   ${ShowShortcuts}</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  WriteRegStr HKLM &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l7.186"></a><span id="l7.186"> !macroend</span>
<a href="#l7.187"></a><span id="l7.187"> !define SetAsDefaultAppGlobal &quot;!insertmacro SetAsDefaultAppGlobal&quot;</span>
<a href="#l7.188"></a><span id="l7.188"> </span>
<a href="#l7.189"></a><span id="l7.189"> !macro HideShortcuts</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-  StrCpy $R1 &quot;Software\Clients\Mail\${BrandFullNameInternal}\InstallInfo&quot;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-  WriteRegDWORD HKLM $R1 &quot;IconsVisible&quot; 0</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+  StrCpy $R1 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  WriteRegDWORD HKLM &quot;$R1&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l7.194"></a><span id="l7.194">   SetShellVarContext all  ; Set $DESKTOP to All Users</span>
<a href="#l7.195"></a><span id="l7.195">   ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.196"></a><span id="l7.196">     SetShellVarContext current  ; Set $DESKTOP to the current user's desktop</span>
<a href="#l7.197"></a><span id="l7.197">   ${EndUnless}</span>
<a href="#l7.198"></a><span id="l7.198"> </span>
<a href="#l7.199"></a><span id="l7.199">   ${If} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.200"></a><span id="l7.200">     ShellLink::GetShortCutArgs &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.201"></a><span id="l7.201">     Pop $0</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-    ${If} $0 == &quot;&quot;</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+    ${If} &quot;$0&quot; == &quot;&quot;</span>
<a href="#l7.204"></a><span id="l7.204">       ShellLink::GetShortCutTarget &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.205"></a><span id="l7.205">       Pop $0</span>
<a href="#l7.206"></a><span id="l7.206">       ; Needs to handle short paths</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-      ${If} $0 == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.209"></a><span id="l7.209">         Delete &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.210"></a><span id="l7.210">       ${EndIf}</span>
<a href="#l7.211"></a><span id="l7.211">     ${EndIf}</span>
<a href="#l7.212"></a><span id="l7.212">   ${EndIf}</span>
<a href="#l7.213"></a><span id="l7.213"> </span>
<a href="#l7.214"></a><span id="l7.214">   ${If} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.215"></a><span id="l7.215">     ShellLink::GetShortCutArgs &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.216"></a><span id="l7.216">     Pop $0</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    ${If} $0 == &quot;&quot;</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+    ${If} &quot;$0&quot; == &quot;&quot;</span>
<a href="#l7.219"></a><span id="l7.219">       ShellLink::GetShortCutTarget &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.220"></a><span id="l7.220">       Pop $0</span>
<a href="#l7.221"></a><span id="l7.221">       ; Needs to handle short paths</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-      ${If} $0 == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.224"></a><span id="l7.224">         Delete &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.225"></a><span id="l7.225">       ${EndIf}</span>
<a href="#l7.226"></a><span id="l7.226">     ${EndIf}</span>
<a href="#l7.227"></a><span id="l7.227">   ${EndIf}</span>
<a href="#l7.228"></a><span id="l7.228"> !macroend</span>
<a href="#l7.229"></a><span id="l7.229"> !define HideShortcuts &quot;!insertmacro HideShortcuts&quot;</span>
<a href="#l7.230"></a><span id="l7.230"> </span>
<a href="#l7.231"></a><span id="l7.231"> !macro ShowShortcuts</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-  StrCpy $R1 &quot;Software\Clients\Mail\${BrandFullNameInternal}\InstallInfo&quot;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-  WriteRegDWORD HKLM $R1 &quot;IconsVisible&quot; 1</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+  StrCpy $R1 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  WriteRegDWORD HKLM &quot;$R1&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l7.236"></a><span id="l7.236">   SetShellVarContext all  ; Set $DESKTOP to All Users</span>
<a href="#l7.237"></a><span id="l7.237">   ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.238"></a><span id="l7.238">     CreateShortCut &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l7.239"></a><span id="l7.239">     ShellLink::SetShortCutWorkingDirectory &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR&quot;</span>
<a href="#l7.240"></a><span id="l7.240">     ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.241"></a><span id="l7.241">       SetShellVarContext current  ; Set $DESKTOP to the current user's desktop</span>
<a href="#l7.242"></a><span id="l7.242">       ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.243"></a><span id="l7.243">         CreateShortCut &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineat">@@ -136,51 +250,60 @@</span>
<a href="#l7.245"></a><span id="l7.245">   ${EndUnless}</span>
<a href="#l7.246"></a><span id="l7.246">   ${Unless} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.247"></a><span id="l7.247">     CreateShortCut &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot; &quot;&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l7.248"></a><span id="l7.248">     ShellLink::SetShortCutWorkingDirectory &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot; &quot;$INSTDIR&quot;</span>
<a href="#l7.249"></a><span id="l7.249">   ${EndUnless}</span>
<a href="#l7.250"></a><span id="l7.250"> !macroend</span>
<a href="#l7.251"></a><span id="l7.251"> !define ShowShortcuts &quot;!insertmacro ShowShortcuts&quot;</span>
<a href="#l7.252"></a><span id="l7.252"> </span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-!macro SetHandlers</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-  GetFullPathName $8 &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+!macro SetHandlersMail</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l7.258"></a><span id="l7.258">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-  StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-  StrCpy $3 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-  ; Associate the file handlers with ThunderbirdEML</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-  WriteRegStr SHCTX &quot;$0\.eml&quot;   &quot;&quot; &quot;ThunderbirdEML&quot;</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+  StrCpy $1 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+  StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.266"></a><span id="l7.266"> </span>
<a href="#l7.267"></a><span id="l7.267">   ; An empty string is used for the 5th param because ThunderbirdEML is not a</span>
<a href="#l7.268"></a><span id="l7.268">   ; protocol handler</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot;  &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot;  &quot;$1&quot; &quot;$8,0&quot; \</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+                      &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+  ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot;  &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+  ${AddHandlerValues} &quot;$0\mailto&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.274"></a><span id="l7.274"> </span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-  ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot;  &quot;$3&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-  ${AddHandlerValues} &quot;$0\Thunderbird.Url.news&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+  ; Associate the file handlers with ThunderbirdEML</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+  ReadRegStr $6 HKCR &quot;.eml&quot; &quot;&quot;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+  ${If} &quot;$6&quot; != &quot;ThunderbirdEML&quot;</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+    WriteRegStr SHCTX &quot;$0\.eml&quot;   &quot;&quot; &quot;ThunderbirdEML&quot;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+!macroend</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+!define SetHandlersMail &quot;!insertmacro SetHandlersMail&quot;</span>
<a href="#l7.284"></a><span id="l7.284"> </span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">-  ${AddHandlerValues} &quot;$0\mailto&quot; &quot;$3&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+!macro SetHandlersNews</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+  StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-  ${AddHandlerValues} &quot;$0\news&quot;   &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-  ${AddHandlerValues} &quot;$0\nntp&quot;   &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-  ${AddHandlerValues} &quot;$0\snews&quot;  &quot;$2&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+  ${AddHandlerValues} &quot;$0\Thunderbird.Url.news&quot; &quot;$1&quot; &quot;$8,0&quot; \</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+                      &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+  ${AddHandlerValues} &quot;$0\news&quot;   &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+  ${AddHandlerValues} &quot;$0\nntp&quot;   &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+  ${AddHandlerValues} &quot;$0\snews&quot;  &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.299"></a><span id="l7.299"> !macroend</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-!define SetHandlers &quot;!insertmacro SetHandlers&quot;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+!define SetHandlersNews &quot;!insertmacro SetHandlersNews&quot;</span>
<a href="#l7.302"></a><span id="l7.302"> </span>
<a href="#l7.303"></a><span id="l7.303"> ; XXXrstrong - there are several values that will be overwritten by and</span>
<a href="#l7.304"></a><span id="l7.304"> ; overwrite other installs of the same application.</span>
<a href="#l7.305"></a><span id="l7.305"> !macro SetClientsMail</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-  GetFullPathName $8 &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-  GetFullPathName $7 &quot;$INSTDIR\uninstall\helper.exe&quot;</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-  GetFullPathName $6 &quot;$INSTDIR\mozMapi32.dll&quot;</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\uninstall\helper.exe&quot; $7</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\mozMapi32.dll&quot; $6</span>
<a href="#l7.312"></a><span id="l7.312"> </span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-  StrCpy $0 &quot;Software\Clients\Mail\${BrandFullNameInternal}&quot;</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+  StrCpy $0 &quot;Software\Clients\Mail\${ClientsRegName}&quot;</span>
<a href="#l7.315"></a><span id="l7.315"> </span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-  WriteRegStr HKLM &quot;$0&quot; &quot;&quot; &quot;${BrandFullNameInternal}&quot;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  WriteRegStr HKLM &quot;$0&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l7.318"></a><span id="l7.318">   WriteRegStr HKLM &quot;$0\DefaultIcon&quot; &quot;&quot; &quot;$8,0&quot;</span>
<a href="#l7.319"></a><span id="l7.319">   WriteRegStr HKLM &quot;$0&quot; &quot;DLLPath&quot; &quot;$6&quot;</span>
<a href="#l7.320"></a><span id="l7.320"> </span>
<a href="#l7.321"></a><span id="l7.321">   ; MapiProxy.dll can exist in multiple installs of the application. Registration</span>
<a href="#l7.322"></a><span id="l7.322">   ; occurs as follows with the last action to occur being the one that wins:</span>
<a href="#l7.323"></a><span id="l7.323">   ; On install and software update when helper.exe runs with the /PostUpdate</span>
<a href="#l7.324"></a><span id="l7.324">   ; argument. On setting the application as the system's default application </span>
<a href="#l7.325"></a><span id="l7.325">   ; using Window's &quot;Set program access and defaults&quot;.</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineat">@@ -211,16 +334,28 @@</span>
<a href="#l7.327"></a><span id="l7.327">   WriteRegStr HKLM &quot;$1\MozillaMapi.1\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l7.328"></a><span id="l7.328"> </span>
<a href="#l7.329"></a><span id="l7.329">   ; The Reinstall Command is defined at</span>
<a href="#l7.330"></a><span id="l7.330">   ; http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/programmersguide/shell_adv/registeringapps.asp</span>
<a href="#l7.331"></a><span id="l7.331">   WriteRegStr HKLM &quot;$0\InstallInfo&quot; &quot;HideIconsCommand&quot; &quot;$\&quot;$7$\&quot; /HideShortcuts&quot;</span>
<a href="#l7.332"></a><span id="l7.332">   WriteRegStr HKLM &quot;$0\InstallInfo&quot; &quot;ShowIconsCommand&quot; &quot;$\&quot;$7$\&quot; /ShowShortcuts&quot;</span>
<a href="#l7.333"></a><span id="l7.333">   WriteRegStr HKLM &quot;$0\InstallInfo&quot; &quot;ReinstallCommand&quot; &quot;$\&quot;$7$\&quot; /SetAsDefaultAppGlobal&quot;</span>
<a href="#l7.334"></a><span id="l7.334"> </span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+  ClearErrors</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+  ReadRegDWORD $1 HKLM &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+  ; If the IconsVisible name vale pair doesn't exist add it otherwise the</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+  ; application won't be displayed in Set Program Access and Defaults.</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+    ${If} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+      WriteRegDWORD HKLM &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+    ${Else}</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+      WriteRegDWORD HKLM &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+</span>
<a href="#l7.347"></a><span id="l7.347">   ; Mail shell/open/command</span>
<a href="#l7.348"></a><span id="l7.348">   WriteRegStr HKLM &quot;$0\shell\open\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -mail&quot;</span>
<a href="#l7.349"></a><span id="l7.349"> </span>
<a href="#l7.350"></a><span id="l7.350">   ; options</span>
<a href="#l7.351"></a><span id="l7.351">   WriteRegStr HKLM &quot;$0\shell\properties&quot; &quot;&quot; &quot;$(CONTEXT_OPTIONS)&quot;</span>
<a href="#l7.352"></a><span id="l7.352">   WriteRegStr HKLM &quot;$0\shell\properties\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -options&quot;</span>
<a href="#l7.353"></a><span id="l7.353"> </span>
<a href="#l7.354"></a><span id="l7.354">   ; safemode</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineat">@@ -231,31 +366,68 @@</span>
<a href="#l7.356"></a><span id="l7.356">   StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.357"></a><span id="l7.357">   ${AddHandlerValues} &quot;$0\Protocols\mailto&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.358"></a><span id="l7.358">  </span>
<a href="#l7.359"></a><span id="l7.359">   ; Vista Capabilities registry keys</span>
<a href="#l7.360"></a><span id="l7.360">   WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationDescription&quot; &quot;$(REG_APP_DESC)&quot;</span>
<a href="#l7.361"></a><span id="l7.361">   WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationIcon&quot; &quot;$8,0&quot;</span>
<a href="#l7.362"></a><span id="l7.362">   WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationName&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l7.363"></a><span id="l7.363">   WriteRegStr HKLM &quot;$0\Capabilities\FileAssociations&quot; &quot;.eml&quot;   &quot;ThunderbirdEML&quot;</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\StartMenu&quot; &quot;Mail&quot; &quot;${BrandFullNameInternal}&quot;</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+  WriteRegStr HKLM &quot;$0\Capabilities\StartMenu&quot; &quot;Mail&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l7.366"></a><span id="l7.366">   WriteRegStr HKLM &quot;$0\Capabilities\URLAssociations&quot; &quot;mailto&quot; &quot;Thunderbird.Url.mailto&quot;</span>
<a href="#l7.367"></a><span id="l7.367"> </span>
<a href="#l7.368"></a><span id="l7.368">   ; Vista Registered Application</span>
<a href="#l7.369"></a><span id="l7.369">   WriteRegStr HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot; &quot;$0\Capabilities&quot;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+!macroend</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+!define SetClientsMail &quot;!insertmacro SetClientsMail&quot;</span>
<a href="#l7.372"></a><span id="l7.372"> </span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-  ; News</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-  StrCpy $0 &quot;Software\Clients\News\${BrandFullNameInternal}&quot;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+; XXXrstrong - there are several values that will be overwritten by and</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+; overwrite other installs of the same application.</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+!macro SetClientsNews</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\uninstall\helper.exe&quot; $7</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\mozMapi32.dll&quot; $6</span>
<a href="#l7.383"></a><span id="l7.383"> </span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  WriteRegStr HKLM &quot;$0&quot; &quot;&quot; &quot;${BrandFullNameInternal}&quot;</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  StrCpy $0 &quot;Software\Clients\News\${ClientsRegName}&quot;</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+  WriteRegStr HKLM &quot;$0&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l7.388"></a><span id="l7.388">   WriteRegStr HKLM &quot;$0\DefaultIcon&quot; &quot;&quot; &quot;$8,0&quot;</span>
<a href="#l7.389"></a><span id="l7.389">   WriteRegStr HKLM &quot;$0&quot; &quot;DLLPath&quot; &quot;$6&quot;</span>
<a href="#l7.390"></a><span id="l7.390"> </span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+  ; MapiProxy.dll can exist in multiple installs of the application. Registration</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+  ; occurs as follows with the last action to occur being the one that wins:</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  ; On install and software update when helper.exe runs with the /PostUpdate</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  ; argument. On setting the application as the system's default application </span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+  ; using Window's &quot;Set program access and defaults&quot;.</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  !ifndef NO_LOG</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+    ${LogHeader} &quot;DLL Registration&quot;</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+  !endif</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+  ClearErrors</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+  RegDLL &quot;$INSTDIR\MapiProxy.dll&quot;</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+  !ifndef NO_LOG  </span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+    ${If} ${Errors}</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+      ${LogMsg} &quot;** ERROR Registering: $INSTDIR\MapiProxy.dll **&quot;</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+    ${Else}</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+      ${LogUninstall} &quot;DLLReg: \MapiProxy.dll&quot;</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+      ${LogMsg} &quot;Registered: $INSTDIR\MapiProxy.dll&quot;</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+    ${EndIf}</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+  !endif</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+  StrCpy $1 &quot;Software\Classes\CLSID\{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+  WriteRegStr HKLM &quot;$1\LocalServer32&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; /MAPIStartup&quot;</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+  WriteRegStr HKLM &quot;$1\ProgID&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+  WriteRegStr HKLM &quot;$1\VersionIndependentProgID&quot; &quot;&quot; &quot;MozillaMAPI&quot;</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+  StrCpy $1 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  WriteRegStr HKLM &quot;$1\MozillaMapi&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+  WriteRegStr HKLM &quot;$1\MozillaMapi\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  WriteRegStr HKLM &quot;$1\MozillaMapi\CurVer&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+  WriteRegStr HKLM &quot;$1\MozillaMapi.1&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+  WriteRegStr HKLM &quot;$1\MozillaMapi.1\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+</span>
<a href="#l7.422"></a><span id="l7.422">   ; Mail shell/open/command</span>
<a href="#l7.423"></a><span id="l7.423">   WriteRegStr HKLM &quot;$0\shell\open\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -mail&quot;</span>
<a href="#l7.424"></a><span id="l7.424"> </span>
<a href="#l7.425"></a><span id="l7.425">   ; Vista Capabilities registry keys</span>
<a href="#l7.426"></a><span id="l7.426">   WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationDescription&quot; &quot;$(REG_APP_DESC)&quot;</span>
<a href="#l7.427"></a><span id="l7.427">   WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationIcon&quot; &quot;$8,0&quot;</span>
<a href="#l7.428"></a><span id="l7.428">   WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationName&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l7.429"></a><span id="l7.429">   WriteRegStr HKLM &quot;$0\Capabilities\URLAssociations&quot; &quot;nntp&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineat">@@ -266,182 +438,268 @@</span>
<a href="#l7.431"></a><span id="l7.431">   StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.432"></a><span id="l7.432">   ${AddHandlerValues} &quot;$0\Protocols\nntp&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.433"></a><span id="l7.433">   ${AddHandlerValues} &quot;$0\Protocols\news&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.434"></a><span id="l7.434">   ${AddHandlerValues} &quot;$0\Protocols\snews&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.435"></a><span id="l7.435"> </span>
<a href="#l7.436"></a><span id="l7.436">   ; Vista Registered Application</span>
<a href="#l7.437"></a><span id="l7.437">   WriteRegStr HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot; &quot;$0\Capabilities&quot;</span>
<a href="#l7.438"></a><span id="l7.438"> !macroend</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-!define SetClientsMail &quot;!insertmacro SetClientsMail&quot;</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+!define SetClientsNews &quot;!insertmacro SetClientsNews&quot;</span>
<a href="#l7.441"></a><span id="l7.441"> </span>
<a href="#l7.442"></a><span id="l7.442"> !macro SetAppKeys</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR&quot; $8</span>
<a href="#l7.444"></a><span id="l7.444">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})\Main&quot;</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Install Directory&quot; &quot;$INSTDIR&quot; 0</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;PathToExe&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Install Directory&quot; &quot;$8&quot; 0</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;PathToExe&quot; &quot;$8\${FileMainEXE}&quot; 0</span>
<a href="#l7.449"></a><span id="l7.449">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Program Folder Path&quot; &quot;$SMPROGRAMS\$StartMenuDir&quot; 0</span>
<a href="#l7.450"></a><span id="l7.450"> </span>
<a href="#l7.451"></a><span id="l7.451">   SetShellVarContext all  ; Set $DESKTOP to All Users</span>
<a href="#l7.452"></a><span id="l7.452">   ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.453"></a><span id="l7.453">     SetShellVarContext current  ; Set $DESKTOP to the current user's desktop</span>
<a href="#l7.454"></a><span id="l7.454">   ${EndUnless}</span>
<a href="#l7.455"></a><span id="l7.455"> </span>
<a href="#l7.456"></a><span id="l7.456">   ${If} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.457"></a><span id="l7.457">     ShellLink::GetShortCutArgs &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.458"></a><span id="l7.458">     Pop $1</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-    ${If} $1 == &quot;&quot;</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+    ${If} &quot;$1&quot; == &quot;&quot;</span>
<a href="#l7.461"></a><span id="l7.461">       ShellLink::GetShortCutTarget &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l7.462"></a><span id="l7.462">       Pop $1</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-      ; Needs to handle short paths</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-      ${If} $1 == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+      ${GetLongPath} &quot;$1&quot; $1</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+      ${If} &quot;$1&quot; == &quot;$8\${FileMainEXE}&quot;</span>
<a href="#l7.467"></a><span id="l7.467">         ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;Create Desktop Shortcut&quot; 1 0</span>
<a href="#l7.468"></a><span id="l7.468">       ${Else}</span>
<a href="#l7.469"></a><span id="l7.469">         ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;Create Desktop Shortcut&quot; 0 0</span>
<a href="#l7.470"></a><span id="l7.470">       ${EndIf}</span>
<a href="#l7.471"></a><span id="l7.471">     ${EndIf}</span>
<a href="#l7.472"></a><span id="l7.472">   ${EndIf}</span>
<a href="#l7.473"></a><span id="l7.473"> </span>
<a href="#l7.474"></a><span id="l7.474">   ; XXXrstrong - need a cleaner way to prevent unsetting SHCTX from HKLM when</span>
<a href="#l7.475"></a><span id="l7.475">   ; trying to find the desktop shortcut.</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-  ${If} $TmpVal == &quot;HKCU&quot;</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-    SetShellVarContext current</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+  ${If} &quot;$TmpVal&quot; == &quot;HKCU&quot;</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+    SetShellVarContext current ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l7.480"></a><span id="l7.480">   ${Else}</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-    SetShellVarContext all</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+    SetShellVarContext all     ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l7.483"></a><span id="l7.483">   ${EndIf}</span>
<a href="#l7.484"></a><span id="l7.484"> </span>
<a href="#l7.485"></a><span id="l7.485">   ${If} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.486"></a><span id="l7.486">     ShellLink::GetShortCutArgs &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.487"></a><span id="l7.487">     Pop $1</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-    ${If} $1 == &quot;&quot;</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+    ${If} &quot;$1&quot; == &quot;&quot;</span>
<a href="#l7.490"></a><span id="l7.490">       ShellLink::GetShortCutTarget &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l7.491"></a><span id="l7.491">       Pop $1</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-      ; Needs to handle short paths</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-      ${If} $1 == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+      ${GetLongPath} &quot;$1&quot; $1</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+      ${If} &quot;$1&quot; == &quot;$8\${FileMainEXE}&quot;</span>
<a href="#l7.496"></a><span id="l7.496">         ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;Create Quick Launch Shortcut&quot; 1 0</span>
<a href="#l7.497"></a><span id="l7.497">       ${Else}</span>
<a href="#l7.498"></a><span id="l7.498">         ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;Create Quick Launch Shortcut&quot; 0 0</span>
<a href="#l7.499"></a><span id="l7.499">       ${EndIf}</span>
<a href="#l7.500"></a><span id="l7.500">     ${EndIf}</span>
<a href="#l7.501"></a><span id="l7.501">   ${EndIf}</span>
<a href="#l7.502"></a><span id="l7.502">   ; XXXrstrong - &quot;Create Start Menu Shortcut&quot; and &quot;Start Menu Folder&quot; are only</span>
<a href="#l7.503"></a><span id="l7.503">   ; set in the installer and should also be set here for software update.</span>
<a href="#l7.504"></a><span id="l7.504"> </span>
<a href="#l7.505"></a><span id="l7.505">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})\Uninstall&quot;</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Uninstall Log Folder&quot; &quot;$INSTDIR\uninstall&quot; 0</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Uninstall Log Folder&quot; &quot;$8\uninstall&quot; 0</span>
<a href="#l7.508"></a><span id="l7.508">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Description&quot; &quot;${BrandFullNameInternal} (${AppVersion})&quot; 0</span>
<a href="#l7.509"></a><span id="l7.509"> </span>
<a href="#l7.510"></a><span id="l7.510">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})&quot;</span>
<a href="#l7.511"></a><span id="l7.511">   ${WriteRegStr2} $TmpVal  &quot;$0&quot; &quot;&quot; &quot;${AppVersion} (${AB_CD})&quot; 0</span>
<a href="#l7.512"></a><span id="l7.512"> </span>
<a href="#l7.513"></a><span id="l7.513">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal} ${AppVersion}\bin&quot;</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;PathToExe&quot; &quot;$INSTDIR\${FileMainEXE}&quot; 0</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;PathToExe&quot; &quot;$8\${FileMainEXE}&quot; 0</span>
<a href="#l7.516"></a><span id="l7.516"> </span>
<a href="#l7.517"></a><span id="l7.517">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal} ${AppVersion}\extensions&quot;</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Components&quot; &quot;$INSTDIR\components&quot; 0</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Plugins&quot; &quot;$INSTDIR\plugins&quot; 0</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Components&quot; &quot;$8\components&quot; 0</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Plugins&quot; &quot;$8\plugins&quot; 0</span>
<a href="#l7.522"></a><span id="l7.522"> </span>
<a href="#l7.523"></a><span id="l7.523">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal} ${AppVersion}&quot;</span>
<a href="#l7.524"></a><span id="l7.524">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;GeckoVer&quot; &quot;${GREVersion}&quot; 0</span>
<a href="#l7.525"></a><span id="l7.525"> </span>
<a href="#l7.526"></a><span id="l7.526">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}&quot;</span>
<a href="#l7.527"></a><span id="l7.527">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;&quot; &quot;${GREVersion}&quot; 0</span>
<a href="#l7.528"></a><span id="l7.528">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;CurrentVersion&quot; &quot;${AppVersion} (${AB_CD})&quot; 0</span>
<a href="#l7.529"></a><span id="l7.529"> !macroend</span>
<a href="#l7.530"></a><span id="l7.530"> !define SetAppKeys &quot;!insertmacro SetAppKeys&quot;</span>
<a href="#l7.531"></a><span id="l7.531"> </span>
<a href="#l7.532"></a><span id="l7.532"> !macro SetUninstallKeys</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+  StrCpy $0 &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${BrandFullNameInternal} (${AppVersion})&quot;</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR&quot; $8</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+</span>
<a href="#l7.536"></a><span id="l7.536">   ; Write the uninstall registry keys</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-  StrCpy $0 &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${BrandFullNameInternal} (${AppVersion})&quot;</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-  GetFullPathName $8 &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-  GetFullPathName $7 &quot;$INSTDIR\uninstall\helper.exe&quot;</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-</span>
<a href="#l7.541"></a><span id="l7.541">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Comments&quot; &quot;${BrandFullNameInternal}&quot; 0</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayIcon&quot; &quot;$8,0&quot; 0</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayIcon&quot; &quot;$8\${FileMainEXE},0&quot; 0</span>
<a href="#l7.544"></a><span id="l7.544">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayName&quot; &quot;${BrandFullNameInternal} (${AppVersion})&quot; 0</span>
<a href="#l7.545"></a><span id="l7.545">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;DisplayVersion&quot; &quot;${AppVersion} (${AB_CD})&quot; 0</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;InstallLocation&quot; &quot;$INSTDIR&quot; 0</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;InstallLocation&quot; &quot;$8&quot; 0</span>
<a href="#l7.548"></a><span id="l7.548">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Publisher&quot; &quot;Mozilla&quot; 0</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;UninstallString&quot; &quot;$7&quot; 0</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+  ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;UninstallString&quot; &quot;$8\uninstall\helper.exe&quot; 0</span>
<a href="#l7.551"></a><span id="l7.551">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;URLInfoAbout&quot; &quot;${URLInfoAbout}&quot; 0</span>
<a href="#l7.552"></a><span id="l7.552">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;URLUpdateInfo&quot; &quot;${URLUpdateInfo}&quot; 0</span>
<a href="#l7.553"></a><span id="l7.553">   ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;NoModify&quot; 1 0</span>
<a href="#l7.554"></a><span id="l7.554">   ${WriteRegDWORD2} $TmpVal &quot;$0&quot; &quot;NoRepair&quot; 1 0</span>
<a href="#l7.555"></a><span id="l7.555"> !macroend</span>
<a href="#l7.556"></a><span id="l7.556"> !define SetUninstallKeys &quot;!insertmacro SetUninstallKeys&quot;</span>
<a href="#l7.557"></a><span id="l7.557"> </span>
<a href="#l7.558"></a><span id="l7.558" class="difflineminus">-!macro FixClassKeys</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+; Updates protocol handlers if their registry open command value is for this</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+; install location</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+!macro UpdateProtocolHandlers</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+  ; Store the command to open the app with an url in a register for easy access.</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+  ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l7.564"></a><span id="l7.564">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-  GetFullPathName $8 &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+  StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+  StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+  StrCpy $3 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.569"></a><span id="l7.569"> </span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-  StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-  ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineplus">+  ; Only set the file and protocol handlers if the existing one under HKCR is</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+  ; for this install location.</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;ThunderbirdEML&quot; $R9</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\ThunderbirdEML&quot; &quot;$3&quot; &quot;$8,0&quot; \</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+                        &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;Thunderbird.Url.mailto&quot; $R9</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\Thunderbird.Url.mailto&quot; &quot;$1&quot; &quot;$8,0&quot; \</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+                        &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;mailto&quot; $R9</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\mailto&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.590"></a><span id="l7.590"> </span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-  ReadRegStr $2 SHCTX &quot;$0\mailto\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineminus">-  ${GetPathFromString} &quot;$2&quot; $3</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-  GetFullPathName $2 &quot;$3&quot;</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-  ClearErrors</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-  ${WordFind} &quot;$2&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineminus">-    ${AddHandlerValues} &quot;$0\mailto&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-  ${EndUnless}</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;Thunderbird.Url.news&quot; $R9</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\Thunderbird.Url.news&quot; &quot;$2&quot; &quot;$8,0&quot; \</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+                        &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineplus">+</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;news&quot; $R9</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\news&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.609"></a><span id="l7.609"> </span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-  StrCpy $1 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineminus">-  ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;snews&quot; $R9</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\snews&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.616"></a><span id="l7.616"> </span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-  StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-  ${AddHandlerValues} &quot;$0\Thunderbird.Url.news&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+  ${IsHandlerForInstallDir} &quot;nntp&quot; $R9</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+  ${If} &quot;$R9&quot; == &quot;true&quot;</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+    ${AddHandlerValues} &quot;SOFTWARE\Classes\nntp&quot; &quot;$2&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+!macroend</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+!define UpdateProtocolHandlers &quot;!insertmacro UpdateProtocolHandlers&quot;</span>
<a href="#l7.625"></a><span id="l7.625"> </span>
<a href="#l7.626"></a><span id="l7.626" class="difflineminus">-  ReadRegStr $2 SHCTX &quot;$0\news\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineminus">-  ${GetPathFromString} &quot;$2&quot; $3</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-  GetFullPathName $2 &quot;$3&quot;</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineplus">+!macro RemoveDeprecatedKeys</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+  StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineplus">+</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineplus">+  ; remove DI and SOC from the .eml class if it exists and contains</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineplus">+  ; thunderbird.exe</span>
<a href="#l7.634"></a><span id="l7.634">   ClearErrors</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-  ${WordFind} &quot;$2&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-    ${AddHandlerValues} &quot;$0\news&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-  ${EndUnless}</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-  ReadRegStr $2 SHCTX &quot;$0\snews\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-  ${GetPathFromString} &quot;$2&quot; $3</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-  GetFullPathName $2 &quot;$3&quot;</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-  ClearErrors</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-  ${WordFind} &quot;$2&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-    ${AddHandlerValues} &quot;$0\snews&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-  ${EndUnless}</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-  ReadRegStr $2 SHCTX &quot;$0\nntp\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineminus">-  ${GetPathFromString} &quot;$2&quot; $3</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineminus">-  GetFullPathName $2 &quot;$3&quot;</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-  ClearErrors</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-  ${WordFind} &quot;$2&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineminus">-    ${AddHandlerValues} &quot;$0\nntp&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineminus">-  ${EndUnless}</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineminus">-</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineminus">-  ; remove DI and SOC from the .eml class if it exists</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-  ReadRegStr $2 SHCTX &quot;$0\.eml\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineminus">-  ${GetPathFromString} &quot;$2&quot; $3</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineminus">-  GetFullPathName $2 &quot;$3&quot;</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineminus">-  ClearErrors</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineminus">-  ${WordFind} &quot;$2&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+  ReadRegStr $1 HKLM &quot;$0\.eml\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+  ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.666"></a><span id="l7.666">   ${Unless} ${Errors}</span>
<a href="#l7.667"></a><span id="l7.667">     DeleteRegKey HKLM &quot;$0\.eml\shell\open\command&quot;</span>
<a href="#l7.668"></a><span id="l7.668">   ${EndUnless}</span>
<a href="#l7.669"></a><span id="l7.669"> </span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-  ReadRegStr $2 SHCTX &quot;$0\.eml\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineminus">-  ${GetPathFromString} &quot;$2&quot; $3</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineminus">-  GetFullPathName $2 &quot;$3&quot;</span>
<a href="#l7.673"></a><span id="l7.673">   ClearErrors</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineminus">-  ${WordFind} &quot;$2&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+  ReadRegStr $1 HKCU &quot;$0\.eml\shell\open\command&quot; &quot;&quot;</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+  ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+    DeleteRegKey HKCU &quot;$0\.eml\shell\open\command&quot;</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+  ${EndUnless}</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+  ClearErrors</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+  ReadRegStr $1 HKLM &quot;$0\.eml\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineplus">+  ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.684"></a><span id="l7.684">   ${Unless} ${Errors}</span>
<a href="#l7.685"></a><span id="l7.685">     DeleteRegKey HKLM &quot;$0\.eml\DefaultIcon&quot;</span>
<a href="#l7.686"></a><span id="l7.686">   ${EndUnless}</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineminus">-  </span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineplus">+  ClearErrors</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+  ReadRegStr $1 HKCU &quot;$0\.eml\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+  ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineplus">+    DeleteRegKey HKCU &quot;$0\.eml\DefaultIcon&quot;</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineplus">+  ${EndUnless}</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+  ; Remove the Shredder clients key if its default icon contains thunderbird.exe</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+  ClearErrors</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+  ReadRegStr $1 HKLM &quot;SOFTWARE\clients\mail\Shredder\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineplus">+  ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineplus">+    DeleteRegKey HKLM &quot;SOFTWARE\clients\mail\Shredder&quot;</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineplus">+  ${EndUnless}</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineplus">+</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineplus">+  ClearErrors</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineplus">+  ReadRegStr $1 HKLM &quot;SOFTWARE\clients\news\Shredder\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineplus">+  ${WordFind} &quot;$1&quot; &quot;${FileMainEXE}&quot; &quot;E+1{&quot; $R1</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineplus">+    DeleteRegKey HKLM &quot;SOFTWARE\clients\news\Shredder&quot;</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineplus">+  ${EndUnless}</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineplus">+</span>
<a href="#l7.711"></a><span id="l7.711">   ; The Vista shim for 1.5.0.10 writes out a set of bogus keys which we need to</span>
<a href="#l7.712"></a><span id="l7.712">   ; cleanup. Intentionally hard coding Mozilla Thunderbird here</span>
<a href="#l7.713"></a><span id="l7.713">   ; as this is the string used by the vista shim.</span>
<a href="#l7.714"></a><span id="l7.714">   DeleteRegKey HKLM &quot;$0\Mozilla Thunderbird.Url.mailto&quot;</span>
<a href="#l7.715"></a><span id="l7.715">   DeleteRegValue HKLM &quot;Software\RegisteredApplications&quot; &quot;Mozilla Thunderbird&quot;</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-  ; More bogus keys are written to Clients\Mail\Mozilla Thunderbird, but</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-  ; those are fixed in SetClientsMail</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineplus">+!macroend</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineplus">+!define RemoveDeprecatedKeys &quot;!insertmacro RemoveDeprecatedKeys&quot;</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+; The files to check if they are in use during (un)install so the restart is</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+; required message is displayed. All files must be located in the $INSTDIR</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+; directory.</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+!macro PushFilesToCheck</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+  ; The first string to be pushed onto the stack MUST be &quot;end&quot; to indicate</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+  ; that there are no more files to check in $INSTDIR and the last string</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+  ; should be ${FileMainEXE} so if it is in use the CheckForFilesInUse macro</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+  ; returns after the first check.</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+  Push &quot;end&quot;</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+  Push &quot;AccessibleMarshal.dll&quot;</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineplus">+  Push &quot;freebl3.dll&quot;</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+  Push &quot;nssckbi.dll&quot;</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineplus">+  Push &quot;nspr4.dll&quot;</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+  Push &quot;nssdbm3.dll&quot;</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineplus">+  Push &quot;sqlite3.dll&quot;</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+  Push &quot;xpcom.dll&quot;</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+  Push &quot;crashreporter.exe&quot;</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineplus">+  Push &quot;updater.exe&quot;</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineplus">+  Push &quot;xpicleanup.exe&quot;</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+  Push &quot;MapiProxy.dll&quot;</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+  Push &quot;mozMapi32.dll&quot;</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+  Push &quot;${FileMainEXE}&quot;</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+!macroend</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+!define PushFilesToCheck &quot;!insertmacro PushFilesToCheck&quot;</span>
<a href="#l7.745"></a><span id="l7.745"> </span>
<a href="#l7.746"></a><span id="l7.746" class="difflineminus">-!macroend</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineminus">-!define FixClassKeys &quot;!insertmacro FixClassKeys&quot;</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+; The !ifdef NO_LOG prevents warnings when compiling the installer since these</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+; functions are currently only used by the uninstaller.</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+!ifdef NO_LOG</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+Function SetAsDefaultMailAppUser</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+  SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineplus">+  ${SetHandlersMail}</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineplus">+  ${If} ${AtLeastWinVista}</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineplus">+    ClearErrors</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+    ; Only register as the handler on Vista if the app registry name exists</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+    ; under the RegisteredApplications registry key.</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+      AppAssocReg::SetAppAsDefaultAll &quot;${AppRegNameMail}&quot;</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+    ${EndUnless}</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+FunctionEnd</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+Function SetAsDefaultNewsAppUser</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+  SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+  ${SetHandlersNews}</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+  ${If} ${AtLeastWinVista}</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+    ClearErrors</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+    ReadRegStr $0 HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+    ; Only register as the handler on Vista if the app registry name exists</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+    ; under the RegisteredApplications registry key.</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+      AppAssocReg::SetAppAsDefaultAll &quot;${AppRegNameNews}&quot;</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineplus">+    ${EndUnless}</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineplus">+  ${EndIf}</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineplus">+FunctionEnd</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+!endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/installer/windows/nsis/uninstaller.nsi</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/installer/windows/nsis/uninstaller.nsi</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -31,95 +31,106 @@</span>
<a href="#l8.4"></a><span id="l8.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.5"></a><span id="l8.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.6"></a><span id="l8.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.7"></a><span id="l8.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.8"></a><span id="l8.8"> #</span>
<a href="#l8.9"></a><span id="l8.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> # Required Plugins:</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-# ShellLink    http://nsis.sourceforge.net/ShellLink_plug-in</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+# AppAssocReg http://nsis.sourceforge.net/Application_Association_Registration_plug-in</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+# ShellLink   http://nsis.sourceforge.net/ShellLink_plug-in</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+# UAC         http://nsis.sourceforge.net/UAC_plug-in</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> ; Set verbosity to 3 (e.g. no script) to lessen the noise in the build logs</span>
<a href="#l8.18"></a><span id="l8.18"> !verbose 3</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> ; 7-Zip provides better compression than the lzma from NSIS so we add the files</span>
<a href="#l8.21"></a><span id="l8.21"> ; uncompressed and use 7-Zip to create a SFX archive of it</span>
<a href="#l8.22"></a><span id="l8.22"> SetDatablockOptimize on</span>
<a href="#l8.23"></a><span id="l8.23"> SetCompress off</span>
<a href="#l8.24"></a><span id="l8.24"> CRCCheck on</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+RequestExecutionLevel user</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28"> !addplugindir ./</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+; USE_UAC_PLUGIN is temporary until Thunderbird has been updated to use the UAC plugin</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+!define USE_UAC_PLUGIN</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+</span>
<a href="#l8.33"></a><span id="l8.33"> ; prevents compiling of the reg write logging.</span>
<a href="#l8.34"></a><span id="l8.34"> !define NO_LOG</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> Var TmpVal</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> ; Other included files may depend upon these includes!</span>
<a href="#l8.39"></a><span id="l8.39"> ; The following includes are provided by NSIS.</span>
<a href="#l8.40"></a><span id="l8.40"> !include FileFunc.nsh</span>
<a href="#l8.41"></a><span id="l8.41"> !include LogicLib.nsh</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+!include MUI.nsh</span>
<a href="#l8.43"></a><span id="l8.43"> !include TextFunc.nsh</span>
<a href="#l8.44"></a><span id="l8.44"> !include WinMessages.nsh</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+!include WinVer.nsh</span>
<a href="#l8.46"></a><span id="l8.46"> !include WordFunc.nsh</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-!include MUI.nsh</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-; WinVer.nsh was added in the same release that RequestExecutionLevel so check</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-; if ___WINVER__NSH___ is defined to determine if RequestExecutionLevel is</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-; available.</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-!include /NONFATAL WinVer.nsh</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-!ifdef ___WINVER__NSH___</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  RequestExecutionLevel admin</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-!else</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-  !warning &quot;Uninstaller will be created without Vista compatibility.$\n            \</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-            Upgrade your NSIS installation to at least version 2.22 to resolve.&quot;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-!endif</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+!insertmacro GetOptions</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+!insertmacro GetParameters</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+!insertmacro GetParent</span>
<a href="#l8.63"></a><span id="l8.63"> !insertmacro WordFind</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-!insertmacro WordReplace</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66"> !insertmacro un.GetParent</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-!insertmacro un.LineFind</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-!insertmacro un.TrimNewLines</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70"> ; The following includes are custom.</span>
<a href="#l8.71"></a><span id="l8.71"> !include branding.nsi</span>
<a href="#l8.72"></a><span id="l8.72"> !include defines.nsi</span>
<a href="#l8.73"></a><span id="l8.73"> !include common.nsh</span>
<a href="#l8.74"></a><span id="l8.74"> !include locales.nsi</span>
<a href="#l8.75"></a><span id="l8.75"> !include version.nsh</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77"> ; This is named BrandShortName helper because we use this for software update</span>
<a href="#l8.78"></a><span id="l8.78"> ; post update cleanup.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-VIAddVersionKey &quot;FileDescription&quot; &quot;${BrandShortName} Helper&quot;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+VIAddVersionKey &quot;FileDescription&quot;  &quot;${BrandShortName} Helper&quot;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+VIAddVersionKey &quot;OriginalFilename&quot; &quot;helper.exe&quot;</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83"> !insertmacro AddHandlerValues</span>
<a href="#l8.84"></a><span id="l8.84"> !insertmacro CleanVirtualStore</span>
<a href="#l8.85"></a><span id="l8.85"> !insertmacro GetLongPath</span>
<a href="#l8.86"></a><span id="l8.86"> !insertmacro GetPathFromString</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+!insertmacro IsHandlerForInstallDir</span>
<a href="#l8.88"></a><span id="l8.88"> !insertmacro RegCleanMain</span>
<a href="#l8.89"></a><span id="l8.89"> !insertmacro RegCleanUninstall</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+!insertmacro SetBrandNameVars</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+!insertmacro UnloadUAC</span>
<a href="#l8.92"></a><span id="l8.92"> !insertmacro WriteRegDWORD2</span>
<a href="#l8.93"></a><span id="l8.93"> !insertmacro WriteRegStr2</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+!insertmacro un.ChangeMUIHeaderImage</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+!insertmacro un.CheckForFilesInUse</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+!insertmacro un.CleanUpdatesDir</span>
<a href="#l8.98"></a><span id="l8.98"> !insertmacro un.CleanVirtualStore</span>
<a href="#l8.99"></a><span id="l8.99"> !insertmacro un.GetLongPath</span>
<a href="#l8.100"></a><span id="l8.100"> !insertmacro un.GetSecondInstallPath</span>
<a href="#l8.101"></a><span id="l8.101"> !insertmacro un.ManualCloseAppPrompt</span>
<a href="#l8.102"></a><span id="l8.102"> !insertmacro un.ParseUninstallLog</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+!insertmacro un.RegCleanAppHandler</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+!insertmacro un.RegCleanFileHandler</span>
<a href="#l8.105"></a><span id="l8.105"> !insertmacro un.RegCleanMain</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+!insertmacro un.RegCleanProtocolHandler</span>
<a href="#l8.107"></a><span id="l8.107"> !insertmacro un.RegCleanUninstall</span>
<a href="#l8.108"></a><span id="l8.108"> !insertmacro un.RemoveQuotesFromPath</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+!insertmacro un.SetBrandNameVars</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111"> !include shared.nsh</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113"> ; Helper macros for ui callbacks. Insert these after shared.nsh</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+!insertmacro OnEndCommon</span>
<a href="#l8.115"></a><span id="l8.115"> !insertmacro UninstallOnInitCommon</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+!insertmacro un.OnEndCommon</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+</span>
<a href="#l8.119"></a><span id="l8.119"> Name &quot;${BrandFullName}&quot;</span>
<a href="#l8.120"></a><span id="l8.120"> OutFile &quot;helper.exe&quot;</span>
<a href="#l8.121"></a><span id="l8.121"> InstallDirRegKey HKLM &quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\${BrandFullNameInternal} (${AppVersion})&quot; &quot;InstallLocation&quot;</span>
<a href="#l8.122"></a><span id="l8.122"> InstallDir &quot;$PROGRAMFILES\${BrandFullName}&quot;</span>
<a href="#l8.123"></a><span id="l8.123"> ShowUnInstDetails nevershow</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125"> ################################################################################</span>
<a href="#l8.126"></a><span id="l8.126"> # Modern User Interface - MUI</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineat">@@ -138,39 +149,43 @@ ShowUnInstDetails nevershow</span>
<a href="#l8.128"></a><span id="l8.128"> !else</span>
<a href="#l8.129"></a><span id="l8.129"> !define MUI_HEADERIMAGE_BITMAP wizHeader.bmp</span>
<a href="#l8.130"></a><span id="l8.130"> !endif</span>
<a href="#l8.131"></a><span id="l8.131"> </span>
<a href="#l8.132"></a><span id="l8.132"> /**</span>
<a href="#l8.133"></a><span id="l8.133">  * Uninstall Pages</span>
<a href="#l8.134"></a><span id="l8.134">  */</span>
<a href="#l8.135"></a><span id="l8.135"> ; Welcome Page</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+!define MUI_PAGE_CUSTOMFUNCTION_PRE un.preWelcome</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+!define MUI_PAGE_CUSTOMFUNCTION_LEAVE un.leaveWelcome</span>
<a href="#l8.138"></a><span id="l8.138"> !insertmacro MUI_UNPAGE_WELCOME</span>
<a href="#l8.139"></a><span id="l8.139"> </span>
<a href="#l8.140"></a><span id="l8.140"> ; Uninstall Confirm Page</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-!define MUI_PAGE_CUSTOMFUNCTION_LEAVE un.leaveConfirm</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-!insertmacro MUI_UNPAGE_CONFIRM</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+UninstPage custom un.preConfirm un.leaveConfirm</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145"> ; Remove Files Page</span>
<a href="#l8.146"></a><span id="l8.146"> !insertmacro MUI_UNPAGE_INSTFILES</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148"> ; Finish Page</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+; Don't setup the survey controls, functions, etc. when the application has</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+; defined NO_UNINSTALL_SURVEY</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+!ifndef NO_UNINSTALL_SURVEY</span>
<a href="#l8.153"></a><span id="l8.153"> !define MUI_PAGE_CUSTOMFUNCTION_PRE un.preFinish</span>
<a href="#l8.154"></a><span id="l8.154"> !define MUI_FINISHPAGE_SHOWREADME_NOTCHECKED</span>
<a href="#l8.155"></a><span id="l8.155"> !define MUI_FINISHPAGE_SHOWREADME &quot;&quot;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-; Setup the survey controls, functions, etc. except when the application has</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-; defined NO_UNINSTALL_SURVEY</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-!ifndef NO_UNINSTALL_SURVEY</span>
<a href="#l8.160"></a><span id="l8.160"> !define MUI_FINISHPAGE_SHOWREADME_TEXT $(SURVEY_TEXT)</span>
<a href="#l8.161"></a><span id="l8.161"> !define MUI_FINISHPAGE_SHOWREADME_FUNCTION un.Survey</span>
<a href="#l8.162"></a><span id="l8.162"> !endif</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164"> !insertmacro MUI_UNPAGE_FINISH</span>
<a href="#l8.165"></a><span id="l8.165"> </span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+; Use the default dialog for IDD_VERIFY for a simple Banner</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+ChangeUI IDD_VERIFY &quot;${NSISDIR}\Contrib\UIs\default.exe&quot;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+</span>
<a href="#l8.169"></a><span id="l8.169"> ################################################################################</span>
<a href="#l8.170"></a><span id="l8.170"> # Install Sections</span>
<a href="#l8.171"></a><span id="l8.171"> ; Empty section required for the installer to compile as an uninstaller</span>
<a href="#l8.172"></a><span id="l8.172"> Section &quot;&quot;</span>
<a href="#l8.173"></a><span id="l8.173"> SectionEnd</span>
<a href="#l8.174"></a><span id="l8.174"> </span>
<a href="#l8.175"></a><span id="l8.175"> ################################################################################</span>
<a href="#l8.176"></a><span id="l8.176"> # Uninstall Sections</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineat">@@ -187,53 +202,72 @@ Section &quot;Uninstall&quot;</span>
<a href="#l8.178"></a><span id="l8.178">     ; If the user closed the application it can take several seconds for it to</span>
<a href="#l8.179"></a><span id="l8.179">     ; shut down completely. If the application is being used by another user we</span>
<a href="#l8.180"></a><span id="l8.180">     ; can still delete the files when the system is restarted. </span>
<a href="#l8.181"></a><span id="l8.181">     Sleep 5000</span>
<a href="#l8.182"></a><span id="l8.182">     ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l8.183"></a><span id="l8.183">     ClearErrors</span>
<a href="#l8.184"></a><span id="l8.184">   ${EndIf}</span>
<a href="#l8.185"></a><span id="l8.185"> </span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-  ; Remove registry entries for non-existent apps and for apps that point to our</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-  ; install location in the Software\Mozilla key and uninstall registry entries</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-  ; that point to our install location for both HKCU and HKLM.</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-  SetShellVarContext current  ; Sets SHCTX to HKCU</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l8.191"></a><span id="l8.191">   ${un.RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l8.192"></a><span id="l8.192">   ${un.RegCleanUninstall}</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-  SetShellVarContext all  ; Sets SHCTX to HKLM</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-  ${un.RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-  ${un.RegCleanUninstall}</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+  ClearErrors</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+  WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+    StrCpy $TmpVal &quot;HKCU&quot; ; used primarily for logging</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+  ${Else}</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    SetShellVarContext all  ; Set SHCTX to HKLM</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+    StrCpy $TmpVal &quot;HKLM&quot; ; used primarily for logging</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+    ${un.RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+    ${un.RegCleanUninstall}</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  ${EndIf}</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+  ${un.RegCleanAppHandler} &quot;Thunderbird.Url.mailto&quot;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+  ${un.RegCleanAppHandler} &quot;Thunderbird.Url.news&quot;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  ${un.RegCleanAppHandler} &quot;ThunderbirdEML&quot;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+  ${un.RegCleanProtocolHandler} &quot;mailto&quot;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  ${un.RegCleanProtocolHandler} &quot;news&quot;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+  ${un.RegCleanProtocolHandler} &quot;nntp&quot;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  ${un.RegCleanProtocolHandler} &quot;snews&quot;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+  ClearErrors</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+  ReadRegStr $R9 HKCR &quot;ThunderbirdEML&quot; &quot;&quot;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+  ; Don't clean up the file handlers if the ThunderbirdEML key still exists</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+  ; since there could be a second installation that may be the default file</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+  ; handler.</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+  ${If} ${Errors}</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+    ${un.RegCleanFileHandler}  &quot;.eml&quot;   &quot;ThunderbirdEML&quot;</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+  ${EndIf}</span>
<a href="#l8.225"></a><span id="l8.225"> </span>
<a href="#l8.226"></a><span id="l8.226">   SetShellVarContext all  ; Set SHCTX to HKLM</span>
<a href="#l8.227"></a><span id="l8.227">   ${un.GetSecondInstallPath} &quot;Software\Mozilla&quot; $R9</span>
<a href="#l8.228"></a><span id="l8.228">   ${If} $R9 == &quot;false&quot;</span>
<a href="#l8.229"></a><span id="l8.229">     SetShellVarContext current  ; Set SHCTX to HKCU</span>
<a href="#l8.230"></a><span id="l8.230">     ${un.GetSecondInstallPath} &quot;Software\Mozilla&quot; $R9</span>
<a href="#l8.231"></a><span id="l8.231">   ${EndIf}</span>
<a href="#l8.232"></a><span id="l8.232"> </span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-  StrCpy $0 &quot;Software\Clients\Mail\${BrandFullNameInternal}\shell\open\command&quot;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+  StrCpy $0 &quot;Software\Clients\Mail\${ClientsRegName}\shell\open\command&quot;</span>
<a href="#l8.235"></a><span id="l8.235">   ReadRegStr $R1 HKLM &quot;$0&quot; &quot;&quot;</span>
<a href="#l8.236"></a><span id="l8.236">   ${un.RemoveQuotesFromPath} &quot;$R1&quot; $R1</span>
<a href="#l8.237"></a><span id="l8.237">   ${un.GetParent} &quot;$R1&quot; $R1</span>
<a href="#l8.238"></a><span id="l8.238"> </span>
<a href="#l8.239"></a><span id="l8.239">   ; Only remove the Clients\Mail and Clients\News key if it refers to this </span>
<a href="#l8.240"></a><span id="l8.240">   ; install location. The Clients\Mail &amp; Clients\News keys are independent </span>
<a href="#l8.241"></a><span id="l8.241">   ; of the default app for the OS settings. The XPInstall base un-installer </span>
<a href="#l8.242"></a><span id="l8.242">   ; always removes these keys if it is uninstalling the default app and it </span>
<a href="#l8.243"></a><span id="l8.243">   ; will always replace the keys when installing even if there is another </span>
<a href="#l8.244"></a><span id="l8.244">   ; install of Thunderbird that is set as the</span>
<a href="#l8.245"></a><span id="l8.245">   ; default app. Now the keys are always updated on install but are only</span>
<a href="#l8.246"></a><span id="l8.246">   ; removed if they refer to this install location.</span>
<a href="#l8.247"></a><span id="l8.247">   ${If} &quot;$INSTDIR&quot; == &quot;$R1&quot;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-    ; XXXrstrong - if there is another installation of the same app ideally we</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-    ; would just modify these values. The GetSecondInstallPath macro could be</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-    ; made to provide enough information to do this.</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-    DeleteRegKey HKLM &quot;Software\Clients\Mail\${BrandFullNameInternal}&quot;</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-    DeleteRegKey HKLM &quot;Software\Clients\News\${BrandFullNameInternal}&quot;</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    DeleteRegKey HKLM &quot;Software\Clients\Mail\${ClientsRegName}&quot;</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+    DeleteRegKey HKLM &quot;Software\Clients\News\${ClientsRegName}&quot;</span>
<a href="#l8.255"></a><span id="l8.255">     DeleteRegValue HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l8.256"></a><span id="l8.256">     DeleteRegValue HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l8.257"></a><span id="l8.257">   ${EndIf}</span>
<a href="#l8.258"></a><span id="l8.258"> </span>
<a href="#l8.259"></a><span id="l8.259">   StrCpy $0 &quot;Software\Microsoft\Windows\CurrentVersion\App Paths\${FileMainEXE}&quot;</span>
<a href="#l8.260"></a><span id="l8.260">   ${If} $R9 == &quot;false&quot;</span>
<a href="#l8.261"></a><span id="l8.261">     DeleteRegKey HKLM &quot;$0&quot;</span>
<a href="#l8.262"></a><span id="l8.262">     DeleteRegKey HKCU &quot;$0&quot;</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineat">@@ -258,32 +292,35 @@ Section &quot;Uninstall&quot;</span>
<a href="#l8.264"></a><span id="l8.264">   ${EndIf}</span>
<a href="#l8.265"></a><span id="l8.265">   ${If} ${FileExists} &quot;$INSTDIR\distribution&quot;</span>
<a href="#l8.266"></a><span id="l8.266">     RmDir /r /REBOOTOK &quot;$INSTDIR\distribution&quot;</span>
<a href="#l8.267"></a><span id="l8.267">   ${EndIf}</span>
<a href="#l8.268"></a><span id="l8.268">   ${If} ${FileExists} &quot;$INSTDIR\removed-files&quot;</span>
<a href="#l8.269"></a><span id="l8.269">     Delete /REBOOTOK &quot;$INSTDIR\removed-files&quot;</span>
<a href="#l8.270"></a><span id="l8.270">   ${EndIf}</span>
<a href="#l8.271"></a><span id="l8.271"> </span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+  ; Remove the updates directory for Vista and above</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+  ${un.CleanUpdatesDir} &quot;Thunderbird&quot;</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+  ; Remove files that may be left behind by the application in the</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+  ; VirtualStore directory.</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+  ${un.CleanVirtualStore}</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+</span>
<a href="#l8.279"></a><span id="l8.279">   ; Parse the uninstall log to unregister dll's and remove all installed</span>
<a href="#l8.280"></a><span id="l8.280">   ; files / directories this install is responsible for.</span>
<a href="#l8.281"></a><span id="l8.281">   ${un.ParseUninstallLog}</span>
<a href="#l8.282"></a><span id="l8.282"> </span>
<a href="#l8.283"></a><span id="l8.283">   ; Remove the uninstall directory that we control</span>
<a href="#l8.284"></a><span id="l8.284">   RmDir /r /REBOOTOK &quot;$INSTDIR\uninstall&quot;</span>
<a href="#l8.285"></a><span id="l8.285"> </span>
<a href="#l8.286"></a><span id="l8.286">   ; Remove the installation directory if it is empty</span>
<a href="#l8.287"></a><span id="l8.287">   ${RemoveDir} &quot;$INSTDIR&quot;</span>
<a href="#l8.288"></a><span id="l8.288"> </span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-  ; Remove files that may be left behind by the application in the</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-  ; VirtualStore directory.</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-  ${un.CleanVirtualStore}</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-  ; If firefox.exe was successfully deleted yet we still need to restart to</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-  ; remove other files create a dummy firefox.exe.moz-delete to prevent the</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  ; If thunderbird.exe was successfully deleted yet we still need to restart to</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+  ; remove other files create a dummy thunderbird.exe.moz-delete to prevent the</span>
<a href="#l8.297"></a><span id="l8.297">   ; installer from allowing an install without restart when it is required</span>
<a href="#l8.298"></a><span id="l8.298">   ; to complete an uninstall.</span>
<a href="#l8.299"></a><span id="l8.299">   ${If} ${RebootFlag}</span>
<a href="#l8.300"></a><span id="l8.300">     ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l8.301"></a><span id="l8.301">       FileOpen $0 &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot; w</span>
<a href="#l8.302"></a><span id="l8.302">       FileWrite $0 &quot;Will be deleted on restart&quot;</span>
<a href="#l8.303"></a><span id="l8.303">       Delete /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l8.304"></a><span id="l8.304">       FileClose $0</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineat">@@ -294,17 +331,17 @@ Section &quot;Uninstall&quot;</span>
<a href="#l8.306"></a><span id="l8.306">   ; removed and other ugly things will happen like recreation of the app's</span>
<a href="#l8.307"></a><span id="l8.307">   ; clients registry key by the OS under some conditions.</span>
<a href="#l8.308"></a><span id="l8.308">   System::Call &quot;shell32::SHChangeNotify(i, i, i, i) v (0x08000000, 0, 0, 0)&quot;</span>
<a href="#l8.309"></a><span id="l8.309"> SectionEnd</span>
<a href="#l8.310"></a><span id="l8.310"> </span>
<a href="#l8.311"></a><span id="l8.311"> ################################################################################</span>
<a href="#l8.312"></a><span id="l8.312"> # Helper Functions</span>
<a href="#l8.313"></a><span id="l8.313"> </span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-; Setup the survey controls, functions, etc. except when the application has</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+; Don't setup the survey controls, functions, etc. when the application has</span>
<a href="#l8.316"></a><span id="l8.316"> ; defined NO_UNINSTALL_SURVEY</span>
<a href="#l8.317"></a><span id="l8.317"> !ifndef NO_UNINSTALL_SURVEY</span>
<a href="#l8.318"></a><span id="l8.318"> Function un.Survey</span>
<a href="#l8.319"></a><span id="l8.319">   ExecShell &quot;open&quot; &quot;${SurveyURL}&quot;</span>
<a href="#l8.320"></a><span id="l8.320"> FunctionEnd</span>
<a href="#l8.321"></a><span id="l8.321"> !endif</span>
<a href="#l8.322"></a><span id="l8.322"> </span>
<a href="#l8.323"></a><span id="l8.323"> ################################################################################</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineat">@@ -317,54 +354,142 @@ FunctionEnd</span>
<a href="#l8.325"></a><span id="l8.325"> !include &quot;customLocale.nsh&quot;</span>
<a href="#l8.326"></a><span id="l8.326"> !verbose pop</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328"> ; Set this after the locale files to override it if it is in the locale. Using</span>
<a href="#l8.329"></a><span id="l8.329"> ; &quot; &quot; for BrandingText will hide the &quot;Nullsoft Install System...&quot; branding.</span>
<a href="#l8.330"></a><span id="l8.330"> BrandingText &quot; &quot;</span>
<a href="#l8.331"></a><span id="l8.331"> </span>
<a href="#l8.332"></a><span id="l8.332"> ################################################################################</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-# Page pre and leave functions</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+# Page pre, show, and leave functions</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+Function un.preWelcome</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\distribution\modern-wizard.bmp&quot;</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+    Delete &quot;$PLUGINSDIR\modern-wizard.bmp&quot;</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+    CopyFiles /SILENT &quot;$INSTDIR\distribution\modern-wizard.bmp&quot; &quot;$PLUGINSDIR\modern-wizard.bmp&quot;</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+  ${EndIf}</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+FunctionEnd</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+Function un.leaveWelcome</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+    Banner::show /NOUNLOAD &quot;$(BANNER_CHECK_EXISTING)&quot;</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+    ${If} &quot;$TmpVal&quot; == &quot;FoundMessageWindow&quot;</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+      Sleep 5000</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+    ${EndIf}</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+    ${PushFilesToCheck}</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+    ${un.CheckForFilesInUse} $TmpVal</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+    Banner::destroy</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+    ${If} &quot;$TmpVal&quot; == &quot;true&quot;</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+      StrCpy $TmpVal &quot;FoundMessageWindow&quot;</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+      ${un.ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_UNINSTALL)&quot;</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+      StrCpy $TmpVal &quot;true&quot;</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+    ${EndIf}</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+  ${EndIf}</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+FunctionEnd</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+Function un.preConfirm</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\distribution\modern-header.bmp&quot;</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+  ${AndIf} $hHeaderBitmap == &quot;&quot;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+    Delete &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+    CopyFiles /SILENT &quot;$INSTDIR\distribution\modern-header.bmp&quot; &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+    ${un.ChangeMUIHeaderImage} &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+  ${EndIf}</span>
<a href="#l8.372"></a><span id="l8.372"> </span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-; Checks if the app being uninstalled is running.</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Settings&quot; NumFields &quot;2&quot;</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 1&quot; Type   &quot;label&quot;</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 1&quot; Text   &quot;$(UN_CONFIRM_UNINSTALLED_FROM)&quot;</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 1&quot; Left   &quot;0&quot;</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 1&quot; Right  &quot;-1&quot;</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 1&quot; Top    &quot;5&quot;</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 1&quot; Bottom &quot;15&quot;</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; Type   &quot;text&quot;</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+  ; The contents of this control must be set as follows in the pre function</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+  ; ${MUI_INSTALLOPTIONS_READ} $1 &quot;unconfirm.ini&quot; &quot;Field 2&quot; &quot;HWND&quot;</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+  ; SendMessage $1 ${WM_SETTEXT} 0 &quot;STR:$INSTDIR&quot;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; State  &quot;&quot;</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; Left   &quot;0&quot;</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; Right  &quot;-1&quot;</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; Top    &quot;17&quot;</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; Bottom &quot;30&quot;</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+  WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 2&quot; flags  &quot;READONLY&quot;</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+  ${If} &quot;$TmpVal&quot; == &quot;true&quot;</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 3&quot; Type   &quot;label&quot;</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 3&quot; Text   &quot;$(SUMMARY_REBOOT_REQUIRED_UNINSTALL)&quot;</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 3&quot; Left   &quot;0&quot;</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 3&quot; Right  &quot;-1&quot;</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 3&quot; Top    &quot;35&quot;</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Field 3&quot; Bottom &quot;45&quot;</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+    WriteINIStr &quot;$PLUGINSDIR\unconfirm.ini&quot; &quot;Settings&quot; NumFields &quot;3&quot;</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+  ${EndIf}</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+  !insertmacro MUI_HEADER_TEXT &quot;$(UN_CONFIRM_PAGE_TITLE)&quot; &quot;$(UN_CONFIRM_PAGE_SUBTITLE)&quot;</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+  ; The Summary custom page has a textbox that will automatically receive</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+  ; focus. This sets the focus to the Install button instead.</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+  !insertmacro MUI_INSTALLOPTIONS_INITDIALOG &quot;unconfirm.ini&quot;</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+  System::Call &quot;user32::SetFocus(i r0, i 0x0007, i,i)i&quot;</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+  ${MUI_INSTALLOPTIONS_READ} $1 &quot;unconfirm.ini&quot; &quot;Field 2&quot; &quot;HWND&quot;</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+  SendMessage $1 ${WM_SETTEXT} 0 &quot;STR:$INSTDIR&quot;</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+  !insertmacro MUI_INSTALLOPTIONS_SHOW</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+FunctionEnd</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+</span>
<a href="#l8.415"></a><span id="l8.415"> Function un.leaveConfirm</span>
<a href="#l8.416"></a><span id="l8.416">   ; Try to delete the app executable and if we can't delete it try to find the</span>
<a href="#l8.417"></a><span id="l8.417">   ; app's message window and prompt the user to close the app. This allows</span>
<a href="#l8.418"></a><span id="l8.418">   ; running an instance that is located in another directory. If for whatever</span>
<a href="#l8.419"></a><span id="l8.419">   ; reason there is no message window we will just rename the app's files and</span>
<a href="#l8.420"></a><span id="l8.420">   ; then remove them on restart if they are in use.</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-  StrCpy $TmpVal &quot;&quot;</span>
<a href="#l8.422"></a><span id="l8.422">   ClearErrors</span>
<a href="#l8.423"></a><span id="l8.423">   ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l8.424"></a><span id="l8.424">   ${If} ${Errors}</span>
<a href="#l8.425"></a><span id="l8.425">     ${un.ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_UNINSTALL)&quot;</span>
<a href="#l8.426"></a><span id="l8.426">   ${EndIf}</span>
<a href="#l8.427"></a><span id="l8.427"> FunctionEnd</span>
<a href="#l8.428"></a><span id="l8.428"> </span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+!ifndef NO_UNINSTALL_SURVEY</span>
<a href="#l8.430"></a><span id="l8.430"> Function un.preFinish</span>
<a href="#l8.431"></a><span id="l8.431">   ; Do not modify the finish page if there is a reboot pending</span>
<a href="#l8.432"></a><span id="l8.432">   ${Unless} ${RebootFlag}</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-!ifdef NO_UNINSTALL_SURVEY</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-    !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;settings&quot; &quot;NumFields&quot; &quot;3&quot;</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-!else</span>
<a href="#l8.436"></a><span id="l8.436">     ; When we add an optional action to the finish page the cancel button</span>
<a href="#l8.437"></a><span id="l8.437">     ; is enabled. This disables it and leaves the finish button as the</span>
<a href="#l8.438"></a><span id="l8.438">     ; only choice.</span>
<a href="#l8.439"></a><span id="l8.439">     !insertmacro MUI_INSTALLOPTIONS_WRITE &quot;ioSpecial.ini&quot; &quot;settings&quot; &quot;cancelenabled&quot; &quot;0&quot;</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-!endif</span>
<a href="#l8.441"></a><span id="l8.441">   ${EndUnless}</span>
<a href="#l8.442"></a><span id="l8.442"> FunctionEnd</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+!endif</span>
<a href="#l8.444"></a><span id="l8.444"> </span>
<a href="#l8.445"></a><span id="l8.445"> ################################################################################</span>
<a href="#l8.446"></a><span id="l8.446"> # Initialization Functions</span>
<a href="#l8.447"></a><span id="l8.447"> </span>
<a href="#l8.448"></a><span id="l8.448"> Function .onInit</span>
<a href="#l8.449"></a><span id="l8.449">   ${UninstallOnInitCommon}</span>
<a href="#l8.450"></a><span id="l8.450"> FunctionEnd</span>
<a href="#l8.451"></a><span id="l8.451"> </span>
<a href="#l8.452"></a><span id="l8.452"> Function un.onInit</span>
<a href="#l8.453"></a><span id="l8.453">   GetFullPathName $INSTDIR &quot;$INSTDIR\..&quot;</span>
<a href="#l8.454"></a><span id="l8.454">   ${un.GetLongPath} &quot;$INSTDIR&quot; $INSTDIR</span>
<a href="#l8.455"></a><span id="l8.455">   ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l8.456"></a><span id="l8.456">     Abort</span>
<a href="#l8.457"></a><span id="l8.457">   ${EndUnless}</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+</span>
<a href="#l8.459"></a><span id="l8.459">   StrCpy $LANGUAGE 0</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+  ${un.SetBrandNameVars} &quot;$INSTDIR\distribution\setup.ini&quot;</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+  ; Initialize $hHeaderBitmap to prevent redundant changing of the bitmap if</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+  ; the user clicks the back button</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+  StrCpy $hHeaderBitmap &quot;&quot;</span>
<a href="#l8.465"></a><span id="l8.465"> FunctionEnd</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+Function .onGUIEnd</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+  ${OnEndCommon}</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+FunctionEnd</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+Function un.onGUIEnd</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+  ${un.OnEndCommon}</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+FunctionEnd</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/locales/en-US/installer/custom.properties</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/locales/en-US/installer/custom.properties</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -70,24 +70,34 @@ SUMMARY_REBOOT_REQUIRED_UNINSTALL=A rest</span>
<a href="#l9.4"></a><span id="l9.4"> SUMMARY_CLICK=Click Install to continue.</span>
<a href="#l9.5"></a><span id="l9.5"> SURVEY_TEXT=&amp;Tell us what you thought of ${BrandShortName}</span>
<a href="#l9.6"></a><span id="l9.6"> LAUNCH_TEXT=&amp;Launch $(^Name) now</span>
<a href="#l9.7"></a><span id="l9.7"> WARN_APP_RUNNING_INSTALL=$(^Name) must be closed to proceed with the installation.\n\nClick &quot;OK&quot; to exit $(^Name) automatically and continue.</span>
<a href="#l9.8"></a><span id="l9.8"> CREATE_ICONS_DESC=Create icons for ${BrandShortName}:</span>
<a href="#l9.9"></a><span id="l9.9"> ICONS_DESKTOP=On my &amp;Desktop</span>
<a href="#l9.10"></a><span id="l9.10"> ICONS_STARTMENU=In my &amp;Start Menu Programs folder</span>
<a href="#l9.11"></a><span id="l9.11"> ICONS_QUICKLAUNCH=In my &amp;Quick Launch bar</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+WARN_MANUALLY_CLOSE_APP_INSTALL=$BrandShortName must be closed to proceed with the installation.\n\nPlease close $BrandShortName to continue.</span>
<a href="#l9.13"></a><span id="l9.13"> WARN_MANUALLY_CLOSE_APP_UNINSTALL=${BrandFullName} must be closed to proceed with the uninstall.\n\nPlease close ${BrandFullName} to continue.</span>
<a href="#l9.14"></a><span id="l9.14"> WARN_MANUALLY_CLOSE_APP_LAUNCH=${BrandFullName} is already running.\n\nPlease close ${BrandFullName} prior to launching the version you have just installed.</span>
<a href="#l9.15"></a><span id="l9.15"> WARN_WRITE_ACCESS=You don't have access to write to the installation directory.\n\nClick OK to select a different directory.</span>
<a href="#l9.16"></a><span id="l9.16"> WARN_DISK_SPACE=You don't have sufficient disk space to install to this location.\n\nClick OK to select a different location.</span>
<a href="#l9.17"></a><span id="l9.17"> WARN_UNSUPPORTED_MSG=Sorry, ${BrandShortName} can't be installed. This version of ${BrandShortName} requires ${MinUnsupportedVer} or newer.</span>
<a href="#l9.18"></a><span id="l9.18"> WARN_RESTART_REQUIRED_UNINSTALL=Your computer must be restarted to complete a previous uninstall of ${BrandShortName}. Do you want to reboot now?</span>
<a href="#l9.19"></a><span id="l9.19"> WARN_RESTART_REQUIRED_UPGRADE=Your computer must be restarted to complete a previous upgrade of ${BrandShortName}. Do you want to reboot now?</span>
<a href="#l9.20"></a><span id="l9.20"> ERROR_CREATE_DIRECTORY=Error creating directory:\n\n$0\n\nClick Cancel to stop the installation or\nRetry to try again.</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ERROR_CREATE_DIRECTORY_PREFIX=Error creating directory:</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+ERROR_CREATE_DIRECTORY_SUFFIX=Click Cancel to stop the installation or\nRetry to try again.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+UN_CONFIRM_PAGE_TITLE=Uninstall $BrandFullName</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+UN_CONFIRM_PAGE_SUBTITLE=Remove $BrandFullName from your computer.</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+UN_CONFIRM_UNINSTALLED_FROM=$BrandShortName will be uninstalled from the following location:</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+UN_CONFIRM_CLICK=Click Uninstall to continue.</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+BANNER_CHECK_EXISTING=Checking existing installation</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31"> STATUS_INSTALL_APP=Installing ${BrandShortName}</span>
<a href="#l9.32"></a><span id="l9.32"> STATUS_INSTALL_LANG=Installing Language Files (${AB_CD})</span>
<a href="#l9.33"></a><span id="l9.33"> STATUS_INSTALL_OPTIONAL=Installing Optional Components</span>
<a href="#l9.34"></a><span id="l9.34"> STATUS_UNINSTALL_MAIN=Uninstalling ${BrandShortName}</span>
<a href="#l9.35"></a><span id="l9.35"> STATUS_CLEANUP=Cleaning up the birdcage</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37"> # _DESC strings support approximately 65 characters per line.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

