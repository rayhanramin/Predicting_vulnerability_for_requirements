<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10770:ccab1c205bb0e6c48108418389c15870bff5f9ba</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ccab1c205bb0e6c48108418389c15870bff5f9ba" />
<meta property="og:url" content="/comm-central/rev/ccab1c205bb0e6c48108418389c15870bff5f9ba" />
<meta property="og:description" content="Fix bug 756052 - Adapt offline interfaces to avoid extra methods for providers - fix caldav listeners. r=redDragon" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ccab1c205bb0e6c48108418389c15870bff5f9ba 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ccab1c205bb0e6c48108418389c15870bff5f9ba">shortlog</a> |
<a href="/comm-central/log/ccab1c205bb0e6c48108418389c15870bff5f9ba">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ccab1c205bb0e6c48108418389c15870bff5f9ba">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ccab1c205bb0e6c48108418389c15870bff5f9ba">files</a> |
changeset |
<a href="/comm-central/raw-rev/ccab1c205bb0e6c48108418389c15870bff5f9ba">raw</a>  | <a href="/comm-central/archive/ccab1c205bb0e6c48108418389c15870bff5f9ba.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=756052">bug 756052</a> - Adapt offline interfaces to avoid extra methods for providers - fix caldav listeners. r=redDragon
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 30 Jul 2012 14:07:49 +0200</td></tr>

<tr>
 <td>changeset 10770</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ccab1c205bb0e6c48108418389c15870bff5f9ba">ccab1c205bb0e6c48108418389c15870bff5f9ba</a></td>
</tr>



<tr>
<td>parent 10769</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7aac2e3b3ef0bafd15768e2f25d94638466ce4cb">7aac2e3b3ef0bafd15768e2f25d94638466ce4cb</a>
</td>
</tr>

<tr>
<td>child 10771</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3a77dab67b90c825a3773bb6f99d262990f4b1ad">3a77dab67b90c825a3773bb6f99d262990f4b1ad</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ccab1c205bb0e6c48108418389c15870bff5f9ba">8094</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 30 Jul 2012 12:09:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ccab1c205bb0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ccab1c205bb0e6c48108418389c15870bff5f9ba">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ccab1c205bb0e6c48108418389c15870bff5f9ba&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ccab1c205bb0e6c48108418389c15870bff5f9ba&newProject=comm-central&newRevision=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ccab1c205bb0e6c48108418389c15870bff5f9ba&newProject=comm-central&newRevision=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ccab1c205bb0e6c48108418389c15870bff5f9ba&newProject=comm-central&newRevision=7aac2e3b3ef0bafd15768e2f25d94638466ce4cb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28redDragon%29&revcount=50">redDragon</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=756052">756052</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=756052">bug 756052</a> - Adapt offline interfaces to avoid extra methods for providers - fix caldav listeners. r=redDragon</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/ccab1c205bb0e6c48108418389c15870bff5f9ba/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -635,43 +635,54 @@ cal.ProviderBase.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">             if (--this.mBatchCount == 0) {</span>
<a href="#l1.5"></a><span id="l1.5">                 this.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l1.6"></a><span id="l1.6">             }</span>
<a href="#l1.7"></a><span id="l1.7">         } else {</span>
<a href="#l1.8"></a><span id="l1.8">             cal.ASSERT(this.mBatchCount &gt; 0, &quot;unexepcted endBatch!&quot;);</span>
<a href="#l1.9"></a><span id="l1.9">         }</span>
<a href="#l1.10"></a><span id="l1.10">     },</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    notifyOperationComplete: function cPB_notifyOperationComplete(aListener,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                                                                  aStatus,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                                                                  aOperationType,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-                                                                  aId,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-                                                                  aDetail) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    notifyPureOperationComplete: function cPB_notifyPureOperationComplete(aListener,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+                                                                          aStatus,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+                                                                          aOperationType,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+                                                                          aId,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+                                                                          aDetail) {</span>
<a href="#l1.22"></a><span id="l1.22">         if (aListener) {</span>
<a href="#l1.23"></a><span id="l1.23">             try {</span>
<a href="#l1.24"></a><span id="l1.24">                 aListener.onOperationComplete(this.superCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l1.25"></a><span id="l1.25">             } catch (exc) {</span>
<a href="#l1.26"></a><span id="l1.26">                 cal.ERROR(exc);</span>
<a href="#l1.27"></a><span id="l1.27">             }</span>
<a href="#l1.28"></a><span id="l1.28">         }</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    },</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    notifyOperationComplete: function cPB_notifyOperationComplete(aListener,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+                                                                  aStatus,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+                                                                  aOperationType,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+                                                                  aId,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                                                                  aDetail,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                                                                  aExtraMessage) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        this.notifyPureOperationComplete(aListener, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40">         if (aStatus == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l1.41"></a><span id="l1.41">             return; // cancellation doesn't change current status, no notification</span>
<a href="#l1.42"></a><span id="l1.42">         }</span>
<a href="#l1.43"></a><span id="l1.43">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l1.44"></a><span id="l1.44">             this.setProperty(&quot;currentStatus&quot;, aStatus);</span>
<a href="#l1.45"></a><span id="l1.45">         } else {</span>
<a href="#l1.46"></a><span id="l1.46">             if (aDetail instanceof Components.interfaces.nsIException) {</span>
<a href="#l1.47"></a><span id="l1.47">                 this.notifyError(aDetail); // will set currentStatus</span>
<a href="#l1.48"></a><span id="l1.48">             } else {</span>
<a href="#l1.49"></a><span id="l1.49">                 this.notifyError(aStatus, aDetail); // will set currentStatus</span>
<a href="#l1.50"></a><span id="l1.50">             }</span>
<a href="#l1.51"></a><span id="l1.51">             this.notifyError(aOperationType == Components.interfaces.calIOperationListener.GET</span>
<a href="#l1.52"></a><span id="l1.52">                              ? Components.interfaces.calIErrors.READ_FAILED</span>
<a href="#l1.53"></a><span id="l1.53">                              : Components.interfaces.calIErrors.MODIFICATION_FAILED,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-                             &quot;&quot;);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+                             aExtraMessage || &quot;&quot;);</span>
<a href="#l1.56"></a><span id="l1.56">         }</span>
<a href="#l1.57"></a><span id="l1.57">     },</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">     // for convenience also callable with just an exception</span>
<a href="#l1.60"></a><span id="l1.60">     notifyError: function cPB_notifyError(aErrNo, aMessage) {</span>
<a href="#l1.61"></a><span id="l1.61">         if (aErrNo == Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l1.62"></a><span id="l1.62">             return; // cancellation doesn't change current status, no notification</span>
<a href="#l1.63"></a><span id="l1.63">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -725,16 +725,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.5"></a><span id="l2.5">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l2.6"></a><span id="l2.6">             },</span>
<a href="#l2.7"></a><span id="l2.7">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.8"></a><span id="l2.8">                 if (isUnavailableCode(status)) {</span>
<a href="#l2.9"></a><span id="l2.9">                     // The item couldn't be added to the (remote) location,</span>
<a href="#l2.10"></a><span id="l2.10">                     // this is like being offline. Add the item to the cached</span>
<a href="#l2.11"></a><span id="l2.11">                     // calendar instead.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Calendar &quot; + calendar.name + &quot; is unavailable, adding item offline&quot;);</span>
<a href="#l2.13"></a><span id="l2.13">                     self.adoptOfflineItem(item, listener);</span>
<a href="#l2.14"></a><span id="l2.14">                 } else if (Components.isSuccessCode(status)) {</span>
<a href="#l2.15"></a><span id="l2.15">                     // On success, add the item to the cache.</span>
<a href="#l2.16"></a><span id="l2.16">                     self.mCachedCalendar.addItem(detail, listener);</span>
<a href="#l2.17"></a><span id="l2.17">                 } else if (listener) {</span>
<a href="#l2.18"></a><span id="l2.18">                     // Either an error occurred or this is a successful add</span>
<a href="#l2.19"></a><span id="l2.19">                     // to a cached calendar. Forward the call to the listener</span>
<a href="#l2.20"></a><span id="l2.20">                     listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -799,16 +800,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.22"></a><span id="l2.22">          * has performed the modification, see below: */</span>
<a href="#l2.23"></a><span id="l2.23">         let cacheListener = {</span>
<a href="#l2.24"></a><span id="l2.24">             onGetResult: function() {},</span>
<a href="#l2.25"></a><span id="l2.25">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.26"></a><span id="l2.26">                 if (isUnavailableCode(status)) {</span>
<a href="#l2.27"></a><span id="l2.27">                     // The item couldn't be modified at the (remote) location,</span>
<a href="#l2.28"></a><span id="l2.28">                     // this is like being offline. Add the item to the cache</span>
<a href="#l2.29"></a><span id="l2.29">                     // instead.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Calendar &quot; + calendar.name + &quot; is unavailable, modifying item offline&quot;);</span>
<a href="#l2.31"></a><span id="l2.31">                     self.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l2.32"></a><span id="l2.32">                 } else if (Components.isSuccessCode(status)) {</span>
<a href="#l2.33"></a><span id="l2.33">                     // On success, modify the item in the cache</span>
<a href="#l2.34"></a><span id="l2.34">                     self.mCachedCalendar.modifyItem(detail, oldItem, listener);</span>
<a href="#l2.35"></a><span id="l2.35">                 } else if (listener) {</span>
<a href="#l2.36"></a><span id="l2.36">                     // This happens on error, forward the error through the listener</span>
<a href="#l2.37"></a><span id="l2.37">                     listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l2.38"></a><span id="l2.38">                 }</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -879,16 +881,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.40"></a><span id="l2.40">         // has performed the modification, see below:</span>
<a href="#l2.41"></a><span id="l2.41">         var cacheListener = {</span>
<a href="#l2.42"></a><span id="l2.42">             onGetResult: function() {},</span>
<a href="#l2.43"></a><span id="l2.43">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.44"></a><span id="l2.44">                 if (isUnavailableCode(status)) {</span>
<a href="#l2.45"></a><span id="l2.45">                     // The item couldn't be deleted at the (remote) location,</span>
<a href="#l2.46"></a><span id="l2.46">                     // this is like being offline. Mark the item deleted in the</span>
<a href="#l2.47"></a><span id="l2.47">                     // cache instead.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Calendar &quot; + calendar.name + &quot; is unavailable, deleting item offline&quot;);</span>
<a href="#l2.49"></a><span id="l2.49">                     self.deleteOfflineItem(item, listener);</span>
<a href="#l2.50"></a><span id="l2.50">                 } else if (Components.isSuccessCode(status)) {</span>
<a href="#l2.51"></a><span id="l2.51">                     // On success, delete the item from the cache</span>
<a href="#l2.52"></a><span id="l2.52">                     self.mCachedCalendar.deleteItem(item, listener);</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">                     // Also, remove any meta data associated with the item</span>
<a href="#l2.55"></a><span id="l2.55">                     try {</span>
<a href="#l2.56"></a><span id="l2.56">                         let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calISyncWriteCalendar);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -17,16 +17,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> const xmlHeader = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> const davNS = &quot;DAV:&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> const caldavNS = &quot;urn:ietf:params:xml:ns:caldav&quot;;</span>
<a href="#l3.9"></a><span id="l3.9"> const calservNS = &quot;http://calendarserver.org/ns/&quot;;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+const cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> function caldavNSResolver(prefix) {</span>
<a href="#l3.15"></a><span id="l3.15">     const ns = {</span>
<a href="#l3.16"></a><span id="l3.16">         D: davNS,</span>
<a href="#l3.17"></a><span id="l3.17">         C: caldavNS,</span>
<a href="#l3.18"></a><span id="l3.18">         CS: calservNS</span>
<a href="#l3.19"></a><span id="l3.19">     };</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -511,93 +512,101 @@ calDavCalendar.prototype = {</span>
<a href="#l3.22"></a><span id="l3.22">     doAdoptItem: function caldav_doAdoptItem(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l3.23"></a><span id="l3.23">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l3.24"></a><span id="l3.24">             aItem.id = cal.getUUID();</span>
<a href="#l3.25"></a><span id="l3.25">         }</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">         if (aItem.id == null) {</span>
<a href="#l3.28"></a><span id="l3.28">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.29"></a><span id="l3.29">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+                                         cIOL.ADD,</span>
<a href="#l3.32"></a><span id="l3.32">                                          aItem.id,</span>
<a href="#l3.33"></a><span id="l3.33">                                          &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l3.34"></a><span id="l3.34">             return;</span>
<a href="#l3.35"></a><span id="l3.35">         }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">         if (!isItemSupported(aItem, this)) {</span>
<a href="#l3.38"></a><span id="l3.38">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.39"></a><span id="l3.39">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                                         cIOL.ADD,</span>
<a href="#l3.42"></a><span id="l3.42">                                          aItem.id,</span>
<a href="#l3.43"></a><span id="l3.43">                                          &quot;Server does not support item type&quot;);</span>
<a href="#l3.44"></a><span id="l3.44">             return;</span>
<a href="#l3.45"></a><span id="l3.45">         }</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">         let parentItem = aItem.parentItem;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-        var locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-        var itemUri = this.makeUri(locationPath);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+        parentItem.calendar = this.superCalendar;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+        let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        let itemUri = this.makeUri(locationPath);</span>
<a href="#l3.54"></a><span id="l3.54">         cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-        var addListener = {};</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l3.59"></a><span id="l3.59">         let serializedItem = this.getSerializedItem(aItem);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-        addListener.onStreamComplete =</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-            function onPutComplete(aLoader, aContext, aStatus, aResultLength,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-                                   aResult) {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-            let status;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-            try {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-                status = request.responseStatus;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-            } catch (ex) {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-                status = Components.interfaces.calIErrors.DAV_PUT_ERROR;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-            }</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-            if (thisCalendar.verboseLogging()) {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-            }</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-            // 201 = HTTP &quot;Created&quot;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-            // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-            if (status == 201 || status == 204) {</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-                cal.LOG(&quot;CalDAV: Item added to &quot; + thisCalendar.name + &quot; successfully&quot;);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+        let addListener = {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+            onStreamComplete: function onPutComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+                let listenerDetail = parentItem;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+                try {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+                    var responseStatus = request.responseStatus;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+                        cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+                    }</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                } catch (ex) {</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+                    listenerStatus = ex.result</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+                    listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+                }</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+                // Translate the HTTP status code to a status and message for the listener</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+                if (responseStatus == 201 || responseStatus == 204) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+                    // 201 = HTTP &quot;Created&quot;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+                    // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Item added to &quot; + thisCalendar.name + &quot; successfully&quot;);</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+                    // TODO: onOpComplete adds the item to the cache, probably after getUpdatedItem!</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-                // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-                // for instance) so we'd best re-fetch in order to know</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-                // the current state of the item</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-                // Observers will be notified in getUpdatedItem()</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-                thisCalendar.getUpdatedItem(parentItem, aListener);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-                cal.LOG(&quot;[calDavCalendar] Server unavailability code received. Items are being put into cache for a later try&quot;);</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-                aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-                                              Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-                                              Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-                                              parentItem.id,</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-                                              parentItem);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-            } else {</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-                if (status &gt; 999) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-                    status = &quot;0x&quot; + status.toString(16);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+                    // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+                    // for instance) so we'd best re-fetch in order to know</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+                    // the current state of the item</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+                    // Observers will be notified in getUpdatedItem()</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+                    thisCalendar.getUpdatedItem(parentItem, aListener);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+                    return;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+                } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+                } else if (responseStatus) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+                    // There is a response status, but we haven't handled it yet. Any</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+                    // error occurring here should consider being handled!</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+                    cal.ERROR(&quot;CalDAV: Unexpected status adding item to &quot; +</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                              thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+                              serializedItem);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.138"></a><span id="l3.138">                 }</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-                let responseBody=&quot;&quot;;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-                try {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-                    responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-                } catch (e) {}</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+                // Still need to visually notify for uncached calendars.</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+                if (!thisCalendar.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+                    thisCalendar.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+                }</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-                cal.ERROR(&quot;CalDAV: Unexpected status adding item to &quot; +</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-                          thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-                          responseBody + &quot;\n&quot; +</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-                          serializedItem);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-                // TODO why is no listener called here?</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-                thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR,</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-                                            status,</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-                                            responseBody);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+                // Finally, notify listener.</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+                thisCalendar.notifyPureOperationComplete(aListener,</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+                                                         listenerStatus,</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+                                                         cIOL.ADD,</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+                                                         parentItem.id,</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+                                                         listenerDetail);</span>
<a href="#l3.164"></a><span id="l3.164">             }</span>
<a href="#l3.165"></a><span id="l3.165">         };</span>
<a href="#l3.166"></a><span id="l3.166"> </span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-        parentItem.calendar = this.superCalendar;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-</span>
<a href="#l3.169"></a><span id="l3.169">         let httpchannel = cal.prepHttpChannel(itemUri,</span>
<a href="#l3.170"></a><span id="l3.170">                                               serializedItem,</span>
<a href="#l3.171"></a><span id="l3.171">                                               &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l3.172"></a><span id="l3.172">                                               this);</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174">         if (!aIgnoreEtag) {</span>
<a href="#l3.175"></a><span id="l3.175">             httpchannel.setRequestHeader(&quot;If-None-Match&quot;, &quot;*&quot;, false);</span>
<a href="#l3.176"></a><span id="l3.176">         }</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineat">@@ -623,17 +632,17 @@ calDavCalendar.prototype = {</span>
<a href="#l3.178"></a><span id="l3.178">      * @param aOldItem    previous version of item to be modified</span>
<a href="#l3.179"></a><span id="l3.179">      * @param aListener   listener from original request</span>
<a href="#l3.180"></a><span id="l3.180">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l3.181"></a><span id="l3.181">      */</span>
<a href="#l3.182"></a><span id="l3.182">     doModifyItem: function caldav_doModifyItem(aNewItem, aOldItem, aListener, aIgnoreEtag){</span>
<a href="#l3.183"></a><span id="l3.183">         if (aNewItem.id == null) {</span>
<a href="#l3.184"></a><span id="l3.184">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.185"></a><span id="l3.185">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+                                         cIOL.MODIFY,</span>
<a href="#l3.188"></a><span id="l3.188">                                          aItem.id,</span>
<a href="#l3.189"></a><span id="l3.189">                                          &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l3.190"></a><span id="l3.190">             return;</span>
<a href="#l3.191"></a><span id="l3.191">         }</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193">         let wasInboxItem = this.mItemInfoCache[aNewItem.id].isInboxItem;</span>
<a href="#l3.194"></a><span id="l3.194"> </span>
<a href="#l3.195"></a><span id="l3.195">         let newItem_ = aNewItem;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineat">@@ -644,75 +653,83 @@ calDavCalendar.prototype = {</span>
<a href="#l3.197"></a><span id="l3.197">         aNewItem.generation += 1;</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199">         var eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l3.200"></a><span id="l3.200"> </span>
<a href="#l3.201"></a><span id="l3.201">         var thisCalendar = this;</span>
<a href="#l3.202"></a><span id="l3.202"> </span>
<a href="#l3.203"></a><span id="l3.203">         var modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l3.204"></a><span id="l3.204"> </span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-        var modListener = {};</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-        modListener.onStreamComplete =</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-            function caldav_mod_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-                                                 aResultLength, aResult) {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-            // 200 = HTTP &quot;OK&quot;</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-            // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-            //</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-            let status;</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-            try {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-                status = request.responseStatus;</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-            } catch (ex) {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-                status = Components.interfaces.calIErrors.DAV_PUT_ERROR;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-            }</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+        let modListener = {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+            onStreamComplete: function caldav_mod_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+                                                                   aResultLength, aResult) {</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+                let listenerDetail = aNewItem;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+                try {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+                    var responseStatus = request.responseStatus;</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-            // We should not accept a 201 status here indefinitely: it indicates a server error</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-            // of some kind that we want to know about. It's convenient to accept it for now</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-            // since a number of server impls don't get this right yet.</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-            if (status == 204 || status == 201 || status == 200) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-                cal.LOG(&quot;CalDAV: Item modified successfully on &quot; + thisCalendar.name);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-                // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-                // for instance) so we'd best re-fetch in order to know</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-                // the current state of the item</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-                // Observers will be notified in getUpdatedItem()</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-                thisCalendar.getUpdatedItem(aNewItem, aListener);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-                // SOGo has calendarUri == inboxUri so we need to be careful</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-                // about deletions</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-                if (wasInboxItem &amp;&amp; thisCalendar.mShouldPollInbox) {</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-                    thisCalendar.doDeleteItem(aNewItem, null, true, true, null);</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-                }</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-            } else if (status == 412 || status == 409) {</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-                thisCalendar.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-                                             aListener, aOldItem);</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-                cal.LOG(&quot;[calDavCalendar] doModifyItem received status code of server unavailibity. Putting entry in cache for later try.&quot;);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-                aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-                                              Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-                                              Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-                                              aNewItem.id,</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-                                              aNewItem);</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-            } else {</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-                if (status &gt; 999) {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-                    status = &quot;0x &quot; + status.toString(16);</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+                       let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+                       cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+                    }</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+                } catch (ex) {</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+                    listenerStatus = ex.result</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+                    listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l3.264"></a><span id="l3.264">                 }</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-                let responseBody=&quot;&quot;;</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-                try {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-                    responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-                } catch (e) {}</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+                if (responseStatus == 204 || responseStatus == 201 || responseStatus == 200) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+                    // We should not accept a 201 status here indefinitely: it indicates a server error</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+                    // of some kind that we want to know about. It's convenient to accept it for now</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+                    // since a number of server impls don't get this right yet.</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Item modified successfully on &quot; + thisCalendar.name);</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+                    // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+                    // for instance) so we'd best re-fetch in order to know</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+                    // the current state of the item</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+                    // Observers will be notified in getUpdatedItem()</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+                    thisCalendar.getUpdatedItem(aNewItem, aListener);</span>
<a href="#l3.281"></a><span id="l3.281"> </span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-                cal.ERROR(&quot;CalDAV: Unexpected status modifying item to &quot; +</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-                        thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-                        responseBody + &quot;\n&quot; +</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-                        modifiedItemICS);</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+                    // SOGo has calendarUri == inboxUri so we need to be careful</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+                    // about deletions</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+                    if (wasInboxItem &amp;&amp; thisCalendar.mShouldPollInbox) {</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+                        thisCalendar.doDeleteItem(aNewItem, null, true, true, null);</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+                    }</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+                    return;</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+                } else if (responseStatus == 412 || responseStatus == 409) {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+                    // promptOverwrite will ask the user and then re-request</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+                    thisCalendar.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+                                                 aListener, aOldItem);</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+                    return;</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+                } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+                } else if (responseStatus) {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+                    // There is a response status, but we haven't handled it yet. Any</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+                    // error occurring here should consider being handled!</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+                    cal.ERROR(&quot;CalDAV: Unexpected status modifying item to &quot; +</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+                            thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+                            modifiedItemICS);</span>
<a href="#l3.306"></a><span id="l3.306"> </span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-                // TODO why is the listener not notified?</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-                thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR,</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-                                            status,</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-                                            responseBody);</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+                }</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+                // Still need to visually notify for uncached calendars.</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+                if (!thisCalendar.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+                    thisCalendar.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+                }</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+                // Finally, notify listener.</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+                thisCalendar.notifyPureOperationComplete(aListener,</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+                                                         listenerStatus,</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+                                                         cIOL.MODIFY,</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+                                                         aNewItem.id,</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+                                                         listenerDetail);</span>
<a href="#l3.326"></a><span id="l3.326">             }</span>
<a href="#l3.327"></a><span id="l3.327">         };</span>
<a href="#l3.328"></a><span id="l3.328"> </span>
<a href="#l3.329"></a><span id="l3.329">         let httpchannel = cal.prepHttpChannel(eventUri,</span>
<a href="#l3.330"></a><span id="l3.330">                                               modifiedItemICS,</span>
<a href="#l3.331"></a><span id="l3.331">                                               &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l3.332"></a><span id="l3.332">                                               this);</span>
<a href="#l3.333"></a><span id="l3.333"> </span>
<a href="#l3.334"></a><span id="l3.334" class="difflineat">@@ -744,124 +761,155 @@ calDavCalendar.prototype = {</span>
<a href="#l3.335"></a><span id="l3.335">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l3.336"></a><span id="l3.336">      * @param aFromInbox  delete from inbox rather than calendar</span>
<a href="#l3.337"></a><span id="l3.337">      * @param aUri        uri of item to delete</span>
<a href="#l3.338"></a><span id="l3.338">      * */</span>
<a href="#l3.339"></a><span id="l3.339">     doDeleteItem: function caldav_doDeleteItem(aItem, aListener, aIgnoreEtag, aFromInbox, aUri){</span>
<a href="#l3.340"></a><span id="l3.340">         if (aItem.id == null) {</span>
<a href="#l3.341"></a><span id="l3.341">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.342"></a><span id="l3.342">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+                                         cIOL.DELETE,</span>
<a href="#l3.345"></a><span id="l3.345">                                          aItem.id,</span>
<a href="#l3.346"></a><span id="l3.346">                                          &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l3.347"></a><span id="l3.347">             return;</span>
<a href="#l3.348"></a><span id="l3.348">         }</span>
<a href="#l3.349"></a><span id="l3.349"> </span>
<a href="#l3.350"></a><span id="l3.350">         var eventUri;</span>
<a href="#l3.351"></a><span id="l3.351">         if (aUri) {</span>
<a href="#l3.352"></a><span id="l3.352">             eventUri = aUri;</span>
<a href="#l3.353"></a><span id="l3.353">         } else if (aFromInbox || this.mItemInfoCache[aItem.id].isInboxItem) {</span>
<a href="#l3.354"></a><span id="l3.354">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath, this.mInboxUrl);</span>
<a href="#l3.355"></a><span id="l3.355">         } else {</span>
<a href="#l3.356"></a><span id="l3.356">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath);</span>
<a href="#l3.357"></a><span id="l3.357">         }</span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-        var delListener = {};</span>
<a href="#l3.360"></a><span id="l3.360">         var thisCalendar = this;</span>
<a href="#l3.361"></a><span id="l3.361"> </span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-        delListener.onStreamComplete =</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-        function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-            let status;</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-            try {</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-                status = request.responseStatus;</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-            } catch (ex) {</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-                status = Components.interfaces.calIErrors.DAV_REMOVE_ERROR;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-            }</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+        let delListener = {</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+            onStreamComplete: function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+                let listenerDetail = aItem;</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+                try {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+                    var responseStatus = request.responseStatus;</span>
<a href="#l3.378"></a><span id="l3.378"> </span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-            // 204 = HTTP &quot;No content&quot;</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-            // 404 = Not Found - This is kind of a success, since the item is already deleted.</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-            //</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-            if (status == 204 || status == 200 || status == 404) {</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-                if (!aFromInbox) {</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-                    if (thisCalendar.isCached) {</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-                        // the item is deleted in the storage calendar from calCachedCalendar</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-                        aListener.onOperationComplete(thisCalendar, status,</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-                                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-                                                         aItem.id, aItem);</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-                    } else {</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-                        thisCalendar.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+                        cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l3.394"></a><span id="l3.394">                     }</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-                    let decodedPath = thisCalendar.ensureDecodedPath(eventUri.path);</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-                    delete thisCalendar.mHrefIndex[decodedPath];</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-                    delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Item deleted successfully from calendar&quot; + thisCalendar.name);</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+                } catch (ex) {</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+                    listenerStatus = ex.result</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+                    listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Request error during delete: &quot; + ex);</span>
<a href="#l3.403"></a><span id="l3.403">                 }</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-            } else if (status == 412 || status == 409) {</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-                // item has either been modified or deleted by someone else check to see which</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-                let httpchannel2 = cal.prepHttpChannel(eventUri,</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-                                                       null,</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-                                                       null,</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-                                                       thisCalendar);</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-                httpchannel2.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-                cal.sendHttpRequest(cal.createStreamLoader(), httpchannel2, delListener2);</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-                cal.LOG(&quot;[calDavCalendar] Remote Calendar &quot; + thisCalendar.name + &quot; is currently unavailabile. Putting entry in cache for a later try.&quot;);</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-                aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-                                              Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-                                              Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-                                              aItem.id,</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-                                              aItem);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-            } else {</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-                let responseBody=&quot;&quot;;</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-                try {</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-                    responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-                } catch (e) {}</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+                // 204 = HTTP &quot;No content&quot;</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+                // 404 = Not Found - This is kind of a success, since the item is already deleted.</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+                //</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+                if (responseStatus == 204 || responseStatus == 200 || responseStatus == 404) {</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+                    if (!aFromInbox) {</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+                        let decodedPath = thisCalendar.ensureDecodedPath(eventUri.path);</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+                        delete thisCalendar.mHrefIndex[decodedPath];</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+                        delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+                        cal.LOG(&quot;CalDAV: Item deleted successfully from calendar &quot; + thisCalendar.name);</span>
<a href="#l3.434"></a><span id="l3.434"> </span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-                // TODO why are listeners not notified?</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-                cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-                          thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-                          responseBody + &quot;\n&quot; +</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-                          &quot;uri: &quot; + eventUri.spec);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+                        if (!thisCalendar.isCached) {</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+                            // If the calendar is not cached, we need to remove</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+                            // the item from our memory calendar now. The</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+                            // listeners will be notified there.</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+                            thisCalendar.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+                            return;</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+                        }</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+                    }</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+                } else if (responseStatus == 412 || responseStatus == 409) {</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+                    // item has either been modified or deleted by someone else check to see which</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Item has been modified on server, checking if it has been deleted&quot;);</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+                    let httpchannel2 = cal.prepHttpChannel(eventUri,</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+                                                           null,</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+                                                           null,</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+                                                           thisCalendar);</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+                    httpchannel2.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+                    cal.sendHttpRequest(cal.createStreamLoader(), httpchannel2, delListener2);</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+                    return;</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+                } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+                } else if (responseStatus) {</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+                    cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+                              thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+                              &quot;uri: &quot; + eventUri.spec);</span>
<a href="#l3.465"></a><span id="l3.465"> </span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-                thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_REMOVE_ERROR,</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-                                            status,</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-                                            responseBody);</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+                }</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+                // Still need to visually notify for uncached calendars.</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+                if (!thisCalendar.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+                    thisCalendar.reportDavError(calIErrors.DAV_REMOVE_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+                }</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+                // Finally, notify listener.</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+                thisCalendar.notifyPureOperationComplete(aListener,</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+                                                         listenerStatus,</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+                                                         cIOL.DELETE,</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+                                                         aItem.id,</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+                                                         listenerDetail);</span>
<a href="#l3.484"></a><span id="l3.484">             }</span>
<a href="#l3.485"></a><span id="l3.485">         };</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-        var delListener2 = {};</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-        delListener2.onStreamComplete =</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-            function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+        let delListener2 = {</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+            onStreamComplete: function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l3.492"></a><span id="l3.492">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-                let status = request.responseStatus;</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-                if (status == 404) {</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-                    // someone else already deleted it</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-                    // TODO don't we have to notify observers?</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+                let listenerStatus = Components.results.NS_OK;</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+                let listenerDetail = aItem;</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+                try {</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+                    var responseStatus = request.responseStatus;</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+                        cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+                    }</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+                } catch (ex) {</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+                    listenerStatus = ex.result</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+                    listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+                }</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+                if (responseStatus == 404) {</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+                    // Nothing to do (except notify the listener below)</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+                    // Someone else has already deleted it</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+                } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+                    listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+                    listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+                } else if (responseStatus) {</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+                    // The item still exists. We need to ask the user if he</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+                    // really wants to delete the item. Remember, we only</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+                    // made this request since the actual delete gave 409/412</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+                    thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem, aListener, null);</span>
<a href="#l3.523"></a><span id="l3.523">                     return;</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-                } else if (status &gt;= 500 &amp;&amp; status &lt;= 510) {</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-                    cal.LOG(&quot;[calDavCalendar] doDeleteItem recd status response of remote calendar unavailability. Putting entry in cache for a later try.&quot;);</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-                    aListener.onOperationComplete(thisCalendar.superCalendar,</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-                                                  Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-                                                  Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-                                                  aItem.id,</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-                                                  aItem);</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-                } else {</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-                    thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem, aListener, null);</span>
<a href="#l3.533"></a><span id="l3.533">                 }</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-            };</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+                // Finally, notify listener.</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+                thisCalendar.notifyPureOperationComplete(aListener,</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+                                                         listenerStatus,</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+                                                         cIOL.DELETE,</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+                                                         aItem.id,</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+                                                         listenerDetail);</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+            }</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+        };</span>
<a href="#l3.544"></a><span id="l3.544"> </span>
<a href="#l3.545"></a><span id="l3.545">         if (this.verboseLogging()) {</span>
<a href="#l3.546"></a><span id="l3.546">             cal.LOG(&quot;CalDAV: Deleting &quot; + eventUri.spec);</span>
<a href="#l3.547"></a><span id="l3.547">         }</span>
<a href="#l3.548"></a><span id="l3.548"> </span>
<a href="#l3.549"></a><span id="l3.549">         let httpchannel = cal.prepHttpChannel(eventUri, null, null, this);</span>
<a href="#l3.550"></a><span id="l3.550">         if (!aIgnoreEtag) {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-            httpchannel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-                                         this.mItemInfoCache[aItem.id].etag,</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-                                         false);</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+            let etag = this.mItemInfoCache[aItem.id].etag;</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+            cal.LOG(&quot;CalDAV: Will only delete if matches etag &quot; + etag);</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+            httpchannel.setRequestHeader(&quot;If-Match&quot;, etag, false);</span>
<a href="#l3.557"></a><span id="l3.557">         }</span>
<a href="#l3.558"></a><span id="l3.558">         httpchannel.requestMethod = &quot;DELETE&quot;;</span>
<a href="#l3.559"></a><span id="l3.559"> </span>
<a href="#l3.560"></a><span id="l3.560">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, delListener);</span>
<a href="#l3.561"></a><span id="l3.561">     },</span>
<a href="#l3.562"></a><span id="l3.562"> </span>
<a href="#l3.563"></a><span id="l3.563">     /**</span>
<a href="#l3.564"></a><span id="l3.564">      * Add an item to the target calendar</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineat">@@ -934,35 +982,50 @@ calDavCalendar.prototype = {</span>
<a href="#l3.566"></a><span id="l3.566">             this.mItemInfoCache[item.id] = { isNew: true };</span>
<a href="#l3.567"></a><span id="l3.567">         }</span>
<a href="#l3.568"></a><span id="l3.568">         this.mItemInfoCache[item.id].locationPath = locationPath;</span>
<a href="#l3.569"></a><span id="l3.569">         this.mItemInfoCache[item.id].isInboxItem = isInboxItem;</span>
<a href="#l3.570"></a><span id="l3.570"> </span>
<a href="#l3.571"></a><span id="l3.571">         this.mHrefIndex[path] = item.id;</span>
<a href="#l3.572"></a><span id="l3.572">         this.mItemInfoCache[item.id].etag = etag;</span>
<a href="#l3.573"></a><span id="l3.573"> </span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+        let needsAddModify = false;</span>
<a href="#l3.575"></a><span id="l3.575">         if (this.isCached) {</span>
<a href="#l3.576"></a><span id="l3.576">             this.setMetaData(item.id, path, etag, isInboxItem);</span>
<a href="#l3.577"></a><span id="l3.577"> </span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-            // In the cached case, notifying operation complete will add the item to the cache</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-            if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-                this.notifyOperationComplete(aListener,</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-                                             Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-                                             item.id,</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-                                             item);</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+            // If we have a listener, then the caller will take care of adding the item</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+            // Otherwise, we have to do it ourself</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+            // XXX This is quite fragile, but saves us a double modify/add</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+            if (aListener) {</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+                // In the cached case, notifying operation complete will add the item to the cache</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+                if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+                    this.notifyOperationComplete(aListener,</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+                                                 Components.results.NS_OK,</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+                                                 cIOL.ADD,</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+                                                 item.id,</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+                                                 item);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+                } else {</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+                    this.notifyOperationComplete(aListener,</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+                                                 Components.results.NS_OK,</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+                                                 cIOL.MODIFY,</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+                                                 item.id,</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+                                                 item);</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+                }</span>
<a href="#l3.604"></a><span id="l3.604">             } else {</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-                this.notifyOperationComplete(aListener,</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-                                             Components.results.NS_OK,</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-                                             Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-                                             item.id,</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-                                             item);</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+                // No listener, we'll have to add it ourselves</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+                needsAddModify = true;</span>
<a href="#l3.612"></a><span id="l3.612">             }</span>
<a href="#l3.613"></a><span id="l3.613">         } else {</span>
<a href="#l3.614"></a><span id="l3.614">             // In the uncached case, we need to do so ourselves</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+            needsAddModify = true;</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+        }</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+        // Now take care of the add/modify if needed.</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+        if (needsAddModify) {</span>
<a href="#l3.620"></a><span id="l3.620">             if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l3.621"></a><span id="l3.621">                 this.mOfflineStorage.adoptItem(item, aListener);</span>
<a href="#l3.622"></a><span id="l3.622">             } else {</span>
<a href="#l3.623"></a><span id="l3.623">                 this.mOfflineStorage.modifyItem(item, null, aListener);</span>
<a href="#l3.624"></a><span id="l3.624">             }</span>
<a href="#l3.625"></a><span id="l3.625">         }</span>
<a href="#l3.626"></a><span id="l3.626">     },</span>
<a href="#l3.627"></a><span id="l3.627"> </span>
<a href="#l3.628"></a><span id="l3.628" class="difflineat">@@ -1058,27 +1121,27 @@ calDavCalendar.prototype = {</span>
<a href="#l3.629"></a><span id="l3.629">          if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l3.630"></a><span id="l3.630">              aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l3.631"></a><span id="l3.631">                                          Components.results.NS_ERROR_FAILURE);</span>
<a href="#l3.632"></a><span id="l3.632">          }</span>
<a href="#l3.633"></a><span id="l3.633"> </span>
<a href="#l3.634"></a><span id="l3.634">          // Notify operation listener</span>
<a href="#l3.635"></a><span id="l3.635">          this.notifyOperationComplete(aListener,</span>
<a href="#l3.636"></a><span id="l3.636">                                       Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+                                      cIOL.GET,</span>
<a href="#l3.639"></a><span id="l3.639">                                       null,</span>
<a href="#l3.640"></a><span id="l3.640">                                       errorMsg);</span>
<a href="#l3.641"></a><span id="l3.641">          // If an error occurrs here, we also need to unqueue the</span>
<a href="#l3.642"></a><span id="l3.642">          // requests previously queued.</span>
<a href="#l3.643"></a><span id="l3.643">          while (this.mQueuedQueries.length) {</span>
<a href="#l3.644"></a><span id="l3.644">              let [,,,,listener] = this.mQueuedQueries.pop();</span>
<a href="#l3.645"></a><span id="l3.645">              try {</span>
<a href="#l3.646"></a><span id="l3.646">                  listener.onOperationComplete(this.superCalendar,</span>
<a href="#l3.647"></a><span id="l3.647">                                               Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-                                              Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+                                              cIOL.GET,</span>
<a href="#l3.650"></a><span id="l3.650">                                               null,</span>
<a href="#l3.651"></a><span id="l3.651">                                               errorMsg);</span>
<a href="#l3.652"></a><span id="l3.652">              } catch (e) {</span>
<a href="#l3.653"></a><span id="l3.653">                  cal.ERROR(e);</span>
<a href="#l3.654"></a><span id="l3.654">              }</span>
<a href="#l3.655"></a><span id="l3.655">          }</span>
<a href="#l3.656"></a><span id="l3.656">      },</span>
<a href="#l3.657"></a><span id="l3.657"> </span>
<a href="#l3.658"></a><span id="l3.658" class="difflineat">@@ -1089,17 +1152,17 @@ calDavCalendar.prototype = {</span>
<a href="#l3.659"></a><span id="l3.659">      * @param aItem       item to fetch</span>
<a href="#l3.660"></a><span id="l3.660">      * @param aListener   listener for method completion</span>
<a href="#l3.661"></a><span id="l3.661">      */</span>
<a href="#l3.662"></a><span id="l3.662">     getUpdatedItem: function caldav_getUpdatedItem(aItem, aListener, aChangeLogListener) {</span>
<a href="#l3.663"></a><span id="l3.663"> </span>
<a href="#l3.664"></a><span id="l3.664">         if (aItem == null) {</span>
<a href="#l3.665"></a><span id="l3.665">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.666"></a><span id="l3.666">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-                                         Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+                                         cIOL.GET,</span>
<a href="#l3.669"></a><span id="l3.669">                                          null,</span>
<a href="#l3.670"></a><span id="l3.670">                                          &quot;passed in null item&quot;);</span>
<a href="#l3.671"></a><span id="l3.671">             return;</span>
<a href="#l3.672"></a><span id="l3.672">         }</span>
<a href="#l3.673"></a><span id="l3.673"> </span>
<a href="#l3.674"></a><span id="l3.674">         let locationPath = this.getItemLocationPath(aItem);</span>
<a href="#l3.675"></a><span id="l3.675">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l3.676"></a><span id="l3.676"> </span>
<a href="#l3.677"></a><span id="l3.677" class="difflineat">@@ -1123,17 +1186,17 @@ calDavCalendar.prototype = {</span>
<a href="#l3.678"></a><span id="l3.678">     getItems: function caldav_getItems(aItemFilter, aCount, aRangeStart,</span>
<a href="#l3.679"></a><span id="l3.679">                                        aRangeEnd, aListener) {</span>
<a href="#l3.680"></a><span id="l3.680">         if (this.isCached) {</span>
<a href="#l3.681"></a><span id="l3.681">             if (this.mOfflineStorage) {</span>
<a href="#l3.682"></a><span id="l3.682">                 this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l3.683"></a><span id="l3.683">             } else {</span>
<a href="#l3.684"></a><span id="l3.684">                 this.notifyOperationComplete(aListener,</span>
<a href="#l3.685"></a><span id="l3.685">                                              Components.results.NS_OK,</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-                                             Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+                                             cIOL.GET,</span>
<a href="#l3.688"></a><span id="l3.688">                                              null,</span>
<a href="#l3.689"></a><span id="l3.689">                                              null);</span>
<a href="#l3.690"></a><span id="l3.690">             }</span>
<a href="#l3.691"></a><span id="l3.691">         } else {</span>
<a href="#l3.692"></a><span id="l3.692">             if (!this.mCheckedServerInfo) {</span>
<a href="#l3.693"></a><span id="l3.693">                 this.mQueuedQueries.push(arguments);</span>
<a href="#l3.694"></a><span id="l3.694">             } else {</span>
<a href="#l3.695"></a><span id="l3.695">                 this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineat">@@ -2003,28 +2066,27 @@ calDavCalendar.prototype = {</span>
<a href="#l3.697"></a><span id="l3.697">         var mapModification = {};</span>
<a href="#l3.698"></a><span id="l3.698">         mapModification[Components.interfaces.calIErrors.DAV_NOT_DAV] = false;</span>
<a href="#l3.699"></a><span id="l3.699">         mapModification[Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV] = false;</span>
<a href="#l3.700"></a><span id="l3.700">         mapModification[Components.interfaces.calIErrors.DAV_PUT_ERROR] = true;</span>
<a href="#l3.701"></a><span id="l3.701">         mapModification[Components.interfaces.calIErrors.DAV_REMOVE_ERROR] = true;</span>
<a href="#l3.702"></a><span id="l3.702">         mapModification[Components.interfaces.calIErrors.DAV_REPORT_ERROR] = false;</span>
<a href="#l3.703"></a><span id="l3.703"> </span>
<a href="#l3.704"></a><span id="l3.704">         var message = mapError[aErrNo];</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+        var localizedMessage;</span>
<a href="#l3.706"></a><span id="l3.706">         var modificationError = mapModification[aErrNo];</span>
<a href="#l3.707"></a><span id="l3.707"> </span>
<a href="#l3.708"></a><span id="l3.708">         if (!message) {</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-            // If we don't have a message for this, then its not important</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-            // enough to notify.</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+            // Only notify if there is a message for this error</span>
<a href="#l3.712"></a><span id="l3.712">             return;</span>
<a href="#l3.713"></a><span id="l3.713">         }</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+        localizedMessage = cal.calGetString(&quot;calendar&quot;, message , [this.mUri.spec]);</span>
<a href="#l3.716"></a><span id="l3.716">         this.mReadOnly = true;</span>
<a href="#l3.717"></a><span id="l3.717">         this.mDisabled = true;</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-        this.notifyError(aErrNo,</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-                         calGetString(&quot;calendar&quot;, message , [this.mUri.spec]));</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+        this.notifyError(aErrNo, localizedMessage);</span>
<a href="#l3.721"></a><span id="l3.721">         this.notifyError(modificationError</span>
<a href="#l3.722"></a><span id="l3.722">                          ? Components.interfaces.calIErrors.MODIFICATION_FAILED</span>
<a href="#l3.723"></a><span id="l3.723">                          : Components.interfaces.calIErrors.READ_FAILED,</span>
<a href="#l3.724"></a><span id="l3.724">                          this.buildDetailedMessage(status, extraInfo));</span>
<a href="#l3.725"></a><span id="l3.725">     },</span>
<a href="#l3.726"></a><span id="l3.726"> </span>
<a href="#l3.727"></a><span id="l3.727">     buildDetailedMessage : function caldav_buildDetailedMessage(status, extraInfo) {</span>
<a href="#l3.728"></a><span id="l3.728">         if (!status) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

