<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20051:7063147fed66249f88739ba93466bd58a7ff032f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7063147fed66249f88739ba93466bd58a7ff032f" />
<meta property="og:url" content="/comm-central/rev/7063147fed66249f88739ba93466bd58a7ff032f" />
<meta property="og:description" content="Bug 1280898 - Set up eslint for calendar files - enable var-only-toplevel rule. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7063147fed66249f88739ba93466bd58a7ff032f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7063147fed66249f88739ba93466bd58a7ff032f">shortlog</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7063147fed66249f88739ba93466bd58a7ff032f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f">files</a> |
changeset |
<a href="/comm-central/raw-rev/7063147fed66249f88739ba93466bd58a7ff032f">raw</a>  | <a href="/comm-central/archive/7063147fed66249f88739ba93466bd58a7ff032f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable var-only-toplevel rule. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#101;&#115;&#108;&#105;&#110;&#116;&#32;&#60;&#101;&#115;&#108;&#105;&#110;&#116;&#64;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#46;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 08 Jul 2016 11:19:29 +0200</td></tr>

<tr>
 <td>changeset 20051</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7063147fed66249f88739ba93466bd58a7ff032f">7063147fed66249f88739ba93466bd58a7ff032f</a></td>
</tr>



<tr>
<td>parent 20050</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fd02e757b1420b415cd3df380922d350c3dbefb6">fd02e757b1420b415cd3df380922d350c3dbefb6</a>
</td>
</tr>

<tr>
<td>child 20052</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/377282fc615d97ac51cdc94ed1f52f8e7cc702f1">377282fc615d97ac51cdc94ed1f52f8e7cc702f1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7063147fed66249f88739ba93466bd58a7ff032f">12299</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Fri, 16 Sep 2016 20:28:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7063147fed66 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7063147fed66249f88739ba93466bd58a7ff032f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7063147fed66249f88739ba93466bd58a7ff032f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7063147fed66249f88739ba93466bd58a7ff032f&newProject=comm-central&newRevision=7063147fed66249f88739ba93466bd58a7ff032f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7063147fed66249f88739ba93466bd58a7ff032f&newProject=comm-central&newRevision=7063147fed66249f88739ba93466bd58a7ff032f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7063147fed66249f88739ba93466bd58a7ff032f&newProject=comm-central&newRevision=7063147fed66249f88739ba93466bd58a7ff032f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">1280898</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable var-only-toplevel rule. r=MakeMyDay

MozReview-Commit-ID: 9gQOq7o6PFJ</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/.eslintrc">calendar/.eslintrc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/.eslintrc">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/.eslintrc">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/.eslintrc">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/.eslintrc">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/.eslintrc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.xml">calendar/base/content/agenda-listbox.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/agenda-listbox.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-daypicker.xml">calendar/base/content/calendar-daypicker.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-daypicker.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-daypicker.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-daypicker.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-daypicker.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-daypicker.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-menus.xml">calendar/base/content/calendar-menus.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-menus.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-menus.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-menus.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-menus.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-menus.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-statusbar.js">calendar/base/content/calendar-statusbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-statusbar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-statusbar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-statusbar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-statusbar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-statusbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.js">calendar/base/content/calendar-task-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-ui-utils.js">calendar/base/content/calendar-ui-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-ui-utils.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-ui-utils.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-ui-utils.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-ui-utils.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-ui-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.xml">calendar/base/content/calendar-views.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/calendar-views.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">calendar/base/content/dialogs/calendar-event-dialog-timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-dialog.js">calendar/base/content/dialogs/calendar-invitations-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-dialog.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-dialog.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-dialog.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-dialog.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-list.xml">calendar/base/content/dialogs/calendar-invitations-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-list.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-list.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-list.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-list.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-invitations-list.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">calendar/base/content/dialogs/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/alarms.js">calendar/base/content/preferences/alarms.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/alarms.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/alarms.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/alarms.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/alarms.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/alarms.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/categories.js">calendar/base/content/preferences/categories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/categories.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/categories.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/categories.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/categories.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/categories.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/views.js">calendar/base/content/preferences/views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/views.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/views.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/views.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/views.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/preferences/views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-subscriptions-list.xml">calendar/base/content/widgets/calendar-subscriptions-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-subscriptions-list.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-subscriptions-list.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-subscriptions-list.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-subscriptions-list.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-subscriptions-list.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-widgets.xml">calendar/base/content/widgets/calendar-widgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-widgets.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-widgets.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-widgets.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-widgets.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/calendar-widgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/minimonth.xml">calendar/base/content/widgets/minimonth.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/minimonth.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/minimonth.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/minimonth.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/minimonth.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/content/widgets/minimonth.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAuthUtils.jsm">calendar/base/modules/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarSearchService.js">calendar/base/src/calCalendarSearchService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarSearchService.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarSearchService.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarSearchService.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarSearchService.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calCalendarSearchService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calFreeBusyService.js">calendar/base/src/calFreeBusyService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calFreeBusyService.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calFreeBusyService.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calFreeBusyService.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calFreeBusyService.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calFreeBusyService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calProtocolHandler.js">calendar/base/src/calProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezone.js">calendar/base/src/calTimezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezone.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezone.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezone.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezone.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezone.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calWeekInfoService.js">calendar/base/src/calWeekInfoService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calWeekInfoService.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calWeekInfoService.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calWeekInfoService.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calWeekInfoService.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/base/src/calWeekInfoService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-utils.js">calendar/lightning/content/lightning-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-utils.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-utils.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-utils.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-utils.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/lightning-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-preferences.js">calendar/lightning/content/messenger-overlay-preferences.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-preferences.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-preferences.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-preferences.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-preferences.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-preferences.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapErrors.js">calendar/providers/wcap/calWcapErrors.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapErrors.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapErrors.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapErrors.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapErrors.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapErrors.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/datetimepickers/datetimepickers.xml">calendar/resources/content/datetimepickers/datetimepickers.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/datetimepickers/datetimepickers.xml">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/datetimepickers/datetimepickers.xml">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/datetimepickers/datetimepickers.xml">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/datetimepickers/datetimepickers.xml">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/datetimepickers/datetimepickers.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/mouseoverPreviews.js">calendar/resources/content/mouseoverPreviews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/mouseoverPreviews.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/mouseoverPreviews.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/mouseoverPreviews.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/mouseoverPreviews.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/mouseoverPreviews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publish.js">calendar/resources/content/publish.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publish.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publish.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publish.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publish.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publish.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publishDialog.js">calendar/resources/content/publishDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publishDialog.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publishDialog.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publishDialog.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publishDialog.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/resources/content/publishDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testAnnualRecurrence.js">calendar/test/mozmill/recurrence/testAnnualRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testAnnualRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testAnnualRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testAnnualRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testAnnualRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testAnnualRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js">calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testDailyRecurrence.js">calendar/test/mozmill/recurrence/testDailyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testDailyRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testDailyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testDailyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testDailyRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testDailyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_attendee.js">calendar/test/unit/test_attendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_attendee.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_attendee.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_attendee.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_attendee.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_attendee.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_freebusy.js">calendar/test/unit/test_freebusy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_freebusy.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_freebusy.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_freebusy.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_freebusy.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_freebusy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_ics.js">calendar/test/unit/test_ics.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_ics.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_ics.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_ics.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_ics.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_ics.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_providers.js">calendar/test/unit/test_providers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_providers.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_providers.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_providers.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_providers.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_providers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_timezone.js">calendar/test/unit/test_timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_timezone.js">file</a> |
<a href="/comm-central/annotate/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_timezone.js">annotate</a> |
<a href="/comm-central/diff/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_timezone.js">diff</a> |
<a href="/comm-central/comparison/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_timezone.js">comparison</a> |
<a href="/comm-central/log/7063147fed66249f88739ba93466bd58a7ff032f/calendar/test/unit/test_timezone.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/.eslintrc</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/.eslintrc</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -195,16 +195,21 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     // Warn about declaration of variables already declared in the outer scope.</span>
<a href="#l1.6"></a><span id="l1.6">     // This isn't an error because it sometimes is useful to use the same name</span>
<a href="#l1.7"></a><span id="l1.7">     // in a small helper function rather than having to come up with another</span>
<a href="#l1.8"></a><span id="l1.8">     // random name.  Still, making this a warning can help people avoid being</span>
<a href="#l1.9"></a><span id="l1.9">     // confused.</span>
<a href="#l1.10"></a><span id="l1.10">     &quot;no-shadow&quot;: 2,</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    // We use var-only-at-top-level instead of no-var as we allow top level</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // vars.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    &quot;no-var&quot;: 0,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    &quot;mozilla/var-only-at-top-level&quot;: 1,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17">     // Will enable these rules later</span>
<a href="#l1.18"></a><span id="l1.18">     &quot;block-spacing&quot;: 0,</span>
<a href="#l1.19"></a><span id="l1.19">     &quot;no-lonely-if&quot;: 0,</span>
<a href="#l1.20"></a><span id="l1.20">     &quot;space-before-blocks&quot;: 0,</span>
<a href="#l1.21"></a><span id="l1.21">     &quot;computed-property-spacing&quot;: 0,</span>
<a href="#l1.22"></a><span id="l1.22">     &quot;consistent-return&quot;: 0,</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">     // The following rules will not be enabled currently, but are kept here for</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -363,23 +363,23 @@ calIcalComponent.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">             kind = kind.toLowerCase();</span>
<a href="#l2.5"></a><span id="l2.5">         }</span>
<a href="#l2.6"></a><span id="l2.6">         let innerObject = this.innerObject;</span>
<a href="#l2.7"></a><span id="l2.7">         this.propertyIterator = (function* () {</span>
<a href="#l2.8"></a><span id="l2.8">             let props = innerObject.getAllProperties(kind);</span>
<a href="#l2.9"></a><span id="l2.9">             if (!props) {</span>
<a href="#l2.10"></a><span id="l2.10">                 return;</span>
<a href="#l2.11"></a><span id="l2.11">             }</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            for (var prop of props) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            for (let prop of props) {</span>
<a href="#l2.14"></a><span id="l2.14">                 let hell = prop.getValues();</span>
<a href="#l2.15"></a><span id="l2.15">                 if (hell.length &gt; 1) {</span>
<a href="#l2.16"></a><span id="l2.16">                     // Uh oh, multiple property values. Our code expects each as one</span>
<a href="#l2.17"></a><span id="l2.17">                     // property. I hate API incompatibility!</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-                    for (var devil of hell) {</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-                        var thisprop = new ICAL.Property(prop.toJSON(),</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+                    for (let devil of hell) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+                        let thisprop = new ICAL.Property(prop.toJSON(),</span>
<a href="#l2.22"></a><span id="l2.22">                                                          prop.parent);</span>
<a href="#l2.23"></a><span id="l2.23">                         thisprop.removeAllValues();</span>
<a href="#l2.24"></a><span id="l2.24">                         thisprop.setValue(devil);</span>
<a href="#l2.25"></a><span id="l2.25">                         yield new calIcalProperty(thisprop);</span>
<a href="#l2.26"></a><span id="l2.26">                     }</span>
<a href="#l2.27"></a><span id="l2.27">                 } else {</span>
<a href="#l2.28"></a><span id="l2.28">                     yield new calIcalProperty(prop);</span>
<a href="#l2.29"></a><span id="l2.29">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -22,41 +22,41 @@ var agendaListbox = {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> /**</span>
<a href="#l3.6"></a><span id="l3.6">  * Initialize the agenda listbox, used on window load.</span>
<a href="#l3.7"></a><span id="l3.7">  */</span>
<a href="#l3.8"></a><span id="l3.8"> agendaListbox.init =</span>
<a href="#l3.9"></a><span id="l3.9"> function initAgendaListbox() {</span>
<a href="#l3.10"></a><span id="l3.10">     this.agendaListboxControl = document.getElementById(&quot;agenda-listbox&quot;);</span>
<a href="#l3.11"></a><span id="l3.11">     this.agendaListboxControl.removeAttribute(&quot;suppressonselect&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    var showTodayHeader = (document.getElementById(&quot;today-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    var showTomorrowHeader = (document.getElementById(&quot;tomorrow-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    var showSoonHeader = (document.getElementById(&quot;nextweek-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    let showTodayHeader = (document.getElementById(&quot;today-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    let showTomorrowHeader = (document.getElementById(&quot;tomorrow-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    let showSoonHeader = (document.getElementById(&quot;nextweek-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">     this.today = new Synthetic(showTodayHeader, 1, false);</span>
<a href="#l3.19"></a><span id="l3.19">     this.addPeriodListItem(this.today, &quot;today-header&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">     this.tomorrow = new Synthetic(showTomorrowHeader, 1, false);</span>
<a href="#l3.21"></a><span id="l3.21">     this.soonDays = getSoondaysPreference();</span>
<a href="#l3.22"></a><span id="l3.22">     this.soon = new Synthetic(showSoonHeader, this.soonDays, true);</span>
<a href="#l3.23"></a><span id="l3.23">     this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l3.24"></a><span id="l3.24">     this.mPendingRefreshJobs = new Map();</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    var prefObserver = {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    let prefObserver = {</span>
<a href="#l3.28"></a><span id="l3.28">         observe: function aL_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l3.29"></a><span id="l3.29">             switch (aPrefName) {</span>
<a href="#l3.30"></a><span id="l3.30">                 case &quot;calendar.agendaListbox.soondays&quot;:</span>
<a href="#l3.31"></a><span id="l3.31">                     agendaListbox.soonDays = getSoondaysPreference();</span>
<a href="#l3.32"></a><span id="l3.32">                     agendaListbox.updateSoonSection();</span>
<a href="#l3.33"></a><span id="l3.33">                     break;</span>
<a href="#l3.34"></a><span id="l3.34">             }</span>
<a href="#l3.35"></a><span id="l3.35">         }</span>
<a href="#l3.36"></a><span id="l3.36">     };</span>
<a href="#l3.37"></a><span id="l3.37">     Services.prefs.addObserver(&quot;calendar.agendaListbox&quot;, prefObserver, false);</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39">     // Make sure the agenda listbox is unloaded</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    var self = this;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    let self = this;</span>
<a href="#l3.42"></a><span id="l3.42">     window.addEventListener(&quot;unload&quot;,</span>
<a href="#l3.43"></a><span id="l3.43">                             function unload_agendaListbox() {</span>
<a href="#l3.44"></a><span id="l3.44">                                 Services.prefs.removeObserver(&quot;calendar.agendaListbox&quot;, prefObserver);</span>
<a href="#l3.45"></a><span id="l3.45">                                 self.uninit();</span>
<a href="#l3.46"></a><span id="l3.46">                             },</span>
<a href="#l3.47"></a><span id="l3.47">                             false);</span>
<a href="#l3.48"></a><span id="l3.48"> };</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineat">@@ -64,17 +64,17 @@ function initAgendaListbox() {</span>
<a href="#l3.51"></a><span id="l3.51">  * Clean up the agenda listbox, used on window unload.</span>
<a href="#l3.52"></a><span id="l3.52">  */</span>
<a href="#l3.53"></a><span id="l3.53"> agendaListbox.uninit =</span>
<a href="#l3.54"></a><span id="l3.54"> function uninit() {</span>
<a href="#l3.55"></a><span id="l3.55">     if (this.calendar) {</span>
<a href="#l3.56"></a><span id="l3.56">         this.calendar.removeObserver(this.calendarObserver);</span>
<a href="#l3.57"></a><span id="l3.57">     }</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    for (var period of this.periods) {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    for (let period of this.periods) {</span>
<a href="#l3.61"></a><span id="l3.61">         if (period.listItem) {</span>
<a href="#l3.62"></a><span id="l3.62">             period.listItem.getCheckbox()</span>
<a href="#l3.63"></a><span id="l3.63">                   .removeEventListener(&quot;CheckboxStateChange&quot;,</span>
<a href="#l3.64"></a><span id="l3.64">                                        this.onCheckboxChange,</span>
<a href="#l3.65"></a><span id="l3.65">                                        true);</span>
<a href="#l3.66"></a><span id="l3.66">         }</span>
<a href="#l3.67"></a><span id="l3.67">     }</span>
<a href="#l3.68"></a><span id="l3.68"> };</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -114,34 +114,34 @@ function removePeriodListItem(aPeriod) {</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71"> /**</span>
<a href="#l3.72"></a><span id="l3.72">  * Handler function called when changing the checkbox state on period items.</span>
<a href="#l3.73"></a><span id="l3.73">  *</span>
<a href="#l3.74"></a><span id="l3.74">  * @param event     The DOM event that triggered the checkbox state change.</span>
<a href="#l3.75"></a><span id="l3.75">  */</span>
<a href="#l3.76"></a><span id="l3.76"> agendaListbox.onCheckboxChange =</span>
<a href="#l3.77"></a><span id="l3.77"> function onCheckboxChange(event) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    var periodCheckbox = event.target;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    var lopen = (periodCheckbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-    var listItem = getParentNodeOrThis(periodCheckbox, &quot;agenda-checkbox-richlist-item&quot;);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    var period = listItem.getItem();</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    let periodCheckbox = event.target;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    let lopen = (periodCheckbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    let listItem = getParentNodeOrThis(periodCheckbox, &quot;agenda-checkbox-richlist-item&quot;);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    let period = listItem.getItem();</span>
<a href="#l3.86"></a><span id="l3.86">     period.open = lopen;</span>
<a href="#l3.87"></a><span id="l3.87">     // as the agenda-checkboxes are only transient we have to set the &quot;checked&quot;</span>
<a href="#l3.88"></a><span id="l3.88">     // attribute at their hidden origins to make that attribute persistent.</span>
<a href="#l3.89"></a><span id="l3.89">     document.getElementById(listItem.id + &quot;-hidden&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l3.90"></a><span id="l3.90">                             periodCheckbox.getAttribute(&quot;checked&quot;));</span>
<a href="#l3.91"></a><span id="l3.91">     if (lopen) {</span>
<a href="#l3.92"></a><span id="l3.92">         agendaListbox.refreshCalendarQuery(period.start, period.end);</span>
<a href="#l3.93"></a><span id="l3.93">     } else {</span>
<a href="#l3.94"></a><span id="l3.94">         listItem = listItem.nextSibling;</span>
<a href="#l3.95"></a><span id="l3.95">         let leaveloop;</span>
<a href="#l3.96"></a><span id="l3.96">         do {</span>
<a href="#l3.97"></a><span id="l3.97">             leaveloop = (listItem == null);</span>
<a href="#l3.98"></a><span id="l3.98">             if (!leaveloop) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-                var nextItemSibling = listItem.nextSibling;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+                let nextItemSibling = listItem.nextSibling;</span>
<a href="#l3.101"></a><span id="l3.101">                 leaveloop = (!agendaListbox.isEventListItem(listItem));</span>
<a href="#l3.102"></a><span id="l3.102">                 if (!leaveloop) {</span>
<a href="#l3.103"></a><span id="l3.103">                     listItem.remove();</span>
<a href="#l3.104"></a><span id="l3.104">                     listItem = nextItemSibling;</span>
<a href="#l3.105"></a><span id="l3.105">                 }</span>
<a href="#l3.106"></a><span id="l3.106">             }</span>
<a href="#l3.107"></a><span id="l3.107">         } while (!leaveloop);</span>
<a href="#l3.108"></a><span id="l3.108">     }</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineat">@@ -181,17 +181,17 @@ function onBlur() {</span>
<a href="#l3.110"></a><span id="l3.110"> };</span>
<a href="#l3.111"></a><span id="l3.111"> </span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113"> /**</span>
<a href="#l3.114"></a><span id="l3.114">  * Handler function called when a key was pressed on the agenda listbox</span>
<a href="#l3.115"></a><span id="l3.115">  */</span>
<a href="#l3.116"></a><span id="l3.116"> agendaListbox.onKeyPress =</span>
<a href="#l3.117"></a><span id="l3.117"> function onKeyPress(aEvent) {</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-    var listItem = aEvent.target;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+    let listItem = aEvent.target;</span>
<a href="#l3.120"></a><span id="l3.120">     if (listItem.localName == &quot;richlistbox&quot;) {</span>
<a href="#l3.121"></a><span id="l3.121">         listItem = listItem.selectedItem;</span>
<a href="#l3.122"></a><span id="l3.122">     }</span>
<a href="#l3.123"></a><span id="l3.123">     switch (aEvent.keyCode) {</span>
<a href="#l3.124"></a><span id="l3.124">         case aEvent.DOM_VK_RETURN:</span>
<a href="#l3.125"></a><span id="l3.125">             document.getElementById('agenda_edit_event_command').doCommand();</span>
<a href="#l3.126"></a><span id="l3.126">             break;</span>
<a href="#l3.127"></a><span id="l3.127">         case aEvent.DOM_VK_DELETE:</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineat">@@ -212,63 +212,63 @@ function onKeyPress(aEvent) {</span>
<a href="#l3.129"></a><span id="l3.129">     }</span>
<a href="#l3.130"></a><span id="l3.130"> };</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132"> /**</span>
<a href="#l3.133"></a><span id="l3.133">  * Calls the event dialog to edit the currently selected item</span>
<a href="#l3.134"></a><span id="l3.134">  */</span>
<a href="#l3.135"></a><span id="l3.135"> agendaListbox.editSelectedItem =</span>
<a href="#l3.136"></a><span id="l3.136"> function editSelectedItem() {</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    var listItem = document.getElementById(&quot;agenda-listbox&quot;).selectedItem;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    let listItem = document.getElementById(&quot;agenda-listbox&quot;).selectedItem;</span>
<a href="#l3.139"></a><span id="l3.139">     if (listItem) {</span>
<a href="#l3.140"></a><span id="l3.140">         modifyEventWithDialog(listItem.occurrence, null, true);</span>
<a href="#l3.141"></a><span id="l3.141">     }</span>
<a href="#l3.142"></a><span id="l3.142"> };</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144"> /**</span>
<a href="#l3.145"></a><span id="l3.145">  * Finds the appropriate period for the given item, i.e finds &quot;Tomorrow&quot; if the</span>
<a href="#l3.146"></a><span id="l3.146">  * item occurrs tomorrow.</span>
<a href="#l3.147"></a><span id="l3.147">  *</span>
<a href="#l3.148"></a><span id="l3.148">  * @param aItem     The item to find the period for.</span>
<a href="#l3.149"></a><span id="l3.149">  */</span>
<a href="#l3.150"></a><span id="l3.150"> agendaListbox.findPeriodsForItem =</span>
<a href="#l3.151"></a><span id="l3.151"> function findPeriodsForItem(aItem) {</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-    var retPeriods = [];</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-    for (var i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    let retPeriods = [];</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+    for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l3.156"></a><span id="l3.156">         if (this.periods[i].open) {</span>
<a href="#l3.157"></a><span id="l3.157">             if (checkIfInRange(aItem, this.periods[i].start, this.periods[i].end)) {</span>
<a href="#l3.158"></a><span id="l3.158">                 retPeriods.push(this.periods[i]);</span>
<a href="#l3.159"></a><span id="l3.159">             }</span>
<a href="#l3.160"></a><span id="l3.160">         }</span>
<a href="#l3.161"></a><span id="l3.161">     }</span>
<a href="#l3.162"></a><span id="l3.162">     return retPeriods;</span>
<a href="#l3.163"></a><span id="l3.163"> };</span>
<a href="#l3.164"></a><span id="l3.164"> </span>
<a href="#l3.165"></a><span id="l3.165"> /**</span>
<a href="#l3.166"></a><span id="l3.166">  * Gets the start of the earliest period shown in the agenda listbox</span>
<a href="#l3.167"></a><span id="l3.167">  */</span>
<a href="#l3.168"></a><span id="l3.168"> agendaListbox.getStart =</span>
<a href="#l3.169"></a><span id="l3.169"> function getStart(){</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-    var retStart = null;</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-    for (var i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    let retStart = null;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l3.174"></a><span id="l3.174">         if (this.periods[i].open) {</span>
<a href="#l3.175"></a><span id="l3.175">             retStart = this.periods[i].start;</span>
<a href="#l3.176"></a><span id="l3.176">             break;</span>
<a href="#l3.177"></a><span id="l3.177">         }</span>
<a href="#l3.178"></a><span id="l3.178">     }</span>
<a href="#l3.179"></a><span id="l3.179">     return retStart;</span>
<a href="#l3.180"></a><span id="l3.180"> };</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182"> /**</span>
<a href="#l3.183"></a><span id="l3.183">  * Gets the end of the latest period shown in the agenda listbox</span>
<a href="#l3.184"></a><span id="l3.184">  */</span>
<a href="#l3.185"></a><span id="l3.185"> agendaListbox.getEnd =</span>
<a href="#l3.186"></a><span id="l3.186"> function getEnd(){</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    var retEnd = null;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    for (var i = this.periods.length - 1; i &gt;= 0; i--) {</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+    let retEnd = null;</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+    for (let i = this.periods.length - 1; i &gt;= 0; i--) {</span>
<a href="#l3.191"></a><span id="l3.191">         if (this.periods[i].open) {</span>
<a href="#l3.192"></a><span id="l3.192">             retEnd = this.periods[i].end;</span>
<a href="#l3.193"></a><span id="l3.193">             break;</span>
<a href="#l3.194"></a><span id="l3.194">         }</span>
<a href="#l3.195"></a><span id="l3.195">     }</span>
<a href="#l3.196"></a><span id="l3.196">     return retEnd;</span>
<a href="#l3.197"></a><span id="l3.197"> };</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199" class="difflineat">@@ -278,17 +278,17 @@ function getEnd(){</span>
<a href="#l3.200"></a><span id="l3.200">  * @param aNewItem      The calIItemBase to add.</span>
<a href="#l3.201"></a><span id="l3.201">  * @param aAgendaItem   The existing item to insert before.</span>
<a href="#l3.202"></a><span id="l3.202">  * @param aPeriod       The period to add the item to.</span>
<a href="#l3.203"></a><span id="l3.203">  * @param visible       If true, the item should be visible.</span>
<a href="#l3.204"></a><span id="l3.204">  * @return              The newly created XUL element.</span>
<a href="#l3.205"></a><span id="l3.205">  */</span>
<a href="#l3.206"></a><span id="l3.206"> agendaListbox.addItemBefore =</span>
<a href="#l3.207"></a><span id="l3.207"> function addItemBefore(aNewItem, aAgendaItem, aPeriod, visible) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-    var newelement = null;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    let newelement = null;</span>
<a href="#l3.210"></a><span id="l3.210">     if (aNewItem.startDate.isDate) {</span>
<a href="#l3.211"></a><span id="l3.211">         newelement = createXULElement(&quot;agenda-allday-richlist-item&quot;);</span>
<a href="#l3.212"></a><span id="l3.212">     } else {</span>
<a href="#l3.213"></a><span id="l3.213">         newelement = createXULElement(&quot;agenda-richlist-item&quot;);</span>
<a href="#l3.214"></a><span id="l3.214">     }</span>
<a href="#l3.215"></a><span id="l3.215">     // set the item at the richlistItem. When the duration of the period</span>
<a href="#l3.216"></a><span id="l3.216">     // is bigger than 1 (day) the starttime of the item has to include</span>
<a href="#l3.217"></a><span id="l3.217">     // information about the day of the item</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineat">@@ -309,37 +309,37 @@ function addItemBefore(aNewItem, aAgenda</span>
<a href="#l3.219"></a><span id="l3.219">  * @param aItem         The calIItemBase to add.</span>
<a href="#l3.220"></a><span id="l3.220">  * @return              The newly created XUL element.</span>
<a href="#l3.221"></a><span id="l3.221">  */</span>
<a href="#l3.222"></a><span id="l3.222"> agendaListbox.addItem =</span>
<a href="#l3.223"></a><span id="l3.223"> function addItem(aItem) {</span>
<a href="#l3.224"></a><span id="l3.224">     if (!isEvent(aItem)) {</span>
<a href="#l3.225"></a><span id="l3.225">         return null;</span>
<a href="#l3.226"></a><span id="l3.226">     }</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-    var periods = this.findPeriodsForItem(aItem);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+    let periods = this.findPeriodsForItem(aItem);</span>
<a href="#l3.229"></a><span id="l3.229">     if (periods.length == 0) {</span>
<a href="#l3.230"></a><span id="l3.230">         return null;</span>
<a href="#l3.231"></a><span id="l3.231">     }</span>
<a href="#l3.232"></a><span id="l3.232">     let newlistItem = null;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    for (var i = 0; i &lt; periods.length; i++) {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    for (let i = 0; i &lt; periods.length; i++) {</span>
<a href="#l3.235"></a><span id="l3.235">         let period = periods[i];</span>
<a href="#l3.236"></a><span id="l3.236">         let complistItem = period.listItem;</span>
<a href="#l3.237"></a><span id="l3.237">         let visible = complistItem.getCheckbox().checked;</span>
<a href="#l3.238"></a><span id="l3.238">         if (aItem.startDate.isDate &amp;&amp; period.duration == 1 &amp;&amp; aItem.duration.days == 1) {</span>
<a href="#l3.239"></a><span id="l3.239">             if (this.getListItems(aItem, period).length == 0) {</span>
<a href="#l3.240"></a><span id="l3.240">                 this.addItemBefore(aItem, period.listItem.nextSibling, period, visible);</span>
<a href="#l3.241"></a><span id="l3.241">             }</span>
<a href="#l3.242"></a><span id="l3.242">         } else {</span>
<a href="#l3.243"></a><span id="l3.243">             do {</span>
<a href="#l3.244"></a><span id="l3.244">                 complistItem = complistItem.nextSibling;</span>
<a href="#l3.245"></a><span id="l3.245">                 if (!this.isEventListItem(complistItem)) {</span>
<a href="#l3.246"></a><span id="l3.246">                     newlistItem = this.addItemBefore(aItem, complistItem, period, visible);</span>
<a href="#l3.247"></a><span id="l3.247">                     break;</span>
<a href="#l3.248"></a><span id="l3.248">                 } else {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-                    var compitem = complistItem.occurrence;</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+                    let compitem = complistItem.occurrence;</span>
<a href="#l3.251"></a><span id="l3.251">                     if (this.isSameEvent(aItem, compitem)) {</span>
<a href="#l3.252"></a><span id="l3.252">                         // The same event occurs on several calendars but we only</span>
<a href="#l3.253"></a><span id="l3.253">                         // display the first one.</span>
<a href="#l3.254"></a><span id="l3.254">                         // TODO: find a way to display this special circumstance</span>
<a href="#l3.255"></a><span id="l3.255">                         break;</span>
<a href="#l3.256"></a><span id="l3.256">                     } else if (this.isBefore(aItem, compitem, period)) {</span>
<a href="#l3.257"></a><span id="l3.257">                         if (this.isSameEvent(aItem, compitem)) {</span>
<a href="#l3.258"></a><span id="l3.258">                             newlistItem = this.addItemBefore(aItem, complistItem, period, visible);</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineat">@@ -453,23 +453,23 @@ function comparisonDate(aItem, aPeriod) </span>
<a href="#l3.260"></a><span id="l3.260">  * Gets the listitems for a given item, possibly in a given period.</span>
<a href="#l3.261"></a><span id="l3.261">  *</span>
<a href="#l3.262"></a><span id="l3.262">  * @param aItem         The item to get the list items for.</span>
<a href="#l3.263"></a><span id="l3.263">  * @param aPeriod       (optional) the period to search in.</span>
<a href="#l3.264"></a><span id="l3.264">  * @return              An array of list items for the given item.</span>
<a href="#l3.265"></a><span id="l3.265">  */</span>
<a href="#l3.266"></a><span id="l3.266"> agendaListbox.getListItems =</span>
<a href="#l3.267"></a><span id="l3.267"> function getListItems(aItem, aPeriod) {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-    var retlistItems = [];</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-    var periods = [aPeriod];</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+    let retlistItems = [];</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+    let periods = [aPeriod];</span>
<a href="#l3.272"></a><span id="l3.272">     if (!aPeriod) {</span>
<a href="#l3.273"></a><span id="l3.273">         periods = this.findPeriodsForItem(aItem);</span>
<a href="#l3.274"></a><span id="l3.274">     }</span>
<a href="#l3.275"></a><span id="l3.275">     if (periods.length &gt; 0) {</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-        for (var i = 0; i &lt; periods.length; i++) {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+        for (let i = 0; i &lt; periods.length; i++) {</span>
<a href="#l3.278"></a><span id="l3.278">             let period = periods[i];</span>
<a href="#l3.279"></a><span id="l3.279">             let complistItem = period.listItem;</span>
<a href="#l3.280"></a><span id="l3.280">             let leaveloop;</span>
<a href="#l3.281"></a><span id="l3.281">             do {</span>
<a href="#l3.282"></a><span id="l3.282">                 complistItem = complistItem.nextSibling;</span>
<a href="#l3.283"></a><span id="l3.283">                 leaveloop = (!this.isEventListItem(complistItem));</span>
<a href="#l3.284"></a><span id="l3.284">                 if (!leaveloop) {</span>
<a href="#l3.285"></a><span id="l3.285">                     if (this.isSameEvent(aItem, complistItem.occurrence)){</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineat">@@ -488,22 +488,22 @@ function getListItems(aItem, aPeriod) {</span>
<a href="#l3.287"></a><span id="l3.287">  *</span>
<a href="#l3.288"></a><span id="l3.288">  * @param aItem             The item to remove.</span>
<a href="#l3.289"></a><span id="l3.289">  * @param aMoveSelection    If true, the selection will be moved to the next</span>
<a href="#l3.290"></a><span id="l3.290">  *                            sibling that is not an period item.</span>
<a href="#l3.291"></a><span id="l3.291">  * @return                  Returns true if the removed item was selected.</span>
<a href="#l3.292"></a><span id="l3.292">  */</span>
<a href="#l3.293"></a><span id="l3.293"> agendaListbox.deleteItem =</span>
<a href="#l3.294"></a><span id="l3.294"> function deleteItem(aItem, aMoveSelection) {</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    var isSelected = false;</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-    var listItems = this.getListItems(aItem);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+    let isSelected = false;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+    let listItems = this.getListItems(aItem);</span>
<a href="#l3.299"></a><span id="l3.299">     if (listItems.length &gt; 0) {</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-        for (var i = listItems.length - 1; i &gt;= 0; i--) {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-            var listItem = listItems[i];</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-            var isSelected2 = listItem.selected;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+        for (let i = listItems.length - 1; i &gt;= 0; i--) {</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+            let listItem = listItems[i];</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+            let isSelected2 = listItem.selected;</span>
<a href="#l3.306"></a><span id="l3.306">             if (isSelected2 &amp;&amp; !isSelected) {</span>
<a href="#l3.307"></a><span id="l3.307">                 isSelected = true;</span>
<a href="#l3.308"></a><span id="l3.308">                 if (aMoveSelection) {</span>
<a href="#l3.309"></a><span id="l3.309">                     this.moveSelection();</span>
<a href="#l3.310"></a><span id="l3.310">                 }</span>
<a href="#l3.311"></a><span id="l3.311">             }</span>
<a href="#l3.312"></a><span id="l3.312">             listItem.remove();</span>
<a href="#l3.313"></a><span id="l3.313">         }</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineat">@@ -544,33 +544,33 @@ function isSameEvent(aItem, aCompItem) {</span>
<a href="#l3.315"></a><span id="l3.315"> /**</span>
<a href="#l3.316"></a><span id="l3.316">  * Checks if the currently selected node in the listbox is an Event item (not a</span>
<a href="#l3.317"></a><span id="l3.317">  * period item).</span>
<a href="#l3.318"></a><span id="l3.318">  *</span>
<a href="#l3.319"></a><span id="l3.319">  * @return              True, if the node is not a period item.</span>
<a href="#l3.320"></a><span id="l3.320">  */</span>
<a href="#l3.321"></a><span id="l3.321"> agendaListbox.isEventSelected =</span>
<a href="#l3.322"></a><span id="l3.322"> function isEventSelected() {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-    var listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+    let listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l3.325"></a><span id="l3.325">     if (listItem) {</span>
<a href="#l3.326"></a><span id="l3.326">         return (this.isEventListItem(listItem));</span>
<a href="#l3.327"></a><span id="l3.327">     }</span>
<a href="#l3.328"></a><span id="l3.328">     return false;</span>
<a href="#l3.329"></a><span id="l3.329"> };</span>
<a href="#l3.330"></a><span id="l3.330"> </span>
<a href="#l3.331"></a><span id="l3.331"> /**</span>
<a href="#l3.332"></a><span id="l3.332">  * Delete the selected item from its calendar (if it is an event item)</span>
<a href="#l3.333"></a><span id="l3.333">  *</span>
<a href="#l3.334"></a><span id="l3.334">  * @param aDoNotConfirm     If true, the user will not be prompted.</span>
<a href="#l3.335"></a><span id="l3.335">  */</span>
<a href="#l3.336"></a><span id="l3.336"> agendaListbox.deleteSelectedItem =</span>
<a href="#l3.337"></a><span id="l3.337"> function deleteSelectedItem(aDoNotConfirm) {</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-    var listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+    let listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l3.340"></a><span id="l3.340">     if (this.isEventListItem(listItem)) {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-        var selectedItems = [listItem.occurrence];</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+        let selectedItems = [listItem.occurrence];</span>
<a href="#l3.343"></a><span id="l3.343">         calendarViewController.deleteOccurrences(selectedItems.length,</span>
<a href="#l3.344"></a><span id="l3.344">                                                  selectedItems,</span>
<a href="#l3.345"></a><span id="l3.345">                                                  false,</span>
<a href="#l3.346"></a><span id="l3.346">                                                  aDoNotConfirm);</span>
<a href="#l3.347"></a><span id="l3.347">     }</span>
<a href="#l3.348"></a><span id="l3.348"> };</span>
<a href="#l3.349"></a><span id="l3.349"> </span>
<a href="#l3.350"></a><span id="l3.350"> /**</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineat">@@ -579,17 +579,17 @@ function deleteSelectedItem(aDoNotConfir</span>
<a href="#l3.352"></a><span id="l3.352">  *</span>
<a href="#l3.353"></a><span id="l3.353">  * @param aEvent            The DOM event that targets the period.</span>
<a href="#l3.354"></a><span id="l3.354">  */</span>
<a href="#l3.355"></a><span id="l3.355"> agendaListbox.createNewEvent =</span>
<a href="#l3.356"></a><span id="l3.356"> function createNewEvent(aEvent) {</span>
<a href="#l3.357"></a><span id="l3.357">     if (!this.isEventListItem(aEvent.target)){</span>
<a href="#l3.358"></a><span id="l3.358">         // Create new event for the date currently displayed in the agenda. Setting</span>
<a href="#l3.359"></a><span id="l3.359">         // isDate = true automatically makes the start time be the next full hour.</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-        var eventStart = agendaListbox.today.start.clone();</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+        let eventStart = agendaListbox.today.start.clone();</span>
<a href="#l3.362"></a><span id="l3.362">         eventStart.isDate = true;</span>
<a href="#l3.363"></a><span id="l3.363">         if (calendarController.isCommandEnabled(&quot;calendar_new_event_command&quot;)) {</span>
<a href="#l3.364"></a><span id="l3.364">             createEventWithDialog(getSelectedCalendar(), eventStart);</span>
<a href="#l3.365"></a><span id="l3.365">         }</span>
<a href="#l3.366"></a><span id="l3.366">     }</span>
<a href="#l3.367"></a><span id="l3.367"> };</span>
<a href="#l3.368"></a><span id="l3.368"> </span>
<a href="#l3.369"></a><span id="l3.369"> /**</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineat">@@ -734,28 +734,28 @@ function setupCalendar() {</span>
<a href="#l3.371"></a><span id="l3.371">  * @see #refreshCalendarQuery</span>
<a href="#l3.372"></a><span id="l3.372">  * @param newDate       The first date to show if the agenda pane doesn't show</span>
<a href="#l3.373"></a><span id="l3.373">  *                        today.</span>
<a href="#l3.374"></a><span id="l3.374">  */</span>
<a href="#l3.375"></a><span id="l3.375"> agendaListbox.refreshPeriodDates =</span>
<a href="#l3.376"></a><span id="l3.376"> function refreshPeriodDates(newDate) {</span>
<a href="#l3.377"></a><span id="l3.377">      this.kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l3.378"></a><span id="l3.378">     // Today: now until midnight of tonight</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-    var oldshowstoday = this.showstoday;</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+    let oldshowstoday = this.showstoday;</span>
<a href="#l3.381"></a><span id="l3.381">     this.showstoday = this.showsToday(newDate);</span>
<a href="#l3.382"></a><span id="l3.382">     if ((this.showstoday) &amp;&amp; (!oldshowstoday)) {</span>
<a href="#l3.383"></a><span id="l3.383">         this.addPeriodListItem(this.tomorrow, &quot;tomorrow-header&quot;);</span>
<a href="#l3.384"></a><span id="l3.384">         this.addPeriodListItem(this.soon, &quot;nextweek-header&quot;);</span>
<a href="#l3.385"></a><span id="l3.385">     } else if (!this.showstoday) {</span>
<a href="#l3.386"></a><span id="l3.386">         this.removePeriodListItem(this.tomorrow);</span>
<a href="#l3.387"></a><span id="l3.387">         this.removePeriodListItem(this.soon);</span>
<a href="#l3.388"></a><span id="l3.388">     }</span>
<a href="#l3.389"></a><span id="l3.389">     newDate.isDate = true;</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-    for (var i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-        var curPeriod = this.periods[i];</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+    for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+        let curPeriod = this.periods[i];</span>
<a href="#l3.394"></a><span id="l3.394">         newDate.hour = newDate.minute = newDate.second = 0;</span>
<a href="#l3.395"></a><span id="l3.395">         if (i == 0 &amp;&amp; this.showstoday) {</span>
<a href="#l3.396"></a><span id="l3.396">             curPeriod.start = now();</span>
<a href="#l3.397"></a><span id="l3.397">         } else {</span>
<a href="#l3.398"></a><span id="l3.398">             curPeriod.start = newDate.clone();</span>
<a href="#l3.399"></a><span id="l3.399">         }</span>
<a href="#l3.400"></a><span id="l3.400">         newDate.day += curPeriod.duration;</span>
<a href="#l3.401"></a><span id="l3.401">         curPeriod.end = newDate.clone();</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineat">@@ -778,53 +778,53 @@ function addListener(aListener) {</span>
<a href="#l3.403"></a><span id="l3.403">  * Checks if the agenda listbox is showing &quot;today&quot;. Without arguments, this</span>
<a href="#l3.404"></a><span id="l3.404">  * function assumes the today attribute of the agenda listbox.</span>
<a href="#l3.405"></a><span id="l3.405">  *</span>
<a href="#l3.406"></a><span id="l3.406">  * @param aStartDate    (optional) The day to check if its &quot;today&quot;.</span>
<a href="#l3.407"></a><span id="l3.407">  * @return              Returns true if today is shown.</span>
<a href="#l3.408"></a><span id="l3.408">  */</span>
<a href="#l3.409"></a><span id="l3.409"> agendaListbox.showsToday =</span>
<a href="#l3.410"></a><span id="l3.410"> function showsToday(aStartDate) {</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-    var lstart = aStartDate;</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+    let lstart = aStartDate;</span>
<a href="#l3.413"></a><span id="l3.413">     if (!lstart) {</span>
<a href="#l3.414"></a><span id="l3.414">         lstart = this.today.start;</span>
<a href="#l3.415"></a><span id="l3.415">     }</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-    var lshowsToday = (sameDay(now(), lstart));</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+    let lshowsToday = (sameDay(now(), lstart));</span>
<a href="#l3.418"></a><span id="l3.418">     if (lshowsToday) {</span>
<a href="#l3.419"></a><span id="l3.419">         this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l3.420"></a><span id="l3.420">     } else {</span>
<a href="#l3.421"></a><span id="l3.421">         this.periods = [this.today];</span>
<a href="#l3.422"></a><span id="l3.422">     }</span>
<a href="#l3.423"></a><span id="l3.423">     return lshowsToday;</span>
<a href="#l3.424"></a><span id="l3.424"> };</span>
<a href="#l3.425"></a><span id="l3.425"> </span>
<a href="#l3.426"></a><span id="l3.426"> /**</span>
<a href="#l3.427"></a><span id="l3.427">  * Moves the selection. Moves down unless the next item is a period item, in</span>
<a href="#l3.428"></a><span id="l3.428">  * which case the selection moves up.</span>
<a href="#l3.429"></a><span id="l3.429">  */</span>
<a href="#l3.430"></a><span id="l3.430"> agendaListbox.moveSelection =</span>
<a href="#l3.431"></a><span id="l3.431"> function moveSelection() {</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-    var selindex = this.agendaListboxControl.selectedIndex;</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+    let selindex = this.agendaListboxControl.selectedIndex;</span>
<a href="#l3.434"></a><span id="l3.434">     if (!this.isEventListItem(this.agendaListboxControl.selectedItem.nextSibling)) {</span>
<a href="#l3.435"></a><span id="l3.435">         this.agendaListboxControl.goUp();</span>
<a href="#l3.436"></a><span id="l3.436">     } else {</span>
<a href="#l3.437"></a><span id="l3.437">         this.agendaListboxControl.goDown();</span>
<a href="#l3.438"></a><span id="l3.438">     }</span>
<a href="#l3.439"></a><span id="l3.439"> };</span>
<a href="#l3.440"></a><span id="l3.440"> </span>
<a href="#l3.441"></a><span id="l3.441"> /**</span>
<a href="#l3.442"></a><span id="l3.442">  * Gets an array of selected items. If a period node is selected, it is not</span>
<a href="#l3.443"></a><span id="l3.443">  * included.</span>
<a href="#l3.444"></a><span id="l3.444">  *</span>
<a href="#l3.445"></a><span id="l3.445">  * @return      An array with all selected items.</span>
<a href="#l3.446"></a><span id="l3.446">  */</span>
<a href="#l3.447"></a><span id="l3.447"> agendaListbox.getSelectedItems =</span>
<a href="#l3.448"></a><span id="l3.448"> function getSelectedItems() {</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-    var selindex = this.agendaListboxControl.selectedIndex;</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-    var items = [];</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+    let selindex = this.agendaListboxControl.selectedIndex;</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+    let items = [];</span>
<a href="#l3.453"></a><span id="l3.453">     if (this.isEventListItem(this.agendaListboxControl.selectedItem)) {</span>
<a href="#l3.454"></a><span id="l3.454">         // If at some point we support selecting multiple items, this array can</span>
<a href="#l3.455"></a><span id="l3.455">         // be expanded.</span>
<a href="#l3.456"></a><span id="l3.456">         items = [this.agendaListboxControl.selectedItem.occurrence];</span>
<a href="#l3.457"></a><span id="l3.457">     }</span>
<a href="#l3.458"></a><span id="l3.458">     return items;</span>
<a href="#l3.459"></a><span id="l3.459"> };</span>
<a href="#l3.460"></a><span id="l3.460"> </span>
<a href="#l3.461"></a><span id="l3.461" class="difflineat">@@ -832,35 +832,35 @@ function getSelectedItems() {</span>
<a href="#l3.462"></a><span id="l3.462">  * Checks if the passed node in the listbox is an Event item (not a</span>
<a href="#l3.463"></a><span id="l3.463">  * period item).</span>
<a href="#l3.464"></a><span id="l3.464">  *</span>
<a href="#l3.465"></a><span id="l3.465">  * @param aListItem     The node to check for.</span>
<a href="#l3.466"></a><span id="l3.466">  * @return              True, if the node is not a period item.</span>
<a href="#l3.467"></a><span id="l3.467">  */</span>
<a href="#l3.468"></a><span id="l3.468"> agendaListbox.isEventListItem =</span>
<a href="#l3.469"></a><span id="l3.469"> function isEventListItem(aListItem) {</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-    var isListItem = (aListItem != null);</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+    let isListItem = (aListItem != null);</span>
<a href="#l3.472"></a><span id="l3.472">     if (isListItem) {</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-        var localName = aListItem.localName;</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+        let localName = aListItem.localName;</span>
<a href="#l3.475"></a><span id="l3.475">         isListItem = (localName == &quot;agenda-richlist-item&quot; ||</span>
<a href="#l3.476"></a><span id="l3.476">                       localName == &quot;agenda-allday-richlist-item&quot;);</span>
<a href="#l3.477"></a><span id="l3.477">     }</span>
<a href="#l3.478"></a><span id="l3.478">     return isListItem;</span>
<a href="#l3.479"></a><span id="l3.479"> };</span>
<a href="#l3.480"></a><span id="l3.480"> </span>
<a href="#l3.481"></a><span id="l3.481"> /**</span>
<a href="#l3.482"></a><span id="l3.482">  * Removes all Event items, keeping the period items intact.</span>
<a href="#l3.483"></a><span id="l3.483">  */</span>
<a href="#l3.484"></a><span id="l3.484"> agendaListbox.removeListItems =</span>
<a href="#l3.485"></a><span id="l3.485"> function removeListItems() {</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    var listItem = this.agendaListboxControl.lastChild;</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+    let listItem = this.agendaListboxControl.lastChild;</span>
<a href="#l3.488"></a><span id="l3.488">     if (listItem) {</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-        var leaveloop = false;</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+        let leaveloop = false;</span>
<a href="#l3.491"></a><span id="l3.491">         do {</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-            var newlistItem = null;</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+            let newlistItem = null;</span>
<a href="#l3.494"></a><span id="l3.494">             if (listItem) {</span>
<a href="#l3.495"></a><span id="l3.495">                 newlistItem = listItem.previousSibling;</span>
<a href="#l3.496"></a><span id="l3.496">             } else {</span>
<a href="#l3.497"></a><span id="l3.497">                 leaveloop = true;</span>
<a href="#l3.498"></a><span id="l3.498">             }</span>
<a href="#l3.499"></a><span id="l3.499">             if (this.isEventListItem(listItem)) {</span>
<a href="#l3.500"></a><span id="l3.500">                 if (listItem != this.agendaListboxControl.firstChild) {</span>
<a href="#l3.501"></a><span id="l3.501">                     listItem.remove();</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineat">@@ -875,18 +875,18 @@ function removeListItems() {</span>
<a href="#l3.503"></a><span id="l3.503"> </span>
<a href="#l3.504"></a><span id="l3.504"> /**</span>
<a href="#l3.505"></a><span id="l3.505">  * Gets the list item node by its associated event's hashId.</span>
<a href="#l3.506"></a><span id="l3.506">  *</span>
<a href="#l3.507"></a><span id="l3.507">  * @return The XUL node if successful, otherwise null.</span>
<a href="#l3.508"></a><span id="l3.508">  */</span>
<a href="#l3.509"></a><span id="l3.509"> agendaListbox.getListItemByHashId =</span>
<a href="#l3.510"></a><span id="l3.510"> function getListItemByHashId(ahashId) {</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-    var listItem = this.agendaListboxControl.firstChild;</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-    var leaveloop = false;</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+    let listItem = this.agendaListboxControl.firstChild;</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+    let leaveloop = false;</span>
<a href="#l3.515"></a><span id="l3.515">     do {</span>
<a href="#l3.516"></a><span id="l3.516">         if (this.isEventListItem(listItem)) {</span>
<a href="#l3.517"></a><span id="l3.517">             if (listItem.occurrence.hashId == ahashId) {</span>
<a href="#l3.518"></a><span id="l3.518">                 return listItem;</span>
<a href="#l3.519"></a><span id="l3.519">             }</span>
<a href="#l3.520"></a><span id="l3.520">         }</span>
<a href="#l3.521"></a><span id="l3.521">         listItem = listItem.nextSibling;</span>
<a href="#l3.522"></a><span id="l3.522">         leaveloop = (listItem == null);</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineat">@@ -933,63 +933,63 @@ agendaListbox.calendarObserver.onLoad = </span>
<a href="#l3.524"></a><span id="l3.524">     this.agendaListbox.refreshCalendarQuery();</span>
<a href="#l3.525"></a><span id="l3.525"> };</span>
<a href="#l3.526"></a><span id="l3.526"> </span>
<a href="#l3.527"></a><span id="l3.527"> agendaListbox.calendarObserver.onAddItem = function observer_onAddItem(item) {</span>
<a href="#l3.528"></a><span id="l3.528">     if (!isEvent(item)) {</span>
<a href="#l3.529"></a><span id="l3.529">         return;</span>
<a href="#l3.530"></a><span id="l3.530">     }</span>
<a href="#l3.531"></a><span id="l3.531">     // get all sub items if it is a recurring item</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-    var occs = this.getOccurrencesBetween(item);</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+    let occs = this.getOccurrencesBetween(item);</span>
<a href="#l3.534"></a><span id="l3.534">     occs.forEach(this.agendaListbox.addItem, this.agendaListbox);</span>
<a href="#l3.535"></a><span id="l3.535">     setCurrentEvent();</span>
<a href="#l3.536"></a><span id="l3.536"> };</span>
<a href="#l3.537"></a><span id="l3.537"> </span>
<a href="#l3.538"></a><span id="l3.538"> agendaListbox.calendarObserver.getOccurrencesBetween =</span>
<a href="#l3.539"></a><span id="l3.539"> function getOccurrencesBetween(aItem) {</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-    var occs = [];</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    var start = this.agendaListbox.getStart();</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    var end = this.agendaListbox.getEnd();</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+    let occs = [];</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+    let start = this.agendaListbox.getStart();</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+    let end = this.agendaListbox.getEnd();</span>
<a href="#l3.546"></a><span id="l3.546">     if (start &amp;&amp; end) {</span>
<a href="#l3.547"></a><span id="l3.547">         occs = aItem.getOccurrencesBetween(start, end, {});</span>
<a href="#l3.548"></a><span id="l3.548">     }</span>
<a href="#l3.549"></a><span id="l3.549">     return occs;</span>
<a href="#l3.550"></a><span id="l3.550"> };</span>
<a href="#l3.551"></a><span id="l3.551"> </span>
<a href="#l3.552"></a><span id="l3.552"> agendaListbox.calendarObserver.onDeleteItem =</span>
<a href="#l3.553"></a><span id="l3.553"> function observer_onDeleteItem(item, rebuildFlag) {</span>
<a href="#l3.554"></a><span id="l3.554">     this.onLocalDeleteItem(item, true);</span>
<a href="#l3.555"></a><span id="l3.555"> };</span>
<a href="#l3.556"></a><span id="l3.556"> </span>
<a href="#l3.557"></a><span id="l3.557"> agendaListbox.calendarObserver.onLocalDeleteItem =</span>
<a href="#l3.558"></a><span id="l3.558"> function observer_onLocalDeleteItem(item, moveSelection) {</span>
<a href="#l3.559"></a><span id="l3.559">     if (!isEvent(item)) {</span>
<a href="#l3.560"></a><span id="l3.560">         return false;</span>
<a href="#l3.561"></a><span id="l3.561">     }</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-    var selectedItemHashId = -1;</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+    let selectedItemHashId = -1;</span>
<a href="#l3.564"></a><span id="l3.564"> // get all sub items if it is a recurring item</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-    var occs = this.getOccurrencesBetween(item);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-    for (var i = 0; i &lt; occs.length; i++) {</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-        var isSelected = this.agendaListbox.deleteItem(occs[i], moveSelection);</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+    let occs = this.getOccurrencesBetween(item);</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+    for (let i = 0; i &lt; occs.length; i++) {</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+        let isSelected = this.agendaListbox.deleteItem(occs[i], moveSelection);</span>
<a href="#l3.571"></a><span id="l3.571">         if (isSelected) {</span>
<a href="#l3.572"></a><span id="l3.572">             selectedItemHashId = occs[i].hashId;</span>
<a href="#l3.573"></a><span id="l3.573">         }</span>
<a href="#l3.574"></a><span id="l3.574">     }</span>
<a href="#l3.575"></a><span id="l3.575">     return selectedItemHashId;</span>
<a href="#l3.576"></a><span id="l3.576"> };</span>
<a href="#l3.577"></a><span id="l3.577"> </span>
<a href="#l3.578"></a><span id="l3.578"> agendaListbox.calendarObserver.onModifyItem =</span>
<a href="#l3.579"></a><span id="l3.579"> function observer_onModifyItem(newItem, oldItem) {</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-    var selectedItemHashId = this.onLocalDeleteItem(oldItem, false);</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+    let selectedItemHashId = this.onLocalDeleteItem(oldItem, false);</span>
<a href="#l3.582"></a><span id="l3.582">     if (!isEvent(newItem)) {</span>
<a href="#l3.583"></a><span id="l3.583">         return;</span>
<a href="#l3.584"></a><span id="l3.584">     }</span>
<a href="#l3.585"></a><span id="l3.585">     this.onAddItem(newItem);</span>
<a href="#l3.586"></a><span id="l3.586">     if (selectedItemHashId != -1) {</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        var listItem = agendaListbox.getListItemByHashId(selectedItemHashId);</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+        let listItem = agendaListbox.getListItemByHashId(selectedItemHashId);</span>
<a href="#l3.589"></a><span id="l3.589">         if (listItem) {</span>
<a href="#l3.590"></a><span id="l3.590">             agendaListbox.agendaListboxControl.clearSelection();</span>
<a href="#l3.591"></a><span id="l3.591">             agendaListbox.agendaListboxControl.ensureElementIsVisible(listItem);</span>
<a href="#l3.592"></a><span id="l3.592">             agendaListbox.agendaListboxControl.selectedItem = listItem;</span>
<a href="#l3.593"></a><span id="l3.593">         }</span>
<a href="#l3.594"></a><span id="l3.594">     }</span>
<a href="#l3.595"></a><span id="l3.595">     setCurrentEvent();</span>
<a href="#l3.596"></a><span id="l3.596"> };</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineat">@@ -997,17 +997,17 @@ function observer_onModifyItem(newItem, </span>
<a href="#l3.598"></a><span id="l3.598"> agendaListbox.calendarObserver.onError = function(cal, errno, msg) {};</span>
<a href="#l3.599"></a><span id="l3.599"> </span>
<a href="#l3.600"></a><span id="l3.600"> agendaListbox.calendarObserver.onPropertyChanged = function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l3.601"></a><span id="l3.601">     switch (aName) {</span>
<a href="#l3.602"></a><span id="l3.602">         case &quot;disabled&quot;:</span>
<a href="#l3.603"></a><span id="l3.603">             this.agendaListbox.refreshCalendarQuery();</span>
<a href="#l3.604"></a><span id="l3.604">             break;</span>
<a href="#l3.605"></a><span id="l3.605">         case &quot;color&quot;:</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-            for (var node = agendaListbox.agendaListboxControl.firstChild;</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+            for (let node = agendaListbox.agendaListboxControl.firstChild;</span>
<a href="#l3.608"></a><span id="l3.608">                  node;</span>
<a href="#l3.609"></a><span id="l3.609">                  node = node.nextSibling) {</span>
<a href="#l3.610"></a><span id="l3.610">                 // Change color on all nodes that don't do so themselves, which</span>
<a href="#l3.611"></a><span id="l3.611">                 // is currently only he agenda-richlist-item</span>
<a href="#l3.612"></a><span id="l3.612">                 if (node.localName != &quot;agenda-richlist-item&quot;) {</span>
<a href="#l3.613"></a><span id="l3.613">                     continue;</span>
<a href="#l3.614"></a><span id="l3.614">                 }</span>
<a href="#l3.615"></a><span id="l3.615">                 node.refreshColor();</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineat">@@ -1126,25 +1126,25 @@ var gEventTimer;</span>
<a href="#l3.617"></a><span id="l3.617">  *                                current.</span>
<a href="#l3.618"></a><span id="l3.618">  * @param aMsUntil              The number of milliseconds until the next event</span>
<a href="#l3.619"></a><span id="l3.619">  *                                is current.</span>
<a href="#l3.620"></a><span id="l3.620">  */</span>
<a href="#l3.621"></a><span id="l3.621"> function scheduleNextCurrentEventUpdate(aRefreshCallback, aMsUntil) {</span>
<a href="#l3.622"></a><span id="l3.622">     // Is an nsITimer/callback extreme overkill here? Yes, but it's necessary to</span>
<a href="#l3.623"></a><span id="l3.623">     // workaround bug 291386.  If we don't, we stand a decent chance of getting</span>
<a href="#l3.624"></a><span id="l3.624">     // stuck in an infinite loop.</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-    var udCallback = {</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+    let udCallback = {</span>
<a href="#l3.627"></a><span id="l3.627">         notify: function(timer) {</span>
<a href="#l3.628"></a><span id="l3.628">             aRefreshCallback();</span>
<a href="#l3.629"></a><span id="l3.629">         }</span>
<a href="#l3.630"></a><span id="l3.630">     };</span>
<a href="#l3.631"></a><span id="l3.631"> </span>
<a href="#l3.632"></a><span id="l3.632">     if (!gEventTimer) {</span>
<a href="#l3.633"></a><span id="l3.633">         // Observer for wake after sleep/hibernate/standby to create new timers and refresh UI</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-        var wakeObserver = {</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+        let wakeObserver = {</span>
<a href="#l3.636"></a><span id="l3.636">            observe: function(aSubject, aTopic, aData) {</span>
<a href="#l3.637"></a><span id="l3.637">                if (aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l3.638"></a><span id="l3.638">                    aRefreshCallback();</span>
<a href="#l3.639"></a><span id="l3.639">                }</span>
<a href="#l3.640"></a><span id="l3.640">            }</span>
<a href="#l3.641"></a><span id="l3.641">         };</span>
<a href="#l3.642"></a><span id="l3.642">         // Add observer</span>
<a href="#l3.643"></a><span id="l3.643">         Services.obs.addObserver(wakeObserver, &quot;wake_notification&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -263,21 +263,21 @@</span>
<a href="#l4.4"></a><span id="l4.4">             } else {</span>
<a href="#l4.5"></a><span id="l4.5">                 durationbox.textContent += &quot; &quot; + aItem.title;</span>
<a href="#l4.6"></a><span id="l4.6">             }</span>
<a href="#l4.7"></a><span id="l4.7">             this.refreshColor();</span>
<a href="#l4.8"></a><span id="l4.8">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.9"></a><span id="l4.9">       &lt;/method&gt;</span>
<a href="#l4.10"></a><span id="l4.10">       &lt;method name=&quot;refreshColor&quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            var calcolor = ((this.mOccurrence &amp;&amp;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+            let calcolor = ((this.mOccurrence &amp;&amp;</span>
<a href="#l4.14"></a><span id="l4.14">                              this.mOccurrence.calendar.getProperty(&quot;color&quot;)) ||</span>
<a href="#l4.15"></a><span id="l4.15">                             &quot;#a8c2e1&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-            var imagebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-calendar-image&quot;);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+            let imagebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-calendar-image&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">             imagebox.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + calcolor + &quot;;&quot;);</span>
<a href="#l4.20"></a><span id="l4.20">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.21"></a><span id="l4.21">       &lt;/method&gt;</span>
<a href="#l4.22"></a><span id="l4.22">     &lt;/implementation&gt;</span>
<a href="#l4.23"></a><span id="l4.23">     &lt;handlers&gt;</span>
<a href="#l4.24"></a><span id="l4.24">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l4.25"></a><span id="l4.25">         invokeEventDragSession(this.mOccurrence.clone(), this);</span>
<a href="#l4.26"></a><span id="l4.26">       ]]&gt;&lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -415,17 +415,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">           for (let i = 0; i &lt; labeldayboxkids.length; i++) {</span>
<a href="#l5.5"></a><span id="l5.5">               labeldayboxkids[i].shortWeekNames = useShortNames;</span>
<a href="#l5.6"></a><span id="l5.6">           }</span>
<a href="#l5.7"></a><span id="l5.7">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.8"></a><span id="l5.8">       &lt;/method&gt;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">       &lt;method name=&quot;today&quot;&gt;</span>
<a href="#l5.11"></a><span id="l5.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          var d = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          let d = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l5.14"></a><span id="l5.14">           d.isDate = true;</span>
<a href="#l5.15"></a><span id="l5.15">           return d;</span>
<a href="#l5.16"></a><span id="l5.16">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.17"></a><span id="l5.17">       &lt;/method&gt;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">       &lt;method name=&quot;isVisible&quot;&gt;</span>
<a href="#l5.20"></a><span id="l5.20">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.21"></a><span id="l5.21">             return (this.nodeName == currentView().nodeName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -84,17 +84,17 @@ var calendarController = {</span>
<a href="#l6.4"></a><span id="l6.4">         &quot;calendar_in_background&quot;: true,</span>
<a href="#l6.5"></a><span id="l6.5">         &quot;calendar_mode_calendar&quot;: true,</span>
<a href="#l6.6"></a><span id="l6.6">         &quot;calendar_mode_task&quot;: true,</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">         &quot;cmd_selectAll&quot;: true</span>
<a href="#l6.9"></a><span id="l6.9">     },</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">     updateCommands: function cC_updateCommands() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        for (var command in this.commands) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        for (let command in this.commands) {</span>
<a href="#l6.14"></a><span id="l6.14">             goUpdateCommand(command);</span>
<a href="#l6.15"></a><span id="l6.15">         }</span>
<a href="#l6.16"></a><span id="l6.16">     },</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">     supportsCommand: function cC_supportsCommand(aCommand) {</span>
<a href="#l6.19"></a><span id="l6.19">         if (aCommand in this.commands) {</span>
<a href="#l6.20"></a><span id="l6.20">             return true;</span>
<a href="#l6.21"></a><span id="l6.21">         }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -222,17 +222,17 @@ var calendarController = {</span>
<a href="#l6.23"></a><span id="l6.23">                 }</span>
<a href="#l6.24"></a><span id="l6.24">                 break;</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">             default:</span>
<a href="#l6.27"></a><span id="l6.27">                 if (this.defaultController &amp;&amp; !this.isCalendarInForeground()) {</span>
<a href="#l6.28"></a><span id="l6.28">                     // The delete-button demands a special handling in mail-mode</span>
<a href="#l6.29"></a><span id="l6.29">                     // as it is supposed to delete an element of the focused pane</span>
<a href="#l6.30"></a><span id="l6.30">                     if (aCommand == &quot;cmd_delete&quot; || aCommand == &quot;button_delete&quot;) {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                        var focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+                        let focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l6.33"></a><span id="l6.33">                         if (focusedElement) {</span>
<a href="#l6.34"></a><span id="l6.34">                             if (focusedElement.getAttribute(&quot;id&quot;) == &quot;agenda-listbox&quot;) {</span>
<a href="#l6.35"></a><span id="l6.35">                                  return agendaListbox.isEventSelected();</span>
<a href="#l6.36"></a><span id="l6.36">                             } else if (focusedElement.className == &quot;calendar-task-tree&quot;) {</span>
<a href="#l6.37"></a><span id="l6.37">                                  return this.writable &amp;&amp;</span>
<a href="#l6.38"></a><span id="l6.38">                                         this.todo_items_selected &amp;&amp;</span>
<a href="#l6.39"></a><span id="l6.39">                                         this.todo_items_writable;</span>
<a href="#l6.40"></a><span id="l6.40">                             }</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -439,28 +439,28 @@ var calendarController = {</span>
<a href="#l6.42"></a><span id="l6.42">                 return gCurrentMode &amp;&amp; gCurrentMode == &quot;calendar&quot;;</span>
<a href="#l6.43"></a><span id="l6.43">             case &quot;task&quot;:</span>
<a href="#l6.44"></a><span id="l6.44">                 return gCurrentMode &amp;&amp; gCurrentMode == &quot;task&quot;;</span>
<a href="#l6.45"></a><span id="l6.45">         }</span>
<a href="#l6.46"></a><span id="l6.46">         return false;</span>
<a href="#l6.47"></a><span id="l6.47">     },</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">     onSelectionChanged: function cC_onSelectionChanged(aEvent) {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-        var selectedItems = aEvent.detail;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+        let selectedItems = aEvent.detail;</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">         calendarUpdateDeleteCommand(selectedItems);</span>
<a href="#l6.54"></a><span id="l6.54">         calendarController.item_selected = selectedItems &amp;&amp; (selectedItems.length &gt; 0);</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">         let selLength = (selectedItems === undefined ? 0 : selectedItems.length);</span>
<a href="#l6.57"></a><span id="l6.57">         let selected_events_readonly = 0;</span>
<a href="#l6.58"></a><span id="l6.58">         let selected_events_requires_network = 0;</span>
<a href="#l6.59"></a><span id="l6.59">         let selected_events_invitation = 0;</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61">         if (selLength &gt; 0) {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-            for (var item of selectedItems) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+            for (let item of selectedItems) {</span>
<a href="#l6.64"></a><span id="l6.64">                 if (item.calendar.readOnly) {</span>
<a href="#l6.65"></a><span id="l6.65">                     selected_events_readonly++;</span>
<a href="#l6.66"></a><span id="l6.66">                 }</span>
<a href="#l6.67"></a><span id="l6.67">                 if (item.calendar.getProperty(&quot;requiresNetwork&quot;) &amp;&amp;</span>
<a href="#l6.68"></a><span id="l6.68">                     !item.calendar.getProperty(&quot;cache.enabled&quot;) &amp;&amp;</span>
<a href="#l6.69"></a><span id="l6.69">                     !item.calendar.getProperty(&quot;cache.always&quot;)) {</span>
<a href="#l6.70"></a><span id="l6.70">                     selected_events_requires_network++;</span>
<a href="#l6.71"></a><span id="l6.71">                 }</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineat">@@ -516,33 +516,33 @@ var calendarController = {</span>
<a href="#l6.73"></a><span id="l6.73">     get offline() {</span>
<a href="#l6.74"></a><span id="l6.74">         return Services.io.offline;</span>
<a href="#l6.75"></a><span id="l6.75">     },</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">     /**</span>
<a href="#l6.78"></a><span id="l6.78">      * Returns a boolean indicating if all calendars are readonly.</span>
<a href="#l6.79"></a><span id="l6.79">      */</span>
<a href="#l6.80"></a><span id="l6.80">     get all_readonly() {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-        var calMgr = getCalendarManager();</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+        let calMgr = getCalendarManager();</span>
<a href="#l6.83"></a><span id="l6.83">         return (calMgr.readOnlyCalendarCount == calMgr.calendarCount);</span>
<a href="#l6.84"></a><span id="l6.84">     },</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">     /**</span>
<a href="#l6.87"></a><span id="l6.87">      * Returns a boolean indicating if all calendars are local</span>
<a href="#l6.88"></a><span id="l6.88">      */</span>
<a href="#l6.89"></a><span id="l6.89">     get no_network_calendars() {</span>
<a href="#l6.90"></a><span id="l6.90">         return (getCalendarManager().networkCalendarCount == 0);</span>
<a href="#l6.91"></a><span id="l6.91">     },</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">     /**</span>
<a href="#l6.94"></a><span id="l6.94">      * Returns a boolean indicating if there are calendars that don't require</span>
<a href="#l6.95"></a><span id="l6.95">      * network access.</span>
<a href="#l6.96"></a><span id="l6.96">      */</span>
<a href="#l6.97"></a><span id="l6.97">     get has_local_calendars() {</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-        var calMgr = getCalendarManager();</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+        let calMgr = getCalendarManager();</span>
<a href="#l6.100"></a><span id="l6.100">         return (calMgr.networkCalendarCount &lt; calMgr.calendarCount);</span>
<a href="#l6.101"></a><span id="l6.101">     },</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">     /**</span>
<a href="#l6.104"></a><span id="l6.104">      * Returns a boolean indicating if there are cached calendars and thus that don't require</span>
<a href="#l6.105"></a><span id="l6.105">      * network access.</span>
<a href="#l6.106"></a><span id="l6.106">      */</span>
<a href="#l6.107"></a><span id="l6.107">     get has_cached_calendars() {</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineat">@@ -564,19 +564,19 @@ var calendarController = {</span>
<a href="#l6.109"></a><span id="l6.109">     },</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111">     /**</span>
<a href="#l6.112"></a><span id="l6.112">      * Returns a boolean indicating that all local calendars are readonly</span>
<a href="#l6.113"></a><span id="l6.113">      */</span>
<a href="#l6.114"></a><span id="l6.114">     get all_local_calendars_readonly() {</span>
<a href="#l6.115"></a><span id="l6.115">         // We might want to speed this part up by keeping track of this in the</span>
<a href="#l6.116"></a><span id="l6.116">         // calendar manager.</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-        var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-        var count = calendars.length;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-        for (var calendar of calendars) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+        let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+        let count = calendars.length;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+        for (let calendar of calendars) {</span>
<a href="#l6.123"></a><span id="l6.123">             if (!isCalendarWritable(calendar)) {</span>
<a href="#l6.124"></a><span id="l6.124">                 count--;</span>
<a href="#l6.125"></a><span id="l6.125">             }</span>
<a href="#l6.126"></a><span id="l6.126">         }</span>
<a href="#l6.127"></a><span id="l6.127">         return (count == 0);</span>
<a href="#l6.128"></a><span id="l6.128">     },</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130">     /**</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineat">@@ -589,17 +589,17 @@ var calendarController = {</span>
<a href="#l6.132"></a><span id="l6.132">                !this.selected_events_readonly &amp;&amp;</span>
<a href="#l6.133"></a><span id="l6.133">                (!this.offline || !this.selected_events_requires_network);</span>
<a href="#l6.134"></a><span id="l6.134">     },</span>
<a href="#l6.135"></a><span id="l6.135"> </span>
<a href="#l6.136"></a><span id="l6.136">     /**</span>
<a href="#l6.137"></a><span id="l6.137">      * Returns a boolean indicating that tasks are selected.</span>
<a href="#l6.138"></a><span id="l6.138">      */</span>
<a href="#l6.139"></a><span id="l6.139">     get todo_items_selected() {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-        var selectedTasks = getSelectedTasks();</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+        let selectedTasks = getSelectedTasks();</span>
<a href="#l6.142"></a><span id="l6.142">         return (selectedTasks.length &gt; 0);</span>
<a href="#l6.143"></a><span id="l6.143">     },</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146">     get todo_items_invitation() {</span>
<a href="#l6.147"></a><span id="l6.147">         let selectedTasks = getSelectedTasks();</span>
<a href="#l6.148"></a><span id="l6.148">         let selected_tasks_invitation = 0;</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150" class="difflineat">@@ -619,18 +619,18 @@ var calendarController = {</span>
<a href="#l6.151"></a><span id="l6.151">         return (selectedTasks.length == selected_tasks_invitation);</span>
<a href="#l6.152"></a><span id="l6.152">     },</span>
<a href="#l6.153"></a><span id="l6.153"> </span>
<a href="#l6.154"></a><span id="l6.154">     /**</span>
<a href="#l6.155"></a><span id="l6.155">      * Returns a boolean indicating that at least one task in the selection is</span>
<a href="#l6.156"></a><span id="l6.156">      * on a calendar that is writable.</span>
<a href="#l6.157"></a><span id="l6.157">      */</span>
<a href="#l6.158"></a><span id="l6.158">     get todo_items_writable() {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-        var selectedTasks = getSelectedTasks();</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-        for (var task of selectedTasks) {</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+        let selectedTasks = getSelectedTasks();</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+        for (let task of selectedTasks) {</span>
<a href="#l6.163"></a><span id="l6.163">             if (isCalendarWritable(task.calendar)) {</span>
<a href="#l6.164"></a><span id="l6.164">                 return true;</span>
<a href="#l6.165"></a><span id="l6.165">             }</span>
<a href="#l6.166"></a><span id="l6.166">         }</span>
<a href="#l6.167"></a><span id="l6.167">         return false;</span>
<a href="#l6.168"></a><span id="l6.168">     }</span>
<a href="#l6.169"></a><span id="l6.169"> };</span>
<a href="#l6.170"></a><span id="l6.170"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">       &lt;/xul:hbox&gt;</span>
<a href="#l7.5"></a><span id="l7.5">     &lt;/content&gt;</span>
<a href="#l7.6"></a><span id="l7.6">     &lt;implementation&gt;</span>
<a href="#l7.7"></a><span id="l7.7">       &lt;method name=&quot;onmodified&quot;&gt;</span>
<a href="#l7.8"></a><span id="l7.8">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l7.9"></a><span id="l7.9">         &lt;body&gt;</span>
<a href="#l7.10"></a><span id="l7.10">           &lt;![CDATA[</span>
<a href="#l7.11"></a><span id="l7.11">             if (aEvent.attrName == &quot;checked&quot;) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-                var event = document.createEvent('Events');</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                let event = document.createEvent('Events');</span>
<a href="#l7.14"></a><span id="l7.14">                 event.initEvent('select', true, true);</span>
<a href="#l7.15"></a><span id="l7.15">                 this.calendar.dispatchEvent(event);</span>
<a href="#l7.16"></a><span id="l7.16">             }</span>
<a href="#l7.17"></a><span id="l7.17">           ]]&gt;</span>
<a href="#l7.18"></a><span id="l7.18">         &lt;/body&gt;</span>
<a href="#l7.19"></a><span id="l7.19">       &lt;/method&gt;</span>
<a href="#l7.20"></a><span id="l7.20">       &lt;constructor&gt;</span>
<a href="#l7.21"></a><span id="l7.21">         &lt;![CDATA[</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -76,73 +76,73 @@</span>
<a href="#l7.23"></a><span id="l7.23">       &lt;!--</span>
<a href="#l7.24"></a><span id="l7.24">       The weekday-picker manages an array of selected days of the week and</span>
<a href="#l7.25"></a><span id="l7.25">       the 'days' property is the interface to this array. the expected argument is</span>
<a href="#l7.26"></a><span id="l7.26">       an array containing integer elements, where each element represents a selected</span>
<a href="#l7.27"></a><span id="l7.27">       day of the week, starting with SUNDAY=1.</span>
<a href="#l7.28"></a><span id="l7.28">       --&gt;</span>
<a href="#l7.29"></a><span id="l7.29">       &lt;property name=&quot;days&quot;&gt;</span>
<a href="#l7.30"></a><span id="l7.30">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-          var mainbox =</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+          let mainbox =</span>
<a href="#l7.33"></a><span id="l7.33">               document.getAnonymousElementByAttribute(</span>
<a href="#l7.34"></a><span id="l7.34">                   this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-          var numChilds = mainbox.childNodes.length;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+          let numChilds = mainbox.childNodes.length;</span>
<a href="#l7.37"></a><span id="l7.37">           for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-              var child = mainbox.childNodes[i];</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+              let child = mainbox.childNodes[i];</span>
<a href="#l7.40"></a><span id="l7.40">               child.removeAttribute(&quot;checked&quot;);</span>
<a href="#l7.41"></a><span id="l7.41">           }</span>
<a href="#l7.42"></a><span id="l7.42">           for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-              var index = val[i] - 1 - this.weekStartOffset;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+              let index = val[i] - 1 - this.weekStartOffset;</span>
<a href="#l7.45"></a><span id="l7.45">               if (index &lt; 0) {</span>
<a href="#l7.46"></a><span id="l7.46">                   index += 7;</span>
<a href="#l7.47"></a><span id="l7.47">               }</span>
<a href="#l7.48"></a><span id="l7.48">               mainbox.childNodes[index].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l7.49"></a><span id="l7.49">           }</span>
<a href="#l7.50"></a><span id="l7.50">           return val;</span>
<a href="#l7.51"></a><span id="l7.51">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.52"></a><span id="l7.52">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-          var mainbox =</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+          let mainbox =</span>
<a href="#l7.55"></a><span id="l7.55">               document.getAnonymousElementByAttribute(</span>
<a href="#l7.56"></a><span id="l7.56">                   this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-          var numChilds = mainbox.childNodes.length;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-          var days = [];</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-          for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-              var child = mainbox.childNodes[i];</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+          let numChilds = mainbox.childNodes.length;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+          let days = [];</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+          for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+              let child = mainbox.childNodes[i];</span>
<a href="#l7.65"></a><span id="l7.65">               if (child.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-                  var index = i + this.weekStartOffset;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+                  let index = i + this.weekStartOffset;</span>
<a href="#l7.68"></a><span id="l7.68">                   if (index &gt;= 7) {</span>
<a href="#l7.69"></a><span id="l7.69">                       index -= 7;</span>
<a href="#l7.70"></a><span id="l7.70">                   }</span>
<a href="#l7.71"></a><span id="l7.71">                   days.push(index + 1);</span>
<a href="#l7.72"></a><span id="l7.72">               }</span>
<a href="#l7.73"></a><span id="l7.73">           }</span>
<a href="#l7.74"></a><span id="l7.74">           return days;</span>
<a href="#l7.75"></a><span id="l7.75">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.76"></a><span id="l7.76">       &lt;/property&gt;</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.79"></a><span id="l7.79">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.80"></a><span id="l7.80">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">         this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l7.83"></a><span id="l7.83"> </span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-        var props =</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+        let props =</span>
<a href="#l7.86"></a><span id="l7.86">             Services.strings.createBundle(</span>
<a href="#l7.87"></a><span id="l7.87">                 &quot;chrome://calendar/locale/dateFormat.properties&quot;);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-        var mainbox =</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+        let mainbox =</span>
<a href="#l7.90"></a><span id="l7.90">             document.getAnonymousElementByAttribute(</span>
<a href="#l7.91"></a><span id="l7.91">                 this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-        var numChilds = mainbox.childNodes.length;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-        for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-            var child = mainbox.childNodes[i];</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-            var dow = i + this.weekStartOffset;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        let numChilds = mainbox.childNodes.length;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+        for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+            let child = mainbox.childNodes[i];</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+            let dow = i + this.weekStartOffset;</span>
<a href="#l7.100"></a><span id="l7.100">             if (dow &gt;= 7) {</span>
<a href="#l7.101"></a><span id="l7.101">                 dow -= 7;</span>
<a href="#l7.102"></a><span id="l7.102">             }</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-            var day = props.GetStringFromName(&quot;day.&quot; + (dow + 1) + &quot;.Mmm&quot;);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+            let day = props.GetStringFromName(&quot;day.&quot; + (dow + 1) + &quot;.Mmm&quot;);</span>
<a href="#l7.105"></a><span id="l7.105">             child.label = day;</span>
<a href="#l7.106"></a><span id="l7.106">             child.calendar = this;</span>
<a href="#l7.107"></a><span id="l7.107">         }</span>
<a href="#l7.108"></a><span id="l7.108">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110">     &lt;/implementation&gt;</span>
<a href="#l7.111"></a><span id="l7.111">   &lt;/binding&gt;</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113" class="difflineat">@@ -224,26 +224,26 @@</span>
<a href="#l7.114"></a><span id="l7.114">               let lastDayOffset = val[i] == -1 ? 0 : -1;</span>
<a href="#l7.115"></a><span id="l7.115">               let index = (val[i] &lt; 0 ? val[i] + days.length + lastDayOffset</span>
<a href="#l7.116"></a><span id="l7.116">                                       : val[i] - 1);</span>
<a href="#l7.117"></a><span id="l7.117">               days[index].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l7.118"></a><span id="l7.118">           }</span>
<a href="#l7.119"></a><span id="l7.119">           return val;</span>
<a href="#l7.120"></a><span id="l7.120">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.121"></a><span id="l7.121">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-          var mainbox =</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+          let mainbox =</span>
<a href="#l7.124"></a><span id="l7.124">               document.getAnonymousElementByAttribute(</span>
<a href="#l7.125"></a><span id="l7.125">                   this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-          var numRows = mainbox.childNodes.length;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-          var days = [];</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-          for (var i = 0; i &lt; numRows; i++) {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-              var row = mainbox.childNodes[i];</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-              var numChilds = row.childNodes.length;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-              for (var j = 0; j &lt; numChilds; j++) {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-                  var child = row.childNodes[j];</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+          let numRows = mainbox.childNodes.length;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+          let days = [];</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+          for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+              let row = mainbox.childNodes[i];</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+              let numChilds = row.childNodes.length;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+              for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+                  let child = row.childNodes[j];</span>
<a href="#l7.140"></a><span id="l7.140">                   if (child.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l7.141"></a><span id="l7.141">                       days.push(Number(child.label) ? Number(child.label) : -1);</span>
<a href="#l7.142"></a><span id="l7.142">                   }</span>
<a href="#l7.143"></a><span id="l7.143">               }</span>
<a href="#l7.144"></a><span id="l7.144">           }</span>
<a href="#l7.145"></a><span id="l7.145">           return days;</span>
<a href="#l7.146"></a><span id="l7.146">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.147"></a><span id="l7.147">       &lt;/property&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -24,17 +24,17 @@ var gInvitationsRequestManager = {</span>
<a href="#l8.4"></a><span id="l8.4">             this.mRequestStatusList[calendar.id] = op;</span>
<a href="#l8.5"></a><span id="l8.5">         }</span>
<a href="#l8.6"></a><span id="l8.6">     },</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">     /**</span>
<a href="#l8.9"></a><span id="l8.9">      * Cancel all pending requests</span>
<a href="#l8.10"></a><span id="l8.10">      */</span>
<a href="#l8.11"></a><span id="l8.11">     cancelPendingRequests: function IRM_cancelPendingRequests() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        for (var id in this.mRequestStatusList) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        for (let id in this.mRequestStatusList) {</span>
<a href="#l8.14"></a><span id="l8.14">             let request = this.mRequestStatusList[id];</span>
<a href="#l8.15"></a><span id="l8.15">             if (request &amp;&amp; request.isPending) {</span>
<a href="#l8.16"></a><span id="l8.16">                 request.cancel(null);</span>
<a href="#l8.17"></a><span id="l8.17">             }</span>
<a href="#l8.18"></a><span id="l8.18">         }</span>
<a href="#l8.19"></a><span id="l8.19">         this.mRequestStatusList = {};</span>
<a href="#l8.20"></a><span id="l8.20">     }</span>
<a href="#l8.21"></a><span id="l8.21"> };</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -61,17 +61,17 @@ function getInvitationsManager() {</span>
<a href="#l8.23"></a><span id="l8.23">  * @constructor</span>
<a href="#l8.24"></a><span id="l8.24">  */</span>
<a href="#l8.25"></a><span id="l8.25"> function InvitationsManager() {</span>
<a href="#l8.26"></a><span id="l8.26">     this.mItemList = [];</span>
<a href="#l8.27"></a><span id="l8.27">     this.mStartDate = null;</span>
<a href="#l8.28"></a><span id="l8.28">     this.mJobsPending = 0;</span>
<a href="#l8.29"></a><span id="l8.29">     this.mTimer = null;</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    var self = this;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    let self = this;</span>
<a href="#l8.33"></a><span id="l8.33">     window.addEventListener(&quot;unload&quot;, function() {</span>
<a href="#l8.34"></a><span id="l8.34">         // Unload handlers get removed automatically</span>
<a href="#l8.35"></a><span id="l8.35">         self.cancelInvitationsUpdate();</span>
<a href="#l8.36"></a><span id="l8.36">     }, false);</span>
<a href="#l8.37"></a><span id="l8.37"> }</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39"> InvitationsManager.prototype = {</span>
<a href="#l8.40"></a><span id="l8.40">     mItemList: null,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -84,17 +84,17 @@ InvitationsManager.prototype = {</span>
<a href="#l8.42"></a><span id="l8.42">      *</span>
<a href="#l8.43"></a><span id="l8.43">      * @param firstDelay          The timeout before the operation should start.</span>
<a href="#l8.44"></a><span id="l8.44">      * @param operationListener   The calIGenericOperationListener to notify.</span>
<a href="#l8.45"></a><span id="l8.45">      */</span>
<a href="#l8.46"></a><span id="l8.46">     scheduleInvitationsUpdate: function IM_scheduleInvitationsUpdate(firstDelay,</span>
<a href="#l8.47"></a><span id="l8.47">                                                                      operationListener) {</span>
<a href="#l8.48"></a><span id="l8.48">         this.cancelInvitationsUpdate();</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        var self = this;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+        let self = this;</span>
<a href="#l8.52"></a><span id="l8.52">         this.mTimer = setTimeout(function startInvitationsTimer() {</span>
<a href="#l8.53"></a><span id="l8.53">             if (Preferences.get(&quot;calendar.invitations.autorefresh.enabled&quot;, true)) {</span>
<a href="#l8.54"></a><span id="l8.54">                 self.mTimer = setInterval(function repeatingInvitationsTimer() {</span>
<a href="#l8.55"></a><span id="l8.55">                     self.getInvitations(operationListener);</span>
<a href="#l8.56"></a><span id="l8.56">                     }, Preferences.get(&quot;calendar.invitations.autorefresh.timeout&quot;, 3) * 60000);</span>
<a href="#l8.57"></a><span id="l8.57">             }</span>
<a href="#l8.58"></a><span id="l8.58">             self.getInvitations(operationListener);</span>
<a href="#l8.59"></a><span id="l8.59">         }, firstDelay);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineat">@@ -112,48 +112,48 @@ InvitationsManager.prototype = {</span>
<a href="#l8.61"></a><span id="l8.61">      * operation listeners.</span>
<a href="#l8.62"></a><span id="l8.62">      *</span>
<a href="#l8.63"></a><span id="l8.63">      * @param operationListener1    The first operation listener to notify.</span>
<a href="#l8.64"></a><span id="l8.64">      * @param operationListener2    (optinal) The second operation listener to</span>
<a href="#l8.65"></a><span id="l8.65">      *                                notify.</span>
<a href="#l8.66"></a><span id="l8.66">      */</span>
<a href="#l8.67"></a><span id="l8.67">     getInvitations: function IM_getInvitations(operationListener1,</span>
<a href="#l8.68"></a><span id="l8.68">                                                operationListener2) {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-        var listeners = [];</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+        let listeners = [];</span>
<a href="#l8.71"></a><span id="l8.71">         if (operationListener1) {</span>
<a href="#l8.72"></a><span id="l8.72">             listeners.push(operationListener1);</span>
<a href="#l8.73"></a><span id="l8.73">         }</span>
<a href="#l8.74"></a><span id="l8.74">         if (operationListener2) {</span>
<a href="#l8.75"></a><span id="l8.75">             listeners.push(operationListener2);</span>
<a href="#l8.76"></a><span id="l8.76">         }</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78">         gInvitationsRequestManager.cancelPendingRequests();</span>
<a href="#l8.79"></a><span id="l8.79">         this.updateStartDate();</span>
<a href="#l8.80"></a><span id="l8.80">         this.deleteAllItems();</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-        var cals = getCalendarManager().getCalendars({});</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        let cals = getCalendarManager().getCalendars({});</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-        var opListener = {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+        let opListener = {</span>
<a href="#l8.87"></a><span id="l8.87">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l8.88"></a><span id="l8.88">             mCount: cals.length,</span>
<a href="#l8.89"></a><span id="l8.89">             mRequestManager: gInvitationsRequestManager,</span>
<a href="#l8.90"></a><span id="l8.90">             mInvitationsManager: this,</span>
<a href="#l8.91"></a><span id="l8.91">             mHandledItems: {},</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93">             // calIOperationListener</span>
<a href="#l8.94"></a><span id="l8.94">             onOperationComplete: function(aCalendar,</span>
<a href="#l8.95"></a><span id="l8.95">                                           aStatus,</span>
<a href="#l8.96"></a><span id="l8.96">                                           aOperationType,</span>
<a href="#l8.97"></a><span id="l8.97">                                           aId,</span>
<a href="#l8.98"></a><span id="l8.98">                                           aDetail) {</span>
<a href="#l8.99"></a><span id="l8.99">                 if (--this.mCount == 0) {</span>
<a href="#l8.100"></a><span id="l8.100">                     this.mInvitationsManager.mItemList.sort((a, b) =&gt; {</span>
<a href="#l8.101"></a><span id="l8.101">                         return a.startDate.compare(b.startDate);</span>
<a href="#l8.102"></a><span id="l8.102">                     });</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-                    for (var listener of listeners) {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+                    for (let listener of listeners) {</span>
<a href="#l8.105"></a><span id="l8.105">                         try {</span>
<a href="#l8.106"></a><span id="l8.106">                             if (this.mInvitationsManager.mItemList.length) {</span>
<a href="#l8.107"></a><span id="l8.107">                                 // Only call if there are actually items</span>
<a href="#l8.108"></a><span id="l8.108">                                 listener.onGetResult(null,</span>
<a href="#l8.109"></a><span id="l8.109">                                                      Components.results.NS_OK,</span>
<a href="#l8.110"></a><span id="l8.110">                                                      Components.interfaces.calIItemBase,</span>
<a href="#l8.111"></a><span id="l8.111">                                                      null,</span>
<a href="#l8.112"></a><span id="l8.112">                                                      this.mInvitationsManager.mItemList.length,</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineat">@@ -173,48 +173,48 @@ InvitationsManager.prototype = {</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">             onGetResult: function(aCalendar,</span>
<a href="#l8.116"></a><span id="l8.116">                                   aStatus,</span>
<a href="#l8.117"></a><span id="l8.117">                                   aItemType,</span>
<a href="#l8.118"></a><span id="l8.118">                                   aDetail,</span>
<a href="#l8.119"></a><span id="l8.119">                                   aCount,</span>
<a href="#l8.120"></a><span id="l8.120">                                   aItems) {</span>
<a href="#l8.121"></a><span id="l8.121">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-                    for (var item of aItems) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+                    for (let item of aItems) {</span>
<a href="#l8.124"></a><span id="l8.124">                         // we need to retrieve by occurrence to properly filter exceptions,</span>
<a href="#l8.125"></a><span id="l8.125">                         // should be fixed with bug 416975</span>
<a href="#l8.126"></a><span id="l8.126">                         item = item.parentItem;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-                        var hid = item.hashId;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+                        let hid = item.hashId;</span>
<a href="#l8.129"></a><span id="l8.129">                         if (!this.mHandledItems[hid]) {</span>
<a href="#l8.130"></a><span id="l8.130">                             this.mHandledItems[hid] = true;</span>
<a href="#l8.131"></a><span id="l8.131">                             this.mInvitationsManager.addItem(item);</span>
<a href="#l8.132"></a><span id="l8.132">                         }</span>
<a href="#l8.133"></a><span id="l8.133">                     }</span>
<a href="#l8.134"></a><span id="l8.134">                 }</span>
<a href="#l8.135"></a><span id="l8.135">             }</span>
<a href="#l8.136"></a><span id="l8.136">         };</span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-        for (var calendar of cals) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+        for (let calendar of cals) {</span>
<a href="#l8.140"></a><span id="l8.140">             if (!isCalendarWritable(calendar) || calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.141"></a><span id="l8.141">                 opListener.onOperationComplete();</span>
<a href="#l8.142"></a><span id="l8.142">                 continue;</span>
<a href="#l8.143"></a><span id="l8.143">             }</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145">             // temporary hack unless calCachedCalendar supports REQUEST_NEEDS_ACTION filter:</span>
<a href="#l8.146"></a><span id="l8.146">             calendar = calendar.getProperty(&quot;cache.uncachedCalendar&quot;);</span>
<a href="#l8.147"></a><span id="l8.147">             if (!calendar) {</span>
<a href="#l8.148"></a><span id="l8.148">                 opListener.onOperationComplete();</span>
<a href="#l8.149"></a><span id="l8.149">                 continue;</span>
<a href="#l8.150"></a><span id="l8.150">             }</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152">             try {</span>
<a href="#l8.153"></a><span id="l8.153">                 calendar = calendar.QueryInterface(Components.interfaces.calICalendar);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-                var endDate = this.mStartDate.clone();</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+                let endDate = this.mStartDate.clone();</span>
<a href="#l8.156"></a><span id="l8.156">                 endDate.year += 1;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-                var op = calendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION |</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+                let op = calendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION |</span>
<a href="#l8.159"></a><span id="l8.159">                                            Components.interfaces.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l8.160"></a><span id="l8.160">                                            // we need to retrieve by occurrence to properly filter exceptions,</span>
<a href="#l8.161"></a><span id="l8.161">                                            // should be fixed with bug 416975</span>
<a href="#l8.162"></a><span id="l8.162">                                            Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES,</span>
<a href="#l8.163"></a><span id="l8.163">                                            0, this.mStartDate,</span>
<a href="#l8.164"></a><span id="l8.164">                                            endDate /* we currently cannot pass null here, because of bug 416975 */,</span>
<a href="#l8.165"></a><span id="l8.165">                                            opListener);</span>
<a href="#l8.166"></a><span id="l8.166">                 gInvitationsRequestManager.addRequestStatus(calendar, op);</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineat">@@ -234,17 +234,17 @@ InvitationsManager.prototype = {</span>
<a href="#l8.168"></a><span id="l8.168">      * @param onLoadOpListener          The operation listener to notify when</span>
<a href="#l8.169"></a><span id="l8.169">      *                                    getting invitations. Should be passed</span>
<a href="#l8.170"></a><span id="l8.170">      *                                    to this.getInvitations().</span>
<a href="#l8.171"></a><span id="l8.171">      * @param finishedCallBack          A callback function to call when the</span>
<a href="#l8.172"></a><span id="l8.172">      *                                    dialog has completed.</span>
<a href="#l8.173"></a><span id="l8.173">      */</span>
<a href="#l8.174"></a><span id="l8.174">     openInvitationsDialog: function IM_openInvitationsDialog(onLoadOpListener,</span>
<a href="#l8.175"></a><span id="l8.175">                                                              finishedCallBack) {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-        var args = {};</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+        let args = {};</span>
<a href="#l8.178"></a><span id="l8.178">         args.onLoadOperationListener = onLoadOpListener;</span>
<a href="#l8.179"></a><span id="l8.179">         args.queue = [];</span>
<a href="#l8.180"></a><span id="l8.180">         args.finishedCallBack = finishedCallBack;</span>
<a href="#l8.181"></a><span id="l8.181">         args.requestManager = gInvitationsRequestManager;</span>
<a href="#l8.182"></a><span id="l8.182">         args.invitationsManager = this;</span>
<a href="#l8.183"></a><span id="l8.183">         // the dialog will reset this to auto when it is done loading</span>
<a href="#l8.184"></a><span id="l8.184">         window.setCursor(&quot;wait&quot;);</span>
<a href="#l8.185"></a><span id="l8.185">         // open the dialog</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineat">@@ -298,20 +298,20 @@ InvitationsManager.prototype = {</span>
<a href="#l8.187"></a><span id="l8.187">                                   aDetail,</span>
<a href="#l8.188"></a><span id="l8.188">                                   aCount,</span>
<a href="#l8.189"></a><span id="l8.189">                                   aItems) {</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191">             }</span>
<a href="#l8.192"></a><span id="l8.192">         };</span>
<a href="#l8.193"></a><span id="l8.193"> </span>
<a href="#l8.194"></a><span id="l8.194">         this.mJobsPending = 0;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-        for (var i = 0; i &lt; queue.length; i++) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-            var job = queue[i];</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-            var oldItem = job.oldItem;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-            var newItem = job.newItem;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+        for (let i = 0; i &lt; queue.length; i++) {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+            let job = queue[i];</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+            let oldItem = job.oldItem;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+            let newItem = job.newItem;</span>
<a href="#l8.203"></a><span id="l8.203">             switch (job.action) {</span>
<a href="#l8.204"></a><span id="l8.204">                 case 'modify':</span>
<a href="#l8.205"></a><span id="l8.205">                     this.mJobsPending++;</span>
<a href="#l8.206"></a><span id="l8.206">                     newItem.calendar.modifyItem(newItem,</span>
<a href="#l8.207"></a><span id="l8.207">                                                 oldItem,</span>
<a href="#l8.208"></a><span id="l8.208">                                                 new operationListener(this, jobQueueFinishedCallBack, oldItem));</span>
<a href="#l8.209"></a><span id="l8.209">                     break;</span>
<a href="#l8.210"></a><span id="l8.210">                 default:</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineat">@@ -326,53 +326,53 @@ InvitationsManager.prototype = {</span>
<a href="#l8.212"></a><span id="l8.212">     /**</span>
<a href="#l8.213"></a><span id="l8.213">      * Checks if the internal item list contains the given item</span>
<a href="#l8.214"></a><span id="l8.214">      * XXXdbo       Please document these correctly.</span>
<a href="#l8.215"></a><span id="l8.215">      *</span>
<a href="#l8.216"></a><span id="l8.216">      * @param item      The item to look for.</span>
<a href="#l8.217"></a><span id="l8.217">      * @return          A boolean value indicating if the item was found.</span>
<a href="#l8.218"></a><span id="l8.218">      */</span>
<a href="#l8.219"></a><span id="l8.219">     hasItem: function IM_hasItem(item) {</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-        var hid = item.hashId;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+        let hid = item.hashId;</span>
<a href="#l8.222"></a><span id="l8.222">         return this.mItemList.some(</span>
<a href="#l8.223"></a><span id="l8.223">             function someFunc(item_) {</span>
<a href="#l8.224"></a><span id="l8.224">                 return hid == item_.hashId;</span>
<a href="#l8.225"></a><span id="l8.225">             });</span>
<a href="#l8.226"></a><span id="l8.226">     },</span>
<a href="#l8.227"></a><span id="l8.227"> </span>
<a href="#l8.228"></a><span id="l8.228">     /**</span>
<a href="#l8.229"></a><span id="l8.229">      * Adds an item to the internal item list.</span>
<a href="#l8.230"></a><span id="l8.230">      * XXXdbo       Please document these correctly.</span>
<a href="#l8.231"></a><span id="l8.231">      *</span>
<a href="#l8.232"></a><span id="l8.232">      * @param item      The item to add.</span>
<a href="#l8.233"></a><span id="l8.233">      */</span>
<a href="#l8.234"></a><span id="l8.234">     addItem: function IM_addItem(item) {</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-        var recInfo = item.recurrenceInfo;</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+        let recInfo = item.recurrenceInfo;</span>
<a href="#l8.237"></a><span id="l8.237">         if (recInfo &amp;&amp; !cal.isOpenInvitation(item)) {</span>
<a href="#l8.238"></a><span id="l8.238">             // scan exceptions:</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-            var ids = recInfo.getExceptionIds({});</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-            for (var id of ids) {</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-                var ex = recInfo.getExceptionFor(id);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+            let ids = recInfo.getExceptionIds({});</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+            for (let id of ids) {</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+                let ex = recInfo.getExceptionFor(id);</span>
<a href="#l8.245"></a><span id="l8.245">                 if (ex &amp;&amp; this.validateItem(ex) &amp;&amp; !this.hasItem(ex)) {</span>
<a href="#l8.246"></a><span id="l8.246">                     this.mItemList.push(ex);</span>
<a href="#l8.247"></a><span id="l8.247">                 }</span>
<a href="#l8.248"></a><span id="l8.248">             }</span>
<a href="#l8.249"></a><span id="l8.249">         } else if (this.validateItem(item) &amp;&amp; !this.hasItem(item)) {</span>
<a href="#l8.250"></a><span id="l8.250">             this.mItemList.push(item);</span>
<a href="#l8.251"></a><span id="l8.251">         }</span>
<a href="#l8.252"></a><span id="l8.252">     },</span>
<a href="#l8.253"></a><span id="l8.253"> </span>
<a href="#l8.254"></a><span id="l8.254">     /**</span>
<a href="#l8.255"></a><span id="l8.255">      * Removes an item from the internal item list</span>
<a href="#l8.256"></a><span id="l8.256">      * XXXdbo       Please document these correctly.</span>
<a href="#l8.257"></a><span id="l8.257">      *</span>
<a href="#l8.258"></a><span id="l8.258">      * @param item      The item to remove.</span>
<a href="#l8.259"></a><span id="l8.259">      */</span>
<a href="#l8.260"></a><span id="l8.260">     deleteItem: function IM_deleteItem(item) {</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-        var id = item.id;</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+        let id = item.id;</span>
<a href="#l8.263"></a><span id="l8.263">         this.mItemList.filter(</span>
<a href="#l8.264"></a><span id="l8.264">             function filterFunc(item_) {</span>
<a href="#l8.265"></a><span id="l8.265">                 return id != item_.id;</span>
<a href="#l8.266"></a><span id="l8.266">             });</span>
<a href="#l8.267"></a><span id="l8.267">     },</span>
<a href="#l8.268"></a><span id="l8.268"> </span>
<a href="#l8.269"></a><span id="l8.269">     /**</span>
<a href="#l8.270"></a><span id="l8.270">      * Remove all items from the internal item list</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineat">@@ -384,33 +384,33 @@ InvitationsManager.prototype = {</span>
<a href="#l8.272"></a><span id="l8.272"> </span>
<a href="#l8.273"></a><span id="l8.273">     /**</span>
<a href="#l8.274"></a><span id="l8.274">      * Helper function to create a start date to search from. This date is the</span>
<a href="#l8.275"></a><span id="l8.275">      * current time with hour/minute/second set to zero.</span>
<a href="#l8.276"></a><span id="l8.276">      *</span>
<a href="#l8.277"></a><span id="l8.277">      * @return      Potential start date.</span>
<a href="#l8.278"></a><span id="l8.278">      */</span>
<a href="#l8.279"></a><span id="l8.279">     getStartDate: function IM_getStartDate() {</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-        var date = now();</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+        let date = now();</span>
<a href="#l8.282"></a><span id="l8.282">         date.second = 0;</span>
<a href="#l8.283"></a><span id="l8.283">         date.minute = 0;</span>
<a href="#l8.284"></a><span id="l8.284">         date.hour = 0;</span>
<a href="#l8.285"></a><span id="l8.285">         return date;</span>
<a href="#l8.286"></a><span id="l8.286">     },</span>
<a href="#l8.287"></a><span id="l8.287"> </span>
<a href="#l8.288"></a><span id="l8.288">     /**</span>
<a href="#l8.289"></a><span id="l8.289">      * Updates the start date for the invitations manager to the date returned</span>
<a href="#l8.290"></a><span id="l8.290">      * from this.getStartDate(), unless the previously existing start date is</span>
<a href="#l8.291"></a><span id="l8.291">      * the same or after what getStartDate() returned.</span>
<a href="#l8.292"></a><span id="l8.292">      */</span>
<a href="#l8.293"></a><span id="l8.293">     updateStartDate: function IM_updateStartDate() {</span>
<a href="#l8.294"></a><span id="l8.294">         if (!this.mStartDate) {</span>
<a href="#l8.295"></a><span id="l8.295">             this.mStartDate = this.getStartDate();</span>
<a href="#l8.296"></a><span id="l8.296">         } else {</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-            var startDate = this.getStartDate();</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+            let startDate = this.getStartDate();</span>
<a href="#l8.299"></a><span id="l8.299">             if (startDate.compare(this.mStartDate) &gt; 0) {</span>
<a href="#l8.300"></a><span id="l8.300">                 this.mStartDate = startDate;</span>
<a href="#l8.301"></a><span id="l8.301">             }</span>
<a href="#l8.302"></a><span id="l8.302">         }</span>
<a href="#l8.303"></a><span id="l8.303">     },</span>
<a href="#l8.304"></a><span id="l8.304"> </span>
<a href="#l8.305"></a><span id="l8.305">     /**</span>
<a href="#l8.306"></a><span id="l8.306">      * Checks if the item is valid for the invitation manager. Checks if the</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineat">@@ -420,13 +420,13 @@ InvitationsManager.prototype = {</span>
<a href="#l8.308"></a><span id="l8.308">      * @param item      The item to check</span>
<a href="#l8.309"></a><span id="l8.309">      * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l8.310"></a><span id="l8.310">      */</span>
<a href="#l8.311"></a><span id="l8.311">     validateItem: function IM_validateItem(item) {</span>
<a href="#l8.312"></a><span id="l8.312">         if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l8.313"></a><span id="l8.313">             !item.calendar.isInvitation(item)) {</span>
<a href="#l8.314"></a><span id="l8.314">             return false; // exclude if organizer has invited himself</span>
<a href="#l8.315"></a><span id="l8.315">         }</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-        var start = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+        let start = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l8.318"></a><span id="l8.318">         return (cal.isOpenInvitation(item) &amp;&amp;</span>
<a href="#l8.319"></a><span id="l8.319">                 start.compare(this.mStartDate) &gt;= 0);</span>
<a href="#l8.320"></a><span id="l8.320">     }</span>
<a href="#l8.321"></a><span id="l8.321"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -222,17 +222,17 @@ function setDefaultItemValues(aItem, aCa</span>
<a href="#l9.4"></a><span id="l9.4">  * @param summary       (optional) The event's title.</span>
<a href="#l9.5"></a><span id="l9.5">  * @param event         (optional) A template event to show in the dialog</span>
<a href="#l9.6"></a><span id="l9.6">  * @param aForceAllDay  (optional) Make sure the event shown in the dialog is an</span>
<a href="#l9.7"></a><span id="l9.7">  *                                   allday event.</span>
<a href="#l9.8"></a><span id="l9.8">  */</span>
<a href="#l9.9"></a><span id="l9.9"> function createEventWithDialog(calendar, startDate, endDate, summary, event, aForceAllday) {</span>
<a href="#l9.10"></a><span id="l9.10">     const kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    var onNewEvent = function(item, opcalendar, originalItem, listener) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    let onNewEvent = function(item, opcalendar, originalItem, listener) {</span>
<a href="#l9.14"></a><span id="l9.14">         if (item.id) {</span>
<a href="#l9.15"></a><span id="l9.15">             // If the item already has an id, then this is the result of</span>
<a href="#l9.16"></a><span id="l9.16">             // saving the item without closing, and then saving again.</span>
<a href="#l9.17"></a><span id="l9.17">             doTransaction('modify', item, opcalendar, originalItem, listener);</span>
<a href="#l9.18"></a><span id="l9.18">         } else {</span>
<a href="#l9.19"></a><span id="l9.19">             // Otherwise, this is an addition</span>
<a href="#l9.20"></a><span id="l9.20">             doTransaction('add', item, opcalendar, null, listener);</span>
<a href="#l9.21"></a><span id="l9.21">         }</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -279,17 +279,17 @@ function createEventWithDialog(calendar,</span>
<a href="#l9.23"></a><span id="l9.23">  * @param dueDate       (optional) The task's due date.</span>
<a href="#l9.24"></a><span id="l9.24">  * @param summary       (optional) The task's title.</span>
<a href="#l9.25"></a><span id="l9.25">  * @param todo          (optional) A template task to show in the dialog.</span>
<a href="#l9.26"></a><span id="l9.26">  * @param initialDate   (optional) The initial date for new task datepickers</span>
<a href="#l9.27"></a><span id="l9.27">  */</span>
<a href="#l9.28"></a><span id="l9.28"> function createTodoWithDialog(calendar, dueDate, summary, todo, initialDate) {</span>
<a href="#l9.29"></a><span id="l9.29">     const kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    var onNewItem = function(item, opcalendar, originalItem, listener) {</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    let onNewItem = function(item, opcalendar, originalItem, listener) {</span>
<a href="#l9.33"></a><span id="l9.33">         if (item.id) {</span>
<a href="#l9.34"></a><span id="l9.34">             // If the item already has an id, then this is the result of</span>
<a href="#l9.35"></a><span id="l9.35">             // saving the item without closing, and then saving again.</span>
<a href="#l9.36"></a><span id="l9.36">             doTransaction('modify', item, opcalendar, originalItem, listener);</span>
<a href="#l9.37"></a><span id="l9.37">         } else {</span>
<a href="#l9.38"></a><span id="l9.38">             // Otherwise, this is an addition</span>
<a href="#l9.39"></a><span id="l9.39">             doTransaction('add', item, opcalendar, null, listener);</span>
<a href="#l9.40"></a><span id="l9.40">         }</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -372,20 +372,20 @@ function openEventDialog(calendarItem, c</span>
<a href="#l9.42"></a><span id="l9.42">         dlg.focus();</span>
<a href="#l9.43"></a><span id="l9.43">         disposeJob(job);</span>
<a href="#l9.44"></a><span id="l9.44">         return;</span>
<a href="#l9.45"></a><span id="l9.45">     }</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47">     // Set up some defaults</span>
<a href="#l9.48"></a><span id="l9.48">     mode = mode || &quot;new&quot;;</span>
<a href="#l9.49"></a><span id="l9.49">     calendar = calendar || getSelectedCalendar();</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-    var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l9.52"></a><span id="l9.52">     calendars = calendars.filter(isCalendarWritable);</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    var isItemSupported;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    let isItemSupported;</span>
<a href="#l9.56"></a><span id="l9.56">     if (isToDo(calendarItem)) {</span>
<a href="#l9.57"></a><span id="l9.57">         isItemSupported = function isTodoSupported(aCalendar) {</span>
<a href="#l9.58"></a><span id="l9.58">             return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l9.59"></a><span id="l9.59">         };</span>
<a href="#l9.60"></a><span id="l9.60">     } else if (isEvent(calendarItem)) {</span>
<a href="#l9.61"></a><span id="l9.61">         isItemSupported = function isEventSupported(aCalendar) {</span>
<a href="#l9.62"></a><span id="l9.62">             return (aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false);</span>
<a href="#l9.63"></a><span id="l9.63">         };</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineat">@@ -429,17 +429,17 @@ function openEventDialog(calendarItem, c</span>
<a href="#l9.65"></a><span id="l9.65">                 // choice. Since we are shortly before a release to keep</span>
<a href="#l9.66"></a><span id="l9.66">                 // regression risk low, explicitly set the item's calendar here.</span>
<a href="#l9.67"></a><span id="l9.67">                 calendarItem.calendar = calendars[0];</span>
<a href="#l9.68"></a><span id="l9.68">             }</span>
<a href="#l9.69"></a><span id="l9.69">         }</span>
<a href="#l9.70"></a><span id="l9.70">     }</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72">     // Setup the window arguments</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-    var args = {};</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+    let args = {};</span>
<a href="#l9.75"></a><span id="l9.75">     args.calendarEvent = calendarItem;</span>
<a href="#l9.76"></a><span id="l9.76">     args.calendar = calendar;</span>
<a href="#l9.77"></a><span id="l9.77">     args.mode = mode;</span>
<a href="#l9.78"></a><span id="l9.78">     args.onOk = callback;</span>
<a href="#l9.79"></a><span id="l9.79">     args.job = job;</span>
<a href="#l9.80"></a><span id="l9.80">     args.initialStartDateValue = (initialDate || getDefaultStartDate());</span>
<a href="#l9.81"></a><span id="l9.81">     args.inTab = Preferences.get(&quot;calendar.item.editInTab&quot;, false);</span>
<a href="#l9.82"></a><span id="l9.82">     args.useNewItemUI = Preferences.get(&quot;calendar.item.useNewItemUI&quot;, false);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineat">@@ -539,32 +539,32 @@ function openEventDialog(calendarItem, c</span>
<a href="#l9.84"></a><span id="l9.84">  *                                        response of the dialog as a constant.</span>
<a href="#l9.85"></a><span id="l9.85">  */</span>
<a href="#l9.86"></a><span id="l9.86"> function promptOccurrenceModification(aItem, aNeedsFuture, aAction) {</span>
<a href="#l9.87"></a><span id="l9.87">     const CANCEL = 0;</span>
<a href="#l9.88"></a><span id="l9.88">     const MODIFY_OCCURRENCE = 1;</span>
<a href="#l9.89"></a><span id="l9.89">     const MODIFY_FOLLOWING = 2;</span>
<a href="#l9.90"></a><span id="l9.90">     const MODIFY_PARENT = 3;</span>
<a href="#l9.91"></a><span id="l9.91"> </span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-    var futureItem = false;</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-    var pastItem;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    var type = CANCEL;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+    let futureItem = false;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    let pastItem;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    let type = CANCEL;</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99">     // Check if this actually is an instance of a recurring event</span>
<a href="#l9.100"></a><span id="l9.100">     if (aItem == aItem.parentItem) {</span>
<a href="#l9.101"></a><span id="l9.101">         type = MODIFY_PARENT;</span>
<a href="#l9.102"></a><span id="l9.102">     } else if (aItem.parentItem.recurrenceInfo.getExceptionFor(aItem.recurrenceId)) {</span>
<a href="#l9.103"></a><span id="l9.103">         // If the user wants to edit an occurrence which is already an exception</span>
<a href="#l9.104"></a><span id="l9.104">         // always edit this single item.</span>
<a href="#l9.105"></a><span id="l9.105">         // XXX  Why? I think its ok to ask also for exceptions.</span>
<a href="#l9.106"></a><span id="l9.106">         type = MODIFY_OCCURRENCE;</span>
<a href="#l9.107"></a><span id="l9.107">     } else {</span>
<a href="#l9.108"></a><span id="l9.108">         // Prompt the user. Setting modal blocks the dialog until it is closed. We</span>
<a href="#l9.109"></a><span id="l9.109">         // use rv to pass our return value.</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-        var rv = { value: CANCEL, item: aItem, action: aAction};</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+        let rv = { value: CANCEL, item: aItem, action: aAction};</span>
<a href="#l9.112"></a><span id="l9.112">         window.openDialog(&quot;chrome://calendar/content/calendar-occurrence-prompt.xul&quot;,</span>
<a href="#l9.113"></a><span id="l9.113">                           &quot;PromptOccurrenceModification&quot;,</span>
<a href="#l9.114"></a><span id="l9.114">                           &quot;centerscreen,chrome,modal,titlebar&quot;,</span>
<a href="#l9.115"></a><span id="l9.115">                           rv);</span>
<a href="#l9.116"></a><span id="l9.116">         type = rv.value;</span>
<a href="#l9.117"></a><span id="l9.117">     }</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119">     switch (type) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-menus.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-menus.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -12,17 +12,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">  xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   &lt;binding id=&quot;task-menupopup&quot; extends=&quot;xul:menupopup&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7">     &lt;implementation&gt;</span>
<a href="#l10.8"></a><span id="l10.8">       &lt;field name=&quot;mType&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l10.9"></a><span id="l10.9">       &lt;field name=&quot;mPopupHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.10"></a><span id="l10.10">       &lt;field name=&quot;mParentMenuPopup&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.11"></a><span id="l10.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        var self = this;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        let self = this;</span>
<a href="#l10.14"></a><span id="l10.14">         this.mPopupHandler = function popupHandler() { self.changeMenuByPropertyName(); };</span>
<a href="#l10.15"></a><span id="l10.15">         this.mParentMenuPopup = getParentNodeOrThis(this, &quot;menupopup&quot;);</span>
<a href="#l10.16"></a><span id="l10.16">         this.mParentMenuPopup.addEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l10.17"></a><span id="l10.17">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.18"></a><span id="l10.18">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l10.19"></a><span id="l10.19">         this.mParentMenuPopup.removeEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l10.20"></a><span id="l10.20">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l10.21"></a><span id="l10.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -76,27 +76,27 @@</span>
<a href="#l11.4"></a><span id="l11.4">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.5"></a><span id="l11.5">             return this.mOccurrence;</span>
<a href="#l11.6"></a><span id="l11.6">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.7"></a><span id="l11.7">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.8"></a><span id="l11.8">           ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l11.9"></a><span id="l11.9">           this.mOccurrence = val;</span>
<a href="#l11.10"></a><span id="l11.10">           if (cal.isEvent(val)) {</span>
<a href="#l11.11"></a><span id="l11.11">             if (!val.startDate.isDate) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-              var label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-              var df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+              let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+              let df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].</span>
<a href="#l11.16"></a><span id="l11.16">                        getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-              var timezone = this.calendarView ? this.calendarView.mTimezone :</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+              let timezone = this.calendarView ? this.calendarView.mTimezone :</span>
<a href="#l11.19"></a><span id="l11.19">                              calendarDefaultTimezone();</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-              var parentDate = ensureDateTime(this.parentBox.date);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-              var startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-              var endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-              var nextDay = parentDate.clone();</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+              let parentDate = ensureDateTime(this.parentBox.date);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+              let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+              let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+              let nextDay = parentDate.clone();</span>
<a href="#l11.28"></a><span id="l11.28">               nextDay.day++;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-              var comp = endTime.compare(nextDay);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+              let comp = endTime.compare(nextDay);</span>
<a href="#l11.31"></a><span id="l11.31">               if (startTime.compare(parentDate) == -1) {</span>
<a href="#l11.32"></a><span id="l11.32">                 if (comp == 1) {</span>
<a href="#l11.33"></a><span id="l11.33">                   label.value = &quot;↔&quot;;</span>
<a href="#l11.34"></a><span id="l11.34">                 } else if (comp == 0) {</span>
<a href="#l11.35"></a><span id="l11.35">                   label.value = &quot;↤&quot;;</span>
<a href="#l11.36"></a><span id="l11.36">                 } else {</span>
<a href="#l11.37"></a><span id="l11.37">                   label.value = &quot;⇥ &quot; + df.formatTime(endTime);</span>
<a href="#l11.38"></a><span id="l11.38">                 }</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineat">@@ -146,17 +146,17 @@</span>
<a href="#l11.40"></a><span id="l11.40">       &lt;field name=&quot;mShowMonthLabel&quot;&gt;false&lt;/field&gt;</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42">       &lt;property name=&quot;date&quot;</span>
<a href="#l11.43"></a><span id="l11.43">                 onget=&quot;return this.mDate&quot;</span>
<a href="#l11.44"></a><span id="l11.44">                 onset=&quot;this.setDate(val); return val;&quot;/&gt;</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">       &lt;property name=&quot;selected&quot;&gt;</span>
<a href="#l11.47"></a><span id="l11.47">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-          var sel = this.getAttribute(&quot;selected&quot;);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+          let sel = this.getAttribute(&quot;selected&quot;);</span>
<a href="#l11.50"></a><span id="l11.50">           if (sel &amp;&amp; sel == &quot;true&quot;) {</span>
<a href="#l11.51"></a><span id="l11.51">             return true;</span>
<a href="#l11.52"></a><span id="l11.52">           }</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">           return false;</span>
<a href="#l11.55"></a><span id="l11.55">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.56"></a><span id="l11.56">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.57"></a><span id="l11.57">           if (val) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineat">@@ -418,17 +418,17 @@</span>
<a href="#l11.59"></a><span id="l11.59">       &lt;!-- constructor --&gt;</span>
<a href="#l11.60"></a><span id="l11.60">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l11.61"></a><span id="l11.61">           Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l11.62"></a><span id="l11.62">           Components.utils.import(&quot;resource://calendar/modules/calViewUtils.jsm&quot;);</span>
<a href="#l11.63"></a><span id="l11.63"> </span>
<a href="#l11.64"></a><span id="l11.64">           // Set the preference for the default start of the week</span>
<a href="#l11.65"></a><span id="l11.65">           this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-          for (var i = 0; i &lt; 7; i++) {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+          for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l11.69"></a><span id="l11.69">               let hdr = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l11.70"></a><span id="l11.70">               this.labeldaybox.appendChild(hdr);</span>
<a href="#l11.71"></a><span id="l11.71">               hdr.weekDay = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l11.72"></a><span id="l11.72">               hdr.shortWeekNames = false;</span>
<a href="#l11.73"></a><span id="l11.73">           }</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75">           // Set the preference for displaying the week number</span>
<a href="#l11.76"></a><span id="l11.76">           this.mShowWeekNumber = Preferences.get('calendar.view-minimonth.showWeekNumber', true);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineat">@@ -587,17 +587,17 @@</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79">           return null;</span>
<a href="#l11.80"></a><span id="l11.80">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.81"></a><span id="l11.81">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.82"></a><span id="l11.82">           if (this.mSelectedDayBox) {</span>
<a href="#l11.83"></a><span id="l11.83">             this.mSelectedDayBox.selected = false;</span>
<a href="#l11.84"></a><span id="l11.84">           }</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-          var realVal = val;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+          let realVal = val;</span>
<a href="#l11.88"></a><span id="l11.88">           if (!realVal.isDate) {</span>
<a href="#l11.89"></a><span id="l11.89">             realVal = val.clone();</span>
<a href="#l11.90"></a><span id="l11.90">             realVal.isDate = true;</span>
<a href="#l11.91"></a><span id="l11.91">           }</span>
<a href="#l11.92"></a><span id="l11.92">           let box = this.findDayBoxForDate(realVal);</span>
<a href="#l11.93"></a><span id="l11.93">           if (box) {</span>
<a href="#l11.94"></a><span id="l11.94">             box.selected = true;</span>
<a href="#l11.95"></a><span id="l11.95">             this.mSelectedDayBox = box;</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineat">@@ -750,66 +750,66 @@</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98">           if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l11.99"></a><span id="l11.99">             throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l11.100"></a><span id="l11.100">           }</span>
<a href="#l11.101"></a><span id="l11.101"> </span>
<a href="#l11.102"></a><span id="l11.102">           // Days that are not in the main month on display are displayed with</span>
<a href="#l11.103"></a><span id="l11.103">           // a gray background.  Unless the month actually starts on a Sunday,</span>
<a href="#l11.104"></a><span id="l11.104">           // this means that mStartDate.month is 1 month less than the main month</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-          var mainMonth = this.mStartDate.month;</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+          let mainMonth = this.mStartDate.month;</span>
<a href="#l11.107"></a><span id="l11.107">           if (this.mStartDate.day != 1) {</span>
<a href="#l11.108"></a><span id="l11.108">             mainMonth++;</span>
<a href="#l11.109"></a><span id="l11.109">             mainMonth = mainMonth % 12;</span>
<a href="#l11.110"></a><span id="l11.110">           }</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-          var dateBoxes = [];</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-          var today = this.today();</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+          let dateBoxes = [];</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+          let today = this.today();</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117">           // This gets set to true, telling us to collapse the rest of the rows</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-          var finished = false;</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-          var dateList = this.getDateList({});</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+          let finished = false;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+          let dateList = this.getDateList({});</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123">           // This allows to find the first column of dayboxes where to set the</span>
<a href="#l11.124"></a><span id="l11.124">           // week labels taking into account whether days-off are displayed or not.</span>
<a href="#l11.125"></a><span id="l11.125">           let weekLabelColumnPos = -1;</span>
<a href="#l11.126"></a><span id="l11.126"> </span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-          var rows = this.monthgridrows.childNodes;</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+          let rows = this.monthgridrows.childNodes;</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130">           // Iterate through each monthgridrow and set up the day-boxes that</span>
<a href="#l11.131"></a><span id="l11.131">           // are its child nodes.  Remember, childNodes is not a normal array,</span>
<a href="#l11.132"></a><span id="l11.132">           // so don't use the in operator if you don't want extra properties</span>
<a href="#l11.133"></a><span id="l11.133">           // coming out.</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-          for (var i = 0; i &lt; rows.length; i++) {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-            var row = rows[i];</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+          for (let i = 0; i &lt; rows.length; i++) {</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+            let row = rows[i];</span>
<a href="#l11.138"></a><span id="l11.138">             // If we've already assigned all of the day-boxes that we need, just</span>
<a href="#l11.139"></a><span id="l11.139">             // collapse the rest of the rows, otherwise expand them if needed.</span>
<a href="#l11.140"></a><span id="l11.140">             if (finished) {</span>
<a href="#l11.141"></a><span id="l11.141">               row.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l11.142"></a><span id="l11.142">               continue;</span>
<a href="#l11.143"></a><span id="l11.143">             } else {</span>
<a href="#l11.144"></a><span id="l11.144">               row.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l11.145"></a><span id="l11.145">             }</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-            for (var j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-              var daybox = row.childNodes[j];</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-              var dt = dateList[dateBoxes.length];</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+            for (let j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+              let daybox = row.childNodes[j];</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+              let dt = dateList[dateBoxes.length];</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153">               // Remove the attribute &quot;relation&quot; for all the column headers.</span>
<a href="#l11.154"></a><span id="l11.154">               // Consider only the first row index otherwise it will be</span>
<a href="#l11.155"></a><span id="l11.155">               // removed again afterwards the correct setting.</span>
<a href="#l11.156"></a><span id="l11.156">               if (i == 0) {</span>
<a href="#l11.157"></a><span id="l11.157">                   this.labeldaybox.childNodes[j].removeAttribute(&quot;relation&quot;);</span>
<a href="#l11.158"></a><span id="l11.158">               }</span>
<a href="#l11.159"></a><span id="l11.159"> </span>
<a href="#l11.160"></a><span id="l11.160">               daybox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l11.161"></a><span id="l11.161">               daybox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l11.162"></a><span id="l11.162"> </span>
<a href="#l11.163"></a><span id="l11.163">               // Set the box-class depending on if this box displays a day in</span>
<a href="#l11.164"></a><span id="l11.164">               // the month being currently shown or not.</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-              var boxClass;</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+              let boxClass;</span>
<a href="#l11.167"></a><span id="l11.167">               if (this.showFullMonth) {</span>
<a href="#l11.168"></a><span id="l11.168">                   boxClass = &quot;calendar-month-day-box-&quot; +</span>
<a href="#l11.169"></a><span id="l11.169">                              (mainMonth == dt.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l11.170"></a><span id="l11.170">               } else {</span>
<a href="#l11.171"></a><span id="l11.171">                   boxClass = &quot;calendar-month-day-box-current-month&quot;;</span>
<a href="#l11.172"></a><span id="l11.172">               }</span>
<a href="#l11.173"></a><span id="l11.173">               if (this.mDaysOffArray.some(dayOffNum =&gt; dayOffNum == dt.weekday)) {</span>
<a href="#l11.174"></a><span id="l11.174">                 boxClass = &quot;calendar-month-day-box-day-off &quot; + boxClass;</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineat">@@ -916,21 +916,21 @@</span>
<a href="#l11.176"></a><span id="l11.176">               weekLabel.hidden = true;</span>
<a href="#l11.177"></a><span id="l11.177">             }</span>
<a href="#l11.178"></a><span id="l11.178">           }</span>
<a href="#l11.179"></a><span id="l11.179">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.180"></a><span id="l11.180">       &lt;/method&gt;</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182">       &lt;method name=&quot;hideDaysOff&quot;&gt;</span>
<a href="#l11.183"></a><span id="l11.183">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-          var columns = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;monthgridcolumns&quot;).childNodes;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+          let columns = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;monthgridcolumns&quot;).childNodes;</span>
<a href="#l11.186"></a><span id="l11.186">           let headerkids = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;labeldaybox&quot;).childNodes;</span>
<a href="#l11.187"></a><span id="l11.187">           for (let i = 0; i &lt; columns.length; i++) {</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-            var dayForColumn = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-            var dayOff = this.mDaysOffArray.includes(dayForColumn);</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+            let dayForColumn = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+            let dayOff = this.mDaysOffArray.includes(dayForColumn);</span>
<a href="#l11.192"></a><span id="l11.192">             columns[i].collapsed = dayOff &amp;&amp; !this.mDisplayDaysOff;</span>
<a href="#l11.193"></a><span id="l11.193">             headerkids[i].collapsed = dayOff &amp;&amp; !this.mDisplayDaysOff;</span>
<a href="#l11.194"></a><span id="l11.194">           }</span>
<a href="#l11.195"></a><span id="l11.195">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.196"></a><span id="l11.196">       &lt;/method&gt;</span>
<a href="#l11.197"></a><span id="l11.197"> </span>
<a href="#l11.198"></a><span id="l11.198">       &lt;method name=&quot;findDayBoxForDate&quot;&gt;</span>
<a href="#l11.199"></a><span id="l11.199">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineat">@@ -945,19 +945,19 @@</span>
<a href="#l11.201"></a><span id="l11.201">           }</span>
<a href="#l11.202"></a><span id="l11.202">           return null;</span>
<a href="#l11.203"></a><span id="l11.203">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.204"></a><span id="l11.204">       &lt;/method&gt;</span>
<a href="#l11.205"></a><span id="l11.205"> </span>
<a href="#l11.206"></a><span id="l11.206">       &lt;method name=&quot;findDayBoxesForItem&quot;&gt;</span>
<a href="#l11.207"></a><span id="l11.207">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l11.208"></a><span id="l11.208">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-          var targetDate = null;</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-          var finishDate = null;</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-          var boxes = [];</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+          let targetDate = null;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+          let finishDate = null;</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+          let boxes = [];</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216">           // All our boxes are in default tz, so we need these times in them too.</span>
<a href="#l11.217"></a><span id="l11.217">           if (cal.isEvent(aItem)) {</span>
<a href="#l11.218"></a><span id="l11.218">               targetDate = aItem.startDate.getInTimezone(this.mTimezone);</span>
<a href="#l11.219"></a><span id="l11.219">               finishDate = aItem.endDate.getInTimezone(this.mTimezone);</span>
<a href="#l11.220"></a><span id="l11.220">           } else if (cal.isToDo(aItem)) {</span>
<a href="#l11.221"></a><span id="l11.221">               // Consider tasks without entry OR due date.</span>
<a href="#l11.222"></a><span id="l11.222">               if (aItem.entryDate || aItem.dueDate) {</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineat">@@ -1030,17 +1030,17 @@</span>
<a href="#l11.224"></a><span id="l11.224"> </span>
<a href="#l11.225"></a><span id="l11.225">           if (!boxes.length) {</span>
<a href="#l11.226"></a><span id="l11.226">               return;</span>
<a href="#l11.227"></a><span id="l11.227">           }</span>
<a href="#l11.228"></a><span id="l11.228"> </span>
<a href="#l11.229"></a><span id="l11.229">           function isNotItem(a) {</span>
<a href="#l11.230"></a><span id="l11.230">               return (a.hashId != aItem.hashId);</span>
<a href="#l11.231"></a><span id="l11.231">           }</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-          var oldLength = this.mSelectedItems.length;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+          let oldLength = this.mSelectedItems.length;</span>
<a href="#l11.234"></a><span id="l11.234">           this.mSelectedItems = this.mSelectedItems.filter(isNotItem);</span>
<a href="#l11.235"></a><span id="l11.235"> </span>
<a href="#l11.236"></a><span id="l11.236">           for (let box of boxes) {</span>
<a href="#l11.237"></a><span id="l11.237">               box.deleteItem(aItem);</span>
<a href="#l11.238"></a><span id="l11.238">           }</span>
<a href="#l11.239"></a><span id="l11.239"> </span>
<a href="#l11.240"></a><span id="l11.240">           // If a deleted event was selected, we need to announce that the</span>
<a href="#l11.241"></a><span id="l11.241">           // selection changed.</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineat">@@ -1067,43 +1067,43 @@</span>
<a href="#l11.243"></a><span id="l11.243">           }</span>
<a href="#l11.244"></a><span id="l11.244">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.245"></a><span id="l11.245">       &lt;/method&gt;</span>
<a href="#l11.246"></a><span id="l11.246"> </span>
<a href="#l11.247"></a><span id="l11.247">       &lt;method name=&quot;flashAlarm&quot;&gt;</span>
<a href="#l11.248"></a><span id="l11.248">         &lt;parameter name=&quot;aAlarmItem&quot;/&gt;</span>
<a href="#l11.249"></a><span id="l11.249">         &lt;parameter name=&quot;aStop&quot;/&gt;</span>
<a href="#l11.250"></a><span id="l11.250">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-          var showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-          var totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+          let showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+          let totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l11.255"></a><span id="l11.255"> </span>
<a href="#l11.256"></a><span id="l11.256">           if (!aStop &amp;&amp; (!showIndicator || totaltime &lt; 1)) {</span>
<a href="#l11.257"></a><span id="l11.257">             // No need to animate if the indicator should not be shown.</span>
<a href="#l11.258"></a><span id="l11.258">             return;</span>
<a href="#l11.259"></a><span id="l11.259">           }</span>
<a href="#l11.260"></a><span id="l11.260"> </span>
<a href="#l11.261"></a><span id="l11.261">           // Make sure the flashing attribute is set or reset on all visible</span>
<a href="#l11.262"></a><span id="l11.262">           // boxes.</span>
<a href="#l11.263"></a><span id="l11.263">           let boxes = this.findDayBoxesForItem(aAlarmItem);</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-          for (var box of boxes) {</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-            for (var id in box.mItemHash) {</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+          for (let box of boxes) {</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+            for (let id in box.mItemHash) {</span>
<a href="#l11.268"></a><span id="l11.268">               let itemData = box.mItemHash[id];</span>
<a href="#l11.269"></a><span id="l11.269">               if (itemData.item.hasSameIds(aAlarmItem)) {</span>
<a href="#l11.270"></a><span id="l11.270">                 if (aStop) {</span>
<a href="#l11.271"></a><span id="l11.271">                   itemData.removeAttribute(&quot;flashing&quot;);</span>
<a href="#l11.272"></a><span id="l11.272">                 } else {</span>
<a href="#l11.273"></a><span id="l11.273">                   itemData.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l11.274"></a><span id="l11.274">                 }</span>
<a href="#l11.275"></a><span id="l11.275">               }</span>
<a href="#l11.276"></a><span id="l11.276">             }</span>
<a href="#l11.277"></a><span id="l11.277">           }</span>
<a href="#l11.278"></a><span id="l11.278"> </span>
<a href="#l11.279"></a><span id="l11.279">           if (!aStop) {</span>
<a href="#l11.280"></a><span id="l11.280">             // Set up a timer to stop the flashing after the total time.</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-            var this_ = this;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+            let this_ = this;</span>
<a href="#l11.283"></a><span id="l11.283">             this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l11.284"></a><span id="l11.284">             setTimeout(function() { this_.flashAlarm(aAlarmItem, true); }, totaltime);</span>
<a href="#l11.285"></a><span id="l11.285">           } else {</span>
<a href="#l11.286"></a><span id="l11.286">             // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l11.287"></a><span id="l11.287">             delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l11.288"></a><span id="l11.288">           }</span>
<a href="#l11.289"></a><span id="l11.289">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.290"></a><span id="l11.290">       &lt;/method&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -46,114 +46,114 @@</span>
<a href="#l12.4"></a><span id="l12.4">               aDayEndHour * 60 &gt; this.mEndMin) {</span>
<a href="#l12.5"></a><span id="l12.5">               throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l12.6"></a><span id="l12.6">           }</span>
<a href="#l12.7"></a><span id="l12.7">           if (this.mDayStartHour != aDayStartHour ||</span>
<a href="#l12.8"></a><span id="l12.8">               this.mDayEndHour != aDayEndHour) {</span>
<a href="#l12.9"></a><span id="l12.9">               this.mDayEndHour = aDayEndHour;</span>
<a href="#l12.10"></a><span id="l12.10">               this.mDayStartHour = aDayStartHour;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-              var topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+              let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l12.14"></a><span id="l12.14">               if (topbox.childNodes.length) {</span>
<a href="#l12.15"></a><span id="l12.15">                   // This only needs to be done if the initial relayout has</span>
<a href="#l12.16"></a><span id="l12.16">                   // already happened, otherwise it will be done then.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-                  for (var hour = this.mStartMin / 60; hour &lt; this.mEndMin / 60; hour++) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+                  for (let hour = this.mStartMin / 60; hour &lt; this.mEndMin / 60; hour++) {</span>
<a href="#l12.19"></a><span id="l12.19">                       if (hour &lt; this.mDayStartHour || hour &gt;= this.mDayEndHour) {</span>
<a href="#l12.20"></a><span id="l12.20">                           topbox.childNodes[hour].setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l12.21"></a><span id="l12.21">                       } else {</span>
<a href="#l12.22"></a><span id="l12.22">                           topbox.childNodes[hour].removeAttribute(&quot;off-time&quot;);</span>
<a href="#l12.23"></a><span id="l12.23">                       }</span>
<a href="#l12.24"></a><span id="l12.24">                   }</span>
<a href="#l12.25"></a><span id="l12.25">               }</span>
<a href="#l12.26"></a><span id="l12.26">           }</span>
<a href="#l12.27"></a><span id="l12.27">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.28"></a><span id="l12.28">       &lt;/method&gt;</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l12.31"></a><span id="l12.31">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l12.32"></a><span id="l12.32">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l12.33"></a><span id="l12.33">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-          var needsrelayout = false;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+          let needsrelayout = false;</span>
<a href="#l12.36"></a><span id="l12.36">           if (aAttr == &quot;orient&quot;) {</span>
<a href="#l12.37"></a><span id="l12.37">               if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l12.38"></a><span id="l12.38">                   needsrelayout = true;</span>
<a href="#l12.39"></a><span id="l12.39">               }</span>
<a href="#l12.40"></a><span id="l12.40">           }</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42">           // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-          var ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.45"></a><span id="l12.45"> </span>
<a href="#l12.46"></a><span id="l12.46">           if (needsrelayout) {</span>
<a href="#l12.47"></a><span id="l12.47">               this.relayout();</span>
<a href="#l12.48"></a><span id="l12.48">           }</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50">           return ret;</span>
<a href="#l12.51"></a><span id="l12.51">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.52"></a><span id="l12.52">       &lt;/method&gt;</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54">       &lt;property name=&quot;pixelsPerMinute&quot;</span>
<a href="#l12.55"></a><span id="l12.55">         onget=&quot;return this.mPixPerMin&quot;</span>
<a href="#l12.56"></a><span id="l12.56">         onset=&quot;if (this.mPixPerMin != val) { this.mPixPerMin = val; this.relayout(); } return val;&quot;/&gt;</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58">       &lt;method name=&quot;relayout&quot;&gt;</span>
<a href="#l12.59"></a><span id="l12.59">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-          var topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-          var orient = topbox.getAttribute(&quot;orient&quot;);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-          var otherorient = getOtherOrientation(orient);</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+          let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+          let orient = topbox.getAttribute(&quot;orient&quot;);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+          let otherorient = getOtherOrientation(orient);</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67"> </span>
<a href="#l12.68"></a><span id="l12.68">           function makeTimeBox(timestr, size) {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-              var box = createXULElement(&quot;box&quot;);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+              let box = createXULElement(&quot;box&quot;);</span>
<a href="#l12.71"></a><span id="l12.71">               box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">               if (orient == &quot;horizontal&quot;) {</span>
<a href="#l12.74"></a><span id="l12.74">                   box.setAttribute(&quot;width&quot;, size);</span>
<a href="#l12.75"></a><span id="l12.75">               } else {</span>
<a href="#l12.76"></a><span id="l12.76">                   box.setAttribute(&quot;height&quot;, size);</span>
<a href="#l12.77"></a><span id="l12.77">               }</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-              var label = createXULElement(&quot;label&quot;);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+              let label = createXULElement(&quot;label&quot;);</span>
<a href="#l12.81"></a><span id="l12.81">               label.setAttribute(&quot;class&quot;, &quot;calendar-time-bar-label&quot;);</span>
<a href="#l12.82"></a><span id="l12.82">               label.setAttribute(&quot;value&quot;, timestr);</span>
<a href="#l12.83"></a><span id="l12.83">               label.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85">               box.appendChild(label);</span>
<a href="#l12.86"></a><span id="l12.86"> </span>
<a href="#l12.87"></a><span id="l12.87">               return box;</span>
<a href="#l12.88"></a><span id="l12.88">           }</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90">           while (topbox.hasChildNodes()) {</span>
<a href="#l12.91"></a><span id="l12.91">               topbox.lastChild.remove();</span>
<a href="#l12.92"></a><span id="l12.92">           }</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-          var formatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;].</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+          let formatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;].</span>
<a href="#l12.96"></a><span id="l12.96">                           getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-          var timeString;</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-          var theMin = this.mStartMin;</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-          var theHour = Math.floor(theMin / 60);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-          var durLeft = this.mEndMin - this.mStartMin;</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+          let timeString;</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+          let theMin = this.mStartMin;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+          let theHour = Math.floor(theMin / 60);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+          let durLeft = this.mEndMin - this.mStartMin;</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106">           while (durLeft &gt; 0) {</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-              var dur;</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+              let dur;</span>
<a href="#l12.109"></a><span id="l12.109">               if (this.mEndMin - theMin &lt; 60) {</span>
<a href="#l12.110"></a><span id="l12.110">                   dur = this.mEndMin - theMin;</span>
<a href="#l12.111"></a><span id="l12.111">               } else {</span>
<a href="#l12.112"></a><span id="l12.112">                   dur = theMin % 60;</span>
<a href="#l12.113"></a><span id="l12.113">               }</span>
<a href="#l12.114"></a><span id="l12.114">               theMin += dur;</span>
<a href="#l12.115"></a><span id="l12.115">               if (dur == 0) {</span>
<a href="#l12.116"></a><span id="l12.116">                   dur = 60;</span>
<a href="#l12.117"></a><span id="l12.117">               }</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">               // calculate duration pixel as the difference between</span>
<a href="#l12.120"></a><span id="l12.120">               // start pixel and end pixel to avoid rounding errors.</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-              var startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-              var endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-              var durPix = endPix - startPix;</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-              var box;</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+              let startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+              let endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+              let durPix = endPix - startPix;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+              let box;</span>
<a href="#l12.129"></a><span id="l12.129">               if (dur != 60) {</span>
<a href="#l12.130"></a><span id="l12.130">                   box = makeTimeBox(&quot;&quot;, durPix);</span>
<a href="#l12.131"></a><span id="l12.131">               } else {</span>
<a href="#l12.132"></a><span id="l12.132">                   timeString = formatter.FormatTime(&quot;&quot;,</span>
<a href="#l12.133"></a><span id="l12.133">                                                     Components.interfaces.nsIScriptableDateFormat.timeFormatNoSeconds,</span>
<a href="#l12.134"></a><span id="l12.134">                                                     theHour, 0, 0);</span>
<a href="#l12.135"></a><span id="l12.135">                   box = makeTimeBox(timeString, durPix);</span>
<a href="#l12.136"></a><span id="l12.136">               }</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineat">@@ -191,17 +191,17 @@</span>
<a href="#l12.138"></a><span id="l12.138">      &lt;/content&gt;</span>
<a href="#l12.139"></a><span id="l12.139"> </span>
<a href="#l12.140"></a><span id="l12.140">     &lt;implementation&gt;</span>
<a href="#l12.141"></a><span id="l12.141">       &lt;property name=&quot;parentorient&quot;&gt;</span>
<a href="#l12.142"></a><span id="l12.142">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.143"></a><span id="l12.143">           return this.getAttribute(&quot;parentorient&quot;);</span>
<a href="#l12.144"></a><span id="l12.144">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.145"></a><span id="l12.145">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-          var thebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;thebox&quot;);</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+          let thebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;thebox&quot;);</span>
<a href="#l12.148"></a><span id="l12.148">           this.setAttribute(&quot;parentorient&quot;, val);</span>
<a href="#l12.149"></a><span id="l12.149">           thebox.setAttribute(&quot;orient&quot;, getOtherOrientation(val));</span>
<a href="#l12.150"></a><span id="l12.150">           return val;</span>
<a href="#l12.151"></a><span id="l12.151">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.152"></a><span id="l12.152">       &lt;/property&gt;</span>
<a href="#l12.153"></a><span id="l12.153"> </span>
<a href="#l12.154"></a><span id="l12.154">       &lt;!-- private --&gt;</span>
<a href="#l12.155"></a><span id="l12.155">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineat">@@ -310,17 +310,17 @@</span>
<a href="#l12.157"></a><span id="l12.157">       &lt;field name=&quot;mSelected&quot;&gt;false&lt;/field&gt;</span>
<a href="#l12.158"></a><span id="l12.158">       &lt;property name=&quot;selected&quot;&gt;</span>
<a href="#l12.159"></a><span id="l12.159">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.160"></a><span id="l12.160">           return this.mSelected;</span>
<a href="#l12.161"></a><span id="l12.161">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.162"></a><span id="l12.162">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.163"></a><span id="l12.163">           this.mSelected = val;</span>
<a href="#l12.164"></a><span id="l12.164">           if (this.bgbox &amp;&amp; this.bgbox.hasChildNodes()) {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-            var child = this.bgbox.firstChild;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+            let child = this.bgbox.firstChild;</span>
<a href="#l12.167"></a><span id="l12.167">             while (child) {</span>
<a href="#l12.168"></a><span id="l12.168">               if (val) {</span>
<a href="#l12.169"></a><span id="l12.169">                 child.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l12.170"></a><span id="l12.170">               } else {</span>
<a href="#l12.171"></a><span id="l12.171">                 child.removeAttribute(&quot;selected&quot;);</span>
<a href="#l12.172"></a><span id="l12.172">               }</span>
<a href="#l12.173"></a><span id="l12.173">               child = child.nextSibling;</span>
<a href="#l12.174"></a><span id="l12.174">             }</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineat">@@ -412,46 +412,46 @@</span>
<a href="#l12.176"></a><span id="l12.176">       &lt;!-- mEventInfos --&gt;</span>
<a href="#l12.177"></a><span id="l12.177">       &lt;field name=&quot;mSelectedChunks&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l12.178"></a><span id="l12.178"> </span>
<a href="#l12.179"></a><span id="l12.179">       &lt;method name=&quot;selectOccurrence&quot;&gt;</span>
<a href="#l12.180"></a><span id="l12.180">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l12.181"></a><span id="l12.181">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.182"></a><span id="l12.182">           if (aOccurrence) {</span>
<a href="#l12.183"></a><span id="l12.183">               this.mSelectedItemIds[aOccurrence.hashId] = true;</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-              var chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+              let chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l12.186"></a><span id="l12.186">               if (!chunk) {</span>
<a href="#l12.187"></a><span id="l12.187">                   return;</span>
<a href="#l12.188"></a><span id="l12.188">               }</span>
<a href="#l12.189"></a><span id="l12.189">               chunk.selected = true;</span>
<a href="#l12.190"></a><span id="l12.190">               this.mSelectedChunks.push(chunk);</span>
<a href="#l12.191"></a><span id="l12.191">           }</span>
<a href="#l12.192"></a><span id="l12.192">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.193"></a><span id="l12.193">       &lt;/method&gt;</span>
<a href="#l12.194"></a><span id="l12.194"> </span>
<a href="#l12.195"></a><span id="l12.195">       &lt;method name=&quot;unselectOccurrence&quot;&gt;</span>
<a href="#l12.196"></a><span id="l12.196">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l12.197"></a><span id="l12.197">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.198"></a><span id="l12.198">           if (aOccurrence) {</span>
<a href="#l12.199"></a><span id="l12.199">               delete this.mSelectedItemIds[aOccurrence.hashId];</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-              var chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+              let chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l12.202"></a><span id="l12.202">               if (!chunk) {</span>
<a href="#l12.203"></a><span id="l12.203">                   return;</span>
<a href="#l12.204"></a><span id="l12.204">               }</span>
<a href="#l12.205"></a><span id="l12.205">               chunk.selected = false;</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-              var index = this.mSelectedChunks.indexOf(chunk);</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+              let index = this.mSelectedChunks.indexOf(chunk);</span>
<a href="#l12.208"></a><span id="l12.208">               this.mSelectedChunks.splice(index, 1);</span>
<a href="#l12.209"></a><span id="l12.209">           }</span>
<a href="#l12.210"></a><span id="l12.210">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.211"></a><span id="l12.211">       &lt;/method&gt;</span>
<a href="#l12.212"></a><span id="l12.212"> </span>
<a href="#l12.213"></a><span id="l12.213">       &lt;method name=&quot;findChunkForOccurrence&quot;&gt;</span>
<a href="#l12.214"></a><span id="l12.214">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l12.215"></a><span id="l12.215">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-          for (var chunk of this.mEventBoxes) {</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+          for (let chunk of this.mEventBoxes) {</span>
<a href="#l12.218"></a><span id="l12.218">               if (chunk.occurrence.hashId == aOccurrence.hashId) {</span>
<a href="#l12.219"></a><span id="l12.219">                   return chunk;</span>
<a href="#l12.220"></a><span id="l12.220">               }</span>
<a href="#l12.221"></a><span id="l12.221">           }</span>
<a href="#l12.222"></a><span id="l12.222"> </span>
<a href="#l12.223"></a><span id="l12.223">           return null;</span>
<a href="#l12.224"></a><span id="l12.224">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.225"></a><span id="l12.225">       &lt;/method&gt;</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineat">@@ -470,32 +470,32 @@</span>
<a href="#l12.227"></a><span id="l12.227">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.228"></a><span id="l12.228">       &lt;/method&gt;</span>
<a href="#l12.229"></a><span id="l12.229"> </span>
<a href="#l12.230"></a><span id="l12.230">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l12.231"></a><span id="l12.231">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l12.232"></a><span id="l12.232">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l12.233"></a><span id="l12.233">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.234"></a><span id="l12.234">           // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-          var ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.237"></a><span id="l12.237"> </span>
<a href="#l12.238"></a><span id="l12.238">           if (aAttr == &quot;orient&quot; &amp;&amp; this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l12.239"></a><span id="l12.239">               this.relayout();</span>
<a href="#l12.240"></a><span id="l12.240">           }</span>
<a href="#l12.241"></a><span id="l12.241"> </span>
<a href="#l12.242"></a><span id="l12.242">           return ret;</span>
<a href="#l12.243"></a><span id="l12.243">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.244"></a><span id="l12.244">       &lt;/method&gt;</span>
<a href="#l12.245"></a><span id="l12.245"> </span>
<a href="#l12.246"></a><span id="l12.246">       &lt;method name=&quot;internalDeleteEvent&quot;&gt;</span>
<a href="#l12.247"></a><span id="l12.247">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l12.248"></a><span id="l12.248">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineminus">-           var itemIndex = -1;</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-           var occ;</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-           for (var i in this.mEventInfos) {</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+           let itemIndex = -1;</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+           let occ;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+           for (let i in this.mEventInfos) {</span>
<a href="#l12.255"></a><span id="l12.255">                occ = this.mEventInfos[i].event;</span>
<a href="#l12.256"></a><span id="l12.256">                if (occ.hashId == aOccurrence.hashId) {</span>
<a href="#l12.257"></a><span id="l12.257">                    itemIndex = i;</span>
<a href="#l12.258"></a><span id="l12.258">                    break;</span>
<a href="#l12.259"></a><span id="l12.259">                }</span>
<a href="#l12.260"></a><span id="l12.260">            }</span>
<a href="#l12.261"></a><span id="l12.261"> </span>
<a href="#l12.262"></a><span id="l12.262">            if (itemIndex != -1) {</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineat">@@ -508,18 +508,18 @@</span>
<a href="#l12.264"></a><span id="l12.264">            } else {</span>
<a href="#l12.265"></a><span id="l12.265">                return false;</span>
<a href="#l12.266"></a><span id="l12.266">            }</span>
<a href="#l12.267"></a><span id="l12.267">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.268"></a><span id="l12.268">       &lt;/method&gt;</span>
<a href="#l12.269"></a><span id="l12.269"> </span>
<a href="#l12.270"></a><span id="l12.270">       &lt;method name=&quot;recalculateStartEndMinutes&quot;&gt;</span>
<a href="#l12.271"></a><span id="l12.271">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-          for (var chunk of this.mEventInfos) {</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-              var mins = this.getStartEndMinutesForOccurrence(chunk.event);</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+          for (let chunk of this.mEventInfos) {</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+              let mins = this.getStartEndMinutesForOccurrence(chunk.event);</span>
<a href="#l12.276"></a><span id="l12.276">               chunk.startMinute = mins.start;</span>
<a href="#l12.277"></a><span id="l12.277">               chunk.endMinute = mins.end;</span>
<a href="#l12.278"></a><span id="l12.278">           }</span>
<a href="#l12.279"></a><span id="l12.279"> </span>
<a href="#l12.280"></a><span id="l12.280">           this.relayout();</span>
<a href="#l12.281"></a><span id="l12.281">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.282"></a><span id="l12.282">       &lt;/method&gt;</span>
<a href="#l12.283"></a><span id="l12.283"> </span>
<a href="#l12.284"></a><span id="l12.284" class="difflineat">@@ -536,20 +536,20 @@</span>
<a href="#l12.285"></a><span id="l12.285">            if (!compareObjects(stdate.timezone, this.mTimezone)) {</span>
<a href="#l12.286"></a><span id="l12.286">                stdate = stdate.getInTimezone(this.mTimezone);</span>
<a href="#l12.287"></a><span id="l12.287">            }</span>
<a href="#l12.288"></a><span id="l12.288"> </span>
<a href="#l12.289"></a><span id="l12.289">            if (!compareObjects(enddate.timezone, this.mTimezone)) {</span>
<a href="#l12.290"></a><span id="l12.290">                enddate = enddate.getInTimezone(this.mTimezone);</span>
<a href="#l12.291"></a><span id="l12.291">            }</span>
<a href="#l12.292"></a><span id="l12.292"> </span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">-           var startHour = stdate.hour;</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineminus">-           var startMinute = stdate.minute;</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">-           var endHour = enddate.hour;</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">-           var endMinute = enddate.minute;</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+           let startHour = stdate.hour;</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+           let startMinute = stdate.minute;</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+           let endHour = enddate.hour;</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+           let endMinute = enddate.minute;</span>
<a href="#l12.301"></a><span id="l12.301"> </span>
<a href="#l12.302"></a><span id="l12.302">            // Handle cases where an event begins or ends on a day other than this</span>
<a href="#l12.303"></a><span id="l12.303">            if (stdate.compare(this.mDate) == -1) {</span>
<a href="#l12.304"></a><span id="l12.304">                startHour = 0;</span>
<a href="#l12.305"></a><span id="l12.305">                startMinute = 0;</span>
<a href="#l12.306"></a><span id="l12.306">            }</span>
<a href="#l12.307"></a><span id="l12.307">            if (enddate.compare(this.mDate) == 1) {</span>
<a href="#l12.308"></a><span id="l12.308">                endHour = 24;</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineat">@@ -572,38 +572,38 @@</span>
<a href="#l12.310"></a><span id="l12.310">                     realStart:    realStart_,</span>
<a href="#l12.311"></a><span id="l12.311">                     realEnd:      realEnd_ };</span>
<a href="#l12.312"></a><span id="l12.312">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.313"></a><span id="l12.313">       &lt;/method&gt;</span>
<a href="#l12.314"></a><span id="l12.314"> </span>
<a href="#l12.315"></a><span id="l12.315">       &lt;method name=&quot;createChunk&quot;&gt;</span>
<a href="#l12.316"></a><span id="l12.316">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l12.317"></a><span id="l12.317">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineminus">-           var mins = this.getStartEndMinutesForOccurrence(aOccurrence);</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineminus">-</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineminus">-           var chunk = {</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+           let mins = this.getStartEndMinutesForOccurrence(aOccurrence);</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+           let chunk = {</span>
<a href="#l12.324"></a><span id="l12.324">                startMinute: mins.start,</span>
<a href="#l12.325"></a><span id="l12.325">                endMinute: mins.end,</span>
<a href="#l12.326"></a><span id="l12.326">                event: aOccurrence</span>
<a href="#l12.327"></a><span id="l12.327">            };</span>
<a href="#l12.328"></a><span id="l12.328">            return chunk;</span>
<a href="#l12.329"></a><span id="l12.329">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.330"></a><span id="l12.330">       &lt;/method&gt;</span>
<a href="#l12.331"></a><span id="l12.331"> </span>
<a href="#l12.332"></a><span id="l12.332">       &lt;method name=&quot;addEvent&quot;&gt;</span>
<a href="#l12.333"></a><span id="l12.333">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l12.334"></a><span id="l12.334">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.335"></a><span id="l12.335">            this.internalDeleteEvent(aOccurrence);</span>
<a href="#l12.336"></a><span id="l12.336"> </span>
<a href="#l12.337"></a><span id="l12.337" class="difflineminus">-           var chunk = this.createChunk(aOccurrence);</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+           let chunk = this.createChunk(aOccurrence);</span>
<a href="#l12.339"></a><span id="l12.339">            this.mEventInfos.push(chunk);</span>
<a href="#l12.340"></a><span id="l12.340">            if (this.mEventMapTimeout) {</span>
<a href="#l12.341"></a><span id="l12.341">                clearTimeout(this.mEventMapTimeout);</span>
<a href="#l12.342"></a><span id="l12.342">            }</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineminus">-           var column = this;</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+           let column = this;</span>
<a href="#l12.345"></a><span id="l12.345"> </span>
<a href="#l12.346"></a><span id="l12.346">            if (this.mCreatedNewEvent) {</span>
<a href="#l12.347"></a><span id="l12.347">                this.mEventToEdit = aOccurrence;</span>
<a href="#l12.348"></a><span id="l12.348">            }</span>
<a href="#l12.349"></a><span id="l12.349">            // Fun with scoping...</span>
<a href="#l12.350"></a><span id="l12.350">            this.mEventMapTimeout = setTimeout(function() { column.relayout.call(column); }, 5);</span>
<a href="#l12.351"></a><span id="l12.351">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.352"></a><span id="l12.352">       &lt;/method&gt;</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineat">@@ -871,31 +871,31 @@</span>
<a href="#l12.354"></a><span id="l12.354">            *</span>
<a href="#l12.355"></a><span id="l12.355">            * Each blob will be an array of objects with the following properties:</span>
<a href="#l12.356"></a><span id="l12.356">            *    item:     the event/task</span>
<a href="#l12.357"></a><span id="l12.357">            *    startCol: the starting column to display the event in (0-indexed)</span>
<a href="#l12.358"></a><span id="l12.358">            *    colSpan:  the number of columns the item spans</span>
<a href="#l12.359"></a><span id="l12.359">            *</span>
<a href="#l12.360"></a><span id="l12.360">            * An item with no conflicts will have startCol: 0 and colSpan: 1.</span>
<a href="#l12.361"></a><span id="l12.361">            */</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-          var blobs = [];</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-          var currentBlob = [];</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+          let blobs = [];</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+          let currentBlob = [];</span>
<a href="#l12.366"></a><span id="l12.366">           function sortByStart(aEventInfo, bEventInfo) {</span>
<a href="#l12.367"></a><span id="l12.367">               // If you pass in tasks without both entry and due dates, I will</span>
<a href="#l12.368"></a><span id="l12.368">               // kill you</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-              var startComparison = aEventInfo.layoutStart.compare(bEventInfo.layoutStart);</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+              let startComparison = aEventInfo.layoutStart.compare(bEventInfo.layoutStart);</span>
<a href="#l12.371"></a><span id="l12.371">               if (startComparison != 0) {</span>
<a href="#l12.372"></a><span id="l12.372">                   return startComparison;</span>
<a href="#l12.373"></a><span id="l12.373">               } else {</span>
<a href="#l12.374"></a><span id="l12.374">                   // If the items start at the same time, return the longer one</span>
<a href="#l12.375"></a><span id="l12.375">                   // first</span>
<a href="#l12.376"></a><span id="l12.376">                   return bEventInfo.layoutEnd.compare(aEventInfo.layoutEnd);</span>
<a href="#l12.377"></a><span id="l12.377">               }</span>
<a href="#l12.378"></a><span id="l12.378">           }</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineminus">-          var self = this;</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+          let self = this;</span>
<a href="#l12.381"></a><span id="l12.381">           this.mEventInfos.forEach(function(aEventInfo) {</span>
<a href="#l12.382"></a><span id="l12.382">               let item = aEventInfo.event.clone();</span>
<a href="#l12.383"></a><span id="l12.383">               let start = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l12.384"></a><span id="l12.384">               start = start.getInTimezone(self.mTimezone);</span>
<a href="#l12.385"></a><span id="l12.385">               aEventInfo.layoutStart = start;</span>
<a href="#l12.386"></a><span id="l12.386">               let end = item.endDate || item.dueDate || item.entryDate;</span>
<a href="#l12.387"></a><span id="l12.387">               end = end.getInTimezone(self.mTimezone);</span>
<a href="#l12.388"></a><span id="l12.388">               let secEnd = start.clone();</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineat">@@ -905,34 +905,34 @@</span>
<a href="#l12.390"></a><span id="l12.390">               } else {</span>
<a href="#l12.391"></a><span id="l12.391">                    aEventInfo.layoutEnd = end;</span>
<a href="#l12.392"></a><span id="l12.392">               }</span>
<a href="#l12.393"></a><span id="l12.393">               return aEventInfo;</span>
<a href="#l12.394"></a><span id="l12.394">           });</span>
<a href="#l12.395"></a><span id="l12.395">           this.mEventInfos.sort(sortByStart);</span>
<a href="#l12.396"></a><span id="l12.396"> </span>
<a href="#l12.397"></a><span id="l12.397">           // The end time of the last ending event in the entire blob</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineminus">-          var latestItemEnd;</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+          let latestItemEnd;</span>
<a href="#l12.400"></a><span id="l12.400"> </span>
<a href="#l12.401"></a><span id="l12.401">           // This array keeps track of the last (latest ending) item in each of</span>
<a href="#l12.402"></a><span id="l12.402">           // the columns of the current blob. We could reconstruct this data at</span>
<a href="#l12.403"></a><span id="l12.403">           // any time by looking at the items in the blob, but that would hurt</span>
<a href="#l12.404"></a><span id="l12.404">           // perf.</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineminus">-          var colEndArray = [];</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+          let colEndArray = [];</span>
<a href="#l12.407"></a><span id="l12.407"> </span>
<a href="#l12.408"></a><span id="l12.408">           /* Go through a 3 step process to try and place each item.</span>
<a href="#l12.409"></a><span id="l12.409">            * Step 1: Look for an existing column with room for the item.</span>
<a href="#l12.410"></a><span id="l12.410">            * Step 2: Look for a previously placed item that can be shrunk in</span>
<a href="#l12.411"></a><span id="l12.411">            *         width to make room for the item.</span>
<a href="#l12.412"></a><span id="l12.412">            * Step 3: Give up and create a new column for the item.</span>
<a href="#l12.413"></a><span id="l12.413">            *</span>
<a href="#l12.414"></a><span id="l12.414">            * (The steps are explained in more detail as we come to them)</span>
<a href="#l12.415"></a><span id="l12.415">            */</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineminus">-          for (var i in this.mEventInfos) {</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineminus">-              var curItemInfo = {event: this.mEventInfos[i].event,</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+          for (let i in this.mEventInfos) {</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineplus">+              let curItemInfo = {event: this.mEventInfos[i].event,</span>
<a href="#l12.420"></a><span id="l12.420">                                  layoutStart: this.mEventInfos[i].layoutStart,</span>
<a href="#l12.421"></a><span id="l12.421">                                  layoutEnd: this.mEventInfos[i].layoutEnd};</span>
<a href="#l12.422"></a><span id="l12.422">               if (!latestItemEnd) {</span>
<a href="#l12.423"></a><span id="l12.423">                  latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l12.424"></a><span id="l12.424">               }</span>
<a href="#l12.425"></a><span id="l12.425">               if (currentBlob.length &amp;&amp; latestItemEnd &amp;&amp;</span>
<a href="#l12.426"></a><span id="l12.426">                   curItemInfo.layoutStart.compare(latestItemEnd) != -1) {</span>
<a href="#l12.427"></a><span id="l12.427">                   // We're done with this current blob because item starts</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineat">@@ -940,17 +940,17 @@</span>
<a href="#l12.429"></a><span id="l12.429">                   blobs.push({blob: currentBlob, totalCols: colEndArray.length});</span>
<a href="#l12.430"></a><span id="l12.430"> </span>
<a href="#l12.431"></a><span id="l12.431">                   // Reset our variables</span>
<a href="#l12.432"></a><span id="l12.432">                   currentBlob = [];</span>
<a href="#l12.433"></a><span id="l12.433">                   colEndArray = [];</span>
<a href="#l12.434"></a><span id="l12.434">               }</span>
<a href="#l12.435"></a><span id="l12.435"> </span>
<a href="#l12.436"></a><span id="l12.436">               // Place the item in its correct place in the blob</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-              var placedItem = false;</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+              let placedItem = false;</span>
<a href="#l12.439"></a><span id="l12.439"> </span>
<a href="#l12.440"></a><span id="l12.440">               // Step 1</span>
<a href="#l12.441"></a><span id="l12.441">               // Look for a possible column in the blob that has been left open. This</span>
<a href="#l12.442"></a><span id="l12.442">               // would happen if we already have multiple columns but some of</span>
<a href="#l12.443"></a><span id="l12.443">               // the cols have events before latestItemEnd.  For instance</span>
<a href="#l12.444"></a><span id="l12.444">               //       |      |      |</span>
<a href="#l12.445"></a><span id="l12.445">               //       |______|      |</span>
<a href="#l12.446"></a><span id="l12.446">               //       |ev1   |______|</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineat">@@ -958,29 +958,29 @@</span>
<a href="#l12.448"></a><span id="l12.448">               //       |______|      |</span>
<a href="#l12.449"></a><span id="l12.449">               //       |      |      |</span>
<a href="#l12.450"></a><span id="l12.450">               //       |OPEN! |      |&lt;--Our item's start time might be here</span>
<a href="#l12.451"></a><span id="l12.451">               //       |      |______|</span>
<a href="#l12.452"></a><span id="l12.452">               //       |      |      |</span>
<a href="#l12.453"></a><span id="l12.453">               //</span>
<a href="#l12.454"></a><span id="l12.454">               // Remember that any time we're starting a new blob, colEndArray</span>
<a href="#l12.455"></a><span id="l12.455">               // will be empty, but that's ok.</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-              for (var ii = 0; ii &lt; colEndArray.length; ++ii) {</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-                  var colStart = colEndArray[ii].layoutStart;</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-                  var colEnd = colEndArray[ii].layoutEnd;</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineplus">+              for (let ii = 0; ii &lt; colEndArray.length; ++ii) {</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+                  let colStart = colEndArray[ii].layoutStart;</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineplus">+                  let colEnd = colEndArray[ii].layoutEnd;</span>
<a href="#l12.462"></a><span id="l12.462">                   if (colEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l12.463"></a><span id="l12.463">                       // Yay, we can jump into this column</span>
<a href="#l12.464"></a><span id="l12.464">                       colEndArray[ii] = curItemInfo;</span>
<a href="#l12.465"></a><span id="l12.465"> </span>
<a href="#l12.466"></a><span id="l12.466">                       // Check and see if there are any adjacent columns we can</span>
<a href="#l12.467"></a><span id="l12.467">                       // jump into as well.</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineminus">-                      var lastCol = Number(ii) + 1;</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineplus">+                      let lastCol = Number(ii) + 1;</span>
<a href="#l12.470"></a><span id="l12.470">                       while (lastCol &lt; colEndArray.length) {</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineminus">-                          var nextColStart = colEndArray[lastCol].layoutStart;</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineminus">-                          var nextColEnd = colEndArray[lastCol].layoutEnd;</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+                          let nextColStart = colEndArray[lastCol].layoutStart;</span>
<a href="#l12.474"></a><span id="l12.474" class="difflineplus">+                          let nextColEnd = colEndArray[lastCol].layoutEnd;</span>
<a href="#l12.475"></a><span id="l12.475">                           // If the next column's item ends after we start, we</span>
<a href="#l12.476"></a><span id="l12.476">                           // can't expand any further</span>
<a href="#l12.477"></a><span id="l12.477">                           if (nextColEnd.compare(curItemInfo.layoutStart) == 1) {</span>
<a href="#l12.478"></a><span id="l12.478">                               break;</span>
<a href="#l12.479"></a><span id="l12.479">                           }</span>
<a href="#l12.480"></a><span id="l12.480">                           colEndArray[lastCol] = curItemInfo;</span>
<a href="#l12.481"></a><span id="l12.481">                           lastCol++;</span>
<a href="#l12.482"></a><span id="l12.482">                       }</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineat">@@ -1015,30 +1015,30 @@</span>
<a href="#l12.484"></a><span id="l12.484">               //       |      |______|      |</span>
<a href="#l12.485"></a><span id="l12.485">               //       |      |      |______|</span>
<a href="#l12.486"></a><span id="l12.486">               //       |      |_____________|</span>
<a href="#l12.487"></a><span id="l12.487">               //       |      |ev2          |</span>
<a href="#l12.488"></a><span id="l12.488">               //       |______|             |&lt;--If our item's start time is</span>
<a href="#l12.489"></a><span id="l12.489">               //       |      |_____________|   here, we can shrink ev2 and jump</span>
<a href="#l12.490"></a><span id="l12.490">               //       |      |      |      |   in column #3</span>
<a href="#l12.491"></a><span id="l12.491">               //</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineminus">-              for (var jj = 1; jj &lt; colEndArray.length; ++jj) {</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+              for (let jj = 1; jj &lt; colEndArray.length; ++jj) {</span>
<a href="#l12.494"></a><span id="l12.494">                   if (colEndArray[jj].event.hashId == colEndArray[jj - 1].event.hashId) {</span>
<a href="#l12.495"></a><span id="l12.495">                       // Good we found a item that spanned multiple columns.</span>
<a href="#l12.496"></a><span id="l12.496">                       // Find it in the blob so we can modify its properties</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-                      for (var kk in currentBlob) {</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineplus">+                      for (let kk in currentBlob) {</span>
<a href="#l12.499"></a><span id="l12.499">                           if (currentBlob[kk].itemInfo.event.hashId == colEndArray[jj].event.hashId) {</span>
<a href="#l12.500"></a><span id="l12.500">                               // Take all but the first spot that the item spanned</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineminus">-                              var spanOfShrunkItem = currentBlob[kk].colSpan;</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineplus">+                              let spanOfShrunkItem = currentBlob[kk].colSpan;</span>
<a href="#l12.503"></a><span id="l12.503">                               currentBlob.push({itemInfo: curItemInfo,</span>
<a href="#l12.504"></a><span id="l12.504">                                                 startCol: Number(currentBlob[kk].startCol) + 1,</span>
<a href="#l12.505"></a><span id="l12.505">                                                 colSpan: spanOfShrunkItem - 1});</span>
<a href="#l12.506"></a><span id="l12.506"> </span>
<a href="#l12.507"></a><span id="l12.507">                               // Update colEndArray</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineminus">-                              for (var ll = jj; ll &lt; jj + spanOfShrunkItem - 1; ll++) {</span>
<a href="#l12.509"></a><span id="l12.509" class="difflineplus">+                              for (let ll = jj; ll &lt; jj + spanOfShrunkItem - 1; ll++) {</span>
<a href="#l12.510"></a><span id="l12.510">                                   colEndArray[ll] = curItemInfo;</span>
<a href="#l12.511"></a><span id="l12.511">                               }</span>
<a href="#l12.512"></a><span id="l12.512"> </span>
<a href="#l12.513"></a><span id="l12.513">                               // Modify the data on the old item</span>
<a href="#l12.514"></a><span id="l12.514">                               currentBlob[kk] = {itemInfo: currentBlob[kk].itemInfo,</span>
<a href="#l12.515"></a><span id="l12.515">                                                  startCol: currentBlob[kk].startCol,</span>
<a href="#l12.516"></a><span id="l12.516">                                                  colSpan: 1};</span>
<a href="#l12.517"></a><span id="l12.517">                               // Update latestItemEnd</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineat">@@ -1065,20 +1065,20 @@</span>
<a href="#l12.519"></a><span id="l12.519"> </span>
<a href="#l12.520"></a><span id="l12.520">               // All the items in the last column, except for the one* that</span>
<a href="#l12.521"></a><span id="l12.521">               // conflicts with the item we're trying to place, need to have</span>
<a href="#l12.522"></a><span id="l12.522">               // their span extended by 1, since we're adding the new column</span>
<a href="#l12.523"></a><span id="l12.523">               //</span>
<a href="#l12.524"></a><span id="l12.524">               // * Note that there can only be one, because we sorted our</span>
<a href="#l12.525"></a><span id="l12.525">               //   events by start time, so this event must start later than</span>
<a href="#l12.526"></a><span id="l12.526">               //   the start of any possible conflicts.</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-              var lastColNum = colEndArray.length;</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-              for (var mm in currentBlob) {</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-                  var mmStart = currentBlob[mm].itemInfo.layoutStart;</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineminus">-                  var mmEnd = currentBlob[mm].itemInfo.layoutEnd;</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineplus">+              let lastColNum = colEndArray.length;</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+              for (let mm in currentBlob) {</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineplus">+                  let mmStart = currentBlob[mm].itemInfo.layoutStart;</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineplus">+                  let mmEnd = currentBlob[mm].itemInfo.layoutEnd;</span>
<a href="#l12.535"></a><span id="l12.535">                   if (currentBlob[mm].startCol + currentBlob[mm].colSpan == lastColNum &amp;&amp;</span>
<a href="#l12.536"></a><span id="l12.536">                       mmEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l12.537"></a><span id="l12.537">                       currentBlob[mm] = {itemInfo: currentBlob[mm].itemInfo,</span>
<a href="#l12.538"></a><span id="l12.538">                                          startCol: currentBlob[mm].startCol,</span>
<a href="#l12.539"></a><span id="l12.539">                                          colSpan: currentBlob[mm].colSpan + 1};</span>
<a href="#l12.540"></a><span id="l12.540">                   }</span>
<a href="#l12.541"></a><span id="l12.541">               }</span>
<a href="#l12.542"></a><span id="l12.542">               currentBlob.push({itemInfo: curItemInfo,</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineat">@@ -1110,45 +1110,45 @@</span>
<a href="#l12.544"></a><span id="l12.544">           //                the blank time in between them</span>
<a href="#l12.545"></a><span id="l12.545">           //</span>
<a href="#l12.546"></a><span id="l12.546">           // * Note that 'equal width' isn't strictly correct.  If we're</span>
<a href="#l12.547"></a><span id="l12.547">           //   oriented differently, it will be height (and we'll have rows</span>
<a href="#l12.548"></a><span id="l12.548">           //   not columns).  What's more, in the 'specialSpan' case, the</span>
<a href="#l12.549"></a><span id="l12.549">           //   columns won't actually have the same size, but will only all</span>
<a href="#l12.550"></a><span id="l12.550">           //   be multiples of a common size.  See the note in the relayout</span>
<a href="#l12.551"></a><span id="l12.551">           //   function for more info on this (fairly rare) case.</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineminus">-          var layers = [];</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineplus">+          let layers = [];</span>
<a href="#l12.554"></a><span id="l12.554"> </span>
<a href="#l12.555"></a><span id="l12.555">           // When we start a new blob, move to a new set of layers</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineminus">-          var layerOffset = 0;</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineminus">-          for (var glob of aBlobs) {</span>
<a href="#l12.558"></a><span id="l12.558" class="difflineminus">-              var layerArray = [];</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineminus">-              var layerCounter = 1;</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineminus">-</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineminus">-              for (var data of glob.blob) {</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineplus">+          let layerOffset = 0;</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+          for (let glob of aBlobs) {</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineplus">+              let layerArray = [];</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineplus">+              let layerCounter = 1;</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+              for (let data of glob.blob) {</span>
<a href="#l12.568"></a><span id="l12.568">                   // from the item at hand we need to figure out on which</span>
<a href="#l12.569"></a><span id="l12.569">                   // layer and on which column it should go.</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineminus">-                  var layerIndex;</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineminus">-                  var specialSpan = null;</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+                  let layerIndex;</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineplus">+                  let specialSpan = null;</span>
<a href="#l12.574"></a><span id="l12.574"> </span>
<a href="#l12.575"></a><span id="l12.575">                   // each blob receives its own layer, that's the first part of the story. within</span>
<a href="#l12.576"></a><span id="l12.576">                   // a given blob we need to distribute the items on different layers depending on</span>
<a href="#l12.577"></a><span id="l12.577">                   // the number of columns each item spans. if each item just spans a single column</span>
<a href="#l12.578"></a><span id="l12.578">                   // the blob will cover *one* layer. if the blob contains items that span more than</span>
<a href="#l12.579"></a><span id="l12.579">                   // a single column, this blob will cover more than one layer. the algorithm places</span>
<a href="#l12.580"></a><span id="l12.580">                   // the items on the first layer in the case an item covers a single column. new layers</span>
<a href="#l12.581"></a><span id="l12.581">                   // are introduced based on the start column and number of spanning columns of an item.</span>
<a href="#l12.582"></a><span id="l12.582">                   if (data.colSpan != 1) {</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineminus">-                      var index = glob.totalCols * data.colSpan + data.startCol;</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineplus">+                      let index = glob.totalCols * data.colSpan + data.startCol;</span>
<a href="#l12.585"></a><span id="l12.585">                       layerIndex = layerArray[index];</span>
<a href="#l12.586"></a><span id="l12.586">                       if (!layerIndex) {</span>
<a href="#l12.587"></a><span id="l12.587">                           layerIndex = layerCounter++;</span>
<a href="#l12.588"></a><span id="l12.588">                           layerArray[index] = layerIndex;</span>
<a href="#l12.589"></a><span id="l12.589">                       }</span>
<a href="#l12.590"></a><span id="l12.590" class="difflineminus">-                      var offset = ((glob.totalCols - data.colSpan) % glob.totalCols);</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineplus">+                      let offset = ((glob.totalCols - data.colSpan) % glob.totalCols);</span>
<a href="#l12.592"></a><span id="l12.592">                       if (offset != 0) {</span>
<a href="#l12.593"></a><span id="l12.593">                           specialSpan = data.colSpan / glob.totalCols;</span>
<a href="#l12.594"></a><span id="l12.594">                       }</span>
<a href="#l12.595"></a><span id="l12.595">                   } else {</span>
<a href="#l12.596"></a><span id="l12.596">                       layerIndex = 0;</span>
<a href="#l12.597"></a><span id="l12.597">                   }</span>
<a href="#l12.598"></a><span id="l12.598">                   layerIndex += layerOffset;</span>
<a href="#l12.599"></a><span id="l12.599"> </span>
<a href="#l12.600"></a><span id="l12.600" class="difflineat">@@ -1160,26 +1160,26 @@</span>
<a href="#l12.601"></a><span id="l12.601">                   while (data.startCol &gt;= layers[layerIndex].length) {</span>
<a href="#l12.602"></a><span id="l12.602">                       layers[layerIndex].push([]);</span>
<a href="#l12.603"></a><span id="l12.603">                       if (specialSpan) {</span>
<a href="#l12.604"></a><span id="l12.604">                           layers[layerIndex][layers[layerIndex].length - 1].specialSpan = 1 / glob.totalCols;</span>
<a href="#l12.605"></a><span id="l12.605">                       }</span>
<a href="#l12.606"></a><span id="l12.606">                   }</span>
<a href="#l12.607"></a><span id="l12.607"> </span>
<a href="#l12.608"></a><span id="l12.608">                   // we now retrieve the column from 'layerIndex' and 'startCol'.</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineminus">-                  var col = layers[layerIndex][data.startCol];</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineplus">+                  let col = layers[layerIndex][data.startCol];</span>
<a href="#l12.611"></a><span id="l12.611">                   if (specialSpan) {</span>
<a href="#l12.612"></a><span id="l12.612">                       col.specialSpan = specialSpan;</span>
<a href="#l12.613"></a><span id="l12.613">                   }</span>
<a href="#l12.614"></a><span id="l12.614"> </span>
<a href="#l12.615"></a><span id="l12.615">                   // take into account that items can span several days.</span>
<a href="#l12.616"></a><span id="l12.616">                   // that's why i'm clipping the start- and end-time to the</span>
<a href="#l12.617"></a><span id="l12.617">                   // timespan of this column.</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineminus">-                  var start = data.itemInfo.layoutStart;</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineminus">-                  var end = data.itemInfo.layoutEnd;</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineplus">+                  let start = data.itemInfo.layoutStart;</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineplus">+                  let end = data.itemInfo.layoutEnd;</span>
<a href="#l12.622"></a><span id="l12.622">                   if (start.year != this.date.year ||</span>
<a href="#l12.623"></a><span id="l12.623">                       start.month != this.date.month ||</span>
<a href="#l12.624"></a><span id="l12.624">                       start.day != this.date.day) {</span>
<a href="#l12.625"></a><span id="l12.625">                       start = start.clone();</span>
<a href="#l12.626"></a><span id="l12.626">                       start.resetTo(this.date.year,</span>
<a href="#l12.627"></a><span id="l12.627">                                     this.date.month,</span>
<a href="#l12.628"></a><span id="l12.628">                                     this.date.day,</span>
<a href="#l12.629"></a><span id="l12.629">                                     0, this.mStartMin, 0,</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineat">@@ -1190,17 +1190,17 @@</span>
<a href="#l12.631"></a><span id="l12.631">                       end.day != this.date.day) {</span>
<a href="#l12.632"></a><span id="l12.632">                       end = end.clone();</span>
<a href="#l12.633"></a><span id="l12.633">                       end.resetTo(this.date.year,</span>
<a href="#l12.634"></a><span id="l12.634">                                   this.date.month,</span>
<a href="#l12.635"></a><span id="l12.635">                                   this.date.day,</span>
<a href="#l12.636"></a><span id="l12.636">                                   0, this.mEndMin, 0,</span>
<a href="#l12.637"></a><span id="l12.637">                                   end.timezone);</span>
<a href="#l12.638"></a><span id="l12.638">                   }</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineminus">-                  var prevEnd;</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineplus">+                  let prevEnd;</span>
<a href="#l12.641"></a><span id="l12.641">                   if (col.length &gt; 0) {</span>
<a href="#l12.642"></a><span id="l12.642">                       // Fill in time gaps with a placeholder</span>
<a href="#l12.643"></a><span id="l12.643">                       prevEnd = col[col.length - 1].endDate.clone();</span>
<a href="#l12.644"></a><span id="l12.644">                   } else {</span>
<a href="#l12.645"></a><span id="l12.645">                       // First event in the column, add a placeholder for the</span>
<a href="#l12.646"></a><span id="l12.646">                       // blank time from this.mStartMin to the event's start</span>
<a href="#l12.647"></a><span id="l12.647">                       prevEnd = start.clone();</span>
<a href="#l12.648"></a><span id="l12.648">                       prevEnd.hour = 0;</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineat">@@ -1208,23 +1208,23 @@</span>
<a href="#l12.650"></a><span id="l12.650">                   }</span>
<a href="#l12.651"></a><span id="l12.651">                   prevEnd.timezone = floating();</span>
<a href="#l12.652"></a><span id="l12.652">                   // the reason why we need to calculate time durations</span>
<a href="#l12.653"></a><span id="l12.653">                   // based on floating timezones is that we need avoid</span>
<a href="#l12.654"></a><span id="l12.654">                   // dst gaps in this case. converting the date/times to</span>
<a href="#l12.655"></a><span id="l12.655">                   // floating conveys this idea in a natural way. note that</span>
<a href="#l12.656"></a><span id="l12.656">                   // we explicitly don't use getInTimezone() as it would</span>
<a href="#l12.657"></a><span id="l12.657">                   // be slightly more expensive in terms of performance.</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineminus">-                  var floatstart = start.clone();</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineplus">+                  let floatstart = start.clone();</span>
<a href="#l12.660"></a><span id="l12.660">                   floatstart.timezone = floating();</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineminus">-                  var dur = floatstart.subtractDate(prevEnd);</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineplus">+                  let dur = floatstart.subtractDate(prevEnd);</span>
<a href="#l12.663"></a><span id="l12.663">                   if (dur.inSeconds) {</span>
<a href="#l12.664"></a><span id="l12.664">                       col.push({duration: dur});</span>
<a href="#l12.665"></a><span id="l12.665">                   }</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-                  var floatend = end.clone();</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineplus">+                  let floatend = end.clone();</span>
<a href="#l12.668"></a><span id="l12.668">                   floatend.timezone = floating();</span>
<a href="#l12.669"></a><span id="l12.669">                   col.push({event: data.itemInfo.event,</span>
<a href="#l12.670"></a><span id="l12.670">                             endDate: end,</span>
<a href="#l12.671"></a><span id="l12.671">                             startDate: start,</span>
<a href="#l12.672"></a><span id="l12.672">                             duration: floatend.subtractDate(floatstart)});</span>
<a href="#l12.673"></a><span id="l12.673">               }</span>
<a href="#l12.674"></a><span id="l12.674">               layerOffset = layers.length;</span>
<a href="#l12.675"></a><span id="l12.675">           }</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineat">@@ -1638,43 +1638,43 @@</span>
<a href="#l12.677"></a><span id="l12.677">           window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp, false);</span>
<a href="#l12.678"></a><span id="l12.678">           window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress, false);</span>
<a href="#l12.679"></a><span id="l12.679"> </span>
<a href="#l12.680"></a><span id="l12.680">           document.calendarEventColumnDragging = null;</span>
<a href="#l12.681"></a><span id="l12.681"> </span>
<a href="#l12.682"></a><span id="l12.682">           // if the user didn't sweep out at least a few pixels, ignore</span>
<a href="#l12.683"></a><span id="l12.683">           // unless we're in a different column</span>
<a href="#l12.684"></a><span id="l12.684">           if (dragState.origColumn == col) {</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineminus">-              var ignore = false;</span>
<a href="#l12.686"></a><span id="l12.686" class="difflineplus">+              let ignore = false;</span>
<a href="#l12.687"></a><span id="l12.687">               if (col.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l12.688"></a><span id="l12.688">                   if (Math.abs(event.screenY - dragState.origLoc) &lt; 3) {</span>
<a href="#l12.689"></a><span id="l12.689">                       ignore = true;</span>
<a href="#l12.690"></a><span id="l12.690">                   }</span>
<a href="#l12.691"></a><span id="l12.691">               } else {</span>
<a href="#l12.692"></a><span id="l12.692">                   if (Math.abs(event.screenX - dragState.origLoc) &lt; 3) {</span>
<a href="#l12.693"></a><span id="l12.693">                       ignore = true;</span>
<a href="#l12.694"></a><span id="l12.694">                   }</span>
<a href="#l12.695"></a><span id="l12.695">               }</span>
<a href="#l12.696"></a><span id="l12.696"> </span>
<a href="#l12.697"></a><span id="l12.697">               if (ignore) {</span>
<a href="#l12.698"></a><span id="l12.698">                   col.mDragState = null;</span>
<a href="#l12.699"></a><span id="l12.699">                   return;</span>
<a href="#l12.700"></a><span id="l12.700">               }</span>
<a href="#l12.701"></a><span id="l12.701">           }</span>
<a href="#l12.702"></a><span id="l12.702"> </span>
<a href="#l12.703"></a><span id="l12.703" class="difflineminus">-          var newStart;</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineminus">-          var newEnd;</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineminus">-          var startTZ;</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineminus">-          var endTZ;</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineplus">+          let newStart;</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+          let newEnd;</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineplus">+          let startTZ;</span>
<a href="#l12.710"></a><span id="l12.710" class="difflineplus">+          let endTZ;</span>
<a href="#l12.711"></a><span id="l12.711">           let dragDay = col.mDate;</span>
<a href="#l12.712"></a><span id="l12.712">           if (dragState.dragType != &quot;new&quot;) {</span>
<a href="#l12.713"></a><span id="l12.713" class="difflineminus">-              var oldStart = dragState.dragOccurrence.startDate ||</span>
<a href="#l12.714"></a><span id="l12.714" class="difflineplus">+              let oldStart = dragState.dragOccurrence.startDate ||</span>
<a href="#l12.715"></a><span id="l12.715">                              dragState.dragOccurrence.entryDate ||</span>
<a href="#l12.716"></a><span id="l12.716">                              dragState.dragOccurrence.dueDate;</span>
<a href="#l12.717"></a><span id="l12.717" class="difflineminus">-              var oldEnd = dragState.dragOccurrence.endDate ||</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineplus">+              let oldEnd = dragState.dragOccurrence.endDate ||</span>
<a href="#l12.719"></a><span id="l12.719">                            dragState.dragOccurrence.dueDate ||</span>
<a href="#l12.720"></a><span id="l12.720">                            dragState.dragOccurrence.entryDate;</span>
<a href="#l12.721"></a><span id="l12.721">               newStart = oldStart.clone();</span>
<a href="#l12.722"></a><span id="l12.722">               newEnd = oldEnd.clone();</span>
<a href="#l12.723"></a><span id="l12.723"> </span>
<a href="#l12.724"></a><span id="l12.724">               // Our views are pegged to the default timezone.  If the event</span>
<a href="#l12.725"></a><span id="l12.725">               // isn't also in the timezone, we're going to need to do some</span>
<a href="#l12.726"></a><span id="l12.726">               // tweaking. We could just do this for every event but</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineat">@@ -1943,28 +1943,28 @@</span>
<a href="#l12.728"></a><span id="l12.728">           if (!this.mDragState) {</span>
<a href="#l12.729"></a><span id="l12.729">               return;</span>
<a href="#l12.730"></a><span id="l12.730">           }</span>
<a href="#l12.731"></a><span id="l12.731"> </span>
<a href="#l12.732"></a><span id="l12.732">           let firstColumn = (aFirstColumn || this);</span>
<a href="#l12.733"></a><span id="l12.733">           let lastColumn = (aLastColumn || this);</span>
<a href="#l12.734"></a><span id="l12.734">           let realstartmin = this.mDragState.startMin + this.mStartMin;</span>
<a href="#l12.735"></a><span id="l12.735">           let realendmin = this.mDragState.endMin + this.mStartMin;</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineminus">-          var starthr = Math.floor(realstartmin / 60);</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineminus">-          var startmin = realstartmin % 60;</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineminus">-</span>
<a href="#l12.739"></a><span id="l12.739" class="difflineminus">-          var endhr = Math.floor(realendmin / 60);</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineminus">-          var endmin = realendmin % 60;</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineminus">-</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineminus">-          var formatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;].</span>
<a href="#l12.743"></a><span id="l12.743" class="difflineplus">+          let starthr = Math.floor(realstartmin / 60);</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineplus">+          let startmin = realstartmin % 60;</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineplus">+</span>
<a href="#l12.746"></a><span id="l12.746" class="difflineplus">+          let endhr = Math.floor(realendmin / 60);</span>
<a href="#l12.747"></a><span id="l12.747" class="difflineplus">+          let endmin = realendmin % 60;</span>
<a href="#l12.748"></a><span id="l12.748" class="difflineplus">+</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineplus">+          let formatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;].</span>
<a href="#l12.750"></a><span id="l12.750">                           getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l12.751"></a><span id="l12.751" class="difflineminus">-          var startstr = formatter.FormatTime(&quot;&quot;,</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineplus">+          let startstr = formatter.FormatTime(&quot;&quot;,</span>
<a href="#l12.753"></a><span id="l12.753">                                               Components.interfaces.nsIScriptableDateFormat.timeFormatNoSeconds,</span>
<a href="#l12.754"></a><span id="l12.754">                                               starthr, startmin, 0);</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineminus">-          var endstr = formatter.FormatTime(&quot;&quot;,</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineplus">+          let endstr = formatter.FormatTime(&quot;&quot;,</span>
<a href="#l12.757"></a><span id="l12.757">                                             Components.interfaces.nsIScriptableDateFormat.timeFormatNoSeconds,</span>
<a href="#l12.758"></a><span id="l12.758">                                             endhr, endmin, 0);</span>
<a href="#l12.759"></a><span id="l12.759"> </span>
<a href="#l12.760"></a><span id="l12.760">           // Tasks without Entry or Due date have a string as first label</span>
<a href="#l12.761"></a><span id="l12.761">           // instead of the time.</span>
<a href="#l12.762"></a><span id="l12.762">           if (cal.isToDo(this.mDragState.dragOccurrence)) {</span>
<a href="#l12.763"></a><span id="l12.763">               if (!this.mDragState.dragOccurrence.dueDate) {</span>
<a href="#l12.764"></a><span id="l12.764">                   startstr = calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyEntryDate&quot;);</span>
<a href="#l12.765"></a><span id="l12.765" class="difflineat">@@ -2113,17 +2113,17 @@</span>
<a href="#l12.766"></a><span id="l12.766">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.767"></a><span id="l12.767">           this.mDate = val;</span>
<a href="#l12.768"></a><span id="l12.768">           return val;</span>
<a href="#l12.769"></a><span id="l12.769">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.770"></a><span id="l12.770">       &lt;/property&gt;</span>
<a href="#l12.771"></a><span id="l12.771">       &lt;method name=&quot;findBoxForItem&quot;&gt;</span>
<a href="#l12.772"></a><span id="l12.772">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l12.773"></a><span id="l12.773">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.774"></a><span id="l12.774" class="difflineminus">-          for (var item of this.mItemBoxes) {</span>
<a href="#l12.775"></a><span id="l12.775" class="difflineplus">+          for (let item of this.mItemBoxes) {</span>
<a href="#l12.776"></a><span id="l12.776">               if (aItem &amp;&amp; item.occurrence.hasSameIds(aItem)) {</span>
<a href="#l12.777"></a><span id="l12.777">                   // We can return directly, since there will only be one box per</span>
<a href="#l12.778"></a><span id="l12.778">                   // item in the header.</span>
<a href="#l12.779"></a><span id="l12.779">                   return item;</span>
<a href="#l12.780"></a><span id="l12.780">               }</span>
<a href="#l12.781"></a><span id="l12.781">           }</span>
<a href="#l12.782"></a><span id="l12.782">           return null;</span>
<a href="#l12.783"></a><span id="l12.783">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.784"></a><span id="l12.784" class="difflineat">@@ -2132,37 +2132,37 @@</span>
<a href="#l12.785"></a><span id="l12.785">       &lt;method name=&quot;addEvent&quot;&gt;</span>
<a href="#l12.786"></a><span id="l12.786">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l12.787"></a><span id="l12.787">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.788"></a><span id="l12.788">           // prevent same items being added</span>
<a href="#l12.789"></a><span id="l12.789">           if (this.mItemBoxes.some(itemBox =&gt; itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l12.790"></a><span id="l12.790">             return;</span>
<a href="#l12.791"></a><span id="l12.791">           }</span>
<a href="#l12.792"></a><span id="l12.792"> </span>
<a href="#l12.793"></a><span id="l12.793" class="difflineminus">-          var itemBox = createXULElement(&quot;calendar-editable-item&quot;);</span>
<a href="#l12.794"></a><span id="l12.794" class="difflineplus">+          let itemBox = createXULElement(&quot;calendar-editable-item&quot;);</span>
<a href="#l12.795"></a><span id="l12.795">           this.appendChild(itemBox);</span>
<a href="#l12.796"></a><span id="l12.796">           itemBox.calendarView = this.calendarView;</span>
<a href="#l12.797"></a><span id="l12.797">           itemBox.occurrence = aItem;</span>
<a href="#l12.798"></a><span id="l12.798" class="difflineminus">-          var ctxt = this.calendarView.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l12.799"></a><span id="l12.799" class="difflineplus">+          let ctxt = this.calendarView.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l12.800"></a><span id="l12.800">                      this.calendarView.getAttribute(&quot;context&quot;);</span>
<a href="#l12.801"></a><span id="l12.801">           itemBox.setAttribute(&quot;context&quot;, ctxt);</span>
<a href="#l12.802"></a><span id="l12.802"> </span>
<a href="#l12.803"></a><span id="l12.803">           if (aItem.hashId in this.calendarView.mFlashingEvents) {</span>
<a href="#l12.804"></a><span id="l12.804">             itemBox.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l12.805"></a><span id="l12.805">           }</span>
<a href="#l12.806"></a><span id="l12.806"> </span>
<a href="#l12.807"></a><span id="l12.807">           this.mItemBoxes.push(itemBox);</span>
<a href="#l12.808"></a><span id="l12.808">           itemBox.parentBox = this;</span>
<a href="#l12.809"></a><span id="l12.809">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.810"></a><span id="l12.810">       &lt;/method&gt;</span>
<a href="#l12.811"></a><span id="l12.811"> </span>
<a href="#l12.812"></a><span id="l12.812">       &lt;method name=&quot;deleteEvent&quot;&gt;</span>
<a href="#l12.813"></a><span id="l12.813">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l12.814"></a><span id="l12.814">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineminus">-          for (var i in this.mItemBoxes) {</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineplus">+          for (let i in this.mItemBoxes) {</span>
<a href="#l12.817"></a><span id="l12.817">             if (this.mItemBoxes[i].occurrence.hashId == aItem.hashId) {</span>
<a href="#l12.818"></a><span id="l12.818">               this.mItemBoxes[i].remove();</span>
<a href="#l12.819"></a><span id="l12.819">               this.mItemBoxes.splice(i, 1);</span>
<a href="#l12.820"></a><span id="l12.820">               break;</span>
<a href="#l12.821"></a><span id="l12.821">             }</span>
<a href="#l12.822"></a><span id="l12.822">           }</span>
<a href="#l12.823"></a><span id="l12.823">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.824"></a><span id="l12.824">       &lt;/method&gt;</span>
<a href="#l12.825"></a><span id="l12.825" class="difflineat">@@ -2308,97 +2308,97 @@</span>
<a href="#l12.826"></a><span id="l12.826">       &lt;!-- fields --&gt;</span>
<a href="#l12.827"></a><span id="l12.827">       &lt;field name=&quot;mParentColumn&quot;&gt;null&lt;/field&gt;</span>
<a href="#l12.828"></a><span id="l12.828"> </span>
<a href="#l12.829"></a><span id="l12.829">       &lt;!-- methods/properties --&gt;</span>
<a href="#l12.830"></a><span id="l12.830">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l12.831"></a><span id="l12.831">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l12.832"></a><span id="l12.832">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l12.833"></a><span id="l12.833">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.834"></a><span id="l12.834" class="difflineminus">-          var needsrelayout = false;</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineplus">+          let needsrelayout = false;</span>
<a href="#l12.836"></a><span id="l12.836">           if (aAttr == &quot;orient&quot;) {</span>
<a href="#l12.837"></a><span id="l12.837">               if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l12.838"></a><span id="l12.838">                   needsrelayout = true;</span>
<a href="#l12.839"></a><span id="l12.839">               }</span>
<a href="#l12.840"></a><span id="l12.840">           }</span>
<a href="#l12.841"></a><span id="l12.841"> </span>
<a href="#l12.842"></a><span id="l12.842">           // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l12.843"></a><span id="l12.843" class="difflineminus">-          var ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineplus">+          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.845"></a><span id="l12.845"> </span>
<a href="#l12.846"></a><span id="l12.846">           if (needsrelayout) {</span>
<a href="#l12.847"></a><span id="l12.847" class="difflineminus">-              var otherorient = (val == &quot;vertical&quot; ? &quot;horizontal&quot; : &quot;vertical&quot;);</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineminus">-              var eventbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;);</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineplus">+              let otherorient = (val == &quot;vertical&quot; ? &quot;horizontal&quot; : &quot;vertical&quot;);</span>
<a href="#l12.850"></a><span id="l12.850" class="difflineplus">+              let eventbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;);</span>
<a href="#l12.851"></a><span id="l12.851">               eventbox.setAttribute(&quot;orient&quot;, val);</span>
<a href="#l12.852"></a><span id="l12.852" class="difflineminus">-              var gb1 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;);</span>
<a href="#l12.853"></a><span id="l12.853" class="difflineplus">+              let gb1 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;);</span>
<a href="#l12.854"></a><span id="l12.854">               gb1.parentorient = val;</span>
<a href="#l12.855"></a><span id="l12.855" class="difflineminus">-              var gb2 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar2&quot;);</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineplus">+              let gb2 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar2&quot;);</span>
<a href="#l12.857"></a><span id="l12.857">               gb2.parentorient = val;</span>
<a href="#l12.858"></a><span id="l12.858">           }</span>
<a href="#l12.859"></a><span id="l12.859"> </span>
<a href="#l12.860"></a><span id="l12.860">           return ret;</span>
<a href="#l12.861"></a><span id="l12.861">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.862"></a><span id="l12.862">       &lt;/method&gt;</span>
<a href="#l12.863"></a><span id="l12.863"> </span>
<a href="#l12.864"></a><span id="l12.864">       &lt;method name=&quot;getOptimalMinSize&quot;&gt;</span>
<a href="#l12.865"></a><span id="l12.865">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.866"></a><span id="l12.866">           if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l12.867"></a><span id="l12.867" class="difflineminus">-              var minHeight = getOptimalMinimumHeight(this.eventNameLabel) +</span>
<a href="#l12.868"></a><span id="l12.868" class="difflineplus">+              let minHeight = getOptimalMinimumHeight(this.eventNameLabel) +</span>
<a href="#l12.869"></a><span id="l12.869">                               getSummarizedStyleValues(document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;), [&quot;margin-bottom&quot;, &quot;margin-top&quot;]) +</span>
<a href="#l12.870"></a><span id="l12.870">                               getSummarizedStyleValues(this, [&quot;border-bottom-width&quot;, &quot;border-top-width&quot;]);</span>
<a href="#l12.871"></a><span id="l12.871">               this.setAttribute(&quot;minheight&quot;, minHeight);</span>
<a href="#l12.872"></a><span id="l12.872">               this.setAttribute(&quot;minwidth&quot;, &quot;1&quot;);</span>
<a href="#l12.873"></a><span id="l12.873">               return minHeight;</span>
<a href="#l12.874"></a><span id="l12.874">           } else {</span>
<a href="#l12.875"></a><span id="l12.875">               this.eventNameLabel.setAttribute(&quot;style&quot;, &quot;min-width: 2em&quot;);</span>
<a href="#l12.876"></a><span id="l12.876" class="difflineminus">-              var minWidth = getOptimalMinimumWidth(this.eventNameLabel);</span>
<a href="#l12.877"></a><span id="l12.877" class="difflineplus">+              let minWidth = getOptimalMinimumWidth(this.eventNameLabel);</span>
<a href="#l12.878"></a><span id="l12.878">               this.setAttribute(&quot;minwidth&quot;, minWidth);</span>
<a href="#l12.879"></a><span id="l12.879">               this.setAttribute(&quot;minheight&quot;, &quot;1&quot;);</span>
<a href="#l12.880"></a><span id="l12.880">               return minWidth;</span>
<a href="#l12.881"></a><span id="l12.881">           }</span>
<a href="#l12.882"></a><span id="l12.882">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.883"></a><span id="l12.883">       &lt;/method&gt;</span>
<a href="#l12.884"></a><span id="l12.884"> </span>
<a href="#l12.885"></a><span id="l12.885">       &lt;property name=&quot;parentColumn&quot;</span>
<a href="#l12.886"></a><span id="l12.886">         onget=&quot;return this.mParentColumn;&quot;</span>
<a href="#l12.887"></a><span id="l12.887">         onset=&quot;return (this.mParentColumn = val);&quot;/&gt;</span>
<a href="#l12.888"></a><span id="l12.888"> </span>
<a href="#l12.889"></a><span id="l12.889">       &lt;property name=&quot;startMinute&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l12.890"></a><span id="l12.890">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.891"></a><span id="l12.891">             if (!this.mOccurrence) {</span>
<a href="#l12.892"></a><span id="l12.892">                 return 0;</span>
<a href="#l12.893"></a><span id="l12.893">             }</span>
<a href="#l12.894"></a><span id="l12.894" class="difflineminus">-            var startDate = this.mOccurrence.startDate || this.mOccurrence.entryDate;</span>
<a href="#l12.895"></a><span id="l12.895" class="difflineplus">+            let startDate = this.mOccurrence.startDate || this.mOccurrence.entryDate;</span>
<a href="#l12.896"></a><span id="l12.896">             return startDate.hour * 60 + startDate.minute;</span>
<a href="#l12.897"></a><span id="l12.897">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.898"></a><span id="l12.898">       &lt;/property&gt;</span>
<a href="#l12.899"></a><span id="l12.899"> </span>
<a href="#l12.900"></a><span id="l12.900">       &lt;property name=&quot;endMinute&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l12.901"></a><span id="l12.901">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.902"></a><span id="l12.902">             if (!this.mOccurrence) {</span>
<a href="#l12.903"></a><span id="l12.903">                 return 0;</span>
<a href="#l12.904"></a><span id="l12.904">             }</span>
<a href="#l12.905"></a><span id="l12.905" class="difflineminus">-            var endDate = this.mOccurrence.endDate || this.mOccurrence.dueDate;</span>
<a href="#l12.906"></a><span id="l12.906" class="difflineplus">+            let endDate = this.mOccurrence.endDate || this.mOccurrence.dueDate;</span>
<a href="#l12.907"></a><span id="l12.907">             return endDate.hour * 60 + endDate.minute;</span>
<a href="#l12.908"></a><span id="l12.908">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.909"></a><span id="l12.909">       &lt;/property&gt;</span>
<a href="#l12.910"></a><span id="l12.910"> </span>
<a href="#l12.911"></a><span id="l12.911">       &lt;method name=&quot;setEditableLabel&quot;&gt;</span>
<a href="#l12.912"></a><span id="l12.912">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.913"></a><span id="l12.913" class="difflineminus">-          var evl = this.eventNameLabel;</span>
<a href="#l12.914"></a><span id="l12.914" class="difflineminus">-          var item = this.mOccurrence;</span>
<a href="#l12.915"></a><span id="l12.915" class="difflineplus">+          let evl = this.eventNameLabel;</span>
<a href="#l12.916"></a><span id="l12.916" class="difflineplus">+          let item = this.mOccurrence;</span>
<a href="#l12.917"></a><span id="l12.917"> </span>
<a href="#l12.918"></a><span id="l12.918">           if (item.title &amp;&amp; item.title != &quot;&quot;) {</span>
<a href="#l12.919"></a><span id="l12.919">             // Use &lt;description&gt; textContent so it can wrap.</span>
<a href="#l12.920"></a><span id="l12.920">             evl.textContent = item.title;</span>
<a href="#l12.921"></a><span id="l12.921">           } else {</span>
<a href="#l12.922"></a><span id="l12.922">             evl.textContent = calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l12.923"></a><span id="l12.923">           }</span>
<a href="#l12.924"></a><span id="l12.924"> </span>
<a href="#l12.925"></a><span id="l12.925" class="difflineminus">-          var gripbar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;).boxObject.height;</span>
<a href="#l12.926"></a><span id="l12.926" class="difflineminus">-          var height = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;).boxObject.height;</span>
<a href="#l12.927"></a><span id="l12.927" class="difflineplus">+          let gripbar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;).boxObject.height;</span>
<a href="#l12.928"></a><span id="l12.928" class="difflineplus">+          let height = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;).boxObject.height;</span>
<a href="#l12.929"></a><span id="l12.929">           evl.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + Math.max(0, height-gripbar * 2) + &quot;px&quot;);</span>
<a href="#l12.930"></a><span id="l12.930">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.931"></a><span id="l12.931">       &lt;/method&gt;</span>
<a href="#l12.932"></a><span id="l12.932">     &lt;/implementation&gt;</span>
<a href="#l12.933"></a><span id="l12.933"> </span>
<a href="#l12.934"></a><span id="l12.934">     &lt;handlers&gt;</span>
<a href="#l12.935"></a><span id="l12.935">       &lt;handler event=&quot;mousedown&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l12.936"></a><span id="l12.936">         event.stopPropagation();</span>
<a href="#l12.937"></a><span id="l12.937" class="difflineat">@@ -2432,18 +2432,18 @@</span>
<a href="#l12.938"></a><span id="l12.938">         }</span>
<a href="#l12.939"></a><span id="l12.939">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l12.940"></a><span id="l12.940"> </span>
<a href="#l12.941"></a><span id="l12.941">       &lt;handler event=&quot;mousemove&quot;&gt;&lt;![CDATA[</span>
<a href="#l12.942"></a><span id="l12.942">         if (!this.mInMouseDown) {</span>
<a href="#l12.943"></a><span id="l12.943">             return;</span>
<a href="#l12.944"></a><span id="l12.944">         }</span>
<a href="#l12.945"></a><span id="l12.945"> </span>
<a href="#l12.946"></a><span id="l12.946" class="difflineminus">-        var dx = Math.abs(event.screenX - this.mMouseX);</span>
<a href="#l12.947"></a><span id="l12.947" class="difflineminus">-        var dy = Math.abs(event.screenY - this.mMouseY);</span>
<a href="#l12.948"></a><span id="l12.948" class="difflineplus">+        let dx = Math.abs(event.screenX - this.mMouseX);</span>
<a href="#l12.949"></a><span id="l12.949" class="difflineplus">+        let dy = Math.abs(event.screenY - this.mMouseY);</span>
<a href="#l12.950"></a><span id="l12.950">         // more than a 3 pixel move?</span>
<a href="#l12.951"></a><span id="l12.951">         if ((dx * dx + dy * dy) &gt; 9) {</span>
<a href="#l12.952"></a><span id="l12.952">             if (this.parentColumn) {</span>
<a href="#l12.953"></a><span id="l12.953">                 if (this.editingTimer) {</span>
<a href="#l12.954"></a><span id="l12.954">                     clearTimeout(this.editingTimer);</span>
<a href="#l12.955"></a><span id="l12.955">                     this.editingTimer = null;</span>
<a href="#l12.956"></a><span id="l12.956">                 }</span>
<a href="#l12.957"></a><span id="l12.957"> </span>
<a href="#l12.958"></a><span id="l12.958" class="difflineat">@@ -2527,17 +2527,17 @@</span>
<a href="#l12.959"></a><span id="l12.959"> </span>
<a href="#l12.960"></a><span id="l12.960">         // initially scroll to the day start hour in the view</span>
<a href="#l12.961"></a><span id="l12.961">         this.scrollToMinute(this.mDayStartMin);</span>
<a href="#l12.962"></a><span id="l12.962"> </span>
<a href="#l12.963"></a><span id="l12.963">         // get visible hours from prefs and set on the view</span>
<a href="#l12.964"></a><span id="l12.964">         let visibleMinutes = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9) * 60;</span>
<a href="#l12.965"></a><span id="l12.965">         this.setVisibleMinutes(visibleMinutes);</span>
<a href="#l12.966"></a><span id="l12.966"> </span>
<a href="#l12.967"></a><span id="l12.967" class="difflineminus">-        var self = this;</span>
<a href="#l12.968"></a><span id="l12.968" class="difflineplus">+        let self = this;</span>
<a href="#l12.969"></a><span id="l12.969">         // set the flex attribute at the scrollbox-innerbox</span>
<a href="#l12.970"></a><span id="l12.970">         // (this can be removed, after Bug 343555 is fixed)</span>
<a href="#l12.971"></a><span id="l12.971">         let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l12.972"></a><span id="l12.972">                        this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l12.973"></a><span id="l12.973">         document.getAnonymousElementByAttribute(</span>
<a href="#l12.974"></a><span id="l12.974">             scrollbox, &quot;class&quot;, &quot;box-inherit scrollbox-innerbox&quot;).flex = &quot;1&quot;;</span>
<a href="#l12.975"></a><span id="l12.975"> </span>
<a href="#l12.976"></a><span id="l12.976">         // set the time interval for the time indicator timer</span>
<a href="#l12.977"></a><span id="l12.977" class="difflineat">@@ -2743,18 +2743,18 @@</span>
<a href="#l12.978"></a><span id="l12.978">       &lt;field name=&quot;mTimeIndicatorInterval&quot;&gt;15&lt;/field&gt;</span>
<a href="#l12.979"></a><span id="l12.979">       &lt;field name=&quot;mModeHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l12.980"></a><span id="l12.980">       &lt;field name=&quot;mTimeIndicatorMinutes&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.981"></a><span id="l12.981"> </span>
<a href="#l12.982"></a><span id="l12.982">       &lt;method name=&quot;flashAlarm&quot;&gt;</span>
<a href="#l12.983"></a><span id="l12.983">         &lt;parameter name=&quot;aAlarmItem&quot;/&gt;</span>
<a href="#l12.984"></a><span id="l12.984">         &lt;parameter name=&quot;aStop&quot;/&gt;</span>
<a href="#l12.985"></a><span id="l12.985">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.986"></a><span id="l12.986" class="difflineminus">-          var showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l12.987"></a><span id="l12.987" class="difflineminus">-          var totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l12.988"></a><span id="l12.988" class="difflineplus">+          let showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l12.989"></a><span id="l12.989" class="difflineplus">+          let totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l12.990"></a><span id="l12.990"> </span>
<a href="#l12.991"></a><span id="l12.991">           if (!aStop &amp;&amp; (!showIndicator || totaltime &lt; 1)) {</span>
<a href="#l12.992"></a><span id="l12.992">             // No need to animate if the indicator should not be shown.</span>
<a href="#l12.993"></a><span id="l12.993">             return;</span>
<a href="#l12.994"></a><span id="l12.994">           }</span>
<a href="#l12.995"></a><span id="l12.995"> </span>
<a href="#l12.996"></a><span id="l12.996">           // Helper function to save some duplicate code</span>
<a href="#l12.997"></a><span id="l12.997">           function setFlashingAttribute(aBox) {</span>
<a href="#l12.998"></a><span id="l12.998" class="difflineat">@@ -2762,31 +2762,31 @@</span>
<a href="#l12.999"></a><span id="l12.999">               aBox.removeAttribute(&quot;flashing&quot;);</span>
<a href="#l12.1000"></a><span id="l12.1000">             } else {</span>
<a href="#l12.1001"></a><span id="l12.1001">               aBox.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l12.1002"></a><span id="l12.1002">             }</span>
<a href="#l12.1003"></a><span id="l12.1003">           }</span>
<a href="#l12.1004"></a><span id="l12.1004"> </span>
<a href="#l12.1005"></a><span id="l12.1005">           // Make sure the flashing attribute is set or reset on all visible</span>
<a href="#l12.1006"></a><span id="l12.1006">           // boxes.</span>
<a href="#l12.1007"></a><span id="l12.1007" class="difflineminus">-          var columns = this.findColumnsForItem(aAlarmItem);</span>
<a href="#l12.1008"></a><span id="l12.1008" class="difflineminus">-          for (var col of columns) {</span>
<a href="#l12.1009"></a><span id="l12.1009" class="difflineminus">-            var box = col.column.findChunkForOccurrence(aAlarmItem);</span>
<a href="#l12.1010"></a><span id="l12.1010" class="difflineplus">+          let columns = this.findColumnsForItem(aAlarmItem);</span>
<a href="#l12.1011"></a><span id="l12.1011" class="difflineplus">+          for (let col of columns) {</span>
<a href="#l12.1012"></a><span id="l12.1012" class="difflineplus">+            let box = col.column.findChunkForOccurrence(aAlarmItem);</span>
<a href="#l12.1013"></a><span id="l12.1013">             if (box &amp;&amp; box.eventbox) {</span>
<a href="#l12.1014"></a><span id="l12.1014">               setFlashingAttribute(box.eventbox);</span>
<a href="#l12.1015"></a><span id="l12.1015">             }</span>
<a href="#l12.1016"></a><span id="l12.1016">             box = col.header.findBoxForItem(aAlarmItem);</span>
<a href="#l12.1017"></a><span id="l12.1017">             if (box) {</span>
<a href="#l12.1018"></a><span id="l12.1018">               setFlashingAttribute(box);</span>
<a href="#l12.1019"></a><span id="l12.1019">             }</span>
<a href="#l12.1020"></a><span id="l12.1020">           }</span>
<a href="#l12.1021"></a><span id="l12.1021"> </span>
<a href="#l12.1022"></a><span id="l12.1022">           if (!aStop) {</span>
<a href="#l12.1023"></a><span id="l12.1023">             // Set up a timer to stop the flashing after the total time.</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineminus">-            var this_ = this;</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineplus">+            let this_ = this;</span>
<a href="#l12.1026"></a><span id="l12.1026">             this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l12.1027"></a><span id="l12.1027">             setTimeout(function() { this_.flashAlarm(aAlarmItem, true); }, totaltime);</span>
<a href="#l12.1028"></a><span id="l12.1028">           } else {</span>
<a href="#l12.1029"></a><span id="l12.1029">             // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l12.1030"></a><span id="l12.1030">             delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l12.1031"></a><span id="l12.1031">           }</span>
<a href="#l12.1032"></a><span id="l12.1032">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1033"></a><span id="l12.1033">       &lt;/method&gt;</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineat">@@ -2819,26 +2819,26 @@</span>
<a href="#l12.1035"></a><span id="l12.1035">               return null;</span>
<a href="#l12.1036"></a><span id="l12.1036">           }</span>
<a href="#l12.1037"></a><span id="l12.1037">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1038"></a><span id="l12.1038">       &lt;/property&gt;</span>
<a href="#l12.1039"></a><span id="l12.1039"> </span>
<a href="#l12.1040"></a><span id="l12.1040">       &lt;method name=&quot;showDate&quot;&gt;</span>
<a href="#l12.1041"></a><span id="l12.1041">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l12.1042"></a><span id="l12.1042">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1043"></a><span id="l12.1043" class="difflineminus">-          var targetDate = aDate.getInTimezone(this.mTimezone);</span>
<a href="#l12.1044"></a><span id="l12.1044" class="difflineplus">+          let targetDate = aDate.getInTimezone(this.mTimezone);</span>
<a href="#l12.1045"></a><span id="l12.1045">           targetDate.isDate = true;</span>
<a href="#l12.1046"></a><span id="l12.1046"> </span>
<a href="#l12.1047"></a><span id="l12.1047">           if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l12.1048"></a><span id="l12.1048">               if (this.mStartDate.compare(targetDate) &lt;= 0 &amp;&amp;</span>
<a href="#l12.1049"></a><span id="l12.1049">                   this.mEndDate.compare(targetDate) &gt;= 0) {</span>
<a href="#l12.1050"></a><span id="l12.1050">                   return;</span>
<a href="#l12.1051"></a><span id="l12.1051">               }</span>
<a href="#l12.1052"></a><span id="l12.1052">           } else if (this.mDateList) {</span>
<a href="#l12.1053"></a><span id="l12.1053" class="difflineminus">-              for (var d of this.mDateList) {</span>
<a href="#l12.1054"></a><span id="l12.1054" class="difflineplus">+              for (let d of this.mDateList) {</span>
<a href="#l12.1055"></a><span id="l12.1055">                   // if date is already visible, nothing to do</span>
<a href="#l12.1056"></a><span id="l12.1056">                   if (d.compare(targetDate) == 0) {</span>
<a href="#l12.1057"></a><span id="l12.1057">                       return;</span>
<a href="#l12.1058"></a><span id="l12.1058">                   }</span>
<a href="#l12.1059"></a><span id="l12.1059">               }</span>
<a href="#l12.1060"></a><span id="l12.1060">           }</span>
<a href="#l12.1061"></a><span id="l12.1061"> </span>
<a href="#l12.1062"></a><span id="l12.1062">           // if we're only showing one date, then continue</span>
<a href="#l12.1063"></a><span id="l12.1063" class="difflineat">@@ -2934,17 +2934,17 @@</span>
<a href="#l12.1064"></a><span id="l12.1064">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1065"></a><span id="l12.1065">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1066"></a><span id="l12.1066">             this.mClickedTime = val;</span>
<a href="#l12.1067"></a><span id="l12.1067">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1068"></a><span id="l12.1068">       &lt;/property&gt;</span>
<a href="#l12.1069"></a><span id="l12.1069"> </span>
<a href="#l12.1070"></a><span id="l12.1070">       &lt;property name=&quot;selectedDay&quot;&gt;</span>
<a href="#l12.1071"></a><span id="l12.1071">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1072"></a><span id="l12.1072" class="difflineminus">-          var selected;</span>
<a href="#l12.1073"></a><span id="l12.1073" class="difflineplus">+          let selected;</span>
<a href="#l12.1074"></a><span id="l12.1074">           if (this.numVisibleDates == 1) {</span>
<a href="#l12.1075"></a><span id="l12.1075">               selected = this.mDateColumns[0].date;</span>
<a href="#l12.1076"></a><span id="l12.1076">           } else if (this.mSelectedDay) {</span>
<a href="#l12.1077"></a><span id="l12.1077">               selected = this.mSelectedDay;</span>
<a href="#l12.1078"></a><span id="l12.1078">           } else if (this.mSelectedDayCol) {</span>
<a href="#l12.1079"></a><span id="l12.1079">               selected = this.mSelectedDayCol.date;</span>
<a href="#l12.1080"></a><span id="l12.1080">           }</span>
<a href="#l12.1081"></a><span id="l12.1081"> </span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineat">@@ -2970,17 +2970,17 @@</span>
<a href="#l12.1083"></a><span id="l12.1083">             if (this.mSelectedDayCol) {</span>
<a href="#l12.1084"></a><span id="l12.1084">               this.mSelectedDay = this.mSelectedDayCol.date;</span>
<a href="#l12.1085"></a><span id="l12.1085">               this.mSelectedDayCol.column.selected = true;</span>
<a href="#l12.1086"></a><span id="l12.1086">               this.mSelectedDayCol.header.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l12.1087"></a><span id="l12.1087">             } else {</span>
<a href="#l12.1088"></a><span id="l12.1088">               this.mSelectedDay = val;</span>
<a href="#l12.1089"></a><span id="l12.1089">             }</span>
<a href="#l12.1090"></a><span id="l12.1090">           }</span>
<a href="#l12.1091"></a><span id="l12.1091" class="difflineminus">-          var headerColLabel = this.selectColumnHeader(val);</span>
<a href="#l12.1092"></a><span id="l12.1092" class="difflineplus">+          let headerColLabel = this.selectColumnHeader(val);</span>
<a href="#l12.1093"></a><span id="l12.1093">           this.fireEvent(&quot;dayselect&quot;, val);</span>
<a href="#l12.1094"></a><span id="l12.1094">           return val;</span>
<a href="#l12.1095"></a><span id="l12.1095">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1096"></a><span id="l12.1096">       &lt;/property&gt;</span>
<a href="#l12.1097"></a><span id="l12.1097"> </span>
<a href="#l12.1098"></a><span id="l12.1098">       &lt;method name=&quot;getSelectedItems&quot;&gt;</span>
<a href="#l12.1099"></a><span id="l12.1099">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l12.1100"></a><span id="l12.1100">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1101"></a><span id="l12.1101" class="difflineat">@@ -3039,35 +3039,35 @@</span>
<a href="#l12.1102"></a><span id="l12.1102">           } else { // undated todo</span>
<a href="#l12.1103"></a><span id="l12.1103">               return [];</span>
<a href="#l12.1104"></a><span id="l12.1104">           }</span>
<a href="#l12.1105"></a><span id="l12.1105">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1106"></a><span id="l12.1106">       &lt;/method&gt;</span>
<a href="#l12.1107"></a><span id="l12.1107"> </span>
<a href="#l12.1108"></a><span id="l12.1108">       &lt;method name=&quot;centerSelectedItems&quot;&gt;</span>
<a href="#l12.1109"></a><span id="l12.1109">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1110"></a><span id="l12.1110" class="difflineminus">-          var displayTZ = calendarDefaultTimezone();</span>
<a href="#l12.1111"></a><span id="l12.1111" class="difflineminus">-          var lowMinute = 24 * 60;</span>
<a href="#l12.1112"></a><span id="l12.1112" class="difflineminus">-          var highMinute = 0;</span>
<a href="#l12.1113"></a><span id="l12.1113" class="difflineminus">-</span>
<a href="#l12.1114"></a><span id="l12.1114" class="difflineminus">-          for (var item of this.mSelectedItems) {</span>
<a href="#l12.1115"></a><span id="l12.1115" class="difflineminus">-              var startDateProperty = calGetStartDateProp(item);</span>
<a href="#l12.1116"></a><span id="l12.1116" class="difflineminus">-              var endDateProperty = calGetEndDateProp(item);</span>
<a href="#l12.1117"></a><span id="l12.1117" class="difflineminus">-</span>
<a href="#l12.1118"></a><span id="l12.1118" class="difflineminus">-              var occs = [];</span>
<a href="#l12.1119"></a><span id="l12.1119" class="difflineplus">+          let displayTZ = calendarDefaultTimezone();</span>
<a href="#l12.1120"></a><span id="l12.1120" class="difflineplus">+          let lowMinute = 24 * 60;</span>
<a href="#l12.1121"></a><span id="l12.1121" class="difflineplus">+          let highMinute = 0;</span>
<a href="#l12.1122"></a><span id="l12.1122" class="difflineplus">+</span>
<a href="#l12.1123"></a><span id="l12.1123" class="difflineplus">+          for (let item of this.mSelectedItems) {</span>
<a href="#l12.1124"></a><span id="l12.1124" class="difflineplus">+              let startDateProperty = calGetStartDateProp(item);</span>
<a href="#l12.1125"></a><span id="l12.1125" class="difflineplus">+              let endDateProperty = calGetEndDateProp(item);</span>
<a href="#l12.1126"></a><span id="l12.1126" class="difflineplus">+</span>
<a href="#l12.1127"></a><span id="l12.1127" class="difflineplus">+              let occs = [];</span>
<a href="#l12.1128"></a><span id="l12.1128">               if (item.recurrenceInfo) {</span>
<a href="#l12.1129"></a><span id="l12.1129">                   // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l12.1130"></a><span id="l12.1130">                   occs = item.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l12.1131"></a><span id="l12.1131">               } else {</span>
<a href="#l12.1132"></a><span id="l12.1132">                   occs = [item];</span>
<a href="#l12.1133"></a><span id="l12.1133">               }</span>
<a href="#l12.1134"></a><span id="l12.1134"> </span>
<a href="#l12.1135"></a><span id="l12.1135" class="difflineminus">-              for (var occ of occs) {</span>
<a href="#l12.1136"></a><span id="l12.1136" class="difflineminus">-                  var occStart = occ[startDateProperty];</span>
<a href="#l12.1137"></a><span id="l12.1137" class="difflineminus">-                  var occEnd = occ[endDateProperty];</span>
<a href="#l12.1138"></a><span id="l12.1138" class="difflineplus">+              for (let occ of occs) {</span>
<a href="#l12.1139"></a><span id="l12.1139" class="difflineplus">+                  let occStart = occ[startDateProperty];</span>
<a href="#l12.1140"></a><span id="l12.1140" class="difflineplus">+                  let occEnd = occ[endDateProperty];</span>
<a href="#l12.1141"></a><span id="l12.1141">                   // must have at least one of start or end</span>
<a href="#l12.1142"></a><span id="l12.1142">                   if (!occStart &amp;&amp; !occEnd) {</span>
<a href="#l12.1143"></a><span id="l12.1143">                       continue; // task with no dates</span>
<a href="#l12.1144"></a><span id="l12.1144">                   }</span>
<a href="#l12.1145"></a><span id="l12.1145"> </span>
<a href="#l12.1146"></a><span id="l12.1146">                   // if just has single datetime, treat as zero duration item</span>
<a href="#l12.1147"></a><span id="l12.1147">                   // (such as task with due datetime or start datetime only)</span>
<a href="#l12.1148"></a><span id="l12.1148">                   occStart = (occStart || occEnd);</span>
<a href="#l12.1149"></a><span id="l12.1149" class="difflineat">@@ -3106,17 +3106,17 @@</span>
<a href="#l12.1150"></a><span id="l12.1150">                   // Ensure range shows occ</span>
<a href="#l12.1151"></a><span id="l12.1151">                   lowMinute = Math.min(occStart.hour * 60 + occStart.minute,</span>
<a href="#l12.1152"></a><span id="l12.1152">                                        lowMinute);</span>
<a href="#l12.1153"></a><span id="l12.1153">                   highMinute = Math.max(occEnd.hour * 60 + occEnd.minute,</span>
<a href="#l12.1154"></a><span id="l12.1154">                                         highMinute);</span>
<a href="#l12.1155"></a><span id="l12.1155">               }</span>
<a href="#l12.1156"></a><span id="l12.1156">           }</span>
<a href="#l12.1157"></a><span id="l12.1157"> </span>
<a href="#l12.1158"></a><span id="l12.1158" class="difflineminus">-          var displayDuration = highMinute - lowMinute;</span>
<a href="#l12.1159"></a><span id="l12.1159" class="difflineplus">+          let displayDuration = highMinute - lowMinute;</span>
<a href="#l12.1160"></a><span id="l12.1160">           if (this.mSelectedItems.length &amp;&amp;</span>
<a href="#l12.1161"></a><span id="l12.1161">               displayDuration &gt;= 0) {</span>
<a href="#l12.1162"></a><span id="l12.1162">               let minute;</span>
<a href="#l12.1163"></a><span id="l12.1163">               if (displayDuration &lt;= this.mVisibleMinutes) {</span>
<a href="#l12.1164"></a><span id="l12.1164">                   minute = lowMinute + (displayDuration - this.mVisibleMinutes) / 2;</span>
<a href="#l12.1165"></a><span id="l12.1165">               } else if (this.mSelectedItems.length == 1) {</span>
<a href="#l12.1166"></a><span id="l12.1166">                   // If the displayDuration doesn't fit into the visible</span>
<a href="#l12.1167"></a><span id="l12.1167">                   // minutes, but only one event is selected, then go ahead and</span>
<a href="#l12.1168"></a><span id="l12.1168" class="difflineat">@@ -3152,24 +3152,24 @@</span>
<a href="#l12.1169"></a><span id="l12.1169">       &lt;!-- private --&gt;</span>
<a href="#l12.1170"></a><span id="l12.1170"> </span>
<a href="#l12.1171"></a><span id="l12.1171">       &lt;property name=&quot;numVisibleDates&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l12.1172"></a><span id="l12.1172">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1173"></a><span id="l12.1173">           if (this.mDateList) {</span>
<a href="#l12.1174"></a><span id="l12.1174">             return this.mDateList.length;</span>
<a href="#l12.1175"></a><span id="l12.1175">           }</span>
<a href="#l12.1176"></a><span id="l12.1176"> </span>
<a href="#l12.1177"></a><span id="l12.1177" class="difflineminus">-          var count = 0;</span>
<a href="#l12.1178"></a><span id="l12.1178" class="difflineplus">+          let count = 0;</span>
<a href="#l12.1179"></a><span id="l12.1179"> </span>
<a href="#l12.1180"></a><span id="l12.1180">           if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l12.1181"></a><span id="l12.1181">             // The view has not been initialized, so there are 0 visible dates.</span>
<a href="#l12.1182"></a><span id="l12.1182">             return count;</span>
<a href="#l12.1183"></a><span id="l12.1183">           }</span>
<a href="#l12.1184"></a><span id="l12.1184"> </span>
<a href="#l12.1185"></a><span id="l12.1185" class="difflineminus">-          var d = this.mStartDate.clone();</span>
<a href="#l12.1186"></a><span id="l12.1186" class="difflineplus">+          let d = this.mStartDate.clone();</span>
<a href="#l12.1187"></a><span id="l12.1187">           while (d.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l12.1188"></a><span id="l12.1188">             count++;</span>
<a href="#l12.1189"></a><span id="l12.1189">             d.day += 1;</span>
<a href="#l12.1190"></a><span id="l12.1190">           }</span>
<a href="#l12.1191"></a><span id="l12.1191"> </span>
<a href="#l12.1192"></a><span id="l12.1192">           return count;</span>
<a href="#l12.1193"></a><span id="l12.1193">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1194"></a><span id="l12.1194">       &lt;/property&gt;</span>
<a href="#l12.1195"></a><span id="l12.1195" class="difflineat">@@ -3185,30 +3185,30 @@</span>
<a href="#l12.1196"></a><span id="l12.1196">           return document.getAnonymousElementByAttribute(timebar, &quot;anonid&quot;, &quot;timeIndicatorBoxTimeBar&quot;);</span>
<a href="#l12.1197"></a><span id="l12.1197">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1198"></a><span id="l12.1198">       &lt;/property&gt;</span>
<a href="#l12.1199"></a><span id="l12.1199"> </span>
<a href="#l12.1200"></a><span id="l12.1200">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l12.1201"></a><span id="l12.1201">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l12.1202"></a><span id="l12.1202">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l12.1203"></a><span id="l12.1203">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1204"></a><span id="l12.1204" class="difflineminus">-          var needsreorient = false;</span>
<a href="#l12.1205"></a><span id="l12.1205" class="difflineminus">-          var needsrelayout = false;</span>
<a href="#l12.1206"></a><span id="l12.1206" class="difflineplus">+          let needsreorient = false;</span>
<a href="#l12.1207"></a><span id="l12.1207" class="difflineplus">+          let needsrelayout = false;</span>
<a href="#l12.1208"></a><span id="l12.1208">           if (aAttr == &quot;orient&quot;) {</span>
<a href="#l12.1209"></a><span id="l12.1209">               if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l12.1210"></a><span id="l12.1210">                   needsreorient = true;</span>
<a href="#l12.1211"></a><span id="l12.1211">               }</span>
<a href="#l12.1212"></a><span id="l12.1212">           }</span>
<a href="#l12.1213"></a><span id="l12.1213"> </span>
<a href="#l12.1214"></a><span id="l12.1214">           if (aAttr == &quot;context&quot; || aAttr == &quot;item-context&quot;) {</span>
<a href="#l12.1215"></a><span id="l12.1215">               needsrelayout = true;</span>
<a href="#l12.1216"></a><span id="l12.1216">           }</span>
<a href="#l12.1217"></a><span id="l12.1217"> </span>
<a href="#l12.1218"></a><span id="l12.1218">           // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l12.1219"></a><span id="l12.1219" class="difflineminus">-          var ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.1220"></a><span id="l12.1220" class="difflineplus">+          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l12.1221"></a><span id="l12.1221"> </span>
<a href="#l12.1222"></a><span id="l12.1222">           if (needsrelayout &amp;&amp; !needsreorient) {</span>
<a href="#l12.1223"></a><span id="l12.1223">               this.relayout();</span>
<a href="#l12.1224"></a><span id="l12.1224">           }</span>
<a href="#l12.1225"></a><span id="l12.1225"> </span>
<a href="#l12.1226"></a><span id="l12.1226">           if (needsreorient) {</span>
<a href="#l12.1227"></a><span id="l12.1227">               this.reorient();</span>
<a href="#l12.1228"></a><span id="l12.1228">           }</span>
<a href="#l12.1229"></a><span id="l12.1229" class="difflineat">@@ -3292,22 +3292,22 @@</span>
<a href="#l12.1230"></a><span id="l12.1230">           }</span>
<a href="#l12.1231"></a><span id="l12.1231">           this.mDateList = computedDateList;</span>
<a href="#l12.1232"></a><span id="l12.1232"> </span>
<a href="#l12.1233"></a><span id="l12.1233">           // unselect previous selected event upon switch views, otherwise those</span>
<a href="#l12.1234"></a><span id="l12.1234">           // events will stay selected forever, if select other events after</span>
<a href="#l12.1235"></a><span id="l12.1235">           // change week view.</span>
<a href="#l12.1236"></a><span id="l12.1236">           this.setSelectedItems(0, [], true);</span>
<a href="#l12.1237"></a><span id="l12.1237"> </span>
<a href="#l12.1238"></a><span id="l12.1238" class="difflineminus">-          var daybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;daybox&quot;);</span>
<a href="#l12.1239"></a><span id="l12.1239" class="difflineminus">-          var headerdaybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l12.1240"></a><span id="l12.1240" class="difflineminus">-</span>
<a href="#l12.1241"></a><span id="l12.1241" class="difflineminus">-          var calView = this;</span>
<a href="#l12.1242"></a><span id="l12.1242" class="difflineminus">-          var dayStartMin = this.mDayStartMin;</span>
<a href="#l12.1243"></a><span id="l12.1243" class="difflineminus">-          var dayEndMin = this.mDayEndMin;</span>
<a href="#l12.1244"></a><span id="l12.1244" class="difflineplus">+          let daybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;daybox&quot;);</span>
<a href="#l12.1245"></a><span id="l12.1245" class="difflineplus">+          let headerdaybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l12.1246"></a><span id="l12.1246" class="difflineplus">+</span>
<a href="#l12.1247"></a><span id="l12.1247" class="difflineplus">+          let calView = this;</span>
<a href="#l12.1248"></a><span id="l12.1248" class="difflineplus">+          let dayStartMin = this.mDayStartMin;</span>
<a href="#l12.1249"></a><span id="l12.1249" class="difflineplus">+          let dayEndMin = this.mDayEndMin;</span>
<a href="#l12.1250"></a><span id="l12.1250">           function setUpDayEventsBox(aDayBox, date) {</span>
<a href="#l12.1251"></a><span id="l12.1251">               aDayBox.setAttribute(&quot;class&quot;, &quot;calendar-event-column-&quot; + (counter % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;));</span>
<a href="#l12.1252"></a><span id="l12.1252">               aDayBox.setAttribute(&quot;context&quot;, calView.getAttribute(&quot;context&quot;));</span>
<a href="#l12.1253"></a><span id="l12.1253">               aDayBox.setAttribute(&quot;item-context&quot;, calView.getAttribute(&quot;item-context&quot;) || calView.getAttribute(&quot;context&quot;));</span>
<a href="#l12.1254"></a><span id="l12.1254">               aDayBox.startLayoutBatchChange();</span>
<a href="#l12.1255"></a><span id="l12.1255">               aDayBox.date = date;</span>
<a href="#l12.1256"></a><span id="l12.1256">               aDayBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l12.1257"></a><span id="l12.1257">               aDayBox.calendarView = calView;</span>
<a href="#l12.1258"></a><span id="l12.1258" class="difflineat">@@ -3323,60 +3323,60 @@</span>
<a href="#l12.1259"></a><span id="l12.1259">               // &quot;rotated&quot; in order to have different css rules.</span>
<a href="#l12.1260"></a><span id="l12.1260">               setBooleanAttribute(aDayBox, &quot;rotated&quot;, orient == &quot;horizontal&quot;);</span>
<a href="#l12.1261"></a><span id="l12.1261">           }</span>
<a href="#l12.1262"></a><span id="l12.1262"> </span>
<a href="#l12.1263"></a><span id="l12.1263">           this.mDateColumns = [];</span>
<a href="#l12.1264"></a><span id="l12.1264"> </span>
<a href="#l12.1265"></a><span id="l12.1265"> </span>
<a href="#l12.1266"></a><span id="l12.1266">           // get today's date</span>
<a href="#l12.1267"></a><span id="l12.1267" class="difflineminus">-          var today = this.today();</span>
<a href="#l12.1268"></a><span id="l12.1268" class="difflineminus">-          var counter = 0;</span>
<a href="#l12.1269"></a><span id="l12.1269" class="difflineminus">-          var dayboxkids = daybox.childNodes;</span>
<a href="#l12.1270"></a><span id="l12.1270" class="difflineminus">-          var headerboxkids = headerdaybox.childNodes;</span>
<a href="#l12.1271"></a><span id="l12.1271" class="difflineplus">+          let today = this.today();</span>
<a href="#l12.1272"></a><span id="l12.1272" class="difflineplus">+          let counter = 0;</span>
<a href="#l12.1273"></a><span id="l12.1273" class="difflineplus">+          let dayboxkids = daybox.childNodes;</span>
<a href="#l12.1274"></a><span id="l12.1274" class="difflineplus">+          let headerboxkids = headerdaybox.childNodes;</span>
<a href="#l12.1275"></a><span id="l12.1275">           let labelboxkids = this.labeldaybox.childNodes;</span>
<a href="#l12.1276"></a><span id="l12.1276">           let updateTimeIndicator = false;</span>
<a href="#l12.1277"></a><span id="l12.1277"> </span>
<a href="#l12.1278"></a><span id="l12.1278" class="difflineminus">-          for (var d of computedDateList) {</span>
<a href="#l12.1279"></a><span id="l12.1279" class="difflineminus">-              var dayEventsBox;</span>
<a href="#l12.1280"></a><span id="l12.1280" class="difflineplus">+          for (let d of computedDateList) {</span>
<a href="#l12.1281"></a><span id="l12.1281" class="difflineplus">+              let dayEventsBox;</span>
<a href="#l12.1282"></a><span id="l12.1282">               if (counter &lt; dayboxkids.length) {</span>
<a href="#l12.1283"></a><span id="l12.1283">                   dayEventsBox = dayboxkids[counter];</span>
<a href="#l12.1284"></a><span id="l12.1284">                   dayEventsBox.removeAttribute(&quot;relation&quot;);</span>
<a href="#l12.1285"></a><span id="l12.1285">                   dayEventsBox.mEventInfos = [];</span>
<a href="#l12.1286"></a><span id="l12.1286">               } else {</span>
<a href="#l12.1287"></a><span id="l12.1287">                   dayEventsBox = createXULElement(&quot;calendar-event-column&quot;);</span>
<a href="#l12.1288"></a><span id="l12.1288">                   dayEventsBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l12.1289"></a><span id="l12.1289">                   daybox.appendChild(dayEventsBox);</span>
<a href="#l12.1290"></a><span id="l12.1290">               }</span>
<a href="#l12.1291"></a><span id="l12.1291">               setUpDayEventsBox(dayEventsBox, d);</span>
<a href="#l12.1292"></a><span id="l12.1292"> </span>
<a href="#l12.1293"></a><span id="l12.1293" class="difflineminus">-              var dayHeaderBox;</span>
<a href="#l12.1294"></a><span id="l12.1294" class="difflineplus">+              let dayHeaderBox;</span>
<a href="#l12.1295"></a><span id="l12.1295">               if (counter &lt; headerboxkids.length) {</span>
<a href="#l12.1296"></a><span id="l12.1296">                   dayHeaderBox = headerboxkids[counter];</span>
<a href="#l12.1297"></a><span id="l12.1297">                   // Delete backwards to make sure we get them all</span>
<a href="#l12.1298"></a><span id="l12.1298">                   // and delete until no more elements are left.</span>
<a href="#l12.1299"></a><span id="l12.1299">                   while (dayHeaderBox.mItemBoxes.length != 0) {</span>
<a href="#l12.1300"></a><span id="l12.1300" class="difflineminus">-                      var num = dayHeaderBox.mItemBoxes.length;</span>
<a href="#l12.1301"></a><span id="l12.1301" class="difflineplus">+                      let num = dayHeaderBox.mItemBoxes.length;</span>
<a href="#l12.1302"></a><span id="l12.1302">                       dayHeaderBox.deleteEvent(dayHeaderBox.mItemBoxes[num-1].occurrence);</span>
<a href="#l12.1303"></a><span id="l12.1303">                   }</span>
<a href="#l12.1304"></a><span id="l12.1304">               } else {</span>
<a href="#l12.1305"></a><span id="l12.1305">                   dayHeaderBox = createXULElement(&quot;calendar-header-container&quot;);</span>
<a href="#l12.1306"></a><span id="l12.1306">                   dayHeaderBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l12.1307"></a><span id="l12.1307">                   headerdaybox.appendChild(dayHeaderBox);</span>
<a href="#l12.1308"></a><span id="l12.1308">               }</span>
<a href="#l12.1309"></a><span id="l12.1309">               setUpDayHeaderBox(dayHeaderBox, d);</span>
<a href="#l12.1310"></a><span id="l12.1310"> </span>
<a href="#l12.1311"></a><span id="l12.1311">               if (this.mDaysOffArray.indexOf(d.weekday) &gt;= 0) {</span>
<a href="#l12.1312"></a><span id="l12.1312">                   dayEventsBox.dayOff = true;</span>
<a href="#l12.1313"></a><span id="l12.1313">                   dayHeaderBox.setAttribute(&quot;weekend&quot;, &quot;true&quot;);</span>
<a href="#l12.1314"></a><span id="l12.1314">               } else {</span>
<a href="#l12.1315"></a><span id="l12.1315">                   dayEventsBox.dayOff = false;</span>
<a href="#l12.1316"></a><span id="l12.1316">                   dayHeaderBox.removeAttribute(&quot;weekend&quot;);</span>
<a href="#l12.1317"></a><span id="l12.1317">               }</span>
<a href="#l12.1318"></a><span id="l12.1318" class="difflineminus">-              var labelbox;</span>
<a href="#l12.1319"></a><span id="l12.1319" class="difflineplus">+              let labelbox;</span>
<a href="#l12.1320"></a><span id="l12.1320">               if (counter &lt; labelboxkids.length) {</span>
<a href="#l12.1321"></a><span id="l12.1321">                   labelbox = labelboxkids[counter];</span>
<a href="#l12.1322"></a><span id="l12.1322">                   labelbox.date = d;</span>
<a href="#l12.1323"></a><span id="l12.1323">               } else {</span>
<a href="#l12.1324"></a><span id="l12.1324">                   labelbox = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l12.1325"></a><span id="l12.1325">                   labelbox.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l12.1326"></a><span id="l12.1326">                   this.labeldaybox.appendChild(labelbox);</span>
<a href="#l12.1327"></a><span id="l12.1327">                   labelbox.date = d;</span>
<a href="#l12.1328"></a><span id="l12.1328" class="difflineat">@@ -3413,17 +3413,17 @@</span>
<a href="#l12.1329"></a><span id="l12.1329">                   case 1:</span>
<a href="#l12.1330"></a><span id="l12.1330">                       dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l12.1331"></a><span id="l12.1331">                       dayEventsBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l12.1332"></a><span id="l12.1332">                       labelbox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l12.1333"></a><span id="l12.1333">                       break;</span>
<a href="#l12.1334"></a><span id="l12.1334">               }</span>
<a href="#l12.1335"></a><span id="l12.1335">               // We don't want to actually mess with our original dates, plus</span>
<a href="#l12.1336"></a><span id="l12.1336">               // they're likely to be immutable.</span>
<a href="#l12.1337"></a><span id="l12.1337" class="difflineminus">-              var d2 = d.clone();</span>
<a href="#l12.1338"></a><span id="l12.1338" class="difflineplus">+              let d2 = d.clone();</span>
<a href="#l12.1339"></a><span id="l12.1339">               d2.isDate = true;</span>
<a href="#l12.1340"></a><span id="l12.1340">               d2.makeImmutable();</span>
<a href="#l12.1341"></a><span id="l12.1341">               this.mDateColumns.push({ date: d2, column: dayEventsBox, header: dayHeaderBox });</span>
<a href="#l12.1342"></a><span id="l12.1342">               counter++;</span>
<a href="#l12.1343"></a><span id="l12.1343">           }</span>
<a href="#l12.1344"></a><span id="l12.1344"> </span>
<a href="#l12.1345"></a><span id="l12.1345">           // Remove any extra columns that may have been hanging around</span>
<a href="#l12.1346"></a><span id="l12.1346">           function removeExtraKids(elem) {</span>
<a href="#l12.1347"></a><span id="l12.1347" class="difflineat">@@ -3473,17 +3473,17 @@</span>
<a href="#l12.1348"></a><span id="l12.1348">       &lt;/method&gt;</span>
<a href="#l12.1349"></a><span id="l12.1349"> </span>
<a href="#l12.1350"></a><span id="l12.1350">       &lt;method name=&quot;findColumnForDate&quot;&gt;</span>
<a href="#l12.1351"></a><span id="l12.1351">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l12.1352"></a><span id="l12.1352">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1353"></a><span id="l12.1353">           if (!this.mDateColumns) {</span>
<a href="#l12.1354"></a><span id="l12.1354">               return null;</span>
<a href="#l12.1355"></a><span id="l12.1355">           }</span>
<a href="#l12.1356"></a><span id="l12.1356" class="difflineminus">-          for (var col of this.mDateColumns) {</span>
<a href="#l12.1357"></a><span id="l12.1357" class="difflineplus">+          for (let col of this.mDateColumns) {</span>
<a href="#l12.1358"></a><span id="l12.1358">               if (col.date.compare(aDate) == 0) {</span>
<a href="#l12.1359"></a><span id="l12.1359">                   return col;</span>
<a href="#l12.1360"></a><span id="l12.1360">               }</span>
<a href="#l12.1361"></a><span id="l12.1361">           }</span>
<a href="#l12.1362"></a><span id="l12.1362">           return null;</span>
<a href="#l12.1363"></a><span id="l12.1363">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1364"></a><span id="l12.1364">       &lt;/method&gt;</span>
<a href="#l12.1365"></a><span id="l12.1365"> </span>
<a href="#l12.1366"></a><span id="l12.1366" class="difflineat">@@ -3512,25 +3512,25 @@</span>
<a href="#l12.1367"></a><span id="l12.1367"> </span>
<a href="#l12.1368"></a><span id="l12.1368">       &lt;method name=&quot;findColumnsForOccurrences&quot;&gt;</span>
<a href="#l12.1369"></a><span id="l12.1369">         &lt;parameter name=&quot;aOccurrences&quot;/&gt;</span>
<a href="#l12.1370"></a><span id="l12.1370">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1371"></a><span id="l12.1371">           if (!this.mDateColumns || !this.mDateColumns.length) {</span>
<a href="#l12.1372"></a><span id="l12.1372">             return [];</span>
<a href="#l12.1373"></a><span id="l12.1373">           }</span>
<a href="#l12.1374"></a><span id="l12.1374"> </span>
<a href="#l12.1375"></a><span id="l12.1375" class="difflineminus">-          var occMap = {};</span>
<a href="#l12.1376"></a><span id="l12.1376" class="difflineminus">-          for (var occ of aOccurrences) {</span>
<a href="#l12.1377"></a><span id="l12.1377" class="difflineminus">-              var startDate = occ[calGetStartDateProp(occ)]</span>
<a href="#l12.1378"></a><span id="l12.1378" class="difflineplus">+          let occMap = {};</span>
<a href="#l12.1379"></a><span id="l12.1379" class="difflineplus">+          for (let occ of aOccurrences) {</span>
<a href="#l12.1380"></a><span id="l12.1380" class="difflineplus">+              let startDate = occ[calGetStartDateProp(occ)]</span>
<a href="#l12.1381"></a><span id="l12.1381">                               .getInTimezone(this.mStartDate.timezone);</span>
<a href="#l12.1382"></a><span id="l12.1382" class="difflineminus">-              var endDate = occ[calGetEndDateProp(occ)]</span>
<a href="#l12.1383"></a><span id="l12.1383" class="difflineplus">+              let endDate = occ[calGetEndDateProp(occ)]</span>
<a href="#l12.1384"></a><span id="l12.1384">                               .getInTimezone(this.mEndDate.timezone) || startDate;</span>
<a href="#l12.1385"></a><span id="l12.1385">               if (startDate.compare(this.mStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l12.1386"></a><span id="l12.1386">                   endDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l12.1387"></a><span id="l12.1387" class="difflineminus">-                  for (var i = startDate.day; i &lt;= endDate.day; i++) {</span>
<a href="#l12.1388"></a><span id="l12.1388" class="difflineplus">+                  for (let i = startDate.day; i &lt;= endDate.day; i++) {</span>
<a href="#l12.1389"></a><span id="l12.1389">                       occMap[i] = true;</span>
<a href="#l12.1390"></a><span id="l12.1390">                   }</span>
<a href="#l12.1391"></a><span id="l12.1391">               }</span>
<a href="#l12.1392"></a><span id="l12.1392">           }</span>
<a href="#l12.1393"></a><span id="l12.1393"> </span>
<a href="#l12.1394"></a><span id="l12.1394">           return this.mDateColumns.filter(function(col) {</span>
<a href="#l12.1395"></a><span id="l12.1395">               return (col.date.day in occMap);</span>
<a href="#l12.1396"></a><span id="l12.1396">           });</span>
<a href="#l12.1397"></a><span id="l12.1397" class="difflineat">@@ -3592,45 +3592,45 @@</span>
<a href="#l12.1398"></a><span id="l12.1398">         --&gt;</span>
<a href="#l12.1399"></a><span id="l12.1399">       &lt;method name=&quot;findColumnForClientPoint&quot;&gt;</span>
<a href="#l12.1400"></a><span id="l12.1400">         &lt;parameter name=&quot;aClientX&quot;/&gt;</span>
<a href="#l12.1401"></a><span id="l12.1401">         &lt;parameter name=&quot;aClientY&quot;/&gt;</span>
<a href="#l12.1402"></a><span id="l12.1402">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1403"></a><span id="l12.1403">           if (!this.mDateColumns) {</span>
<a href="#l12.1404"></a><span id="l12.1404">               return null;</span>
<a href="#l12.1405"></a><span id="l12.1405">           }</span>
<a href="#l12.1406"></a><span id="l12.1406" class="difflineminus">-          for (var col of this.mDateColumns) {</span>
<a href="#l12.1407"></a><span id="l12.1407" class="difflineplus">+          for (let col of this.mDateColumns) {</span>
<a href="#l12.1408"></a><span id="l12.1408">               let bo = document.getAnonymousElementByAttribute(col.column, &quot;anonid&quot;, &quot;boxstack&quot;).boxObject;</span>
<a href="#l12.1409"></a><span id="l12.1409">               if ((aClientX &gt;= bo.screenX) &amp;&amp; (aClientX &lt;= (bo.screenX + bo.width)) &amp;&amp;</span>
<a href="#l12.1410"></a><span id="l12.1410">                   (aClientY &gt;= bo.screenY) &amp;&amp; (aClientY &lt;= (bo.screenY + bo.height))) {</span>
<a href="#l12.1411"></a><span id="l12.1411">                   return col.column;</span>
<a href="#l12.1412"></a><span id="l12.1412">               }</span>
<a href="#l12.1413"></a><span id="l12.1413">           }</span>
<a href="#l12.1414"></a><span id="l12.1414">           return null;</span>
<a href="#l12.1415"></a><span id="l12.1415">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1416"></a><span id="l12.1416">       &lt;/method&gt;</span>
<a href="#l12.1417"></a><span id="l12.1417"> </span>
<a href="#l12.1418"></a><span id="l12.1418">       &lt;method name=&quot;adjustScrollbarSpacersForAlldayEvents&quot;&gt;</span>
<a href="#l12.1419"></a><span id="l12.1419">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.1420"></a><span id="l12.1420">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1421"></a><span id="l12.1421" class="difflineminus">-          var startDate = aEvent[calGetStartDateProp(aEvent)];</span>
<a href="#l12.1422"></a><span id="l12.1422" class="difflineminus">-          var endDate = aEvent[calGetEndDateProp(aEvent)];</span>
<a href="#l12.1423"></a><span id="l12.1423" class="difflineplus">+          let startDate = aEvent[calGetStartDateProp(aEvent)];</span>
<a href="#l12.1424"></a><span id="l12.1424" class="difflineplus">+          let endDate = aEvent[calGetEndDateProp(aEvent)];</span>
<a href="#l12.1425"></a><span id="l12.1425">           if (startDate &amp;&amp; startDate.isDate ||</span>
<a href="#l12.1426"></a><span id="l12.1426">               endDate &amp;&amp; endDate.isDate) {</span>
<a href="#l12.1427"></a><span id="l12.1427">               // If this is an all day event, then the header with allday</span>
<a href="#l12.1428"></a><span id="l12.1428">               // events could possibly get a scrollbar. Readjust them.</span>
<a href="#l12.1429"></a><span id="l12.1429">               this.adjustScrollBarSpacers();</span>
<a href="#l12.1430"></a><span id="l12.1430">           }</span>
<a href="#l12.1431"></a><span id="l12.1431">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1432"></a><span id="l12.1432">       &lt;/method&gt;</span>
<a href="#l12.1433"></a><span id="l12.1433"> </span>
<a href="#l12.1434"></a><span id="l12.1434">       &lt;method name=&quot;doAddItem&quot;&gt;</span>
<a href="#l12.1435"></a><span id="l12.1435">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.1436"></a><span id="l12.1436">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1437"></a><span id="l12.1437" class="difflineminus">-          var cols = this.findColumnsForItem(aEvent);</span>
<a href="#l12.1438"></a><span id="l12.1438" class="difflineplus">+          let cols = this.findColumnsForItem(aEvent);</span>
<a href="#l12.1439"></a><span id="l12.1439">           if (!cols.length) {</span>
<a href="#l12.1440"></a><span id="l12.1440">               return;</span>
<a href="#l12.1441"></a><span id="l12.1441">           }</span>
<a href="#l12.1442"></a><span id="l12.1442"> </span>
<a href="#l12.1443"></a><span id="l12.1443">           for (let col of cols) {</span>
<a href="#l12.1444"></a><span id="l12.1444">               let column = col.column;</span>
<a href="#l12.1445"></a><span id="l12.1445">               let header = col.header;</span>
<a href="#l12.1446"></a><span id="l12.1446"> </span>
<a href="#l12.1447"></a><span id="l12.1447" class="difflineat">@@ -3644,22 +3644,22 @@</span>
<a href="#l12.1448"></a><span id="l12.1448"> </span>
<a href="#l12.1449"></a><span id="l12.1449">           this.adjustScrollbarSpacersForAlldayEvents(aEvent);</span>
<a href="#l12.1450"></a><span id="l12.1450">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1451"></a><span id="l12.1451">       &lt;/method&gt;</span>
<a href="#l12.1452"></a><span id="l12.1452"> </span>
<a href="#l12.1453"></a><span id="l12.1453">       &lt;method name=&quot;doDeleteItem&quot;&gt;</span>
<a href="#l12.1454"></a><span id="l12.1454">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.1455"></a><span id="l12.1455">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1456"></a><span id="l12.1456" class="difflineminus">-          var cols = this.findColumnsForItem(aEvent);</span>
<a href="#l12.1457"></a><span id="l12.1457" class="difflineplus">+          let cols = this.findColumnsForItem(aEvent);</span>
<a href="#l12.1458"></a><span id="l12.1458">           if (!cols.length) {</span>
<a href="#l12.1459"></a><span id="l12.1459">               return;</span>
<a href="#l12.1460"></a><span id="l12.1460">           }</span>
<a href="#l12.1461"></a><span id="l12.1461"> </span>
<a href="#l12.1462"></a><span id="l12.1462" class="difflineminus">-          var oldLength = this.mSelectedItems.length;</span>
<a href="#l12.1463"></a><span id="l12.1463" class="difflineplus">+          let oldLength = this.mSelectedItems.length;</span>
<a href="#l12.1464"></a><span id="l12.1464">           this.mSelectedItems = this.mSelectedItems.filter((item) =&gt; {</span>
<a href="#l12.1465"></a><span id="l12.1465">               return item.hashId != aEvent.hashId;</span>
<a href="#l12.1466"></a><span id="l12.1466">           });</span>
<a href="#l12.1467"></a><span id="l12.1467"> </span>
<a href="#l12.1468"></a><span id="l12.1468">           for (let col of cols) {</span>
<a href="#l12.1469"></a><span id="l12.1469">               let column = col.column;</span>
<a href="#l12.1470"></a><span id="l12.1470">               let header = col.header;</span>
<a href="#l12.1471"></a><span id="l12.1471"> </span>
<a href="#l12.1472"></a><span id="l12.1472" class="difflineat">@@ -3699,51 +3699,51 @@</span>
<a href="#l12.1473"></a><span id="l12.1473">               }</span>
<a href="#l12.1474"></a><span id="l12.1474">           }</span>
<a href="#l12.1475"></a><span id="l12.1475">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1476"></a><span id="l12.1476">       &lt;/method&gt;</span>
<a href="#l12.1477"></a><span id="l12.1477"> </span>
<a href="#l12.1478"></a><span id="l12.1478">       &lt;method name=&quot;adjustScrollBarSpacers&quot;&gt;</span>
<a href="#l12.1479"></a><span id="l12.1479">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1480"></a><span id="l12.1480">           // get the view's orientation</span>
<a href="#l12.1481"></a><span id="l12.1481" class="difflineminus">-          var propertyName;</span>
<a href="#l12.1482"></a><span id="l12.1482" class="difflineplus">+          let propertyName;</span>
<a href="#l12.1483"></a><span id="l12.1483">           if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l12.1484"></a><span id="l12.1484">               propertyName = &quot;width&quot;;</span>
<a href="#l12.1485"></a><span id="l12.1485">           } else {</span>
<a href="#l12.1486"></a><span id="l12.1486">               propertyName = &quot;height&quot;;</span>
<a href="#l12.1487"></a><span id="l12.1487">           }</span>
<a href="#l12.1488"></a><span id="l12.1488"> </span>
<a href="#l12.1489"></a><span id="l12.1489">           // get the width/height of the scrollbox scrollbar</span>
<a href="#l12.1490"></a><span id="l12.1490" class="difflineminus">-          var scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1491"></a><span id="l12.1491" class="difflineplus">+          let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1492"></a><span id="l12.1492">                          this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l12.1493"></a><span id="l12.1493" class="difflineminus">-          var propertyValue = scrollbox.boxObject.firstChild</span>
<a href="#l12.1494"></a><span id="l12.1494" class="difflineplus">+          let propertyValue = scrollbox.boxObject.firstChild</span>
<a href="#l12.1495"></a><span id="l12.1495">                               .boxObject[propertyName];</span>
<a href="#l12.1496"></a><span id="l12.1496">           // Check if we need to show the headerScrollbarSpacer at all</span>
<a href="#l12.1497"></a><span id="l12.1497" class="difflineminus">-          var headerPropertyValue = propertyValue;</span>
<a href="#l12.1498"></a><span id="l12.1498" class="difflineminus">-          var headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1499"></a><span id="l12.1499" class="difflineplus">+          let headerPropertyValue = propertyValue;</span>
<a href="#l12.1500"></a><span id="l12.1500" class="difflineplus">+          let headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1501"></a><span id="l12.1501">                              this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l12.1502"></a><span id="l12.1502">           if (headerDayBox) {</span>
<a href="#l12.1503"></a><span id="l12.1503">             // Only do this when there are multiple days</span>
<a href="#l12.1504"></a><span id="l12.1504" class="difflineminus">-            var headerDayBoxMaxHeight = parseInt(document.defaultView.getComputedStyle(headerDayBox, null)</span>
<a href="#l12.1505"></a><span id="l12.1505" class="difflineplus">+            let headerDayBoxMaxHeight = parseInt(document.defaultView.getComputedStyle(headerDayBox, null)</span>
<a href="#l12.1506"></a><span id="l12.1506">                                                          .getPropertyValue(&quot;max-height&quot;), 10);</span>
<a href="#l12.1507"></a><span id="l12.1507">             if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot; &amp;&amp;</span>
<a href="#l12.1508"></a><span id="l12.1508">                 headerDayBox.boxObject.height &gt;= headerDayBoxMaxHeight) {</span>
<a href="#l12.1509"></a><span id="l12.1509">                 // If the headerDayBox is just as high as the max-height, then</span>
<a href="#l12.1510"></a><span id="l12.1510">                 // there is already a scrollbar and we don't need to show the</span>
<a href="#l12.1511"></a><span id="l12.1511">                 // headerScrollbarSpacer. This is only valid for the non-rotated</span>
<a href="#l12.1512"></a><span id="l12.1512">                 // view.</span>
<a href="#l12.1513"></a><span id="l12.1513">                 headerPropertyValue = 0;</span>
<a href="#l12.1514"></a><span id="l12.1514">             }</span>
<a href="#l12.1515"></a><span id="l12.1515">           }</span>
<a href="#l12.1516"></a><span id="l12.1516"> </span>
<a href="#l12.1517"></a><span id="l12.1517">           // set the same width/height for the label and header box spacers</span>
<a href="#l12.1518"></a><span id="l12.1518" class="difflineminus">-          var headerScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1519"></a><span id="l12.1519" class="difflineplus">+          let headerScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1520"></a><span id="l12.1520">                                       this, &quot;anonid&quot;, &quot;headerscrollbarspacer&quot;);</span>
<a href="#l12.1521"></a><span id="l12.1521">           headerScrollBarSpacer.setAttribute(propertyName, headerPropertyValue);</span>
<a href="#l12.1522"></a><span id="l12.1522" class="difflineminus">-          var labelScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1523"></a><span id="l12.1523" class="difflineplus">+          let labelScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l12.1524"></a><span id="l12.1524">                                      this, &quot;anonid&quot;, &quot;labelscrollbarspacer&quot;);</span>
<a href="#l12.1525"></a><span id="l12.1525">           labelScrollBarSpacer.setAttribute(propertyName, propertyValue);</span>
<a href="#l12.1526"></a><span id="l12.1526">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1527"></a><span id="l12.1527">       &lt;/method&gt;</span>
<a href="#l12.1528"></a><span id="l12.1528"> </span>
<a href="#l12.1529"></a><span id="l12.1529">       &lt;field name=&quot;mFirstVisibleMinute&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.1530"></a><span id="l12.1530">       &lt;method name=&quot;scrollToMinute&quot;&gt;</span>
<a href="#l12.1531"></a><span id="l12.1531">         &lt;parameter name=&quot;aMinute&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-statusbar.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-statusbar.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> /**</span>
<a href="#l13.9"></a><span id="l13.9">  * This code might change soon if we support Thunderbird's activity manager.</span>
<a href="#l13.10"></a><span id="l13.10">  * NOTE: The naming &quot;Meteors&quot; is historical.</span>
<a href="#l13.11"></a><span id="l13.11">  */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">- var gCalendarStatusFeedback = {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ let gCalendarStatusFeedback = {</span>
<a href="#l13.14"></a><span id="l13.14">      mCalendarStep: 0,</span>
<a href="#l13.15"></a><span id="l13.15">      mCalendarCount: 0,</span>
<a href="#l13.16"></a><span id="l13.16">      mWindow: null,</span>
<a href="#l13.17"></a><span id="l13.17">      mStatusText: null,</span>
<a href="#l13.18"></a><span id="l13.18">      mStatusBar: null,</span>
<a href="#l13.19"></a><span id="l13.19">      mStatusProgressPanel: null,</span>
<a href="#l13.20"></a><span id="l13.20">      mThrobber: null,</span>
<a href="#l13.21"></a><span id="l13.21">      mProgressMode: Components.interfaces.calIStatusObserver.NO_PROGRESS,</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -55,17 +55,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l13.23"></a><span id="l13.23">                  this.mCalendarStep = Math.trunc(100 / this.mCalendarCount);</span>
<a href="#l13.24"></a><span id="l13.24">              }</span>
<a href="#l13.25"></a><span id="l13.25">              this.mProgressMode = aProgressMode;</span>
<a href="#l13.26"></a><span id="l13.26">              this.mStatusProgressPanel.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l13.27"></a><span id="l13.27">              if (this.mProgressMode == Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l13.28"></a><span id="l13.28">                  this.mStatusBar.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l13.29"></a><span id="l13.29">                  this.mStatusBar.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l13.30"></a><span id="l13.30">                  this.mStatusBar.value = 0;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                 var commonStatus = calGetString(&quot;calendar&quot;, &quot;gettingCalendarInfoCommon&quot;);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+                 let commonStatus = calGetString(&quot;calendar&quot;, &quot;gettingCalendarInfoCommon&quot;);</span>
<a href="#l13.33"></a><span id="l13.33">                  this.showStatusString(commonStatus);</span>
<a href="#l13.34"></a><span id="l13.34">              }</span>
<a href="#l13.35"></a><span id="l13.35">              if (this.mThrobber) {</span>
<a href="#l13.36"></a><span id="l13.36">                  this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l13.37"></a><span id="l13.37">              }</span>
<a href="#l13.38"></a><span id="l13.38">          }</span>
<a href="#l13.39"></a><span id="l13.39">      },</span>
<a href="#l13.40"></a><span id="l13.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -54,24 +54,24 @@ var taskEdit = {</span>
<a href="#l14.4"></a><span id="l14.4">     },</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">     /**</span>
<a href="#l14.7"></a><span id="l14.7">      * Handler function to call when the quick-add textbox gains focus.</span>
<a href="#l14.8"></a><span id="l14.8">      *</span>
<a href="#l14.9"></a><span id="l14.9">      * @param aEvent    The DOM focus event</span>
<a href="#l14.10"></a><span id="l14.10">      */</span>
<a href="#l14.11"></a><span id="l14.11">     onFocus: function tE_onFocus(aEvent) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        var edit = aEvent.target;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        let edit = aEvent.target;</span>
<a href="#l14.14"></a><span id="l14.14">         if (edit.localName == &quot;input&quot;) {</span>
<a href="#l14.15"></a><span id="l14.15">             // For some reason, we only receive an onfocus event for the textbox</span>
<a href="#l14.16"></a><span id="l14.16">             // when debugging with venkman.</span>
<a href="#l14.17"></a><span id="l14.17">             edit = edit.parentNode.parentNode;</span>
<a href="#l14.18"></a><span id="l14.18">         }</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-        var calendar = getSelectedCalendar();</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+        let calendar = getSelectedCalendar();</span>
<a href="#l14.22"></a><span id="l14.22">         edit.showsInstructions = true;</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">         if (calendar.getProperty(&quot;capabilities.tasks.supported&quot;) === false) {</span>
<a href="#l14.25"></a><span id="l14.25">             taskEdit.setupTaskField(edit,</span>
<a href="#l14.26"></a><span id="l14.26">                                     true,</span>
<a href="#l14.27"></a><span id="l14.27">                                     calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsCapability&quot;));</span>
<a href="#l14.28"></a><span id="l14.28">         } else if (!isCalendarWritable(calendar)) {</span>
<a href="#l14.29"></a><span id="l14.29">             taskEdit.setupTaskField(edit,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineat">@@ -143,18 +143,18 @@ var taskEdit = {</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32">     /**</span>
<a href="#l14.33"></a><span id="l14.33">      * Window load function to set up all quick-add textboxes. The texbox must</span>
<a href="#l14.34"></a><span id="l14.34">      * have the class &quot;task-edit-field&quot;.</span>
<a href="#l14.35"></a><span id="l14.35">      */</span>
<a href="#l14.36"></a><span id="l14.36">     onLoad: function tE_onLoad(aEvent) {</span>
<a href="#l14.37"></a><span id="l14.37">         window.removeEventListener(&quot;load&quot;, taskEdit.onLoad, false);</span>
<a href="#l14.38"></a><span id="l14.38">         // TODO use getElementsByClassName</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-        var taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-        for (var i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+        let taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+        for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.43"></a><span id="l14.43">             taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l14.44"></a><span id="l14.44">         }</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46">         getCompositeCalendar().addObserver(taskEdit.compositeObserver);</span>
<a href="#l14.47"></a><span id="l14.47">         taskEdit.observedCalendar = getSelectedCalendar();</span>
<a href="#l14.48"></a><span id="l14.48">     },</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">     /**</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineat">@@ -190,18 +190,18 @@ var taskEdit = {</span>
<a href="#l14.52"></a><span id="l14.52">             if (aCalendar.id != getSelectedCalendar().id) {</span>
<a href="#l14.53"></a><span id="l14.53">                 // Optimization: if the given calendar isn't the default calendar,</span>
<a href="#l14.54"></a><span id="l14.54">                 // then we don't need to change any readonly/disabled states.</span>
<a href="#l14.55"></a><span id="l14.55">                 return;</span>
<a href="#l14.56"></a><span id="l14.56">             }</span>
<a href="#l14.57"></a><span id="l14.57">             switch (aName) {</span>
<a href="#l14.58"></a><span id="l14.58">                 case &quot;readOnly&quot;:</span>
<a href="#l14.59"></a><span id="l14.59">                 case &quot;disabled&quot;:</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-                    var taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-                    for (var i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+                    let taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+                    for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.64"></a><span id="l14.64">                         taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l14.65"></a><span id="l14.65">                     }</span>
<a href="#l14.66"></a><span id="l14.66">             }</span>
<a href="#l14.67"></a><span id="l14.67">         },</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69">         onPropertyDeleting: function tE_calObs_onPropertyDeleting(aCalendar,</span>
<a href="#l14.70"></a><span id="l14.70">                                                            aName) {</span>
<a href="#l14.71"></a><span id="l14.71">             // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineat">@@ -234,18 +234,18 @@ var taskEdit = {</span>
<a href="#l14.73"></a><span id="l14.73">         onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l14.74"></a><span id="l14.74">         onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {},</span>
<a href="#l14.75"></a><span id="l14.75">         onPropertyDeleting: function(aCalendar, aName) {},</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77">         // calICompositeObserver:</span>
<a href="#l14.78"></a><span id="l14.78">         onCalendarAdded: function onCalendarAdded(aCalendar) {},</span>
<a href="#l14.79"></a><span id="l14.79">         onCalendarRemoved: function onCalendarRemoved(aCalendar) {},</span>
<a href="#l14.80"></a><span id="l14.80">         onDefaultCalendarChanged: function tE_compObs_onDefaultCalendarChanged(aNewDefault) {</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-            var taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-            for (var i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+            let taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+            for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l14.85"></a><span id="l14.85">                 taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l14.86"></a><span id="l14.86">             }</span>
<a href="#l14.87"></a><span id="l14.87">             taskEdit.observedCalendar = aNewDefault;</span>
<a href="#l14.88"></a><span id="l14.88">         }</span>
<a href="#l14.89"></a><span id="l14.89">     }</span>
<a href="#l14.90"></a><span id="l14.90"> };</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92"> window.addEventListener(&quot;load&quot;, taskEdit.onLoad, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -7,25 +7,25 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * children.</span>
<a href="#l15.5"></a><span id="l15.5">  *</span>
<a href="#l15.6"></a><span id="l15.6">  * XXX Either replace the existing items using replaceNode, or use helper</span>
<a href="#l15.7"></a><span id="l15.7">  * functions (cal.removeChildren).</span>
<a href="#l15.8"></a><span id="l15.8">  *</span>
<a href="#l15.9"></a><span id="l15.9">  * @param aEvent    The popupshowing event of the opening menu</span>
<a href="#l15.10"></a><span id="l15.10">  */</span>
<a href="#l15.11"></a><span id="l15.11"> function addCalendarNames(aEvent) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    var calendarMenuPopup = aEvent.target;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+    let calendarMenuPopup = aEvent.target;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+    let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l15.16"></a><span id="l15.16">     while (calendarMenuPopup.hasChildNodes()) {</span>
<a href="#l15.17"></a><span id="l15.17">         calendarMenuPopup.lastChild.remove();</span>
<a href="#l15.18"></a><span id="l15.18">     }</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-    var tasksSelected = (tasks.length &gt; 0);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+    let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+    let tasksSelected = (tasks.length &gt; 0);</span>
<a href="#l15.23"></a><span id="l15.23">     if (tasksSelected) {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-        var selIndex = appendCalendarItems(tasks[0], calendarMenuPopup, null, &quot;contextChangeTaskCalendar(event);&quot;);</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+        let selIndex = appendCalendarItems(tasks[0], calendarMenuPopup, null, &quot;contextChangeTaskCalendar(event);&quot;);</span>
<a href="#l15.26"></a><span id="l15.26">         if (isPropertyValueSame(tasks, &quot;calendar&quot;) &amp;&amp; (selIndex &gt; -1)) {</span>
<a href="#l15.27"></a><span id="l15.27">             calendarMenuPopup.childNodes[selIndex].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.28"></a><span id="l15.28">         }</span>
<a href="#l15.29"></a><span id="l15.29">     }</span>
<a href="#l15.30"></a><span id="l15.30"> }</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32"> /**</span>
<a href="#l15.33"></a><span id="l15.33">  * Change the opening context menu for the selected tasks.</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineat">@@ -151,20 +151,20 @@ function contextChangeTaskProgress(aEven</span>
<a href="#l15.35"></a><span id="l15.35"> /**</span>
<a href="#l15.36"></a><span id="l15.36">  * Handler function to change the calendar of the selected tasks. The targeted</span>
<a href="#l15.37"></a><span id="l15.37">  * menuitem must have &quot;calendar&quot; property that implements calICalendar.</span>
<a href="#l15.38"></a><span id="l15.38">  *</span>
<a href="#l15.39"></a><span id="l15.39">  * @param aEvent      The DOM event that triggered this command.</span>
<a href="#l15.40"></a><span id="l15.40">  */</span>
<a href="#l15.41"></a><span id="l15.41"> function contextChangeTaskCalendar(aEvent) {</span>
<a href="#l15.42"></a><span id="l15.42">    startBatchTransaction();</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-   var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-   for (var t = 0; t &lt; tasks.length; t++) {</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-       var task = tasks[t];</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-       var newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+   let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+   for (let t = 0; t &lt; tasks.length; t++) {</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+       let task = tasks[t];</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+       let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l15.51"></a><span id="l15.51">        newTask.calendar = aEvent.target.calendar;</span>
<a href="#l15.52"></a><span id="l15.52">        doTransaction('modify', newTask, newTask.calendar, task, null);</span>
<a href="#l15.53"></a><span id="l15.53">     }</span>
<a href="#l15.54"></a><span id="l15.54">     endBatchTransaction();</span>
<a href="#l15.55"></a><span id="l15.55"> }</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57"> /**</span>
<a href="#l15.58"></a><span id="l15.58">  * Handler function to change the priority of the selected tasks, or of</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineat">@@ -174,17 +174,17 @@ function contextChangeTaskCalendar(aEven</span>
<a href="#l15.60"></a><span id="l15.60">  * @param {short} aPriority         The priority to set on the task(s)</span>
<a href="#l15.61"></a><span id="l15.61">  */</span>
<a href="#l15.62"></a><span id="l15.62"> function contextChangeTaskPriority(aEvent, aPriority) {</span>
<a href="#l15.63"></a><span id="l15.63">     let tabType = gTabmail &amp;&amp; gTabmail.currentTabInfo.mode.type;</span>
<a href="#l15.64"></a><span id="l15.64">     if (tabType == &quot;calendarTask&quot; || tabType == &quot;calendarEvent&quot;) {</span>
<a href="#l15.65"></a><span id="l15.65">         editConfigState({ priority: aPriority });</span>
<a href="#l15.66"></a><span id="l15.66">     } else {</span>
<a href="#l15.67"></a><span id="l15.67">         startBatchTransaction();</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-        var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+        let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.70"></a><span id="l15.70">         for (let task of tasks) {</span>
<a href="#l15.71"></a><span id="l15.71">             let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l15.72"></a><span id="l15.72">             newTask.priority = aPriority;</span>
<a href="#l15.73"></a><span id="l15.73">             doTransaction('modify', newTask, newTask.calendar, task, null);</span>
<a href="#l15.74"></a><span id="l15.74">         }</span>
<a href="#l15.75"></a><span id="l15.75">         endBatchTransaction();</span>
<a href="#l15.76"></a><span id="l15.76">     }</span>
<a href="#l15.77"></a><span id="l15.77"> }</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineat">@@ -226,80 +226,80 @@ function contextPostponeTask(aEvent, aDu</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80"> /**</span>
<a href="#l15.81"></a><span id="l15.81">  * Modifies the selected tasks with the event dialog</span>
<a href="#l15.82"></a><span id="l15.82">  *</span>
<a href="#l15.83"></a><span id="l15.83">  * @param aEvent        The DOM event that triggered this command.</span>
<a href="#l15.84"></a><span id="l15.84">  * @param initialDate   (optional) The initial date for new task datepickers</span>
<a href="#l15.85"></a><span id="l15.85">  */</span>
<a href="#l15.86"></a><span id="l15.86"> function modifyTaskFromContext(aEvent, initialDate) {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-    var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-    for (var t = 0; t &lt; tasks.length; t++) {</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+    let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+    for (let t = 0; t &lt; tasks.length; t++) {</span>
<a href="#l15.91"></a><span id="l15.91">         modifyEventWithDialog(tasks[t], null, true, initialDate);</span>
<a href="#l15.92"></a><span id="l15.92">     }</span>
<a href="#l15.93"></a><span id="l15.93">  }</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95"> /**</span>
<a href="#l15.96"></a><span id="l15.96">  *  Delete the current selected item with focus from the task tree</span>
<a href="#l15.97"></a><span id="l15.97">  *</span>
<a href="#l15.98"></a><span id="l15.98">  * @param aEvent          The DOM event that triggered this command.</span>
<a href="#l15.99"></a><span id="l15.99">  * @param aDoNotConfirm   If true, the user will not be asked to delete.</span>
<a href="#l15.100"></a><span id="l15.100">  */</span>
<a href="#l15.101"></a><span id="l15.101"> function deleteToDoCommand(aEvent, aDoNotConfirm) {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-    var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+    let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.104"></a><span id="l15.104">     calendarViewController.deleteOccurrences(tasks.length,</span>
<a href="#l15.105"></a><span id="l15.105">                                              tasks,</span>
<a href="#l15.106"></a><span id="l15.106">                                              false,</span>
<a href="#l15.107"></a><span id="l15.107">                                              aDoNotConfirm);</span>
<a href="#l15.108"></a><span id="l15.108"> }</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110"> /**</span>
<a href="#l15.111"></a><span id="l15.111">  * Gets the currently visible task tree</span>
<a href="#l15.112"></a><span id="l15.112">  *</span>
<a href="#l15.113"></a><span id="l15.113">  * @return    The XUL task tree element.</span>
<a href="#l15.114"></a><span id="l15.114">  */</span>
<a href="#l15.115"></a><span id="l15.115"> function getTaskTree() {</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-    var currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+    let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l15.118"></a><span id="l15.118">     if (currentMode == &quot;task&quot;) {</span>
<a href="#l15.119"></a><span id="l15.119">         return document.getElementById(&quot;calendar-task-tree&quot;);</span>
<a href="#l15.120"></a><span id="l15.120">     } else {</span>
<a href="#l15.121"></a><span id="l15.121">         return document.getElementById(&quot;unifinder-todo-tree&quot;);</span>
<a href="#l15.122"></a><span id="l15.122">     }</span>
<a href="#l15.123"></a><span id="l15.123"> }</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125"> /**</span>
<a href="#l15.126"></a><span id="l15.126">  * Gets the tasks selected in the currently visible task tree.</span>
<a href="#l15.127"></a><span id="l15.127">  *</span>
<a href="#l15.128"></a><span id="l15.128">  * XXX Parameter aEvent is unused, needs to be removed here and in calling</span>
<a href="#l15.129"></a><span id="l15.129">  * functions.</span>
<a href="#l15.130"></a><span id="l15.130">  *</span>
<a href="#l15.131"></a><span id="l15.131">  * @param aEvent      Unused</span>
<a href="#l15.132"></a><span id="l15.132">  */</span>
<a href="#l15.133"></a><span id="l15.133"> function getSelectedTasks(aEvent) {</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-    var taskTree = getTaskTree();</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+    let taskTree = getTaskTree();</span>
<a href="#l15.136"></a><span id="l15.136">     if (taskTree != null) {</span>
<a href="#l15.137"></a><span id="l15.137">         return taskTree.selectedTasks;</span>
<a href="#l15.138"></a><span id="l15.138">     } else {</span>
<a href="#l15.139"></a><span id="l15.139">         return [];</span>
<a href="#l15.140"></a><span id="l15.140">     }</span>
<a href="#l15.141"></a><span id="l15.141"> }</span>
<a href="#l15.142"></a><span id="l15.142"> </span>
<a href="#l15.143"></a><span id="l15.143"> /**</span>
<a href="#l15.144"></a><span id="l15.144">  * Convert selected tasks to emails.</span>
<a href="#l15.145"></a><span id="l15.145">  */</span>
<a href="#l15.146"></a><span id="l15.146"> function tasksToMail(aEvent) {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-    var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+    let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.149"></a><span id="l15.149">     calendarMailButtonDNDObserver.onDropItems(tasks);</span>
<a href="#l15.150"></a><span id="l15.150"> }</span>
<a href="#l15.151"></a><span id="l15.151"> </span>
<a href="#l15.152"></a><span id="l15.152"> /**</span>
<a href="#l15.153"></a><span id="l15.153">  * Convert selected tasks to events.</span>
<a href="#l15.154"></a><span id="l15.154">  */</span>
<a href="#l15.155"></a><span id="l15.155"> function tasksToEvents(aEvent) {</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-    var tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+    let tasks = getSelectedTasks(aEvent);</span>
<a href="#l15.158"></a><span id="l15.158">     calendarCalendarButtonDNDObserver.onDropItems(tasks);</span>
<a href="#l15.159"></a><span id="l15.159"> }</span>
<a href="#l15.160"></a><span id="l15.160"> </span>
<a href="#l15.161"></a><span id="l15.161"> /**</span>
<a href="#l15.162"></a><span id="l15.162">  * Toggle the completed state on selected tasks.</span>
<a href="#l15.163"></a><span id="l15.163">  *</span>
<a href="#l15.164"></a><span id="l15.164">  * @param aEvent    The originating event, can be null.</span>
<a href="#l15.165"></a><span id="l15.165">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -223,17 +223,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">       &lt;field name=&quot;mFilter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.5"></a><span id="l16.5">       &lt;field name=&quot;mStartDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.6"></a><span id="l16.6">       &lt;field name=&quot;mEndDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.7"></a><span id="l16.7">       &lt;field name=&quot;mDateRangeFilter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.8"></a><span id="l16.8">       &lt;field name=&quot;mTextFilterField&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">       &lt;property name=&quot;currentIndex&quot;&gt;</span>
<a href="#l16.11"></a><span id="l16.11">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-          var tree = document.getAnonymousElementByAttribute(</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+          let tree = document.getAnonymousElementByAttribute(</span>
<a href="#l16.14"></a><span id="l16.14">               this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l16.15"></a><span id="l16.15">           return tree.currentIndex;</span>
<a href="#l16.16"></a><span id="l16.16">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.17"></a><span id="l16.17">       &lt;/property&gt;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">       &lt;property name=&quot;currentTask&quot;&gt;</span>
<a href="#l16.20"></a><span id="l16.20">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.21"></a><span id="l16.21">           let tree = document.getAnonymousElementByAttribute(</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -244,28 +244,28 @@</span>
<a href="#l16.23"></a><span id="l16.23">               index = (tree.view.selection.isSelected(index) ? index : -1);</span>
<a href="#l16.24"></a><span id="l16.24">           }</span>
<a href="#l16.25"></a><span id="l16.25">           return (index &lt; 0) ? null : this.mTaskArray[index];</span>
<a href="#l16.26"></a><span id="l16.26">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.27"></a><span id="l16.27">       &lt;/property&gt;</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">       &lt;property name=&quot;selectedTasks&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l16.30"></a><span id="l16.30">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-          var tasks = [];</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-          var start = {};</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-          var end = {};</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+          let tasks = [];</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+          let start = {};</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+          let end = {};</span>
<a href="#l16.37"></a><span id="l16.37">           if (!this.mTreeView.selection) {</span>
<a href="#l16.38"></a><span id="l16.38">               return tasks;</span>
<a href="#l16.39"></a><span id="l16.39">           }</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-          var rangeCount = this.mTreeView.selection.getRangeCount();</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-          for (var range = 0; range &lt; rangeCount; range++) {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+          let rangeCount = this.mTreeView.selection.getRangeCount();</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+          for (let range = 0; range &lt; rangeCount; range++) {</span>
<a href="#l16.45"></a><span id="l16.45">               this.mTreeView.selection.getRangeAt(range, start, end);</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-              for (var i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-                  var task = this.getTaskAtRow(i);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+              for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+                  let task = this.getTaskAtRow(i);</span>
<a href="#l16.50"></a><span id="l16.50">                   if (task) {</span>
<a href="#l16.51"></a><span id="l16.51">                       tasks.push(this.getTaskAtRow(i));</span>
<a href="#l16.52"></a><span id="l16.52">                   }</span>
<a href="#l16.53"></a><span id="l16.53">               }</span>
<a href="#l16.54"></a><span id="l16.54">           }</span>
<a href="#l16.55"></a><span id="l16.55">           return tasks;</span>
<a href="#l16.56"></a><span id="l16.56">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.57"></a><span id="l16.57">       &lt;/property&gt;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineat">@@ -353,20 +353,20 @@</span>
<a href="#l16.59"></a><span id="l16.59">           mSelectedColumn: null,</span>
<a href="#l16.60"></a><span id="l16.60">           sortDirection: null,</span>
<a href="#l16.61"></a><span id="l16.61"> </span>
<a href="#l16.62"></a><span id="l16.62">           get selectedColumn() {</span>
<a href="#l16.63"></a><span id="l16.63">               return this.mSelectedColumn;</span>
<a href="#l16.64"></a><span id="l16.64">           },</span>
<a href="#l16.65"></a><span id="l16.65"> </span>
<a href="#l16.66"></a><span id="l16.66">           set selectedColumn(aCol) {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-              var tree = document.getAnonymousNodes(this.binding)[0];</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-              var treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-              for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-                  var col = treecols[i];</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+              let tree = document.getAnonymousNodes(this.binding)[0];</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+              let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+              for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+                  let col = treecols[i];</span>
<a href="#l16.75"></a><span id="l16.75">                   if (col.getAttribute(&quot;sortActive&quot;)) {</span>
<a href="#l16.76"></a><span id="l16.76">                       col.removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l16.77"></a><span id="l16.77">                       col.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l16.78"></a><span id="l16.78">                   }</span>
<a href="#l16.79"></a><span id="l16.79">                   if (aCol.getAttribute(&quot;itemproperty&quot;) == col.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l16.80"></a><span id="l16.80">                       col.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l16.81"></a><span id="l16.81">                       col.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l16.82"></a><span id="l16.82">                   }</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineat">@@ -464,27 +464,27 @@</span>
<a href="#l16.84"></a><span id="l16.84">                   this.tree.view.selection.select(selIndex);</span>
<a href="#l16.85"></a><span id="l16.85">                   this.treebox.ensureRowIsVisible(selIndex);</span>
<a href="#l16.86"></a><span id="l16.86">               }</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88">               this.treebox.endUpdateBatch();</span>
<a href="#l16.89"></a><span id="l16.89">           },</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91">           clear: function tTV_clear() {</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-              var count = this.binding.mTaskArray.length;</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+              let count = this.binding.mTaskArray.length;</span>
<a href="#l16.94"></a><span id="l16.94">               if (count &gt; 0) {</span>
<a href="#l16.95"></a><span id="l16.95">                   this.binding.mTaskArray = [];</span>
<a href="#l16.96"></a><span id="l16.96">                   this.binding.mHash2Index = {};</span>
<a href="#l16.97"></a><span id="l16.97">                   this.treebox.rowCountChanged(0, -count);</span>
<a href="#l16.98"></a><span id="l16.98">                   this.tree.view.selection.clearSelection();</span>
<a href="#l16.99"></a><span id="l16.99">               }</span>
<a href="#l16.100"></a><span id="l16.100">           },</span>
<a href="#l16.101"></a><span id="l16.101"> </span>
<a href="#l16.102"></a><span id="l16.102">           updateItem: function tTV_updateItem(aItem) {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-              var index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+              let index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l16.105"></a><span id="l16.105">               if (index) {</span>
<a href="#l16.106"></a><span id="l16.106">                   this.treebox.invalidateRow(index);</span>
<a href="#l16.107"></a><span id="l16.107">               }</span>
<a href="#l16.108"></a><span id="l16.108">           },</span>
<a href="#l16.109"></a><span id="l16.109"> </span>
<a href="#l16.110"></a><span id="l16.110">           /**</span>
<a href="#l16.111"></a><span id="l16.111">            * nsITreeView methods and properties</span>
<a href="#l16.112"></a><span id="l16.112">            */</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineat">@@ -538,27 +538,27 @@</span>
<a href="#l16.114"></a><span id="l16.114">                                                  .map(formatStringForCSSRule));</span>
<a href="#l16.115"></a><span id="l16.115"> </span>
<a href="#l16.116"></a><span id="l16.116">               return properties.join(&quot; &quot;);</span>
<a href="#l16.117"></a><span id="l16.117">           },</span>
<a href="#l16.118"></a><span id="l16.118"> </span>
<a href="#l16.119"></a><span id="l16.119">           // Called on the view when a cell in a non-selectable cycling</span>
<a href="#l16.120"></a><span id="l16.120">           // column (e.g., unread/flag/etc.) is clicked.</span>
<a href="#l16.121"></a><span id="l16.121">           cycleCell: function mTV_cycleCell(aRow, aCol) {</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-              var task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+              let task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125">               // prevent toggling completed status for parent items of</span>
<a href="#l16.126"></a><span id="l16.126">               // repeating tasks or when the calendar is read-only.</span>
<a href="#l16.127"></a><span id="l16.127">               if (!task || task.recurrenceInfo || task.calendar.readOnly) {</span>
<a href="#l16.128"></a><span id="l16.128">                   return;</span>
<a href="#l16.129"></a><span id="l16.129">               }</span>
<a href="#l16.130"></a><span id="l16.130">               if (aCol != null) {</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-                  var content = aCol.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+                  let content = aCol.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l16.133"></a><span id="l16.133">                   if (content == &quot;completed&quot;) {</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-                      var newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+                      let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l16.136"></a><span id="l16.136">                       newTask.isCompleted = !task.completedDate;</span>
<a href="#l16.137"></a><span id="l16.137">                       doTransaction('modify', newTask, newTask.calendar, task, null);</span>
<a href="#l16.138"></a><span id="l16.138">                   }</span>
<a href="#l16.139"></a><span id="l16.139">               }</span>
<a href="#l16.140"></a><span id="l16.140">           },</span>
<a href="#l16.141"></a><span id="l16.141"> </span>
<a href="#l16.142"></a><span id="l16.142">           // Called on the view when a header is clicked.</span>
<a href="#l16.143"></a><span id="l16.143">           cycleHeader: function mTV_cycleHeader(aCol) {</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineat">@@ -579,17 +579,17 @@</span>
<a href="#l16.145"></a><span id="l16.145">                       this.tree.view.selection.toggleSelect(index);</span>
<a href="#l16.146"></a><span id="l16.146">                   }</span>
<a href="#l16.147"></a><span id="l16.147">               }</span>
<a href="#l16.148"></a><span id="l16.148">           },</span>
<a href="#l16.149"></a><span id="l16.149"> </span>
<a href="#l16.150"></a><span id="l16.150">           // The text for a given cell. If a column consists only of an</span>
<a href="#l16.151"></a><span id="l16.151">           // image, then the empty string is returned.</span>
<a href="#l16.152"></a><span id="l16.152">           getCellText: function mTV_getCellText(aRow, aCol) {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-              var task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+              let task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.155"></a><span id="l16.155">               if (!task) {</span>
<a href="#l16.156"></a><span id="l16.156">                   return false;</span>
<a href="#l16.157"></a><span id="l16.157">               }</span>
<a href="#l16.158"></a><span id="l16.158"> </span>
<a href="#l16.159"></a><span id="l16.159">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l16.160"></a><span id="l16.160">                   case &quot;title&quot;:</span>
<a href="#l16.161"></a><span id="l16.161">                       // return title, or &quot;Untitled&quot; if empty/null</span>
<a href="#l16.162"></a><span id="l16.162">                       return (task.title ? task.title.replace(/\n/g, ' ') : calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineat">@@ -615,17 +615,17 @@</span>
<a href="#l16.164"></a><span id="l16.164">                   case &quot;priority&quot;:</span>
<a href="#l16.165"></a><span id="l16.165">                   default:</span>
<a href="#l16.166"></a><span id="l16.166">                       return &quot;&quot;;</span>
<a href="#l16.167"></a><span id="l16.167">               }</span>
<a href="#l16.168"></a><span id="l16.168">           },</span>
<a href="#l16.169"></a><span id="l16.169"> </span>
<a href="#l16.170"></a><span id="l16.170">           // This method is only called for columns of type other than text.</span>
<a href="#l16.171"></a><span id="l16.171">           getCellValue: function mTV_getCellValue(aRow, aCol) {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-              var task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+              let task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.174"></a><span id="l16.174">               if (!task) {</span>
<a href="#l16.175"></a><span id="l16.175">                   return null;</span>
<a href="#l16.176"></a><span id="l16.176">               }</span>
<a href="#l16.177"></a><span id="l16.177">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l16.178"></a><span id="l16.178">                   case &quot;percentComplete&quot;:</span>
<a href="#l16.179"></a><span id="l16.179">                       return task.percentComplete;</span>
<a href="#l16.180"></a><span id="l16.180">               }</span>
<a href="#l16.181"></a><span id="l16.181">               return null;</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineat">@@ -705,17 +705,17 @@</span>
<a href="#l16.183"></a><span id="l16.183">               return null;</span>
<a href="#l16.184"></a><span id="l16.184">           },</span>
<a href="#l16.185"></a><span id="l16.185"> </span>
<a href="#l16.186"></a><span id="l16.186">           // The progress mode for a given cell. This method is only called for</span>
<a href="#l16.187"></a><span id="l16.187">           // columns of type |progressmeter|.</span>
<a href="#l16.188"></a><span id="l16.188">           getProgressMode: function mTV_getProgressMode(aRow, aCol) {</span>
<a href="#l16.189"></a><span id="l16.189">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l16.190"></a><span id="l16.190">                   case &quot;percentComplete&quot;:</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-                      var task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+                      let task = this.binding.mTaskArray[aRow];</span>
<a href="#l16.193"></a><span id="l16.193">                       if (aCol.element.boxObject.width &gt; 75 &amp;&amp;</span>
<a href="#l16.194"></a><span id="l16.194">                           task.percentComplete &gt; 0) {</span>
<a href="#l16.195"></a><span id="l16.195">                           // XXX Would be nice if we could use relative widths,</span>
<a href="#l16.196"></a><span id="l16.196">                           // i.e &quot;15ex&quot;, but there is no scriptable interface.</span>
<a href="#l16.197"></a><span id="l16.197">                           return Components.interfaces.nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l16.198"></a><span id="l16.198">                       }</span>
<a href="#l16.199"></a><span id="l16.199">                       break;</span>
<a href="#l16.200"></a><span id="l16.200">               }</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineat">@@ -726,20 +726,20 @@</span>
<a href="#l16.202"></a><span id="l16.202">           /**</span>
<a href="#l16.203"></a><span id="l16.203">            * Task Tree Events</span>
<a href="#l16.204"></a><span id="l16.204">            */</span>
<a href="#l16.205"></a><span id="l16.205">           onSelect: function tTV_onSelect(event) {},</span>
<a href="#l16.206"></a><span id="l16.206"> </span>
<a href="#l16.207"></a><span id="l16.207">           onDoubleClick: function tTV_onDoubleClick(event) {</span>
<a href="#l16.208"></a><span id="l16.208">               if (event.button == 0) {</span>
<a href="#l16.209"></a><span id="l16.209">                   let initialDate = getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-                  var col = {};</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-                  var item = this._getItemFromEvent(event, col);</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+                  let col = {};</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+                  let item = this._getItemFromEvent(event, col);</span>
<a href="#l16.214"></a><span id="l16.214">                   if (item) {</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-                      var colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+                      let colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l16.217"></a><span id="l16.217">                       if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l16.218"></a><span id="l16.218">                           // item holds checkbox state toggled by first click,</span>
<a href="#l16.219"></a><span id="l16.219">                           // so don't call modifyEventWithDialog</span>
<a href="#l16.220"></a><span id="l16.220">                           // to make sure user notices state changed.</span>
<a href="#l16.221"></a><span id="l16.221">                       } else {</span>
<a href="#l16.222"></a><span id="l16.222">                           modifyEventWithDialog(item, null, true, initialDate);</span>
<a href="#l16.223"></a><span id="l16.223">                       }</span>
<a href="#l16.224"></a><span id="l16.224">                   } else {</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineat">@@ -754,25 +754,25 @@</span>
<a href="#l16.226"></a><span id="l16.226">                   case kKE.DOM_VK_DELETE:</span>
<a href="#l16.227"></a><span id="l16.227">                       document.popupNode = this.binding;</span>
<a href="#l16.228"></a><span id="l16.228">                       document.getElementById('calendar_delete_todo_command').doCommand();</span>
<a href="#l16.229"></a><span id="l16.229">                       event.preventDefault();</span>
<a href="#l16.230"></a><span id="l16.230">                       event.stopPropagation();</span>
<a href="#l16.231"></a><span id="l16.231">                       break;</span>
<a href="#l16.232"></a><span id="l16.232">                   case kKE.DOM_VK_SPACE:</span>
<a href="#l16.233"></a><span id="l16.233">                       if (this.tree.currentIndex &gt; -1) {</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-                          var col = document.getAnonymousElementByAttribute(</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+                          let col = document.getAnonymousElementByAttribute(</span>
<a href="#l16.236"></a><span id="l16.236">                               this.binding, &quot;itemproperty&quot;, &quot;completed&quot;);</span>
<a href="#l16.237"></a><span id="l16.237">                           this.cycleCell(</span>
<a href="#l16.238"></a><span id="l16.238">                               this.tree.currentIndex,</span>
<a href="#l16.239"></a><span id="l16.239">                               { element: col });</span>
<a href="#l16.240"></a><span id="l16.240">                       }</span>
<a href="#l16.241"></a><span id="l16.241">                       break;</span>
<a href="#l16.242"></a><span id="l16.242">                   case kKE.DOM_VK_RETURN:</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-                      var index = this.tree.currentIndex;</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+                      let index = this.tree.currentIndex;</span>
<a href="#l16.245"></a><span id="l16.245">                       if (index &gt; -1) {</span>
<a href="#l16.246"></a><span id="l16.246">                           modifyEventWithDialog(this.binding.mTaskArray[index]);</span>
<a href="#l16.247"></a><span id="l16.247">                       }</span>
<a href="#l16.248"></a><span id="l16.248">                       break;</span>
<a href="#l16.249"></a><span id="l16.249">               }</span>
<a href="#l16.250"></a><span id="l16.250">           },</span>
<a href="#l16.251"></a><span id="l16.251"> </span>
<a href="#l16.252"></a><span id="l16.252">           // Set the context menu on mousedown to change it before it is opened</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineat">@@ -787,32 +787,32 @@</span>
<a href="#l16.254"></a><span id="l16.254">           },</span>
<a href="#l16.255"></a><span id="l16.255"> </span>
<a href="#l16.256"></a><span id="l16.256">           /**</span>
<a href="#l16.257"></a><span id="l16.257">            * Private methods and attributes</span>
<a href="#l16.258"></a><span id="l16.258">            */</span>
<a href="#l16.259"></a><span id="l16.259"> </span>
<a href="#l16.260"></a><span id="l16.260">           _getItemFromEvent: function tTV_getItemFromEvent(event, aCol, aRow) {</span>
<a href="#l16.261"></a><span id="l16.261">             aRow = aRow || {};</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-            var childElt = {};</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+            let childElt = {};</span>
<a href="#l16.264"></a><span id="l16.264">             this.treebox.getCellAt(event.clientX, event.clientY, aRow, aCol || {}, childElt);</span>
<a href="#l16.265"></a><span id="l16.265">             if (!childElt.value) {</span>
<a href="#l16.266"></a><span id="l16.266">                 return false;</span>
<a href="#l16.267"></a><span id="l16.267">             }</span>
<a href="#l16.268"></a><span id="l16.268">             return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.binding.mTaskArray[aRow.value];</span>
<a href="#l16.269"></a><span id="l16.269">           },</span>
<a href="#l16.270"></a><span id="l16.270"> </span>
<a href="#l16.271"></a><span id="l16.271">           // Helper function to display datetimes</span>
<a href="#l16.272"></a><span id="l16.272">           _formatDateTime: function tTV_formatDateTime(aDateTime) {</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-              var dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+              let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l16.275"></a><span id="l16.275">                                             .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l16.276"></a><span id="l16.276"> </span>
<a href="#l16.277"></a><span id="l16.277">               // datetime is from todo object, it is not a javascript date</span>
<a href="#l16.278"></a><span id="l16.278">               if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-                  var dateTime = aDateTime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+                  let dateTime = aDateTime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l16.281"></a><span id="l16.281">                   return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l16.282"></a><span id="l16.282">               }</span>
<a href="#l16.283"></a><span id="l16.283">               return &quot;&quot;;</span>
<a href="#l16.284"></a><span id="l16.284">           }</span>
<a href="#l16.285"></a><span id="l16.285">       })</span>
<a href="#l16.286"></a><span id="l16.286">       ]]&gt;&lt;/field&gt;</span>
<a href="#l16.287"></a><span id="l16.287"> </span>
<a href="#l16.288"></a><span id="l16.288">       &lt;!--</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineat">@@ -848,17 +848,17 @@</span>
<a href="#l16.290"></a><span id="l16.290">           },</span>
<a href="#l16.291"></a><span id="l16.291"> </span>
<a href="#l16.292"></a><span id="l16.292">           onModifyItem: function tTO_onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l16.293"></a><span id="l16.293">               if ((cal.isToDo(aNewItem) || cal.isToDo(aOldItem))) {</span>
<a href="#l16.294"></a><span id="l16.294">                   this.binding.mTreeView.modifyItems(this.binding.mFilter.getOccurrences(aNewItem),</span>
<a href="#l16.295"></a><span id="l16.295">                                                      this.binding.mFilter.getOccurrences(aOldItem));</span>
<a href="#l16.296"></a><span id="l16.296"> </span>
<a href="#l16.297"></a><span id="l16.297">                   // we also need to notify potential listeners.</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-                  var event = document.createEvent('Events');</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+                  let event = document.createEvent('Events');</span>
<a href="#l16.300"></a><span id="l16.300">                   event.initEvent('select', true, false);</span>
<a href="#l16.301"></a><span id="l16.301">                   this.binding.dispatchEvent(event);</span>
<a href="#l16.302"></a><span id="l16.302">               }</span>
<a href="#l16.303"></a><span id="l16.303">           },</span>
<a href="#l16.304"></a><span id="l16.304"> </span>
<a href="#l16.305"></a><span id="l16.305">           onDeleteItem: function tTO_onDeleteItem(aDeletedItem) {</span>
<a href="#l16.306"></a><span id="l16.306">               if (cal.isToDo(aDeletedItem)) {</span>
<a href="#l16.307"></a><span id="l16.307">                   this.binding.mTreeView.removeItems(this.binding.mFilter.getOccurrences(aDeletedItem));</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineat">@@ -1008,38 +1008,38 @@</span>
<a href="#l16.309"></a><span id="l16.309">             });</span>
<a href="#l16.310"></a><span id="l16.310">             this.mTreeView.removeItems(tasks);</span>
<a href="#l16.311"></a><span id="l16.311">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.312"></a><span id="l16.312">       &lt;/method&gt;</span>
<a href="#l16.313"></a><span id="l16.313"> </span>
<a href="#l16.314"></a><span id="l16.314">       &lt;method name=&quot;sortItems&quot;&gt;</span>
<a href="#l16.315"></a><span id="l16.315">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.316"></a><span id="l16.316">           if (this.mTreeView.selectedColumn) {</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineminus">-              var modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-              var sortKey = cal.sortEntry.mSortKey = this.mTreeView.selectedColumn.getAttribute(&quot;sortKey&quot;) ?</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+              let modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+              let sortKey = cal.sortEntry.mSortKey = this.mTreeView.selectedColumn.getAttribute(&quot;sortKey&quot;) ?</span>
<a href="#l16.321"></a><span id="l16.321">                           this.mTreeView.selectedColumn.getAttribute(&quot;sortKey&quot;) :</span>
<a href="#l16.322"></a><span id="l16.322">                           this.mTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-              var sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+              let sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l16.325"></a><span id="l16.325"> </span>
<a href="#l16.326"></a><span id="l16.326">               // sort (key,item) entries</span>
<a href="#l16.327"></a><span id="l16.327">               cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineminus">-              var entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+              let entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l16.330"></a><span id="l16.330">               entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l16.331"></a><span id="l16.331">               this.mTaskArray = entries.map(cal.sortEntryItem);</span>
<a href="#l16.332"></a><span id="l16.332">           }</span>
<a href="#l16.333"></a><span id="l16.333"> </span>
<a href="#l16.334"></a><span id="l16.334">           this.recreateHashTable();</span>
<a href="#l16.335"></a><span id="l16.335">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.336"></a><span id="l16.336">       &lt;/method&gt;</span>
<a href="#l16.337"></a><span id="l16.337"> </span>
<a href="#l16.338"></a><span id="l16.338">       &lt;method name=&quot;recreateHashTable&quot;&gt;</span>
<a href="#l16.339"></a><span id="l16.339">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.340"></a><span id="l16.340">           this.mHash2Index = {};</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineminus">-          for (var i=0; i &lt; this.mTaskArray.length; i++) {</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-              var item = this.mTaskArray[i];</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+          for (let i = 0; i &lt; this.mTaskArray.length; i++) {</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+              let item = this.mTaskArray[i];</span>
<a href="#l16.345"></a><span id="l16.345">               this.mHash2Index[item.hashId] = i;</span>
<a href="#l16.346"></a><span id="l16.346">           }</span>
<a href="#l16.347"></a><span id="l16.347">           if (this.mTreeView.treebox) {</span>
<a href="#l16.348"></a><span id="l16.348">             this.mTreeView.treebox.invalidate();</span>
<a href="#l16.349"></a><span id="l16.349">           }</span>
<a href="#l16.350"></a><span id="l16.350">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.351"></a><span id="l16.351">       &lt;/method&gt;</span>
<a href="#l16.352"></a><span id="l16.352"> </span>
<a href="#l16.353"></a><span id="l16.353" class="difflineat">@@ -1133,39 +1133,39 @@</span>
<a href="#l16.354"></a><span id="l16.354">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.355"></a><span id="l16.355">         this.mTreeView.onMouseDown(event);</span>
<a href="#l16.356"></a><span id="l16.356">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.357"></a><span id="l16.357">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.358"></a><span id="l16.358">         if (event.originalTarget.localName != &quot;treechildren&quot;) {</span>
<a href="#l16.359"></a><span id="l16.359">             // We should only drag treechildren, not for example the scrollbar.</span>
<a href="#l16.360"></a><span id="l16.360">             return;</span>
<a href="#l16.361"></a><span id="l16.361">         }</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineminus">-        var item = this.mTreeView._getItemFromEvent(event);</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+        let item = this.mTreeView._getItemFromEvent(event);</span>
<a href="#l16.364"></a><span id="l16.364">         if (!item || item.calendar.readOnly) {</span>
<a href="#l16.365"></a><span id="l16.365">             return;</span>
<a href="#l16.366"></a><span id="l16.366">         }</span>
<a href="#l16.367"></a><span id="l16.367"> </span>
<a href="#l16.368"></a><span id="l16.368" class="difflineminus">-        var tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+        let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l16.370"></a><span id="l16.370"> </span>
<a href="#l16.371"></a><span id="l16.371">         // let's build the drag region</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineminus">-        var region = null;</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+        let region = null;</span>
<a href="#l16.374"></a><span id="l16.374">         try {</span>
<a href="#l16.375"></a><span id="l16.375">           region = Components.classes[&quot;@mozilla.org/gfx/region;1&quot;].createInstance(Components.interfaces.nsIScriptableRegion);</span>
<a href="#l16.376"></a><span id="l16.376">           region.init();</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineminus">-          var obo = tree.treeBoxObject;</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineminus">-          var bo = obo.treeBody.boxObject;</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-          var sel = tree.view.selection;</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+          let obo = tree.treeBoxObject;</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+          let bo = obo.treeBody.boxObject;</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+          let sel = tree.view.selection;</span>
<a href="#l16.383"></a><span id="l16.383"> </span>
<a href="#l16.384"></a><span id="l16.384" class="difflineminus">-          var rowX = bo.x;</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineminus">-          var rowY = bo.y;</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineminus">-          var rowHeight = obo.rowHeight;</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineminus">-          var rowWidth = bo.width;</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+          let rowX = bo.x;</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+          let rowY = bo.y;</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+          let rowHeight = obo.rowHeight;</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+          let rowWidth = bo.width;</span>
<a href="#l16.392"></a><span id="l16.392"> </span>
<a href="#l16.393"></a><span id="l16.393">           // add a rectangle for each visible selected row</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineminus">-          for (var i = obo.getFirstVisibleRow(); i &lt;= obo.getLastVisibleRow(); i++) {</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+          for (let i = obo.getFirstVisibleRow(); i &lt;= obo.getLastVisibleRow(); i++) {</span>
<a href="#l16.396"></a><span id="l16.396">             if (sel.isSelected(i)) {</span>
<a href="#l16.397"></a><span id="l16.397">               region.unionRect(rowX, rowY, rowWidth, rowHeight);</span>
<a href="#l16.398"></a><span id="l16.398">             }</span>
<a href="#l16.399"></a><span id="l16.399">             rowY = rowY + rowHeight;</span>
<a href="#l16.400"></a><span id="l16.400">           }</span>
<a href="#l16.401"></a><span id="l16.401"> </span>
<a href="#l16.402"></a><span id="l16.402">           // and finally, clip the result to be sure we don't spill over...</span>
<a href="#l16.403"></a><span id="l16.403">           if (!region.isEmpty()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,81 +10,81 @@ var taskDetailsView = {</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">     /**</span>
<a href="#l17.6"></a><span id="l17.6">      * Task Details Events</span>
<a href="#l17.7"></a><span id="l17.7">      *</span>
<a href="#l17.8"></a><span id="l17.8">      * XXXberend Please document this function, possibly also consolidate since</span>
<a href="#l17.9"></a><span id="l17.9">      * its the only function in taskDetailsView.</span>
<a href="#l17.10"></a><span id="l17.10">      */</span>
<a href="#l17.11"></a><span id="l17.11">     onSelect: function tDV_onSelect(event) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-        var dateFormatter =</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-            Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-            .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-</span>
<a href="#l17.16"></a><span id="l17.16">         function displayElement(id, flag) {</span>
<a href="#l17.17"></a><span id="l17.17">             setBooleanAttribute(id, &quot;hidden&quot;, !flag);</span>
<a href="#l17.18"></a><span id="l17.18">             return flag;</span>
<a href="#l17.19"></a><span id="l17.19">         }</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-        var item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+        let dateFormatter =</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+            Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+            .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+        let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l17.27"></a><span id="l17.27">         if (displayElement(&quot;calendar-task-details-container&quot;, item != null) &amp;&amp;</span>
<a href="#l17.28"></a><span id="l17.28">             displayElement(&quot;calendar-task-view-splitter&quot;, item != null)) {</span>
<a href="#l17.29"></a><span id="l17.29">             displayElement(&quot;calendar-task-details-title-row&quot;, true);</span>
<a href="#l17.30"></a><span id="l17.30">             document.getElementById(&quot;calendar-task-details-title&quot;).textContent =</span>
<a href="#l17.31"></a><span id="l17.31">                 (item.title ? item.title.replace(/\n/g, ' ') : &quot;&quot;);</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-            var organizer = item.organizer;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+            let organizer = item.organizer;</span>
<a href="#l17.35"></a><span id="l17.35">             if (displayElement(&quot;calendar-task-details-organizer-row&quot;, organizer != null)) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-                var name = organizer.commonName;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+                let name = organizer.commonName;</span>
<a href="#l17.38"></a><span id="l17.38">                 if (!name || name.length &lt;= 0) {</span>
<a href="#l17.39"></a><span id="l17.39">                   if (organizer.id &amp;&amp; organizer.id.length) {</span>
<a href="#l17.40"></a><span id="l17.40">                       name = organizer.id;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-                      var re = new RegExp(&quot;^mailto:(.*)&quot;, &quot;i&quot;);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-                      var matches = re.exec(name);</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+                      let re = new RegExp(&quot;^mailto:(.*)&quot;, &quot;i&quot;);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+                      let matches = re.exec(name);</span>
<a href="#l17.45"></a><span id="l17.45">                       if (matches) {</span>
<a href="#l17.46"></a><span id="l17.46">                           name = matches[1];</span>
<a href="#l17.47"></a><span id="l17.47">                       }</span>
<a href="#l17.48"></a><span id="l17.48">                   }</span>
<a href="#l17.49"></a><span id="l17.49">                 }</span>
<a href="#l17.50"></a><span id="l17.50">                 if (displayElement(&quot;calendar-task-details-organizer-row&quot;, name &amp;&amp; name.length)) {</span>
<a href="#l17.51"></a><span id="l17.51">                     document.getElementById(&quot;calendar-task-details-organizer&quot;).value = name;</span>
<a href="#l17.52"></a><span id="l17.52">                 }</span>
<a href="#l17.53"></a><span id="l17.53">             }</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-            var priority = 0;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+            let priority = 0;</span>
<a href="#l17.57"></a><span id="l17.57">             if (item.calendar.getProperty(&quot;capabilities.priority.supported&quot;) != false) {</span>
<a href="#l17.58"></a><span id="l17.58">                 priority = parseInt(item.priority, 10);</span>
<a href="#l17.59"></a><span id="l17.59">             }</span>
<a href="#l17.60"></a><span id="l17.60">             displayElement(&quot;calendar-task-details-priority-label&quot;, (priority &gt; 0));</span>
<a href="#l17.61"></a><span id="l17.61">             displayElement(&quot;calendar-task-details-priority-low&quot;, (priority &gt;= 6 &amp;&amp; priority &lt;= 9));</span>
<a href="#l17.62"></a><span id="l17.62">             displayElement(&quot;calendar-task-details-priority-normal&quot;, priority == 5);</span>
<a href="#l17.63"></a><span id="l17.63">             displayElement(&quot;calendar-task-details-priority-high&quot;, (priority &gt;= 1 &amp;&amp; priority &lt;= 4));</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-            var status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+            let status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l17.67"></a><span id="l17.67">             if (displayElement(&quot;calendar-task-details-status-row&quot;, status &amp;&amp; status.length &gt; 0)) {</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-                var statusDetails = document.getElementById(&quot;calendar-task-details-status&quot;);</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+                let statusDetails = document.getElementById(&quot;calendar-task-details-status&quot;);</span>
<a href="#l17.70"></a><span id="l17.70">                 switch (status) {</span>
<a href="#l17.71"></a><span id="l17.71">                     case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l17.72"></a><span id="l17.72">                         statusDetails.value = calGetString(</span>
<a href="#l17.73"></a><span id="l17.73">                             &quot;calendar&quot;,</span>
<a href="#l17.74"></a><span id="l17.74">                             &quot;taskDetailsStatusNeedsAction&quot;);</span>
<a href="#l17.75"></a><span id="l17.75">                         break;</span>
<a href="#l17.76"></a><span id="l17.76">                     case &quot;IN-PROCESS&quot;:</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-                        var percent = 0;</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-                        var property = item.getProperty(&quot;PERCENT-COMPLETE&quot;);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+                        let percent = 0;</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+                        let property = item.getProperty(&quot;PERCENT-COMPLETE&quot;);</span>
<a href="#l17.81"></a><span id="l17.81">                         if (property != null) {</span>
<a href="#l17.82"></a><span id="l17.82">                             percent = parseInt(property, 10);</span>
<a href="#l17.83"></a><span id="l17.83">                         }</span>
<a href="#l17.84"></a><span id="l17.84">                         statusDetails.value = calGetString(</span>
<a href="#l17.85"></a><span id="l17.85">                             &quot;calendar&quot;,</span>
<a href="#l17.86"></a><span id="l17.86">                             &quot;taskDetailsStatusInProgress&quot;, [percent]);</span>
<a href="#l17.87"></a><span id="l17.87">                         break;</span>
<a href="#l17.88"></a><span id="l17.88">                     case &quot;COMPLETED&quot;:</span>
<a href="#l17.89"></a><span id="l17.89">                         if (item.completedDate) {</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-                            var completedDate = item.completedDate.getInTimezone(</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+                            let completedDate = item.completedDate.getInTimezone(</span>
<a href="#l17.92"></a><span id="l17.92">                                                     calendarDefaultTimezone());</span>
<a href="#l17.93"></a><span id="l17.93">                             statusDetails.value = calGetString(</span>
<a href="#l17.94"></a><span id="l17.94">                                 &quot;calendar&quot;,</span>
<a href="#l17.95"></a><span id="l17.95">                                 &quot;taskDetailsStatusCompletedOn&quot;,</span>
<a href="#l17.96"></a><span id="l17.96">                                 [dateFormatter.formatDateTime(completedDate)]);</span>
<a href="#l17.97"></a><span id="l17.97">                         }</span>
<a href="#l17.98"></a><span id="l17.98">                         break;</span>
<a href="#l17.99"></a><span id="l17.99">                     case &quot;CANCELLED&quot;:</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineat">@@ -92,41 +92,41 @@ var taskDetailsView = {</span>
<a href="#l17.101"></a><span id="l17.101">                             &quot;calendar&quot;,</span>
<a href="#l17.102"></a><span id="l17.102">                             &quot;taskDetailsStatusCancelled&quot;);</span>
<a href="#l17.103"></a><span id="l17.103">                         break;</span>
<a href="#l17.104"></a><span id="l17.104">                     default:</span>
<a href="#l17.105"></a><span id="l17.105">                         displayElement(&quot;calendar-task-details-status-row&quot;, false);</span>
<a href="#l17.106"></a><span id="l17.106">                         break;</span>
<a href="#l17.107"></a><span id="l17.107">                 }</span>
<a href="#l17.108"></a><span id="l17.108">             }</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-            var categories = item.getCategories({});</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+            let categories = item.getCategories({});</span>
<a href="#l17.111"></a><span id="l17.111">             if (displayElement(&quot;calendar-task-details-category-row&quot;, categories.length &gt; 0)) {</span>
<a href="#l17.112"></a><span id="l17.112">                 document.getElementById(&quot;calendar-task-details-category&quot;).value = categories.join(&quot;, &quot;);</span>
<a href="#l17.113"></a><span id="l17.113">             }</span>
<a href="#l17.114"></a><span id="l17.114">             document.getElementById(&quot;task-start-row&quot;).Item = item;</span>
<a href="#l17.115"></a><span id="l17.115">             document.getElementById(&quot;task-due-row&quot;).Item = item;</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-            var parentItem = item;</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+            let parentItem = item;</span>
<a href="#l17.118"></a><span id="l17.118">             if (parentItem.parentItem != parentItem) {</span>
<a href="#l17.119"></a><span id="l17.119">                 // XXXdbo Didn't we want to get rid of these checks?</span>
<a href="#l17.120"></a><span id="l17.120">                 parentItem = parentItem.parentItem;</span>
<a href="#l17.121"></a><span id="l17.121">             }</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-            var recurrenceInfo = parentItem.recurrenceInfo;</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-            var recurStart = parentItem.recurrenceStartDate;</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+            let recurrenceInfo = parentItem.recurrenceInfo;</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+            let recurStart = parentItem.recurrenceStartDate;</span>
<a href="#l17.126"></a><span id="l17.126">             if (displayElement(&quot;calendar-task-details-repeat-row&quot;, recurrenceInfo &amp;&amp; recurStart)) {</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-                var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-                var startDate = recurStart.getInTimezone(kDefaultTimezone);</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-                var endDate = item.dueDate ? item.dueDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-                var detailsString = recurrenceRule2String(recurrenceInfo, startDate, endDate, startDate.isDate);</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+                let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+                let startDate = recurStart.getInTimezone(kDefaultTimezone);</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+                let endDate = item.dueDate ? item.dueDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+                let detailsString = recurrenceRule2String(recurrenceInfo, startDate, endDate, startDate.isDate);</span>
<a href="#l17.135"></a><span id="l17.135">                 if (detailsString) {</span>
<a href="#l17.136"></a><span id="l17.136">                     let rpv = document.getElementById(&quot;calendar-task-details-repeat&quot;);</span>
<a href="#l17.137"></a><span id="l17.137">                     rpv.value = detailsString.split(&quot;\n&quot;).join(&quot; &quot;);</span>
<a href="#l17.138"></a><span id="l17.138">                 }</span>
<a href="#l17.139"></a><span id="l17.139">             }</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-            var textbox = document.getElementById(&quot;calendar-task-details-description&quot;);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-            var description = item.hasProperty(&quot;DESCRIPTION&quot;) ? item.getProperty(&quot;DESCRIPTION&quot;) : null;</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+            let textbox = document.getElementById(&quot;calendar-task-details-description&quot;);</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+            let description = item.hasProperty(&quot;DESCRIPTION&quot;) ? item.getProperty(&quot;DESCRIPTION&quot;) : null;</span>
<a href="#l17.144"></a><span id="l17.144">             textbox.value = description;</span>
<a href="#l17.145"></a><span id="l17.145">             textbox.inputField.readOnly = true;</span>
<a href="#l17.146"></a><span id="l17.146">             let attachmentRows = document.getElementById(&quot;calendar-task-details-attachment-rows&quot;);</span>
<a href="#l17.147"></a><span id="l17.147">             removeChildren(attachmentRows);</span>
<a href="#l17.148"></a><span id="l17.148">             let attachments = item.getAttachments({});</span>
<a href="#l17.149"></a><span id="l17.149">             if (displayElement(&quot;calendar-task-details-attachment-row&quot;, attachments.length &gt; 0)) {</span>
<a href="#l17.150"></a><span id="l17.150">                 displayElement(&quot;calendar-task-details-attachment-rows&quot;, true);</span>
<a href="#l17.151"></a><span id="l17.151">                 for (let attachment of attachments) {</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineat">@@ -205,17 +205,17 @@ function taskViewUpdate(aFilter) {</span>
<a href="#l17.153"></a><span id="l17.153"> /**</span>
<a href="#l17.154"></a><span id="l17.154">  * Prepares a dialog to send an email to the organizer of the currently selected</span>
<a href="#l17.155"></a><span id="l17.155">  * task in the task view.</span>
<a href="#l17.156"></a><span id="l17.156">  *</span>
<a href="#l17.157"></a><span id="l17.157">  * XXX We already have a function with this name in the event dialog. Either</span>
<a href="#l17.158"></a><span id="l17.158">  * consolidate or make name more clear.</span>
<a href="#l17.159"></a><span id="l17.159">  */</span>
<a href="#l17.160"></a><span id="l17.160"> function sendMailToOrganizer() {</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-    var item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+    let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l17.163"></a><span id="l17.163">     if (item != null) {</span>
<a href="#l17.164"></a><span id="l17.164">         let organizer = item.organizer;</span>
<a href="#l17.165"></a><span id="l17.165">         let email = cal.getAttendeeEmail(organizer, true);</span>
<a href="#l17.166"></a><span id="l17.166">         let emailSubject = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;emailSubjectReply&quot;, [item.title]);</span>
<a href="#l17.167"></a><span id="l17.167">         let identity = item.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l17.168"></a><span id="l17.168">         sendMailTo(email, emailSubject, null, identity);</span>
<a href="#l17.169"></a><span id="l17.169">     }</span>
<a href="#l17.170"></a><span id="l17.170"> }</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineat">@@ -260,22 +260,22 @@ function taskViewOnLoad() {</span>
<a href="#l17.172"></a><span id="l17.172">                                                    &quot;keyLabelMac&quot; : &quot;keyLabelNonMac&quot;);</span>
<a href="#l17.173"></a><span id="l17.173"> </span>
<a href="#l17.174"></a><span id="l17.174">             textFilter.setAttribute(&quot;placeholder&quot;, base.replace(&quot;#1&quot;, keyLabel));</span>
<a href="#l17.175"></a><span id="l17.175">             textFilter.value = &quot;&quot;;</span>
<a href="#l17.176"></a><span id="l17.176">         }</span>
<a href="#l17.177"></a><span id="l17.177">     }</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179">     // Setup customizeDone handler for the task action toolbox.</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-    var toolbox = document.getElementById(&quot;task-actions-toolbox&quot;);</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+    let toolbox = document.getElementById(&quot;task-actions-toolbox&quot;);</span>
<a href="#l17.182"></a><span id="l17.182">     toolbox.customizeDone = function(aEvent) {</span>
<a href="#l17.183"></a><span id="l17.183">         MailToolboxCustomizeDone(aEvent, &quot;CustomizeTaskActionsToolbar&quot;);</span>
<a href="#l17.184"></a><span id="l17.184">     };</span>
<a href="#l17.185"></a><span id="l17.185"> </span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-    var toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+    let toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l17.188"></a><span id="l17.188">     toolbox.toolbarset = toolbarset;</span>
<a href="#l17.189"></a><span id="l17.189"> </span>
<a href="#l17.190"></a><span id="l17.190">     Services.obs.notifyObservers(window, &quot;calendar-taskview-startup-done&quot;, false);</span>
<a href="#l17.191"></a><span id="l17.191"> }</span>
<a href="#l17.192"></a><span id="l17.192"> </span>
<a href="#l17.193"></a><span id="l17.193"> /**</span>
<a href="#l17.194"></a><span id="l17.194">  * Copy the value of the given link node to the clipboard</span>
<a href="#l17.195"></a><span id="l17.195">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -148,45 +148,45 @@ function disableElement(aElement) {</span>
<a href="#l18.4"></a><span id="l18.4">  */</span>
<a href="#l18.5"></a><span id="l18.5"> function disableElementWithLock(elementId, lockId) {</span>
<a href="#l18.6"></a><span id="l18.6">     // unconditionally disable the element.</span>
<a href="#l18.7"></a><span id="l18.7">     disableElement(elementId);</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">     // remember that this element has been locked with</span>
<a href="#l18.10"></a><span id="l18.10">     // the key passed as argument. we keep a primitive</span>
<a href="#l18.11"></a><span id="l18.11">     // form of ref-count in the attribute 'lock'.</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    var element = document.getElementById(elementId);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    let element = document.getElementById(elementId);</span>
<a href="#l18.14"></a><span id="l18.14">     if (element) {</span>
<a href="#l18.15"></a><span id="l18.15">         if (!element.hasAttribute(lockId)) {</span>
<a href="#l18.16"></a><span id="l18.16">             element.setAttribute(lockId, &quot;true&quot;);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-            var n = parseInt(element.getAttribute(&quot;lock&quot;) || 0, 10);</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+            let n = parseInt(element.getAttribute(&quot;lock&quot;) || 0, 10);</span>
<a href="#l18.19"></a><span id="l18.19">             element.setAttribute(&quot;lock&quot;, n + 1);</span>
<a href="#l18.20"></a><span id="l18.20">         }</span>
<a href="#l18.21"></a><span id="l18.21">     }</span>
<a href="#l18.22"></a><span id="l18.22"> }</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24"> /**</span>
<a href="#l18.25"></a><span id="l18.25">  * This function is intended to be used in tandem with the</span>
<a href="#l18.26"></a><span id="l18.26">  * above defined function 'disableElementWithLock()'.</span>
<a href="#l18.27"></a><span id="l18.27">  * See the respective comment for further details.</span>
<a href="#l18.28"></a><span id="l18.28">  *</span>
<a href="#l18.29"></a><span id="l18.29">  * @see disableElementWithLock</span>
<a href="#l18.30"></a><span id="l18.30">  * @param elementId     The element ID of the element to enable.</span>
<a href="#l18.31"></a><span id="l18.31">  * @param lockId        The ID of the lock to set.</span>
<a href="#l18.32"></a><span id="l18.32">  */</span>
<a href="#l18.33"></a><span id="l18.33"> function enableElementWithLock(elementId, lockId) {</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    var element = document.getElementById(elementId);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    let element = document.getElementById(elementId);</span>
<a href="#l18.36"></a><span id="l18.36">     if (!element) {</span>
<a href="#l18.37"></a><span id="l18.37">         dump(&quot;unable to find &quot; + elementId + &quot;\n&quot;);</span>
<a href="#l18.38"></a><span id="l18.38">         return;</span>
<a href="#l18.39"></a><span id="l18.39">     }</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41">     if (element.hasAttribute(lockId)) {</span>
<a href="#l18.42"></a><span id="l18.42">         element.removeAttribute(lockId);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-        var n = parseInt(element.getAttribute(&quot;lock&quot;) || 0, 10) - 1;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+        let n = parseInt(element.getAttribute(&quot;lock&quot;) || 0, 10) - 1;</span>
<a href="#l18.45"></a><span id="l18.45">         if (n &gt; 0) {</span>
<a href="#l18.46"></a><span id="l18.46">             element.setAttribute(&quot;lock&quot;, n);</span>
<a href="#l18.47"></a><span id="l18.47">         } else {</span>
<a href="#l18.48"></a><span id="l18.48">             element.removeAttribute(&quot;lock&quot;);</span>
<a href="#l18.49"></a><span id="l18.49">         }</span>
<a href="#l18.50"></a><span id="l18.50">         if (n &lt;= 0) {</span>
<a href="#l18.51"></a><span id="l18.51">             enableElement(elementId);</span>
<a href="#l18.52"></a><span id="l18.52">         }</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineat">@@ -195,20 +195,20 @@ function enableElementWithLock(elementId</span>
<a href="#l18.54"></a><span id="l18.54"> </span>
<a href="#l18.55"></a><span id="l18.55"> /**</span>
<a href="#l18.56"></a><span id="l18.56">  * Unchecks the commands of the child elements of a DOM-tree-node i.e of a menu</span>
<a href="#l18.57"></a><span id="l18.57">  *</span>
<a href="#l18.58"></a><span id="l18.58">  * @param aEvent    The event from which the target is taken to retrieve the</span>
<a href="#l18.59"></a><span id="l18.59">  *                    child elements</span>
<a href="#l18.60"></a><span id="l18.60">  */</span>
<a href="#l18.61"></a><span id="l18.61"> function uncheckChildNodes(aEvent) {</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-    var liveList = aEvent.target.getElementsByAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-    for (var i = liveList.length - 1; i &gt;= 0; i--) {</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-        var commandName = liveList.item(i).getAttribute(&quot;command&quot;);</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-        var command = document.getElementById(commandName);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+    let liveList = aEvent.target.getElementsByAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+    for (let i = liveList.length - 1; i &gt;= 0; i--) {</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+        let commandName = liveList.item(i).getAttribute(&quot;command&quot;);</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+        let command = document.getElementById(commandName);</span>
<a href="#l18.70"></a><span id="l18.70">         if (command) {</span>
<a href="#l18.71"></a><span id="l18.71">             command.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l18.72"></a><span id="l18.72">         }</span>
<a href="#l18.73"></a><span id="l18.73">     }</span>
<a href="#l18.74"></a><span id="l18.74"> }</span>
<a href="#l18.75"></a><span id="l18.75"> </span>
<a href="#l18.76"></a><span id="l18.76"> /**</span>
<a href="#l18.77"></a><span id="l18.77">  * Removes all child nodes of the given node</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineat">@@ -340,22 +340,22 @@ function addMenuItem(aParent, aLabel, aV</span>
<a href="#l18.79"></a><span id="l18.79">  * @param aFilterAttribute  (optional) The name of an attribute that the child nodes carry</span>
<a href="#l18.80"></a><span id="l18.80">  *                            and that is used to filter the childnodes.</span>
<a href="#l18.81"></a><span id="l18.81">  * @param aFilterValue      (optional) The value of the filterattribute. If set only those</span>
<a href="#l18.82"></a><span id="l18.82">  *                            childnodes are modified that have an attribute</span>
<a href="#l18.83"></a><span id="l18.83">  *                            'aFilterAttribute' with the given value</span>
<a href="#l18.84"></a><span id="l18.84">  *                            'aFilterValue' set.</span>
<a href="#l18.85"></a><span id="l18.85">  */</span>
<a href="#l18.86"></a><span id="l18.86"> function setAttributeToChildren(aParent, aAttribute, aValue, aFilterAttribute, aFilterValue) {</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-    for (var i = 0; i &lt; aParent.childNodes.length; i++) {</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-        var element = aParent.childNodes[i];</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+    for (let i = 0; i &lt; aParent.childNodes.length; i++) {</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+        let element = aParent.childNodes[i];</span>
<a href="#l18.91"></a><span id="l18.91">         if (aFilterAttribute == null) {</span>
<a href="#l18.92"></a><span id="l18.92">             setElementValue(element, aValue, aAttribute);</span>
<a href="#l18.93"></a><span id="l18.93">         } else if (element.hasAttribute(aFilterAttribute)) {</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-            var compValue = element.getAttribute(aFilterAttribute);</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+            let compValue = element.getAttribute(aFilterAttribute);</span>
<a href="#l18.96"></a><span id="l18.96">             if (compValue === aFilterValue) {</span>
<a href="#l18.97"></a><span id="l18.97">                 setElementValue(element, aValue, aAttribute);</span>
<a href="#l18.98"></a><span id="l18.98">             }</span>
<a href="#l18.99"></a><span id="l18.99">         }</span>
<a href="#l18.100"></a><span id="l18.100">     }</span>
<a href="#l18.101"></a><span id="l18.101"> }</span>
<a href="#l18.102"></a><span id="l18.102"> </span>
<a href="#l18.103"></a><span id="l18.103"> /**</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineat">@@ -363,20 +363,20 @@ function setAttributeToChildren(aParent,</span>
<a href="#l18.105"></a><span id="l18.105">  *</span>
<a href="#l18.106"></a><span id="l18.106">  * @param aParent  The parent node of the 'radio controls', either radios</span>
<a href="#l18.107"></a><span id="l18.107">  *                  or menuitems of the type 'radio'.</span>
<a href="#l18.108"></a><span id="l18.108">  * @param avalue   The value of the radio control bound to be checked.</span>
<a href="#l18.109"></a><span id="l18.109">  * @return         True or false depending on if the a 'radio control' with the</span>
<a href="#l18.110"></a><span id="l18.110">  *                  given value could be checked.</span>
<a href="#l18.111"></a><span id="l18.111">  */</span>
<a href="#l18.112"></a><span id="l18.112"> function checkRadioControl(aParent, aValue) {</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-    for (var i = 0; i &lt; aParent.childNodes.length; i++) {</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-        var element = aParent.childNodes[i];</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+    for (let i = 0; i &lt; aParent.childNodes.length; i++) {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+        let element = aParent.childNodes[i];</span>
<a href="#l18.117"></a><span id="l18.117">         if (element.hasAttribute(&quot;value&quot;)) {</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-            var compValue = element.getAttribute(&quot;value&quot;);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+            let compValue = element.getAttribute(&quot;value&quot;);</span>
<a href="#l18.120"></a><span id="l18.120">             if (compValue == aValue) {</span>
<a href="#l18.121"></a><span id="l18.121">                 if (element.localName == &quot;menuitem&quot;) {</span>
<a href="#l18.122"></a><span id="l18.122">                     if (element.getAttribute(&quot;type&quot;) == &quot;radio&quot;) {</span>
<a href="#l18.123"></a><span id="l18.123">                         element.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.124"></a><span id="l18.124">                         return true;</span>
<a href="#l18.125"></a><span id="l18.125">                     }</span>
<a href="#l18.126"></a><span id="l18.126">                 } else if (element.localName == &quot;radio&quot;) {</span>
<a href="#l18.127"></a><span id="l18.127">                     element.radioGroup.selectedItem = element;</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineat">@@ -390,30 +390,30 @@ function checkRadioControl(aParent, aVal</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130"> /**</span>
<a href="#l18.131"></a><span id="l18.131">  * Enables or disables the given element depending on the checkbox state.</span>
<a href="#l18.132"></a><span id="l18.132">  *</span>
<a href="#l18.133"></a><span id="l18.133">  * @param checkboxId    The ID of the XUL checkbox element.</span>
<a href="#l18.134"></a><span id="l18.134">  * @param elementId     The element to change the disabled state on.</span>
<a href="#l18.135"></a><span id="l18.135">  */</span>
<a href="#l18.136"></a><span id="l18.136"> function processEnableCheckbox(checkboxId, elementId) {</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-    var checked = document.getElementById(checkboxId).checked;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+    let checked = document.getElementById(checkboxId).checked;</span>
<a href="#l18.139"></a><span id="l18.139">     setElementValue(elementId, !checked &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l18.140"></a><span id="l18.140"> }</span>
<a href="#l18.141"></a><span id="l18.141"> </span>
<a href="#l18.142"></a><span id="l18.142"> /**</span>
<a href="#l18.143"></a><span id="l18.143">  * Enable/disable button if there are children in a listbox</span>
<a href="#l18.144"></a><span id="l18.144">  *</span>
<a href="#l18.145"></a><span id="l18.145">  * XXX This function needs renaming, it can do more than just buttons.</span>
<a href="#l18.146"></a><span id="l18.146">  *</span>
<a href="#l18.147"></a><span id="l18.147">  * @param listboxId     The ID of the listbox to check.</span>
<a href="#l18.148"></a><span id="l18.148">  * @param buttonId      The element to change the disabled state on.</span>
<a href="#l18.149"></a><span id="l18.149">  */</span>
<a href="#l18.150"></a><span id="l18.150"> function updateListboxDeleteButton(listboxId, buttonId) {</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-    var rowCount = document.getElementById(listboxId).getRowCount();</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+    let rowCount = document.getElementById(listboxId).getRowCount();</span>
<a href="#l18.153"></a><span id="l18.153">     setElementValue(buttonId, rowCount &lt; 1 &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l18.154"></a><span id="l18.154"> }</span>
<a href="#l18.155"></a><span id="l18.155"> </span>
<a href="#l18.156"></a><span id="l18.156"> /**</span>
<a href="#l18.157"></a><span id="l18.157">  * Gets the correct plural form of a given unit.</span>
<a href="#l18.158"></a><span id="l18.158">  *</span>
<a href="#l18.159"></a><span id="l18.159">  * @param aLength         The number to use to determine the plural form</span>
<a href="#l18.160"></a><span id="l18.160">  * @param aUnit           The unit to find the plural form of</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineat">@@ -472,37 +472,37 @@ function updateMenuLabelsPlural(aLengthF</span>
<a href="#l18.162"></a><span id="l18.162">  *</span>
<a href="#l18.163"></a><span id="l18.163">  * XXX Isn't it enough to just do menuList.value = value ?</span>
<a href="#l18.164"></a><span id="l18.164">  *</span>
<a href="#l18.165"></a><span id="l18.165">  * @param menuListId    The ID of the menulist to check.</span>
<a href="#l18.166"></a><span id="l18.166">  * @param value         The value to set.</span>
<a href="#l18.167"></a><span id="l18.167">  * @throws              String error if value not found.</span>
<a href="#l18.168"></a><span id="l18.168">  */</span>
<a href="#l18.169"></a><span id="l18.169"> function menuListSelectItem(menuListId, value) {</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-    var menuList = document.getElementById(menuListId);</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-    var index = menuListIndexOf(menuList, value);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+    let menuList = document.getElementById(menuListId);</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+    let index = menuListIndexOf(menuList, value);</span>
<a href="#l18.174"></a><span id="l18.174">     if (index != -1) {</span>
<a href="#l18.175"></a><span id="l18.175">         menuList.selectedIndex = index;</span>
<a href="#l18.176"></a><span id="l18.176">     } else {</span>
<a href="#l18.177"></a><span id="l18.177">         throw &quot;menuListSelectItem: No such Element: &quot; + value;</span>
<a href="#l18.178"></a><span id="l18.178">     }</span>
<a href="#l18.179"></a><span id="l18.179"> }</span>
<a href="#l18.180"></a><span id="l18.180"> </span>
<a href="#l18.181"></a><span id="l18.181"> /**</span>
<a href="#l18.182"></a><span id="l18.182">  * Find index of menuitem with the given value, or return -1 if not found.</span>
<a href="#l18.183"></a><span id="l18.183">  *</span>
<a href="#l18.184"></a><span id="l18.184">  * @param menuListId    The XUL menulist node to check.</span>
<a href="#l18.185"></a><span id="l18.185">  * @param value         The value to look for.</span>
<a href="#l18.186"></a><span id="l18.186">  * @return              The child index of the node that matches, or -1.</span>
<a href="#l18.187"></a><span id="l18.187">  */</span>
<a href="#l18.188"></a><span id="l18.188"> function menuListIndexOf(menuList, value) {</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-    var items = menuList.menupopup.childNodes;</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-    var index = -1;</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-    for (var i = 0; i &lt; items.length; i++) {</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-        var element = items[i];</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+    let items = menuList.menupopup.childNodes;</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+    let index = -1;</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+    for (let i = 0; i &lt; items.length; i++) {</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+        let element = items[i];</span>
<a href="#l18.197"></a><span id="l18.197">         if (element.nodeName == &quot;menuitem&quot;) {</span>
<a href="#l18.198"></a><span id="l18.198">             index++;</span>
<a href="#l18.199"></a><span id="l18.199">         }</span>
<a href="#l18.200"></a><span id="l18.200">         if (element.getAttribute(&quot;value&quot;) == value) {</span>
<a href="#l18.201"></a><span id="l18.201">             return index;</span>
<a href="#l18.202"></a><span id="l18.202">         }</span>
<a href="#l18.203"></a><span id="l18.203">     }</span>
<a href="#l18.204"></a><span id="l18.204">     return -1; // not found</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineat">@@ -524,19 +524,19 @@ function createXULElement(el) {</span>
<a href="#l18.206"></a><span id="l18.206">  * see also</span>
<a href="#l18.207"></a><span id="l18.207">  * http://www.w3.org/TR/DOM-Level-2-Style/css.html#CSS-CSSview-getComputedStyle</span>
<a href="#l18.208"></a><span id="l18.208">  * @param aXULElement   The xul element to be inspected.</span>
<a href="#l18.209"></a><span id="l18.209">  * @param aStyleProps   The css style properties for which values are to be retrieved</span>
<a href="#l18.210"></a><span id="l18.210">  *                        e.g. 'font-size', 'min-width&quot; etc.</span>
<a href="#l18.211"></a><span id="l18.211">  * @return              An integer value denoting the optimal minimum width</span>
<a href="#l18.212"></a><span id="l18.212">  */</span>
<a href="#l18.213"></a><span id="l18.213"> function getSummarizedStyleValues(aXULElement, aStyleProps) {</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-    var retValue = 0;</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-    var cssStyleDeclares = document.defaultView.getComputedStyle(aXULElement, null);</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-    for (var prop of aStyleProps) {</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+    let retValue = 0;</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+    let cssStyleDeclares = document.defaultView.getComputedStyle(aXULElement, null);</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+    for (let prop of aStyleProps) {</span>
<a href="#l18.220"></a><span id="l18.220">         retValue += parseInt(cssStyleDeclares.getPropertyValue(prop), 10);</span>
<a href="#l18.221"></a><span id="l18.221">     }</span>
<a href="#l18.222"></a><span id="l18.222">     return retValue;</span>
<a href="#l18.223"></a><span id="l18.223"> }</span>
<a href="#l18.224"></a><span id="l18.224"> </span>
<a href="#l18.225"></a><span id="l18.225"> /**</span>
<a href="#l18.226"></a><span id="l18.226">  * Calculates the optimal minimum width based on the set css style-rules</span>
<a href="#l18.227"></a><span id="l18.227">  * by considering the css rules for the min-width, padding, border, margin</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineat">@@ -559,18 +559,18 @@ function getOptimalMinimumWidth(aXULElem</span>
<a href="#l18.229"></a><span id="l18.229">  * by assuming that it's size is about one third of the size of the font-size</span>
<a href="#l18.230"></a><span id="l18.230">  *</span>
<a href="#l18.231"></a><span id="l18.231">  * @param aXULElement   The xul-element to be inspected.</span>
<a href="#l18.232"></a><span id="l18.232">  * @return              An integer value denoting the optimal minimum height</span>
<a href="#l18.233"></a><span id="l18.233">  */</span>
<a href="#l18.234"></a><span id="l18.234"> function getOptimalMinimumHeight(aXULElement) {</span>
<a href="#l18.235"></a><span id="l18.235">     // the following line of code presumes that the line-height is set to &quot;normal&quot;</span>
<a href="#l18.236"></a><span id="l18.236">     // which is supposed to be a &quot;reasonable distance&quot; between the lines</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-    var firstEntity = parseInt(1.35 * getSummarizedStyleValues(aXULElement, [&quot;font-size&quot;]), 10);</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineminus">-    var secondEntity = getSummarizedStyleValues(aXULElement,</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+    let firstEntity = parseInt(1.35 * getSummarizedStyleValues(aXULElement, [&quot;font-size&quot;]), 10);</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+    let secondEntity = getSummarizedStyleValues(aXULElement,</span>
<a href="#l18.241"></a><span id="l18.241">                                                 [&quot;padding-bottom&quot;, &quot;padding-top&quot;,</span>
<a href="#l18.242"></a><span id="l18.242">                                                 &quot;margin-bottom&quot;, &quot;margin-top&quot;,</span>
<a href="#l18.243"></a><span id="l18.243">                                                 &quot;border-bottom-width&quot;, &quot;border-top-width&quot;]);</span>
<a href="#l18.244"></a><span id="l18.244">     return (firstEntity + secondEntity);</span>
<a href="#l18.245"></a><span id="l18.245"> }</span>
<a href="#l18.246"></a><span id="l18.246"> </span>
<a href="#l18.247"></a><span id="l18.247"> /**</span>
<a href="#l18.248"></a><span id="l18.248">  * Gets the &quot;other&quot; orientation value, i.e if &quot;horizontal&quot; is passed, &quot;vertical&quot;</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineat">@@ -588,17 +588,17 @@ function getOtherOrientation(aOrientatio</span>
<a href="#l18.250"></a><span id="l18.250">  * menuitem is selected. This function takes care by reselecting the item</span>
<a href="#l18.251"></a><span id="l18.251">  *</span>
<a href="#l18.252"></a><span id="l18.252">  * @param aElement  The element to update, or its id as a string</span>
<a href="#l18.253"></a><span id="l18.253">  */</span>
<a href="#l18.254"></a><span id="l18.254"> function updateSelectedLabel(aElement) {</span>
<a href="#l18.255"></a><span id="l18.255">     if (typeof aElement == &quot;string&quot;) {</span>
<a href="#l18.256"></a><span id="l18.256">         aElement = document.getElementById(aElement);</span>
<a href="#l18.257"></a><span id="l18.257">     }</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-    var selectedIndex = aElement.selectedIndex;</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+    let selectedIndex = aElement.selectedIndex;</span>
<a href="#l18.260"></a><span id="l18.260">     aElement.selectedIndex = -1;</span>
<a href="#l18.261"></a><span id="l18.261">     aElement.selectedIndex = selectedIndex;</span>
<a href="#l18.262"></a><span id="l18.262"> }</span>
<a href="#l18.263"></a><span id="l18.263"> </span>
<a href="#l18.264"></a><span id="l18.264"> /**</span>
<a href="#l18.265"></a><span id="l18.265">  * Sets up the attendance context menu, based on the given items</span>
<a href="#l18.266"></a><span id="l18.266">  *</span>
<a href="#l18.267"></a><span id="l18.267">  * @param aMenu     The DOM Node of the menupopup to set up</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -873,26 +873,26 @@ function addItemsFromSingleCalendarInter</span>
<a href="#l19.4"></a><span id="l19.4"> }</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> function addItemsFromCalendar(aCalendar, aAddItemsInternalFunc) {</span>
<a href="#l19.7"></a><span id="l19.7">     if (isUnifinderHidden()) {</span>
<a href="#l19.8"></a><span id="l19.8">         // If the unifinder is hidden, don't refresh the events to reduce needed</span>
<a href="#l19.9"></a><span id="l19.9">         // getItems calls.</span>
<a href="#l19.10"></a><span id="l19.10">         return;</span>
<a href="#l19.11"></a><span id="l19.11">     }</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    var refreshListener = {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    let refreshListener = {</span>
<a href="#l19.14"></a><span id="l19.14">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l19.15"></a><span id="l19.15">         mEventArray: [],</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">         onOperationComplete: function rET_onOperationComplete(aOpCalendar,</span>
<a href="#l19.18"></a><span id="l19.18">                                                               aStatus,</span>
<a href="#l19.19"></a><span id="l19.19">                                                               aOperationType,</span>
<a href="#l19.20"></a><span id="l19.20">                                                               aId,</span>
<a href="#l19.21"></a><span id="l19.21">                                                               aDateTime) {</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-            var refreshTreeInternalFunc = function() {</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+            let refreshTreeInternalFunc = function() {</span>
<a href="#l19.24"></a><span id="l19.24">                 aAddItemsInternalFunc(refreshListener.mEventArray);</span>
<a href="#l19.25"></a><span id="l19.25">             };</span>
<a href="#l19.26"></a><span id="l19.26">             setTimeout(refreshTreeInternalFunc, 0);</span>
<a href="#l19.27"></a><span id="l19.27">         },</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">         onGetResult: function rET_onGetResult(aOpCalendar,</span>
<a href="#l19.30"></a><span id="l19.30">                                               aStatus,</span>
<a href="#l19.31"></a><span id="l19.31">                                               aItemType,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -145,31 +145,31 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5">       &lt;property name=&quot;eventNameLabel&quot; readonly=&quot;true&quot;</span>
<a href="#l20.6"></a><span id="l20.6">         onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name');&quot;/&gt;</span>
<a href="#l20.7"></a><span id="l20.7">       &lt;property name=&quot;eventNameTextbox&quot; readonly=&quot;true&quot;</span>
<a href="#l20.8"></a><span id="l20.8">         onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name-textbox');&quot;/&gt;</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">       &lt;method name=&quot;setEditableLabel&quot;&gt;</span>
<a href="#l20.11"></a><span id="l20.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-          var evl = this.eventNameLabel;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-          var item = this.mOccurrence;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+          let evl = this.eventNameLabel;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+          let item = this.mOccurrence;</span>
<a href="#l20.16"></a><span id="l20.16">           evl.value = (item.title ? item.title.replace(/\n/g, ' ') :</span>
<a href="#l20.17"></a><span id="l20.17">                                     cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l20.18"></a><span id="l20.18">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.19"></a><span id="l20.19">       &lt;/method&gt;</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21">       &lt;method name=&quot;setCSSClasses&quot;&gt;</span>
<a href="#l20.22"></a><span id="l20.22">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-          var item = this.mOccurrence;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+          let item = this.mOccurrence;</span>
<a href="#l20.25"></a><span id="l20.25">           this.setAttribute(&quot;calendar-uri&quot;, item.calendar.uri.spec);</span>
<a href="#l20.26"></a><span id="l20.26">           this.setAttribute(&quot;calendar-id&quot;, item.calendar.id);</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-          var categoriesArray = item.getCategories({});</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+          let categoriesArray = item.getCategories({});</span>
<a href="#l20.29"></a><span id="l20.29">           if (categoriesArray.length &gt; 0) {</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-            var cssClassesArray = categoriesArray.map(formatStringForCSSRule);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+            let cssClassesArray = categoriesArray.map(formatStringForCSSRule);</span>
<a href="#l20.32"></a><span id="l20.32">             this.setAttribute(&quot;categories&quot;, cssClassesArray.join(&quot; &quot;));</span>
<a href="#l20.33"></a><span id="l20.33">           }</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35">           // Add alarm icons as needed.</span>
<a href="#l20.36"></a><span id="l20.36">           let alarms = item.getAlarms({});</span>
<a href="#l20.37"></a><span id="l20.37">           if (alarms.length &amp;&amp; Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true)) {</span>
<a href="#l20.38"></a><span id="l20.38">               let iconsBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-icons-box&quot;);</span>
<a href="#l20.39"></a><span id="l20.39">               cal.alarms.addReminderImages(iconsBox, alarms);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineat">@@ -322,17 +322,17 @@</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42">         // If the left button was used and the item is already selected</span>
<a href="#l20.43"></a><span id="l20.43">         // and there are no multiple items selected start</span>
<a href="#l20.44"></a><span id="l20.44">         // the 'single click edit' timeout. Otherwise select the item too.</span>
<a href="#l20.45"></a><span id="l20.45">         // Also, check if the calendar is readOnly or we are offline.</span>
<a href="#l20.46"></a><span id="l20.46"> </span>
<a href="#l20.47"></a><span id="l20.47">         if (this.selected &amp;&amp; !(event.ctrlKey || event.metaKey) &amp;&amp;</span>
<a href="#l20.48"></a><span id="l20.48">               isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-            var self = this;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+            let self = this;</span>
<a href="#l20.51"></a><span id="l20.51">             if (this.editingTimer) {</span>
<a href="#l20.52"></a><span id="l20.52">                 clearTimeout(this.editingTimer);</span>
<a href="#l20.53"></a><span id="l20.53">             }</span>
<a href="#l20.54"></a><span id="l20.54">             this.editingTimer = setTimeout(function editingTimeout() { self.startEditing(); }, 350);</span>
<a href="#l20.55"></a><span id="l20.55">         } else {</span>
<a href="#l20.56"></a><span id="l20.56">             this.select(event);</span>
<a href="#l20.57"></a><span id="l20.57">             event.stopPropagation();</span>
<a href="#l20.58"></a><span id="l20.58">         }</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineat">@@ -343,17 +343,17 @@</span>
<a href="#l20.60"></a><span id="l20.60"> </span>
<a href="#l20.61"></a><span id="l20.61">         // stop 'single click edit' timeout (if started)</span>
<a href="#l20.62"></a><span id="l20.62">         if (this.editingTimer) {</span>
<a href="#l20.63"></a><span id="l20.63">             clearTimeout(this.editingTimer);</span>
<a href="#l20.64"></a><span id="l20.64">             this.editingTimer = null;</span>
<a href="#l20.65"></a><span id="l20.65">         }</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">         if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-            var item = (event.ctrlKey) ? this.mOccurrence.parentItem : this.mOccurrence;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+            let item = (event.ctrlKey) ? this.mOccurrence.parentItem : this.mOccurrence;</span>
<a href="#l20.70"></a><span id="l20.70">             this.calendarView.controller.modifyOccurrence(item);</span>
<a href="#l20.71"></a><span id="l20.71">         }</span>
<a href="#l20.72"></a><span id="l20.72">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l20.73"></a><span id="l20.73">       &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l20.74"></a><span id="l20.74">         if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l20.75"></a><span id="l20.75">             event.stopPropagation();</span>
<a href="#l20.76"></a><span id="l20.76">             onMouseOverItem(event);</span>
<a href="#l20.77"></a><span id="l20.77">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -87,38 +87,38 @@ var calendarViewController = {</span>
<a href="#l21.4"></a><span id="l21.4">      * Deletes the given occurrences</span>
<a href="#l21.5"></a><span id="l21.5">      * @see calICalendarViewController</span>
<a href="#l21.6"></a><span id="l21.6">      */</span>
<a href="#l21.7"></a><span id="l21.7">     deleteOccurrences: function(aCount,</span>
<a href="#l21.8"></a><span id="l21.8">                                 aOccurrences,</span>
<a href="#l21.9"></a><span id="l21.9">                                 aUseParentItems,</span>
<a href="#l21.10"></a><span id="l21.10">                                 aDoNotConfirm) {</span>
<a href="#l21.11"></a><span id="l21.11">         startBatchTransaction();</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-        var recurringItems = {};</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+        let recurringItems = {};</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-        function getSavedItem(aItemToDelete) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+        let getSavedItem = function(aItemToDelete) {</span>
<a href="#l21.17"></a><span id="l21.17">             // Get the parent item, saving it in our recurringItems object for</span>
<a href="#l21.18"></a><span id="l21.18">             // later use.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-            var hashVal = aItemToDelete.parentItem.hashId;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+            let hashVal = aItemToDelete.parentItem.hashId;</span>
<a href="#l21.21"></a><span id="l21.21">             if (!recurringItems[hashVal]) {</span>
<a href="#l21.22"></a><span id="l21.22">                 recurringItems[hashVal] = {</span>
<a href="#l21.23"></a><span id="l21.23">                     oldItem: aItemToDelete.parentItem,</span>
<a href="#l21.24"></a><span id="l21.24">                     newItem: aItemToDelete.parentItem.clone()</span>
<a href="#l21.25"></a><span id="l21.25">                 };</span>
<a href="#l21.26"></a><span id="l21.26">             }</span>
<a href="#l21.27"></a><span id="l21.27">             return recurringItems[hashVal];</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-        }</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+        };</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31">         // Make sure we are modifying a copy of aOccurrences, otherwise we will</span>
<a href="#l21.32"></a><span id="l21.32">         // run into race conditions when the view's doDeleteItem removes the</span>
<a href="#l21.33"></a><span id="l21.33">         // array elements while we are iterating through them. While we are at</span>
<a href="#l21.34"></a><span id="l21.34">         // it, filter out any items that have readonly calendars, so that</span>
<a href="#l21.35"></a><span id="l21.35">         // checking for one total item below also works out if all but one item</span>
<a href="#l21.36"></a><span id="l21.36">         // are readonly.</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-        var occurrences = aOccurrences.filter(function(item) { return isCalendarWritable(item.calendar); });</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+        let occurrences = aOccurrences.filter(function(item) { return isCalendarWritable(item.calendar); });</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40">         for (let itemToDelete of occurrences) {</span>
<a href="#l21.41"></a><span id="l21.41">             if (aUseParentItems) {</span>
<a href="#l21.42"></a><span id="l21.42">                 // Usually happens when ctrl-click is used. In that case we</span>
<a href="#l21.43"></a><span id="l21.43">                 // don't need to ask the user if he wants to delete an</span>
<a href="#l21.44"></a><span id="l21.44">                 // occurrence or not.</span>
<a href="#l21.45"></a><span id="l21.45">                 itemToDelete = itemToDelete.parentItem;</span>
<a href="#l21.46"></a><span id="l21.46">             } else if (!aDoNotConfirm &amp;&amp; occurrences.length == 1) {</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineat">@@ -134,29 +134,29 @@ var calendarViewController = {</span>
<a href="#l21.48"></a><span id="l21.48">                 itemToDelete = targetItem;</span>
<a href="#l21.49"></a><span id="l21.49">             }</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51">             // Now some dirty work: Make sure more than one occurrence can be</span>
<a href="#l21.52"></a><span id="l21.52">             // deleted by saving the recurring items and removing occurrences as</span>
<a href="#l21.53"></a><span id="l21.53">             // they come in. If this is not an occurrence, we can go ahead and</span>
<a href="#l21.54"></a><span id="l21.54">             // delete the whole item.</span>
<a href="#l21.55"></a><span id="l21.55">             if (itemToDelete.parentItem.hashId != itemToDelete.hashId) {</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-                var savedItem = getSavedItem(itemToDelete);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+                let savedItem = getSavedItem(itemToDelete);</span>
<a href="#l21.58"></a><span id="l21.58">                 savedItem.newItem.recurrenceInfo</span>
<a href="#l21.59"></a><span id="l21.59">                          .removeOccurrenceAt(itemToDelete.recurrenceId);</span>
<a href="#l21.60"></a><span id="l21.60">                 // Dont start the transaction yet. Do so later, in case the</span>
<a href="#l21.61"></a><span id="l21.61">                 // parent item gets modified more than once.</span>
<a href="#l21.62"></a><span id="l21.62">             } else {</span>
<a href="#l21.63"></a><span id="l21.63">                 doTransaction('delete', itemToDelete, itemToDelete.calendar, null, null);</span>
<a href="#l21.64"></a><span id="l21.64">             }</span>
<a href="#l21.65"></a><span id="l21.65">         }</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67">         // Now handle recurring events. This makes sure that all occurrences</span>
<a href="#l21.68"></a><span id="l21.68">         // that have been passed are deleted.</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-        for (var hashVal in recurringItems) {</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+        for (let hashVal in recurringItems) {</span>
<a href="#l21.71"></a><span id="l21.71">             let ritem = recurringItems[hashVal];</span>
<a href="#l21.72"></a><span id="l21.72">             doTransaction('modify',</span>
<a href="#l21.73"></a><span id="l21.73">                           ritem.newItem,</span>
<a href="#l21.74"></a><span id="l21.74">                           ritem.newItem.calendar,</span>
<a href="#l21.75"></a><span id="l21.75">                           ritem.oldItem,</span>
<a href="#l21.76"></a><span id="l21.76">                           null);</span>
<a href="#l21.77"></a><span id="l21.77">         }</span>
<a href="#l21.78"></a><span id="l21.78">         endBatchTransaction();</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineat">@@ -165,26 +165,26 @@ var calendarViewController = {</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81"> /**</span>
<a href="#l21.82"></a><span id="l21.82">  * This function does the common steps to switch between views. Should be called</span>
<a href="#l21.83"></a><span id="l21.83">  * from app-specific view switching functions</span>
<a href="#l21.84"></a><span id="l21.84">  *</span>
<a href="#l21.85"></a><span id="l21.85">  * @param aViewType     The type of view to select.</span>
<a href="#l21.86"></a><span id="l21.86">  */</span>
<a href="#l21.87"></a><span id="l21.87"> function switchToView(aViewType) {</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-    var viewDeck = getViewDeck();</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-    var selectedDay;</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-    var currentSelection = [];</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+    let viewDeck = getViewDeck();</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+    let selectedDay;</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+    let currentSelection = [];</span>
<a href="#l21.94"></a><span id="l21.94"> </span>
<a href="#l21.95"></a><span id="l21.95">     // Set up the view commands</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-    var views = viewDeck.childNodes;</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-    for (var i = 0; i &lt; views.length; i++) {</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+    let views = viewDeck.childNodes;</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+    for (let i = 0; i &lt; views.length; i++) {</span>
<a href="#l21.100"></a><span id="l21.100">         let view = views[i];</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-        var commandId = &quot;calendar_&quot; + view.id + &quot;_command&quot;;</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-        var command = document.getElementById(commandId);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+        let commandId = &quot;calendar_&quot; + view.id + &quot;_command&quot;;</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+        let command = document.getElementById(commandId);</span>
<a href="#l21.105"></a><span id="l21.105">         if (view.id == aViewType + &quot;-view&quot;) {</span>
<a href="#l21.106"></a><span id="l21.106">             command.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l21.107"></a><span id="l21.107">         } else {</span>
<a href="#l21.108"></a><span id="l21.108">             command.removeAttribute(&quot;checked&quot;);</span>
<a href="#l21.109"></a><span id="l21.109">         }</span>
<a href="#l21.110"></a><span id="l21.110">     }</span>
<a href="#l21.111"></a><span id="l21.111"> </span>
<a href="#l21.112"></a><span id="l21.112">     /**</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineat">@@ -289,32 +289,32 @@ var gMidnightTimer;</span>
<a href="#l21.114"></a><span id="l21.114">  *</span>
<a href="#l21.115"></a><span id="l21.115">  * XXX This function is not very usable, since there is only one midnight timer.</span>
<a href="#l21.116"></a><span id="l21.116">  * Better would be a function that uses the observer service to notify at</span>
<a href="#l21.117"></a><span id="l21.117">  * midnight.</span>
<a href="#l21.118"></a><span id="l21.118">  *</span>
<a href="#l21.119"></a><span id="l21.119">  * @param aRefreshCallback      A callback to be called at midnight.</span>
<a href="#l21.120"></a><span id="l21.120">  */</span>
<a href="#l21.121"></a><span id="l21.121"> function scheduleMidnightUpdate(aRefreshCallback) {</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-    var jsNow = new Date();</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineminus">-    var tomorrow = new Date(jsNow.getFullYear(), jsNow.getMonth(), jsNow.getDate() + 1);</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineminus">-    var msUntilTomorrow = tomorrow.getTime() - jsNow.getTime();</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+    let jsNow = new Date();</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+    let tomorrow = new Date(jsNow.getFullYear(), jsNow.getMonth(), jsNow.getDate() + 1);</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+    let msUntilTomorrow = tomorrow.getTime() - jsNow.getTime();</span>
<a href="#l21.128"></a><span id="l21.128"> </span>
<a href="#l21.129"></a><span id="l21.129">     // Is an nsITimer/callback extreme overkill here? Yes, but it's necessary to</span>
<a href="#l21.130"></a><span id="l21.130">     // workaround bug 291386.  If we don't, we stand a decent chance of getting</span>
<a href="#l21.131"></a><span id="l21.131">     // stuck in an infinite loop.</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineminus">-    var udCallback = {</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+    let udCallback = {</span>
<a href="#l21.134"></a><span id="l21.134">         notify: function(timer) {</span>
<a href="#l21.135"></a><span id="l21.135">             aRefreshCallback();</span>
<a href="#l21.136"></a><span id="l21.136">         }</span>
<a href="#l21.137"></a><span id="l21.137">     };</span>
<a href="#l21.138"></a><span id="l21.138"> </span>
<a href="#l21.139"></a><span id="l21.139">     if (!gMidnightTimer) {</span>
<a href="#l21.140"></a><span id="l21.140">         // Observer for wake after sleep/hibernate/standby to create new timers and refresh UI</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-        var wakeObserver = {</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+        let wakeObserver = {</span>
<a href="#l21.143"></a><span id="l21.143">            observe: function(aSubject, aTopic, aData) {</span>
<a href="#l21.144"></a><span id="l21.144">                if (aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l21.145"></a><span id="l21.145">                    // postpone refresh for another couple of seconds to get netwerk ready:</span>
<a href="#l21.146"></a><span id="l21.146">                    if (this.mTimer) {</span>
<a href="#l21.147"></a><span id="l21.147">                        this.mTimer.cancel();</span>
<a href="#l21.148"></a><span id="l21.148">                    } else {</span>
<a href="#l21.149"></a><span id="l21.149">                        this.mTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l21.150"></a><span id="l21.150">                                                .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineat">@@ -458,32 +458,32 @@ var categoryManagement = {</span>
<a href="#l21.152"></a><span id="l21.152"> /**</span>
<a href="#l21.153"></a><span id="l21.153">  * Handler function to set the selected day in the minimonth to the currently</span>
<a href="#l21.154"></a><span id="l21.154">  * selected day in the current view.</span>
<a href="#l21.155"></a><span id="l21.155">  *</span>
<a href="#l21.156"></a><span id="l21.156">  * @param event     The &quot;dayselect&quot; event emitted from the views.</span>
<a href="#l21.157"></a><span id="l21.157">  *</span>
<a href="#l21.158"></a><span id="l21.158">  */</span>
<a href="#l21.159"></a><span id="l21.159"> function observeViewDaySelect(event) {</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-    var date = event.detail;</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-    var jsDate = new Date(date.year, date.month, date.day);</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineplus">+    let date = event.detail;</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineplus">+    let jsDate = new Date(date.year, date.month, date.day);</span>
<a href="#l21.164"></a><span id="l21.164"> </span>
<a href="#l21.165"></a><span id="l21.165">     // for the month and multiweek view find the main month,</span>
<a href="#l21.166"></a><span id="l21.166">     // which is the month with the most visible days in the view;</span>
<a href="#l21.167"></a><span id="l21.167">     // note, that the main date is the first day of the main month</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-    var jsMainDate;</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineplus">+    let jsMainDate;</span>
<a href="#l21.170"></a><span id="l21.170">     if (!event.originalTarget.supportsDisjointDates) {</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-        var mainDate = null;</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineminus">-        var maxVisibleDays = 0;</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-        var startDay = currentView().startDay;</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-        var endDay = currentView().endDay;</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineminus">-        var firstMonth = startDay.startOfMonth;</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-        var lastMonth = endDay.startOfMonth;</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-        for (var month = firstMonth.clone(); month.compare(lastMonth) &lt;= 0; month.month += 1) {</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-            var visibleDays = 0;</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+        let mainDate = null;</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineplus">+        let maxVisibleDays = 0;</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+        let startDay = currentView().startDay;</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineplus">+        let endDay = currentView().endDay;</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+        let firstMonth = startDay.startOfMonth;</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineplus">+        let lastMonth = endDay.startOfMonth;</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+        for (let month = firstMonth.clone(); month.compare(lastMonth) &lt;= 0; month.month += 1) {</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineplus">+            let visibleDays = 0;</span>
<a href="#l21.187"></a><span id="l21.187">             if (month.compare(firstMonth) == 0) {</span>
<a href="#l21.188"></a><span id="l21.188">                 visibleDays = startDay.endOfMonth.day - startDay.day + 1;</span>
<a href="#l21.189"></a><span id="l21.189">             } else if (month.compare(lastMonth) == 0) {</span>
<a href="#l21.190"></a><span id="l21.190">                 visibleDays = endDay.day;</span>
<a href="#l21.191"></a><span id="l21.191">             } else {</span>
<a href="#l21.192"></a><span id="l21.192">                 visibleDays = month.endOfMonth.day;</span>
<a href="#l21.193"></a><span id="l21.193">             }</span>
<a href="#l21.194"></a><span id="l21.194">             if (visibleDays &gt; maxVisibleDays) {</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineat">@@ -507,75 +507,75 @@ function observeViewDaySelect(event) {</span>
<a href="#l21.196"></a><span id="l21.196"> function getMinimonth() {</span>
<a href="#l21.197"></a><span id="l21.197">     return document.getElementById(&quot;calMinimonth&quot;);</span>
<a href="#l21.198"></a><span id="l21.198"> }</span>
<a href="#l21.199"></a><span id="l21.199"> </span>
<a href="#l21.200"></a><span id="l21.200"> /**</span>
<a href="#l21.201"></a><span id="l21.201">  * Update the view orientation based on the checked state of the command</span>
<a href="#l21.202"></a><span id="l21.202">  */</span>
<a href="#l21.203"></a><span id="l21.203"> function toggleOrientation() {</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineminus">-    var cmd = document.getElementById(&quot;calendar_toggle_orientation_command&quot;);</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineminus">-    var newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineplus">+    let cmd = document.getElementById(&quot;calendar_toggle_orientation_command&quot;);</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineplus">+    let newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.208"></a><span id="l21.208">     cmd.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l21.209"></a><span id="l21.209"> </span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-    var deck = getViewDeck();</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-    for (var view of deck.childNodes) {</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineplus">+    let deck = getViewDeck();</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineplus">+    for (let view of deck.childNodes) {</span>
<a href="#l21.214"></a><span id="l21.214">         view.rotated = (newValue == &quot;true&quot;);</span>
<a href="#l21.215"></a><span id="l21.215">     }</span>
<a href="#l21.216"></a><span id="l21.216"> </span>
<a href="#l21.217"></a><span id="l21.217">     // orientation refreshes automatically</span>
<a href="#l21.218"></a><span id="l21.218"> }</span>
<a href="#l21.219"></a><span id="l21.219"> </span>
<a href="#l21.220"></a><span id="l21.220"> /**</span>
<a href="#l21.221"></a><span id="l21.221">  * Toggle the workdays only checkbox and refresh the current view</span>
<a href="#l21.222"></a><span id="l21.222">  *</span>
<a href="#l21.223"></a><span id="l21.223">  * XXX We shouldn't need to refresh the view just to toggle the workdays. This</span>
<a href="#l21.224"></a><span id="l21.224">  * should happen automatically.</span>
<a href="#l21.225"></a><span id="l21.225">  */</span>
<a href="#l21.226"></a><span id="l21.226"> function toggleWorkdaysOnly() {</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-    var cmd = document.getElementById(&quot;calendar_toggle_workdays_only_command&quot;);</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineminus">-    var newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineplus">+    let cmd = document.getElementById(&quot;calendar_toggle_workdays_only_command&quot;);</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineplus">+    let newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.231"></a><span id="l21.231">     cmd.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l21.232"></a><span id="l21.232"> </span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-    var deck = getViewDeck();</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-    for (var view of deck.childNodes) {</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineplus">+    let deck = getViewDeck();</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineplus">+    for (let view of deck.childNodes) {</span>
<a href="#l21.237"></a><span id="l21.237">         view.workdaysOnly = (newValue == &quot;true&quot;);</span>
<a href="#l21.238"></a><span id="l21.238">     }</span>
<a href="#l21.239"></a><span id="l21.239"> </span>
<a href="#l21.240"></a><span id="l21.240">     // Refresh the current view</span>
<a href="#l21.241"></a><span id="l21.241">     currentView().goToDay();</span>
<a href="#l21.242"></a><span id="l21.242"> }</span>
<a href="#l21.243"></a><span id="l21.243"> </span>
<a href="#l21.244"></a><span id="l21.244"> /**</span>
<a href="#l21.245"></a><span id="l21.245">  * Toggle the tasks in view checkbox and refresh the current view</span>
<a href="#l21.246"></a><span id="l21.246">  */</span>
<a href="#l21.247"></a><span id="l21.247"> function toggleTasksInView() {</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineminus">-    var cmd = document.getElementById(&quot;calendar_toggle_tasks_in_view_command&quot;);</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineminus">-    var newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineplus">+    let cmd = document.getElementById(&quot;calendar_toggle_tasks_in_view_command&quot;);</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineplus">+    let newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.252"></a><span id="l21.252">     cmd.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l21.253"></a><span id="l21.253"> </span>
<a href="#l21.254"></a><span id="l21.254" class="difflineminus">-    var deck = getViewDeck();</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineminus">-    for (var view of deck.childNodes) {</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineplus">+    let deck = getViewDeck();</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineplus">+    for (let view of deck.childNodes) {</span>
<a href="#l21.258"></a><span id="l21.258">         view.tasksInView = (newValue == &quot;true&quot;);</span>
<a href="#l21.259"></a><span id="l21.259">     }</span>
<a href="#l21.260"></a><span id="l21.260"> </span>
<a href="#l21.261"></a><span id="l21.261">     // Refresh the current view</span>
<a href="#l21.262"></a><span id="l21.262">     currentView().goToDay();</span>
<a href="#l21.263"></a><span id="l21.263"> }</span>
<a href="#l21.264"></a><span id="l21.264"> </span>
<a href="#l21.265"></a><span id="l21.265"> /**</span>
<a href="#l21.266"></a><span id="l21.266">  * Toggle the show completed in view checkbox and refresh the current view</span>
<a href="#l21.267"></a><span id="l21.267">  */</span>
<a href="#l21.268"></a><span id="l21.268"> function toggleShowCompletedInView() {</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-    var cmd = document.getElementById(&quot;calendar_toggle_show_completed_in_view_command&quot;);</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineminus">-    var newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineplus">+    let cmd = document.getElementById(&quot;calendar_toggle_show_completed_in_view_command&quot;);</span>
<a href="#l21.272"></a><span id="l21.272" class="difflineplus">+    let newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l21.273"></a><span id="l21.273">     cmd.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l21.274"></a><span id="l21.274"> </span>
<a href="#l21.275"></a><span id="l21.275" class="difflineminus">-    var deck = getViewDeck();</span>
<a href="#l21.276"></a><span id="l21.276" class="difflineminus">-    for (var view of deck.childNodes) {</span>
<a href="#l21.277"></a><span id="l21.277" class="difflineplus">+    let deck = getViewDeck();</span>
<a href="#l21.278"></a><span id="l21.278" class="difflineplus">+    for (let view of deck.childNodes) {</span>
<a href="#l21.279"></a><span id="l21.279">         view.showCompleted = (newValue == &quot;true&quot;);</span>
<a href="#l21.280"></a><span id="l21.280">     }</span>
<a href="#l21.281"></a><span id="l21.281"> </span>
<a href="#l21.282"></a><span id="l21.282">     // Refresh the current view</span>
<a href="#l21.283"></a><span id="l21.283">     currentView().goToDay();</span>
<a href="#l21.284"></a><span id="l21.284"> }</span>
<a href="#l21.285"></a><span id="l21.285"> </span>
<a href="#l21.286"></a><span id="l21.286"> /**</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineat">@@ -590,85 +590,85 @@ function goToDate(aDate) {</span>
<a href="#l21.288"></a><span id="l21.288"> </span>
<a href="#l21.289"></a><span id="l21.289"> /**</span>
<a href="#l21.290"></a><span id="l21.290">  * Returns the calendar view that was selected before restart, or the current</span>
<a href="#l21.291"></a><span id="l21.291">  * calendar view if it has already been set in this session</span>
<a href="#l21.292"></a><span id="l21.292">  *</span>
<a href="#l21.293"></a><span id="l21.293">  * @return          The last calendar view.</span>
<a href="#l21.294"></a><span id="l21.294">  */</span>
<a href="#l21.295"></a><span id="l21.295"> function getLastCalendarView() {</span>
<a href="#l21.296"></a><span id="l21.296" class="difflineminus">-    var deck = getViewDeck();</span>
<a href="#l21.297"></a><span id="l21.297" class="difflineplus">+    let deck = getViewDeck();</span>
<a href="#l21.298"></a><span id="l21.298">     if (deck.selectedIndex &gt; -1) {</span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-        var viewNode = deck.childNodes[deck.selectedIndex];</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineplus">+        let viewNode = deck.childNodes[deck.selectedIndex];</span>
<a href="#l21.301"></a><span id="l21.301">         return viewNode.id.replace(/-view/, &quot;&quot;);</span>
<a href="#l21.302"></a><span id="l21.302">     }</span>
<a href="#l21.303"></a><span id="l21.303"> </span>
<a href="#l21.304"></a><span id="l21.304">     // No deck item was selected beforehand, default to week view.</span>
<a href="#l21.305"></a><span id="l21.305">     return &quot;week&quot;;</span>
<a href="#l21.306"></a><span id="l21.306"> }</span>
<a href="#l21.307"></a><span id="l21.307"> </span>
<a href="#l21.308"></a><span id="l21.308"> /**</span>
<a href="#l21.309"></a><span id="l21.309">  * Deletes items currently selected in the view and clears selection.</span>
<a href="#l21.310"></a><span id="l21.310">  */</span>
<a href="#l21.311"></a><span id="l21.311"> function deleteSelectedEvents() {</span>
<a href="#l21.312"></a><span id="l21.312" class="difflineminus">-    var selectedItems = currentView().getSelectedItems({});</span>
<a href="#l21.313"></a><span id="l21.313" class="difflineplus">+    let selectedItems = currentView().getSelectedItems({});</span>
<a href="#l21.314"></a><span id="l21.314">     calendarViewController.deleteOccurrences(selectedItems.length,</span>
<a href="#l21.315"></a><span id="l21.315">                                              selectedItems,</span>
<a href="#l21.316"></a><span id="l21.316">                                              false,</span>
<a href="#l21.317"></a><span id="l21.317">                                              false);</span>
<a href="#l21.318"></a><span id="l21.318">     // clear selection</span>
<a href="#l21.319"></a><span id="l21.319">     currentView().setSelectedItems(0, [], true);</span>
<a href="#l21.320"></a><span id="l21.320"> }</span>
<a href="#l21.321"></a><span id="l21.321"> </span>
<a href="#l21.322"></a><span id="l21.322"> /**</span>
<a href="#l21.323"></a><span id="l21.323">  * Edit the items currently selected in the view with the event dialog.</span>
<a href="#l21.324"></a><span id="l21.324">  */</span>
<a href="#l21.325"></a><span id="l21.325"> function editSelectedEvents() {</span>
<a href="#l21.326"></a><span id="l21.326" class="difflineminus">-    var selectedItems = currentView().getSelectedItems({});</span>
<a href="#l21.327"></a><span id="l21.327" class="difflineplus">+    let selectedItems = currentView().getSelectedItems({});</span>
<a href="#l21.328"></a><span id="l21.328">     if (selectedItems &amp;&amp; selectedItems.length &gt;= 1) {</span>
<a href="#l21.329"></a><span id="l21.329">         modifyEventWithDialog(selectedItems[0], null, true);</span>
<a href="#l21.330"></a><span id="l21.330">     }</span>
<a href="#l21.331"></a><span id="l21.331"> }</span>
<a href="#l21.332"></a><span id="l21.332"> </span>
<a href="#l21.333"></a><span id="l21.333"> /**</span>
<a href="#l21.334"></a><span id="l21.334">  * Select all events from all calendars. Use with care.</span>
<a href="#l21.335"></a><span id="l21.335">  */</span>
<a href="#l21.336"></a><span id="l21.336"> function selectAllEvents() {</span>
<a href="#l21.337"></a><span id="l21.337" class="difflineminus">-    var items = [];</span>
<a href="#l21.338"></a><span id="l21.338" class="difflineminus">-    var listener = {</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineplus">+    let items = [];</span>
<a href="#l21.340"></a><span id="l21.340" class="difflineplus">+    let listener = {</span>
<a href="#l21.341"></a><span id="l21.341">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l21.342"></a><span id="l21.342">         onOperationComplete: function selectAll_ooc(aCalendar, aStatus,</span>
<a href="#l21.343"></a><span id="l21.343">                                                     aOperationType, aId,</span>
<a href="#l21.344"></a><span id="l21.344">                                                     aDetail) {</span>
<a href="#l21.345"></a><span id="l21.345">             currentView().setSelectedItems(items.length, items, false);</span>
<a href="#l21.346"></a><span id="l21.346">         },</span>
<a href="#l21.347"></a><span id="l21.347">         onGetResult: function selectAll_ogr(aCalendar, aStatus, aItemType,</span>
<a href="#l21.348"></a><span id="l21.348">                                             aDetail, aCount, aItems) {</span>
<a href="#l21.349"></a><span id="l21.349" class="difflineminus">-            for (var item of aItems) {</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineplus">+            for (let item of aItems) {</span>
<a href="#l21.351"></a><span id="l21.351">                 items.push(item);</span>
<a href="#l21.352"></a><span id="l21.352">             }</span>
<a href="#l21.353"></a><span id="l21.353">         }</span>
<a href="#l21.354"></a><span id="l21.354">     };</span>
<a href="#l21.355"></a><span id="l21.355"> </span>
<a href="#l21.356"></a><span id="l21.356" class="difflineminus">-    var composite = getCompositeCalendar();</span>
<a href="#l21.357"></a><span id="l21.357" class="difflineminus">-    var filter = composite.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l21.358"></a><span id="l21.358" class="difflineplus">+    let composite = getCompositeCalendar();</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineplus">+    let filter = composite.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l21.360"></a><span id="l21.360"> </span>
<a href="#l21.361"></a><span id="l21.361">     if (currentView().tasksInView) {</span>
<a href="#l21.362"></a><span id="l21.362">         filter |= composite.ITEM_FILTER_TYPE_ALL;</span>
<a href="#l21.363"></a><span id="l21.363">     } else {</span>
<a href="#l21.364"></a><span id="l21.364">         filter |= composite.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l21.365"></a><span id="l21.365">     }</span>
<a href="#l21.366"></a><span id="l21.366">     if (currentView().showCompleted) {</span>
<a href="#l21.367"></a><span id="l21.367">         filter |= composite.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l21.368"></a><span id="l21.368">     } else {</span>
<a href="#l21.369"></a><span id="l21.369">         filter |= composite.ITEM_FILTER_COMPLETED_NO;</span>
<a href="#l21.370"></a><span id="l21.370">     }</span>
<a href="#l21.371"></a><span id="l21.371"> </span>
<a href="#l21.372"></a><span id="l21.372">     // Need to move one day out to get all events</span>
<a href="#l21.373"></a><span id="l21.373" class="difflineminus">-    var end = currentView().endDay.clone();</span>
<a href="#l21.374"></a><span id="l21.374" class="difflineplus">+    let end = currentView().endDay.clone();</span>
<a href="#l21.375"></a><span id="l21.375">     end.day += 1;</span>
<a href="#l21.376"></a><span id="l21.376"> </span>
<a href="#l21.377"></a><span id="l21.377">     composite.getItems(filter, 0, currentView().startDay, end, listener);</span>
<a href="#l21.378"></a><span id="l21.378"> }</span>
<a href="#l21.379"></a><span id="l21.379"> </span>
<a href="#l21.380"></a><span id="l21.380"> var cal = cal || {};</span>
<a href="#l21.381"></a><span id="l21.381"> cal.navigationBar = {</span>
<a href="#l21.382"></a><span id="l21.382">     setDateRange: function setDateRange(aStartDate, aEndDate) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/calendar-views.xml</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.xml</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -37,17 +37,17 @@</span>
<a href="#l22.4"></a><span id="l22.4">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l22.5"></a><span id="l22.5">             &lt;/method&gt;</span>
<a href="#l22.6"></a><span id="l22.6">             &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l22.7"></a><span id="l22.7">                 &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l22.8"></a><span id="l22.8">                 &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.9"></a><span id="l22.9">                     if (!aNumber) {</span>
<a href="#l22.10"></a><span id="l22.10">                         this.goToDay(now());</span>
<a href="#l22.11"></a><span id="l22.11">                     } else {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-                        var currentDay = this.startDay.clone();</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+                        let currentDay = this.startDay.clone();</span>
<a href="#l22.14"></a><span id="l22.14">                         currentDay.day += aNumber;</span>
<a href="#l22.15"></a><span id="l22.15">                         this.goToDay(currentDay);</span>
<a href="#l22.16"></a><span id="l22.16">                     }</span>
<a href="#l22.17"></a><span id="l22.17">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l22.18"></a><span id="l22.18">             &lt;/method&gt;</span>
<a href="#l22.19"></a><span id="l22.19">         &lt;/implementation&gt;</span>
<a href="#l22.20"></a><span id="l22.20">     &lt;/binding&gt;</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -90,30 +90,30 @@</span>
<a href="#l22.23"></a><span id="l22.23">                 &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.24"></a><span id="l22.24">                     this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">                     if (!aDate) {</span>
<a href="#l22.27"></a><span id="l22.27">                         this.refresh();</span>
<a href="#l22.28"></a><span id="l22.28">                         return;</span>
<a href="#l22.29"></a><span id="l22.29">                     }</span>
<a href="#l22.30"></a><span id="l22.30">                     aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-                    var d1 = getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-                    var d2 = d1.clone();</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+                    let d1 = getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+                    let d2 = d1.clone();</span>
<a href="#l22.35"></a><span id="l22.35">                     d2.day += 6;</span>
<a href="#l22.36"></a><span id="l22.36">                     this.setDateRange(d1, d2);</span>
<a href="#l22.37"></a><span id="l22.37">                     this.selectedDay = aDate;</span>
<a href="#l22.38"></a><span id="l22.38">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l22.39"></a><span id="l22.39">             &lt;/method&gt;</span>
<a href="#l22.40"></a><span id="l22.40">             &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l22.41"></a><span id="l22.41">                 &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l22.42"></a><span id="l22.42">                 &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.43"></a><span id="l22.43">                     if (!aNumber) {</span>
<a href="#l22.44"></a><span id="l22.44">                         this.goToDay(now());</span>
<a href="#l22.45"></a><span id="l22.45">                     } else {</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-                        var d1 = this.selectedDay.clone();</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+                        let d1 = this.selectedDay.clone();</span>
<a href="#l22.48"></a><span id="l22.48">                         d1.day += 7 * aNumber;</span>
<a href="#l22.49"></a><span id="l22.49">                         this.goToDay(d1);</span>
<a href="#l22.50"></a><span id="l22.50">                     }</span>
<a href="#l22.51"></a><span id="l22.51">                 ]]&gt;&lt;/body&gt;</span>
<a href="#l22.52"></a><span id="l22.52">             &lt;/method&gt;</span>
<a href="#l22.53"></a><span id="l22.53">         &lt;/implementation&gt;</span>
<a href="#l22.54"></a><span id="l22.54">     &lt;/binding&gt;</span>
<a href="#l22.55"></a><span id="l22.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -29,17 +29,17 @@ function intializeTabOrWindowVariables()</span>
<a href="#l23.4"></a><span id="l23.4">     }</span>
<a href="#l23.5"></a><span id="l23.5"> }</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> /**</span>
<a href="#l23.8"></a><span id="l23.8">  * Dispose of controlling operations of this event dialog. Uses</span>
<a href="#l23.9"></a><span id="l23.9">  * window.arguments[0].job.dispose()</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> function dispose() {</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l23.14"></a><span id="l23.14">     if (args.job &amp;&amp; args.job.dispose) {</span>
<a href="#l23.15"></a><span id="l23.15">         args.job.dispose();</span>
<a href="#l23.16"></a><span id="l23.16">     }</span>
<a href="#l23.17"></a><span id="l23.17">     resetDialogId(document.documentElement);</span>
<a href="#l23.18"></a><span id="l23.18"> }</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> /**</span>
<a href="#l23.21"></a><span id="l23.21">  * Sets the id of a Dialog to another value to allow different window-icons to be displayed.</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -168,17 +168,17 @@ function updateReminderDetails() {</span>
<a href="#l23.23"></a><span id="l23.23">     let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l23.24"></a><span id="l23.24">     let reminderMultipleLabel = document.getElementById(&quot;reminder-multiple-alarms-label&quot;);</span>
<a href="#l23.25"></a><span id="l23.25">     let iconBox = document.getElementById(&quot;reminder-icon-box&quot;);</span>
<a href="#l23.26"></a><span id="l23.26">     let reminderSingleLabel = document.getElementById(&quot;reminder-single-alarms-label&quot;);</span>
<a href="#l23.27"></a><span id="l23.27">     let reminders = document.getElementById(&quot;reminder-custom-menuitem&quot;).reminders || [];</span>
<a href="#l23.28"></a><span id="l23.28">     let calendar = getCurrentCalendar();</span>
<a href="#l23.29"></a><span id="l23.29">     let actionValues = calendar.getProperty(&quot;capabilities.alarms.actionValues&quot;) || [&quot;DISPLAY&quot;];</span>
<a href="#l23.30"></a><span id="l23.30">     let actionMap = {};</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    for (var action of actionValues) {</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+    for (let action of actionValues) {</span>
<a href="#l23.33"></a><span id="l23.33">         actionMap[action] = true;</span>
<a href="#l23.34"></a><span id="l23.34">     }</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36">     // Filter out any unsupported action types.</span>
<a href="#l23.37"></a><span id="l23.37">     reminders = reminders.filter(x =&gt; x.action in actionMap);</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39">     if (reminderList.value == &quot;custom&quot;) {</span>
<a href="#l23.40"></a><span id="l23.40">         // Depending on how many alarms we have, show either the &quot;Multiple Alarms&quot;</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineat">@@ -497,42 +497,43 @@ function commonUpdateReminder(aSuppressD</span>
<a href="#l23.42"></a><span id="l23.42">     updateReminderDetails();</span>
<a href="#l23.43"></a><span id="l23.43"> }</span>
<a href="#l23.44"></a><span id="l23.44"> </span>
<a href="#l23.45"></a><span id="l23.45"> /**</span>
<a href="#l23.46"></a><span id="l23.46">  * Updates the related link on the dialog. Currently only used by the</span>
<a href="#l23.47"></a><span id="l23.47">  * read-only summary dialog.</span>
<a href="#l23.48"></a><span id="l23.48">  */</span>
<a href="#l23.49"></a><span id="l23.49"> function updateLink() {</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    var itemUrlString = window.calendarItem.getProperty(&quot;URL&quot;) || &quot;&quot;;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-    var linkCommand = document.getElementById(&quot;cmd_toggle_link&quot;);</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-</span>
<a href="#l23.53"></a><span id="l23.53">     function hideOrShow(aBool) {</span>
<a href="#l23.54"></a><span id="l23.54">         setElementValue(&quot;event-grid-link-row&quot;, !aBool &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-        var separator = document.getElementById(&quot;event-grid-link-separator&quot;);</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+        let separator = document.getElementById(&quot;event-grid-link-separator&quot;);</span>
<a href="#l23.57"></a><span id="l23.57">         if (separator) {</span>
<a href="#l23.58"></a><span id="l23.58">             // The separator is not there in the summary dialog</span>
<a href="#l23.59"></a><span id="l23.59">             setElementValue(&quot;event-grid-link-separator&quot;, !aBool &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l23.60"></a><span id="l23.60">         }</span>
<a href="#l23.61"></a><span id="l23.61">     }</span>
<a href="#l23.62"></a><span id="l23.62"> </span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+    let itemUrlString = window.calendarItem.getProperty(&quot;URL&quot;) || &quot;&quot;;</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+    let linkCommand = document.getElementById(&quot;cmd_toggle_link&quot;);</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+</span>
<a href="#l23.67"></a><span id="l23.67">     if (linkCommand) {</span>
<a href="#l23.68"></a><span id="l23.68">         // Disable if there is no url</span>
<a href="#l23.69"></a><span id="l23.69">         setElementValue(linkCommand,</span>
<a href="#l23.70"></a><span id="l23.70">                         !itemUrlString.length &amp;&amp; &quot;true&quot;,</span>
<a href="#l23.71"></a><span id="l23.71">                         &quot;disabled&quot;);</span>
<a href="#l23.72"></a><span id="l23.72">     }</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74">     if ((linkCommand &amp;&amp; linkCommand.getAttribute(&quot;checked&quot;) != &quot;true&quot;) ||</span>
<a href="#l23.75"></a><span id="l23.75">         !itemUrlString.length) {</span>
<a href="#l23.76"></a><span id="l23.76">         // Hide if there is no url, or the menuitem was chosen so that the url</span>
<a href="#l23.77"></a><span id="l23.77">         // should be hidden</span>
<a href="#l23.78"></a><span id="l23.78">         hideOrShow(false);</span>
<a href="#l23.79"></a><span id="l23.79">     } else {</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-        var handler, uri;</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+        let handler, uri;</span>
<a href="#l23.82"></a><span id="l23.82">         try {</span>
<a href="#l23.83"></a><span id="l23.83">             uri = makeURL(itemUrlString);</span>
<a href="#l23.84"></a><span id="l23.84">             handler = Services.io.getProtocolHandler(uri.scheme);</span>
<a href="#l23.85"></a><span id="l23.85">         } catch (e) {</span>
<a href="#l23.86"></a><span id="l23.86">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l23.87"></a><span id="l23.87">             hideOrShow(false);</span>
<a href="#l23.88"></a><span id="l23.88">             return;</span>
<a href="#l23.89"></a><span id="l23.89">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -33,20 +33,20 @@ function onLoad() {</span>
<a href="#l24.4"></a><span id="l24.4">     window.addEventListener(&quot;timebar&quot;, onTimebar, true);</span>
<a href="#l24.5"></a><span id="l24.5">     window.addEventListener(&quot;timechange&quot;, onTimeChange, true);</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7">     // As long as DOMMouseScroll is still implemented, we need to keep it</span>
<a href="#l24.8"></a><span id="l24.8">     // around to make sure scrolling is blocked.</span>
<a href="#l24.9"></a><span id="l24.9">     window.addEventListener(&quot;wheel&quot;, onMouseScroll, true);</span>
<a href="#l24.10"></a><span id="l24.10">     window.addEventListener(&quot;DOMMouseScroll&quot;, onMouseScroll, true);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-    var startTime = args.startTime;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-    var endTime = args.endTime;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-    var calendar = args.calendar;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+    let startTime = args.startTime;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+    let endTime = args.endTime;</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+    let calendar = args.calendar;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21">     gDisplayTimezone = args.displayTimezone;</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23">     onChangeCalendar(calendar);</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">     let zoom = document.getElementById(&quot;zoom-menulist&quot;);</span>
<a href="#l24.27"></a><span id="l24.27">     let zoomOut = document.getElementById(&quot;zoom-out-button&quot;);</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineat">@@ -82,35 +82,35 @@ function onLoad() {</span>
<a href="#l24.29"></a><span id="l24.29">     propagateDateTime();</span>
<a href="#l24.30"></a><span id="l24.30">     // Set the scroll bar at where the event is</span>
<a href="#l24.31"></a><span id="l24.31">     scrollToCurrentTime();</span>
<a href="#l24.32"></a><span id="l24.32">     updateButtons();</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34">     // we need to enforce several layout constraints which can't be modelled</span>
<a href="#l24.35"></a><span id="l24.35">     // with plain xul and css, at least as far as i know.</span>
<a href="#l24.36"></a><span id="l24.36">     const kStylesheet = &quot;chrome://calendar/skin/calendar-event-dialog.css&quot;;</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    for (var stylesheet of document.styleSheets) {</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    for (let stylesheet of document.styleSheets) {</span>
<a href="#l24.39"></a><span id="l24.39">         if (stylesheet.href == kStylesheet) {</span>
<a href="#l24.40"></a><span id="l24.40">             // make the dummy-spacer #1 [top] the same height as the timebar</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-            var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+            let timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.43"></a><span id="l24.43">             stylesheet.insertRule(</span>
<a href="#l24.44"></a><span id="l24.44">                 &quot;.attendee-spacer-top { height: &quot;</span>
<a href="#l24.45"></a><span id="l24.45">                     + timebar.boxObject.height + &quot;px; }&quot;, 0);</span>
<a href="#l24.46"></a><span id="l24.46">             // make the dummy-spacer #2 [bottom] the same height as the scrollbar</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-            var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+            let scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.49"></a><span id="l24.49">             stylesheet.insertRule(</span>
<a href="#l24.50"></a><span id="l24.50">                 &quot;.attendee-spacer-bottom { height: &quot;</span>
<a href="#l24.51"></a><span id="l24.51">                     + scrollbar.boxObject.height + &quot;px; }&quot;, 0);</span>
<a href="#l24.52"></a><span id="l24.52">             break;</span>
<a href="#l24.53"></a><span id="l24.53">         }</span>
<a href="#l24.54"></a><span id="l24.54">     }</span>
<a href="#l24.55"></a><span id="l24.55"> </span>
<a href="#l24.56"></a><span id="l24.56">     // attach an observer to get notified of changes</span>
<a href="#l24.57"></a><span id="l24.57">     // that are relevant to this dialog.</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-    var prefObserver = {</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+    let prefObserver = {</span>
<a href="#l24.60"></a><span id="l24.60">         observe: function aD_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l24.61"></a><span id="l24.61">             switch (aPrefName) {</span>
<a href="#l24.62"></a><span id="l24.62">                 case &quot;calendar.view.daystarthour&quot;:</span>
<a href="#l24.63"></a><span id="l24.63">                 case &quot;calendar.view.dayendhour&quot;:</span>
<a href="#l24.64"></a><span id="l24.64">                     initTimeRange();</span>
<a href="#l24.65"></a><span id="l24.65">                     propagateDateTime();</span>
<a href="#l24.66"></a><span id="l24.66">                     break;</span>
<a href="#l24.67"></a><span id="l24.67">             }</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineat">@@ -129,17 +129,17 @@ function onLoad() {</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70"> /**</span>
<a href="#l24.71"></a><span id="l24.71">  * This function should be called when the accept button was pressed on the</span>
<a href="#l24.72"></a><span id="l24.72">  * attendee dialog. Calls the accept function specified in the window arguments.</span>
<a href="#l24.73"></a><span id="l24.73">  *</span>
<a href="#l24.74"></a><span id="l24.74">  * @return      Returns true, if the dialog should be closed.</span>
<a href="#l24.75"></a><span id="l24.75">  */</span>
<a href="#l24.76"></a><span id="l24.76"> function onAccept() {</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-    var attendees = document.getElementById(&quot;attendees-list&quot;);</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+    let attendees = document.getElementById(&quot;attendees-list&quot;);</span>
<a href="#l24.79"></a><span id="l24.79">     window.arguments[0].onOk(</span>
<a href="#l24.80"></a><span id="l24.80">         attendees.attendees,</span>
<a href="#l24.81"></a><span id="l24.81">         attendees.organizer,</span>
<a href="#l24.82"></a><span id="l24.82">         gStartDate.getInTimezone(gStartTimezone),</span>
<a href="#l24.83"></a><span id="l24.83">         gEndDate.getInTimezone(gEndTimezone));</span>
<a href="#l24.84"></a><span id="l24.84">     return true;</span>
<a href="#l24.85"></a><span id="l24.85"> }</span>
<a href="#l24.86"></a><span id="l24.86"> </span>
<a href="#l24.87"></a><span id="l24.87" class="difflineat">@@ -172,61 +172,61 @@ function zoomWithButtons(aZoomOut) {</span>
<a href="#l24.88"></a><span id="l24.88">  * Loads the passed start and end dates, fills global variables that give</span>
<a href="#l24.89"></a><span id="l24.89">  * information about the state of the dialog.</span>
<a href="#l24.90"></a><span id="l24.90">  *</span>
<a href="#l24.91"></a><span id="l24.91">  * @param aStartDate        The date/time the grid should start at.</span>
<a href="#l24.92"></a><span id="l24.92">  * @param aEndDate          The date/time the grid should end at.</span>
<a href="#l24.93"></a><span id="l24.93">  */</span>
<a href="#l24.94"></a><span id="l24.94"> function loadDateTime(aStartDate, aEndDate) {</span>
<a href="#l24.95"></a><span id="l24.95">     gDuration = aEndDate.subtractDate(aStartDate);</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.98"></a><span id="l24.98">     gStartTimezone = aStartDate.timezone;</span>
<a href="#l24.99"></a><span id="l24.99">     gEndTimezone = aEndDate.timezone;</span>
<a href="#l24.100"></a><span id="l24.100">     gStartDate = aStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.101"></a><span id="l24.101">     gEndDate = aEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.102"></a><span id="l24.102">     gStartDate.makeImmutable();</span>
<a href="#l24.103"></a><span id="l24.103">     gEndDate.makeImmutable();</span>
<a href="#l24.104"></a><span id="l24.104"> }</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106"> /**</span>
<a href="#l24.107"></a><span id="l24.107">  * Sets up the time grid using the global start and end dates.</span>
<a href="#l24.108"></a><span id="l24.108">  */</span>
<a href="#l24.109"></a><span id="l24.109"> function propagateDateTime() {</span>
<a href="#l24.110"></a><span id="l24.110">     // Fill the controls</span>
<a href="#l24.111"></a><span id="l24.111">     updateDateTime();</span>
<a href="#l24.112"></a><span id="l24.112"> </span>
<a href="#l24.113"></a><span id="l24.113">     // Tell the timebar about the new start/enddate</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-    var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+    let timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.116"></a><span id="l24.116">     timebar.startDate = gStartDate;</span>
<a href="#l24.117"></a><span id="l24.117">     timebar.endDate = gEndDate;</span>
<a href="#l24.118"></a><span id="l24.118">     timebar.refresh();</span>
<a href="#l24.119"></a><span id="l24.119"> </span>
<a href="#l24.120"></a><span id="l24.120">     // Tell the selection-bar about the new start/enddate</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-    var selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+    let selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l24.123"></a><span id="l24.123">     selectionbar.startDate = gStartDate;</span>
<a href="#l24.124"></a><span id="l24.124">     selectionbar.endDate = gEndDate;</span>
<a href="#l24.125"></a><span id="l24.125">     selectionbar.update();</span>
<a href="#l24.126"></a><span id="l24.126"> </span>
<a href="#l24.127"></a><span id="l24.127">     // Tell the freebusy grid about the new start/enddate</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-    var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+    let grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.130"></a><span id="l24.130"> </span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-    var refresh = (grid.startDate == null) ||</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+    let refresh = (grid.startDate == null) ||</span>
<a href="#l24.133"></a><span id="l24.133">                   (grid.startDate.compare(gStartDate) != 0) ||</span>
<a href="#l24.134"></a><span id="l24.134">                   (grid.endDate == null) ||</span>
<a href="#l24.135"></a><span id="l24.135">                   (grid.endDate.compare(gEndDate) != 0);</span>
<a href="#l24.136"></a><span id="l24.136">     grid.startDate = gStartDate;</span>
<a href="#l24.137"></a><span id="l24.137">     grid.endDate = gEndDate;</span>
<a href="#l24.138"></a><span id="l24.138">     if (refresh) {</span>
<a href="#l24.139"></a><span id="l24.139">         grid.forceRefresh();</span>
<a href="#l24.140"></a><span id="l24.140">     }</span>
<a href="#l24.141"></a><span id="l24.141"> </span>
<a href="#l24.142"></a><span id="l24.142">     // Expand to 24hrs if the new range is outside of the default range.</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-    var startTime = gStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-    var endTime = gEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+    let startTime = gStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+    let endTime = gEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.149"></a><span id="l24.149">     if ((startTime.hour &lt; gStartHour) ||</span>
<a href="#l24.150"></a><span id="l24.150">         (startTime.hour &gt;= gEndHour) ||</span>
<a href="#l24.151"></a><span id="l24.151">         (endTime.hour &gt;= gEndHour) ||</span>
<a href="#l24.152"></a><span id="l24.152">         (startTime.day != endTime.day) ||</span>
<a href="#l24.153"></a><span id="l24.153">         (startTime.isDate)) {</span>
<a href="#l24.154"></a><span id="l24.154">         setForce24Hours(true);</span>
<a href="#l24.155"></a><span id="l24.155">     }</span>
<a href="#l24.156"></a><span id="l24.156"> }</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineat">@@ -297,26 +297,26 @@ function updateDateTime() {</span>
<a href="#l24.158"></a><span id="l24.158">  * This function requires gStartDate and gEndDate and the respective timezone</span>
<a href="#l24.159"></a><span id="l24.159">  * variables to be initialized. It updates the timezone information displayed in</span>
<a href="#l24.160"></a><span id="l24.160">  * the dialog from the above noted variables.</span>
<a href="#l24.161"></a><span id="l24.161">  */</span>
<a href="#l24.162"></a><span id="l24.162"> function updateTimezone() {</span>
<a href="#l24.163"></a><span id="l24.163">     gIgnoreUpdate = true;</span>
<a href="#l24.164"></a><span id="l24.164"> </span>
<a href="#l24.165"></a><span id="l24.165">     if (gDisplayTimezone) {</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-        var startTimezone = gStartTimezone;</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-        var endTimezone = gEndTimezone;</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-        var equalTimezones = false;</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+        let startTimezone = gStartTimezone;</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+        let endTimezone = gEndTimezone;</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+        let equalTimezones = false;</span>
<a href="#l24.172"></a><span id="l24.172">         if (startTimezone &amp;&amp; endTimezone &amp;&amp;</span>
<a href="#l24.173"></a><span id="l24.173">             (compareObjects(startTimezone, endTimezone) || endTimezone.isUTC)) {</span>
<a href="#l24.174"></a><span id="l24.174">             equalTimezones = true;</span>
<a href="#l24.175"></a><span id="l24.175">         }</span>
<a href="#l24.176"></a><span id="l24.176"> </span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-        var tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-        var tzEnd = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+        let tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+        let tzEnd = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l24.181"></a><span id="l24.181">         if (startTimezone != null) {</span>
<a href="#l24.182"></a><span id="l24.182">             tzStart.removeAttribute('collapsed');</span>
<a href="#l24.183"></a><span id="l24.183">             tzStart.value = startTimezone.displayName || startTimezone.tzid;</span>
<a href="#l24.184"></a><span id="l24.184">         } else {</span>
<a href="#l24.185"></a><span id="l24.185">             tzStart.setAttribute('collapsed', 'true');</span>
<a href="#l24.186"></a><span id="l24.186">         }</span>
<a href="#l24.187"></a><span id="l24.187"> </span>
<a href="#l24.188"></a><span id="l24.188">         // we never display the second timezone if both are equal</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineat">@@ -373,85 +373,85 @@ function updateStartTime() {</span>
<a href="#l24.190"></a><span id="l24.190"> /**</span>
<a href="#l24.191"></a><span id="l24.191">  * Updates gEndDate from the end time picker &quot;event-endtime&quot;</span>
<a href="#l24.192"></a><span id="l24.192">  */</span>
<a href="#l24.193"></a><span id="l24.193"> function updateEndTime() {</span>
<a href="#l24.194"></a><span id="l24.194">     if (gIgnoreUpdate) {</span>
<a href="#l24.195"></a><span id="l24.195">         return;</span>
<a href="#l24.196"></a><span id="l24.196">     }</span>
<a href="#l24.197"></a><span id="l24.197"> </span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-    var startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-    var endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineplus">+    let startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineplus">+    let endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l24.202"></a><span id="l24.202"> </span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-    var startWidget = document.getElementById(startWidgetId);</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-    var endWidget = document.getElementById(endWidgetId);</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+    let startWidget = document.getElementById(startWidgetId);</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+    let endWidget = document.getElementById(endWidgetId);</span>
<a href="#l24.207"></a><span id="l24.207"> </span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-    var saveStartTime = gStartDate;</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineminus">-    var saveEndTime = gEndDate;</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+    let saveStartTime = gStartDate;</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+    let saveEndTime = gEndDate;</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l24.214"></a><span id="l24.214"> </span>
<a href="#l24.215"></a><span id="l24.215">     gStartDate = cal.jsDateToDateTime(startWidget.value,</span>
<a href="#l24.216"></a><span id="l24.216">                                   gDisplayTimezone ? gStartTimezone : calendarDefaultTimezone());</span>
<a href="#l24.217"></a><span id="l24.217"> </span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-    var timezone = gEndTimezone;</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineplus">+    let timezone = gEndTimezone;</span>
<a href="#l24.220"></a><span id="l24.220">     if (timezone.isUTC &amp;&amp;</span>
<a href="#l24.221"></a><span id="l24.221">         gStartDate &amp;&amp;</span>
<a href="#l24.222"></a><span id="l24.222">         !compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l24.223"></a><span id="l24.223">         timezone = gStartTimezone;</span>
<a href="#l24.224"></a><span id="l24.224">     }</span>
<a href="#l24.225"></a><span id="l24.225">     gEndDate = cal.jsDateToDateTime(endWidget.value,</span>
<a href="#l24.226"></a><span id="l24.226">                                     gDisplayTimezone ? timezone : kDefaultTimezone);</span>
<a href="#l24.227"></a><span id="l24.227"> </span>
<a href="#l24.228"></a><span id="l24.228" class="difflineminus">-    var allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-    var allDay = allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+    let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+    let allDay = allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l24.232"></a><span id="l24.232">     if (allDay) {</span>
<a href="#l24.233"></a><span id="l24.233">         gStartDate.isDate = true;</span>
<a href="#l24.234"></a><span id="l24.234">         gEndDate.isDate = true;</span>
<a href="#l24.235"></a><span id="l24.235">     }</span>
<a href="#l24.236"></a><span id="l24.236"> </span>
<a href="#l24.237"></a><span id="l24.237">     // Calculate the new duration of start/end-time.</span>
<a href="#l24.238"></a><span id="l24.238">     // don't allow for negative durations.</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-    var warning = false;</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineplus">+    let warning = false;</span>
<a href="#l24.241"></a><span id="l24.241">     if (gEndDate.compare(gStartDate) &gt;= 0) {</span>
<a href="#l24.242"></a><span id="l24.242">         gDuration = gEndDate.subtractDate(gStartDate);</span>
<a href="#l24.243"></a><span id="l24.243">     } else {</span>
<a href="#l24.244"></a><span id="l24.244">         gStartDate = saveStartTime;</span>
<a href="#l24.245"></a><span id="l24.245">         gEndDate = saveEndTime;</span>
<a href="#l24.246"></a><span id="l24.246">         warning = true;</span>
<a href="#l24.247"></a><span id="l24.247">     }</span>
<a href="#l24.248"></a><span id="l24.248"> </span>
<a href="#l24.249"></a><span id="l24.249">     propagateDateTime();</span>
<a href="#l24.250"></a><span id="l24.250"> </span>
<a href="#l24.251"></a><span id="l24.251">     if (warning) {</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineminus">-        var callback = function() {</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineplus">+        let callback = function() {</span>
<a href="#l24.254"></a><span id="l24.254">             Services.prompt.alert(</span>
<a href="#l24.255"></a><span id="l24.255">                 null,</span>
<a href="#l24.256"></a><span id="l24.256">                 document.title,</span>
<a href="#l24.257"></a><span id="l24.257">                 calGetString(&quot;calendar&quot;, &quot;warningEndBeforeStart&quot;));</span>
<a href="#l24.258"></a><span id="l24.258">         };</span>
<a href="#l24.259"></a><span id="l24.259">         setTimeout(callback, 1);</span>
<a href="#l24.260"></a><span id="l24.260">     }</span>
<a href="#l24.261"></a><span id="l24.261"> }</span>
<a href="#l24.262"></a><span id="l24.262"> </span>
<a href="#l24.263"></a><span id="l24.263"> /**</span>
<a href="#l24.264"></a><span id="l24.264">  * Prompts the user to pick a new timezone for the starttime. The dialog is</span>
<a href="#l24.265"></a><span id="l24.265">  * opened modally.</span>
<a href="#l24.266"></a><span id="l24.266">  */</span>
<a href="#l24.267"></a><span id="l24.267"> function editStartTimezone() {</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-    var tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineplus">+    let tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l24.270"></a><span id="l24.270">     if (tzStart.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l24.271"></a><span id="l24.271">         return;</span>
<a href="#l24.272"></a><span id="l24.272">     }</span>
<a href="#l24.273"></a><span id="l24.273"> </span>
<a href="#l24.274"></a><span id="l24.274" class="difflineminus">-    var self = this;</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-    var args = {};</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineplus">+    let self = this;</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineplus">+    let args = {};</span>
<a href="#l24.278"></a><span id="l24.278">     args.calendar = window.arguments[0].calendar;</span>
<a href="#l24.279"></a><span id="l24.279">     args.time = gStartDate.getInTimezone(gStartTimezone);</span>
<a href="#l24.280"></a><span id="l24.280">     args.onOk = function(datetime) {</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-        var equalTimezones = false;</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineplus">+        let equalTimezones = false;</span>
<a href="#l24.283"></a><span id="l24.283">         if (gStartTimezone &amp;&amp; gEndTimezone &amp;&amp;</span>
<a href="#l24.284"></a><span id="l24.284">             compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l24.285"></a><span id="l24.285">             equalTimezones = true;</span>
<a href="#l24.286"></a><span id="l24.286">         }</span>
<a href="#l24.287"></a><span id="l24.287">         gStartTimezone = datetime.timezone;</span>
<a href="#l24.288"></a><span id="l24.288">         if (equalTimezones) {</span>
<a href="#l24.289"></a><span id="l24.289">             gEndTimezone = datetime.timezone;</span>
<a href="#l24.290"></a><span id="l24.290">         }</span>
<a href="#l24.291"></a><span id="l24.291" class="difflineat">@@ -466,23 +466,23 @@ function editStartTimezone() {</span>
<a href="#l24.292"></a><span id="l24.292">         args);</span>
<a href="#l24.293"></a><span id="l24.293"> }</span>
<a href="#l24.294"></a><span id="l24.294"> </span>
<a href="#l24.295"></a><span id="l24.295"> /**</span>
<a href="#l24.296"></a><span id="l24.296">  * Prompts the user to pick a new timezone for the endtime. The dialog is</span>
<a href="#l24.297"></a><span id="l24.297">  * opened modally.</span>
<a href="#l24.298"></a><span id="l24.298">  */</span>
<a href="#l24.299"></a><span id="l24.299"> function editEndTimezone() {</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-    var tzStart = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineplus">+    let tzStart = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l24.302"></a><span id="l24.302">     if (tzStart.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l24.303"></a><span id="l24.303">         return;</span>
<a href="#l24.304"></a><span id="l24.304">     }</span>
<a href="#l24.305"></a><span id="l24.305"> </span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-    var self = this;</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineminus">-    var args = {};</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineplus">+    let self = this;</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineplus">+    let args = {};</span>
<a href="#l24.310"></a><span id="l24.310">     args.calendar = window.arguments[0].calendar;</span>
<a href="#l24.311"></a><span id="l24.311">     args.time = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l24.312"></a><span id="l24.312">     args.onOk = function(datetime) {</span>
<a href="#l24.313"></a><span id="l24.313">         if (gStartTimezone &amp;&amp; gEndTimezone &amp;&amp;</span>
<a href="#l24.314"></a><span id="l24.314">             compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l24.315"></a><span id="l24.315">             gStartTimezone = datetime.timezone;</span>
<a href="#l24.316"></a><span id="l24.316">         }</span>
<a href="#l24.317"></a><span id="l24.317">         gEndTimezone = datetime.timezone;</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineat">@@ -503,23 +503,23 @@ function editEndTimezone() {</span>
<a href="#l24.319"></a><span id="l24.319">  *</span>
<a href="#l24.320"></a><span id="l24.320">  * This for example disables the timepicker since its not needed.</span>
<a href="#l24.321"></a><span id="l24.321">  */</span>
<a href="#l24.322"></a><span id="l24.322"> function updateAllDay() {</span>
<a href="#l24.323"></a><span id="l24.323">     if (gIgnoreUpdate) {</span>
<a href="#l24.324"></a><span id="l24.324">         return;</span>
<a href="#l24.325"></a><span id="l24.325">     }</span>
<a href="#l24.326"></a><span id="l24.326"> </span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-    var allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineminus">-    var allDay = (allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineminus">-    var startpicker = document.getElementById(&quot;event-starttime&quot;);</span>
<a href="#l24.330"></a><span id="l24.330" class="difflineminus">-    var endpicker = document.getElementById(&quot;event-endtime&quot;);</span>
<a href="#l24.331"></a><span id="l24.331" class="difflineplus">+    let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineplus">+    let allDay = (allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineplus">+    let startpicker = document.getElementById(&quot;event-starttime&quot;);</span>
<a href="#l24.334"></a><span id="l24.334" class="difflineplus">+    let endpicker = document.getElementById(&quot;event-endtime&quot;);</span>
<a href="#l24.335"></a><span id="l24.335"> </span>
<a href="#l24.336"></a><span id="l24.336" class="difflineminus">-    var tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineminus">-    var tzEnd = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineplus">+    let tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineplus">+    let tzEnd = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l24.340"></a><span id="l24.340"> </span>
<a href="#l24.341"></a><span id="l24.341">     // Disable the timezone links if 'allday' is checked OR the</span>
<a href="#l24.342"></a><span id="l24.342">     // calendar of this item is read-only. In any other case we</span>
<a href="#l24.343"></a><span id="l24.343">     // enable the links.</span>
<a href="#l24.344"></a><span id="l24.344">     if (allDay) {</span>
<a href="#l24.345"></a><span id="l24.345">         startpicker.setAttribute(&quot;timepickerdisabled&quot;, &quot;true&quot;);</span>
<a href="#l24.346"></a><span id="l24.346">         endpicker.setAttribute(&quot;timepickerdisabled&quot;, &quot;true&quot;);</span>
<a href="#l24.347"></a><span id="l24.347"> </span>
<a href="#l24.348"></a><span id="l24.348" class="difflineat">@@ -539,31 +539,31 @@ function updateAllDay() {</span>
<a href="#l24.349"></a><span id="l24.349"> }</span>
<a href="#l24.350"></a><span id="l24.350"> </span>
<a href="#l24.351"></a><span id="l24.351"> /**</span>
<a href="#l24.352"></a><span id="l24.352">  * Changes the global variables to adapt for the change of the allday checkbox.</span>
<a href="#l24.353"></a><span id="l24.353">  *</span>
<a href="#l24.354"></a><span id="l24.354">  * XXX Function names are all very similar here. This needs some consistency!</span>
<a href="#l24.355"></a><span id="l24.355">  */</span>
<a href="#l24.356"></a><span id="l24.356"> function changeAllDay() {</span>
<a href="#l24.357"></a><span id="l24.357" class="difflineminus">-    var allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l24.358"></a><span id="l24.358" class="difflineminus">-    var allDay = (allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineplus">+    let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineplus">+    let allDay = (allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l24.361"></a><span id="l24.361"> </span>
<a href="#l24.362"></a><span id="l24.362">     gStartDate = gStartDate.clone();</span>
<a href="#l24.363"></a><span id="l24.363">     gEndDate = gEndDate.clone();</span>
<a href="#l24.364"></a><span id="l24.364"> </span>
<a href="#l24.365"></a><span id="l24.365">     gStartDate.isDate = allDay;</span>
<a href="#l24.366"></a><span id="l24.366">     gEndDate.isDate = allDay;</span>
<a href="#l24.367"></a><span id="l24.367"> </span>
<a href="#l24.368"></a><span id="l24.368">     propagateDateTime();</span>
<a href="#l24.369"></a><span id="l24.369"> </span>
<a href="#l24.370"></a><span id="l24.370">     // After propagating the modified times we enforce some constraints</span>
<a href="#l24.371"></a><span id="l24.371">     // on the zoom-factor. In case this events is now said to be all-day,</span>
<a href="#l24.372"></a><span id="l24.372">     // we automatically enforce a 25% zoom-factor and disable the control.</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineminus">-    var zoom = document.getElementById(&quot;zoom-menulist&quot;);</span>
<a href="#l24.374"></a><span id="l24.374" class="difflineplus">+    let zoom = document.getElementById(&quot;zoom-menulist&quot;);</span>
<a href="#l24.375"></a><span id="l24.375">     let zoomOut = document.getElementById(&quot;zoom-out-button&quot;);</span>
<a href="#l24.376"></a><span id="l24.376">     let zoomIn = document.getElementById(&quot;zoom-in-button&quot;);</span>
<a href="#l24.377"></a><span id="l24.377">     if (allDay) {</span>
<a href="#l24.378"></a><span id="l24.378">         zoom.value = &quot;400&quot;;</span>
<a href="#l24.379"></a><span id="l24.379">         zoom.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l24.380"></a><span id="l24.380">         zoomOut.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l24.381"></a><span id="l24.381">         zoomIn.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l24.382"></a><span id="l24.382">         setZoomFactor(zoom.value);</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineat">@@ -639,46 +639,46 @@ function onChangeCalendar(calendar) {</span>
<a href="#l24.384"></a><span id="l24.384">     let freebusy = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.385"></a><span id="l24.385">     freebusy.onChangeCalendar(calendar);</span>
<a href="#l24.386"></a><span id="l24.386"> }</span>
<a href="#l24.387"></a><span id="l24.387"> </span>
<a href="#l24.388"></a><span id="l24.388"> /**</span>
<a href="#l24.389"></a><span id="l24.389">  * Updates the slot buttons.</span>
<a href="#l24.390"></a><span id="l24.390">  */</span>
<a href="#l24.391"></a><span id="l24.391"> function updateButtons() {</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineminus">-    var previousButton = document.getElementById(&quot;previous-slot&quot;);</span>
<a href="#l24.393"></a><span id="l24.393" class="difflineplus">+    let previousButton = document.getElementById(&quot;previous-slot&quot;);</span>
<a href="#l24.394"></a><span id="l24.394">     if (gUndoStack.length &gt; 0) {</span>
<a href="#l24.395"></a><span id="l24.395">         previousButton.removeAttribute('disabled');</span>
<a href="#l24.396"></a><span id="l24.396">     } else {</span>
<a href="#l24.397"></a><span id="l24.397">         previousButton.setAttribute('disabled', 'true');</span>
<a href="#l24.398"></a><span id="l24.398">     }</span>
<a href="#l24.399"></a><span id="l24.399"> }</span>
<a href="#l24.400"></a><span id="l24.400"> </span>
<a href="#l24.401"></a><span id="l24.401"> /**</span>
<a href="#l24.402"></a><span id="l24.402">  * Handler function called to advance to the next slot.</span>
<a href="#l24.403"></a><span id="l24.403">  */</span>
<a href="#l24.404"></a><span id="l24.404"> function onNextSlot() {</span>
<a href="#l24.405"></a><span id="l24.405">     // Store the current setting in the undo-stack.</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineminus">-    var currentSlot = {};</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineplus">+    let currentSlot = {};</span>
<a href="#l24.408"></a><span id="l24.408">     currentSlot.startTime = gStartDate;</span>
<a href="#l24.409"></a><span id="l24.409">     currentSlot.endTime = gEndDate;</span>
<a href="#l24.410"></a><span id="l24.410">     gUndoStack.push(currentSlot);</span>
<a href="#l24.411"></a><span id="l24.411"> </span>
<a href="#l24.412"></a><span id="l24.412">     // Ask the grid for the next possible timeslot.</span>
<a href="#l24.413"></a><span id="l24.413" class="difflineminus">-    var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineminus">-    var duration = gEndDate.subtractDate(gStartDate);</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineminus">-    var start = grid.nextSlot();</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-    var end = start.clone();</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineplus">+    let grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineplus">+    let duration = gEndDate.subtractDate(gStartDate);</span>
<a href="#l24.419"></a><span id="l24.419" class="difflineplus">+    let start = grid.nextSlot();</span>
<a href="#l24.420"></a><span id="l24.420" class="difflineplus">+    let end = start.clone();</span>
<a href="#l24.421"></a><span id="l24.421">     end.addDuration(duration);</span>
<a href="#l24.422"></a><span id="l24.422">     if (start.isDate) {</span>
<a href="#l24.423"></a><span id="l24.423">         end.day++;</span>
<a href="#l24.424"></a><span id="l24.424">     }</span>
<a href="#l24.425"></a><span id="l24.425">     gStartDate = start.clone();</span>
<a href="#l24.426"></a><span id="l24.426">     gEndDate = end.clone();</span>
<a href="#l24.427"></a><span id="l24.427" class="difflineminus">-    var endDate = gEndDate.clone();</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineplus">+    let endDate = gEndDate.clone();</span>
<a href="#l24.429"></a><span id="l24.429"> </span>
<a href="#l24.430"></a><span id="l24.430">     // Check if an all-day event has been passed in (to adapt endDate).</span>
<a href="#l24.431"></a><span id="l24.431">     if (gStartDate.isDate) {</span>
<a href="#l24.432"></a><span id="l24.432">         gEndDate.day--;</span>
<a href="#l24.433"></a><span id="l24.433">     }</span>
<a href="#l24.434"></a><span id="l24.434">     gStartDate.makeImmutable();</span>
<a href="#l24.435"></a><span id="l24.435">     gEndDate.makeImmutable();</span>
<a href="#l24.436"></a><span id="l24.436">     endDate.makeImmutable();</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineat">@@ -690,59 +690,59 @@ function onNextSlot() {</span>
<a href="#l24.438"></a><span id="l24.438"> </span>
<a href="#l24.439"></a><span id="l24.439">     updateButtons();</span>
<a href="#l24.440"></a><span id="l24.440"> }</span>
<a href="#l24.441"></a><span id="l24.441"> </span>
<a href="#l24.442"></a><span id="l24.442"> /**</span>
<a href="#l24.443"></a><span id="l24.443">  * Handler function called to advance to the previous slot.</span>
<a href="#l24.444"></a><span id="l24.444">  */</span>
<a href="#l24.445"></a><span id="l24.445"> function onPreviousSlot() {</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineminus">-    var previousSlot = gUndoStack.pop();</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+    let previousSlot = gUndoStack.pop();</span>
<a href="#l24.448"></a><span id="l24.448">     if (!previousSlot) {</span>
<a href="#l24.449"></a><span id="l24.449">         return;</span>
<a href="#l24.450"></a><span id="l24.450">     }</span>
<a href="#l24.451"></a><span id="l24.451"> </span>
<a href="#l24.452"></a><span id="l24.452">     // In case the new starttime happens to be scheduled</span>
<a href="#l24.453"></a><span id="l24.453">     // on a different day, we also need to update the</span>
<a href="#l24.454"></a><span id="l24.454">     // complete freebusy informations and appropriate</span>
<a href="#l24.455"></a><span id="l24.455">     // underlying arrays holding the information.</span>
<a href="#l24.456"></a><span id="l24.456" class="difflineminus">-    var refresh = previousSlot.startTime.day != gStartDate.day;</span>
<a href="#l24.457"></a><span id="l24.457" class="difflineplus">+    let refresh = previousSlot.startTime.day != gStartDate.day;</span>
<a href="#l24.458"></a><span id="l24.458"> </span>
<a href="#l24.459"></a><span id="l24.459">     gStartDate = previousSlot.startTime.clone();</span>
<a href="#l24.460"></a><span id="l24.460">     gEndDate = previousSlot.endTime.clone();</span>
<a href="#l24.461"></a><span id="l24.461" class="difflineminus">-    var endDate = gEndDate.clone();</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineplus">+    let endDate = gEndDate.clone();</span>
<a href="#l24.463"></a><span id="l24.463"> </span>
<a href="#l24.464"></a><span id="l24.464">     propagateDateTime();</span>
<a href="#l24.465"></a><span id="l24.465"> </span>
<a href="#l24.466"></a><span id="l24.466">     // scroll the grid/timebar such that the current time is visible</span>
<a href="#l24.467"></a><span id="l24.467">     scrollToCurrentTime();</span>
<a href="#l24.468"></a><span id="l24.468"> </span>
<a href="#l24.469"></a><span id="l24.469">     updateButtons();</span>
<a href="#l24.470"></a><span id="l24.470"> </span>
<a href="#l24.471"></a><span id="l24.471">     if (refresh) {</span>
<a href="#l24.472"></a><span id="l24.472" class="difflineminus">-        var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.473"></a><span id="l24.473" class="difflineplus">+        let grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.474"></a><span id="l24.474">         grid.forceRefresh();</span>
<a href="#l24.475"></a><span id="l24.475">     }</span>
<a href="#l24.476"></a><span id="l24.476"> }</span>
<a href="#l24.477"></a><span id="l24.477"> </span>
<a href="#l24.478"></a><span id="l24.478"> /**</span>
<a href="#l24.479"></a><span id="l24.479">  * Scrolls the time grid to a position where the time of the item in question is</span>
<a href="#l24.480"></a><span id="l24.480">  * visible.</span>
<a href="#l24.481"></a><span id="l24.481">  */</span>
<a href="#l24.482"></a><span id="l24.482"> function scrollToCurrentTime() {</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineminus">-    var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineminus">-    var ratio = (gStartDate.hour - gStartHour - 1) * timebar.step;</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineplus">+    let timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineplus">+    let ratio = (gStartDate.hour - gStartHour - 1) * timebar.step;</span>
<a href="#l24.487"></a><span id="l24.487">     if (ratio &lt;= 0.0) {</span>
<a href="#l24.488"></a><span id="l24.488">         ratio = 0.0;</span>
<a href="#l24.489"></a><span id="l24.489">     }</span>
<a href="#l24.490"></a><span id="l24.490">     if (ratio &gt;= 1.0) {</span>
<a href="#l24.491"></a><span id="l24.491">         ratio = 1.0;</span>
<a href="#l24.492"></a><span id="l24.492">     }</span>
<a href="#l24.493"></a><span id="l24.493" class="difflineminus">-    var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineminus">-    var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineplus">+    let scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineplus">+    let maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.497"></a><span id="l24.497">     scrollbar.setAttribute(&quot;curpos&quot;, ratio * maxpos);</span>
<a href="#l24.498"></a><span id="l24.498"> }</span>
<a href="#l24.499"></a><span id="l24.499"> </span>
<a href="#l24.500"></a><span id="l24.500"> </span>
<a href="#l24.501"></a><span id="l24.501"> /**</span>
<a href="#l24.502"></a><span id="l24.502">  * Sets the zoom factor for the time grid</span>
<a href="#l24.503"></a><span id="l24.503">  *</span>
<a href="#l24.504"></a><span id="l24.504">  * @param aValue        The zoom factor to set.</span>
<a href="#l24.505"></a><span id="l24.505" class="difflineat">@@ -760,33 +760,33 @@ function setZoomFactor(aValue) {</span>
<a href="#l24.506"></a><span id="l24.506">     applyCurrentZoomFactor();</span>
<a href="#l24.507"></a><span id="l24.507">     return aValue;</span>
<a href="#l24.508"></a><span id="l24.508"> }</span>
<a href="#l24.509"></a><span id="l24.509"> </span>
<a href="#l24.510"></a><span id="l24.510"> /**</span>
<a href="#l24.511"></a><span id="l24.511">  * applies the current zoom factor for the time grid</span>
<a href="#l24.512"></a><span id="l24.512">  */</span>
<a href="#l24.513"></a><span id="l24.513"> function applyCurrentZoomFactor() {</span>
<a href="#l24.514"></a><span id="l24.514" class="difflineminus">-    var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.515"></a><span id="l24.515" class="difflineplus">+    let timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.516"></a><span id="l24.516">     timebar.zoomFactor = gZoomFactor;</span>
<a href="#l24.517"></a><span id="l24.517" class="difflineminus">-    var selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l24.518"></a><span id="l24.518" class="difflineplus">+    let selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l24.519"></a><span id="l24.519">     selectionbar.zoomFactor = gZoomFactor;</span>
<a href="#l24.520"></a><span id="l24.520" class="difflineminus">-    var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.521"></a><span id="l24.521" class="difflineplus">+    let grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.522"></a><span id="l24.522">     grid.zoomFactor = gZoomFactor;</span>
<a href="#l24.523"></a><span id="l24.523"> </span>
<a href="#l24.524"></a><span id="l24.524">     // Calling onResize() will update the scrollbars and everything else</span>
<a href="#l24.525"></a><span id="l24.525">     // that needs to adopt the previously made changes. We need to call</span>
<a href="#l24.526"></a><span id="l24.526">     // this after the changes have actually been made...</span>
<a href="#l24.527"></a><span id="l24.527">     onResize();</span>
<a href="#l24.528"></a><span id="l24.528"> </span>
<a href="#l24.529"></a><span id="l24.529" class="difflineminus">-    var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.530"></a><span id="l24.530" class="difflineplus">+    let scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.531"></a><span id="l24.531">     if (scrollbar.hasAttribute(&quot;maxpos&quot;)) {</span>
<a href="#l24.532"></a><span id="l24.532" class="difflineminus">-        var curpos = scrollbar.getAttribute(&quot;curpos&quot;);</span>
<a href="#l24.533"></a><span id="l24.533" class="difflineminus">-        var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.534"></a><span id="l24.534" class="difflineminus">-        var ratio = curpos / maxpos;</span>
<a href="#l24.535"></a><span id="l24.535" class="difflineplus">+        let curpos = scrollbar.getAttribute(&quot;curpos&quot;);</span>
<a href="#l24.536"></a><span id="l24.536" class="difflineplus">+        let maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.537"></a><span id="l24.537" class="difflineplus">+        let ratio = curpos / maxpos;</span>
<a href="#l24.538"></a><span id="l24.538">         timebar.scroll = ratio;</span>
<a href="#l24.539"></a><span id="l24.539">         grid.scroll = ratio;</span>
<a href="#l24.540"></a><span id="l24.540">         selectionbar.ratio = ratio;</span>
<a href="#l24.541"></a><span id="l24.541">     }</span>
<a href="#l24.542"></a><span id="l24.542"> }</span>
<a href="#l24.543"></a><span id="l24.543"> </span>
<a href="#l24.544"></a><span id="l24.544"> /**</span>
<a href="#l24.545"></a><span id="l24.545">  * Force the time grid to show 24 hours.</span>
<a href="#l24.546"></a><span id="l24.546" class="difflineat">@@ -796,35 +796,35 @@ function applyCurrentZoomFactor() {</span>
<a href="#l24.547"></a><span id="l24.547">  */</span>
<a href="#l24.548"></a><span id="l24.548"> function setForce24Hours(aValue) {</span>
<a href="#l24.549"></a><span id="l24.549">     if (gForce24Hours == aValue) {</span>
<a href="#l24.550"></a><span id="l24.550">       return aValue;</span>
<a href="#l24.551"></a><span id="l24.551">     }</span>
<a href="#l24.552"></a><span id="l24.552"> </span>
<a href="#l24.553"></a><span id="l24.553">     gForce24Hours = aValue;</span>
<a href="#l24.554"></a><span id="l24.554">     initTimeRange();</span>
<a href="#l24.555"></a><span id="l24.555" class="difflineminus">-    var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.556"></a><span id="l24.556" class="difflineplus">+    let timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.557"></a><span id="l24.557">     timebar.force24Hours = gForce24Hours;</span>
<a href="#l24.558"></a><span id="l24.558" class="difflineminus">-    var selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l24.559"></a><span id="l24.559" class="difflineplus">+    let selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l24.560"></a><span id="l24.560">     selectionbar.force24Hours = gForce24Hours;</span>
<a href="#l24.561"></a><span id="l24.561" class="difflineminus">-    var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.562"></a><span id="l24.562" class="difflineplus">+    let grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.563"></a><span id="l24.563">     grid.force24Hours = gForce24Hours;</span>
<a href="#l24.564"></a><span id="l24.564"> </span>
<a href="#l24.565"></a><span id="l24.565">     // Calling onResize() will update the scrollbars and everything else</span>
<a href="#l24.566"></a><span id="l24.566">     // that needs to adopt the previously made changes. We need to call</span>
<a href="#l24.567"></a><span id="l24.567">     // this after the changes have actually been made...</span>
<a href="#l24.568"></a><span id="l24.568">     onResize();</span>
<a href="#l24.569"></a><span id="l24.569"> </span>
<a href="#l24.570"></a><span id="l24.570" class="difflineminus">-    var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.571"></a><span id="l24.571" class="difflineplus">+    let scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l24.572"></a><span id="l24.572">     if (!scrollbar.hasAttribute(&quot;maxpos&quot;)) {</span>
<a href="#l24.573"></a><span id="l24.573">         return aValue;</span>
<a href="#l24.574"></a><span id="l24.574">     }</span>
<a href="#l24.575"></a><span id="l24.575" class="difflineminus">-    var curpos = scrollbar.getAttribute(&quot;curpos&quot;);</span>
<a href="#l24.576"></a><span id="l24.576" class="difflineminus">-    var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.577"></a><span id="l24.577" class="difflineminus">-    var ratio = curpos / maxpos;</span>
<a href="#l24.578"></a><span id="l24.578" class="difflineplus">+    let curpos = scrollbar.getAttribute(&quot;curpos&quot;);</span>
<a href="#l24.579"></a><span id="l24.579" class="difflineplus">+    let maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.580"></a><span id="l24.580" class="difflineplus">+    let ratio = curpos / maxpos;</span>
<a href="#l24.581"></a><span id="l24.581">     timebar.scroll = ratio;</span>
<a href="#l24.582"></a><span id="l24.582">     grid.scroll = ratio;</span>
<a href="#l24.583"></a><span id="l24.583">     selectionbar.ratio = ratio;</span>
<a href="#l24.584"></a><span id="l24.584"> </span>
<a href="#l24.585"></a><span id="l24.585">     return aValue;</span>
<a href="#l24.586"></a><span id="l24.586"> }</span>
<a href="#l24.587"></a><span id="l24.587"> </span>
<a href="#l24.588"></a><span id="l24.588"> /**</span>
<a href="#l24.589"></a><span id="l24.589" class="difflineat">@@ -856,19 +856,19 @@ function onModify(event) {</span>
<a href="#l24.590"></a><span id="l24.590"> </span>
<a href="#l24.591"></a><span id="l24.591"> /**</span>
<a href="#l24.592"></a><span id="l24.592">  * Handler function for the &quot;rowchange&quot; event, emitted from the attendees-list</span>
<a href="#l24.593"></a><span id="l24.593">  * binding. event.details is the row that was changed to.</span>
<a href="#l24.594"></a><span id="l24.594">  *</span>
<a href="#l24.595"></a><span id="l24.595">  * @param event     The DOM event caused by the row change.</span>
<a href="#l24.596"></a><span id="l24.596">  */</span>
<a href="#l24.597"></a><span id="l24.597"> function onRowChange(event) {</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineminus">-    var scrollbar = document.getElementById(&quot;vertical-scrollbar&quot;);</span>
<a href="#l24.599"></a><span id="l24.599" class="difflineminus">-    var attendees = document.getElementById(&quot;attendees-list&quot;);</span>
<a href="#l24.600"></a><span id="l24.600" class="difflineminus">-    var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.601"></a><span id="l24.601" class="difflineplus">+    let scrollbar = document.getElementById(&quot;vertical-scrollbar&quot;);</span>
<a href="#l24.602"></a><span id="l24.602" class="difflineplus">+    let attendees = document.getElementById(&quot;attendees-list&quot;);</span>
<a href="#l24.603"></a><span id="l24.603" class="difflineplus">+    let maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l24.604"></a><span id="l24.604">     scrollbar.setAttribute(</span>
<a href="#l24.605"></a><span id="l24.605">         &quot;curpos&quot;,</span>
<a href="#l24.606"></a><span id="l24.606">         event.details / attendees.mMaxAttendees * maxpos);</span>
<a href="#l24.607"></a><span id="l24.607"> }</span>
<a href="#l24.608"></a><span id="l24.608"> </span>
<a href="#l24.609"></a><span id="l24.609"> /**</span>
<a href="#l24.610"></a><span id="l24.610">  * Handler function to take care of mouse scrolling on the window</span>
<a href="#l24.611"></a><span id="l24.611">  *</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineat">@@ -952,34 +952,34 @@ function onTimebar(event) {</span>
<a href="#l24.613"></a><span id="l24.613"> /**</span>
<a href="#l24.614"></a><span id="l24.614">  * Handler function to update controls when the time has changed on the</span>
<a href="#l24.615"></a><span id="l24.615">  * selection bar.</span>
<a href="#l24.616"></a><span id="l24.616">  *</span>
<a href="#l24.617"></a><span id="l24.617">  * @param event     The &quot;timechange&quot; event with startDate and endDate</span>
<a href="#l24.618"></a><span id="l24.618">  *                    properties.</span>
<a href="#l24.619"></a><span id="l24.619">  */</span>
<a href="#l24.620"></a><span id="l24.620"> function onTimeChange(event) {</span>
<a href="#l24.621"></a><span id="l24.621" class="difflineminus">-    var start = event.startDate.getInTimezone(gStartTimezone);</span>
<a href="#l24.622"></a><span id="l24.622" class="difflineminus">-    var end = event.endDate.getInTimezone(gEndTimezone);</span>
<a href="#l24.623"></a><span id="l24.623" class="difflineplus">+    let start = event.startDate.getInTimezone(gStartTimezone);</span>
<a href="#l24.624"></a><span id="l24.624" class="difflineplus">+    let end = event.endDate.getInTimezone(gEndTimezone);</span>
<a href="#l24.625"></a><span id="l24.625"> </span>
<a href="#l24.626"></a><span id="l24.626">     loadDateTime(start, end);</span>
<a href="#l24.627"></a><span id="l24.627"> </span>
<a href="#l24.628"></a><span id="l24.628">     // fill the controls</span>
<a href="#l24.629"></a><span id="l24.629">     updateDateTime();</span>
<a href="#l24.630"></a><span id="l24.630"> </span>
<a href="#l24.631"></a><span id="l24.631">     // tell the timebar about the new start/enddate</span>
<a href="#l24.632"></a><span id="l24.632" class="difflineminus">-    var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.633"></a><span id="l24.633" class="difflineplus">+    let timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l24.634"></a><span id="l24.634">     timebar.startDate = gStartDate;</span>
<a href="#l24.635"></a><span id="l24.635">     timebar.endDate = gEndDate;</span>
<a href="#l24.636"></a><span id="l24.636">     timebar.refresh();</span>
<a href="#l24.637"></a><span id="l24.637"> </span>
<a href="#l24.638"></a><span id="l24.638">     // tell the freebusy grid about the new start/enddate</span>
<a href="#l24.639"></a><span id="l24.639" class="difflineminus">-    var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.640"></a><span id="l24.640" class="difflineplus">+    let grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l24.641"></a><span id="l24.641"> </span>
<a href="#l24.642"></a><span id="l24.642" class="difflineminus">-    var refresh = (grid.startDate == null) ||</span>
<a href="#l24.643"></a><span id="l24.643" class="difflineplus">+    let refresh = (grid.startDate == null) ||</span>
<a href="#l24.644"></a><span id="l24.644">                   (grid.startDate.compare(gStartDate) != 0) ||</span>
<a href="#l24.645"></a><span id="l24.645">                   (grid.endDate == null) ||</span>
<a href="#l24.646"></a><span id="l24.646">                   (grid.endDate.compare(gEndDate) != 0);</span>
<a href="#l24.647"></a><span id="l24.647">     grid.startDate = gStartDate;</span>
<a href="#l24.648"></a><span id="l24.648">     grid.endDate = gEndDate;</span>
<a href="#l24.649"></a><span id="l24.649">     if (refresh) {</span>
<a href="#l24.650"></a><span id="l24.650">         grid.forceRefresh();</span>
<a href="#l24.651"></a><span id="l24.651">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -66,68 +66,68 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.6"></a><span id="l25.6">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.7"></a><span id="l25.7">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.8"></a><span id="l25.8">         Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10">         this.mMaxAttendees = 0;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-        var self = this;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-        var load = function loadHandler() {</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+        let self = this;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+        let load = function loadHandler() {</span>
<a href="#l25.16"></a><span id="l25.16">             self.onLoad();</span>
<a href="#l25.17"></a><span id="l25.17">         };</span>
<a href="#l25.18"></a><span id="l25.18">         window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l25.19"></a><span id="l25.19">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l25.22"></a><span id="l25.22">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-          var listbox =</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+          let listbox =</span>
<a href="#l25.25"></a><span id="l25.25">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.26"></a><span id="l25.26">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-          var template =</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+          let template =</span>
<a href="#l25.29"></a><span id="l25.29">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.30"></a><span id="l25.30">                   this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32">           this.onInitialize();</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34">           // this trigger the continous update chain, which</span>
<a href="#l25.35"></a><span id="l25.35">           // effectively calls this.onModify() on predefined</span>
<a href="#l25.36"></a><span id="l25.36">           // time intervals [each second].</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-          var self = this;</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-          var callback = function() {</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+          let self = this;</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+          let callback = function() {</span>
<a href="#l25.41"></a><span id="l25.41">               setTimeout(callback, 1000);</span>
<a href="#l25.42"></a><span id="l25.42">               self.onModify();</span>
<a href="#l25.43"></a><span id="l25.43">           };</span>
<a href="#l25.44"></a><span id="l25.44">           callback();</span>
<a href="#l25.45"></a><span id="l25.45">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.46"></a><span id="l25.46">       &lt;/method&gt;</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48">       &lt;method name=&quot;onInitialize&quot;&gt;</span>
<a href="#l25.49"></a><span id="l25.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-          var args = window.arguments[0];</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-          var organizer = args.organizer;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-          var attendees = args.attendees;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-          var calendar = args.calendar;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+          let args = window.arguments[0];</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+          let organizer = args.organizer;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+          let attendees = args.attendees;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+          let calendar = args.calendar;</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59">           this.mIsReadOnly = calendar.readOnly;</span>
<a href="#l25.60"></a><span id="l25.60"> </span>
<a href="#l25.61"></a><span id="l25.61">           // assume we're the organizer [in case that the calendar</span>
<a href="#l25.62"></a><span id="l25.62">           // does not support the concept of identities].</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-          var organizerID = ((organizer &amp;&amp; organizer.id)</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+          let organizerID = ((organizer &amp;&amp; organizer.id)</span>
<a href="#l25.65"></a><span id="l25.65">                              ? organizer.id</span>
<a href="#l25.66"></a><span id="l25.66">                              : calendar.getProperty(&quot;organizerId&quot;));</span>
<a href="#l25.67"></a><span id="l25.67"> </span>
<a href="#l25.68"></a><span id="l25.68">           calendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l25.69"></a><span id="l25.69">           this.mIsInvitation = (calendar &amp;&amp; calendar.isInvitation(args.item));</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-          var listbox =</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+          let listbox =</span>
<a href="#l25.73"></a><span id="l25.73">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.74"></a><span id="l25.74">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-          var template =</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+          let template =</span>
<a href="#l25.77"></a><span id="l25.77">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.78"></a><span id="l25.78">                   this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l25.79"></a><span id="l25.79">           template.focus();</span>
<a href="#l25.80"></a><span id="l25.80"> </span>
<a href="#l25.81"></a><span id="l25.81">           if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l25.82"></a><span id="l25.82">               listbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l25.83"></a><span id="l25.83">           }</span>
<a href="#l25.84"></a><span id="l25.84"> </span>
<a href="#l25.85"></a><span id="l25.85" class="difflineat">@@ -153,19 +153,19 @@</span>
<a href="#l25.86"></a><span id="l25.86">               }</span>
<a href="#l25.87"></a><span id="l25.87">               if (!organizer.commonName || !organizer.commonName.length) {</span>
<a href="#l25.88"></a><span id="l25.88">                   organizer.commonName = calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l25.89"></a><span id="l25.89">               }</span>
<a href="#l25.90"></a><span id="l25.90">               organizer.isOrganizer = true;</span>
<a href="#l25.91"></a><span id="l25.91">               this.appendAttendee(organizer, listbox, template, true);</span>
<a href="#l25.92"></a><span id="l25.92">           }</span>
<a href="#l25.93"></a><span id="l25.93"> </span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-          var numRowsAdded = 0;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+          let numRowsAdded = 0;</span>
<a href="#l25.96"></a><span id="l25.96">           if (attendees.length &gt; 0) {</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-              for (var attendee of attendees) {</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+              for (let attendee of attendees) {</span>
<a href="#l25.99"></a><span id="l25.99">                   this.appendAttendee(attendee, listbox, template, false);</span>
<a href="#l25.100"></a><span id="l25.100">                   numRowsAdded++;</span>
<a href="#l25.101"></a><span id="l25.101">               }</span>
<a href="#l25.102"></a><span id="l25.102">           }</span>
<a href="#l25.103"></a><span id="l25.103">           if (numRowsAdded == 0) {</span>
<a href="#l25.104"></a><span id="l25.104">               this.appendAttendee(null, listbox, template, false);</span>
<a href="#l25.105"></a><span id="l25.105">           }</span>
<a href="#l25.106"></a><span id="l25.106"> </span>
<a href="#l25.107"></a><span id="l25.107" class="difflineat">@@ -180,25 +180,25 @@</span>
<a href="#l25.108"></a><span id="l25.108">       &lt;!-- appends a new row using an existing attendee structure --&gt;</span>
<a href="#l25.109"></a><span id="l25.109">       &lt;method name=&quot;appendAttendee&quot;&gt;</span>
<a href="#l25.110"></a><span id="l25.110">         &lt;parameter name=&quot;aAttendee&quot;/&gt;</span>
<a href="#l25.111"></a><span id="l25.111">         &lt;parameter name=&quot;aParentNode&quot;/&gt;</span>
<a href="#l25.112"></a><span id="l25.112">         &lt;parameter name=&quot;aTemplateNode&quot;/&gt;</span>
<a href="#l25.113"></a><span id="l25.113">         &lt;parameter name=&quot;aDisableIfOrganizer&quot;/&gt;</span>
<a href="#l25.114"></a><span id="l25.114">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.115"></a><span id="l25.115">           // create a new listbox item and append it to our parent control.</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-          var newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+          let newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l25.118"></a><span id="l25.118"> </span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-          var input =</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+          let input =</span>
<a href="#l25.121"></a><span id="l25.121">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.122"></a><span id="l25.122">                   newNode, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-          var roleStatusIcon =</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+          let roleStatusIcon =</span>
<a href="#l25.125"></a><span id="l25.125">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.126"></a><span id="l25.126">                   newNode, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-          var userTypeIcon =</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+          let userTypeIcon =</span>
<a href="#l25.129"></a><span id="l25.129">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.130"></a><span id="l25.130">                   newNode, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l25.131"></a><span id="l25.131"> </span>
<a href="#l25.132"></a><span id="l25.132">           // We always clone the first row. The problem is that the first row</span>
<a href="#l25.133"></a><span id="l25.133">           // could be focused. When we clone that row, we end up with a cloned</span>
<a href="#l25.134"></a><span id="l25.134">           // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l25.135"></a><span id="l25.135">           // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l25.136"></a><span id="l25.136">           // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineat">@@ -225,17 +225,17 @@</span>
<a href="#l25.138"></a><span id="l25.138"> </span>
<a href="#l25.139"></a><span id="l25.139">           // disable the input-field [name &lt;email&gt;] if this attendee</span>
<a href="#l25.140"></a><span id="l25.140">           // appears to be the organizer.</span>
<a href="#l25.141"></a><span id="l25.141">           if (aDisableIfOrganizer &amp;&amp; aAttendee &amp;&amp; aAttendee.isOrganizer) {</span>
<a href="#l25.142"></a><span id="l25.142">               input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l25.143"></a><span id="l25.143">           }</span>
<a href="#l25.144"></a><span id="l25.144"> </span>
<a href="#l25.145"></a><span id="l25.145">           this.mMaxAttendees++;</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-          var rowNumber = this.mMaxAttendees;</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+          let rowNumber = this.mMaxAttendees;</span>
<a href="#l25.148"></a><span id="l25.148">           if (rowNumber &gt;= 0) {</span>
<a href="#l25.149"></a><span id="l25.149">               roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l25.150"></a><span id="l25.150">               userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l25.151"></a><span id="l25.151">               input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l25.152"></a><span id="l25.152">           }</span>
<a href="#l25.153"></a><span id="l25.153"> </span>
<a href="#l25.154"></a><span id="l25.154">           if (!aAttendee) {</span>
<a href="#l25.155"></a><span id="l25.155">               aAttendee = this.createAttendee();</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineat">@@ -284,59 +284,59 @@</span>
<a href="#l25.157"></a><span id="l25.157">           return true;</span>
<a href="#l25.158"></a><span id="l25.158">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.159"></a><span id="l25.159">       &lt;/method&gt;</span>
<a href="#l25.160"></a><span id="l25.160"> </span>
<a href="#l25.161"></a><span id="l25.161">       &lt;method name=&quot;appendNewRow&quot;&gt;</span>
<a href="#l25.162"></a><span id="l25.162">         &lt;parameter name=&quot;aSetFocus&quot;/&gt;</span>
<a href="#l25.163"></a><span id="l25.163">         &lt;parameter name=&quot;aInsertAfter&quot;/&gt;</span>
<a href="#l25.164"></a><span id="l25.164">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-          var listbox =</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+          let listbox =</span>
<a href="#l25.167"></a><span id="l25.167">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.168"></a><span id="l25.168">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-          var listitem1 = this.getListItem(1);</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineminus">-          var newNode = null;</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineplus">+          let listitem1 = this.getListItem(1);</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineplus">+          let newNode = null;</span>
<a href="#l25.173"></a><span id="l25.173"> </span>
<a href="#l25.174"></a><span id="l25.174">           if (listbox &amp;&amp; listitem1) {</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-              var newAttendee = this.createAttendee();</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-              var nextDummy = this.getNextDummyRow();</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+              let newAttendee = this.createAttendee();</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+              let nextDummy = this.getNextDummyRow();</span>
<a href="#l25.179"></a><span id="l25.179">               newNode = listitem1.cloneNode(true);</span>
<a href="#l25.180"></a><span id="l25.180"> </span>
<a href="#l25.181"></a><span id="l25.181">               if (aInsertAfter) {</span>
<a href="#l25.182"></a><span id="l25.182">                   listbox.insertBefore(newNode, aInsertAfter.nextSibling);</span>
<a href="#l25.183"></a><span id="l25.183">               } else if (nextDummy) {</span>
<a href="#l25.184"></a><span id="l25.184">                   listbox.replaceChild(newNode, nextDummy);</span>
<a href="#l25.185"></a><span id="l25.185">               } else {</span>
<a href="#l25.186"></a><span id="l25.186">                   listbox.appendChild(newNode);</span>
<a href="#l25.187"></a><span id="l25.187">               }</span>
<a href="#l25.188"></a><span id="l25.188"> </span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-              var input =</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+              let input =</span>
<a href="#l25.191"></a><span id="l25.191">                   document.getAnonymousElementByAttribute(</span>
<a href="#l25.192"></a><span id="l25.192">                       newNode, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineminus">-              var roleStatusIcon =</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+              let roleStatusIcon =</span>
<a href="#l25.195"></a><span id="l25.195">                   document.getAnonymousElementByAttribute(</span>
<a href="#l25.196"></a><span id="l25.196">                       newNode, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-              var userTypeIcon =</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineplus">+              let userTypeIcon =</span>
<a href="#l25.199"></a><span id="l25.199">                   document.getAnonymousElementByAttribute(</span>
<a href="#l25.200"></a><span id="l25.200">                       newNode, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l25.201"></a><span id="l25.201"> </span>
<a href="#l25.202"></a><span id="l25.202">               // the template could have its fields disabled,</span>
<a href="#l25.203"></a><span id="l25.203">               // that's why we need to reset their status.</span>
<a href="#l25.204"></a><span id="l25.204">               input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l25.205"></a><span id="l25.205">               roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l25.206"></a><span id="l25.206">               userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l25.207"></a><span id="l25.207"> </span>
<a href="#l25.208"></a><span id="l25.208">               if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l25.209"></a><span id="l25.209">                   input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l25.210"></a><span id="l25.210">                   roleStatusIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l25.211"></a><span id="l25.211">                   userTypeIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l25.212"></a><span id="l25.212">               }</span>
<a href="#l25.213"></a><span id="l25.213"> </span>
<a href="#l25.214"></a><span id="l25.214">               this.mMaxAttendees++;</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineminus">-              var rowNumber = this.mMaxAttendees;</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineplus">+              let rowNumber = this.mMaxAttendees;</span>
<a href="#l25.217"></a><span id="l25.217">               if (rowNumber &gt;= 0) {</span>
<a href="#l25.218"></a><span id="l25.218">                   roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l25.219"></a><span id="l25.219">                   userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l25.220"></a><span id="l25.220">                   input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l25.221"></a><span id="l25.221">               }</span>
<a href="#l25.222"></a><span id="l25.222"> </span>
<a href="#l25.223"></a><span id="l25.223">               input.value = null;</span>
<a href="#l25.224"></a><span id="l25.224">               input.removeAttribute(&quot;value&quot;);</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineat">@@ -509,17 +509,17 @@</span>
<a href="#l25.226"></a><span id="l25.226">                 if (aList[l] === listid) {</span>
<a href="#l25.227"></a><span id="l25.227">                   return true;</span>
<a href="#l25.228"></a><span id="l25.228">                 }</span>
<a href="#l25.229"></a><span id="l25.229">               }</span>
<a href="#l25.230"></a><span id="l25.230">               return false;</span>
<a href="#l25.231"></a><span id="l25.231">             }</span>
<a href="#l25.232"></a><span id="l25.232"> </span>
<a href="#l25.233"></a><span id="l25.233">             let addressLists = mailingList.addressLists;</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineminus">-            for (var i = 0; i &lt; addressLists.length; i++) {</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineplus">+            for (let i = 0; i &lt; addressLists.length; i++) {</span>
<a href="#l25.236"></a><span id="l25.236">               let abCard = addressLists.queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l25.237"></a><span id="l25.237">               let thisId = abCard.primaryEmail;</span>
<a href="#l25.238"></a><span id="l25.238">               if (abCard.displayName.length &gt; 0) {</span>
<a href="#l25.239"></a><span id="l25.239">                   let rCn = abCard.displayName;</span>
<a href="#l25.240"></a><span id="l25.240">                   if (rCn.includes(&quot;,&quot;)) {</span>
<a href="#l25.241"></a><span id="l25.241">                       rCn = '&quot;' + rCn + '&quot;';</span>
<a href="#l25.242"></a><span id="l25.242">                   }</span>
<a href="#l25.243"></a><span id="l25.243">                   thisId = rCn + &quot; &lt;&quot; + thisId + &quot;&gt;&quot;;</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineat">@@ -709,53 +709,53 @@</span>
<a href="#l25.245"></a><span id="l25.245">       &lt;property name=&quot;documentSize&quot;&gt;</span>
<a href="#l25.246"></a><span id="l25.246">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.247"></a><span id="l25.247">             return this.mRowHeight * this.mMaxAttendees;</span>
<a href="#l25.248"></a><span id="l25.248">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l25.249"></a><span id="l25.249">       &lt;/property&gt;</span>
<a href="#l25.250"></a><span id="l25.250"> </span>
<a href="#l25.251"></a><span id="l25.251">       &lt;method name=&quot;fitDummyRows&quot;&gt;</span>
<a href="#l25.252"></a><span id="l25.252">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineminus">-          var self = this;</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-          var func = function attendees_list_fitDummyRows() {</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineplus">+          let self = this;</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineplus">+          let func = function attendees_list_fitDummyRows() {</span>
<a href="#l25.257"></a><span id="l25.257">               self.calcContentHeight();</span>
<a href="#l25.258"></a><span id="l25.258">               self.createOrRemoveDummyRows();</span>
<a href="#l25.259"></a><span id="l25.259">           };</span>
<a href="#l25.260"></a><span id="l25.260">           setTimeout(func, 0);</span>
<a href="#l25.261"></a><span id="l25.261">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.262"></a><span id="l25.262">       &lt;/method&gt;</span>
<a href="#l25.263"></a><span id="l25.263"> </span>
<a href="#l25.264"></a><span id="l25.264">       &lt;method name=&quot;calcContentHeight&quot;&gt;</span>
<a href="#l25.265"></a><span id="l25.265">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.266"></a><span id="l25.266" class="difflineminus">-          var listbox =</span>
<a href="#l25.267"></a><span id="l25.267" class="difflineplus">+          let listbox =</span>
<a href="#l25.268"></a><span id="l25.268">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.269"></a><span id="l25.269">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineminus">-          var items = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineplus">+          let items = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l25.272"></a><span id="l25.272">           this.mContentHeight = 0;</span>
<a href="#l25.273"></a><span id="l25.273">           if (items.length &gt; 0) {</span>
<a href="#l25.274"></a><span id="l25.274" class="difflineminus">-              var i = 0;</span>
<a href="#l25.275"></a><span id="l25.275" class="difflineplus">+              let i = 0;</span>
<a href="#l25.276"></a><span id="l25.276">               do {</span>
<a href="#l25.277"></a><span id="l25.277">                   this.mRowHeight = items[i].boxObject.height;</span>
<a href="#l25.278"></a><span id="l25.278">                   ++i;</span>
<a href="#l25.279"></a><span id="l25.279">               } while (i &lt; items.length &amp;&amp; !this.mRowHeight);</span>
<a href="#l25.280"></a><span id="l25.280">               this.mContentHeight = this.mRowHeight * items.length;</span>
<a href="#l25.281"></a><span id="l25.281">           }</span>
<a href="#l25.282"></a><span id="l25.282">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.283"></a><span id="l25.283">       &lt;/method&gt;</span>
<a href="#l25.284"></a><span id="l25.284"> </span>
<a href="#l25.285"></a><span id="l25.285">       &lt;method name=&quot;createOrRemoveDummyRows&quot;&gt;</span>
<a href="#l25.286"></a><span id="l25.286">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineminus">-          var listbox =</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineplus">+          let listbox =</span>
<a href="#l25.289"></a><span id="l25.289">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.290"></a><span id="l25.290">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineminus">-          var listboxHeight = listbox.boxObject.height;</span>
<a href="#l25.292"></a><span id="l25.292" class="difflineplus">+          let listboxHeight = listbox.boxObject.height;</span>
<a href="#l25.293"></a><span id="l25.293"> </span>
<a href="#l25.294"></a><span id="l25.294">           // remove rows to remove scrollbar</span>
<a href="#l25.295"></a><span id="l25.295" class="difflineminus">-          var kids = listbox.childNodes;</span>
<a href="#l25.296"></a><span id="l25.296" class="difflineminus">-          for (var i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l25.297"></a><span id="l25.297" class="difflineplus">+          let kids = listbox.childNodes;</span>
<a href="#l25.298"></a><span id="l25.298" class="difflineplus">+          for (let i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l25.299"></a><span id="l25.299">               if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l25.300"></a><span id="l25.300">                   this.mContentHeight -= this.mRowHeight;</span>
<a href="#l25.301"></a><span id="l25.301">                   kids[i].remove();</span>
<a href="#l25.302"></a><span id="l25.302">               }</span>
<a href="#l25.303"></a><span id="l25.303">           }</span>
<a href="#l25.304"></a><span id="l25.304"> </span>
<a href="#l25.305"></a><span id="l25.305">           // add rows to fill space</span>
<a href="#l25.306"></a><span id="l25.306">           if (this.mRowHeight) {</span>
<a href="#l25.307"></a><span id="l25.307" class="difflineat">@@ -765,66 +765,66 @@</span>
<a href="#l25.308"></a><span id="l25.308">               }</span>
<a href="#l25.309"></a><span id="l25.309">           }</span>
<a href="#l25.310"></a><span id="l25.310">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.311"></a><span id="l25.311">       &lt;/method&gt;</span>
<a href="#l25.312"></a><span id="l25.312"> </span>
<a href="#l25.313"></a><span id="l25.313">       &lt;method name=&quot;createDummyCell&quot;&gt;</span>
<a href="#l25.314"></a><span id="l25.314">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l25.315"></a><span id="l25.315">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.316"></a><span id="l25.316" class="difflineminus">-          var cell = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listcell&quot;);</span>
<a href="#l25.317"></a><span id="l25.317" class="difflineplus">+          let cell = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listcell&quot;);</span>
<a href="#l25.318"></a><span id="l25.318">           cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l25.319"></a><span id="l25.319">           if (aParent) {</span>
<a href="#l25.320"></a><span id="l25.320">               aParent.appendChild(cell);</span>
<a href="#l25.321"></a><span id="l25.321">           }</span>
<a href="#l25.322"></a><span id="l25.322">           return cell;</span>
<a href="#l25.323"></a><span id="l25.323">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.324"></a><span id="l25.324">       &lt;/method&gt;</span>
<a href="#l25.325"></a><span id="l25.325"> </span>
<a href="#l25.326"></a><span id="l25.326">       &lt;method name=&quot;createDummyItem&quot;&gt;</span>
<a href="#l25.327"></a><span id="l25.327">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l25.328"></a><span id="l25.328">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineminus">-          var titem = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listitem&quot;);</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineplus">+          let titem = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listitem&quot;);</span>
<a href="#l25.331"></a><span id="l25.331">           titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l25.332"></a><span id="l25.332">           titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l25.333"></a><span id="l25.333" class="difflineminus">-          for (var i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineplus">+          for (let i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l25.335"></a><span id="l25.335">               this.createDummyCell(titem);</span>
<a href="#l25.336"></a><span id="l25.336">           }</span>
<a href="#l25.337"></a><span id="l25.337">           if (aParent) {</span>
<a href="#l25.338"></a><span id="l25.338">               aParent.appendChild(titem);</span>
<a href="#l25.339"></a><span id="l25.339">           }</span>
<a href="#l25.340"></a><span id="l25.340">           return titem;</span>
<a href="#l25.341"></a><span id="l25.341">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.342"></a><span id="l25.342">       &lt;/method&gt;</span>
<a href="#l25.343"></a><span id="l25.343"> </span>
<a href="#l25.344"></a><span id="l25.344">       &lt;!-- gets the next row from the top down --&gt;</span>
<a href="#l25.345"></a><span id="l25.345">       &lt;method name=&quot;getNextDummyRow&quot;&gt;</span>
<a href="#l25.346"></a><span id="l25.346">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.347"></a><span id="l25.347" class="difflineminus">-          var listbox =</span>
<a href="#l25.348"></a><span id="l25.348" class="difflineplus">+          let listbox =</span>
<a href="#l25.349"></a><span id="l25.349">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.350"></a><span id="l25.350">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineminus">-          var kids = listbox.childNodes;</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineminus">-          for (var i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineplus">+          let kids = listbox.childNodes;</span>
<a href="#l25.354"></a><span id="l25.354" class="difflineplus">+          for (let i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l25.355"></a><span id="l25.355">               if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l25.356"></a><span id="l25.356">                   return kids[i];</span>
<a href="#l25.357"></a><span id="l25.357">               }</span>
<a href="#l25.358"></a><span id="l25.358">           }</span>
<a href="#l25.359"></a><span id="l25.359">           return null;</span>
<a href="#l25.360"></a><span id="l25.360">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.361"></a><span id="l25.361">       &lt;/method&gt;</span>
<a href="#l25.362"></a><span id="l25.362"> </span>
<a href="#l25.363"></a><span id="l25.363">       &lt;!-- This method returns the &lt;xul:listitem&gt; at row numer 'aRow' --&gt;</span>
<a href="#l25.364"></a><span id="l25.364">       &lt;method name=&quot;getListItem&quot;&gt;</span>
<a href="#l25.365"></a><span id="l25.365">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l25.366"></a><span id="l25.366">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineminus">-          var listbox =</span>
<a href="#l25.368"></a><span id="l25.368" class="difflineplus">+          let listbox =</span>
<a href="#l25.369"></a><span id="l25.369">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.370"></a><span id="l25.370">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.371"></a><span id="l25.371">           if (listbox &amp;&amp; aRow &gt; 0) {</span>
<a href="#l25.372"></a><span id="l25.372" class="difflineminus">-              var listitems = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l25.373"></a><span id="l25.373" class="difflineplus">+              let listitems = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l25.374"></a><span id="l25.374">               if (listitems &amp;&amp; listitems.length &gt;= aRow) {</span>
<a href="#l25.375"></a><span id="l25.375">                   return listitems[aRow - 1];</span>
<a href="#l25.376"></a><span id="l25.376">               }</span>
<a href="#l25.377"></a><span id="l25.377">           }</span>
<a href="#l25.378"></a><span id="l25.378">           return 0;</span>
<a href="#l25.379"></a><span id="l25.379">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.380"></a><span id="l25.380">       &lt;/method&gt;</span>
<a href="#l25.381"></a><span id="l25.381"> </span>
<a href="#l25.382"></a><span id="l25.382" class="difflineat">@@ -833,17 +833,17 @@</span>
<a href="#l25.383"></a><span id="l25.383">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.384"></a><span id="l25.384">           return aListItem.getElementsByTagNameNS(&quot;*&quot;, &quot;textbox&quot;)[0];</span>
<a href="#l25.385"></a><span id="l25.385">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.386"></a><span id="l25.386">       &lt;/method&gt;</span>
<a href="#l25.387"></a><span id="l25.387"> </span>
<a href="#l25.388"></a><span id="l25.388">       &lt;method name=&quot;getRowByInputElement&quot;&gt;</span>
<a href="#l25.389"></a><span id="l25.389">         &lt;parameter name=&quot;aElement&quot;/&gt;</span>
<a href="#l25.390"></a><span id="l25.390">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.391"></a><span id="l25.391" class="difflineminus">-          var row = 0;</span>
<a href="#l25.392"></a><span id="l25.392" class="difflineplus">+          let row = 0;</span>
<a href="#l25.393"></a><span id="l25.393">           while (aElement &amp;&amp; aElement.localName != &quot;listitem&quot;) {</span>
<a href="#l25.394"></a><span id="l25.394">               aElement = aElement.parentNode;</span>
<a href="#l25.395"></a><span id="l25.395">           }</span>
<a href="#l25.396"></a><span id="l25.396">           if (aElement) {</span>
<a href="#l25.397"></a><span id="l25.397">               while (aElement) {</span>
<a href="#l25.398"></a><span id="l25.398">                   if (aElement.localName == &quot;listitem&quot;) {</span>
<a href="#l25.399"></a><span id="l25.399">                       ++row;</span>
<a href="#l25.400"></a><span id="l25.400">                   }</span>
<a href="#l25.401"></a><span id="l25.401" class="difflineat">@@ -882,89 +882,89 @@</span>
<a href="#l25.402"></a><span id="l25.402">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.403"></a><span id="l25.403">           return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol2#&quot; + aRow);</span>
<a href="#l25.404"></a><span id="l25.404">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.405"></a><span id="l25.405">       &lt;/method&gt;</span>
<a href="#l25.406"></a><span id="l25.406"> </span>
<a href="#l25.407"></a><span id="l25.407">       &lt;method name=&quot;setFocus&quot;&gt;</span>
<a href="#l25.408"></a><span id="l25.408">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l25.409"></a><span id="l25.409">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.410"></a><span id="l25.410" class="difflineminus">-          var self = this;</span>
<a href="#l25.411"></a><span id="l25.411" class="difflineminus">-          var set_focus = function() {</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-              var node;</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineplus">+          let self = this;</span>
<a href="#l25.414"></a><span id="l25.414" class="difflineplus">+          let set_focus = function() {</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineplus">+              let node;</span>
<a href="#l25.416"></a><span id="l25.416">               if (typeof aRow == 'number') {</span>
<a href="#l25.417"></a><span id="l25.417">                 node = self.getListItem(aRow);</span>
<a href="#l25.418"></a><span id="l25.418">               } else {</span>
<a href="#l25.419"></a><span id="l25.419">                 node = aRow;</span>
<a href="#l25.420"></a><span id="l25.420">               }</span>
<a href="#l25.421"></a><span id="l25.421"> </span>
<a href="#l25.422"></a><span id="l25.422">               // do we need to scroll in order to see the selected row?</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineminus">-              var listbox =</span>
<a href="#l25.424"></a><span id="l25.424" class="difflineplus">+              let listbox =</span>
<a href="#l25.425"></a><span id="l25.425">                   document.getAnonymousElementByAttribute(</span>
<a href="#l25.426"></a><span id="l25.426">                       self, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineminus">-              var firstVisibleRow = listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineminus">-              var numOfVisibleRows = listbox.getNumberOfVisibleRows();</span>
<a href="#l25.429"></a><span id="l25.429" class="difflineplus">+              let firstVisibleRow = listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l25.430"></a><span id="l25.430" class="difflineplus">+              let numOfVisibleRows = listbox.getNumberOfVisibleRows();</span>
<a href="#l25.431"></a><span id="l25.431">               if (aRow &lt;= firstVisibleRow) {</span>
<a href="#l25.432"></a><span id="l25.432">                   listbox.scrollToIndex(aRow - 1);</span>
<a href="#l25.433"></a><span id="l25.433">               } else {</span>
<a href="#l25.434"></a><span id="l25.434">                   if (aRow - 1 &gt;= (firstVisibleRow + numOfVisibleRows)) {</span>
<a href="#l25.435"></a><span id="l25.435">                       listbox.scrollToIndex(aRow - numOfVisibleRows);</span>
<a href="#l25.436"></a><span id="l25.436">                   }</span>
<a href="#l25.437"></a><span id="l25.437">               }</span>
<a href="#l25.438"></a><span id="l25.438" class="difflineminus">-              var input =</span>
<a href="#l25.439"></a><span id="l25.439" class="difflineplus">+              let input =</span>
<a href="#l25.440"></a><span id="l25.440">                   document.getAnonymousElementByAttribute(</span>
<a href="#l25.441"></a><span id="l25.441">                       node, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l25.442"></a><span id="l25.442">               input.focus();</span>
<a href="#l25.443"></a><span id="l25.443">           };</span>
<a href="#l25.444"></a><span id="l25.444">           setTimeout(set_focus, 0);</span>
<a href="#l25.445"></a><span id="l25.445">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.446"></a><span id="l25.446">       &lt;/method&gt;</span>
<a href="#l25.447"></a><span id="l25.447"> </span>
<a href="#l25.448"></a><span id="l25.448">       &lt;property name=&quot;firstVisibleRow&quot;&gt;</span>
<a href="#l25.449"></a><span id="l25.449">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.450"></a><span id="l25.450" class="difflineminus">-          var listbox =</span>
<a href="#l25.451"></a><span id="l25.451" class="difflineplus">+          let listbox =</span>
<a href="#l25.452"></a><span id="l25.452">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.453"></a><span id="l25.453">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.454"></a><span id="l25.454">           return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l25.455"></a><span id="l25.455">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l25.456"></a><span id="l25.456">       &lt;/property&gt;</span>
<a href="#l25.457"></a><span id="l25.457"> </span>
<a href="#l25.458"></a><span id="l25.458">       &lt;method name=&quot;createAttendee&quot;&gt;</span>
<a href="#l25.459"></a><span id="l25.459">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.460"></a><span id="l25.460" class="difflineminus">-          var attendee = createAttendee();</span>
<a href="#l25.461"></a><span id="l25.461" class="difflineplus">+          let attendee = createAttendee();</span>
<a href="#l25.462"></a><span id="l25.462">           attendee.id = &quot;&quot;;</span>
<a href="#l25.463"></a><span id="l25.463">           attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l25.464"></a><span id="l25.464">           attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l25.465"></a><span id="l25.465">           attendee.participationStatus = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l25.466"></a><span id="l25.466">           return attendee;</span>
<a href="#l25.467"></a><span id="l25.467">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.468"></a><span id="l25.468">       &lt;/method&gt;</span>
<a href="#l25.469"></a><span id="l25.469"> </span>
<a href="#l25.470"></a><span id="l25.470">       &lt;property name=&quot;numColumns&quot;&gt;</span>
<a href="#l25.471"></a><span id="l25.471">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.472"></a><span id="l25.472">           if (!this.mNumColumns) {</span>
<a href="#l25.473"></a><span id="l25.473" class="difflineminus">-              var listbox =</span>
<a href="#l25.474"></a><span id="l25.474" class="difflineplus">+              let listbox =</span>
<a href="#l25.475"></a><span id="l25.475">                   document.getAnonymousElementByAttribute(</span>
<a href="#l25.476"></a><span id="l25.476">                       this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineminus">-              var listCols = listbox.getElementsByTagNameNS('*', 'listcol');</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineplus">+              let listCols = listbox.getElementsByTagNameNS('*', 'listcol');</span>
<a href="#l25.479"></a><span id="l25.479">               this.mNumColumns = listCols.length;</span>
<a href="#l25.480"></a><span id="l25.480">               if (!this.mNumColumns) {</span>
<a href="#l25.481"></a><span id="l25.481">                   this.mNumColumns = 1;</span>
<a href="#l25.482"></a><span id="l25.482">               }</span>
<a href="#l25.483"></a><span id="l25.483">           }</span>
<a href="#l25.484"></a><span id="l25.484">           return this.mNumColumns;</span>
<a href="#l25.485"></a><span id="l25.485">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l25.486"></a><span id="l25.486">       &lt;/property&gt;</span>
<a href="#l25.487"></a><span id="l25.487"> </span>
<a href="#l25.488"></a><span id="l25.488">       &lt;property name=&quot;ratio&quot;&gt;</span>
<a href="#l25.489"></a><span id="l25.489">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineminus">-          var listbox =</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineplus">+          let listbox =</span>
<a href="#l25.492"></a><span id="l25.492">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.493"></a><span id="l25.493">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineminus">-          var rowcount = listbox.getRowCount();</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineplus">+          let rowcount = listbox.getRowCount();</span>
<a href="#l25.496"></a><span id="l25.496">           listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l25.497"></a><span id="l25.497">           return val;</span>
<a href="#l25.498"></a><span id="l25.498">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l25.499"></a><span id="l25.499">       &lt;/property&gt;</span>
<a href="#l25.500"></a><span id="l25.500"> </span>
<a href="#l25.501"></a><span id="l25.501">       &lt;method name=&quot;returnHit&quot;&gt;</span>
<a href="#l25.502"></a><span id="l25.502">         &lt;parameter name=&quot;element&quot;/&gt;</span>
<a href="#l25.503"></a><span id="l25.503">         &lt;parameter name=&quot;noAdvance&quot;/&gt;</span>
<a href="#l25.504"></a><span id="l25.504" class="difflineat">@@ -1005,81 +1005,81 @@</span>
<a href="#l25.505"></a><span id="l25.505">           }</span>
<a href="#l25.506"></a><span id="l25.506">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.507"></a><span id="l25.507">       &lt;/method&gt;</span>
<a href="#l25.508"></a><span id="l25.508"> </span>
<a href="#l25.509"></a><span id="l25.509">       &lt;method name=&quot;arrowHit&quot;&gt;</span>
<a href="#l25.510"></a><span id="l25.510">         &lt;parameter name=&quot;aElement&quot;/&gt;</span>
<a href="#l25.511"></a><span id="l25.511">         &lt;parameter name=&quot;aDirection&quot;/&gt;</span>
<a href="#l25.512"></a><span id="l25.512">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineminus">-          var row = this.getRowByInputElement(aElement) + aDirection;</span>
<a href="#l25.514"></a><span id="l25.514" class="difflineplus">+          let row = this.getRowByInputElement(aElement) + aDirection;</span>
<a href="#l25.515"></a><span id="l25.515">           if (row) {</span>
<a href="#l25.516"></a><span id="l25.516">               if (row &gt; this.mMaxAttendees) {</span>
<a href="#l25.517"></a><span id="l25.517">                   this.appendNewRow(true);</span>
<a href="#l25.518"></a><span id="l25.518">               } else {</span>
<a href="#l25.519"></a><span id="l25.519" class="difflineminus">-                  var input = this.getInputElement(row);</span>
<a href="#l25.520"></a><span id="l25.520" class="difflineplus">+                  let input = this.getInputElement(row);</span>
<a href="#l25.521"></a><span id="l25.521">                   if (input.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l25.522"></a><span id="l25.522">                       return;</span>
<a href="#l25.523"></a><span id="l25.523">                   }</span>
<a href="#l25.524"></a><span id="l25.524">                   this.setFocus(row);</span>
<a href="#l25.525"></a><span id="l25.525">               }</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineminus">-              var event = document.createEvent('Events');</span>
<a href="#l25.527"></a><span id="l25.527" class="difflineplus">+              let event = document.createEvent('Events');</span>
<a href="#l25.528"></a><span id="l25.528">               event.initEvent('rowchange', true, false);</span>
<a href="#l25.529"></a><span id="l25.529">               event.details = row;</span>
<a href="#l25.530"></a><span id="l25.530">               this.dispatchEvent(event);</span>
<a href="#l25.531"></a><span id="l25.531">           }</span>
<a href="#l25.532"></a><span id="l25.532">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.533"></a><span id="l25.533">       &lt;/method&gt;</span>
<a href="#l25.534"></a><span id="l25.534"> </span>
<a href="#l25.535"></a><span id="l25.535">       &lt;method name=&quot;deleteHit&quot;&gt;</span>
<a href="#l25.536"></a><span id="l25.536">         &lt;parameter name=&quot;aElement&quot;/&gt;</span>
<a href="#l25.537"></a><span id="l25.537">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.538"></a><span id="l25.538">           // don't delete the row if only the organizer is remaining</span>
<a href="#l25.539"></a><span id="l25.539">           if (this.mMaxAttendees &lt;= 1) {</span>
<a href="#l25.540"></a><span id="l25.540">               return;</span>
<a href="#l25.541"></a><span id="l25.541">           }</span>
<a href="#l25.542"></a><span id="l25.542"> </span>
<a href="#l25.543"></a><span id="l25.543" class="difflineminus">-          var row = this.getRowByInputElement(aElement);</span>
<a href="#l25.544"></a><span id="l25.544" class="difflineplus">+          let row = this.getRowByInputElement(aElement);</span>
<a href="#l25.545"></a><span id="l25.545">           this.deleteRow(row);</span>
<a href="#l25.546"></a><span id="l25.546">           if (row &gt; 0) {</span>
<a href="#l25.547"></a><span id="l25.547">               row = row - 1;</span>
<a href="#l25.548"></a><span id="l25.548">           }</span>
<a href="#l25.549"></a><span id="l25.549">           this.setFocus(row);</span>
<a href="#l25.550"></a><span id="l25.550">           this.onModify();</span>
<a href="#l25.551"></a><span id="l25.551"> </span>
<a href="#l25.552"></a><span id="l25.552" class="difflineminus">-          var event = document.createEvent('Events');</span>
<a href="#l25.553"></a><span id="l25.553" class="difflineplus">+          let event = document.createEvent('Events');</span>
<a href="#l25.554"></a><span id="l25.554">           event.initEvent('rowchange', true, false);</span>
<a href="#l25.555"></a><span id="l25.555">           event.details = row;</span>
<a href="#l25.556"></a><span id="l25.556">           this.dispatchEvent(event);</span>
<a href="#l25.557"></a><span id="l25.557">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.558"></a><span id="l25.558">       &lt;/method&gt;</span>
<a href="#l25.559"></a><span id="l25.559"> </span>
<a href="#l25.560"></a><span id="l25.560">       &lt;method name=&quot;deleteRow&quot;&gt;</span>
<a href="#l25.561"></a><span id="l25.561">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l25.562"></a><span id="l25.562">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.563"></a><span id="l25.563">           // reset id's in order to not break the sequence</span>
<a href="#l25.564"></a><span id="l25.564" class="difflineminus">-          var maxAttendees = this.mMaxAttendees;</span>
<a href="#l25.565"></a><span id="l25.565" class="difflineplus">+          let maxAttendees = this.mMaxAttendees;</span>
<a href="#l25.566"></a><span id="l25.566">           this.removeRow(aRow);</span>
<a href="#l25.567"></a><span id="l25.567" class="difflineminus">-          var numberOfCols = this.numColumns;</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineminus">-          for (var row = aRow + 1; row &lt;= maxAttendees; row++) {</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineminus">-              for (var col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineminus">-                  var colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineminus">-                  var elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineplus">+          let numberOfCols = this.numColumns;</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineplus">+          for (let row = aRow + 1; row &lt;= maxAttendees; row++) {</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineplus">+              for (let col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineplus">+                  let colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineplus">+                  let elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l25.577"></a><span id="l25.577">                   if (elem) {</span>
<a href="#l25.578"></a><span id="l25.578">                       elem.setAttribute(&quot;id&quot;, &quot;attendeeCol&quot; + col + &quot;#&quot; + (row - 1));</span>
<a href="#l25.579"></a><span id="l25.579">                   }</span>
<a href="#l25.580"></a><span id="l25.580">               }</span>
<a href="#l25.581"></a><span id="l25.581">           }</span>
<a href="#l25.582"></a><span id="l25.582">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.583"></a><span id="l25.583">       &lt;/method&gt;</span>
<a href="#l25.584"></a><span id="l25.584"> </span>
<a href="#l25.585"></a><span id="l25.585">       &lt;method name=&quot;removeRow&quot;&gt;</span>
<a href="#l25.586"></a><span id="l25.586">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l25.587"></a><span id="l25.587">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.588"></a><span id="l25.588" class="difflineminus">-          var listbox =</span>
<a href="#l25.589"></a><span id="l25.589" class="difflineplus">+          let listbox =</span>
<a href="#l25.590"></a><span id="l25.590">               document.getAnonymousElementByAttribute(</span>
<a href="#l25.591"></a><span id="l25.591">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l25.592"></a><span id="l25.592">           this.getListItem(aRow).remove();</span>
<a href="#l25.593"></a><span id="l25.593">           this.fitDummyRows();</span>
<a href="#l25.594"></a><span id="l25.594">           this.mMaxAttendees--;</span>
<a href="#l25.595"></a><span id="l25.595">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.596"></a><span id="l25.596">       &lt;/method&gt;</span>
<a href="#l25.597"></a><span id="l25.597">     &lt;/implementation&gt;</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineat">@@ -1298,49 +1298,49 @@</span>
<a href="#l25.599"></a><span id="l25.599">                 this, &quot;anonid&quot;, &quot;selection-bar&quot;);</span>
<a href="#l25.600"></a><span id="l25.600">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.601"></a><span id="l25.601"> </span>
<a href="#l25.602"></a><span id="l25.602">       &lt;property name=&quot;baseDate&quot;&gt;</span>
<a href="#l25.603"></a><span id="l25.603">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l25.604"></a><span id="l25.604">           // we need to convert the date/time in question in</span>
<a href="#l25.605"></a><span id="l25.605">           // order to calculate with hours that are aligned</span>
<a href="#l25.606"></a><span id="l25.606">           // with our timebar display.</span>
<a href="#l25.607"></a><span id="l25.607" class="difflineminus">-          var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l25.608"></a><span id="l25.608" class="difflineplus">+          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l25.609"></a><span id="l25.609">           this.mBaseDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l25.610"></a><span id="l25.610">           this.mBaseDate.isDate = true;</span>
<a href="#l25.611"></a><span id="l25.611">           this.mBaseDate.makeImmutable();</span>
<a href="#l25.612"></a><span id="l25.612">           return val;</span>
<a href="#l25.613"></a><span id="l25.613">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l25.614"></a><span id="l25.614">       &lt;/property&gt;</span>
<a href="#l25.615"></a><span id="l25.615"> </span>
<a href="#l25.616"></a><span id="l25.616">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l25.617"></a><span id="l25.617">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l25.618"></a><span id="l25.618">           // currently we *always* set the basedate to be</span>
<a href="#l25.619"></a><span id="l25.619">           // equal to the startdate. we'll most probably</span>
<a href="#l25.620"></a><span id="l25.620">           // want to change this later.</span>
<a href="#l25.621"></a><span id="l25.621">           this.baseDate = val;</span>
<a href="#l25.622"></a><span id="l25.622">           // we need to convert the date/time in question in</span>
<a href="#l25.623"></a><span id="l25.623">           // order to calculate with hours that are aligned</span>
<a href="#l25.624"></a><span id="l25.624">           // with our timebar display.</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineminus">-          var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l25.626"></a><span id="l25.626" class="difflineplus">+          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l25.627"></a><span id="l25.627">           this.mStartDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l25.628"></a><span id="l25.628">           this.mStartDate.makeImmutable();</span>
<a href="#l25.629"></a><span id="l25.629">           return val;</span>
<a href="#l25.630"></a><span id="l25.630">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l25.631"></a><span id="l25.631">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.632"></a><span id="l25.632">           return this.mStartDate;</span>
<a href="#l25.633"></a><span id="l25.633">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l25.634"></a><span id="l25.634">       &lt;/property&gt;</span>
<a href="#l25.635"></a><span id="l25.635"> </span>
<a href="#l25.636"></a><span id="l25.636">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l25.637"></a><span id="l25.637">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l25.638"></a><span id="l25.638">           // we need to convert the date/time in question in</span>
<a href="#l25.639"></a><span id="l25.639">           // order to calculate with hours that are aligned</span>
<a href="#l25.640"></a><span id="l25.640">           // with our timebar display.</span>
<a href="#l25.641"></a><span id="l25.641" class="difflineminus">-          var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l25.642"></a><span id="l25.642" class="difflineplus">+          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l25.643"></a><span id="l25.643">           this.mEndDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l25.644"></a><span id="l25.644">           if (this.mEndDate.isDate) {</span>
<a href="#l25.645"></a><span id="l25.645">               this.mEndDate.day += 1;</span>
<a href="#l25.646"></a><span id="l25.646">           }</span>
<a href="#l25.647"></a><span id="l25.647">           this.mEndDate.makeImmutable();</span>
<a href="#l25.648"></a><span id="l25.648">           return val;</span>
<a href="#l25.649"></a><span id="l25.649">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l25.650"></a><span id="l25.650">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineat">@@ -1380,20 +1380,20 @@</span>
<a href="#l25.652"></a><span id="l25.652">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.653"></a><span id="l25.653">       &lt;/method&gt;</span>
<a href="#l25.654"></a><span id="l25.654"> </span>
<a href="#l25.655"></a><span id="l25.655">       &lt;!-- given some specific date this method calculates the</span>
<a href="#l25.656"></a><span id="l25.656">            corrposonding offset in fractional hours --&gt;</span>
<a href="#l25.657"></a><span id="l25.657">       &lt;method name=&quot;date2offset&quot;&gt;</span>
<a href="#l25.658"></a><span id="l25.658">         &lt;parameter name=&quot;date&quot;/&gt;</span>
<a href="#l25.659"></a><span id="l25.659">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.660"></a><span id="l25.660" class="difflineminus">-          var num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l25.661"></a><span id="l25.661" class="difflineminus">-          var diff = date.subtractDate(this.mBaseDate);</span>
<a href="#l25.662"></a><span id="l25.662" class="difflineminus">-          var offset = diff.days * num_hours;</span>
<a href="#l25.663"></a><span id="l25.663" class="difflineminus">-          var hours = (diff.hours - this.mStartHour) + (diff.minutes / 60.0);</span>
<a href="#l25.664"></a><span id="l25.664" class="difflineplus">+          let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l25.665"></a><span id="l25.665" class="difflineplus">+          let diff = date.subtractDate(this.mBaseDate);</span>
<a href="#l25.666"></a><span id="l25.666" class="difflineplus">+          let offset = diff.days * num_hours;</span>
<a href="#l25.667"></a><span id="l25.667" class="difflineplus">+          let hours = (diff.hours - this.mStartHour) + (diff.minutes / 60.0);</span>
<a href="#l25.668"></a><span id="l25.668">           if (hours &lt; 0) {</span>
<a href="#l25.669"></a><span id="l25.669">               hours = 0;</span>
<a href="#l25.670"></a><span id="l25.670">           }</span>
<a href="#l25.671"></a><span id="l25.671">           if (hours &gt; num_hours) {</span>
<a href="#l25.672"></a><span id="l25.672">               hours = num_hours;</span>
<a href="#l25.673"></a><span id="l25.673">           }</span>
<a href="#l25.674"></a><span id="l25.674">           offset += hours;</span>
<a href="#l25.675"></a><span id="l25.675">           return offset;</span>
<a href="#l25.676"></a><span id="l25.676" class="difflineat">@@ -1402,73 +1402,73 @@</span>
<a href="#l25.677"></a><span id="l25.677"> </span>
<a href="#l25.678"></a><span id="l25.678">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l25.679"></a><span id="l25.679">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.680"></a><span id="l25.680">           if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l25.681"></a><span id="l25.681">               return;</span>
<a href="#l25.682"></a><span id="l25.682">           }</span>
<a href="#l25.683"></a><span id="l25.683"> </span>
<a href="#l25.684"></a><span id="l25.684">           // Calculate the relation of startdate/basedate and enddate/startdate.</span>
<a href="#l25.685"></a><span id="l25.685" class="difflineminus">-          var offset = this.mStartDate.subtractDate(this.mBaseDate);</span>
<a href="#l25.686"></a><span id="l25.686" class="difflineminus">-          var duration = this.mEndDate.subtractDate(this.mStartDate);</span>
<a href="#l25.687"></a><span id="l25.687" class="difflineplus">+          let offset = this.mStartDate.subtractDate(this.mBaseDate);</span>
<a href="#l25.688"></a><span id="l25.688" class="difflineplus">+          let duration = this.mEndDate.subtractDate(this.mStartDate);</span>
<a href="#l25.689"></a><span id="l25.689"> </span>
<a href="#l25.690"></a><span id="l25.690">           // Calculate how much pixels a single hour and a single day take up.</span>
<a href="#l25.691"></a><span id="l25.691" class="difflineminus">-          var num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l25.692"></a><span id="l25.692" class="difflineminus">-          var hour_width = this.mContentWidth / num_hours;</span>
<a href="#l25.693"></a><span id="l25.693" class="difflineplus">+          let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l25.694"></a><span id="l25.694" class="difflineplus">+          let hour_width = this.mContentWidth / num_hours;</span>
<a href="#l25.695"></a><span id="l25.695"> </span>
<a href="#l25.696"></a><span id="l25.696">           // Calculate the offset in fractional hours that corrospond</span>
<a href="#l25.697"></a><span id="l25.697">           // to our start- and end-time.</span>
<a href="#l25.698"></a><span id="l25.698" class="difflineminus">-          var start_offset_in_hours = this.date2offset(this.mStartDate);</span>
<a href="#l25.699"></a><span id="l25.699" class="difflineminus">-          var end_offset_in_hours = this.date2offset(this.mEndDate);</span>
<a href="#l25.700"></a><span id="l25.700" class="difflineminus">-          var duration_in_hours = end_offset_in_hours - start_offset_in_hours;</span>
<a href="#l25.701"></a><span id="l25.701" class="difflineplus">+          let start_offset_in_hours = this.date2offset(this.mStartDate);</span>
<a href="#l25.702"></a><span id="l25.702" class="difflineplus">+          let end_offset_in_hours = this.date2offset(this.mEndDate);</span>
<a href="#l25.703"></a><span id="l25.703" class="difflineplus">+          let duration_in_hours = end_offset_in_hours - start_offset_in_hours;</span>
<a href="#l25.704"></a><span id="l25.704"> </span>
<a href="#l25.705"></a><span id="l25.705">           // Calculate width &amp; margin for the selection bar based on the</span>
<a href="#l25.706"></a><span id="l25.706">           // relation of startdate/basedate and enddate/startdate.</span>
<a href="#l25.707"></a><span id="l25.707">           // This is a simple conversion from hours to pixels.</span>
<a href="#l25.708"></a><span id="l25.708">           this.mWidth = duration_in_hours * hour_width;</span>
<a href="#l25.709"></a><span id="l25.709" class="difflineminus">-          var totaldragwidths = this.leftdragWidth + this.rightdragWidth;</span>
<a href="#l25.710"></a><span id="l25.710" class="difflineplus">+          let totaldragwidths = this.leftdragWidth + this.rightdragWidth;</span>
<a href="#l25.711"></a><span id="l25.711">           if (this.mWidth &lt; totaldragwidths) {</span>
<a href="#l25.712"></a><span id="l25.712">               this.mWidth = totaldragwidths;</span>
<a href="#l25.713"></a><span id="l25.713">           }</span>
<a href="#l25.714"></a><span id="l25.714">           this.mMargin = start_offset_in_hours * hour_width;</span>
<a href="#l25.715"></a><span id="l25.715"> </span>
<a href="#l25.716"></a><span id="l25.716">           // Calculate the difference between content and container in pixels.</span>
<a href="#l25.717"></a><span id="l25.717">           // The container is the window showing this control, the content is the</span>
<a href="#l25.718"></a><span id="l25.718">           // total number of pixels the selection bar can theoretically take up.</span>
<a href="#l25.719"></a><span id="l25.719" class="difflineminus">-          var total_width = this.mContentWidth * this.mRange - this.parentNode.boxObject.width;</span>
<a href="#l25.720"></a><span id="l25.720" class="difflineplus">+          let total_width = this.mContentWidth * this.mRange - this.parentNode.boxObject.width;</span>
<a href="#l25.721"></a><span id="l25.721"> </span>
<a href="#l25.722"></a><span id="l25.722">           // Calculate the current scroll offset.</span>
<a href="#l25.723"></a><span id="l25.723">           offset = Math.floor(total_width * this.mRatio);</span>
<a href="#l25.724"></a><span id="l25.724"> </span>
<a href="#l25.725"></a><span id="l25.725">           // The final margin is the difference between the date-based margin</span>
<a href="#l25.726"></a><span id="l25.726">           // and the scroll-based margin.</span>
<a href="#l25.727"></a><span id="l25.727">           this.mMargin -= offset;</span>
<a href="#l25.728"></a><span id="l25.728"> </span>
<a href="#l25.729"></a><span id="l25.729">           // Set the styles based on the calculations above for the 'selection-bar'.</span>
<a href="#l25.730"></a><span id="l25.730" class="difflineminus">-          var style = &quot;width: &quot; + this.mWidth +</span>
<a href="#l25.731"></a><span id="l25.731" class="difflineplus">+          let style = &quot;width: &quot; + this.mWidth +</span>
<a href="#l25.732"></a><span id="l25.732">                       &quot;px; margin-inline-start: &quot; + this.mMargin +</span>
<a href="#l25.733"></a><span id="l25.733">                       &quot;px; margin-top: &quot; + this.mHeaderHeight + &quot;px;&quot;;</span>
<a href="#l25.734"></a><span id="l25.734">           this.mSelectionbar.setAttribute(&quot;style&quot;, style);</span>
<a href="#l25.735"></a><span id="l25.735"> </span>
<a href="#l25.736"></a><span id="l25.736" class="difflineminus">-          var event = document.createEvent('Events');</span>
<a href="#l25.737"></a><span id="l25.737" class="difflineplus">+          let event = document.createEvent('Events');</span>
<a href="#l25.738"></a><span id="l25.738">           event.initEvent('timechange', true, false);</span>
<a href="#l25.739"></a><span id="l25.739">           event.startDate = this.mStartDate;</span>
<a href="#l25.740"></a><span id="l25.740">           event.endDate = this.mEndDate.clone();</span>
<a href="#l25.741"></a><span id="l25.741">           if (event.endDate.isDate) {</span>
<a href="#l25.742"></a><span id="l25.742">               event.endDate.day--;</span>
<a href="#l25.743"></a><span id="l25.743">           }</span>
<a href="#l25.744"></a><span id="l25.744">           event.endDate.makeImmutable();</span>
<a href="#l25.745"></a><span id="l25.745">           this.dispatchEvent(event);</span>
<a href="#l25.746"></a><span id="l25.746">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.747"></a><span id="l25.747">       &lt;/method&gt;</span>
<a href="#l25.748"></a><span id="l25.748"> </span>
<a href="#l25.749"></a><span id="l25.749">       &lt;method name=&quot;setWidth&quot;&gt;</span>
<a href="#l25.750"></a><span id="l25.750">         &lt;parameter name=&quot;width&quot;/&gt;</span>
<a href="#l25.751"></a><span id="l25.751">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.752"></a><span id="l25.752" class="difflineminus">-            var scrollbox =</span>
<a href="#l25.753"></a><span id="l25.753" class="difflineplus">+            let scrollbox =</span>
<a href="#l25.754"></a><span id="l25.754">                 document.getAnonymousElementByAttribute(</span>
<a href="#l25.755"></a><span id="l25.755">                     this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l25.756"></a><span id="l25.756">             scrollbox.setAttribute(&quot;width&quot;, width);</span>
<a href="#l25.757"></a><span id="l25.757">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.758"></a><span id="l25.758">       &lt;/method&gt;</span>
<a href="#l25.759"></a><span id="l25.759"> </span>
<a href="#l25.760"></a><span id="l25.760">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l25.761"></a><span id="l25.761">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.762"></a><span id="l25.762" class="difflineat">@@ -1482,26 +1482,26 @@</span>
<a href="#l25.763"></a><span id="l25.763">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.764"></a><span id="l25.764">       &lt;/method&gt;</span>
<a href="#l25.765"></a><span id="l25.765"> </span>
<a href="#l25.766"></a><span id="l25.766">       &lt;method name=&quot;moveTime&quot;&gt;</span>
<a href="#l25.767"></a><span id="l25.767">         &lt;parameter name=&quot;time&quot;/&gt;</span>
<a href="#l25.768"></a><span id="l25.768">         &lt;parameter name=&quot;delta&quot;/&gt;</span>
<a href="#l25.769"></a><span id="l25.769">         &lt;parameter name=&quot;doclip&quot;/&gt;</span>
<a href="#l25.770"></a><span id="l25.770">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.771"></a><span id="l25.771" class="difflineminus">-          var newTime = time.clone();</span>
<a href="#l25.772"></a><span id="l25.772" class="difflineminus">-          var clip_minutes = 60 * this.zoomFactor / 100;</span>
<a href="#l25.773"></a><span id="l25.773" class="difflineplus">+          let newTime = time.clone();</span>
<a href="#l25.774"></a><span id="l25.774" class="difflineplus">+          let clip_minutes = 60 * this.zoomFactor / 100;</span>
<a href="#l25.775"></a><span id="l25.775">           if (newTime.isDate) {</span>
<a href="#l25.776"></a><span id="l25.776">               clip_minutes = 60 * 24;</span>
<a href="#l25.777"></a><span id="l25.777">           }</span>
<a href="#l25.778"></a><span id="l25.778" class="difflineminus">-          var num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l25.779"></a><span id="l25.779" class="difflineminus">-          var hour_width = this.mContentWidth / num_hours;</span>
<a href="#l25.780"></a><span id="l25.780" class="difflineminus">-          var minutes_per_pixel = 60 / hour_width;</span>
<a href="#l25.781"></a><span id="l25.781" class="difflineminus">-          var minute_shift = minutes_per_pixel * delta;</span>
<a href="#l25.782"></a><span id="l25.782" class="difflineminus">-          var isClipped = Math.abs(minute_shift) &gt;= (this.mfClipRatio * clip_minutes);</span>
<a href="#l25.783"></a><span id="l25.783" class="difflineplus">+          let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l25.784"></a><span id="l25.784" class="difflineplus">+          let hour_width = this.mContentWidth / num_hours;</span>
<a href="#l25.785"></a><span id="l25.785" class="difflineplus">+          let minutes_per_pixel = 60 / hour_width;</span>
<a href="#l25.786"></a><span id="l25.786" class="difflineplus">+          let minute_shift = minutes_per_pixel * delta;</span>
<a href="#l25.787"></a><span id="l25.787" class="difflineplus">+          let isClipped = Math.abs(minute_shift) &gt;= (this.mfClipRatio * clip_minutes);</span>
<a href="#l25.788"></a><span id="l25.788">           if (isClipped) {</span>
<a href="#l25.789"></a><span id="l25.789">               if (delta &gt; 0) {</span>
<a href="#l25.790"></a><span id="l25.790">                   if (time.isDate) {</span>
<a href="#l25.791"></a><span id="l25.791">                       newTime.day++;</span>
<a href="#l25.792"></a><span id="l25.792">                   } else {</span>
<a href="#l25.793"></a><span id="l25.793">                       if (doclip) {</span>
<a href="#l25.794"></a><span id="l25.794">                           newTime.minute -= newTime.minute % clip_minutes;</span>
<a href="#l25.795"></a><span id="l25.795">                       }</span>
<a href="#l25.796"></a><span id="l25.796" class="difflineat">@@ -1532,19 +1532,19 @@</span>
<a href="#l25.797"></a><span id="l25.797"> </span>
<a href="#l25.798"></a><span id="l25.798">           return newTime;</span>
<a href="#l25.799"></a><span id="l25.799">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.800"></a><span id="l25.800">       &lt;/method&gt;</span>
<a href="#l25.801"></a><span id="l25.801">     &lt;/implementation&gt;</span>
<a href="#l25.802"></a><span id="l25.802"> </span>
<a href="#l25.803"></a><span id="l25.803">     &lt;handlers&gt;</span>
<a href="#l25.804"></a><span id="l25.804">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l25.805"></a><span id="l25.805" class="difflineminus">-        var element = event.target;</span>
<a href="#l25.806"></a><span id="l25.806" class="difflineplus">+        let element = event.target;</span>
<a href="#l25.807"></a><span id="l25.807">         this.mMouseX = event.screenX;</span>
<a href="#l25.808"></a><span id="l25.808" class="difflineminus">-        var mouseX = event.clientX - element.boxObject.x;</span>
<a href="#l25.809"></a><span id="l25.809" class="difflineplus">+        let mouseX = event.clientX - element.boxObject.x;</span>
<a href="#l25.810"></a><span id="l25.810"> </span>
<a href="#l25.811"></a><span id="l25.811">         if (mouseX &gt;= this.mMargin) {</span>
<a href="#l25.812"></a><span id="l25.812">             if (mouseX &lt;= (this.mMargin + this.mWidth)) {</span>
<a href="#l25.813"></a><span id="l25.813">                 if (mouseX &lt;= (this.mMargin + this.leftdragWidth)) {</span>
<a href="#l25.814"></a><span id="l25.814">                     // Move the startdate only...</span>
<a href="#l25.815"></a><span id="l25.815">                     window.setCursor(&quot;w-resize&quot;);</span>
<a href="#l25.816"></a><span id="l25.816">                     this.mDragState = 2;</span>
<a href="#l25.817"></a><span id="l25.817">                 } else if (mouseX &gt;= (this.mMargin + this.mWidth - (this.rightdragWidth))) {</span>
<a href="#l25.818"></a><span id="l25.818" class="difflineat">@@ -1556,17 +1556,17 @@</span>
<a href="#l25.819"></a><span id="l25.819">                     this.mDragState = 1;</span>
<a href="#l25.820"></a><span id="l25.820">                     window.setCursor(&quot;grab&quot;);</span>
<a href="#l25.821"></a><span id="l25.821">                 }</span>
<a href="#l25.822"></a><span id="l25.822">             }</span>
<a href="#l25.823"></a><span id="l25.823">         }</span>
<a href="#l25.824"></a><span id="l25.824">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l25.825"></a><span id="l25.825"> </span>
<a href="#l25.826"></a><span id="l25.826">       &lt;handler event=&quot;mousemove&quot;&gt;&lt;![CDATA[</span>
<a href="#l25.827"></a><span id="l25.827" class="difflineminus">-        var mouseX = event.screenX;</span>
<a href="#l25.828"></a><span id="l25.828" class="difflineplus">+        let mouseX = event.screenX;</span>
<a href="#l25.829"></a><span id="l25.829">         if (this.mDragState == 1) {</span>
<a href="#l25.830"></a><span id="l25.830">             // Move the startdate and the enddate</span>
<a href="#l25.831"></a><span id="l25.831">             let delta = mouseX - this.mMouseX;</span>
<a href="#l25.832"></a><span id="l25.832">             let newStart = this.moveTime(this.mStartDate, delta, false);</span>
<a href="#l25.833"></a><span id="l25.833">             if (newStart.compare(this.mStartDate) != 0) {</span>
<a href="#l25.834"></a><span id="l25.834">                 newEnd = this.moveTime(this.mEndDate, delta, false);</span>
<a href="#l25.835"></a><span id="l25.835"> </span>
<a href="#l25.836"></a><span id="l25.836">                 // We need to adapt this date in case we're dealing with</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -30,28 +30,28 @@</span>
<a href="#l26.4"></a><span id="l26.4">           &lt;children/&gt;</span>
<a href="#l26.5"></a><span id="l26.5">         &lt;/xul:box&gt;</span>
<a href="#l26.6"></a><span id="l26.6">       &lt;/xul:box&gt;</span>
<a href="#l26.7"></a><span id="l26.7">     &lt;/content&gt;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9">     &lt;implementation&gt;</span>
<a href="#l26.10"></a><span id="l26.10">       &lt;property name=&quot;x&quot;&gt;</span>
<a href="#l26.11"></a><span id="l26.11">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-          var content =</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+          let content =</span>
<a href="#l26.14"></a><span id="l26.14">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.15"></a><span id="l26.15">                   this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l26.16"></a><span id="l26.16">           content.setAttribute(&quot;style&quot;,</span>
<a href="#l26.17"></a><span id="l26.17">                                &quot;margin-inline-start: &quot; + (-val) + &quot;px;&quot;);</span>
<a href="#l26.18"></a><span id="l26.18">           return val;</span>
<a href="#l26.19"></a><span id="l26.19">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.20"></a><span id="l26.20">       &lt;/property&gt;</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22">       &lt;property name=&quot;y&quot;&gt;</span>
<a href="#l26.23"></a><span id="l26.23">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-          var content =</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+          let content =</span>
<a href="#l26.26"></a><span id="l26.26">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.27"></a><span id="l26.27">                   this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l26.28"></a><span id="l26.28">           content.setAttribute(&quot;style&quot;,</span>
<a href="#l26.29"></a><span id="l26.29">                                &quot;margin-top: &quot; + (-val) + &quot;px;&quot;);</span>
<a href="#l26.30"></a><span id="l26.30">           return val;</span>
<a href="#l26.31"></a><span id="l26.31">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.32"></a><span id="l26.32">       &lt;/property&gt;</span>
<a href="#l26.33"></a><span id="l26.33">     &lt;/implementation&gt;</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineat">@@ -140,26 +140,26 @@</span>
<a href="#l26.35"></a><span id="l26.35">           this.mEndDate = val.clone();</span>
<a href="#l26.36"></a><span id="l26.36">           this.mEndDate.makeImmutable();</span>
<a href="#l26.37"></a><span id="l26.37">           return val;</span>
<a href="#l26.38"></a><span id="l26.38">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.39"></a><span id="l26.39">       &lt;/property&gt;</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41">       &lt;property name=&quot;dayHeight&quot;&gt;</span>
<a href="#l26.42"></a><span id="l26.42">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-          var day =</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+          let day =</span>
<a href="#l26.45"></a><span id="l26.45">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.46"></a><span id="l26.46">                   this, &quot;anonid&quot;, &quot;day&quot;);</span>
<a href="#l26.47"></a><span id="l26.47">           return day.boxObject.height;</span>
<a href="#l26.48"></a><span id="l26.48">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.49"></a><span id="l26.49">       &lt;/property&gt;</span>
<a href="#l26.50"></a><span id="l26.50"> </span>
<a href="#l26.51"></a><span id="l26.51">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l26.52"></a><span id="l26.52">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-          var date = val.clone();</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+          let date = val.clone();</span>
<a href="#l26.55"></a><span id="l26.55">           date.hour = 0;</span>
<a href="#l26.56"></a><span id="l26.56">           date.minute = 0;</span>
<a href="#l26.57"></a><span id="l26.57">           date.isDate = false;</span>
<a href="#l26.58"></a><span id="l26.58"> </span>
<a href="#l26.59"></a><span id="l26.59">           if (!this.mDateFormatter) {</span>
<a href="#l26.60"></a><span id="l26.60">               this.mDateFormatter =</span>
<a href="#l26.61"></a><span id="l26.61">                   Components.classes[</span>
<a href="#l26.62"></a><span id="l26.62">                       &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineat">@@ -254,20 +254,20 @@</span>
<a href="#l26.64"></a><span id="l26.64"> </span>
<a href="#l26.65"></a><span id="l26.65">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l26.66"></a><span id="l26.66">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.67"></a><span id="l26.67">           return this.mZoomFactor;</span>
<a href="#l26.68"></a><span id="l26.68">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.69"></a><span id="l26.69">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.70"></a><span id="l26.70">           this.mZoomFactor = val;</span>
<a href="#l26.71"></a><span id="l26.71"> </span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-          var template =</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+          let template =</span>
<a href="#l26.74"></a><span id="l26.74">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.75"></a><span id="l26.75">                   this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineminus">-          var parent = template.parentNode;</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+          let parent = template.parentNode;</span>
<a href="#l26.78"></a><span id="l26.78">           while (parent.childNodes.length &gt; 1) {</span>
<a href="#l26.79"></a><span id="l26.79">               parent.lastChild.remove();</span>
<a href="#l26.80"></a><span id="l26.80">           }</span>
<a href="#l26.81"></a><span id="l26.81"> </span>
<a href="#l26.82"></a><span id="l26.82">           template.force24Hours = this.mForce24Hours;</span>
<a href="#l26.83"></a><span id="l26.83">           template.zoomFactor = this.mZoomFactor;</span>
<a href="#l26.84"></a><span id="l26.84"> </span>
<a href="#l26.85"></a><span id="l26.85">           this.onLoad();</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineat">@@ -279,21 +279,21 @@</span>
<a href="#l26.87"></a><span id="l26.87">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l26.88"></a><span id="l26.88">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.89"></a><span id="l26.89">           return this.mForce24Hours;</span>
<a href="#l26.90"></a><span id="l26.90">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.91"></a><span id="l26.91">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.92"></a><span id="l26.92">           this.mForce24Hours = val;</span>
<a href="#l26.93"></a><span id="l26.93">           this.initTimeRange();</span>
<a href="#l26.94"></a><span id="l26.94"> </span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-          var template =</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+          let template =</span>
<a href="#l26.97"></a><span id="l26.97">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.98"></a><span id="l26.98">                   this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l26.99"></a><span id="l26.99"> </span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-          var parent = template.parentNode;</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+          let parent = template.parentNode;</span>
<a href="#l26.102"></a><span id="l26.102">           while (parent.childNodes.length &gt; 1) {</span>
<a href="#l26.103"></a><span id="l26.103">             parent.lastChild.remove();</span>
<a href="#l26.104"></a><span id="l26.104">           }</span>
<a href="#l26.105"></a><span id="l26.105"> </span>
<a href="#l26.106"></a><span id="l26.106">           template.force24Hours = this.mForce24Hours;</span>
<a href="#l26.107"></a><span id="l26.107">           template.zoomFactor = this.mZoomFactor;</span>
<a href="#l26.108"></a><span id="l26.108"> </span>
<a href="#l26.109"></a><span id="l26.109">           this.onLoad();</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineat">@@ -302,17 +302,17 @@</span>
<a href="#l26.111"></a><span id="l26.111">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.112"></a><span id="l26.112">       &lt;/property&gt;</span>
<a href="#l26.113"></a><span id="l26.113"> </span>
<a href="#l26.114"></a><span id="l26.114">       &lt;property name=&quot;contentWidth&quot;&gt;</span>
<a href="#l26.115"></a><span id="l26.115">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.116"></a><span id="l26.116">           // Calculate the difference between the first to day-elements, since</span>
<a href="#l26.117"></a><span id="l26.117">           // the width of the head element does not specify the width we need</span>
<a href="#l26.118"></a><span id="l26.118">           // due to an arbitrary margin value.</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-          var template =</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+          let template =</span>
<a href="#l26.121"></a><span id="l26.121">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.122"></a><span id="l26.122">                   this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l26.123"></a><span id="l26.123">           return template.nextSibling.boxObject.x - template.boxObject.x;</span>
<a href="#l26.124"></a><span id="l26.124">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.125"></a><span id="l26.125">       &lt;/property&gt;</span>
<a href="#l26.126"></a><span id="l26.126"> </span>
<a href="#l26.127"></a><span id="l26.127">       &lt;property name=&quot;containerWidth&quot;&gt;</span>
<a href="#l26.128"></a><span id="l26.128">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineat">@@ -340,176 +340,176 @@</span>
<a href="#l26.130"></a><span id="l26.130">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.131"></a><span id="l26.131">           return this.mEndDate;</span>
<a href="#l26.132"></a><span id="l26.132">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.133"></a><span id="l26.133">       &lt;/property&gt;</span>
<a href="#l26.134"></a><span id="l26.134"> </span>
<a href="#l26.135"></a><span id="l26.135">       &lt;property name=&quot;dayOffset&quot;&gt;</span>
<a href="#l26.136"></a><span id="l26.136">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.137"></a><span id="l26.137">           this.mDayOffset = val;</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineminus">-          var container =</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineplus">+          let container =</span>
<a href="#l26.140"></a><span id="l26.140">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.141"></a><span id="l26.141">                   this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineminus">-          var date = this.mStartDate.clone();</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineplus">+          let date = this.mStartDate.clone();</span>
<a href="#l26.144"></a><span id="l26.144">           date.day += val;</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineminus">-          var numChilds = container.childNodes.length;</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-          for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-              var child = container.childNodes[i];</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineplus">+          let numChilds = container.childNodes.length;</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+          for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+              let child = container.childNodes[i];</span>
<a href="#l26.151"></a><span id="l26.151">               child.date = date;</span>
<a href="#l26.152"></a><span id="l26.152">               date.day++;</span>
<a href="#l26.153"></a><span id="l26.153">           }</span>
<a href="#l26.154"></a><span id="l26.154">           return val;</span>
<a href="#l26.155"></a><span id="l26.155">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.156"></a><span id="l26.156">       &lt;/property&gt;</span>
<a href="#l26.157"></a><span id="l26.157"> </span>
<a href="#l26.158"></a><span id="l26.158">       &lt;property name=&quot;step&quot;&gt;</span>
<a href="#l26.159"></a><span id="l26.159">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.160"></a><span id="l26.160">           // How much pixels spans a single day</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineminus">-          var oneday = this.contentWidth;</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineplus">+          let oneday = this.contentWidth;</span>
<a href="#l26.163"></a><span id="l26.163"> </span>
<a href="#l26.164"></a><span id="l26.164">           // The difference in pixels between the content and the container.</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-          var shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+          let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l26.167"></a><span id="l26.167"> </span>
<a href="#l26.168"></a><span id="l26.168">           // What we want to know is the scale of the total shift</span>
<a href="#l26.169"></a><span id="l26.169">           // needed to step one block further. Since the content</span>
<a href="#l26.170"></a><span id="l26.170">           // is divided into 'numHours' equal parts, we can simply state:</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineminus">-          var numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineplus">+          let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l26.173"></a><span id="l26.173">           return (this.contentWidth) / (numHours * shift);</span>
<a href="#l26.174"></a><span id="l26.174">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.175"></a><span id="l26.175">       &lt;/property&gt;</span>
<a href="#l26.176"></a><span id="l26.176"> </span>
<a href="#l26.177"></a><span id="l26.177">       &lt;property name=&quot;scroll&quot;&gt;</span>
<a href="#l26.178"></a><span id="l26.178">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.179"></a><span id="l26.179">           this.mScrollOffset = val;</span>
<a href="#l26.180"></a><span id="l26.180"> </span>
<a href="#l26.181"></a><span id="l26.181">           // How much pixels spans a single day</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineminus">-          var oneday = this.contentWidth;</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineplus">+          let oneday = this.contentWidth;</span>
<a href="#l26.184"></a><span id="l26.184"> </span>
<a href="#l26.185"></a><span id="l26.185">           // The difference in pixels between the content and the container.</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-          var shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineplus">+          let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l26.188"></a><span id="l26.188"> </span>
<a href="#l26.189"></a><span id="l26.189">           // Now calculate the (positive) offset in pixels which the content</span>
<a href="#l26.190"></a><span id="l26.190">           // needs to be shifted. This is a simple scaling in one dimension.</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineminus">-          var offset = Math.floor(val * shift);</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineplus">+          let offset = Math.floor(val * shift);</span>
<a href="#l26.193"></a><span id="l26.193"> </span>
<a href="#l26.194"></a><span id="l26.194">           // Now find out how much days this offset effectively skips.</span>
<a href="#l26.195"></a><span id="l26.195">           // this is a simple division which always yields a positive integer value.</span>
<a href="#l26.196"></a><span id="l26.196">           this.dayOffset = (offset - (offset % oneday)) / oneday;</span>
<a href="#l26.197"></a><span id="l26.197"> </span>
<a href="#l26.198"></a><span id="l26.198">           // Set the pixel offset for the content which will always need</span>
<a href="#l26.199"></a><span id="l26.199">           // to be in the range [0 &lt;= offset &lt;= oneday].</span>
<a href="#l26.200"></a><span id="l26.200">           offset %= oneday;</span>
<a href="#l26.201"></a><span id="l26.201"> </span>
<a href="#l26.202"></a><span id="l26.202">           // Set the offset at the content node.</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-          var container =</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+          let container =</span>
<a href="#l26.205"></a><span id="l26.205">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.206"></a><span id="l26.206">                   this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l26.207"></a><span id="l26.207">           container.x = offset;</span>
<a href="#l26.208"></a><span id="l26.208">           return val;</span>
<a href="#l26.209"></a><span id="l26.209">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.210"></a><span id="l26.210">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.211"></a><span id="l26.211">           return this.mScrollOffset;</span>
<a href="#l26.212"></a><span id="l26.212">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.213"></a><span id="l26.213">       &lt;/property&gt;</span>
<a href="#l26.214"></a><span id="l26.214"> </span>
<a href="#l26.215"></a><span id="l26.215">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l26.216"></a><span id="l26.216">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l26.217"></a><span id="l26.217"> </span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-        var args = window.arguments[0];</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-        var startTime = args.startTime;</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-        var endTime = args.endTime;</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+        let args = window.arguments[0];</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineplus">+        let startTime = args.startTime;</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineplus">+        let endTime = args.endTime;</span>
<a href="#l26.224"></a><span id="l26.224"> </span>
<a href="#l26.225"></a><span id="l26.225">         this.initTimeRange();</span>
<a href="#l26.226"></a><span id="l26.226"> </span>
<a href="#l26.227"></a><span id="l26.227">         // The basedate is the date/time from which the display</span>
<a href="#l26.228"></a><span id="l26.228">         // of the timebar starts. The range is the number of days</span>
<a href="#l26.229"></a><span id="l26.229">         // we should be able to show. The start- and enddate</span>
<a href="#l26.230"></a><span id="l26.230">         // is the time the event is scheduled for.</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-        var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineplus">+        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.233"></a><span id="l26.233">         this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.234"></a><span id="l26.234">         this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.235"></a><span id="l26.235">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l26.236"></a><span id="l26.236"> </span>
<a href="#l26.237"></a><span id="l26.237" class="difflineminus">-        var self = this;</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineminus">-        var load = function loadHandler() {</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineplus">+        let self = this;</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineplus">+        let load = function loadHandler() {</span>
<a href="#l26.241"></a><span id="l26.241">             self.onLoad();</span>
<a href="#l26.242"></a><span id="l26.242">         };</span>
<a href="#l26.243"></a><span id="l26.243">         window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l26.244"></a><span id="l26.244">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l26.245"></a><span id="l26.245"> </span>
<a href="#l26.246"></a><span id="l26.246">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l26.247"></a><span id="l26.247">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-          var date = this.mStartDate.clone();</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-          var template =</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineplus">+          let date = this.mStartDate.clone();</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+          let template =</span>
<a href="#l26.252"></a><span id="l26.252">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.253"></a><span id="l26.253">                   this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineminus">-          var parent = template.parentNode;</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineminus">-          var numChilds = parent.childNodes.length;</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineminus">-          for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineminus">-              var child = parent.childNodes[i];</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineplus">+          let parent = template.parentNode;</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineplus">+          let numChilds = parent.childNodes.length;</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineplus">+          for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineplus">+              let child = parent.childNodes[i];</span>
<a href="#l26.262"></a><span id="l26.262">               child.startDate = this.mStartDate;</span>
<a href="#l26.263"></a><span id="l26.263">               child.endDate = this.mEndDate;</span>
<a href="#l26.264"></a><span id="l26.264">               child.date = date;</span>
<a href="#l26.265"></a><span id="l26.265">               date.day++;</span>
<a href="#l26.266"></a><span id="l26.266">           }</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-          var offset = this.mDayOffset;</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineplus">+          let offset = this.mDayOffset;</span>
<a href="#l26.269"></a><span id="l26.269">           this.dayOffset = offset;</span>
<a href="#l26.270"></a><span id="l26.270">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.271"></a><span id="l26.271">       &lt;/method&gt;</span>
<a href="#l26.272"></a><span id="l26.272"> </span>
<a href="#l26.273"></a><span id="l26.273">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l26.274"></a><span id="l26.274">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.275"></a><span id="l26.275">             this.initialize();</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineminus">-            var template =</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineplus">+            let template =</span>
<a href="#l26.278"></a><span id="l26.278">                 document.getAnonymousElementByAttribute(</span>
<a href="#l26.279"></a><span id="l26.279">                     this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l26.280"></a><span id="l26.280" class="difflineminus">-            var event = document.createEvent('Events');</span>
<a href="#l26.281"></a><span id="l26.281" class="difflineplus">+            let event = document.createEvent('Events');</span>
<a href="#l26.282"></a><span id="l26.282">             event.initEvent('timebar', true, false);</span>
<a href="#l26.283"></a><span id="l26.283">             event.details = this.contentWidth;</span>
<a href="#l26.284"></a><span id="l26.284">             event.height = template.dayHeight;</span>
<a href="#l26.285"></a><span id="l26.285">             this.dispatchEvent(event);</span>
<a href="#l26.286"></a><span id="l26.286">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.287"></a><span id="l26.287">       &lt;/method&gt;</span>
<a href="#l26.288"></a><span id="l26.288"> </span>
<a href="#l26.289"></a><span id="l26.289">       &lt;method name=&quot;initialize&quot;&gt;</span>
<a href="#l26.290"></a><span id="l26.290">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.291"></a><span id="l26.291" class="difflineminus">-          var args = window.arguments[0];</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineminus">-          var startTime = args.startTime;</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineminus">-          var endTime = args.endTime;</span>
<a href="#l26.294"></a><span id="l26.294" class="difflineminus">-          var calendar = args.calendar;</span>
<a href="#l26.295"></a><span id="l26.295" class="difflineplus">+          let args = window.arguments[0];</span>
<a href="#l26.296"></a><span id="l26.296" class="difflineplus">+          let startTime = args.startTime;</span>
<a href="#l26.297"></a><span id="l26.297" class="difflineplus">+          let endTime = args.endTime;</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineplus">+          let calendar = args.calendar;</span>
<a href="#l26.299"></a><span id="l26.299"> </span>
<a href="#l26.300"></a><span id="l26.300" class="difflineminus">-          var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.301"></a><span id="l26.301" class="difflineplus">+          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.302"></a><span id="l26.302">           this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.303"></a><span id="l26.303">           this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.304"></a><span id="l26.304"> </span>
<a href="#l26.305"></a><span id="l26.305">           // Set the number of 'freebusy-day'-elements</span>
<a href="#l26.306"></a><span id="l26.306">           // we need to fill up the content box.</span>
<a href="#l26.307"></a><span id="l26.307">           // TODO: hardcoded value</span>
<a href="#l26.308"></a><span id="l26.308">           this.mNumDays = 4 * this.mZoomFactor / 100;</span>
<a href="#l26.309"></a><span id="l26.309">           if (this.mNumDays &lt; 2) {</span>
<a href="#l26.310"></a><span id="l26.310">               this.mNumDays = 2;</span>
<a href="#l26.311"></a><span id="l26.311">           }</span>
<a href="#l26.312"></a><span id="l26.312"> </span>
<a href="#l26.313"></a><span id="l26.313">           // Now create those elements and set their date property.</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineminus">-          var date = this.mStartDate.clone();</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineminus">-          var template =</span>
<a href="#l26.316"></a><span id="l26.316" class="difflineplus">+          let date = this.mStartDate.clone();</span>
<a href="#l26.317"></a><span id="l26.317" class="difflineplus">+          let template =</span>
<a href="#l26.318"></a><span id="l26.318">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.319"></a><span id="l26.319">                   this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l26.320"></a><span id="l26.320">           template.force24Hours = this.mForce24Hours;</span>
<a href="#l26.321"></a><span id="l26.321">           template.zoomFactor = this.mZoomFactor;</span>
<a href="#l26.322"></a><span id="l26.322">           template.startDate = this.mStartDate;</span>
<a href="#l26.323"></a><span id="l26.323">           template.endDate = this.mEndDate;</span>
<a href="#l26.324"></a><span id="l26.324">           template.date = date;</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineminus">-          var parent = template.parentNode;</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineplus">+          let parent = template.parentNode;</span>
<a href="#l26.327"></a><span id="l26.327">           if (parent.childNodes.length &lt;= 1) {</span>
<a href="#l26.328"></a><span id="l26.328" class="difflineminus">-              var count = this.mNumDays - 1;</span>
<a href="#l26.329"></a><span id="l26.329" class="difflineplus">+              let count = this.mNumDays - 1;</span>
<a href="#l26.330"></a><span id="l26.330">               if (count &gt; 0) {</span>
<a href="#l26.331"></a><span id="l26.331" class="difflineminus">-                  for (var i = 0; i &lt; count; i++) {</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineplus">+                  for (let i = 0; i &lt; count; i++) {</span>
<a href="#l26.333"></a><span id="l26.333">                       date.day++;</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineminus">-                      var newNode = template.cloneNode(false);</span>
<a href="#l26.335"></a><span id="l26.335" class="difflineplus">+                      let newNode = template.cloneNode(false);</span>
<a href="#l26.336"></a><span id="l26.336">                       newNode.force24Hours = this.mForce24Hours;</span>
<a href="#l26.337"></a><span id="l26.337">                       newNode.zoomFactor = this.mZoomFactor;</span>
<a href="#l26.338"></a><span id="l26.338">                       newNode.startDate = this.mStartDate;</span>
<a href="#l26.339"></a><span id="l26.339">                       newNode.endDate = this.mEndDate;</span>
<a href="#l26.340"></a><span id="l26.340">                       newNode.date = date;</span>
<a href="#l26.341"></a><span id="l26.341">                       parent.appendChild(newNode);</span>
<a href="#l26.342"></a><span id="l26.342">                   }</span>
<a href="#l26.343"></a><span id="l26.343">               }</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineat">@@ -601,24 +601,24 @@</span>
<a href="#l26.345"></a><span id="l26.345">           this.mEndDate.isDate = false;</span>
<a href="#l26.346"></a><span id="l26.346">           this.mEndDate.makeImmutable();</span>
<a href="#l26.347"></a><span id="l26.347">           return val;</span>
<a href="#l26.348"></a><span id="l26.348">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.349"></a><span id="l26.349">       &lt;/property&gt;</span>
<a href="#l26.350"></a><span id="l26.350"> </span>
<a href="#l26.351"></a><span id="l26.351">       &lt;property name=&quot;numHours&quot;&gt;</span>
<a href="#l26.352"></a><span id="l26.352">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineminus">-          var numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l26.354"></a><span id="l26.354" class="difflineplus">+          let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l26.355"></a><span id="l26.355">           return Math.ceil(numHours * 100 / this.mZoomFactor);</span>
<a href="#l26.356"></a><span id="l26.356">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.357"></a><span id="l26.357">       &lt;/property&gt;</span>
<a href="#l26.358"></a><span id="l26.358"> </span>
<a href="#l26.359"></a><span id="l26.359">       &lt;property name=&quot;contentWidth&quot;&gt;</span>
<a href="#l26.360"></a><span id="l26.360">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.361"></a><span id="l26.361" class="difflineminus">-          var hours =</span>
<a href="#l26.362"></a><span id="l26.362" class="difflineplus">+          let hours =</span>
<a href="#l26.363"></a><span id="l26.363">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.364"></a><span id="l26.364">                   this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l26.365"></a><span id="l26.365">           return (hours.childNodes[1].boxObject.x -</span>
<a href="#l26.366"></a><span id="l26.366">                   hours.childNodes[0].boxObject.x) *</span>
<a href="#l26.367"></a><span id="l26.367">                   this.numHours;</span>
<a href="#l26.368"></a><span id="l26.368">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.369"></a><span id="l26.369">       &lt;/property&gt;</span>
<a href="#l26.370"></a><span id="l26.370"> </span>
<a href="#l26.371"></a><span id="l26.371" class="difflineat">@@ -644,38 +644,38 @@</span>
<a href="#l26.372"></a><span id="l26.372">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.373"></a><span id="l26.373">           return this.contentWidth * this.mRange;</span>
<a href="#l26.374"></a><span id="l26.374">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.375"></a><span id="l26.375">       &lt;/property&gt;</span>
<a href="#l26.376"></a><span id="l26.376"> </span>
<a href="#l26.377"></a><span id="l26.377">       &lt;property name=&quot;scroll&quot;&gt;</span>
<a href="#l26.378"></a><span id="l26.378">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.379"></a><span id="l26.379">           // How much pixels spans a single day</span>
<a href="#l26.380"></a><span id="l26.380" class="difflineminus">-          var oneday = this.contentWidth;</span>
<a href="#l26.381"></a><span id="l26.381" class="difflineplus">+          let oneday = this.contentWidth;</span>
<a href="#l26.382"></a><span id="l26.382">           if (oneday &lt;= 0) {</span>
<a href="#l26.383"></a><span id="l26.383">               return val;</span>
<a href="#l26.384"></a><span id="l26.384">           }</span>
<a href="#l26.385"></a><span id="l26.385"> </span>
<a href="#l26.386"></a><span id="l26.386">           // The difference in pixels between the content and the container.</span>
<a href="#l26.387"></a><span id="l26.387" class="difflineminus">-          var shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l26.388"></a><span id="l26.388" class="difflineplus">+          let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l26.389"></a><span id="l26.389"> </span>
<a href="#l26.390"></a><span id="l26.390">           // Now calculate the (positive) offset in pixels which the content</span>
<a href="#l26.391"></a><span id="l26.391">           // needs to be shifted. This is a simple scaling in one dimension.</span>
<a href="#l26.392"></a><span id="l26.392" class="difflineminus">-          var offset = Math.floor(val * shift);</span>
<a href="#l26.393"></a><span id="l26.393" class="difflineplus">+          let offset = Math.floor(val * shift);</span>
<a href="#l26.394"></a><span id="l26.394"> </span>
<a href="#l26.395"></a><span id="l26.395">           // Now find out how much days this offset effectively skips.</span>
<a href="#l26.396"></a><span id="l26.396">           // this is a simple division which always yields a positive integer value.</span>
<a href="#l26.397"></a><span id="l26.397">           this.dayOffset = (offset - (offset % oneday)) / oneday;</span>
<a href="#l26.398"></a><span id="l26.398"> </span>
<a href="#l26.399"></a><span id="l26.399">           // Set the pixel offset for the content which will always need</span>
<a href="#l26.400"></a><span id="l26.400">           // to be in the range [0 &lt;= offset &lt;= oneday].</span>
<a href="#l26.401"></a><span id="l26.401">           offset %= oneday;</span>
<a href="#l26.402"></a><span id="l26.402"> </span>
<a href="#l26.403"></a><span id="l26.403">           // Set the offset at the content node.</span>
<a href="#l26.404"></a><span id="l26.404" class="difflineminus">-          var container =</span>
<a href="#l26.405"></a><span id="l26.405" class="difflineplus">+          let container =</span>
<a href="#l26.406"></a><span id="l26.406">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.407"></a><span id="l26.407">                   this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l26.408"></a><span id="l26.408">           container.x = offset;</span>
<a href="#l26.409"></a><span id="l26.409">           return val;</span>
<a href="#l26.410"></a><span id="l26.410">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.411"></a><span id="l26.411">       &lt;/property&gt;</span>
<a href="#l26.412"></a><span id="l26.412"> </span>
<a href="#l26.413"></a><span id="l26.413">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l26.414"></a><span id="l26.414" class="difflineat">@@ -749,24 +749,24 @@</span>
<a href="#l26.415"></a><span id="l26.415">           // which will map the entries to attributes on the xul elements.</span>
<a href="#l26.416"></a><span id="l26.416">           if (aEntries) {</span>
<a href="#l26.417"></a><span id="l26.417">               // Remember the free/busy array which is used to find a</span>
<a href="#l26.418"></a><span id="l26.418">               // new time for an event. We store this array only if</span>
<a href="#l26.419"></a><span id="l26.419">               // the provider returned a valid array. In any other case</span>
<a href="#l26.420"></a><span id="l26.420">               // (temporarily clean the display) we keep the last know result.</span>
<a href="#l26.421"></a><span id="l26.421">               this.mEntries = aEntries;</span>
<a href="#l26.422"></a><span id="l26.422"> </span>
<a href="#l26.423"></a><span id="l26.423" class="difflineminus">-              var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.424"></a><span id="l26.424" class="difflineplus">+              let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.425"></a><span id="l26.425"> </span>
<a href="#l26.426"></a><span id="l26.426" class="difflineminus">-              var start = this.mStartDate.clone();</span>
<a href="#l26.427"></a><span id="l26.427" class="difflineplus">+              let start = this.mStartDate.clone();</span>
<a href="#l26.428"></a><span id="l26.428">               start.hour = 0;</span>
<a href="#l26.429"></a><span id="l26.429">               start.minute = 0;</span>
<a href="#l26.430"></a><span id="l26.430">               start.second = 0;</span>
<a href="#l26.431"></a><span id="l26.431">               start.timezone = kDefaultTimezone;</span>
<a href="#l26.432"></a><span id="l26.432" class="difflineminus">-              var end = start.clone();</span>
<a href="#l26.433"></a><span id="l26.433" class="difflineplus">+              let end = start.clone();</span>
<a href="#l26.434"></a><span id="l26.434">               end.day += this.mRange;</span>
<a href="#l26.435"></a><span id="l26.435">               end.timezone = kDefaultTimezone;</span>
<a href="#l26.436"></a><span id="l26.436"> </span>
<a href="#l26.437"></a><span id="l26.437">               // First of all set all state slots to 'free'</span>
<a href="#l26.438"></a><span id="l26.438">               for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l26.439"></a><span id="l26.439">                   this.mState[i] = Components.interfaces.calIFreeBusyInterval.FREE;</span>
<a href="#l26.440"></a><span id="l26.440">               }</span>
<a href="#l26.441"></a><span id="l26.441"> </span>
<a href="#l26.442"></a><span id="l26.442" class="difflineat">@@ -897,31 +897,31 @@</span>
<a href="#l26.443"></a><span id="l26.443">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.444"></a><span id="l26.444">       &lt;/method&gt;</span>
<a href="#l26.445"></a><span id="l26.445"> </span>
<a href="#l26.446"></a><span id="l26.446">       &lt;method name=&quot;nextSlot&quot;&gt;</span>
<a href="#l26.447"></a><span id="l26.447">         &lt;parameter name=&quot;aStartTime&quot;/&gt;</span>
<a href="#l26.448"></a><span id="l26.448">         &lt;parameter name=&quot;aEndTime&quot;/&gt;</span>
<a href="#l26.449"></a><span id="l26.449">         &lt;parameter name=&quot;allDay&quot;/&gt;</span>
<a href="#l26.450"></a><span id="l26.450">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.451"></a><span id="l26.451" class="difflineminus">-          var newTime = aStartTime.clone();</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineminus">-          var duration = aEndTime.subtractDate(aStartTime);</span>
<a href="#l26.453"></a><span id="l26.453" class="difflineminus">-          var newEndTime = newTime.clone();</span>
<a href="#l26.454"></a><span id="l26.454" class="difflineplus">+          let newTime = aStartTime.clone();</span>
<a href="#l26.455"></a><span id="l26.455" class="difflineplus">+          let duration = aEndTime.subtractDate(aStartTime);</span>
<a href="#l26.456"></a><span id="l26.456" class="difflineplus">+          let newEndTime = newTime.clone();</span>
<a href="#l26.457"></a><span id="l26.457">           newEndTime.addDuration(duration);</span>
<a href="#l26.458"></a><span id="l26.458"> </span>
<a href="#l26.459"></a><span id="l26.459" class="difflineminus">-          var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.460"></a><span id="l26.460" class="difflineplus">+          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.461"></a><span id="l26.461"> </span>
<a href="#l26.462"></a><span id="l26.462">           if (this.mEntries) {</span>
<a href="#l26.463"></a><span id="l26.463" class="difflineminus">-              for (var entry of this.mEntries) {</span>
<a href="#l26.464"></a><span id="l26.464" class="difflineminus">-                var rangeStart =</span>
<a href="#l26.465"></a><span id="l26.465" class="difflineplus">+              for (let entry of this.mEntries) {</span>
<a href="#l26.466"></a><span id="l26.466" class="difflineplus">+                let rangeStart =</span>
<a href="#l26.467"></a><span id="l26.467">                     entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.468"></a><span id="l26.468" class="difflineminus">-                var rangeEnd =</span>
<a href="#l26.469"></a><span id="l26.469" class="difflineplus">+                let rangeEnd =</span>
<a href="#l26.470"></a><span id="l26.470">                     entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.471"></a><span id="l26.471"> </span>
<a href="#l26.472"></a><span id="l26.472" class="difflineminus">-                var isZeroLength = !newTime.compare(newEndTime);</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineplus">+                let isZeroLength = !newTime.compare(newEndTime);</span>
<a href="#l26.474"></a><span id="l26.474">                 if ((isZeroLength &amp;&amp;</span>
<a href="#l26.475"></a><span id="l26.475">                      newTime.compare(rangeStart) &gt;= 0 &amp;&amp;</span>
<a href="#l26.476"></a><span id="l26.476">                      newTime.compare(rangeEnd) &lt; 0) ||</span>
<a href="#l26.477"></a><span id="l26.477">                     (!isZeroLength &amp;&amp;</span>
<a href="#l26.478"></a><span id="l26.478">                      newTime.compare(rangeEnd) &lt; 0 &amp;&amp;</span>
<a href="#l26.479"></a><span id="l26.479">                      newEndTime.compare(rangeStart) &gt; 0)) {</span>
<a href="#l26.480"></a><span id="l26.480">                     // Current range of event conflicts with another event.</span>
<a href="#l26.481"></a><span id="l26.481">                     // we need to find a new time for this event. A trivial approach</span>
<a href="#l26.482"></a><span id="l26.482" class="difflineat">@@ -1009,112 +1009,112 @@</span>
<a href="#l26.483"></a><span id="l26.483">       &lt;field name=&quot;mZoomFactor&quot;&gt;100&lt;/field&gt;</span>
<a href="#l26.484"></a><span id="l26.484"> </span>
<a href="#l26.485"></a><span id="l26.485">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l26.486"></a><span id="l26.486">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.487"></a><span id="l26.487">           return this.mZoomFactor;</span>
<a href="#l26.488"></a><span id="l26.488">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.489"></a><span id="l26.489">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.490"></a><span id="l26.490">           this.mZoomFactor = val;</span>
<a href="#l26.491"></a><span id="l26.491" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.492"></a><span id="l26.492" class="difflineminus">-              var freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineplus">+              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.495"></a><span id="l26.495">               freebusy.zoomFactor = this.mZoomFactor;</span>
<a href="#l26.496"></a><span id="l26.496">           }</span>
<a href="#l26.497"></a><span id="l26.497">           this.forceRefresh();</span>
<a href="#l26.498"></a><span id="l26.498">           return val;</span>
<a href="#l26.499"></a><span id="l26.499">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.500"></a><span id="l26.500">       &lt;/property&gt;</span>
<a href="#l26.501"></a><span id="l26.501"> </span>
<a href="#l26.502"></a><span id="l26.502">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l26.503"></a><span id="l26.503">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.504"></a><span id="l26.504">           return this.mForce24Hours;</span>
<a href="#l26.505"></a><span id="l26.505">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.506"></a><span id="l26.506">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.507"></a><span id="l26.507">           this.mForce24Hours = val;</span>
<a href="#l26.508"></a><span id="l26.508">           this.initTimeRange();</span>
<a href="#l26.509"></a><span id="l26.509" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.510"></a><span id="l26.510" class="difflineminus">-              var freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.511"></a><span id="l26.511" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineplus">+              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.513"></a><span id="l26.513">               freebusy.force24Hours = this.mForce24Hours;</span>
<a href="#l26.514"></a><span id="l26.514">           }</span>
<a href="#l26.515"></a><span id="l26.515">           return val;</span>
<a href="#l26.516"></a><span id="l26.516">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.517"></a><span id="l26.517">       &lt;/property&gt;</span>
<a href="#l26.518"></a><span id="l26.518"> </span>
<a href="#l26.519"></a><span id="l26.519">       &lt;property name=&quot;firstVisibleRow&quot;&gt;</span>
<a href="#l26.520"></a><span id="l26.520">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.521"></a><span id="l26.521" class="difflineminus">-          var listbox =</span>
<a href="#l26.522"></a><span id="l26.522" class="difflineplus">+          let listbox =</span>
<a href="#l26.523"></a><span id="l26.523">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.524"></a><span id="l26.524">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.525"></a><span id="l26.525">           return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l26.526"></a><span id="l26.526">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.527"></a><span id="l26.527">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.528"></a><span id="l26.528" class="difflineminus">-          var listbox =</span>
<a href="#l26.529"></a><span id="l26.529" class="difflineplus">+          let listbox =</span>
<a href="#l26.530"></a><span id="l26.530">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.531"></a><span id="l26.531">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.532"></a><span id="l26.532">           listbox.scrollToIndex(val);</span>
<a href="#l26.533"></a><span id="l26.533">           return val;</span>
<a href="#l26.534"></a><span id="l26.534">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.535"></a><span id="l26.535">       &lt;/property&gt;</span>
<a href="#l26.536"></a><span id="l26.536"> </span>
<a href="#l26.537"></a><span id="l26.537">       &lt;property name=&quot;ratio&quot;&gt;</span>
<a href="#l26.538"></a><span id="l26.538">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.539"></a><span id="l26.539" class="difflineminus">-          var listbox =</span>
<a href="#l26.540"></a><span id="l26.540" class="difflineplus">+          let listbox =</span>
<a href="#l26.541"></a><span id="l26.541">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.542"></a><span id="l26.542">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.543"></a><span id="l26.543" class="difflineminus">-          var rowcount = listbox.getRowCount();</span>
<a href="#l26.544"></a><span id="l26.544" class="difflineplus">+          let rowcount = listbox.getRowCount();</span>
<a href="#l26.545"></a><span id="l26.545">           listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l26.546"></a><span id="l26.546">           return val;</span>
<a href="#l26.547"></a><span id="l26.547">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.548"></a><span id="l26.548">       &lt;/property&gt;</span>
<a href="#l26.549"></a><span id="l26.549"> </span>
<a href="#l26.550"></a><span id="l26.550">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l26.551"></a><span id="l26.551">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l26.552"></a><span id="l26.552"> </span>
<a href="#l26.553"></a><span id="l26.553" class="difflineminus">-        var args = window.arguments[0];</span>
<a href="#l26.554"></a><span id="l26.554" class="difflineplus">+        let args = window.arguments[0];</span>
<a href="#l26.555"></a><span id="l26.555"> </span>
<a href="#l26.556"></a><span id="l26.556">         this.initTimeRange();</span>
<a href="#l26.557"></a><span id="l26.557"> </span>
<a href="#l26.558"></a><span id="l26.558">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l26.559"></a><span id="l26.559"> </span>
<a href="#l26.560"></a><span id="l26.560">         this.mMaxFreeBusy = 0;</span>
<a href="#l26.561"></a><span id="l26.561">         this.mPendingRequests = [];</span>
<a href="#l26.562"></a><span id="l26.562"> </span>
<a href="#l26.563"></a><span id="l26.563" class="difflineminus">-        var self = this;</span>
<a href="#l26.564"></a><span id="l26.564" class="difflineminus">-        var load = function freebusy_grid_loadHandler() {</span>
<a href="#l26.565"></a><span id="l26.565" class="difflineplus">+        let self = this;</span>
<a href="#l26.566"></a><span id="l26.566" class="difflineplus">+        let load = function freebusy_grid_loadHandler() {</span>
<a href="#l26.567"></a><span id="l26.567">             self.onLoad();</span>
<a href="#l26.568"></a><span id="l26.568">         };</span>
<a href="#l26.569"></a><span id="l26.569">         window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l26.570"></a><span id="l26.570" class="difflineminus">-        var unload = function freebusy_grid_unloadHandler() {</span>
<a href="#l26.571"></a><span id="l26.571" class="difflineplus">+        let unload = function freebusy_grid_unloadHandler() {</span>
<a href="#l26.572"></a><span id="l26.572">             self.onUnload();</span>
<a href="#l26.573"></a><span id="l26.573">         };</span>
<a href="#l26.574"></a><span id="l26.574">         window.addEventListener(&quot;unload&quot;, unload, true);</span>
<a href="#l26.575"></a><span id="l26.575">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l26.576"></a><span id="l26.576"> </span>
<a href="#l26.577"></a><span id="l26.577">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l26.578"></a><span id="l26.578">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.579"></a><span id="l26.579">           return this.mStartDate;</span>
<a href="#l26.580"></a><span id="l26.580">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.581"></a><span id="l26.581">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.582"></a><span id="l26.582">           this.mStartDate = val.clone();</span>
<a href="#l26.583"></a><span id="l26.583">           this.mStartDate.makeImmutable();</span>
<a href="#l26.584"></a><span id="l26.584" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.585"></a><span id="l26.585" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.586"></a><span id="l26.586">               this.getFreeBusyElement(i).startDate = val;</span>
<a href="#l26.587"></a><span id="l26.587">           }</span>
<a href="#l26.588"></a><span id="l26.588">           return val;</span>
<a href="#l26.589"></a><span id="l26.589">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.590"></a><span id="l26.590">       &lt;/property&gt;</span>
<a href="#l26.591"></a><span id="l26.591"> </span>
<a href="#l26.592"></a><span id="l26.592">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l26.593"></a><span id="l26.593">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.594"></a><span id="l26.594">           return this.mEndDate;</span>
<a href="#l26.595"></a><span id="l26.595">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.596"></a><span id="l26.596">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.597"></a><span id="l26.597">           this.mEndDate = val.clone();</span>
<a href="#l26.598"></a><span id="l26.598">           this.mEndDate.makeImmutable();</span>
<a href="#l26.599"></a><span id="l26.599" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.600"></a><span id="l26.600" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.601"></a><span id="l26.601">               this.getFreeBusyElement(i).endDate = val;</span>
<a href="#l26.602"></a><span id="l26.602">           }</span>
<a href="#l26.603"></a><span id="l26.603">           return val;</span>
<a href="#l26.604"></a><span id="l26.604">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.605"></a><span id="l26.605">       &lt;/property&gt;</span>
<a href="#l26.606"></a><span id="l26.606"> </span>
<a href="#l26.607"></a><span id="l26.607">       &lt;property name=&quot;documentSize&quot;&gt;</span>
<a href="#l26.608"></a><span id="l26.608">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.609"></a><span id="l26.609" class="difflineat">@@ -1126,39 +1126,39 @@</span>
<a href="#l26.610"></a><span id="l26.610">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.611"></a><span id="l26.611">           this.onInitialize();</span>
<a href="#l26.612"></a><span id="l26.612">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.613"></a><span id="l26.613">       &lt;/method&gt;</span>
<a href="#l26.614"></a><span id="l26.614"> </span>
<a href="#l26.615"></a><span id="l26.615">       &lt;method name=&quot;onUnload&quot;&gt;</span>
<a href="#l26.616"></a><span id="l26.616">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.617"></a><span id="l26.617">           // Cancel pending free/busy requests</span>
<a href="#l26.618"></a><span id="l26.618" class="difflineminus">-          for (var request of this.mPendingRequests) {</span>
<a href="#l26.619"></a><span id="l26.619" class="difflineplus">+          for (let request of this.mPendingRequests) {</span>
<a href="#l26.620"></a><span id="l26.620">               request.cancel(null);</span>
<a href="#l26.621"></a><span id="l26.621">           }</span>
<a href="#l26.622"></a><span id="l26.622"> </span>
<a href="#l26.623"></a><span id="l26.623">           this.mPendingRequests = [];</span>
<a href="#l26.624"></a><span id="l26.624">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.625"></a><span id="l26.625">       &lt;/method&gt;</span>
<a href="#l26.626"></a><span id="l26.626"> </span>
<a href="#l26.627"></a><span id="l26.627">       &lt;method name=&quot;onInitialize&quot;&gt;</span>
<a href="#l26.628"></a><span id="l26.628">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.629"></a><span id="l26.629" class="difflineminus">-          var args = window.arguments[0];</span>
<a href="#l26.630"></a><span id="l26.630" class="difflineminus">-          var startTime = args.startTime;</span>
<a href="#l26.631"></a><span id="l26.631" class="difflineminus">-          var endTime = args.endTime;</span>
<a href="#l26.632"></a><span id="l26.632" class="difflineminus">-          var calendar = args.calendar;</span>
<a href="#l26.633"></a><span id="l26.633" class="difflineplus">+          let args = window.arguments[0];</span>
<a href="#l26.634"></a><span id="l26.634" class="difflineplus">+          let startTime = args.startTime;</span>
<a href="#l26.635"></a><span id="l26.635" class="difflineplus">+          let endTime = args.endTime;</span>
<a href="#l26.636"></a><span id="l26.636" class="difflineplus">+          let calendar = args.calendar;</span>
<a href="#l26.637"></a><span id="l26.637"> </span>
<a href="#l26.638"></a><span id="l26.638" class="difflineminus">-          var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.639"></a><span id="l26.639" class="difflineplus">+          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l26.640"></a><span id="l26.640">           this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.641"></a><span id="l26.641">           this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l26.642"></a><span id="l26.642"> </span>
<a href="#l26.643"></a><span id="l26.643" class="difflineminus">-          var listbox =</span>
<a href="#l26.644"></a><span id="l26.644" class="difflineplus">+          let listbox =</span>
<a href="#l26.645"></a><span id="l26.645">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.646"></a><span id="l26.646">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.647"></a><span id="l26.647" class="difflineminus">-          var template =</span>
<a href="#l26.648"></a><span id="l26.648" class="difflineplus">+          let template =</span>
<a href="#l26.649"></a><span id="l26.649">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.650"></a><span id="l26.650">                   this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l26.651"></a><span id="l26.651">           this.appendNewRow(listbox, template, null);</span>
<a href="#l26.652"></a><span id="l26.652">           template.remove();</span>
<a href="#l26.653"></a><span id="l26.653"> </span>
<a href="#l26.654"></a><span id="l26.654">           this.updateFreeBusy();</span>
<a href="#l26.655"></a><span id="l26.655">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.656"></a><span id="l26.656">       &lt;/method&gt;</span>
<a href="#l26.657"></a><span id="l26.657" class="difflineat">@@ -1171,27 +1171,27 @@</span>
<a href="#l26.658"></a><span id="l26.658"> </span>
<a href="#l26.659"></a><span id="l26.659">       &lt;!-- appends a new empty row --&gt;</span>
<a href="#l26.660"></a><span id="l26.660">       &lt;method name=&quot;appendNewRow&quot;&gt;</span>
<a href="#l26.661"></a><span id="l26.661">         &lt;parameter name=&quot;aParentNode&quot;/&gt;</span>
<a href="#l26.662"></a><span id="l26.662">         &lt;parameter name=&quot;aTemplateNode&quot;/&gt;</span>
<a href="#l26.663"></a><span id="l26.663">         &lt;parameter name=&quot;aReplaceNode&quot;/&gt;</span>
<a href="#l26.664"></a><span id="l26.664">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.665"></a><span id="l26.665">           this.mMaxFreeBusy++;</span>
<a href="#l26.666"></a><span id="l26.666" class="difflineminus">-          var newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l26.667"></a><span id="l26.667" class="difflineplus">+          let newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l26.668"></a><span id="l26.668">           if (aReplaceNode) {</span>
<a href="#l26.669"></a><span id="l26.669">               aParentNode.replaceChild(newNode, aReplaceNode);</span>
<a href="#l26.670"></a><span id="l26.670">           } else {</span>
<a href="#l26.671"></a><span id="l26.671">               aParentNode.appendChild(newNode);</span>
<a href="#l26.672"></a><span id="l26.672">           }</span>
<a href="#l26.673"></a><span id="l26.673"> </span>
<a href="#l26.674"></a><span id="l26.674" class="difflineminus">-          var grid =</span>
<a href="#l26.675"></a><span id="l26.675" class="difflineplus">+          let grid =</span>
<a href="#l26.676"></a><span id="l26.676">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.677"></a><span id="l26.677">                   newNode, &quot;anonid&quot;, &quot;grid&quot;);</span>
<a href="#l26.678"></a><span id="l26.678" class="difflineminus">-          var rowNumber = this.mMaxFreeBusy;</span>
<a href="#l26.679"></a><span id="l26.679" class="difflineplus">+          let rowNumber = this.mMaxFreeBusy;</span>
<a href="#l26.680"></a><span id="l26.680">           if (rowNumber &gt;= 0) {</span>
<a href="#l26.681"></a><span id="l26.681">               grid.setAttribute(&quot;id&quot;, &quot;attendeeCol4#&quot; + rowNumber);</span>
<a href="#l26.682"></a><span id="l26.682">           }</span>
<a href="#l26.683"></a><span id="l26.683"> </span>
<a href="#l26.684"></a><span id="l26.684">           // Propagate start/enddate to the new row.</span>
<a href="#l26.685"></a><span id="l26.685">           grid.startDate = this.mStartDate;</span>
<a href="#l26.686"></a><span id="l26.686">           grid.endDate = this.mEndDate;</span>
<a href="#l26.687"></a><span id="l26.687"> </span>
<a href="#l26.688"></a><span id="l26.688" class="difflineat">@@ -1210,51 +1210,51 @@</span>
<a href="#l26.689"></a><span id="l26.689">               grid.removeAttribute('focused');</span>
<a href="#l26.690"></a><span id="l26.690">           }</span>
<a href="#l26.691"></a><span id="l26.691">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.692"></a><span id="l26.692">       &lt;/method&gt;</span>
<a href="#l26.693"></a><span id="l26.693"> </span>
<a href="#l26.694"></a><span id="l26.694">       &lt;property name=&quot;scroll&quot;&gt;</span>
<a href="#l26.695"></a><span id="l26.695">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l26.696"></a><span id="l26.696">           this.mScrollOffset = val;</span>
<a href="#l26.697"></a><span id="l26.697" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.698"></a><span id="l26.698" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.699"></a><span id="l26.699">               this.getFreeBusyElement(i).scroll = val;</span>
<a href="#l26.700"></a><span id="l26.700">           }</span>
<a href="#l26.701"></a><span id="l26.701">           return val;</span>
<a href="#l26.702"></a><span id="l26.702">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l26.703"></a><span id="l26.703">       &lt;/property&gt;</span>
<a href="#l26.704"></a><span id="l26.704"> </span>
<a href="#l26.705"></a><span id="l26.705">       &lt;method name=&quot;onModify&quot;&gt;</span>
<a href="#l26.706"></a><span id="l26.706">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l26.707"></a><span id="l26.707">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.708"></a><span id="l26.708">           // Add or remove rows depending on the number of items</span>
<a href="#l26.709"></a><span id="l26.709">           // contained in the list passed as argument.</span>
<a href="#l26.710"></a><span id="l26.710" class="difflineminus">-          var list = event.details;</span>
<a href="#l26.711"></a><span id="l26.711" class="difflineplus">+          let list = event.details;</span>
<a href="#l26.712"></a><span id="l26.712">           if (this.mMaxFreeBusy != list.length) {</span>
<a href="#l26.713"></a><span id="l26.713" class="difflineminus">-              var listbox =</span>
<a href="#l26.714"></a><span id="l26.714" class="difflineplus">+              let listbox =</span>
<a href="#l26.715"></a><span id="l26.715">                   document.getAnonymousElementByAttribute(</span>
<a href="#l26.716"></a><span id="l26.716">                       this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.717"></a><span id="l26.717" class="difflineminus">-              var template =</span>
<a href="#l26.718"></a><span id="l26.718" class="difflineplus">+              let template =</span>
<a href="#l26.719"></a><span id="l26.719">                   document.getAnonymousElementByAttribute(</span>
<a href="#l26.720"></a><span id="l26.720">                       this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l26.721"></a><span id="l26.721">               while (this.mMaxFreeBusy &lt; list.length) {</span>
<a href="#l26.722"></a><span id="l26.722" class="difflineminus">-                  var nextDummy = this.getNextDummyRow();</span>
<a href="#l26.723"></a><span id="l26.723" class="difflineplus">+                  let nextDummy = this.getNextDummyRow();</span>
<a href="#l26.724"></a><span id="l26.724">                   this.appendNewRow(listbox, template, nextDummy);</span>
<a href="#l26.725"></a><span id="l26.725">                   template =</span>
<a href="#l26.726"></a><span id="l26.726">                       document.getAnonymousElementByAttribute(</span>
<a href="#l26.727"></a><span id="l26.727">                           this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l26.728"></a><span id="l26.728">               }</span>
<a href="#l26.729"></a><span id="l26.729">               while (this.mMaxFreeBusy &gt; list.length) {</span>
<a href="#l26.730"></a><span id="l26.730">                   this.deleteRow(this.mMaxFreeBusy);</span>
<a href="#l26.731"></a><span id="l26.731">               }</span>
<a href="#l26.732"></a><span id="l26.732">           }</span>
<a href="#l26.733"></a><span id="l26.733"> </span>
<a href="#l26.734"></a><span id="l26.734">           // Store the attributes in our grid rows.</span>
<a href="#l26.735"></a><span id="l26.735" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.736"></a><span id="l26.736" class="difflineminus">-              var freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.737"></a><span id="l26.737" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.738"></a><span id="l26.738" class="difflineplus">+              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.739"></a><span id="l26.739">               freebusy.setAttribute(&quot;calid&quot;, list[i - 1].calid);</span>
<a href="#l26.740"></a><span id="l26.740">               freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l26.741"></a><span id="l26.741">               if (list[i - 1].dirty) {</span>
<a href="#l26.742"></a><span id="l26.742">                   freebusy.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l26.743"></a><span id="l26.743">               }</span>
<a href="#l26.744"></a><span id="l26.744">           }</span>
<a href="#l26.745"></a><span id="l26.745"> </span>
<a href="#l26.746"></a><span id="l26.746">           // Align all rows</span>
<a href="#l26.747"></a><span id="l26.747" class="difflineat">@@ -1262,36 +1262,36 @@</span>
<a href="#l26.748"></a><span id="l26.748"> </span>
<a href="#l26.749"></a><span id="l26.749">           this.updateFreeBusy();</span>
<a href="#l26.750"></a><span id="l26.750">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.751"></a><span id="l26.751">       &lt;/method&gt;</span>
<a href="#l26.752"></a><span id="l26.752"> </span>
<a href="#l26.753"></a><span id="l26.753">       &lt;!-- updateFreeBusy(), implementation of the core functionality of this binding --&gt;</span>
<a href="#l26.754"></a><span id="l26.754">       &lt;method name=&quot;updateFreeBusy&quot;&gt;</span>
<a href="#l26.755"></a><span id="l26.755">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.756"></a><span id="l26.756" class="difflineminus">-          var fbService = getFreeBusyService();</span>
<a href="#l26.757"></a><span id="l26.757" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.758"></a><span id="l26.758" class="difflineplus">+          let fbService = getFreeBusyService();</span>
<a href="#l26.759"></a><span id="l26.759" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.760"></a><span id="l26.760">               // Retrieve the string from the appropriate row</span>
<a href="#l26.761"></a><span id="l26.761" class="difflineminus">-              var freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.762"></a><span id="l26.762" class="difflineplus">+              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l26.763"></a><span id="l26.763">               if (freebusy.hasAttribute(&quot;dirty&quot;)) {</span>
<a href="#l26.764"></a><span id="l26.764">                   freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l26.765"></a><span id="l26.765" class="difflineminus">-                  var calid = freebusy.getAttribute(&quot;calid&quot;);</span>
<a href="#l26.766"></a><span id="l26.766" class="difflineplus">+                  let calid = freebusy.getAttribute(&quot;calid&quot;);</span>
<a href="#l26.767"></a><span id="l26.767">                   if (calid &amp;&amp; calid.length &gt; 0) {</span>
<a href="#l26.768"></a><span id="l26.768">                       // Define the datetime range we would like to ask for.</span>
<a href="#l26.769"></a><span id="l26.769" class="difflineminus">-                      var start = this.mStartDate.clone();</span>
<a href="#l26.770"></a><span id="l26.770" class="difflineplus">+                      let start = this.mStartDate.clone();</span>
<a href="#l26.771"></a><span id="l26.771">                       start.hour = 0;</span>
<a href="#l26.772"></a><span id="l26.772">                       start.minute = 0;</span>
<a href="#l26.773"></a><span id="l26.773">                       start.second = 0;</span>
<a href="#l26.774"></a><span id="l26.774" class="difflineminus">-                      var end = start.clone();</span>
<a href="#l26.775"></a><span id="l26.775" class="difflineplus">+                      let end = start.clone();</span>
<a href="#l26.776"></a><span id="l26.776">                       end.day += this.mRange;</span>
<a href="#l26.777"></a><span id="l26.777">                       // Update with 'no data available' until response will be received</span>
<a href="#l26.778"></a><span id="l26.778">                       freebusy.onFreeBusy(null);</span>
<a href="#l26.779"></a><span id="l26.779">                       try {</span>
<a href="#l26.780"></a><span id="l26.780" class="difflineminus">-                          var listener = new calFreeBusyListener(freebusy, this);</span>
<a href="#l26.781"></a><span id="l26.781" class="difflineminus">-                          var request = fbService.getFreeBusyIntervals(calid,</span>
<a href="#l26.782"></a><span id="l26.782" class="difflineplus">+                          let listener = new calFreeBusyListener(freebusy, this);</span>
<a href="#l26.783"></a><span id="l26.783" class="difflineplus">+                          let request = fbService.getFreeBusyIntervals(calid,</span>
<a href="#l26.784"></a><span id="l26.784">                                                                        start,</span>
<a href="#l26.785"></a><span id="l26.785">                                                                        end,</span>
<a href="#l26.786"></a><span id="l26.786">                                                                        Components.interfaces.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l26.787"></a><span id="l26.787">                                                                        listener);</span>
<a href="#l26.788"></a><span id="l26.788">                           if (request &amp;&amp; request.isPending) {</span>
<a href="#l26.789"></a><span id="l26.789">                               this.mPendingRequests.push(request);</span>
<a href="#l26.790"></a><span id="l26.790">                           }</span>
<a href="#l26.791"></a><span id="l26.791">                       } catch (ex) {</span>
<a href="#l26.792"></a><span id="l26.792" class="difflineat">@@ -1300,30 +1300,30 @@</span>
<a href="#l26.793"></a><span id="l26.793">                   }</span>
<a href="#l26.794"></a><span id="l26.794">               }</span>
<a href="#l26.795"></a><span id="l26.795">           }</span>
<a href="#l26.796"></a><span id="l26.796">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.797"></a><span id="l26.797">       &lt;/method&gt;</span>
<a href="#l26.798"></a><span id="l26.798"> </span>
<a href="#l26.799"></a><span id="l26.799">       &lt;method name=&quot;nextSlot&quot;&gt;</span>
<a href="#l26.800"></a><span id="l26.800">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.801"></a><span id="l26.801" class="difflineminus">-          var startTime = this.mStartDate.clone();</span>
<a href="#l26.802"></a><span id="l26.802" class="difflineminus">-          var endTime = this.mEndDate.clone();</span>
<a href="#l26.803"></a><span id="l26.803" class="difflineplus">+          let startTime = this.mStartDate.clone();</span>
<a href="#l26.804"></a><span id="l26.804" class="difflineplus">+          let endTime = this.mEndDate.clone();</span>
<a href="#l26.805"></a><span id="l26.805"> </span>
<a href="#l26.806"></a><span id="l26.806">           startTime.isDate = false;</span>
<a href="#l26.807"></a><span id="l26.807">           endTime.isDate = false;</span>
<a href="#l26.808"></a><span id="l26.808"> </span>
<a href="#l26.809"></a><span id="l26.809" class="difflineminus">-          var allDay = this.mStartDate.isDate;</span>
<a href="#l26.810"></a><span id="l26.810" class="difflineminus">-          var step_in_minutes = Math.floor(60 * this.zoomFactor / 100);</span>
<a href="#l26.811"></a><span id="l26.811" class="difflineplus">+          let allDay = this.mStartDate.isDate;</span>
<a href="#l26.812"></a><span id="l26.812" class="difflineplus">+          let step_in_minutes = Math.floor(60 * this.zoomFactor / 100);</span>
<a href="#l26.813"></a><span id="l26.813">           if (allDay) {</span>
<a href="#l26.814"></a><span id="l26.814">               step_in_minutes = 60 * 24;</span>
<a href="#l26.815"></a><span id="l26.815">               endTime.day++;</span>
<a href="#l26.816"></a><span id="l26.816">           }</span>
<a href="#l26.817"></a><span id="l26.817"> </span>
<a href="#l26.818"></a><span id="l26.818" class="difflineminus">-          var duration = endTime.subtractDate(startTime);</span>
<a href="#l26.819"></a><span id="l26.819" class="difflineplus">+          let duration = endTime.subtractDate(startTime);</span>
<a href="#l26.820"></a><span id="l26.820"> </span>
<a href="#l26.821"></a><span id="l26.821">           startTime.minute += step_in_minutes;</span>
<a href="#l26.822"></a><span id="l26.822"> </span>
<a href="#l26.823"></a><span id="l26.823">           if (startTime.hour &lt; this.mStartHour) {</span>
<a href="#l26.824"></a><span id="l26.824">               startTime.hour = this.mStartHour;</span>
<a href="#l26.825"></a><span id="l26.825">               startTime.minute = 0;</span>
<a href="#l26.826"></a><span id="l26.826">           }</span>
<a href="#l26.827"></a><span id="l26.827"> </span>
<a href="#l26.828"></a><span id="l26.828" class="difflineat">@@ -1339,22 +1339,22 @@</span>
<a href="#l26.829"></a><span id="l26.829">                   return this.mStartDate.clone();</span>
<a href="#l26.830"></a><span id="l26.830">               }</span>
<a href="#l26.831"></a><span id="l26.831">           }</span>
<a href="#l26.832"></a><span id="l26.832"> </span>
<a href="#l26.833"></a><span id="l26.833">           // Now iterate all freebusy-rows and ask each one</span>
<a href="#l26.834"></a><span id="l26.834">           // if it wants to modify the suggested time slot.</span>
<a href="#l26.835"></a><span id="l26.835">           // we keep iterating the rows until all of them</span>
<a href="#l26.836"></a><span id="l26.836">           // are happy with it.</span>
<a href="#l26.837"></a><span id="l26.837" class="difflineminus">-          var recheck;</span>
<a href="#l26.838"></a><span id="l26.838" class="difflineplus">+          let recheck;</span>
<a href="#l26.839"></a><span id="l26.839">           do {</span>
<a href="#l26.840"></a><span id="l26.840">               recheck = false;</span>
<a href="#l26.841"></a><span id="l26.841"> </span>
<a href="#l26.842"></a><span id="l26.842">               for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.843"></a><span id="l26.843" class="difflineminus">-                  var row = this.getFreeBusyElement(i);</span>
<a href="#l26.844"></a><span id="l26.844" class="difflineplus">+                  let row = this.getFreeBusyElement(i);</span>
<a href="#l26.845"></a><span id="l26.845">                   let newTime = row.nextSlot(startTime, endTime, allDay);</span>
<a href="#l26.846"></a><span id="l26.846">                   if (newTime) {</span>
<a href="#l26.847"></a><span id="l26.847">                     if (newTime.compare(startTime) != 0) {</span>
<a href="#l26.848"></a><span id="l26.848">                         startTime = newTime;</span>
<a href="#l26.849"></a><span id="l26.849"> </span>
<a href="#l26.850"></a><span id="l26.850">                         if (startTime.hour &lt; this.mStartHour) {</span>
<a href="#l26.851"></a><span id="l26.851">                             startTime.hour = this.mStartHour;</span>
<a href="#l26.852"></a><span id="l26.852">                             startTime.minute = 0;</span>
<a href="#l26.853"></a><span id="l26.853" class="difflineat">@@ -1408,33 +1408,33 @@</span>
<a href="#l26.854"></a><span id="l26.854"> </span>
<a href="#l26.855"></a><span id="l26.855">           // Return the new starttime of the item.</span>
<a href="#l26.856"></a><span id="l26.856">           return startTime;</span>
<a href="#l26.857"></a><span id="l26.857">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.858"></a><span id="l26.858">       &lt;/method&gt;</span>
<a href="#l26.859"></a><span id="l26.859"> </span>
<a href="#l26.860"></a><span id="l26.860">       &lt;method name=&quot;forceRefresh&quot;&gt;</span>
<a href="#l26.861"></a><span id="l26.861">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.862"></a><span id="l26.862" class="difflineminus">-          for (var i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.863"></a><span id="l26.863" class="difflineminus">-              var row = this.getFreeBusyElement(i);</span>
<a href="#l26.864"></a><span id="l26.864" class="difflineplus">+          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l26.865"></a><span id="l26.865" class="difflineplus">+              let row = this.getFreeBusyElement(i);</span>
<a href="#l26.866"></a><span id="l26.866">               row.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l26.867"></a><span id="l26.867">           }</span>
<a href="#l26.868"></a><span id="l26.868">           this.updateFreeBusy();</span>
<a href="#l26.869"></a><span id="l26.869">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.870"></a><span id="l26.870">       &lt;/method&gt;</span>
<a href="#l26.871"></a><span id="l26.871"> </span>
<a href="#l26.872"></a><span id="l26.872">       &lt;!-- This method returns the &lt;xul:listitem&gt; at row numer 'aRow' --&gt;</span>
<a href="#l26.873"></a><span id="l26.873">       &lt;method name=&quot;getListItem&quot;&gt;</span>
<a href="#l26.874"></a><span id="l26.874">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l26.875"></a><span id="l26.875">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.876"></a><span id="l26.876" class="difflineminus">-          var listbox =</span>
<a href="#l26.877"></a><span id="l26.877" class="difflineplus">+          let listbox =</span>
<a href="#l26.878"></a><span id="l26.878">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.879"></a><span id="l26.879">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.880"></a><span id="l26.880">           if (listbox &amp;&amp; aRow &gt; 0) {</span>
<a href="#l26.881"></a><span id="l26.881" class="difflineminus">-              var listitems = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l26.882"></a><span id="l26.882" class="difflineplus">+              let listitems = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l26.883"></a><span id="l26.883">               if (listitems &amp;&amp; listitems.length &gt;= aRow) {</span>
<a href="#l26.884"></a><span id="l26.884">                   return listitems[aRow - 1];</span>
<a href="#l26.885"></a><span id="l26.885">               }</span>
<a href="#l26.886"></a><span id="l26.886">           }</span>
<a href="#l26.887"></a><span id="l26.887">           return 0;</span>
<a href="#l26.888"></a><span id="l26.888">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.889"></a><span id="l26.889">       &lt;/method&gt;</span>
<a href="#l26.890"></a><span id="l26.890"> </span>
<a href="#l26.891"></a><span id="l26.891" class="difflineat">@@ -1445,100 +1445,100 @@</span>
<a href="#l26.892"></a><span id="l26.892">                                                          &quot;attendeeCol4#&quot; + aRow);</span>
<a href="#l26.893"></a><span id="l26.893">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.894"></a><span id="l26.894">       &lt;/method&gt;</span>
<a href="#l26.895"></a><span id="l26.895"> </span>
<a href="#l26.896"></a><span id="l26.896">       &lt;method name=&quot;deleteRow&quot;&gt;</span>
<a href="#l26.897"></a><span id="l26.897">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l26.898"></a><span id="l26.898">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.899"></a><span id="l26.899">           // Reset id's in order to not break the sequence</span>
<a href="#l26.900"></a><span id="l26.900" class="difflineminus">-          var max = this.mMaxFreeBusy;</span>
<a href="#l26.901"></a><span id="l26.901" class="difflineplus">+          let max = this.mMaxFreeBusy;</span>
<a href="#l26.902"></a><span id="l26.902">           this.removeRow(aRow);</span>
<a href="#l26.903"></a><span id="l26.903" class="difflineminus">-          var numberOfCols = this.numColumns;</span>
<a href="#l26.904"></a><span id="l26.904" class="difflineminus">-          for (var row = aRow + 1; row &lt;= max; row++) {</span>
<a href="#l26.905"></a><span id="l26.905" class="difflineminus">-              for (var col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l26.906"></a><span id="l26.906" class="difflineminus">-                  var colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l26.907"></a><span id="l26.907" class="difflineminus">-                  var elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l26.908"></a><span id="l26.908" class="difflineplus">+          let numberOfCols = this.numColumns;</span>
<a href="#l26.909"></a><span id="l26.909" class="difflineplus">+          for (let row = aRow + 1; row &lt;= max; row++) {</span>
<a href="#l26.910"></a><span id="l26.910" class="difflineplus">+              for (let col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l26.911"></a><span id="l26.911" class="difflineplus">+                  let colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l26.912"></a><span id="l26.912" class="difflineplus">+                  let elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l26.913"></a><span id="l26.913">                   if (elem) {</span>
<a href="#l26.914"></a><span id="l26.914">                       elem.setAttribute(</span>
<a href="#l26.915"></a><span id="l26.915">                           &quot;id&quot;,</span>
<a href="#l26.916"></a><span id="l26.916">                           &quot;attendeeCol&quot; + (col) + &quot;#&quot; + (row - 1));</span>
<a href="#l26.917"></a><span id="l26.917">                   }</span>
<a href="#l26.918"></a><span id="l26.918">               }</span>
<a href="#l26.919"></a><span id="l26.919">           }</span>
<a href="#l26.920"></a><span id="l26.920">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.921"></a><span id="l26.921">       &lt;/method&gt;</span>
<a href="#l26.922"></a><span id="l26.922"> </span>
<a href="#l26.923"></a><span id="l26.923">       &lt;method name=&quot;removeRow&quot;&gt;</span>
<a href="#l26.924"></a><span id="l26.924">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l26.925"></a><span id="l26.925">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.926"></a><span id="l26.926" class="difflineminus">-          var listbox =</span>
<a href="#l26.927"></a><span id="l26.927" class="difflineplus">+          let listbox =</span>
<a href="#l26.928"></a><span id="l26.928">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.929"></a><span id="l26.929">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.930"></a><span id="l26.930">           this.getListItem(aRow).remove();</span>
<a href="#l26.931"></a><span id="l26.931">           this.fitDummyRows();</span>
<a href="#l26.932"></a><span id="l26.932">           this.mMaxFreeBusy--;</span>
<a href="#l26.933"></a><span id="l26.933">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.934"></a><span id="l26.934">       &lt;/method&gt;</span>
<a href="#l26.935"></a><span id="l26.935"> </span>
<a href="#l26.936"></a><span id="l26.936">       &lt;!-- gets the next row from the top down --&gt;</span>
<a href="#l26.937"></a><span id="l26.937">       &lt;method name=&quot;getNextDummyRow&quot;&gt;</span>
<a href="#l26.938"></a><span id="l26.938">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.939"></a><span id="l26.939" class="difflineminus">-          var listbox =</span>
<a href="#l26.940"></a><span id="l26.940" class="difflineplus">+          let listbox =</span>
<a href="#l26.941"></a><span id="l26.941">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.942"></a><span id="l26.942">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.943"></a><span id="l26.943" class="difflineminus">-          var kids = listbox.childNodes;</span>
<a href="#l26.944"></a><span id="l26.944" class="difflineminus">-          for (var i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l26.945"></a><span id="l26.945" class="difflineplus">+          let kids = listbox.childNodes;</span>
<a href="#l26.946"></a><span id="l26.946" class="difflineplus">+          for (let i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l26.947"></a><span id="l26.947">               if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l26.948"></a><span id="l26.948">                   return kids[i];</span>
<a href="#l26.949"></a><span id="l26.949">               }</span>
<a href="#l26.950"></a><span id="l26.950">           }</span>
<a href="#l26.951"></a><span id="l26.951">           return null;</span>
<a href="#l26.952"></a><span id="l26.952">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.953"></a><span id="l26.953">       &lt;/method&gt;</span>
<a href="#l26.954"></a><span id="l26.954"> </span>
<a href="#l26.955"></a><span id="l26.955">       &lt;method name=&quot;fitDummyRows&quot;&gt;</span>
<a href="#l26.956"></a><span id="l26.956">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.957"></a><span id="l26.957" class="difflineminus">-          var self = this;</span>
<a href="#l26.958"></a><span id="l26.958" class="difflineminus">-          var func = function func() {</span>
<a href="#l26.959"></a><span id="l26.959" class="difflineplus">+          let self = this;</span>
<a href="#l26.960"></a><span id="l26.960" class="difflineplus">+          let func = function func() {</span>
<a href="#l26.961"></a><span id="l26.961">               self.calcContentHeight();</span>
<a href="#l26.962"></a><span id="l26.962">               self.createOrRemoveDummyRows();</span>
<a href="#l26.963"></a><span id="l26.963">           };</span>
<a href="#l26.964"></a><span id="l26.964">           setTimeout(func, 0);</span>
<a href="#l26.965"></a><span id="l26.965">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.966"></a><span id="l26.966">       &lt;/method&gt;</span>
<a href="#l26.967"></a><span id="l26.967"> </span>
<a href="#l26.968"></a><span id="l26.968">       &lt;method name=&quot;calcContentHeight&quot;&gt;</span>
<a href="#l26.969"></a><span id="l26.969">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.970"></a><span id="l26.970" class="difflineminus">-          var listbox =</span>
<a href="#l26.971"></a><span id="l26.971" class="difflineplus">+          let listbox =</span>
<a href="#l26.972"></a><span id="l26.972">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.973"></a><span id="l26.973">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.974"></a><span id="l26.974" class="difflineminus">-          var items = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l26.975"></a><span id="l26.975" class="difflineplus">+          let items = listbox.getElementsByTagNameNS('*', 'listitem');</span>
<a href="#l26.976"></a><span id="l26.976">           this.mContentHeight = 0;</span>
<a href="#l26.977"></a><span id="l26.977">           if (items.length &gt; 0) {</span>
<a href="#l26.978"></a><span id="l26.978" class="difflineminus">-              var i = 0;</span>
<a href="#l26.979"></a><span id="l26.979" class="difflineplus">+              let i = 0;</span>
<a href="#l26.980"></a><span id="l26.980">               do {</span>
<a href="#l26.981"></a><span id="l26.981">                   this.mRowHeight = items[i].boxObject.height;</span>
<a href="#l26.982"></a><span id="l26.982">                   ++i;</span>
<a href="#l26.983"></a><span id="l26.983">               } while (i &lt; items.length &amp;&amp; !this.mRowHeight);</span>
<a href="#l26.984"></a><span id="l26.984">               this.mContentHeight = this.mRowHeight * items.length;</span>
<a href="#l26.985"></a><span id="l26.985">           }</span>
<a href="#l26.986"></a><span id="l26.986">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.987"></a><span id="l26.987">       &lt;/method&gt;</span>
<a href="#l26.988"></a><span id="l26.988"> </span>
<a href="#l26.989"></a><span id="l26.989">       &lt;method name=&quot;createOrRemoveDummyRows&quot;&gt;</span>
<a href="#l26.990"></a><span id="l26.990">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.991"></a><span id="l26.991" class="difflineminus">-          var listbox =</span>
<a href="#l26.992"></a><span id="l26.992" class="difflineplus">+          let listbox =</span>
<a href="#l26.993"></a><span id="l26.993">               document.getAnonymousElementByAttribute(</span>
<a href="#l26.994"></a><span id="l26.994">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.995"></a><span id="l26.995" class="difflineminus">-          var listboxHeight = listbox.boxObject.height;</span>
<a href="#l26.996"></a><span id="l26.996" class="difflineplus">+          let listboxHeight = listbox.boxObject.height;</span>
<a href="#l26.997"></a><span id="l26.997"> </span>
<a href="#l26.998"></a><span id="l26.998">           // Remove rows to remove scrollbar</span>
<a href="#l26.999"></a><span id="l26.999" class="difflineminus">-          var kids = listbox.childNodes;</span>
<a href="#l26.1000"></a><span id="l26.1000" class="difflineminus">-          for (var i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1001"></a><span id="l26.1001" class="difflineplus">+          let kids = listbox.childNodes;</span>
<a href="#l26.1002"></a><span id="l26.1002" class="difflineplus">+          for (let i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1003"></a><span id="l26.1003">               if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l26.1004"></a><span id="l26.1004">                   this.mContentHeight -= this.mRowHeight;</span>
<a href="#l26.1005"></a><span id="l26.1005">                   kids[i].remove();</span>
<a href="#l26.1006"></a><span id="l26.1006">               }</span>
<a href="#l26.1007"></a><span id="l26.1007">           }</span>
<a href="#l26.1008"></a><span id="l26.1008"> </span>
<a href="#l26.1009"></a><span id="l26.1009">           // Add rows to fill space</span>
<a href="#l26.1010"></a><span id="l26.1010">           if (this.mRowHeight) {</span>
<a href="#l26.1011"></a><span id="l26.1011" class="difflineat">@@ -1548,48 +1548,48 @@</span>
<a href="#l26.1012"></a><span id="l26.1012">               }</span>
<a href="#l26.1013"></a><span id="l26.1013">           }</span>
<a href="#l26.1014"></a><span id="l26.1014">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.1015"></a><span id="l26.1015">       &lt;/method&gt;</span>
<a href="#l26.1016"></a><span id="l26.1016"> </span>
<a href="#l26.1017"></a><span id="l26.1017">       &lt;method name=&quot;createDummyCell&quot;&gt;</span>
<a href="#l26.1018"></a><span id="l26.1018">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l26.1019"></a><span id="l26.1019">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.1020"></a><span id="l26.1020" class="difflineminus">-          var cell = document.createElement(&quot;listcell&quot;);</span>
<a href="#l26.1021"></a><span id="l26.1021" class="difflineplus">+          let cell = document.createElement(&quot;listcell&quot;);</span>
<a href="#l26.1022"></a><span id="l26.1022">           cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l26.1023"></a><span id="l26.1023">           if (aParent) {</span>
<a href="#l26.1024"></a><span id="l26.1024">               aParent.appendChild(cell);</span>
<a href="#l26.1025"></a><span id="l26.1025">           }</span>
<a href="#l26.1026"></a><span id="l26.1026">           return cell;</span>
<a href="#l26.1027"></a><span id="l26.1027">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.1028"></a><span id="l26.1028">       &lt;/method&gt;</span>
<a href="#l26.1029"></a><span id="l26.1029"> </span>
<a href="#l26.1030"></a><span id="l26.1030">       &lt;method name=&quot;createDummyItem&quot;&gt;</span>
<a href="#l26.1031"></a><span id="l26.1031">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l26.1032"></a><span id="l26.1032">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l26.1033"></a><span id="l26.1033" class="difflineminus">-          var titem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l26.1034"></a><span id="l26.1034" class="difflineplus">+          let titem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l26.1035"></a><span id="l26.1035">           titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l26.1036"></a><span id="l26.1036">           titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l26.1037"></a><span id="l26.1037" class="difflineminus">-          for (var i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l26.1038"></a><span id="l26.1038" class="difflineplus">+          for (let i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l26.1039"></a><span id="l26.1039">               this.createDummyCell(titem);</span>
<a href="#l26.1040"></a><span id="l26.1040">           }</span>
<a href="#l26.1041"></a><span id="l26.1041">           if (aParent) {</span>
<a href="#l26.1042"></a><span id="l26.1042">               aParent.appendChild(titem);</span>
<a href="#l26.1043"></a><span id="l26.1043">           }</span>
<a href="#l26.1044"></a><span id="l26.1044">           return titem;</span>
<a href="#l26.1045"></a><span id="l26.1045">         ]]&gt;&lt;/body&gt;</span>
<a href="#l26.1046"></a><span id="l26.1046">       &lt;/method&gt;</span>
<a href="#l26.1047"></a><span id="l26.1047"> </span>
<a href="#l26.1048"></a><span id="l26.1048">       &lt;property name=&quot;numColumns&quot;&gt;</span>
<a href="#l26.1049"></a><span id="l26.1049">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l26.1050"></a><span id="l26.1050">           if (!this.mNumColumns) {</span>
<a href="#l26.1051"></a><span id="l26.1051" class="difflineminus">-              var listbox =</span>
<a href="#l26.1052"></a><span id="l26.1052" class="difflineplus">+              let listbox =</span>
<a href="#l26.1053"></a><span id="l26.1053">                   document.getAnonymousElementByAttribute(</span>
<a href="#l26.1054"></a><span id="l26.1054">                       this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l26.1055"></a><span id="l26.1055" class="difflineminus">-              var listCols = listbox.getElementsByTagNameNS('*', 'listcol');</span>
<a href="#l26.1056"></a><span id="l26.1056" class="difflineplus">+              let listCols = listbox.getElementsByTagNameNS('*', 'listcol');</span>
<a href="#l26.1057"></a><span id="l26.1057">               this.mNumColumns = listCols.length || 1;</span>
<a href="#l26.1058"></a><span id="l26.1058">           }</span>
<a href="#l26.1059"></a><span id="l26.1059">           return this.mNumColumns;</span>
<a href="#l26.1060"></a><span id="l26.1060">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l26.1061"></a><span id="l26.1061">       &lt;/property&gt;</span>
<a href="#l26.1062"></a><span id="l26.1062"> </span>
<a href="#l26.1063"></a><span id="l26.1063">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l26.1064"></a><span id="l26.1064">         &lt;body&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -32,17 +32,17 @@</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5">     &lt;implementation&gt;</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7">       &lt;field name=&quot;mRecurrenceInfo&quot;&gt;null&lt;/field&gt;</span>
<a href="#l27.8"></a><span id="l27.8">       &lt;field name=&quot;mResizeHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l27.9"></a><span id="l27.9">       &lt;field name=&quot;mDateTime&quot;&gt;null&lt;/field&gt;</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-        var self = this;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+        let self = this;</span>
<a href="#l27.14"></a><span id="l27.14">         this.mResizeHandler = function recurrence_preview_resizeHandler() {</span>
<a href="#l27.15"></a><span id="l27.15">             self.onResize();</span>
<a href="#l27.16"></a><span id="l27.16">         };</span>
<a href="#l27.17"></a><span id="l27.17">         window.addEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l27.18"></a><span id="l27.18">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l27.21"></a><span id="l27.21">         window.removeEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -57,56 +57,56 @@</span>
<a href="#l27.23"></a><span id="l27.23">             if (this.mDateTime == null) {</span>
<a href="#l27.24"></a><span id="l27.24">                 this.mDateTime = now();</span>
<a href="#l27.25"></a><span id="l27.25">             }</span>
<a href="#l27.26"></a><span id="l27.26">             return this.mDateTime;</span>
<a href="#l27.27"></a><span id="l27.27">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l27.28"></a><span id="l27.28">       &lt;/property&gt;</span>
<a href="#l27.29"></a><span id="l27.29">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l27.30"></a><span id="l27.30">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-          var mainbox =</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+          let mainbox =</span>
<a href="#l27.33"></a><span id="l27.33">               document.getAnonymousElementByAttribute(</span>
<a href="#l27.34"></a><span id="l27.34">                   this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-          var minimonth =</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+          let minimonth =</span>
<a href="#l27.37"></a><span id="l27.37">               document.getAnonymousElementByAttribute(</span>
<a href="#l27.38"></a><span id="l27.38">                   this, &quot;anonid&quot;, &quot;minimonth&quot;);</span>
<a href="#l27.39"></a><span id="l27.39"> </span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-          var row =</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+          let row =</span>
<a href="#l27.42"></a><span id="l27.42">               document.getAnonymousElementByAttribute(</span>
<a href="#l27.43"></a><span id="l27.43">                   this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-          var rows = row.parentNode;</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+          let rows = row.parentNode;</span>
<a href="#l27.46"></a><span id="l27.46"> </span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-          var contentWidth = minimonth.boxObject.width;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-          var containerWidth =</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+          let contentWidth = minimonth.boxObject.width;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+          let containerWidth =</span>
<a href="#l27.51"></a><span id="l27.51">               document.getAnonymousNodes(this)[0]</span>
<a href="#l27.52"></a><span id="l27.52">                   .boxObject.width;</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54">           // Now find out how much elements can be displayed.</span>
<a href="#l27.55"></a><span id="l27.55">           // this is a simple division which always yields a positive integer value.</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-          var numHorizontal =</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+          let numHorizontal =</span>
<a href="#l27.58"></a><span id="l27.58">               (containerWidth -</span>
<a href="#l27.59"></a><span id="l27.59">                   (containerWidth % contentWidth)) /</span>
<a href="#l27.60"></a><span id="l27.60">                       contentWidth;</span>
<a href="#l27.61"></a><span id="l27.61"> </span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-          var contentHeight = minimonth.boxObject.height;</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-          var containerHeight =</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+          let contentHeight = minimonth.boxObject.height;</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+          let containerHeight =</span>
<a href="#l27.66"></a><span id="l27.66">               document.getAnonymousNodes(this)[0]</span>
<a href="#l27.67"></a><span id="l27.67">                   .boxObject.height;</span>
<a href="#l27.68"></a><span id="l27.68"> </span>
<a href="#l27.69"></a><span id="l27.69">           // Now find out how much elements can be displayed.</span>
<a href="#l27.70"></a><span id="l27.70">           // this is a simple division which always yields a positive integer value.</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-          var numVertical =</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+          let numVertical =</span>
<a href="#l27.73"></a><span id="l27.73">               (containerHeight -</span>
<a href="#l27.74"></a><span id="l27.74">                   (containerHeight % contentHeight)) /</span>
<a href="#l27.75"></a><span id="l27.75">                       contentHeight;</span>
<a href="#l27.76"></a><span id="l27.76">           numVertical = Math.max(1, numVertical);</span>
<a href="#l27.77"></a><span id="l27.77"> </span>
<a href="#l27.78"></a><span id="l27.78">           // Count the number of existing rows</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-          var numRows = 0;</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-          var rowIterator = row;</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+          let numRows = 0;</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+          let rowIterator = row;</span>
<a href="#l27.83"></a><span id="l27.83">           while (rowIterator) {</span>
<a href="#l27.84"></a><span id="l27.84">               numRows++;</span>
<a href="#l27.85"></a><span id="l27.85">               rowIterator = rowIterator.nextSibling;</span>
<a href="#l27.86"></a><span id="l27.86">           }</span>
<a href="#l27.87"></a><span id="l27.87"> </span>
<a href="#l27.88"></a><span id="l27.88">           // Adjust rows</span>
<a href="#l27.89"></a><span id="l27.89">           while (numRows &lt; numVertical) {</span>
<a href="#l27.90"></a><span id="l27.90">               let newNode = row.cloneNode(true);</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineat">@@ -114,33 +114,33 @@</span>
<a href="#l27.92"></a><span id="l27.92">               numRows++;</span>
<a href="#l27.93"></a><span id="l27.93">           }</span>
<a href="#l27.94"></a><span id="l27.94">           while (numRows &gt; numVertical) {</span>
<a href="#l27.95"></a><span id="l27.95">               rows.firstChild.remove();</span>
<a href="#l27.96"></a><span id="l27.96">               numRows--;</span>
<a href="#l27.97"></a><span id="l27.97">           }</span>
<a href="#l27.98"></a><span id="l27.98"> </span>
<a href="#l27.99"></a><span id="l27.99">           // Adjust columns in the grid</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-          var column =</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+          let column =</span>
<a href="#l27.102"></a><span id="l27.102">               document.getAnonymousElementByAttribute(</span>
<a href="#l27.103"></a><span id="l27.103">                   this, &quot;anonid&quot;, &quot;column&quot;);</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-          var columns = column.parentNode;</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+          let columns = column.parentNode;</span>
<a href="#l27.106"></a><span id="l27.106">           while ((columns.childNodes.length - 1) &lt; numHorizontal) {</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-              var newColumn = column.cloneNode(false);</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+              let newColumn = column.cloneNode(false);</span>
<a href="#l27.109"></a><span id="l27.109">               columns.insertBefore(newColumn, column.nextSibling);</span>
<a href="#l27.110"></a><span id="l27.110">           }</span>
<a href="#l27.111"></a><span id="l27.111">           while ((columns.childNodes.length - 1) &gt; numHorizontal) {</span>
<a href="#l27.112"></a><span id="l27.112">               columns.firstChild.remove();</span>
<a href="#l27.113"></a><span id="l27.113">           }</span>
<a href="#l27.114"></a><span id="l27.114"> </span>
<a href="#l27.115"></a><span id="l27.115">           // Walk all rows and adjust column elements</span>
<a href="#l27.116"></a><span id="l27.116">           row = document.getAnonymousElementByAttribute(</span>
<a href="#l27.117"></a><span id="l27.117">                    this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l27.118"></a><span id="l27.118">           while (row) {</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineminus">-              var firstChild = row.firstChild;</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+              let firstChild = row.firstChild;</span>
<a href="#l27.121"></a><span id="l27.121">               while ((row.childNodes.length - 1) &lt; numHorizontal) {</span>
<a href="#l27.122"></a><span id="l27.122">                   let newNode = firstChild.cloneNode(true);</span>
<a href="#l27.123"></a><span id="l27.123">                   firstChild.parentNode.insertBefore(newNode, firstChild);</span>
<a href="#l27.124"></a><span id="l27.124">               }</span>
<a href="#l27.125"></a><span id="l27.125">               while ((row.childNodes.length - 1) &gt; numHorizontal) {</span>
<a href="#l27.126"></a><span id="l27.126">                   row.firstChild.remove();</span>
<a href="#l27.127"></a><span id="l27.127">               }</span>
<a href="#l27.128"></a><span id="l27.128">               row = row.nextSibling;</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineat">@@ -148,74 +148,74 @@</span>
<a href="#l27.130"></a><span id="l27.130"> </span>
<a href="#l27.131"></a><span id="l27.131">           this.updateContent();</span>
<a href="#l27.132"></a><span id="l27.132">           this.updatePreview(this.mRecurrenceInfo);</span>
<a href="#l27.133"></a><span id="l27.133">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.134"></a><span id="l27.134">       &lt;/method&gt;</span>
<a href="#l27.135"></a><span id="l27.135"> </span>
<a href="#l27.136"></a><span id="l27.136">       &lt;method name=&quot;updateContent&quot;&gt;</span>
<a href="#l27.137"></a><span id="l27.137">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-          var dt = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-          var row = document.getAnonymousElementByAttribute(</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+          let dt = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+          let row = document.getAnonymousElementByAttribute(</span>
<a href="#l27.142"></a><span id="l27.142">                         this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l27.143"></a><span id="l27.143">           while (row) {</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineminus">-              var numChilds = row.childNodes.length - 1;</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-              for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-                  var minimonth = row.childNodes[i];</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineplus">+              let numChilds = row.childNodes.length - 1;</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineplus">+              for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+                  let minimonth = row.childNodes[i];</span>
<a href="#l27.150"></a><span id="l27.150">                   minimonth.showMonth(dt);</span>
<a href="#l27.151"></a><span id="l27.151">                   dt.setMonth(dt.getMonth() + 1);</span>
<a href="#l27.152"></a><span id="l27.152">               }</span>
<a href="#l27.153"></a><span id="l27.153">               row = row.nextSibling;</span>
<a href="#l27.154"></a><span id="l27.154">           }</span>
<a href="#l27.155"></a><span id="l27.155">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.156"></a><span id="l27.156">       &lt;/method&gt;</span>
<a href="#l27.157"></a><span id="l27.157"> </span>
<a href="#l27.158"></a><span id="l27.158">       &lt;method name=&quot;updatePreview&quot;&gt;</span>
<a href="#l27.159"></a><span id="l27.159">         &lt;parameter name=&quot;aRecurrenceInfo&quot;/&gt;</span>
<a href="#l27.160"></a><span id="l27.160">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.161"></a><span id="l27.161">           this.mRecurrenceInfo = aRecurrenceInfo;</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-          var start = this.dateTime.clone();</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineplus">+          let start = this.dateTime.clone();</span>
<a href="#l27.164"></a><span id="l27.164">           start.day = 1;</span>
<a href="#l27.165"></a><span id="l27.165">           start.hour = 0;</span>
<a href="#l27.166"></a><span id="l27.166">           start.minute = 0;</span>
<a href="#l27.167"></a><span id="l27.167">           start.second = 0;</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-          var end = start.clone();</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+          let end = start.clone();</span>
<a href="#l27.170"></a><span id="l27.170">           end.month++;</span>
<a href="#l27.171"></a><span id="l27.171"> </span>
<a href="#l27.172"></a><span id="l27.172">           // the 'minimonth' controls are arranged in a</span>
<a href="#l27.173"></a><span id="l27.173">           // grid, sorted by rows first -&gt; iterate the rows that may exist.</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-          var row = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+          let row = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l27.176"></a><span id="l27.176">           while (row) {</span>
<a href="#l27.177"></a><span id="l27.177">               // now iterater all the child nodes of this row</span>
<a href="#l27.178"></a><span id="l27.178">               // in order to visit each minimonth in turn.</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-              var numChilds = row.childNodes.length - 1;</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-              for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineplus">+              let numChilds = row.childNodes.length - 1;</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineplus">+              for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l27.183"></a><span id="l27.183">                   // we now have one of the minimonth controls while 'start'</span>
<a href="#l27.184"></a><span id="l27.184">                   // and 'end' are set to the interval this minimonth shows.</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-                  var minimonth = row.childNodes[i];</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineplus">+                  let minimonth = row.childNodes[i];</span>
<a href="#l27.187"></a><span id="l27.187">                   minimonth.showMonth(cal.dateTimeToJsDate(start));</span>
<a href="#l27.188"></a><span id="l27.188">                   if (aRecurrenceInfo) {</span>
<a href="#l27.189"></a><span id="l27.189">                       // retrieve an array of dates that represents all occurrences</span>
<a href="#l27.190"></a><span id="l27.190">                       // that fall into this time interval [start,end[.</span>
<a href="#l27.191"></a><span id="l27.191">                       // note: the following loop assumes that this array conains</span>
<a href="#l27.192"></a><span id="l27.192">                       // dates that are strictly monotonically increasing.</span>
<a href="#l27.193"></a><span id="l27.193">                       // should getOccurrenceDates() not enforce this assumption we</span>
<a href="#l27.194"></a><span id="l27.194">                       // need to fall back to some different algorithm.</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">-                      var dates = aRecurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineplus">+                      let dates = aRecurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l27.197"></a><span id="l27.197"> </span>
<a href="#l27.198"></a><span id="l27.198">                       // now run throgh all days of this month and set the</span>
<a href="#l27.199"></a><span id="l27.199">                       // 'busy' attribute with respect to the occurrence array.</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-                      var index = 0;</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-                      var occurrence = null;</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineplus">+                      let index = 0;</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineplus">+                      let occurrence = null;</span>
<a href="#l27.204"></a><span id="l27.204">                       if (index &lt; dates.length) {</span>
<a href="#l27.205"></a><span id="l27.205">                           occurrence =</span>
<a href="#l27.206"></a><span id="l27.206">                               dates[index++]</span>
<a href="#l27.207"></a><span id="l27.207">                                   .getInTimezone(start.timezone);</span>
<a href="#l27.208"></a><span id="l27.208">                       }</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-                      var current = start.clone();</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+                      let current = start.clone();</span>
<a href="#l27.211"></a><span id="l27.211">                       while (current.compare(end) &lt; 0) {</span>
<a href="#l27.212"></a><span id="l27.212">                         let box = minimonth.getBoxForDate(current);</span>
<a href="#l27.213"></a><span id="l27.213">                         if (box) {</span>
<a href="#l27.214"></a><span id="l27.214">                             if (occurrence &amp;&amp;</span>
<a href="#l27.215"></a><span id="l27.215">                                 occurrence.day == current.day &amp;&amp;</span>
<a href="#l27.216"></a><span id="l27.216">                                 occurrence.month == current.month &amp;&amp;</span>
<a href="#l27.217"></a><span id="l27.217">                                 occurrence.year == current.year) {</span>
<a href="#l27.218"></a><span id="l27.218">                                 box.setAttribute(&quot;busy&quot;, 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -13,43 +13,43 @@ var gUntilDate = null;</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5"> /**</span>
<a href="#l28.6"></a><span id="l28.6">  * Sets up the recurrence dialog from the window arguments. Takes care of filling</span>
<a href="#l28.7"></a><span id="l28.7">  * the dialog controls with the recurrence information for this window.</span>
<a href="#l28.8"></a><span id="l28.8">  */</span>
<a href="#l28.9"></a><span id="l28.9"> function onLoad() {</span>
<a href="#l28.10"></a><span id="l28.10">     changeWidgetsOrder();</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-    var calendar = item.calendar;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-    var recinfo = args.recurrenceInfo;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+    let calendar = item.calendar;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+    let recinfo = args.recurrenceInfo;</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21">     gStartTime = args.startTime;</span>
<a href="#l28.22"></a><span id="l28.22">     gEndTime = args.endTime;</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-    var preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+    let preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l28.25"></a><span id="l28.25">     preview.dateTime = gStartTime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27">     onChangeCalendar(calendar);</span>
<a href="#l28.28"></a><span id="l28.28"> </span>
<a href="#l28.29"></a><span id="l28.29">     // Set starting value for 'repeat until' rule and highlight the start date.</span>
<a href="#l28.30"></a><span id="l28.30">     let repeatDate = cal.dateTimeToJsDate(gStartTime.getInTimezone(cal.floating()));</span>
<a href="#l28.31"></a><span id="l28.31">     setElementValue(&quot;repeat-until-date&quot;, repeatDate);</span>
<a href="#l28.32"></a><span id="l28.32">     document.getElementById(&quot;repeat-until-date&quot;).extraDate = repeatDate;</span>
<a href="#l28.33"></a><span id="l28.33"> </span>
<a href="#l28.34"></a><span id="l28.34">     if (item.parentItem != item) {</span>
<a href="#l28.35"></a><span id="l28.35">         item = item.parentItem;</span>
<a href="#l28.36"></a><span id="l28.36">     }</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-    var rule = null;</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+    let rule = null;</span>
<a href="#l28.39"></a><span id="l28.39">     if (recinfo) {</span>
<a href="#l28.40"></a><span id="l28.40">         // Split out rules and exceptions</span>
<a href="#l28.41"></a><span id="l28.41">         try {</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-            var rrules = splitRecurrenceRules(recinfo);</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-            var rules = rrules[0];</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-            var exceptions = rrules[1];</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+            let rrules = splitRecurrenceRules(recinfo);</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+            let rules = rrules[0];</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+            let exceptions = rrules[1];</span>
<a href="#l28.48"></a><span id="l28.48">             // Deal with the rules</span>
<a href="#l28.49"></a><span id="l28.49">             if (rules.length &gt; 0) {</span>
<a href="#l28.50"></a><span id="l28.50">                 // We only handle 1 rule currently</span>
<a href="#l28.51"></a><span id="l28.51">                 rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l28.52"></a><span id="l28.52">             }</span>
<a href="#l28.53"></a><span id="l28.53">         } catch (ex) {</span>
<a href="#l28.54"></a><span id="l28.54">             Components.utils.reportError(ex);</span>
<a href="#l28.55"></a><span id="l28.55">         }</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineat">@@ -123,21 +123,21 @@ function initializeControls(rule) {</span>
<a href="#l28.57"></a><span id="l28.57">             document.getElementById(&quot;period-list&quot;).selectedIndex = 3;</span>
<a href="#l28.58"></a><span id="l28.58">             break;</span>
<a href="#l28.59"></a><span id="l28.59">         default:</span>
<a href="#l28.60"></a><span id="l28.60">             document.getElementById(&quot;period-list&quot;).selectedIndex = 0;</span>
<a href="#l28.61"></a><span id="l28.61">             dump(&quot;unable to handle your rule type!\n&quot;);</span>
<a href="#l28.62"></a><span id="l28.62">             break;</span>
<a href="#l28.63"></a><span id="l28.63">     }</span>
<a href="#l28.64"></a><span id="l28.64"> </span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-    var byDayRuleComponent = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-    var byMonthDayRuleComponent = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-    var byMonthRuleComponent = rule.getComponent(&quot;BYMONTH&quot;, {});</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-    var startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+    let byDayRuleComponent = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+    let byMonthDayRuleComponent = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+    let byMonthRuleComponent = rule.getComponent(&quot;BYMONTH&quot;, {});</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+    let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.75"></a><span id="l28.75"> </span>
<a href="#l28.76"></a><span id="l28.76">     // &quot;DAILY&quot; ruletype</span>
<a href="#l28.77"></a><span id="l28.77">     // byDayRuleComponents may have been set priorily by &quot;MONTHLY&quot;- ruletypes</span>
<a href="#l28.78"></a><span id="l28.78">     // where they have a different context-</span>
<a href="#l28.79"></a><span id="l28.79">     // that's why we also query the current rule-type</span>
<a href="#l28.80"></a><span id="l28.80">     if (byDayRuleComponent.length == 0 || rule.type != &quot;DAILY&quot;) {</span>
<a href="#l28.81"></a><span id="l28.81">         document.getElementById(&quot;daily-group&quot;).selectedIndex = 0;</span>
<a href="#l28.82"></a><span id="l28.82">     } else {</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineat">@@ -147,34 +147,34 @@ function initializeControls(rule) {</span>
<a href="#l28.84"></a><span id="l28.84">     // &quot;WEEKLY&quot; ruletype</span>
<a href="#l28.85"></a><span id="l28.85">     if (byDayRuleComponent.length == 0 || rule.type != &quot;WEEKLY&quot;) {</span>
<a href="#l28.86"></a><span id="l28.86">         document.getElementById(&quot;daypicker-weekday&quot;).days = [startDate.weekday + 1];</span>
<a href="#l28.87"></a><span id="l28.87">     } else {</span>
<a href="#l28.88"></a><span id="l28.88">         document.getElementById(&quot;daypicker-weekday&quot;).days = byDayRuleComponent;</span>
<a href="#l28.89"></a><span id="l28.89">     }</span>
<a href="#l28.90"></a><span id="l28.90"> </span>
<a href="#l28.91"></a><span id="l28.91">     // &quot;MONTHLY&quot; ruletype</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-    var ruleComponentsEmpty = (byDayRuleComponent.length == 0 &amp;&amp;</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+    let ruleComponentsEmpty = (byDayRuleComponent.length == 0 &amp;&amp;</span>
<a href="#l28.94"></a><span id="l28.94">                                byMonthDayRuleComponent.length == 0);</span>
<a href="#l28.95"></a><span id="l28.95">     if (ruleComponentsEmpty || rule.type != &quot;MONTHLY&quot;) {</span>
<a href="#l28.96"></a><span id="l28.96">         document.getElementById(&quot;monthly-group&quot;).selectedIndex = 1;</span>
<a href="#l28.97"></a><span id="l28.97">         document.getElementById(&quot;monthly-days&quot;).days = [startDate.day];</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-        var day = Math.floor((startDate.day - 1) / 7) + 1;</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+        let day = Math.floor((startDate.day - 1) / 7) + 1;</span>
<a href="#l28.100"></a><span id="l28.100">         setElementValue(&quot;monthly-ordinal&quot;, day);</span>
<a href="#l28.101"></a><span id="l28.101">         setElementValue(&quot;monthly-weekday&quot;, startDate.weekday + 1);</span>
<a href="#l28.102"></a><span id="l28.102">     } else {</span>
<a href="#l28.103"></a><span id="l28.103">         if (everyWeekDay(byDayRuleComponent)) {</span>
<a href="#l28.104"></a><span id="l28.104">             // Every day of the month.</span>
<a href="#l28.105"></a><span id="l28.105">             document.getElementById(&quot;monthly-group&quot;).selectedIndex = 0;</span>
<a href="#l28.106"></a><span id="l28.106">             setElementValue(&quot;monthly-ordinal&quot;, 0);</span>
<a href="#l28.107"></a><span id="l28.107">             setElementValue(&quot;monthly-weekday&quot;, -1);</span>
<a href="#l28.108"></a><span id="l28.108">         } else if (byDayRuleComponent.length &gt; 0) {</span>
<a href="#l28.109"></a><span id="l28.109">             // One of the first five days or weekdays of the month.</span>
<a href="#l28.110"></a><span id="l28.110">             document.getElementById(&quot;monthly-group&quot;).selectedIndex = 0;</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineminus">-            var ruleInfo = getOrdinalAndWeekdayOfRule(byDayRuleComponent[0]);</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+            let ruleInfo = getOrdinalAndWeekdayOfRule(byDayRuleComponent[0]);</span>
<a href="#l28.113"></a><span id="l28.113">             setElementValue(&quot;monthly-ordinal&quot;, ruleInfo.ordinal);</span>
<a href="#l28.114"></a><span id="l28.114">             setElementValue(&quot;monthly-weekday&quot;, ruleInfo.weekday);</span>
<a href="#l28.115"></a><span id="l28.115">         } else if (byMonthDayRuleComponent.length == 1 &amp;&amp; byMonthDayRuleComponent[0] == -1) {</span>
<a href="#l28.116"></a><span id="l28.116">             // The last day of the month.</span>
<a href="#l28.117"></a><span id="l28.117">             document.getElementById(&quot;monthly-group&quot;).selectedIndex = 0;</span>
<a href="#l28.118"></a><span id="l28.118">             setElementValue(&quot;monthly-ordinal&quot;, byMonthDayRuleComponent[0]);</span>
<a href="#l28.119"></a><span id="l28.119">             setElementValue(&quot;monthly-weekday&quot;, byMonthDayRuleComponent[0]);</span>
<a href="#l28.120"></a><span id="l28.120">         } else if (byMonthDayRuleComponent.length &gt; 0) {</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineat">@@ -260,32 +260,32 @@ function onSave(item) {</span>
<a href="#l28.122"></a><span id="l28.122"> </span>
<a href="#l28.123"></a><span id="l28.123">     // This works, but if we ever support more complex recurrence,</span>
<a href="#l28.124"></a><span id="l28.124">     // e.g. recurrence for Martians, then we're going to want to</span>
<a href="#l28.125"></a><span id="l28.125">     // not clone and just recreate the recurrenceInfo each time.</span>
<a href="#l28.126"></a><span id="l28.126">     // The reason is that the order of items (rules/dates/datesets)</span>
<a href="#l28.127"></a><span id="l28.127">     // matters, so we can't always just append at the end.  This</span>
<a href="#l28.128"></a><span id="l28.128">     // code here always inserts a rule first, because all our</span>
<a href="#l28.129"></a><span id="l28.129">     // exceptions should come afterward.</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineminus">-    var deckNumber = Number(getElementValue(&quot;period-list&quot;));</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineplus">+    let deckNumber = Number(getElementValue(&quot;period-list&quot;));</span>
<a href="#l28.132"></a><span id="l28.132"> </span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-    var recurrenceInfo = args.recurrenceInfo;</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+    let recurrenceInfo = args.recurrenceInfo;</span>
<a href="#l28.137"></a><span id="l28.137">     if (recurrenceInfo) {</span>
<a href="#l28.138"></a><span id="l28.138">         recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineminus">-        var rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+        let rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l28.141"></a><span id="l28.141">         if (rrules[0].length &gt; 0) {</span>
<a href="#l28.142"></a><span id="l28.142">             recurrenceInfo.deleteRecurrenceItem(rrules[0][0]);</span>
<a href="#l28.143"></a><span id="l28.143">         }</span>
<a href="#l28.144"></a><span id="l28.144">         recurrenceInfo.item = item;</span>
<a href="#l28.145"></a><span id="l28.145">     } else {</span>
<a href="#l28.146"></a><span id="l28.146">         recurrenceInfo = createRecurrenceInfo(item);</span>
<a href="#l28.147"></a><span id="l28.147">     }</span>
<a href="#l28.148"></a><span id="l28.148"> </span>
<a href="#l28.149"></a><span id="l28.149" class="difflineminus">-    var recRule = createRecurrenceRule();</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+    let recRule = createRecurrenceRule();</span>
<a href="#l28.151"></a><span id="l28.151">     const ALL_WEEKDAYS = [2, 3, 4, 5, 6, 7, 1]; // The sequence MO,TU,WE,TH,FR,SA,SU.</span>
<a href="#l28.152"></a><span id="l28.152">     switch (deckNumber) {</span>
<a href="#l28.153"></a><span id="l28.153">     case 0: {</span>
<a href="#l28.154"></a><span id="l28.154">         recRule.type = &quot;DAILY&quot;;</span>
<a href="#l28.155"></a><span id="l28.155">         let dailyGroup = document.getElementById(&quot;daily-group&quot;);</span>
<a href="#l28.156"></a><span id="l28.156">         if (dailyGroup.selectedIndex == 0) {</span>
<a href="#l28.157"></a><span id="l28.157">             let ndays = Math.max(1, Number(getElementValue(&quot;daily-days&quot;)));</span>
<a href="#l28.158"></a><span id="l28.158">             recRule.interval = ndays;</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineat">@@ -396,18 +396,18 @@ function onSave(item) {</span>
<a href="#l28.160"></a><span id="l28.160"> }</span>
<a href="#l28.161"></a><span id="l28.161"> </span>
<a href="#l28.162"></a><span id="l28.162"> /**</span>
<a href="#l28.163"></a><span id="l28.163">  * Handler function to be called when the accept button is pressed.</span>
<a href="#l28.164"></a><span id="l28.164">  *</span>
<a href="#l28.165"></a><span id="l28.165">  * @return      Returns true if the window should be closed</span>
<a href="#l28.166"></a><span id="l28.166">  */</span>
<a href="#l28.167"></a><span id="l28.167"> function onAccept() {</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l28.172"></a><span id="l28.172">     args.onOk(onSave(item));</span>
<a href="#l28.173"></a><span id="l28.173">     // Don't close the dialog if a warning must be showed.</span>
<a href="#l28.174"></a><span id="l28.174">     return !checkUntilDate.warning;</span>
<a href="#l28.175"></a><span id="l28.175"> }</span>
<a href="#l28.176"></a><span id="l28.176"> </span>
<a href="#l28.177"></a><span id="l28.177"> /**</span>
<a href="#l28.178"></a><span id="l28.178">  * Handler function to be called when the Cancel button is pressed.</span>
<a href="#l28.179"></a><span id="l28.179">  *</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineat">@@ -424,18 +424,18 @@ function onCancel() {</span>
<a href="#l28.181"></a><span id="l28.181">  * setup).</span>
<a href="#l28.182"></a><span id="l28.182">  *</span>
<a href="#l28.183"></a><span id="l28.183">  * XXX we don't change the calendar in this dialog, this function should be</span>
<a href="#l28.184"></a><span id="l28.184">  * consolidated or renamed.</span>
<a href="#l28.185"></a><span id="l28.185">  *</span>
<a href="#l28.186"></a><span id="l28.186">  * @param calendar    The calendar to use for setup.</span>
<a href="#l28.187"></a><span id="l28.187">  */</span>
<a href="#l28.188"></a><span id="l28.188"> function onChangeCalendar(calendar) {</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l28.193"></a><span id="l28.193"> </span>
<a href="#l28.194"></a><span id="l28.194">     // Set 'gIsReadOnly' if the calendar is read-only</span>
<a href="#l28.195"></a><span id="l28.195">     gIsReadOnly = false;</span>
<a href="#l28.196"></a><span id="l28.196">     if (calendar &amp;&amp; calendar.readOnly) {</span>
<a href="#l28.197"></a><span id="l28.197">         gIsReadOnly = true;</span>
<a href="#l28.198"></a><span id="l28.198">     }</span>
<a href="#l28.199"></a><span id="l28.199"> </span>
<a href="#l28.200"></a><span id="l28.200">     // Disable or enable controls based on a set or rules</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineat">@@ -473,50 +473,50 @@ function disableOrEnable(item) {</span>
<a href="#l28.202"></a><span id="l28.202"> </span>
<a href="#l28.203"></a><span id="l28.203"> /**</span>
<a href="#l28.204"></a><span id="l28.204">  * Disables all fields that have an attribute that matches the argument and is</span>
<a href="#l28.205"></a><span id="l28.205">  * set to &quot;true&quot;.</span>
<a href="#l28.206"></a><span id="l28.206">  *</span>
<a href="#l28.207"></a><span id="l28.207">  * @param aAttributeName    The attribute to search for.</span>
<a href="#l28.208"></a><span id="l28.208">  */</span>
<a href="#l28.209"></a><span id="l28.209"> function disableRecurrenceFields(aAttributeName) {</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-    var disableElements = document.getElementsByAttribute(aAttributeName, &quot;true&quot;);</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineminus">-    for (var i = 0; i &lt; disableElements.length; i++) {</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineplus">+    let disableElements = document.getElementsByAttribute(aAttributeName, &quot;true&quot;);</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineplus">+    for (let i = 0; i &lt; disableElements.length; i++) {</span>
<a href="#l28.214"></a><span id="l28.214">         disableElements[i].setAttribute('disabled', 'true');</span>
<a href="#l28.215"></a><span id="l28.215">     }</span>
<a href="#l28.216"></a><span id="l28.216"> }</span>
<a href="#l28.217"></a><span id="l28.217"> </span>
<a href="#l28.218"></a><span id="l28.218"> /**</span>
<a href="#l28.219"></a><span id="l28.219">  * Enables all fields that have an attribute that matches the argument and is</span>
<a href="#l28.220"></a><span id="l28.220">  * set to &quot;true&quot;.</span>
<a href="#l28.221"></a><span id="l28.221">  *</span>
<a href="#l28.222"></a><span id="l28.222">  * @param aAttributeName    The attribute to search for.</span>
<a href="#l28.223"></a><span id="l28.223">  */</span>
<a href="#l28.224"></a><span id="l28.224"> function enableRecurrenceFields(aAttributeName) {</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineminus">-    var enableElements = document.getElementsByAttribute(aAttributeName, &quot;true&quot;);</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineminus">-    for (var i = 0; i &lt; enableElements.length; i++) {</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineplus">+    let enableElements = document.getElementsByAttribute(aAttributeName, &quot;true&quot;);</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineplus">+    for (let i = 0; i &lt; enableElements.length; i++) {</span>
<a href="#l28.229"></a><span id="l28.229">         enableElements[i].removeAttribute('disabled');</span>
<a href="#l28.230"></a><span id="l28.230">     }</span>
<a href="#l28.231"></a><span id="l28.231"> }</span>
<a href="#l28.232"></a><span id="l28.232"> </span>
<a href="#l28.233"></a><span id="l28.233"> /**</span>
<a href="#l28.234"></a><span id="l28.234">  * Split rules into negative and positive rules.</span>
<a href="#l28.235"></a><span id="l28.235">  *</span>
<a href="#l28.236"></a><span id="l28.236">  * XXX This function is duplicate from calendar-dialog-utils.js, which we may</span>
<a href="#l28.237"></a><span id="l28.237">  * want to include in this dialog.</span>
<a href="#l28.238"></a><span id="l28.238">  *</span>
<a href="#l28.239"></a><span id="l28.239">  * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l28.240"></a><span id="l28.240">  * @return                  An array with two elements: an array of positive</span>
<a href="#l28.241"></a><span id="l28.241">  *                            rules and an array of negative rules.</span>
<a href="#l28.242"></a><span id="l28.242">  */</span>
<a href="#l28.243"></a><span id="l28.243"> function splitRecurrenceRules(recurrenceInfo) {</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineminus">-    var ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineminus">-    var rules = [];</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineminus">-    var exceptions = [];</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineminus">-    for (var r of ritems) {</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineplus">+    let ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineplus">+    let rules = [];</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineplus">+    let exceptions = [];</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineplus">+    for (let r of ritems) {</span>
<a href="#l28.252"></a><span id="l28.252">         if (r.isNegative) {</span>
<a href="#l28.253"></a><span id="l28.253">             exceptions.push(r);</span>
<a href="#l28.254"></a><span id="l28.254">         } else {</span>
<a href="#l28.255"></a><span id="l28.255">             rules.push(r);</span>
<a href="#l28.256"></a><span id="l28.256">         }</span>
<a href="#l28.257"></a><span id="l28.257">     }</span>
<a href="#l28.258"></a><span id="l28.258">     return [rules, exceptions];</span>
<a href="#l28.259"></a><span id="l28.259"> }</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineat">@@ -531,43 +531,43 @@ function updateRecurrenceDeck() {</span>
<a href="#l28.261"></a><span id="l28.261">     updateRecurrenceControls();</span>
<a href="#l28.262"></a><span id="l28.262"> }</span>
<a href="#l28.263"></a><span id="l28.263"> </span>
<a href="#l28.264"></a><span id="l28.264"> /**</span>
<a href="#l28.265"></a><span id="l28.265">  * Updates the controls regarding ranged controls (i.e repeat forever, repeat</span>
<a href="#l28.266"></a><span id="l28.266">  * until, repeat n times...)</span>
<a href="#l28.267"></a><span id="l28.267">  */</span>
<a href="#l28.268"></a><span id="l28.268"> function updateRecurrenceRange() {</span>
<a href="#l28.269"></a><span id="l28.269" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l28.273"></a><span id="l28.273">     if (item.parentItem != item || gIsReadOnly) {</span>
<a href="#l28.274"></a><span id="l28.274">         return;</span>
<a href="#l28.275"></a><span id="l28.275">     }</span>
<a href="#l28.276"></a><span id="l28.276"> </span>
<a href="#l28.277"></a><span id="l28.277" class="difflineminus">-    var radioRangeForever =</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineplus">+    let radioRangeForever =</span>
<a href="#l28.279"></a><span id="l28.279">         document.getElementById(&quot;recurrence-range-forever&quot;);</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineminus">-    var radioRangeFor =</span>
<a href="#l28.281"></a><span id="l28.281" class="difflineplus">+    let radioRangeFor =</span>
<a href="#l28.282"></a><span id="l28.282">         document.getElementById(&quot;recurrence-range-for&quot;);</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineminus">-    var radioRangeUntil =</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+    let radioRangeUntil =</span>
<a href="#l28.285"></a><span id="l28.285">         document.getElementById(&quot;recurrence-range-until&quot;);</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineminus">-    var rangeTimesCount =</span>
<a href="#l28.287"></a><span id="l28.287" class="difflineplus">+    let rangeTimesCount =</span>
<a href="#l28.288"></a><span id="l28.288">         document.getElementById(&quot;repeat-ntimes-count&quot;);</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineminus">-    var rangeUntilDate =</span>
<a href="#l28.290"></a><span id="l28.290" class="difflineplus">+    let rangeUntilDate =</span>
<a href="#l28.291"></a><span id="l28.291">         document.getElementById(&quot;repeat-until-date&quot;);</span>
<a href="#l28.292"></a><span id="l28.292" class="difflineminus">-    var rangeAppointmentsLabel =</span>
<a href="#l28.293"></a><span id="l28.293" class="difflineplus">+    let rangeAppointmentsLabel =</span>
<a href="#l28.294"></a><span id="l28.294">         document.getElementById(&quot;repeat-appointments-label&quot;);</span>
<a href="#l28.295"></a><span id="l28.295"> </span>
<a href="#l28.296"></a><span id="l28.296" class="difflineminus">-    var deckNumber = Number(getElementValue(&quot;period-list&quot;));</span>
<a href="#l28.297"></a><span id="l28.297" class="difflineplus">+    let deckNumber = Number(getElementValue(&quot;period-list&quot;));</span>
<a href="#l28.298"></a><span id="l28.298"> </span>
<a href="#l28.299"></a><span id="l28.299">     radioRangeForever.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.300"></a><span id="l28.300">     radioRangeFor.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.301"></a><span id="l28.301">     radioRangeUntil.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.302"></a><span id="l28.302">     rangeAppointmentsLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.303"></a><span id="l28.303"> </span>
<a href="#l28.304"></a><span id="l28.304" class="difflineminus">-    var durationSelection = document.getElementById(&quot;recurrence-duration&quot;)</span>
<a href="#l28.305"></a><span id="l28.305" class="difflineplus">+    let durationSelection = document.getElementById(&quot;recurrence-duration&quot;)</span>
<a href="#l28.306"></a><span id="l28.306">                                     .selectedItem.value;</span>
<a href="#l28.307"></a><span id="l28.307"> </span>
<a href="#l28.308"></a><span id="l28.308">     if (durationSelection == &quot;ntimes&quot;) {</span>
<a href="#l28.309"></a><span id="l28.309">         rangeTimesCount.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.310"></a><span id="l28.310">     } else {</span>
<a href="#l28.311"></a><span id="l28.311">         rangeTimesCount.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.312"></a><span id="l28.312">     }</span>
<a href="#l28.313"></a><span id="l28.313"> </span>
<a href="#l28.314"></a><span id="l28.314" class="difflineat">@@ -577,55 +577,55 @@ function updateRecurrenceRange() {</span>
<a href="#l28.315"></a><span id="l28.315">         rangeUntilDate.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.316"></a><span id="l28.316">     }</span>
<a href="#l28.317"></a><span id="l28.317"> }</span>
<a href="#l28.318"></a><span id="l28.318"> </span>
<a href="#l28.319"></a><span id="l28.319"> /**</span>
<a href="#l28.320"></a><span id="l28.320">  * Updates the recurrence preview calendars using the window's item.</span>
<a href="#l28.321"></a><span id="l28.321">  */</span>
<a href="#l28.322"></a><span id="l28.322"> function updatePreview() {</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.324"></a><span id="l28.324" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l28.327"></a><span id="l28.327">     if (item.parentItem != item) {</span>
<a href="#l28.328"></a><span id="l28.328">         item = item.parentItem;</span>
<a href="#l28.329"></a><span id="l28.329">     }</span>
<a href="#l28.330"></a><span id="l28.330"> </span>
<a href="#l28.331"></a><span id="l28.331">     // TODO: We should better start the whole dialog with a newly cloned item</span>
<a href="#l28.332"></a><span id="l28.332">     // and always pump changes immediately into it. This would eliminate the</span>
<a href="#l28.333"></a><span id="l28.333">     // need to break the encapsulation, as we do it here. But we need the item</span>
<a href="#l28.334"></a><span id="l28.334">     // to contain the startdate in order to calculate the recurrence preview.</span>
<a href="#l28.335"></a><span id="l28.335">     item = item.clone();</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l28.338"></a><span id="l28.338">     if (isEvent(item)) {</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineminus">-        var startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineminus">-        var endDate = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineplus">+        let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.342"></a><span id="l28.342" class="difflineplus">+        let endDate = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.343"></a><span id="l28.343">         if (startDate.isDate) {</span>
<a href="#l28.344"></a><span id="l28.344">             endDate.day--;</span>
<a href="#l28.345"></a><span id="l28.345">         }</span>
<a href="#l28.346"></a><span id="l28.346"> </span>
<a href="#l28.347"></a><span id="l28.347">         item.startDate = startDate;</span>
<a href="#l28.348"></a><span id="l28.348">         item.endDate = endDate;</span>
<a href="#l28.349"></a><span id="l28.349">     }</span>
<a href="#l28.350"></a><span id="l28.350">     if (isToDo(item)) {</span>
<a href="#l28.351"></a><span id="l28.351" class="difflineminus">-        var entryDate = gStartTime;</span>
<a href="#l28.352"></a><span id="l28.352" class="difflineplus">+        let entryDate = gStartTime;</span>
<a href="#l28.353"></a><span id="l28.353">         if (entryDate) {</span>
<a href="#l28.354"></a><span id="l28.354">             entryDate = entryDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.355"></a><span id="l28.355">         } else {</span>
<a href="#l28.356"></a><span id="l28.356">             item.recurrenceInfo = null;</span>
<a href="#l28.357"></a><span id="l28.357">         }</span>
<a href="#l28.358"></a><span id="l28.358">         item.entryDate = entryDate;</span>
<a href="#l28.359"></a><span id="l28.359" class="difflineminus">-        var dueDate = gEndTime;</span>
<a href="#l28.360"></a><span id="l28.360" class="difflineplus">+        let dueDate = gEndTime;</span>
<a href="#l28.361"></a><span id="l28.361">         if (dueDate) {</span>
<a href="#l28.362"></a><span id="l28.362">             dueDate = dueDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l28.363"></a><span id="l28.363">         }</span>
<a href="#l28.364"></a><span id="l28.364">         item.dueDate = dueDate;</span>
<a href="#l28.365"></a><span id="l28.365">     }</span>
<a href="#l28.366"></a><span id="l28.366"> </span>
<a href="#l28.367"></a><span id="l28.367" class="difflineminus">-    var recInfo = onSave(item);</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineminus">-    var preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineplus">+    let recInfo = onSave(item);</span>
<a href="#l28.370"></a><span id="l28.370" class="difflineplus">+    let preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l28.371"></a><span id="l28.371">     preview.updatePreview(recInfo);</span>
<a href="#l28.372"></a><span id="l28.372"> }</span>
<a href="#l28.373"></a><span id="l28.373"> </span>
<a href="#l28.374"></a><span id="l28.374"> /**</span>
<a href="#l28.375"></a><span id="l28.375">  * Checks the until date just entered in the datepicker in order to avoid</span>
<a href="#l28.376"></a><span id="l28.376">  * setting a date earlier than the start date.</span>
<a href="#l28.377"></a><span id="l28.377">  * Restores the previous correct date, shows a warning and prevents to close the</span>
<a href="#l28.378"></a><span id="l28.378">  * dialog when the user enters a wrong until date.</span>
<a href="#l28.379"></a><span id="l28.379" class="difflineat">@@ -664,61 +664,61 @@ function updateRecurrenceControls() {</span>
<a href="#l28.380"></a><span id="l28.380"> }</span>
<a href="#l28.381"></a><span id="l28.381"> </span>
<a href="#l28.382"></a><span id="l28.382"> /**</span>
<a href="#l28.383"></a><span id="l28.383">  * Disables/enables controls related to the recurrence pattern.</span>
<a href="#l28.384"></a><span id="l28.384">  * the status of the controls depends on which period entry is selected</span>
<a href="#l28.385"></a><span id="l28.385">  * and which form of pattern rule is selected.</span>
<a href="#l28.386"></a><span id="l28.386">  */</span>
<a href="#l28.387"></a><span id="l28.387"> function updateRecurrencePattern() {</span>
<a href="#l28.388"></a><span id="l28.388" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l28.389"></a><span id="l28.389" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l28.390"></a><span id="l28.390" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l28.391"></a><span id="l28.391" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l28.392"></a><span id="l28.392">     if (item.parentItem != item || gIsReadOnly) {</span>
<a href="#l28.393"></a><span id="l28.393">         return;</span>
<a href="#l28.394"></a><span id="l28.394">     }</span>
<a href="#l28.395"></a><span id="l28.395"> </span>
<a href="#l28.396"></a><span id="l28.396">     switch (Number(getElementValue(&quot;period-list&quot;))) {</span>
<a href="#l28.397"></a><span id="l28.397">         // daily</span>
<a href="#l28.398"></a><span id="l28.398">         case 0:</span>
<a href="#l28.399"></a><span id="l28.399" class="difflineminus">-            var dailyGroup = document.getElementById(&quot;daily-group&quot;);</span>
<a href="#l28.400"></a><span id="l28.400" class="difflineminus">-            var dailyDays = document.getElementById(&quot;daily-days&quot;);</span>
<a href="#l28.401"></a><span id="l28.401" class="difflineplus">+            let dailyGroup = document.getElementById(&quot;daily-group&quot;);</span>
<a href="#l28.402"></a><span id="l28.402" class="difflineplus">+            let dailyDays = document.getElementById(&quot;daily-days&quot;);</span>
<a href="#l28.403"></a><span id="l28.403">             dailyDays.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.404"></a><span id="l28.404">             if (dailyGroup.selectedIndex == 1) {</span>
<a href="#l28.405"></a><span id="l28.405">                 dailyDays.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.406"></a><span id="l28.406">             }</span>
<a href="#l28.407"></a><span id="l28.407">             break;</span>
<a href="#l28.408"></a><span id="l28.408">         // weekly</span>
<a href="#l28.409"></a><span id="l28.409">         case 1:</span>
<a href="#l28.410"></a><span id="l28.410">             break;</span>
<a href="#l28.411"></a><span id="l28.411">         // monthly</span>
<a href="#l28.412"></a><span id="l28.412">         case 2:</span>
<a href="#l28.413"></a><span id="l28.413" class="difflineminus">-            var monthlyGroup = document.getElementById(&quot;monthly-group&quot;);</span>
<a href="#l28.414"></a><span id="l28.414" class="difflineminus">-            var monthlyOrdinal = document.getElementById(&quot;monthly-ordinal&quot;);</span>
<a href="#l28.415"></a><span id="l28.415" class="difflineminus">-            var monthlyWeekday = document.getElementById(&quot;monthly-weekday&quot;);</span>
<a href="#l28.416"></a><span id="l28.416" class="difflineminus">-            var monthlyDays = document.getElementById(&quot;monthly-days&quot;);</span>
<a href="#l28.417"></a><span id="l28.417" class="difflineplus">+            let monthlyGroup = document.getElementById(&quot;monthly-group&quot;);</span>
<a href="#l28.418"></a><span id="l28.418" class="difflineplus">+            let monthlyOrdinal = document.getElementById(&quot;monthly-ordinal&quot;);</span>
<a href="#l28.419"></a><span id="l28.419" class="difflineplus">+            let monthlyWeekday = document.getElementById(&quot;monthly-weekday&quot;);</span>
<a href="#l28.420"></a><span id="l28.420" class="difflineplus">+            let monthlyDays = document.getElementById(&quot;monthly-days&quot;);</span>
<a href="#l28.421"></a><span id="l28.421">             monthlyOrdinal.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.422"></a><span id="l28.422">             monthlyWeekday.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.423"></a><span id="l28.423">             monthlyDays.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.424"></a><span id="l28.424">             if (monthlyGroup.selectedIndex == 0) {</span>
<a href="#l28.425"></a><span id="l28.425">                 monthlyDays.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.426"></a><span id="l28.426">             } else {</span>
<a href="#l28.427"></a><span id="l28.427">                 monthlyOrdinal.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.428"></a><span id="l28.428">                 monthlyWeekday.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.429"></a><span id="l28.429">             }</span>
<a href="#l28.430"></a><span id="l28.430">             break;</span>
<a href="#l28.431"></a><span id="l28.431">         // yearly</span>
<a href="#l28.432"></a><span id="l28.432">         case 3:</span>
<a href="#l28.433"></a><span id="l28.433" class="difflineminus">-            var yearlyGroup = document.getElementById(&quot;yearly-group&quot;);</span>
<a href="#l28.434"></a><span id="l28.434" class="difflineminus">-            var yearlyDays = document.getElementById(&quot;yearly-days&quot;);</span>
<a href="#l28.435"></a><span id="l28.435" class="difflineminus">-            var yearlyMonthOrdinal = document.getElementById(&quot;yearly-month-ordinal&quot;);</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineminus">-            var yearlyPeriodOfMonthLabel = document.getElementById(&quot;yearly-period-of-month-label&quot;);</span>
<a href="#l28.437"></a><span id="l28.437" class="difflineminus">-            var yearlyOrdinal = document.getElementById(&quot;yearly-ordinal&quot;);</span>
<a href="#l28.438"></a><span id="l28.438" class="difflineminus">-            var yearlyWeekday = document.getElementById(&quot;yearly-weekday&quot;);</span>
<a href="#l28.439"></a><span id="l28.439" class="difflineminus">-            var yearlyMonthRule = document.getElementById(&quot;yearly-month-rule&quot;);</span>
<a href="#l28.440"></a><span id="l28.440" class="difflineminus">-            var yearlyPeriodOfLabel = document.getElementById(&quot;yearly-period-of-label&quot;);</span>
<a href="#l28.441"></a><span id="l28.441" class="difflineplus">+            let yearlyGroup = document.getElementById(&quot;yearly-group&quot;);</span>
<a href="#l28.442"></a><span id="l28.442" class="difflineplus">+            let yearlyDays = document.getElementById(&quot;yearly-days&quot;);</span>
<a href="#l28.443"></a><span id="l28.443" class="difflineplus">+            let yearlyMonthOrdinal = document.getElementById(&quot;yearly-month-ordinal&quot;);</span>
<a href="#l28.444"></a><span id="l28.444" class="difflineplus">+            let yearlyPeriodOfMonthLabel = document.getElementById(&quot;yearly-period-of-month-label&quot;);</span>
<a href="#l28.445"></a><span id="l28.445" class="difflineplus">+            let yearlyOrdinal = document.getElementById(&quot;yearly-ordinal&quot;);</span>
<a href="#l28.446"></a><span id="l28.446" class="difflineplus">+            let yearlyWeekday = document.getElementById(&quot;yearly-weekday&quot;);</span>
<a href="#l28.447"></a><span id="l28.447" class="difflineplus">+            let yearlyMonthRule = document.getElementById(&quot;yearly-month-rule&quot;);</span>
<a href="#l28.448"></a><span id="l28.448" class="difflineplus">+            let yearlyPeriodOfLabel = document.getElementById(&quot;yearly-period-of-label&quot;);</span>
<a href="#l28.449"></a><span id="l28.449">             yearlyDays.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.450"></a><span id="l28.450">             yearlyMonthOrdinal.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.451"></a><span id="l28.451">             yearlyOrdinal.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.452"></a><span id="l28.452">             yearlyWeekday.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.453"></a><span id="l28.453">             yearlyMonthRule.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.454"></a><span id="l28.454">             yearlyPeriodOfLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.455"></a><span id="l28.455">             yearlyPeriodOfMonthLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.456"></a><span id="l28.456">             if (yearlyGroup.selectedIndex == 0) {</span>
<a href="#l28.457"></a><span id="l28.457" class="difflineat">@@ -740,42 +740,42 @@ function updateRecurrencePattern() {</span>
<a href="#l28.458"></a><span id="l28.458">  * This is needed for some locales that expect a different wording order.</span>
<a href="#l28.459"></a><span id="l28.459">  *</span>
<a href="#l28.460"></a><span id="l28.460">  * @param aPropKey      The locale property key to get the order from</span>
<a href="#l28.461"></a><span id="l28.461">  * @param aPropParams   An array of ids to be passed to the locale property.</span>
<a href="#l28.462"></a><span id="l28.462">  *                        These should be the ids of the elements to change</span>
<a href="#l28.463"></a><span id="l28.463">  *                        the order for.</span>
<a href="#l28.464"></a><span id="l28.464">  */</span>
<a href="#l28.465"></a><span id="l28.465"> function changeOrderForElements(aPropKey, aPropParams) {</span>
<a href="#l28.466"></a><span id="l28.466" class="difflineminus">-    var localeOrder;</span>
<a href="#l28.467"></a><span id="l28.467" class="difflineminus">-    var parents = {};</span>
<a href="#l28.468"></a><span id="l28.468" class="difflineplus">+    let localeOrder;</span>
<a href="#l28.469"></a><span id="l28.469" class="difflineplus">+    let parents = {};</span>
<a href="#l28.470"></a><span id="l28.470"> </span>
<a href="#l28.471"></a><span id="l28.471" class="difflineminus">-    for (var key in aPropParams) {</span>
<a href="#l28.472"></a><span id="l28.472" class="difflineplus">+    for (let key in aPropParams) {</span>
<a href="#l28.473"></a><span id="l28.473">         // Save original parents so that the nodes to reorder get appended to</span>
<a href="#l28.474"></a><span id="l28.474">         // the correct parent nodes.</span>
<a href="#l28.475"></a><span id="l28.475">         parents[key] = document.getElementById(aPropParams[key]).parentNode;</span>
<a href="#l28.476"></a><span id="l28.476">     }</span>
<a href="#l28.477"></a><span id="l28.477"> </span>
<a href="#l28.478"></a><span id="l28.478">     try {</span>
<a href="#l28.479"></a><span id="l28.479">         localeOrder = calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l28.480"></a><span id="l28.480">                                    aPropKey,</span>
<a href="#l28.481"></a><span id="l28.481">                                    aPropParams);</span>
<a href="#l28.482"></a><span id="l28.482"> </span>
<a href="#l28.483"></a><span id="l28.483">         localeOrder = localeOrder.split(&quot; &quot;);</span>
<a href="#l28.484"></a><span id="l28.484">     } catch (ex) {</span>
<a href="#l28.485"></a><span id="l28.485" class="difflineminus">-        var s = &quot;The key &quot; + aPropKey + &quot; in calendar-event-dialog.prop&quot; +</span>
<a href="#l28.486"></a><span id="l28.486" class="difflineplus">+        let s = &quot;The key &quot; + aPropKey + &quot; in calendar-event-dialog.prop&quot; +</span>
<a href="#l28.487"></a><span id="l28.487">                 &quot;erties has incorrect number of params. Expected &quot; +</span>
<a href="#l28.488"></a><span id="l28.488">                 aPropParams.length + &quot; params.&quot;;</span>
<a href="#l28.489"></a><span id="l28.489">         Components.utils.reportError(s + &quot; &quot; + ex);</span>
<a href="#l28.490"></a><span id="l28.490">         return;</span>
<a href="#l28.491"></a><span id="l28.491">     }</span>
<a href="#l28.492"></a><span id="l28.492"> </span>
<a href="#l28.493"></a><span id="l28.493">     // Add elements in the right order, removing them from their old parent</span>
<a href="#l28.494"></a><span id="l28.494">     for (let i = 0; i &lt; aPropParams.length; i++) {</span>
<a href="#l28.495"></a><span id="l28.495" class="difflineminus">-        var newEl = document.getElementById(localeOrder[i]);</span>
<a href="#l28.496"></a><span id="l28.496" class="difflineplus">+        let newEl = document.getElementById(localeOrder[i]);</span>
<a href="#l28.497"></a><span id="l28.497">         if (newEl) {</span>
<a href="#l28.498"></a><span id="l28.498">             parents[i].appendChild(newEl.parentNode.removeChild(newEl));</span>
<a href="#l28.499"></a><span id="l28.499">         } else {</span>
<a href="#l28.500"></a><span id="l28.500">             cal.ERROR(&quot;Localization error, could not find node '&quot; + localeOrder[i] + &quot;'. Please have your localizer check the string '&quot; + aPropKey + &quot;'&quot;);</span>
<a href="#l28.501"></a><span id="l28.501">         }</span>
<a href="#l28.502"></a><span id="l28.502">     }</span>
<a href="#l28.503"></a><span id="l28.503"> }</span>
<a href="#l28.504"></a><span id="l28.504"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> /**</span>
<a href="#l29.8"></a><span id="l29.8">  * Sets up the timezone dialog from the window arguments, also setting up all</span>
<a href="#l29.9"></a><span id="l29.9">  * dialog controls from the window's dates.</span>
<a href="#l29.10"></a><span id="l29.10">  */</span>
<a href="#l29.11"></a><span id="l29.11"> function onLoad() {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l29.14"></a><span id="l29.14">     window.time = args.time;</span>
<a href="#l29.15"></a><span id="l29.15">     window.onAcceptCallback = args.onOk;</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17">     let tzProvider = (args.calendar.getProperty(&quot;timezones.provider&quot;) ||</span>
<a href="#l29.18"></a><span id="l29.18">                       cal.getTimezoneService());</span>
<a href="#l29.19"></a><span id="l29.19">     window.tzProvider = tzProvider;</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">     let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -64,21 +64,21 @@ function onLoad() {</span>
<a href="#l29.23"></a><span id="l29.23"> </span>
<a href="#l29.24"></a><span id="l29.24"> /**</span>
<a href="#l29.25"></a><span id="l29.25">  * Find the index of the timezone menuitem corresponding to the given timezone.</span>
<a href="#l29.26"></a><span id="l29.26">  *</span>
<a href="#l29.27"></a><span id="l29.27">  * @param timezone      The calITimezone to look for.</span>
<a href="#l29.28"></a><span id="l29.28">  * @return              The index of the childnode below &quot;timezone-menulist&quot;</span>
<a href="#l29.29"></a><span id="l29.29">  */</span>
<a href="#l29.30"></a><span id="l29.30"> function findTimezone(timezone) {</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-    var tzid = timezone.tzid;</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-    var menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-    var numChilds = menulist.childNodes[0].childNodes.length;</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-    for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-        var menuitem = menulist.childNodes[0].childNodes[i];</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+    let tzid = timezone.tzid;</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+    let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+    let numChilds = menulist.childNodes[0].childNodes.length;</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+    for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+        let menuitem = menulist.childNodes[0].childNodes[i];</span>
<a href="#l29.41"></a><span id="l29.41">         if (menuitem.getAttribute(&quot;value&quot;) == tzid) {</span>
<a href="#l29.42"></a><span id="l29.42">             return i;</span>
<a href="#l29.43"></a><span id="l29.43">         }</span>
<a href="#l29.44"></a><span id="l29.44">     }</span>
<a href="#l29.45"></a><span id="l29.45">     return -1;</span>
<a href="#l29.46"></a><span id="l29.46"> }</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48"> /**</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineat">@@ -114,21 +114,21 @@ function updateTimezone() {</span>
<a href="#l29.50"></a><span id="l29.50">     image.setAttribute(&quot;tzid&quot;, standardTZOffset);</span>
<a href="#l29.51"></a><span id="l29.51"> }</span>
<a href="#l29.52"></a><span id="l29.52"> /**</span>
<a href="#l29.53"></a><span id="l29.53">  * Handler function to be called when the accept button is pressed.</span>
<a href="#l29.54"></a><span id="l29.54">  *</span>
<a href="#l29.55"></a><span id="l29.55">  * @return      Returns true if the window should be closed</span>
<a href="#l29.56"></a><span id="l29.56">  */</span>
<a href="#l29.57"></a><span id="l29.57"> function onAccept() {</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-    var menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-    var menuitem = menulist.selectedItem;</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-    var timezone = menuitem.getAttribute(&quot;value&quot;);</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-    var tz = window.tzProvider.getTimezone(timezone);</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-    var datetime = window.time.getInTimezone(tz);</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+    let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+    let menuitem = menulist.selectedItem;</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+    let timezone = menuitem.getAttribute(&quot;value&quot;);</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+    let tz = window.tzProvider.getTimezone(timezone);</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+    let datetime = window.time.getInTimezone(tz);</span>
<a href="#l29.68"></a><span id="l29.68">     window.onAcceptCallback(datetime);</span>
<a href="#l29.69"></a><span id="l29.69">     return true;</span>
<a href="#l29.70"></a><span id="l29.70"> }</span>
<a href="#l29.71"></a><span id="l29.71"> </span>
<a href="#l29.72"></a><span id="l29.72"> /**</span>
<a href="#l29.73"></a><span id="l29.73">  * Handler function to be called when the cancel button is pressed.</span>
<a href="#l29.74"></a><span id="l29.74">  *</span>
<a href="#l29.75"></a><span id="l29.75">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -6,121 +6,121 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l30.4"></a><span id="l30.4"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l30.5"></a><span id="l30.5"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7"> /**</span>
<a href="#l30.8"></a><span id="l30.8">  * Sets up the invitations dialog from the window arguments, retrieves the</span>
<a href="#l30.9"></a><span id="l30.9">  * invitations from the invitations manager.</span>
<a href="#l30.10"></a><span id="l30.10">  */</span>
<a href="#l30.11"></a><span id="l30.11"> function onLoad() {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-    var operationListener = {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+    let operationListener = {</span>
<a href="#l30.14"></a><span id="l30.14">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l30.15"></a><span id="l30.15">         onOperationComplete: function oL_onOperationComplete(aCalendar,</span>
<a href="#l30.16"></a><span id="l30.16">                                                              aStatus,</span>
<a href="#l30.17"></a><span id="l30.17">                                                              aOperationType,</span>
<a href="#l30.18"></a><span id="l30.18">                                                              aId,</span>
<a href="#l30.19"></a><span id="l30.19">                                                              aDetail) {</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-            var updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+            let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l30.22"></a><span id="l30.22">             updatingBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-            var richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+            let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l30.25"></a><span id="l30.25">             if (richListBox.getRowCount() &gt; 0) {</span>
<a href="#l30.26"></a><span id="l30.26">                 richListBox.selectedIndex = 0;</span>
<a href="#l30.27"></a><span id="l30.27">             } else {</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-                var noInvitationsBox =</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+                let noInvitationsBox =</span>
<a href="#l30.30"></a><span id="l30.30">                     document.getElementById(&quot;noinvitations-box&quot;);</span>
<a href="#l30.31"></a><span id="l30.31">                 noInvitationsBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l30.32"></a><span id="l30.32">             }</span>
<a href="#l30.33"></a><span id="l30.33">         },</span>
<a href="#l30.34"></a><span id="l30.34">         onGetResult: function oL_onGetResult(aCalendar,</span>
<a href="#l30.35"></a><span id="l30.35">                                              aStatus,</span>
<a href="#l30.36"></a><span id="l30.36">                                              aItemType,</span>
<a href="#l30.37"></a><span id="l30.37">                                              aDetail,</span>
<a href="#l30.38"></a><span id="l30.38">                                              aCount,</span>
<a href="#l30.39"></a><span id="l30.39">                                              aItems) {</span>
<a href="#l30.40"></a><span id="l30.40">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l30.41"></a><span id="l30.41">                 return;</span>
<a href="#l30.42"></a><span id="l30.42">             }</span>
<a href="#l30.43"></a><span id="l30.43">             document.title = invitationsText + &quot; (&quot; + aCount + &quot;)&quot;;</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-            var updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+            let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l30.46"></a><span id="l30.46">             updatingBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-            var richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-            for (var item of aItems) {</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+            let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+            for (let item of aItems) {</span>
<a href="#l30.51"></a><span id="l30.51">                 richListBox.addCalendarItem(item);</span>
<a href="#l30.52"></a><span id="l30.52">             }</span>
<a href="#l30.53"></a><span id="l30.53">         }</span>
<a href="#l30.54"></a><span id="l30.54">     };</span>
<a href="#l30.55"></a><span id="l30.55"> </span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-    var updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+    let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l30.58"></a><span id="l30.58">     updatingBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l30.59"></a><span id="l30.59"> </span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l30.62"></a><span id="l30.62">     args.invitationsManager.getInvitations(operationListener,</span>
<a href="#l30.63"></a><span id="l30.63">                                            args.onLoadOperationListener);</span>
<a href="#l30.64"></a><span id="l30.64"> </span>
<a href="#l30.65"></a><span id="l30.65">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l30.66"></a><span id="l30.66"> }</span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68"> /**</span>
<a href="#l30.69"></a><span id="l30.69">  * Cleans up the invitations dialog, cancels pending requests.</span>
<a href="#l30.70"></a><span id="l30.70">  */</span>
<a href="#l30.71"></a><span id="l30.71"> function onUnload() {</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l30.74"></a><span id="l30.74">     args.requestManager.cancelPendingRequests();</span>
<a href="#l30.75"></a><span id="l30.75"> }</span>
<a href="#l30.76"></a><span id="l30.76"> </span>
<a href="#l30.77"></a><span id="l30.77"> /**</span>
<a href="#l30.78"></a><span id="l30.78">  * Handler function to be called when the accept button is pressed.</span>
<a href="#l30.79"></a><span id="l30.79">  *</span>
<a href="#l30.80"></a><span id="l30.80">  * @return      Returns true if the window should be closed</span>
<a href="#l30.81"></a><span id="l30.81">  */</span>
<a href="#l30.82"></a><span id="l30.82"> function onAccept() {</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l30.85"></a><span id="l30.85">     fillJobQueue(args.queue);</span>
<a href="#l30.86"></a><span id="l30.86">     args.invitationsManager.processJobQueue(args.queue, args.finishedCallBack);</span>
<a href="#l30.87"></a><span id="l30.87">     return true;</span>
<a href="#l30.88"></a><span id="l30.88"> }</span>
<a href="#l30.89"></a><span id="l30.89"> </span>
<a href="#l30.90"></a><span id="l30.90"> /**</span>
<a href="#l30.91"></a><span id="l30.91">  * Handler function to be called when the cancel button is pressed.</span>
<a href="#l30.92"></a><span id="l30.92">  */</span>
<a href="#l30.93"></a><span id="l30.93"> function onCancel() {</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l30.96"></a><span id="l30.96">     if (args.finishedCallBack) {</span>
<a href="#l30.97"></a><span id="l30.97">         args.finishedCallBack();</span>
<a href="#l30.98"></a><span id="l30.98">     }</span>
<a href="#l30.99"></a><span id="l30.99"> }</span>
<a href="#l30.100"></a><span id="l30.100"> </span>
<a href="#l30.101"></a><span id="l30.101"> /**</span>
<a href="#l30.102"></a><span id="l30.102">  * Fills the job queue from the invitations-listbox's items. The job queue</span>
<a href="#l30.103"></a><span id="l30.103">  * contains objects for all items that have a modified participation status.</span>
<a href="#l30.104"></a><span id="l30.104">  *</span>
<a href="#l30.105"></a><span id="l30.105">  * @param queue     The queue to fill.</span>
<a href="#l30.106"></a><span id="l30.106">  */</span>
<a href="#l30.107"></a><span id="l30.107"> function fillJobQueue(queue) {</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-    var richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-    var rowCount = richListBox.getRowCount();</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-    for (var i = 0; i &lt; rowCount; i++) {</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-        var richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-        var newStatus = richListItem.participationStatus;</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-        var oldStatus = richListItem.initialParticipationStatus;</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+    let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+    let rowCount = richListBox.getRowCount();</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+    for (let i = 0; i &lt; rowCount; i++) {</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+        let richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+        let newStatus = richListItem.participationStatus;</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+        let oldStatus = richListItem.initialParticipationStatus;</span>
<a href="#l30.120"></a><span id="l30.120">         if (newStatus != oldStatus) {</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-            var actionString = &quot;modify&quot;;</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-            var oldCalendarItem = richListItem.calendarItem;</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-            var newCalendarItem = oldCalendarItem.clone();</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+            let actionString = &quot;modify&quot;;</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+            let oldCalendarItem = richListItem.calendarItem;</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+            let newCalendarItem = oldCalendarItem.clone();</span>
<a href="#l30.127"></a><span id="l30.127"> </span>
<a href="#l30.128"></a><span id="l30.128">             // set default alarm on unresponded items that have not been declined:</span>
<a href="#l30.129"></a><span id="l30.129">             if (!newCalendarItem.getAlarms({}).length &amp;&amp;</span>
<a href="#l30.130"></a><span id="l30.130">                 (oldStatus == &quot;NEEDS-ACTION&quot;) &amp;&amp;</span>
<a href="#l30.131"></a><span id="l30.131">                 (newStatus != &quot;DECLINED&quot;)) {</span>
<a href="#l30.132"></a><span id="l30.132">                 cal.alarms.setDefaultValues(newCalendarItem);</span>
<a href="#l30.133"></a><span id="l30.133">             }</span>
<a href="#l30.134"></a><span id="l30.134"> </span>
<a href="#l30.135"></a><span id="l30.135">             richListItem.setCalendarItemParticipationStatus(newCalendarItem,</span>
<a href="#l30.136"></a><span id="l30.136">                 newStatus);</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">-            var job = {</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+            let job = {</span>
<a href="#l30.139"></a><span id="l30.139">                 action: actionString,</span>
<a href="#l30.140"></a><span id="l30.140">                 oldItem: oldCalendarItem,</span>
<a href="#l30.141"></a><span id="l30.141">                 newItem: newCalendarItem</span>
<a href="#l30.142"></a><span id="l30.142">             };</span>
<a href="#l30.143"></a><span id="l30.143">             queue.push(job);</span>
<a href="#l30.144"></a><span id="l30.144">         }</span>
<a href="#l30.145"></a><span id="l30.145">     }</span>
<a href="#l30.146"></a><span id="l30.146"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l31.4"></a><span id="l31.4">   &lt;binding id=&quot;calendar-invitations-richlistbox&quot;</span>
<a href="#l31.5"></a><span id="l31.5">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistbox&quot;</span>
<a href="#l31.6"></a><span id="l31.6">            xbl:inherits=&quot;flex&quot;&gt;</span>
<a href="#l31.7"></a><span id="l31.7">     &lt;implementation&gt;</span>
<a href="#l31.8"></a><span id="l31.8">       &lt;!-- methods --&gt;</span>
<a href="#l31.9"></a><span id="l31.9">       &lt;method name=&quot;addCalendarItem&quot;&gt;</span>
<a href="#l31.10"></a><span id="l31.10">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l31.11"></a><span id="l31.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-          var newNode = createXULElement(&quot;calendar-invitations-richlistitem&quot;);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+          let newNode = createXULElement(&quot;calendar-invitations-richlistitem&quot;);</span>
<a href="#l31.14"></a><span id="l31.14">           this.appendChild(newNode);</span>
<a href="#l31.15"></a><span id="l31.15">           newNode.setAttribute(&quot;anonid&quot;, &quot;invitations-listitem&quot;);</span>
<a href="#l31.16"></a><span id="l31.16">           newNode.calendarItem = aItem;</span>
<a href="#l31.17"></a><span id="l31.17">         ]]&gt;&lt;/body&gt;</span>
<a href="#l31.18"></a><span id="l31.18">       &lt;/method&gt;</span>
<a href="#l31.19"></a><span id="l31.19">     &lt;/implementation&gt;</span>
<a href="#l31.20"></a><span id="l31.20">   &lt;/binding&gt;</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -102,17 +102,17 @@</span>
<a href="#l31.23"></a><span id="l31.23">       &lt;/property&gt;</span>
<a href="#l31.24"></a><span id="l31.24"> </span>
<a href="#l31.25"></a><span id="l31.25">       &lt;property name=&quot;participationStatus&quot;&gt;</span>
<a href="#l31.26"></a><span id="l31.26">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l31.27"></a><span id="l31.27">           return this.mParticipationStatus;</span>
<a href="#l31.28"></a><span id="l31.28">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l31.29"></a><span id="l31.29">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l31.30"></a><span id="l31.30">           this.mParticipationStatus = val;</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-          var icon = document.getAnonymousElementByAttribute(</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+          let icon = document.getAnonymousElementByAttribute(</span>
<a href="#l31.33"></a><span id="l31.33">               this, &quot;anonid&quot;, &quot;icon&quot;);</span>
<a href="#l31.34"></a><span id="l31.34">           icon.setAttribute(&quot;status&quot;, val);</span>
<a href="#l31.35"></a><span id="l31.35">           return val;</span>
<a href="#l31.36"></a><span id="l31.36">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l31.37"></a><span id="l31.37">       &lt;/property&gt;</span>
<a href="#l31.38"></a><span id="l31.38"> </span>
<a href="#l31.39"></a><span id="l31.39">       &lt;!-- constructor --&gt;</span>
<a href="#l31.40"></a><span id="l31.40">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineat">@@ -124,54 +124,54 @@</span>
<a href="#l31.42"></a><span id="l31.42">       &lt;method name=&quot;setCalendarItem&quot;&gt;</span>
<a href="#l31.43"></a><span id="l31.43">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l31.44"></a><span id="l31.44">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l31.45"></a><span id="l31.45">             this.mCalendarItem = aItem;</span>
<a href="#l31.46"></a><span id="l31.46">             this.mInitialParticipationStatus =</span>
<a href="#l31.47"></a><span id="l31.47">                 this.getCalendarItemParticipationStatus(aItem);</span>
<a href="#l31.48"></a><span id="l31.48">             this.participationStatus = this.mInitialParticipationStatus;</span>
<a href="#l31.49"></a><span id="l31.49"> </span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-            var titleLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+            let titleLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.52"></a><span id="l31.52">                 this, &quot;anonid&quot;, &quot;title&quot;);</span>
<a href="#l31.53"></a><span id="l31.53">             titleLabel.setAttribute(&quot;value&quot;, aItem.title);</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-            var dateLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+            let dateLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.57"></a><span id="l31.57">                 this, &quot;anonid&quot;, &quot;date&quot;);</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-            var dateString = this.mDateFormatter.formatItemInterval(aItem);</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+            let dateString = this.mDateFormatter.formatItemInterval(aItem);</span>
<a href="#l31.60"></a><span id="l31.60">             if (aItem.startDate.isDate) {</span>
<a href="#l31.61"></a><span id="l31.61">                 dateString += &quot;, &quot; + this.mStrings.alldayEvent;</span>
<a href="#l31.62"></a><span id="l31.62">             }</span>
<a href="#l31.63"></a><span id="l31.63">             dateLabel.setAttribute(&quot;value&quot;, dateString);</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-            var recurrenceLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+            let recurrenceLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.67"></a><span id="l31.67">                 this, &quot;anonid&quot;, &quot;recurrence&quot;);</span>
<a href="#l31.68"></a><span id="l31.68">             if (aItem.recurrenceInfo) {</span>
<a href="#l31.69"></a><span id="l31.69">                 recurrenceLabel.setAttribute(&quot;value&quot;, this.mStrings.recurrentEvent);</span>
<a href="#l31.70"></a><span id="l31.70">             } else {</span>
<a href="#l31.71"></a><span id="l31.71">                 recurrenceLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-                var spacer = document.getAnonymousElementByAttribute(</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+                let spacer = document.getAnonymousElementByAttribute(</span>
<a href="#l31.74"></a><span id="l31.74">                     this, &quot;anonid&quot;, &quot;spacer&quot;);</span>
<a href="#l31.75"></a><span id="l31.75">                 spacer.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l31.76"></a><span id="l31.76">             }</span>
<a href="#l31.77"></a><span id="l31.77"> </span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-            var locationLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+            let locationLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.80"></a><span id="l31.80">                 this, &quot;anonid&quot;, &quot;location&quot;);</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-            var locationString = this.mStrings.location;</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-            var locationProperty = aItem.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+            let locationString = this.mStrings.location;</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+            let locationProperty = aItem.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l31.85"></a><span id="l31.85">             if (locationProperty &amp;&amp; locationProperty.length &gt; 0) {</span>
<a href="#l31.86"></a><span id="l31.86">                 locationString += locationProperty;</span>
<a href="#l31.87"></a><span id="l31.87">             } else {</span>
<a href="#l31.88"></a><span id="l31.88">                 locationString += this.mStrings.none;</span>
<a href="#l31.89"></a><span id="l31.89">             }</span>
<a href="#l31.90"></a><span id="l31.90">             locationLabel.setAttribute(&quot;value&quot;, locationString);</span>
<a href="#l31.91"></a><span id="l31.91"> </span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-            var organizerLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+            let organizerLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l31.94"></a><span id="l31.94">                 this, &quot;anonid&quot;, &quot;organizer&quot;);</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-            var organizerString = this.mStrings.organizer;</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-            var org = aItem.organizer;</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+            let organizerString = this.mStrings.organizer;</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+            let org = aItem.organizer;</span>
<a href="#l31.99"></a><span id="l31.99">             if (org) {</span>
<a href="#l31.100"></a><span id="l31.100">                 if (org.commonName &amp;&amp; org.commonName.length &gt; 0) {</span>
<a href="#l31.101"></a><span id="l31.101">                     organizerString += org.commonName;</span>
<a href="#l31.102"></a><span id="l31.102">                 } else if (org.id) {</span>
<a href="#l31.103"></a><span id="l31.103">                     organizerString += org.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l31.104"></a><span id="l31.104">                 }</span>
<a href="#l31.105"></a><span id="l31.105">             }</span>
<a href="#l31.106"></a><span id="l31.106">             organizerLabel.setAttribute(&quot;value&quot;, organizerString);</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineat">@@ -202,19 +202,19 @@</span>
<a href="#l31.108"></a><span id="l31.108">       &lt;/method&gt;</span>
<a href="#l31.109"></a><span id="l31.109"> </span>
<a href="#l31.110"></a><span id="l31.110">       &lt;method name=&quot;setCalendarItemParticipationStatus&quot;&gt;</span>
<a href="#l31.111"></a><span id="l31.111">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l31.112"></a><span id="l31.112">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l31.113"></a><span id="l31.113">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l31.114"></a><span id="l31.114">           let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l31.115"></a><span id="l31.115">           if (calendar) {</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-              var att = calendar.getInvitedAttendee(aItem);</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+              let att = calendar.getInvitedAttendee(aItem);</span>
<a href="#l31.118"></a><span id="l31.118">               if (att) {</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-                  var att_ = att.clone();</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+                  let att_ = att.clone();</span>
<a href="#l31.121"></a><span id="l31.121">                   att_.participationStatus = aStatus;</span>
<a href="#l31.122"></a><span id="l31.122"> </span>
<a href="#l31.123"></a><span id="l31.123">                   // Update attendee</span>
<a href="#l31.124"></a><span id="l31.124">                   aItem.removeAttendee(att);</span>
<a href="#l31.125"></a><span id="l31.125">                   aItem.addAttendee(att_);</span>
<a href="#l31.126"></a><span id="l31.126">                   return true;</span>
<a href="#l31.127"></a><span id="l31.127">               }</span>
<a href="#l31.128"></a><span id="l31.128">           }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -76,17 +76,17 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l32.4"></a><span id="l32.4">     settings.layoutCId = document.getElementById(&quot;layout-field&quot;).value;</span>
<a href="#l32.5"></a><span id="l32.5">     settings.start = null;</span>
<a href="#l32.6"></a><span id="l32.6">     settings.end = null;</span>
<a href="#l32.7"></a><span id="l32.7">     settings.eventList = [];</span>
<a href="#l32.8"></a><span id="l32.8">     settings.printEvents = document.getElementById(&quot;events&quot;).checked;</span>
<a href="#l32.9"></a><span id="l32.9">     settings.printTasks = document.getElementById(&quot;tasks&quot;).checked;</span>
<a href="#l32.10"></a><span id="l32.10">     settings.printCompletedTasks = document.getElementById(&quot;completed-tasks&quot;).checked;</span>
<a href="#l32.11"></a><span id="l32.11">     settings.printTasksWithNoDueDate = document.getElementById(&quot;tasks-with-no-due-date&quot;).checked;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    var theView = getCalendarView();</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+    let theView = getCalendarView();</span>
<a href="#l32.14"></a><span id="l32.14">     switch (document.getElementById(&quot;view-field&quot;).selectedItem.value) {</span>
<a href="#l32.15"></a><span id="l32.15">     case 'currentView':</span>
<a href="#l32.16"></a><span id="l32.16">     case '': // just in case</span>
<a href="#l32.17"></a><span id="l32.17">         settings.start = theView.startDay.clone();</span>
<a href="#l32.18"></a><span id="l32.18">         settings.end = theView.endDay.clone();</span>
<a href="#l32.19"></a><span id="l32.19">         settings.end.day += 1;</span>
<a href="#l32.20"></a><span id="l32.20">         settings.start.isDate = false;</span>
<a href="#l32.21"></a><span id="l32.21">         settings.end.isDate = false;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -102,17 +102,17 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l32.23"></a><span id="l32.23">             }</span>
<a href="#l32.24"></a><span id="l32.24">             return true;</span>
<a href="#l32.25"></a><span id="l32.25">         });</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27">         // If tasks should be printed, also include selected tasks from the</span>
<a href="#l32.28"></a><span id="l32.28">         // opening window.</span>
<a href="#l32.29"></a><span id="l32.29">         if (settings.printTasks) {</span>
<a href="#l32.30"></a><span id="l32.30">             let selectedTasks = window.opener.getSelectedTasks();</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-            for (var task of selectedTasks) {</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+            for (let task of selectedTasks) {</span>
<a href="#l32.33"></a><span id="l32.33">                 settings.eventList.push(task);</span>
<a href="#l32.34"></a><span id="l32.34">             }</span>
<a href="#l32.35"></a><span id="l32.35">         }</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37">         // We've set the event list above, no need to fetch items below.</span>
<a href="#l32.38"></a><span id="l32.38">         requiresFetch = false;</span>
<a href="#l32.39"></a><span id="l32.39">         break;</span>
<a href="#l32.40"></a><span id="l32.40">     }</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineat">@@ -141,17 +141,17 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l32.42"></a><span id="l32.42">             function onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l32.43"></a><span id="l32.43">                 receiverFunc(settings);</span>
<a href="#l32.44"></a><span id="l32.44">             },</span>
<a href="#l32.45"></a><span id="l32.45">             onGetResult:</span>
<a href="#l32.46"></a><span id="l32.46">             function onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l32.47"></a><span id="l32.47">                 settings.eventList = settings.eventList.concat(aItems);</span>
<a href="#l32.48"></a><span id="l32.48">                 if (!settings.printTasksWithNoDueDate) {</span>
<a href="#l32.49"></a><span id="l32.49">                     eventWithDueDate = [];</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-                    for (var item of settings.eventList) {</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+                    for (let item of settings.eventList) {</span>
<a href="#l32.52"></a><span id="l32.52">                         if (item.dueDate || item.endDate) {</span>
<a href="#l32.53"></a><span id="l32.53">                             eventWithDueDate.push(item);</span>
<a href="#l32.54"></a><span id="l32.54">                         }</span>
<a href="#l32.55"></a><span id="l32.55">                     }</span>
<a href="#l32.56"></a><span id="l32.56">                     settings.eventList = eventWithDueDate;</span>
<a href="#l32.57"></a><span id="l32.57">                 }</span>
<a href="#l32.58"></a><span id="l32.58">             }</span>
<a href="#l32.59"></a><span id="l32.59">         };</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineat">@@ -262,28 +262,28 @@ var closeOnComplete = {</span>
<a href="#l32.61"></a><span id="l32.61"> };</span>
<a href="#l32.62"></a><span id="l32.62"> </span>
<a href="#l32.63"></a><span id="l32.63"> /**</span>
<a href="#l32.64"></a><span id="l32.64">  * Prints the document and then closes the window</span>
<a href="#l32.65"></a><span id="l32.65">  */</span>
<a href="#l32.66"></a><span id="l32.66"> function printAndClose() {</span>
<a href="#l32.67"></a><span id="l32.67">     refreshHtml(</span>
<a href="#l32.68"></a><span id="l32.68">         function finish() {</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-            var webBrowserPrint = PrintUtils.getWebBrowserPrint();</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-            var printSettings = PrintUtils.getPrintSettings();</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+            let webBrowserPrint = PrintUtils.getWebBrowserPrint();</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+            let printSettings = PrintUtils.getPrintSettings();</span>
<a href="#l32.73"></a><span id="l32.73"> </span>
<a href="#l32.74"></a><span id="l32.74">             // Evicts &quot;about:blank&quot; header</span>
<a href="#l32.75"></a><span id="l32.75">             printSettings.docURL = &quot; &quot;;</span>
<a href="#l32.76"></a><span id="l32.76"> </span>
<a href="#l32.77"></a><span id="l32.77">             // Start the printing, this is just what PrintUtils does, but we</span>
<a href="#l32.78"></a><span id="l32.78">             // apply our own settings.</span>
<a href="#l32.79"></a><span id="l32.79">             try {</span>
<a href="#l32.80"></a><span id="l32.80">                 webBrowserPrint.print(printSettings, closeOnComplete);</span>
<a href="#l32.81"></a><span id="l32.81">                 if (gPrintSettingsAreGlobal &amp;&amp; gSavePrintSettings) {</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-                    var PSSVC = Components.classes[&quot;@mozilla.org/gfx/printsettings-service;1&quot;]</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+                    let PSSVC = Components.classes[&quot;@mozilla.org/gfx/printsettings-service;1&quot;]</span>
<a href="#l32.84"></a><span id="l32.84">                                           .getService(Components.interfaces.nsIPrintSettingsService);</span>
<a href="#l32.85"></a><span id="l32.85">                     PSSVC.savePrintSettingsToPrefs(printSettings, true,</span>
<a href="#l32.86"></a><span id="l32.86">                                                         printSettings.kInitSaveAll);</span>
<a href="#l32.87"></a><span id="l32.87">                     PSSVC.savePrintSettingsToPrefs(printSettings, false,</span>
<a href="#l32.88"></a><span id="l32.88">                                                    printSettings.kInitSavePrinterName);</span>
<a href="#l32.89"></a><span id="l32.89">                 }</span>
<a href="#l32.90"></a><span id="l32.90">             } catch (e) {</span>
<a href="#l32.91"></a><span id="l32.91">                 // Pressing cancel is expressed as an NS_ERROR_ABORT return value,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -59,23 +59,23 @@ function onTextBoxKeyPress(event) {</span>
<a href="#l33.4"></a><span id="l33.4"> }</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> /**</span>
<a href="#l33.7"></a><span id="l33.7">  * Handler function to be called when the accept button is pressed.</span>
<a href="#l33.8"></a><span id="l33.8">  *</span>
<a href="#l33.9"></a><span id="l33.9">  * @return      Returns true if the window should be closed</span>
<a href="#l33.10"></a><span id="l33.10">  */</span>
<a href="#l33.11"></a><span id="l33.11"> function onAccept() {</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    var richListBox = document.getElementById(&quot;subscriptions-listbox&quot;);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-    var rowCount = richListBox.getRowCount();</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-    for (var i = 0; i &lt; rowCount; i++) {</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-        var richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-        var checked = richListItem.checked;</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+    let richListBox = document.getElementById(&quot;subscriptions-listbox&quot;);</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+    let rowCount = richListBox.getRowCount();</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+    for (let i = 0; i &lt; rowCount; i++) {</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+        let richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+        let checked = richListItem.checked;</span>
<a href="#l33.22"></a><span id="l33.22">         if (checked != richListItem.subscribed) {</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-            var calendar = richListItem.calendar;</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+            let calendar = richListItem.calendar;</span>
<a href="#l33.25"></a><span id="l33.25">             if (checked) {</span>
<a href="#l33.26"></a><span id="l33.26">                 getCalendarManager().registerCalendar(calendar);</span>
<a href="#l33.27"></a><span id="l33.27">             } else {</span>
<a href="#l33.28"></a><span id="l33.28">                 getCalendarManager().unregisterCalendar(calendar);</span>
<a href="#l33.29"></a><span id="l33.29">             }</span>
<a href="#l33.30"></a><span id="l33.30">         }</span>
<a href="#l33.31"></a><span id="l33.31">     }</span>
<a href="#l33.32"></a><span id="l33.32">     return true;</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineat">@@ -127,24 +127,24 @@ function onSearch() {</span>
<a href="#l33.34"></a><span id="l33.34">     }</span>
<a href="#l33.35"></a><span id="l33.35"> }</span>
<a href="#l33.36"></a><span id="l33.36"> </span>
<a href="#l33.37"></a><span id="l33.37"> /**</span>
<a href="#l33.38"></a><span id="l33.38">  * Markes the selected item in the subscriptions-listbox for subscribing. The</span>
<a href="#l33.39"></a><span id="l33.39">  * actual subscribe happens when the window is closed.</span>
<a href="#l33.40"></a><span id="l33.40">  */</span>
<a href="#l33.41"></a><span id="l33.41"> function onSubscribe() {</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-    var item = document.getElementById(&quot;subscriptions-listbox&quot;).selectedItem;</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+    let item = document.getElementById(&quot;subscriptions-listbox&quot;).selectedItem;</span>
<a href="#l33.44"></a><span id="l33.44">     if (item &amp;&amp; !item.disabled) {</span>
<a href="#l33.45"></a><span id="l33.45">         item.checked = true;</span>
<a href="#l33.46"></a><span id="l33.46">     }</span>
<a href="#l33.47"></a><span id="l33.47"> }</span>
<a href="#l33.48"></a><span id="l33.48"> </span>
<a href="#l33.49"></a><span id="l33.49"> /**</span>
<a href="#l33.50"></a><span id="l33.50">  * Unmarkes the selected item in the subscriptions-listbox for subscribing. The</span>
<a href="#l33.51"></a><span id="l33.51">  * actual subscribe happens when the window is closed.</span>
<a href="#l33.52"></a><span id="l33.52">  */</span>
<a href="#l33.53"></a><span id="l33.53"> function onUnsubscribe() {</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineminus">-    var item = document.getElementById(&quot;subscriptions-listbox&quot;).selectedItem;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+    let item = document.getElementById(&quot;subscriptions-listbox&quot;).selectedItem;</span>
<a href="#l33.56"></a><span id="l33.56">     if (item &amp;&amp; !item.disabled) {</span>
<a href="#l33.57"></a><span id="l33.57">         item.checked = false;</span>
<a href="#l33.58"></a><span id="l33.58">     }</span>
<a href="#l33.59"></a><span id="l33.59"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -7,30 +7,30 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l34.4"></a><span id="l34.4"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l34.5"></a><span id="l34.5"> Components.utils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> /**</span>
<a href="#l34.8"></a><span id="l34.8">  * Sets up the summary dialog, setting all needed fields on the dialog from the</span>
<a href="#l34.9"></a><span id="l34.9">  * item received in the window arguments.</span>
<a href="#l34.10"></a><span id="l34.10">  */</span>
<a href="#l34.11"></a><span id="l34.11"> function onLoad() {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l34.16"></a><span id="l34.16">     item = item.clone(); // use an own copy of the passed item</span>
<a href="#l34.17"></a><span id="l34.17">     window.calendarItem = item;</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19">     // the calling entity provides us with an object that is responsible</span>
<a href="#l34.20"></a><span id="l34.20">     // for recording details about the initiated modification. the 'finalize'-property</span>
<a href="#l34.21"></a><span id="l34.21">     // is our hook in order to receive a notification in case the operation needs</span>
<a href="#l34.22"></a><span id="l34.22">     // to be terminated prematurely. this function will be called if the calling</span>
<a href="#l34.23"></a><span id="l34.23">     // entity needs to immediately terminate the pending modification. in this</span>
<a href="#l34.24"></a><span id="l34.24">     // case we serialize the item and close the window.</span>
<a href="#l34.25"></a><span id="l34.25">     if (args.job) {</span>
<a href="#l34.26"></a><span id="l34.26">         // keep this context...</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-        var self = this;</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+        let self = this;</span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30">         // store the 'finalize'-functor in the provided job-object.</span>
<a href="#l34.31"></a><span id="l34.31">         args.job.finalize = function finalize() {</span>
<a href="#l34.32"></a><span id="l34.32">             // store any pending modifications...</span>
<a href="#l34.33"></a><span id="l34.33">             self.onAccept();</span>
<a href="#l34.34"></a><span id="l34.34"> </span>
<a href="#l34.35"></a><span id="l34.35">             let calendarItem = window.calendarItem;</span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37" class="difflineat">@@ -52,17 +52,17 @@ function onLoad() {</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39">     let calendar = cal.wrapInstance(item.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l34.40"></a><span id="l34.40">     window.readOnly = !(isCalendarWritable(calendar)</span>
<a href="#l34.41"></a><span id="l34.41">                         &amp;&amp; (userCanModifyItem(item)</span>
<a href="#l34.42"></a><span id="l34.42">                             || (calendar</span>
<a href="#l34.43"></a><span id="l34.43">                                 &amp;&amp; item.calendar.isInvitation(item)</span>
<a href="#l34.44"></a><span id="l34.44">                                 &amp;&amp; userCanRespondToInvitation(item))));</span>
<a href="#l34.45"></a><span id="l34.45">     if (!window.readOnly &amp;&amp; calendar) {</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-        var attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+        let attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l34.48"></a><span id="l34.48">         if (attendee) {</span>
<a href="#l34.49"></a><span id="l34.49">             // if this is an unresponded invitation, preset our default alarm values:</span>
<a href="#l34.50"></a><span id="l34.50">             if (!item.getAlarms({}).length &amp;&amp;</span>
<a href="#l34.51"></a><span id="l34.51">                 (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l34.52"></a><span id="l34.52">                 cal.alarms.setDefaultValues(item);</span>
<a href="#l34.53"></a><span id="l34.53">             }</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55">             window.attendee = attendee.clone();</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineat">@@ -85,41 +85,41 @@ function onLoad() {</span>
<a href="#l34.57"></a><span id="l34.57">     document.getElementById(&quot;item-start-row&quot;).Item = item;</span>
<a href="#l34.58"></a><span id="l34.58">     document.getElementById(&quot;item-end-row&quot;).Item = item;</span>
<a href="#l34.59"></a><span id="l34.59"> </span>
<a href="#l34.60"></a><span id="l34.60">     updateInvitationStatus();</span>
<a href="#l34.61"></a><span id="l34.61"> </span>
<a href="#l34.62"></a><span id="l34.62">     // show reminder if this item is *not* readonly.</span>
<a href="#l34.63"></a><span id="l34.63">     // this case happens for example if this is an invitation.</span>
<a href="#l34.64"></a><span id="l34.64">     let argCalendar = window.arguments[0].calendarEvent.calendar;</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-    var supportsReminders =</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+    let supportsReminders =</span>
<a href="#l34.67"></a><span id="l34.67">         (argCalendar.getProperty(&quot;capabilities.alarms.oninvitations.supported&quot;) !== false);</span>
<a href="#l34.68"></a><span id="l34.68">     if (!window.readOnly &amp;&amp; supportsReminders) {</span>
<a href="#l34.69"></a><span id="l34.69">         document.getElementById(&quot;reminder-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.70"></a><span id="l34.70">         loadReminders(window.calendarItem.getAlarms({}));</span>
<a href="#l34.71"></a><span id="l34.71">         updateReminder();</span>
<a href="#l34.72"></a><span id="l34.72">     }</span>
<a href="#l34.73"></a><span id="l34.73"> </span>
<a href="#l34.74"></a><span id="l34.74">     updateRepeatDetails();</span>
<a href="#l34.75"></a><span id="l34.75">     updateAttendees();</span>
<a href="#l34.76"></a><span id="l34.76">     updateLink();</span>
<a href="#l34.77"></a><span id="l34.77"> </span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-    var location = item.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+    let location = item.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l34.80"></a><span id="l34.80">     if (location &amp;&amp; location.length) {</span>
<a href="#l34.81"></a><span id="l34.81">         document.getElementById(&quot;location-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.82"></a><span id="l34.82">         document.getElementById(&quot;item-location&quot;).value = location;</span>
<a href="#l34.83"></a><span id="l34.83">     }</span>
<a href="#l34.84"></a><span id="l34.84"> </span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-    var categories = item.getCategories({});</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+    let categories = item.getCategories({});</span>
<a href="#l34.87"></a><span id="l34.87">     if (categories.length &gt; 0) {</span>
<a href="#l34.88"></a><span id="l34.88">         document.getElementById(&quot;category-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.89"></a><span id="l34.89">         document.getElementById(&quot;item-category&quot;).value = categories.join(&quot;, &quot;); // TODO l10n-unfriendly</span>
<a href="#l34.90"></a><span id="l34.90">     }</span>
<a href="#l34.91"></a><span id="l34.91"> </span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-    var organizer = item.organizer;</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+    let organizer = item.organizer;</span>
<a href="#l34.94"></a><span id="l34.94">     if (organizer &amp;&amp; organizer.id) {</span>
<a href="#l34.95"></a><span id="l34.95">         document.getElementById(&quot;organizer-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.96"></a><span id="l34.96">         let cell = document.getElementsByClassName(&quot;item-organizer-cell&quot;)[0];</span>
<a href="#l34.97"></a><span id="l34.97">         let text = cell.getElementsByTagName(&quot;label&quot;)[0];</span>
<a href="#l34.98"></a><span id="l34.98">         let icon = cell.getElementsByTagName(&quot;img&quot;)[0];</span>
<a href="#l34.99"></a><span id="l34.99"> </span>
<a href="#l34.100"></a><span id="l34.100">         let role = organizer.role || &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l34.101"></a><span id="l34.101">         let ut = organizer.userType || &quot;INDIVIDUAL&quot;;</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineat">@@ -137,39 +137,39 @@ function onLoad() {</span>
<a href="#l34.103"></a><span id="l34.103"> </span>
<a href="#l34.104"></a><span id="l34.104">         text.setAttribute(&quot;value&quot;, orgName);</span>
<a href="#l34.105"></a><span id="l34.105">         cell.setAttribute(&quot;tooltiptext&quot;, tt);</span>
<a href="#l34.106"></a><span id="l34.106">         icon.setAttribute(&quot;partstat&quot;, ps);</span>
<a href="#l34.107"></a><span id="l34.107">         icon.setAttribute(&quot;usertype&quot;, ut);</span>
<a href="#l34.108"></a><span id="l34.108">         icon.setAttribute(&quot;role&quot;, role);</span>
<a href="#l34.109"></a><span id="l34.109">     }</span>
<a href="#l34.110"></a><span id="l34.110"> </span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-    var status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+    let status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l34.113"></a><span id="l34.113">     if (status &amp;&amp; status.length) {</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-        var statusRow = document.getElementById(&quot;status-row&quot;);</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-        for (var i = 0; i &lt; statusRow.childNodes.length; i++) {</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+        let statusRow = document.getElementById(&quot;status-row&quot;);</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+        for (let i = 0; i &lt; statusRow.childNodes.length; i++) {</span>
<a href="#l34.118"></a><span id="l34.118">             if (statusRow.childNodes[i].getAttribute(&quot;status&quot;) == status) {</span>
<a href="#l34.119"></a><span id="l34.119">                 statusRow.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.120"></a><span id="l34.120">                 if (status == &quot;CANCELLED&quot; &amp;&amp; cal.isToDo(item)) {</span>
<a href="#l34.121"></a><span id="l34.121">                     // There are two labels for CANCELLED, the second one is for</span>
<a href="#l34.122"></a><span id="l34.122">                     // todo items. Increment the counter here.</span>
<a href="#l34.123"></a><span id="l34.123">                     i++;</span>
<a href="#l34.124"></a><span id="l34.124">                 }</span>
<a href="#l34.125"></a><span id="l34.125">                 statusRow.childNodes[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.126"></a><span id="l34.126">                 break;</span>
<a href="#l34.127"></a><span id="l34.127">             }</span>
<a href="#l34.128"></a><span id="l34.128">         }</span>
<a href="#l34.129"></a><span id="l34.129">     }</span>
<a href="#l34.130"></a><span id="l34.130"> </span>
<a href="#l34.131"></a><span id="l34.131">     if (item.hasProperty(&quot;DESCRIPTION&quot;)) {</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-        var description = item.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineplus">+        let description = item.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l34.134"></a><span id="l34.134">         if (description &amp;&amp; description.length) {</span>
<a href="#l34.135"></a><span id="l34.135">             document.getElementById(&quot;item-description-box&quot;)</span>
<a href="#l34.136"></a><span id="l34.136">                 .removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-            var textbox = document.getElementById(&quot;item-description&quot;);</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineplus">+            let textbox = document.getElementById(&quot;item-description&quot;);</span>
<a href="#l34.139"></a><span id="l34.139">             textbox.value = description;</span>
<a href="#l34.140"></a><span id="l34.140">             textbox.inputField.readOnly = true;</span>
<a href="#l34.141"></a><span id="l34.141">         }</span>
<a href="#l34.142"></a><span id="l34.142">     }</span>
<a href="#l34.143"></a><span id="l34.143"> </span>
<a href="#l34.144"></a><span id="l34.144">     document.title = item.title;</span>
<a href="#l34.145"></a><span id="l34.145"> </span>
<a href="#l34.146"></a><span id="l34.146">     // If this item is read only we remove the 'cancel' button as users</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineat">@@ -187,20 +187,20 @@ function onLoad() {</span>
<a href="#l34.148"></a><span id="l34.148">  *</span>
<a href="#l34.149"></a><span id="l34.149">  * @return      Returns true if the dialog</span>
<a href="#l34.150"></a><span id="l34.150">  */</span>
<a href="#l34.151"></a><span id="l34.151"> function onAccept() {</span>
<a href="#l34.152"></a><span id="l34.152">     dispose();</span>
<a href="#l34.153"></a><span id="l34.153">     if (window.readOnly) {</span>
<a href="#l34.154"></a><span id="l34.154">         return true;</span>
<a href="#l34.155"></a><span id="l34.155">     }</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-    var oldItem = args.calendarEvent;</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineminus">-    var newItem = window.calendarItem;</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-    var calendar = newItem.calendar;</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineplus">+    let oldItem = args.calendarEvent;</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineplus">+    let newItem = window.calendarItem;</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineplus">+    let calendar = newItem.calendar;</span>
<a href="#l34.164"></a><span id="l34.164">     saveReminder(newItem);</span>
<a href="#l34.165"></a><span id="l34.165">     args.onOk(newItem, calendar, oldItem);</span>
<a href="#l34.166"></a><span id="l34.166">     window.calendarItem = newItem;</span>
<a href="#l34.167"></a><span id="l34.167">     return true;</span>
<a href="#l34.168"></a><span id="l34.168"> }</span>
<a href="#l34.169"></a><span id="l34.169"> </span>
<a href="#l34.170"></a><span id="l34.170"> /**</span>
<a href="#l34.171"></a><span id="l34.171">  * Called when closing the dialog and any changes should be thrown away.</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineat">@@ -212,32 +212,32 @@ function onCancel() {</span>
<a href="#l34.173"></a><span id="l34.173"> </span>
<a href="#l34.174"></a><span id="l34.174"> /**</span>
<a href="#l34.175"></a><span id="l34.175">  * Sets the dialog's invitation status dropdown to the value specified by the</span>
<a href="#l34.176"></a><span id="l34.176">  * user's invitation status.</span>
<a href="#l34.177"></a><span id="l34.177">  */</span>
<a href="#l34.178"></a><span id="l34.178"> function updateInvitationStatus() {</span>
<a href="#l34.179"></a><span id="l34.179">     if (!window.readOnly) {</span>
<a href="#l34.180"></a><span id="l34.180">         if (window.attendee) {</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-            var invitationRow =</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineplus">+            let invitationRow =</span>
<a href="#l34.183"></a><span id="l34.183">                 document.getElementById(&quot;invitation-row&quot;);</span>
<a href="#l34.184"></a><span id="l34.184">             invitationRow.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-            var statusElement =</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineplus">+            let statusElement =</span>
<a href="#l34.187"></a><span id="l34.187">                 document.getElementById(&quot;item-participation&quot;);</span>
<a href="#l34.188"></a><span id="l34.188">             statusElement.value = window.attendee.participationStatus;</span>
<a href="#l34.189"></a><span id="l34.189">         }</span>
<a href="#l34.190"></a><span id="l34.190">     }</span>
<a href="#l34.191"></a><span id="l34.191"> }</span>
<a href="#l34.192"></a><span id="l34.192"> </span>
<a href="#l34.193"></a><span id="l34.193"> /**</span>
<a href="#l34.194"></a><span id="l34.194">  * When the summary dialog is showing an invitation, this function updates the</span>
<a href="#l34.195"></a><span id="l34.195">  * user's invitation status from the value chosen in the dialog.</span>
<a href="#l34.196"></a><span id="l34.196">  */</span>
<a href="#l34.197"></a><span id="l34.197"> function updatePartStat() {</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-  var statusElement = document.getElementById(&quot;item-participation&quot;);</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineplus">+  let statusElement = document.getElementById(&quot;item-participation&quot;);</span>
<a href="#l34.200"></a><span id="l34.200">   if (window.attendee) {</span>
<a href="#l34.201"></a><span id="l34.201">       let item = window.arguments[0];</span>
<a href="#l34.202"></a><span id="l34.202">       let aclEntry = item.calendar.aclEntry;</span>
<a href="#l34.203"></a><span id="l34.203">       if (aclEntry) {</span>
<a href="#l34.204"></a><span id="l34.204">           let userAddresses = aclEntry.getUserAddresses({});</span>
<a href="#l34.205"></a><span id="l34.205">           if (userAddresses.length &gt; 0</span>
<a href="#l34.206"></a><span id="l34.206">               &amp;&amp; !cal.attendeeMatchesAddresses(window.attendee, userAddresses)) {</span>
<a href="#l34.207"></a><span id="l34.207">               window.attendee.setProperty(&quot;SENT-BY&quot;, &quot;mailto:&quot; + userAddresses[0]);</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineat">@@ -248,63 +248,63 @@ function updatePartStat() {</span>
<a href="#l34.209"></a><span id="l34.209">   }</span>
<a href="#l34.210"></a><span id="l34.210"> }</span>
<a href="#l34.211"></a><span id="l34.211"> </span>
<a href="#l34.212"></a><span id="l34.212"> /**</span>
<a href="#l34.213"></a><span id="l34.213">  * Updates the dialog w.r.t recurrence, i.e shows a text describing the item's</span>
<a href="#l34.214"></a><span id="l34.214">  * recurrence)</span>
<a href="#l34.215"></a><span id="l34.215">  */</span>
<a href="#l34.216"></a><span id="l34.216"> function updateRepeatDetails() {</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l34.221"></a><span id="l34.221"> </span>
<a href="#l34.222"></a><span id="l34.222">     // step to the parent (in order to show the</span>
<a href="#l34.223"></a><span id="l34.223">     // recurrence info which is stored at the parent).</span>
<a href="#l34.224"></a><span id="l34.224">     item = item.parentItem;</span>
<a href="#l34.225"></a><span id="l34.225"> </span>
<a href="#l34.226"></a><span id="l34.226">     // retrieve a valid recurrence rule from the currently</span>
<a href="#l34.227"></a><span id="l34.227">     // set recurrence info. bail out if there's more</span>
<a href="#l34.228"></a><span id="l34.228">     // than a single rule or something other than a rule.</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineminus">-    var recurrenceInfo = item.recurrenceInfo;</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+    let recurrenceInfo = item.recurrenceInfo;</span>
<a href="#l34.231"></a><span id="l34.231">     if (!recurrenceInfo) {</span>
<a href="#l34.232"></a><span id="l34.232">         return;</span>
<a href="#l34.233"></a><span id="l34.233">     }</span>
<a href="#l34.234"></a><span id="l34.234"> </span>
<a href="#l34.235"></a><span id="l34.235">     document.getElementById(&quot;repeat-row&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l34.236"></a><span id="l34.236"> </span>
<a href="#l34.237"></a><span id="l34.237">     // First of all collapse the details text. If we fail to</span>
<a href="#l34.238"></a><span id="l34.238">     // create a details string, we simply don't show anything.</span>
<a href="#l34.239"></a><span id="l34.239">     // this could happen if the repeat rule is something exotic</span>
<a href="#l34.240"></a><span id="l34.240">     // we don't have any strings prepared for.</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-    var repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineplus">+    let repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l34.243"></a><span id="l34.243">     repeatDetails.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l34.244"></a><span id="l34.244"> </span>
<a href="#l34.245"></a><span id="l34.245">     // Try to create a descriptive string from the rule(s).</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineminus">-    var startDate = item.startDate || item.entryDate;</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineminus">-    var endDate = item.endDate || item.dueDate;</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineplus">+    let startDate = item.startDate || item.entryDate;</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineplus">+    let endDate = item.endDate || item.dueDate;</span>
<a href="#l34.252"></a><span id="l34.252">     startDate = startDate ? startDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l34.253"></a><span id="l34.253">     endDate = endDate ? endDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineminus">-    var detailsString = recurrenceRule2String(recurrenceInfo, startDate,</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineplus">+    let detailsString = recurrenceRule2String(recurrenceInfo, startDate,</span>
<a href="#l34.256"></a><span id="l34.256">                                               endDate, startDate.isDate);</span>
<a href="#l34.257"></a><span id="l34.257"> </span>
<a href="#l34.258"></a><span id="l34.258">     if (!detailsString) {</span>
<a href="#l34.259"></a><span id="l34.259">         detailsString = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;ruleTooComplexSummary&quot;);</span>
<a href="#l34.260"></a><span id="l34.260">     }</span>
<a href="#l34.261"></a><span id="l34.261"> </span>
<a href="#l34.262"></a><span id="l34.262">     // Now display the string...</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-    var lines = detailsString.split(&quot;\n&quot;);</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineplus">+    let lines = detailsString.split(&quot;\n&quot;);</span>
<a href="#l34.265"></a><span id="l34.265">     repeatDetails.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l34.266"></a><span id="l34.266">     while (repeatDetails.childNodes.length &gt; lines.length) {</span>
<a href="#l34.267"></a><span id="l34.267">         repeatDetails.lastChild.remove();</span>
<a href="#l34.268"></a><span id="l34.268">     }</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineminus">-    var numChilds = repeatDetails.childNodes.length;</span>
<a href="#l34.270"></a><span id="l34.270" class="difflineminus">-    for (var i = 0; i &lt; lines.length; i++) {</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineplus">+    let numChilds = repeatDetails.childNodes.length;</span>
<a href="#l34.272"></a><span id="l34.272" class="difflineplus">+    for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l34.273"></a><span id="l34.273">         if (i &gt;= numChilds) {</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-            var newNode = repeatDetails.firstChild</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineplus">+            let newNode = repeatDetails.firstChild</span>
<a href="#l34.276"></a><span id="l34.276">                                        .cloneNode(true);</span>
<a href="#l34.277"></a><span id="l34.277">             repeatDetails.appendChild(newNode);</span>
<a href="#l34.278"></a><span id="l34.278">         }</span>
<a href="#l34.279"></a><span id="l34.279">         repeatDetails.childNodes[i].value = lines[i];</span>
<a href="#l34.280"></a><span id="l34.280">         repeatDetails.childNodes[i].setAttribute(&quot;tooltiptext&quot;, detailsString);</span>
<a href="#l34.281"></a><span id="l34.281">     }</span>
<a href="#l34.282"></a><span id="l34.282"> }</span>
<a href="#l34.283"></a><span id="l34.283"> </span>
<a href="#l34.284"></a><span id="l34.284" class="difflineat">@@ -328,19 +328,19 @@ function updateReminder() {</span>
<a href="#l34.285"></a><span id="l34.285"> }</span>
<a href="#l34.286"></a><span id="l34.286"> </span>
<a href="#l34.287"></a><span id="l34.287"> /**</span>
<a href="#l34.288"></a><span id="l34.288">  * Browse the item's attached URL.</span>
<a href="#l34.289"></a><span id="l34.289">  *</span>
<a href="#l34.290"></a><span id="l34.290">  * XXX This function is broken, should be fixed in bug 471967</span>
<a href="#l34.291"></a><span id="l34.291">  */</span>
<a href="#l34.292"></a><span id="l34.292"> function browseDocument() {</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-    var item = args.calendarEvent;</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineminus">-    var url = item.getProperty(&quot;URL&quot;);</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineplus">+    let item = args.calendarEvent;</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineplus">+    let url = item.getProperty(&quot;URL&quot;);</span>
<a href="#l34.299"></a><span id="l34.299">     launchBrowser(url);</span>
<a href="#l34.300"></a><span id="l34.300"> }</span>
<a href="#l34.301"></a><span id="l34.301"> </span>
<a href="#l34.302"></a><span id="l34.302"> /**</span>
<a href="#l34.303"></a><span id="l34.303">  * Extracts the item's organizer and opens a compose window to send the</span>
<a href="#l34.304"></a><span id="l34.304">  * organizer an email.</span>
<a href="#l34.305"></a><span id="l34.305">  */</span>
<a href="#l34.306"></a><span id="l34.306"> function sendMailToOrganizer() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -138,26 +138,26 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l35.4"></a><span id="l35.4"> </span>
<a href="#l35.5"></a><span id="l35.5">     // And set batch mode on the calendar, to tell the views to not</span>
<a href="#l35.6"></a><span id="l35.6">     // redraw until all items are imported</span>
<a href="#l35.7"></a><span id="l35.7">     destCal.startBatch();</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9">     // This listener is needed to find out when the last addItem really</span>
<a href="#l35.10"></a><span id="l35.10">     // finished. Using a counter to find the last item (which might not</span>
<a href="#l35.11"></a><span id="l35.11">     // be the last item added)</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    var count = 0;</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-    var failedCount = 0;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-    var duplicateCount = 0;</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+    let count = 0;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+    let failedCount = 0;</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+    let duplicateCount = 0;</span>
<a href="#l35.18"></a><span id="l35.18">     // Used to store the last error. Only the last error, because we don't</span>
<a href="#l35.19"></a><span id="l35.19">     // wan't to bomb the user with thousands of error messages in case</span>
<a href="#l35.20"></a><span id="l35.20">     // something went really wrong.</span>
<a href="#l35.21"></a><span id="l35.21">     // (example of something very wrong: importing the same file twice.</span>
<a href="#l35.22"></a><span id="l35.22">     //  quite easy to trigger, so we really should do this)</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-    var lastError;</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-    var listener = {</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+    let lastError;</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+    let listener = {</span>
<a href="#l35.27"></a><span id="l35.27">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l35.28"></a><span id="l35.28">         onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l35.29"></a><span id="l35.29">             count++;</span>
<a href="#l35.30"></a><span id="l35.30">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l35.31"></a><span id="l35.31">                 if (aStatus == Components.interfaces.calIErrors.DUPLICATE_ID) {</span>
<a href="#l35.32"></a><span id="l35.32">                     duplicateCount++;</span>
<a href="#l35.33"></a><span id="l35.33">                 } else {</span>
<a href="#l35.34"></a><span id="l35.34">                     failedCount++;</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineat">@@ -313,45 +313,45 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l35.36"></a><span id="l35.36"> </span>
<a href="#l35.37"></a><span id="l35.37"> /**</span>
<a href="#l35.38"></a><span id="l35.38">  * Exports all the events and tasks in a calendar.  If aCalendar is not specified,</span>
<a href="#l35.39"></a><span id="l35.39">  * the user will be prompted with a list of calendars to choose which one to export.</span>
<a href="#l35.40"></a><span id="l35.40">  *</span>
<a href="#l35.41"></a><span id="l35.41">  * @param aCalendar     (optional) A specific calendar to export</span>
<a href="#l35.42"></a><span id="l35.42">  */</span>
<a href="#l35.43"></a><span id="l35.43"> function exportEntireCalendar(aCalendar) {</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-    var itemArray = [];</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-    var getListener = {</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+    let itemArray = [];</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+    let getListener = {</span>
<a href="#l35.48"></a><span id="l35.48">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l35.49"></a><span id="l35.49">         onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l35.50"></a><span id="l35.50">             saveEventsToFile(itemArray, aOpCalendar.name);</span>
<a href="#l35.51"></a><span id="l35.51">         },</span>
<a href="#l35.52"></a><span id="l35.52">         onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l35.53"></a><span id="l35.53">             for (let item of aItems) {</span>
<a href="#l35.54"></a><span id="l35.54">                 itemArray.push(item);</span>
<a href="#l35.55"></a><span id="l35.55">             }</span>
<a href="#l35.56"></a><span id="l35.56">         }</span>
<a href="#l35.57"></a><span id="l35.57">     };</span>
<a href="#l35.58"></a><span id="l35.58"> </span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-    function getItemsFromCal(aCal) {</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+    let getItemsFromCal = function(aCal) {</span>
<a href="#l35.61"></a><span id="l35.61">         aCal.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l35.62"></a><span id="l35.62">                       0, null, null, getListener);</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-    }</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+    };</span>
<a href="#l35.65"></a><span id="l35.65"> </span>
<a href="#l35.66"></a><span id="l35.66">     if (!aCalendar) {</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineminus">-        var count = {};</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineminus">-        var calendars = getCalendarManager().getCalendars(count);</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+        let count = {};</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+        let calendars = getCalendarManager().getCalendars(count);</span>
<a href="#l35.71"></a><span id="l35.71"> </span>
<a href="#l35.72"></a><span id="l35.72">         if (count.value == 1) {</span>
<a href="#l35.73"></a><span id="l35.73">             // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l35.74"></a><span id="l35.74">             // the user wants to import into.</span>
<a href="#l35.75"></a><span id="l35.75">             getItemsFromCal(calendars[0]);</span>
<a href="#l35.76"></a><span id="l35.76">         } else {</span>
<a href="#l35.77"></a><span id="l35.77">             // Ask what calendar to import into</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineminus">-            var args = {};</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+            let args = {};</span>
<a href="#l35.80"></a><span id="l35.80">             args.onOk = getItemsFromCal;</span>
<a href="#l35.81"></a><span id="l35.81">             args.promptText = calGetString(&quot;calendar&quot;, &quot;exportPrompt&quot;);</span>
<a href="#l35.82"></a><span id="l35.82">             openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l35.83"></a><span id="l35.83">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l35.84"></a><span id="l35.84">         }</span>
<a href="#l35.85"></a><span id="l35.85">     } else {</span>
<a href="#l35.86"></a><span id="l35.86">         getItemsFromCal(aCalendar);</span>
<a href="#l35.87"></a><span id="l35.87">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/content/preferences/alarms.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/content/preferences/alarms.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -28,85 +28,85 @@ var gAlarmsPane = {</span>
<a href="#l36.4"></a><span id="l36.4">      * Converts the given file url to a nsILocalFile</span>
<a href="#l36.5"></a><span id="l36.5">      *</span>
<a href="#l36.6"></a><span id="l36.6">      * @param aFileURL    A string with a file:// url.</span>
<a href="#l36.7"></a><span id="l36.7">      * @return            The corresponding nsILocalFile.</span>
<a href="#l36.8"></a><span id="l36.8">      */</span>
<a href="#l36.9"></a><span id="l36.9">     convertURLToLocalFile: function gAP_convertURLToLocalFile(aFileURL) {</span>
<a href="#l36.10"></a><span id="l36.10">         // Convert the file url into a nsILocalFile</span>
<a href="#l36.11"></a><span id="l36.11">         if (aFileURL) {</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-            var fph = Services.io</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+            let fph = Services.io</span>
<a href="#l36.14"></a><span id="l36.14">                          .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l36.15"></a><span id="l36.15">                          .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l36.16"></a><span id="l36.16">             return fph.getFileFromURLSpec(aFileURL);</span>
<a href="#l36.17"></a><span id="l36.17">         } else {</span>
<a href="#l36.18"></a><span id="l36.18">             return null;</span>
<a href="#l36.19"></a><span id="l36.19">         }</span>
<a href="#l36.20"></a><span id="l36.20">     },</span>
<a href="#l36.21"></a><span id="l36.21"> </span>
<a href="#l36.22"></a><span id="l36.22">     /**</span>
<a href="#l36.23"></a><span id="l36.23">      * Handler function to be called when the calendar.alarms.soundURL pref has</span>
<a href="#l36.24"></a><span id="l36.24">      * changed. Updates the label in the dialog.</span>
<a href="#l36.25"></a><span id="l36.25">      */</span>
<a href="#l36.26"></a><span id="l36.26">     readSoundLocation: function gAP_readSoundLocation() {</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineminus">-        var soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;);</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+        let soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;);</span>
<a href="#l36.29"></a><span id="l36.29">         soundUrl.value = document.getElementById(&quot;calendar.alarms.soundURL&quot;).value;</span>
<a href="#l36.30"></a><span id="l36.30">         if (soundUrl.value.startsWith(&quot;file://&quot;)) {</span>
<a href="#l36.31"></a><span id="l36.31">             soundUrl.label = this.convertURLToLocalFile(soundUrl.value).leafName;</span>
<a href="#l36.32"></a><span id="l36.32">         } else {</span>
<a href="#l36.33"></a><span id="l36.33">             soundUrl.label = soundUrl.value;</span>
<a href="#l36.34"></a><span id="l36.34">         }</span>
<a href="#l36.35"></a><span id="l36.35">         soundUrl.image = &quot;moz-icon://&quot; + soundUrl.label + &quot;?size=16&quot;;</span>
<a href="#l36.36"></a><span id="l36.36">         return undefined;</span>
<a href="#l36.37"></a><span id="l36.37">     },</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39">     /**</span>
<a href="#l36.40"></a><span id="l36.40">      * Causes the default sound to be selected in the dialog controls</span>
<a href="#l36.41"></a><span id="l36.41">      */</span>
<a href="#l36.42"></a><span id="l36.42">     useDefaultSound: function gAP_useDefaultSound() {</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-        var defaultSoundUrl = &quot;chrome://calendar/content/sound.wav&quot;;</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+        let defaultSoundUrl = &quot;chrome://calendar/content/sound.wav&quot;;</span>
<a href="#l36.45"></a><span id="l36.45">         document.getElementById(&quot;calendar.alarms.soundURL&quot;).value = defaultSoundUrl;</span>
<a href="#l36.46"></a><span id="l36.46">         document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l36.47"></a><span id="l36.47">         this.readSoundLocation();</span>
<a href="#l36.48"></a><span id="l36.48">     },</span>
<a href="#l36.49"></a><span id="l36.49"> </span>
<a href="#l36.50"></a><span id="l36.50">     /**</span>
<a href="#l36.51"></a><span id="l36.51">      * Opens a filepicker to open a local sound for the alarm.</span>
<a href="#l36.52"></a><span id="l36.52">      */</span>
<a href="#l36.53"></a><span id="l36.53">     browseAlarm: function gAP_browseAlarm() {</span>
<a href="#l36.54"></a><span id="l36.54">         const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-        var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+        let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l36.57"></a><span id="l36.57">                     .createInstance(nsIFilePicker);</span>
<a href="#l36.58"></a><span id="l36.58"> </span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-        var bundlePreferences = document.getElementById(&quot;bundleCalendarPreferences&quot;);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-        var title = bundlePreferences.getString(&quot;Open&quot;);</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-        var wildmat = &quot;*.wav&quot;;</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-        var label = bundlePreferences.getFormattedString(&quot;filterWav&quot;, [wildmat], 1);</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+        let bundlePreferences = document.getElementById(&quot;bundleCalendarPreferences&quot;);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+        let title = bundlePreferences.getString(&quot;Open&quot;);</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+        let wildmat = &quot;*.wav&quot;;</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+        let label = bundlePreferences.getFormattedString(&quot;filterWav&quot;, [wildmat], 1);</span>
<a href="#l36.67"></a><span id="l36.67"> </span>
<a href="#l36.68"></a><span id="l36.68">         fp.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l36.69"></a><span id="l36.69">         fp.appendFilter(label, wildmat);</span>
<a href="#l36.70"></a><span id="l36.70">         fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l36.71"></a><span id="l36.71"> </span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-        var ret = fp.show();</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+        let ret = fp.show();</span>
<a href="#l36.74"></a><span id="l36.74"> </span>
<a href="#l36.75"></a><span id="l36.75">         if (ret == nsIFilePicker.returnOK) {</span>
<a href="#l36.76"></a><span id="l36.76">             document.getElementById(&quot;calendar.alarms.soundURL&quot;).value = fp.fileURL.spec;</span>
<a href="#l36.77"></a><span id="l36.77">             document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l36.78"></a><span id="l36.78">             this.readSoundLocation();</span>
<a href="#l36.79"></a><span id="l36.79">         }</span>
<a href="#l36.80"></a><span id="l36.80">     },</span>
<a href="#l36.81"></a><span id="l36.81"> </span>
<a href="#l36.82"></a><span id="l36.82">     /**</span>
<a href="#l36.83"></a><span id="l36.83">      * Plays the alarm sound currently selected.</span>
<a href="#l36.84"></a><span id="l36.84">      */</span>
<a href="#l36.85"></a><span id="l36.85">     previewAlarm: function gAP_previewAlarm() {</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-        var soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;).value;</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-        var soundIfc = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+        let soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;).value;</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+        let soundIfc = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l36.90"></a><span id="l36.90">                             .createInstance(Components.interfaces.nsISound);</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineminus">-        var url;</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+        let url;</span>
<a href="#l36.93"></a><span id="l36.93">         try {</span>
<a href="#l36.94"></a><span id="l36.94">             soundIfc.init();</span>
<a href="#l36.95"></a><span id="l36.95">             if (soundUrl &amp;&amp; soundUrl.length &amp;&amp; soundUrl.length &gt; 0) {</span>
<a href="#l36.96"></a><span id="l36.96">                 url = Services.io.newURI(soundUrl, null, null);</span>
<a href="#l36.97"></a><span id="l36.97">                 soundIfc.play(url);</span>
<a href="#l36.98"></a><span id="l36.98">             } else {</span>
<a href="#l36.99"></a><span id="l36.99">                 soundIfc.beep();</span>
<a href="#l36.100"></a><span id="l36.100">             }</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineat">@@ -116,21 +116,21 @@ var gAlarmsPane = {</span>
<a href="#l36.102"></a><span id="l36.102">     },</span>
<a href="#l36.103"></a><span id="l36.103"> </span>
<a href="#l36.104"></a><span id="l36.104">     /**</span>
<a href="#l36.105"></a><span id="l36.105">      * Handler function to call when the calendar.alarms.playsound preference</span>
<a href="#l36.106"></a><span id="l36.106">      * has been changed. Updates the disabled state of fields that depend on</span>
<a href="#l36.107"></a><span id="l36.107">      * playing a sound.</span>
<a href="#l36.108"></a><span id="l36.108">      */</span>
<a href="#l36.109"></a><span id="l36.109">     alarmsPlaySoundPrefChanged: function gAP_alarmsPlaySoundPrefChanged() {</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineminus">-        var alarmsPlaySoundPref =</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+        let alarmsPlaySoundPref =</span>
<a href="#l36.112"></a><span id="l36.112">             document.getElementById(&quot;calendar.alarms.playsound&quot;);</span>
<a href="#l36.113"></a><span id="l36.113"> </span>
<a href="#l36.114"></a><span id="l36.114" class="difflineminus">-        var items = [document.getElementById(&quot;alarmSoundFileField&quot;),</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+        let items = [document.getElementById(&quot;alarmSoundFileField&quot;),</span>
<a href="#l36.116"></a><span id="l36.116">                      document.getElementById(&quot;calendar.prefs.alarm.sound.useDefault&quot;),</span>
<a href="#l36.117"></a><span id="l36.117">                      document.getElementById(&quot;calendar.prefs.alarm.sound.browse&quot;),</span>
<a href="#l36.118"></a><span id="l36.118">                      document.getElementById(&quot;calendar.prefs.alarm.sound.play&quot;)];</span>
<a href="#l36.119"></a><span id="l36.119"> </span>
<a href="#l36.120"></a><span id="l36.120" class="difflineminus">-        for (var i = 0; i &lt; items.length; i++) {</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+        for (let i = 0; i &lt; items.length; i++) {</span>
<a href="#l36.122"></a><span id="l36.122">             items[i].disabled = !alarmsPlaySoundPref.value;</span>
<a href="#l36.123"></a><span id="l36.123">         }</span>
<a href="#l36.124"></a><span id="l36.124">     }</span>
<a href="#l36.125"></a><span id="l36.125"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/content/preferences/categories.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/content/preferences/categories.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -18,19 +18,19 @@ var gCategoriesPane = {</span>
<a href="#l37.4"></a><span id="l37.4">     /**</span>
<a href="#l37.5"></a><span id="l37.5">      * Initialize the categories pref pane. Sets up dialog controls to show the</span>
<a href="#l37.6"></a><span id="l37.6">      * categories saved in preferences.</span>
<a href="#l37.7"></a><span id="l37.7">      */</span>
<a href="#l37.8"></a><span id="l37.8">     init: function gCP_init() {</span>
<a href="#l37.9"></a><span id="l37.9">         // On non-instant-apply platforms, once this pane has been loaded,</span>
<a href="#l37.10"></a><span id="l37.10">         // attach our &quot;revert all changes&quot; function to the parent prefwindow's</span>
<a href="#l37.11"></a><span id="l37.11">         // &quot;ondialogcancel&quot; event.</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-        var parentPrefWindow = document.documentElement;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+        let parentPrefWindow = document.documentElement;</span>
<a href="#l37.14"></a><span id="l37.14">         if (!parentPrefWindow.instantApply) {</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-            var existingOnDialogCancel = parentPrefWindow.getAttribute(&quot;ondialogcancel&quot;);</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+            let existingOnDialogCancel = parentPrefWindow.getAttribute(&quot;ondialogcancel&quot;);</span>
<a href="#l37.17"></a><span id="l37.17">             parentPrefWindow.setAttribute(&quot;ondialogcancel&quot;,</span>
<a href="#l37.18"></a><span id="l37.18">                                           &quot;gCategoriesPane.panelOnCancel(); &quot; +</span>
<a href="#l37.19"></a><span id="l37.19">                                           existingOnDialogCancel);</span>
<a href="#l37.20"></a><span id="l37.20">         }</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22">         // A list of preferences to be reverted when the dialog is cancelled.</span>
<a href="#l37.23"></a><span id="l37.23">         // It needs to be a property of the parent to be visible onCancel</span>
<a href="#l37.24"></a><span id="l37.24">         if (!(&quot;backupPrefList&quot; in parent)) {</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineat">@@ -75,25 +75,25 @@ var gCategoriesPane = {</span>
<a href="#l37.26"></a><span id="l37.26">         listbox.clearSelection();</span>
<a href="#l37.27"></a><span id="l37.27">         this.updateButtons();</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29"> </span>
<a href="#l37.30"></a><span id="l37.30">         while (listbox.lastChild.id != &quot;categoryColumns&quot;) {</span>
<a href="#l37.31"></a><span id="l37.31">             listbox.lastChild.remove();</span>
<a href="#l37.32"></a><span id="l37.32">         }</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-        for (var i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-            var newListItem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-            var categoryName = document.createElement(&quot;listcell&quot;);</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+        for (let i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+            let newListItem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+            let categoryName = document.createElement(&quot;listcell&quot;);</span>
<a href="#l37.40"></a><span id="l37.40">             categoryName.setAttribute(&quot;id&quot;, gCategoryList[i]);</span>
<a href="#l37.41"></a><span id="l37.41">             categoryName.setAttribute(&quot;label&quot;, gCategoryList[i]);</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-            var categoryNameFix = formatStringForCSSRule(gCategoryList[i]);</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-            var categoryColor = document.createElement(&quot;listcell&quot;);</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+            let categoryNameFix = formatStringForCSSRule(gCategoryList[i]);</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+            let categoryColor = document.createElement(&quot;listcell&quot;);</span>
<a href="#l37.46"></a><span id="l37.46">             try {</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-                var colorCode = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+                let colorCode = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l37.49"></a><span id="l37.49">                 categoryColor.setAttribute(&quot;id&quot;, colorCode);</span>
<a href="#l37.50"></a><span id="l37.50">                 categoryColor.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + colorCode + &quot;;&quot;);</span>
<a href="#l37.51"></a><span id="l37.51">             } catch (ex) {</span>
<a href="#l37.52"></a><span id="l37.52">                 categoryColor.setAttribute(&quot;label&quot;, noneLabel);</span>
<a href="#l37.53"></a><span id="l37.53">             }</span>
<a href="#l37.54"></a><span id="l37.54"> </span>
<a href="#l37.55"></a><span id="l37.55">             newListItem.appendChild(categoryName);</span>
<a href="#l37.56"></a><span id="l37.56">             newListItem.appendChild(categoryColor);</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineat">@@ -183,20 +183,20 @@ var gCategoriesPane = {</span>
<a href="#l37.58"></a><span id="l37.58"> </span>
<a href="#l37.59"></a><span id="l37.59">     /**</span>
<a href="#l37.60"></a><span id="l37.60">      * Saves the given category to the preferences.</span>
<a href="#l37.61"></a><span id="l37.61">      *</span>
<a href="#l37.62"></a><span id="l37.62">      * @param categoryName      The name of the category.</span>
<a href="#l37.63"></a><span id="l37.63">      * @param categoryColor     The color of the category</span>
<a href="#l37.64"></a><span id="l37.64">      */</span>
<a href="#l37.65"></a><span id="l37.65">     saveCategory: function gCP_saveCateogry(categoryName, categoryColor) {</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-        var list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+        let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l37.68"></a><span id="l37.68">         // Check to make sure another category doesn't have the same name</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-        var toBeDeleted = -1;</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">-        for (var i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+        let toBeDeleted = -1;</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+        for (let i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l37.73"></a><span id="l37.73">             if (i == list.selectedIndex) {</span>
<a href="#l37.74"></a><span id="l37.74">                 continue;</span>
<a href="#l37.75"></a><span id="l37.75">             }</span>
<a href="#l37.76"></a><span id="l37.76"> </span>
<a href="#l37.77"></a><span id="l37.77">             if (categoryName.toLowerCase() == gCategoryList[i].toLowerCase()) {</span>
<a href="#l37.78"></a><span id="l37.78">                 if (Services.prompt.confirm(null, overwriteTitle, overwrite)) {</span>
<a href="#l37.79"></a><span id="l37.79">                     if (list.selectedIndex != -1) {</span>
<a href="#l37.80"></a><span id="l37.80">                         // Don't delete the old category yet. It will mess up indices.</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineat">@@ -209,17 +209,17 @@ var gCategoriesPane = {</span>
<a href="#l37.82"></a><span id="l37.82">             }</span>
<a href="#l37.83"></a><span id="l37.83">         }</span>
<a href="#l37.84"></a><span id="l37.84"> </span>
<a href="#l37.85"></a><span id="l37.85">         if (categoryName.length == 0) {</span>
<a href="#l37.86"></a><span id="l37.86">             Services.prompt.alert(null, null, noBlankCategories);</span>
<a href="#l37.87"></a><span id="l37.87">             return;</span>
<a href="#l37.88"></a><span id="l37.88">         }</span>
<a href="#l37.89"></a><span id="l37.89"> </span>
<a href="#l37.90"></a><span id="l37.90" class="difflineminus">-        var categoryNameFix = formatStringForCSSRule(categoryName);</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+        let categoryNameFix = formatStringForCSSRule(categoryName);</span>
<a href="#l37.92"></a><span id="l37.92">         if (list.selectedIndex == -1) {</span>
<a href="#l37.93"></a><span id="l37.93">             this.backupData(categoryNameFix);</span>
<a href="#l37.94"></a><span id="l37.94">             gCategoryList.push(categoryName);</span>
<a href="#l37.95"></a><span id="l37.95">             if (categoryColor) {</span>
<a href="#l37.96"></a><span id="l37.96">                 categoryPrefBranch.setCharPref(categoryNameFix, categoryColor);</span>
<a href="#l37.97"></a><span id="l37.97">             }</span>
<a href="#l37.98"></a><span id="l37.98">         } else {</span>
<a href="#l37.99"></a><span id="l37.99">             this.backupData(categoryNameFix);</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineat">@@ -238,17 +238,17 @@ var gCategoriesPane = {</span>
<a href="#l37.101"></a><span id="l37.101">         // If 'Overwrite' was chosen, delete category that was being edited</span>
<a href="#l37.102"></a><span id="l37.102">         if (toBeDeleted != -1) {</span>
<a href="#l37.103"></a><span id="l37.103">             list.selectedIndex = toBeDeleted;</span>
<a href="#l37.104"></a><span id="l37.104">             this.deleteCategory();</span>
<a href="#l37.105"></a><span id="l37.105">         }</span>
<a href="#l37.106"></a><span id="l37.106"> </span>
<a href="#l37.107"></a><span id="l37.107">         this.updateCategoryList();</span>
<a href="#l37.108"></a><span id="l37.108"> </span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-        var updatedCategory = gCategoryList.indexOf(categoryName);</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+        let updatedCategory = gCategoryList.indexOf(categoryName);</span>
<a href="#l37.111"></a><span id="l37.111">         list.ensureIndexIsVisible(updatedCategory);</span>
<a href="#l37.112"></a><span id="l37.112">         list.selectedIndex = updatedCategory;</span>
<a href="#l37.113"></a><span id="l37.113">     },</span>
<a href="#l37.114"></a><span id="l37.114"> </span>
<a href="#l37.115"></a><span id="l37.115">     /**</span>
<a href="#l37.116"></a><span id="l37.116">      * Enable the edit and delete category buttons.</span>
<a href="#l37.117"></a><span id="l37.117">      */</span>
<a href="#l37.118"></a><span id="l37.118">     updateButtons: function gCP_updateButtons() {</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineat">@@ -259,25 +259,25 @@ var gCategoriesPane = {</span>
<a href="#l37.120"></a><span id="l37.120"> </span>
<a href="#l37.121"></a><span id="l37.121">     /**</span>
<a href="#l37.122"></a><span id="l37.122">      * Backs up the category name in case the dialog is canceled.</span>
<a href="#l37.123"></a><span id="l37.123">      *</span>
<a href="#l37.124"></a><span id="l37.124">      * @see formatStringForCSSRule</span>
<a href="#l37.125"></a><span id="l37.125">      * @param categoryNameFix     The formatted category name.</span>
<a href="#l37.126"></a><span id="l37.126">      */</span>
<a href="#l37.127"></a><span id="l37.127">     backupData: function gCP_backupData(categoryNameFix) {</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-        var currentColor;</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+        let currentColor;</span>
<a href="#l37.130"></a><span id="l37.130">         try {</span>
<a href="#l37.131"></a><span id="l37.131">             currentColor = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l37.132"></a><span id="l37.132">         } catch (ex) {</span>
<a href="#l37.133"></a><span id="l37.133">             dump(&quot;Exception caught in 'backupData': &quot; + ex + &quot;\n&quot;);</span>
<a href="#l37.134"></a><span id="l37.134">             currentColor = &quot;##NEW&quot;;</span>
<a href="#l37.135"></a><span id="l37.135">         }</span>
<a href="#l37.136"></a><span id="l37.136"> </span>
<a href="#l37.137"></a><span id="l37.137" class="difflineminus">-        for (var i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineplus">+        for (let i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l37.139"></a><span id="l37.139">             if (categoryNameFix == parent.backupPrefList[i].name) {</span>
<a href="#l37.140"></a><span id="l37.140">                 return;</span>
<a href="#l37.141"></a><span id="l37.141">             }</span>
<a href="#l37.142"></a><span id="l37.142">         }</span>
<a href="#l37.143"></a><span id="l37.143">         parent.backupPrefList[parent.backupPrefList.length] =</span>
<a href="#l37.144"></a><span id="l37.144">             { name: categoryNameFix, color: currentColor };</span>
<a href="#l37.145"></a><span id="l37.145">     },</span>
<a href="#l37.146"></a><span id="l37.146"> </span>
<a href="#l37.147"></a><span id="l37.147" class="difflineat">@@ -292,17 +292,17 @@ var gCategoriesPane = {</span>
<a href="#l37.148"></a><span id="l37.148">             this.editCategory();</span>
<a href="#l37.149"></a><span id="l37.149">         }</span>
<a href="#l37.150"></a><span id="l37.150">     },</span>
<a href="#l37.151"></a><span id="l37.151"> </span>
<a href="#l37.152"></a><span id="l37.152">     /**</span>
<a href="#l37.153"></a><span id="l37.153">      * Reverts category preferences in case the cancel button is pressed.</span>
<a href="#l37.154"></a><span id="l37.154">      */</span>
<a href="#l37.155"></a><span id="l37.155">     panelOnCancel: function gCP_panelOnCancel() {</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineminus">-        for (var i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+        for (let i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l37.158"></a><span id="l37.158">             if (parent.backupPrefList[i].color == &quot;##NEW&quot;) {</span>
<a href="#l37.159"></a><span id="l37.159">                 try {</span>
<a href="#l37.160"></a><span id="l37.160">                    categoryPrefBranch.clearUserPref(parent.backupPrefList[i].name);</span>
<a href="#l37.161"></a><span id="l37.161">                 } catch (ex) {</span>
<a href="#l37.162"></a><span id="l37.162">                     dump(&quot;Exception caught in 'panelOnCancel': &quot; + ex + &quot;\n&quot;);</span>
<a href="#l37.163"></a><span id="l37.163">                 }</span>
<a href="#l37.164"></a><span id="l37.164">             } else {</span>
<a href="#l37.165"></a><span id="l37.165">                 categoryPrefBranch.setCharPref(parent.backupPrefList[i].name,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -10,21 +10,21 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l38.4"></a><span id="l38.4">  * Global Object to hold methods for the general pref pane</span>
<a href="#l38.5"></a><span id="l38.5">  */</span>
<a href="#l38.6"></a><span id="l38.6"> var gCalendarGeneralPane = {</span>
<a href="#l38.7"></a><span id="l38.7">     /**</span>
<a href="#l38.8"></a><span id="l38.8">      * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l38.9"></a><span id="l38.9">      * values set in prefs.</span>
<a href="#l38.10"></a><span id="l38.10">      */</span>
<a href="#l38.11"></a><span id="l38.11">     init: function gCGP_init() {</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-        var df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+        let df = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l38.14"></a><span id="l38.14">                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l38.15"></a><span id="l38.15"> </span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-        var dateFormattedLong = df.formatDateLong(now());</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-        var dateFormattedShort = df.formatDateShort(now());</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+        let dateFormattedLong = df.formatDateLong(now());</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+        let dateFormattedShort = df.formatDateShort(now());</span>
<a href="#l38.20"></a><span id="l38.20"> </span>
<a href="#l38.21"></a><span id="l38.21">         // menu items include examples of current date formats.</span>
<a href="#l38.22"></a><span id="l38.22">         document.getElementById(&quot;dateformat-long-menuitem&quot;)</span>
<a href="#l38.23"></a><span id="l38.23">                 .setAttribute(&quot;label&quot;, labelLong + &quot;: &quot; + dateFormattedLong);</span>
<a href="#l38.24"></a><span id="l38.24">         document.getElementById(&quot;dateformat-short-menuitem&quot;)</span>
<a href="#l38.25"></a><span id="l38.25">                 .setAttribute(&quot;label&quot;, labelShort + &quot;: &quot; + dateFormattedShort);</span>
<a href="#l38.26"></a><span id="l38.26"> </span>
<a href="#l38.27"></a><span id="l38.27">         // deselect and reselect to update visible item title</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/content/preferences/views.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/content/preferences/views.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -19,23 +19,23 @@ var gViewsPane = {</span>
<a href="#l39.4"></a><span id="l39.4">         this.initializeViewStartEndMenus();</span>
<a href="#l39.5"></a><span id="l39.5">     },</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7">     /**</span>
<a href="#l39.8"></a><span id="l39.8">      * Initialize the strings for the  &quot;day starts at&quot; and &quot;day ends at&quot;</span>
<a href="#l39.9"></a><span id="l39.9">      * menulists. This is needed to respect locales that use AM/PM.</span>
<a href="#l39.10"></a><span id="l39.10">      */</span>
<a href="#l39.11"></a><span id="l39.11">     initializeViewStartEndMenus: function gVP_initializeViewStartEndMenus() {</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-        var labelIdStart;</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-        var labelIdEnd;</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-        var timeFormatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+        let labelIdStart;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+        let labelIdEnd;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+        let timeFormatter = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l39.18"></a><span id="l39.18">                                       .getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l39.19"></a><span id="l39.19">         // 1 to 23 instead of 0 to 24 to keep midnight &amp; noon as the localized strings</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-        for (var theHour = 1; theHour &lt;= 23; theHour++) {</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-            var time = timeFormatter.FormatTime(&quot;&quot;, Components.interfaces.nsIScriptableDateFormat</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+        for (let theHour = 1; theHour &lt;= 23; theHour++) {</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+            let time = timeFormatter.FormatTime(&quot;&quot;, Components.interfaces.nsIScriptableDateFormat</span>
<a href="#l39.24"></a><span id="l39.24">                                     .timeFormatNoSeconds, theHour, 0, 0);</span>
<a href="#l39.25"></a><span id="l39.25"> </span>
<a href="#l39.26"></a><span id="l39.26">             labelIdStart = &quot;timeStart&quot; + theHour;</span>
<a href="#l39.27"></a><span id="l39.27">             labelIdEnd = &quot;timeEnd&quot; + theHour;</span>
<a href="#l39.28"></a><span id="l39.28">             // This if block to keep Noon as the localized string, instead of as a number.</span>
<a href="#l39.29"></a><span id="l39.29">             if (theHour != 12) {</span>
<a href="#l39.30"></a><span id="l39.30">                 document.getElementById(labelIdStart).setAttribute(&quot;label&quot;, time);</span>
<a href="#l39.31"></a><span id="l39.31">                 document.getElementById(labelIdEnd).setAttribute(&quot;label&quot;, time);</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineat">@@ -49,51 +49,51 @@ var gViewsPane = {</span>
<a href="#l39.33"></a><span id="l39.33"> </span>
<a href="#l39.34"></a><span id="l39.34">     /**</span>
<a href="#l39.35"></a><span id="l39.35">      * Updates the view end menu to only display hours after the selected view</span>
<a href="#l39.36"></a><span id="l39.36">      * start.</span>
<a href="#l39.37"></a><span id="l39.37">      *</span>
<a href="#l39.38"></a><span id="l39.38">      * @param aStartValue       The value selected for view start.</span>
<a href="#l39.39"></a><span id="l39.39">      */</span>
<a href="#l39.40"></a><span id="l39.40">     updateViewEndMenu: function gVP_updateViewEndMenu(aStartValue) {</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-        var endMenuKids = document.getElementById(&quot;dayendhourpopup&quot;)</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+        let endMenuKids = document.getElementById(&quot;dayendhourpopup&quot;)</span>
<a href="#l39.43"></a><span id="l39.43">                                   .childNodes;</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-        for (var i = 0; i &lt; endMenuKids.length; i++) {</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+        for (let i = 0; i &lt; endMenuKids.length; i++) {</span>
<a href="#l39.46"></a><span id="l39.46">             if (Number(endMenuKids[i].value) &lt;= Number(aStartValue)) {</span>
<a href="#l39.47"></a><span id="l39.47">                 endMenuKids[i].setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l39.48"></a><span id="l39.48">             } else {</span>
<a href="#l39.49"></a><span id="l39.49">                 endMenuKids[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l39.50"></a><span id="l39.50">             }</span>
<a href="#l39.51"></a><span id="l39.51">         }</span>
<a href="#l39.52"></a><span id="l39.52">     },</span>
<a href="#l39.53"></a><span id="l39.53"> </span>
<a href="#l39.54"></a><span id="l39.54">     /**</span>
<a href="#l39.55"></a><span id="l39.55">      * Updates the view start menu to only display hours before the selected view</span>
<a href="#l39.56"></a><span id="l39.56">      * end.</span>
<a href="#l39.57"></a><span id="l39.57">      *</span>
<a href="#l39.58"></a><span id="l39.58">      * @param aEndValue         The value selected for view end.</span>
<a href="#l39.59"></a><span id="l39.59">      */</span>
<a href="#l39.60"></a><span id="l39.60">     updateViewStartMenu: function gVP_updateViewStartMenu(aEndValue) {</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-        var startMenuKids = document.getElementById(&quot;daystarthourpopup&quot;)</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+        let startMenuKids = document.getElementById(&quot;daystarthourpopup&quot;)</span>
<a href="#l39.63"></a><span id="l39.63">                                   .childNodes;</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-        for (var i = 0; i &lt; startMenuKids.length; i++) {</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+        for (let i = 0; i &lt; startMenuKids.length; i++) {</span>
<a href="#l39.66"></a><span id="l39.66">             if (Number(startMenuKids[i].value) &gt;= Number(aEndValue)) {</span>
<a href="#l39.67"></a><span id="l39.67">                 startMenuKids[i].setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l39.68"></a><span id="l39.68">             } else {</span>
<a href="#l39.69"></a><span id="l39.69">                 startMenuKids[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l39.70"></a><span id="l39.70">             }</span>
<a href="#l39.71"></a><span id="l39.71">         }</span>
<a href="#l39.72"></a><span id="l39.72">     },</span>
<a href="#l39.73"></a><span id="l39.73"> </span>
<a href="#l39.74"></a><span id="l39.74">     /**</span>
<a href="#l39.75"></a><span id="l39.75">      * Update the workday checkboxes based on the start of the week.</span>
<a href="#l39.76"></a><span id="l39.76">      *</span>
<a href="#l39.77"></a><span id="l39.77">      * @Param weekStart         The (0-based) index of the weekday the week</span>
<a href="#l39.78"></a><span id="l39.78">      *                            should start at.</span>
<a href="#l39.79"></a><span id="l39.79">      */</span>
<a href="#l39.80"></a><span id="l39.80">     updateViewWorkDayCheckboxes: function gVP_updateViewWorkDayCheckboxes(weekStart) {</span>
<a href="#l39.81"></a><span id="l39.81">         weekStart = Number(weekStart);</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-        for (var i = weekStart; i &lt; weekStart + 7; i++) {</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineminus">-            var checkbox = document.getElementById(&quot;dayoff&quot; + (i % 7));</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+        for (let i = weekStart; i &lt; weekStart + 7; i++) {</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+            let checkbox = document.getElementById(&quot;dayoff&quot; + (i % 7));</span>
<a href="#l39.86"></a><span id="l39.86">             checkbox.parentNode.appendChild(checkbox);</span>
<a href="#l39.87"></a><span id="l39.87">         }</span>
<a href="#l39.88"></a><span id="l39.88">     }</span>
<a href="#l39.89"></a><span id="l39.89"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -146,18 +146,18 @@</span>
<a href="#l40.4"></a><span id="l40.4">         onPropertyDeleting: function cO_onPropertyDeleting(aCalendar,</span>
<a href="#l40.5"></a><span id="l40.5">                                                             aName) {</span>
<a href="#l40.6"></a><span id="l40.6">         }</span>
<a href="#l40.7"></a><span id="l40.7">       })</span>
<a href="#l40.8"></a><span id="l40.8">       ]]&gt;&lt;/field&gt;</span>
<a href="#l40.9"></a><span id="l40.9">     &lt;/implementation&gt;</span>
<a href="#l40.10"></a><span id="l40.10">     &lt;handlers&gt;</span>
<a href="#l40.11"></a><span id="l40.11">       &lt;handler event=&quot;dblclick&quot;&gt;&lt;![CDATA[</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-        var col = {};</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-        var calendar = this.getCalendarFromEvent(event, col);</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+        let col = {};</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+        let calendar = this.getCalendarFromEvent(event, col);</span>
<a href="#l40.16"></a><span id="l40.16">         if (event.button != 0 ||</span>
<a href="#l40.17"></a><span id="l40.17">             (col.value &amp;&amp; col.value.element &amp;&amp;</span>
<a href="#l40.18"></a><span id="l40.18">              col.value.element.getAttribute(&quot;anonid&quot;) == &quot;checkbox-treecol&quot;)) {</span>
<a href="#l40.19"></a><span id="l40.19">             // Only left clicks that are not on the checkbox column</span>
<a href="#l40.20"></a><span id="l40.20">             return;</span>
<a href="#l40.21"></a><span id="l40.21">         }</span>
<a href="#l40.22"></a><span id="l40.22">         if (calendar) {</span>
<a href="#l40.23"></a><span id="l40.23">             openCalendarProperties(calendar);</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineat">@@ -439,17 +439,17 @@</span>
<a href="#l40.25"></a><span id="l40.25">         &lt;!--</span>
<a href="#l40.26"></a><span id="l40.26">           - Find the array index of the calendar with the passed id.</span>
<a href="#l40.27"></a><span id="l40.27">           -</span>
<a href="#l40.28"></a><span id="l40.28">           - @param aId           The calendar id to find an index for.</span>
<a href="#l40.29"></a><span id="l40.29">           - @return              The array index, or -1 if not found.</span>
<a href="#l40.30"></a><span id="l40.30">           --&gt;</span>
<a href="#l40.31"></a><span id="l40.31">         &lt;parameter name=&quot;aId&quot;/&gt;</span>
<a href="#l40.32"></a><span id="l40.32">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-          for (var i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+          for (let i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l40.35"></a><span id="l40.35">               if (this.mCalendarList[i].id == aId) {</span>
<a href="#l40.36"></a><span id="l40.36">                   return i;</span>
<a href="#l40.37"></a><span id="l40.37">               }</span>
<a href="#l40.38"></a><span id="l40.38">           }</span>
<a href="#l40.39"></a><span id="l40.39">           return -1;</span>
<a href="#l40.40"></a><span id="l40.40">         ]]&gt;&lt;/body&gt;</span>
<a href="#l40.41"></a><span id="l40.41">       &lt;/method&gt;</span>
<a href="#l40.42"></a><span id="l40.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-subscriptions-list.xml</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-subscriptions-list.xml</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -18,17 +18,17 @@</span>
<a href="#l41.4"></a><span id="l41.4">     &lt;implementation&gt;</span>
<a href="#l41.5"></a><span id="l41.5"> </span>
<a href="#l41.6"></a><span id="l41.6">       &lt;!-- methods --&gt;</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8">       &lt;method name=&quot;addCalendar&quot;&gt;</span>
<a href="#l41.9"></a><span id="l41.9">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l41.10"></a><span id="l41.10">         &lt;parameter name=&quot;bSubscribed&quot;/&gt;</span>
<a href="#l41.11"></a><span id="l41.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-          var newNode = createXULElement(&quot;calendar-subscriptions-richlistitem&quot;);</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+          let newNode = createXULElement(&quot;calendar-subscriptions-richlistitem&quot;);</span>
<a href="#l41.14"></a><span id="l41.14">           this.appendChild(newNode);</span>
<a href="#l41.15"></a><span id="l41.15">           newNode.setAttribute(&quot;anonid&quot;, &quot;subscriptions-listitem&quot;);</span>
<a href="#l41.16"></a><span id="l41.16">           newNode.calendar = aCalendar;</span>
<a href="#l41.17"></a><span id="l41.17">           newNode.subscribed = bSubscribed;</span>
<a href="#l41.18"></a><span id="l41.18">         ]]&gt;&lt;/body&gt;</span>
<a href="#l41.19"></a><span id="l41.19">       &lt;/method&gt;</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21">       &lt;method name=&quot;clear&quot;&gt;</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -78,48 +78,48 @@</span>
<a href="#l41.23"></a><span id="l41.23">           this.mSubscribed = val;</span>
<a href="#l41.24"></a><span id="l41.24">           this.checked = val;</span>
<a href="#l41.25"></a><span id="l41.25">           return val;</span>
<a href="#l41.26"></a><span id="l41.26">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l41.27"></a><span id="l41.27">       &lt;/property&gt;</span>
<a href="#l41.28"></a><span id="l41.28"> </span>
<a href="#l41.29"></a><span id="l41.29">       &lt;property name=&quot;checked&quot;&gt;</span>
<a href="#l41.30"></a><span id="l41.30">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-          var checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.33"></a><span id="l41.33">             this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l41.34"></a><span id="l41.34">           if (checkbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l41.35"></a><span id="l41.35">             return true;</span>
<a href="#l41.36"></a><span id="l41.36">           } else {</span>
<a href="#l41.37"></a><span id="l41.37">             return false;</span>
<a href="#l41.38"></a><span id="l41.38">           }</span>
<a href="#l41.39"></a><span id="l41.39">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l41.40"></a><span id="l41.40">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-          var checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.43"></a><span id="l41.43">             this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l41.44"></a><span id="l41.44">           if (val) {</span>
<a href="#l41.45"></a><span id="l41.45">             checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l41.46"></a><span id="l41.46">           } else {</span>
<a href="#l41.47"></a><span id="l41.47">             checkbox.removeAttribute(&quot;checked&quot;);</span>
<a href="#l41.48"></a><span id="l41.48">           }</span>
<a href="#l41.49"></a><span id="l41.49">           return val;</span>
<a href="#l41.50"></a><span id="l41.50">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l41.51"></a><span id="l41.51">       &lt;/property&gt;</span>
<a href="#l41.52"></a><span id="l41.52"> </span>
<a href="#l41.53"></a><span id="l41.53">       &lt;property name=&quot;disabled&quot;&gt;</span>
<a href="#l41.54"></a><span id="l41.54">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineminus">-          var checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.57"></a><span id="l41.57">             this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l41.58"></a><span id="l41.58">           if (checkbox.getAttribute(&quot;disabled&quot;) == &quot;true&quot;) {</span>
<a href="#l41.59"></a><span id="l41.59">             return true;</span>
<a href="#l41.60"></a><span id="l41.60">           } else {</span>
<a href="#l41.61"></a><span id="l41.61">             return false;</span>
<a href="#l41.62"></a><span id="l41.62">           }</span>
<a href="#l41.63"></a><span id="l41.63">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l41.64"></a><span id="l41.64">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineminus">-          var checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l41.67"></a><span id="l41.67">             this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l41.68"></a><span id="l41.68">           if (val) {</span>
<a href="#l41.69"></a><span id="l41.69">             checkbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l41.70"></a><span id="l41.70">           } else {</span>
<a href="#l41.71"></a><span id="l41.71">             checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l41.72"></a><span id="l41.72">           }</span>
<a href="#l41.73"></a><span id="l41.73">           return val;</span>
<a href="#l41.74"></a><span id="l41.74">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineat">@@ -127,17 +127,17 @@</span>
<a href="#l41.76"></a><span id="l41.76"> </span>
<a href="#l41.77"></a><span id="l41.77">       &lt;!-- methods --&gt;</span>
<a href="#l41.78"></a><span id="l41.78"> </span>
<a href="#l41.79"></a><span id="l41.79">       &lt;method name=&quot;setCalendar&quot;&gt;</span>
<a href="#l41.80"></a><span id="l41.80">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l41.81"></a><span id="l41.81">         &lt;body&gt;</span>
<a href="#l41.82"></a><span id="l41.82">           &lt;![CDATA[</span>
<a href="#l41.83"></a><span id="l41.83">             this.mCalendar = aCalendar;</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineminus">-            var label = document.getAnonymousElementByAttribute(</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+            let label = document.getAnonymousElementByAttribute(</span>
<a href="#l41.86"></a><span id="l41.86">                 this, &quot;anonid&quot;, &quot;subscription-name&quot;);</span>
<a href="#l41.87"></a><span id="l41.87">             label.setAttribute(&quot;value&quot;, aCalendar.name);</span>
<a href="#l41.88"></a><span id="l41.88">           ]]&gt;</span>
<a href="#l41.89"></a><span id="l41.89">         &lt;/body&gt;</span>
<a href="#l41.90"></a><span id="l41.90">       &lt;/method&gt;</span>
<a href="#l41.91"></a><span id="l41.91"> </span>
<a href="#l41.92"></a><span id="l41.92">     &lt;/implementation&gt;</span>
<a href="#l41.93"></a><span id="l41.93"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -148,17 +148,17 @@</span>
<a href="#l42.4"></a><span id="l42.4">             return;</span>
<a href="#l42.5"></a><span id="l42.5">           }</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7">           let localeCollator = cal.createLocaleCollator();</span>
<a href="#l42.8"></a><span id="l42.8">           let compare = localeCollator.compareString.bind(localeCollator, 0);</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10">           let children = categoryListbox.childNodes;</span>
<a href="#l42.11"></a><span id="l42.11">           let categories = [];</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-          for (var i = 0; i &lt; children.length; i++) {</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+          for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l42.14"></a><span id="l42.14">             categories.push(children[i].label);</span>
<a href="#l42.15"></a><span id="l42.15">           }</span>
<a href="#l42.16"></a><span id="l42.16"> </span>
<a href="#l42.17"></a><span id="l42.17">           let item = this.insertCategory(category, categories, categoryListbox, compare);</span>
<a href="#l42.18"></a><span id="l42.18">           categoryTextbox.value = &quot;&quot;;</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20">           if (this.maxCount == 1) {</span>
<a href="#l42.21"></a><span id="l42.21">             categoryListbox.selectedItem = item;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -332,21 +332,21 @@</span>
<a href="#l42.23"></a><span id="l42.23">                 return &quot;&quot;;</span>
<a href="#l42.24"></a><span id="l42.24">             }</span>
<a href="#l42.25"></a><span id="l42.25">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l42.26"></a><span id="l42.26">       &lt;/property&gt;</span>
<a href="#l42.27"></a><span id="l42.27"> </span>
<a href="#l42.28"></a><span id="l42.28">       &lt;method name=&quot;isVisible&quot;&gt;</span>
<a href="#l42.29"></a><span id="l42.29">         &lt;parameter name=&quot;aMode&quot;/&gt;</span>
<a href="#l42.30"></a><span id="l42.30">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-            var lMode = aMode || this.currentMode;</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+            let lMode = aMode || this.currentMode;</span>
<a href="#l42.33"></a><span id="l42.33">             if (!this.isVisibleInMode(lMode)) {</span>
<a href="#l42.34"></a><span id="l42.34">                 return false;</span>
<a href="#l42.35"></a><span id="l42.35">             }</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-            var collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+            let collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l42.38"></a><span id="l42.38">             return (!collapsedModes.includes(lMode));</span>
<a href="#l42.39"></a><span id="l42.39">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.40"></a><span id="l42.40">       &lt;/method&gt;</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42">       &lt;method name=&quot;setModeAttribute&quot;&gt; </span>
<a href="#l42.43"></a><span id="l42.43">         &lt;parameter name=&quot;aModeAttribute&quot;/&gt;</span>
<a href="#l42.44"></a><span id="l42.44">         &lt;parameter name=&quot;aModeValue&quot;/&gt;</span>
<a href="#l42.45"></a><span id="l42.45">         &lt;parameter name=&quot;amode&quot;/&gt;</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineat">@@ -377,23 +377,23 @@</span>
<a href="#l42.47"></a><span id="l42.47">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.48"></a><span id="l42.48">       &lt;/method&gt;</span>
<a href="#l42.49"></a><span id="l42.49"> </span>
<a href="#l42.50"></a><span id="l42.50">       &lt;method name=&quot;setVisible&quot;&gt;</span>
<a href="#l42.51"></a><span id="l42.51">         &lt;parameter name=&quot;aVisible&quot;/&gt;</span>
<a href="#l42.52"></a><span id="l42.52">         &lt;parameter name=&quot;aPushModeCollapsedAttribute&quot;/&gt;</span>
<a href="#l42.53"></a><span id="l42.53">         &lt;parameter name=&quot;aNotifyRefControl&quot;/&gt;</span>
<a href="#l42.54"></a><span id="l42.54">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-            var notifyRefControl = ((aNotifyRefControl == null) || (aNotifyRefControl === true));</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-            var pushModeCollapsedAttribute = ((aPushModeCollapsedAttribute == null)</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+            let notifyRefControl = ((aNotifyRefControl == null) || (aNotifyRefControl === true));</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+            let pushModeCollapsedAttribute = ((aPushModeCollapsedAttribute == null)</span>
<a href="#l42.59"></a><span id="l42.59">                                                  || (aPushModeCollapsedAttribute === true));</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-            var collapsedModes = [];</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-            var modeIndex = -1;</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-            var display = aVisible;</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-            var collapsedInMode = false;</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+            let collapsedModes = [];</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+            let modeIndex = -1;</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+            let display = aVisible;</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+            let collapsedInMode = false;</span>
<a href="#l42.68"></a><span id="l42.68">             if (this.hasAttribute(&quot;collapsedinmodes&quot;)) {</span>
<a href="#l42.69"></a><span id="l42.69">                 collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l42.70"></a><span id="l42.70">                 modeIndex = collapsedModes.indexOf(this.currentMode);</span>
<a href="#l42.71"></a><span id="l42.71">                 collapsedInMode = (modeIndex &gt; -1);</span>
<a href="#l42.72"></a><span id="l42.72">             }</span>
<a href="#l42.73"></a><span id="l42.73">             if ((aVisible === true) &amp;&amp; (pushModeCollapsedAttribute == false)){</span>
<a href="#l42.74"></a><span id="l42.74">                 display = (aVisible === true) &amp;&amp; (!collapsedInMode);</span>
<a href="#l42.75"></a><span id="l42.75">             }</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineat">@@ -411,76 +411,76 @@</span>
<a href="#l42.77"></a><span id="l42.77">                     if (modeIndex &gt; -1) {</span>
<a href="#l42.78"></a><span id="l42.78">                         collapsedModes.splice(modeIndex, 1);</span>
<a href="#l42.79"></a><span id="l42.79">                         if (collapsedModes.join(&quot;,&quot;) == &quot;&quot;) {</span>
<a href="#l42.80"></a><span id="l42.80">                             collapsedModes[0] = &quot;,&quot;;</span>
<a href="#l42.81"></a><span id="l42.81">                         }</span>
<a href="#l42.82"></a><span id="l42.82">                     }</span>
<a href="#l42.83"></a><span id="l42.83">                 }</span>
<a href="#l42.84"></a><span id="l42.84">                 this.setAttribute(&quot;collapsedinmodes&quot;, collapsedModes.join(&quot;,&quot;));</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-                var id = this.getAttribute(&quot;id&quot;);</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+                let id = this.getAttribute(&quot;id&quot;);</span>
<a href="#l42.87"></a><span id="l42.87">                 if (id) {</span>
<a href="#l42.88"></a><span id="l42.88">                     document.persist(id, &quot;collapsedinmodes&quot;);</span>
<a href="#l42.89"></a><span id="l42.89">                 }</span>
<a href="#l42.90"></a><span id="l42.90">             }</span>
<a href="#l42.91"></a><span id="l42.91">             if (notifyRefControl === true) {</span>
<a href="#l42.92"></a><span id="l42.92">                 if (this.hasAttribute(&quot;refcontrol&quot;)) {</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineminus">-                    var command = document.getElementById(this.getAttribute(&quot;refcontrol&quot;));</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+                    let command = document.getElementById(this.getAttribute(&quot;refcontrol&quot;));</span>
<a href="#l42.95"></a><span id="l42.95">                     if (command) {</span>
<a href="#l42.96"></a><span id="l42.96">                         command.setAttribute(&quot;checked&quot;, display);</span>
<a href="#l42.97"></a><span id="l42.97">                         setBooleanAttribute(command, &quot;disabled&quot;, !this.isVisibleInMode());</span>
<a href="#l42.98"></a><span id="l42.98">                     }</span>
<a href="#l42.99"></a><span id="l42.99">                 }</span>
<a href="#l42.100"></a><span id="l42.100">             }</span>
<a href="#l42.101"></a><span id="l42.101">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.102"></a><span id="l42.102">       &lt;/method&gt;</span>
<a href="#l42.103"></a><span id="l42.103"> </span>
<a href="#l42.104"></a><span id="l42.104">       &lt;method name=&quot;isVisibleInMode&quot;&gt;</span>
<a href="#l42.105"></a><span id="l42.105">         &lt;parameter name=&quot;aMode&quot;/&gt;</span>
<a href="#l42.106"></a><span id="l42.106">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineminus">-            var lMode = aMode || this.currentMode;</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineminus">-            var display = true;</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineminus">-            var lModes = [];</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+            let lMode = aMode || this.currentMode;</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+            let display = true;</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+            let lModes = [];</span>
<a href="#l42.113"></a><span id="l42.113">             if (this.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-                var modeString = this.getAttribute(&quot;mode&quot;);</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+                let modeString = this.getAttribute(&quot;mode&quot;);</span>
<a href="#l42.116"></a><span id="l42.116">                 lModes = modeString.split(&quot;,&quot;);</span>
<a href="#l42.117"></a><span id="l42.117">             }</span>
<a href="#l42.118"></a><span id="l42.118">             if (lModes &amp;&amp; lModes.length &gt; 0) {</span>
<a href="#l42.119"></a><span id="l42.119">                 display = lModes.includes(lMode);</span>
<a href="#l42.120"></a><span id="l42.120">             }</span>
<a href="#l42.121"></a><span id="l42.121">             return display;</span>
<a href="#l42.122"></a><span id="l42.122">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.123"></a><span id="l42.123">       &lt;/method&gt;</span>
<a href="#l42.124"></a><span id="l42.124"> </span>
<a href="#l42.125"></a><span id="l42.125">       &lt;method name=&quot;onModeModified&quot;&gt;</span>
<a href="#l42.126"></a><span id="l42.126">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l42.127"></a><span id="l42.127">         &lt;parameter name=&quot;aBinding&quot;/&gt;</span>
<a href="#l42.128"></a><span id="l42.128">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.129"></a><span id="l42.129">             if (aEvent.attrName == &quot;mode&quot;) {</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineminus">-                var display = aBinding.isVisibleInMode(aEvent.newValue);</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+                let display = aBinding.isVisibleInMode(aEvent.newValue);</span>
<a href="#l42.132"></a><span id="l42.132">                 aBinding.setVisible(display, false, true);</span>
<a href="#l42.133"></a><span id="l42.133">             }</span>
<a href="#l42.134"></a><span id="l42.134">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.135"></a><span id="l42.135">       &lt;/method&gt;</span>
<a href="#l42.136"></a><span id="l42.136"> </span>
<a href="#l42.137"></a><span id="l42.137">       &lt;method name=&quot;togglePane&quot;&gt;</span>
<a href="#l42.138"></a><span id="l42.138">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l42.139"></a><span id="l42.139">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineminus">-            var command = aEvent.target;</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineminus">-            var newValue = (command.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+            let command = aEvent.target;</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineplus">+            let newValue = (command.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l42.144"></a><span id="l42.144">             command.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l42.145"></a><span id="l42.145">             this.setVisible(newValue == &quot;true&quot;, true, true);</span>
<a href="#l42.146"></a><span id="l42.146">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.147"></a><span id="l42.147">       &lt;/method&gt;</span>
<a href="#l42.148"></a><span id="l42.148"> </span>
<a href="#l42.149"></a><span id="l42.149">       &lt;method name=&quot;onCheckboxStateChange&quot;&gt;</span>
<a href="#l42.150"></a><span id="l42.150">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l42.151"></a><span id="l42.151">         &lt;parameter name=&quot;aBinding&quot;/&gt;</span>
<a href="#l42.152"></a><span id="l42.152">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineminus">-            var newValue = aEvent.target.checked;</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineplus">+            let newValue = aEvent.target.checked;</span>
<a href="#l42.155"></a><span id="l42.155">             this.setVisible(newValue, true, true);</span>
<a href="#l42.156"></a><span id="l42.156">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.157"></a><span id="l42.157">       &lt;/method&gt;</span>
<a href="#l42.158"></a><span id="l42.158">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l42.159"></a><span id="l42.159">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l42.160"></a><span id="l42.160">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l42.161"></a><span id="l42.161">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l42.162"></a><span id="l42.162">           if (aAttr == &quot;broadcaster&quot;) {</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineat">@@ -490,17 +490,17 @@</span>
<a href="#l42.164"></a><span id="l42.164">                   binding: this,</span>
<a href="#l42.165"></a><span id="l42.165">                   handleEvent: function(aEvent, aHandled) {</span>
<a href="#l42.166"></a><span id="l42.166">                       return this.binding.onModeModified(aEvent, this.binding);</span>
<a href="#l42.167"></a><span id="l42.167">                   }</span>
<a href="#l42.168"></a><span id="l42.168">               };</span>
<a href="#l42.169"></a><span id="l42.169">               this.mBroadcaster.addEventListener(&quot;DOMAttrModified&quot;, this.mModHandler, true);</span>
<a href="#l42.170"></a><span id="l42.170">             }</span>
<a href="#l42.171"></a><span id="l42.171">           }</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineminus">-          var ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineplus">+          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l42.174"></a><span id="l42.174">         ]]&gt;&lt;/body&gt;</span>
<a href="#l42.175"></a><span id="l42.175">       &lt;/method&gt;</span>
<a href="#l42.176"></a><span id="l42.176">     &lt;/implementation&gt;</span>
<a href="#l42.177"></a><span id="l42.177">   &lt;/binding&gt;</span>
<a href="#l42.178"></a><span id="l42.178"> </span>
<a href="#l42.179"></a><span id="l42.179"> &lt;!-- This binding may server as a droptarget container for arbitrary items</span>
<a href="#l42.180"></a><span id="l42.180">      it contains methods to add DropShadows. This binding is meant to be used</span>
<a href="#l42.181"></a><span id="l42.181">      as a parent binding. The methods may be overwritten.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -481,33 +481,33 @@</span>
<a href="#l43.4"></a><span id="l43.4">         &lt;parameter name=&quot;aItemType&quot;/&gt;</span>
<a href="#l43.5"></a><span id="l43.5">         &lt;parameter name=&quot;aDetail&quot;/&gt;</span>
<a href="#l43.6"></a><span id="l43.6">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l43.7"></a><span id="l43.7">         &lt;parameter name=&quot;aItems&quot;/&gt;</span>
<a href="#l43.8"></a><span id="l43.8">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.9"></a><span id="l43.9">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l43.10"></a><span id="l43.10">                 return;</span>
<a href="#l43.11"></a><span id="l43.11">             }</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-            for (var item of aItems) {</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+            for (let item of aItems) {</span>
<a href="#l43.14"></a><span id="l43.14">                 this.setBusyDaysForOccurrence(item, true);</span>
<a href="#l43.15"></a><span id="l43.15">             }</span>
<a href="#l43.16"></a><span id="l43.16">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.17"></a><span id="l43.17">       &lt;/method&gt;</span>
<a href="#l43.18"></a><span id="l43.18"> </span>
<a href="#l43.19"></a><span id="l43.19">       &lt;method name=&quot;setBusyDaysForItem&quot;&gt;</span>
<a href="#l43.20"></a><span id="l43.20">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l43.21"></a><span id="l43.21">         &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l43.22"></a><span id="l43.22">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">-          var items = [aItem];</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+          let items = [aItem];</span>
<a href="#l43.25"></a><span id="l43.25">           if (aItem.recurrenceInfo) {</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineminus">-              var startDate = this.firstDate;</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineminus">-              var endDate = this.lastDate;</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+              let startDate = this.firstDate;</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+              let endDate = this.lastDate;</span>
<a href="#l43.30"></a><span id="l43.30">               items = aItem.getOccurrencesBetween(startDate, endDate, {});</span>
<a href="#l43.31"></a><span id="l43.31">           }</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">-          for (var item of items) {</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+          for (let item of items) {</span>
<a href="#l43.34"></a><span id="l43.34">               this.setBusyDaysForOccurrence(item, aState);</span>
<a href="#l43.35"></a><span id="l43.35">           }</span>
<a href="#l43.36"></a><span id="l43.36">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.37"></a><span id="l43.37">       &lt;/method&gt;</span>
<a href="#l43.38"></a><span id="l43.38"> </span>
<a href="#l43.39"></a><span id="l43.39">       &lt;method name=&quot;parseBoxBusy&quot;&gt;</span>
<a href="#l43.40"></a><span id="l43.40">         &lt;parameter name=&quot;aBox&quot;/&gt;</span>
<a href="#l43.41"></a><span id="l43.41">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineat">@@ -719,21 +719,21 @@</span>
<a href="#l43.43"></a><span id="l43.43">           }</span>
<a href="#l43.44"></a><span id="l43.44">           this.setHeader();</span>
<a href="#l43.45"></a><span id="l43.45">           this.showMonth(this.mValue);</span>
<a href="#l43.46"></a><span id="l43.46">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.47"></a><span id="l43.47">       &lt;/method&gt;</span>
<a href="#l43.48"></a><span id="l43.48">       &lt;method name=&quot;setHeader&quot;&gt;</span>
<a href="#l43.49"></a><span id="l43.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.50"></a><span id="l43.50">           // Reset the headers</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineminus">-          var header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-row-header&quot;);</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-          var dayList = new Array(7);</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineminus">-          var tempDate = new Date();</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-          var i, j;</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-          var useOSFormat;</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+          let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-row-header&quot;);</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+          let dayList = new Array(7);</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+          let tempDate = new Date();</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+          let i, j;</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+          let useOSFormat;</span>
<a href="#l43.61"></a><span id="l43.61">           tempDate.setDate(tempDate.getDate() - (tempDate.getDay() - this.weekStart));</span>
<a href="#l43.62"></a><span id="l43.62">           for (i = 0; i &lt; header.childNodes.length - 1; i++) {</span>
<a href="#l43.63"></a><span id="l43.63">               // if available, use UILocale days, else operating system format</span>
<a href="#l43.64"></a><span id="l43.64">               try {</span>
<a href="#l43.65"></a><span id="l43.65">                   dayList[i] = calGetString(&quot;dateFormat&quot;,</span>
<a href="#l43.66"></a><span id="l43.66">                                &quot;day.&quot; + (tempDate.getDay() + 1) + &quot;.short&quot;);</span>
<a href="#l43.67"></a><span id="l43.67">               } catch (e) {</span>
<a href="#l43.68"></a><span id="l43.68">                   dayList[i] = tempDate.toLocaleFormat(&quot;%a&quot;);</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineat">@@ -743,53 +743,53 @@</span>
<a href="#l43.70"></a><span id="l43.70">           }</span>
<a href="#l43.71"></a><span id="l43.71"> </span>
<a href="#l43.72"></a><span id="l43.72">           if (useOSFormat) {</span>
<a href="#l43.73"></a><span id="l43.73">               // To keep datepicker popup compact, shrink localized weekday</span>
<a href="#l43.74"></a><span id="l43.74">               // abbreviations down to 1 or 2 chars so each column of week can</span>
<a href="#l43.75"></a><span id="l43.75">               // be as narrow as 2 digits.</span>
<a href="#l43.76"></a><span id="l43.76">               //</span>
<a href="#l43.77"></a><span id="l43.77">               // 1. Compute the minLength of the day name abbreviations.</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineminus">-              var minLength = dayList[0].length;</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+              let minLength = dayList[0].length;</span>
<a href="#l43.80"></a><span id="l43.80">               for (i = 1; i &lt; dayList.length; i++) {</span>
<a href="#l43.81"></a><span id="l43.81">                   minLength = Math.min(minLength, dayList[i].length);</span>
<a href="#l43.82"></a><span id="l43.82">               }</span>
<a href="#l43.83"></a><span id="l43.83">               // 2. If some day name abbrev. is longer than 2 chars (not Catalan),</span>
<a href="#l43.84"></a><span id="l43.84">               //    and ALL localized day names share same prefix (as in Chinese),</span>
<a href="#l43.85"></a><span id="l43.85">               //    then trim shared &quot;day-&quot; prefix.</span>
<a href="#l43.86"></a><span id="l43.86">               if (dayList.some(function(dayAbbr){ return dayAbbr.length &gt; 2; })) {</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineminus">-                  for (var endPrefix = 0; endPrefix &lt; minLength; endPrefix++) {</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineminus">-                      var c = dayList[0][endPrefix];</span>
<a href="#l43.89"></a><span id="l43.89" class="difflineplus">+                  for (let endPrefix = 0; endPrefix &lt; minLength; endPrefix++) {</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineplus">+                      let c = dayList[0][endPrefix];</span>
<a href="#l43.91"></a><span id="l43.91">                       if (dayList.some(dayAbbr =&gt; dayAbbr[endPrefix] != c)) {</span>
<a href="#l43.92"></a><span id="l43.92">                           if (endPrefix &gt; 0) {</span>
<a href="#l43.93"></a><span id="l43.93">                               for (i = 0; i &lt; dayList.length; i++) { // trim prefix chars.</span>
<a href="#l43.94"></a><span id="l43.94">                                   dayList[i] = dayList[i].substring(endPrefix);</span>
<a href="#l43.95"></a><span id="l43.95">                               }</span>
<a href="#l43.96"></a><span id="l43.96">                           }</span>
<a href="#l43.97"></a><span id="l43.97">                           break;</span>
<a href="#l43.98"></a><span id="l43.98">                       }</span>
<a href="#l43.99"></a><span id="l43.99">                   }</span>
<a href="#l43.100"></a><span id="l43.100">               }</span>
<a href="#l43.101"></a><span id="l43.101">               // 3. trim each day abbreviation to 1 char if unique, else 2 chars.</span>
<a href="#l43.102"></a><span id="l43.102">               for (i = 0; i &lt; dayList.length; i++) {</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineminus">-                  var foundMatch = 1;</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineplus">+                  let foundMatch = 1;</span>
<a href="#l43.105"></a><span id="l43.105">                   for (j = 0; j &lt; dayList.length; j++) {</span>
<a href="#l43.106"></a><span id="l43.106">                       if (i != j) {</span>
<a href="#l43.107"></a><span id="l43.107">                           if (dayList[i].substring(0, 1) == dayList[j].substring(0, 1)) {</span>
<a href="#l43.108"></a><span id="l43.108">                               foundMatch = 2;</span>
<a href="#l43.109"></a><span id="l43.109">                               break;</span>
<a href="#l43.110"></a><span id="l43.110">                           }</span>
<a href="#l43.111"></a><span id="l43.111">                       }</span>
<a href="#l43.112"></a><span id="l43.112">                   }</span>
<a href="#l43.113"></a><span id="l43.113">                   dayList[i] = dayList[i].substring(0, foundMatch);</span>
<a href="#l43.114"></a><span id="l43.114">               }</span>
<a href="#l43.115"></a><span id="l43.115">           }</span>
<a href="#l43.116"></a><span id="l43.116"> </span>
<a href="#l43.117"></a><span id="l43.117">           setBooleanAttribute(header.childNodes[0], &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineminus">-          for (var column = 1; column &lt; header.childNodes.length; column++) {</span>
<a href="#l43.119"></a><span id="l43.119" class="difflineplus">+          for (let column = 1; column &lt; header.childNodes.length; column++) {</span>
<a href="#l43.120"></a><span id="l43.120">               header.childNodes[column].setAttribute(&quot;value&quot;, dayList[column - 1]);</span>
<a href="#l43.121"></a><span id="l43.121">           }</span>
<a href="#l43.122"></a><span id="l43.122">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.123"></a><span id="l43.123">       &lt;/method&gt;</span>
<a href="#l43.124"></a><span id="l43.124">       &lt;method name=&quot;showMonth&quot;&gt;</span>
<a href="#l43.125"></a><span id="l43.125">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l43.126"></a><span id="l43.126">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.127"></a><span id="l43.127">             // Use mExtraDate if aDate is null.</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineat">@@ -799,17 +799,17 @@</span>
<a href="#l43.129"></a><span id="l43.129">             // We set the hour and minute to something highly unlikely to be the</span>
<a href="#l43.130"></a><span id="l43.130">             // exact change point of DST, so timezones like America/Sao Paulo</span>
<a href="#l43.131"></a><span id="l43.131">             // don't display some days twice.</span>
<a href="#l43.132"></a><span id="l43.132">             aDate.setHours(12);</span>
<a href="#l43.133"></a><span id="l43.133">             aDate.setMinutes(34);</span>
<a href="#l43.134"></a><span id="l43.134">             aDate.setSeconds(0);</span>
<a href="#l43.135"></a><span id="l43.135">             aDate.setMilliseconds(0);</span>
<a href="#l43.136"></a><span id="l43.136">             // Don't fire onmonthchange event upon initialization</span>
<a href="#l43.137"></a><span id="l43.137" class="difflineminus">-            var monthChanged = this.mEditorDate &amp;&amp; (this.mEditorDate.valueOf() != aDate.valueOf());</span>
<a href="#l43.138"></a><span id="l43.138" class="difflineplus">+            let monthChanged = this.mEditorDate &amp;&amp; (this.mEditorDate.valueOf() != aDate.valueOf());</span>
<a href="#l43.139"></a><span id="l43.139">             this.mEditorDate = aDate; // only place mEditorDate is set.</span>
<a href="#l43.140"></a><span id="l43.140"> </span>
<a href="#l43.141"></a><span id="l43.141">             if (this.mToday) {</span>
<a href="#l43.142"></a><span id="l43.142">               this.mToday.removeAttribute(&quot;today&quot;);</span>
<a href="#l43.143"></a><span id="l43.143">               this.mToday = null;</span>
<a href="#l43.144"></a><span id="l43.144">             }</span>
<a href="#l43.145"></a><span id="l43.145"> </span>
<a href="#l43.146"></a><span id="l43.146">             if (this.mSelected) {</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineat">@@ -822,42 +822,42 @@</span>
<a href="#l43.148"></a><span id="l43.148">               this.mExtra = null;</span>
<a href="#l43.149"></a><span id="l43.149">             }</span>
<a href="#l43.150"></a><span id="l43.150"> </span>
<a href="#l43.151"></a><span id="l43.151">             // Update the month and year title</span>
<a href="#l43.152"></a><span id="l43.152">             this.setAttribute(&quot;month&quot;, aDate.getMonth());</span>
<a href="#l43.153"></a><span id="l43.153">             this.setAttribute(&quot;year&quot;, aDate.getFullYear());</span>
<a href="#l43.154"></a><span id="l43.154">             if (!this.mIsReadOnly) {</span>
<a href="#l43.155"></a><span id="l43.155">                 // Update the month popup</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineminus">-                var header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l43.157"></a><span id="l43.157" class="difflineplus">+                let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l43.158"></a><span id="l43.158">                 header.updateYearPopup(aDate);</span>
<a href="#l43.159"></a><span id="l43.159">                 header.updateMonthPopup(aDate);</span>
<a href="#l43.160"></a><span id="l43.160">             }</span>
<a href="#l43.161"></a><span id="l43.161">             // Update the calendar</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineminus">-            var calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineminus">-            var date = this._getStartDate(aDate);</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineplus">+            let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+            let date = this._getStartDate(aDate);</span>
<a href="#l43.166"></a><span id="l43.166"> </span>
<a href="#l43.167"></a><span id="l43.167">             // get today's date</span>
<a href="#l43.168"></a><span id="l43.168" class="difflineminus">-            var today = new Date();</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineplus">+            let today = new Date();</span>
<a href="#l43.170"></a><span id="l43.170"> </span>
<a href="#l43.171"></a><span id="l43.171">             this.mDayMap = {};</span>
<a href="#l43.172"></a><span id="l43.172" class="difflineminus">-            for (var k = 1; k &lt; calbox.childNodes.length; k++) {</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineminus">-                var row = calbox.childNodes[k];</span>
<a href="#l43.174"></a><span id="l43.174" class="difflineplus">+            for (let k = 1; k &lt; calbox.childNodes.length; k++) {</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+                let row = calbox.childNodes[k];</span>
<a href="#l43.176"></a><span id="l43.176"> </span>
<a href="#l43.177"></a><span id="l43.177">                 // Set the week number.</span>
<a href="#l43.178"></a><span id="l43.178">                 let firstElement = row.childNodes[0];</span>
<a href="#l43.179"></a><span id="l43.179">                 setBooleanAttribute(firstElement, &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l43.180"></a><span id="l43.180">                 if (this.mShowWeekNumber) {</span>
<a href="#l43.181"></a><span id="l43.181">                     let weekNumber = cal.getWeekInfoService().getWeekTitle(cal.jsDateToDateTime(date));</span>
<a href="#l43.182"></a><span id="l43.182">                     firstElement.setAttribute(&quot;value&quot;, weekNumber);</span>
<a href="#l43.183"></a><span id="l43.183">                 }</span>
<a href="#l43.184"></a><span id="l43.184"> </span>
<a href="#l43.185"></a><span id="l43.185" class="difflineminus">-                for (var i = 1; i &lt; 8; i++) {</span>
<a href="#l43.186"></a><span id="l43.186" class="difflineminus">-                    var day = row.childNodes[i];</span>
<a href="#l43.187"></a><span id="l43.187" class="difflineminus">-                    var ymd = date.getFullYear() + &quot;-&quot; +</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineplus">+                for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineplus">+                    let day = row.childNodes[i];</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineplus">+                    let ymd = date.getFullYear() + &quot;-&quot; +</span>
<a href="#l43.191"></a><span id="l43.191">                               date.getMonth() + &quot;-&quot; +</span>
<a href="#l43.192"></a><span id="l43.192">                               date.getDate();</span>
<a href="#l43.193"></a><span id="l43.193">                     this.mDayMap[ymd] = day;</span>
<a href="#l43.194"></a><span id="l43.194"> </span>
<a href="#l43.195"></a><span id="l43.195">                     if (!this.mIsReadOnly) {</span>
<a href="#l43.196"></a><span id="l43.196">                         day.setAttribute(&quot;interactive&quot;, &quot;true&quot;);</span>
<a href="#l43.197"></a><span id="l43.197">                     }</span>
<a href="#l43.198"></a><span id="l43.198"> </span>
<a href="#l43.199"></a><span id="l43.199" class="difflineat">@@ -869,17 +869,17 @@</span>
<a href="#l43.200"></a><span id="l43.200"> </span>
<a href="#l43.201"></a><span id="l43.201">                     // highlight today</span>
<a href="#l43.202"></a><span id="l43.202">                     if (this._sameDay(today, date)) {</span>
<a href="#l43.203"></a><span id="l43.203">                         this.mToday = day;</span>
<a href="#l43.204"></a><span id="l43.204">                         day.setAttribute(&quot;today&quot;, &quot;true&quot;);</span>
<a href="#l43.205"></a><span id="l43.205">                     }</span>
<a href="#l43.206"></a><span id="l43.206"> </span>
<a href="#l43.207"></a><span id="l43.207">                     // highlight the current date</span>
<a href="#l43.208"></a><span id="l43.208" class="difflineminus">-                    var val = this.value;</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineplus">+                    let val = this.value;</span>
<a href="#l43.210"></a><span id="l43.210">                     if (this._sameDay(val, date)) {</span>
<a href="#l43.211"></a><span id="l43.211">                         this.mSelected = day;</span>
<a href="#l43.212"></a><span id="l43.212">                         day.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l43.213"></a><span id="l43.213">                     }</span>
<a href="#l43.214"></a><span id="l43.214"> </span>
<a href="#l43.215"></a><span id="l43.215">                     // highlight the extra date</span>
<a href="#l43.216"></a><span id="l43.216">                     if (this._sameDay(this.mExtraDate, date)) {</span>
<a href="#l43.217"></a><span id="l43.217">                         this.mExtra = day;</span>
<a href="#l43.218"></a><span id="l43.218" class="difflineat">@@ -905,17 +905,17 @@</span>
<a href="#l43.219"></a><span id="l43.219">                 this.getItems();</span>
<a href="#l43.220"></a><span id="l43.220">             }</span>
<a href="#l43.221"></a><span id="l43.221">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.222"></a><span id="l43.222">       &lt;/method&gt;</span>
<a href="#l43.223"></a><span id="l43.223">       &lt;!--Attention - duplicate!!!!--&gt;</span>
<a href="#l43.224"></a><span id="l43.224">       &lt;method name=&quot;fireEvent&quot;&gt;</span>
<a href="#l43.225"></a><span id="l43.225">         &lt;parameter name=&quot;aEventName&quot;/&gt;</span>
<a href="#l43.226"></a><span id="l43.226">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineminus">-            var event = document.createEvent('Events');</span>
<a href="#l43.228"></a><span id="l43.228" class="difflineplus">+            let event = document.createEvent('Events');</span>
<a href="#l43.229"></a><span id="l43.229">             event.initEvent(aEventName, true, true);</span>
<a href="#l43.230"></a><span id="l43.230">             this.dispatchEvent(event);</span>
<a href="#l43.231"></a><span id="l43.231">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.232"></a><span id="l43.232">       &lt;/method&gt;</span>
<a href="#l43.233"></a><span id="l43.233"> </span>
<a href="#l43.234"></a><span id="l43.234">       &lt;method name=&quot;getBoxForDate&quot;&gt;</span>
<a href="#l43.235"></a><span id="l43.235">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l43.236"></a><span id="l43.236">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineat">@@ -924,17 +924,17 @@</span>
<a href="#l43.238"></a><span id="l43.238">             return (ymd in this.mDayMap ? this.mDayMap[ymd] : null);</span>
<a href="#l43.239"></a><span id="l43.239">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.240"></a><span id="l43.240">       &lt;/method&gt;</span>
<a href="#l43.241"></a><span id="l43.241"> </span>
<a href="#l43.242"></a><span id="l43.242">       &lt;method name=&quot;resetAttributesForDate&quot;&gt;</span>
<a href="#l43.243"></a><span id="l43.243">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l43.244"></a><span id="l43.244">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.245"></a><span id="l43.245">             function removeForBox(aBox) {</span>
<a href="#l43.246"></a><span id="l43.246" class="difflineminus">-              var allowedAttributes = 0;</span>
<a href="#l43.247"></a><span id="l43.247" class="difflineplus">+              let allowedAttributes = 0;</span>
<a href="#l43.248"></a><span id="l43.248">               while (aBox.attributes.length &gt; allowedAttributes) {</span>
<a href="#l43.249"></a><span id="l43.249">                 switch (aBox.attributes[allowedAttributes].nodeName) {</span>
<a href="#l43.250"></a><span id="l43.250">                   case &quot;selected&quot;:</span>
<a href="#l43.251"></a><span id="l43.251">                   case &quot;othermonth&quot;:</span>
<a href="#l43.252"></a><span id="l43.252">                   case &quot;today&quot;:</span>
<a href="#l43.253"></a><span id="l43.253">                   case &quot;extra&quot;:</span>
<a href="#l43.254"></a><span id="l43.254">                   case &quot;interactive&quot;:</span>
<a href="#l43.255"></a><span id="l43.255">                   case &quot;value&quot;:</span>
<a href="#l43.256"></a><span id="l43.256" class="difflineat">@@ -950,19 +950,19 @@</span>
<a href="#l43.257"></a><span id="l43.257">             }</span>
<a href="#l43.258"></a><span id="l43.258"> </span>
<a href="#l43.259"></a><span id="l43.259">             if (aDate) {</span>
<a href="#l43.260"></a><span id="l43.260">               let box = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l43.261"></a><span id="l43.261">               if (box) {</span>
<a href="#l43.262"></a><span id="l43.262">                   removeForBox(box);</span>
<a href="#l43.263"></a><span id="l43.263">               }</span>
<a href="#l43.264"></a><span id="l43.264">             } else {</span>
<a href="#l43.265"></a><span id="l43.265" class="difflineminus">-              var calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineminus">-              for (var k = 1; k &lt; calbox.childNodes.length; k++) {</span>
<a href="#l43.267"></a><span id="l43.267" class="difflineminus">-                for (var i = 1; i &lt; 8; i++) {</span>
<a href="#l43.268"></a><span id="l43.268" class="difflineplus">+              let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l43.269"></a><span id="l43.269" class="difflineplus">+              for (let k = 1; k &lt; calbox.childNodes.length; k++) {</span>
<a href="#l43.270"></a><span id="l43.270" class="difflineplus">+                for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l43.271"></a><span id="l43.271">                     removeForBox(calbox.childNodes[k].childNodes[i]);</span>
<a href="#l43.272"></a><span id="l43.272">                 }</span>
<a href="#l43.273"></a><span id="l43.273">               }</span>
<a href="#l43.274"></a><span id="l43.274">             }</span>
<a href="#l43.275"></a><span id="l43.275">           ]]&gt;&lt;/body&gt;</span>
<a href="#l43.276"></a><span id="l43.276">       &lt;/method&gt;</span>
<a href="#l43.277"></a><span id="l43.277">       &lt;method name=&quot;_setFreeBusy&quot;&gt;</span>
<a href="#l43.278"></a><span id="l43.278">         &lt;parameter name=&quot;aFreeBusy&quot;/&gt;</span>
<a href="#l43.279"></a><span id="l43.279" class="difflineat">@@ -983,29 +983,29 @@</span>
<a href="#l43.280"></a><span id="l43.280">       &lt;/method&gt;</span>
<a href="#l43.281"></a><span id="l43.281">       &lt;method name=&quot;removeAttribute&quot;&gt;</span>
<a href="#l43.282"></a><span id="l43.282">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l43.283"></a><span id="l43.283">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.284"></a><span id="l43.284">           if (aAttr == &quot;freebusy&quot;) {</span>
<a href="#l43.285"></a><span id="l43.285">               this._setFreeBusy(false);</span>
<a href="#l43.286"></a><span id="l43.286">           }</span>
<a href="#l43.287"></a><span id="l43.287">           // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l43.288"></a><span id="l43.288" class="difflineminus">-          var ret = XULElement.prototype.removeAttribute.call(this, aAttr);</span>
<a href="#l43.289"></a><span id="l43.289" class="difflineplus">+          let ret = XULElement.prototype.removeAttribute.call(this, aAttr);</span>
<a href="#l43.290"></a><span id="l43.290">           return ret;</span>
<a href="#l43.291"></a><span id="l43.291">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.292"></a><span id="l43.292">       &lt;/method&gt;</span>
<a href="#l43.293"></a><span id="l43.293">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l43.294"></a><span id="l43.294">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l43.295"></a><span id="l43.295">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l43.296"></a><span id="l43.296">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.297"></a><span id="l43.297">           if (aAttr == &quot;freebusy&quot;) {</span>
<a href="#l43.298"></a><span id="l43.298">               this._setFreeBusy(aVal == &quot;true&quot;);</span>
<a href="#l43.299"></a><span id="l43.299">           }</span>
<a href="#l43.300"></a><span id="l43.300">           // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l43.301"></a><span id="l43.301" class="difflineminus">-          var ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l43.302"></a><span id="l43.302" class="difflineplus">+          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l43.303"></a><span id="l43.303">           return ret;</span>
<a href="#l43.304"></a><span id="l43.304">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.305"></a><span id="l43.305">       &lt;/method&gt;</span>
<a href="#l43.306"></a><span id="l43.306">       &lt;method name=&quot;getItems&quot;&gt;</span>
<a href="#l43.307"></a><span id="l43.307">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l43.308"></a><span id="l43.308">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.309"></a><span id="l43.309">           // The minimonth automatically clears extra styles on a month change.</span>
<a href="#l43.310"></a><span id="l43.310">           // Therefore we only need to fill the minimonth with new info.</span>
<a href="#l43.311"></a><span id="l43.311" class="difflineat">@@ -1048,52 +1048,52 @@</span>
<a href="#l43.312"></a><span id="l43.312">           }</span>
<a href="#l43.313"></a><span id="l43.313">           this.showMonth(aValue);</span>
<a href="#l43.314"></a><span id="l43.314">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.315"></a><span id="l43.315">       &lt;/method&gt;</span>
<a href="#l43.316"></a><span id="l43.316"> </span>
<a href="#l43.317"></a><span id="l43.317">       &lt;method name=&quot;hidePopupList&quot;&gt;</span>
<a href="#l43.318"></a><span id="l43.318">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.319"></a><span id="l43.319">           if (!this.mIsReadOnly) {</span>
<a href="#l43.320"></a><span id="l43.320" class="difflineminus">-             var header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l43.321"></a><span id="l43.321" class="difflineplus">+             let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l43.322"></a><span id="l43.322">              header.hidePopupList();</span>
<a href="#l43.323"></a><span id="l43.323">           }</span>
<a href="#l43.324"></a><span id="l43.324">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.325"></a><span id="l43.325">       &lt;/method&gt;</span>
<a href="#l43.326"></a><span id="l43.326"> </span>
<a href="#l43.327"></a><span id="l43.327">       &lt;method name=&quot;switchMonth&quot;&gt;</span>
<a href="#l43.328"></a><span id="l43.328">         &lt;parameter name=&quot;aMonth&quot;/&gt;</span>
<a href="#l43.329"></a><span id="l43.329">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.330"></a><span id="l43.330" class="difflineminus">-            var newMonth = new Date(this.mEditorDate);</span>
<a href="#l43.331"></a><span id="l43.331" class="difflineplus">+            let newMonth = new Date(this.mEditorDate);</span>
<a href="#l43.332"></a><span id="l43.332">             newMonth.setMonth(aMonth);</span>
<a href="#l43.333"></a><span id="l43.333">             this.showMonth(newMonth);</span>
<a href="#l43.334"></a><span id="l43.334">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.335"></a><span id="l43.335">       &lt;/method&gt;</span>
<a href="#l43.336"></a><span id="l43.336"> </span>
<a href="#l43.337"></a><span id="l43.337">       &lt;method name=&quot;switchYear&quot;&gt;</span>
<a href="#l43.338"></a><span id="l43.338">         &lt;parameter name=&quot;aYear&quot;/&gt;</span>
<a href="#l43.339"></a><span id="l43.339">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.340"></a><span id="l43.340" class="difflineminus">-            var newMonth = new Date(this.mEditorDate);</span>
<a href="#l43.341"></a><span id="l43.341" class="difflineplus">+            let newMonth = new Date(this.mEditorDate);</span>
<a href="#l43.342"></a><span id="l43.342">             newMonth.setFullYear(aYear);</span>
<a href="#l43.343"></a><span id="l43.343">             this.showMonth(newMonth);</span>
<a href="#l43.344"></a><span id="l43.344">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.345"></a><span id="l43.345">       &lt;/method&gt;</span>
<a href="#l43.346"></a><span id="l43.346"> </span>
<a href="#l43.347"></a><span id="l43.347">       &lt;method name=&quot;selectDate&quot;&gt;</span>
<a href="#l43.348"></a><span id="l43.348">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l43.349"></a><span id="l43.349">         &lt;parameter name=&quot;aMainDate&quot;/&gt;</span>
<a href="#l43.350"></a><span id="l43.350">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.351"></a><span id="l43.351">             if (!aMainDate || (aDate &lt; this._getStartDate(aMainDate) || aDate &gt; this._getEndDate(aMainDate))) {</span>
<a href="#l43.352"></a><span id="l43.352">                 aMainDate = new Date(aDate);</span>
<a href="#l43.353"></a><span id="l43.353">                 aMainDate.setDate(1);</span>
<a href="#l43.354"></a><span id="l43.354">             }</span>
<a href="#l43.355"></a><span id="l43.355">             // note, that aMainDate and this.mEditorDate refer to the first day</span>
<a href="#l43.356"></a><span id="l43.356">             // of the corresponding month</span>
<a href="#l43.357"></a><span id="l43.357" class="difflineminus">-            var sameMonth = this._sameDay(aMainDate, this.mEditorDate);</span>
<a href="#l43.358"></a><span id="l43.358" class="difflineminus">-            var sameDate = this._sameDay(aDate, this.mValue);</span>
<a href="#l43.359"></a><span id="l43.359" class="difflineplus">+            let sameMonth = this._sameDay(aMainDate, this.mEditorDate);</span>
<a href="#l43.360"></a><span id="l43.360" class="difflineplus">+            let sameDate = this._sameDay(aDate, this.mValue);</span>
<a href="#l43.361"></a><span id="l43.361">             if (!sameMonth &amp;&amp; !sameDate) {</span>
<a href="#l43.362"></a><span id="l43.362">                 // change month and select day</span>
<a href="#l43.363"></a><span id="l43.363">                 this.mValue = aDate;</span>
<a href="#l43.364"></a><span id="l43.364">                 this.showMonth(aMainDate);</span>
<a href="#l43.365"></a><span id="l43.365">             } else if (!sameMonth) {</span>
<a href="#l43.366"></a><span id="l43.366">                 // change month only</span>
<a href="#l43.367"></a><span id="l43.367">                 this.showMonth(aMainDate);</span>
<a href="#l43.368"></a><span id="l43.368">             } else if (!sameDate) {</span>
<a href="#l43.369"></a><span id="l43.369" class="difflineat">@@ -1107,29 +1107,29 @@</span>
<a href="#l43.370"></a><span id="l43.370">                 this.mValue = aDate;</span>
<a href="#l43.371"></a><span id="l43.371">             }</span>
<a href="#l43.372"></a><span id="l43.372">          ]]&gt;&lt;/body&gt;</span>
<a href="#l43.373"></a><span id="l43.373">       &lt;/method&gt;</span>
<a href="#l43.374"></a><span id="l43.374"> </span>
<a href="#l43.375"></a><span id="l43.375">       &lt;method name=&quot;_getStartDate&quot;&gt;</span>
<a href="#l43.376"></a><span id="l43.376">         &lt;parameter name=&quot;aMainDate&quot;/&gt;</span>
<a href="#l43.377"></a><span id="l43.377">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.378"></a><span id="l43.378" class="difflineminus">-          var date = new Date(aMainDate);</span>
<a href="#l43.379"></a><span id="l43.379" class="difflineminus">-          var firstWeekday = (7 + aMainDate.getDay() - this.weekStart) % 7;</span>
<a href="#l43.380"></a><span id="l43.380" class="difflineplus">+          let date = new Date(aMainDate);</span>
<a href="#l43.381"></a><span id="l43.381" class="difflineplus">+          let firstWeekday = (7 + aMainDate.getDay() - this.weekStart) % 7;</span>
<a href="#l43.382"></a><span id="l43.382">           date.setDate(date.getDate() - firstWeekday);</span>
<a href="#l43.383"></a><span id="l43.383">           return date;</span>
<a href="#l43.384"></a><span id="l43.384">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.385"></a><span id="l43.385">       &lt;/method&gt;</span>
<a href="#l43.386"></a><span id="l43.386"> </span>
<a href="#l43.387"></a><span id="l43.387">       &lt;method name=&quot;_getEndDate&quot;&gt;</span>
<a href="#l43.388"></a><span id="l43.388">         &lt;parameter name=&quot;aMainDate&quot;/&gt;</span>
<a href="#l43.389"></a><span id="l43.389">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.390"></a><span id="l43.390" class="difflineminus">-          var date = this._getStartDate(aMainDate);</span>
<a href="#l43.391"></a><span id="l43.391" class="difflineminus">-          var calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l43.392"></a><span id="l43.392" class="difflineminus">-          var days = (calbox.childNodes.length - 1) * 7;</span>
<a href="#l43.393"></a><span id="l43.393" class="difflineplus">+          let date = this._getStartDate(aMainDate);</span>
<a href="#l43.394"></a><span id="l43.394" class="difflineplus">+          let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l43.395"></a><span id="l43.395" class="difflineplus">+          let days = (calbox.childNodes.length - 1) * 7;</span>
<a href="#l43.396"></a><span id="l43.396">           date.setDate(date.getDate() + days - 1);</span>
<a href="#l43.397"></a><span id="l43.397">           return date;</span>
<a href="#l43.398"></a><span id="l43.398">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.399"></a><span id="l43.399">       &lt;/method&gt;</span>
<a href="#l43.400"></a><span id="l43.400"> </span>
<a href="#l43.401"></a><span id="l43.401">       &lt;method name=&quot;_sameDay&quot;&gt;</span>
<a href="#l43.402"></a><span id="l43.402">         &lt;parameter name=&quot;aDate1&quot;/&gt;</span>
<a href="#l43.403"></a><span id="l43.403">         &lt;parameter name=&quot;aDate2&quot;/&gt;</span>
<a href="#l43.404"></a><span id="l43.404" class="difflineat">@@ -1141,18 +1141,18 @@</span>
<a href="#l43.405"></a><span id="l43.405">              return true;</span>
<a href="#l43.406"></a><span id="l43.406">           }</span>
<a href="#l43.407"></a><span id="l43.407">           return false;</span>
<a href="#l43.408"></a><span id="l43.408">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.409"></a><span id="l43.409">       &lt;/method&gt;</span>
<a href="#l43.410"></a><span id="l43.410">       &lt;method name=&quot;advanceMonth&quot;&gt;</span>
<a href="#l43.411"></a><span id="l43.411">         &lt;parameter name=&quot;aDir&quot;/&gt;</span>
<a href="#l43.412"></a><span id="l43.412">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l43.413"></a><span id="l43.413" class="difflineminus">-          var advEditorDate = new Date(this.mEditorDate); // at 1st of month</span>
<a href="#l43.414"></a><span id="l43.414" class="difflineminus">-          var advMonth = this.mEditorDate.getMonth() + aDir;</span>
<a href="#l43.415"></a><span id="l43.415" class="difflineplus">+          let advEditorDate = new Date(this.mEditorDate); // at 1st of month</span>
<a href="#l43.416"></a><span id="l43.416" class="difflineplus">+          let advMonth = this.mEditorDate.getMonth() + aDir;</span>
<a href="#l43.417"></a><span id="l43.417">           advEditorDate.setMonth(advMonth);</span>
<a href="#l43.418"></a><span id="l43.418">           this.showMonth(advEditorDate);</span>
<a href="#l43.419"></a><span id="l43.419">         ]]&gt;&lt;/body&gt;</span>
<a href="#l43.420"></a><span id="l43.420">       &lt;/method&gt;</span>
<a href="#l43.421"></a><span id="l43.421">     &lt;/implementation&gt;</span>
<a href="#l43.422"></a><span id="l43.422">     &lt;handlers&gt;</span>
<a href="#l43.423"></a><span id="l43.423">       &lt;handler event=&quot;wheel&quot;&gt;</span>
<a href="#l43.424"></a><span id="l43.424">         &lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -135,17 +135,17 @@ cal.alarms = {</span>
<a href="#l44.4"></a><span id="l44.4">         }</span>
<a href="#l44.5"></a><span id="l44.5"> </span>
<a href="#l44.6"></a><span id="l44.6">         // Fill up the icon box with the alarm icons, show max one icon per</span>
<a href="#l44.7"></a><span id="l44.7">         // alarm type.</span>
<a href="#l44.8"></a><span id="l44.8">         let countIconChildren = aElement.childNodes.length;</span>
<a href="#l44.9"></a><span id="l44.9">         let actionMap = {};</span>
<a href="#l44.10"></a><span id="l44.10">         let i, offset;</span>
<a href="#l44.11"></a><span id="l44.11">         for (i = 0, offset = 0; i &lt; aReminders.length; i++) {</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-            var reminder = aReminders[i];</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+            let reminder = aReminders[i];</span>
<a href="#l44.14"></a><span id="l44.14">             if (reminder.action in actionMap) {</span>
<a href="#l44.15"></a><span id="l44.15">                 // Only show one icon of each type;</span>
<a href="#l44.16"></a><span id="l44.16">                 offset++;</span>
<a href="#l44.17"></a><span id="l44.17">                 continue;</span>
<a href="#l44.18"></a><span id="l44.18">             }</span>
<a href="#l44.19"></a><span id="l44.19">             actionMap[reminder.action] = true;</span>
<a href="#l44.20"></a><span id="l44.20"> </span>
<a href="#l44.21"></a><span id="l44.21">             if (i - offset &gt;= countIconChildren) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -276,17 +276,17 @@ cal.auth.Prompt.prototype = {</span>
<a href="#l45.4"></a><span id="l45.4">      *        the caller should fall back to promptUsernameAndPassword().</span>
<a href="#l45.5"></a><span id="l45.5">      */</span>
<a href="#l45.6"></a><span id="l45.6">     asyncPromptAuth: function capAPA(aChannel,   // nsIChannel</span>
<a href="#l45.7"></a><span id="l45.7">                                      aCallback,  // nsIAuthPromptCallback</span>
<a href="#l45.8"></a><span id="l45.8">                                      aContext,   // nsISupports</span>
<a href="#l45.9"></a><span id="l45.9">                                      aLevel,     // PRUint32</span>
<a href="#l45.10"></a><span id="l45.10">                                      aAuthInfo   // nsIAuthInformation</span>
<a href="#l45.11"></a><span id="l45.11">                                 ) {</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-        var self = this;</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+        let self = this;</span>
<a href="#l45.14"></a><span id="l45.14">         let promptlistener = {</span>
<a href="#l45.15"></a><span id="l45.15">             onPromptStart: function() {</span>
<a href="#l45.16"></a><span id="l45.16">                 res = self.promptAuth(aChannel, aLevel, aAuthInfo);</span>
<a href="#l45.17"></a><span id="l45.17"> </span>
<a href="#l45.18"></a><span id="l45.18">                 if (res) {</span>
<a href="#l45.19"></a><span id="l45.19">                     gAuthCache.setAuthInfo(hostKey, aAuthInfo);</span>
<a href="#l45.20"></a><span id="l45.20">                     this.onPromptAuthAvailable();</span>
<a href="#l45.21"></a><span id="l45.21">                     return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -308,21 +308,21 @@ cal.fromRFC3339 = function fromRFC3339(a</span>
<a href="#l46.4"></a><span id="l46.4">     // XXX I have not covered leapseconds (matches[8]), this might need to</span>
<a href="#l46.5"></a><span id="l46.5">     // be done. The only reference to leap seconds I found is bug 227329.</span>
<a href="#l46.6"></a><span id="l46.6">     //</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8">     // Create a DateTime instance (calUtils.js)</span>
<a href="#l46.9"></a><span id="l46.9">     let dateTime = cal.createDateTime();</span>
<a href="#l46.10"></a><span id="l46.10"> </span>
<a href="#l46.11"></a><span id="l46.11">     // Killer regex to parse RFC3339 dates</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-    var re = new RegExp(&quot;^([0-9]{4})-([0-9]{2})-([0-9]{2})&quot; +</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+    let re = new RegExp(&quot;^([0-9]{4})-([0-9]{2})-([0-9]{2})&quot; +</span>
<a href="#l46.14"></a><span id="l46.14">         &quot;([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]+)?)?&quot; +</span>
<a href="#l46.15"></a><span id="l46.15">         &quot;(([Zz]|([+-])([0-9]{2}):([0-9]{2})))?&quot;);</span>
<a href="#l46.16"></a><span id="l46.16"> </span>
<a href="#l46.17"></a><span id="l46.17" class="difflineminus">-    var matches = re.exec(aStr);</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+    let matches = re.exec(aStr);</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20">     if (!matches) {</span>
<a href="#l46.21"></a><span id="l46.21">         return null;</span>
<a href="#l46.22"></a><span id="l46.22">     }</span>
<a href="#l46.23"></a><span id="l46.23"> </span>
<a href="#l46.24"></a><span id="l46.24">     // Set usual date components</span>
<a href="#l46.25"></a><span id="l46.25">     dateTime.isDate = (matches[4] == null);</span>
<a href="#l46.26"></a><span id="l46.26"> </span>
<a href="#l46.27"></a><span id="l46.27" class="difflineat">@@ -389,23 +389,23 @@ cal.fromRFC3339 = function fromRFC3339(a</span>
<a href="#l46.28"></a><span id="l46.28">  * @param aDateTime     The calIDateTime object</span>
<a href="#l46.29"></a><span id="l46.29">  * @return              The RFC3339 compliant date string</span>
<a href="#l46.30"></a><span id="l46.30">  */</span>
<a href="#l46.31"></a><span id="l46.31"> cal.toRFC3339 = function toRFC3339(aDateTime) {</span>
<a href="#l46.32"></a><span id="l46.32">     if (!aDateTime) {</span>
<a href="#l46.33"></a><span id="l46.33">         return &quot;&quot;;</span>
<a href="#l46.34"></a><span id="l46.34">     }</span>
<a href="#l46.35"></a><span id="l46.35"> </span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-    var full_tzoffset = aDateTime.timezoneOffset;</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-    var tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+    let full_tzoffset = aDateTime.timezoneOffset;</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+    let tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l46.40"></a><span id="l46.40"> </span>
<a href="#l46.41"></a><span id="l46.41" class="difflineminus">-    var tzoffset_mn = ((Math.abs(full_tzoffset) / 3600).toFixed(2) -</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+    let tzoffset_mn = ((Math.abs(full_tzoffset) / 3600).toFixed(2) -</span>
<a href="#l46.43"></a><span id="l46.43">                        tzoffset_hr) * 60;</span>
<a href="#l46.44"></a><span id="l46.44"> </span>
<a href="#l46.45"></a><span id="l46.45" class="difflineminus">-    var str = aDateTime.year + &quot;-&quot; +</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+    let str = aDateTime.year + &quot;-&quot; +</span>
<a href="#l46.47"></a><span id="l46.47">         (&quot;00&quot; + (aDateTime.month + 1)).substr(-2) + &quot;-&quot; +</span>
<a href="#l46.48"></a><span id="l46.48">         (&quot;00&quot; + aDateTime.day).substr(-2);</span>
<a href="#l46.49"></a><span id="l46.49"> </span>
<a href="#l46.50"></a><span id="l46.50">     // Time and Timezone extension</span>
<a href="#l46.51"></a><span id="l46.51">     if (!aDateTime.isDate) {</span>
<a href="#l46.52"></a><span id="l46.52">         str += &quot;T&quot; +</span>
<a href="#l46.53"></a><span id="l46.53">                (&quot;00&quot; + aDateTime.hour).substr(-2) + &quot;:&quot; +</span>
<a href="#l46.54"></a><span id="l46.54">                (&quot;00&quot; + aDateTime.minute).substr(-2) + &quot;:&quot; +</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineat">@@ -460,17 +460,17 @@ cal.ObserverBag.prototype = {</span>
<a href="#l46.56"></a><span id="l46.56">         }</span>
<a href="#l46.57"></a><span id="l46.57">         return this.__proto__.__proto__.notify.apply(this, arguments);</span>
<a href="#l46.58"></a><span id="l46.58">     },</span>
<a href="#l46.59"></a><span id="l46.59"> </span>
<a href="#l46.60"></a><span id="l46.60">     add: function calObserverBag_add(iface) {</span>
<a href="#l46.61"></a><span id="l46.61">         if (this.__proto__.__proto__.add.apply(this, arguments) &amp;&amp; (this.mBatchCount &gt; 0)) {</span>
<a href="#l46.62"></a><span id="l46.62">             // Replay batch notifications, because the onEndBatch notifications are yet to come.</span>
<a href="#l46.63"></a><span id="l46.63">             // We may think about doing the reverse on remove, though I currently see no need:</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineminus">-            for (var i = this.mBatchCount; i--;) {</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+            for (let i = this.mBatchCount; i--;) {</span>
<a href="#l46.66"></a><span id="l46.66">                 iface.onStartBatch();</span>
<a href="#l46.67"></a><span id="l46.67">             }</span>
<a href="#l46.68"></a><span id="l46.68">         }</span>
<a href="#l46.69"></a><span id="l46.69">     }</span>
<a href="#l46.70"></a><span id="l46.70"> };</span>
<a href="#l46.71"></a><span id="l46.71"> </span>
<a href="#l46.72"></a><span id="l46.72"> /**</span>
<a href="#l46.73"></a><span id="l46.73">  * Base prototype to be used implementing a provider.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -368,20 +368,20 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l47.4"></a><span id="l47.4"> /**</span>
<a href="#l47.5"></a><span id="l47.5">  * Split rules into negative and positive rules.</span>
<a href="#l47.6"></a><span id="l47.6">  *</span>
<a href="#l47.7"></a><span id="l47.7">  * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l47.8"></a><span id="l47.8">  * @return                  An array with two elements: an array of positive</span>
<a href="#l47.9"></a><span id="l47.9">  *                            rules and an array of negative rules.</span>
<a href="#l47.10"></a><span id="l47.10">  */</span>
<a href="#l47.11"></a><span id="l47.11"> function splitRecurrenceRules(recurrenceInfo) {</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-    var ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-    var rules = [];</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-    var exceptions = [];</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-    for (var r of ritems) {</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+    let ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+    let rules = [];</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+    let exceptions = [];</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+    for (let r of ritems) {</span>
<a href="#l47.20"></a><span id="l47.20">         if (r.isNegative) {</span>
<a href="#l47.21"></a><span id="l47.21">             exceptions.push(r);</span>
<a href="#l47.22"></a><span id="l47.22">         } else {</span>
<a href="#l47.23"></a><span id="l47.23">             rules.push(r);</span>
<a href="#l47.24"></a><span id="l47.24">         }</span>
<a href="#l47.25"></a><span id="l47.25">     }</span>
<a href="#l47.26"></a><span id="l47.26">     return [rules, exceptions];</span>
<a href="#l47.27"></a><span id="l47.27"> }</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineat">@@ -390,16 +390,16 @@ function splitRecurrenceRules(recurrence</span>
<a href="#l47.29"></a><span id="l47.29">  * Check if a recurrence rule's component is valid.</span>
<a href="#l47.30"></a><span id="l47.30">  *</span>
<a href="#l47.31"></a><span id="l47.31">  * @see                     calIRecurrenceRule</span>
<a href="#l47.32"></a><span id="l47.32">  * @param aRule             The recurrence rule to check.</span>
<a href="#l47.33"></a><span id="l47.33">  * @param aArray            An array of component names to check.</span>
<a href="#l47.34"></a><span id="l47.34">  * @return                  Returns true if the rule is valid.</span>
<a href="#l47.35"></a><span id="l47.35">  */</span>
<a href="#l47.36"></a><span id="l47.36"> function checkRecurrenceRule(aRule, aArray) {</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineminus">-    for (var comp of aArray) {</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-        var ruleComp = aRule.getComponent(comp, {});</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineplus">+    for (let comp of aArray) {</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineplus">+        let ruleComp = aRule.getComponent(comp, {});</span>
<a href="#l47.41"></a><span id="l47.41">         if (ruleComp &amp;&amp; ruleComp.length &gt; 0) {</span>
<a href="#l47.42"></a><span id="l47.42">             return true;</span>
<a href="#l47.43"></a><span id="l47.43">         }</span>
<a href="#l47.44"></a><span id="l47.44">     }</span>
<a href="#l47.45"></a><span id="l47.45">     return false;</span>
<a href="#l47.46"></a><span id="l47.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -634,17 +634,17 @@ var cal = {</span>
<a href="#l48.4"></a><span id="l48.4">     },</span>
<a href="#l48.5"></a><span id="l48.5"> </span>
<a href="#l48.6"></a><span id="l48.6">     nativeTimeOrNow: function cal_nativeTimeOrNow(calDateTime, sortStartedTime) {</span>
<a href="#l48.7"></a><span id="l48.7">         // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l48.8"></a><span id="l48.8">         // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l48.9"></a><span id="l48.9">         if (calDateTime == null) {</span>
<a href="#l48.10"></a><span id="l48.10">             return sortStartedTime.nativeTime;</span>
<a href="#l48.11"></a><span id="l48.11">         }</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-        var ns = calDateTime.nativeTime;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+        let ns = calDateTime.nativeTime;</span>
<a href="#l48.14"></a><span id="l48.14">         if (ns == -62168601600000000) { // ns value for (0000/00/00 00:00:00)</span>
<a href="#l48.15"></a><span id="l48.15">             return sortStartedTime;</span>
<a href="#l48.16"></a><span id="l48.16">         }</span>
<a href="#l48.17"></a><span id="l48.17">         return ns;</span>
<a href="#l48.18"></a><span id="l48.18">     },</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20">     nativeTime: function cal_nativeTime(calDateTime) {</span>
<a href="#l48.21"></a><span id="l48.21">         if (calDateTime == null) {</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineat">@@ -716,17 +716,17 @@ var cal = {</span>
<a href="#l48.23"></a><span id="l48.23">                          .CreateCollation(Services.locale.getApplicationLocale());</span>
<a href="#l48.24"></a><span id="l48.24">      },</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26">     /**</span>
<a href="#l48.27"></a><span id="l48.27">      * Sort an array of strings according to the current locale.</span>
<a href="#l48.28"></a><span id="l48.28">      * Modifies aStringArray, returning it sorted.</span>
<a href="#l48.29"></a><span id="l48.29">      */</span>
<a href="#l48.30"></a><span id="l48.30">     sortArrayByLocaleCollator: function cal_sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineminus">-        var localeCollator = cal.createLocaleCollator();</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+        let localeCollator = cal.createLocaleCollator();</span>
<a href="#l48.33"></a><span id="l48.33">         function compare(a, b) { return localeCollator.compareString(0, a, b); }</span>
<a href="#l48.34"></a><span id="l48.34">         aStringArray.sort(compare);</span>
<a href="#l48.35"></a><span id="l48.35">         return aStringArray;</span>
<a href="#l48.36"></a><span id="l48.36">     },</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38">     /**</span>
<a href="#l48.39"></a><span id="l48.39">      * Gets the month name string in the right form depending on a base string.</span>
<a href="#l48.40"></a><span id="l48.40">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -32,17 +32,17 @@ calAttendee.prototype = {</span>
<a href="#l49.4"></a><span id="l49.4">         }</span>
<a href="#l49.5"></a><span id="l49.5">     },</span>
<a href="#l49.6"></a><span id="l49.6"> </span>
<a href="#l49.7"></a><span id="l49.7">     makeImmutable: function() {</span>
<a href="#l49.8"></a><span id="l49.8">         this.mImmutable = true;</span>
<a href="#l49.9"></a><span id="l49.9">     },</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11">     clone: function() {</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-        var a = new calAttendee();</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+        let a = new calAttendee();</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15">         if (this.mIsOrganizer) {</span>
<a href="#l49.16"></a><span id="l49.16">             a.isOrganizer = true;</span>
<a href="#l49.17"></a><span id="l49.17">         }</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19">         const allProps = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;,</span>
<a href="#l49.20"></a><span id="l49.20">                           &quot;participationStatus&quot;, &quot;userType&quot;];</span>
<a href="#l49.21"></a><span id="l49.21">         for (let prop of allProps) {</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineat">@@ -89,30 +89,30 @@ calAttendee.prototype = {</span>
<a href="#l49.23"></a><span id="l49.23">         for (let [name, value] of cal.ical.paramIterator(icalatt)) {</span>
<a href="#l49.24"></a><span id="l49.24">             if (!promotedProps[name]) {</span>
<a href="#l49.25"></a><span id="l49.25">                 this.setProperty(name, value);</span>
<a href="#l49.26"></a><span id="l49.26">             }</span>
<a href="#l49.27"></a><span id="l49.27">         }</span>
<a href="#l49.28"></a><span id="l49.28">     },</span>
<a href="#l49.29"></a><span id="l49.29"> </span>
<a href="#l49.30"></a><span id="l49.30">     get icalProperty() {</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-        var icssvc = cal.getIcsService();</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-        var icalatt;</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+        let icssvc = cal.getIcsService();</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+        let icalatt;</span>
<a href="#l49.35"></a><span id="l49.35">         if (!this.mIsOrganizer) {</span>
<a href="#l49.36"></a><span id="l49.36">             icalatt = icssvc.createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l49.37"></a><span id="l49.37">         } else {</span>
<a href="#l49.38"></a><span id="l49.38">             icalatt = icssvc.createIcalProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l49.39"></a><span id="l49.39">         }</span>
<a href="#l49.40"></a><span id="l49.40"> </span>
<a href="#l49.41"></a><span id="l49.41">         if (!this.id) {</span>
<a href="#l49.42"></a><span id="l49.42">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l49.43"></a><span id="l49.43">         }</span>
<a href="#l49.44"></a><span id="l49.44">         icalatt.valueAsIcalString = this.id;</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineminus">-        for (var i = 0; i &lt; this.icalAttendeePropMap.length; i++) {</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineminus">-            var prop = this.icalAttendeePropMap[i];</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineplus">+        for (let i = 0; i &lt; this.icalAttendeePropMap.length; i++) {</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+            let prop = this.icalAttendeePropMap[i];</span>
<a href="#l49.49"></a><span id="l49.49">             if (this[prop.cal]) {</span>
<a href="#l49.50"></a><span id="l49.50">                 try {</span>
<a href="#l49.51"></a><span id="l49.51">                     icalatt.setParameter(prop.ics, this[prop.cal]);</span>
<a href="#l49.52"></a><span id="l49.52">                 } catch (e) {</span>
<a href="#l49.53"></a><span id="l49.53">                     if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l49.54"></a><span id="l49.54">                         // Illegal values should be ignored, but we could log them if</span>
<a href="#l49.55"></a><span id="l49.55">                         // the user has enabled logging.</span>
<a href="#l49.56"></a><span id="l49.56">                         cal.LOG(&quot;Warning: Invalid attendee parameter value &quot; + prop.ics + &quot;=&quot; + this[prop.cal]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -70,17 +70,17 @@ calCachedCalendarObserverHelper.prototyp</span>
<a href="#l50.4"></a><span id="l50.4">     onLoad: function(calendar) {</span>
<a href="#l50.5"></a><span id="l50.5">         if (this.isCachedObserver) {</span>
<a href="#l50.6"></a><span id="l50.6">             this.home.mObservers.notify(&quot;onLoad&quot;, [this.home]);</span>
<a href="#l50.7"></a><span id="l50.7">         } else {</span>
<a href="#l50.8"></a><span id="l50.8">             // start sync action after uncached calendar has been loaded.</span>
<a href="#l50.9"></a><span id="l50.9">             // xxx todo, think about:</span>
<a href="#l50.10"></a><span id="l50.10">             // although onAddItem et al have been called, we need to fire</span>
<a href="#l50.11"></a><span id="l50.11">             // an additional onLoad completing the refresh call (-&gt;composite)</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-            var home = this.home;</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+            let home = this.home;</span>
<a href="#l50.14"></a><span id="l50.14">             home.synchronize(function(status) {</span>
<a href="#l50.15"></a><span id="l50.15">                 home.mObservers.notify(&quot;onLoad&quot;, [home]);</span>
<a href="#l50.16"></a><span id="l50.16">             });</span>
<a href="#l50.17"></a><span id="l50.17">         }</span>
<a href="#l50.18"></a><span id="l50.18">     },</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20">     onAddItem: function(aItem) {</span>
<a href="#l50.21"></a><span id="l50.21">         if (this.isCachedObserver) {</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -280,54 +280,54 @@ calCachedCalendar.prototype = {</span>
<a href="#l50.23"></a><span id="l50.23">         };</span>
<a href="#l50.24"></a><span id="l50.24">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_DELETED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l50.25"></a><span id="l50.25">                                       0, null, null, getListener);</span>
<a href="#l50.26"></a><span id="l50.26">     },</span>
<a href="#l50.27"></a><span id="l50.27"> </span>
<a href="#l50.28"></a><span id="l50.28">     mPendingSync: null,</span>
<a href="#l50.29"></a><span id="l50.29">     mSyncQueue: null,</span>
<a href="#l50.30"></a><span id="l50.30">     synchronize: function cCC_synchronize(respFunc) {</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-        var this_ = this;</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+        let this_ = this;</span>
<a href="#l50.33"></a><span id="l50.33">         if (this.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l50.34"></a><span id="l50.34">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l50.35"></a><span id="l50.35">         }</span>
<a href="#l50.36"></a><span id="l50.36"> </span>
<a href="#l50.37"></a><span id="l50.37">         this.mSyncQueue.push(respFunc);</span>
<a href="#l50.38"></a><span id="l50.38">         if (this.mSyncQueue.length &gt; 1) { // don't use mPendingSync here</span>
<a href="#l50.39"></a><span id="l50.39">             cal.LOG(&quot;[calCachedCalendar] sync in action/pending.&quot;);</span>
<a href="#l50.40"></a><span id="l50.40">             return this.mPendingSync;</span>
<a href="#l50.41"></a><span id="l50.41">         }</span>
<a href="#l50.42"></a><span id="l50.42"> </span>
<a href="#l50.43"></a><span id="l50.43">         function emptyQueue(status) {</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineminus">-            var queue = this_.mSyncQueue;</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+            let queue = this_.mSyncQueue;</span>
<a href="#l50.46"></a><span id="l50.46">             this_.mSyncQueue = [];</span>
<a href="#l50.47"></a><span id="l50.47">             function execResponseFunc(func) {</span>
<a href="#l50.48"></a><span id="l50.48">                 try {</span>
<a href="#l50.49"></a><span id="l50.49">                     func(status);</span>
<a href="#l50.50"></a><span id="l50.50">                 } catch (exc) {</span>
<a href="#l50.51"></a><span id="l50.51">                     cal.ASSERT(false, exc);</span>
<a href="#l50.52"></a><span id="l50.52">                 }</span>
<a href="#l50.53"></a><span id="l50.53">             }</span>
<a href="#l50.54"></a><span id="l50.54">             queue.forEach(execResponseFunc);</span>
<a href="#l50.55"></a><span id="l50.55">             cal.LOG(&quot;[calCachedCalendar] sync queue empty.&quot;);</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-            var op = this_.mPendingSync;</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+            let op = this_.mPendingSync;</span>
<a href="#l50.58"></a><span id="l50.58">             this_.mPendingSync = null;</span>
<a href="#l50.59"></a><span id="l50.59">             return op;</span>
<a href="#l50.60"></a><span id="l50.60">         }</span>
<a href="#l50.61"></a><span id="l50.61"> </span>
<a href="#l50.62"></a><span id="l50.62">         if (this.offline) {</span>
<a href="#l50.63"></a><span id="l50.63">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l50.64"></a><span id="l50.64">         }</span>
<a href="#l50.65"></a><span id="l50.65"> </span>
<a href="#l50.66"></a><span id="l50.66">         if (this.supportsChangeLog) {</span>
<a href="#l50.67"></a><span id="l50.67">             cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-            var opListener = {</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+            let opListener = {</span>
<a href="#l50.70"></a><span id="l50.70">                 onResult: function(op, result) {</span>
<a href="#l50.71"></a><span id="l50.71">                     if (!op || !op.isPending) {</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-                        var status = (op ? op.status : Components.results.NS_OK);</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+                        let status = (op ? op.status : Components.results.NS_OK);</span>
<a href="#l50.74"></a><span id="l50.74">                         if (!Components.isSuccessCode(status)) {</span>
<a href="#l50.75"></a><span id="l50.75">                             cal.ERROR(&quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l50.76"></a><span id="l50.76">                                       (op ? op.id : &quot;&lt;unknown&gt;&quot;) + &quot;, uri=&quot; +</span>
<a href="#l50.77"></a><span id="l50.77">                                       this_.uri.spec + &quot;, result=&quot; +</span>
<a href="#l50.78"></a><span id="l50.78">                                       result + &quot;, op=&quot; + op);</span>
<a href="#l50.79"></a><span id="l50.79">                         }</span>
<a href="#l50.80"></a><span id="l50.80">                         cal.LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l50.81"></a><span id="l50.81">                         emptyQueue(status);</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineat">@@ -630,17 +630,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l50.83"></a><span id="l50.83">                 this.downstreamRefresh();</span>
<a href="#l50.84"></a><span id="l50.84">             }</span>
<a href="#l50.85"></a><span id="l50.85">         }</span>
<a href="#l50.86"></a><span id="l50.86">     },</span>
<a href="#l50.87"></a><span id="l50.87">     downstreamRefresh: function() {</span>
<a href="#l50.88"></a><span id="l50.88">         if (this.mUncachedCalendar.canRefresh &amp;&amp; !this.offline) {</span>
<a href="#l50.89"></a><span id="l50.89">             return this.mUncachedCalendar.refresh(); // will trigger synchronize once the calendar is loaded</span>
<a href="#l50.90"></a><span id="l50.90">         } else {</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineminus">-            var this_ = this;</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineplus">+            let this_ = this;</span>
<a href="#l50.93"></a><span id="l50.93">             return this.synchronize(</span>
<a href="#l50.94"></a><span id="l50.94">                 function(status) { // fire completing onLoad for this refresh call</span>
<a href="#l50.95"></a><span id="l50.95">                     this_.mCachedObserver.onLoad(this_.mCachedCalendar);</span>
<a href="#l50.96"></a><span id="l50.96">                 });</span>
<a href="#l50.97"></a><span id="l50.97">         }</span>
<a href="#l50.98"></a><span id="l50.98">     },</span>
<a href="#l50.99"></a><span id="l50.99"> </span>
<a href="#l50.100"></a><span id="l50.100">     addObserver: function(aObserver) {</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineat">@@ -691,24 +691,24 @@ calCachedCalendar.prototype = {</span>
<a href="#l50.102"></a><span id="l50.102">             // If we are offline, don't even try to add the item</span>
<a href="#l50.103"></a><span id="l50.103">             this.adoptOfflineItem(item, listener);</span>
<a href="#l50.104"></a><span id="l50.104">         } else {</span>
<a href="#l50.105"></a><span id="l50.105">             // Otherwise ask the provider to add the item now.</span>
<a href="#l50.106"></a><span id="l50.106">             this.mUncachedCalendar.adoptItem(item, cacheListener);</span>
<a href="#l50.107"></a><span id="l50.107">         }</span>
<a href="#l50.108"></a><span id="l50.108">     },</span>
<a href="#l50.109"></a><span id="l50.109">     adoptOfflineItem: function(item, listener) {</span>
<a href="#l50.110"></a><span id="l50.110" class="difflineminus">-        var this_ = this;</span>
<a href="#l50.111"></a><span id="l50.111" class="difflineminus">-        var opListener = {</span>
<a href="#l50.112"></a><span id="l50.112" class="difflineplus">+        let this_ = this;</span>
<a href="#l50.113"></a><span id="l50.113" class="difflineplus">+        let opListener = {</span>
<a href="#l50.114"></a><span id="l50.114">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l50.115"></a><span id="l50.115">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l50.116"></a><span id="l50.116">             },</span>
<a href="#l50.117"></a><span id="l50.117">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l50.118"></a><span id="l50.118">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineminus">-                    var storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineplus">+                    let storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l50.121"></a><span id="l50.121">                     storage.addOfflineItem(detail, listener);</span>
<a href="#l50.122"></a><span id="l50.122">                 } else if (listener) {</span>
<a href="#l50.123"></a><span id="l50.123">                     listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l50.124"></a><span id="l50.124">                 }</span>
<a href="#l50.125"></a><span id="l50.125">             }</span>
<a href="#l50.126"></a><span id="l50.126">         };</span>
<a href="#l50.127"></a><span id="l50.127">         this.mCachedCalendar.adoptItem(item, opListener);</span>
<a href="#l50.128"></a><span id="l50.128">     },</span>
<a href="#l50.129"></a><span id="l50.129" class="difflineat">@@ -767,26 +767,26 @@ calCachedCalendar.prototype = {</span>
<a href="#l50.130"></a><span id="l50.130">         } else {</span>
<a href="#l50.131"></a><span id="l50.131">             // Otherwise, get the item flags, the listener will further</span>
<a href="#l50.132"></a><span id="l50.132">             // process the item.</span>
<a href="#l50.133"></a><span id="l50.133">             this.mCachedCalendar.getItemOfflineFlag(oldItem, flagListener);</span>
<a href="#l50.134"></a><span id="l50.134">         }</span>
<a href="#l50.135"></a><span id="l50.135">     },</span>
<a href="#l50.136"></a><span id="l50.136"> </span>
<a href="#l50.137"></a><span id="l50.137">     modifyOfflineItem: function(newItem, oldItem, listener) {</span>
<a href="#l50.138"></a><span id="l50.138" class="difflineminus">-        var this_ = this;</span>
<a href="#l50.139"></a><span id="l50.139" class="difflineminus">-        var opListener = {</span>
<a href="#l50.140"></a><span id="l50.140" class="difflineplus">+        let this_ = this;</span>
<a href="#l50.141"></a><span id="l50.141" class="difflineplus">+        let opListener = {</span>
<a href="#l50.142"></a><span id="l50.142">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l50.143"></a><span id="l50.143">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l50.144"></a><span id="l50.144">             },</span>
<a href="#l50.145"></a><span id="l50.145">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l50.146"></a><span id="l50.146">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l50.147"></a><span id="l50.147">                     // Modify the offline item in the storage, passing the</span>
<a href="#l50.148"></a><span id="l50.148">                     // listener will make sure its notified</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineminus">-                    var storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineplus">+                    let storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l50.151"></a><span id="l50.151">                     storage.modifyOfflineItem(detail, listener);</span>
<a href="#l50.152"></a><span id="l50.152">                 } else if (listener) {</span>
<a href="#l50.153"></a><span id="l50.153">                     // If there was not a success, then we need to notify the</span>
<a href="#l50.154"></a><span id="l50.154">                     // listener ourselves</span>
<a href="#l50.155"></a><span id="l50.155">                     listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l50.156"></a><span id="l50.156">                 }</span>
<a href="#l50.157"></a><span id="l50.157">             }</span>
<a href="#l50.158"></a><span id="l50.158">         };</span>
<a href="#l50.159"></a><span id="l50.159" class="difflineat">@@ -818,17 +818,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l50.160"></a><span id="l50.160">         // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l50.161"></a><span id="l50.161">         // But this would mean the uncached provider fires on the passed</span>
<a href="#l50.162"></a><span id="l50.162">         // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l50.163"></a><span id="l50.163">         // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l50.164"></a><span id="l50.164">         // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l50.165"></a><span id="l50.165">         // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l50.166"></a><span id="l50.166">         // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l50.167"></a><span id="l50.167">         // has performed the modification, see below:</span>
<a href="#l50.168"></a><span id="l50.168" class="difflineminus">-        var cacheListener = {</span>
<a href="#l50.169"></a><span id="l50.169" class="difflineplus">+        let cacheListener = {</span>
<a href="#l50.170"></a><span id="l50.170">             onGetResult: function() {},</span>
<a href="#l50.171"></a><span id="l50.171">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l50.172"></a><span id="l50.172">                 if (isUnavailableCode(status)) {</span>
<a href="#l50.173"></a><span id="l50.173">                     // The item couldn't be deleted at the (remote) location,</span>
<a href="#l50.174"></a><span id="l50.174">                     // this is like being offline. Mark the item deleted in the</span>
<a href="#l50.175"></a><span id="l50.175">                     // cache instead.</span>
<a href="#l50.176"></a><span id="l50.176">                     cal.LOG(&quot;[calCachedCalendar] Calendar &quot; + calendar.name + &quot; is unavailable, deleting item offline&quot;);</span>
<a href="#l50.177"></a><span id="l50.177">                     self.deleteOfflineItem(item, listener);</span>
<a href="#l50.178"></a><span id="l50.178" class="difflineat">@@ -856,32 +856,32 @@ calCachedCalendar.prototype = {</span>
<a href="#l50.179"></a><span id="l50.179">         } else {</span>
<a href="#l50.180"></a><span id="l50.180">             // Otherwise, get the item flags, the listener will further</span>
<a href="#l50.181"></a><span id="l50.181">             // process the item.</span>
<a href="#l50.182"></a><span id="l50.182">             this.mCachedCalendar.getItemOfflineFlag(item, flagListener);</span>
<a href="#l50.183"></a><span id="l50.183">         }</span>
<a href="#l50.184"></a><span id="l50.184">     },</span>
<a href="#l50.185"></a><span id="l50.185">     deleteOfflineItem: function(item, listener) {</span>
<a href="#l50.186"></a><span id="l50.186">         /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l50.187"></a><span id="l50.187" class="difflineminus">-        var storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l50.188"></a><span id="l50.188" class="difflineplus">+        let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l50.189"></a><span id="l50.189">         storage.deleteOfflineItem(item, listener);</span>
<a href="#l50.190"></a><span id="l50.190">     }</span>
<a href="#l50.191"></a><span id="l50.191"> };</span>
<a href="#l50.192"></a><span id="l50.192"> (function() {</span>
<a href="#l50.193"></a><span id="l50.193">     function defineForwards(proto, targetName, functions, getters, gettersAndSetters) {</span>
<a href="#l50.194"></a><span id="l50.194">         function defineForwardGetter(attr) {</span>
<a href="#l50.195"></a><span id="l50.195">             proto.__defineGetter__(attr, function() { return this[targetName][attr]; });</span>
<a href="#l50.196"></a><span id="l50.196">         }</span>
<a href="#l50.197"></a><span id="l50.197">         function defineForwardGetterAndSetter(attr) {</span>
<a href="#l50.198"></a><span id="l50.198">             defineForwardGetter(attr);</span>
<a href="#l50.199"></a><span id="l50.199">             proto.__defineSetter__(attr, function(value) { return (this[targetName][attr] = value); });</span>
<a href="#l50.200"></a><span id="l50.200">         }</span>
<a href="#l50.201"></a><span id="l50.201">         function defineForwardFunction(funcName) {</span>
<a href="#l50.202"></a><span id="l50.202">             proto[funcName] = function() {</span>
<a href="#l50.203"></a><span id="l50.203" class="difflineminus">-                var obj = this[targetName];</span>
<a href="#l50.204"></a><span id="l50.204" class="difflineplus">+                let obj = this[targetName];</span>
<a href="#l50.205"></a><span id="l50.205">                 return obj[funcName].apply(obj, arguments);</span>
<a href="#l50.206"></a><span id="l50.206">             };</span>
<a href="#l50.207"></a><span id="l50.207">         }</span>
<a href="#l50.208"></a><span id="l50.208">         functions.forEach(defineForwardFunction);</span>
<a href="#l50.209"></a><span id="l50.209">         getters.forEach(defineForwardGetter);</span>
<a href="#l50.210"></a><span id="l50.210">         gettersAndSetters.forEach(defineForwardGetterAndSetter);</span>
<a href="#l50.211"></a><span id="l50.211">     }</span>
<a href="#l50.212"></a><span id="l50.212"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -209,32 +209,32 @@ calCalendarManager.prototype = {</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5">             db.executeSimpleSQL(&quot;CREATE TABLE cal_calendars_prefs_v6 &quot; +</span>
<a href="#l51.6"></a><span id="l51.6">                                 &quot;(id       INTEGER PRIMARY KEY,&quot; +</span>
<a href="#l51.7"></a><span id="l51.7">                                 &quot; calendar INTEGER,&quot; +</span>
<a href="#l51.8"></a><span id="l51.8">                                 &quot; name     TEXT,&quot; +</span>
<a href="#l51.9"></a><span id="l51.9">                                 &quot; value    TEXT);&quot;);</span>
<a href="#l51.10"></a><span id="l51.10"> </span>
<a href="#l51.11"></a><span id="l51.11">             // Copy in the data.</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-            var calendarCols = [&quot;id&quot;, &quot;type&quot;, &quot;uri&quot;];</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-            var calendarPrefsCols = [&quot;id&quot;, &quot;calendar&quot;, &quot;name&quot;, &quot;value&quot;];</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+            let calendarCols = [&quot;id&quot;, &quot;type&quot;, &quot;uri&quot;];</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+            let calendarPrefsCols = [&quot;id&quot;, &quot;calendar&quot;, &quot;name&quot;, &quot;value&quot;];</span>
<a href="#l51.16"></a><span id="l51.16"> </span>
<a href="#l51.17"></a><span id="l51.17">             db.executeSimpleSQL(&quot;INSERT INTO cal_calendars_v6(&quot; + calendarCols.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l51.18"></a><span id="l51.18">                                 &quot;     SELECT &quot; + calendarCols.join(&quot;,&quot;) +</span>
<a href="#l51.19"></a><span id="l51.19">                                 &quot;       FROM cal_calendars&quot;);</span>
<a href="#l51.20"></a><span id="l51.20"> </span>
<a href="#l51.21"></a><span id="l51.21">             db.executeSimpleSQL(&quot;INSERT INTO cal_calendars_prefs_v6(&quot; + calendarPrefsCols.join(&quot;,&quot;) + &quot;) &quot; +</span>
<a href="#l51.22"></a><span id="l51.22">                                 &quot;     SELECT &quot; + calendarPrefsCols.join(&quot;,&quot;) +</span>
<a href="#l51.23"></a><span id="l51.23">                                 &quot;       FROM cal_calendars_prefs&quot;);</span>
<a href="#l51.24"></a><span id="l51.24"> </span>
<a href="#l51.25"></a><span id="l51.25">             // Delete each old table and rename the new ones to use the</span>
<a href="#l51.26"></a><span id="l51.26">             // old tables' names.</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineminus">-            var tableNames = [&quot;cal_calendars&quot;, &quot;cal_calendars_prefs&quot;];</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+            let tableNames = [&quot;cal_calendars&quot;, &quot;cal_calendars_prefs&quot;];</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30" class="difflineminus">-            for (var i in tableNames) {</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+            for (let i in tableNames) {</span>
<a href="#l51.32"></a><span id="l51.32">                 db.executeSimpleSQL(&quot;DROP TABLE &quot; + tableNames[i] + &quot;;&quot; +</span>
<a href="#l51.33"></a><span id="l51.33">                                     &quot;ALTER TABLE &quot; + tableNames[i] + &quot;_v6 &quot; +</span>
<a href="#l51.34"></a><span id="l51.34">                                     &quot;  RENAME TO &quot; + tableNames[i] + &quot;;&quot;);</span>
<a href="#l51.35"></a><span id="l51.35">             }</span>
<a href="#l51.36"></a><span id="l51.36"> </span>
<a href="#l51.37"></a><span id="l51.37">             oldVersion = 8;</span>
<a href="#l51.38"></a><span id="l51.38">         }</span>
<a href="#l51.39"></a><span id="l51.39"> </span>
<a href="#l51.40"></a><span id="l51.40" class="difflineat">@@ -359,20 +359,20 @@ calCalendarManager.prototype = {</span>
<a href="#l51.41"></a><span id="l51.41">         }</span>
<a href="#l51.42"></a><span id="l51.42">     },</span>
<a href="#l51.43"></a><span id="l51.43"> </span>
<a href="#l51.44"></a><span id="l51.44">     /**</span>
<a href="#l51.45"></a><span id="l51.45">      * @return      db schema version</span>
<a href="#l51.46"></a><span id="l51.46">      * @exception   various, depending on error</span>
<a href="#l51.47"></a><span id="l51.47">      */</span>
<a href="#l51.48"></a><span id="l51.48">     getSchemaVersion: function calMgrGetSchemaVersion(db) {</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineminus">-        var stmt;</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineminus">-        var version = null;</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineplus">+        let stmt;</span>
<a href="#l51.52"></a><span id="l51.52" class="difflineplus">+        let version = null;</span>
<a href="#l51.53"></a><span id="l51.53"> </span>
<a href="#l51.54"></a><span id="l51.54" class="difflineminus">-        var table;</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineplus">+        let table;</span>
<a href="#l51.56"></a><span id="l51.56">         if (db.tableExists(&quot;cal_calmgr_schema_version&quot;)) {</span>
<a href="#l51.57"></a><span id="l51.57">             table = &quot;cal_calmgr_schema_version&quot;;</span>
<a href="#l51.58"></a><span id="l51.58">         } else {</span>
<a href="#l51.59"></a><span id="l51.59">             // Fall back to the old schema table</span>
<a href="#l51.60"></a><span id="l51.60">             table = &quot;cal_calendar_schema_version&quot;;</span>
<a href="#l51.61"></a><span id="l51.61">         }</span>
<a href="#l51.62"></a><span id="l51.62"> </span>
<a href="#l51.63"></a><span id="l51.63">         try {</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineat">@@ -400,29 +400,29 @@ calCalendarManager.prototype = {</span>
<a href="#l51.65"></a><span id="l51.65"> </span>
<a href="#l51.66"></a><span id="l51.66">     //</span>
<a href="#l51.67"></a><span id="l51.67">     // / DB migration code ends here</span>
<a href="#l51.68"></a><span id="l51.68">     //</span>
<a href="#l51.69"></a><span id="l51.69"> </span>
<a href="#l51.70"></a><span id="l51.70">     alertAndQuit: function cmgr_alertAndQuit() {</span>
<a href="#l51.71"></a><span id="l51.71">         // We want to include the extension name in the error message rather</span>
<a href="#l51.72"></a><span id="l51.72">         // than blaming Thunderbird.</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineminus">-        var hostAppName = calGetString(&quot;brand&quot;, &quot;brandShortName&quot;, null, &quot;branding&quot;);</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineminus">-        var calAppName = calGetString(&quot;lightning&quot;, &quot;brandShortName&quot;, null, &quot;lightning&quot;);</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineminus">-        var errorBoxTitle = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l51.76"></a><span id="l51.76" class="difflineminus">-        var errorBoxText = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTextLightning&quot;, [calAppName, hostAppName]);</span>
<a href="#l51.77"></a><span id="l51.77" class="difflineminus">-        var errorBoxButtonLabel = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonRestart&quot;, [hostAppName]);</span>
<a href="#l51.78"></a><span id="l51.78" class="difflineplus">+        let hostAppName = calGetString(&quot;brand&quot;, &quot;brandShortName&quot;, null, &quot;branding&quot;);</span>
<a href="#l51.79"></a><span id="l51.79" class="difflineplus">+        let calAppName = calGetString(&quot;lightning&quot;, &quot;brandShortName&quot;, null, &quot;lightning&quot;);</span>
<a href="#l51.80"></a><span id="l51.80" class="difflineplus">+        let errorBoxTitle = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l51.81"></a><span id="l51.81" class="difflineplus">+        let errorBoxText = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTextLightning&quot;, [calAppName, hostAppName]);</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineplus">+        let errorBoxButtonLabel = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonRestart&quot;, [hostAppName]);</span>
<a href="#l51.83"></a><span id="l51.83"> </span>
<a href="#l51.84"></a><span id="l51.84" class="difflineminus">-        var promptSvc = Services.prompt;</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineplus">+        let promptSvc = Services.prompt;</span>
<a href="#l51.86"></a><span id="l51.86"> </span>
<a href="#l51.87"></a><span id="l51.87" class="difflineminus">-        var errorBoxButtonFlags = (promptSvc.BUTTON_POS_0 *</span>
<a href="#l51.88"></a><span id="l51.88" class="difflineplus">+        let errorBoxButtonFlags = (promptSvc.BUTTON_POS_0 *</span>
<a href="#l51.89"></a><span id="l51.89">                                    promptSvc.BUTTON_TITLE_IS_STRING +</span>
<a href="#l51.90"></a><span id="l51.90">                                    promptSvc.BUTTON_POS_0_DEFAULT);</span>
<a href="#l51.91"></a><span id="l51.91"> </span>
<a href="#l51.92"></a><span id="l51.92" class="difflineminus">-        var choice = promptSvc.confirmEx(null,</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineplus">+        let choice = promptSvc.confirmEx(null,</span>
<a href="#l51.94"></a><span id="l51.94">                                          errorBoxTitle,</span>
<a href="#l51.95"></a><span id="l51.95">                                          errorBoxText,</span>
<a href="#l51.96"></a><span id="l51.96">                                          errorBoxButtonFlags,</span>
<a href="#l51.97"></a><span id="l51.97">                                          errorBoxButtonLabel,</span>
<a href="#l51.98"></a><span id="l51.98">                                          null, // No second button text</span>
<a href="#l51.99"></a><span id="l51.99">                                          null, // No third button text</span>
<a href="#l51.100"></a><span id="l51.100">                                          null, // No checkbox</span>
<a href="#l51.101"></a><span id="l51.101">                                          { value: false }); // Unnecessary checkbox state</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineat">@@ -517,17 +517,17 @@ calCalendarManager.prototype = {</span>
<a href="#l51.103"></a><span id="l51.103"> </span>
<a href="#l51.104"></a><span id="l51.104">         this.notifyObservers(&quot;onCalendarRegistered&quot;, [calendar]);</span>
<a href="#l51.105"></a><span id="l51.105">     },</span>
<a href="#l51.106"></a><span id="l51.106"> </span>
<a href="#l51.107"></a><span id="l51.107">     setupCalendar: function cmgr_setupCalendar(calendar) {</span>
<a href="#l51.108"></a><span id="l51.108">         this.mCache[calendar.id] = calendar;</span>
<a href="#l51.109"></a><span id="l51.109"> </span>
<a href="#l51.110"></a><span id="l51.110">         // Add an observer to track readonly-mode triggers</span>
<a href="#l51.111"></a><span id="l51.111" class="difflineminus">-        var newObserver = new calMgrCalendarObserver(calendar, this);</span>
<a href="#l51.112"></a><span id="l51.112" class="difflineplus">+        let newObserver = new calMgrCalendarObserver(calendar, this);</span>
<a href="#l51.113"></a><span id="l51.113">         calendar.addObserver(newObserver);</span>
<a href="#l51.114"></a><span id="l51.114">         this.mCalObservers[calendar.id] = newObserver;</span>
<a href="#l51.115"></a><span id="l51.115"> </span>
<a href="#l51.116"></a><span id="l51.116">         // Set up statistics</span>
<a href="#l51.117"></a><span id="l51.117">         if (calendar.getProperty(&quot;requiresNetwork&quot;) !== false) {</span>
<a href="#l51.118"></a><span id="l51.118">             this.mNetworkCalendarCount++;</span>
<a href="#l51.119"></a><span id="l51.119">         }</span>
<a href="#l51.120"></a><span id="l51.120">         if (calendar.readOnly) {</span>
<a href="#l51.121"></a><span id="l51.121" class="difflineat">@@ -646,18 +646,18 @@ calCalendarManager.prototype = {</span>
<a href="#l51.122"></a><span id="l51.122">             return this.mCache[aId];</span>
<a href="#l51.123"></a><span id="l51.123">         } else {</span>
<a href="#l51.124"></a><span id="l51.124">             return null;</span>
<a href="#l51.125"></a><span id="l51.125">         }</span>
<a href="#l51.126"></a><span id="l51.126">     },</span>
<a href="#l51.127"></a><span id="l51.127"> </span>
<a href="#l51.128"></a><span id="l51.128">     getCalendars: function cmgr_getCalendars(count) {</span>
<a href="#l51.129"></a><span id="l51.129">         this.assureCache();</span>
<a href="#l51.130"></a><span id="l51.130" class="difflineminus">-        var calendars = [];</span>
<a href="#l51.131"></a><span id="l51.131" class="difflineminus">-        for (var id in this.mCache) {</span>
<a href="#l51.132"></a><span id="l51.132" class="difflineplus">+        let calendars = [];</span>
<a href="#l51.133"></a><span id="l51.133" class="difflineplus">+        for (let id in this.mCache) {</span>
<a href="#l51.134"></a><span id="l51.134">             let calendar = this.mCache[id];</span>
<a href="#l51.135"></a><span id="l51.135">             calendars.push(calendar);</span>
<a href="#l51.136"></a><span id="l51.136">         }</span>
<a href="#l51.137"></a><span id="l51.137">         count.value = calendars.length;</span>
<a href="#l51.138"></a><span id="l51.138">         return calendars;</span>
<a href="#l51.139"></a><span id="l51.139">     },</span>
<a href="#l51.140"></a><span id="l51.140"> </span>
<a href="#l51.141"></a><span id="l51.141">     assureCache: function cmgr_assureCache() {</span>
<a href="#l51.142"></a><span id="l51.142" class="difflineat">@@ -863,17 +863,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l51.143"></a><span id="l51.143">                     initialSortOrderPos = i;</span>
<a href="#l51.144"></a><span id="l51.144">                 }</span>
<a href="#l51.145"></a><span id="l51.145">             }</span>
<a href="#l51.146"></a><span id="l51.146">             // Enabling or disabling cache on a calendar re-creates</span>
<a href="#l51.147"></a><span id="l51.147">             // it so the registerCalendar call can wrap/unwrap the</span>
<a href="#l51.148"></a><span id="l51.148">             // calCachedCalendar facade saving the user the need to</span>
<a href="#l51.149"></a><span id="l51.149">             // restart Thunderbird and making sure a new Id is used.</span>
<a href="#l51.150"></a><span id="l51.150">             this.calMgr.removeCalendar(aCalendar, cICM.REMOVE_NO_DELETE);</span>
<a href="#l51.151"></a><span id="l51.151" class="difflineminus">-            var newCal = this.calMgr.createCalendar(aCalendar.type, aCalendar.uri);</span>
<a href="#l51.152"></a><span id="l51.152" class="difflineplus">+            let newCal = this.calMgr.createCalendar(aCalendar.type, aCalendar.uri);</span>
<a href="#l51.153"></a><span id="l51.153">             newCal.name = aCalendar.name;</span>
<a href="#l51.154"></a><span id="l51.154"> </span>
<a href="#l51.155"></a><span id="l51.155">             // TODO: if properties get added this list will need to be adjusted,</span>
<a href="#l51.156"></a><span id="l51.156">             // ideally we should add a &quot;getProperties&quot; method to calICalendar.idl</span>
<a href="#l51.157"></a><span id="l51.157">             // to retrieve all non-transient properties for a calendar.</span>
<a href="#l51.158"></a><span id="l51.158">             let propsToCopy = [ &quot;color&quot;,</span>
<a href="#l51.159"></a><span id="l51.159">                                 &quot;disabled&quot;,</span>
<a href="#l51.160"></a><span id="l51.160">                                 &quot;auto-enabled&quot;,</span>
<a href="#l51.161"></a><span id="l51.161" class="difflineat">@@ -904,46 +904,46 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l51.162"></a><span id="l51.162">     },</span>
<a href="#l51.163"></a><span id="l51.163"> </span>
<a href="#l51.164"></a><span id="l51.164">     onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l51.165"></a><span id="l51.165">         this.onPropertyChanged(aCalendar, aName, false, true);</span>
<a href="#l51.166"></a><span id="l51.166">     },</span>
<a href="#l51.167"></a><span id="l51.167"> </span>
<a href="#l51.168"></a><span id="l51.168">     // Error announcer specific functions</span>
<a href="#l51.169"></a><span id="l51.169">     announceError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l51.170"></a><span id="l51.170" class="difflineminus">-        var paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+        let paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l51.172"></a><span id="l51.172">                                    .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l51.173"></a><span id="l51.173" class="difflineminus">-        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l51.174"></a><span id="l51.174" class="difflineminus">-        var errMsg;</span>
<a href="#l51.175"></a><span id="l51.175" class="difflineplus">+        let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l51.176"></a><span id="l51.176" class="difflineplus">+        let errMsg;</span>
<a href="#l51.177"></a><span id="l51.177">         paramBlock.SetNumberStrings(3);</span>
<a href="#l51.178"></a><span id="l51.178">         if (!this.storedReadOnly &amp;&amp; this.calendar.readOnly) {</span>
<a href="#l51.179"></a><span id="l51.179">             // Major errors change the calendar to readOnly</span>
<a href="#l51.180"></a><span id="l51.180">             errMsg = props.formatStringFromName(&quot;readOnlyMode&quot;, [this.calendar.name], 1);</span>
<a href="#l51.181"></a><span id="l51.181">         } else if (!this.storedReadOnly &amp;&amp; !this.calendar.readOnly) {</span>
<a href="#l51.182"></a><span id="l51.182">             // Minor errors don't, but still tell the user something went wrong</span>
<a href="#l51.183"></a><span id="l51.183">             errMsg = props.formatStringFromName(&quot;minorError&quot;, [this.calendar.name], 1);</span>
<a href="#l51.184"></a><span id="l51.184">         } else {</span>
<a href="#l51.185"></a><span id="l51.185">             // The calendar was already in readOnly mode, but still tell the user</span>
<a href="#l51.186"></a><span id="l51.186">             errMsg = props.formatStringFromName(&quot;stillReadOnlyError&quot;, [this.calendar.name], 1);</span>
<a href="#l51.187"></a><span id="l51.187">         }</span>
<a href="#l51.188"></a><span id="l51.188"> </span>
<a href="#l51.189"></a><span id="l51.189">         // When possible, change the error number into its name, to</span>
<a href="#l51.190"></a><span id="l51.190">         // make it slightly more readable.</span>
<a href="#l51.191"></a><span id="l51.191" class="difflineminus">-        var errCode = &quot;0x&quot; + aErrNo.toString(16);</span>
<a href="#l51.192"></a><span id="l51.192" class="difflineplus">+        let errCode = &quot;0x&quot; + aErrNo.toString(16);</span>
<a href="#l51.193"></a><span id="l51.193">         const calIErrors = Components.interfaces.calIErrors;</span>
<a href="#l51.194"></a><span id="l51.194">         // Check if it is worth enumerating all the error codes.</span>
<a href="#l51.195"></a><span id="l51.195">         if (aErrNo &amp; calIErrors.ERROR_BASE) {</span>
<a href="#l51.196"></a><span id="l51.196" class="difflineminus">-            for (var err in calIErrors) {</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineplus">+            for (let err in calIErrors) {</span>
<a href="#l51.198"></a><span id="l51.198">                 if (calIErrors[err] == aErrNo) {</span>
<a href="#l51.199"></a><span id="l51.199">                     errCode = err;</span>
<a href="#l51.200"></a><span id="l51.200">                 }</span>
<a href="#l51.201"></a><span id="l51.201">             }</span>
<a href="#l51.202"></a><span id="l51.202">         }</span>
<a href="#l51.203"></a><span id="l51.203"> </span>
<a href="#l51.204"></a><span id="l51.204" class="difflineminus">-        var message;</span>
<a href="#l51.205"></a><span id="l51.205" class="difflineplus">+        let message;</span>
<a href="#l51.206"></a><span id="l51.206">         switch (aErrNo) {</span>
<a href="#l51.207"></a><span id="l51.207">             case calIErrors.CAL_UTF8_DECODING_FAILED:</span>
<a href="#l51.208"></a><span id="l51.208">                 message = props.GetStringFromName(&quot;utf8DecodeError&quot;);</span>
<a href="#l51.209"></a><span id="l51.209">                 break;</span>
<a href="#l51.210"></a><span id="l51.210">             case calIErrors.ICS_MALFORMEDDATA:</span>
<a href="#l51.211"></a><span id="l51.211">                 message = props.GetStringFromName(&quot;icsMalformedError&quot;);</span>
<a href="#l51.212"></a><span id="l51.212">                 break;</span>
<a href="#l51.213"></a><span id="l51.213">             case calIErrors.MODIFICATION_FAILED:</span>
<a href="#l51.214"></a><span id="l51.214" class="difflineat">@@ -953,19 +953,19 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l51.215"></a><span id="l51.215">          }</span>
<a href="#l51.216"></a><span id="l51.216"> </span>
<a href="#l51.217"></a><span id="l51.217"> </span>
<a href="#l51.218"></a><span id="l51.218">         paramBlock.SetString(0, errMsg);</span>
<a href="#l51.219"></a><span id="l51.219">         paramBlock.SetString(1, errCode);</span>
<a href="#l51.220"></a><span id="l51.220">         paramBlock.SetString(2, message);</span>
<a href="#l51.221"></a><span id="l51.221"> </span>
<a href="#l51.222"></a><span id="l51.222">         this.storedReadOnly = this.calendar.readOnly;</span>
<a href="#l51.223"></a><span id="l51.223" class="difflineminus">-        var errorCode = calGetString(&quot;calendar&quot;, &quot;errorCode&quot;, [errCode]);</span>
<a href="#l51.224"></a><span id="l51.224" class="difflineminus">-        var errorDescription = calGetString(&quot;calendar&quot;, &quot;errorDescription&quot;, [message]);</span>
<a href="#l51.225"></a><span id="l51.225" class="difflineminus">-        var summary = errMsg + &quot; &quot; + errorCode + &quot;. &quot; + errorDescription;</span>
<a href="#l51.226"></a><span id="l51.226" class="difflineplus">+        let errorCode = calGetString(&quot;calendar&quot;, &quot;errorCode&quot;, [errCode]);</span>
<a href="#l51.227"></a><span id="l51.227" class="difflineplus">+        let errorDescription = calGetString(&quot;calendar&quot;, &quot;errorDescription&quot;, [message]);</span>
<a href="#l51.228"></a><span id="l51.228" class="difflineplus">+        let summary = errMsg + &quot; &quot; + errorCode + &quot;. &quot; + errorDescription;</span>
<a href="#l51.229"></a><span id="l51.229"> </span>
<a href="#l51.230"></a><span id="l51.230">         // Log warnings in error console.</span>
<a href="#l51.231"></a><span id="l51.231">         // Report serious errors in both error console and in prompt window.</span>
<a href="#l51.232"></a><span id="l51.232">         if (aErrNo == calIErrors.MODIFICATION_FAILED) {</span>
<a href="#l51.233"></a><span id="l51.233">             Components.utils.reportError(summary);</span>
<a href="#l51.234"></a><span id="l51.234">             this.announceParamBlock(paramBlock);</span>
<a href="#l51.235"></a><span id="l51.235">         } else {</span>
<a href="#l51.236"></a><span id="l51.236">             cal.WARN(summary);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -2,29 +2,29 @@</span>
<a href="#l52.4"></a><span id="l52.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l52.5"></a><span id="l52.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.6"></a><span id="l52.6"> </span>
<a href="#l52.7"></a><span id="l52.7"> function calCalendarSearchListener(numOperations, finalListener) {</span>
<a href="#l52.8"></a><span id="l52.8">     this.mFinalListener = finalListener;</span>
<a href="#l52.9"></a><span id="l52.9">     this.mNumOperations = numOperations;</span>
<a href="#l52.10"></a><span id="l52.10">     this.mResults = [];</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    var this_ = this;</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+    let this_ = this;</span>
<a href="#l52.14"></a><span id="l52.14">     function cancelFunc() { // operation group has been cancelled</span>
<a href="#l52.15"></a><span id="l52.15">         this_.notifyResult(null);</span>
<a href="#l52.16"></a><span id="l52.16">     }</span>
<a href="#l52.17"></a><span id="l52.17">     this.opGroup = new calOperationGroup(cancelFunc);</span>
<a href="#l52.18"></a><span id="l52.18"> }</span>
<a href="#l52.19"></a><span id="l52.19"> calCalendarSearchListener.prototype = {</span>
<a href="#l52.20"></a><span id="l52.20">     mFinalListener: null,</span>
<a href="#l52.21"></a><span id="l52.21">     mNumOperations: 0,</span>
<a href="#l52.22"></a><span id="l52.22">     opGroup: null,</span>
<a href="#l52.23"></a><span id="l52.23"> </span>
<a href="#l52.24"></a><span id="l52.24">     notifyResult: function calCalendarSearchListener_notifyResult(result) {</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineminus">-        var listener = this.mFinalListener;</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+        let listener = this.mFinalListener;</span>
<a href="#l52.27"></a><span id="l52.27">         if (listener) {</span>
<a href="#l52.28"></a><span id="l52.28">             if (!this.opGroup.isPending) {</span>
<a href="#l52.29"></a><span id="l52.29">                 this.mFinalListener = null;</span>
<a href="#l52.30"></a><span id="l52.30">             }</span>
<a href="#l52.31"></a><span id="l52.31">             listener.onResult(this.opGroup, result);</span>
<a href="#l52.32"></a><span id="l52.32">         }</span>
<a href="#l52.33"></a><span id="l52.33">     },</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35" class="difflineat">@@ -66,17 +66,17 @@ calCalendarSearchService.prototype = {</span>
<a href="#l52.36"></a><span id="l52.36">         flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l52.37"></a><span id="l52.37">     }),</span>
<a href="#l52.38"></a><span id="l52.38"> </span>
<a href="#l52.39"></a><span id="l52.39">     // calICalendarSearchProvider:</span>
<a href="#l52.40"></a><span id="l52.40">     searchForCalendars: function calCalendarSearchService_searchForCalendars(aString,</span>
<a href="#l52.41"></a><span id="l52.41">                                                                              aHints,</span>
<a href="#l52.42"></a><span id="l52.42">                                                                              aMaxResults,</span>
<a href="#l52.43"></a><span id="l52.43">                                                                              aListener) {</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineminus">-        var groupListener = new calCalendarSearchListener(this.mProviders.size, aListener);</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineplus">+        let groupListener = new calCalendarSearchListener(this.mProviders.size, aListener);</span>
<a href="#l52.46"></a><span id="l52.46">         function searchForCalendars_(provider) {</span>
<a href="#l52.47"></a><span id="l52.47">             try {</span>
<a href="#l52.48"></a><span id="l52.48">                 groupListener.opGroup.add(provider.searchForCalendars(aString,</span>
<a href="#l52.49"></a><span id="l52.49">                                                                       aHints,</span>
<a href="#l52.50"></a><span id="l52.50">                                                                       aMaxResults,</span>
<a href="#l52.51"></a><span id="l52.51">                                                                       groupListener));</span>
<a href="#l52.52"></a><span id="l52.52">             } catch (exc) {</span>
<a href="#l52.53"></a><span id="l52.53">                 Components.utils.reportError(exc);</span>
<a href="#l52.54"></a><span id="l52.54" class="difflineat">@@ -84,17 +84,17 @@ calCalendarSearchService.prototype = {</span>
<a href="#l52.55"></a><span id="l52.55">             }</span>
<a href="#l52.56"></a><span id="l52.56">         }</span>
<a href="#l52.57"></a><span id="l52.57">         this.mProviders.forEach(searchForCalendars_);</span>
<a href="#l52.58"></a><span id="l52.58">         return groupListener.opGroup;</span>
<a href="#l52.59"></a><span id="l52.59">     },</span>
<a href="#l52.60"></a><span id="l52.60"> </span>
<a href="#l52.61"></a><span id="l52.61">     // calICalendarSearchService:</span>
<a href="#l52.62"></a><span id="l52.62">     getProviders: function calCalendarSearchService_getProviders(out_aCount) {</span>
<a href="#l52.63"></a><span id="l52.63" class="difflineminus">-        var ret = this.mProviders.interfaceArray;</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineplus">+        let ret = this.mProviders.interfaceArray;</span>
<a href="#l52.65"></a><span id="l52.65">         out_aCount.value = ret.length;</span>
<a href="#l52.66"></a><span id="l52.66">         return ret;</span>
<a href="#l52.67"></a><span id="l52.67">     },</span>
<a href="#l52.68"></a><span id="l52.68">     addProvider: function calCalendarSearchService_addProvider(aProvider) {</span>
<a href="#l52.69"></a><span id="l52.69">         this.mProviders.add(aProvider);</span>
<a href="#l52.70"></a><span id="l52.70">     },</span>
<a href="#l52.71"></a><span id="l52.71">     removeProvider: function calCalendarSearchService_removeProvider(aProvider) {</span>
<a href="#l52.72"></a><span id="l52.72">         this.mProviders.remove(aProvider);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -17,38 +17,38 @@ function calDateTimeFormatter() {</span>
<a href="#l53.4"></a><span id="l53.4">                   .getService(nsIScriptableDateFormat);</span>
<a href="#l53.5"></a><span id="l53.5"> </span>
<a href="#l53.6"></a><span id="l53.6">     // Do does the month or day come first in this locale?</span>
<a href="#l53.7"></a><span id="l53.7">     this.mMonthFirst = false;</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9">     // If LONG FORMATTED DATE is same as short formatted date,</span>
<a href="#l53.10"></a><span id="l53.10">     // then OS has poor extended/long date config, so use workaround.</span>
<a href="#l53.11"></a><span id="l53.11">     this.mUseLongDateService = true;</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-    var probeDate =</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+    let probeDate =</span>
<a href="#l53.14"></a><span id="l53.14">         Components.classes[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l53.15"></a><span id="l53.15">                   .createInstance(Components.interfaces.calIDateTime);</span>
<a href="#l53.16"></a><span id="l53.16">     probeDate.timezone = UTC();</span>
<a href="#l53.17"></a><span id="l53.17">     probeDate.year = 2002;</span>
<a href="#l53.18"></a><span id="l53.18">     probeDate.month = 3;</span>
<a href="#l53.19"></a><span id="l53.19">     probeDate.day = 5;</span>
<a href="#l53.20"></a><span id="l53.20">     try {</span>
<a href="#l53.21"></a><span id="l53.21">         // We're try/catching the calls to nsScriptableDateFormat since it's</span>
<a href="#l53.22"></a><span id="l53.22">         // outside this module. We're also reusing probeDate rather than</span>
<a href="#l53.23"></a><span id="l53.23">         // creating 3 discrete calDateTimes for performance.</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineminus">-        var probeStringA = this.formatDateShort(probeDate);</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineminus">-        var longProbeString = this.formatDateLong(probeDate);</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+        let probeStringA = this.formatDateShort(probeDate);</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineplus">+        let longProbeString = this.formatDateLong(probeDate);</span>
<a href="#l53.28"></a><span id="l53.28">         probeDate.month = 4;</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineminus">-        var probeStringB = this.formatDateShort(probeDate);</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+        let probeStringB = this.formatDateShort(probeDate);</span>
<a href="#l53.31"></a><span id="l53.31">         probeDate.month = 3;</span>
<a href="#l53.32"></a><span id="l53.32">         probeDate.day = 6;</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-        var probeStringC = this.formatDateShort(probeDate);</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+        let probeStringC = this.formatDateShort(probeDate);</span>
<a href="#l53.35"></a><span id="l53.35"> </span>
<a href="#l53.36"></a><span id="l53.36">         // Compare the index of the first differing character between</span>
<a href="#l53.37"></a><span id="l53.37">         // probeStringA to probeStringB and probeStringA to probeStringC.</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineminus">-        for (var i = 0; i &lt; probeStringA.length; i++) {</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+        for (let i = 0; i &lt; probeStringA.length; i++) {</span>
<a href="#l53.40"></a><span id="l53.40">             if (probeStringA[i] != probeStringB[i]) {</span>
<a href="#l53.41"></a><span id="l53.41">                 this.mMonthFirst = true;</span>
<a href="#l53.42"></a><span id="l53.42">                 break;</span>
<a href="#l53.43"></a><span id="l53.43">             } else if (probeStringA[i] != probeStringC[i]) {</span>
<a href="#l53.44"></a><span id="l53.44">                 this.mMonthFirst = false;</span>
<a href="#l53.45"></a><span id="l53.45">                 break;</span>
<a href="#l53.46"></a><span id="l53.46">             }</span>
<a href="#l53.47"></a><span id="l53.47">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -80,37 +80,37 @@ calEvent.prototype = {</span>
<a href="#l54.4"></a><span id="l54.4">     { cal: &quot;DTSTART&quot;, ics: &quot;startTime&quot; },</span>
<a href="#l54.5"></a><span id="l54.5">     { cal: &quot;DTEND&quot;, ics: &quot;endTime&quot; }],</span>
<a href="#l54.6"></a><span id="l54.6"> </span>
<a href="#l54.7"></a><span id="l54.7">     set icalString(value) {</span>
<a href="#l54.8"></a><span id="l54.8">         this.icalComponent = getIcsService().parseICS(value, null);</span>
<a href="#l54.9"></a><span id="l54.9">     },</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11">     get icalString() {</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-        var calcomp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+        let calcomp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l54.14"></a><span id="l54.14">         calSetProdidVersion(calcomp);</span>
<a href="#l54.15"></a><span id="l54.15">         calcomp.addSubcomponent(this.icalComponent);</span>
<a href="#l54.16"></a><span id="l54.16">         return calcomp.serializeToICS();</span>
<a href="#l54.17"></a><span id="l54.17">     },</span>
<a href="#l54.18"></a><span id="l54.18"> </span>
<a href="#l54.19"></a><span id="l54.19">     get icalComponent() {</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineminus">-        var icssvc = getIcsService();</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineminus">-        var icalcomp = icssvc.createIcalComponent(&quot;VEVENT&quot;);</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+        let icssvc = getIcsService();</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+        let icalcomp = icssvc.createIcalComponent(&quot;VEVENT&quot;);</span>
<a href="#l54.24"></a><span id="l54.24">         this.fillIcalComponentFromBase(icalcomp);</span>
<a href="#l54.25"></a><span id="l54.25">         this.mapPropsToICS(icalcomp, this.icsEventPropMap);</span>
<a href="#l54.26"></a><span id="l54.26"> </span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-        var bagenum = this.propertyEnumerator;</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineplus">+        let bagenum = this.propertyEnumerator;</span>
<a href="#l54.29"></a><span id="l54.29">         while (bagenum.hasMoreElements()) {</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-            var iprop = bagenum.getNext().</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+            let iprop = bagenum.getNext().</span>
<a href="#l54.32"></a><span id="l54.32">                 QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l54.33"></a><span id="l54.33">             try {</span>
<a href="#l54.34"></a><span id="l54.34">                 if (!this.eventPromotedProps[iprop.name]) {</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineminus">-                    var icalprop = icssvc.createIcalProperty(iprop.name);</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+                    let icalprop = icssvc.createIcalProperty(iprop.name);</span>
<a href="#l54.37"></a><span id="l54.37">                     icalprop.value = iprop.value;</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineminus">-                    var propBucket = this.mPropertyParams[iprop.name];</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineplus">+                    let propBucket = this.mPropertyParams[iprop.name];</span>
<a href="#l54.40"></a><span id="l54.40">                     if (propBucket) {</span>
<a href="#l54.41"></a><span id="l54.41">                         for (let paramName in propBucket) {</span>
<a href="#l54.42"></a><span id="l54.42">                             try {</span>
<a href="#l54.43"></a><span id="l54.43">                                 icalprop.setParameter(paramName, propBucket[paramName]);</span>
<a href="#l54.44"></a><span id="l54.44">                             } catch (e) {</span>
<a href="#l54.45"></a><span id="l54.45">                                 if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l54.46"></a><span id="l54.46">                                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l54.47"></a><span id="l54.47">                                     // the user has enabled logging.</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineat">@@ -159,37 +159,37 @@ calEvent.prototype = {</span>
<a href="#l54.49"></a><span id="l54.49">     set startDate(value) {</span>
<a href="#l54.50"></a><span id="l54.50">         this.modify();</span>
<a href="#l54.51"></a><span id="l54.51"> </span>
<a href="#l54.52"></a><span id="l54.52">         // We're about to change the start date of an item which probably</span>
<a href="#l54.53"></a><span id="l54.53">         // could break the associated calIRecurrenceInfo. We're calling</span>
<a href="#l54.54"></a><span id="l54.54">         // the appropriate method here to adjust the internal structure in</span>
<a href="#l54.55"></a><span id="l54.55">         // order to free clients from worrying about such details.</span>
<a href="#l54.56"></a><span id="l54.56">         if (this.parentItem == this) {</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineminus">-            var rec = this.recurrenceInfo;</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+            let rec = this.recurrenceInfo;</span>
<a href="#l54.59"></a><span id="l54.59">             if (rec) {</span>
<a href="#l54.60"></a><span id="l54.60">                 rec.onStartDateChange(value, this.startDate);</span>
<a href="#l54.61"></a><span id="l54.61">             }</span>
<a href="#l54.62"></a><span id="l54.62">         }</span>
<a href="#l54.63"></a><span id="l54.63"> </span>
<a href="#l54.64"></a><span id="l54.64">         return this.setProperty(&quot;DTSTART&quot;, value);</span>
<a href="#l54.65"></a><span id="l54.65">     },</span>
<a href="#l54.66"></a><span id="l54.66"> </span>
<a href="#l54.67"></a><span id="l54.67">     get startDate() {</span>
<a href="#l54.68"></a><span id="l54.68">         return this.getProperty(&quot;DTSTART&quot;);</span>
<a href="#l54.69"></a><span id="l54.69">     },</span>
<a href="#l54.70"></a><span id="l54.70"> </span>
<a href="#l54.71"></a><span id="l54.71">     mEndDate: undefined,</span>
<a href="#l54.72"></a><span id="l54.72">     get endDate() {</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineminus">-        var endDate = this.mEndDate;</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineplus">+        let endDate = this.mEndDate;</span>
<a href="#l54.75"></a><span id="l54.75">         if (endDate === undefined) {</span>
<a href="#l54.76"></a><span id="l54.76">             endDate = this.getProperty(&quot;DTEND&quot;);</span>
<a href="#l54.77"></a><span id="l54.77">             if (!endDate &amp;&amp; this.startDate) {</span>
<a href="#l54.78"></a><span id="l54.78">                 endDate = this.startDate.clone();</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineminus">-                var dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+                let dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l54.81"></a><span id="l54.81">                 if (dur) {</span>
<a href="#l54.82"></a><span id="l54.82">                     // If there is a duration set on the event, calculate the right end time.</span>
<a href="#l54.83"></a><span id="l54.83">                     endDate.addDuration(cal.createDuration(dur));</span>
<a href="#l54.84"></a><span id="l54.84">                 } else {</span>
<a href="#l54.85"></a><span id="l54.85">                     // If the start time is a date-time the event ends on the same calendar</span>
<a href="#l54.86"></a><span id="l54.86">                     // date and time of day. If the start time is a date the events</span>
<a href="#l54.87"></a><span id="l54.87">                     // non-inclusive end is the end of the calendar date.</span>
<a href="#l54.88"></a><span id="l54.88">                     if (endDate.isDate) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/base/src/calFreeBusyService.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/base/src/calFreeBusyService.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -3,31 +3,31 @@</span>
<a href="#l55.4"></a><span id="l55.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.5"></a><span id="l55.5"> </span>
<a href="#l55.6"></a><span id="l55.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l55.7"></a><span id="l55.7"> </span>
<a href="#l55.8"></a><span id="l55.8"> function calFreeBusyListener(numOperations, finalListener) {</span>
<a href="#l55.9"></a><span id="l55.9">     this.mFinalListener = finalListener;</span>
<a href="#l55.10"></a><span id="l55.10">     this.mNumOperations = numOperations;</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-    var this_ = this;</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+    let this_ = this;</span>
<a href="#l55.14"></a><span id="l55.14">     function cancelFunc() { // operation group has been cancelled</span>
<a href="#l55.15"></a><span id="l55.15">         this_.notifyResult(null);</span>
<a href="#l55.16"></a><span id="l55.16">     }</span>
<a href="#l55.17"></a><span id="l55.17">     this.opGroup = new calOperationGroup(cancelFunc);</span>
<a href="#l55.18"></a><span id="l55.18"> }</span>
<a href="#l55.19"></a><span id="l55.19"> calFreeBusyListener.prototype = {</span>
<a href="#l55.20"></a><span id="l55.20">     mFinalListener: null,</span>
<a href="#l55.21"></a><span id="l55.21">     mNumOperations: 0,</span>
<a href="#l55.22"></a><span id="l55.22">     opGroup: null,</span>
<a href="#l55.23"></a><span id="l55.23"> </span>
<a href="#l55.24"></a><span id="l55.24">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIGenericOperationListener]),</span>
<a href="#l55.25"></a><span id="l55.25"> </span>
<a href="#l55.26"></a><span id="l55.26">     notifyResult: function calFreeBusyListener_notifyResult(result) {</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineminus">-        var listener = this.mFinalListener;</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+        let listener = this.mFinalListener;</span>
<a href="#l55.29"></a><span id="l55.29">         if (listener) {</span>
<a href="#l55.30"></a><span id="l55.30">             if (!this.opGroup.isPending) {</span>
<a href="#l55.31"></a><span id="l55.31">                 this.mFinalListener = null;</span>
<a href="#l55.32"></a><span id="l55.32">             }</span>
<a href="#l55.33"></a><span id="l55.33">             listener.onResult(this.opGroup, result);</span>
<a href="#l55.34"></a><span id="l55.34">         }</span>
<a href="#l55.35"></a><span id="l55.35">     },</span>
<a href="#l55.36"></a><span id="l55.36"> </span>
<a href="#l55.37"></a><span id="l55.37" class="difflineat">@@ -74,17 +74,17 @@ calFreeBusyService.prototype = {</span>
<a href="#l55.38"></a><span id="l55.38">     }),</span>
<a href="#l55.39"></a><span id="l55.39"> </span>
<a href="#l55.40"></a><span id="l55.40">     // calIFreeBusyProvider:</span>
<a href="#l55.41"></a><span id="l55.41">     getFreeBusyIntervals: function calFreeBusyService_getFreeBusyIntervals(aCalId,</span>
<a href="#l55.42"></a><span id="l55.42">                                                                            aRangeStart,</span>
<a href="#l55.43"></a><span id="l55.43">                                                                            aRangeEnd,</span>
<a href="#l55.44"></a><span id="l55.44">                                                                            aBusyTypes,</span>
<a href="#l55.45"></a><span id="l55.45">                                                                            aListener) {</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineminus">-        var groupListener = new calFreeBusyListener(this.mProviders.size, aListener);</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+        let groupListener = new calFreeBusyListener(this.mProviders.size, aListener);</span>
<a href="#l55.48"></a><span id="l55.48">         for (let provider of this.mProviders) {</span>
<a href="#l55.49"></a><span id="l55.49">             let operation = provider.getFreeBusyIntervals(aCalId, aRangeStart,</span>
<a href="#l55.50"></a><span id="l55.50">                                                           aRangeEnd,</span>
<a href="#l55.51"></a><span id="l55.51">                                                           aBusyTypes,</span>
<a href="#l55.52"></a><span id="l55.52">                                                           groupListener);</span>
<a href="#l55.53"></a><span id="l55.53">             groupListener.opGroup.add(operation);</span>
<a href="#l55.54"></a><span id="l55.54">         }</span>
<a href="#l55.55"></a><span id="l55.55">         return groupListener.opGroup;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -73,18 +73,18 @@ calItemBase.prototype = {</span>
<a href="#l56.4"></a><span id="l56.4">         }</span>
<a href="#l56.5"></a><span id="l56.5"> </span>
<a href="#l56.6"></a><span id="l56.6">         return aclEntry;</span>
<a href="#l56.7"></a><span id="l56.7">     },</span>
<a href="#l56.8"></a><span id="l56.8"> </span>
<a href="#l56.9"></a><span id="l56.9">     // readonly attribute AUTF8String hashId;</span>
<a href="#l56.10"></a><span id="l56.10">     get hashId() {</span>
<a href="#l56.11"></a><span id="l56.11">         if (this.mHashId === null) {</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-            var rid = this.recurrenceId;</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-            var calendar = this.calendar;</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+            let rid = this.recurrenceId;</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+            let calendar = this.calendar;</span>
<a href="#l56.16"></a><span id="l56.16">             // some unused delim character:</span>
<a href="#l56.17"></a><span id="l56.17">             this.mHashId = [encodeURIComponent(this.id),</span>
<a href="#l56.18"></a><span id="l56.18">                             rid ? rid.getInTimezone(UTC()).icalString : &quot;&quot;,</span>
<a href="#l56.19"></a><span id="l56.19">                             calendar ? encodeURIComponent(calendar.id) : &quot;&quot;].join(&quot;#&quot;);</span>
<a href="#l56.20"></a><span id="l56.20">         }</span>
<a href="#l56.21"></a><span id="l56.21">         return this.mHashId;</span>
<a href="#l56.22"></a><span id="l56.22">     },</span>
<a href="#l56.23"></a><span id="l56.23"> </span>
<a href="#l56.24"></a><span id="l56.24" class="difflineat">@@ -377,30 +377,30 @@ calItemBase.prototype = {</span>
<a href="#l56.25"></a><span id="l56.25">                     return false;</span>
<a href="#l56.26"></a><span id="l56.26">                 },</span>
<a href="#l56.27"></a><span id="l56.27"> </span>
<a href="#l56.28"></a><span id="l56.28">                 getNext: function cib_pe_getNext() {</span>
<a href="#l56.29"></a><span id="l56.29">                     if (!this.hasMoreElements()) { // hasMoreElements is called by intention to skip yet deleted properties</span>
<a href="#l56.30"></a><span id="l56.30">                         cal.ASSERT(false, Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l56.31"></a><span id="l56.31">                         throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l56.32"></a><span id="l56.32">                     }</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineminus">-                    var ret = this.mCurrentProp;</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+                    let ret = this.mCurrentProp;</span>
<a href="#l56.35"></a><span id="l56.35">                     this.mCurrentProp = null;</span>
<a href="#l56.36"></a><span id="l56.36">                     return ret;</span>
<a href="#l56.37"></a><span id="l56.37">                 }</span>
<a href="#l56.38"></a><span id="l56.38">             };</span>
<a href="#l56.39"></a><span id="l56.39">         } else {</span>
<a href="#l56.40"></a><span id="l56.40">             return this.mProperties.enumerator;</span>
<a href="#l56.41"></a><span id="l56.41">         }</span>
<a href="#l56.42"></a><span id="l56.42">     },</span>
<a href="#l56.43"></a><span id="l56.43"> </span>
<a href="#l56.44"></a><span id="l56.44">     // nsIVariant getProperty(in AString name);</span>
<a href="#l56.45"></a><span id="l56.45">     getProperty: function cIB_getProperty(aName) {</span>
<a href="#l56.46"></a><span id="l56.46">         aName = aName.toUpperCase();</span>
<a href="#l56.47"></a><span id="l56.47" class="difflineminus">-        var aValue = this.mProperties.getProperty_(aName);</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineplus">+        let aValue = this.mProperties.getProperty_(aName);</span>
<a href="#l56.49"></a><span id="l56.49">         if (aValue === undefined) {</span>
<a href="#l56.50"></a><span id="l56.50">             aValue = (this.mIsProxy ? this.mParentItem.getProperty(aName) : null);</span>
<a href="#l56.51"></a><span id="l56.51">         }</span>
<a href="#l56.52"></a><span id="l56.52">         return aValue;</span>
<a href="#l56.53"></a><span id="l56.53">     },</span>
<a href="#l56.54"></a><span id="l56.54"> </span>
<a href="#l56.55"></a><span id="l56.55">     // boolean hasProperty(in AString name);</span>
<a href="#l56.56"></a><span id="l56.56">     hasProperty: function cIB_hasProperty(aName) {</span>
<a href="#l56.57"></a><span id="l56.57" class="difflineat">@@ -516,36 +516,36 @@ calItemBase.prototype = {</span>
<a href="#l56.58"></a><span id="l56.58">         } else {</span>
<a href="#l56.59"></a><span id="l56.59">             countObj.value = 0;</span>
<a href="#l56.60"></a><span id="l56.60">             return [];</span>
<a href="#l56.61"></a><span id="l56.61">         }</span>
<a href="#l56.62"></a><span id="l56.62">     },</span>
<a href="#l56.63"></a><span id="l56.63"> </span>
<a href="#l56.64"></a><span id="l56.64">     // calIAttendee getAttendeeById(in AUTF8String id);</span>
<a href="#l56.65"></a><span id="l56.65">     getAttendeeById: function cIB_getAttendeeById(id) {</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineminus">-        var attendees = this.getAttendees({});</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineminus">-        var lowerCaseId = id.toLowerCase();</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineminus">-        for (var attendee of attendees) {</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineplus">+        let attendees = this.getAttendees({});</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineplus">+        let lowerCaseId = id.toLowerCase();</span>
<a href="#l56.71"></a><span id="l56.71" class="difflineplus">+        for (let attendee of attendees) {</span>
<a href="#l56.72"></a><span id="l56.72">             // This match must be case insensitive to deal with differing</span>
<a href="#l56.73"></a><span id="l56.73">             // cases of things like MAILTO:</span>
<a href="#l56.74"></a><span id="l56.74">             if (attendee.id.toLowerCase() == lowerCaseId) {</span>
<a href="#l56.75"></a><span id="l56.75">                 return attendee;</span>
<a href="#l56.76"></a><span id="l56.76">             }</span>
<a href="#l56.77"></a><span id="l56.77">         }</span>
<a href="#l56.78"></a><span id="l56.78">         return null;</span>
<a href="#l56.79"></a><span id="l56.79">     },</span>
<a href="#l56.80"></a><span id="l56.80"> </span>
<a href="#l56.81"></a><span id="l56.81">     // void removeAttendee(in calIAttendee attendee);</span>
<a href="#l56.82"></a><span id="l56.82">     removeAttendee: function cIB_removeAttendee(attendee) {</span>
<a href="#l56.83"></a><span id="l56.83">         this.modify();</span>
<a href="#l56.84"></a><span id="l56.84" class="difflineminus">-        var found = false, newAttendees = [];</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineminus">-        var attendees = this.getAttendees({});</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineminus">-        var attIdLowerCase = attendee.id.toLowerCase();</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineplus">+        let found = false, newAttendees = [];</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineplus">+        let attendees = this.getAttendees({});</span>
<a href="#l56.89"></a><span id="l56.89" class="difflineplus">+        let attIdLowerCase = attendee.id.toLowerCase();</span>
<a href="#l56.90"></a><span id="l56.90"> </span>
<a href="#l56.91"></a><span id="l56.91" class="difflineminus">-        for (var i = 0; i &lt; attendees.length; i++) {</span>
<a href="#l56.92"></a><span id="l56.92" class="difflineplus">+        for (let i = 0; i &lt; attendees.length; i++) {</span>
<a href="#l56.93"></a><span id="l56.93">             if (attendees[i].id.toLowerCase() != attIdLowerCase) {</span>
<a href="#l56.94"></a><span id="l56.94">                 newAttendees.push(attendees[i]);</span>
<a href="#l56.95"></a><span id="l56.95">             } else {</span>
<a href="#l56.96"></a><span id="l56.96">                 found = true;</span>
<a href="#l56.97"></a><span id="l56.97">             }</span>
<a href="#l56.98"></a><span id="l56.98">         }</span>
<a href="#l56.99"></a><span id="l56.99">         if (found) {</span>
<a href="#l56.100"></a><span id="l56.100">             this.mAttendees = newAttendees;</span>
<a href="#l56.101"></a><span id="l56.101" class="difflineat">@@ -607,17 +607,17 @@ calItemBase.prototype = {</span>
<a href="#l56.102"></a><span id="l56.102">             aCount.value = 0;</span>
<a href="#l56.103"></a><span id="l56.103">             return [];</span>
<a href="#l56.104"></a><span id="l56.104">         }</span>
<a href="#l56.105"></a><span id="l56.105">     },</span>
<a href="#l56.106"></a><span id="l56.106"> </span>
<a href="#l56.107"></a><span id="l56.107">     // void removeAttachment(in calIAttachment attachment);</span>
<a href="#l56.108"></a><span id="l56.108">     removeAttachment: function cIB_removeAttachment(aAttachment) {</span>
<a href="#l56.109"></a><span id="l56.109">         this.modify();</span>
<a href="#l56.110"></a><span id="l56.110" class="difflineminus">-        for (var attIndex in this.mAttachments) {</span>
<a href="#l56.111"></a><span id="l56.111" class="difflineplus">+        for (let attIndex in this.mAttachments) {</span>
<a href="#l56.112"></a><span id="l56.112">             if (cal.compareObjects(this.mAttachments[attIndex], aAttachment, Components.interfaces.calIAttachment)) {</span>
<a href="#l56.113"></a><span id="l56.113">                 this.modify();</span>
<a href="#l56.114"></a><span id="l56.114">                 this.mAttachments.splice(attIndex, 1);</span>
<a href="#l56.115"></a><span id="l56.115">                 break;</span>
<a href="#l56.116"></a><span id="l56.116">             }</span>
<a href="#l56.117"></a><span id="l56.117">         }</span>
<a href="#l56.118"></a><span id="l56.118">     },</span>
<a href="#l56.119"></a><span id="l56.119"> </span>
<a href="#l56.120"></a><span id="l56.120" class="difflineat">@@ -649,17 +649,17 @@ calItemBase.prototype = {</span>
<a href="#l56.121"></a><span id="l56.121">             aCount.value = 0;</span>
<a href="#l56.122"></a><span id="l56.122">             return [];</span>
<a href="#l56.123"></a><span id="l56.123">         }</span>
<a href="#l56.124"></a><span id="l56.124">     },</span>
<a href="#l56.125"></a><span id="l56.125"> </span>
<a href="#l56.126"></a><span id="l56.126">     // void removeRelation(in calIRelation relation);</span>
<a href="#l56.127"></a><span id="l56.127">     removeRelation: function cIB_removeRelation(aRelation) {</span>
<a href="#l56.128"></a><span id="l56.128">         this.modify();</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineminus">-        for (var attIndex in this.mRelations) {</span>
<a href="#l56.130"></a><span id="l56.130" class="difflineplus">+        for (let attIndex in this.mRelations) {</span>
<a href="#l56.131"></a><span id="l56.131">             // Could we have the same item as parent and as child ?</span>
<a href="#l56.132"></a><span id="l56.132">             if (this.mRelations[attIndex].relId == aRelation.relId &amp;&amp;</span>
<a href="#l56.133"></a><span id="l56.133">                 this.mRelations[attIndex].relType == aRelation.relType) {</span>
<a href="#l56.134"></a><span id="l56.134">                 this.modify();</span>
<a href="#l56.135"></a><span id="l56.135">                 this.mRelations.splice(attIndex, 1);</span>
<a href="#l56.136"></a><span id="l56.136">                 break;</span>
<a href="#l56.137"></a><span id="l56.137">             }</span>
<a href="#l56.138"></a><span id="l56.138">         }</span>
<a href="#l56.139"></a><span id="l56.139" class="difflineat">@@ -783,37 +783,37 @@ calItemBase.prototype = {</span>
<a href="#l56.140"></a><span id="l56.140">     /**</span>
<a href="#l56.141"></a><span id="l56.141">      * Walks through the propmap and sets all properties on this item from the</span>
<a href="#l56.142"></a><span id="l56.142">      * given icalcomp.</span>
<a href="#l56.143"></a><span id="l56.143">      *</span>
<a href="#l56.144"></a><span id="l56.144">      * @param icalcomp      The calIIcalComponent to read from.</span>
<a href="#l56.145"></a><span id="l56.145">      * @param propmap       The property map to walk through.</span>
<a href="#l56.146"></a><span id="l56.146">      */</span>
<a href="#l56.147"></a><span id="l56.147">     mapPropsFromICS: function cIB_mapPropsFromICS(icalcomp, propmap) {</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineminus">-        for (var i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l56.149"></a><span id="l56.149" class="difflineminus">-            var prop = propmap[i];</span>
<a href="#l56.150"></a><span id="l56.150" class="difflineminus">-            var val = icalcomp[prop.ics];</span>
<a href="#l56.151"></a><span id="l56.151" class="difflineplus">+        for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineplus">+            let prop = propmap[i];</span>
<a href="#l56.153"></a><span id="l56.153" class="difflineplus">+            let val = icalcomp[prop.ics];</span>
<a href="#l56.154"></a><span id="l56.154">             if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l56.155"></a><span id="l56.155">                 this.setProperty(prop.cal, val);</span>
<a href="#l56.156"></a><span id="l56.156">             }</span>
<a href="#l56.157"></a><span id="l56.157">         }</span>
<a href="#l56.158"></a><span id="l56.158">     },</span>
<a href="#l56.159"></a><span id="l56.159"> </span>
<a href="#l56.160"></a><span id="l56.160">     /**</span>
<a href="#l56.161"></a><span id="l56.161">      * Walks through the propmap and sets all properties on the given icalcomp</span>
<a href="#l56.162"></a><span id="l56.162">      * from the properties set on this item.</span>
<a href="#l56.163"></a><span id="l56.163">      * given icalcomp.</span>
<a href="#l56.164"></a><span id="l56.164">      *</span>
<a href="#l56.165"></a><span id="l56.165">      * @param icalcomp      The calIIcalComponent to write to.</span>
<a href="#l56.166"></a><span id="l56.166">      * @param propmap       The property map to walk through.</span>
<a href="#l56.167"></a><span id="l56.167">      */</span>
<a href="#l56.168"></a><span id="l56.168">     mapPropsToICS: function cIB_mapPropsToICS(icalcomp, propmap) {</span>
<a href="#l56.169"></a><span id="l56.169" class="difflineminus">-        for (var i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l56.170"></a><span id="l56.170" class="difflineminus">-            var prop = propmap[i];</span>
<a href="#l56.171"></a><span id="l56.171" class="difflineminus">-            var val = this.getProperty(prop.cal);</span>
<a href="#l56.172"></a><span id="l56.172" class="difflineplus">+        for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l56.173"></a><span id="l56.173" class="difflineplus">+            let prop = propmap[i];</span>
<a href="#l56.174"></a><span id="l56.174" class="difflineplus">+            let val = this.getProperty(prop.cal);</span>
<a href="#l56.175"></a><span id="l56.175">             if (val != null &amp;&amp; val != Components.interfaces.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l56.176"></a><span id="l56.176">                 icalcomp[prop.ics] = val;</span>
<a href="#l56.177"></a><span id="l56.177">             }</span>
<a href="#l56.178"></a><span id="l56.178">         }</span>
<a href="#l56.179"></a><span id="l56.179">     },</span>
<a href="#l56.180"></a><span id="l56.180"> </span>
<a href="#l56.181"></a><span id="l56.181"> </span>
<a href="#l56.182"></a><span id="l56.182">     /**</span>
<a href="#l56.183"></a><span id="l56.183" class="difflineat">@@ -1110,24 +1110,24 @@ makeMemberAttr(calItemBase, &quot;mProperties</span>
<a href="#l56.184"></a><span id="l56.184">  *                        case asProperty is true.</span>
<a href="#l56.185"></a><span id="l56.185">  * @param dflt          The default value in case none is set</span>
<a href="#l56.186"></a><span id="l56.186">  * @param attr          The attribute name to be used</span>
<a href="#l56.187"></a><span id="l56.187">  * @param asProperty    If true, getProperty will be used to get/set the</span>
<a href="#l56.188"></a><span id="l56.188">  *                        member.</span>
<a href="#l56.189"></a><span id="l56.189">  */</span>
<a href="#l56.190"></a><span id="l56.190"> function makeMemberAttr(ctor, varname, dflt, attr, asProperty) {</span>
<a href="#l56.191"></a><span id="l56.191">     // XXX handle defaults!</span>
<a href="#l56.192"></a><span id="l56.192" class="difflineminus">-    var getter = function() {</span>
<a href="#l56.193"></a><span id="l56.193" class="difflineplus">+    let getter = function() {</span>
<a href="#l56.194"></a><span id="l56.194">         if (asProperty) {</span>
<a href="#l56.195"></a><span id="l56.195">             return this.getProperty(varname);</span>
<a href="#l56.196"></a><span id="l56.196">         } else {</span>
<a href="#l56.197"></a><span id="l56.197">             return (varname in this ? this[varname] : undefined);</span>
<a href="#l56.198"></a><span id="l56.198">         }</span>
<a href="#l56.199"></a><span id="l56.199">     };</span>
<a href="#l56.200"></a><span id="l56.200" class="difflineminus">-    var setter = function(v) {</span>
<a href="#l56.201"></a><span id="l56.201" class="difflineplus">+    let setter = function(v) {</span>
<a href="#l56.202"></a><span id="l56.202">         this.modify();</span>
<a href="#l56.203"></a><span id="l56.203">         if (asProperty) {</span>
<a href="#l56.204"></a><span id="l56.204">             return this.setProperty(varname, v);</span>
<a href="#l56.205"></a><span id="l56.205">         } else {</span>
<a href="#l56.206"></a><span id="l56.206">             return (this[varname] = v);</span>
<a href="#l56.207"></a><span id="l56.207">         }</span>
<a href="#l56.208"></a><span id="l56.208">     };</span>
<a href="#l56.209"></a><span id="l56.209">     ctor.prototype.__defineGetter__(attr, getter);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/base/src/calProtocolHandler.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/base/src/calProtocolHandler.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -26,17 +26,17 @@ function calProtocolHandler(scheme) {</span>
<a href="#l57.4"></a><span id="l57.4">     this.wrappedJSObject = this;</span>
<a href="#l57.5"></a><span id="l57.5"> }</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7"> calProtocolHandler.prototype = {</span>
<a href="#l57.8"></a><span id="l57.8">     get defaultPort() { return this.mHttpProtocol.defaultPort; },</span>
<a href="#l57.9"></a><span id="l57.9">     get protocolFlags() { return this.mHttpProtocol.protocolFlags; },</span>
<a href="#l57.10"></a><span id="l57.10"> </span>
<a href="#l57.11"></a><span id="l57.11">     newURI: function cph_newURI(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-        var uri = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+        let uri = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l57.14"></a><span id="l57.14">                              createInstance(Components.interfaces.nsIStandardURL);</span>
<a href="#l57.15"></a><span id="l57.15">         uri.init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l57.16"></a><span id="l57.16">                  this.mHttpProtocol.defaultPort, aSpec, anOriginalCharset, aBaseURI);</span>
<a href="#l57.17"></a><span id="l57.17">         return uri;</span>
<a href="#l57.18"></a><span id="l57.18">     },</span>
<a href="#l57.19"></a><span id="l57.19"> </span>
<a href="#l57.20"></a><span id="l57.20">     newChannel: function cph_newChannel(aUri) {</span>
<a href="#l57.21"></a><span id="l57.21">       return this.newChannel2(aUri, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l58.4"></a><span id="l58.4"> </span>
<a href="#l58.5"></a><span id="l58.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l58.6"></a><span id="l58.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> function getRidKey(dt) {</span>
<a href="#l58.9"></a><span id="l58.9">     if (!dt) {</span>
<a href="#l58.10"></a><span id="l58.10">         return null;</span>
<a href="#l58.11"></a><span id="l58.11">     }</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-    var tz = dt.timezone;</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+    let tz = dt.timezone;</span>
<a href="#l58.14"></a><span id="l58.14">     if (!tz.isUTC &amp;&amp; !tz.isFloating) {</span>
<a href="#l58.15"></a><span id="l58.15">         dt = dt.getInTimezone(UTC());</span>
<a href="#l58.16"></a><span id="l58.16">     }</span>
<a href="#l58.17"></a><span id="l58.17">     return dt.icalString;</span>
<a href="#l58.18"></a><span id="l58.18"> }</span>
<a href="#l58.19"></a><span id="l58.19"> </span>
<a href="#l58.20"></a><span id="l58.20"> function calRecurrenceInfo() {</span>
<a href="#l58.21"></a><span id="l58.21">     this.mRecurrenceItems = [];</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineat">@@ -54,17 +54,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.23"></a><span id="l58.23">         if (this.mImmutable) {</span>
<a href="#l58.24"></a><span id="l58.24">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l58.25"></a><span id="l58.25">         }</span>
<a href="#l58.26"></a><span id="l58.26">     },</span>
<a href="#l58.27"></a><span id="l58.27">     ensureSortedRecurrenceRules: function cRI_ensureSortedRecurrenceRules() {</span>
<a href="#l58.28"></a><span id="l58.28">         if (!this.mPositiveRules || !this.mNegativeRules) {</span>
<a href="#l58.29"></a><span id="l58.29">             this.mPositiveRules = [];</span>
<a href="#l58.30"></a><span id="l58.30">             this.mNegativeRules = [];</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">-            for (var ritem of this.mRecurrenceItems) {</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+            for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l58.33"></a><span id="l58.33">                 if (ritem.isNegative) {</span>
<a href="#l58.34"></a><span id="l58.34">                     this.mNegativeRules.push(ritem);</span>
<a href="#l58.35"></a><span id="l58.35">                 } else {</span>
<a href="#l58.36"></a><span id="l58.36">                     this.mPositiveRules.push(ritem);</span>
<a href="#l58.37"></a><span id="l58.37">                 }</span>
<a href="#l58.38"></a><span id="l58.38">             }</span>
<a href="#l58.39"></a><span id="l58.39">         }</span>
<a href="#l58.40"></a><span id="l58.40">     },</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineat">@@ -92,27 +92,27 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.42"></a><span id="l58.42">                 item.makeImmutable();</span>
<a href="#l58.43"></a><span id="l58.43">             }</span>
<a href="#l58.44"></a><span id="l58.44">         }</span>
<a href="#l58.45"></a><span id="l58.45"> </span>
<a href="#l58.46"></a><span id="l58.46">         this.mImmutable = true;</span>
<a href="#l58.47"></a><span id="l58.47">     },</span>
<a href="#l58.48"></a><span id="l58.48"> </span>
<a href="#l58.49"></a><span id="l58.49">     clone: function cRI_clone() {</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineminus">-        var cloned = new calRecurrenceInfo();</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+        let cloned = new calRecurrenceInfo();</span>
<a href="#l58.52"></a><span id="l58.52">         cloned.mBaseItem = this.mBaseItem;</span>
<a href="#l58.53"></a><span id="l58.53"> </span>
<a href="#l58.54"></a><span id="l58.54" class="difflineminus">-        var clonedItems = [];</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineminus">-        for (var ritem of this.mRecurrenceItems) {</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineplus">+        let clonedItems = [];</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineplus">+        for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l58.58"></a><span id="l58.58">             clonedItems.push(ritem.clone());</span>
<a href="#l58.59"></a><span id="l58.59">         }</span>
<a href="#l58.60"></a><span id="l58.60">         cloned.mRecurrenceItems = clonedItems;</span>
<a href="#l58.61"></a><span id="l58.61"> </span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-        var clonedExceptions = {};</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineminus">-        for (var exitem in this.mExceptionMap) {</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineplus">+        let clonedExceptions = {};</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineplus">+        for (let exitem in this.mExceptionMap) {</span>
<a href="#l58.66"></a><span id="l58.66">             clonedExceptions[exitem] = this.mExceptionMap[exitem].cloneShallow(this.mBaseItem);</span>
<a href="#l58.67"></a><span id="l58.67">         }</span>
<a href="#l58.68"></a><span id="l58.68">         cloned.mExceptionMap = clonedExceptions;</span>
<a href="#l58.69"></a><span id="l58.69"> </span>
<a href="#l58.70"></a><span id="l58.70">         return cloned;</span>
<a href="#l58.71"></a><span id="l58.71">     },</span>
<a href="#l58.72"></a><span id="l58.72"> </span>
<a href="#l58.73"></a><span id="l58.73">     /*</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineat">@@ -206,22 +206,22 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.75"></a><span id="l58.75"> </span>
<a href="#l58.76"></a><span id="l58.76">         this.mRecurrenceItems.splice(aIndex, 1);</span>
<a href="#l58.77"></a><span id="l58.77">     },</span>
<a href="#l58.78"></a><span id="l58.78"> </span>
<a href="#l58.79"></a><span id="l58.79">     deleteRecurrenceItem: function cRI_deleteRecurrenceItem(aItem) {</span>
<a href="#l58.80"></a><span id="l58.80">         // Because xpcom objects can be wrapped in various ways, testing for</span>
<a href="#l58.81"></a><span id="l58.81">         // mere == sometimes returns false even when it should be true.  Use</span>
<a href="#l58.82"></a><span id="l58.82">         // the interface pointer returned by sip to avoid that problem.</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineminus">-        var sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineplus">+        let sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;]</span>
<a href="#l58.85"></a><span id="l58.85">                             .createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l58.86"></a><span id="l58.86">         sip1.data = aItem;</span>
<a href="#l58.87"></a><span id="l58.87">         sip1.dataIID = Components.interfaces.calIRecurrenceItem;</span>
<a href="#l58.88"></a><span id="l58.88"> </span>
<a href="#l58.89"></a><span id="l58.89" class="difflineminus">-        var pos;</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineplus">+        let pos;</span>
<a href="#l58.91"></a><span id="l58.91">         if ((pos = this.mRecurrenceItems.indexOf(sip1.data)) &gt; -1) {</span>
<a href="#l58.92"></a><span id="l58.92">             this.deleteRecurrenceItemAt(pos);</span>
<a href="#l58.93"></a><span id="l58.93">         } else {</span>
<a href="#l58.94"></a><span id="l58.94">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.95"></a><span id="l58.95">         }</span>
<a href="#l58.96"></a><span id="l58.96">     },</span>
<a href="#l58.97"></a><span id="l58.97"> </span>
<a href="#l58.98"></a><span id="l58.98">     insertRecurrenceItemAt: function cRI_insertRecurrenceItemAt(aItem, aIndex) {</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineat">@@ -253,63 +253,63 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.100"></a><span id="l58.100"> </span>
<a href="#l58.101"></a><span id="l58.101">     /*</span>
<a href="#l58.102"></a><span id="l58.102">      * calculations</span>
<a href="#l58.103"></a><span id="l58.103">      */</span>
<a href="#l58.104"></a><span id="l58.104">     getNextOccurrence: function cRI_getNextOccurrence(aTime) {</span>
<a href="#l58.105"></a><span id="l58.105">         this.ensureBaseItem();</span>
<a href="#l58.106"></a><span id="l58.106">         this.ensureSortedRecurrenceRules();</span>
<a href="#l58.107"></a><span id="l58.107"> </span>
<a href="#l58.108"></a><span id="l58.108" class="difflineminus">-        var startDate = this.mBaseItem.recurrenceStartDate;</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineminus">-        var dates = [];</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineplus">+        let startDate = this.mBaseItem.recurrenceStartDate;</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+        let dates = [];</span>
<a href="#l58.112"></a><span id="l58.112"> </span>
<a href="#l58.113"></a><span id="l58.113" class="difflineminus">-        var nextOccurrences = [];</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineminus">-        var invalidOccurrences;</span>
<a href="#l58.115"></a><span id="l58.115" class="difflineminus">-        var negMap = {};</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineminus">-        var minOccRid;</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineplus">+        let nextOccurrences = [];</span>
<a href="#l58.118"></a><span id="l58.118" class="difflineplus">+        let invalidOccurrences;</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineplus">+        let negMap = {};</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineplus">+        let minOccRid;</span>
<a href="#l58.121"></a><span id="l58.121"> </span>
<a href="#l58.122"></a><span id="l58.122">         // Go through all negative rules to create a map of occurrences that</span>
<a href="#l58.123"></a><span id="l58.123">         // should be skipped when going through occurrences.</span>
<a href="#l58.124"></a><span id="l58.124" class="difflineminus">-        for (var ritem of this.mNegativeRules) {</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineplus">+        for (let ritem of this.mNegativeRules) {</span>
<a href="#l58.126"></a><span id="l58.126">             // TODO Infinite rules (i.e EXRULE) are not taken into account,</span>
<a href="#l58.127"></a><span id="l58.127">             // because its very performance hungry and could potentially</span>
<a href="#l58.128"></a><span id="l58.128">             // lead to a deadlock (i.e RRULE is canceled out by an EXRULE).</span>
<a href="#l58.129"></a><span id="l58.129">             // This is ok for now, since EXRULE is deprecated anyway.</span>
<a href="#l58.130"></a><span id="l58.130">             if (ritem.isFinite) {</span>
<a href="#l58.131"></a><span id="l58.131">                 // Get all occurrences starting at our recurrence start date.</span>
<a href="#l58.132"></a><span id="l58.132">                 // This is fine, since there will never be an EXDATE that</span>
<a href="#l58.133"></a><span id="l58.133">                 // occurrs before the event started and its illegal to EXDATE an</span>
<a href="#l58.134"></a><span id="l58.134">                 // RDATE.</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineminus">-                var rdates = ritem.getOccurrences(startDate,</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineplus">+                let rdates = ritem.getOccurrences(startDate,</span>
<a href="#l58.137"></a><span id="l58.137">                                                   startDate,</span>
<a href="#l58.138"></a><span id="l58.138">                                                   null,</span>
<a href="#l58.139"></a><span id="l58.139">                                                   0,</span>
<a href="#l58.140"></a><span id="l58.140">                                                   {});</span>
<a href="#l58.141"></a><span id="l58.141">                 // Map all negative dates.</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineminus">-                for (var r of rdates) {</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineplus">+                for (let r of rdates) {</span>
<a href="#l58.144"></a><span id="l58.144">                     negMap[getRidKey(r)] = true;</span>
<a href="#l58.145"></a><span id="l58.145">                 }</span>
<a href="#l58.146"></a><span id="l58.146">             } else {</span>
<a href="#l58.147"></a><span id="l58.147">                 WARN(&quot;Item '&quot; + this.mBaseItem.title + &quot;'&quot; +</span>
<a href="#l58.148"></a><span id="l58.148">                      (this.mBaseItem.calendar ? &quot; (&quot; + this.mBaseItem.calendar.name + &quot;)&quot; : &quot;&quot;) +</span>
<a href="#l58.149"></a><span id="l58.149">                      &quot; has an infinite negative rule (EXRULE)&quot;);</span>
<a href="#l58.150"></a><span id="l58.150">             }</span>
<a href="#l58.151"></a><span id="l58.151">         }</span>
<a href="#l58.152"></a><span id="l58.152"> </span>
<a href="#l58.153"></a><span id="l58.153" class="difflineminus">-        var bailCounter = 0;</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineplus">+        let bailCounter = 0;</span>
<a href="#l58.155"></a><span id="l58.155">         do {</span>
<a href="#l58.156"></a><span id="l58.156">             invalidOccurrences = 0;</span>
<a href="#l58.157"></a><span id="l58.157">             // Go through all positive rules and get the next recurrence id</span>
<a href="#l58.158"></a><span id="l58.158">             // according to that rule. If for all rules the rid is &quot;invalid&quot;,</span>
<a href="#l58.159"></a><span id="l58.159">             // (i.e an EXDATE removed it, or an exception moved it somewhere</span>
<a href="#l58.160"></a><span id="l58.160">             // else), then get the respective next rid.</span>
<a href="#l58.161"></a><span id="l58.161">             //</span>
<a href="#l58.162"></a><span id="l58.162">             // If in a loop at least one rid is valid (i.e not an exception, not</span>
<a href="#l58.163"></a><span id="l58.163">             // an exdate, is after aTime), then remember the lowest one.</span>
<a href="#l58.164"></a><span id="l58.164" class="difflineminus">-            for (var i = 0; i &lt; this.mPositiveRules.length; i++) {</span>
<a href="#l58.165"></a><span id="l58.165" class="difflineplus">+            for (let i = 0; i &lt; this.mPositiveRules.length; i++) {</span>
<a href="#l58.166"></a><span id="l58.166">                 let rDateInstance = cal.wrapInstance(this.mPositiveRules[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l58.167"></a><span id="l58.167">                 let rRuleInstance = cal.wrapInstance(this.mPositiveRules[i], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l58.168"></a><span id="l58.168">                 if (rDateInstance) {</span>
<a href="#l58.169"></a><span id="l58.169">                     // RDATEs are special. there is only one date in this rule,</span>
<a href="#l58.170"></a><span id="l58.170">                     // so no need to search anything.</span>
<a href="#l58.171"></a><span id="l58.171">                     let rdate = rDateInstance.date;</span>
<a href="#l58.172"></a><span id="l58.172">                     if (!nextOccurrences[i] &amp;&amp; rdate.compare(aTime) &gt; 0) {</span>
<a href="#l58.173"></a><span id="l58.173">                         // The RDATE falls into range, save it.</span>
<a href="#l58.174"></a><span id="l58.174" class="difflineat">@@ -320,23 +320,23 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.175"></a><span id="l58.175">                         nextOccurrences[i] = null;</span>
<a href="#l58.176"></a><span id="l58.176">                         invalidOccurrences++;</span>
<a href="#l58.177"></a><span id="l58.177">                     }</span>
<a href="#l58.178"></a><span id="l58.178">                 } else if (rRuleInstance) {</span>
<a href="#l58.179"></a><span id="l58.179">                     // RRULEs must not start searching before |startDate|, since</span>
<a href="#l58.180"></a><span id="l58.180">                     // the pattern is only valid afterwards. If an occurrence</span>
<a href="#l58.181"></a><span id="l58.181">                     // was found in a previous round, we can go ahead and start</span>
<a href="#l58.182"></a><span id="l58.182">                     // searching from that occurrence.</span>
<a href="#l58.183"></a><span id="l58.183" class="difflineminus">-                    var searchStart = nextOccurrences[i] || startDate;</span>
<a href="#l58.184"></a><span id="l58.184" class="difflineplus">+                    let searchStart = nextOccurrences[i] || startDate;</span>
<a href="#l58.185"></a><span id="l58.185"> </span>
<a href="#l58.186"></a><span id="l58.186">                     // Search for the next occurrence after aTime. If the last</span>
<a href="#l58.187"></a><span id="l58.187">                     // round was invalid, then in this round we need to search</span>
<a href="#l58.188"></a><span id="l58.188">                     // after nextOccurrences[i] to make sure getNextOccurrence()</span>
<a href="#l58.189"></a><span id="l58.189">                     // doesn't find the same occurrence again.</span>
<a href="#l58.190"></a><span id="l58.190" class="difflineminus">-                    var searchDate =</span>
<a href="#l58.191"></a><span id="l58.191" class="difflineplus">+                    let searchDate =</span>
<a href="#l58.192"></a><span id="l58.192">                         (nextOccurrences[i] &amp;&amp; nextOccurrences[i].compare(aTime) &gt; 0 ?</span>
<a href="#l58.193"></a><span id="l58.193">                             nextOccurrences[i] :</span>
<a href="#l58.194"></a><span id="l58.194">                             aTime);</span>
<a href="#l58.195"></a><span id="l58.195"> </span>
<a href="#l58.196"></a><span id="l58.196">                     nextOccurrences[i] = rRuleInstance</span>
<a href="#l58.197"></a><span id="l58.197">                                              .getNextOccurrence(searchStart, searchDate);</span>
<a href="#l58.198"></a><span id="l58.198">                 }</span>
<a href="#l58.199"></a><span id="l58.199"> </span>
<a href="#l58.200"></a><span id="l58.200" class="difflineat">@@ -374,23 +374,23 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.201"></a><span id="l58.201">             // We counted how many positive rules found out that their next</span>
<a href="#l58.202"></a><span id="l58.202">             // candidate is invalid. If all rules produce invalid next</span>
<a href="#l58.203"></a><span id="l58.203">             // occurrences, a second round is needed.</span>
<a href="#l58.204"></a><span id="l58.204">         } while (invalidOccurrences == this.mPositiveRules.length);</span>
<a href="#l58.205"></a><span id="l58.205"> </span>
<a href="#l58.206"></a><span id="l58.206">         // Since we need to compare occurrences by date, save the rid found</span>
<a href="#l58.207"></a><span id="l58.207">         // above also as a date. This works out because above we skipped</span>
<a href="#l58.208"></a><span id="l58.208">         // exceptions.</span>
<a href="#l58.209"></a><span id="l58.209" class="difflineminus">-        var minOccDate = minOccRid;</span>
<a href="#l58.210"></a><span id="l58.210" class="difflineplus">+        let minOccDate = minOccRid;</span>
<a href="#l58.211"></a><span id="l58.211"> </span>
<a href="#l58.212"></a><span id="l58.212">         // Scan exceptions for any dates earlier than the above found</span>
<a href="#l58.213"></a><span id="l58.213">         // minOccDate, but still after aTime.</span>
<a href="#l58.214"></a><span id="l58.214" class="difflineminus">-        for (var ex in this.mExceptionMap) {</span>
<a href="#l58.215"></a><span id="l58.215" class="difflineplus">+        for (let ex in this.mExceptionMap) {</span>
<a href="#l58.216"></a><span id="l58.216">             let exc = this.mExceptionMap[ex];</span>
<a href="#l58.217"></a><span id="l58.217" class="difflineminus">-            var start = exc.recurrenceStartDate;</span>
<a href="#l58.218"></a><span id="l58.218" class="difflineplus">+            let start = exc.recurrenceStartDate;</span>
<a href="#l58.219"></a><span id="l58.219">             if (start.compare(aTime) &gt; 0 &amp;&amp;</span>
<a href="#l58.220"></a><span id="l58.220">                 (!minOccDate || start.compare(minOccDate) &lt;= 0)) {</span>
<a href="#l58.221"></a><span id="l58.221">                 // This exception is earlier, save its rid (for getting the</span>
<a href="#l58.222"></a><span id="l58.222">                 // occurrence later on) and its date (for comparing to other</span>
<a href="#l58.223"></a><span id="l58.223">                 // exceptions).</span>
<a href="#l58.224"></a><span id="l58.224">                 minOccRid = exc.recurrenceId;</span>
<a href="#l58.225"></a><span id="l58.225">                 minOccDate = start;</span>
<a href="#l58.226"></a><span id="l58.226">             }</span>
<a href="#l58.227"></a><span id="l58.227" class="difflineat">@@ -405,20 +405,20 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.228"></a><span id="l58.228">         // TODO libical currently does not provide us with easy means of</span>
<a href="#l58.229"></a><span id="l58.229">         // getting the previous occurrence. This could be fixed to improve</span>
<a href="#l58.230"></a><span id="l58.230">         // performance greatly. Filed as libical feature request 1944020.</span>
<a href="#l58.231"></a><span id="l58.231"> </span>
<a href="#l58.232"></a><span id="l58.232">         // HACK We never know how early an RDATE might be before the actual</span>
<a href="#l58.233"></a><span id="l58.233">         // recurrence start. Since rangeStart cannot be null for recurrence</span>
<a href="#l58.234"></a><span id="l58.234">         // items like calIRecurrenceRule, we need to work around by supplying a</span>
<a href="#l58.235"></a><span id="l58.235">         // very early date. Again, this might have a high performance penalty.</span>
<a href="#l58.236"></a><span id="l58.236" class="difflineminus">-        var early = createDateTime();</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineplus">+        let early = createDateTime();</span>
<a href="#l58.238"></a><span id="l58.238">         early.icalString = &quot;00000101T000000Z&quot;;</span>
<a href="#l58.239"></a><span id="l58.239"> </span>
<a href="#l58.240"></a><span id="l58.240" class="difflineminus">-        var rids = this.calculateDates(early,</span>
<a href="#l58.241"></a><span id="l58.241" class="difflineplus">+        let rids = this.calculateDates(early,</span>
<a href="#l58.242"></a><span id="l58.242">                                        aTime,</span>
<a href="#l58.243"></a><span id="l58.243">                                        0);</span>
<a href="#l58.244"></a><span id="l58.244">         // The returned dates are sorted, so the last one is a good</span>
<a href="#l58.245"></a><span id="l58.245">         // candidate, if it exists.</span>
<a href="#l58.246"></a><span id="l58.246">         return (rids.length &gt; 0 ? this.getOccurrenceFor(rids[rids.length - 1].id) : null);</span>
<a href="#l58.247"></a><span id="l58.247">     },</span>
<a href="#l58.248"></a><span id="l58.248"> </span>
<a href="#l58.249"></a><span id="l58.249">     // internal helper function;</span>
<a href="#l58.250"></a><span id="l58.250" class="difflineat">@@ -428,67 +428,67 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.251"></a><span id="l58.251">         this.ensureBaseItem();</span>
<a href="#l58.252"></a><span id="l58.252">         this.ensureSortedRecurrenceRules();</span>
<a href="#l58.253"></a><span id="l58.253"> </span>
<a href="#l58.254"></a><span id="l58.254">         function ridDateSortComptor(a, b) {</span>
<a href="#l58.255"></a><span id="l58.255">             return a.rstart.compare(b.rstart);</span>
<a href="#l58.256"></a><span id="l58.256">         }</span>
<a href="#l58.257"></a><span id="l58.257"> </span>
<a href="#l58.258"></a><span id="l58.258">         // workaround for UTC- timezones</span>
<a href="#l58.259"></a><span id="l58.259" class="difflineminus">-        var rangeStart = ensureDateTime(aRangeStart);</span>
<a href="#l58.260"></a><span id="l58.260" class="difflineminus">-        var rangeEnd = ensureDateTime(aRangeEnd);</span>
<a href="#l58.261"></a><span id="l58.261" class="difflineplus">+        let rangeStart = ensureDateTime(aRangeStart);</span>
<a href="#l58.262"></a><span id="l58.262" class="difflineplus">+        let rangeEnd = ensureDateTime(aRangeEnd);</span>
<a href="#l58.263"></a><span id="l58.263"> </span>
<a href="#l58.264"></a><span id="l58.264">         // If aRangeStart falls in the middle of an occurrence, libical will</span>
<a href="#l58.265"></a><span id="l58.265">         // not return that occurrence when we go and ask for an</span>
<a href="#l58.266"></a><span id="l58.266">         // icalrecur_iterator_new.  This actually seems fairly rational, so</span>
<a href="#l58.267"></a><span id="l58.267">         // instead of hacking libical, I'm going to move aRangeStart back far</span>
<a href="#l58.268"></a><span id="l58.268">         // enough to make sure we get the occurrences we might miss.</span>
<a href="#l58.269"></a><span id="l58.269" class="difflineminus">-        var searchStart = rangeStart.clone();</span>
<a href="#l58.270"></a><span id="l58.270" class="difflineminus">-        var baseDuration = this.mBaseItem.duration;</span>
<a href="#l58.271"></a><span id="l58.271" class="difflineplus">+        let searchStart = rangeStart.clone();</span>
<a href="#l58.272"></a><span id="l58.272" class="difflineplus">+        let baseDuration = this.mBaseItem.duration;</span>
<a href="#l58.273"></a><span id="l58.273">         if (baseDuration) {</span>
<a href="#l58.274"></a><span id="l58.274" class="difflineminus">-            var duration = baseDuration.clone();</span>
<a href="#l58.275"></a><span id="l58.275" class="difflineplus">+            let duration = baseDuration.clone();</span>
<a href="#l58.276"></a><span id="l58.276">             duration.isNegative = true;</span>
<a href="#l58.277"></a><span id="l58.277">             searchStart.addDuration(duration);</span>
<a href="#l58.278"></a><span id="l58.278">         }</span>
<a href="#l58.279"></a><span id="l58.279"> </span>
<a href="#l58.280"></a><span id="l58.280" class="difflineminus">-        var startDate = this.mBaseItem.recurrenceStartDate;</span>
<a href="#l58.281"></a><span id="l58.281" class="difflineplus">+        let startDate = this.mBaseItem.recurrenceStartDate;</span>
<a href="#l58.282"></a><span id="l58.282">         if (startDate == null) {</span>
<a href="#l58.283"></a><span id="l58.283">             // Todo created by other apps may have a saved recurrence but</span>
<a href="#l58.284"></a><span id="l58.284">             // start and due dates disabled.  Since no recurrenceStartDate,</span>
<a href="#l58.285"></a><span id="l58.285">             // treat as undated task.</span>
<a href="#l58.286"></a><span id="l58.286">             return [];</span>
<a href="#l58.287"></a><span id="l58.287">         }</span>
<a href="#l58.288"></a><span id="l58.288"> </span>
<a href="#l58.289"></a><span id="l58.289" class="difflineminus">-        var dates = [];</span>
<a href="#l58.290"></a><span id="l58.290" class="difflineplus">+        let dates = [];</span>
<a href="#l58.291"></a><span id="l58.291"> </span>
<a href="#l58.292"></a><span id="l58.292">         // toss in exceptions first. Save a map of all exceptions ids, so we</span>
<a href="#l58.293"></a><span id="l58.293">         // don't add the wrong occurrences later on.</span>
<a href="#l58.294"></a><span id="l58.294" class="difflineminus">-        var occurrenceMap = {};</span>
<a href="#l58.295"></a><span id="l58.295" class="difflineminus">-        for (var ex in this.mExceptionMap) {</span>
<a href="#l58.296"></a><span id="l58.296" class="difflineminus">-            var item = this.mExceptionMap[ex];</span>
<a href="#l58.297"></a><span id="l58.297" class="difflineminus">-            var occDate = checkIfInRange(item, aRangeStart, aRangeEnd, true);</span>
<a href="#l58.298"></a><span id="l58.298" class="difflineplus">+        let occurrenceMap = {};</span>
<a href="#l58.299"></a><span id="l58.299" class="difflineplus">+        for (let ex in this.mExceptionMap) {</span>
<a href="#l58.300"></a><span id="l58.300" class="difflineplus">+            let item = this.mExceptionMap[ex];</span>
<a href="#l58.301"></a><span id="l58.301" class="difflineplus">+            let occDate = checkIfInRange(item, aRangeStart, aRangeEnd, true);</span>
<a href="#l58.302"></a><span id="l58.302">             occurrenceMap[ex] = true;</span>
<a href="#l58.303"></a><span id="l58.303">             if (occDate) {</span>
<a href="#l58.304"></a><span id="l58.304">                 binaryInsert(dates, { id: item.recurrenceId, rstart: occDate }, ridDateSortComptor);</span>
<a href="#l58.305"></a><span id="l58.305">             }</span>
<a href="#l58.306"></a><span id="l58.306">         }</span>
<a href="#l58.307"></a><span id="l58.307"> </span>
<a href="#l58.308"></a><span id="l58.308">         // DTSTART/DUE is always part of the (positive) expanded set:</span>
<a href="#l58.309"></a><span id="l58.309">         // DTSTART always equals RECURRENCE-ID for items expanded from RRULE</span>
<a href="#l58.310"></a><span id="l58.310" class="difflineminus">-        var baseOccDate = checkIfInRange(this.mBaseItem, aRangeStart, aRangeEnd, true);</span>
<a href="#l58.311"></a><span id="l58.311" class="difflineminus">-        var baseOccDateKey = getRidKey(baseOccDate);</span>
<a href="#l58.312"></a><span id="l58.312" class="difflineplus">+        let baseOccDate = checkIfInRange(this.mBaseItem, aRangeStart, aRangeEnd, true);</span>
<a href="#l58.313"></a><span id="l58.313" class="difflineplus">+        let baseOccDateKey = getRidKey(baseOccDate);</span>
<a href="#l58.314"></a><span id="l58.314">         if (baseOccDate &amp;&amp; !occurrenceMap[baseOccDateKey]) {</span>
<a href="#l58.315"></a><span id="l58.315">             occurrenceMap[baseOccDateKey] = true;</span>
<a href="#l58.316"></a><span id="l58.316">             binaryInsert(dates, { id: baseOccDate, rstart: baseOccDate }, ridDateSortComptor);</span>
<a href="#l58.317"></a><span id="l58.317">         }</span>
<a href="#l58.318"></a><span id="l58.318"> </span>
<a href="#l58.319"></a><span id="l58.319">         // if both range start and end are specified, we ask for all of the occurrences,</span>
<a href="#l58.320"></a><span id="l58.320">         // to make sure we catch all possible exceptions.  If aRangeEnd isn't specified,</span>
<a href="#l58.321"></a><span id="l58.321">         // then we have to ask for aMaxCount, and hope for the best.</span>
<a href="#l58.322"></a><span id="l58.322" class="difflineminus">-        var maxCount;</span>
<a href="#l58.323"></a><span id="l58.323" class="difflineplus">+        let maxCount;</span>
<a href="#l58.324"></a><span id="l58.324">         if (rangeStart &amp;&amp; rangeEnd) {</span>
<a href="#l58.325"></a><span id="l58.325">             maxCount = 0;</span>
<a href="#l58.326"></a><span id="l58.326">         } else {</span>
<a href="#l58.327"></a><span id="l58.327">             maxCount = aMaxCount;</span>
<a href="#l58.328"></a><span id="l58.328">         }</span>
<a href="#l58.329"></a><span id="l58.329"> </span>
<a href="#l58.330"></a><span id="l58.330">         // Apply positive rules</span>
<a href="#l58.331"></a><span id="l58.331">         for (let ritem of this.mPositiveRules) {</span>
<a href="#l58.332"></a><span id="l58.332" class="difflineat">@@ -578,17 +578,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.333"></a><span id="l58.333"> </span>
<a href="#l58.334"></a><span id="l58.334">         return dates;</span>
<a href="#l58.335"></a><span id="l58.335">     },</span>
<a href="#l58.336"></a><span id="l58.336"> </span>
<a href="#l58.337"></a><span id="l58.337">     getOccurrenceDates: function cRI_getOccurrenceDates(aRangeStart,</span>
<a href="#l58.338"></a><span id="l58.338">                                                         aRangeEnd,</span>
<a href="#l58.339"></a><span id="l58.339">                                                         aMaxCount,</span>
<a href="#l58.340"></a><span id="l58.340">                                                         aCount) {</span>
<a href="#l58.341"></a><span id="l58.341" class="difflineminus">-        var dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l58.342"></a><span id="l58.342" class="difflineplus">+        let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l58.343"></a><span id="l58.343">         dates = dates.map(function(d) { return d.rstart; });</span>
<a href="#l58.344"></a><span id="l58.344">         aCount.value = dates.length;</span>
<a href="#l58.345"></a><span id="l58.345">         return dates;</span>
<a href="#l58.346"></a><span id="l58.346">     },</span>
<a href="#l58.347"></a><span id="l58.347"> </span>
<a href="#l58.348"></a><span id="l58.348">     getOccurrences: function cRI_getOccurrences(aRangeStart,</span>
<a href="#l58.349"></a><span id="l58.349">                                                 aRangeEnd,</span>
<a href="#l58.350"></a><span id="l58.350">                                                 aMaxCount,</span>
<a href="#l58.351"></a><span id="l58.351" class="difflineat">@@ -619,32 +619,32 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.352"></a><span id="l58.352">         }</span>
<a href="#l58.353"></a><span id="l58.353">         return proxy;</span>
<a href="#l58.354"></a><span id="l58.354">     },</span>
<a href="#l58.355"></a><span id="l58.355"> </span>
<a href="#l58.356"></a><span id="l58.356">     removeOccurrenceAt: function cRI_removeOccurrenceAt(aRecurrenceId) {</span>
<a href="#l58.357"></a><span id="l58.357">         this.ensureBaseItem();</span>
<a href="#l58.358"></a><span id="l58.358">         this.ensureMutable();</span>
<a href="#l58.359"></a><span id="l58.359"> </span>
<a href="#l58.360"></a><span id="l58.360" class="difflineminus">-        var d = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l58.361"></a><span id="l58.361" class="difflineplus">+        let d = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l58.362"></a><span id="l58.362">                           .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l58.363"></a><span id="l58.363">         d.isNegative = true;</span>
<a href="#l58.364"></a><span id="l58.364">         d.date = aRecurrenceId.clone();</span>
<a href="#l58.365"></a><span id="l58.365"> </span>
<a href="#l58.366"></a><span id="l58.366">         this.removeExceptionFor(d.date);</span>
<a href="#l58.367"></a><span id="l58.367"> </span>
<a href="#l58.368"></a><span id="l58.368">         this.appendRecurrenceItem(d);</span>
<a href="#l58.369"></a><span id="l58.369">     },</span>
<a href="#l58.370"></a><span id="l58.370"> </span>
<a href="#l58.371"></a><span id="l58.371">     restoreOccurrenceAt: function cRI_restoreOccurrenceAt(aRecurrenceId) {</span>
<a href="#l58.372"></a><span id="l58.372">         this.ensureBaseItem();</span>
<a href="#l58.373"></a><span id="l58.373">         this.ensureMutable();</span>
<a href="#l58.374"></a><span id="l58.374">         this.ensureSortedRecurrenceRules();</span>
<a href="#l58.375"></a><span id="l58.375"> </span>
<a href="#l58.376"></a><span id="l58.376" class="difflineminus">-        for (var i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l58.377"></a><span id="l58.377" class="difflineplus">+        for (let i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l58.378"></a><span id="l58.378">             let wrappedItem = cal.wrapInstance(this.mRecurrenceItems[i], Components.interfaces.calIRecurrenceDate);</span>
<a href="#l58.379"></a><span id="l58.379">             if (wrappedItem) {</span>
<a href="#l58.380"></a><span id="l58.380">                 let rd = wrappedItem;</span>
<a href="#l58.381"></a><span id="l58.381">                 if (rd.isNegative &amp;&amp; rd.date.compare(aRecurrenceId) == 0) {</span>
<a href="#l58.382"></a><span id="l58.382">                     return this.deleteRecurrenceItemAt(i);</span>
<a href="#l58.383"></a><span id="l58.383">                 }</span>
<a href="#l58.384"></a><span id="l58.384">             }</span>
<a href="#l58.385"></a><span id="l58.385">         }</span>
<a href="#l58.386"></a><span id="l58.386" class="difflineat">@@ -695,28 +695,28 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.387"></a><span id="l58.387">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.388"></a><span id="l58.388">         }</span>
<a href="#l58.389"></a><span id="l58.389"> </span>
<a href="#l58.390"></a><span id="l58.390">         if (anItem.recurrenceId == null) {</span>
<a href="#l58.391"></a><span id="l58.391">             ERROR(&quot;recurrenceInfo::addException: item with null recurrenceId!&quot;);</span>
<a href="#l58.392"></a><span id="l58.392">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l58.393"></a><span id="l58.393">         }</span>
<a href="#l58.394"></a><span id="l58.394"> </span>
<a href="#l58.395"></a><span id="l58.395" class="difflineminus">-        var itemtoadd;</span>
<a href="#l58.396"></a><span id="l58.396" class="difflineplus">+        let itemtoadd;</span>
<a href="#l58.397"></a><span id="l58.397">         if (aTakeOverOwnership &amp;&amp; anItem.isMutable) {</span>
<a href="#l58.398"></a><span id="l58.398">             itemtoadd = anItem;</span>
<a href="#l58.399"></a><span id="l58.399">             itemtoadd.parentItem = this.mBaseItem;</span>
<a href="#l58.400"></a><span id="l58.400">         } else {</span>
<a href="#l58.401"></a><span id="l58.401">             itemtoadd = anItem.cloneShallow(this.mBaseItem);</span>
<a href="#l58.402"></a><span id="l58.402">         }</span>
<a href="#l58.403"></a><span id="l58.403"> </span>
<a href="#l58.404"></a><span id="l58.404">         // we're going to assume that the recurrenceId is valid here,</span>
<a href="#l58.405"></a><span id="l58.405">         // because presumably the item came from one of our functions</span>
<a href="#l58.406"></a><span id="l58.406"> </span>
<a href="#l58.407"></a><span id="l58.407" class="difflineminus">-        var exKey = getRidKey(itemtoadd.recurrenceId);</span>
<a href="#l58.408"></a><span id="l58.408" class="difflineplus">+        let exKey = getRidKey(itemtoadd.recurrenceId);</span>
<a href="#l58.409"></a><span id="l58.409">         this.mExceptionMap[exKey] = itemtoadd;</span>
<a href="#l58.410"></a><span id="l58.410">     },</span>
<a href="#l58.411"></a><span id="l58.411"> </span>
<a href="#l58.412"></a><span id="l58.412">     getExceptionFor: function cRI_getExceptionFor(aRecurrenceId) {</span>
<a href="#l58.413"></a><span id="l58.413">         this.ensureBaseItem();</span>
<a href="#l58.414"></a><span id="l58.414">         // Interface calIRecurrenceInfo specifies result be null if not found.</span>
<a href="#l58.415"></a><span id="l58.415">         // To avoid strict &quot;reference to undefined property&quot; warning, appending</span>
<a href="#l58.416"></a><span id="l58.416">         // &quot;|| null&quot; gives explicit result in case where property undefined</span>
<a href="#l58.417"></a><span id="l58.417" class="difflineat">@@ -727,17 +727,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l58.418"></a><span id="l58.418">     removeExceptionFor: function cRI_removeExceptionFor(aRecurrenceId) {</span>
<a href="#l58.419"></a><span id="l58.419">         this.ensureBaseItem();</span>
<a href="#l58.420"></a><span id="l58.420">         delete this.mExceptionMap[getRidKey(aRecurrenceId)];</span>
<a href="#l58.421"></a><span id="l58.421">     },</span>
<a href="#l58.422"></a><span id="l58.422"> </span>
<a href="#l58.423"></a><span id="l58.423">     getExceptionIds: function cRI_getExceptionIds(aCount) {</span>
<a href="#l58.424"></a><span id="l58.424">         this.ensureBaseItem();</span>
<a href="#l58.425"></a><span id="l58.425"> </span>
<a href="#l58.426"></a><span id="l58.426" class="difflineminus">-        var ids = [];</span>
<a href="#l58.427"></a><span id="l58.427" class="difflineplus">+        let ids = [];</span>
<a href="#l58.428"></a><span id="l58.428">         for (let ex in this.mExceptionMap) {</span>
<a href="#l58.429"></a><span id="l58.429">             let item = this.mExceptionMap[ex];</span>
<a href="#l58.430"></a><span id="l58.430">             ids.push(item.recurrenceId);</span>
<a href="#l58.431"></a><span id="l58.431">         }</span>
<a href="#l58.432"></a><span id="l58.432"> </span>
<a href="#l58.433"></a><span id="l58.433">         aCount.value = ids.length;</span>
<a href="#l58.434"></a><span id="l58.434">         return ids;</span>
<a href="#l58.435"></a><span id="l58.435">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/base/src/calTimezone.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/base/src/calTimezone.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -79,17 +79,17 @@ calLibicalTimezone.prototype = {</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5">     toString: function calLibicalTimezone_toString() {</span>
<a href="#l59.6"></a><span id="l59.6">         return (this.icalComponent ? this.icalComponent.toString() : this.tzid);</span>
<a href="#l59.7"></a><span id="l59.7">     },</span>
<a href="#l59.8"></a><span id="l59.8"> </span>
<a href="#l59.9"></a><span id="l59.9">     get isUTC() { return this.mUTC; },</span>
<a href="#l59.10"></a><span id="l59.10"> </span>
<a href="#l59.11"></a><span id="l59.11">     get icalComponent() {</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-        var comp = this.mComponent;</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+        let comp = this.mComponent;</span>
<a href="#l59.14"></a><span id="l59.14">         if (comp &amp;&amp; (typeof comp == &quot;string&quot;)) {</span>
<a href="#l59.15"></a><span id="l59.15">             this.mComponent = cal.getIcsService().parseICS(&quot;BEGIN:VCALENDAR\r\n&quot; + comp + &quot;\r\nEND:VCALENDAR\r\n&quot;, null)</span>
<a href="#l59.16"></a><span id="l59.16">                                                  .getFirstSubcomponent(&quot;VTIMEZONE&quot;);</span>
<a href="#l59.17"></a><span id="l59.17">         }</span>
<a href="#l59.18"></a><span id="l59.18">         return this.mComponent;</span>
<a href="#l59.19"></a><span id="l59.19">     },</span>
<a href="#l59.20"></a><span id="l59.20"> </span>
<a href="#l59.21"></a><span id="l59.21">     get displayName() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -241,18 +241,18 @@ calTimezoneService.prototype = {</span>
<a href="#l60.4"></a><span id="l60.4">     },</span>
<a href="#l60.5"></a><span id="l60.5"> </span>
<a href="#l60.6"></a><span id="l60.6">     get version() {</span>
<a href="#l60.7"></a><span id="l60.7">         return this.mVersion;</span>
<a href="#l60.8"></a><span id="l60.8">     },</span>
<a href="#l60.9"></a><span id="l60.9"> </span>
<a href="#l60.10"></a><span id="l60.10">     get defaultTimezone() {</span>
<a href="#l60.11"></a><span id="l60.11">         if (!this.mDefaultTimezone) {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-            var prefTzid = Preferences.get(&quot;calendar.timezone.local&quot;, null);</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-            var tzid = prefTzid;</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+            let prefTzid = Preferences.get(&quot;calendar.timezone.local&quot;, null);</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+            let tzid = prefTzid;</span>
<a href="#l60.16"></a><span id="l60.16">             if (!tzid) {</span>
<a href="#l60.17"></a><span id="l60.17">                 try {</span>
<a href="#l60.18"></a><span id="l60.18">                     tzid = guessSystemTimezone();</span>
<a href="#l60.19"></a><span id="l60.19">                 } catch (e) {</span>
<a href="#l60.20"></a><span id="l60.20">                     cal.WARN(&quot;An exception occurred guessing the system timezone, trying UTC. Exception: &quot; + e);</span>
<a href="#l60.21"></a><span id="l60.21">                     tzid = &quot;UTC&quot;;</span>
<a href="#l60.22"></a><span id="l60.22">                 }</span>
<a href="#l60.23"></a><span id="l60.23">             }</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineat">@@ -306,59 +306,59 @@ function guessSystemTimezone() {</span>
<a href="#l60.25"></a><span id="l60.25">     const tzNameJun = nameDataJun &amp;&amp; nameDataJun[2];</span>
<a href="#l60.26"></a><span id="l60.26">     const tzNameDec = nameDataDec &amp;&amp; nameDataDec[2];</span>
<a href="#l60.27"></a><span id="l60.27">     const offsetRegex = /[+-]\d{4}/;</span>
<a href="#l60.28"></a><span id="l60.28">     const offsetJun = dateJun.match(offsetRegex)[0];</span>
<a href="#l60.29"></a><span id="l60.29">     const offsetDec = dateDec.match(offsetRegex)[0];</span>
<a href="#l60.30"></a><span id="l60.30"> </span>
<a href="#l60.31"></a><span id="l60.31">     const tzSvc = cal.getTimezoneService();</span>
<a href="#l60.32"></a><span id="l60.32"> </span>
<a href="#l60.33"></a><span id="l60.33" class="difflineminus">-    var continent = &quot;Africa|America|Antarctica|Asia|Australia|Europe&quot;;</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineminus">-    var ocean = &quot;Arctic|Atlantic|Indian|Pacific&quot;;</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineminus">-    var tzRegex = new RegExp(&quot;.*((?:&quot; + continent + &quot;|&quot; + ocean + &quot;)&quot; +</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineplus">+    let continent = &quot;Africa|America|Antarctica|Asia|Australia|Europe&quot;;</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+    let ocean = &quot;Arctic|Atlantic|Indian|Pacific&quot;;</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+    let tzRegex = new RegExp(&quot;.*((?:&quot; + continent + &quot;|&quot; + ocean + &quot;)&quot; +</span>
<a href="#l60.39"></a><span id="l60.39">                              &quot;(?:[/][-A-Z_a-z]+)+)&quot;);</span>
<a href="#l60.40"></a><span id="l60.40"> </span>
<a href="#l60.41"></a><span id="l60.41">     function getIcalString(component, property) {</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineminus">-        var prop = (component &amp;&amp; component.getFirstProperty(property));</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineplus">+        let prop = (component &amp;&amp; component.getFirstProperty(property));</span>
<a href="#l60.44"></a><span id="l60.44">         return (prop ? prop.valueAsIcalString : null);</span>
<a href="#l60.45"></a><span id="l60.45">     }</span>
<a href="#l60.46"></a><span id="l60.46"> </span>
<a href="#l60.47"></a><span id="l60.47">     // Check if Olson ZoneInfo timezone matches OS/JSDate timezone properties:</span>
<a href="#l60.48"></a><span id="l60.48">     // * standard offset and daylight/summer offset if present (longitude),</span>
<a href="#l60.49"></a><span id="l60.49">     // * if has summer time, direction of change (northern/southern hemisphere)</span>
<a href="#l60.50"></a><span id="l60.50">     // * if has summer time, dates of next transitions</span>
<a href="#l60.51"></a><span id="l60.51">     // * timezone name (such as &quot;Western European Standard Time&quot;).</span>
<a href="#l60.52"></a><span id="l60.52">     // Score is 3 if matches dates and names, 2 if matches dates without names,</span>
<a href="#l60.53"></a><span id="l60.53">     // 1 if matches dates within a week (so changes on different weekday),</span>
<a href="#l60.54"></a><span id="l60.54">     // otherwise 0 if no match.</span>
<a href="#l60.55"></a><span id="l60.55">     function checkTZ(tzId) {</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineminus">-        var tz = tzSvc.getTimezone(tzId);</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+        let tz = tzSvc.getTimezone(tzId);</span>
<a href="#l60.58"></a><span id="l60.58"> </span>
<a href="#l60.59"></a><span id="l60.59">         // Have to handle UTC separately because it has no .icalComponent.</span>
<a href="#l60.60"></a><span id="l60.60">         if (tz.isUTC) {</span>
<a href="#l60.61"></a><span id="l60.61">             if (offsetDec == 0 &amp;&amp; offsetJun == 0) {</span>
<a href="#l60.62"></a><span id="l60.62">                 if (tzNameJun == &quot;UTC&quot; &amp;&amp; tzNameDec == &quot;UTC&quot;) {</span>
<a href="#l60.63"></a><span id="l60.63">                     return 3;</span>
<a href="#l60.64"></a><span id="l60.64">                 } else {</span>
<a href="#l60.65"></a><span id="l60.65">                     return 2;</span>
<a href="#l60.66"></a><span id="l60.66">                 }</span>
<a href="#l60.67"></a><span id="l60.67">             } else {</span>
<a href="#l60.68"></a><span id="l60.68">                 return 0;</span>
<a href="#l60.69"></a><span id="l60.69">             }</span>
<a href="#l60.70"></a><span id="l60.70">         }</span>
<a href="#l60.71"></a><span id="l60.71"> </span>
<a href="#l60.72"></a><span id="l60.72" class="difflineminus">-        var subComp = tz.icalComponent;</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+        let subComp = tz.icalComponent;</span>
<a href="#l60.74"></a><span id="l60.74">         // find currently applicable time period, not just first,</span>
<a href="#l60.75"></a><span id="l60.75">         // because offsets of timezone may be changed over the years.</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineminus">-        var standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineminus">-        var standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineminus">-        var standardName = getIcalString(standard, &quot;TZNAME&quot;);</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineminus">-        var daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineminus">-        var daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineminus">-        var daylightName = getIcalString(daylight, &quot;TZNAME&quot;);</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+        let standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+        let standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+        let standardName = getIcalString(standard, &quot;TZNAME&quot;);</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+        let daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+        let daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+        let daylightName = getIcalString(daylight, &quot;TZNAME&quot;);</span>
<a href="#l60.88"></a><span id="l60.88"> </span>
<a href="#l60.89"></a><span id="l60.89">         // Try northern hemisphere cases.</span>
<a href="#l60.90"></a><span id="l60.90">         if (offsetDec == standardTZOffset &amp;&amp; offsetDec == offsetJun &amp;&amp;</span>
<a href="#l60.91"></a><span id="l60.91">             !daylight) {</span>
<a href="#l60.92"></a><span id="l60.92">             if (standardName &amp;&amp; standardName == tzNameJun) {</span>
<a href="#l60.93"></a><span id="l60.93">                 return 3;</span>
<a href="#l60.94"></a><span id="l60.94">             } else {</span>
<a href="#l60.95"></a><span id="l60.95">                 return 2;</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineat">@@ -467,19 +467,19 @@ function guessSystemTimezone() {</span>
<a href="#l60.97"></a><span id="l60.97">             periodStartCalDate.icalString = getIcalString(period, &quot;DTSTART&quot;);</span>
<a href="#l60.98"></a><span id="l60.98">             periodStartCalDate.timezone = tz;</span>
<a href="#l60.99"></a><span id="l60.99">             if (oneYrUTC.nativeTime &lt; periodStartCalDate.nativeTime) {</span>
<a href="#l60.100"></a><span id="l60.100">                 continue; // period starts too far in future</span>
<a href="#l60.101"></a><span id="l60.101">             }</span>
<a href="#l60.102"></a><span id="l60.102">             // Must examine UNTIL date (not next daylight start) because</span>
<a href="#l60.103"></a><span id="l60.103">             // some zones (e.g., Arizona, Hawaii) may stop using daylight</span>
<a href="#l60.104"></a><span id="l60.104">             // time, so there might not be a next daylight start.</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineminus">-            var rrule = period.getFirstProperty(&quot;RRULE&quot;);</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+            let rrule = period.getFirstProperty(&quot;RRULE&quot;);</span>
<a href="#l60.107"></a><span id="l60.107">             if (rrule) {</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineminus">-                var match = untilRegex.exec(rrule.valueAsIcalString);</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineplus">+                let match = untilRegex.exec(rrule.valueAsIcalString);</span>
<a href="#l60.110"></a><span id="l60.110">                 if (match) {</span>
<a href="#l60.111"></a><span id="l60.111">                     periodUntilCalDate.icalString = match[1];</span>
<a href="#l60.112"></a><span id="l60.112">                     if (todayUTC.nativeTime &gt; periodUntilDate.nativeTime) {</span>
<a href="#l60.113"></a><span id="l60.113">                         continue; // period ends too early</span>
<a href="#l60.114"></a><span id="l60.114">                     }</span>
<a href="#l60.115"></a><span id="l60.115">                 } // else forever rule</span>
<a href="#l60.116"></a><span id="l60.116">             } // else no daylight rule</span>
<a href="#l60.117"></a><span id="l60.117"> </span>
<a href="#l60.118"></a><span id="l60.118" class="difflineat">@@ -489,17 +489,17 @@ function guessSystemTimezone() {</span>
<a href="#l60.119"></a><span id="l60.119">             } else {</span>
<a href="#l60.120"></a><span id="l60.120">                 if (todayUTC.nativeTime &lt; periodStartCalDate.nativeTime) {</span>
<a href="#l60.121"></a><span id="l60.121">                     // already know periodStartCalDate &lt; oneYr from now,</span>
<a href="#l60.122"></a><span id="l60.122">                     // and transitions are at most once per year, so it is next.</span>
<a href="#l60.123"></a><span id="l60.123">                     return cal.dateTimeToJsDate(periodStartCalDate);</span>
<a href="#l60.124"></a><span id="l60.124">                 } else if (rrule) {</span>
<a href="#l60.125"></a><span id="l60.125">                     // find next occurrence after today</span>
<a href="#l60.126"></a><span id="l60.126">                     periodCalRule.icalProperty = rrule;</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineminus">-                    var nextTransitionDate =</span>
<a href="#l60.128"></a><span id="l60.128" class="difflineplus">+                    let nextTransitionDate =</span>
<a href="#l60.129"></a><span id="l60.129">                         periodCalRule.getNextOccurrence(periodStartCalDate,</span>
<a href="#l60.130"></a><span id="l60.130">                                                         todayUTC);</span>
<a href="#l60.131"></a><span id="l60.131">                     // make sure rule doesn't end before next transition date.</span>
<a href="#l60.132"></a><span id="l60.132">                     if (nextTransitionDate) {</span>
<a href="#l60.133"></a><span id="l60.133">                         return cal.dateTimeToJsDate(nextTransitionDate);</span>
<a href="#l60.134"></a><span id="l60.134">                     }</span>
<a href="#l60.135"></a><span id="l60.135">                 }</span>
<a href="#l60.136"></a><span id="l60.136">             }</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineat">@@ -572,61 +572,61 @@ function guessSystemTimezone() {</span>
<a href="#l60.138"></a><span id="l60.138">     function weekday(icsDate, tz) {</span>
<a href="#l60.139"></a><span id="l60.139">         let calDate = cal.createDateTime(icsDate);</span>
<a href="#l60.140"></a><span id="l60.140">         calDate.timezone = tz;</span>
<a href="#l60.141"></a><span id="l60.141">         return cal.dateTimeToJsDate(calDate).toLocaleFormat(&quot;%a&quot;);</span>
<a href="#l60.142"></a><span id="l60.142">     }</span>
<a href="#l60.143"></a><span id="l60.143"> </span>
<a href="#l60.144"></a><span id="l60.144">     // Try to find a tz that matches OS/JSDate timezone.  If no name match,</span>
<a href="#l60.145"></a><span id="l60.145">     // will use first of probable timezone(s) with highest score.</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineminus">-    var probableTZId = &quot;floating&quot;; // default fallback tz if no tz matches.</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineminus">-    var probableTZScore = 0;</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineminus">-    var probableTZSource = null;</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+    let probableTZId = &quot;floating&quot;; // default fallback tz if no tz matches.</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+    let probableTZScore = 0;</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineplus">+    let probableTZSource = null;</span>
<a href="#l60.152"></a><span id="l60.152"> </span>
<a href="#l60.153"></a><span id="l60.153">     const calProperties = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l60.154"></a><span id="l60.154"> </span>
<a href="#l60.155"></a><span id="l60.155">     // First, try to detect operating system timezone.</span>
<a href="#l60.156"></a><span id="l60.156">     let zoneInfoIdFromOSUserTimeZone = null;</span>
<a href="#l60.157"></a><span id="l60.157">     let osUserTimeZone = null;</span>
<a href="#l60.158"></a><span id="l60.158">     try {</span>
<a href="#l60.159"></a><span id="l60.159" class="difflineminus">-        var handler = Components.classes[&quot;@mozilla.org/network/protocol;1?name=http&quot;]</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineplus">+        let handler = Components.classes[&quot;@mozilla.org/network/protocol;1?name=http&quot;]</span>
<a href="#l60.161"></a><span id="l60.161">                                 .getService(Components.interfaces.nsIHttpProtocolHandler);</span>
<a href="#l60.162"></a><span id="l60.162"> </span>
<a href="#l60.163"></a><span id="l60.163">         if (handler.oscpu.match(/^Windows/)) {</span>
<a href="#l60.164"></a><span id="l60.164" class="difflineminus">-            var wrk = (Components</span>
<a href="#l60.165"></a><span id="l60.165" class="difflineplus">+            let wrk = (Components</span>
<a href="#l60.166"></a><span id="l60.166">                        .classes[&quot;@mozilla.org/windows-registry-key;1&quot;]</span>
<a href="#l60.167"></a><span id="l60.167">                        .createInstance(Components.interfaces.nsIWindowsRegKey));</span>
<a href="#l60.168"></a><span id="l60.168">             wrk.open(wrk.ROOT_KEY_LOCAL_MACHINE,</span>
<a href="#l60.169"></a><span id="l60.169">                      &quot;SYSTEM\\CurrentControlSet\\Control\\TimeZoneInformation&quot;,</span>
<a href="#l60.170"></a><span id="l60.170">                      wrk.ACCESS_READ);</span>
<a href="#l60.171"></a><span id="l60.171">             if (wrk.hasValue(&quot;TimeZoneKeyName&quot;)) {</span>
<a href="#l60.172"></a><span id="l60.172">                 // Windows Vista and later have this key.</span>
<a href="#l60.173"></a><span id="l60.173">                 // Clear trailing garbage on this key, see bug 1129712.</span>
<a href="#l60.174"></a><span id="l60.174">                 osUserTimeZone = wrk.readStringValue(&quot;TimeZoneKeyName&quot;).split(&quot;\0&quot;)[0];</span>
<a href="#l60.175"></a><span id="l60.175">             } else {</span>
<a href="#l60.176"></a><span id="l60.176">                 // If on Windows XP, current timezone only lists its localized name,</span>
<a href="#l60.177"></a><span id="l60.177">                 // so to find its registry key name, match localized name to</span>
<a href="#l60.178"></a><span id="l60.178">                 // localized names of each windows timezone listed in registry.</span>
<a href="#l60.179"></a><span id="l60.179">                 // Then use the registry key name to see if this timezone has a</span>
<a href="#l60.180"></a><span id="l60.180">                 // known ZoneInfo name.</span>
<a href="#l60.181"></a><span id="l60.181" class="difflineminus">-                var currentTZStandardName = wrk.readStringValue(&quot;StandardName&quot;);</span>
<a href="#l60.182"></a><span id="l60.182" class="difflineplus">+                let currentTZStandardName = wrk.readStringValue(&quot;StandardName&quot;);</span>
<a href="#l60.183"></a><span id="l60.183">                 wrk.close();</span>
<a href="#l60.184"></a><span id="l60.184"> </span>
<a href="#l60.185"></a><span id="l60.185">                 wrk.open(wrk.ROOT_KEY_LOCAL_MACHINE,</span>
<a href="#l60.186"></a><span id="l60.186">                          &quot;SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Time Zones&quot;,</span>
<a href="#l60.187"></a><span id="l60.187">                          wrk.ACCESS_READ);</span>
<a href="#l60.188"></a><span id="l60.188"> </span>
<a href="#l60.189"></a><span id="l60.189">                 // Linear search matching localized name of standard timezone</span>
<a href="#l60.190"></a><span id="l60.190">                 // to find the non-localized registry key.</span>
<a href="#l60.191"></a><span id="l60.191">                 // (Registry keys are sorted by subkeyName, not by localized name</span>
<a href="#l60.192"></a><span id="l60.192">                 //  nor offset, so cannot use binary search.)</span>
<a href="#l60.193"></a><span id="l60.193" class="difflineminus">-                for (var i = 0; i &lt; wrk.childCount; i++) {</span>
<a href="#l60.194"></a><span id="l60.194" class="difflineminus">-                    var subkeyName = wrk.getChildName(i);</span>
<a href="#l60.195"></a><span id="l60.195" class="difflineminus">-                    var subkey = wrk.openChild(subkeyName, wrk.ACCESS_READ);</span>
<a href="#l60.196"></a><span id="l60.196" class="difflineminus">-                    var std = subkey.readStringValue(&quot;Std&quot;);</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineplus">+                for (let i = 0; i &lt; wrk.childCount; i++) {</span>
<a href="#l60.198"></a><span id="l60.198" class="difflineplus">+                    let subkeyName = wrk.getChildName(i);</span>
<a href="#l60.199"></a><span id="l60.199" class="difflineplus">+                    let subkey = wrk.openChild(subkeyName, wrk.ACCESS_READ);</span>
<a href="#l60.200"></a><span id="l60.200" class="difflineplus">+                    let std = subkey.readStringValue(&quot;Std&quot;);</span>
<a href="#l60.201"></a><span id="l60.201">                     subkey.close();</span>
<a href="#l60.202"></a><span id="l60.202">                     if (std == currentTZStandardName) {</span>
<a href="#l60.203"></a><span id="l60.203">                         osUserTimeZone = subkeyName;</span>
<a href="#l60.204"></a><span id="l60.204">                         break;</span>
<a href="#l60.205"></a><span id="l60.205">                     }</span>
<a href="#l60.206"></a><span id="l60.206">                 }</span>
<a href="#l60.207"></a><span id="l60.207">             }</span>
<a href="#l60.208"></a><span id="l60.208">             wrk.close();</span>
<a href="#l60.209"></a><span id="l60.209" class="difflineat">@@ -763,50 +763,50 @@ function guessSystemTimezone() {</span>
<a href="#l60.210"></a><span id="l60.210">     // If reach here, there were no score=3 matches, so Warn in console.</span>
<a href="#l60.211"></a><span id="l60.211">     try {</span>
<a href="#l60.212"></a><span id="l60.212">         switch (probableTZScore) {</span>
<a href="#l60.213"></a><span id="l60.213">         case 0:</span>
<a href="#l60.214"></a><span id="l60.214">             cal.WARN(calProperties.GetStringFromName(&quot;warningUsingFloatingTZNoMatch&quot;));</span>
<a href="#l60.215"></a><span id="l60.215">             break;</span>
<a href="#l60.216"></a><span id="l60.216">         case 1: case 2:</span>
<a href="#l60.217"></a><span id="l60.217">             let tzId = probableTZId;</span>
<a href="#l60.218"></a><span id="l60.218" class="difflineminus">-            var tz = tzSvc.getTimezone(tzId);</span>
<a href="#l60.219"></a><span id="l60.219" class="difflineminus">-            var subComp = tz.icalComponent;</span>
<a href="#l60.220"></a><span id="l60.220" class="difflineminus">-            var standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineminus">-            var standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.222"></a><span id="l60.222" class="difflineminus">-            var daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l60.223"></a><span id="l60.223" class="difflineminus">-            var daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.224"></a><span id="l60.224" class="difflineminus">-            var warningDetail;</span>
<a href="#l60.225"></a><span id="l60.225" class="difflineplus">+            let tz = tzSvc.getTimezone(tzId);</span>
<a href="#l60.226"></a><span id="l60.226" class="difflineplus">+            let subComp = tz.icalComponent;</span>
<a href="#l60.227"></a><span id="l60.227" class="difflineplus">+            let standard = findCurrentTimePeriod(tz, subComp, &quot;STANDARD&quot;);</span>
<a href="#l60.228"></a><span id="l60.228" class="difflineplus">+            let standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.229"></a><span id="l60.229" class="difflineplus">+            let daylight = findCurrentTimePeriod(tz, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l60.230"></a><span id="l60.230" class="difflineplus">+            let daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+            let warningDetail;</span>
<a href="#l60.232"></a><span id="l60.232">             if (probableTZScore == 1) {</span>
<a href="#l60.233"></a><span id="l60.233">                 // score 1 means has daylight time,</span>
<a href="#l60.234"></a><span id="l60.234">                 // but transitions start on different weekday from os timezone.</span>
<a href="#l60.235"></a><span id="l60.235" class="difflineminus">-                var standardStart = getIcalString(standard, &quot;DTSTART&quot;);</span>
<a href="#l60.236"></a><span id="l60.236" class="difflineminus">-                var standardStartWeekday = weekday(standardStart, tz);</span>
<a href="#l60.237"></a><span id="l60.237" class="difflineminus">-                var standardRule = getIcalString(standard, &quot;RRULE&quot;);</span>
<a href="#l60.238"></a><span id="l60.238" class="difflineminus">-                var standardText =</span>
<a href="#l60.239"></a><span id="l60.239" class="difflineplus">+                let standardStart = getIcalString(standard, &quot;DTSTART&quot;);</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineplus">+                let standardStartWeekday = weekday(standardStart, tz);</span>
<a href="#l60.241"></a><span id="l60.241" class="difflineplus">+                let standardRule = getIcalString(standard, &quot;RRULE&quot;);</span>
<a href="#l60.242"></a><span id="l60.242" class="difflineplus">+                let standardText =</span>
<a href="#l60.243"></a><span id="l60.243">                     (&quot;  Standard: &quot; + standardStart + &quot; &quot; + standardStartWeekday + &quot;\n&quot; +</span>
<a href="#l60.244"></a><span id="l60.244">                      &quot;            &quot; + standardRule + &quot;\n&quot;);</span>
<a href="#l60.245"></a><span id="l60.245" class="difflineminus">-                var daylightStart = getIcalString(daylight, &quot;DTSTART&quot;);</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineminus">-                var daylightStartWeekday = weekday(daylightStart, tz);</span>
<a href="#l60.247"></a><span id="l60.247" class="difflineminus">-                var daylightRule = getIcalString(daylight, &quot;RRULE&quot;);</span>
<a href="#l60.248"></a><span id="l60.248" class="difflineminus">-                var daylightText =</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineplus">+                let daylightStart = getIcalString(daylight, &quot;DTSTART&quot;);</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+                let daylightStartWeekday = weekday(daylightStart, tz);</span>
<a href="#l60.251"></a><span id="l60.251" class="difflineplus">+                let daylightRule = getIcalString(daylight, &quot;RRULE&quot;);</span>
<a href="#l60.252"></a><span id="l60.252" class="difflineplus">+                let daylightText =</span>
<a href="#l60.253"></a><span id="l60.253">                     (&quot;  Daylight: &quot; + daylightStart + &quot; &quot; + daylightStartWeekday + &quot;\n&quot; +</span>
<a href="#l60.254"></a><span id="l60.254">                      &quot;            &quot; + daylightRule + &quot;\n&quot;);</span>
<a href="#l60.255"></a><span id="l60.255">                 warningDetail =</span>
<a href="#l60.256"></a><span id="l60.256">                     ((standardStart &lt; daylightStart</span>
<a href="#l60.257"></a><span id="l60.257">                       ? standardText + daylightText</span>
<a href="#l60.258"></a><span id="l60.258">                       : daylightText + standardText) +</span>
<a href="#l60.259"></a><span id="l60.259">                      (calProperties.GetStringFromName(</span>
<a href="#l60.260"></a><span id="l60.260">                       &quot;TZAlmostMatchesOSDifferAtMostAWeek&quot;)));</span>
<a href="#l60.261"></a><span id="l60.261">             } else {</span>
<a href="#l60.262"></a><span id="l60.262">                 warningDetail = calProperties.GetStringFromName(&quot;TZSeemsToMatchOS&quot;);</span>
<a href="#l60.263"></a><span id="l60.263">             }</span>
<a href="#l60.264"></a><span id="l60.264" class="difflineminus">-            var offsetString = standardTZOffset +</span>
<a href="#l60.265"></a><span id="l60.265" class="difflineplus">+            let offsetString = standardTZOffset +</span>
<a href="#l60.266"></a><span id="l60.266">                                  (!daylightTZOffset ? &quot;&quot; : &quot;/&quot; + daylightTZOffset);</span>
<a href="#l60.267"></a><span id="l60.267" class="difflineminus">-            var warningMsg = calProperties.formatStringFromName(&quot;WarningUsingGuessedTZ&quot;,</span>
<a href="#l60.268"></a><span id="l60.268" class="difflineplus">+            let warningMsg = calProperties.formatStringFromName(&quot;WarningUsingGuessedTZ&quot;,</span>
<a href="#l60.269"></a><span id="l60.269">                               [tzId, offsetString, warningDetail, probableTZSource], 4);</span>
<a href="#l60.270"></a><span id="l60.270">             cal.WARN(warningMsg);</span>
<a href="#l60.271"></a><span id="l60.271">             break;</span>
<a href="#l60.272"></a><span id="l60.272">         }</span>
<a href="#l60.273"></a><span id="l60.273">     } catch (ex) { // don't abort if error occurs warning user</span>
<a href="#l60.274"></a><span id="l60.274">         Components.utils.reportError(ex);</span>
<a href="#l60.275"></a><span id="l60.275">     }</span>
<a href="#l60.276"></a><span id="l60.276"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -118,37 +118,37 @@ calTodo.prototype = {</span>
<a href="#l61.4"></a><span id="l61.4">     { cal: &quot;DUE&quot;, ics: &quot;dueTime&quot; },</span>
<a href="#l61.5"></a><span id="l61.5">     { cal: &quot;COMPLETED&quot;, ics: &quot;completedTime&quot; }],</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7">     set icalString(value) {</span>
<a href="#l61.8"></a><span id="l61.8">         this.icalComponent = getIcsService().parseICS(value, null);</span>
<a href="#l61.9"></a><span id="l61.9">     },</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11">     get icalString() {</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-        var calcomp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+        let calcomp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l61.14"></a><span id="l61.14">         calSetProdidVersion(calcomp);</span>
<a href="#l61.15"></a><span id="l61.15">         calcomp.addSubcomponent(this.icalComponent);</span>
<a href="#l61.16"></a><span id="l61.16">         return calcomp.serializeToICS();</span>
<a href="#l61.17"></a><span id="l61.17">     },</span>
<a href="#l61.18"></a><span id="l61.18"> </span>
<a href="#l61.19"></a><span id="l61.19">     get icalComponent() {</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineminus">-        var icssvc = getIcsService();</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineminus">-        var icalcomp = icssvc.createIcalComponent(&quot;VTODO&quot;);</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+        let icssvc = getIcsService();</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+        let icalcomp = icssvc.createIcalComponent(&quot;VTODO&quot;);</span>
<a href="#l61.24"></a><span id="l61.24">         this.fillIcalComponentFromBase(icalcomp);</span>
<a href="#l61.25"></a><span id="l61.25">         this.mapPropsToICS(icalcomp, this.icsEventPropMap);</span>
<a href="#l61.26"></a><span id="l61.26"> </span>
<a href="#l61.27"></a><span id="l61.27" class="difflineminus">-        var bagenum = this.propertyEnumerator;</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineplus">+        let bagenum = this.propertyEnumerator;</span>
<a href="#l61.29"></a><span id="l61.29">         while (bagenum.hasMoreElements()) {</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineminus">-            var iprop = bagenum.getNext().</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineplus">+            let iprop = bagenum.getNext().</span>
<a href="#l61.32"></a><span id="l61.32">                 QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l61.33"></a><span id="l61.33">             try {</span>
<a href="#l61.34"></a><span id="l61.34">                 if (!this.todoPromotedProps[iprop.name]) {</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineminus">-                    var icalprop = icssvc.createIcalProperty(iprop.name);</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineplus">+                    let icalprop = icssvc.createIcalProperty(iprop.name);</span>
<a href="#l61.37"></a><span id="l61.37">                     icalprop.value = iprop.value;</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineminus">-                    var propBucket = this.mPropertyParams[iprop.name];</span>
<a href="#l61.39"></a><span id="l61.39" class="difflineplus">+                    let propBucket = this.mPropertyParams[iprop.name];</span>
<a href="#l61.40"></a><span id="l61.40">                     if (propBucket) {</span>
<a href="#l61.41"></a><span id="l61.41">                         for (let paramName in propBucket) {</span>
<a href="#l61.42"></a><span id="l61.42">                             try {</span>
<a href="#l61.43"></a><span id="l61.43">                                 icalprop.setParameter(paramName, propBucket[paramName]);</span>
<a href="#l61.44"></a><span id="l61.44">                             } catch (e) {</span>
<a href="#l61.45"></a><span id="l61.45">                                 if (e.result == Components.results.NS_ERROR_ILLEGAL_VALUE) {</span>
<a href="#l61.46"></a><span id="l61.46">                                     // Illegal values should be ignored, but we could log them if</span>
<a href="#l61.47"></a><span id="l61.47">                                     // the user has enabled logging.</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineat">@@ -196,37 +196,37 @@ calTodo.prototype = {</span>
<a href="#l61.49"></a><span id="l61.49">     set entryDate(value) {</span>
<a href="#l61.50"></a><span id="l61.50">         this.modify();</span>
<a href="#l61.51"></a><span id="l61.51"> </span>
<a href="#l61.52"></a><span id="l61.52">         // We're about to change the start date of an item which probably</span>
<a href="#l61.53"></a><span id="l61.53">         // could break the associated calIRecurrenceInfo. We're calling</span>
<a href="#l61.54"></a><span id="l61.54">         // the appropriate method here to adjust the internal structure in</span>
<a href="#l61.55"></a><span id="l61.55">         // order to free clients from worrying about such details.</span>
<a href="#l61.56"></a><span id="l61.56">         if (this.parentItem == this) {</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineminus">-            var rec = this.recurrenceInfo;</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineplus">+            let rec = this.recurrenceInfo;</span>
<a href="#l61.59"></a><span id="l61.59">             if (rec) {</span>
<a href="#l61.60"></a><span id="l61.60">                 rec.onStartDateChange(value, this.entryDate);</span>
<a href="#l61.61"></a><span id="l61.61">             }</span>
<a href="#l61.62"></a><span id="l61.62">         }</span>
<a href="#l61.63"></a><span id="l61.63"> </span>
<a href="#l61.64"></a><span id="l61.64">         return this.setProperty(&quot;DTSTART&quot;, value);</span>
<a href="#l61.65"></a><span id="l61.65">     },</span>
<a href="#l61.66"></a><span id="l61.66"> </span>
<a href="#l61.67"></a><span id="l61.67">     get entryDate() {</span>
<a href="#l61.68"></a><span id="l61.68">         return this.getProperty(&quot;DTSTART&quot;);</span>
<a href="#l61.69"></a><span id="l61.69">     },</span>
<a href="#l61.70"></a><span id="l61.70"> </span>
<a href="#l61.71"></a><span id="l61.71">     mDueDate: undefined,</span>
<a href="#l61.72"></a><span id="l61.72">     get dueDate() {</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineminus">-        var dueDate = this.mDueDate;</span>
<a href="#l61.74"></a><span id="l61.74" class="difflineplus">+        let dueDate = this.mDueDate;</span>
<a href="#l61.75"></a><span id="l61.75">         if (dueDate === undefined) {</span>
<a href="#l61.76"></a><span id="l61.76">             dueDate = this.getProperty(&quot;DUE&quot;);</span>
<a href="#l61.77"></a><span id="l61.77">             if (!dueDate) {</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineminus">-                var entryDate = this.entryDate;</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineminus">-                var dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+                let entryDate = this.entryDate;</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+                let dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l61.82"></a><span id="l61.82">                 if (entryDate &amp;&amp; dur) {</span>
<a href="#l61.83"></a><span id="l61.83">                     // If there is a duration set on the todo, calculate the right end time.</span>
<a href="#l61.84"></a><span id="l61.84">                     dueDate = entryDate.clone();</span>
<a href="#l61.85"></a><span id="l61.85">                     dueDate.addDuration(cal.createDuration(dur));</span>
<a href="#l61.86"></a><span id="l61.86">                 }</span>
<a href="#l61.87"></a><span id="l61.87">             }</span>
<a href="#l61.88"></a><span id="l61.88">             this.mDueDate = dueDate;</span>
<a href="#l61.89"></a><span id="l61.89">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -29,17 +29,17 @@ calTransactionManager.prototype = {</span>
<a href="#l62.4"></a><span id="l62.4">     }),</span>
<a href="#l62.5"></a><span id="l62.5"> </span>
<a href="#l62.6"></a><span id="l62.6">     transactionManager: null,</span>
<a href="#l62.7"></a><span id="l62.7">     createAndCommitTxn: function cTM_createAndCommitTxn(aAction,</span>
<a href="#l62.8"></a><span id="l62.8">                                                         aItem,</span>
<a href="#l62.9"></a><span id="l62.9">                                                         aCalendar,</span>
<a href="#l62.10"></a><span id="l62.10">                                                         aOldItem,</span>
<a href="#l62.11"></a><span id="l62.11">                                                         aListener) {</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-        var txn = new calTransaction(aAction,</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+        let txn = new calTransaction(aAction,</span>
<a href="#l62.14"></a><span id="l62.14">                                      aItem,</span>
<a href="#l62.15"></a><span id="l62.15">                                      aCalendar,</span>
<a href="#l62.16"></a><span id="l62.16">                                      aOldItem,</span>
<a href="#l62.17"></a><span id="l62.17">                                      aListener);</span>
<a href="#l62.18"></a><span id="l62.18">         this.transactionManager.doTransaction(txn);</span>
<a href="#l62.19"></a><span id="l62.19">     },</span>
<a href="#l62.20"></a><span id="l62.20"> </span>
<a href="#l62.21"></a><span id="l62.21">     beginBatch: function cTM_beginBatch() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -41,17 +41,17 @@ var createRelation = _calIcalCreator(&quot;@m</span>
<a href="#l63.4"></a><span id="l63.4">                                      Components.interfaces.calIRelation);</span>
<a href="#l63.5"></a><span id="l63.5"> var createRecurrenceDate = _calIcalCreator(&quot;@mozilla.org/calendar/recurrence-date;1&quot;,</span>
<a href="#l63.6"></a><span id="l63.6">                                            Components.interfaces.calIRecurrenceDate);</span>
<a href="#l63.7"></a><span id="l63.7"> var createRecurrenceRule = _calIcalCreator(&quot;@mozilla.org/calendar/recurrence-rule;1&quot;,</span>
<a href="#l63.8"></a><span id="l63.8">                                            Components.interfaces.calIRecurrenceRule);</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10"> /* Returns a clean new calIRecurrenceInfo */</span>
<a href="#l63.11"></a><span id="l63.11"> function createRecurrenceInfo(aItem) {</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-    var recInfo = Components.classes[&quot;@mozilla.org/calendar/recurrence-info;1&quot;].</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+    let recInfo = Components.classes[&quot;@mozilla.org/calendar/recurrence-info;1&quot;].</span>
<a href="#l63.14"></a><span id="l63.14">            createInstance(Components.interfaces.calIRecurrenceInfo);</span>
<a href="#l63.15"></a><span id="l63.15">     recInfo.item = aItem;</span>
<a href="#l63.16"></a><span id="l63.16">     return recInfo;</span>
<a href="#l63.17"></a><span id="l63.17"> }</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19"> /* Shortcut to the calendar-manager service */</span>
<a href="#l63.20"></a><span id="l63.20"> function getCalendarManager() {</span>
<a href="#l63.21"></a><span id="l63.21">     return Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineat">@@ -195,17 +195,17 @@ function getRecentTimezones(aConvertZone</span>
<a href="#l63.23"></a><span id="l63.23">  *   http://www.w3.org/TR/CSS21/grammar.html#scanner</span>
<a href="#l63.24"></a><span id="l63.24">  *</span>
<a href="#l63.25"></a><span id="l63.25">  * @param aString       The unicode string to format</span>
<a href="#l63.26"></a><span id="l63.26">  * @return              The formatted string using only chars [_a-zA-Z0-9-]</span>
<a href="#l63.27"></a><span id="l63.27">  */</span>
<a href="#l63.28"></a><span id="l63.28"> function formatStringForCSSRule(aString) {</span>
<a href="#l63.29"></a><span id="l63.29">     function toReplacement(ch) {</span>
<a href="#l63.30"></a><span id="l63.30">         // char code is natural number (positive integer)</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-        var nat = ch.charCodeAt(0);</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+        let nat = ch.charCodeAt(0);</span>
<a href="#l63.33"></a><span id="l63.33">         switch (nat) {</span>
<a href="#l63.34"></a><span id="l63.34">             case 0x20: // space</span>
<a href="#l63.35"></a><span id="l63.35">                 return &quot;_&quot;;</span>
<a href="#l63.36"></a><span id="l63.36">             default:</span>
<a href="#l63.37"></a><span id="l63.37">                 return &quot;-ux&quot; + nat.toString(16) + &quot;-&quot;; // lowercase</span>
<a href="#l63.38"></a><span id="l63.38">         }</span>
<a href="#l63.39"></a><span id="l63.39">     }</span>
<a href="#l63.40"></a><span id="l63.40">     // Result must be lowercase or style rule will not work.</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineat">@@ -213,17 +213,17 @@ function formatStringForCSSRule(aString)</span>
<a href="#l63.42"></a><span id="l63.42"> }</span>
<a href="#l63.43"></a><span id="l63.43"> </span>
<a href="#l63.44"></a><span id="l63.44"> /**</span>
<a href="#l63.45"></a><span id="l63.45">  * Shared dialog functions</span>
<a href="#l63.46"></a><span id="l63.46">  * Gets the calendar directory, defaults to &lt;profile-dir&gt;/calendar</span>
<a href="#l63.47"></a><span id="l63.47">  */</span>
<a href="#l63.48"></a><span id="l63.48"> function getCalendarDirectory() {</span>
<a href="#l63.49"></a><span id="l63.49">     if (getCalendarDirectory.mDir === undefined) {</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineminus">-        var dir = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineplus">+        let dir = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l63.52"></a><span id="l63.52">         dir.append(&quot;calendar-data&quot;);</span>
<a href="#l63.53"></a><span id="l63.53">         if (!dir.exists()) {</span>
<a href="#l63.54"></a><span id="l63.54">             try {</span>
<a href="#l63.55"></a><span id="l63.55">                 dir.create(Components.interfaces.nsIFile.DIRECTORY_TYPE,</span>
<a href="#l63.56"></a><span id="l63.56">                            parseInt(&quot;0700&quot;, 8));</span>
<a href="#l63.57"></a><span id="l63.57">             } catch (exc) {</span>
<a href="#l63.58"></a><span id="l63.58">                 ASSERT(false, exc);</span>
<a href="#l63.59"></a><span id="l63.59">                 throw exc;</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineat">@@ -382,31 +382,31 @@ function makeURL(aUriString) {</span>
<a href="#l63.61"></a><span id="l63.61">     return Services.io.newURI(aUriString, null, null);</span>
<a href="#l63.62"></a><span id="l63.62"> }</span>
<a href="#l63.63"></a><span id="l63.63"> </span>
<a href="#l63.64"></a><span id="l63.64"> /**</span>
<a href="#l63.65"></a><span id="l63.65">  * Returns a calIDateTime that corresponds to the current time in the user's</span>
<a href="#l63.66"></a><span id="l63.66">  * default timezone.</span>
<a href="#l63.67"></a><span id="l63.67">  */</span>
<a href="#l63.68"></a><span id="l63.68"> function now() {</span>
<a href="#l63.69"></a><span id="l63.69" class="difflineminus">-    var d = cal.jsDateToDateTime(new Date());</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineplus">+    let d = cal.jsDateToDateTime(new Date());</span>
<a href="#l63.71"></a><span id="l63.71">     return d.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l63.72"></a><span id="l63.72"> }</span>
<a href="#l63.73"></a><span id="l63.73"> </span>
<a href="#l63.74"></a><span id="l63.74"> /**</span>
<a href="#l63.75"></a><span id="l63.75">  * Selects an item with id aItemId in the radio group with id aRadioGroupId</span>
<a href="#l63.76"></a><span id="l63.76">  *</span>
<a href="#l63.77"></a><span id="l63.77">  * @param aRadioGroupId  the id of the radio group which contains the item</span>
<a href="#l63.78"></a><span id="l63.78">  * @param aItemId        the item to be selected</span>
<a href="#l63.79"></a><span id="l63.79">  */</span>
<a href="#l63.80"></a><span id="l63.80"> function calRadioGroupSelectItem(aRadioGroupId, aItemId) {</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineminus">-    var radioGroup = document.getElementById(aRadioGroupId);</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineminus">-    var items = radioGroup.getElementsByTagName(&quot;radio&quot;);</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineminus">-    var index;</span>
<a href="#l63.84"></a><span id="l63.84" class="difflineminus">-    for (var i in items) {</span>
<a href="#l63.85"></a><span id="l63.85" class="difflineplus">+    let radioGroup = document.getElementById(aRadioGroupId);</span>
<a href="#l63.86"></a><span id="l63.86" class="difflineplus">+    let items = radioGroup.getElementsByTagName(&quot;radio&quot;);</span>
<a href="#l63.87"></a><span id="l63.87" class="difflineplus">+    let index;</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineplus">+    for (let i in items) {</span>
<a href="#l63.89"></a><span id="l63.89">         if (items[i].getAttribute(&quot;id&quot;) == aItemId) {</span>
<a href="#l63.90"></a><span id="l63.90">             index = i;</span>
<a href="#l63.91"></a><span id="l63.91">             break;</span>
<a href="#l63.92"></a><span id="l63.92">         }</span>
<a href="#l63.93"></a><span id="l63.93">     }</span>
<a href="#l63.94"></a><span id="l63.94">     ASSERT(index &amp;&amp; index != 0, &quot;Can't find radioGroup item to select.&quot;, true);</span>
<a href="#l63.95"></a><span id="l63.95">     radioGroup.selectedIndex = index;</span>
<a href="#l63.96"></a><span id="l63.96"> }</span>
<a href="#l63.97"></a><span id="l63.97" class="difflineat">@@ -682,39 +682,39 @@ function calGetString(aBundleName, aStri</span>
<a href="#l63.98"></a><span id="l63.98">         return s;</span>
<a href="#l63.99"></a><span id="l63.99">     }</span>
<a href="#l63.100"></a><span id="l63.100"> }</span>
<a href="#l63.101"></a><span id="l63.101"> </span>
<a href="#l63.102"></a><span id="l63.102"> /**</span>
<a href="#l63.103"></a><span id="l63.103">  * Make a UUID using the UUIDGenerator service available, we'll use that.</span>
<a href="#l63.104"></a><span id="l63.104">  */</span>
<a href="#l63.105"></a><span id="l63.105"> function getUUID() {</span>
<a href="#l63.106"></a><span id="l63.106" class="difflineminus">-    var uuidGen = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineplus">+    let uuidGen = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l63.108"></a><span id="l63.108">                   .getService(Components.interfaces.nsIUUIDGenerator);</span>
<a href="#l63.109"></a><span id="l63.109">     // generate uuids without braces to avoid problems with</span>
<a href="#l63.110"></a><span id="l63.110">     // CalDAV servers that don't support filenames with {}</span>
<a href="#l63.111"></a><span id="l63.111">     return uuidGen.generateUUID().toString().replace(/[{}]/g, '');</span>
<a href="#l63.112"></a><span id="l63.112"> }</span>
<a href="#l63.113"></a><span id="l63.113"> </span>
<a href="#l63.114"></a><span id="l63.114"> /**</span>
<a href="#l63.115"></a><span id="l63.115">  * Due to a bug in js-wrapping, normal == comparison can fail when we</span>
<a href="#l63.116"></a><span id="l63.116">  * have 2 objects.  Use these functions to force them both to get wrapped</span>
<a href="#l63.117"></a><span id="l63.117">  * the same way, allowing for normal comparison.</span>
<a href="#l63.118"></a><span id="l63.118">  */</span>
<a href="#l63.119"></a><span id="l63.119"> </span>
<a href="#l63.120"></a><span id="l63.120"> /**</span>
<a href="#l63.121"></a><span id="l63.121">  * calIItemBase comparer</span>
<a href="#l63.122"></a><span id="l63.122">  */</span>
<a href="#l63.123"></a><span id="l63.123"> function compareItems(aItem, aOtherItem) {</span>
<a href="#l63.124"></a><span id="l63.124" class="difflineminus">-    var sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.125"></a><span id="l63.125" class="difflineplus">+    let sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.126"></a><span id="l63.126">                createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l63.127"></a><span id="l63.127">     sip1.data = aItem;</span>
<a href="#l63.128"></a><span id="l63.128">     sip1.dataIID = Components.interfaces.calIItemBase;</span>
<a href="#l63.129"></a><span id="l63.129"> </span>
<a href="#l63.130"></a><span id="l63.130" class="difflineminus">-    var sip2 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.131"></a><span id="l63.131" class="difflineplus">+    let sip2 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.132"></a><span id="l63.132">                createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l63.133"></a><span id="l63.133">     sip2.data = aOtherItem;</span>
<a href="#l63.134"></a><span id="l63.134">     sip2.dataIID = Components.interfaces.calIItemBase;</span>
<a href="#l63.135"></a><span id="l63.135">     return sip1.data == sip2.data;</span>
<a href="#l63.136"></a><span id="l63.136"> }</span>
<a href="#l63.137"></a><span id="l63.137"> </span>
<a href="#l63.138"></a><span id="l63.138"> /**</span>
<a href="#l63.139"></a><span id="l63.139">  * Tries to get rid of wrappers. This is used to avoid cyclic references, and thus leaks.</span>
<a href="#l63.140"></a><span id="l63.140" class="difflineat">@@ -740,43 +740,43 @@ function compareObjects(aObject, aOtherO</span>
<a href="#l63.141"></a><span id="l63.141">     //           Anybody knows an official API that could be used for this purpose?</span>
<a href="#l63.142"></a><span id="l63.142">     //           For what reason do clients need to pass aIID since</span>
<a href="#l63.143"></a><span id="l63.143">     //           every XPCOM object has to implement nsISupports?</span>
<a href="#l63.144"></a><span id="l63.144">     //           XPCOM (like COM, like UNO, ...) defines that QueryInterface *only* needs to return</span>
<a href="#l63.145"></a><span id="l63.145">     //           the very same pointer for nsISupports during its lifetime.</span>
<a href="#l63.146"></a><span id="l63.146">     if (!aIID) {</span>
<a href="#l63.147"></a><span id="l63.147">         aIID = Components.interfaces.nsISupports;</span>
<a href="#l63.148"></a><span id="l63.148">     }</span>
<a href="#l63.149"></a><span id="l63.149" class="difflineminus">-    var sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.150"></a><span id="l63.150" class="difflineplus">+    let sip1 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.151"></a><span id="l63.151">                createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l63.152"></a><span id="l63.152">     sip1.data = aObject;</span>
<a href="#l63.153"></a><span id="l63.153">     sip1.dataIID = aIID;</span>
<a href="#l63.154"></a><span id="l63.154"> </span>
<a href="#l63.155"></a><span id="l63.155" class="difflineminus">-    var sip2 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.156"></a><span id="l63.156" class="difflineplus">+    let sip2 = Components.classes[&quot;@mozilla.org/supports-interface-pointer;1&quot;].</span>
<a href="#l63.157"></a><span id="l63.157">                createInstance(Components.interfaces.nsISupportsInterfacePointer);</span>
<a href="#l63.158"></a><span id="l63.158">     sip2.data = aOtherObject;</span>
<a href="#l63.159"></a><span id="l63.159">     sip2.dataIID = aIID;</span>
<a href="#l63.160"></a><span id="l63.160">     return sip1.data == sip2.data;</span>
<a href="#l63.161"></a><span id="l63.161"> }</span>
<a href="#l63.162"></a><span id="l63.162"> </span>
<a href="#l63.163"></a><span id="l63.163"> /**</span>
<a href="#l63.164"></a><span id="l63.164">  * Compare two arrays using the passed function.</span>
<a href="#l63.165"></a><span id="l63.165">  */</span>
<a href="#l63.166"></a><span id="l63.166"> function compareArrays(aOne, aTwo, compareFunc) {</span>
<a href="#l63.167"></a><span id="l63.167">     if (!aOne &amp;&amp; !aTwo) {</span>
<a href="#l63.168"></a><span id="l63.168">         return true;</span>
<a href="#l63.169"></a><span id="l63.169">     }</span>
<a href="#l63.170"></a><span id="l63.170">     if (!aOne || !aTwo) {</span>
<a href="#l63.171"></a><span id="l63.171">         return false;</span>
<a href="#l63.172"></a><span id="l63.172">     }</span>
<a href="#l63.173"></a><span id="l63.173" class="difflineminus">-    var len = aOne.length;</span>
<a href="#l63.174"></a><span id="l63.174" class="difflineplus">+    let len = aOne.length;</span>
<a href="#l63.175"></a><span id="l63.175">     if (len != aTwo.length) {</span>
<a href="#l63.176"></a><span id="l63.176">         return false;</span>
<a href="#l63.177"></a><span id="l63.177">     }</span>
<a href="#l63.178"></a><span id="l63.178" class="difflineminus">-    for (var i = 0; i &lt; len; ++i) {</span>
<a href="#l63.179"></a><span id="l63.179" class="difflineplus">+    for (let i = 0; i &lt; len; ++i) {</span>
<a href="#l63.180"></a><span id="l63.180">         if (!compareFunc(aOne[i], aTwo[i])) {</span>
<a href="#l63.181"></a><span id="l63.181">             return false;</span>
<a href="#l63.182"></a><span id="l63.182">         }</span>
<a href="#l63.183"></a><span id="l63.183">     }</span>
<a href="#l63.184"></a><span id="l63.184">     return true;</span>
<a href="#l63.185"></a><span id="l63.185"> }</span>
<a href="#l63.186"></a><span id="l63.186"> </span>
<a href="#l63.187"></a><span id="l63.187"> /**</span>
<a href="#l63.188"></a><span id="l63.188" class="difflineat">@@ -805,29 +805,29 @@ function doQueryInterface(aSelf, aProto,</span>
<a href="#l63.189"></a><span id="l63.189">             return aClassInfo;</span>
<a href="#l63.190"></a><span id="l63.190">         }</span>
<a href="#l63.191"></a><span id="l63.191">         if (!aList) {</span>
<a href="#l63.192"></a><span id="l63.192">             aList = aClassInfo.getInterfaces({});</span>
<a href="#l63.193"></a><span id="l63.193">         }</span>
<a href="#l63.194"></a><span id="l63.194">     }</span>
<a href="#l63.195"></a><span id="l63.195"> </span>
<a href="#l63.196"></a><span id="l63.196">     if (aList) {</span>
<a href="#l63.197"></a><span id="l63.197" class="difflineminus">-        for (var iid of aList) {</span>
<a href="#l63.198"></a><span id="l63.198" class="difflineplus">+        for (let iid of aList) {</span>
<a href="#l63.199"></a><span id="l63.199">             if (aIID.equals(iid)) {</span>
<a href="#l63.200"></a><span id="l63.200">                 return aSelf;</span>
<a href="#l63.201"></a><span id="l63.201">             }</span>
<a href="#l63.202"></a><span id="l63.202">         }</span>
<a href="#l63.203"></a><span id="l63.203">     }</span>
<a href="#l63.204"></a><span id="l63.204"> </span>
<a href="#l63.205"></a><span id="l63.205">     if (aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l63.206"></a><span id="l63.206">         return aSelf;</span>
<a href="#l63.207"></a><span id="l63.207">     }</span>
<a href="#l63.208"></a><span id="l63.208"> </span>
<a href="#l63.209"></a><span id="l63.209">     if (aProto) {</span>
<a href="#l63.210"></a><span id="l63.210" class="difflineminus">-        var base = aProto.__proto__;</span>
<a href="#l63.211"></a><span id="l63.211" class="difflineplus">+        let base = aProto.__proto__;</span>
<a href="#l63.212"></a><span id="l63.212">         if (base &amp;&amp; base.QueryInterface) {</span>
<a href="#l63.213"></a><span id="l63.213">             // Try to QI the base prototype</span>
<a href="#l63.214"></a><span id="l63.214">             return base.QueryInterface.call(aSelf, aIID);</span>
<a href="#l63.215"></a><span id="l63.215">         }</span>
<a href="#l63.216"></a><span id="l63.216">     }</span>
<a href="#l63.217"></a><span id="l63.217"> </span>
<a href="#l63.218"></a><span id="l63.218">     throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l63.219"></a><span id="l63.219"> }</span>
<a href="#l63.220"></a><span id="l63.220" class="difflineat">@@ -838,32 +838,32 @@ function doQueryInterface(aSelf, aProto,</span>
<a href="#l63.221"></a><span id="l63.221">  * the object is already a datetime, it will simply be returned.</span>
<a href="#l63.222"></a><span id="l63.222">  *</span>
<a href="#l63.223"></a><span id="l63.223">  * @param aDate  the date or datetime to check</span>
<a href="#l63.224"></a><span id="l63.224">  */</span>
<a href="#l63.225"></a><span id="l63.225"> function ensureDateTime(aDate) {</span>
<a href="#l63.226"></a><span id="l63.226">     if (!aDate || !aDate.isDate) {</span>
<a href="#l63.227"></a><span id="l63.227">         return aDate;</span>
<a href="#l63.228"></a><span id="l63.228">     }</span>
<a href="#l63.229"></a><span id="l63.229" class="difflineminus">-    var newDate = aDate.clone();</span>
<a href="#l63.230"></a><span id="l63.230" class="difflineplus">+    let newDate = aDate.clone();</span>
<a href="#l63.231"></a><span id="l63.231">     newDate.isDate = false;</span>
<a href="#l63.232"></a><span id="l63.232">     return newDate;</span>
<a href="#l63.233"></a><span id="l63.233"> }</span>
<a href="#l63.234"></a><span id="l63.234"> </span>
<a href="#l63.235"></a><span id="l63.235"> /**</span>
<a href="#l63.236"></a><span id="l63.236">  * Get the default event start date. This is the next full hour, or 23:00 if it</span>
<a href="#l63.237"></a><span id="l63.237">  * is past 23:00.</span>
<a href="#l63.238"></a><span id="l63.238">  *</span>
<a href="#l63.239"></a><span id="l63.239">  * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l63.240"></a><span id="l63.240">  *                            keeping the date and timezone intact.</span>
<a href="#l63.241"></a><span id="l63.241">  */</span>
<a href="#l63.242"></a><span id="l63.242"> function getDefaultStartDate(aReferenceDate) {</span>
<a href="#l63.243"></a><span id="l63.243" class="difflineminus">-    var startDate = now();</span>
<a href="#l63.244"></a><span id="l63.244" class="difflineplus">+    let startDate = now();</span>
<a href="#l63.245"></a><span id="l63.245">     if (aReferenceDate) {</span>
<a href="#l63.246"></a><span id="l63.246" class="difflineminus">-        var savedHour = startDate.hour;</span>
<a href="#l63.247"></a><span id="l63.247" class="difflineplus">+        let savedHour = startDate.hour;</span>
<a href="#l63.248"></a><span id="l63.248">         startDate = aReferenceDate;</span>
<a href="#l63.249"></a><span id="l63.249">         if (!startDate.isMutable) {</span>
<a href="#l63.250"></a><span id="l63.250">             startDate = startDate.clone();</span>
<a href="#l63.251"></a><span id="l63.251">         }</span>
<a href="#l63.252"></a><span id="l63.252">         startDate.isDate = false;</span>
<a href="#l63.253"></a><span id="l63.253">         startDate.hour = savedHour;</span>
<a href="#l63.254"></a><span id="l63.254">     }</span>
<a href="#l63.255"></a><span id="l63.255"> </span>
<a href="#l63.256"></a><span id="l63.256" class="difflineat">@@ -914,21 +914,21 @@ function _log(message, flag) {</span>
<a href="#l63.257"></a><span id="l63.257">  *              properties should be logged.</span>
<a href="#l63.258"></a><span id="l63.258">  */</span>
<a href="#l63.259"></a><span id="l63.259"> function LOG(aArg) {</span>
<a href="#l63.260"></a><span id="l63.260">     if (!Preferences.get(&quot;calendar.debug.log&quot;, false)) {</span>
<a href="#l63.261"></a><span id="l63.261">         return;</span>
<a href="#l63.262"></a><span id="l63.262">     }</span>
<a href="#l63.263"></a><span id="l63.263"> </span>
<a href="#l63.264"></a><span id="l63.264">     ASSERT(aArg, &quot;Bad log argument.&quot;, false);</span>
<a href="#l63.265"></a><span id="l63.265" class="difflineminus">-    var string = aArg;</span>
<a href="#l63.266"></a><span id="l63.266" class="difflineplus">+    let string = aArg;</span>
<a href="#l63.267"></a><span id="l63.267">     // We should just dump() both String objects, and string primitives.</span>
<a href="#l63.268"></a><span id="l63.268">     if (!(aArg instanceof String) &amp;&amp; !(typeof aArg == &quot;string&quot;)) {</span>
<a href="#l63.269"></a><span id="l63.269">         string = &quot;Logging object...\n&quot;;</span>
<a href="#l63.270"></a><span id="l63.270" class="difflineminus">-        for (var prop in aArg) {</span>
<a href="#l63.271"></a><span id="l63.271" class="difflineplus">+        for (let prop in aArg) {</span>
<a href="#l63.272"></a><span id="l63.272">             string += prop + ': ' + aArg[prop] + '\n';</span>
<a href="#l63.273"></a><span id="l63.273">         }</span>
<a href="#l63.274"></a><span id="l63.274">         string += &quot;End object\n&quot;;</span>
<a href="#l63.275"></a><span id="l63.275">     }</span>
<a href="#l63.276"></a><span id="l63.276"> </span>
<a href="#l63.277"></a><span id="l63.277">     dump(string + '\n');</span>
<a href="#l63.278"></a><span id="l63.278">     _log(string, Components.interfaces.nsIScriptError.infoFlag);</span>
<a href="#l63.279"></a><span id="l63.279"> }</span>
<a href="#l63.280"></a><span id="l63.280" class="difflineat">@@ -1013,23 +1013,23 @@ function showError(aMsg) {</span>
<a href="#l63.281"></a><span id="l63.281"> </span>
<a href="#l63.282"></a><span id="l63.282"> /**</span>
<a href="#l63.283"></a><span id="l63.283">  * Pick whichever of &quot;black&quot; or &quot;white&quot; will look better when used as a text</span>
<a href="#l63.284"></a><span id="l63.284">  * color against a background of bgColor.</span>
<a href="#l63.285"></a><span id="l63.285">  *</span>
<a href="#l63.286"></a><span id="l63.286">  * @param bgColor   the background color as a &quot;#RRGGBB&quot; string</span>
<a href="#l63.287"></a><span id="l63.287">  */</span>
<a href="#l63.288"></a><span id="l63.288"> function getContrastingTextColor(bgColor) {</span>
<a href="#l63.289"></a><span id="l63.289" class="difflineminus">-    var calcColor = bgColor.replace(/#/g, &quot;&quot;);</span>
<a href="#l63.290"></a><span id="l63.290" class="difflineminus">-    var red = parseInt(calcColor.substring(0, 2), 16);</span>
<a href="#l63.291"></a><span id="l63.291" class="difflineminus">-    var green = parseInt(calcColor.substring(2, 4), 16);</span>
<a href="#l63.292"></a><span id="l63.292" class="difflineminus">-    var blue = parseInt(calcColor.substring(4, 6), 16);</span>
<a href="#l63.293"></a><span id="l63.293" class="difflineplus">+    let calcColor = bgColor.replace(/#/g, &quot;&quot;);</span>
<a href="#l63.294"></a><span id="l63.294" class="difflineplus">+    let red = parseInt(calcColor.substring(0, 2), 16);</span>
<a href="#l63.295"></a><span id="l63.295" class="difflineplus">+    let green = parseInt(calcColor.substring(2, 4), 16);</span>
<a href="#l63.296"></a><span id="l63.296" class="difflineplus">+    let blue = parseInt(calcColor.substring(4, 6), 16);</span>
<a href="#l63.297"></a><span id="l63.297"> </span>
<a href="#l63.298"></a><span id="l63.298">     // Calculate the brightness (Y) value using the YUV color system.</span>
<a href="#l63.299"></a><span id="l63.299" class="difflineminus">-    var brightness = (0.299 * red) + (0.587 * green) + (0.114 * blue);</span>
<a href="#l63.300"></a><span id="l63.300" class="difflineplus">+    let brightness = (0.299 * red) + (0.587 * green) + (0.114 * blue);</span>
<a href="#l63.301"></a><span id="l63.301"> </span>
<a href="#l63.302"></a><span id="l63.302">     // Consider all colors with less than 56% brightness as dark colors and</span>
<a href="#l63.303"></a><span id="l63.303">     // use white as the foreground color, otherwise use black.</span>
<a href="#l63.304"></a><span id="l63.304">     if (brightness &lt; 144) {</span>
<a href="#l63.305"></a><span id="l63.305">         return &quot;white&quot;;</span>
<a href="#l63.306"></a><span id="l63.306">     }</span>
<a href="#l63.307"></a><span id="l63.307"> </span>
<a href="#l63.308"></a><span id="l63.308">     return &quot;black&quot;;</span>
<a href="#l63.309"></a><span id="l63.309" class="difflineat">@@ -1316,22 +1316,22 @@ calOperationGroup.prototype = {</span>
<a href="#l63.310"></a><span id="l63.310">     },</span>
<a href="#l63.311"></a><span id="l63.311"> </span>
<a href="#l63.312"></a><span id="l63.312">     cancel: function calOperationGroup_cancel(status) {</span>
<a href="#l63.313"></a><span id="l63.313">         if (this.isPending) {</span>
<a href="#l63.314"></a><span id="l63.314">             if (!status) {</span>
<a href="#l63.315"></a><span id="l63.315">                 status = Components.interfaces.calIErrors.OPERATION_CANCELLED;</span>
<a href="#l63.316"></a><span id="l63.316">             }</span>
<a href="#l63.317"></a><span id="l63.317">             this.notifyCompleted(status);</span>
<a href="#l63.318"></a><span id="l63.318" class="difflineminus">-            var cancelFunc = this.mCancelFunc;</span>
<a href="#l63.319"></a><span id="l63.319" class="difflineplus">+            let cancelFunc = this.mCancelFunc;</span>
<a href="#l63.320"></a><span id="l63.320">             if (cancelFunc) {</span>
<a href="#l63.321"></a><span id="l63.321">                 this.mCancelFunc = null;</span>
<a href="#l63.322"></a><span id="l63.322">                 cancelFunc();</span>
<a href="#l63.323"></a><span id="l63.323">             }</span>
<a href="#l63.324"></a><span id="l63.324" class="difflineminus">-            var subOperations = this.mSubOperations;</span>
<a href="#l63.325"></a><span id="l63.325" class="difflineplus">+            let subOperations = this.mSubOperations;</span>
<a href="#l63.326"></a><span id="l63.326">             this.mSubOperations = [];</span>
<a href="#l63.327"></a><span id="l63.327">             for (let op of subOperations) {</span>
<a href="#l63.328"></a><span id="l63.328">                 op.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l63.329"></a><span id="l63.329">             }</span>
<a href="#l63.330"></a><span id="l63.330">         }</span>
<a href="#l63.331"></a><span id="l63.331">     }</span>
<a href="#l63.332"></a><span id="l63.332"> };</span>
<a href="#l63.333"></a><span id="l63.333"> </span>
<a href="#l63.334"></a><span id="l63.334" class="difflineat">@@ -1385,26 +1385,26 @@ function calSetProdidVersion(aIcalCompon</span>
<a href="#l63.335"></a><span id="l63.335">  * applies a value to all children of a Menu. If the respective childnodes define</span>
<a href="#l63.336"></a><span id="l63.336">  * a command the value is applied to the attribute of thecommand of the childnode</span>
<a href="#l63.337"></a><span id="l63.337">  *</span>
<a href="#l63.338"></a><span id="l63.338">  * @param aElement The parentnode of the elements</span>
<a href="#l63.339"></a><span id="l63.339">  * @param aAttributeName The name of the attribute</span>
<a href="#l63.340"></a><span id="l63.340">  * @param aValue The value of the attribute</span>
<a href="#l63.341"></a><span id="l63.341">  */</span>
<a href="#l63.342"></a><span id="l63.342"> function applyAttributeToMenuChildren(aElement, aAttributeName, aValue) {</span>
<a href="#l63.343"></a><span id="l63.343" class="difflineminus">-   var sibling = aElement.firstChild;</span>
<a href="#l63.344"></a><span id="l63.344" class="difflineplus">+   let sibling = aElement.firstChild;</span>
<a href="#l63.345"></a><span id="l63.345">    do {</span>
<a href="#l63.346"></a><span id="l63.346">        if (sibling) {</span>
<a href="#l63.347"></a><span id="l63.347" class="difflineminus">-           var domObject = sibling;</span>
<a href="#l63.348"></a><span id="l63.348" class="difflineminus">-           var commandName = null;</span>
<a href="#l63.349"></a><span id="l63.349" class="difflineplus">+           let domObject = sibling;</span>
<a href="#l63.350"></a><span id="l63.350" class="difflineplus">+           let commandName = null;</span>
<a href="#l63.351"></a><span id="l63.351">            if (sibling.hasAttribute(&quot;command&quot;)){</span>
<a href="#l63.352"></a><span id="l63.352">                commandName = sibling.getAttribute(&quot;command&quot;);</span>
<a href="#l63.353"></a><span id="l63.353">            }</span>
<a href="#l63.354"></a><span id="l63.354">            if (commandName) {</span>
<a href="#l63.355"></a><span id="l63.355" class="difflineminus">-               var command = document.getElementById(commandName);</span>
<a href="#l63.356"></a><span id="l63.356" class="difflineplus">+               let command = document.getElementById(commandName);</span>
<a href="#l63.357"></a><span id="l63.357">                if (command) {</span>
<a href="#l63.358"></a><span id="l63.358">                    domObject = command;</span>
<a href="#l63.359"></a><span id="l63.359">                }</span>
<a href="#l63.360"></a><span id="l63.360">            }</span>
<a href="#l63.361"></a><span id="l63.361">            domObject.setAttribute(aAttributeName, aValue);</span>
<a href="#l63.362"></a><span id="l63.362">        sibling = sibling.nextSibling;</span>
<a href="#l63.363"></a><span id="l63.363">        }</span>
<a href="#l63.364"></a><span id="l63.364">     } while (sibling);</span>
<a href="#l63.365"></a><span id="l63.365" class="difflineat">@@ -1414,22 +1414,22 @@ function applyAttributeToMenuChildren(aE</span>
<a href="#l63.366"></a><span id="l63.366"> /**</span>
<a href="#l63.367"></a><span id="l63.367">  * compares the value of a property of an array of objects and returns</span>
<a href="#l63.368"></a><span id="l63.368">  * true or false if it is same or not among all array members</span>
<a href="#l63.369"></a><span id="l63.369">  *</span>
<a href="#l63.370"></a><span id="l63.370">  * @param aObjects An Array of Objects to inspect</span>
<a href="#l63.371"></a><span id="l63.371">  * @param aProperty Name the name of the Property of which the value is compared</span>
<a href="#l63.372"></a><span id="l63.372">  */</span>
<a href="#l63.373"></a><span id="l63.373"> function isPropertyValueSame(aObjects, aPropertyName) {</span>
<a href="#l63.374"></a><span id="l63.374" class="difflineminus">-    var value = null;</span>
<a href="#l63.375"></a><span id="l63.375" class="difflineminus">-    for (var i = 0; i &lt; aObjects.length; i++) {</span>
<a href="#l63.376"></a><span id="l63.376" class="difflineplus">+    let value = null;</span>
<a href="#l63.377"></a><span id="l63.377" class="difflineplus">+    for (let i = 0; i &lt; aObjects.length; i++) {</span>
<a href="#l63.378"></a><span id="l63.378">         if (!value) {</span>
<a href="#l63.379"></a><span id="l63.379">             value = aObjects[0][aPropertyName];</span>
<a href="#l63.380"></a><span id="l63.380">         }</span>
<a href="#l63.381"></a><span id="l63.381" class="difflineminus">-        var compValue = aObjects[i][aPropertyName];</span>
<a href="#l63.382"></a><span id="l63.382" class="difflineplus">+        let compValue = aObjects[i][aPropertyName];</span>
<a href="#l63.383"></a><span id="l63.383">         if (compValue != value) {</span>
<a href="#l63.384"></a><span id="l63.384">             return false;</span>
<a href="#l63.385"></a><span id="l63.385">         }</span>
<a href="#l63.386"></a><span id="l63.386">     }</span>
<a href="#l63.387"></a><span id="l63.387">     return true;</span>
<a href="#l63.388"></a><span id="l63.388"> }</span>
<a href="#l63.389"></a><span id="l63.389"> </span>
<a href="#l63.390"></a><span id="l63.390"> /**</span>
<a href="#l63.391"></a><span id="l63.391" class="difflineat">@@ -1440,17 +1440,17 @@ function isPropertyValueSame(aObjects, a</span>
<a href="#l63.392"></a><span id="l63.392">  * @param aLocalName  The localName of the to-be-returned parent</span>
<a href="#l63.393"></a><span id="l63.393">  *                      that is looked for.</span>
<a href="#l63.394"></a><span id="l63.394">  * @return            The parent with the given localName or the</span>
<a href="#l63.395"></a><span id="l63.395">  *                      given childNode 'aChildNode'. If no appropriate</span>
<a href="#l63.396"></a><span id="l63.396">  *                      parent node with aLocalName could be</span>
<a href="#l63.397"></a><span id="l63.397">  *                      retrieved it is returned 'null'.</span>
<a href="#l63.398"></a><span id="l63.398">  */</span>
<a href="#l63.399"></a><span id="l63.399"> function getParentNodeOrThis(aChildNode, aLocalName) {</span>
<a href="#l63.400"></a><span id="l63.400" class="difflineminus">-    var node = aChildNode;</span>
<a href="#l63.401"></a><span id="l63.401" class="difflineplus">+    let node = aChildNode;</span>
<a href="#l63.402"></a><span id="l63.402">     while (node &amp;&amp; (node.localName != aLocalName)) {</span>
<a href="#l63.403"></a><span id="l63.403">         node = node.parentNode;</span>
<a href="#l63.404"></a><span id="l63.404">         if (node.tagName == undefined) {</span>
<a href="#l63.405"></a><span id="l63.405">             return null;</span>
<a href="#l63.406"></a><span id="l63.406">         }</span>
<a href="#l63.407"></a><span id="l63.407">     }</span>
<a href="#l63.408"></a><span id="l63.408">     return node;</span>
<a href="#l63.409"></a><span id="l63.409"> }</span>
<a href="#l63.410"></a><span id="l63.410" class="difflineat">@@ -1463,29 +1463,29 @@ function getParentNodeOrThis(aChildNode,</span>
<a href="#l63.411"></a><span id="l63.411">  * @param aAttibuteName   The name of the attribute that is to be compared with</span>
<a href="#l63.412"></a><span id="l63.412">  * @param aAttibuteValue  The value of the attribute that is to be compared with</span>
<a href="#l63.413"></a><span id="l63.413">  * @return                The parent with the given attributeName set that has</span>
<a href="#l63.414"></a><span id="l63.414">  *                          the same value as the given given attributevalue</span>
<a href="#l63.415"></a><span id="l63.415">  *                          'aAttributeValue'. If no appropriate</span>
<a href="#l63.416"></a><span id="l63.416">  *                          parent node can be retrieved it is returned 'null'.</span>
<a href="#l63.417"></a><span id="l63.417">  */</span>
<a href="#l63.418"></a><span id="l63.418"> function getParentNodeOrThisByAttribute(aChildNode, aAttributeName, aAttributeValue) {</span>
<a href="#l63.419"></a><span id="l63.419" class="difflineminus">-    var node = aChildNode;</span>
<a href="#l63.420"></a><span id="l63.420" class="difflineplus">+    let node = aChildNode;</span>
<a href="#l63.421"></a><span id="l63.421">     while (node &amp;&amp; (node.getAttribute(aAttributeName) != aAttributeValue)) {</span>
<a href="#l63.422"></a><span id="l63.422">         node = node.parentNode;</span>
<a href="#l63.423"></a><span id="l63.423">         if (node.tagName == undefined) {</span>
<a href="#l63.424"></a><span id="l63.424">             return null;</span>
<a href="#l63.425"></a><span id="l63.425">         }</span>
<a href="#l63.426"></a><span id="l63.426">     }</span>
<a href="#l63.427"></a><span id="l63.427">     return node;</span>
<a href="#l63.428"></a><span id="l63.428"> }</span>
<a href="#l63.429"></a><span id="l63.429"> </span>
<a href="#l63.430"></a><span id="l63.430"> function setItemProperty(item, propertyName, aValue, aCapability) {</span>
<a href="#l63.431"></a><span id="l63.431" class="difflineminus">-    var isSupported = (item.calendar.getProperty(&quot;capabilities.&quot; + aCapability + &quot;.supported&quot;) !== false);</span>
<a href="#l63.432"></a><span id="l63.432" class="difflineminus">-    var value = (aCapability &amp;&amp; !isSupported ? null : aValue);</span>
<a href="#l63.433"></a><span id="l63.433" class="difflineplus">+    let isSupported = (item.calendar.getProperty(&quot;capabilities.&quot; + aCapability + &quot;.supported&quot;) !== false);</span>
<a href="#l63.434"></a><span id="l63.434" class="difflineplus">+    let value = (aCapability &amp;&amp; !isSupported ? null : aValue);</span>
<a href="#l63.435"></a><span id="l63.435"> </span>
<a href="#l63.436"></a><span id="l63.436">     switch (propertyName) {</span>
<a href="#l63.437"></a><span id="l63.437">         case &quot;startDate&quot;:</span>
<a href="#l63.438"></a><span id="l63.438">             if (value.isDate &amp;&amp; !item.startDate.isDate ||</span>
<a href="#l63.439"></a><span id="l63.439">                 !value.isDate &amp;&amp; item.startDate.isDate ||</span>
<a href="#l63.440"></a><span id="l63.440">                 !compareObjects(value.timezone, item.startDate.timezone) ||</span>
<a href="#l63.441"></a><span id="l63.441">                 value.compare(item.startDate) != 0) {</span>
<a href="#l63.442"></a><span id="l63.442">                 item.startDate = value;</span>
<a href="#l63.443"></a><span id="l63.443" class="difflineat">@@ -1573,19 +1573,19 @@ calPropertyBag.prototype = {</span>
<a href="#l63.444"></a><span id="l63.444">         // avoid strict undefined property warning</span>
<a href="#l63.445"></a><span id="l63.445">         return (aName in this.mData ? this.mData[aName] : undefined);</span>
<a href="#l63.446"></a><span id="l63.446">     },</span>
<a href="#l63.447"></a><span id="l63.447">     getProperty: function cpb_getProperty(aName) {</span>
<a href="#l63.448"></a><span id="l63.448">         // avoid strict undefined property warning</span>
<a href="#l63.449"></a><span id="l63.449">         return (aName in this.mData ? this.mData[aName] : null);</span>
<a href="#l63.450"></a><span id="l63.450">     },</span>
<a href="#l63.451"></a><span id="l63.451">     getAllProperties: function cpb_getAllProperties(aOutKeys, aOutValues) {</span>
<a href="#l63.452"></a><span id="l63.452" class="difflineminus">-        var keys = [];</span>
<a href="#l63.453"></a><span id="l63.453" class="difflineminus">-        var values = [];</span>
<a href="#l63.454"></a><span id="l63.454" class="difflineminus">-        for (var key in this.mData) {</span>
<a href="#l63.455"></a><span id="l63.455" class="difflineplus">+        let keys = [];</span>
<a href="#l63.456"></a><span id="l63.456" class="difflineplus">+        let values = [];</span>
<a href="#l63.457"></a><span id="l63.457" class="difflineplus">+        for (let key in this.mData) {</span>
<a href="#l63.458"></a><span id="l63.458">             keys.push(key);</span>
<a href="#l63.459"></a><span id="l63.459">             values.push(this.mData[key]);</span>
<a href="#l63.460"></a><span id="l63.460">         }</span>
<a href="#l63.461"></a><span id="l63.461">         aOutKeys.value = keys;</span>
<a href="#l63.462"></a><span id="l63.462">         aOutValues.value = values;</span>
<a href="#l63.463"></a><span id="l63.463">     },</span>
<a href="#l63.464"></a><span id="l63.464">     deleteProperty: function cpb_deleteProperty(aName) {</span>
<a href="#l63.465"></a><span id="l63.465">         delete this.mData[aName];</span>
<a href="#l63.466"></a><span id="l63.466" class="difflineat">@@ -1611,17 +1611,17 @@ calPropertyBagEnumerator.prototype = {</span>
<a href="#l63.467"></a><span id="l63.467">     mKeys: null,</span>
<a href="#l63.468"></a><span id="l63.468"> </span>
<a href="#l63.469"></a><span id="l63.469">     // nsISimpleEnumerator:</span>
<a href="#l63.470"></a><span id="l63.470">     getNext: function cpb_enum_getNext() {</span>
<a href="#l63.471"></a><span id="l63.471">         if (!this.hasMoreElements()) { // hasMoreElements is called by intention to skip yet deleted properties</span>
<a href="#l63.472"></a><span id="l63.472">             ASSERT(false, Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l63.473"></a><span id="l63.473">             throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l63.474"></a><span id="l63.474">         }</span>
<a href="#l63.475"></a><span id="l63.475" class="difflineminus">-        var name = this.mKeys[this.mIndex++];</span>
<a href="#l63.476"></a><span id="l63.476" class="difflineplus">+        let name = this.mKeys[this.mIndex++];</span>
<a href="#l63.477"></a><span id="l63.477">         return { // nsIProperty:</span>
<a href="#l63.478"></a><span id="l63.478">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIProperty]),</span>
<a href="#l63.479"></a><span id="l63.479">             name: name,</span>
<a href="#l63.480"></a><span id="l63.480">             value: this.mCurrentValue</span>
<a href="#l63.481"></a><span id="l63.481">         };</span>
<a href="#l63.482"></a><span id="l63.482">     },</span>
<a href="#l63.483"></a><span id="l63.483">     hasMoreElements: function cpb_enum_hasMoreElements() {</span>
<a href="#l63.484"></a><span id="l63.484">         while (this.mIndex &lt; this.mKeys.length) {</span>
<a href="#l63.485"></a><span id="l63.485" class="difflineat">@@ -1635,22 +1635,22 @@ calPropertyBagEnumerator.prototype = {</span>
<a href="#l63.486"></a><span id="l63.486">     }</span>
<a href="#l63.487"></a><span id="l63.487"> };</span>
<a href="#l63.488"></a><span id="l63.488"> </span>
<a href="#l63.489"></a><span id="l63.489"> /**</span>
<a href="#l63.490"></a><span id="l63.490">  * Iterates all email identities and calls the passed function with identity and account.</span>
<a href="#l63.491"></a><span id="l63.491">  * If the called function returns false, iteration is stopped.</span>
<a href="#l63.492"></a><span id="l63.492">  */</span>
<a href="#l63.493"></a><span id="l63.493"> function calIterateEmailIdentities(func) {</span>
<a href="#l63.494"></a><span id="l63.494" class="difflineminus">-    var accounts = MailServices.accounts.accounts;</span>
<a href="#l63.495"></a><span id="l63.495" class="difflineminus">-    for (var i = 0; i &lt; accounts.length; ++i) {</span>
<a href="#l63.496"></a><span id="l63.496" class="difflineminus">-        var account = accounts.queryElementAt(i, Components.interfaces.nsIMsgAccount);</span>
<a href="#l63.497"></a><span id="l63.497" class="difflineminus">-        var identities = account.identities;</span>
<a href="#l63.498"></a><span id="l63.498" class="difflineminus">-        for (var j = 0; j &lt; identities.length; ++j) {</span>
<a href="#l63.499"></a><span id="l63.499" class="difflineminus">-            var identity = identities.queryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l63.500"></a><span id="l63.500" class="difflineplus">+    let accounts = MailServices.accounts.accounts;</span>
<a href="#l63.501"></a><span id="l63.501" class="difflineplus">+    for (let i = 0; i &lt; accounts.length; ++i) {</span>
<a href="#l63.502"></a><span id="l63.502" class="difflineplus">+        let account = accounts.queryElementAt(i, Components.interfaces.nsIMsgAccount);</span>
<a href="#l63.503"></a><span id="l63.503" class="difflineplus">+        let identities = account.identities;</span>
<a href="#l63.504"></a><span id="l63.504" class="difflineplus">+        for (let j = 0; j &lt; identities.length; ++j) {</span>
<a href="#l63.505"></a><span id="l63.505" class="difflineplus">+            let identity = identities.queryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l63.506"></a><span id="l63.506">             if (!func(identity, account)) {</span>
<a href="#l63.507"></a><span id="l63.507">                 break;</span>
<a href="#l63.508"></a><span id="l63.508">             }</span>
<a href="#l63.509"></a><span id="l63.509">         }</span>
<a href="#l63.510"></a><span id="l63.510">     }</span>
<a href="#l63.511"></a><span id="l63.511"> }</span>
<a href="#l63.512"></a><span id="l63.512"> </span>
<a href="#l63.513"></a><span id="l63.513"> /**</span>
<a href="#l63.514"></a><span id="l63.514" class="difflineat">@@ -1746,18 +1746,18 @@ function compareItemContent(aFirstItem, </span>
<a href="#l63.515"></a><span id="l63.515">  */</span>
<a href="#l63.516"></a><span id="l63.516"> function binarySearch(itemArray, newItem, comptor) {</span>
<a href="#l63.517"></a><span id="l63.517">     function binarySearchInternal(low, high) {</span>
<a href="#l63.518"></a><span id="l63.518">         // Are we done yet?</span>
<a href="#l63.519"></a><span id="l63.519">         if (low == high) {</span>
<a href="#l63.520"></a><span id="l63.520">             return low + (comptor(newItem, itemArray[low]) &lt; 0 ? 0 : 1);</span>
<a href="#l63.521"></a><span id="l63.521">         }</span>
<a href="#l63.522"></a><span id="l63.522"> </span>
<a href="#l63.523"></a><span id="l63.523" class="difflineminus">-        var mid = Math.floor(low + ((high - low) / 2));</span>
<a href="#l63.524"></a><span id="l63.524" class="difflineminus">-        var q = comptor(newItem, itemArray[mid]);</span>
<a href="#l63.525"></a><span id="l63.525" class="difflineplus">+        let mid = Math.floor(low + ((high - low) / 2));</span>
<a href="#l63.526"></a><span id="l63.526" class="difflineplus">+        let q = comptor(newItem, itemArray[mid]);</span>
<a href="#l63.527"></a><span id="l63.527">         if (q &gt; 0) {</span>
<a href="#l63.528"></a><span id="l63.528">             return binarySearchInternal(mid + 1, high);</span>
<a href="#l63.529"></a><span id="l63.529">         } else if (q &lt; 0) {</span>
<a href="#l63.530"></a><span id="l63.530">             return binarySearchInternal(low, mid);</span>
<a href="#l63.531"></a><span id="l63.531">         } else {</span>
<a href="#l63.532"></a><span id="l63.532">             return mid;</span>
<a href="#l63.533"></a><span id="l63.533">         }</span>
<a href="#l63.534"></a><span id="l63.534">     }</span>
<a href="#l63.535"></a><span id="l63.535" class="difflineat">@@ -1815,17 +1815,17 @@ binaryInsertNode.defaultAccessor = n =&gt; </span>
<a href="#l63.536"></a><span id="l63.536">  * @param item                  The item to insert into the array.</span>
<a href="#l63.537"></a><span id="l63.537">  * @param comptor               A comparation function that can compare two items.</span>
<a href="#l63.538"></a><span id="l63.538">  * @param discardDuplicates     Use the comptor function to check if the item in</span>
<a href="#l63.539"></a><span id="l63.539">  *                                question is already in the array. If so, the</span>
<a href="#l63.540"></a><span id="l63.540">  *                                new item is not inserted.</span>
<a href="#l63.541"></a><span id="l63.541">  * @return                      The index of the new item.</span>
<a href="#l63.542"></a><span id="l63.542">  */</span>
<a href="#l63.543"></a><span id="l63.543"> function binaryInsert(itemArray, item, comptor, discardDuplicates) {</span>
<a href="#l63.544"></a><span id="l63.544" class="difflineminus">-    var newIndex = binarySearch(itemArray, item, comptor);</span>
<a href="#l63.545"></a><span id="l63.545" class="difflineplus">+    let newIndex = binarySearch(itemArray, item, comptor);</span>
<a href="#l63.546"></a><span id="l63.546"> </span>
<a href="#l63.547"></a><span id="l63.547">     if (newIndex &lt; 0) {</span>
<a href="#l63.548"></a><span id="l63.548">         itemArray.push(item);</span>
<a href="#l63.549"></a><span id="l63.549">         newIndex = 0;</span>
<a href="#l63.550"></a><span id="l63.550">     } else if (!discardDuplicates ||</span>
<a href="#l63.551"></a><span id="l63.551">                 comptor(itemArray[Math.min(newIndex, itemArray.length - 1)], item) != 0) {</span>
<a href="#l63.552"></a><span id="l63.552">         // Only add the item if duplicates should not be discarded, or if</span>
<a href="#l63.553"></a><span id="l63.553">         // they should and itemArray[newIndex] != item.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/base/src/calWeekInfoService.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/base/src/calWeekInfoService.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -51,69 +51,69 @@ calWeekInfoService.prototype = {</span>
<a href="#l64.4"></a><span id="l64.4">         // which may be part of first/last week in the other year.)</span>
<a href="#l64.5"></a><span id="l64.5">         // The Thursday of a week is the Thursday that follows the first day</span>
<a href="#l64.6"></a><span id="l64.6">         // of the week.</span>
<a href="#l64.7"></a><span id="l64.7">         // The week number of a day is the same as the week number of the first</span>
<a href="#l64.8"></a><span id="l64.8">         // day of the week. (This takes care of days near the start of the year,</span>
<a href="#l64.9"></a><span id="l64.9">         // which may be part of the week counted in the previous year.) So we</span>
<a href="#l64.10"></a><span id="l64.10">         // need the startWeekday.</span>
<a href="#l64.11"></a><span id="l64.11">         const SUNDAY = 0;</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-        var startWeekday = Preferences.get(&quot;calendar.week.start&quot;, SUNDAY); // default to monday per ISO8601 standard.</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+        let startWeekday = Preferences.get(&quot;calendar.week.start&quot;, SUNDAY); // default to monday per ISO8601 standard.</span>
<a href="#l64.14"></a><span id="l64.14"> </span>
<a href="#l64.15"></a><span id="l64.15">         // The number of days since the start of the week.</span>
<a href="#l64.16"></a><span id="l64.16">         // Notice that the result of the substraction might be negative.</span>
<a href="#l64.17"></a><span id="l64.17">         // We correct for that by adding 7, and then using the remainder operator.</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineminus">-        var sinceStartOfWeek = (aDateTime.weekday - startWeekday + 7) % 7;</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+        let sinceStartOfWeek = (aDateTime.weekday - startWeekday + 7) % 7;</span>
<a href="#l64.20"></a><span id="l64.20"> </span>
<a href="#l64.21"></a><span id="l64.21">         // The number of days to Thursday is the difference between Thursday</span>
<a href="#l64.22"></a><span id="l64.22">         // and the start-day of the week (again corrected for negative values).</span>
<a href="#l64.23"></a><span id="l64.23">         const THURSDAY = 4;</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineminus">-        var startToThursday = (THURSDAY - startWeekday + 7) % 7;</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineplus">+        let startToThursday = (THURSDAY - startWeekday + 7) % 7;</span>
<a href="#l64.26"></a><span id="l64.26"> </span>
<a href="#l64.27"></a><span id="l64.27">         // The yearday number of the Thursday this week.</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineminus">-        var thisWeeksThursday = aDateTime.yearday - sinceStartOfWeek + startToThursday;</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+        let thisWeeksThursday = aDateTime.yearday - sinceStartOfWeek + startToThursday;</span>
<a href="#l64.30"></a><span id="l64.30"> </span>
<a href="#l64.31"></a><span id="l64.31">         if (thisWeeksThursday &lt; 1) {</span>
<a href="#l64.32"></a><span id="l64.32">             // For the first few days of the year, we still are in week 52 or 53.</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineminus">-            var lastYearDate = aDateTime.clone();</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+            let lastYearDate = aDateTime.clone();</span>
<a href="#l64.35"></a><span id="l64.35">             lastYearDate.year -= 1;</span>
<a href="#l64.36"></a><span id="l64.36">             thisWeeksThursday += lastYearDate.endOfYear.yearday;</span>
<a href="#l64.37"></a><span id="l64.37">         } else if (thisWeeksThursday &gt; aDateTime.endOfYear.yearday) {</span>
<a href="#l64.38"></a><span id="l64.38">             // For the last few days of the year, we already are in week 1.</span>
<a href="#l64.39"></a><span id="l64.39">             thisWeeksThursday -= aDateTime.endOfYear.yearday;</span>
<a href="#l64.40"></a><span id="l64.40">         }</span>
<a href="#l64.41"></a><span id="l64.41"> </span>
<a href="#l64.42"></a><span id="l64.42" class="difflineminus">-        var weekNumber = Math.ceil(thisWeeksThursday / 7);</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+        let weekNumber = Math.ceil(thisWeeksThursday / 7);</span>
<a href="#l64.44"></a><span id="l64.44">         return weekNumber;</span>
<a href="#l64.45"></a><span id="l64.45">     },</span>
<a href="#l64.46"></a><span id="l64.46"> </span>
<a href="#l64.47"></a><span id="l64.47">     /**</span>
<a href="#l64.48"></a><span id="l64.48">      * gets the first day of a week of a passed day under consideration</span>
<a href="#l64.49"></a><span id="l64.49">      * of the preference setting &quot;calendar.week.start&quot;</span>
<a href="#l64.50"></a><span id="l64.50">      *</span>
<a href="#l64.51"></a><span id="l64.51">      * @param aDate     a date time object</span>
<a href="#l64.52"></a><span id="l64.52">      * @return          a dateTime-object denoting the first day of the week</span>
<a href="#l64.53"></a><span id="l64.53">      */</span>
<a href="#l64.54"></a><span id="l64.54">     getStartOfWeek: function(aDate) {</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineminus">-        var date = aDate.clone();</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+        let date = aDate.clone();</span>
<a href="#l64.57"></a><span id="l64.57">         date.isDate = true;</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-        var offset = (Preferences.get(&quot;calendar.week.start&quot;, 0) - aDate.weekday);</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+        let offset = (Preferences.get(&quot;calendar.week.start&quot;, 0) - aDate.weekday);</span>
<a href="#l64.60"></a><span id="l64.60">         if (offset &gt; 0) {</span>
<a href="#l64.61"></a><span id="l64.61">             date.day -= (7 - offset);</span>
<a href="#l64.62"></a><span id="l64.62">         } else {</span>
<a href="#l64.63"></a><span id="l64.63">             date.day += offset;</span>
<a href="#l64.64"></a><span id="l64.64">         }</span>
<a href="#l64.65"></a><span id="l64.65">         return date;</span>
<a href="#l64.66"></a><span id="l64.66">     },</span>
<a href="#l64.67"></a><span id="l64.67"> </span>
<a href="#l64.68"></a><span id="l64.68">     /**</span>
<a href="#l64.69"></a><span id="l64.69">      * gets the last day of a week of a passed day under consideration</span>
<a href="#l64.70"></a><span id="l64.70">      * of the preference setting &quot;calendar.week.start&quot;</span>
<a href="#l64.71"></a><span id="l64.71">      *</span>
<a href="#l64.72"></a><span id="l64.72">      * @param aDate     a date time object</span>
<a href="#l64.73"></a><span id="l64.73">      * @return          a dateTime-object denoting the last day of the week</span>
<a href="#l64.74"></a><span id="l64.74">      */</span>
<a href="#l64.75"></a><span id="l64.75">     getEndOfWeek: function(aDate) {</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineminus">-        var date = this.getStartOfWeek(aDate);</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineplus">+        let date = this.getStartOfWeek(aDate);</span>
<a href="#l64.78"></a><span id="l64.78">         date.day += 6;</span>
<a href="#l64.79"></a><span id="l64.79">         return date;</span>
<a href="#l64.80"></a><span id="l64.80">     }</span>
<a href="#l64.81"></a><span id="l64.81"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -140,17 +140,17 @@ var eventDialogCalendarObserver = {</span>
<a href="#l65.4"></a><span id="l65.4">  * Checks if the given calendar supports notifying attendees. The item is needed</span>
<a href="#l65.5"></a><span id="l65.5">  * since calendars may support notifications for only some types of items.</span>
<a href="#l65.6"></a><span id="l65.6">  *</span>
<a href="#l65.7"></a><span id="l65.7">  * @param {calICalendar} aCalendar  The calendar to check</span>
<a href="#l65.8"></a><span id="l65.8">  * @param {calIItemBase} aItem      The item to check support for</span>
<a href="#l65.9"></a><span id="l65.9">  */</span>
<a href="#l65.10"></a><span id="l65.10"> function canNotifyAttendees(aCalendar, aItem) {</span>
<a href="#l65.11"></a><span id="l65.11">     try {</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-        var calendar = aCalendar.QueryInterface(Components.interfaces.calISchedulingSupport);</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+        let calendar = aCalendar.QueryInterface(Components.interfaces.calISchedulingSupport);</span>
<a href="#l65.14"></a><span id="l65.14">         return (calendar.canNotify(&quot;REQUEST&quot;, aItem) &amp;&amp; calendar.canNotify(&quot;CANCEL&quot;, aItem));</span>
<a href="#l65.15"></a><span id="l65.15">     } catch (exc) {</span>
<a href="#l65.16"></a><span id="l65.16">         return false;</span>
<a href="#l65.17"></a><span id="l65.17">     }</span>
<a href="#l65.18"></a><span id="l65.18"> }</span>
<a href="#l65.19"></a><span id="l65.19"> </span>
<a href="#l65.20"></a><span id="l65.20"> /**</span>
<a href="#l65.21"></a><span id="l65.21">  * Sends an asynchronous message to the parent context that contains the</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -435,35 +435,35 @@ function onCommandCancel() {</span>
<a href="#l65.23"></a><span id="l65.23">         return true;</span>
<a href="#l65.24"></a><span id="l65.24">     }</span>
<a href="#l65.25"></a><span id="l65.25"> </span>
<a href="#l65.26"></a><span id="l65.26">     if (gInTab &amp;&amp; gTabInfoObject) {</span>
<a href="#l65.27"></a><span id="l65.27">         // Switch to the tab that the prompt refers to.</span>
<a href="#l65.28"></a><span id="l65.28">         gTabmail.switchToTab(gTabInfoObject);</span>
<a href="#l65.29"></a><span id="l65.29">     }</span>
<a href="#l65.30"></a><span id="l65.30"> </span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-    var promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineminus">-</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineminus">-    var promptTitle = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+    let promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineplus">+</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineplus">+    let promptTitle = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l65.37"></a><span id="l65.37">                                        isEvent(window.calendarItem) ?</span>
<a href="#l65.38"></a><span id="l65.38">                                           &quot;askSaveTitleEvent&quot; :</span>
<a href="#l65.39"></a><span id="l65.39">                                           &quot;askSaveTitleTask&quot;);</span>
<a href="#l65.40"></a><span id="l65.40" class="difflineminus">-    var promptMessage = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineplus">+    let promptMessage = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l65.42"></a><span id="l65.42">                                          isEvent(window.calendarItem) ?</span>
<a href="#l65.43"></a><span id="l65.43">                                             &quot;askSaveMessageEvent&quot; :</span>
<a href="#l65.44"></a><span id="l65.44">                                             &quot;askSaveMessageTask&quot;);</span>
<a href="#l65.45"></a><span id="l65.45"> </span>
<a href="#l65.46"></a><span id="l65.46" class="difflineminus">-    var flags = promptService.BUTTON_TITLE_SAVE *</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+    let flags = promptService.BUTTON_TITLE_SAVE *</span>
<a href="#l65.48"></a><span id="l65.48">                 promptService.BUTTON_POS_0 +</span>
<a href="#l65.49"></a><span id="l65.49">                 promptService.BUTTON_TITLE_CANCEL *</span>
<a href="#l65.50"></a><span id="l65.50">                 promptService.BUTTON_POS_1 +</span>
<a href="#l65.51"></a><span id="l65.51">                 promptService.BUTTON_TITLE_DONT_SAVE *</span>
<a href="#l65.52"></a><span id="l65.52">                 promptService.BUTTON_POS_2;</span>
<a href="#l65.53"></a><span id="l65.53"> </span>
<a href="#l65.54"></a><span id="l65.54" class="difflineminus">-    var choice = Services.prompt.confirmEx(null,</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+    let choice = Services.prompt.confirmEx(null,</span>
<a href="#l65.56"></a><span id="l65.56">                                            promptTitle,</span>
<a href="#l65.57"></a><span id="l65.57">                                            promptMessage,</span>
<a href="#l65.58"></a><span id="l65.58">                                            flags,</span>
<a href="#l65.59"></a><span id="l65.59">                                            null,</span>
<a href="#l65.60"></a><span id="l65.60">                                            null,</span>
<a href="#l65.61"></a><span id="l65.61">                                            null,</span>
<a href="#l65.62"></a><span id="l65.62">                                            null,</span>
<a href="#l65.63"></a><span id="l65.63">                                            {});</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineat">@@ -964,35 +964,35 @@ function toggleKeepDuration() {</span>
<a href="#l65.65"></a><span id="l65.65">  */</span>
<a href="#l65.66"></a><span id="l65.66"> function dateTimeControls2State(aStartDatepicker) {</span>
<a href="#l65.67"></a><span id="l65.67">     if (gIgnoreUpdate) {</span>
<a href="#l65.68"></a><span id="l65.68">         return;</span>
<a href="#l65.69"></a><span id="l65.69">     }</span>
<a href="#l65.70"></a><span id="l65.70">     let keepAttribute = document.getElementById(&quot;keepduration-button&quot;)</span>
<a href="#l65.71"></a><span id="l65.71">                                 .getAttribute(&quot;keep&quot;) == &quot;true&quot;;</span>
<a href="#l65.72"></a><span id="l65.72">     let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineminus">-    var startWidgetId;</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineminus">-    var endWidgetId;</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineplus">+    let startWidgetId;</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineplus">+    let endWidgetId;</span>
<a href="#l65.77"></a><span id="l65.77">     if (isEvent(window.calendarItem)) {</span>
<a href="#l65.78"></a><span id="l65.78">         startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l65.79"></a><span id="l65.79">         endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l65.80"></a><span id="l65.80">     } else {</span>
<a href="#l65.81"></a><span id="l65.81">         if (!getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;)) {</span>
<a href="#l65.82"></a><span id="l65.82">             gItemDuration = null;</span>
<a href="#l65.83"></a><span id="l65.83">         }</span>
<a href="#l65.84"></a><span id="l65.84">         if (!getElementValue(&quot;todo-has-duedate&quot;, &quot;checked&quot;)) {</span>
<a href="#l65.85"></a><span id="l65.85">             gItemDuration = null;</span>
<a href="#l65.86"></a><span id="l65.86">         }</span>
<a href="#l65.87"></a><span id="l65.87">         startWidgetId = &quot;todo-entrydate&quot;;</span>
<a href="#l65.88"></a><span id="l65.88">         endWidgetId = &quot;todo-duedate&quot;;</span>
<a href="#l65.89"></a><span id="l65.89">     }</span>
<a href="#l65.90"></a><span id="l65.90"> </span>
<a href="#l65.91"></a><span id="l65.91" class="difflineminus">-    var saveStartTime = gStartTime;</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineminus">-    var saveEndTime = gEndTime;</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineplus">+    let saveStartTime = gStartTime;</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineplus">+    let saveEndTime = gEndTime;</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l65.97"></a><span id="l65.97"> </span>
<a href="#l65.98"></a><span id="l65.98">     if (gStartTime) {</span>
<a href="#l65.99"></a><span id="l65.99">         // jsDate is always in OS timezone, thus we create a calIDateTime</span>
<a href="#l65.100"></a><span id="l65.100">         // object from the jsDate representation then we convert the timezone</span>
<a href="#l65.101"></a><span id="l65.101">         // in order to keep gStartTime in default timezone.</span>
<a href="#l65.102"></a><span id="l65.102">         if (gTimezonesEnabled || allDay) {</span>
<a href="#l65.103"></a><span id="l65.103">             gStartTime = cal.jsDateToDateTime(getElementValue(startWidgetId), gStartTimezone);</span>
<a href="#l65.104"></a><span id="l65.104">             gStartTime = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineat">@@ -1218,20 +1218,20 @@ function getRepeatTypeAndUntilDate(aItem</span>
<a href="#l65.106"></a><span id="l65.106">             } else {</span>
<a href="#l65.107"></a><span id="l65.107">                 gUntilDate = null;</span>
<a href="#l65.108"></a><span id="l65.108">             }</span>
<a href="#l65.109"></a><span id="l65.109">         }</span>
<a href="#l65.110"></a><span id="l65.110">     };</span>
<a href="#l65.111"></a><span id="l65.111"> </span>
<a href="#l65.112"></a><span id="l65.112">     if (recurrenceInfo) {</span>
<a href="#l65.113"></a><span id="l65.113">         repeatType = &quot;custom&quot;;</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineminus">-        var ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineminus">-        var rules = [];</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineminus">-        var exceptions = [];</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineminus">-        for (var r of ritems) {</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+        let ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+        let rules = [];</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineplus">+        let exceptions = [];</span>
<a href="#l65.121"></a><span id="l65.121" class="difflineplus">+        for (let r of ritems) {</span>
<a href="#l65.122"></a><span id="l65.122">             if (r.isNegative) {</span>
<a href="#l65.123"></a><span id="l65.123">                 exceptions.push(r);</span>
<a href="#l65.124"></a><span id="l65.124">             } else {</span>
<a href="#l65.125"></a><span id="l65.125">                 rules.push(r);</span>
<a href="#l65.126"></a><span id="l65.126">             }</span>
<a href="#l65.127"></a><span id="l65.127">         }</span>
<a href="#l65.128"></a><span id="l65.128">         if (rules.length == 1) {</span>
<a href="#l65.129"></a><span id="l65.129">             let rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineat">@@ -1373,17 +1373,17 @@ function saveDialog(item) {</span>
<a href="#l65.131"></a><span id="l65.131">     item.calendar = getCurrentCalendar();</span>
<a href="#l65.132"></a><span id="l65.132"> </span>
<a href="#l65.133"></a><span id="l65.133">     setItemProperty(item, &quot;title&quot;, getElementValue(&quot;item-title&quot;));</span>
<a href="#l65.134"></a><span id="l65.134">     setItemProperty(item, &quot;LOCATION&quot;, getElementValue(&quot;item-location&quot;));</span>
<a href="#l65.135"></a><span id="l65.135"> </span>
<a href="#l65.136"></a><span id="l65.136">     saveDateTime(item);</span>
<a href="#l65.137"></a><span id="l65.137"> </span>
<a href="#l65.138"></a><span id="l65.138">     if (isToDo(item)) {</span>
<a href="#l65.139"></a><span id="l65.139" class="difflineminus">-        var percentCompleteInteger = 0;</span>
<a href="#l65.140"></a><span id="l65.140" class="difflineplus">+        let percentCompleteInteger = 0;</span>
<a href="#l65.141"></a><span id="l65.141">         if (getElementValue(&quot;percent-complete-textbox&quot;) != &quot;&quot;) {</span>
<a href="#l65.142"></a><span id="l65.142">             percentCompleteInteger =</span>
<a href="#l65.143"></a><span id="l65.143">                 parseInt(getElementValue(&quot;percent-complete-textbox&quot;), 10);</span>
<a href="#l65.144"></a><span id="l65.144">         }</span>
<a href="#l65.145"></a><span id="l65.145">         if (percentCompleteInteger &lt; 0) {</span>
<a href="#l65.146"></a><span id="l65.146">             percentCompleteInteger = 0;</span>
<a href="#l65.147"></a><span id="l65.147">         } else if (percentCompleteInteger &gt; 100) {</span>
<a href="#l65.148"></a><span id="l65.148">             percentCompleteInteger = 100;</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineat">@@ -1394,33 +1394,33 @@ function saveDialog(item) {</span>
<a href="#l65.150"></a><span id="l65.150">     // Categories</span>
<a href="#l65.151"></a><span id="l65.151">     saveCategories(item);</span>
<a href="#l65.152"></a><span id="l65.152"> </span>
<a href="#l65.153"></a><span id="l65.153">     // Attachment</span>
<a href="#l65.154"></a><span id="l65.154">     // We want the attachments to be up to date, remove all first.</span>
<a href="#l65.155"></a><span id="l65.155">     item.removeAllAttachments();</span>
<a href="#l65.156"></a><span id="l65.156"> </span>
<a href="#l65.157"></a><span id="l65.157">     // Now add back the new ones</span>
<a href="#l65.158"></a><span id="l65.158" class="difflineminus">-    for (var hashId in gAttachMap) {</span>
<a href="#l65.159"></a><span id="l65.159" class="difflineminus">-        var att = gAttachMap[hashId];</span>
<a href="#l65.160"></a><span id="l65.160" class="difflineplus">+    for (let hashId in gAttachMap) {</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineplus">+        let att = gAttachMap[hashId];</span>
<a href="#l65.162"></a><span id="l65.162">         item.addAttachment(att);</span>
<a href="#l65.163"></a><span id="l65.163">     }</span>
<a href="#l65.164"></a><span id="l65.164"> </span>
<a href="#l65.165"></a><span id="l65.165">     // Description</span>
<a href="#l65.166"></a><span id="l65.166">     setItemProperty(item, &quot;DESCRIPTION&quot;, getElementValue(&quot;item-description&quot;));</span>
<a href="#l65.167"></a><span id="l65.167"> </span>
<a href="#l65.168"></a><span id="l65.168">     // Event Status</span>
<a href="#l65.169"></a><span id="l65.169">     if (isEvent(item)) {</span>
<a href="#l65.170"></a><span id="l65.170">         if (gConfig.status &amp;&amp; gConfig.status != &quot;NONE&quot;) {</span>
<a href="#l65.171"></a><span id="l65.171">             item.setProperty(&quot;STATUS&quot;, gConfig.status);</span>
<a href="#l65.172"></a><span id="l65.172">         } else {</span>
<a href="#l65.173"></a><span id="l65.173">             item.deleteProperty(&quot;STATUS&quot;);</span>
<a href="#l65.174"></a><span id="l65.174">         }</span>
<a href="#l65.175"></a><span id="l65.175">     } else {</span>
<a href="#l65.176"></a><span id="l65.176" class="difflineminus">-        var status = getElementValue(&quot;todo-status&quot;);</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineplus">+        let status = getElementValue(&quot;todo-status&quot;);</span>
<a href="#l65.178"></a><span id="l65.178">         if (status != &quot;COMPLETED&quot;) {</span>
<a href="#l65.179"></a><span id="l65.179">             item.completedDate = null;</span>
<a href="#l65.180"></a><span id="l65.180">         }</span>
<a href="#l65.181"></a><span id="l65.181">         setItemProperty(item, &quot;STATUS&quot;, (status != &quot;NONE&quot;) ? status : null);</span>
<a href="#l65.182"></a><span id="l65.182">     }</span>
<a href="#l65.183"></a><span id="l65.183"> </span>
<a href="#l65.184"></a><span id="l65.184">     // set the &quot;PRIORITY&quot; property if a valid priority has been</span>
<a href="#l65.185"></a><span id="l65.185">     // specified (any integer value except *null*) OR the item</span>
<a href="#l65.186"></a><span id="l65.186" class="difflineat">@@ -1442,30 +1442,30 @@ function saveDialog(item) {</span>
<a href="#l65.187"></a><span id="l65.187">     } else {</span>
<a href="#l65.188"></a><span id="l65.188">         item.deleteProperty(&quot;TRANSP&quot;);</span>
<a href="#l65.189"></a><span id="l65.189">     }</span>
<a href="#l65.190"></a><span id="l65.190"> </span>
<a href="#l65.191"></a><span id="l65.191">     // Privacy</span>
<a href="#l65.192"></a><span id="l65.192">     setItemProperty(item, &quot;CLASS&quot;, gConfig.privacy, &quot;privacy&quot;);</span>
<a href="#l65.193"></a><span id="l65.193"> </span>
<a href="#l65.194"></a><span id="l65.194">     if (item.status == &quot;COMPLETED&quot; &amp;&amp; isToDo(item)) {</span>
<a href="#l65.195"></a><span id="l65.195" class="difflineminus">-        var elementValue = getElementValue(&quot;completed-date-picker&quot;);</span>
<a href="#l65.196"></a><span id="l65.196" class="difflineplus">+        let elementValue = getElementValue(&quot;completed-date-picker&quot;);</span>
<a href="#l65.197"></a><span id="l65.197">         item.completedDate = cal.jsDateToDateTime(elementValue);</span>
<a href="#l65.198"></a><span id="l65.198">     }</span>
<a href="#l65.199"></a><span id="l65.199"> </span>
<a href="#l65.200"></a><span id="l65.200">     saveReminder(item);</span>
<a href="#l65.201"></a><span id="l65.201"> }</span>
<a href="#l65.202"></a><span id="l65.202"> </span>
<a href="#l65.203"></a><span id="l65.203"> /**</span>
<a href="#l65.204"></a><span id="l65.204">  * Save date and time related values from the dialog to the passed item.</span>
<a href="#l65.205"></a><span id="l65.205">  *</span>
<a href="#l65.206"></a><span id="l65.206">  * @param item    The item to save to.</span>
<a href="#l65.207"></a><span id="l65.207">  */</span>
<a href="#l65.208"></a><span id="l65.208"> function saveDateTime(item) {</span>
<a href="#l65.209"></a><span id="l65.209" class="difflineminus">-    var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l65.210"></a><span id="l65.210" class="difflineplus">+    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l65.211"></a><span id="l65.211"> </span>
<a href="#l65.212"></a><span id="l65.212">     // Changes to the start date don't have to change the until date.</span>
<a href="#l65.213"></a><span id="l65.213">     untilDateCompensation(item);</span>
<a href="#l65.214"></a><span id="l65.214"> </span>
<a href="#l65.215"></a><span id="l65.215">     if (isEvent(item)) {</span>
<a href="#l65.216"></a><span id="l65.216">         let startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l65.217"></a><span id="l65.217">         let endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l65.218"></a><span id="l65.218">         let isAllDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l65.219"></a><span id="l65.219" class="difflineat">@@ -1556,18 +1556,18 @@ function updateAccept() {</span>
<a href="#l65.220"></a><span id="l65.220">         startDate = getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;) ?</span>
<a href="#l65.221"></a><span id="l65.221">             cal.jsDateToDateTime(getElementValue(&quot;todo-entrydate&quot;)) : null;</span>
<a href="#l65.222"></a><span id="l65.222">         endDate = getElementValue(&quot;todo-has-duedate&quot;, &quot;checked&quot;) ?</span>
<a href="#l65.223"></a><span id="l65.223">             cal.jsDateToDateTime(getElementValue(&quot;todo-duedate&quot;)) : null;</span>
<a href="#l65.224"></a><span id="l65.224">     }</span>
<a href="#l65.225"></a><span id="l65.225"> </span>
<a href="#l65.226"></a><span id="l65.226">     if (startDate &amp;&amp; endDate) {</span>
<a href="#l65.227"></a><span id="l65.227">         if (gTimezonesEnabled) {</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineminus">-            var startTimezone = gStartTimezone;</span>
<a href="#l65.229"></a><span id="l65.229" class="difflineminus">-            var endTimezone = gEndTimezone;</span>
<a href="#l65.230"></a><span id="l65.230" class="difflineplus">+            let startTimezone = gStartTimezone;</span>
<a href="#l65.231"></a><span id="l65.231" class="difflineplus">+            let endTimezone = gEndTimezone;</span>
<a href="#l65.232"></a><span id="l65.232">             if (endTimezone.isUTC) {</span>
<a href="#l65.233"></a><span id="l65.233">                 if (!compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l65.234"></a><span id="l65.234">                     endTimezone = gStartTimezone;</span>
<a href="#l65.235"></a><span id="l65.235">                 }</span>
<a href="#l65.236"></a><span id="l65.236">             }</span>
<a href="#l65.237"></a><span id="l65.237"> </span>
<a href="#l65.238"></a><span id="l65.238">             startDate = startDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l65.239"></a><span id="l65.239">             endDate = endDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l65.240"></a><span id="l65.240" class="difflineat">@@ -1716,28 +1716,28 @@ function updateAllDay() {</span>
<a href="#l65.241"></a><span id="l65.241">     updateAccept();</span>
<a href="#l65.242"></a><span id="l65.242"> }</span>
<a href="#l65.243"></a><span id="l65.243"> </span>
<a href="#l65.244"></a><span id="l65.244"> /**</span>
<a href="#l65.245"></a><span id="l65.245">  * Use the window arguments to cause the opener to create a new event on the</span>
<a href="#l65.246"></a><span id="l65.246">  * item's calendar</span>
<a href="#l65.247"></a><span id="l65.247">  */</span>
<a href="#l65.248"></a><span id="l65.248"> function openNewEvent() {</span>
<a href="#l65.249"></a><span id="l65.249" class="difflineminus">-    var item = window.calendarItem;</span>
<a href="#l65.250"></a><span id="l65.250" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l65.251"></a><span id="l65.251" class="difflineplus">+    let item = window.calendarItem;</span>
<a href="#l65.252"></a><span id="l65.252" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l65.253"></a><span id="l65.253">     args.onNewEvent(item.calendar);</span>
<a href="#l65.254"></a><span id="l65.254"> }</span>
<a href="#l65.255"></a><span id="l65.255"> </span>
<a href="#l65.256"></a><span id="l65.256"> /**</span>
<a href="#l65.257"></a><span id="l65.257">  * Use the window arguments to cause the opener to create a new event on the</span>
<a href="#l65.258"></a><span id="l65.258">  * item's calendar</span>
<a href="#l65.259"></a><span id="l65.259">  */</span>
<a href="#l65.260"></a><span id="l65.260"> function openNewTask() {</span>
<a href="#l65.261"></a><span id="l65.261" class="difflineminus">-    var item = window.calendarItem;</span>
<a href="#l65.262"></a><span id="l65.262" class="difflineminus">-    var args = window.arguments[0];</span>
<a href="#l65.263"></a><span id="l65.263" class="difflineplus">+    let item = window.calendarItem;</span>
<a href="#l65.264"></a><span id="l65.264" class="difflineplus">+    let args = window.arguments[0];</span>
<a href="#l65.265"></a><span id="l65.265">     args.onNewTodo(item.calendar);</span>
<a href="#l65.266"></a><span id="l65.266"> }</span>
<a href="#l65.267"></a><span id="l65.267"> </span>
<a href="#l65.268"></a><span id="l65.268"> /**</span>
<a href="#l65.269"></a><span id="l65.269">  * Open a new Thunderbird compose window.</span>
<a href="#l65.270"></a><span id="l65.270">  */</span>
<a href="#l65.271"></a><span id="l65.271"> function openNewMessage() {</span>
<a href="#l65.272"></a><span id="l65.272">     MailServices.compose.OpenComposeWindow(null,</span>
<a href="#l65.273"></a><span id="l65.273" class="difflineat">@@ -1769,17 +1769,17 @@ function setShowTimeAs(allDay) {</span>
<a href="#l65.274"></a><span id="l65.274">     gConfig.showTimeAs = cal.getEventDefaultTransparency(allDay);</span>
<a href="#l65.275"></a><span id="l65.275">     updateConfigState({ showTimeAs: gConfig.showTimeAs });</span>
<a href="#l65.276"></a><span id="l65.276"> }</span>
<a href="#l65.277"></a><span id="l65.277"> </span>
<a href="#l65.278"></a><span id="l65.278"> function editAttendees() {</span>
<a href="#l65.279"></a><span id="l65.279">     let savedWindow = window;</span>
<a href="#l65.280"></a><span id="l65.280">     let calendar = getCurrentCalendar();</span>
<a href="#l65.281"></a><span id="l65.281"> </span>
<a href="#l65.282"></a><span id="l65.282" class="difflineminus">-    var callback = function(attendees, organizer, startTime, endTime) {</span>
<a href="#l65.283"></a><span id="l65.283" class="difflineplus">+    let callback = function(attendees, organizer, startTime, endTime) {</span>
<a href="#l65.284"></a><span id="l65.284">         savedWindow.attendees = attendees;</span>
<a href="#l65.285"></a><span id="l65.285">         if (organizer) {</span>
<a href="#l65.286"></a><span id="l65.286">             // In case we didn't have an organizer object before we</span>
<a href="#l65.287"></a><span id="l65.287">             // added attendees to our event we take the one created</span>
<a href="#l65.288"></a><span id="l65.288">             // by the 'invite attendee'-dialog.</span>
<a href="#l65.289"></a><span id="l65.289">             if (savedWindow.organizer) {</span>
<a href="#l65.290"></a><span id="l65.290">                 // The other case is that we already had an organizer object</span>
<a href="#l65.291"></a><span id="l65.291">                 // before we went throught the 'invite attendee'-dialog. In that</span>
<a href="#l65.292"></a><span id="l65.292" class="difflineat">@@ -1796,46 +1796,46 @@ function editAttendees() {</span>
<a href="#l65.293"></a><span id="l65.293">                     organizer.participationStatus = null;</span>
<a href="#l65.294"></a><span id="l65.294">                 }</span>
<a href="#l65.295"></a><span id="l65.295">                 if (!savedWindow.organizer.commonName) {</span>
<a href="#l65.296"></a><span id="l65.296">                     organizer.commonName = null;</span>
<a href="#l65.297"></a><span id="l65.297">                 }</span>
<a href="#l65.298"></a><span id="l65.298">             }</span>
<a href="#l65.299"></a><span id="l65.299">             savedWindow.organizer = organizer;</span>
<a href="#l65.300"></a><span id="l65.300">         }</span>
<a href="#l65.301"></a><span id="l65.301" class="difflineminus">-        var duration = endTime.subtractDate(startTime);</span>
<a href="#l65.302"></a><span id="l65.302" class="difflineplus">+        let duration = endTime.subtractDate(startTime);</span>
<a href="#l65.303"></a><span id="l65.303">         startTime = startTime.clone();</span>
<a href="#l65.304"></a><span id="l65.304">         endTime = endTime.clone();</span>
<a href="#l65.305"></a><span id="l65.305" class="difflineminus">-        var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l65.306"></a><span id="l65.306" class="difflineplus">+        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l65.307"></a><span id="l65.307">         gStartTimezone = startTime.timezone;</span>
<a href="#l65.308"></a><span id="l65.308">         gEndTimezone = endTime.timezone;</span>
<a href="#l65.309"></a><span id="l65.309">         gStartTime = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l65.310"></a><span id="l65.310">         gEndTime = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l65.311"></a><span id="l65.311">         gItemDuration = duration;</span>
<a href="#l65.312"></a><span id="l65.312">         updateAttendees();</span>
<a href="#l65.313"></a><span id="l65.313">         updateDateTime();</span>
<a href="#l65.314"></a><span id="l65.314">         updateAllDay();</span>
<a href="#l65.315"></a><span id="l65.315">         if (isAllDay != gStartTime.isDate){</span>
<a href="#l65.316"></a><span id="l65.316">             setShowTimeAs(gStartTime.isDate);</span>
<a href="#l65.317"></a><span id="l65.317">         }</span>
<a href="#l65.318"></a><span id="l65.318">     };</span>
<a href="#l65.319"></a><span id="l65.319"> </span>
<a href="#l65.320"></a><span id="l65.320" class="difflineminus">-    var startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l65.321"></a><span id="l65.321" class="difflineminus">-    var endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l65.322"></a><span id="l65.322" class="difflineminus">-</span>
<a href="#l65.323"></a><span id="l65.323" class="difflineminus">-    var isAllDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineplus">+    let startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineplus">+    let endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineplus">+</span>
<a href="#l65.327"></a><span id="l65.327" class="difflineplus">+    let isAllDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l65.328"></a><span id="l65.328">     if (isAllDay) {</span>
<a href="#l65.329"></a><span id="l65.329">         startTime.isDate = true;</span>
<a href="#l65.330"></a><span id="l65.330">         endTime.isDate = true;</span>
<a href="#l65.331"></a><span id="l65.331">         endTime.day += 1;</span>
<a href="#l65.332"></a><span id="l65.332">     } else {</span>
<a href="#l65.333"></a><span id="l65.333">         startTime.isDate = false;</span>
<a href="#l65.334"></a><span id="l65.334">         endTime.isDate = false;</span>
<a href="#l65.335"></a><span id="l65.335">     }</span>
<a href="#l65.336"></a><span id="l65.336" class="difflineminus">-    var args = {};</span>
<a href="#l65.337"></a><span id="l65.337" class="difflineplus">+    let args = {};</span>
<a href="#l65.338"></a><span id="l65.338">     args.startTime = startTime;</span>
<a href="#l65.339"></a><span id="l65.339">     args.endTime = endTime;</span>
<a href="#l65.340"></a><span id="l65.340">     args.displayTimezone = gTimezonesEnabled;</span>
<a href="#l65.341"></a><span id="l65.341">     args.attendees = window.attendees;</span>
<a href="#l65.342"></a><span id="l65.342">     args.organizer = window.organizer &amp;&amp; window.organizer.clone();</span>
<a href="#l65.343"></a><span id="l65.343">     args.calendar = calendar;</span>
<a href="#l65.344"></a><span id="l65.344">     args.item = window.calendarItem;</span>
<a href="#l65.345"></a><span id="l65.345">     args.onOk = callback;</span>
<a href="#l65.346"></a><span id="l65.346" class="difflineat">@@ -1950,28 +1950,28 @@ function loadCloudProviders() {</span>
<a href="#l65.347"></a><span id="l65.347"> }</span>
<a href="#l65.348"></a><span id="l65.348"> </span>
<a href="#l65.349"></a><span id="l65.349"> /**</span>
<a href="#l65.350"></a><span id="l65.350">  * Prompts the user to attach an url to this item.</span>
<a href="#l65.351"></a><span id="l65.351">  */</span>
<a href="#l65.352"></a><span id="l65.352"> function attachURL() {</span>
<a href="#l65.353"></a><span id="l65.353">     if (Services.prompt) {</span>
<a href="#l65.354"></a><span id="l65.354">         // ghost in an example...</span>
<a href="#l65.355"></a><span id="l65.355" class="difflineminus">-        var result = { value: &quot;http://&quot; };</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineplus">+        let result = { value: &quot;http://&quot; };</span>
<a href="#l65.357"></a><span id="l65.357">         if (Services.prompt.prompt(window,</span>
<a href="#l65.358"></a><span id="l65.358">                                    calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l65.359"></a><span id="l65.359">                                                 &quot;specifyLinkLocation&quot;),</span>
<a href="#l65.360"></a><span id="l65.360">                                    calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l65.361"></a><span id="l65.361">                                                 &quot;enterLinkLocation&quot;),</span>
<a href="#l65.362"></a><span id="l65.362">                                    result,</span>
<a href="#l65.363"></a><span id="l65.363">                                    null,</span>
<a href="#l65.364"></a><span id="l65.364">                                    { value: 0 })) {</span>
<a href="#l65.365"></a><span id="l65.365">             try {</span>
<a href="#l65.366"></a><span id="l65.366">                 // If something bogus was entered, makeURL may fail.</span>
<a href="#l65.367"></a><span id="l65.367" class="difflineminus">-                var attachment = createAttachment();</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineplus">+                let attachment = createAttachment();</span>
<a href="#l65.369"></a><span id="l65.369">                 attachment.uri = makeURL(result.value);</span>
<a href="#l65.370"></a><span id="l65.370">                 addAttachment(attachment);</span>
<a href="#l65.371"></a><span id="l65.371">             } catch (e) {</span>
<a href="#l65.372"></a><span id="l65.372">                 // TODO We might want to show a warning instead of just not</span>
<a href="#l65.373"></a><span id="l65.373">                 // adding the file</span>
<a href="#l65.374"></a><span id="l65.374">             }</span>
<a href="#l65.375"></a><span id="l65.375">         }</span>
<a href="#l65.376"></a><span id="l65.376">     }</span>
<a href="#l65.377"></a><span id="l65.377" class="difflineat">@@ -2060,35 +2060,35 @@ function attachFile(cloudProvider) {</span>
<a href="#l65.378"></a><span id="l65.378">  * @param aFileUri    (optional) If passed, the last directory will be set and</span>
<a href="#l65.379"></a><span id="l65.379">  *                                 returned. If null, the last chosen directory</span>
<a href="#l65.380"></a><span id="l65.380">  *                                 will be returned.</span>
<a href="#l65.381"></a><span id="l65.381">  * @return            The last directory that was set with this function.</span>
<a href="#l65.382"></a><span id="l65.382">  */</span>
<a href="#l65.383"></a><span id="l65.383"> function lastDirectory(aFileUri) {</span>
<a href="#l65.384"></a><span id="l65.384">     if (aFileUri) {</span>
<a href="#l65.385"></a><span id="l65.385">         // Act similar to a setter, save the passed uri.</span>
<a href="#l65.386"></a><span id="l65.386" class="difflineminus">-        var uri = makeURL(aFileUri);</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineminus">-        var file = uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l65.388"></a><span id="l65.388" class="difflineplus">+        let uri = makeURL(aFileUri);</span>
<a href="#l65.389"></a><span id="l65.389" class="difflineplus">+        let file = uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l65.390"></a><span id="l65.390">         lastDirectory.mValue = file.parent.QueryInterface(Components.interfaces.nsILocalFile);</span>
<a href="#l65.391"></a><span id="l65.391">     }</span>
<a href="#l65.392"></a><span id="l65.392"> </span>
<a href="#l65.393"></a><span id="l65.393">     // In any case, return the value</span>
<a href="#l65.394"></a><span id="l65.394">     return (lastDirectory.mValue !== undefined ? lastDirectory.mValue : null);</span>
<a href="#l65.395"></a><span id="l65.395"> }</span>
<a href="#l65.396"></a><span id="l65.396"> </span>
<a href="#l65.397"></a><span id="l65.397"> /**</span>
<a href="#l65.398"></a><span id="l65.398">  * Turns an url into a string that can be used in UI.</span>
<a href="#l65.399"></a><span id="l65.399">  * - For a file:// url, shows the filename.</span>
<a href="#l65.400"></a><span id="l65.400">  * - For a http:// url, removes protocol and trailing slash</span>
<a href="#l65.401"></a><span id="l65.401">  *</span>
<a href="#l65.402"></a><span id="l65.402">  * @param aUri    The uri to parse.</span>
<a href="#l65.403"></a><span id="l65.403">  * @return        A string that can be used in UI.</span>
<a href="#l65.404"></a><span id="l65.404">  */</span>
<a href="#l65.405"></a><span id="l65.405"> function makePrettyName(aUri){</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineminus">-    var name = aUri.spec;</span>
<a href="#l65.407"></a><span id="l65.407" class="difflineplus">+    let name = aUri.spec;</span>
<a href="#l65.408"></a><span id="l65.408">     if (aUri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l65.409"></a><span id="l65.409">         name = aUri.spec.split(&quot;/&quot;).pop();</span>
<a href="#l65.410"></a><span id="l65.410">     } else if (aUri.schemeIs(&quot;http&quot;)) {</span>
<a href="#l65.411"></a><span id="l65.411">         name = aUri.spec.replace(/\/$/, &quot;&quot;).replace(/^http:\/\//, &quot;&quot;);</span>
<a href="#l65.412"></a><span id="l65.412">     }</span>
<a href="#l65.413"></a><span id="l65.413">     return name;</span>
<a href="#l65.414"></a><span id="l65.414"> }</span>
<a href="#l65.415"></a><span id="l65.415"> </span>
<a href="#l65.416"></a><span id="l65.416" class="difflineat">@@ -2244,19 +2244,19 @@ function deleteAttachment() {</span>
<a href="#l65.417"></a><span id="l65.417"> </span>
<a href="#l65.418"></a><span id="l65.418">     updateAttachment();</span>
<a href="#l65.419"></a><span id="l65.419"> }</span>
<a href="#l65.420"></a><span id="l65.420"> </span>
<a href="#l65.421"></a><span id="l65.421"> /**</span>
<a href="#l65.422"></a><span id="l65.422">  * Removes all attachments from the dialog controls.</span>
<a href="#l65.423"></a><span id="l65.423">  */</span>
<a href="#l65.424"></a><span id="l65.424"> function deleteAllAttachments() {</span>
<a href="#l65.425"></a><span id="l65.425" class="difflineminus">-    var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l65.426"></a><span id="l65.426" class="difflineminus">-    var itemCount = documentLink.getRowCount();</span>
<a href="#l65.427"></a><span id="l65.427" class="difflineminus">-    var ok = (itemCount &lt; 2);</span>
<a href="#l65.428"></a><span id="l65.428" class="difflineplus">+    let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l65.429"></a><span id="l65.429" class="difflineplus">+    let itemCount = documentLink.getRowCount();</span>
<a href="#l65.430"></a><span id="l65.430" class="difflineplus">+    let ok = (itemCount &lt; 2);</span>
<a href="#l65.431"></a><span id="l65.431"> </span>
<a href="#l65.432"></a><span id="l65.432">     if (itemCount &gt; 1) {</span>
<a href="#l65.433"></a><span id="l65.433">         let removeText = PluralForm.get(itemCount, cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;removeAttachmentsText&quot;));</span>
<a href="#l65.434"></a><span id="l65.434">         let removeTitle = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;removeCalendarsTitle&quot;);</span>
<a href="#l65.435"></a><span id="l65.435">         ok = Services.prompt.confirm(window, removeTitle, removeText.replace(&quot;#1&quot;, itemCount), {});</span>
<a href="#l65.436"></a><span id="l65.436">     }</span>
<a href="#l65.437"></a><span id="l65.437"> </span>
<a href="#l65.438"></a><span id="l65.438">     if (ok) {</span>
<a href="#l65.439"></a><span id="l65.439" class="difflineat">@@ -2272,20 +2272,20 @@ function deleteAllAttachments() {</span>
<a href="#l65.440"></a><span id="l65.440"> }</span>
<a href="#l65.441"></a><span id="l65.441"> </span>
<a href="#l65.442"></a><span id="l65.442"> /**</span>
<a href="#l65.443"></a><span id="l65.443">  * Opens the selected attachment using the external protocol service.</span>
<a href="#l65.444"></a><span id="l65.444">  * @see nsIExternalProtocolService</span>
<a href="#l65.445"></a><span id="l65.445">  */</span>
<a href="#l65.446"></a><span id="l65.446"> function openAttachment() {</span>
<a href="#l65.447"></a><span id="l65.447">     // Only one file has to be selected and we don't handle base64 files at all</span>
<a href="#l65.448"></a><span id="l65.448" class="difflineminus">-    var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l65.449"></a><span id="l65.449" class="difflineplus">+    let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l65.450"></a><span id="l65.450">     if (documentLink.selectedItems.length == 1) {</span>
<a href="#l65.451"></a><span id="l65.451" class="difflineminus">-        var attURI = documentLink.getSelectedItem(0).attachment.uri;</span>
<a href="#l65.452"></a><span id="l65.452" class="difflineminus">-        var externalLoader = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l65.453"></a><span id="l65.453" class="difflineplus">+        let attURI = documentLink.getSelectedItem(0).attachment.uri;</span>
<a href="#l65.454"></a><span id="l65.454" class="difflineplus">+        let externalLoader = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l65.455"></a><span id="l65.455">                                        .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l65.456"></a><span id="l65.456">         // TODO There should be a nicer dialog</span>
<a href="#l65.457"></a><span id="l65.457">         externalLoader.loadUrl(attURI);</span>
<a href="#l65.458"></a><span id="l65.458">     }</span>
<a href="#l65.459"></a><span id="l65.459"> }</span>
<a href="#l65.460"></a><span id="l65.460"> </span>
<a href="#l65.461"></a><span id="l65.461"> /**</span>
<a href="#l65.462"></a><span id="l65.462">  * Copies the link location of the first selected attachment to the clipboard</span>
<a href="#l65.463"></a><span id="l65.463" class="difflineat">@@ -2468,20 +2468,20 @@ function updateCalendar() {</span>
<a href="#l65.464"></a><span id="l65.464">             updateToDoStatus(item.status);</span>
<a href="#l65.465"></a><span id="l65.465">         }</span>
<a href="#l65.466"></a><span id="l65.466"> </span>
<a href="#l65.467"></a><span id="l65.467">         // disable repeat menupopup if this is an occurrence</span>
<a href="#l65.468"></a><span id="l65.468">         item = window.calendarItem;</span>
<a href="#l65.469"></a><span id="l65.469">         if (item.parentItem != item) {</span>
<a href="#l65.470"></a><span id="l65.470">             disableElement(&quot;item-repeat&quot;);</span>
<a href="#l65.471"></a><span id="l65.471">             disableElement(&quot;repeat-until-datepicker&quot;);</span>
<a href="#l65.472"></a><span id="l65.472" class="difflineminus">-            var repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l65.473"></a><span id="l65.473" class="difflineminus">-            var numChilds = repeatDetails.childNodes.length;</span>
<a href="#l65.474"></a><span id="l65.474" class="difflineminus">-            for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l65.475"></a><span id="l65.475" class="difflineminus">-                var node = repeatDetails.childNodes[i];</span>
<a href="#l65.476"></a><span id="l65.476" class="difflineplus">+            let repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l65.477"></a><span id="l65.477" class="difflineplus">+            let numChilds = repeatDetails.childNodes.length;</span>
<a href="#l65.478"></a><span id="l65.478" class="difflineplus">+            for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l65.479"></a><span id="l65.479" class="difflineplus">+                let node = repeatDetails.childNodes[i];</span>
<a href="#l65.480"></a><span id="l65.480">                 node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l65.481"></a><span id="l65.481">                 node.removeAttribute(&quot;class&quot;);</span>
<a href="#l65.482"></a><span id="l65.482">                 node.removeAttribute(&quot;onclick&quot;);</span>
<a href="#l65.483"></a><span id="l65.483">             }</span>
<a href="#l65.484"></a><span id="l65.484">         }</span>
<a href="#l65.485"></a><span id="l65.485"> </span>
<a href="#l65.486"></a><span id="l65.486">         // If the item is a proxy occurrence/instance, a few things aren't</span>
<a href="#l65.487"></a><span id="l65.487">         // valid.</span>
<a href="#l65.488"></a><span id="l65.488" class="difflineat">@@ -2503,23 +2503,23 @@ function updateCalendar() {</span>
<a href="#l65.489"></a><span id="l65.489">     updateCapabilities();</span>
<a href="#l65.490"></a><span id="l65.490"> }</span>
<a href="#l65.491"></a><span id="l65.491"> </span>
<a href="#l65.492"></a><span id="l65.492"> /**</span>
<a href="#l65.493"></a><span id="l65.493">  * Opens the recurrence dialog modally to allow the user to edit the recurrence</span>
<a href="#l65.494"></a><span id="l65.494">  * rules.</span>
<a href="#l65.495"></a><span id="l65.495">  */</span>
<a href="#l65.496"></a><span id="l65.496"> function editRepeat() {</span>
<a href="#l65.497"></a><span id="l65.497" class="difflineminus">-    var args = {};</span>
<a href="#l65.498"></a><span id="l65.498" class="difflineplus">+    let args = {};</span>
<a href="#l65.499"></a><span id="l65.499">     args.calendarEvent = window.calendarItem;</span>
<a href="#l65.500"></a><span id="l65.500">     args.recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l65.501"></a><span id="l65.501">     args.startTime = gStartTime;</span>
<a href="#l65.502"></a><span id="l65.502">     args.endTime = gEndTime;</span>
<a href="#l65.503"></a><span id="l65.503"> </span>
<a href="#l65.504"></a><span id="l65.504" class="difflineminus">-    var savedWindow = window;</span>
<a href="#l65.505"></a><span id="l65.505" class="difflineplus">+    let savedWindow = window;</span>
<a href="#l65.506"></a><span id="l65.506">     args.onOk = function(recurrenceInfo) {</span>
<a href="#l65.507"></a><span id="l65.507">         savedWindow.recurrenceInfo = recurrenceInfo;</span>
<a href="#l65.508"></a><span id="l65.508">     };</span>
<a href="#l65.509"></a><span id="l65.509"> </span>
<a href="#l65.510"></a><span id="l65.510">     window.setCursor(&quot;wait&quot;);</span>
<a href="#l65.511"></a><span id="l65.511"> </span>
<a href="#l65.512"></a><span id="l65.512">     // open the dialog modally</span>
<a href="#l65.513"></a><span id="l65.513">     openDialog(</span>
<a href="#l65.514"></a><span id="l65.514" class="difflineat">@@ -2882,32 +2882,32 @@ function updateToDoStatus(aStatus, aComp</span>
<a href="#l65.515"></a><span id="l65.515">  * @return      a copy of the original item with changes made.</span>
<a href="#l65.516"></a><span id="l65.516">  */</span>
<a href="#l65.517"></a><span id="l65.517"> function saveItem() {</span>
<a href="#l65.518"></a><span id="l65.518">     // we need to clone the item in order to apply the changes.</span>
<a href="#l65.519"></a><span id="l65.519">     // it is important to not apply the changes to the original item</span>
<a href="#l65.520"></a><span id="l65.520">     // (even if it happens to be mutable) in order to guarantee</span>
<a href="#l65.521"></a><span id="l65.521">     // that providers see a proper oldItem/newItem pair in case</span>
<a href="#l65.522"></a><span id="l65.522">     // they rely on this fact (e.g. WCAP does).</span>
<a href="#l65.523"></a><span id="l65.523" class="difflineminus">-    var originalItem = window.calendarItem;</span>
<a href="#l65.524"></a><span id="l65.524" class="difflineminus">-    var item = originalItem.clone();</span>
<a href="#l65.525"></a><span id="l65.525" class="difflineplus">+    let originalItem = window.calendarItem;</span>
<a href="#l65.526"></a><span id="l65.526" class="difflineplus">+    let item = originalItem.clone();</span>
<a href="#l65.527"></a><span id="l65.527"> </span>
<a href="#l65.528"></a><span id="l65.528">     // override item's recurrenceInfo *before* serializing date/time-objects.</span>
<a href="#l65.529"></a><span id="l65.529">     if (!item.recurrenceId) {</span>
<a href="#l65.530"></a><span id="l65.530">         item.recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l65.531"></a><span id="l65.531">     }</span>
<a href="#l65.532"></a><span id="l65.532"> </span>
<a href="#l65.533"></a><span id="l65.533">     // serialize the item</span>
<a href="#l65.534"></a><span id="l65.534">     saveDialog(item);</span>
<a href="#l65.535"></a><span id="l65.535"> </span>
<a href="#l65.536"></a><span id="l65.536">     item.organizer = window.organizer;</span>
<a href="#l65.537"></a><span id="l65.537"> </span>
<a href="#l65.538"></a><span id="l65.538">     item.removeAllAttendees();</span>
<a href="#l65.539"></a><span id="l65.539">     if (window.attendees &amp;&amp; (window.attendees.length &gt; 0)) {</span>
<a href="#l65.540"></a><span id="l65.540" class="difflineminus">-        for (var attendee of window.attendees) {</span>
<a href="#l65.541"></a><span id="l65.541" class="difflineplus">+        for (let attendee of window.attendees) {</span>
<a href="#l65.542"></a><span id="l65.542">            item.addAttendee(attendee);</span>
<a href="#l65.543"></a><span id="l65.543">         }</span>
<a href="#l65.544"></a><span id="l65.544"> </span>
<a href="#l65.545"></a><span id="l65.545">         let notifyCheckbox = document.getElementById(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l65.546"></a><span id="l65.546">         if (notifyCheckbox.disabled) {</span>
<a href="#l65.547"></a><span id="l65.547">             item.deleteProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;);</span>
<a href="#l65.548"></a><span id="l65.548">         } else {</span>
<a href="#l65.549"></a><span id="l65.549">             item.setProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;, notifyCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l65.550"></a><span id="l65.550" class="difflineat">@@ -2971,17 +2971,17 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l65.551"></a><span id="l65.551"> </span>
<a href="#l65.552"></a><span id="l65.552">     // When the call is complete, we need to set the new item, so that the</span>
<a href="#l65.553"></a><span id="l65.553">     // dialog is up to date.</span>
<a href="#l65.554"></a><span id="l65.554"> </span>
<a href="#l65.555"></a><span id="l65.555">     // XXX Do we want to disable the dialog or at least the save button until</span>
<a href="#l65.556"></a><span id="l65.556">     // the call is complete? This might help when the user tries to save twice</span>
<a href="#l65.557"></a><span id="l65.557">     // before the call is complete. In that case, we do need a progress bar and</span>
<a href="#l65.558"></a><span id="l65.558">     // the ability to cancel the operation though.</span>
<a href="#l65.559"></a><span id="l65.559" class="difflineminus">-    var listener = {</span>
<a href="#l65.560"></a><span id="l65.560" class="difflineplus">+    let listener = {</span>
<a href="#l65.561"></a><span id="l65.561">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l65.562"></a><span id="l65.562">         onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aItem) {</span>
<a href="#l65.563"></a><span id="l65.563">             // Check if the current window has a calendarItem first, because in case of undo</span>
<a href="#l65.564"></a><span id="l65.564">             // window refers to the main window and we would get a 'calendarItem is undefined' warning.</span>
<a href="#l65.565"></a><span id="l65.565">             if (&quot;calendarItem&quot; in window) {</span>
<a href="#l65.566"></a><span id="l65.566">                 // If we changed the calendar of the item, onOperationComplete will be called multiple</span>
<a href="#l65.567"></a><span id="l65.567">                 // times. We need to make sure we're receiving the update on the right calendar.</span>
<a href="#l65.568"></a><span id="l65.568">                 if ((!window.calendarItem.id ||aId == window.calendarItem.id) &amp;&amp;</span>
<a href="#l65.569"></a><span id="l65.569" class="difflineat">@@ -3099,17 +3099,17 @@ function postponeTask(aDuration) {</span>
<a href="#l65.570"></a><span id="l65.570">  * Prompts the user to change the start timezone.</span>
<a href="#l65.571"></a><span id="l65.571">  */</span>
<a href="#l65.572"></a><span id="l65.572"> function editStartTimezone() {</span>
<a href="#l65.573"></a><span id="l65.573">     editTimezone(&quot;timezone-starttime&quot;,</span>
<a href="#l65.574"></a><span id="l65.574">                  gStartTime.getInTimezone(gStartTimezone),</span>
<a href="#l65.575"></a><span id="l65.575">                  editStartTimezone.complete);</span>
<a href="#l65.576"></a><span id="l65.576"> }</span>
<a href="#l65.577"></a><span id="l65.577"> editStartTimezone.complete = function(datetime) {</span>
<a href="#l65.578"></a><span id="l65.578" class="difflineminus">-    var equalTimezones = false;</span>
<a href="#l65.579"></a><span id="l65.579" class="difflineplus">+    let equalTimezones = false;</span>
<a href="#l65.580"></a><span id="l65.580">     if (gStartTimezone &amp;&amp; gEndTimezone) {</span>
<a href="#l65.581"></a><span id="l65.581">         if (gStartTimezone == gEndTimezone) {</span>
<a href="#l65.582"></a><span id="l65.582">             equalTimezones = true;</span>
<a href="#l65.583"></a><span id="l65.583">         }</span>
<a href="#l65.584"></a><span id="l65.584">     }</span>
<a href="#l65.585"></a><span id="l65.585">     gStartTimezone = datetime.timezone;</span>
<a href="#l65.586"></a><span id="l65.586">     if (equalTimezones) {</span>
<a href="#l65.587"></a><span id="l65.587">       gEndTimezone = datetime.timezone;</span>
<a href="#l65.588"></a><span id="l65.588" class="difflineat">@@ -3203,17 +3203,17 @@ function showTimezonePopup(event, dateTi</span>
<a href="#l65.589"></a><span id="l65.589">  */</span>
<a href="#l65.590"></a><span id="l65.590"> function editTimezone(aElementId, aDateTime, aCallback) {</span>
<a href="#l65.591"></a><span id="l65.591">     if (document.getElementById(aElementId)</span>
<a href="#l65.592"></a><span id="l65.592">         .hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l65.593"></a><span id="l65.593">         return;</span>
<a href="#l65.594"></a><span id="l65.594">     }</span>
<a href="#l65.595"></a><span id="l65.595"> </span>
<a href="#l65.596"></a><span id="l65.596">     // prepare the arguments that will be passed to the dialog</span>
<a href="#l65.597"></a><span id="l65.597" class="difflineminus">-    var args = {};</span>
<a href="#l65.598"></a><span id="l65.598" class="difflineplus">+    let args = {};</span>
<a href="#l65.599"></a><span id="l65.599">     args.time = aDateTime;</span>
<a href="#l65.600"></a><span id="l65.600">     args.calendar = getCurrentCalendar();</span>
<a href="#l65.601"></a><span id="l65.601">     args.onOk = function(datetime) {</span>
<a href="#l65.602"></a><span id="l65.602">         cal.saveRecentTimezone(datetime.timezone.tzid);</span>
<a href="#l65.603"></a><span id="l65.603">         return aCallback(datetime);</span>
<a href="#l65.604"></a><span id="l65.604">     };</span>
<a href="#l65.605"></a><span id="l65.605"> </span>
<a href="#l65.606"></a><span id="l65.606">     // open the dialog modally</span>
<a href="#l65.607"></a><span id="l65.607" class="difflineat">@@ -3602,17 +3602,17 @@ function updateRepeatDetails() {</span>
<a href="#l65.608"></a><span id="l65.608">         let lines = detailsString.split(&quot;\n&quot;);</span>
<a href="#l65.609"></a><span id="l65.609">         repeatDetails.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l65.610"></a><span id="l65.610">         while (repeatDetails.childNodes.length &gt; lines.length) {</span>
<a href="#l65.611"></a><span id="l65.611">             repeatDetails.lastChild.remove();</span>
<a href="#l65.612"></a><span id="l65.612">         }</span>
<a href="#l65.613"></a><span id="l65.613">         let numChilds = repeatDetails.childNodes.length;</span>
<a href="#l65.614"></a><span id="l65.614">         for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l65.615"></a><span id="l65.615">             if (i &gt;= numChilds) {</span>
<a href="#l65.616"></a><span id="l65.616" class="difflineminus">-                var newNode = repeatDetails.childNodes[0]</span>
<a href="#l65.617"></a><span id="l65.617" class="difflineplus">+                let newNode = repeatDetails.childNodes[0]</span>
<a href="#l65.618"></a><span id="l65.618">                                            .cloneNode(true);</span>
<a href="#l65.619"></a><span id="l65.619">                 repeatDetails.appendChild(newNode);</span>
<a href="#l65.620"></a><span id="l65.620">             }</span>
<a href="#l65.621"></a><span id="l65.621">             repeatDetails.childNodes[i].value = lines[i];</span>
<a href="#l65.622"></a><span id="l65.622">             repeatDetails.childNodes[i].setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l65.623"></a><span id="l65.623">                                                      detailsString);</span>
<a href="#l65.624"></a><span id="l65.624">         }</span>
<a href="#l65.625"></a><span id="l65.625">     } else {</span>
<a href="#l65.626"></a><span id="l65.626" class="difflineat">@@ -3721,17 +3721,17 @@ function removeAllAttendees() {</span>
<a href="#l65.627"></a><span id="l65.627"> }</span>
<a href="#l65.628"></a><span id="l65.628"> </span>
<a href="#l65.629"></a><span id="l65.629"> /**</span>
<a href="#l65.630"></a><span id="l65.630">  * Send Email to all attendees that haven't responded or are tentative.</span>
<a href="#l65.631"></a><span id="l65.631">  *</span>
<a href="#l65.632"></a><span id="l65.632">  * @param aAttendees    The attendees to check.</span>
<a href="#l65.633"></a><span id="l65.633">  */</span>
<a href="#l65.634"></a><span id="l65.634"> function sendMailToUndecidedAttendees(aAttendees) {</span>
<a href="#l65.635"></a><span id="l65.635" class="difflineminus">-    var targetAttendees = attendees.filter(isAttendeeUndecided);</span>
<a href="#l65.636"></a><span id="l65.636" class="difflineplus">+    let targetAttendees = attendees.filter(isAttendeeUndecided);</span>
<a href="#l65.637"></a><span id="l65.637">     sendMailToAttendees(targetAttendees);</span>
<a href="#l65.638"></a><span id="l65.638"> }</span>
<a href="#l65.639"></a><span id="l65.639"> </span>
<a href="#l65.640"></a><span id="l65.640"> /**</span>
<a href="#l65.641"></a><span id="l65.641">  * Send Email to all given attendees.</span>
<a href="#l65.642"></a><span id="l65.642">  *</span>
<a href="#l65.643"></a><span id="l65.643">  * @param aAttendees    The attendees to send mail to.</span>
<a href="#l65.644"></a><span id="l65.644">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/lightning/content/lightning-utils.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-utils.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -19,31 +19,31 @@ function ltnGetString(aBundleName, aStri</span>
<a href="#l66.4"></a><span id="l66.4"> }</span>
<a href="#l66.5"></a><span id="l66.5"> </span>
<a href="#l66.6"></a><span id="l66.6"> // shared by lightning-calendar-properties.js and lightning-calendar-creation.js:</span>
<a href="#l66.7"></a><span id="l66.7"> function ltnInitMailIdentitiesRow() {</span>
<a href="#l66.8"></a><span id="l66.8">     if (!gCalendar) {</span>
<a href="#l66.9"></a><span id="l66.9">         collapseElement(&quot;calendar-email-identity-row&quot;);</span>
<a href="#l66.10"></a><span id="l66.10">     }</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-    var imipIdentityDisabled = gCalendar.getProperty(&quot;imip.identity.disabled&quot;);</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+    let imipIdentityDisabled = gCalendar.getProperty(&quot;imip.identity.disabled&quot;);</span>
<a href="#l66.14"></a><span id="l66.14">     setElementValue(&quot;calendar-email-identity-row&quot;,</span>
<a href="#l66.15"></a><span id="l66.15">                     imipIdentityDisabled &amp;&amp; &quot;true&quot;,</span>
<a href="#l66.16"></a><span id="l66.16">                     &quot;collapsed&quot;);</span>
<a href="#l66.17"></a><span id="l66.17"> </span>
<a href="#l66.18"></a><span id="l66.18">     if (imipIdentityDisabled) {</span>
<a href="#l66.19"></a><span id="l66.19">         // If the imip identity is disabled, we don't have to set up the</span>
<a href="#l66.20"></a><span id="l66.20">         // menulist.</span>
<a href="#l66.21"></a><span id="l66.21">         return;</span>
<a href="#l66.22"></a><span id="l66.22">     }</span>
<a href="#l66.23"></a><span id="l66.23"> </span>
<a href="#l66.24"></a><span id="l66.24">     // If there is no transport but also no organizer id, then the</span>
<a href="#l66.25"></a><span id="l66.25">     // provider has not statically configured an organizer id. This is</span>
<a href="#l66.26"></a><span id="l66.26">     // basically what happens when &quot;None&quot; is selected.</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineminus">-    var menuPopup = document.getElementById(&quot;email-identity-menupopup&quot;);</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+    let menuPopup = document.getElementById(&quot;email-identity-menupopup&quot;);</span>
<a href="#l66.29"></a><span id="l66.29"> </span>
<a href="#l66.30"></a><span id="l66.30">     // Remove all children from the email list to avoid duplicates if the list</span>
<a href="#l66.31"></a><span id="l66.31">     // has already been populated during a previous step in the calendar</span>
<a href="#l66.32"></a><span id="l66.32">     // creation wizard.</span>
<a href="#l66.33"></a><span id="l66.33">     while (menuPopup.hasChildNodes()) {</span>
<a href="#l66.34"></a><span id="l66.34">         menuPopup.lastChild.remove();</span>
<a href="#l66.35"></a><span id="l66.35">     }</span>
<a href="#l66.36"></a><span id="l66.36"> </span>
<a href="#l66.37"></a><span id="l66.37" class="difflineat">@@ -53,32 +53,32 @@ function ltnInitMailIdentitiesRow() {</span>
<a href="#l66.38"></a><span id="l66.38">         identities = gCalendar.aclEntry.getOwnerIdentities({});</span>
<a href="#l66.39"></a><span id="l66.39">     } else {</span>
<a href="#l66.40"></a><span id="l66.40">         identities = MailServices.accounts.allIdentities;</span>
<a href="#l66.41"></a><span id="l66.41">     }</span>
<a href="#l66.42"></a><span id="l66.42">     for (let identity in fixIterator(identities, Components.interfaces.nsIMsgIdentity)) {</span>
<a href="#l66.43"></a><span id="l66.43">         addMenuItem(menuPopup, identity.identityName, identity.key);</span>
<a href="#l66.44"></a><span id="l66.44">     }</span>
<a href="#l66.45"></a><span id="l66.45">     try {</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineminus">-        var sel = gCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l66.47"></a><span id="l66.47" class="difflineplus">+        let sel = gCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l66.48"></a><span id="l66.48">         if (sel) {</span>
<a href="#l66.49"></a><span id="l66.49">             sel = sel.QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l66.50"></a><span id="l66.50">         }</span>
<a href="#l66.51"></a><span id="l66.51">         menuListSelectItem(&quot;email-identity-menulist&quot;, sel ? sel.key : &quot;none&quot;);</span>
<a href="#l66.52"></a><span id="l66.52">     } catch (exc) {</span>
<a href="#l66.53"></a><span id="l66.53">         // Don't select anything if the message identity can't be found</span>
<a href="#l66.54"></a><span id="l66.54">     }</span>
<a href="#l66.55"></a><span id="l66.55"> }</span>
<a href="#l66.56"></a><span id="l66.56"> </span>
<a href="#l66.57"></a><span id="l66.57"> function ltnSaveMailIdentitySelection() {</span>
<a href="#l66.58"></a><span id="l66.58">     if (!gCalendar) {</span>
<a href="#l66.59"></a><span id="l66.59">         return;</span>
<a href="#l66.60"></a><span id="l66.60">     }</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineminus">-    var sel = &quot;none&quot;;</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineminus">-    var imipIdentityDisabled = gCalendar.getProperty(&quot;imip.identity.disabled&quot;);</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineminus">-    var selItem = document.getElementById(&quot;email-identity-menulist&quot;).selectedItem;</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineplus">+    let sel = &quot;none&quot;;</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineplus">+    let imipIdentityDisabled = gCalendar.getProperty(&quot;imip.identity.disabled&quot;);</span>
<a href="#l66.66"></a><span id="l66.66" class="difflineplus">+    let selItem = document.getElementById(&quot;email-identity-menulist&quot;).selectedItem;</span>
<a href="#l66.67"></a><span id="l66.67">     if (!imipIdentityDisabled &amp;&amp; selItem) {</span>
<a href="#l66.68"></a><span id="l66.68">         sel = selItem.getAttribute(&quot;value&quot;);</span>
<a href="#l66.69"></a><span id="l66.69">     }</span>
<a href="#l66.70"></a><span id="l66.70">     // no imip.identity.key will default to the default account/identity, whereas</span>
<a href="#l66.71"></a><span id="l66.71">     // an empty key indicates no imip; that identity will not be found</span>
<a href="#l66.72"></a><span id="l66.72">     gCalendar.setProperty(&quot;imip.identity.key&quot;, sel == &quot;none&quot; ? &quot;&quot; : sel);</span>
<a href="#l66.73"></a><span id="l66.73"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-preferences.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-preferences.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l67.4"></a><span id="l67.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l67.5"></a><span id="l67.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l67.6"></a><span id="l67.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l67.7"></a><span id="l67.7"> </span>
<a href="#l67.8"></a><span id="l67.8"> var gLightningPane = {</span>
<a href="#l67.9"></a><span id="l67.9">     mInitialized: false,</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11">     init: function lnPaneInit() {</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-        var preference = document.getElementById(&quot;calendar.preferences.lightning.selectedTabIndex&quot;);</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+        let preference = document.getElementById(&quot;calendar.preferences.lightning.selectedTabIndex&quot;);</span>
<a href="#l67.14"></a><span id="l67.14">         if (preference.value) {</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineminus">-            var ltnPrefs = document.getElementById(&quot;calPreferencesTabbox&quot;);</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineplus">+            let ltnPrefs = document.getElementById(&quot;calPreferencesTabbox&quot;);</span>
<a href="#l67.17"></a><span id="l67.17">             ltnPrefs.selectedIndex = preference.value;</span>
<a href="#l67.18"></a><span id="l67.18">         }</span>
<a href="#l67.19"></a><span id="l67.19">         this.mInitialized = true;</span>
<a href="#l67.20"></a><span id="l67.20">     },</span>
<a href="#l67.21"></a><span id="l67.21"> </span>
<a href="#l67.22"></a><span id="l67.22">     tabSelectionChanged: function lnPaneTabSelectionChanged() {</span>
<a href="#l67.23"></a><span id="l67.23">         if (!this.mInitialized) {</span>
<a href="#l67.24"></a><span id="l67.24">             return;</span>
<a href="#l67.25"></a><span id="l67.25">         }</span>
<a href="#l67.26"></a><span id="l67.26" class="difflineminus">-        var ltnPrefs = document.getElementById(&quot;calPreferencesTabbox&quot;);</span>
<a href="#l67.27"></a><span id="l67.27" class="difflineminus">-        var preference = document.getElementById(&quot;calendar.preferences.lightning.selectedTabIndex&quot;);</span>
<a href="#l67.28"></a><span id="l67.28" class="difflineplus">+        let ltnPrefs = document.getElementById(&quot;calPreferencesTabbox&quot;);</span>
<a href="#l67.29"></a><span id="l67.29" class="difflineplus">+        let preference = document.getElementById(&quot;calendar.preferences.lightning.selectedTabIndex&quot;);</span>
<a href="#l67.30"></a><span id="l67.30">         preference.valueFromPreferences = ltnPrefs.selectedIndex;</span>
<a href="#l67.31"></a><span id="l67.31">     }</span>
<a href="#l67.32"></a><span id="l67.32"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -593,17 +593,17 @@ function switchCalendarView(aType, aShow</span>
<a href="#l68.4"></a><span id="l68.4">  * slider gets clicked and wants to display the appropriate mail.</span>
<a href="#l68.5"></a><span id="l68.5">  * All necessary logic for switching between the different modes</span>
<a href="#l68.6"></a><span id="l68.6">  * should live inside of the corresponding functions:</span>
<a href="#l68.7"></a><span id="l68.7">  * - ltnSwitch2Mail()</span>
<a href="#l68.8"></a><span id="l68.8">  * - ltnSwitch2Calendar()</span>
<a href="#l68.9"></a><span id="l68.9">  * - ltnSwitch2Task()</span>
<a href="#l68.10"></a><span id="l68.10">  */</span>
<a href="#l68.11"></a><span id="l68.11"> function LtnObserveDisplayDeckChange(event) {</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-    var deck = event.target;</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+    let deck = event.target;</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15">     // Bug 309505: The 'select' event also fires when we change the selected</span>
<a href="#l68.16"></a><span id="l68.16">     // panel of calendar-view-box.  Workaround with this check.</span>
<a href="#l68.17"></a><span id="l68.17">     if (deck.id != &quot;calendarDisplayDeck&quot;) {</span>
<a href="#l68.18"></a><span id="l68.18">         return;</span>
<a href="#l68.19"></a><span id="l68.19">     }</span>
<a href="#l68.20"></a><span id="l68.20"> </span>
<a href="#l68.21"></a><span id="l68.21">     let id = deck.selectedPanel &amp;&amp; deck.selectedPanel.id;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -237,17 +237,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.4"></a><span id="l69.4">             this.setupAuthentication(aChangeLogListener);</span>
<a href="#l69.5"></a><span id="l69.5">         } else {</span>
<a href="#l69.6"></a><span id="l69.6">             this.safeRefresh(aChangeLogListener);</span>
<a href="#l69.7"></a><span id="l69.7">         }</span>
<a href="#l69.8"></a><span id="l69.8">     },</span>
<a href="#l69.9"></a><span id="l69.9">     setMetaData: function caldav_setMetaData(id, path, etag, isInboxItem) {</span>
<a href="#l69.10"></a><span id="l69.10">         if (this.mOfflineStorage.setMetaData) {</span>
<a href="#l69.11"></a><span id="l69.11">             if (id) {</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-                var dataString = [etag, path, (isInboxItem ? &quot;true&quot; : &quot;false&quot;)].join(&quot;\u001A&quot;);</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+                let dataString = [etag, path, (isInboxItem ? &quot;true&quot; : &quot;false&quot;)].join(&quot;\u001A&quot;);</span>
<a href="#l69.14"></a><span id="l69.14">                 this.mOfflineStorage.setMetaData(id, dataString);</span>
<a href="#l69.15"></a><span id="l69.15">             } else {</span>
<a href="#l69.16"></a><span id="l69.16">                 cal.LOG(&quot;CalDAV: cannot store meta data without an id&quot;);</span>
<a href="#l69.17"></a><span id="l69.17">             }</span>
<a href="#l69.18"></a><span id="l69.18">         } else {</span>
<a href="#l69.19"></a><span id="l69.19">             cal.ERROR(&quot;CalDAV: calendar storage does not support meta data&quot;);</span>
<a href="#l69.20"></a><span id="l69.20">         }</span>
<a href="#l69.21"></a><span id="l69.21">     },</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineat">@@ -760,21 +760,21 @@ calDavCalendar.prototype = {</span>
<a href="#l69.23"></a><span id="l69.23"> </span>
<a href="#l69.24"></a><span id="l69.24">         let newItem_ = aNewItem;</span>
<a href="#l69.25"></a><span id="l69.25">         aNewItem = aNewItem.parentItem.clone();</span>
<a href="#l69.26"></a><span id="l69.26">         if (newItem_.parentItem != newItem_) {</span>
<a href="#l69.27"></a><span id="l69.27">             aNewItem.recurrenceInfo.modifyException(newItem_, false);</span>
<a href="#l69.28"></a><span id="l69.28">         }</span>
<a href="#l69.29"></a><span id="l69.29">         aNewItem.generation += 1;</span>
<a href="#l69.30"></a><span id="l69.30"> </span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-        var eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+        let eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l69.33"></a><span id="l69.33"> </span>
<a href="#l69.34"></a><span id="l69.34" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l69.36"></a><span id="l69.36"> </span>
<a href="#l69.37"></a><span id="l69.37" class="difflineminus">-        var modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineplus">+        let modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l69.39"></a><span id="l69.39"> </span>
<a href="#l69.40"></a><span id="l69.40">         let modListener = {</span>
<a href="#l69.41"></a><span id="l69.41">             onStreamComplete: function caldav_mod_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l69.42"></a><span id="l69.42">                                                                    aResultLength, aResult) {</span>
<a href="#l69.43"></a><span id="l69.43">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.44"></a><span id="l69.44">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l69.45"></a><span id="l69.45">                 let listenerDetail = aNewItem;</span>
<a href="#l69.46"></a><span id="l69.46">                 let responseStatus;</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineat">@@ -877,33 +877,33 @@ calDavCalendar.prototype = {</span>
<a href="#l69.48"></a><span id="l69.48">         };</span>
<a href="#l69.49"></a><span id="l69.49"> </span>
<a href="#l69.50"></a><span id="l69.50">         if (aItem.id == null) {</span>
<a href="#l69.51"></a><span id="l69.51">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l69.52"></a><span id="l69.52">                            &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l69.53"></a><span id="l69.53">             return;</span>
<a href="#l69.54"></a><span id="l69.54">         }</span>
<a href="#l69.55"></a><span id="l69.55"> </span>
<a href="#l69.56"></a><span id="l69.56" class="difflineminus">-        var eventUri;</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineplus">+        let eventUri;</span>
<a href="#l69.58"></a><span id="l69.58">         if (aUri) {</span>
<a href="#l69.59"></a><span id="l69.59">             eventUri = aUri;</span>
<a href="#l69.60"></a><span id="l69.60">         } else if (aFromInbox || this.mItemInfoCache[aItem.id].isInboxItem) {</span>
<a href="#l69.61"></a><span id="l69.61">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath, this.mInboxUrl);</span>
<a href="#l69.62"></a><span id="l69.62">         } else {</span>
<a href="#l69.63"></a><span id="l69.63">             eventUri = this.makeUri(this.mItemInfoCache[aItem.id].locationPath);</span>
<a href="#l69.64"></a><span id="l69.64">         }</span>
<a href="#l69.65"></a><span id="l69.65"> </span>
<a href="#l69.66"></a><span id="l69.66">         if (eventUri.path == this.calendarUri.path) {</span>
<a href="#l69.67"></a><span id="l69.67">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l69.68"></a><span id="l69.68">                            &quot;eventUri and calendarUri paths are the same, &quot; +</span>
<a href="#l69.69"></a><span id="l69.69">                            &quot;will not go on to delete entire calendar&quot;);</span>
<a href="#l69.70"></a><span id="l69.70">             return;</span>
<a href="#l69.71"></a><span id="l69.71">         }</span>
<a href="#l69.72"></a><span id="l69.72"> </span>
<a href="#l69.73"></a><span id="l69.73" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l69.75"></a><span id="l69.75"> </span>
<a href="#l69.76"></a><span id="l69.76">         let delListener = {</span>
<a href="#l69.77"></a><span id="l69.77">             onStreamComplete: function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l69.78"></a><span id="l69.78">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.79"></a><span id="l69.79">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l69.80"></a><span id="l69.80">                 let listenerDetail = aItem;</span>
<a href="#l69.81"></a><span id="l69.81">                 let responseStatus;</span>
<a href="#l69.82"></a><span id="l69.82">                 try {</span>
<a href="#l69.83"></a><span id="l69.83" class="difflineat">@@ -1050,17 +1050,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.84"></a><span id="l69.84">             // certain event failed.</span>
<a href="#l69.85"></a><span id="l69.85">             cal.WARN(&quot;Failed to parse item: &quot; + calData + &quot;\n\nException:&quot; + e);</span>
<a href="#l69.86"></a><span id="l69.86">             return;</span>
<a href="#l69.87"></a><span id="l69.87">         }</span>
<a href="#l69.88"></a><span id="l69.88">         // with CalDAV there really should only be one item here</span>
<a href="#l69.89"></a><span id="l69.89">         let items = parser.getItems({});</span>
<a href="#l69.90"></a><span id="l69.90">         let propertiesList = parser.getProperties({});</span>
<a href="#l69.91"></a><span id="l69.91">         let method;</span>
<a href="#l69.92"></a><span id="l69.92" class="difflineminus">-        for (var prop of propertiesList) {</span>
<a href="#l69.93"></a><span id="l69.93" class="difflineplus">+        for (let prop of propertiesList) {</span>
<a href="#l69.94"></a><span id="l69.94">             if (prop.propertyName == &quot;METHOD&quot;) {</span>
<a href="#l69.95"></a><span id="l69.95">                 method = prop.value;</span>
<a href="#l69.96"></a><span id="l69.96">                 break;</span>
<a href="#l69.97"></a><span id="l69.97">             }</span>
<a href="#l69.98"></a><span id="l69.98">         }</span>
<a href="#l69.99"></a><span id="l69.99">         let isReply = (method == &quot;REPLY&quot;);</span>
<a href="#l69.100"></a><span id="l69.100">         let item = items[0];</span>
<a href="#l69.101"></a><span id="l69.101">         if (!item) {</span>
<a href="#l69.102"></a><span id="l69.102" class="difflineat">@@ -1388,17 +1388,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.103"></a><span id="l69.103">                 '&lt;CS:getctag/&gt;' +</span>
<a href="#l69.104"></a><span id="l69.104">               '&lt;/D:prop&gt;' +</span>
<a href="#l69.105"></a><span id="l69.105">             '&lt;/D:propfind&gt;';</span>
<a href="#l69.106"></a><span id="l69.106"> </span>
<a href="#l69.107"></a><span id="l69.107">         if (this.verboseLogging()) {</span>
<a href="#l69.108"></a><span id="l69.108">             cal.LOG(&quot;CalDAV: send(&quot; + this.makeUri().spec + &quot;): &quot; + queryXml);</span>
<a href="#l69.109"></a><span id="l69.109">         }</span>
<a href="#l69.110"></a><span id="l69.110"> </span>
<a href="#l69.111"></a><span id="l69.111" class="difflineminus">-        var streamListener = {};</span>
<a href="#l69.112"></a><span id="l69.112" class="difflineplus">+        let streamListener = {};</span>
<a href="#l69.113"></a><span id="l69.113">         streamListener.onStreamComplete =</span>
<a href="#l69.114"></a><span id="l69.114">             function safeRefresh_safeRefresh_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l69.115"></a><span id="l69.115">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.116"></a><span id="l69.116">             try {</span>
<a href="#l69.117"></a><span id="l69.117">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l69.118"></a><span id="l69.118">                         &quot; checking ctag for calendar &quot; + thisCalendar.name);</span>
<a href="#l69.119"></a><span id="l69.119">             } catch (ex) {</span>
<a href="#l69.120"></a><span id="l69.120">                 cal.LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineat">@@ -1472,24 +1472,24 @@ calDavCalendar.prototype = {</span>
<a href="#l69.122"></a><span id="l69.122">         });</span>
<a href="#l69.123"></a><span id="l69.123">     },</span>
<a href="#l69.124"></a><span id="l69.124"> </span>
<a href="#l69.125"></a><span id="l69.125">     refresh: function caldav_refresh() {</span>
<a href="#l69.126"></a><span id="l69.126">         this.replayChangesOn(null);</span>
<a href="#l69.127"></a><span id="l69.127">     },</span>
<a href="#l69.128"></a><span id="l69.128"> </span>
<a href="#l69.129"></a><span id="l69.129">     firstInRealm: function caldav_firstInRealm() {</span>
<a href="#l69.130"></a><span id="l69.130" class="difflineminus">-        var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l69.131"></a><span id="l69.131" class="difflineminus">-        for (var i = 0; i &lt; calendars.length; i++) {</span>
<a href="#l69.132"></a><span id="l69.132" class="difflineplus">+        let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l69.133"></a><span id="l69.133" class="difflineplus">+        for (let i = 0; i &lt; calendars.length; i++) {</span>
<a href="#l69.134"></a><span id="l69.134">             if (calendars[i].type != &quot;caldav&quot; || calendars[i].getProperty(&quot;disabled&quot;)) {</span>
<a href="#l69.135"></a><span id="l69.135">                 continue;</span>
<a href="#l69.136"></a><span id="l69.136">             }</span>
<a href="#l69.137"></a><span id="l69.137">             // XXX We should probably expose the inner calendar via an</span>
<a href="#l69.138"></a><span id="l69.138">             // interface, but for now use wrappedJSObject.</span>
<a href="#l69.139"></a><span id="l69.139" class="difflineminus">-            var calendar = calendars[i].wrappedJSObject;</span>
<a href="#l69.140"></a><span id="l69.140" class="difflineplus">+            let calendar = calendars[i].wrappedJSObject;</span>
<a href="#l69.141"></a><span id="l69.141">             if (calendar.mUncachedCalendar) {</span>
<a href="#l69.142"></a><span id="l69.142">                 calendar = calendar.mUncachedCalendar;</span>
<a href="#l69.143"></a><span id="l69.143">             }</span>
<a href="#l69.144"></a><span id="l69.144">             if (calendar.uri.prePath == this.uri.prePath &amp;&amp;</span>
<a href="#l69.145"></a><span id="l69.145">                 calendar.authRealm == this.mAuthRealm) {</span>
<a href="#l69.146"></a><span id="l69.146">                 if (calendar.id == this.id) {</span>
<a href="#l69.147"></a><span id="l69.147">                     return true;</span>
<a href="#l69.148"></a><span id="l69.148">                 }</span>
<a href="#l69.149"></a><span id="l69.149" class="difflineat">@@ -1612,17 +1612,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.150"></a><span id="l69.150">                 this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE,</span>
<a href="#l69.151"></a><span id="l69.151">                                         OAUTH_CLIENT_ID, OAUTH_HASH);</span>
<a href="#l69.152"></a><span id="l69.152">                 this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l69.153"></a><span id="l69.153">                 this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=600&quot;;</span>
<a href="#l69.154"></a><span id="l69.154"> </span>
<a href="#l69.155"></a><span id="l69.155">                 Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l69.156"></a><span id="l69.156">                     get: function getRefreshToken() {</span>
<a href="#l69.157"></a><span id="l69.157">                         if (!this.mRefreshToken) {</span>
<a href="#l69.158"></a><span id="l69.158" class="difflineminus">-                            var pass = { value: null };</span>
<a href="#l69.159"></a><span id="l69.159" class="difflineplus">+                            let pass = { value: null };</span>
<a href="#l69.160"></a><span id="l69.160">                             try {</span>
<a href="#l69.161"></a><span id="l69.161">                                 cal.auth.passwordManagerGet(sessionId, pass, sessionId, pwMgrId);</span>
<a href="#l69.162"></a><span id="l69.162">                             } catch (e) {</span>
<a href="#l69.163"></a><span id="l69.163">                                 // User might have cancelled the master password prompt, thats ok</span>
<a href="#l69.164"></a><span id="l69.164">                                 if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l69.165"></a><span id="l69.165">                                     throw e;</span>
<a href="#l69.166"></a><span id="l69.166">                                 }</span>
<a href="#l69.167"></a><span id="l69.167">                             }</span>
<a href="#l69.168"></a><span id="l69.168" class="difflineat">@@ -1697,17 +1697,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.169"></a><span id="l69.169">                 '&lt;C:supported-calendar-component-set/&gt;' +</span>
<a href="#l69.170"></a><span id="l69.170">                 '&lt;CS:getctag/&gt;' +</span>
<a href="#l69.171"></a><span id="l69.171">               '&lt;/D:prop&gt;' +</span>
<a href="#l69.172"></a><span id="l69.172">             '&lt;/D:propfind&gt;';</span>
<a href="#l69.173"></a><span id="l69.173"> </span>
<a href="#l69.174"></a><span id="l69.174">         if (this.verboseLogging()) {</span>
<a href="#l69.175"></a><span id="l69.175">             cal.LOG(&quot;CalDAV: send: &quot; + queryXml);</span>
<a href="#l69.176"></a><span id="l69.176">         }</span>
<a href="#l69.177"></a><span id="l69.177" class="difflineminus">-        var streamListener = {};</span>
<a href="#l69.178"></a><span id="l69.178" class="difflineplus">+        let streamListener = {};</span>
<a href="#l69.179"></a><span id="l69.179"> </span>
<a href="#l69.180"></a><span id="l69.180">         streamListener.onStreamComplete =</span>
<a href="#l69.181"></a><span id="l69.181">             function checkDavResourceType_oSC(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l69.182"></a><span id="l69.182">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.183"></a><span id="l69.183">             try {</span>
<a href="#l69.184"></a><span id="l69.184">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l69.185"></a><span id="l69.185">                         &quot; on initial PROPFIND for calendar &quot; + thisCalendar.name);</span>
<a href="#l69.186"></a><span id="l69.186">             } catch (ex) {</span>
<a href="#l69.187"></a><span id="l69.187" class="difflineat">@@ -1768,34 +1768,34 @@ calDavCalendar.prototype = {</span>
<a href="#l69.188"></a><span id="l69.188">             // i.e a backend server being disabled.</span>
<a href="#l69.189"></a><span id="l69.189">             if (responseStatusCategory == 5) {</span>
<a href="#l69.190"></a><span id="l69.190">                 cal.LOG(&quot;CalDAV: Server not available &quot; + request.responseStatus +</span>
<a href="#l69.191"></a><span id="l69.191">                         &quot;, abort sync for calendar &quot; + thisCalendar.name);</span>
<a href="#l69.192"></a><span id="l69.192">                 thisCalendar.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l69.193"></a><span id="l69.193">                 return;</span>
<a href="#l69.194"></a><span id="l69.194">             }</span>
<a href="#l69.195"></a><span id="l69.195"> </span>
<a href="#l69.196"></a><span id="l69.196" class="difflineminus">-            var wwwauth;</span>
<a href="#l69.197"></a><span id="l69.197" class="difflineplus">+            let wwwauth;</span>
<a href="#l69.198"></a><span id="l69.198">             try {</span>
<a href="#l69.199"></a><span id="l69.199">                 wwwauth = request.getRequestHeader(&quot;Authorization&quot;);</span>
<a href="#l69.200"></a><span id="l69.200">                 thisCalendar.mAuthScheme = wwwauth.split(&quot; &quot;)[0];</span>
<a href="#l69.201"></a><span id="l69.201">             } catch (ex) {</span>
<a href="#l69.202"></a><span id="l69.202">                 // no auth header could mean a public calendar</span>
<a href="#l69.203"></a><span id="l69.203">                 thisCalendar.mAuthScheme = &quot;none&quot;;</span>
<a href="#l69.204"></a><span id="l69.204">             }</span>
<a href="#l69.205"></a><span id="l69.205"> </span>
<a href="#l69.206"></a><span id="l69.206">             if (thisCalendar.mUriParams) {</span>
<a href="#l69.207"></a><span id="l69.207">                 thisCalendar.mAuthScheme = &quot;Ticket&quot;;</span>
<a href="#l69.208"></a><span id="l69.208">             }</span>
<a href="#l69.209"></a><span id="l69.209">             cal.LOG(&quot;CalDAV: Authentication scheme for &quot; + thisCalendar.name +</span>
<a href="#l69.210"></a><span id="l69.210">                     &quot; is &quot; + thisCalendar.mAuthScheme);</span>
<a href="#l69.211"></a><span id="l69.211">             // we only really need the authrealm for Digest auth</span>
<a href="#l69.212"></a><span id="l69.212">             // since only Digest is going to time out on us</span>
<a href="#l69.213"></a><span id="l69.213">             if (thisCalendar.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l69.214"></a><span id="l69.214" class="difflineminus">-                var realmChop = wwwauth.split(&quot;realm=\&quot;&quot;)[1];</span>
<a href="#l69.215"></a><span id="l69.215" class="difflineplus">+                let realmChop = wwwauth.split(&quot;realm=\&quot;&quot;)[1];</span>
<a href="#l69.216"></a><span id="l69.216">                 thisCalendar.mAuthRealm = realmChop.split(&quot;\&quot;, &quot;)[0];</span>
<a href="#l69.217"></a><span id="l69.217">                 cal.LOG(&quot;CalDAV: realm &quot; + thisCalendar.mAuthRealm);</span>
<a href="#l69.218"></a><span id="l69.218">             }</span>
<a href="#l69.219"></a><span id="l69.219"> </span>
<a href="#l69.220"></a><span id="l69.220">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l69.221"></a><span id="l69.221">             if (!str || request.responseStatus == 404) {</span>
<a href="#l69.222"></a><span id="l69.222">                 // No response, or the calendar no longer exists.</span>
<a href="#l69.223"></a><span id="l69.223">                 cal.LOG(&quot;CalDAV: Failed to determine resource type for&quot; +</span>
<a href="#l69.224"></a><span id="l69.224" class="difflineat">@@ -1924,23 +1924,23 @@ calDavCalendar.prototype = {</span>
<a href="#l69.225"></a><span id="l69.225">      * checkDavResourceType</span>
<a href="#l69.226"></a><span id="l69.226">      * checkServerCaps                              * You are here</span>
<a href="#l69.227"></a><span id="l69.227">      * findPrincipalNS</span>
<a href="#l69.228"></a><span id="l69.228">      * checkPrincipalsNameSpace</span>
<a href="#l69.229"></a><span id="l69.229">      * completeCheckServerInfo</span>
<a href="#l69.230"></a><span id="l69.230">      */</span>
<a href="#l69.231"></a><span id="l69.231">     checkServerCaps: function caldav_checkServerCaps(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l69.232"></a><span id="l69.232">         let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l69.233"></a><span id="l69.233" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l69.234"></a><span id="l69.234" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l69.235"></a><span id="l69.235"> </span>
<a href="#l69.236"></a><span id="l69.236">         if (this.verboseLogging()) {</span>
<a href="#l69.237"></a><span id="l69.237">             cal.LOG(&quot;CalDAV: send: OPTIONS &quot; + homeSet.spec);</span>
<a href="#l69.238"></a><span id="l69.238">         }</span>
<a href="#l69.239"></a><span id="l69.239"> </span>
<a href="#l69.240"></a><span id="l69.240" class="difflineminus">-        var streamListener = {};</span>
<a href="#l69.241"></a><span id="l69.241" class="difflineplus">+        let streamListener = {};</span>
<a href="#l69.242"></a><span id="l69.242">         streamListener.onStreamComplete =</span>
<a href="#l69.243"></a><span id="l69.243">             function checkServerCaps_oSC(aLoader, aContext, aStatus,</span>
<a href="#l69.244"></a><span id="l69.244">                                          aResultLength, aResult) {</span>
<a href="#l69.245"></a><span id="l69.245">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.246"></a><span id="l69.246">             if (request.responseStatus != 200) {</span>
<a href="#l69.247"></a><span id="l69.247">                 if (!calHomeSetUrlRetry &amp;&amp; request.responseStatus == 404) {</span>
<a href="#l69.248"></a><span id="l69.248">                     // try again with calendar URL, see https://bugzilla.mozilla.org/show_bug.cgi?id=588799</span>
<a href="#l69.249"></a><span id="l69.249">                     cal.LOG(&quot;CalDAV: Calendar homeset was not found at parent url of calendar URL&quot; +</span>
<a href="#l69.250"></a><span id="l69.250" class="difflineat">@@ -2046,17 +2046,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.251"></a><span id="l69.251">               '&lt;D:prop&gt;' +</span>
<a href="#l69.252"></a><span id="l69.252">                 '&lt;D:principal-collection-set/&gt;' +</span>
<a href="#l69.253"></a><span id="l69.253">               '&lt;/D:prop&gt;' +</span>
<a href="#l69.254"></a><span id="l69.254">             '&lt;/D:propfind&gt;';</span>
<a href="#l69.255"></a><span id="l69.255"> </span>
<a href="#l69.256"></a><span id="l69.256">         if (this.verboseLogging()) {</span>
<a href="#l69.257"></a><span id="l69.257">             cal.LOG(&quot;CalDAV: send: &quot; + homeSet.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l69.258"></a><span id="l69.258">         }</span>
<a href="#l69.259"></a><span id="l69.259" class="difflineminus">-        var streamListener = {};</span>
<a href="#l69.260"></a><span id="l69.260" class="difflineplus">+        let streamListener = {};</span>
<a href="#l69.261"></a><span id="l69.261">         streamListener.onStreamComplete =</span>
<a href="#l69.262"></a><span id="l69.262">             function findInOutboxes_oSC(aLoader, aContext, aStatus,</span>
<a href="#l69.263"></a><span id="l69.263">                                          aResultLength, aResult) {</span>
<a href="#l69.264"></a><span id="l69.264">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.265"></a><span id="l69.265">             if (request.responseStatus != 207) {</span>
<a href="#l69.266"></a><span id="l69.266">                 cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l69.267"></a><span id="l69.267">                     &quot; while querying principal namespace for &quot; + thisCalendar.name);</span>
<a href="#l69.268"></a><span id="l69.268">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l69.269"></a><span id="l69.269" class="difflineat">@@ -2111,23 +2111,23 @@ calDavCalendar.prototype = {</span>
<a href="#l69.270"></a><span id="l69.270">      * checkServerCaps</span>
<a href="#l69.271"></a><span id="l69.271">      * findPrincipalNS</span>
<a href="#l69.272"></a><span id="l69.272">      * checkPrincipalsNameSpace                     * You are here</span>
<a href="#l69.273"></a><span id="l69.273">      * completeCheckServerInfo</span>
<a href="#l69.274"></a><span id="l69.274">      *</span>
<a href="#l69.275"></a><span id="l69.275">      * @param aNameSpaceList    List of available namespaces</span>
<a href="#l69.276"></a><span id="l69.276">      */</span>
<a href="#l69.277"></a><span id="l69.277">     checkPrincipalsNameSpace: function caldav_checkPrincipalsNameSpace(aNameSpaceList, aChangeLogListener) {</span>
<a href="#l69.278"></a><span id="l69.278" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l69.279"></a><span id="l69.279" class="difflineminus">-        function doesntSupportScheduling() {</span>
<a href="#l69.280"></a><span id="l69.280" class="difflineminus">-            thisCalendar.hasScheduling = false;</span>
<a href="#l69.281"></a><span id="l69.281" class="difflineminus">-            thisCalendar.mInboxUrl = null;</span>
<a href="#l69.282"></a><span id="l69.282" class="difflineminus">-            thisCalendar.mOutboxUrl = null;</span>
<a href="#l69.283"></a><span id="l69.283" class="difflineminus">-            thisCalendar.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l69.284"></a><span id="l69.284" class="difflineminus">-        }</span>
<a href="#l69.285"></a><span id="l69.285" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l69.286"></a><span id="l69.286" class="difflineplus">+        let doesntSupportScheduling = () =&gt; {</span>
<a href="#l69.287"></a><span id="l69.287" class="difflineplus">+            this.hasScheduling = false;</span>
<a href="#l69.288"></a><span id="l69.288" class="difflineplus">+            this.mInboxUrl = null;</span>
<a href="#l69.289"></a><span id="l69.289" class="difflineplus">+            this.mOutboxUrl = null;</span>
<a href="#l69.290"></a><span id="l69.290" class="difflineplus">+            this.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l69.291"></a><span id="l69.291" class="difflineplus">+        };</span>
<a href="#l69.292"></a><span id="l69.292"> </span>
<a href="#l69.293"></a><span id="l69.293">         if (!aNameSpaceList.length) {</span>
<a href="#l69.294"></a><span id="l69.294">             if (this.verboseLogging()) {</span>
<a href="#l69.295"></a><span id="l69.295">                 cal.LOG(&quot;CalDAV: principal namespace list empty, calendar &quot; +</span>
<a href="#l69.296"></a><span id="l69.296">                         this.name + &quot; doesn't support scheduling&quot;);</span>
<a href="#l69.297"></a><span id="l69.297">             }</span>
<a href="#l69.298"></a><span id="l69.298">             doesntSupportScheduling();</span>
<a href="#l69.299"></a><span id="l69.299">             return;</span>
<a href="#l69.300"></a><span id="l69.300" class="difflineat">@@ -2173,17 +2173,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.301"></a><span id="l69.301">         // We want a trailing slash, ensure it.</span>
<a href="#l69.302"></a><span id="l69.302">         let nextNS = aNameSpaceList.pop().replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l69.303"></a><span id="l69.303">         let requestUri = makeURL(this.calendarUri.prePath + this.ensureEncodedPath(nextNS));</span>
<a href="#l69.304"></a><span id="l69.304"> </span>
<a href="#l69.305"></a><span id="l69.305">         if (this.verboseLogging()) {</span>
<a href="#l69.306"></a><span id="l69.306">             cal.LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + requestUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l69.307"></a><span id="l69.307">         }</span>
<a href="#l69.308"></a><span id="l69.308"> </span>
<a href="#l69.309"></a><span id="l69.309" class="difflineminus">-        var streamListener = {};</span>
<a href="#l69.310"></a><span id="l69.310" class="difflineplus">+        let streamListener = {};</span>
<a href="#l69.311"></a><span id="l69.311">         streamListener.onStreamComplete =</span>
<a href="#l69.312"></a><span id="l69.312">             function caldav_cPNS_oSC(aLoader, aContext, aStatus,</span>
<a href="#l69.313"></a><span id="l69.313">                                          aResultLength, aResult) {</span>
<a href="#l69.314"></a><span id="l69.314">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.315"></a><span id="l69.315">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l69.316"></a><span id="l69.316">             if (!str) {</span>
<a href="#l69.317"></a><span id="l69.317">                 cal.LOG(&quot;CalDAV: Failed to report principals namespace for &quot; + thisCalendar.name);</span>
<a href="#l69.318"></a><span id="l69.318">                 doesntSupportScheduling();</span>
<a href="#l69.319"></a><span id="l69.319" class="difflineat">@@ -2323,33 +2323,33 @@ calDavCalendar.prototype = {</span>
<a href="#l69.320"></a><span id="l69.320">         }</span>
<a href="#l69.321"></a><span id="l69.321">     },</span>
<a href="#l69.322"></a><span id="l69.322"> </span>
<a href="#l69.323"></a><span id="l69.323">     /**</span>
<a href="#l69.324"></a><span id="l69.324">      * Called to report a certain DAV error. Strings and modification type are</span>
<a href="#l69.325"></a><span id="l69.325">      * handled here.</span>
<a href="#l69.326"></a><span id="l69.326">      */</span>
<a href="#l69.327"></a><span id="l69.327">     reportDavError: function caldav_reportDavError(aErrNo, status, extraInfo) {</span>
<a href="#l69.328"></a><span id="l69.328" class="difflineminus">-        var mapError = {};</span>
<a href="#l69.329"></a><span id="l69.329" class="difflineplus">+        let mapError = {};</span>
<a href="#l69.330"></a><span id="l69.330">         mapError[Components.interfaces.calIErrors.DAV_NOT_DAV] = &quot;dav_notDav&quot;;</span>
<a href="#l69.331"></a><span id="l69.331">         mapError[Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV] = &quot;dav_davNotCaldav&quot;;</span>
<a href="#l69.332"></a><span id="l69.332">         mapError[Components.interfaces.calIErrors.DAV_PUT_ERROR] = &quot;itemPutError&quot;;</span>
<a href="#l69.333"></a><span id="l69.333">         mapError[Components.interfaces.calIErrors.DAV_REMOVE_ERROR] = &quot;itemDeleteError&quot;;</span>
<a href="#l69.334"></a><span id="l69.334">         mapError[Components.interfaces.calIErrors.DAV_REPORT_ERROR] = &quot;disabledMode&quot;;</span>
<a href="#l69.335"></a><span id="l69.335"> </span>
<a href="#l69.336"></a><span id="l69.336" class="difflineminus">-        var mapModification = {};</span>
<a href="#l69.337"></a><span id="l69.337" class="difflineplus">+        let mapModification = {};</span>
<a href="#l69.338"></a><span id="l69.338">         mapModification[Components.interfaces.calIErrors.DAV_NOT_DAV] = false;</span>
<a href="#l69.339"></a><span id="l69.339">         mapModification[Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV] = false;</span>
<a href="#l69.340"></a><span id="l69.340">         mapModification[Components.interfaces.calIErrors.DAV_PUT_ERROR] = true;</span>
<a href="#l69.341"></a><span id="l69.341">         mapModification[Components.interfaces.calIErrors.DAV_REMOVE_ERROR] = true;</span>
<a href="#l69.342"></a><span id="l69.342">         mapModification[Components.interfaces.calIErrors.DAV_REPORT_ERROR] = false;</span>
<a href="#l69.343"></a><span id="l69.343"> </span>
<a href="#l69.344"></a><span id="l69.344" class="difflineminus">-        var message = mapError[aErrNo];</span>
<a href="#l69.345"></a><span id="l69.345" class="difflineminus">-        var localizedMessage;</span>
<a href="#l69.346"></a><span id="l69.346" class="difflineminus">-        var modificationError = mapModification[aErrNo];</span>
<a href="#l69.347"></a><span id="l69.347" class="difflineplus">+        let message = mapError[aErrNo];</span>
<a href="#l69.348"></a><span id="l69.348" class="difflineplus">+        let localizedMessage;</span>
<a href="#l69.349"></a><span id="l69.349" class="difflineplus">+        let modificationError = mapModification[aErrNo];</span>
<a href="#l69.350"></a><span id="l69.350"> </span>
<a href="#l69.351"></a><span id="l69.351">         if (!message) {</span>
<a href="#l69.352"></a><span id="l69.352">             // Only notify if there is a message for this error</span>
<a href="#l69.353"></a><span id="l69.353">             return;</span>
<a href="#l69.354"></a><span id="l69.354">         }</span>
<a href="#l69.355"></a><span id="l69.355">         localizedMessage = cal.calGetString(&quot;calendar&quot;, message, [this.mUri.spec]);</span>
<a href="#l69.356"></a><span id="l69.356">         this.mReadOnly = true;</span>
<a href="#l69.357"></a><span id="l69.357">         this.mDisabled = true;</span>
<a href="#l69.358"></a><span id="l69.358" class="difflineat">@@ -2360,17 +2360,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.359"></a><span id="l69.359">                          this.buildDetailedMessage(status, extraInfo));</span>
<a href="#l69.360"></a><span id="l69.360">     },</span>
<a href="#l69.361"></a><span id="l69.361"> </span>
<a href="#l69.362"></a><span id="l69.362">     buildDetailedMessage: function caldav_buildDetailedMessage(status, extraInfo) {</span>
<a href="#l69.363"></a><span id="l69.363">         if (!status) {</span>
<a href="#l69.364"></a><span id="l69.364">             return &quot;&quot;;</span>
<a href="#l69.365"></a><span id="l69.365">         }</span>
<a href="#l69.366"></a><span id="l69.366"> </span>
<a href="#l69.367"></a><span id="l69.367" class="difflineminus">-        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l69.368"></a><span id="l69.368" class="difflineplus">+        let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l69.369"></a><span id="l69.369">         let statusString;</span>
<a href="#l69.370"></a><span id="l69.370">         try {</span>
<a href="#l69.371"></a><span id="l69.371">             statusString = props.GetStringFromName(&quot;caldavRequestStatusCodeString&quot; + status);</span>
<a href="#l69.372"></a><span id="l69.372">         } catch (e) {</span>
<a href="#l69.373"></a><span id="l69.373">             // Fallback on generic string if no string is defined for the status code</span>
<a href="#l69.374"></a><span id="l69.374">             statusString = props.GetStringFromName(&quot;caldavRequestStatusCodeStringGeneric&quot;);</span>
<a href="#l69.375"></a><span id="l69.375">         }</span>
<a href="#l69.376"></a><span id="l69.376">         return props.formatStringFromName(&quot;caldavRequestStatusCode&quot;, [ status ], 1) + &quot;, &quot; +</span>
<a href="#l69.377"></a><span id="l69.377" class="difflineat">@@ -2397,44 +2397,44 @@ calDavCalendar.prototype = {</span>
<a href="#l69.378"></a><span id="l69.378">             // don't spam every known outbox with freebusy queries</span>
<a href="#l69.379"></a><span id="l69.379">             aListener.onResult(null, null);</span>
<a href="#l69.380"></a><span id="l69.380">             return;</span>
<a href="#l69.381"></a><span id="l69.381">         }</span>
<a href="#l69.382"></a><span id="l69.382"> </span>
<a href="#l69.383"></a><span id="l69.383">         // We tweak the organizer lookup here: If e.g. scheduling is turned off, then the</span>
<a href="#l69.384"></a><span id="l69.384">         // configured email takes place being the organizerId for scheduling which need</span>
<a href="#l69.385"></a><span id="l69.385">         // not match against the calendar-user-address:</span>
<a href="#l69.386"></a><span id="l69.386" class="difflineminus">-        var orgId = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l69.387"></a><span id="l69.387" class="difflineplus">+        let orgId = this.getProperty(&quot;organizerId&quot;);</span>
<a href="#l69.388"></a><span id="l69.388">         if (orgId &amp;&amp; orgId.toLowerCase() == aCalId.toLowerCase()) {</span>
<a href="#l69.389"></a><span id="l69.389">             aCalId = this.calendarUserAddress; // continue with calendar-user-address</span>
<a href="#l69.390"></a><span id="l69.390">         }</span>
<a href="#l69.391"></a><span id="l69.391"> </span>
<a href="#l69.392"></a><span id="l69.392">         // the caller prepends MAILTO: to calid strings containing @</span>
<a href="#l69.393"></a><span id="l69.393">         // but apple needs that to be mailto:</span>
<a href="#l69.394"></a><span id="l69.394" class="difflineminus">-        var aCalIdParts = aCalId.split(&quot;:&quot;);</span>
<a href="#l69.395"></a><span id="l69.395" class="difflineplus">+        let aCalIdParts = aCalId.split(&quot;:&quot;);</span>
<a href="#l69.396"></a><span id="l69.396">         aCalIdParts[0] = aCalIdParts[0].toLowerCase();</span>
<a href="#l69.397"></a><span id="l69.397"> </span>
<a href="#l69.398"></a><span id="l69.398">         if (aCalIdParts[0] != &quot;mailto&quot;</span>
<a href="#l69.399"></a><span id="l69.399">             &amp;&amp; aCalIdParts[0] != &quot;http&quot;</span>
<a href="#l69.400"></a><span id="l69.400">             &amp;&amp; aCalIdParts[0] != &quot;https&quot;) {</span>
<a href="#l69.401"></a><span id="l69.401">             aListener.onResult(null, null);</span>
<a href="#l69.402"></a><span id="l69.402">             return;</span>
<a href="#l69.403"></a><span id="l69.403">         }</span>
<a href="#l69.404"></a><span id="l69.404" class="difflineminus">-        var mailto_aCalId = aCalIdParts.join(&quot;:&quot;);</span>
<a href="#l69.405"></a><span id="l69.405" class="difflineplus">+        let mailto_aCalId = aCalIdParts.join(&quot;:&quot;);</span>
<a href="#l69.406"></a><span id="l69.406"> </span>
<a href="#l69.407"></a><span id="l69.407" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l69.408"></a><span id="l69.408" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l69.409"></a><span id="l69.409"> </span>
<a href="#l69.410"></a><span id="l69.410" class="difflineminus">-        var organizer = this.calendarUserAddress;</span>
<a href="#l69.411"></a><span id="l69.411" class="difflineplus">+        let organizer = this.calendarUserAddress;</span>
<a href="#l69.412"></a><span id="l69.412"> </span>
<a href="#l69.413"></a><span id="l69.413" class="difflineminus">-        var fbQuery = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l69.414"></a><span id="l69.414" class="difflineplus">+        let fbQuery = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l69.415"></a><span id="l69.415">         calSetProdidVersion(fbQuery);</span>
<a href="#l69.416"></a><span id="l69.416" class="difflineminus">-        var prop = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l69.417"></a><span id="l69.417" class="difflineplus">+        let prop = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l69.418"></a><span id="l69.418">         prop.value = &quot;REQUEST&quot;;</span>
<a href="#l69.419"></a><span id="l69.419">         fbQuery.addProperty(prop);</span>
<a href="#l69.420"></a><span id="l69.420" class="difflineminus">-        var fbComp = getIcsService().createIcalComponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l69.421"></a><span id="l69.421" class="difflineplus">+        let fbComp = getIcsService().createIcalComponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l69.422"></a><span id="l69.422">         fbComp.stampTime = now().getInTimezone(UTC());</span>
<a href="#l69.423"></a><span id="l69.423">         prop = getIcsService().createIcalProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l69.424"></a><span id="l69.424">         prop.value = organizer;</span>
<a href="#l69.425"></a><span id="l69.425">         fbComp.addProperty(prop);</span>
<a href="#l69.426"></a><span id="l69.426">         fbComp.startTime = aRangeStart.getInTimezone(UTC());</span>
<a href="#l69.427"></a><span id="l69.427">         fbComp.endTime = aRangeEnd.getInTimezone(UTC());</span>
<a href="#l69.428"></a><span id="l69.428">         fbComp.uid = cal.getUUID();</span>
<a href="#l69.429"></a><span id="l69.429">         prop = getIcsService().createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l69.430"></a><span id="l69.430" class="difflineat">@@ -2445,32 +2445,32 @@ calDavCalendar.prototype = {</span>
<a href="#l69.431"></a><span id="l69.431">         fbComp.addProperty(prop);</span>
<a href="#l69.432"></a><span id="l69.432">         fbQuery.addSubcomponent(fbComp);</span>
<a href="#l69.433"></a><span id="l69.433">         fbQuery = fbQuery.serializeToICS();</span>
<a href="#l69.434"></a><span id="l69.434">         if (this.verboseLogging()) {</span>
<a href="#l69.435"></a><span id="l69.435">             cal.LOG(&quot;CalDAV: send (Originator=&quot; + organizer +</span>
<a href="#l69.436"></a><span id="l69.436">                     &quot;,Recipient=&quot; + mailto_aCalId + &quot;): &quot; + fbQuery);</span>
<a href="#l69.437"></a><span id="l69.437">         }</span>
<a href="#l69.438"></a><span id="l69.438"> </span>
<a href="#l69.439"></a><span id="l69.439" class="difflineminus">-        var streamListener = {};</span>
<a href="#l69.440"></a><span id="l69.440" class="difflineplus">+        let streamListener = {};</span>
<a href="#l69.441"></a><span id="l69.441"> </span>
<a href="#l69.442"></a><span id="l69.442">         streamListener.onStreamComplete =</span>
<a href="#l69.443"></a><span id="l69.443">             function caldav_GFBI_oSC(aLoader, aContext, aStatus,</span>
<a href="#l69.444"></a><span id="l69.444">                                          aResultLength, aResult) {</span>
<a href="#l69.445"></a><span id="l69.445">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.446"></a><span id="l69.446">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l69.447"></a><span id="l69.447">             if (!str) {</span>
<a href="#l69.448"></a><span id="l69.448">                 cal.LOG(&quot;CalDAV: Failed to parse freebusy response from &quot; + thisCalendar.name);</span>
<a href="#l69.449"></a><span id="l69.449">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l69.450"></a><span id="l69.450">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l69.451"></a><span id="l69.451">             }</span>
<a href="#l69.452"></a><span id="l69.452"> </span>
<a href="#l69.453"></a><span id="l69.453">             if (request.responseStatus == 200) {</span>
<a href="#l69.454"></a><span id="l69.454" class="difflineminus">-                var periodsToReturn = [];</span>
<a href="#l69.455"></a><span id="l69.455" class="difflineminus">-                var fbTypeMap = {};</span>
<a href="#l69.456"></a><span id="l69.456" class="difflineplus">+                let periodsToReturn = [];</span>
<a href="#l69.457"></a><span id="l69.457" class="difflineplus">+                let fbTypeMap = {};</span>
<a href="#l69.458"></a><span id="l69.458">                 fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l69.459"></a><span id="l69.459">                 fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span>
<a href="#l69.460"></a><span id="l69.460">                 fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l69.461"></a><span id="l69.461">                 fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l69.462"></a><span id="l69.462"> </span>
<a href="#l69.463"></a><span id="l69.463">                 let fbResult;</span>
<a href="#l69.464"></a><span id="l69.464">                 try {</span>
<a href="#l69.465"></a><span id="l69.465">                     fbResult = cal.xml.parseString(str);</span>
<a href="#l69.466"></a><span id="l69.466" class="difflineat">@@ -2585,34 +2585,34 @@ calDavCalendar.prototype = {</span>
<a href="#l69.467"></a><span id="l69.467">      * encoded full url</span>
<a href="#l69.468"></a><span id="l69.468">      *</span>
<a href="#l69.469"></a><span id="l69.469">      * @param aString {string} un-encoded path OR encoded uri spec.</span>
<a href="#l69.470"></a><span id="l69.470">      */</span>
<a href="#l69.471"></a><span id="l69.471">     ensureEncodedPath: function caldav_ensureEncodedPath(aString) {</span>
<a href="#l69.472"></a><span id="l69.472">         if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l69.473"></a><span id="l69.473">             aString = this.ensureDecodedPath(aString);</span>
<a href="#l69.474"></a><span id="l69.474">         }</span>
<a href="#l69.475"></a><span id="l69.475" class="difflineminus">-        var uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l69.476"></a><span id="l69.476" class="difflineplus">+        let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l69.477"></a><span id="l69.477">         uriComponents = uriComponents.map(encodeURIComponent);</span>
<a href="#l69.478"></a><span id="l69.478">         return uriComponents.join(&quot;/&quot;);</span>
<a href="#l69.479"></a><span id="l69.479">     },</span>
<a href="#l69.480"></a><span id="l69.480"> </span>
<a href="#l69.481"></a><span id="l69.481">     /**</span>
<a href="#l69.482"></a><span id="l69.482">      * This is called to get a decoded path from an encoded path or uri spec.</span>
<a href="#l69.483"></a><span id="l69.483">      *</span>
<a href="#l69.484"></a><span id="l69.484">      * @param aString {string} Represents either a path</span>
<a href="#l69.485"></a><span id="l69.485">      * or a full uri that needs to be decoded.</span>
<a href="#l69.486"></a><span id="l69.486">      */</span>
<a href="#l69.487"></a><span id="l69.487">     ensureDecodedPath: function caldav_ensureDecodedPath(aString) {</span>
<a href="#l69.488"></a><span id="l69.488">         if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l69.489"></a><span id="l69.489">             aString = this.extractPathFromSpec(aString);</span>
<a href="#l69.490"></a><span id="l69.490">         }</span>
<a href="#l69.491"></a><span id="l69.491"> </span>
<a href="#l69.492"></a><span id="l69.492" class="difflineminus">-        var uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l69.493"></a><span id="l69.493" class="difflineminus">-        for (var i = 0; i &lt; uriComponents.length; i++) {</span>
<a href="#l69.494"></a><span id="l69.494" class="difflineplus">+        let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l69.495"></a><span id="l69.495" class="difflineplus">+        for (let i = 0; i &lt; uriComponents.length; i++) {</span>
<a href="#l69.496"></a><span id="l69.496">             try {</span>
<a href="#l69.497"></a><span id="l69.497">                 uriComponents[i] = decodeURIComponent(uriComponents[i]);</span>
<a href="#l69.498"></a><span id="l69.498">             } catch (e) {</span>
<a href="#l69.499"></a><span id="l69.499">                 cal.WARN(&quot;CalDAV: Exception decoding path &quot; + aString + &quot;, segment: &quot; + uriComponents[i]);</span>
<a href="#l69.500"></a><span id="l69.500">             }</span>
<a href="#l69.501"></a><span id="l69.501">         }</span>
<a href="#l69.502"></a><span id="l69.502">         return uriComponents.join(&quot;/&quot;);</span>
<a href="#l69.503"></a><span id="l69.503">     },</span>
<a href="#l69.504"></a><span id="l69.504" class="difflineat">@@ -2641,64 +2641,64 @@ calDavCalendar.prototype = {</span>
<a href="#l69.505"></a><span id="l69.505"> </span>
<a href="#l69.506"></a><span id="l69.506">     //</span>
<a href="#l69.507"></a><span id="l69.507">     // take calISchedulingSupport interface base implementation (cal.ProviderBase)</span>
<a href="#l69.508"></a><span id="l69.508">     //</span>
<a href="#l69.509"></a><span id="l69.509"> </span>
<a href="#l69.510"></a><span id="l69.510">     processItipReply: function caldav_processItipReply(aItem, aPath) {</span>
<a href="#l69.511"></a><span id="l69.511">         // modify partstat for in-calendar item</span>
<a href="#l69.512"></a><span id="l69.512">         // delete item from inbox</span>
<a href="#l69.513"></a><span id="l69.513" class="difflineminus">-        var thisCalendar = this;</span>
<a href="#l69.514"></a><span id="l69.514" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l69.515"></a><span id="l69.515"> </span>
<a href="#l69.516"></a><span id="l69.516" class="difflineminus">-        var getItemListener = {};</span>
<a href="#l69.517"></a><span id="l69.517" class="difflineplus">+        let getItemListener = {};</span>
<a href="#l69.518"></a><span id="l69.518">         getItemListener.QueryInterface = XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]);</span>
<a href="#l69.519"></a><span id="l69.519">         getItemListener.onOperationComplete = function caldav_gUIs_oOC(aCalendar,</span>
<a href="#l69.520"></a><span id="l69.520">                                                                        aStatus,</span>
<a href="#l69.521"></a><span id="l69.521">                                                                        aOperationType,</span>
<a href="#l69.522"></a><span id="l69.522">                                                                        aId,</span>
<a href="#l69.523"></a><span id="l69.523">                                                                        aDetail) {</span>
<a href="#l69.524"></a><span id="l69.524">         };</span>
<a href="#l69.525"></a><span id="l69.525">         getItemListener.onGetResult = function caldav_pIR_oGR(aCalendar,</span>
<a href="#l69.526"></a><span id="l69.526">                                                               aStatus,</span>
<a href="#l69.527"></a><span id="l69.527">                                                               aItemType,</span>
<a href="#l69.528"></a><span id="l69.528">                                                               aDetail,</span>
<a href="#l69.529"></a><span id="l69.529">                                                               aCount,</span>
<a href="#l69.530"></a><span id="l69.530">                                                               aItems) {</span>
<a href="#l69.531"></a><span id="l69.531" class="difflineminus">-            var itemToUpdate = aItems[0];</span>
<a href="#l69.532"></a><span id="l69.532" class="difflineplus">+            let itemToUpdate = aItems[0];</span>
<a href="#l69.533"></a><span id="l69.533">             if (aItem.recurrenceId &amp;&amp; itemToUpdate.recurrenceInfo) {</span>
<a href="#l69.534"></a><span id="l69.534">                 itemToUpdate = itemToUpdate.recurrenceInfo.getOccurrenceFor(aItem.recurrenceId);</span>
<a href="#l69.535"></a><span id="l69.535">             }</span>
<a href="#l69.536"></a><span id="l69.536" class="difflineminus">-            var newItem = itemToUpdate.clone();</span>
<a href="#l69.537"></a><span id="l69.537" class="difflineplus">+            let newItem = itemToUpdate.clone();</span>
<a href="#l69.538"></a><span id="l69.538"> </span>
<a href="#l69.539"></a><span id="l69.539" class="difflineminus">-            for (var attendee of aItem.getAttendees({})) {</span>
<a href="#l69.540"></a><span id="l69.540" class="difflineminus">-                var att = newItem.getAttendeeById(attendee.id);</span>
<a href="#l69.541"></a><span id="l69.541" class="difflineplus">+            for (let attendee of aItem.getAttendees({})) {</span>
<a href="#l69.542"></a><span id="l69.542" class="difflineplus">+                let att = newItem.getAttendeeById(attendee.id);</span>
<a href="#l69.543"></a><span id="l69.543">                 if (att) {</span>
<a href="#l69.544"></a><span id="l69.544">                     newItem.removeAttendee(att);</span>
<a href="#l69.545"></a><span id="l69.545">                     att = att.clone();</span>
<a href="#l69.546"></a><span id="l69.546">                     att.participationStatus = attendee.participationStatus;</span>
<a href="#l69.547"></a><span id="l69.547">                     newItem.addAttendee(att);</span>
<a href="#l69.548"></a><span id="l69.548">                 }</span>
<a href="#l69.549"></a><span id="l69.549">             }</span>
<a href="#l69.550"></a><span id="l69.550">             thisCalendar.doModifyItem(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l69.551"></a><span id="l69.551">                                       modListener, true);</span>
<a href="#l69.552"></a><span id="l69.552">         };</span>
<a href="#l69.553"></a><span id="l69.553"> </span>
<a href="#l69.554"></a><span id="l69.554" class="difflineminus">-        var modListener = {};</span>
<a href="#l69.555"></a><span id="l69.555" class="difflineplus">+        let modListener = {};</span>
<a href="#l69.556"></a><span id="l69.556">         modListener.QueryInterface = XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]);</span>
<a href="#l69.557"></a><span id="l69.557">         modListener.onOperationComplete = function caldav_pIR_moOC(aCalendar,</span>
<a href="#l69.558"></a><span id="l69.558">                                                                    aStatus,</span>
<a href="#l69.559"></a><span id="l69.559">                                                                    aOperationType,</span>
<a href="#l69.560"></a><span id="l69.560">                                                                    aItemId,</span>
<a href="#l69.561"></a><span id="l69.561">                                                                    aDetail) {</span>
<a href="#l69.562"></a><span id="l69.562">             cal.LOG(&quot;CalDAV: status &quot; + aStatus + &quot; while processing iTIP REPLY &quot; +</span>
<a href="#l69.563"></a><span id="l69.563">                     &quot; for &quot; + thisCalendar.name);</span>
<a href="#l69.564"></a><span id="l69.564">             // don't delete the REPLY item from inbox unless modifying the master</span>
<a href="#l69.565"></a><span id="l69.565">             // item was successful</span>
<a href="#l69.566"></a><span id="l69.566">             if (aStatus == 0) { // aStatus undocumented; 0 seems to indicate no error</span>
<a href="#l69.567"></a><span id="l69.567" class="difflineminus">-                var delUri = thisCalendar.calendarUri.clone();</span>
<a href="#l69.568"></a><span id="l69.568" class="difflineplus">+                let delUri = thisCalendar.calendarUri.clone();</span>
<a href="#l69.569"></a><span id="l69.569">                 delUri.path = thisCalendar.ensureEncodedPath(aPath);</span>
<a href="#l69.570"></a><span id="l69.570">                 thisCalendar.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l69.571"></a><span id="l69.571">             }</span>
<a href="#l69.572"></a><span id="l69.572">         };</span>
<a href="#l69.573"></a><span id="l69.573"> </span>
<a href="#l69.574"></a><span id="l69.574">         this.mOfflineStorage.getItem(aItem.id, getItemListener);</span>
<a href="#l69.575"></a><span id="l69.575">     },</span>
<a href="#l69.576"></a><span id="l69.576"> </span>
<a href="#l69.577"></a><span id="l69.577" class="difflineat">@@ -2749,34 +2749,34 @@ calDavCalendar.prototype = {</span>
<a href="#l69.578"></a><span id="l69.578">             // ATTENDEES and/or interpreting the SCHEDULE-STATUS parameter which</span>
<a href="#l69.579"></a><span id="l69.579">             // could translate in the client sending out IMIP REQUESTS</span>
<a href="#l69.580"></a><span id="l69.580">             // for specific attendees.</span>
<a href="#l69.581"></a><span id="l69.581">             return false;</span>
<a href="#l69.582"></a><span id="l69.582">         }</span>
<a href="#l69.583"></a><span id="l69.583"> </span>
<a href="#l69.584"></a><span id="l69.584">         if (aItipItem.responseMethod == &quot;REPLY&quot;) {</span>
<a href="#l69.585"></a><span id="l69.585">             // Get my participation status</span>
<a href="#l69.586"></a><span id="l69.586" class="difflineminus">-            var attendee = aItipItem.getItemList({})[0].getAttendeeById(this.calendarUserAddress);</span>
<a href="#l69.587"></a><span id="l69.587" class="difflineplus">+            let attendee = aItipItem.getItemList({})[0].getAttendeeById(this.calendarUserAddress);</span>
<a href="#l69.588"></a><span id="l69.588">             if (!attendee) {</span>
<a href="#l69.589"></a><span id="l69.589">                 return false;</span>
<a href="#l69.590"></a><span id="l69.590">             }</span>
<a href="#l69.591"></a><span id="l69.591">             // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l69.592"></a><span id="l69.592">             aItipItem.setAttendeeStatus(attendee.id, attendee.participationStatus);</span>
<a href="#l69.593"></a><span id="l69.593">         }</span>
<a href="#l69.594"></a><span id="l69.594"> </span>
<a href="#l69.595"></a><span id="l69.595" class="difflineminus">-        for (var item of aItipItem.getItemList({})) {</span>
<a href="#l69.596"></a><span id="l69.596" class="difflineminus">-            var serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l69.597"></a><span id="l69.597" class="difflineplus">+        for (let item of aItipItem.getItemList({})) {</span>
<a href="#l69.598"></a><span id="l69.598" class="difflineplus">+            let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l69.599"></a><span id="l69.599">                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l69.600"></a><span id="l69.600">             serializer.addItems([item], 1);</span>
<a href="#l69.601"></a><span id="l69.601" class="difflineminus">-            var methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l69.602"></a><span id="l69.602" class="difflineplus">+            let methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l69.603"></a><span id="l69.603">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l69.604"></a><span id="l69.604">             serializer.addProperty(methodProp);</span>
<a href="#l69.605"></a><span id="l69.605"> </span>
<a href="#l69.606"></a><span id="l69.606" class="difflineminus">-            var thisCalendar = this;</span>
<a href="#l69.607"></a><span id="l69.607" class="difflineminus">-            var streamListener = {</span>
<a href="#l69.608"></a><span id="l69.608" class="difflineplus">+            let thisCalendar = this;</span>
<a href="#l69.609"></a><span id="l69.609" class="difflineplus">+            let streamListener = {</span>
<a href="#l69.610"></a><span id="l69.610">                 onStreamComplete: function caldav_sendItems_oSC(aLoader, aContext, aStatus,</span>
<a href="#l69.611"></a><span id="l69.611">                                                                 aResultLength, aResult) {</span>
<a href="#l69.612"></a><span id="l69.612">                     let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l69.613"></a><span id="l69.613">                     let status;</span>
<a href="#l69.614"></a><span id="l69.614">                     try {</span>
<a href="#l69.615"></a><span id="l69.615">                         status = request.responseStatus;</span>
<a href="#l69.616"></a><span id="l69.616">                     } catch (ex) {</span>
<a href="#l69.617"></a><span id="l69.617">                         status = Components.interfaces.calIErrors.DAV_POST_ERROR;</span>
<a href="#l69.618"></a><span id="l69.618" class="difflineat">@@ -2802,17 +2802,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.619"></a><span id="l69.619">                     let responseXML;</span>
<a href="#l69.620"></a><span id="l69.620">                     try {</span>
<a href="#l69.621"></a><span id="l69.621">                         responseXML = cal.xml.parseString(str);</span>
<a href="#l69.622"></a><span id="l69.622">                     } catch (ex) {</span>
<a href="#l69.623"></a><span id="l69.623">                         cal.LOG(&quot;CalDAV: Could not parse multistatus response: &quot; + ex + &quot;\n&quot; + str);</span>
<a href="#l69.624"></a><span id="l69.624">                         return;</span>
<a href="#l69.625"></a><span id="l69.625">                     }</span>
<a href="#l69.626"></a><span id="l69.626"> </span>
<a href="#l69.627"></a><span id="l69.627" class="difflineminus">-                    var remainingAttendees = [];</span>
<a href="#l69.628"></a><span id="l69.628" class="difflineplus">+                    let remainingAttendees = [];</span>
<a href="#l69.629"></a><span id="l69.629">                     // TODO The following XPath expressions are currently</span>
<a href="#l69.630"></a><span id="l69.630">                     // untested code, as I don't have a caldav-sched server</span>
<a href="#l69.631"></a><span id="l69.631">                     // available. If you find someone who does, please test!</span>
<a href="#l69.632"></a><span id="l69.632">                     let responses = caldavXPath(responseXML, &quot;/C:schedule-response/C:response&quot;);</span>
<a href="#l69.633"></a><span id="l69.633">                     if (responses) {</span>
<a href="#l69.634"></a><span id="l69.634">                         for (let response of responses) {</span>
<a href="#l69.635"></a><span id="l69.635">                             let recip = caldavXPathFirst(response, &quot;C:recipient/D:href/text()&quot;);</span>
<a href="#l69.636"></a><span id="l69.636">                             let reqstatus = caldavXPathFirst(response, &quot;C:request-status/text()&quot;);</span>
<a href="#l69.637"></a><span id="l69.637" class="difflineat">@@ -2828,17 +2828,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.638"></a><span id="l69.638">                                 }</span>
<a href="#l69.639"></a><span id="l69.639">                             }</span>
<a href="#l69.640"></a><span id="l69.640">                         }</span>
<a href="#l69.641"></a><span id="l69.641">                     }</span>
<a href="#l69.642"></a><span id="l69.642"> </span>
<a href="#l69.643"></a><span id="l69.643">                     if (remainingAttendees.length) {</span>
<a href="#l69.644"></a><span id="l69.644">                         // try to fall back to email delivery if CalDAV-sched</span>
<a href="#l69.645"></a><span id="l69.645">                         // didn't work</span>
<a href="#l69.646"></a><span id="l69.646" class="difflineminus">-                        var imipTransport = cal.getImipTransport(thisCalendar);</span>
<a href="#l69.647"></a><span id="l69.647" class="difflineplus">+                        let imipTransport = cal.getImipTransport(thisCalendar);</span>
<a href="#l69.648"></a><span id="l69.648">                         if (imipTransport) {</span>
<a href="#l69.649"></a><span id="l69.649">                             if (thisCalendar.verboseLogging()) {</span>
<a href="#l69.650"></a><span id="l69.650">                                 cal.LOG(&quot;CalDAV: sending email to &quot; + remainingAttendees.length + &quot; recipients&quot;);</span>
<a href="#l69.651"></a><span id="l69.651">                             }</span>
<a href="#l69.652"></a><span id="l69.652">                             imipTransport.sendItems(remainingAttendees.length, remainingAttendees, aItipItem);</span>
<a href="#l69.653"></a><span id="l69.653">                         } else {</span>
<a href="#l69.654"></a><span id="l69.654">                             cal.LOG(&quot;CalDAV: no fallback to iTIP/iMIP transport for &quot; +</span>
<a href="#l69.655"></a><span id="l69.655">                                     thisCalendar.name);</span>
<a href="#l69.656"></a><span id="l69.656" class="difflineat">@@ -2850,17 +2850,17 @@ calDavCalendar.prototype = {</span>
<a href="#l69.657"></a><span id="l69.657">             let uploadData = serializer.serializeToString();</span>
<a href="#l69.658"></a><span id="l69.658">             let requestUri = this.makeUri(null, this.outboxUrl);</span>
<a href="#l69.659"></a><span id="l69.659">             if (this.verboseLogging()) {</span>
<a href="#l69.660"></a><span id="l69.660">                 cal.LOG(&quot;CalDAV: send(&quot; + requestUri.spec + &quot;): &quot; + uploadData);</span>
<a href="#l69.661"></a><span id="l69.661">             }</span>
<a href="#l69.662"></a><span id="l69.662">             this.sendHttpRequest(requestUri, uploadData, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l69.663"></a><span id="l69.663">                 channel.requestMethod = &quot;POST&quot;;</span>
<a href="#l69.664"></a><span id="l69.664">                 channel.setRequestHeader(&quot;Originator&quot;, this.calendarUserAddress, false);</span>
<a href="#l69.665"></a><span id="l69.665" class="difflineminus">-                for (var recipient of aRecipients) {</span>
<a href="#l69.666"></a><span id="l69.666" class="difflineplus">+                for (let recipient of aRecipients) {</span>
<a href="#l69.667"></a><span id="l69.667">                     channel.setRequestHeader(&quot;Recipient&quot;, recipient.id, true);</span>
<a href="#l69.668"></a><span id="l69.668">                 }</span>
<a href="#l69.669"></a><span id="l69.669">                 return streamListener;</span>
<a href="#l69.670"></a><span id="l69.670">             }, () =&gt; {</span>
<a href="#l69.671"></a><span id="l69.671">                 notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l69.672"></a><span id="l69.672">                                &quot;Error preparing http channel&quot;);</span>
<a href="#l69.673"></a><span id="l69.673">             });</span>
<a href="#l69.674"></a><span id="l69.674">         }</span>
<a href="#l69.675"></a><span id="l69.675" class="difflineat">@@ -2871,20 +2871,20 @@ calDavCalendar.prototype = {</span>
<a href="#l69.676"></a><span id="l69.676">     verboseLogging: function caldav_verboseLogging() {</span>
<a href="#l69.677"></a><span id="l69.677">         if (this.mVerboseLogging === undefined) {</span>
<a href="#l69.678"></a><span id="l69.678">             this.mVerboseLogging = Preferences.get(&quot;calendar.debug.log.verbose&quot;, false);</span>
<a href="#l69.679"></a><span id="l69.679">         }</span>
<a href="#l69.680"></a><span id="l69.680">         return this.mVerboseLogging;</span>
<a href="#l69.681"></a><span id="l69.681">     },</span>
<a href="#l69.682"></a><span id="l69.682"> </span>
<a href="#l69.683"></a><span id="l69.683">     getSerializedItem: function caldav_getSerializedItem(aItem) {</span>
<a href="#l69.684"></a><span id="l69.684" class="difflineminus">-        var serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l69.685"></a><span id="l69.685" class="difflineplus">+        let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l69.686"></a><span id="l69.686">                                    .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l69.687"></a><span id="l69.687">         serializer.addItems([aItem], 1);</span>
<a href="#l69.688"></a><span id="l69.688" class="difflineminus">-        var serializedItem = serializer.serializeToString();</span>
<a href="#l69.689"></a><span id="l69.689" class="difflineplus">+        let serializedItem = serializer.serializeToString();</span>
<a href="#l69.690"></a><span id="l69.690">         if (this.verboseLogging()) {</span>
<a href="#l69.691"></a><span id="l69.691">             cal.LOG(&quot;CalDAV: send: &quot; + serializedItem);</span>
<a href="#l69.692"></a><span id="l69.692">         }</span>
<a href="#l69.693"></a><span id="l69.693">         return serializedItem;</span>
<a href="#l69.694"></a><span id="l69.694">     },</span>
<a href="#l69.695"></a><span id="l69.695"> </span>
<a href="#l69.696"></a><span id="l69.696">     // nsIChannelEventSink implementation</span>
<a href="#l69.697"></a><span id="l69.697">     asyncOnChannelRedirect: function caldav_asyncOonChannelRedirect(aOldChannel, aNewChannel, aFlags, aCallback) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -111,17 +111,17 @@ calICSCalendar.prototype = {</span>
<a href="#l70.4"></a><span id="l70.4"> </span>
<a href="#l70.5"></a><span id="l70.5">     get uri() { return this.mUri; },</span>
<a href="#l70.6"></a><span id="l70.6">     set uri(aUri) {</span>
<a href="#l70.7"></a><span id="l70.7">         this.mUri = aUri;</span>
<a href="#l70.8"></a><span id="l70.8">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l70.9"></a><span id="l70.9"> </span>
<a href="#l70.10"></a><span id="l70.10">         // Use the ioservice, to create a channel, which makes finding the</span>
<a href="#l70.11"></a><span id="l70.11">         // right hooks to use easier.</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-        var channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+        let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l70.14"></a><span id="l70.14">                                                      null,</span>
<a href="#l70.15"></a><span id="l70.15">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l70.16"></a><span id="l70.16">                                                      null,</span>
<a href="#l70.17"></a><span id="l70.17">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l70.18"></a><span id="l70.18">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l70.19"></a><span id="l70.19">         let wHttpChannel = cal.wrapInstance(channel, Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.20"></a><span id="l70.20">         let wFileChannel = cal.wrapInstance(channel, Components.interfaces.nsIFileChannel);</span>
<a href="#l70.21"></a><span id="l70.21"> </span>
<a href="#l70.22"></a><span id="l70.22" class="difflineat">@@ -173,25 +173,25 @@ calICSCalendar.prototype = {</span>
<a href="#l70.23"></a><span id="l70.23">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l70.24"></a><span id="l70.24">     },</span>
<a href="#l70.25"></a><span id="l70.25"> </span>
<a href="#l70.26"></a><span id="l70.26">     doRefresh: function calICSCalendar_doRefresh(aForce) {</span>
<a href="#l70.27"></a><span id="l70.27">         let prbForce = Components.classes[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l70.28"></a><span id="l70.28">                                  .createInstance(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l70.29"></a><span id="l70.29">         prbForce.data = aForce;</span>
<a href="#l70.30"></a><span id="l70.30"> </span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-        var channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineplus">+        let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l70.33"></a><span id="l70.33">                                                      null,</span>
<a href="#l70.34"></a><span id="l70.34">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l70.35"></a><span id="l70.35">                                                      null,</span>
<a href="#l70.36"></a><span id="l70.36">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l70.37"></a><span id="l70.37">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l70.38"></a><span id="l70.38">         this.prepareChannel(channel, aForce);</span>
<a href="#l70.39"></a><span id="l70.39"> </span>
<a href="#l70.40"></a><span id="l70.40" class="difflineminus">-        var streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineplus">+        let streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l70.42"></a><span id="l70.42">                                      .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l70.43"></a><span id="l70.43"> </span>
<a href="#l70.44"></a><span id="l70.44">         // Lock other changes to the item list.</span>
<a href="#l70.45"></a><span id="l70.45">         this.lock();</span>
<a href="#l70.46"></a><span id="l70.46"> </span>
<a href="#l70.47"></a><span id="l70.47">         try {</span>
<a href="#l70.48"></a><span id="l70.48">             streamLoader.init(this);</span>
<a href="#l70.49"></a><span id="l70.49">             channel.asyncOpen(streamLoader, prbForce);</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineat">@@ -241,21 +241,21 @@ calICSCalendar.prototype = {</span>
<a href="#l70.51"></a><span id="l70.51">             this.mObserver.onLoad(this);</span>
<a href="#l70.52"></a><span id="l70.52">             this.unlock();</span>
<a href="#l70.53"></a><span id="l70.53">             return;</span>
<a href="#l70.54"></a><span id="l70.54">         }</span>
<a href="#l70.55"></a><span id="l70.55"> </span>
<a href="#l70.56"></a><span id="l70.56">         // This conversion is needed, because the stream only knows about</span>
<a href="#l70.57"></a><span id="l70.57">         // byte arrays, not about strings or encodings. The array of bytes</span>
<a href="#l70.58"></a><span id="l70.58">         // need to be interpreted as utf8 and put into a javascript string.</span>
<a href="#l70.59"></a><span id="l70.59" class="difflineminus">-        var unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l70.60"></a><span id="l70.60" class="difflineplus">+        let unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l70.61"></a><span id="l70.61">                                          .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l70.62"></a><span id="l70.62">         // ics files are always utf8</span>
<a href="#l70.63"></a><span id="l70.63">         unicodeConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineminus">-        var str;</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+        let str;</span>
<a href="#l70.66"></a><span id="l70.66">         try {</span>
<a href="#l70.67"></a><span id="l70.67">             str = unicodeConverter.convertFromByteArray(result, result.length);</span>
<a href="#l70.68"></a><span id="l70.68">         } catch (e) {</span>
<a href="#l70.69"></a><span id="l70.69">             this.mObserver.onError(this.superCalendar, calIErrors.CAL_UTF8_DECODING_FAILED, e.toString());</span>
<a href="#l70.70"></a><span id="l70.70">             this.mObserver.onError(this.superCalendar, calIErrors.READ_FAILED, &quot;&quot;);</span>
<a href="#l70.71"></a><span id="l70.71">             this.unlock();</span>
<a href="#l70.72"></a><span id="l70.72">             return;</span>
<a href="#l70.73"></a><span id="l70.73">         }</span>
<a href="#l70.74"></a><span id="l70.74" class="difflineat">@@ -310,44 +310,44 @@ calICSCalendar.prototype = {</span>
<a href="#l70.75"></a><span id="l70.75">         } catch (exc) {</span>
<a href="#l70.76"></a><span id="l70.76">             this.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l70.77"></a><span id="l70.77">             throw exc;</span>
<a href="#l70.78"></a><span id="l70.78">         }</span>
<a href="#l70.79"></a><span id="l70.79">     },</span>
<a href="#l70.80"></a><span id="l70.80"> </span>
<a href="#l70.81"></a><span id="l70.81">     doWriteICS: function() {</span>
<a href="#l70.82"></a><span id="l70.82">         cal.LOG(&quot;[calICSCalendar] Writing ICS File &quot; + this.uri.spec);</span>
<a href="#l70.83"></a><span id="l70.83" class="difflineminus">-        var savedthis = this;</span>
<a href="#l70.84"></a><span id="l70.84" class="difflineminus">-        var listener =</span>
<a href="#l70.85"></a><span id="l70.85" class="difflineplus">+        let savedthis = this;</span>
<a href="#l70.86"></a><span id="l70.86" class="difflineplus">+        let listener =</span>
<a href="#l70.87"></a><span id="l70.87">         {</span>
<a href="#l70.88"></a><span id="l70.88">             serializer: null,</span>
<a href="#l70.89"></a><span id="l70.89">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l70.90"></a><span id="l70.90">             onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l70.91"></a><span id="l70.91" class="difflineminus">-                var inLastWindowClosingSurvivalArea = false;</span>
<a href="#l70.92"></a><span id="l70.92" class="difflineplus">+                let inLastWindowClosingSurvivalArea = false;</span>
<a href="#l70.93"></a><span id="l70.93">                 try {</span>
<a href="#l70.94"></a><span id="l70.94">                     // All events are returned. Now set up a channel and a</span>
<a href="#l70.95"></a><span id="l70.95">                     // streamloader to upload.  onStopRequest will be called</span>
<a href="#l70.96"></a><span id="l70.96">                     // once the write has finished</span>
<a href="#l70.97"></a><span id="l70.97" class="difflineminus">-                    var channel = Services.io.newChannelFromURI2(savedthis.mUri,</span>
<a href="#l70.98"></a><span id="l70.98" class="difflineplus">+                    let channel = Services.io.newChannelFromURI2(savedthis.mUri,</span>
<a href="#l70.99"></a><span id="l70.99">                                                                  null,</span>
<a href="#l70.100"></a><span id="l70.100">                                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l70.101"></a><span id="l70.101">                                                                  null,</span>
<a href="#l70.102"></a><span id="l70.102">                                                                  Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l70.103"></a><span id="l70.103">                                                                  Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l70.104"></a><span id="l70.104"> </span>
<a href="#l70.105"></a><span id="l70.105">                     // Allow the hook to add things to the channel, like a</span>
<a href="#l70.106"></a><span id="l70.106">                     // header that checks etags</span>
<a href="#l70.107"></a><span id="l70.107" class="difflineminus">-                    var notChanged = savedthis.mHooks.onBeforePut(channel);</span>
<a href="#l70.108"></a><span id="l70.108" class="difflineplus">+                    let notChanged = savedthis.mHooks.onBeforePut(channel);</span>
<a href="#l70.109"></a><span id="l70.109">                     if (notChanged) {</span>
<a href="#l70.110"></a><span id="l70.110">                         channel.notificationCallbacks = savedthis;</span>
<a href="#l70.111"></a><span id="l70.111" class="difflineminus">-                        var uploadChannel = channel.QueryInterface(</span>
<a href="#l70.112"></a><span id="l70.112" class="difflineplus">+                        let uploadChannel = channel.QueryInterface(</span>
<a href="#l70.113"></a><span id="l70.113">                             Components.interfaces.nsIUploadChannel);</span>
<a href="#l70.114"></a><span id="l70.114"> </span>
<a href="#l70.115"></a><span id="l70.115">                         // Serialize</span>
<a href="#l70.116"></a><span id="l70.116" class="difflineminus">-                        var icsStream = this.serializer.serializeToInputStream();</span>
<a href="#l70.117"></a><span id="l70.117" class="difflineplus">+                        let icsStream = this.serializer.serializeToInputStream();</span>
<a href="#l70.118"></a><span id="l70.118"> </span>
<a href="#l70.119"></a><span id="l70.119">                         // Upload</span>
<a href="#l70.120"></a><span id="l70.120">                         uploadChannel.setUploadStream(icsStream,</span>
<a href="#l70.121"></a><span id="l70.121">                                                     &quot;text/calendar&quot;, -1);</span>
<a href="#l70.122"></a><span id="l70.122"> </span>
<a href="#l70.123"></a><span id="l70.123">                         Services.startup.enterLastWindowClosingSurvivalArea();</span>
<a href="#l70.124"></a><span id="l70.124">                         inLastWindowClosingSurvivalArea = true;</span>
<a href="#l70.125"></a><span id="l70.125">                         channel.asyncOpen(savedthis, savedthis);</span>
<a href="#l70.126"></a><span id="l70.126" class="difflineat">@@ -512,19 +512,19 @@ calICSCalendar.prototype = {</span>
<a href="#l70.127"></a><span id="l70.127">         modListener.prototype = {</span>
<a href="#l70.128"></a><span id="l70.128">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l70.129"></a><span id="l70.129">             onGetResult: function() {},</span>
<a href="#l70.130"></a><span id="l70.130">             onOperationComplete: function() {</span>
<a href="#l70.131"></a><span id="l70.131">                 this.mAction.opCompleteArgs = arguments;</span>
<a href="#l70.132"></a><span id="l70.132">             }</span>
<a href="#l70.133"></a><span id="l70.133">         };</span>
<a href="#l70.134"></a><span id="l70.134"> </span>
<a href="#l70.135"></a><span id="l70.135" class="difflineminus">-        var a;</span>
<a href="#l70.136"></a><span id="l70.136" class="difflineminus">-        var writeICS = false;</span>
<a href="#l70.137"></a><span id="l70.137" class="difflineminus">-        var refreshAction = null;</span>
<a href="#l70.138"></a><span id="l70.138" class="difflineplus">+        let a;</span>
<a href="#l70.139"></a><span id="l70.139" class="difflineplus">+        let writeICS = false;</span>
<a href="#l70.140"></a><span id="l70.140" class="difflineplus">+        let refreshAction = null;</span>
<a href="#l70.141"></a><span id="l70.141">         while ((a = this.queue.shift())) {</span>
<a href="#l70.142"></a><span id="l70.142">             switch (a.action) {</span>
<a href="#l70.143"></a><span id="l70.143">                 case 'add':</span>
<a href="#l70.144"></a><span id="l70.144">                     this.mMemoryCalendar.addItem(a.item, new modListener(a));</span>
<a href="#l70.145"></a><span id="l70.145">                     this.mModificationActions.push(a);</span>
<a href="#l70.146"></a><span id="l70.146">                     writeICS = true;</span>
<a href="#l70.147"></a><span id="l70.147">                     break;</span>
<a href="#l70.148"></a><span id="l70.148">                 case 'modify':</span>
<a href="#l70.149"></a><span id="l70.149" class="difflineat">@@ -638,17 +638,17 @@ calICSCalendar.prototype = {</span>
<a href="#l70.150"></a><span id="l70.150"> </span>
<a href="#l70.151"></a><span id="l70.151">         // This is a bit messy. createUnique creates an empty file,</span>
<a href="#l70.152"></a><span id="l70.152">         // but we don't use that file. All we want is a filename, to be used</span>
<a href="#l70.153"></a><span id="l70.153">         // in the call to copyTo later. So we create a file, get the filename,</span>
<a href="#l70.154"></a><span id="l70.154">         // and never use the file again, but write over it.</span>
<a href="#l70.155"></a><span id="l70.155">         // Using createUnique anyway, because I don't feel like</span>
<a href="#l70.156"></a><span id="l70.156">         // re-implementing it</span>
<a href="#l70.157"></a><span id="l70.157">         function makeDailyFileName() {</span>
<a href="#l70.158"></a><span id="l70.158" class="difflineminus">-            var dailyBackupFile = backupDir.clone();</span>
<a href="#l70.159"></a><span id="l70.159" class="difflineplus">+            let dailyBackupFile = backupDir.clone();</span>
<a href="#l70.160"></a><span id="l70.160">             dailyBackupFile.append(makeName('day'));</span>
<a href="#l70.161"></a><span id="l70.161">             dailyBackupFile.createUnique(CI.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l70.162"></a><span id="l70.162">                                          parseInt(&quot;0600&quot;, 8));</span>
<a href="#l70.163"></a><span id="l70.163">             dailyBackupFileName = dailyBackupFile.leafName;</span>
<a href="#l70.164"></a><span id="l70.164"> </span>
<a href="#l70.165"></a><span id="l70.165">             // Remove the reference to the nsIFile, because we need to</span>
<a href="#l70.166"></a><span id="l70.166">             // write over the file later, and you never know what happens</span>
<a href="#l70.167"></a><span id="l70.167">             // if something still has a reference.</span>
<a href="#l70.168"></a><span id="l70.168" class="difflineat">@@ -656,80 +656,79 @@ calICSCalendar.prototype = {</span>
<a href="#l70.169"></a><span id="l70.169">             // just the name.</span>
<a href="#l70.170"></a><span id="l70.170">             dailyBackupFile = null;</span>
<a href="#l70.171"></a><span id="l70.171"> </span>
<a href="#l70.172"></a><span id="l70.172">             return dailyBackupFileName;</span>
<a href="#l70.173"></a><span id="l70.173">         }</span>
<a href="#l70.174"></a><span id="l70.174"> </span>
<a href="#l70.175"></a><span id="l70.175">         function purgeBackupsByType(files, type) {</span>
<a href="#l70.176"></a><span id="l70.176">             // filter out backups of the type we care about.</span>
<a href="#l70.177"></a><span id="l70.177" class="difflineminus">-            var filteredFiles = files.filter(</span>
<a href="#l70.178"></a><span id="l70.178" class="difflineplus">+            let filteredFiles = files.filter(</span>
<a href="#l70.179"></a><span id="l70.179">                 v =&gt; v.name.includes(&quot;calBackupData_&quot; + pseudoID + &quot;_&quot; + type)</span>
<a href="#l70.180"></a><span id="l70.180">             );</span>
<a href="#l70.181"></a><span id="l70.181">             // Sort by lastmodifed</span>
<a href="#l70.182"></a><span id="l70.182">             filteredFiles.sort(</span>
<a href="#l70.183"></a><span id="l70.183">                 function s(a, b) {</span>
<a href="#l70.184"></a><span id="l70.184">                     return (a.lastmodified - b.lastmodified);</span>
<a href="#l70.185"></a><span id="l70.185">                 });</span>
<a href="#l70.186"></a><span id="l70.186">             // And delete the oldest files, and keep the desired number of</span>
<a href="#l70.187"></a><span id="l70.187">             // old backups</span>
<a href="#l70.188"></a><span id="l70.188" class="difflineminus">-            var i;</span>
<a href="#l70.189"></a><span id="l70.189" class="difflineminus">-            for (i = 0; i &lt; filteredFiles.length - numBackupFiles; ++i) {</span>
<a href="#l70.190"></a><span id="l70.190" class="difflineplus">+            for (let i = 0; i &lt; filteredFiles.length - numBackupFiles; ++i) {</span>
<a href="#l70.191"></a><span id="l70.191">                 let file = backupDir.clone();</span>
<a href="#l70.192"></a><span id="l70.192">                 file.append(filteredFiles[i].name);</span>
<a href="#l70.193"></a><span id="l70.193"> </span>
<a href="#l70.194"></a><span id="l70.194">                 try {</span>
<a href="#l70.195"></a><span id="l70.195">                     file.remove(false);</span>
<a href="#l70.196"></a><span id="l70.196">                 } catch (ex) {</span>
<a href="#l70.197"></a><span id="l70.197">                     // This can fail because of some crappy code in</span>
<a href="#l70.198"></a><span id="l70.198">                     // nsILocalFile.  That's not the end of the world.  We can</span>
<a href="#l70.199"></a><span id="l70.199">                     // try to remove the file the next time around.</span>
<a href="#l70.200"></a><span id="l70.200">                 }</span>
<a href="#l70.201"></a><span id="l70.201">             }</span>
<a href="#l70.202"></a><span id="l70.202">             return;</span>
<a href="#l70.203"></a><span id="l70.203">         }</span>
<a href="#l70.204"></a><span id="l70.204"> </span>
<a href="#l70.205"></a><span id="l70.205">         function purgeOldBackups() {</span>
<a href="#l70.206"></a><span id="l70.206">             // Enumerate files in the backupdir for expiry of old backups</span>
<a href="#l70.207"></a><span id="l70.207" class="difflineminus">-            var dirEnum = backupDir.directoryEntries;</span>
<a href="#l70.208"></a><span id="l70.208" class="difflineminus">-            var files = [];</span>
<a href="#l70.209"></a><span id="l70.209" class="difflineplus">+            let dirEnum = backupDir.directoryEntries;</span>
<a href="#l70.210"></a><span id="l70.210" class="difflineplus">+            let files = [];</span>
<a href="#l70.211"></a><span id="l70.211">             while (dirEnum.hasMoreElements()) {</span>
<a href="#l70.212"></a><span id="l70.212" class="difflineminus">-                var file = dirEnum.getNext().QueryInterface(CI.nsIFile);</span>
<a href="#l70.213"></a><span id="l70.213" class="difflineplus">+                let file = dirEnum.getNext().QueryInterface(CI.nsIFile);</span>
<a href="#l70.214"></a><span id="l70.214">                 if (file.isFile()) {</span>
<a href="#l70.215"></a><span id="l70.215">                     files.push({name: file.leafName, lastmodified: file.lastModifiedTime});</span>
<a href="#l70.216"></a><span id="l70.216">                 }</span>
<a href="#l70.217"></a><span id="l70.217">             }</span>
<a href="#l70.218"></a><span id="l70.218"> </span>
<a href="#l70.219"></a><span id="l70.219">             if (doDailyBackup) {</span>
<a href="#l70.220"></a><span id="l70.220">                 purgeBackupsByType(files, 'day');</span>
<a href="#l70.221"></a><span id="l70.221">             } else {</span>
<a href="#l70.222"></a><span id="l70.222">                 purgeBackupsByType(files, 'edit');</span>
<a href="#l70.223"></a><span id="l70.223">             }</span>
<a href="#l70.224"></a><span id="l70.224"> </span>
<a href="#l70.225"></a><span id="l70.225">             return;</span>
<a href="#l70.226"></a><span id="l70.226">         }</span>
<a href="#l70.227"></a><span id="l70.227"> </span>
<a href="#l70.228"></a><span id="l70.228">         function copyToOverwriting(oldFile, newParentDir, newName) {</span>
<a href="#l70.229"></a><span id="l70.229">             try {</span>
<a href="#l70.230"></a><span id="l70.230" class="difflineminus">-                var newFile = newParentDir.clone();</span>
<a href="#l70.231"></a><span id="l70.231" class="difflineplus">+                let newFile = newParentDir.clone();</span>
<a href="#l70.232"></a><span id="l70.232">                 newFile.append(newName);</span>
<a href="#l70.233"></a><span id="l70.233"> </span>
<a href="#l70.234"></a><span id="l70.234">                 if (newFile.exists()) {</span>
<a href="#l70.235"></a><span id="l70.235">                     newFile.remove(false);</span>
<a href="#l70.236"></a><span id="l70.236">                 }</span>
<a href="#l70.237"></a><span id="l70.237">                 oldFile.copyTo(newParentDir, newName);</span>
<a href="#l70.238"></a><span id="l70.238">             } catch (e) {</span>
<a href="#l70.239"></a><span id="l70.239">                 cal.ERROR(&quot;[calICSCalendar] Backup failed, no copy: &quot; + e);</span>
<a href="#l70.240"></a><span id="l70.240">                 // Error in making a daily/initial backup.</span>
<a href="#l70.241"></a><span id="l70.241">                 // not fatal, so just continue</span>
<a href="#l70.242"></a><span id="l70.242">             }</span>
<a href="#l70.243"></a><span id="l70.243">         }</span>
<a href="#l70.244"></a><span id="l70.244"> </span>
<a href="#l70.245"></a><span id="l70.245" class="difflineminus">-        var backupDays = Preferences.get(&quot;calendar.backup.days&quot;, 1);</span>
<a href="#l70.246"></a><span id="l70.246" class="difflineminus">-        var numBackupFiles = Preferences.get(&quot;calendar.backup.filenum&quot;, 3);</span>
<a href="#l70.247"></a><span id="l70.247" class="difflineplus">+        let backupDays = Preferences.get(&quot;calendar.backup.days&quot;, 1);</span>
<a href="#l70.248"></a><span id="l70.248" class="difflineplus">+        let numBackupFiles = Preferences.get(&quot;calendar.backup.filenum&quot;, 3);</span>
<a href="#l70.249"></a><span id="l70.249"> </span>
<a href="#l70.250"></a><span id="l70.250">         let backupDir;</span>
<a href="#l70.251"></a><span id="l70.251">         try {</span>
<a href="#l70.252"></a><span id="l70.252">             backupDir = cal.getCalendarDirectory();</span>
<a href="#l70.253"></a><span id="l70.253">             backupDir.append(&quot;backup&quot;);</span>
<a href="#l70.254"></a><span id="l70.254">             if (!backupDir.exists()) {</span>
<a href="#l70.255"></a><span id="l70.255">                 backupDir.create(CI.nsIFile.DIRECTORY_TYPE, parseInt(&quot;0755&quot;, 8));</span>
<a href="#l70.256"></a><span id="l70.256">             }</span>
<a href="#l70.257"></a><span id="l70.257" class="difflineat">@@ -751,58 +750,58 @@ calICSCalendar.prototype = {</span>
<a href="#l70.258"></a><span id="l70.258">         } catch (e) {</span>
<a href="#l70.259"></a><span id="l70.259">             // calendarmgr not found. Likely because we are running in</span>
<a href="#l70.260"></a><span id="l70.260">             // xpcshell. Don't die, but continue the upload.</span>
<a href="#l70.261"></a><span id="l70.261">             cal.ERROR(&quot;[calICSCalendar] Backup failed, no calendarmanager:&quot; + e);</span>
<a href="#l70.262"></a><span id="l70.262">             aCallback.call(this);</span>
<a href="#l70.263"></a><span id="l70.263">             return;</span>
<a href="#l70.264"></a><span id="l70.264">         }</span>
<a href="#l70.265"></a><span id="l70.265"> </span>
<a href="#l70.266"></a><span id="l70.266" class="difflineminus">-        var doInitialBackup = false;</span>
<a href="#l70.267"></a><span id="l70.267" class="difflineminus">-        var initialBackupFile = backupDir.clone();</span>
<a href="#l70.268"></a><span id="l70.268" class="difflineplus">+        let doInitialBackup = false;</span>
<a href="#l70.269"></a><span id="l70.269" class="difflineplus">+        let initialBackupFile = backupDir.clone();</span>
<a href="#l70.270"></a><span id="l70.270">         initialBackupFile.append(makeName('initial'));</span>
<a href="#l70.271"></a><span id="l70.271">         if (!initialBackupFile.exists()) {</span>
<a href="#l70.272"></a><span id="l70.272">             doInitialBackup = true;</span>
<a href="#l70.273"></a><span id="l70.273">         }</span>
<a href="#l70.274"></a><span id="l70.274"> </span>
<a href="#l70.275"></a><span id="l70.275" class="difflineminus">-        var doDailyBackup = false;</span>
<a href="#l70.276"></a><span id="l70.276" class="difflineminus">-        var backupTime = this.getProperty('backup-time2');</span>
<a href="#l70.277"></a><span id="l70.277" class="difflineplus">+        let doDailyBackup = false;</span>
<a href="#l70.278"></a><span id="l70.278" class="difflineplus">+        let backupTime = this.getProperty('backup-time2');</span>
<a href="#l70.279"></a><span id="l70.279">         if (!backupTime ||</span>
<a href="#l70.280"></a><span id="l70.280">             (new Date().getTime() &gt; backupTime + backupDays * 24 * 60 * 60 * 1000)) {</span>
<a href="#l70.281"></a><span id="l70.281">             // It's time do to a daily backup</span>
<a href="#l70.282"></a><span id="l70.282">             doDailyBackup = true;</span>
<a href="#l70.283"></a><span id="l70.283">             this.setProperty('backup-time2', new Date().getTime());</span>
<a href="#l70.284"></a><span id="l70.284">         }</span>
<a href="#l70.285"></a><span id="l70.285"> </span>
<a href="#l70.286"></a><span id="l70.286" class="difflineminus">-        var dailyBackupFileName;</span>
<a href="#l70.287"></a><span id="l70.287" class="difflineplus">+        let dailyBackupFileName;</span>
<a href="#l70.288"></a><span id="l70.288">         if (doDailyBackup) {</span>
<a href="#l70.289"></a><span id="l70.289">             dailyBackupFileName = makeDailyFileName(backupDir);</span>
<a href="#l70.290"></a><span id="l70.290">         }</span>
<a href="#l70.291"></a><span id="l70.291"> </span>
<a href="#l70.292"></a><span id="l70.292" class="difflineminus">-        var backupFile = backupDir.clone();</span>
<a href="#l70.293"></a><span id="l70.293" class="difflineplus">+        let backupFile = backupDir.clone();</span>
<a href="#l70.294"></a><span id="l70.294">         backupFile.append(makeName('edit'));</span>
<a href="#l70.295"></a><span id="l70.295">         backupFile.createUnique(CI.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0600&quot;, 8));</span>
<a href="#l70.296"></a><span id="l70.296"> </span>
<a href="#l70.297"></a><span id="l70.297">         purgeOldBackups();</span>
<a href="#l70.298"></a><span id="l70.298"> </span>
<a href="#l70.299"></a><span id="l70.299">         // Now go download the remote file, and store it somewhere local.</span>
<a href="#l70.300"></a><span id="l70.300" class="difflineminus">-        var channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l70.301"></a><span id="l70.301" class="difflineplus">+        let channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l70.302"></a><span id="l70.302">                                                      null,</span>
<a href="#l70.303"></a><span id="l70.303">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l70.304"></a><span id="l70.304">                                                      null,</span>
<a href="#l70.305"></a><span id="l70.305">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l70.306"></a><span id="l70.306">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l70.307"></a><span id="l70.307">         channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l70.308"></a><span id="l70.308">         channel.notificationCallbacks = this;</span>
<a href="#l70.309"></a><span id="l70.309"> </span>
<a href="#l70.310"></a><span id="l70.310" class="difflineminus">-        var downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l70.311"></a><span id="l70.311" class="difflineplus">+        let downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l70.312"></a><span id="l70.312">                                    .createInstance(CI.nsIDownloader);</span>
<a href="#l70.313"></a><span id="l70.313"> </span>
<a href="#l70.314"></a><span id="l70.314" class="difflineminus">-        var savedthis = this;</span>
<a href="#l70.315"></a><span id="l70.315" class="difflineminus">-        var listener = {</span>
<a href="#l70.316"></a><span id="l70.316" class="difflineplus">+        let savedthis = this;</span>
<a href="#l70.317"></a><span id="l70.317" class="difflineplus">+        let listener = {</span>
<a href="#l70.318"></a><span id="l70.318">             onDownloadComplete: function(opdownloader, request, ctxt, status, result) {</span>
<a href="#l70.319"></a><span id="l70.319">                 if (doInitialBackup) {</span>
<a href="#l70.320"></a><span id="l70.320">                     copyToOverwriting(result, backupDir, makeName('initial'));</span>
<a href="#l70.321"></a><span id="l70.321">                 }</span>
<a href="#l70.322"></a><span id="l70.322">                 if (doDailyBackup) {</span>
<a href="#l70.323"></a><span id="l70.323">                     copyToOverwriting(result, backupDir, dailyBackupFileName);</span>
<a href="#l70.324"></a><span id="l70.324">                 }</span>
<a href="#l70.325"></a><span id="l70.325"> </span>
<a href="#l70.326"></a><span id="l70.326" class="difflineat">@@ -911,17 +910,17 @@ dummyHooks.prototype = {</span>
<a href="#l70.327"></a><span id="l70.327"> };</span>
<a href="#l70.328"></a><span id="l70.328"> </span>
<a href="#l70.329"></a><span id="l70.329"> function httpHooks(calendar) {</span>
<a href="#l70.330"></a><span id="l70.330">     this.mCalendar = calendar;</span>
<a href="#l70.331"></a><span id="l70.331"> }</span>
<a href="#l70.332"></a><span id="l70.332"> </span>
<a href="#l70.333"></a><span id="l70.333"> httpHooks.prototype = {</span>
<a href="#l70.334"></a><span id="l70.334">     onBeforeGet: function(aChannel, aForceRefresh) {</span>
<a href="#l70.335"></a><span id="l70.335" class="difflineminus">-        var httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.336"></a><span id="l70.336" class="difflineplus">+        let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.337"></a><span id="l70.337">         httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/calendar,text/plain;q=0.8,*/*;q=0.5&quot;, false);</span>
<a href="#l70.338"></a><span id="l70.338"> </span>
<a href="#l70.339"></a><span id="l70.339">         if (this.mEtag &amp;&amp; !aForceRefresh) {</span>
<a href="#l70.340"></a><span id="l70.340">             // Somehow the webdav header 'If' doesn't work on apache when</span>
<a href="#l70.341"></a><span id="l70.341">             // passing in a Not, so use the http version here.</span>
<a href="#l70.342"></a><span id="l70.342">             httpchannel.setRequestHeader(&quot;If-None-Match&quot;, this.mEtag, false);</span>
<a href="#l70.343"></a><span id="l70.343">         } else if (!aForceRefresh &amp;&amp; this.mLastModified) {</span>
<a href="#l70.344"></a><span id="l70.344">             // Only send 'If-Modified-Since' if no ETag is available</span>
<a href="#l70.345"></a><span id="l70.345" class="difflineat">@@ -981,44 +980,44 @@ httpHooks.prototype = {</span>
<a href="#l70.346"></a><span id="l70.346">             this.mLastModified = null;</span>
<a href="#l70.347"></a><span id="l70.347">         }</span>
<a href="#l70.348"></a><span id="l70.348"> </span>
<a href="#l70.349"></a><span id="l70.349">         return true;</span>
<a href="#l70.350"></a><span id="l70.350">     },</span>
<a href="#l70.351"></a><span id="l70.351"> </span>
<a href="#l70.352"></a><span id="l70.352">     onBeforePut: function(aChannel) {</span>
<a href="#l70.353"></a><span id="l70.353">         if (this.mEtag) {</span>
<a href="#l70.354"></a><span id="l70.354" class="difflineminus">-            var httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.355"></a><span id="l70.355" class="difflineplus">+            let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.356"></a><span id="l70.356"> </span>
<a href="#l70.357"></a><span id="l70.357">             // Apache doesn't work correctly with if-match on a PUT method,</span>
<a href="#l70.358"></a><span id="l70.358">             // so use the webdav header</span>
<a href="#l70.359"></a><span id="l70.359">             httpchannel.setRequestHeader(&quot;If&quot;, '([' + this.mEtag + '])', false);</span>
<a href="#l70.360"></a><span id="l70.360">         }</span>
<a href="#l70.361"></a><span id="l70.361">         return true;</span>
<a href="#l70.362"></a><span id="l70.362">     },</span>
<a href="#l70.363"></a><span id="l70.363"> </span>
<a href="#l70.364"></a><span id="l70.364">     onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l70.365"></a><span id="l70.365" class="difflineminus">-        var httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.366"></a><span id="l70.366" class="difflineplus">+        let httpchannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l70.367"></a><span id="l70.367">         try {</span>
<a href="#l70.368"></a><span id="l70.368">             this.mEtag = httpchannel.getResponseHeader(&quot;ETag&quot;);</span>
<a href="#l70.369"></a><span id="l70.369">             aRespFunc();</span>
<a href="#l70.370"></a><span id="l70.370">         } catch (e) {</span>
<a href="#l70.371"></a><span id="l70.371">             // There was no ETag header on the response. This means that</span>
<a href="#l70.372"></a><span id="l70.372">             // putting is not atomic. This is bad. Race conditions can happen,</span>
<a href="#l70.373"></a><span id="l70.373">             // because there is a time in which we don't know the right</span>
<a href="#l70.374"></a><span id="l70.374">             // etag.</span>
<a href="#l70.375"></a><span id="l70.375">             // Try to do the best we can, by immediatly getting the etag.</span>
<a href="#l70.376"></a><span id="l70.376"> </span>
<a href="#l70.377"></a><span id="l70.377" class="difflineminus">-            var etagListener = {};</span>
<a href="#l70.378"></a><span id="l70.378" class="difflineminus">-            var thisHook = this; // need to reference in callback</span>
<a href="#l70.379"></a><span id="l70.379" class="difflineplus">+            let etagListener = {};</span>
<a href="#l70.380"></a><span id="l70.380" class="difflineplus">+            let thisHook = this; // need to reference in callback</span>
<a href="#l70.381"></a><span id="l70.381"> </span>
<a href="#l70.382"></a><span id="l70.382">             etagListener.onStreamComplete =</span>
<a href="#l70.383"></a><span id="l70.383">                 function ics_etLoSC(aLoader, aContext, aStatus, aResultLength,</span>
<a href="#l70.384"></a><span id="l70.384">                                     aResult) {</span>
<a href="#l70.385"></a><span id="l70.385" class="difflineminus">-                var resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l70.386"></a><span id="l70.386" class="difflineplus">+                let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l70.387"></a><span id="l70.387">                                                 .createInstance(Components</span>
<a href="#l70.388"></a><span id="l70.388">                                                 .interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l70.389"></a><span id="l70.389">                 resultConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l70.390"></a><span id="l70.390"> </span>
<a href="#l70.391"></a><span id="l70.391">                 let multistatus;</span>
<a href="#l70.392"></a><span id="l70.392">                 try {</span>
<a href="#l70.393"></a><span id="l70.393">                     let str = resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l70.394"></a><span id="l70.394">                     multistatus = cal.xml.parseString(str);</span>
<a href="#l70.395"></a><span id="l70.395" class="difflineat">@@ -1036,17 +1035,17 @@ httpHooks.prototype = {</span>
<a href="#l70.396"></a><span id="l70.396">                   '&lt;/D:prop&gt;' +</span>
<a href="#l70.397"></a><span id="l70.397">                 '&lt;/D:propfind&gt;';</span>
<a href="#l70.398"></a><span id="l70.398"> </span>
<a href="#l70.399"></a><span id="l70.399">             let etagChannel = cal.prepHttpChannel(aChannel.URI, queryXml,</span>
<a href="#l70.400"></a><span id="l70.400">                                                   &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l70.401"></a><span id="l70.401">                                                   this);</span>
<a href="#l70.402"></a><span id="l70.402">             etagChannel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l70.403"></a><span id="l70.403">             etagChannel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l70.404"></a><span id="l70.404" class="difflineminus">-            var streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l70.405"></a><span id="l70.405" class="difflineplus">+            let streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l70.406"></a><span id="l70.406">                                          .createInstance(Components.interfaces</span>
<a href="#l70.407"></a><span id="l70.407">                                          .nsIStreamLoader);</span>
<a href="#l70.408"></a><span id="l70.408"> </span>
<a href="#l70.409"></a><span id="l70.409">             cal.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l70.410"></a><span id="l70.410">         }</span>
<a href="#l70.411"></a><span id="l70.411">         return true;</span>
<a href="#l70.412"></a><span id="l70.412">     },</span>
<a href="#l70.413"></a><span id="l70.413"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -102,17 +102,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l71.4"></a><span id="l71.4">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l71.5"></a><span id="l71.5">     },</span>
<a href="#l71.6"></a><span id="l71.6"> </span>
<a href="#l71.7"></a><span id="l71.7">     // readonly attribute AUTF8String type;</span>
<a href="#l71.8"></a><span id="l71.8">     get type() { return &quot;memory&quot;; },</span>
<a href="#l71.9"></a><span id="l71.9"> </span>
<a href="#l71.10"></a><span id="l71.10">     // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l71.11"></a><span id="l71.11">     addItem: function(aItem, aListener) {</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-        var newItem = aItem.clone();</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+        let newItem = aItem.clone();</span>
<a href="#l71.14"></a><span id="l71.14">         return this.adoptItem(newItem, aListener);</span>
<a href="#l71.15"></a><span id="l71.15">     },</span>
<a href="#l71.16"></a><span id="l71.16"> </span>
<a href="#l71.17"></a><span id="l71.17">     // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l71.18"></a><span id="l71.18">     adoptItem: function(aItem, aListener) {</span>
<a href="#l71.19"></a><span id="l71.19">         if (this.readOnly) {</span>
<a href="#l71.20"></a><span id="l71.20">             throw Components.interfaces.calIErrors.CAL_IS_READONLY;</span>
<a href="#l71.21"></a><span id="l71.21">         }</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineat">@@ -173,32 +173,32 @@ calMemoryCalendar.prototype = {</span>
<a href="#l71.23"></a><span id="l71.23">     modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l71.24"></a><span id="l71.24">         if (this.readOnly) {</span>
<a href="#l71.25"></a><span id="l71.25">             throw Components.interfaces.calIErrors.CAL_IS_READONLY;</span>
<a href="#l71.26"></a><span id="l71.26">         }</span>
<a href="#l71.27"></a><span id="l71.27">         if (!aNewItem) {</span>
<a href="#l71.28"></a><span id="l71.28">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l71.29"></a><span id="l71.29">         }</span>
<a href="#l71.30"></a><span id="l71.30"> </span>
<a href="#l71.31"></a><span id="l71.31" class="difflineminus">-        var this_ = this;</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+        let this_ = this;</span>
<a href="#l71.33"></a><span id="l71.33">         function reportError(errStr, errId) {</span>
<a href="#l71.34"></a><span id="l71.34">             this_.notifyOperationComplete(aListener,</span>
<a href="#l71.35"></a><span id="l71.35">                                           errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l71.36"></a><span id="l71.36">                                           Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l71.37"></a><span id="l71.37">                                           aNewItem.id,</span>
<a href="#l71.38"></a><span id="l71.38">                                           errStr);</span>
<a href="#l71.39"></a><span id="l71.39">             return null;</span>
<a href="#l71.40"></a><span id="l71.40">         }</span>
<a href="#l71.41"></a><span id="l71.41"> </span>
<a href="#l71.42"></a><span id="l71.42">         if (!aNewItem.id) {</span>
<a href="#l71.43"></a><span id="l71.43">             // this is definitely an error</span>
<a href="#l71.44"></a><span id="l71.44">             return reportError(null, &quot;ID for modifyItem item is null&quot;);</span>
<a href="#l71.45"></a><span id="l71.45">         }</span>
<a href="#l71.46"></a><span id="l71.46"> </span>
<a href="#l71.47"></a><span id="l71.47" class="difflineminus">-        var modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+        let modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l71.49"></a><span id="l71.49">         if (aNewItem.parentItem != aNewItem) {</span>
<a href="#l71.50"></a><span id="l71.50">             modifiedItem.recurrenceInfo.modifyException(aNewItem, false);</span>
<a href="#l71.51"></a><span id="l71.51">         }</span>
<a href="#l71.52"></a><span id="l71.52"> </span>
<a href="#l71.53"></a><span id="l71.53">         // If no old item was passed, then we should overwrite in any case.</span>
<a href="#l71.54"></a><span id="l71.54">         // Pick up the old item from our items array and use this as an old item</span>
<a href="#l71.55"></a><span id="l71.55">         // later on.</span>
<a href="#l71.56"></a><span id="l71.56">         if (!aOldItem) {</span>
<a href="#l71.57"></a><span id="l71.57" class="difflineat">@@ -219,17 +219,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l71.58"></a><span id="l71.58">             }</span>
<a href="#l71.59"></a><span id="l71.59"> </span>
<a href="#l71.60"></a><span id="l71.60">             // do the old and new items match?</span>
<a href="#l71.61"></a><span id="l71.61">             if (aOldItem.id != modifiedItem.id) {</span>
<a href="#l71.62"></a><span id="l71.62">                 return reportError(&quot;item ID mismatch between old and new items&quot;);</span>
<a href="#l71.63"></a><span id="l71.63">             }</span>
<a href="#l71.64"></a><span id="l71.64"> </span>
<a href="#l71.65"></a><span id="l71.65">             aOldItem = aOldItem.parentItem;</span>
<a href="#l71.66"></a><span id="l71.66" class="difflineminus">-            var storedOldItem = this.mItems[aOldItem.id];</span>
<a href="#l71.67"></a><span id="l71.67" class="difflineplus">+            let storedOldItem = this.mItems[aOldItem.id];</span>
<a href="#l71.68"></a><span id="l71.68"> </span>
<a href="#l71.69"></a><span id="l71.69">             // compareItems is not suitable here. See bug 418805.</span>
<a href="#l71.70"></a><span id="l71.70">             // Cannot compare here due to bug 380060</span>
<a href="#l71.71"></a><span id="l71.71">             if (!cal.compareItemContent(storedOldItem, aOldItem)) {</span>
<a href="#l71.72"></a><span id="l71.72">                 return reportError(&quot;old item mismatch in modifyItem&quot; + &quot; storedId:&quot; + storedOldItem.icalComponent + &quot; old item:&quot; + aOldItem.icalComponent);</span>
<a href="#l71.73"></a><span id="l71.73">             }</span>
<a href="#l71.74"></a><span id="l71.74">            // offline bug</span>
<a href="#l71.75"></a><span id="l71.75"> </span>
<a href="#l71.76"></a><span id="l71.76" class="difflineat">@@ -272,17 +272,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l71.77"></a><span id="l71.77">             this.notifyOperationComplete(aListener,</span>
<a href="#l71.78"></a><span id="l71.78">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l71.79"></a><span id="l71.79">                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l71.80"></a><span id="l71.80">                                          aItem.id,</span>
<a href="#l71.81"></a><span id="l71.81">                                          &quot;ID is null in deleteItem&quot;);</span>
<a href="#l71.82"></a><span id="l71.82">             return;</span>
<a href="#l71.83"></a><span id="l71.83">         }</span>
<a href="#l71.84"></a><span id="l71.84"> </span>
<a href="#l71.85"></a><span id="l71.85" class="difflineminus">-        var oldItem;</span>
<a href="#l71.86"></a><span id="l71.86" class="difflineplus">+        let oldItem;</span>
<a href="#l71.87"></a><span id="l71.87">         if (this.relaxedMode) {</span>
<a href="#l71.88"></a><span id="l71.88">             oldItem = aItem;</span>
<a href="#l71.89"></a><span id="l71.89">         } else {</span>
<a href="#l71.90"></a><span id="l71.90">             oldItem = this.mItems[aItem.id];</span>
<a href="#l71.91"></a><span id="l71.91">             if (oldItem.generation != aItem.generation) {</span>
<a href="#l71.92"></a><span id="l71.92">                 this.notifyOperationComplete(aListener,</span>
<a href="#l71.93"></a><span id="l71.93">                                              Components.results.NS_ERROR_FAILURE,</span>
<a href="#l71.94"></a><span id="l71.94">                                              Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l71.95"></a><span id="l71.95" class="difflineat">@@ -316,18 +316,18 @@ calMemoryCalendar.prototype = {</span>
<a href="#l71.96"></a><span id="l71.96">             this.notifyOperationComplete(aListener,</span>
<a href="#l71.97"></a><span id="l71.97">                                          Components.results.NS_OK,</span>
<a href="#l71.98"></a><span id="l71.98">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l71.99"></a><span id="l71.99">                                          aId,</span>
<a href="#l71.100"></a><span id="l71.100">                                          null);</span>
<a href="#l71.101"></a><span id="l71.101">             return;</span>
<a href="#l71.102"></a><span id="l71.102">         }</span>
<a href="#l71.103"></a><span id="l71.103"> </span>
<a href="#l71.104"></a><span id="l71.104" class="difflineminus">-        var item = this.mItems[aId];</span>
<a href="#l71.105"></a><span id="l71.105" class="difflineminus">-        var iid = null;</span>
<a href="#l71.106"></a><span id="l71.106" class="difflineplus">+        let item = this.mItems[aId];</span>
<a href="#l71.107"></a><span id="l71.107" class="difflineplus">+        let iid = null;</span>
<a href="#l71.108"></a><span id="l71.108"> </span>
<a href="#l71.109"></a><span id="l71.109">         if (cal.isEvent(item)) {</span>
<a href="#l71.110"></a><span id="l71.110">             iid = Components.interfaces.calIEvent;</span>
<a href="#l71.111"></a><span id="l71.111">         } else if (cal.isToDo(item)) {</span>
<a href="#l71.112"></a><span id="l71.112">             iid = Components.interfaces.calITodo;</span>
<a href="#l71.113"></a><span id="l71.113">         } else {</span>
<a href="#l71.114"></a><span id="l71.114">             this.notifyOperationComplete(aListener,</span>
<a href="#l71.115"></a><span id="l71.115">                                          Components.results.NS_ERROR_FAILURE,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -421,17 +421,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.4"></a><span id="l72.4">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l72.5"></a><span id="l72.5">             return;</span>
<a href="#l72.6"></a><span id="l72.6">         }</span>
<a href="#l72.7"></a><span id="l72.7"> </span>
<a href="#l72.8"></a><span id="l72.8">         if (aItem.id == null) {</span>
<a href="#l72.9"></a><span id="l72.9">             // is this an error?  Or should we generate an IID?</span>
<a href="#l72.10"></a><span id="l72.10">             aItem.id = cal.getUUID();</span>
<a href="#l72.11"></a><span id="l72.11">         } else {</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-            var olditem = this.getItemById(aItem.id);</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+            let olditem = this.getItemById(aItem.id);</span>
<a href="#l72.14"></a><span id="l72.14">             if (olditem) {</span>
<a href="#l72.15"></a><span id="l72.15">                 if (this.relaxedMode) {</span>
<a href="#l72.16"></a><span id="l72.16">                     // we possibly want to interact with the user before deleting</span>
<a href="#l72.17"></a><span id="l72.17">                     this.deleteItemById(aItem.id, true);</span>
<a href="#l72.18"></a><span id="l72.18">                 } else {</span>
<a href="#l72.19"></a><span id="l72.19">                     this.notifyOperationComplete(aListener,</span>
<a href="#l72.20"></a><span id="l72.20">                                                  Components.interfaces.calIErrors.DUPLICATE_ID,</span>
<a href="#l72.21"></a><span id="l72.21">                                                  Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineat">@@ -534,17 +534,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.23"></a><span id="l72.23">         if (this.relaxedMode) {</span>
<a href="#l72.24"></a><span id="l72.24">             // We've already filled in the old item above, if this doesn't exist</span>
<a href="#l72.25"></a><span id="l72.25">             // then just take the current item as its old version</span>
<a href="#l72.26"></a><span id="l72.26">             if (!aOldItem) {</span>
<a href="#l72.27"></a><span id="l72.27">                 aOldItem = aNewItem;</span>
<a href="#l72.28"></a><span id="l72.28">             }</span>
<a href="#l72.29"></a><span id="l72.29">             aOldItem = aOldItem.parentItem;</span>
<a href="#l72.30"></a><span id="l72.30">         } else {</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineminus">-            var storedOldItem = (aOldItem ? this.getItemById(aOldItem.id) : null);</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineplus">+            let storedOldItem = (aOldItem ? this.getItemById(aOldItem.id) : null);</span>
<a href="#l72.33"></a><span id="l72.33">             if (!aOldItem || !storedOldItem) {</span>
<a href="#l72.34"></a><span id="l72.34">                 // no old item found?  should be using addItem, then.</span>
<a href="#l72.35"></a><span id="l72.35">                 return reportError(&quot;ID does not already exist for modifyItem&quot;);</span>
<a href="#l72.36"></a><span id="l72.36">             }</span>
<a href="#l72.37"></a><span id="l72.37">             aOldItem = aOldItem.parentItem;</span>
<a href="#l72.38"></a><span id="l72.38"> </span>
<a href="#l72.39"></a><span id="l72.39">             if (aOldItem.generation != storedOldItem.generation) {</span>
<a href="#l72.40"></a><span id="l72.40">                 return reportError(&quot;generation too old for for modifyItem&quot;);</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineat">@@ -614,28 +614,28 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.42"></a><span id="l72.42">     },</span>
<a href="#l72.43"></a><span id="l72.43"> </span>
<a href="#l72.44"></a><span id="l72.44">     // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l72.45"></a><span id="l72.45">     getItem: function cSC_getItem(aId, aListener) {</span>
<a href="#l72.46"></a><span id="l72.46">         if (!aListener) {</span>
<a href="#l72.47"></a><span id="l72.47">             return;</span>
<a href="#l72.48"></a><span id="l72.48">         }</span>
<a href="#l72.49"></a><span id="l72.49"> </span>
<a href="#l72.50"></a><span id="l72.50" class="difflineminus">-        var item = this.getItemById(aId);</span>
<a href="#l72.51"></a><span id="l72.51" class="difflineplus">+        let item = this.getItemById(aId);</span>
<a href="#l72.52"></a><span id="l72.52">         if (!item) {</span>
<a href="#l72.53"></a><span id="l72.53">             // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l72.54"></a><span id="l72.54">             this.notifyOperationComplete(aListener,</span>
<a href="#l72.55"></a><span id="l72.55">                                          Components.results.NS_OK,</span>
<a href="#l72.56"></a><span id="l72.56">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l72.57"></a><span id="l72.57">                                          aId,</span>
<a href="#l72.58"></a><span id="l72.58">                                          null);</span>
<a href="#l72.59"></a><span id="l72.59">             return;</span>
<a href="#l72.60"></a><span id="l72.60">         }</span>
<a href="#l72.61"></a><span id="l72.61"> </span>
<a href="#l72.62"></a><span id="l72.62" class="difflineminus">-        var item_iid = null;</span>
<a href="#l72.63"></a><span id="l72.63" class="difflineplus">+        let item_iid = null;</span>
<a href="#l72.64"></a><span id="l72.64">         if (cal.isEvent(item)) {</span>
<a href="#l72.65"></a><span id="l72.65">             item_iid = Components.interfaces.calIEvent;</span>
<a href="#l72.66"></a><span id="l72.66">         } else if (cal.isToDo(item)) {</span>
<a href="#l72.67"></a><span id="l72.67">             item_iid = Components.interfaces.calITodo;</span>
<a href="#l72.68"></a><span id="l72.68">         } else {</span>
<a href="#l72.69"></a><span id="l72.69">             this.notifyOperationComplete(aListener,</span>
<a href="#l72.70"></a><span id="l72.70">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l72.71"></a><span id="l72.71">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l72.72"></a><span id="l72.72" class="difflineat">@@ -1046,17 +1046,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.73"></a><span id="l72.73">     deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l72.74"></a><span id="l72.74">         let this_ = this;</span>
<a href="#l72.75"></a><span id="l72.75">         let opListener = {</span>
<a href="#l72.76"></a><span id="l72.76">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l72.77"></a><span id="l72.77">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l72.78"></a><span id="l72.78"> </span>
<a href="#l72.79"></a><span id="l72.79">             },</span>
<a href="#l72.80"></a><span id="l72.80">             onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l72.81"></a><span id="l72.81" class="difflineminus">-                var newOfflineJournalFlag = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l72.82"></a><span id="l72.82" class="difflineplus">+                let newOfflineJournalFlag = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l72.83"></a><span id="l72.83">                 if (oldOfflineJournalFlag) {</span>
<a href="#l72.84"></a><span id="l72.84">                     // Delete item if flag is c</span>
<a href="#l72.85"></a><span id="l72.85">                     if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l72.86"></a><span id="l72.86">                         this_.deleteItemById(aItem.id);</span>
<a href="#l72.87"></a><span id="l72.87">                     } else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l72.88"></a><span id="l72.88">                         this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l72.89"></a><span id="l72.89">                     }</span>
<a href="#l72.90"></a><span id="l72.90">                 } else {</span>
<a href="#l72.91"></a><span id="l72.91" class="difflineat">@@ -1113,20 +1113,20 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.92"></a><span id="l72.92">             //   WHERE  ((event_end &gt; :range_start OR</span>
<a href="#l72.93"></a><span id="l72.93">             //           (event_end = :range_start AND</span>
<a href="#l72.94"></a><span id="l72.94">             //           event_start = :range_start))</span>
<a href="#l72.95"></a><span id="l72.95">             //          AND event_start &lt; :range_end)</span>
<a href="#l72.96"></a><span id="l72.96">             //</span>
<a href="#l72.97"></a><span id="l72.97">             // but that doesn't work with floating start or end times. The logic</span>
<a href="#l72.98"></a><span id="l72.98">             // is the same though.</span>
<a href="#l72.99"></a><span id="l72.99">             // For readability, a few helpers:</span>
<a href="#l72.100"></a><span id="l72.100" class="difflineminus">-            var floatingEventStart = &quot;event_start_tz = 'floating' AND event_start&quot;;</span>
<a href="#l72.101"></a><span id="l72.101" class="difflineminus">-            var nonFloatingEventStart = &quot;event_start_tz != 'floating' AND event_start&quot;;</span>
<a href="#l72.102"></a><span id="l72.102" class="difflineminus">-            var floatingEventEnd = &quot;event_end_tz = 'floating' AND event_end&quot;;</span>
<a href="#l72.103"></a><span id="l72.103" class="difflineminus">-            var nonFloatingEventEnd = &quot;event_end_tz != 'floating' AND event_end&quot;;</span>
<a href="#l72.104"></a><span id="l72.104" class="difflineplus">+            let floatingEventStart = &quot;event_start_tz = 'floating' AND event_start&quot;;</span>
<a href="#l72.105"></a><span id="l72.105" class="difflineplus">+            let nonFloatingEventStart = &quot;event_start_tz != 'floating' AND event_start&quot;;</span>
<a href="#l72.106"></a><span id="l72.106" class="difflineplus">+            let floatingEventEnd = &quot;event_end_tz = 'floating' AND event_end&quot;;</span>
<a href="#l72.107"></a><span id="l72.107" class="difflineplus">+            let nonFloatingEventEnd = &quot;event_end_tz != 'floating' AND event_end&quot;;</span>
<a href="#l72.108"></a><span id="l72.108">             // The query needs to take both floating and non floating into account</span>
<a href="#l72.109"></a><span id="l72.109">             this.mSelectNonRecurringEventsByRange = this.mDB.createStatement(</span>
<a href="#l72.110"></a><span id="l72.110">                 &quot;SELECT * FROM cal_events &quot; +</span>
<a href="#l72.111"></a><span id="l72.111">                 &quot;WHERE &quot; +</span>
<a href="#l72.112"></a><span id="l72.112">                 &quot; ((&quot; + floatingEventEnd + &quot; &gt; :range_start + :start_offset) OR &quot; +</span>
<a href="#l72.113"></a><span id="l72.113">                 &quot;  (&quot; + nonFloatingEventEnd + &quot; &gt; :range_start) OR &quot; +</span>
<a href="#l72.114"></a><span id="l72.114">                 &quot;  (((&quot; + floatingEventEnd + &quot; = :range_start + :start_offset) OR &quot; +</span>
<a href="#l72.115"></a><span id="l72.115">                 &quot;    (&quot; + nonFloatingEventEnd + &quot; = :range_start)) AND &quot; +</span>
<a href="#l72.116"></a><span id="l72.116" class="difflineat">@@ -1143,22 +1143,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.117"></a><span id="l72.117">                 );</span>
<a href="#l72.118"></a><span id="l72.118"> </span>
<a href="#l72.119"></a><span id="l72.119">             //</span>
<a href="#l72.120"></a><span id="l72.120">             // WHERE (due &gt; rangeStart  AND  (entry IS NULL  OR  entry &lt; rangeEnd)) OR</span>
<a href="#l72.121"></a><span id="l72.121">             //       (due = rangeStart  AND  (entry IS NULL  OR  entry = rangeStart)) OR</span>
<a href="#l72.122"></a><span id="l72.122">             //       (due IS NULL  AND  (entry &gt;= rangeStart  AND  entry &lt; rangeEnd)) OR</span>
<a href="#l72.123"></a><span id="l72.123">             //       (entry IS NULL  AND  (completed &gt; rangeStart  OR  completed IS NULL))</span>
<a href="#l72.124"></a><span id="l72.124">             //</span>
<a href="#l72.125"></a><span id="l72.125" class="difflineminus">-            var floatingTodoEntry = &quot;todo_entry_tz = 'floating' AND todo_entry&quot;;</span>
<a href="#l72.126"></a><span id="l72.126" class="difflineminus">-            var nonFloatingTodoEntry = &quot;todo_entry_tz != 'floating' AND todo_entry&quot;;</span>
<a href="#l72.127"></a><span id="l72.127" class="difflineminus">-            var floatingTodoDue = &quot;todo_due_tz = 'floating' AND todo_due&quot;;</span>
<a href="#l72.128"></a><span id="l72.128" class="difflineminus">-            var nonFloatingTodoDue = &quot;todo_due_tz != 'floating' AND todo_due&quot;;</span>
<a href="#l72.129"></a><span id="l72.129" class="difflineminus">-            var floatingCompleted = &quot;todo_completed_tz = 'floating' AND todo_completed&quot;;</span>
<a href="#l72.130"></a><span id="l72.130" class="difflineminus">-            var nonFloatingCompleted = &quot;todo_completed_tz != 'floating' AND todo_completed&quot;;</span>
<a href="#l72.131"></a><span id="l72.131" class="difflineplus">+            let floatingTodoEntry = &quot;todo_entry_tz = 'floating' AND todo_entry&quot;;</span>
<a href="#l72.132"></a><span id="l72.132" class="difflineplus">+            let nonFloatingTodoEntry = &quot;todo_entry_tz != 'floating' AND todo_entry&quot;;</span>
<a href="#l72.133"></a><span id="l72.133" class="difflineplus">+            let floatingTodoDue = &quot;todo_due_tz = 'floating' AND todo_due&quot;;</span>
<a href="#l72.134"></a><span id="l72.134" class="difflineplus">+            let nonFloatingTodoDue = &quot;todo_due_tz != 'floating' AND todo_due&quot;;</span>
<a href="#l72.135"></a><span id="l72.135" class="difflineplus">+            let floatingCompleted = &quot;todo_completed_tz = 'floating' AND todo_completed&quot;;</span>
<a href="#l72.136"></a><span id="l72.136" class="difflineplus">+            let nonFloatingCompleted = &quot;todo_completed_tz != 'floating' AND todo_completed&quot;;</span>
<a href="#l72.137"></a><span id="l72.137"> </span>
<a href="#l72.138"></a><span id="l72.138">             this.mSelectNonRecurringTodosByRange = this.mDB.createStatement(</span>
<a href="#l72.139"></a><span id="l72.139">                 &quot;SELECT * FROM cal_todos &quot; +</span>
<a href="#l72.140"></a><span id="l72.140">                 &quot;WHERE &quot; +</span>
<a href="#l72.141"></a><span id="l72.141">                 &quot;((((&quot;+ floatingTodoDue + &quot; &gt; :range_start + :start_offset) OR &quot; +</span>
<a href="#l72.142"></a><span id="l72.142">                 &quot;   (&quot;+ nonFloatingTodoDue + &quot; &gt; :range_start)) AND &quot; +</span>
<a href="#l72.143"></a><span id="l72.143">                 &quot;  ((todo_entry IS NULL) OR &quot; +</span>
<a href="#l72.144"></a><span id="l72.144">                 &quot;   ((&quot;+ floatingTodoEntry + &quot; &lt; :range_end + :end_offset) OR &quot; +</span>
<a href="#l72.145"></a><span id="l72.145" class="difflineat">@@ -1388,25 +1388,25 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.146"></a><span id="l72.146">             this.mDeleteMetaData = this.mDB.createStatement(</span>
<a href="#l72.147"></a><span id="l72.147">                 &quot;DELETE FROM cal_metadata WHERE item_id = :item_id AND cal_id = :cal_id&quot;</span>
<a href="#l72.148"></a><span id="l72.148">                 );</span>
<a href="#l72.149"></a><span id="l72.149">             this.mDeleteAlarms = this.mDB.createStatement(</span>
<a href="#l72.150"></a><span id="l72.150">                 &quot;DELETE FROM cal_alarms WHERE item_id = :item_id AND cal_id = :cal_id&quot;</span>
<a href="#l72.151"></a><span id="l72.151">                 );</span>
<a href="#l72.152"></a><span id="l72.152"> </span>
<a href="#l72.153"></a><span id="l72.153">             // These are only used when deleting an entire calendar</span>
<a href="#l72.154"></a><span id="l72.154" class="difflineminus">-            var extrasTables = [ &quot;cal_attendees&quot;, &quot;cal_properties&quot;,</span>
<a href="#l72.155"></a><span id="l72.155" class="difflineplus">+            let extrasTables = [ &quot;cal_attendees&quot;, &quot;cal_properties&quot;,</span>
<a href="#l72.156"></a><span id="l72.156">                                  &quot;cal_recurrence&quot;, &quot;cal_attachments&quot;,</span>
<a href="#l72.157"></a><span id="l72.157">                                  &quot;cal_metadata&quot;, &quot;cal_relations&quot;,</span>
<a href="#l72.158"></a><span id="l72.158">                                  &quot;cal_alarms&quot;];</span>
<a href="#l72.159"></a><span id="l72.159"> </span>
<a href="#l72.160"></a><span id="l72.160">             this.mDeleteEventExtras = [];</span>
<a href="#l72.161"></a><span id="l72.161">             this.mDeleteTodoExtras = [];</span>
<a href="#l72.162"></a><span id="l72.162"> </span>
<a href="#l72.163"></a><span id="l72.163" class="difflineminus">-            for (var table in extrasTables) {</span>
<a href="#l72.164"></a><span id="l72.164" class="difflineplus">+            for (let table in extrasTables) {</span>
<a href="#l72.165"></a><span id="l72.165">                 this.mDeleteEventExtras[table] = this.mDB.createStatement(</span>
<a href="#l72.166"></a><span id="l72.166">                     &quot;DELETE FROM &quot; + extrasTables[table] + &quot; WHERE item_id IN&quot; +</span>
<a href="#l72.167"></a><span id="l72.167">                     &quot;  (SELECT id FROM cal_events WHERE cal_id = :cal_id)&quot; +</span>
<a href="#l72.168"></a><span id="l72.168">                     &quot; AND cal_id = :cal_id&quot;</span>
<a href="#l72.169"></a><span id="l72.169">                     );</span>
<a href="#l72.170"></a><span id="l72.170">                 this.mDeleteTodoExtras[table] = this.mDB.createStatement(</span>
<a href="#l72.171"></a><span id="l72.171">                     &quot;DELETE FROM &quot; + extrasTables[table] + &quot; WHERE item_id IN&quot; +</span>
<a href="#l72.172"></a><span id="l72.172">                     &quot;  (SELECT id FROM cal_todos WHERE cal_id = :cal_id)&quot; +</span>
<a href="#l72.173"></a><span id="l72.173" class="difflineat">@@ -1575,33 +1575,33 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.174"></a><span id="l72.174">         } finally {</span>
<a href="#l72.175"></a><span id="l72.175">             this.mSelectEventsWithRecurrence.reset();</span>
<a href="#l72.176"></a><span id="l72.176">         }</span>
<a href="#l72.177"></a><span id="l72.177"> </span>
<a href="#l72.178"></a><span id="l72.178">         try {</span>
<a href="#l72.179"></a><span id="l72.179">             this.prepareStatement(this.mSelectTodosWithRecurrence);</span>
<a href="#l72.180"></a><span id="l72.180">             let sp = this.mSelectTodosWithRecurrence.params;</span>
<a href="#l72.181"></a><span id="l72.181">             while (this.mSelectTodosWithRecurrence.executeStep()) {</span>
<a href="#l72.182"></a><span id="l72.182" class="difflineminus">-                var row = this.mSelectTodosWithRecurrence.row;</span>
<a href="#l72.183"></a><span id="l72.183" class="difflineminus">-                var item = this.getTodoFromRow(row, {});</span>
<a href="#l72.184"></a><span id="l72.184" class="difflineplus">+                let row = this.mSelectTodosWithRecurrence.row;</span>
<a href="#l72.185"></a><span id="l72.185" class="difflineplus">+                let item = this.getTodoFromRow(row, {});</span>
<a href="#l72.186"></a><span id="l72.186">                 this.mRecTodoCache[item.id] = item;</span>
<a href="#l72.187"></a><span id="l72.187">                 this.mRecTodoCacheOfflineFlags[item.id] = row.offline_journal || null;</span>
<a href="#l72.188"></a><span id="l72.188">             }</span>
<a href="#l72.189"></a><span id="l72.189">         } catch (e) {</span>
<a href="#l72.190"></a><span id="l72.190">             this.logError(&quot;Error selecting todos with recurrence!&quot;, e);</span>
<a href="#l72.191"></a><span id="l72.191">         } finally {</span>
<a href="#l72.192"></a><span id="l72.192">             this.mSelectTodosWithRecurrence.reset();</span>
<a href="#l72.193"></a><span id="l72.193">         }</span>
<a href="#l72.194"></a><span id="l72.194"> </span>
<a href="#l72.195"></a><span id="l72.195">         this.mRecItemCacheInited = true;</span>
<a href="#l72.196"></a><span id="l72.196">     },</span>
<a href="#l72.197"></a><span id="l72.197"> </span>
<a href="#l72.198"></a><span id="l72.198">     // xxx todo: consider removing flags parameter</span>
<a href="#l72.199"></a><span id="l72.199">     getEventFromRow: function cSC_getEventFromRow(row, flags, isException) {</span>
<a href="#l72.200"></a><span id="l72.200" class="difflineminus">-        var item;</span>
<a href="#l72.201"></a><span id="l72.201" class="difflineplus">+        let item;</span>
<a href="#l72.202"></a><span id="l72.202">         if (!isException) { // only parent items are cached</span>
<a href="#l72.203"></a><span id="l72.203">             item = this.mItemCache[row.id];</span>
<a href="#l72.204"></a><span id="l72.204">             if (item) {</span>
<a href="#l72.205"></a><span id="l72.205">                 return item;</span>
<a href="#l72.206"></a><span id="l72.206">             }</span>
<a href="#l72.207"></a><span id="l72.207">         }</span>
<a href="#l72.208"></a><span id="l72.208"> </span>
<a href="#l72.209"></a><span id="l72.209">         item = createEvent();</span>
<a href="#l72.210"></a><span id="l72.210" class="difflineat">@@ -1627,17 +1627,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.211"></a><span id="l72.211">         if (!isException) { // keep exceptions modifyable to set the parentItem</span>
<a href="#l72.212"></a><span id="l72.212">             item.makeImmutable();</span>
<a href="#l72.213"></a><span id="l72.213">             this.cacheItem(item);</span>
<a href="#l72.214"></a><span id="l72.214">         }</span>
<a href="#l72.215"></a><span id="l72.215">         return item;</span>
<a href="#l72.216"></a><span id="l72.216">     },</span>
<a href="#l72.217"></a><span id="l72.217"> </span>
<a href="#l72.218"></a><span id="l72.218">     getTodoFromRow: function cSC_getTodoFromRow(row, flags, isException) {</span>
<a href="#l72.219"></a><span id="l72.219" class="difflineminus">-        var item;</span>
<a href="#l72.220"></a><span id="l72.220" class="difflineplus">+        let item;</span>
<a href="#l72.221"></a><span id="l72.221">         if (!isException) { // only parent items are cached</span>
<a href="#l72.222"></a><span id="l72.222">             item = this.mItemCache[row.id];</span>
<a href="#l72.223"></a><span id="l72.223">             if (item) {</span>
<a href="#l72.224"></a><span id="l72.224">                 return item;</span>
<a href="#l72.225"></a><span id="l72.225">             }</span>
<a href="#l72.226"></a><span id="l72.226">         }</span>
<a href="#l72.227"></a><span id="l72.227"> </span>
<a href="#l72.228"></a><span id="l72.228">         item = createTodo();</span>
<a href="#l72.229"></a><span id="l72.229" class="difflineat">@@ -1908,23 +1908,23 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.230"></a><span id="l72.230"> </span>
<a href="#l72.231"></a><span id="l72.231">     //</span>
<a href="#l72.232"></a><span id="l72.232">     // get item from db or from cache with given iid</span>
<a href="#l72.233"></a><span id="l72.233">     //</span>
<a href="#l72.234"></a><span id="l72.234">     getItemById: function cSC_getItemById(aID) {</span>
<a href="#l72.235"></a><span id="l72.235">         this.assureRecurringItemCaches();</span>
<a href="#l72.236"></a><span id="l72.236"> </span>
<a href="#l72.237"></a><span id="l72.237">         // cached?</span>
<a href="#l72.238"></a><span id="l72.238" class="difflineminus">-        var item = this.mItemCache[aID];</span>
<a href="#l72.239"></a><span id="l72.239" class="difflineplus">+        let item = this.mItemCache[aID];</span>
<a href="#l72.240"></a><span id="l72.240">         if (item) {</span>
<a href="#l72.241"></a><span id="l72.241">             return item;</span>
<a href="#l72.242"></a><span id="l72.242">         }</span>
<a href="#l72.243"></a><span id="l72.243"> </span>
<a href="#l72.244"></a><span id="l72.244">         // not cached; need to read from the db</span>
<a href="#l72.245"></a><span id="l72.245" class="difflineminus">-        var flags = {};</span>
<a href="#l72.246"></a><span id="l72.246" class="difflineplus">+        let flags = {};</span>
<a href="#l72.247"></a><span id="l72.247"> </span>
<a href="#l72.248"></a><span id="l72.248">         try {</span>
<a href="#l72.249"></a><span id="l72.249">             // try events first</span>
<a href="#l72.250"></a><span id="l72.250">             this.prepareStatement(this.mSelectEvent);</span>
<a href="#l72.251"></a><span id="l72.251">             this.mSelectEvent.params.id = aID;</span>
<a href="#l72.252"></a><span id="l72.252">             if (this.mSelectEvent.executeStep()) {</span>
<a href="#l72.253"></a><span id="l72.253">                 item = this.getEventFromRow(this.mSelectEvent.row, flags);</span>
<a href="#l72.254"></a><span id="l72.254">             }</span>
<a href="#l72.255"></a><span id="l72.255" class="difflineat">@@ -1954,18 +1954,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.256"></a><span id="l72.256"> </span>
<a href="#l72.257"></a><span id="l72.257">     //</span>
<a href="#l72.258"></a><span id="l72.258">     // database writing functions</span>
<a href="#l72.259"></a><span id="l72.259">     //</span>
<a href="#l72.260"></a><span id="l72.260"> </span>
<a href="#l72.261"></a><span id="l72.261">     setDateParamHelper: function cSC_setDateParamHelper(params, entryname, cdt) {</span>
<a href="#l72.262"></a><span id="l72.262">         if (cdt) {</span>
<a href="#l72.263"></a><span id="l72.263">             params[entryname] = cdt.nativeTime;</span>
<a href="#l72.264"></a><span id="l72.264" class="difflineminus">-            var tz = cdt.timezone;</span>
<a href="#l72.265"></a><span id="l72.265" class="difflineminus">-            var ownTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l72.266"></a><span id="l72.266" class="difflineplus">+            let tz = cdt.timezone;</span>
<a href="#l72.267"></a><span id="l72.267" class="difflineplus">+            let ownTz = cal.getTimezoneService().getTimezone(tz.tzid);</span>
<a href="#l72.268"></a><span id="l72.268">             if (ownTz) { // if we know that TZID, we use it</span>
<a href="#l72.269"></a><span id="l72.269">                 params[entryname + &quot;_tz&quot;] = ownTz.tzid;</span>
<a href="#l72.270"></a><span id="l72.270">             } else if (!tz.icalComponent) { // timezone component missing</span>
<a href="#l72.271"></a><span id="l72.271">                 params[entryname + &quot;_tz&quot;] = &quot;floating&quot;;</span>
<a href="#l72.272"></a><span id="l72.272">             } else { // foreign one</span>
<a href="#l72.273"></a><span id="l72.273">                 params[entryname + &quot;_tz&quot;] = tz.icalComponent.serializeToICS();</span>
<a href="#l72.274"></a><span id="l72.274">             }</span>
<a href="#l72.275"></a><span id="l72.275">         } else {</span>
<a href="#l72.276"></a><span id="l72.276" class="difflineat">@@ -1993,17 +1993,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.277"></a><span id="l72.277">     //</span>
<a href="#l72.278"></a><span id="l72.278">     // The write* functions execute the database bits</span>
<a href="#l72.279"></a><span id="l72.279">     // to write the given item type.  They're to return</span>
<a href="#l72.280"></a><span id="l72.280">     // any bits they want or'd into flags, which will be passed</span>
<a href="#l72.281"></a><span id="l72.281">     // to writeEvent/writeTodo to actually do the writing.</span>
<a href="#l72.282"></a><span id="l72.282">     //</span>
<a href="#l72.283"></a><span id="l72.283"> </span>
<a href="#l72.284"></a><span id="l72.284">     writeItem: function cSC_writeItem(item, olditem) {</span>
<a href="#l72.285"></a><span id="l72.285" class="difflineminus">-        var flags = 0;</span>
<a href="#l72.286"></a><span id="l72.286" class="difflineplus">+        let flags = 0;</span>
<a href="#l72.287"></a><span id="l72.287"> </span>
<a href="#l72.288"></a><span id="l72.288">         flags |= this.writeAttendees(item, olditem);</span>
<a href="#l72.289"></a><span id="l72.289">         flags |= this.writeRecurrence(item, olditem);</span>
<a href="#l72.290"></a><span id="l72.290">         flags |= this.writeProperties(item, olditem);</span>
<a href="#l72.291"></a><span id="l72.291">         flags |= this.writeAttachments(item, olditem);</span>
<a href="#l72.292"></a><span id="l72.292">         flags |= this.writeRelations(item, olditem);</span>
<a href="#l72.293"></a><span id="l72.293">         flags |= this.writeAlarms(item, olditem);</span>
<a href="#l72.294"></a><span id="l72.294"> </span>
<a href="#l72.295"></a><span id="l72.295" class="difflineat">@@ -2073,17 +2073,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.296"></a><span id="l72.296"> </span>
<a href="#l72.297"></a><span id="l72.297">     setupItemBaseParams: function cSC_setupItemBaseParams(item, olditem, ip) {</span>
<a href="#l72.298"></a><span id="l72.298">         ip.id = item.id;</span>
<a href="#l72.299"></a><span id="l72.299"> </span>
<a href="#l72.300"></a><span id="l72.300">         if (item.recurrenceId) {</span>
<a href="#l72.301"></a><span id="l72.301">             this.setDateParamHelper(ip, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l72.302"></a><span id="l72.302">         }</span>
<a href="#l72.303"></a><span id="l72.303"> </span>
<a href="#l72.304"></a><span id="l72.304" class="difflineminus">-        var tmp;</span>
<a href="#l72.305"></a><span id="l72.305" class="difflineplus">+        let tmp;</span>
<a href="#l72.306"></a><span id="l72.306"> </span>
<a href="#l72.307"></a><span id="l72.307">         if ((tmp = item.getProperty(&quot;CREATED&quot;))) {</span>
<a href="#l72.308"></a><span id="l72.308">             ip.time_created = tmp.nativeTime;</span>
<a href="#l72.309"></a><span id="l72.309">         }</span>
<a href="#l72.310"></a><span id="l72.310">         if ((tmp = item.getProperty(&quot;LAST-MODIFIED&quot;))) {</span>
<a href="#l72.311"></a><span id="l72.311">             ip.last_modified = tmp.nativeTime;</span>
<a href="#l72.312"></a><span id="l72.312">         }</span>
<a href="#l72.313"></a><span id="l72.313"> </span>
<a href="#l72.314"></a><span id="l72.314" class="difflineat">@@ -2093,24 +2093,24 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.315"></a><span id="l72.315">         ip.ical_status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l72.316"></a><span id="l72.316"> </span>
<a href="#l72.317"></a><span id="l72.317">         if (item.alarmLastAck) {</span>
<a href="#l72.318"></a><span id="l72.318">             ip.alarm_last_ack = item.alarmLastAck.nativeTime;</span>
<a href="#l72.319"></a><span id="l72.319">         }</span>
<a href="#l72.320"></a><span id="l72.320">     },</span>
<a href="#l72.321"></a><span id="l72.321"> </span>
<a href="#l72.322"></a><span id="l72.322">     writeAttendees: function cSC_writeAttendees(item, olditem) {</span>
<a href="#l72.323"></a><span id="l72.323" class="difflineminus">-        var attendees = item.getAttendees({});</span>
<a href="#l72.324"></a><span id="l72.324" class="difflineplus">+        let attendees = item.getAttendees({});</span>
<a href="#l72.325"></a><span id="l72.325">         if (item.organizer) {</span>
<a href="#l72.326"></a><span id="l72.326">             attendees = attendees.concat([]);</span>
<a href="#l72.327"></a><span id="l72.327">             attendees.push(item.organizer);</span>
<a href="#l72.328"></a><span id="l72.328">         }</span>
<a href="#l72.329"></a><span id="l72.329">         if (attendees.length &gt; 0) {</span>
<a href="#l72.330"></a><span id="l72.330" class="difflineminus">-            for (var att of attendees) {</span>
<a href="#l72.331"></a><span id="l72.331" class="difflineminus">-                var ap = this.mInsertAttendee.params;</span>
<a href="#l72.332"></a><span id="l72.332" class="difflineplus">+            for (let att of attendees) {</span>
<a href="#l72.333"></a><span id="l72.333" class="difflineplus">+                let ap = this.mInsertAttendee.params;</span>
<a href="#l72.334"></a><span id="l72.334">                 ap.item_id = item.id;</span>
<a href="#l72.335"></a><span id="l72.335">                 try {</span>
<a href="#l72.336"></a><span id="l72.336">                     this.prepareStatement(this.mInsertAttendee);</span>
<a href="#l72.337"></a><span id="l72.337">                     this.setDateParamHelper(ap, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l72.338"></a><span id="l72.338">                     ap.icalString = att.icalString;</span>
<a href="#l72.339"></a><span id="l72.339">                     this.mInsertAttendee.executeStep();</span>
<a href="#l72.340"></a><span id="l72.340">                 } finally {</span>
<a href="#l72.341"></a><span id="l72.341">                     this.mInsertAttendee.reset();</span>
<a href="#l72.342"></a><span id="l72.342" class="difflineat">@@ -2121,17 +2121,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.343"></a><span id="l72.343">         }</span>
<a href="#l72.344"></a><span id="l72.344"> </span>
<a href="#l72.345"></a><span id="l72.345">         return 0;</span>
<a href="#l72.346"></a><span id="l72.346">     },</span>
<a href="#l72.347"></a><span id="l72.347"> </span>
<a href="#l72.348"></a><span id="l72.348">     writeProperty: function cSC_writeProperty(item, propName, propValue) {</span>
<a href="#l72.349"></a><span id="l72.349">         try {</span>
<a href="#l72.350"></a><span id="l72.350">             this.prepareStatement(this.mInsertProperty);</span>
<a href="#l72.351"></a><span id="l72.351" class="difflineminus">-            var pp = this.mInsertProperty.params;</span>
<a href="#l72.352"></a><span id="l72.352" class="difflineplus">+            let pp = this.mInsertProperty.params;</span>
<a href="#l72.353"></a><span id="l72.353">             pp.key = propName;</span>
<a href="#l72.354"></a><span id="l72.354">             let wPropValue = cal.wrapInstance(propValue, Components.interfaces.calIDateTime);</span>
<a href="#l72.355"></a><span id="l72.355">             if (wPropValue) {</span>
<a href="#l72.356"></a><span id="l72.356">                 pp.value = wPropValue.nativeTime;</span>
<a href="#l72.357"></a><span id="l72.357">             } else {</span>
<a href="#l72.358"></a><span id="l72.358">                 try {</span>
<a href="#l72.359"></a><span id="l72.359">                     pp.value = propValue;</span>
<a href="#l72.360"></a><span id="l72.360">                 } catch (e) {</span>
<a href="#l72.361"></a><span id="l72.361" class="difflineat">@@ -2147,56 +2147,56 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.362"></a><span id="l72.362">             this.setDateParamHelper(pp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l72.363"></a><span id="l72.363">             this.mInsertProperty.executeStep();</span>
<a href="#l72.364"></a><span id="l72.364">         } finally {</span>
<a href="#l72.365"></a><span id="l72.365">             this.mInsertProperty.reset();</span>
<a href="#l72.366"></a><span id="l72.366">         }</span>
<a href="#l72.367"></a><span id="l72.367">     },</span>
<a href="#l72.368"></a><span id="l72.368"> </span>
<a href="#l72.369"></a><span id="l72.369">     writeProperties: function cSC_writeProperties(item, olditem) {</span>
<a href="#l72.370"></a><span id="l72.370" class="difflineminus">-        var ret = 0;</span>
<a href="#l72.371"></a><span id="l72.371" class="difflineminus">-        var propEnumerator = item.propertyEnumerator;</span>
<a href="#l72.372"></a><span id="l72.372" class="difflineplus">+        let ret = 0;</span>
<a href="#l72.373"></a><span id="l72.373" class="difflineplus">+        let propEnumerator = item.propertyEnumerator;</span>
<a href="#l72.374"></a><span id="l72.374">         while (propEnumerator.hasMoreElements()) {</span>
<a href="#l72.375"></a><span id="l72.375">             ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l72.376"></a><span id="l72.376" class="difflineminus">-            var prop = propEnumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l72.377"></a><span id="l72.377" class="difflineplus">+            let prop = propEnumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l72.378"></a><span id="l72.378">             if (item.isPropertyPromoted(prop.name)) {</span>
<a href="#l72.379"></a><span id="l72.379">                 continue;</span>
<a href="#l72.380"></a><span id="l72.380">             }</span>
<a href="#l72.381"></a><span id="l72.381">             this.writeProperty(item, prop.name, prop.value);</span>
<a href="#l72.382"></a><span id="l72.382">         }</span>
<a href="#l72.383"></a><span id="l72.383"> </span>
<a href="#l72.384"></a><span id="l72.384" class="difflineminus">-        var cats = item.getCategories({});</span>
<a href="#l72.385"></a><span id="l72.385" class="difflineplus">+        let cats = item.getCategories({});</span>
<a href="#l72.386"></a><span id="l72.386">         if (cats.length &gt; 0) {</span>
<a href="#l72.387"></a><span id="l72.387">             ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l72.388"></a><span id="l72.388">             this.writeProperty(item, &quot;CATEGORIES&quot;, categoriesArrayToString(cats));</span>
<a href="#l72.389"></a><span id="l72.389">         }</span>
<a href="#l72.390"></a><span id="l72.390"> </span>
<a href="#l72.391"></a><span id="l72.391">         return ret;</span>
<a href="#l72.392"></a><span id="l72.392">     },</span>
<a href="#l72.393"></a><span id="l72.393"> </span>
<a href="#l72.394"></a><span id="l72.394">     writeRecurrence: function cSC_writeRecurrence(item, olditem) {</span>
<a href="#l72.395"></a><span id="l72.395" class="difflineminus">-        var flags = 0;</span>
<a href="#l72.396"></a><span id="l72.396" class="difflineplus">+        let flags = 0;</span>
<a href="#l72.397"></a><span id="l72.397"> </span>
<a href="#l72.398"></a><span id="l72.398" class="difflineminus">-        var rec = item.recurrenceInfo;</span>
<a href="#l72.399"></a><span id="l72.399" class="difflineplus">+        let rec = item.recurrenceInfo;</span>
<a href="#l72.400"></a><span id="l72.400">         if (rec) {</span>
<a href="#l72.401"></a><span id="l72.401">             flags = CAL_ITEM_FLAG.HAS_RECURRENCE;</span>
<a href="#l72.402"></a><span id="l72.402">             let ritems = rec.getRecurrenceItems({});</span>
<a href="#l72.403"></a><span id="l72.403">             for (let ritem of ritems) {</span>
<a href="#l72.404"></a><span id="l72.404">                 let ap = this.mInsertRecurrence.params;</span>
<a href="#l72.405"></a><span id="l72.405">                 try {</span>
<a href="#l72.406"></a><span id="l72.406">                     this.prepareStatement(this.mInsertRecurrence);</span>
<a href="#l72.407"></a><span id="l72.407">                     ap.item_id = item.id;</span>
<a href="#l72.408"></a><span id="l72.408">                     ap.icalString = ritem.icalString;</span>
<a href="#l72.409"></a><span id="l72.409">                     this.mInsertRecurrence.executeStep();</span>
<a href="#l72.410"></a><span id="l72.410">                 } finally {</span>
<a href="#l72.411"></a><span id="l72.411">                     this.mInsertRecurrence.reset();</span>
<a href="#l72.412"></a><span id="l72.412">                 }</span>
<a href="#l72.413"></a><span id="l72.413">             }</span>
<a href="#l72.414"></a><span id="l72.414"> </span>
<a href="#l72.415"></a><span id="l72.415" class="difflineminus">-            var exceptions = rec.getExceptionIds({});</span>
<a href="#l72.416"></a><span id="l72.416" class="difflineplus">+            let exceptions = rec.getExceptionIds({});</span>
<a href="#l72.417"></a><span id="l72.417">             if (exceptions.length &gt; 0) {</span>
<a href="#l72.418"></a><span id="l72.418">                 flags |= CAL_ITEM_FLAG.HAS_EXCEPTIONS;</span>
<a href="#l72.419"></a><span id="l72.419"> </span>
<a href="#l72.420"></a><span id="l72.420">                 // we need to serialize each exid as a separate</span>
<a href="#l72.421"></a><span id="l72.421">                 // event/todo; setupItemBase will handle</span>
<a href="#l72.422"></a><span id="l72.422">                 // writing the recurrenceId for us</span>
<a href="#l72.423"></a><span id="l72.423">                 for (let exid of exceptions) {</span>
<a href="#l72.424"></a><span id="l72.424">                     let ex = rec.getExceptionFor(exid);</span>
<a href="#l72.425"></a><span id="l72.425" class="difflineat">@@ -2232,17 +2232,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.426"></a><span id="l72.426">             return CAL_ITEM_FLAG.HAS_ATTACHMENTS;</span>
<a href="#l72.427"></a><span id="l72.427">         }</span>
<a href="#l72.428"></a><span id="l72.428">         return 0;</span>
<a href="#l72.429"></a><span id="l72.429">     },</span>
<a href="#l72.430"></a><span id="l72.430"> </span>
<a href="#l72.431"></a><span id="l72.431">     writeRelations: function cSC_writeRelations(item, olditem) {</span>
<a href="#l72.432"></a><span id="l72.432">         let relations = item.getRelations({});</span>
<a href="#l72.433"></a><span id="l72.433">         if (relations &amp;&amp; relations.length &gt; 0) {</span>
<a href="#l72.434"></a><span id="l72.434" class="difflineminus">-            for (var rel of relations) {</span>
<a href="#l72.435"></a><span id="l72.435" class="difflineplus">+            for (let rel of relations) {</span>
<a href="#l72.436"></a><span id="l72.436">                 let rp = this.mInsertRelation.params;</span>
<a href="#l72.437"></a><span id="l72.437">                 try {</span>
<a href="#l72.438"></a><span id="l72.438">                     this.prepareStatement(this.mInsertRelation);</span>
<a href="#l72.439"></a><span id="l72.439">                     this.setDateParamHelper(rp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l72.440"></a><span id="l72.440">                     rp.item_id = item.id;</span>
<a href="#l72.441"></a><span id="l72.441">                     rp.icalString = rel.icalString;</span>
<a href="#l72.442"></a><span id="l72.442"> </span>
<a href="#l72.443"></a><span id="l72.443">                     this.mInsertRelation.executeStep();</span>
<a href="#l72.444"></a><span id="l72.444" class="difflineat">@@ -2451,19 +2451,19 @@ calStorageCalendar.prototype = {</span>
<a href="#l72.445"></a><span id="l72.445">      * propagate the given sequence in exceptions. It may be needed by some calendar implementations</span>
<a href="#l72.446"></a><span id="l72.446">      */</span>
<a href="#l72.447"></a><span id="l72.447">     _propagateSequence: function cSC__propagateSequence(aItem, newSequence) {</span>
<a href="#l72.448"></a><span id="l72.448">         if (newSequence) {</span>
<a href="#l72.449"></a><span id="l72.449">             aItem.setProperty(&quot;SEQUENCE&quot;, newSequence);</span>
<a href="#l72.450"></a><span id="l72.450">         } else {</span>
<a href="#l72.451"></a><span id="l72.451">             aItem.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l72.452"></a><span id="l72.452">         }</span>
<a href="#l72.453"></a><span id="l72.453" class="difflineminus">-        var rec = aItem.recurrenceInfo;</span>
<a href="#l72.454"></a><span id="l72.454" class="difflineplus">+        let rec = aItem.recurrenceInfo;</span>
<a href="#l72.455"></a><span id="l72.455">         if (rec) {</span>
<a href="#l72.456"></a><span id="l72.456" class="difflineminus">-            var exceptions = rec.getExceptionIds({});</span>
<a href="#l72.457"></a><span id="l72.457" class="difflineplus">+            let exceptions = rec.getExceptionIds({});</span>
<a href="#l72.458"></a><span id="l72.458">             if (exceptions.length &gt; 0) {</span>
<a href="#l72.459"></a><span id="l72.459">                 for (let exid of exceptions) {</span>
<a href="#l72.460"></a><span id="l72.460">                     let ex = rec.getExceptionFor(exid);</span>
<a href="#l72.461"></a><span id="l72.461">                     if (newSequence) {</span>
<a href="#l72.462"></a><span id="l72.462">                         ex.setProperty(&quot;SEQUENCE&quot;, newSequence);</span>
<a href="#l72.463"></a><span id="l72.463">                     } else {</span>
<a href="#l72.464"></a><span id="l72.464">                         ex.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l72.465"></a><span id="l72.465">                     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -33,27 +33,27 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.4"></a><span id="l73.4">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l73.5"></a><span id="l73.5">         classID: calWcapCalendarClassID,</span>
<a href="#l73.6"></a><span id="l73.6">         contractID: &quot;@mozilla.org/calendar/calendar;1?type=wcap&quot;,</span>
<a href="#l73.7"></a><span id="l73.7">         classDescription: &quot;Sun Java System Calendar Server WCAP Provider&quot;,</span>
<a href="#l73.8"></a><span id="l73.8">         interfaces: calWcapCalendarInterfaces</span>
<a href="#l73.9"></a><span id="l73.9">     }),</span>
<a href="#l73.10"></a><span id="l73.10"> </span>
<a href="#l73.11"></a><span id="l73.11">     toString: function calWcapCalendar_toString() {</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-        var str = this.session.toString();</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+        let str = this.session.toString();</span>
<a href="#l73.14"></a><span id="l73.14">         if (this.m_calId) {</span>
<a href="#l73.15"></a><span id="l73.15">             str += (&quot;, calId=&quot; + this.calId);</span>
<a href="#l73.16"></a><span id="l73.16">         } else {</span>
<a href="#l73.17"></a><span id="l73.17">             str += &quot;, default calendar&quot;;</span>
<a href="#l73.18"></a><span id="l73.18">         }</span>
<a href="#l73.19"></a><span id="l73.19">         return str;</span>
<a href="#l73.20"></a><span id="l73.20">     },</span>
<a href="#l73.21"></a><span id="l73.21"> </span>
<a href="#l73.22"></a><span id="l73.22">     notifyError_: function calWcapCalendar_notifyError_(err, msg, context) {</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineminus">-        var rc = getResultCode(err);</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineplus">+        let rc = getResultCode(err);</span>
<a href="#l73.25"></a><span id="l73.25">         switch (rc) {</span>
<a href="#l73.26"></a><span id="l73.26">             case calIWcapErrors.WCAP_COMPONENT_NOT_FOUND:</span>
<a href="#l73.27"></a><span id="l73.27">             case NS_ERROR_OFFLINE:</span>
<a href="#l73.28"></a><span id="l73.28">                 return;</span>
<a href="#l73.29"></a><span id="l73.29">             default:</span>
<a href="#l73.30"></a><span id="l73.30">                 msg = errorToString(err);</span>
<a href="#l73.31"></a><span id="l73.31">                 log(&quot;error: &quot; + msg, context);</span>
<a href="#l73.32"></a><span id="l73.32">                 break;</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineat">@@ -80,17 +80,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.34"></a><span id="l73.34">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.35"></a><span id="l73.35">     },</span>
<a href="#l73.36"></a><span id="l73.36">     getCalendar: function calWcapCalendar_getCalendar(url) {</span>
<a href="#l73.37"></a><span id="l73.37">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l73.38"></a><span id="l73.38">     },</span>
<a href="#l73.39"></a><span id="l73.39"> </span>
<a href="#l73.40"></a><span id="l73.40">     // calICalendar:</span>
<a href="#l73.41"></a><span id="l73.41">     get name() {</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineminus">-        var name = this.getProperty(&quot;name&quot;);</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineplus">+        let name = this.getProperty(&quot;name&quot;);</span>
<a href="#l73.44"></a><span id="l73.44">         if (!name) {</span>
<a href="#l73.45"></a><span id="l73.45">             name = this.displayName;</span>
<a href="#l73.46"></a><span id="l73.46">         }</span>
<a href="#l73.47"></a><span id="l73.47">         return name;</span>
<a href="#l73.48"></a><span id="l73.48">     },</span>
<a href="#l73.49"></a><span id="l73.49">     set name(aValue) {</span>
<a href="#l73.50"></a><span id="l73.50">         return this.setProperty(&quot;name&quot;, aValue);</span>
<a href="#l73.51"></a><span id="l73.51">     },</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineat">@@ -100,23 +100,23 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.53"></a><span id="l73.53">     },</span>
<a href="#l73.54"></a><span id="l73.54"> </span>
<a href="#l73.55"></a><span id="l73.55">     m_uri: null,</span>
<a href="#l73.56"></a><span id="l73.56">     get uri() {</span>
<a href="#l73.57"></a><span id="l73.57">         return this.m_uri;</span>
<a href="#l73.58"></a><span id="l73.58">     },</span>
<a href="#l73.59"></a><span id="l73.59">     set uri(thatUri) {</span>
<a href="#l73.60"></a><span id="l73.60">         this.m_uri = thatUri.clone();</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineminus">-        var path = thatUri.path;</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineminus">-        var qmPos = path.indexOf(&quot;?&quot;);</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineplus">+        let path = thatUri.path;</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineplus">+        let qmPos = path.indexOf(&quot;?&quot;);</span>
<a href="#l73.65"></a><span id="l73.65">         if (qmPos != -1) {</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineminus">-            var pos = path.indexOf(&quot;?calid=&quot;, qmPos);</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineplus">+            let pos = path.indexOf(&quot;?calid=&quot;, qmPos);</span>
<a href="#l73.68"></a><span id="l73.68">             if (pos != -1) {</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineminus">-                var start = (pos + &quot;?calid=&quot;.length);</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineminus">-                var end = path.indexOf(&quot;&amp;&quot;, start);</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+                let start = (pos + &quot;?calid=&quot;.length);</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineplus">+                let end = path.indexOf(&quot;&amp;&quot;, start);</span>
<a href="#l73.73"></a><span id="l73.73">                 this.m_calId = decodeURIComponent(</span>
<a href="#l73.74"></a><span id="l73.74">                     path.substring(start, end == -1 ? path.length : end));</span>
<a href="#l73.75"></a><span id="l73.75">             }</span>
<a href="#l73.76"></a><span id="l73.76">         }</span>
<a href="#l73.77"></a><span id="l73.77">         return this.uri;</span>
<a href="#l73.78"></a><span id="l73.78">     },</span>
<a href="#l73.79"></a><span id="l73.79"> </span>
<a href="#l73.80"></a><span id="l73.80">     getProperty: function calWcapCalendar_getProperty(aName) {</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineat">@@ -139,17 +139,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.82"></a><span id="l73.82">                                                         // Popup alarms not available no matter what; wtf.</span>
<a href="#l73.83"></a><span id="l73.83">                 return false;</span>
<a href="#l73.84"></a><span id="l73.84">             case &quot;capabilities.alarms.actionValues&quot;:</span>
<a href="#l73.85"></a><span id="l73.85">                 return [&quot;EMAIL&quot;];</span>
<a href="#l73.86"></a><span id="l73.86">             case &quot;capabilities.alarms.maxCount&quot;:</span>
<a href="#l73.87"></a><span id="l73.87">                 return 1;</span>
<a href="#l73.88"></a><span id="l73.88">         }</span>
<a href="#l73.89"></a><span id="l73.89"> </span>
<a href="#l73.90"></a><span id="l73.90" class="difflineminus">-        var value = this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+        let value = this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l73.92"></a><span id="l73.92">         switch (aName) {</span>
<a href="#l73.93"></a><span id="l73.93">             case &quot;readOnly&quot;:</span>
<a href="#l73.94"></a><span id="l73.94">                 if (value === null) {</span>
<a href="#l73.95"></a><span id="l73.95">                     // tweak readOnly default to true for non-owned calendars,</span>
<a href="#l73.96"></a><span id="l73.96">                     // all secondary calendars to readOnly unless we're logged in</span>
<a href="#l73.97"></a><span id="l73.97">                     value = (this.m_session &amp;&amp; this.session.isLoggedIn</span>
<a href="#l73.98"></a><span id="l73.98">                              ? !this.isOwnedCalendar</span>
<a href="#l73.99"></a><span id="l73.99">                              : !this.isDefaultCalendar);</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineat">@@ -207,17 +207,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.101"></a><span id="l73.101">         // invalidate cached results:</span>
<a href="#l73.102"></a><span id="l73.102">         delete this.m_cachedResults;</span>
<a href="#l73.103"></a><span id="l73.103">         // notify about refreshed calendar:</span>
<a href="#l73.104"></a><span id="l73.104">         this.notifyObservers(&quot;onLoad&quot;, [this]);</span>
<a href="#l73.105"></a><span id="l73.105">     },</span>
<a href="#l73.106"></a><span id="l73.106"> </span>
<a href="#l73.107"></a><span id="l73.107">     issueNetworkRequest: function calWcapCalendar_issueNetworkRequest(</span>
<a href="#l73.108"></a><span id="l73.108">               request, respFunc, dataConvFunc, wcapCommand, params, accessRights) {</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineminus">-        var this_ = this;</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineplus">+        let this_ = this;</span>
<a href="#l73.111"></a><span id="l73.111">         // - bootstrap problem: no cal_props, no access check, no default calId</span>
<a href="#l73.112"></a><span id="l73.112">         // - assure being logged in, thus the default cal_props are available</span>
<a href="#l73.113"></a><span id="l73.113">         // - every subscribed calendar will come along with cal_props</span>
<a href="#l73.114"></a><span id="l73.114">         return this.session.getSessionId(</span>
<a href="#l73.115"></a><span id="l73.115">             request,</span>
<a href="#l73.116"></a><span id="l73.116">             function getSessionId_resp(err, sessionId) {</span>
<a href="#l73.117"></a><span id="l73.117">                 try {</span>
<a href="#l73.118"></a><span id="l73.118">                     if (err) {</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineat">@@ -243,41 +243,41 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.120"></a><span id="l73.120">     },</span>
<a href="#l73.121"></a><span id="l73.121"> </span>
<a href="#l73.122"></a><span id="l73.122">     m_calId: null,</span>
<a href="#l73.123"></a><span id="l73.123">     get calId() {</span>
<a href="#l73.124"></a><span id="l73.124">         return (this.m_calId || this.session.defaultCalId);</span>
<a href="#l73.125"></a><span id="l73.125">     },</span>
<a href="#l73.126"></a><span id="l73.126"> </span>
<a href="#l73.127"></a><span id="l73.127">     get ownerId() {</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineminus">-        var ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-PRIMARY-OWNER&quot;);</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+        let ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-PRIMARY-OWNER&quot;);</span>
<a href="#l73.130"></a><span id="l73.130">         if (ar.length == 0) {</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineminus">-            var calId = this.calId;</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineplus">+            let calId = this.calId;</span>
<a href="#l73.133"></a><span id="l73.133">             log(&quot;cannot determine primary owner of calendar &quot; + calId, this);</span>
<a href="#l73.134"></a><span id="l73.134">             // fallback to calId prefix:</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineminus">-            var nColon = calId.indexOf(&quot;:&quot;);</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineplus">+            let nColon = calId.indexOf(&quot;:&quot;);</span>
<a href="#l73.137"></a><span id="l73.137">             if (nColon &gt;= 0) {</span>
<a href="#l73.138"></a><span id="l73.138">                 calId = calId.substring(0, nColon);</span>
<a href="#l73.139"></a><span id="l73.139">             }</span>
<a href="#l73.140"></a><span id="l73.140">             return calId;</span>
<a href="#l73.141"></a><span id="l73.141">         }</span>
<a href="#l73.142"></a><span id="l73.142">         return ar[0];</span>
<a href="#l73.143"></a><span id="l73.143">     },</span>
<a href="#l73.144"></a><span id="l73.144"> </span>
<a href="#l73.145"></a><span id="l73.145">     get description() {</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineminus">-        var ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-DESCRIPTION&quot;);</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+        let ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-DESCRIPTION&quot;);</span>
<a href="#l73.148"></a><span id="l73.148">         if (ar.length == 0) {</span>
<a href="#l73.149"></a><span id="l73.149">             // fallback to display name:</span>
<a href="#l73.150"></a><span id="l73.150">             return this.displayName;</span>
<a href="#l73.151"></a><span id="l73.151">         }</span>
<a href="#l73.152"></a><span id="l73.152">         return ar[0];</span>
<a href="#l73.153"></a><span id="l73.153">     },</span>
<a href="#l73.154"></a><span id="l73.154"> </span>
<a href="#l73.155"></a><span id="l73.155">     get displayName() {</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineminus">-        var ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-NAME&quot;);</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineplus">+        let ar = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-NAME&quot;);</span>
<a href="#l73.158"></a><span id="l73.158">         if (ar.length == 0) {</span>
<a href="#l73.159"></a><span id="l73.159">             // fallback to common name:</span>
<a href="#l73.160"></a><span id="l73.160">             ar = this.getCalendarProperties(&quot;X-S1CS-CALPROPS-COMMON-NAME&quot;);</span>
<a href="#l73.161"></a><span id="l73.161">             if (ar.length == 0) {</span>
<a href="#l73.162"></a><span id="l73.162">                 ar = [this.calId];</span>
<a href="#l73.163"></a><span id="l73.163">             }</span>
<a href="#l73.164"></a><span id="l73.164">         }</span>
<a href="#l73.165"></a><span id="l73.165">         return ar[0];</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineat">@@ -294,17 +294,17 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.167"></a><span id="l73.167">         return !this.m_calId;</span>
<a href="#l73.168"></a><span id="l73.168">     },</span>
<a href="#l73.169"></a><span id="l73.169"> </span>
<a href="#l73.170"></a><span id="l73.170">     m_calProps: null,</span>
<a href="#l73.171"></a><span id="l73.171">     getCalendarProperties: function calWcapCalendar_getCalendarProperties(propName, out_count) {</span>
<a href="#l73.172"></a><span id="l73.172">         if (!this.m_calProps) {</span>
<a href="#l73.173"></a><span id="l73.173">             log(&quot;soft error: no calprops available, most possibly not logged in.&quot;, this);</span>
<a href="#l73.174"></a><span id="l73.174">         }</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineminus">-        var ret = filterXmlNodes(propName, this.m_calProps);</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+        let ret = filterXmlNodes(propName, this.m_calProps);</span>
<a href="#l73.177"></a><span id="l73.177">         if (out_count) {</span>
<a href="#l73.178"></a><span id="l73.178">             out_count.value = ret.length;</span>
<a href="#l73.179"></a><span id="l73.179">         }</span>
<a href="#l73.180"></a><span id="l73.180">         return ret;</span>
<a href="#l73.181"></a><span id="l73.181">     },</span>
<a href="#l73.182"></a><span id="l73.182"> </span>
<a href="#l73.183"></a><span id="l73.183">     get defaultTimezone() {</span>
<a href="#l73.184"></a><span id="l73.184">         let tzid = this.getCalendarProperties(&quot;X-NSCP-CALPROPS-TZID&quot;);</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineat">@@ -314,36 +314,36 @@ calWcapCalendar.prototype = {</span>
<a href="#l73.186"></a><span id="l73.186">             logWarning(&quot;defaultTimezone: cannot get X-NSCP-CALPROPS-TZID!&quot;, this);</span>
<a href="#l73.187"></a><span id="l73.187">             // try to use local one if supported:</span>
<a href="#l73.188"></a><span id="l73.188">             tzid = cal.getTimezoneService().defaultTimezone.tzid;</span>
<a href="#l73.189"></a><span id="l73.189">             return (this.session.getTimezone(tzid) ? tzid : &quot;UTC&quot;);</span>
<a href="#l73.190"></a><span id="l73.190">         }</span>
<a href="#l73.191"></a><span id="l73.191">     },</span>
<a href="#l73.192"></a><span id="l73.192"> </span>
<a href="#l73.193"></a><span id="l73.193">     getAlignedTzid: function calWcapCalendar_getAlignedTzid(tz) {</span>
<a href="#l73.194"></a><span id="l73.194" class="difflineminus">-        var tzid = tz.tzid;</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineplus">+        let tzid = tz.tzid;</span>
<a href="#l73.196"></a><span id="l73.196">         // check whether it is one cs supports:</span>
<a href="#l73.197"></a><span id="l73.197">         if (tz.isFloating || !this.session.getTimezone(tzid)) {</span>
<a href="#l73.198"></a><span id="l73.198">             log(&quot;not a supported timezone: &quot; + tzid);</span>
<a href="#l73.199"></a><span id="l73.199">             // bug 435436:</span>
<a href="#l73.200"></a><span id="l73.200">             // xxx todo: we could further on search for a matching region,</span>
<a href="#l73.201"></a><span id="l73.201">             //           e.g. CET (in TZNAME), but for now stick to</span>
<a href="#l73.202"></a><span id="l73.202">             //           user's default if not supported directly</span>
<a href="#l73.203"></a><span id="l73.203" class="difflineminus">-            var ret = this.defaultTimezone;</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineplus">+            let ret = this.defaultTimezone;</span>
<a href="#l73.205"></a><span id="l73.205">             // use calendar's default:</span>
<a href="#l73.206"></a><span id="l73.206">             log(tzid + &quot; not supported, falling back to default: &quot; + ret, this);</span>
<a href="#l73.207"></a><span id="l73.207">             return ret;</span>
<a href="#l73.208"></a><span id="l73.208">         }</span>
<a href="#l73.209"></a><span id="l73.209">         return tzid;</span>
<a href="#l73.210"></a><span id="l73.210">     },</span>
<a href="#l73.211"></a><span id="l73.211"> </span>
<a href="#l73.212"></a><span id="l73.212">     checkAccess: function calWcapCalendar_checkAccess(accessControlBits) {</span>
<a href="#l73.213"></a><span id="l73.213">         // xxx todo: take real acl into account</span>
<a href="#l73.214"></a><span id="l73.214">         // for now, optimistically assuming that everybody has full access, server will check:</span>
<a href="#l73.215"></a><span id="l73.215" class="difflineminus">-        var granted = calIWcapCalendar.AC_FULL;</span>
<a href="#l73.216"></a><span id="l73.216" class="difflineplus">+        let granted = calIWcapCalendar.AC_FULL;</span>
<a href="#l73.217"></a><span id="l73.217">         if (this.getProperty(&quot;readOnly&quot;)) {</span>
<a href="#l73.218"></a><span id="l73.218">             granted &amp;= ~(calIWcapCalendar.AC_COMP_WRITE |</span>
<a href="#l73.219"></a><span id="l73.219">                          calIWcapCalendar.AC_PROP_WRITE);</span>
<a href="#l73.220"></a><span id="l73.220">         }</span>
<a href="#l73.221"></a><span id="l73.221">         // check whether every bit fits:</span>
<a href="#l73.222"></a><span id="l73.222">         return ((accessControlBits &amp; granted) == accessControlBits);</span>
<a href="#l73.223"></a><span id="l73.223">     },</span>
<a href="#l73.224"></a><span id="l73.224"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -21,38 +21,38 @@ function calWcapCalendar_encodeAttendee(</span>
<a href="#l74.4"></a><span id="l74.4">             }</span>
<a href="#l74.5"></a><span id="l74.5">             params += encodeURIComponent(val);</span>
<a href="#l74.6"></a><span id="l74.6">         }</span>
<a href="#l74.7"></a><span id="l74.7">         return params;</span>
<a href="#l74.8"></a><span id="l74.8">     }</span>
<a href="#l74.9"></a><span id="l74.9">     let params = encodeAttr(att.rsvp, &quot;RSVP&quot;, &quot;&quot;);</span>
<a href="#l74.10"></a><span id="l74.10">     params = encodeAttr(att.participationStatus, &quot;PARTSTAT&quot;, params);</span>
<a href="#l74.11"></a><span id="l74.11">     params = encodeAttr(att.role, &quot;ROLE&quot;, params);</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-    var cn = att.commonName;</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+    let cn = att.commonName;</span>
<a href="#l74.14"></a><span id="l74.14">     if (cn) {</span>
<a href="#l74.15"></a><span id="l74.15">         params = encodeAttr(cn.replace(/[;:]/g, &quot; &quot;), &quot;CN&quot;, params); // remove ';' and ':' from CN</span>
<a href="#l74.16"></a><span id="l74.16">     }</span>
<a href="#l74.17"></a><span id="l74.17">     return encodeAttr(att.id, null, params);</span>
<a href="#l74.18"></a><span id="l74.18"> };</span>
<a href="#l74.19"></a><span id="l74.19"> </span>
<a href="#l74.20"></a><span id="l74.20"> calWcapCalendar.prototype.getRecurrenceParams =</span>
<a href="#l74.21"></a><span id="l74.21"> function calWcapCalendar_getRecurrenceParams(item, out_rrules, out_rdates, out_exrules, out_exdates) {</span>
<a href="#l74.22"></a><span id="l74.22">     // recurrences:</span>
<a href="#l74.23"></a><span id="l74.23">     out_rrules.value = [];</span>
<a href="#l74.24"></a><span id="l74.24">     out_rdates.value = [];</span>
<a href="#l74.25"></a><span id="l74.25">     out_exrules.value = [];</span>
<a href="#l74.26"></a><span id="l74.26">     out_exdates.value = [];</span>
<a href="#l74.27"></a><span id="l74.27">     if (item.recurrenceInfo) {</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineminus">-        var rItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineminus">-        for (var rItem of rItems) {</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineminus">-            var isNeg = rItem.isNegative;</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+        let rItems = item.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineplus">+        for (let rItem of rItems) {</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineplus">+            let isNeg = rItem.isNegative;</span>
<a href="#l74.34"></a><span id="l74.34">             let rRuleInstance = cal.wrapInstance(rItem, Components.interfaces.calIRecurrenceRule);</span>
<a href="#l74.35"></a><span id="l74.35">             let rDateInstance = cal.wrapInstance(rItem, Components.interfaces.calIRecurrenceDate);</span>
<a href="#l74.36"></a><span id="l74.36">             if (rRuleInstance) {</span>
<a href="#l74.37"></a><span id="l74.37" class="difflineminus">-                var rule = (&quot;\&quot;&quot; + encodeURIComponent(rRuleInstance.icalProperty.valueAsIcalString) + &quot;\&quot;&quot;);</span>
<a href="#l74.38"></a><span id="l74.38" class="difflineplus">+                let rule = (&quot;\&quot;&quot; + encodeURIComponent(rRuleInstance.icalProperty.valueAsIcalString) + &quot;\&quot;&quot;);</span>
<a href="#l74.39"></a><span id="l74.39">                 if (isNeg) {</span>
<a href="#l74.40"></a><span id="l74.40">                     out_exrules.value.push(rule);</span>
<a href="#l74.41"></a><span id="l74.41">                 } else {</span>
<a href="#l74.42"></a><span id="l74.42">                     out_rrules.value.push(rule);</span>
<a href="#l74.43"></a><span id="l74.43">                 }</span>
<a href="#l74.44"></a><span id="l74.44">             } else if (rDateInstance) {</span>
<a href="#l74.45"></a><span id="l74.45">                 // cs does not accept DATEs here:</span>
<a href="#l74.46"></a><span id="l74.46">                 if (isNeg) {</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineat">@@ -73,20 +73,20 @@ function sameStringSet(list, list_) {</span>
<a href="#l74.48"></a><span id="l74.48">             list.every(function everyFunc(x) {</span>
<a href="#l74.49"></a><span id="l74.49">                     return list_.some(</span>
<a href="#l74.50"></a><span id="l74.50">                         function someFunc(y) { return x == y; });</span>
<a href="#l74.51"></a><span id="l74.51">                 }));</span>
<a href="#l74.52"></a><span id="l74.52"> }</span>
<a href="#l74.53"></a><span id="l74.53"> </span>
<a href="#l74.54"></a><span id="l74.54"> calWcapCalendar.prototype.encodeRecurrenceParams =</span>
<a href="#l74.55"></a><span id="l74.55">     function calWcapCalendar_encodeRecurrenceParams(item, oldItem, excludeExdates) {</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineminus">-    var rrules = {};</span>
<a href="#l74.57"></a><span id="l74.57" class="difflineminus">-    var rdates = {};</span>
<a href="#l74.58"></a><span id="l74.58" class="difflineminus">-    var exrules = {};</span>
<a href="#l74.59"></a><span id="l74.59" class="difflineminus">-    var exdates = {};</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineplus">+    let rrules = {};</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineplus">+    let rdates = {};</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineplus">+    let exrules = {};</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+    let exdates = {};</span>
<a href="#l74.64"></a><span id="l74.64">     this.getRecurrenceParams(item, rrules, rdates, exrules, exdates);</span>
<a href="#l74.65"></a><span id="l74.65">     if (oldItem) {</span>
<a href="#l74.66"></a><span id="l74.66">         // actually only write changes if an old item has been changed, because</span>
<a href="#l74.67"></a><span id="l74.67">         // cs recreates the whole series if a rule has changed.</span>
<a href="#l74.68"></a><span id="l74.68">         // xxx todo: one problem is left when a master only holds EXDATEs,</span>
<a href="#l74.69"></a><span id="l74.69">         //           and effectively no item is present anymore.</span>
<a href="#l74.70"></a><span id="l74.70">         //           cs seems not to clean up automatically, but it does when</span>
<a href="#l74.71"></a><span id="l74.71">         //           when deleting an occurrence {id, rec-id}!</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineat">@@ -94,37 +94,37 @@ calWcapCalendar.prototype.encodeRecurren</span>
<a href="#l74.73"></a><span id="l74.73">         //           does not directly call deleteItem rather than modifyItem,</span>
<a href="#l74.74"></a><span id="l74.74">         //           which leads to a much cleaner usage.</span>
<a href="#l74.75"></a><span id="l74.75">         //           I assume this mimic has been chosen for easier undo/redo</span>
<a href="#l74.76"></a><span id="l74.76">         //           support (Undo would then have to distinguish whether</span>
<a href="#l74.77"></a><span id="l74.77">         //           it has previously deleted an occurrence or ordinary item:</span>
<a href="#l74.78"></a><span id="l74.78">         //            - entering an exception again</span>
<a href="#l74.79"></a><span id="l74.79">         //            - or adding an item)</span>
<a href="#l74.80"></a><span id="l74.80">         //           Currently it can just modifyItem(newItem/oldItem) back.</span>
<a href="#l74.81"></a><span id="l74.81" class="difflineminus">-        var rrules_ = {};</span>
<a href="#l74.82"></a><span id="l74.82" class="difflineminus">-        var rdates_ = {};</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineminus">-        var exrules_ = {};</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineminus">-        var exdates_ = {};</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineplus">+        let rrules_ = {};</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineplus">+        let rdates_ = {};</span>
<a href="#l74.87"></a><span id="l74.87" class="difflineplus">+        let exrules_ = {};</span>
<a href="#l74.88"></a><span id="l74.88" class="difflineplus">+        let exdates_ = {};</span>
<a href="#l74.89"></a><span id="l74.89">         this.getRecurrenceParams(oldItem, rrules_, rdates_, exrules_, exdates_);</span>
<a href="#l74.90"></a><span id="l74.90"> </span>
<a href="#l74.91"></a><span id="l74.91">         if (sameStringSet(rrules.value, rrules_.value)) {</span>
<a href="#l74.92"></a><span id="l74.92">             rrules.value = null; // don't write</span>
<a href="#l74.93"></a><span id="l74.93">         }</span>
<a href="#l74.94"></a><span id="l74.94">         if (sameStringSet(rdates.value, rdates_.value)) {</span>
<a href="#l74.95"></a><span id="l74.95">             rdates.value = null; // don't write</span>
<a href="#l74.96"></a><span id="l74.96">         }</span>
<a href="#l74.97"></a><span id="l74.97">         if (sameStringSet(exrules.value, exrules.value)) {</span>
<a href="#l74.98"></a><span id="l74.98">             exrules.value = null; // don't write</span>
<a href="#l74.99"></a><span id="l74.99">         }</span>
<a href="#l74.100"></a><span id="l74.100">         if (excludeExdates || sameStringSet(exdates.value, exdates_.value)) {</span>
<a href="#l74.101"></a><span id="l74.101">             exdates.value = null; // don't write</span>
<a href="#l74.102"></a><span id="l74.102">         }</span>
<a href="#l74.103"></a><span id="l74.103">     }</span>
<a href="#l74.104"></a><span id="l74.104"> </span>
<a href="#l74.105"></a><span id="l74.105" class="difflineminus">-    var ret = &quot;&quot;;</span>
<a href="#l74.106"></a><span id="l74.106" class="difflineplus">+    let ret = &quot;&quot;;</span>
<a href="#l74.107"></a><span id="l74.107">     if (rrules.value) {</span>
<a href="#l74.108"></a><span id="l74.108">         ret += (&quot;&amp;rrules=&quot; + rrules.value.join(&quot;;&quot;));</span>
<a href="#l74.109"></a><span id="l74.109">     }</span>
<a href="#l74.110"></a><span id="l74.110">     if (rdates.value) {</span>
<a href="#l74.111"></a><span id="l74.111">         ret += (&quot;&amp;rdates=&quot; + rdates.value.join(&quot;;&quot;));</span>
<a href="#l74.112"></a><span id="l74.112">     }</span>
<a href="#l74.113"></a><span id="l74.113">     if (exrules.value) {</span>
<a href="#l74.114"></a><span id="l74.114">         ret += (&quot;&amp;exrules=&quot; + exrules.value.join(&quot;;&quot;));</span>
<a href="#l74.115"></a><span id="l74.115" class="difflineat">@@ -179,55 +179,55 @@ function calWcapCalendar_getAlarmParams(</span>
<a href="#l74.116"></a><span id="l74.116"> </span>
<a href="#l74.117"></a><span id="l74.117"> // why ever, X-S1CS-EMAIL is unsupported though documented</span>
<a href="#l74.118"></a><span id="l74.118"> // for get_calprops... WTF.</span>
<a href="#l74.119"></a><span id="l74.119"> function getCalId(att) {</span>
<a href="#l74.120"></a><span id="l74.120">     return (att ? att.getProperty(&quot;X-S1CS-CALID&quot;) : null);</span>
<a href="#l74.121"></a><span id="l74.121"> }</span>
<a href="#l74.122"></a><span id="l74.122"> </span>
<a href="#l74.123"></a><span id="l74.123"> function getAttendeeByCalId(atts, calId) {</span>
<a href="#l74.124"></a><span id="l74.124" class="difflineminus">-    for (var att of atts) {</span>
<a href="#l74.125"></a><span id="l74.125" class="difflineplus">+    for (let att of atts) {</span>
<a href="#l74.126"></a><span id="l74.126">         if (getCalId(att) == calId) {</span>
<a href="#l74.127"></a><span id="l74.127">             return att;</span>
<a href="#l74.128"></a><span id="l74.128">         }</span>
<a href="#l74.129"></a><span id="l74.129">     }</span>
<a href="#l74.130"></a><span id="l74.130">     return null;</span>
<a href="#l74.131"></a><span id="l74.131"> }</span>
<a href="#l74.132"></a><span id="l74.132"> </span>
<a href="#l74.133"></a><span id="l74.133"> calWcapCalendar.prototype.isInvitation =</span>
<a href="#l74.134"></a><span id="l74.134"> function calWcapCalendar_isInvitation(item) {</span>
<a href="#l74.135"></a><span id="l74.135">     if (!this.session.isLoggedIn) {</span>
<a href="#l74.136"></a><span id="l74.136">         return false; // don't know</span>
<a href="#l74.137"></a><span id="l74.137">     }</span>
<a href="#l74.138"></a><span id="l74.138" class="difflineminus">-    var calId = this.calId;</span>
<a href="#l74.139"></a><span id="l74.139" class="difflineminus">-    var orgCalId = getCalId(item.organizer);</span>
<a href="#l74.140"></a><span id="l74.140" class="difflineplus">+    let calId = this.calId;</span>
<a href="#l74.141"></a><span id="l74.141" class="difflineplus">+    let orgCalId = getCalId(item.organizer);</span>
<a href="#l74.142"></a><span id="l74.142">     if (!orgCalId || (orgCalId == calId)) {</span>
<a href="#l74.143"></a><span id="l74.143">         return false;</span>
<a href="#l74.144"></a><span id="l74.144">     }</span>
<a href="#l74.145"></a><span id="l74.145">     return (this.getInvitedAttendee(item) != null);</span>
<a href="#l74.146"></a><span id="l74.146"> };</span>
<a href="#l74.147"></a><span id="l74.147"> </span>
<a href="#l74.148"></a><span id="l74.148"> calWcapCalendar.prototype.getInvitedAttendee =</span>
<a href="#l74.149"></a><span id="l74.149"> function calWcapCalendar_getInvitedAttendee(item) {</span>
<a href="#l74.150"></a><span id="l74.150" class="difflineminus">-    var att = getAttendeeByCalId(item.getAttendees({}), this.calId);</span>
<a href="#l74.151"></a><span id="l74.151" class="difflineplus">+    let att = getAttendeeByCalId(item.getAttendees({}), this.calId);</span>
<a href="#l74.152"></a><span id="l74.152">     if (!att) { // try to find mail address</span>
<a href="#l74.153"></a><span id="l74.153" class="difflineminus">-        var ar = this.session.getUserPreferences(&quot;X-NSCP-WCAP-PREF-mail&quot;);</span>
<a href="#l74.154"></a><span id="l74.154" class="difflineplus">+        let ar = this.session.getUserPreferences(&quot;X-NSCP-WCAP-PREF-mail&quot;);</span>
<a href="#l74.155"></a><span id="l74.155">         if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l74.156"></a><span id="l74.156">             att = item.getAttendeeById(&quot;mailto:&quot; + ar[0]);</span>
<a href="#l74.157"></a><span id="l74.157">         }</span>
<a href="#l74.158"></a><span id="l74.158">     }</span>
<a href="#l74.159"></a><span id="l74.159">     return att;</span>
<a href="#l74.160"></a><span id="l74.160"> };</span>
<a href="#l74.161"></a><span id="l74.161"> </span>
<a href="#l74.162"></a><span id="l74.162"> calWcapCalendar.prototype.canNotify =</span>
<a href="#l74.163"></a><span id="l74.163"> function calWcapCalendar_canNotify(method, item) {</span>
<a href="#l74.164"></a><span id="l74.164">     if (!this.session.isLoggedIn) {</span>
<a href="#l74.165"></a><span id="l74.165">         return false;</span>
<a href="#l74.166"></a><span id="l74.166">     }</span>
<a href="#l74.167"></a><span id="l74.167" class="difflineminus">-    var calId = this.calId;</span>
<a href="#l74.168"></a><span id="l74.168" class="difflineplus">+    let calId = this.calId;</span>
<a href="#l74.169"></a><span id="l74.169">     switch (method) {</span>
<a href="#l74.170"></a><span id="l74.170">         case &quot;REQUEST&quot;:</span>
<a href="#l74.171"></a><span id="l74.171">         case &quot;CANCEL&quot;:</span>
<a href="#l74.172"></a><span id="l74.172">             // when creating new items, mind that organizer's id</span>
<a href="#l74.173"></a><span id="l74.173">             return (!item.organizer || // might yet not be set</span>
<a href="#l74.174"></a><span id="l74.174">                     (item.organizer.id == calId) || // or is set to raw calId</span>
<a href="#l74.175"></a><span id="l74.175">                     (getCalId(item.organizer) == calId));</span>
<a href="#l74.176"></a><span id="l74.176">         case &quot;REPLY&quot;: // only if we we're invited from cs, and find matching X-S1CS-CALID:</span>
<a href="#l74.177"></a><span id="l74.177" class="difflineat">@@ -247,18 +247,18 @@ function equalDatetimes(one, two) {</span>
<a href="#l74.178"></a><span id="l74.178"> function identicalDatetimes(one, two) {</span>
<a href="#l74.179"></a><span id="l74.179">     return ((!one &amp;&amp; !two) ||</span>
<a href="#l74.180"></a><span id="l74.180">             (equalDatetimes(one, two) &amp;&amp;</span>
<a href="#l74.181"></a><span id="l74.181">              compareObjects(one.timezone, two.timezone)));</span>
<a href="#l74.182"></a><span id="l74.182"> }</span>
<a href="#l74.183"></a><span id="l74.183"> </span>
<a href="#l74.184"></a><span id="l74.184"> // @return null if nothing has changed else value to be written</span>
<a href="#l74.185"></a><span id="l74.185"> function diffProperty(newItem, oldItem, propName) {</span>
<a href="#l74.186"></a><span id="l74.186" class="difflineminus">-    var val = newItem.getProperty(propName);</span>
<a href="#l74.187"></a><span id="l74.187" class="difflineminus">-    var oldVal = (oldItem ? oldItem.getProperty(propName) : null);</span>
<a href="#l74.188"></a><span id="l74.188" class="difflineplus">+    let val = newItem.getProperty(propName);</span>
<a href="#l74.189"></a><span id="l74.189" class="difflineplus">+    let oldVal = (oldItem ? oldItem.getProperty(propName) : null);</span>
<a href="#l74.190"></a><span id="l74.190">     if (val === null) {</span>
<a href="#l74.191"></a><span id="l74.191">         // force being set when - no old item, eg when adding new item</span>
<a href="#l74.192"></a><span id="l74.192">         //                      - property is to be deleted</span>
<a href="#l74.193"></a><span id="l74.193">         if (!oldItem || oldVal) {</span>
<a href="#l74.194"></a><span id="l74.194">             val = &quot;&quot;;</span>
<a href="#l74.195"></a><span id="l74.195">         }</span>
<a href="#l74.196"></a><span id="l74.196">     } else {</span>
<a href="#l74.197"></a><span id="l74.197">         val = val.replace(/(\r\n)|\n/g, &quot;\r\n&quot;);</span>
<a href="#l74.198"></a><span id="l74.198" class="difflineat">@@ -300,51 +300,51 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.199"></a><span id="l74.199">         cats = cats.concat([]);</span>
<a href="#l74.200"></a><span id="l74.200">         cats.sort();</span>
<a href="#l74.201"></a><span id="l74.201">         return cats.join(&quot;;&quot;);</span>
<a href="#l74.202"></a><span id="l74.202">     }</span>
<a href="#l74.203"></a><span id="l74.203">     function getPrivacy(pitem) {</span>
<a href="#l74.204"></a><span id="l74.204">         return ((pitem.privacy &amp;&amp; pitem.privacy != &quot;&quot;) ? pitem.privacy : &quot;PUBLIC&quot;);</span>
<a href="#l74.205"></a><span id="l74.205">     }</span>
<a href="#l74.206"></a><span id="l74.206">     function getAttachments(attitem) {</span>
<a href="#l74.207"></a><span id="l74.207" class="difflineminus">-        var ret;</span>
<a href="#l74.208"></a><span id="l74.208" class="difflineminus">-        var attachments = attitem.attachments;</span>
<a href="#l74.209"></a><span id="l74.209" class="difflineplus">+        let ret;</span>
<a href="#l74.210"></a><span id="l74.210" class="difflineplus">+        let attachments = attitem.attachments;</span>
<a href="#l74.211"></a><span id="l74.211">         if (attachments) {</span>
<a href="#l74.212"></a><span id="l74.212" class="difflineminus">-            var strings = [];</span>
<a href="#l74.213"></a><span id="l74.213" class="difflineminus">-            for (var att of attachments) {</span>
<a href="#l74.214"></a><span id="l74.214" class="difflineplus">+            let strings = [];</span>
<a href="#l74.215"></a><span id="l74.215" class="difflineplus">+            for (let att of attachments) {</span>
<a href="#l74.216"></a><span id="l74.216">                 let wrappedAtt = cal.wrapInstance(att, Components.interfaces.calIAttachment);</span>
<a href="#l74.217"></a><span id="l74.217">                 if (typeof att == &quot;string&quot;) {</span>
<a href="#l74.218"></a><span id="l74.218">                     strings.push(encodeURIComponent(att));</span>
<a href="#l74.219"></a><span id="l74.219">                 } else if (wrappedAtt &amp;&amp; wrappedAtt.uri) {</span>
<a href="#l74.220"></a><span id="l74.220">                     strings.push(encodeURIComponent(wrappedAtt.uri.spec));</span>
<a href="#l74.221"></a><span id="l74.221">                 } else { // xxx todo</span>
<a href="#l74.222"></a><span id="l74.222">                     logError(&quot;only URLs supported as attachment, not: &quot; + att, this_);</span>
<a href="#l74.223"></a><span id="l74.223">                 }</span>
<a href="#l74.224"></a><span id="l74.224">             }</span>
<a href="#l74.225"></a><span id="l74.225">             strings.sort();</span>
<a href="#l74.226"></a><span id="l74.226">             ret = strings.join(&quot;;&quot;);</span>
<a href="#l74.227"></a><span id="l74.227">         }</span>
<a href="#l74.228"></a><span id="l74.228">         return ret || &quot;&quot;;</span>
<a href="#l74.229"></a><span id="l74.229">     }</span>
<a href="#l74.230"></a><span id="l74.230"> </span>
<a href="#l74.231"></a><span id="l74.231" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.232"></a><span id="l74.232" class="difflineminus">-    var bIsEvent = isEvent(item);</span>
<a href="#l74.233"></a><span id="l74.233" class="difflineminus">-    var bIsParent = isParent(item);</span>
<a href="#l74.234"></a><span id="l74.234" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.235"></a><span id="l74.235" class="difflineplus">+    let bIsEvent = isEvent(item);</span>
<a href="#l74.236"></a><span id="l74.236" class="difflineplus">+    let bIsParent = isParent(item);</span>
<a href="#l74.237"></a><span id="l74.237"> </span>
<a href="#l74.238"></a><span id="l74.238" class="difflineminus">-    var method = METHOD_PUBLISH;</span>
<a href="#l74.239"></a><span id="l74.239" class="difflineminus">-    var bNoSmtpNotify = false;</span>
<a href="#l74.240"></a><span id="l74.240" class="difflineminus">-    var params = &quot;&quot;;</span>
<a href="#l74.241"></a><span id="l74.241" class="difflineplus">+    let method = METHOD_PUBLISH;</span>
<a href="#l74.242"></a><span id="l74.242" class="difflineplus">+    let bNoSmtpNotify = false;</span>
<a href="#l74.243"></a><span id="l74.243" class="difflineplus">+    let params = &quot;&quot;;</span>
<a href="#l74.244"></a><span id="l74.244"> </span>
<a href="#l74.245"></a><span id="l74.245" class="difflineminus">-    var calId = this.calId;</span>
<a href="#l74.246"></a><span id="l74.246" class="difflineplus">+    let calId = this.calId;</span>
<a href="#l74.247"></a><span id="l74.247">     if (!bAddItem &amp;&amp; this.isInvitation(item)) { // REPLY</span>
<a href="#l74.248"></a><span id="l74.248">         method = METHOD_REPLY;</span>
<a href="#l74.249"></a><span id="l74.249" class="difflineminus">-        var att = getAttendeeByCalId(item.getAttendees({}), calId);</span>
<a href="#l74.250"></a><span id="l74.250" class="difflineplus">+        let att = getAttendeeByCalId(item.getAttendees({}), calId);</span>
<a href="#l74.251"></a><span id="l74.251">         if (att) {</span>
<a href="#l74.252"></a><span id="l74.252">             log(&quot;attendee: &quot; + att.icalProperty.icalString, this);</span>
<a href="#l74.253"></a><span id="l74.253" class="difflineminus">-            var oldAtt = null;</span>
<a href="#l74.254"></a><span id="l74.254" class="difflineplus">+            let oldAtt = null;</span>
<a href="#l74.255"></a><span id="l74.255">             if (oldItem) {</span>
<a href="#l74.256"></a><span id="l74.256">                 oldAtt = getAttendeeByCalId(oldItem.getAttendees({}), calId);</span>
<a href="#l74.257"></a><span id="l74.257">             }</span>
<a href="#l74.258"></a><span id="l74.258">             if (!oldAtt || (att.participationStatus != oldAtt.participationStatus)) {</span>
<a href="#l74.259"></a><span id="l74.259">                 // REPLY first for just this calendar:</span>
<a href="#l74.260"></a><span id="l74.260">                 params += (&quot;&amp;attendees=PARTSTAT=&quot; + att.participationStatus +</span>
<a href="#l74.261"></a><span id="l74.261">                            &quot;^&quot; + encodeURIComponent(att.id));</span>
<a href="#l74.262"></a><span id="l74.262">             }</span>
<a href="#l74.263"></a><span id="l74.263" class="difflineat">@@ -353,18 +353,18 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.264"></a><span id="l74.264">         // workarounds for server bugs concerning recurrences/exceptions:</span>
<a href="#l74.265"></a><span id="l74.265">         // - if first occurrence is an exception</span>
<a href="#l74.266"></a><span id="l74.266">         //   and an EXDATE for that occurrence ought to be written,</span>
<a href="#l74.267"></a><span id="l74.267">         //   then the master item's data is replaced with that EXDATEd exception. WTF.</span>
<a href="#l74.268"></a><span id="l74.268">         // - if start/end date is being written on master, the previously EXDATEd</span>
<a href="#l74.269"></a><span id="l74.269">         //   exception overwrites master, why ever.</span>
<a href="#l74.270"></a><span id="l74.270">         // So in these cases: write all data of master.</span>
<a href="#l74.271"></a><span id="l74.271"> </span>
<a href="#l74.272"></a><span id="l74.272" class="difflineminus">-        var bIsAllDay = false;</span>
<a href="#l74.273"></a><span id="l74.273" class="difflineminus">-        var dtstart, dtend;</span>
<a href="#l74.274"></a><span id="l74.274" class="difflineplus">+        let bIsAllDay = false;</span>
<a href="#l74.275"></a><span id="l74.275" class="difflineplus">+        let dtstart, dtend;</span>
<a href="#l74.276"></a><span id="l74.276">         if (bIsEvent) {</span>
<a href="#l74.277"></a><span id="l74.277">             dtstart = item.startDate;</span>
<a href="#l74.278"></a><span id="l74.278">             dtend = item.endDate;</span>
<a href="#l74.279"></a><span id="l74.279">             bIsAllDay = (dtstart.isDate &amp;&amp; dtend.isDate);</span>
<a href="#l74.280"></a><span id="l74.280">             if (!oldItem || !identicalDatetimes(dtstart, oldItem.startDate)</span>
<a href="#l74.281"></a><span id="l74.281">                          || !identicalDatetimes(dtend, oldItem.endDate)) {</span>
<a href="#l74.282"></a><span id="l74.282">                 params += (&quot;&amp;dtstart=&quot; + getIcalUTC(dtstart)); // timezone will be set with tzid param</span>
<a href="#l74.283"></a><span id="l74.283">                 params += (&quot;&amp;dtend=&quot; + getIcalUTC(dtend));</span>
<a href="#l74.284"></a><span id="l74.284" class="difflineat">@@ -393,35 +393,35 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.285"></a><span id="l74.285">                 params += (bIsAllDay ? &quot;&amp;isAllDay=1&quot; : &quot;&amp;isAllDay=0&quot;);</span>
<a href="#l74.286"></a><span id="l74.286"> </span>
<a href="#l74.287"></a><span id="l74.287">                 if (bIsParent &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l74.288"></a><span id="l74.288">                     oldItem = null; // recurrence/exceptions hack: write whole master</span>
<a href="#l74.289"></a><span id="l74.289">                 }</span>
<a href="#l74.290"></a><span id="l74.290">             }</span>
<a href="#l74.291"></a><span id="l74.291">         }</span>
<a href="#l74.292"></a><span id="l74.292">         if (bIsParent) {</span>
<a href="#l74.293"></a><span id="l74.293" class="difflineminus">-            var recParams = this.encodeRecurrenceParams(item, oldItem, !bAddItem /* exclude EXDATEs */);</span>
<a href="#l74.294"></a><span id="l74.294" class="difflineplus">+            let recParams = this.encodeRecurrenceParams(item, oldItem, !bAddItem /* exclude EXDATEs */);</span>
<a href="#l74.295"></a><span id="l74.295">             if (recParams.length &gt; 0) {</span>
<a href="#l74.296"></a><span id="l74.296">                 oldItem = null; // recurrence/exceptions hack: write whole master</span>
<a href="#l74.297"></a><span id="l74.297">                 params += recParams;</span>
<a href="#l74.298"></a><span id="l74.298">             }</span>
<a href="#l74.299"></a><span id="l74.299">         }</span>
<a href="#l74.300"></a><span id="l74.300"> </span>
<a href="#l74.301"></a><span id="l74.301" class="difflineminus">-        var orgCalId = getCalId(item.organizer);</span>
<a href="#l74.302"></a><span id="l74.302" class="difflineplus">+        let orgCalId = getCalId(item.organizer);</span>
<a href="#l74.303"></a><span id="l74.303">         if (!orgCalId) { // new events yet don't have X-S1CS-CALID set on ORGANIZER or this is outbound iTIP</span>
<a href="#l74.304"></a><span id="l74.304" class="difflineminus">-            var orgId = getOrgId(item);</span>
<a href="#l74.305"></a><span id="l74.305" class="difflineplus">+            let orgId = getOrgId(item);</span>
<a href="#l74.306"></a><span id="l74.306">             if (!orgId || (orgId.toLowerCase().replace(/^mailto:/, &quot;&quot;) == this.ownerId.toLowerCase())) {</span>
<a href="#l74.307"></a><span id="l74.307">                 orgCalId = calId; // own event</span>
<a href="#l74.308"></a><span id="l74.308">             } // else outbound</span>
<a href="#l74.309"></a><span id="l74.309">         }</span>
<a href="#l74.310"></a><span id="l74.310"> </span>
<a href="#l74.311"></a><span id="l74.311" class="difflineminus">-        var attendees = item.getAttendees({});</span>
<a href="#l74.312"></a><span id="l74.312" class="difflineplus">+        let attendees = item.getAttendees({});</span>
<a href="#l74.313"></a><span id="l74.313">         if (attendees.length &gt; 0) {</span>
<a href="#l74.314"></a><span id="l74.314">             // xxx todo: why ever, X-S1CS-EMAIL is unsupported though documented for calprops... WTF.</span>
<a href="#l74.315"></a><span id="l74.315" class="difflineminus">-            var attParam = encodeAttendees(attendees);</span>
<a href="#l74.316"></a><span id="l74.316" class="difflineplus">+            let attParam = encodeAttendees(attendees);</span>
<a href="#l74.317"></a><span id="l74.317">             if (!oldItem || attParam != encodeAttendees(oldItem.getAttendees({}))) {</span>
<a href="#l74.318"></a><span id="l74.318">                 params += (&quot;&amp;attendees=&quot; + attParam);</span>
<a href="#l74.319"></a><span id="l74.319">             }</span>
<a href="#l74.320"></a><span id="l74.320"> </span>
<a href="#l74.321"></a><span id="l74.321">             if (orgCalId == calId) {</span>
<a href="#l74.322"></a><span id="l74.322">                 method = METHOD_REQUEST;</span>
<a href="#l74.323"></a><span id="l74.323">             } else {</span>
<a href="#l74.324"></a><span id="l74.324">                 method = METHOD_UPDATE;</span>
<a href="#l74.325"></a><span id="l74.325" class="difflineat">@@ -432,23 +432,23 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.326"></a><span id="l74.326">             params += &quot;&amp;attendees=&quot;; // clear attendees</span>
<a href="#l74.327"></a><span id="l74.327">         }</span>
<a href="#l74.328"></a><span id="l74.328"> </span>
<a href="#l74.329"></a><span id="l74.329">         if (orgCalId) {</span>
<a href="#l74.330"></a><span id="l74.330">             if (!oldItem || (orgCalId != getCalId(oldItem.organizer))) {</span>
<a href="#l74.331"></a><span id="l74.331">                 params += (&quot;&amp;orgCalid=&quot; + encodeURIComponent(orgCalId));</span>
<a href="#l74.332"></a><span id="l74.332">             }</span>
<a href="#l74.333"></a><span id="l74.333">         } else { // might be a copy of an iTIP invitation:</span>
<a href="#l74.334"></a><span id="l74.334" class="difflineminus">-            var orgEmail = getOrgId(item);</span>
<a href="#l74.335"></a><span id="l74.335" class="difflineplus">+            let orgEmail = getOrgId(item);</span>
<a href="#l74.336"></a><span id="l74.336">             if (!oldItem || (getOrgId(oldItem) != orgEmail)) {</span>
<a href="#l74.337"></a><span id="l74.337">                 params += (&quot;&amp;orgEmail=&quot; + encodeURIComponent(orgEmail));</span>
<a href="#l74.338"></a><span id="l74.338">             }</span>
<a href="#l74.339"></a><span id="l74.339">         }</span>
<a href="#l74.340"></a><span id="l74.340"> </span>
<a href="#l74.341"></a><span id="l74.341" class="difflineminus">-        var val = item.title;</span>
<a href="#l74.342"></a><span id="l74.342" class="difflineplus">+        let val = item.title;</span>
<a href="#l74.343"></a><span id="l74.343">         if (!oldItem || val != oldItem.title) {</span>
<a href="#l74.344"></a><span id="l74.344">             params += (&quot;&amp;summary=&quot; + encodeURIComponent(val));</span>
<a href="#l74.345"></a><span id="l74.345">         }</span>
<a href="#l74.346"></a><span id="l74.346"> </span>
<a href="#l74.347"></a><span id="l74.347">         let categories = item.getCategories({});</span>
<a href="#l74.348"></a><span id="l74.348">         let catParam = encodeCategories(categories);</span>
<a href="#l74.349"></a><span id="l74.349">         if (!oldItem || catParam != encodeCategories(oldItem.getCategories({}))) {</span>
<a href="#l74.350"></a><span id="l74.350">             params += (&quot;&amp;categories=&quot; + catParam);</span>
<a href="#l74.351"></a><span id="l74.351" class="difflineat">@@ -467,17 +467,17 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.352"></a><span id="l74.352">             params += (&quot;&amp;icsUrl=&quot; + encodeURIComponent(val));</span>
<a href="#l74.353"></a><span id="l74.353">         }</span>
<a href="#l74.354"></a><span id="l74.354">         // xxx todo: default prio is 0 (5 in sjs cs)</span>
<a href="#l74.355"></a><span id="l74.355">         val = item.priority;</span>
<a href="#l74.356"></a><span id="l74.356">         if (!oldItem || val != oldItem.priority) {</span>
<a href="#l74.357"></a><span id="l74.357">             params += (&quot;&amp;priority=&quot; + encodeURIComponent(val));</span>
<a href="#l74.358"></a><span id="l74.358">         }</span>
<a href="#l74.359"></a><span id="l74.359"> </span>
<a href="#l74.360"></a><span id="l74.360" class="difflineminus">-        var icsClass = getPrivacy(item);</span>
<a href="#l74.361"></a><span id="l74.361" class="difflineplus">+        let icsClass = getPrivacy(item);</span>
<a href="#l74.362"></a><span id="l74.362">         if (!oldItem || icsClass != getPrivacy(oldItem)) {</span>
<a href="#l74.363"></a><span id="l74.363">             params += (&quot;&amp;icsClass=&quot; + icsClass);</span>
<a href="#l74.364"></a><span id="l74.364">         }</span>
<a href="#l74.365"></a><span id="l74.365"> </span>
<a href="#l74.366"></a><span id="l74.366">         if (!oldItem || item.status != oldItem.status) {</span>
<a href="#l74.367"></a><span id="l74.367">             switch (item.status) {</span>
<a href="#l74.368"></a><span id="l74.368">                 case &quot;CONFIRMED&quot;: params += &quot;&amp;status=0&quot;; break;</span>
<a href="#l74.369"></a><span id="l74.369">                 case &quot;CANCELLED&quot;: params += &quot;&amp;status=1&quot;; break;</span>
<a href="#l74.370"></a><span id="l74.370" class="difflineat">@@ -519,34 +519,34 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.371"></a><span id="l74.371"> </span>
<a href="#l74.372"></a><span id="l74.372">         // attachment urls:</span>
<a href="#l74.373"></a><span id="l74.373">         val = getAttachments(item);</span>
<a href="#l74.374"></a><span id="l74.374">         if (!oldItem || val != getAttachments(oldItem)) {</span>
<a href="#l74.375"></a><span id="l74.375">             params += (&quot;&amp;attachments=&quot; + val);</span>
<a href="#l74.376"></a><span id="l74.376">         }</span>
<a href="#l74.377"></a><span id="l74.377">     } // PUBLISH, REQUEST</span>
<a href="#l74.378"></a><span id="l74.378"> </span>
<a href="#l74.379"></a><span id="l74.379" class="difflineminus">-    var alarmParams = this.getAlarmParams(item);</span>
<a href="#l74.380"></a><span id="l74.380" class="difflineplus">+    let alarmParams = this.getAlarmParams(item);</span>
<a href="#l74.381"></a><span id="l74.381">     if (!oldItem || (this.getAlarmParams(oldItem) != alarmParams)) {</span>
<a href="#l74.382"></a><span id="l74.382">         if ((method == METHOD_REQUEST) &amp;&amp; params.length == 0) {</span>
<a href="#l74.383"></a><span id="l74.383">             // assure no email notifications about this change:</span>
<a href="#l74.384"></a><span id="l74.384">             bNoSmtpNotify = true;</span>
<a href="#l74.385"></a><span id="l74.385">         }</span>
<a href="#l74.386"></a><span id="l74.386">         params += alarmParams;</span>
<a href="#l74.387"></a><span id="l74.387">     }</span>
<a href="#l74.388"></a><span id="l74.388"> </span>
<a href="#l74.389"></a><span id="l74.389">     if (params.length == 0) {</span>
<a href="#l74.390"></a><span id="l74.390">         log(&quot;no change at all.&quot;, this);</span>
<a href="#l74.391"></a><span id="l74.391">         if (LOG_LEVEL &gt; 2) {</span>
<a href="#l74.392"></a><span id="l74.392">             log(&quot;old item:\n&quot; + oldItem.icalString + &quot;\n\nnew item:\n&quot; + item.icalString, this);</span>
<a href="#l74.393"></a><span id="l74.393">         }</span>
<a href="#l74.394"></a><span id="l74.394">         request.execRespFunc(null, item);</span>
<a href="#l74.395"></a><span id="l74.395">     } else {</span>
<a href="#l74.396"></a><span id="l74.396">         // cs does not support separate timezones for start and end, just pick one for tzid param:</span>
<a href="#l74.397"></a><span id="l74.397" class="difflineminus">-        var someDate = (item.startDate || item.entryDate || item.dueDate);</span>
<a href="#l74.398"></a><span id="l74.398" class="difflineplus">+        let someDate = (item.startDate || item.entryDate || item.dueDate);</span>
<a href="#l74.399"></a><span id="l74.399">         if (someDate &amp;&amp; !someDate.timezone.isUTC) {</span>
<a href="#l74.400"></a><span id="l74.400">             params += (&quot;&amp;tzid=&quot; + encodeURIComponent(this.getAlignedTzid(someDate.timezone)));</span>
<a href="#l74.401"></a><span id="l74.401">         }</span>
<a href="#l74.402"></a><span id="l74.402"> </span>
<a href="#l74.403"></a><span id="l74.403">         if (item.id) {</span>
<a href="#l74.404"></a><span id="l74.404">             params += (&quot;&amp;uid=&quot; + encodeURIComponent(item.id));</span>
<a href="#l74.405"></a><span id="l74.405">         }</span>
<a href="#l74.406"></a><span id="l74.406"> </span>
<a href="#l74.407"></a><span id="l74.407" class="difflineat">@@ -571,23 +571,23 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l74.408"></a><span id="l74.408">         params += &quot;&amp;replace=1&quot;; // (update) don't append to any lists</span>
<a href="#l74.409"></a><span id="l74.409">         params += &quot;&amp;fetch=1&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l74.410"></a><span id="l74.410">         params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l74.411"></a><span id="l74.411"> </span>
<a href="#l74.412"></a><span id="l74.412">         let netRespFunc = (err, icalRootComp) =&gt; {</span>
<a href="#l74.413"></a><span id="l74.413">             if (err) {</span>
<a href="#l74.414"></a><span id="l74.414">                 throw err;</span>
<a href="#l74.415"></a><span id="l74.415">             }</span>
<a href="#l74.416"></a><span id="l74.416" class="difflineminus">-            var items = this.parseItems(icalRootComp, calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l74.417"></a><span id="l74.417" class="difflineplus">+            let items = this.parseItems(icalRootComp, calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l74.418"></a><span id="l74.418">                                         0, null, null, true /* bLeaveMutable */);</span>
<a href="#l74.419"></a><span id="l74.419">             if (items.length != 1) {</span>
<a href="#l74.420"></a><span id="l74.420">                 this.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l74.421"></a><span id="l74.421">                                  &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l74.422"></a><span id="l74.422">             }</span>
<a href="#l74.423"></a><span id="l74.423" class="difflineminus">-            var newItem = items[0];</span>
<a href="#l74.424"></a><span id="l74.424" class="difflineplus">+            let newItem = items[0];</span>
<a href="#l74.425"></a><span id="l74.425">             this.tunnelXProps(newItem, item);</span>
<a href="#l74.426"></a><span id="l74.426">             newItem.makeImmutable();</span>
<a href="#l74.427"></a><span id="l74.427">             // invalidate cached results:</span>
<a href="#l74.428"></a><span id="l74.428">             delete this.m_cachedResults;</span>
<a href="#l74.429"></a><span id="l74.429">             // xxx todo: may log request status</span>
<a href="#l74.430"></a><span id="l74.430">             request.execRespFunc(null, newItem);</span>
<a href="#l74.431"></a><span id="l74.431">         };</span>
<a href="#l74.432"></a><span id="l74.432">         this.issueNetworkRequest(request, netRespFunc, stringToIcal,</span>
<a href="#l74.433"></a><span id="l74.433" class="difflineat">@@ -604,18 +604,18 @@ function calWcapCalendar_tunnelXProps(de</span>
<a href="#l74.434"></a><span id="l74.434">         return;</span>
<a href="#l74.435"></a><span id="l74.435">     }</span>
<a href="#l74.436"></a><span id="l74.436">     // tunnel alarm X-MOZ-SNOOZE only if alarm is still set:</span>
<a href="#l74.437"></a><span id="l74.437">     // TODO ALARMSUPPORT still needed when showing alarms as EMAIL for wcap?</span>
<a href="#l74.438"></a><span id="l74.438">     let hasAlarms = destItem.getAlarms({}).length;</span>
<a href="#l74.439"></a><span id="l74.439">     let enumerator = srcItem.propertyEnumerator;</span>
<a href="#l74.440"></a><span id="l74.440">     while (enumerator.hasMoreElements()) {</span>
<a href="#l74.441"></a><span id="l74.441">         try {</span>
<a href="#l74.442"></a><span id="l74.442" class="difflineminus">-            var prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l74.443"></a><span id="l74.443" class="difflineminus">-            var name = prop.name;</span>
<a href="#l74.444"></a><span id="l74.444" class="difflineplus">+            let prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l74.445"></a><span id="l74.445" class="difflineplus">+            let name = prop.name;</span>
<a href="#l74.446"></a><span id="l74.446">             if (name.startsWith(&quot;X-MOZ-&quot;)) {</span>
<a href="#l74.447"></a><span id="l74.447">                 switch (name) {</span>
<a href="#l74.448"></a><span id="l74.448">                     // keep snooze stamps for occurrences only and if alarm is still set:</span>
<a href="#l74.449"></a><span id="l74.449">                     case &quot;X-MOZ-SNOOZE-TIME&quot;:</span>
<a href="#l74.450"></a><span id="l74.450">                         if (!hasAlarms) {</span>
<a href="#l74.451"></a><span id="l74.451">                             break; // alarm has been reset</span>
<a href="#l74.452"></a><span id="l74.452">                         }</span>
<a href="#l74.453"></a><span id="l74.453">                         // fallthru intended</span>
<a href="#l74.454"></a><span id="l74.454" class="difflineat">@@ -630,18 +630,18 @@ function calWcapCalendar_tunnelXProps(de</span>
<a href="#l74.455"></a><span id="l74.455">         } catch (exc) {</span>
<a href="#l74.456"></a><span id="l74.456">             logError(exc, this);</span>
<a href="#l74.457"></a><span id="l74.457">         }</span>
<a href="#l74.458"></a><span id="l74.458">     }</span>
<a href="#l74.459"></a><span id="l74.459"> };</span>
<a href="#l74.460"></a><span id="l74.460"> </span>
<a href="#l74.461"></a><span id="l74.461"> calWcapCalendar.prototype.adoptItem =</span>
<a href="#l74.462"></a><span id="l74.462"> function calWcapCalendar_adoptItem(item, listener) {</span>
<a href="#l74.463"></a><span id="l74.463" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.464"></a><span id="l74.464" class="difflineminus">-    var request = new calWcapRequest(</span>
<a href="#l74.465"></a><span id="l74.465" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.466"></a><span id="l74.466" class="difflineplus">+    let request = new calWcapRequest(</span>
<a href="#l74.467"></a><span id="l74.467">         function adoptItem_resp(oprequest, err, newItem) {</span>
<a href="#l74.468"></a><span id="l74.468">             this_.notifyOperationComplete(listener,</span>
<a href="#l74.469"></a><span id="l74.469">                                           getResultCode(err),</span>
<a href="#l74.470"></a><span id="l74.470">                                           calIOperationListener.ADD,</span>
<a href="#l74.471"></a><span id="l74.471">                                           err ? item.id : newItem.id,</span>
<a href="#l74.472"></a><span id="l74.472">                                           err ? err : newItem);</span>
<a href="#l74.473"></a><span id="l74.473">             if (!err &amp;&amp; this_ == this_.superCalendar) {</span>
<a href="#l74.474"></a><span id="l74.474">                 this_.notifyObservers(&quot;onAddItem&quot;, [newItem]);</span>
<a href="#l74.475"></a><span id="l74.475" class="difflineat">@@ -659,58 +659,58 @@ function calWcapCalendar_adoptItem(item,</span>
<a href="#l74.476"></a><span id="l74.476"> </span>
<a href="#l74.477"></a><span id="l74.477"> calWcapCalendar.prototype.addItem =</span>
<a href="#l74.478"></a><span id="l74.478"> function calWcapCalendar_addItem(item, listener) {</span>
<a href="#l74.479"></a><span id="l74.479">     this.adoptItem(item.clone(), listener);</span>
<a href="#l74.480"></a><span id="l74.480"> };</span>
<a href="#l74.481"></a><span id="l74.481"> </span>
<a href="#l74.482"></a><span id="l74.482"> calWcapCalendar.prototype.modifyItem =</span>
<a href="#l74.483"></a><span id="l74.483"> function calWcapCalendar_modifyItem(newItem, oldItem, listener) {</span>
<a href="#l74.484"></a><span id="l74.484" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.485"></a><span id="l74.485" class="difflineminus">-    var request = new calWcapRequest(</span>
<a href="#l74.486"></a><span id="l74.486" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.487"></a><span id="l74.487" class="difflineplus">+    let request = new calWcapRequest(</span>
<a href="#l74.488"></a><span id="l74.488">         function modifyItem_resp(oprequest, err, item) {</span>
<a href="#l74.489"></a><span id="l74.489">             this_.notifyOperationComplete(listener,</span>
<a href="#l74.490"></a><span id="l74.490">                                           getResultCode(err),</span>
<a href="#l74.491"></a><span id="l74.491">                                           calIOperationListener.MODIFY,</span>
<a href="#l74.492"></a><span id="l74.492">                                           newItem.id, err ? err : item);</span>
<a href="#l74.493"></a><span id="l74.493">             if (!err &amp;&amp; this_ == this_.superCalendar) {</span>
<a href="#l74.494"></a><span id="l74.494">                 this_.notifyObservers(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l74.495"></a><span id="l74.495">             }</span>
<a href="#l74.496"></a><span id="l74.496">         },</span>
<a href="#l74.497"></a><span id="l74.497">         log(&quot;modifyItem() call: &quot; + newItem.id, this));</span>
<a href="#l74.498"></a><span id="l74.498"> </span>
<a href="#l74.499"></a><span id="l74.499">     try {</span>
<a href="#l74.500"></a><span id="l74.500">         if (!newItem.id) {</span>
<a href="#l74.501"></a><span id="l74.501">             throw new Components.Exception(&quot;new item has no id!&quot;);</span>
<a href="#l74.502"></a><span id="l74.502">         }</span>
<a href="#l74.503"></a><span id="l74.503" class="difflineminus">-        var oldItem_ = oldItem;</span>
<a href="#l74.504"></a><span id="l74.504" class="difflineplus">+        let oldItem_ = oldItem;</span>
<a href="#l74.505"></a><span id="l74.505">         if (isParent(newItem)) {</span>
<a href="#l74.506"></a><span id="l74.506">             // Due to a cs bug, EXDATEs cannot be passed with store, thus make a two-step delete then store.</span>
<a href="#l74.507"></a><span id="l74.507">             // First check if EXDATEs are passed or have been modified:</span>
<a href="#l74.508"></a><span id="l74.508" class="difflineminus">-            var exdates = {};</span>
<a href="#l74.509"></a><span id="l74.509" class="difflineplus">+            let exdates = {};</span>
<a href="#l74.510"></a><span id="l74.510">             this.getRecurrenceParams(newItem, {}, {}, {}, exdates);</span>
<a href="#l74.511"></a><span id="l74.511">             if (oldItem) {</span>
<a href="#l74.512"></a><span id="l74.512" class="difflineminus">-                var exdates_ = {};</span>
<a href="#l74.513"></a><span id="l74.513" class="difflineplus">+                let exdates_ = {};</span>
<a href="#l74.514"></a><span id="l74.514">                 this.getRecurrenceParams(oldItem_, {}, {}, {}, exdates_);</span>
<a href="#l74.515"></a><span id="l74.515">                 // only use added elements</span>
<a href="#l74.516"></a><span id="l74.516">                 exdates.value = exdates.value.filter(</span>
<a href="#l74.517"></a><span id="l74.517">                     function(elem) { return !exdates_.value.some(function(elem_) { return elem_ == elem; }); });</span>
<a href="#l74.518"></a><span id="l74.518">             } // else in case no oldItem is passed, nevertheless try to delete the EXDATEs</span>
<a href="#l74.519"></a><span id="l74.519">             if (exdates.value.length &gt; 0) {</span>
<a href="#l74.520"></a><span id="l74.520" class="difflineminus">-                var params = &quot;&amp;uid=&quot;;</span>
<a href="#l74.521"></a><span id="l74.521" class="difflineplus">+                let params = &quot;&amp;uid=&quot;;</span>
<a href="#l74.522"></a><span id="l74.522">                 // all deletes on the same item:</span>
<a href="#l74.523"></a><span id="l74.523" class="difflineminus">-                for (var i = exdates.value.length; i--;) {</span>
<a href="#l74.524"></a><span id="l74.524" class="difflineplus">+                for (let i = exdates.value.length; i--;) {</span>
<a href="#l74.525"></a><span id="l74.525">                     params += encodeURIComponent(newItem.id);</span>
<a href="#l74.526"></a><span id="l74.526">                     if (i &gt; 0) {</span>
<a href="#l74.527"></a><span id="l74.527">                         params += &quot;;&quot;;</span>
<a href="#l74.528"></a><span id="l74.528">                     }</span>
<a href="#l74.529"></a><span id="l74.529">                 }</span>
<a href="#l74.530"></a><span id="l74.530">                 params += (&quot;&amp;mod=1&amp;rid=&quot; + exdates.value.join(&quot;;&quot;));</span>
<a href="#l74.531"></a><span id="l74.531"> </span>
<a href="#l74.532"></a><span id="l74.532" class="difflineminus">-                var orgCalId = getCalId(newItem.organizer);</span>
<a href="#l74.533"></a><span id="l74.533" class="difflineplus">+                let orgCalId = getCalId(newItem.organizer);</span>
<a href="#l74.534"></a><span id="l74.534">                 if (!orgCalId || (orgCalId != this.calId)) {</span>
<a href="#l74.535"></a><span id="l74.535">                     // item does not belong to this user, so don't notify:</span>
<a href="#l74.536"></a><span id="l74.536">                     params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l74.537"></a><span id="l74.537">                 }</span>
<a href="#l74.538"></a><span id="l74.538">                 params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l74.539"></a><span id="l74.539"> </span>
<a href="#l74.540"></a><span id="l74.540">                 request.lockPending();</span>
<a href="#l74.541"></a><span id="l74.541">                 this.issueNetworkRequest(request,</span>
<a href="#l74.542"></a><span id="l74.542" class="difflineat">@@ -740,43 +740,43 @@ function calWcapCalendar_modifyItem(newI</span>
<a href="#l74.543"></a><span id="l74.543">     } catch (exc) {</span>
<a href="#l74.544"></a><span id="l74.544">         request.execRespFunc(exc);</span>
<a href="#l74.545"></a><span id="l74.545">     }</span>
<a href="#l74.546"></a><span id="l74.546">     return request;</span>
<a href="#l74.547"></a><span id="l74.547"> };</span>
<a href="#l74.548"></a><span id="l74.548"> </span>
<a href="#l74.549"></a><span id="l74.549"> calWcapCalendar.prototype.deleteItem =</span>
<a href="#l74.550"></a><span id="l74.550"> function calWcapCalendar_deleteItem(item, listener) {</span>
<a href="#l74.551"></a><span id="l74.551" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.552"></a><span id="l74.552" class="difflineminus">-    var request = new calWcapRequest(</span>
<a href="#l74.553"></a><span id="l74.553" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.554"></a><span id="l74.554" class="difflineplus">+    let request = new calWcapRequest(</span>
<a href="#l74.555"></a><span id="l74.555">         function deleteItem_resp(oprequest, err) {</span>
<a href="#l74.556"></a><span id="l74.556">             // xxx todo: need to notify about each deleted item if multiple?</span>
<a href="#l74.557"></a><span id="l74.557">             this_.notifyOperationComplete(listener,</span>
<a href="#l74.558"></a><span id="l74.558">                                           getResultCode(err),</span>
<a href="#l74.559"></a><span id="l74.559">                                           calIOperationListener.DELETE,</span>
<a href="#l74.560"></a><span id="l74.560">                                           item.id, err ? err : item);</span>
<a href="#l74.561"></a><span id="l74.561">             if (!err &amp;&amp; this_ == this_.superCalendar) {</span>
<a href="#l74.562"></a><span id="l74.562">                 this_.notifyObservers(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l74.563"></a><span id="l74.563">             }</span>
<a href="#l74.564"></a><span id="l74.564">         },</span>
<a href="#l74.565"></a><span id="l74.565">         log(&quot;deleteItem() call: &quot; + item.id, this));</span>
<a href="#l74.566"></a><span id="l74.566"> </span>
<a href="#l74.567"></a><span id="l74.567">     try {</span>
<a href="#l74.568"></a><span id="l74.568">         if (!item.id) {</span>
<a href="#l74.569"></a><span id="l74.569">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l74.570"></a><span id="l74.570">         }</span>
<a href="#l74.571"></a><span id="l74.571" class="difflineminus">-        var params = (&quot;&amp;uid=&quot; + encodeURIComponent(item.id));</span>
<a href="#l74.572"></a><span id="l74.572" class="difflineplus">+        let params = (&quot;&amp;uid=&quot; + encodeURIComponent(item.id));</span>
<a href="#l74.573"></a><span id="l74.573">         if (isParent(item)) { // delete THIS AND ALL:</span>
<a href="#l74.574"></a><span id="l74.574">             params += &quot;&amp;mod=4&amp;rid=0&quot;;</span>
<a href="#l74.575"></a><span id="l74.575">         } else { // delete THIS INSTANCE:</span>
<a href="#l74.576"></a><span id="l74.576">             // cs does not accept DATE here:</span>
<a href="#l74.577"></a><span id="l74.577">             params += (&quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(ensureDateTime(item.recurrenceId)));</span>
<a href="#l74.578"></a><span id="l74.578">         }</span>
<a href="#l74.579"></a><span id="l74.579"> </span>
<a href="#l74.580"></a><span id="l74.580" class="difflineminus">-        var orgCalId = getCalId(item.organizer);</span>
<a href="#l74.581"></a><span id="l74.581" class="difflineplus">+        let orgCalId = getCalId(item.organizer);</span>
<a href="#l74.582"></a><span id="l74.582">         if (!orgCalId || (orgCalId != this.calId)) {</span>
<a href="#l74.583"></a><span id="l74.583">             // item does not belong to this user, so don't notify:</span>
<a href="#l74.584"></a><span id="l74.584">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l74.585"></a><span id="l74.585">         }</span>
<a href="#l74.586"></a><span id="l74.586"> </span>
<a href="#l74.587"></a><span id="l74.587">         params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l74.588"></a><span id="l74.588"> </span>
<a href="#l74.589"></a><span id="l74.589">         this.issueNetworkRequest(request,</span>
<a href="#l74.590"></a><span id="l74.590" class="difflineat">@@ -794,25 +794,25 @@ function calWcapCalendar_deleteItem(item</span>
<a href="#l74.591"></a><span id="l74.591">                                  params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l74.592"></a><span id="l74.592">     } catch (exc) {</span>
<a href="#l74.593"></a><span id="l74.593">         request.execRespFunc(exc);</span>
<a href="#l74.594"></a><span id="l74.594">     }</span>
<a href="#l74.595"></a><span id="l74.595">     return request;</span>
<a href="#l74.596"></a><span id="l74.596"> };</span>
<a href="#l74.597"></a><span id="l74.597"> </span>
<a href="#l74.598"></a><span id="l74.598"> calWcapCalendar.prototype.patchTimezone = function calWcapCalendar_patchTimezone(subComp, attr, xpropOrTz) {</span>
<a href="#l74.599"></a><span id="l74.599" class="difflineminus">-    var dt = subComp[attr];</span>
<a href="#l74.600"></a><span id="l74.600" class="difflineplus">+    let dt = subComp[attr];</span>
<a href="#l74.601"></a><span id="l74.601">     // if TZID parameter present (all-day items), it takes precedence:</span>
<a href="#l74.602"></a><span id="l74.602">     if (dt &amp;&amp; (dt.timezone.isUTC || dt.timezone.isFloating)) {</span>
<a href="#l74.603"></a><span id="l74.603">         if (LOG_LEVEL &gt; 2) {</span>
<a href="#l74.604"></a><span id="l74.604">             log(attr + &quot; is &quot; + dt, this);</span>
<a href="#l74.605"></a><span id="l74.605">         }</span>
<a href="#l74.606"></a><span id="l74.606" class="difflineminus">-        var tz;</span>
<a href="#l74.607"></a><span id="l74.607" class="difflineplus">+        let tz;</span>
<a href="#l74.608"></a><span id="l74.608">         if (typeof xpropOrTz == &quot;string&quot;) {</span>
<a href="#l74.609"></a><span id="l74.609" class="difflineminus">-            var tzid = subComp.getFirstProperty(xpropOrTz);</span>
<a href="#l74.610"></a><span id="l74.610" class="difflineplus">+            let tzid = subComp.getFirstProperty(xpropOrTz);</span>
<a href="#l74.611"></a><span id="l74.611">             if (tzid) {</span>
<a href="#l74.612"></a><span id="l74.612">                 tz = this.session.getTimezone(tzid.value);</span>
<a href="#l74.613"></a><span id="l74.613">                 ASSERT(tz, &quot;timezone not found: &quot; + tzid);</span>
<a href="#l74.614"></a><span id="l74.614">             }</span>
<a href="#l74.615"></a><span id="l74.615">         } else {</span>
<a href="#l74.616"></a><span id="l74.616">             tz = xpropOrTz;</span>
<a href="#l74.617"></a><span id="l74.617">         }</span>
<a href="#l74.618"></a><span id="l74.618">         if (tz) {</span>
<a href="#l74.619"></a><span id="l74.619" class="difflineat">@@ -1032,18 +1032,18 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l74.620"></a><span id="l74.620">     if (LOG_LEVEL &gt; 1) {</span>
<a href="#l74.621"></a><span id="l74.621">         log(&quot;parseItems(): returning &quot; + items.length + &quot; items&quot;, this);</span>
<a href="#l74.622"></a><span id="l74.622">     }</span>
<a href="#l74.623"></a><span id="l74.623">     return items;</span>
<a href="#l74.624"></a><span id="l74.624"> };</span>
<a href="#l74.625"></a><span id="l74.625"> </span>
<a href="#l74.626"></a><span id="l74.626"> calWcapCalendar.prototype.getItem =</span>
<a href="#l74.627"></a><span id="l74.627"> function calWcapCalendar_getItem(id, listener) {</span>
<a href="#l74.628"></a><span id="l74.628" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.629"></a><span id="l74.629" class="difflineminus">-    var request = new calWcapRequest(</span>
<a href="#l74.630"></a><span id="l74.630" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.631"></a><span id="l74.631" class="difflineplus">+    let request = new calWcapRequest(</span>
<a href="#l74.632"></a><span id="l74.632">         function getItem_resp(oprequest, err, item) {</span>
<a href="#l74.633"></a><span id="l74.633">             if (checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) ||</span>
<a href="#l74.634"></a><span id="l74.634">                 checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)) {</span>
<a href="#l74.635"></a><span id="l74.635">                 // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l74.636"></a><span id="l74.636">                 err = NS_OK;</span>
<a href="#l74.637"></a><span id="l74.637">             }</span>
<a href="#l74.638"></a><span id="l74.638">             this_.notifyOperationComplete(listener,</span>
<a href="#l74.639"></a><span id="l74.639">                                           getResultCode(err),</span>
<a href="#l74.640"></a><span id="l74.640" class="difflineat">@@ -1052,26 +1052,26 @@ function calWcapCalendar_getItem(id, lis</span>
<a href="#l74.641"></a><span id="l74.641">                                           err || item);</span>
<a href="#l74.642"></a><span id="l74.642">         },</span>
<a href="#l74.643"></a><span id="l74.643">         log(&quot;getItem() call: id=&quot; + id, this));</span>
<a href="#l74.644"></a><span id="l74.644"> </span>
<a href="#l74.645"></a><span id="l74.645">     try {</span>
<a href="#l74.646"></a><span id="l74.646">         if (!id) {</span>
<a href="#l74.647"></a><span id="l74.647">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l74.648"></a><span id="l74.648">         }</span>
<a href="#l74.649"></a><span id="l74.649" class="difflineminus">-        var params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l74.650"></a><span id="l74.650" class="difflineplus">+        let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l74.651"></a><span id="l74.651">         params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&amp;uid=&quot;;</span>
<a href="#l74.652"></a><span id="l74.652">         params += encodeURIComponent(id);</span>
<a href="#l74.653"></a><span id="l74.653"> </span>
<a href="#l74.654"></a><span id="l74.654">         // most common: try events first</span>
<a href="#l74.655"></a><span id="l74.655">         this.issueNetworkRequest(</span>
<a href="#l74.656"></a><span id="l74.656">             request,</span>
<a href="#l74.657"></a><span id="l74.657">             function fetchEventById_resp(err, eventRootComp) {</span>
<a href="#l74.658"></a><span id="l74.658">                 function notifyResult(rootComp) {</span>
<a href="#l74.659"></a><span id="l74.659" class="difflineminus">-                    var items = this_.parseItems(rootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l74.660"></a><span id="l74.660" class="difflineplus">+                    let items = this_.parseItems(rootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l74.661"></a><span id="l74.661">                     if (items.length &lt; 1) {</span>
<a href="#l74.662"></a><span id="l74.662">                         throw new Components.Exception(&quot;no such item!&quot;);</span>
<a href="#l74.663"></a><span id="l74.663">                     }</span>
<a href="#l74.664"></a><span id="l74.664">                     if (items.length &gt; 1) {</span>
<a href="#l74.665"></a><span id="l74.665">                         this_.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l74.666"></a><span id="l74.666">                                           &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l74.667"></a><span id="l74.667">                     }</span>
<a href="#l74.668"></a><span id="l74.668">                     if (listener) {</span>
<a href="#l74.669"></a><span id="l74.669" class="difflineat">@@ -1103,27 +1103,27 @@ function calWcapCalendar_getItem(id, lis</span>
<a href="#l74.670"></a><span id="l74.670">             stringToIcal, &quot;fetchevents_by_id&quot;, params, calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l74.671"></a><span id="l74.671">     } catch (exc) {</span>
<a href="#l74.672"></a><span id="l74.672">         request.execRespFunc(exc);</span>
<a href="#l74.673"></a><span id="l74.673">     }</span>
<a href="#l74.674"></a><span id="l74.674">     return request;</span>
<a href="#l74.675"></a><span id="l74.675"> };</span>
<a href="#l74.676"></a><span id="l74.676"> </span>
<a href="#l74.677"></a><span id="l74.677"> function getItemFilterParams(itemFilter) {</span>
<a href="#l74.678"></a><span id="l74.678" class="difflineminus">-    var params = &quot;&quot;;</span>
<a href="#l74.679"></a><span id="l74.679" class="difflineplus">+    let params = &quot;&quot;;</span>
<a href="#l74.680"></a><span id="l74.680">     switch (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_ALL) {</span>
<a href="#l74.681"></a><span id="l74.681">         case calICalendar.ITEM_FILTER_TYPE_TODO:</span>
<a href="#l74.682"></a><span id="l74.682">             params += &quot;&amp;component-type=todo&quot;;</span>
<a href="#l74.683"></a><span id="l74.683">             break;</span>
<a href="#l74.684"></a><span id="l74.684">         case calICalendar.ITEM_FILTER_TYPE_EVENT:</span>
<a href="#l74.685"></a><span id="l74.685">             params += &quot;&amp;component-type=event&quot;;</span>
<a href="#l74.686"></a><span id="l74.686">             break;</span>
<a href="#l74.687"></a><span id="l74.687">     }</span>
<a href="#l74.688"></a><span id="l74.688"> </span>
<a href="#l74.689"></a><span id="l74.689" class="difflineminus">-    var compstate = &quot;&quot;;</span>
<a href="#l74.690"></a><span id="l74.690" class="difflineplus">+    let compstate = &quot;&quot;;</span>
<a href="#l74.691"></a><span id="l74.691"> //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REPLY_DECLINED)</span>
<a href="#l74.692"></a><span id="l74.692"> //         compstate += &quot;;REPLY-DECLINED&quot;;</span>
<a href="#l74.693"></a><span id="l74.693"> //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REPLY_ACCEPTED)</span>
<a href="#l74.694"></a><span id="l74.694"> //         compstate += &quot;;REPLY-ACCEPTED&quot;;</span>
<a href="#l74.695"></a><span id="l74.695"> //     if (itemFilter &amp; calIWcapCalendar.ITEM_FILTER_REQUEST_COMPLETED)</span>
<a href="#l74.696"></a><span id="l74.696"> //         compstate += &quot;;REQUEST-COMPLETED&quot;;</span>
<a href="#l74.697"></a><span id="l74.697">     if (itemFilter &amp; calICalendar.ITEM_FILTER_REQUEST_NEEDS_ACTION) {</span>
<a href="#l74.698"></a><span id="l74.698">         compstate += &quot;;REQUEST-NEEDS-ACTION&quot;;</span>
<a href="#l74.699"></a><span id="l74.699" class="difflineat">@@ -1140,21 +1140,21 @@ function getItemFilterParams(itemFilter)</span>
<a href="#l74.700"></a><span id="l74.700">     }</span>
<a href="#l74.701"></a><span id="l74.701">     return params;</span>
<a href="#l74.702"></a><span id="l74.702"> }</span>
<a href="#l74.703"></a><span id="l74.703"> </span>
<a href="#l74.704"></a><span id="l74.704"> calWcapCalendar.prototype.getItems =</span>
<a href="#l74.705"></a><span id="l74.705"> function calWcapCalendar_getItems(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l74.706"></a><span id="l74.706">     rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l74.707"></a><span id="l74.707">     rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l74.708"></a><span id="l74.708" class="difflineminus">-    var zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l74.709"></a><span id="l74.709" class="difflineminus">-    var zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l74.710"></a><span id="l74.710" class="difflineplus">+    let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l74.711"></a><span id="l74.711" class="difflineplus">+    let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l74.712"></a><span id="l74.712"> </span>
<a href="#l74.713"></a><span id="l74.713" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.714"></a><span id="l74.714" class="difflineminus">-    var request = new calWcapRequest(</span>
<a href="#l74.715"></a><span id="l74.715" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.716"></a><span id="l74.716" class="difflineplus">+    let request = new calWcapRequest(</span>
<a href="#l74.717"></a><span id="l74.717">         function getItems_resp(oprequest, err, data) {</span>
<a href="#l74.718"></a><span id="l74.718">             log(&quot;getItems() complete: &quot; + errorToString(err), this_);</span>
<a href="#l74.719"></a><span id="l74.719">             this_.notifyOperationComplete(listener,</span>
<a href="#l74.720"></a><span id="l74.720">                                           getResultCode(err),</span>
<a href="#l74.721"></a><span id="l74.721">                                           calIOperationListener.GET,</span>
<a href="#l74.722"></a><span id="l74.722">                                           null,</span>
<a href="#l74.723"></a><span id="l74.723">                                           err);</span>
<a href="#l74.724"></a><span id="l74.724">         },</span>
<a href="#l74.725"></a><span id="l74.725" class="difflineat">@@ -1190,17 +1190,17 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l74.726"></a><span id="l74.726">                 }</span>
<a href="#l74.727"></a><span id="l74.727">                 request.execRespFunc(null, entry.results);</span>
<a href="#l74.728"></a><span id="l74.728">                 return request;</span>
<a href="#l74.729"></a><span id="l74.729">             }</span>
<a href="#l74.730"></a><span id="l74.730">         }</span>
<a href="#l74.731"></a><span id="l74.731">     }</span>
<a href="#l74.732"></a><span id="l74.732"> </span>
<a href="#l74.733"></a><span id="l74.733">     try {</span>
<a href="#l74.734"></a><span id="l74.734" class="difflineminus">-        var params = (&quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l74.735"></a><span id="l74.735" class="difflineplus">+        let params = (&quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l74.736"></a><span id="l74.736">         // setting component-type, compstate filters:</span>
<a href="#l74.737"></a><span id="l74.737">         params += getItemFilterParams(itemFilter);</span>
<a href="#l74.738"></a><span id="l74.738">         if (maxResults &gt; 0) {</span>
<a href="#l74.739"></a><span id="l74.739">             params += (&quot;&amp;maxResults=&quot; + maxResults);</span>
<a href="#l74.740"></a><span id="l74.740">         }</span>
<a href="#l74.741"></a><span id="l74.741">         params += (&quot;&amp;dtstart=&quot; + zRangeStart);</span>
<a href="#l74.742"></a><span id="l74.742">         params += (&quot;&amp;dtend=&quot; + zRangeEnd);</span>
<a href="#l74.743"></a><span id="l74.743"> </span>
<a href="#l74.744"></a><span id="l74.744" class="difflineat">@@ -1208,24 +1208,24 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l74.745"></a><span id="l74.745">             request,</span>
<a href="#l74.746"></a><span id="l74.746">             function netResp(err, icalRootComp) {</span>
<a href="#l74.747"></a><span id="l74.747">                 if (err) {</span>
<a href="#l74.748"></a><span id="l74.748">                     if (checkErrorCode(err, calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR)) {</span>
<a href="#l74.749"></a><span id="l74.749">                         // try free-busy times:</span>
<a href="#l74.750"></a><span id="l74.750">                         if (listener &amp;&amp;</span>
<a href="#l74.751"></a><span id="l74.751">                             (itemFilter &amp; calICalendar.ITEM_FILTER_TYPE_EVENT) &amp;&amp;</span>
<a href="#l74.752"></a><span id="l74.752">                             rangeStart &amp;&amp; rangeEnd) {</span>
<a href="#l74.753"></a><span id="l74.753" class="difflineminus">-                            var freeBusyListener = { // calIGenericOperationListener:</span>
<a href="#l74.754"></a><span id="l74.754" class="difflineplus">+                            let freeBusyListener = { // calIGenericOperationListener:</span>
<a href="#l74.755"></a><span id="l74.755">                                 onResult: function freeBusyListener_onResult(oprequest, result) {</span>
<a href="#l74.756"></a><span id="l74.756">                                     if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l74.757"></a><span id="l74.757">                                         throw oprequest.status;</span>
<a href="#l74.758"></a><span id="l74.758">                                     }</span>
<a href="#l74.759"></a><span id="l74.759" class="difflineminus">-                                    var items = [];</span>
<a href="#l74.760"></a><span id="l74.760" class="difflineplus">+                                    let items = [];</span>
<a href="#l74.761"></a><span id="l74.761">                                     for (let entry of result) {</span>
<a href="#l74.762"></a><span id="l74.762" class="difflineminus">-                                        var item = createEvent();</span>
<a href="#l74.763"></a><span id="l74.763" class="difflineplus">+                                        let item = createEvent();</span>
<a href="#l74.764"></a><span id="l74.764">                                         item.id = (g_busyPhantomItemUuidPrefix + getIcalUTC(entry.interval.start));</span>
<a href="#l74.765"></a><span id="l74.765">                                         item.calendar = this_.superCalendar;</span>
<a href="#l74.766"></a><span id="l74.766">                                         item.title = g_busyItemTitle;</span>
<a href="#l74.767"></a><span id="l74.767">                                         item.startDate = entry.interval.start;</span>
<a href="#l74.768"></a><span id="l74.768">                                         item.endDate = entry.interval.end;</span>
<a href="#l74.769"></a><span id="l74.769">                                         item.makeImmutable();</span>
<a href="#l74.770"></a><span id="l74.770">                                         items.push(item);</span>
<a href="#l74.771"></a><span id="l74.771">                                     }</span>
<a href="#l74.772"></a><span id="l74.772" class="difflineat">@@ -1237,24 +1237,24 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l74.773"></a><span id="l74.773">                                 this_.session.getFreeBusyIntervals(</span>
<a href="#l74.774"></a><span id="l74.774">                                     this_.calId, rangeStart, rangeEnd, calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l74.775"></a><span id="l74.775">                                     freeBusyListener));</span>
<a href="#l74.776"></a><span id="l74.776">                         }</span>
<a href="#l74.777"></a><span id="l74.777">                     } else {</span>
<a href="#l74.778"></a><span id="l74.778">                         throw err;</span>
<a href="#l74.779"></a><span id="l74.779">                     }</span>
<a href="#l74.780"></a><span id="l74.780">                 } else if (listener) {</span>
<a href="#l74.781"></a><span id="l74.781" class="difflineminus">-                    var items = this_.parseItems(</span>
<a href="#l74.782"></a><span id="l74.782" class="difflineplus">+                    let items = this_.parseItems(</span>
<a href="#l74.783"></a><span id="l74.783">                         icalRootComp, itemFilter, maxResults,</span>
<a href="#l74.784"></a><span id="l74.784">                         rangeStart, rangeEnd);</span>
<a href="#l74.785"></a><span id="l74.785"> </span>
<a href="#l74.786"></a><span id="l74.786">                     if (CACHE_LAST_RESULTS &gt; 0) {</span>
<a href="#l74.787"></a><span id="l74.787">                         // auto invalidate after X minutes:</span>
<a href="#l74.788"></a><span id="l74.788">                         if (!this_.m_cachedResultsTimer) {</span>
<a href="#l74.789"></a><span id="l74.789" class="difflineminus">-                            var callback = {</span>
<a href="#l74.790"></a><span id="l74.790" class="difflineplus">+                            let callback = {</span>
<a href="#l74.791"></a><span id="l74.791">                                 notify: function notify(timer) {</span>
<a href="#l74.792"></a><span id="l74.792">                                     if (!this_.m_cachedResults) {</span>
<a href="#l74.793"></a><span id="l74.793">                                         return;</span>
<a href="#l74.794"></a><span id="l74.794">                                     }</span>
<a href="#l74.795"></a><span id="l74.795">                                     let now = (new Date()).getTime();</span>
<a href="#l74.796"></a><span id="l74.796">                                     // sort out old entries:</span>
<a href="#l74.797"></a><span id="l74.797">                                     let entries = [];</span>
<a href="#l74.798"></a><span id="l74.798">                                     for (let i = 0; i &lt; this_.m_cachedResults.length; ++i) {</span>
<a href="#l74.799"></a><span id="l74.799" class="difflineat">@@ -1309,22 +1309,22 @@ calWcapCalendar.prototype.offlineStorage</span>
<a href="#l74.800"></a><span id="l74.800"> </span>
<a href="#l74.801"></a><span id="l74.801"> calWcapCalendar.prototype.resetLog =</span>
<a href="#l74.802"></a><span id="l74.802"> function calWcapCalendar_resetLog() {</span>
<a href="#l74.803"></a><span id="l74.803">     this.deleteProperty(&quot;replay.last_stamp&quot;);</span>
<a href="#l74.804"></a><span id="l74.804"> };</span>
<a href="#l74.805"></a><span id="l74.805"> </span>
<a href="#l74.806"></a><span id="l74.806"> calWcapCalendar.prototype.replayChangesOn =</span>
<a href="#l74.807"></a><span id="l74.807"> function calWcapCalendar_replayChangesOn(listener) {</span>
<a href="#l74.808"></a><span id="l74.808" class="difflineminus">-    var this_ = this;</span>
<a href="#l74.809"></a><span id="l74.809" class="difflineminus">-    var itemFilter = calICalendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l74.810"></a><span id="l74.810" class="difflineminus">-    var dtFrom = getDatetimeFromIcalString(this.getProperty(&quot;replay.last_stamp&quot;));</span>
<a href="#l74.811"></a><span id="l74.811" class="difflineminus">-    var now = getTime(); // new stamp for this sync</span>
<a href="#l74.812"></a><span id="l74.812" class="difflineplus">+    let this_ = this;</span>
<a href="#l74.813"></a><span id="l74.813" class="difflineplus">+    let itemFilter = calICalendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l74.814"></a><span id="l74.814" class="difflineplus">+    let dtFrom = getDatetimeFromIcalString(this.getProperty(&quot;replay.last_stamp&quot;));</span>
<a href="#l74.815"></a><span id="l74.815" class="difflineplus">+    let now = getTime(); // new stamp for this sync</span>
<a href="#l74.816"></a><span id="l74.816"> </span>
<a href="#l74.817"></a><span id="l74.817" class="difflineminus">-    var request_ = new calWcapRequest(</span>
<a href="#l74.818"></a><span id="l74.818" class="difflineplus">+    let request_ = new calWcapRequest(</span>
<a href="#l74.819"></a><span id="l74.819">         function replayChangesOn_resp(request, err) {</span>
<a href="#l74.820"></a><span id="l74.820">             if (err) {</span>
<a href="#l74.821"></a><span id="l74.821">                 logError(&quot;error replaying changes: &quot; + errorToString(err));</span>
<a href="#l74.822"></a><span id="l74.822">                 this_.notifyError(err);</span>
<a href="#l74.823"></a><span id="l74.823">             } else {</span>
<a href="#l74.824"></a><span id="l74.824">                 log(&quot;replay succeeded.&quot;, this_);</span>
<a href="#l74.825"></a><span id="l74.825">                 this_.setProperty(&quot;replay.last_stamp&quot;, getIcalUTC(now));</span>
<a href="#l74.826"></a><span id="l74.826">                 log(&quot;new replay stamp: &quot; + getIcalUTC(now), this_);</span>
<a href="#l74.827"></a><span id="l74.827" class="difflineat">@@ -1332,31 +1332,31 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l74.828"></a><span id="l74.828">             if (listener) {</span>
<a href="#l74.829"></a><span id="l74.829">                 listener.onResult(request, null);</span>
<a href="#l74.830"></a><span id="l74.830">             }</span>
<a href="#l74.831"></a><span id="l74.831">         },</span>
<a href="#l74.832"></a><span id="l74.832">         log(&quot;replayChangesOn():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) +</span>
<a href="#l74.833"></a><span id="l74.833">             &quot;\n\tdtFrom=&quot; + getIcalUTC(dtFrom), this));</span>
<a href="#l74.834"></a><span id="l74.834"> </span>
<a href="#l74.835"></a><span id="l74.835">     try {</span>
<a href="#l74.836"></a><span id="l74.836" class="difflineminus">-        var writeListener = {</span>
<a href="#l74.837"></a><span id="l74.837" class="difflineplus">+        let writeListener = {</span>
<a href="#l74.838"></a><span id="l74.838">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l74.839"></a><span id="l74.839">             onGetResult: function() {},</span>
<a href="#l74.840"></a><span id="l74.840">             onOperationComplete: function(aCalendar, status, opType, id, detail) {</span>
<a href="#l74.841"></a><span id="l74.841">                 if (!Components.isSuccessCode(status)) {</span>
<a href="#l74.842"></a><span id="l74.842">                     request.execRespFunc(status); // any error on writing breaks whole operation</span>
<a href="#l74.843"></a><span id="l74.843">                 }</span>
<a href="#l74.844"></a><span id="l74.844">             }</span>
<a href="#l74.845"></a><span id="l74.845">         };</span>
<a href="#l74.846"></a><span id="l74.846" class="difflineminus">-        var request = new calWcapRequest(</span>
<a href="#l74.847"></a><span id="l74.847" class="difflineplus">+        let request = new calWcapRequest(</span>
<a href="#l74.848"></a><span id="l74.848">             function netFinishedRespFunc(err, data) {</span>
<a href="#l74.849"></a><span id="l74.849" class="difflineminus">-                var modifiedIds = {};</span>
<a href="#l74.850"></a><span id="l74.850" class="difflineplus">+                let modifiedIds = {};</span>
<a href="#l74.851"></a><span id="l74.851">                 for (let item of request.m_modifiedItems) {</span>
<a href="#l74.852"></a><span id="l74.852" class="difflineminus">-                    var dtCreated = item.getProperty(&quot;CREATED&quot;);</span>
<a href="#l74.853"></a><span id="l74.853" class="difflineminus">-                    var bAdd = (!dtCreated || !dtFrom || dtCreated.compare(dtFrom) &gt;= 0);</span>
<a href="#l74.854"></a><span id="l74.854" class="difflineplus">+                    let dtCreated = item.getProperty(&quot;CREATED&quot;);</span>
<a href="#l74.855"></a><span id="l74.855" class="difflineplus">+                    let bAdd = (!dtCreated || !dtFrom || dtCreated.compare(dtFrom) &gt;= 0);</span>
<a href="#l74.856"></a><span id="l74.856">                     modifiedIds[item.id] = true;</span>
<a href="#l74.857"></a><span id="l74.857">                     if (bAdd) {</span>
<a href="#l74.858"></a><span id="l74.858">                         log(&quot;replayChangesOn(): new item &quot; + item.id, this_);</span>
<a href="#l74.859"></a><span id="l74.859">                         if (this_.offlineStorage) {</span>
<a href="#l74.860"></a><span id="l74.860">                             this_.offlineStorage.addItem(item, writeListener);</span>
<a href="#l74.861"></a><span id="l74.861">                         }</span>
<a href="#l74.862"></a><span id="l74.862">                     } else {</span>
<a href="#l74.863"></a><span id="l74.863">                         log(&quot;replayChangesOn(): modified item &quot; + item.id, this_);</span>
<a href="#l74.864"></a><span id="l74.864" class="difflineat">@@ -1371,17 +1371,17 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l74.865"></a><span id="l74.865">                         log(&quot;replayChangesOn(): skipping deletion of &quot; + item.id, this_);</span>
<a href="#l74.866"></a><span id="l74.866">                     } else if (isParent(item)) {</span>
<a href="#l74.867"></a><span id="l74.867">                         log(&quot;replayChangesOn(): deleted item &quot; + item.id, this_);</span>
<a href="#l74.868"></a><span id="l74.868">                         if (this_.offlineStorage) {</span>
<a href="#l74.869"></a><span id="l74.869">                             this_.offlineStorage.deleteItem(item, writeListener);</span>
<a href="#l74.870"></a><span id="l74.870">                         }</span>
<a href="#l74.871"></a><span id="l74.871">                     } else { // modify parent instead of</span>
<a href="#l74.872"></a><span id="l74.872">                              // straight-forward deleteItem(). WTF.</span>
<a href="#l74.873"></a><span id="l74.873" class="difflineminus">-                        var parent = item.parentItem.clone();</span>
<a href="#l74.874"></a><span id="l74.874" class="difflineplus">+                        let parent = item.parentItem.clone();</span>
<a href="#l74.875"></a><span id="l74.875">                         parent.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l74.876"></a><span id="l74.876">                         log(&quot;replayChangesOn(): modified parent &quot; + parent.id, this_);</span>
<a href="#l74.877"></a><span id="l74.877">                         if (this_.offlineStorage) {</span>
<a href="#l74.878"></a><span id="l74.878">                             this_.offlineStorage.modifyItem(parent, item, writeListener);</span>
<a href="#l74.879"></a><span id="l74.879">                         }</span>
<a href="#l74.880"></a><span id="l74.880">                     }</span>
<a href="#l74.881"></a><span id="l74.881">                 }</span>
<a href="#l74.882"></a><span id="l74.882">             }, &quot;replayChangesOn() netFinishedRespFunc&quot;);</span>
<a href="#l74.883"></a><span id="l74.883" class="difflineat">@@ -1390,17 +1390,17 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l74.884"></a><span id="l74.884">         // assure being logged in to calc server times:</span>
<a href="#l74.885"></a><span id="l74.885">         this.session.getSessionId(</span>
<a href="#l74.886"></a><span id="l74.886">             request,</span>
<a href="#l74.887"></a><span id="l74.887">             function getSessionId_resp(err, sessionId) {</span>
<a href="#l74.888"></a><span id="l74.888">                 try {</span>
<a href="#l74.889"></a><span id="l74.889">                     if (err) {</span>
<a href="#l74.890"></a><span id="l74.890">                         throw err;</span>
<a href="#l74.891"></a><span id="l74.891">                     }</span>
<a href="#l74.892"></a><span id="l74.892" class="difflineminus">-                    var params = (&quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot; +</span>
<a href="#l74.893"></a><span id="l74.893" class="difflineplus">+                    let params = (&quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot; +</span>
<a href="#l74.894"></a><span id="l74.894">                                   &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l74.895"></a><span id="l74.895">                     if (dtFrom) {</span>
<a href="#l74.896"></a><span id="l74.896">                         dtFrom = this_.session.getServerTime(dtFrom);</span>
<a href="#l74.897"></a><span id="l74.897">                     }</span>
<a href="#l74.898"></a><span id="l74.898">                     params += (&quot;&amp;dtstart=&quot; + getIcalUTC(dtFrom));</span>
<a href="#l74.899"></a><span id="l74.899">                     params += (&quot;&amp;dtend=&quot; + getIcalUTC(this_.session.getServerTime(now)));</span>
<a href="#l74.900"></a><span id="l74.900"> </span>
<a href="#l74.901"></a><span id="l74.901">                     log(&quot;replayChangesOn(): getting last modifications...&quot;, this_);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -25,25 +25,25 @@ function getResultCode(err) {</span>
<a href="#l75.4"></a><span id="l75.4">     }</span>
<a href="#l75.5"></a><span id="l75.5">     if (isNaN(err)) {</span>
<a href="#l75.6"></a><span id="l75.6">         return ((err instanceof nsIException) ? err.result : Components.results.NS_ERROR_FAILURE);</span>
<a href="#l75.7"></a><span id="l75.7">     }</span>
<a href="#l75.8"></a><span id="l75.8">     return err;</span>
<a href="#l75.9"></a><span id="l75.9"> }</span>
<a href="#l75.10"></a><span id="l75.10"> </span>
<a href="#l75.11"></a><span id="l75.11"> function getErrorModule(err) {</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-    var rc = getResultCode(err);</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+    let rc = getResultCode(err);</span>
<a href="#l75.14"></a><span id="l75.14">     return (((rc &gt;&gt;&gt; 16) &amp; 0x7fff) - NS_ERROR_MODULE_BASE_OFFSET);</span>
<a href="#l75.15"></a><span id="l75.15"> }</span>
<a href="#l75.16"></a><span id="l75.16"> </span>
<a href="#l75.17"></a><span id="l75.17"> function checkErrorCode(err, rcBits, maskBits) {</span>
<a href="#l75.18"></a><span id="l75.18">     if (!maskBits) {</span>
<a href="#l75.19"></a><span id="l75.19">         maskBits = 0;</span>
<a href="#l75.20"></a><span id="l75.20">     }</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineminus">-    var rc = getResultCode(err);</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineplus">+    let rc = getResultCode(err);</span>
<a href="#l75.23"></a><span id="l75.23">     return ((rc ^ rcBits) &gt;&gt;&gt; maskBits) == 0;</span>
<a href="#l75.24"></a><span id="l75.24"> }</span>
<a href="#l75.25"></a><span id="l75.25"> </span>
<a href="#l75.26"></a><span id="l75.26"> // Cannot perform operation, because user is offline.</span>
<a href="#l75.27"></a><span id="l75.27"> // The following error codes have been adopted from</span>
<a href="#l75.28"></a><span id="l75.28"> // xpcom/base/nsError.h</span>
<a href="#l75.29"></a><span id="l75.29"> // and ought to be defined in IDL. xxx todo</span>
<a href="#l75.30"></a><span id="l75.30"> </span>
<a href="#l75.31"></a><span id="l75.31" class="difflineat">@@ -99,17 +99,17 @@ var g_nsNetErrorCodes = [</span>
<a href="#l75.32"></a><span id="l75.32">     /* NS_ERROR_UNKNOWN_SOCKET_TYPE */ generateNetFailure(51),</span>
<a href="#l75.33"></a><span id="l75.33">     &quot;The specified socket type does not exist.&quot;,</span>
<a href="#l75.34"></a><span id="l75.34">     /* NS_ERROR_SOCKET_CREATE_FAILED */ generateNetFailure(52),</span>
<a href="#l75.35"></a><span id="l75.35">     &quot;The specified socket type could not be created.&quot;</span>
<a href="#l75.36"></a><span id="l75.36">     ];</span>
<a href="#l75.37"></a><span id="l75.37"> </span>
<a href="#l75.38"></a><span id="l75.38"> function netErrorToString(rc) {</span>
<a href="#l75.39"></a><span id="l75.39">     if (!isNaN(rc) &amp;&amp; getErrorModule(rc) == NS_ERROR_MODULE_NETWORK) {</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineminus">-        var i = 0;</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineplus">+        let i = 0;</span>
<a href="#l75.42"></a><span id="l75.42">         while (i &lt; g_nsNetErrorCodes.length) {</span>
<a href="#l75.43"></a><span id="l75.43">             // however rc is kept unsigned, our generated code signed,</span>
<a href="#l75.44"></a><span id="l75.44">             // so == won't work here:</span>
<a href="#l75.45"></a><span id="l75.45">             if ((g_nsNetErrorCodes[i] ^ rc) == 0) {</span>
<a href="#l75.46"></a><span id="l75.46">                 return g_nsNetErrorCodes[i + 1];</span>
<a href="#l75.47"></a><span id="l75.47">             }</span>
<a href="#l75.48"></a><span id="l75.48">             i += 2;</span>
<a href="#l75.49"></a><span id="l75.49">         }</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineat">@@ -246,68 +246,68 @@ var g_wcapErrorCodes = [</span>
<a href="#l75.51"></a><span id="l75.51"> function wcapErrorToString(rc) {</span>
<a href="#l75.52"></a><span id="l75.52">     if (isNaN(rc)) {</span>
<a href="#l75.53"></a><span id="l75.53">         throw new Components.Exception(&quot;No known WCAP error code: &quot; + rc.toString(0x10), NS_ERROR_INVALID_ARG);</span>
<a href="#l75.54"></a><span id="l75.54">     }</span>
<a href="#l75.55"></a><span id="l75.55">     if (rc == calIWcapErrors.WCAP_NO_ERRNO) {</span>
<a href="#l75.56"></a><span id="l75.56">         return &quot;No WCAP errno (missing X-NSCP-WCAP-ERRNO).&quot;;</span>
<a href="#l75.57"></a><span id="l75.57">     }</span>
<a href="#l75.58"></a><span id="l75.58"> </span>
<a href="#l75.59"></a><span id="l75.59" class="difflineminus">-    var index = (rc - calIWcapErrors.WCAP_ERROR_BASE + 1);</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineplus">+    let index = (rc - calIWcapErrors.WCAP_ERROR_BASE + 1);</span>
<a href="#l75.61"></a><span id="l75.61">     if (index &gt;= 1 &amp;&amp; index &lt;= 108 &amp;&amp; g_wcapErrorCodes[index * 2] != NS_ERROR_INVALID_ARG) {</span>
<a href="#l75.62"></a><span id="l75.62">         return g_wcapErrorCodes[(index * 2) + 1];</span>
<a href="#l75.63"></a><span id="l75.63">     }</span>
<a href="#l75.64"></a><span id="l75.64">     throw new Components.Exception(&quot;No known WCAP error code: &quot; + rc.toString(0x10), NS_ERROR_INVALID_ARG);</span>
<a href="#l75.65"></a><span id="l75.65"> }</span>
<a href="#l75.66"></a><span id="l75.66"> </span>
<a href="#l75.67"></a><span id="l75.67"> function getWcapErrorCode(errno) {</span>
<a href="#l75.68"></a><span id="l75.68">     if (errno == -5000) { // semantically same error</span>
<a href="#l75.69"></a><span id="l75.69">         errno = 59;</span>
<a href="#l75.70"></a><span id="l75.70">     }</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineminus">-    var index = -1;</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineplus">+    let index = -1;</span>
<a href="#l75.73"></a><span id="l75.73">     if (errno &gt;= -1 &amp;&amp; errno &lt;= 81) {</span>
<a href="#l75.74"></a><span id="l75.74">         index = (errno + 1);</span>
<a href="#l75.75"></a><span id="l75.75">     } else if (errno &gt;= 11000 &amp;&amp; errno &lt;= 11008) {</span>
<a href="#l75.76"></a><span id="l75.76">         index = (errno - 11000 + 100 + 1);</span>
<a href="#l75.77"></a><span id="l75.77">     }</span>
<a href="#l75.78"></a><span id="l75.78">     if (index &gt;= 0 &amp;&amp; g_wcapErrorCodes[index * 2] != NS_ERROR_INVALID_ARG) {</span>
<a href="#l75.79"></a><span id="l75.79">         return g_wcapErrorCodes[index * 2];</span>
<a href="#l75.80"></a><span id="l75.80">     }</span>
<a href="#l75.81"></a><span id="l75.81">     throw new Components.Exception(&quot;No known WCAP error no: &quot; + errno, NS_ERROR_INVALID_ARG);</span>
<a href="#l75.82"></a><span id="l75.82"> }</span>
<a href="#l75.83"></a><span id="l75.83"> </span>
<a href="#l75.84"></a><span id="l75.84"> function getWcapXmlErrno(xml) {</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineminus">-    var elem = xml.getElementsByTagName(&quot;X-NSCP-WCAP-ERRNO&quot;);</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineplus">+    let elem = xml.getElementsByTagName(&quot;X-NSCP-WCAP-ERRNO&quot;);</span>
<a href="#l75.87"></a><span id="l75.87">     if (elem) {</span>
<a href="#l75.88"></a><span id="l75.88">         elem = elem.item(0);</span>
<a href="#l75.89"></a><span id="l75.89">         if (elem) {</span>
<a href="#l75.90"></a><span id="l75.90">             return parseInt(elem.textContent, 10);</span>
<a href="#l75.91"></a><span id="l75.91">         }</span>
<a href="#l75.92"></a><span id="l75.92">     }</span>
<a href="#l75.93"></a><span id="l75.93">     // some commands just respond with an empty calendar, no errno. WTF.</span>
<a href="#l75.94"></a><span id="l75.94">     // assume success:</span>
<a href="#l75.95"></a><span id="l75.95">     return undefined;</span>
<a href="#l75.96"></a><span id="l75.96"> }</span>
<a href="#l75.97"></a><span id="l75.97"> </span>
<a href="#l75.98"></a><span id="l75.98"> function getWcapIcalErrno(icalRootComp) {</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineminus">-    var prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-ERRNO&quot;);</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineplus">+    let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-ERRNO&quot;);</span>
<a href="#l75.101"></a><span id="l75.101">     if (prop) {</span>
<a href="#l75.102"></a><span id="l75.102">         return parseInt(prop.value, 10);</span>
<a href="#l75.103"></a><span id="l75.103">     }</span>
<a href="#l75.104"></a><span id="l75.104">     // some commands just respond with an empty calendar, no errno. WTF.</span>
<a href="#l75.105"></a><span id="l75.105">     // assume success:</span>
<a href="#l75.106"></a><span id="l75.106">     return undefined;</span>
<a href="#l75.107"></a><span id="l75.107"> }</span>
<a href="#l75.108"></a><span id="l75.108"> </span>
<a href="#l75.109"></a><span id="l75.109"> function checkWcapErrno(errno, expectedErrno) {</span>
<a href="#l75.110"></a><span id="l75.110">     if (expectedErrno === undefined) {</span>
<a href="#l75.111"></a><span id="l75.111">         expectedErrno = 0; // i.e. Command successful.</span>
<a href="#l75.112"></a><span id="l75.112">     }</span>
<a href="#l75.113"></a><span id="l75.113">     if (errno !== undefined &amp;&amp; errno != expectedErrno) {</span>
<a href="#l75.114"></a><span id="l75.114" class="difflineminus">-        var rc = getWcapErrorCode(errno);</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineplus">+        let rc = getWcapErrorCode(errno);</span>
<a href="#l75.116"></a><span id="l75.116">         throw new Components.Exception(wcapErrorToString(rc), rc);</span>
<a href="#l75.117"></a><span id="l75.117">     }</span>
<a href="#l75.118"></a><span id="l75.118"> }</span>
<a href="#l75.119"></a><span id="l75.119"> </span>
<a href="#l75.120"></a><span id="l75.120"> function checkWcapXmlErrno(xml, expectedErrno) {</span>
<a href="#l75.121"></a><span id="l75.121">     checkWcapErrno(getWcapXmlErrno(xml), expectedErrno);</span>
<a href="#l75.122"></a><span id="l75.122"> }</span>
<a href="#l75.123"></a><span id="l75.123"> </span>
<a href="#l75.124"></a><span id="l75.124" class="difflineat">@@ -366,17 +366,17 @@ function errorToString(err) {</span>
<a href="#l75.125"></a><span id="l75.125">             // probe for WCAP error:</span>
<a href="#l75.126"></a><span id="l75.126">             try {</span>
<a href="#l75.127"></a><span id="l75.127">                 return wcapErrorToString(err);</span>
<a href="#l75.128"></a><span id="l75.128">             } catch (exc) { // probe for netwerk error:</span>
<a href="#l75.129"></a><span id="l75.129">                 try {</span>
<a href="#l75.130"></a><span id="l75.130">                     return netErrorToString(err);</span>
<a href="#l75.131"></a><span id="l75.131">                 } catch (exc2) {</span>
<a href="#l75.132"></a><span id="l75.132">                     if (err &amp; calIErrors.ERROR_BASE) {</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineminus">-                        for (var err_ in calIErrors) {</span>
<a href="#l75.134"></a><span id="l75.134" class="difflineplus">+                        for (let err_ in calIErrors) {</span>
<a href="#l75.135"></a><span id="l75.135">                             if (calIErrors[err_] == err) {</span>
<a href="#l75.136"></a><span id="l75.136">                                 return err_;</span>
<a href="#l75.137"></a><span id="l75.137">                             }</span>
<a href="#l75.138"></a><span id="l75.138">                         }</span>
<a href="#l75.139"></a><span id="l75.139">                     }</span>
<a href="#l75.140"></a><span id="l75.140">                     return (&quot;[0x&quot; + err.toString(0x10) + &quot;] unknown error.&quot;);</span>
<a href="#l75.141"></a><span id="l75.141">                 }</span>
<a href="#l75.142"></a><span id="l75.142">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -72,22 +72,22 @@ calWcapRequest.prototype = {</span>
<a href="#l76.4"></a><span id="l76.4">             // assures that respFunc is executed:</span>
<a href="#l76.5"></a><span id="l76.5">             if (this.m_attachedRequests.length == 0) {</span>
<a href="#l76.6"></a><span id="l76.6">                 this.execRespFunc();</span>
<a href="#l76.7"></a><span id="l76.7">             }</span>
<a href="#l76.8"></a><span id="l76.8">         }</span>
<a href="#l76.9"></a><span id="l76.9">     },</span>
<a href="#l76.10"></a><span id="l76.10"> </span>
<a href="#l76.11"></a><span id="l76.11">     toString: function calWcapRequest_toString() {</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-        var ret = (&quot;calWcapRequest id=&quot; + this.id +</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+        let ret = (&quot;calWcapRequest id=&quot; + this.id +</span>
<a href="#l76.14"></a><span id="l76.14">                    &quot;, parent-id=&quot; + (this.parentRequest ? this.parentRequest.id : &quot;&lt;none&gt;&quot;) +</span>
<a href="#l76.15"></a><span id="l76.15">                    &quot; (&quot; + this.m_logContext + &quot;)&quot;);</span>
<a href="#l76.16"></a><span id="l76.16">         if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_attachedRequests.length &gt; 0) {</span>
<a href="#l76.17"></a><span id="l76.17">             ret += &quot;\nattached requests:&quot;;</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineminus">-            for (var req of this.m_attachedRequests) {</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineplus">+            for (let req of this.m_attachedRequests) {</span>
<a href="#l76.20"></a><span id="l76.20">                 ret += (&quot;\n#&quot; + req.id + &quot;\t&quot; + req);</span>
<a href="#l76.21"></a><span id="l76.21">             }</span>
<a href="#l76.22"></a><span id="l76.22">         }</span>
<a href="#l76.23"></a><span id="l76.23">         ret += (&quot;, isPending=&quot; + this.isPending);</span>
<a href="#l76.24"></a><span id="l76.24">         ret += (&quot;, status=&quot; + errorToString(this.status));</span>
<a href="#l76.25"></a><span id="l76.25">         return ret;</span>
<a href="#l76.26"></a><span id="l76.26">     },</span>
<a href="#l76.27"></a><span id="l76.27"> </span>
<a href="#l76.28"></a><span id="l76.28" class="difflineat">@@ -114,37 +114,37 @@ calWcapRequest.prototype = {</span>
<a href="#l76.29"></a><span id="l76.29">             this.execRespFunc(err);</span>
<a href="#l76.30"></a><span id="l76.30">         } else if (!this.m_locked &amp;&amp; this.m_attachedRequests.length == 0) {</span>
<a href="#l76.31"></a><span id="l76.31">             // assures that respFunc is executed after all sub requests have been completed:</span>
<a href="#l76.32"></a><span id="l76.32">             this.execRespFunc();</span>
<a href="#l76.33"></a><span id="l76.33">         }</span>
<a href="#l76.34"></a><span id="l76.34">     },</span>
<a href="#l76.35"></a><span id="l76.35"> </span>
<a href="#l76.36"></a><span id="l76.36">     cancelAllSubRequests: function calWcapRequest_cancelAllSubRequests(status) {</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineminus">-        var attachedRequests = this.m_attachedRequests;</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineplus">+        let attachedRequests = this.m_attachedRequests;</span>
<a href="#l76.39"></a><span id="l76.39">         this.m_attachedRequests = [];</span>
<a href="#l76.40"></a><span id="l76.40">         attachedRequests.forEach(function(req) { req.cancel(null); });</span>
<a href="#l76.41"></a><span id="l76.41">     },</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43">     detachFromParent: function calWcapRequest_detachFromParent(err) {</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineminus">-        var parentRequest = this.m_parentRequest;</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineplus">+        let parentRequest = this.m_parentRequest;</span>
<a href="#l76.46"></a><span id="l76.46">         if (parentRequest) {</span>
<a href="#l76.47"></a><span id="l76.47">             this.m_parentRequest = null;</span>
<a href="#l76.48"></a><span id="l76.48">             parentRequest.detachSubRequest(this, err);</span>
<a href="#l76.49"></a><span id="l76.49">         }</span>
<a href="#l76.50"></a><span id="l76.50">     },</span>
<a href="#l76.51"></a><span id="l76.51"> </span>
<a href="#l76.52"></a><span id="l76.52">     execRespFunc: function calWcapRequest_execRespFunc(err, data) {</span>
<a href="#l76.53"></a><span id="l76.53">         if (this.isPending) {</span>
<a href="#l76.54"></a><span id="l76.54">             this.m_isPending = false;</span>
<a href="#l76.55"></a><span id="l76.55">             if (err) {</span>
<a href="#l76.56"></a><span id="l76.56">                 this.m_status = err;</span>
<a href="#l76.57"></a><span id="l76.57">             }</span>
<a href="#l76.58"></a><span id="l76.58">             this.cancelAllSubRequests();</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineminus">-            var respFunc = this.m_respFunc;</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+            let respFunc = this.m_respFunc;</span>
<a href="#l76.61"></a><span id="l76.61">             if (respFunc) {</span>
<a href="#l76.62"></a><span id="l76.62">                 this.m_respFunc = null; // call once only</span>
<a href="#l76.63"></a><span id="l76.63">                 if (LOG_LEVEL &gt; 2) {</span>
<a href="#l76.64"></a><span id="l76.64">                     log(&quot;response exec: &quot; + errorToString(err), this);</span>
<a href="#l76.65"></a><span id="l76.65">                 }</span>
<a href="#l76.66"></a><span id="l76.66">                 try {</span>
<a href="#l76.67"></a><span id="l76.67">                     respFunc(this, err, data);</span>
<a href="#l76.68"></a><span id="l76.68">                 } catch (exc) {</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineat">@@ -247,21 +247,21 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l76.70"></a><span id="l76.70"> </span>
<a href="#l76.71"></a><span id="l76.71">     /**</span>
<a href="#l76.72"></a><span id="l76.72">      * @see nsIUnicharStreamLoaderObserver</span>
<a href="#l76.73"></a><span id="l76.73">      */</span>
<a href="#l76.74"></a><span id="l76.74">     onDetermineCharset: function calWcapNetworkRequest_onDetermineCharset(loader,</span>
<a href="#l76.75"></a><span id="l76.75">                                                                           context,</span>
<a href="#l76.76"></a><span id="l76.76">                                                                           firstSegment,</span>
<a href="#l76.77"></a><span id="l76.77">                                                                           length) {</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineminus">-        var channel = null;</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+        let channel = null;</span>
<a href="#l76.80"></a><span id="l76.80">         if (loader) {</span>
<a href="#l76.81"></a><span id="l76.81">             channel = loader.channel;</span>
<a href="#l76.82"></a><span id="l76.82">         }</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineminus">-        var charset = null;</span>
<a href="#l76.84"></a><span id="l76.84" class="difflineplus">+        let charset = null;</span>
<a href="#l76.85"></a><span id="l76.85">         if (channel) {</span>
<a href="#l76.86"></a><span id="l76.86">             charset = channel.contentCharset;</span>
<a href="#l76.87"></a><span id="l76.87">         }</span>
<a href="#l76.88"></a><span id="l76.88">         if (!charset || charset.length == 0) {</span>
<a href="#l76.89"></a><span id="l76.89">             charset = &quot;UTF-8&quot;;</span>
<a href="#l76.90"></a><span id="l76.90">         }</span>
<a href="#l76.91"></a><span id="l76.91">         return charset;</span>
<a href="#l76.92"></a><span id="l76.92">     },</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineat">@@ -282,36 +282,36 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l76.94"></a><span id="l76.94">             this.execRespFunc(aStatus);</span>
<a href="#l76.95"></a><span id="l76.95">             return;</span>
<a href="#l76.96"></a><span id="l76.96">         }</span>
<a href="#l76.97"></a><span id="l76.97"> </span>
<a href="#l76.98"></a><span id="l76.98">         if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_bLogging) {</span>
<a href="#l76.99"></a><span id="l76.99">             log(&quot;contentCharset = &quot; + aLoader.charset + &quot;\nrequest result:\n&quot; + unicharData, this);</span>
<a href="#l76.100"></a><span id="l76.100">         }</span>
<a href="#l76.101"></a><span id="l76.101"> </span>
<a href="#l76.102"></a><span id="l76.102" class="difflineminus">-        var httpChannel = aLoader.channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l76.103"></a><span id="l76.103" class="difflineplus">+        let httpChannel = aLoader.channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l76.104"></a><span id="l76.104">         switch (httpChannel.responseStatus / 100) {</span>
<a href="#l76.105"></a><span id="l76.105">             case 2: /* 2xx codes */</span>
<a href="#l76.106"></a><span id="l76.106">                 // Everything worked out, we are done</span>
<a href="#l76.107"></a><span id="l76.107">                 this.execRespFunc(aStatus, unicharData);</span>
<a href="#l76.108"></a><span id="l76.108">                 break;</span>
<a href="#l76.109"></a><span id="l76.109">             default: {</span>
<a href="#l76.110"></a><span id="l76.110">                 // Something else went wrong</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineminus">-                var error = (&quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineplus">+                let error = (&quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l76.113"></a><span id="l76.113">                              httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l76.114"></a><span id="l76.114">                              httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l76.115"></a><span id="l76.115">                              unicharData);</span>
<a href="#l76.116"></a><span id="l76.116">                 this.execRespFunc(Components.Exception(error, NS_BINDING_FAILED));</span>
<a href="#l76.117"></a><span id="l76.117">                 break;</span>
<a href="#l76.118"></a><span id="l76.118">             }</span>
<a href="#l76.119"></a><span id="l76.119">         }</span>
<a href="#l76.120"></a><span id="l76.120">     },</span>
<a href="#l76.121"></a><span id="l76.121"> </span>
<a href="#l76.122"></a><span id="l76.122">     toString: function calWcapNetworkRequest_toString() {</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineminus">-        var ret = (&quot;calWcapNetworkRequest id=&quot; + this.id +</span>
<a href="#l76.124"></a><span id="l76.124" class="difflineplus">+        let ret = (&quot;calWcapNetworkRequest id=&quot; + this.id +</span>
<a href="#l76.125"></a><span id="l76.125">                    &quot;, parent-id=&quot; + (this.parentRequest ? this.parentRequest.id : &quot;&lt;none&gt;&quot;));</span>
<a href="#l76.126"></a><span id="l76.126">         if (this.m_bLogging) {</span>
<a href="#l76.127"></a><span id="l76.127">             ret += (&quot; (&quot; + this.m_url + &quot;)&quot;);</span>
<a href="#l76.128"></a><span id="l76.128">         }</span>
<a href="#l76.129"></a><span id="l76.129">         ret += (&quot;, isPending=&quot; + this.isPending);</span>
<a href="#l76.130"></a><span id="l76.130">         ret += (&quot;, status=&quot; + errorToString(this.status));</span>
<a href="#l76.131"></a><span id="l76.131">         return ret;</span>
<a href="#l76.132"></a><span id="l76.132">     },</span>
<a href="#l76.133"></a><span id="l76.133" class="difflineat">@@ -338,45 +338,45 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l76.134"></a><span id="l76.134">         return this.m_isPending;</span>
<a href="#l76.135"></a><span id="l76.135">     },</span>
<a href="#l76.136"></a><span id="l76.136"> </span>
<a href="#l76.137"></a><span id="l76.137">     get status() {</span>
<a href="#l76.138"></a><span id="l76.138">         return (this.request ? this.request.status : NS_OK);</span>
<a href="#l76.139"></a><span id="l76.139">     },</span>
<a href="#l76.140"></a><span id="l76.140"> </span>
<a href="#l76.141"></a><span id="l76.141">     detachFromParent: function calWcapNetworkRequest_detachFromParent(err) {</span>
<a href="#l76.142"></a><span id="l76.142" class="difflineminus">-        var parentRequest = this.m_parentRequest;</span>
<a href="#l76.143"></a><span id="l76.143" class="difflineplus">+        let parentRequest = this.m_parentRequest;</span>
<a href="#l76.144"></a><span id="l76.144">         if (parentRequest) {</span>
<a href="#l76.145"></a><span id="l76.145">             this.m_parentRequest = null;</span>
<a href="#l76.146"></a><span id="l76.146">             parentRequest.detachSubRequest(this, err);</span>
<a href="#l76.147"></a><span id="l76.147">         }</span>
<a href="#l76.148"></a><span id="l76.148">     },</span>
<a href="#l76.149"></a><span id="l76.149"> </span>
<a href="#l76.150"></a><span id="l76.150">     get request() {</span>
<a href="#l76.151"></a><span id="l76.151">         return (this.m_loader ? this.m_loader.channel : null);</span>
<a href="#l76.152"></a><span id="l76.152">     },</span>
<a href="#l76.153"></a><span id="l76.153"> </span>
<a href="#l76.154"></a><span id="l76.154">     cancel: function calWcapNetworkRequest_cancel(status) {</span>
<a href="#l76.155"></a><span id="l76.155">         if (!status) {</span>
<a href="#l76.156"></a><span id="l76.156">             status = calIErrors.OPERATION_CANCELLED;</span>
<a href="#l76.157"></a><span id="l76.157">         }</span>
<a href="#l76.158"></a><span id="l76.158">         this.execRespFunc(status);</span>
<a href="#l76.159"></a><span id="l76.159">         // xxx todo: check whether this works on redirected channels!</span>
<a href="#l76.160"></a><span id="l76.160" class="difflineminus">-        var request = this.request;</span>
<a href="#l76.161"></a><span id="l76.161" class="difflineplus">+        let request = this.request;</span>
<a href="#l76.162"></a><span id="l76.162">         if (request &amp;&amp; request.isPending()) {</span>
<a href="#l76.163"></a><span id="l76.163">             log(&quot;canceling netwerk request...&quot;, this);</span>
<a href="#l76.164"></a><span id="l76.164">             request.cancel(NS_BINDING_FAILED);</span>
<a href="#l76.165"></a><span id="l76.165">             this.m_loader = null;</span>
<a href="#l76.166"></a><span id="l76.166">         }</span>
<a href="#l76.167"></a><span id="l76.167">     },</span>
<a href="#l76.168"></a><span id="l76.168"> </span>
<a href="#l76.169"></a><span id="l76.169">     execRespFunc: function calWcapNetworkRequest_execRespFunc(err, str) {</span>
<a href="#l76.170"></a><span id="l76.170">         if (this.isPending) {</span>
<a href="#l76.171"></a><span id="l76.171">             this.m_isPending = false;</span>
<a href="#l76.172"></a><span id="l76.172" class="difflineminus">-            var respFunc = this.m_respFunc;</span>
<a href="#l76.173"></a><span id="l76.173" class="difflineplus">+            let respFunc = this.m_respFunc;</span>
<a href="#l76.174"></a><span id="l76.174">             if (respFunc) {</span>
<a href="#l76.175"></a><span id="l76.175">                 this.m_respFunc = null; // call once only</span>
<a href="#l76.176"></a><span id="l76.176">                 if (LOG_LEVEL &gt; 2 &amp;&amp; this.m_bLogging) {</span>
<a href="#l76.177"></a><span id="l76.177">                     log(&quot;response exec: &quot; + errorToString(err), this);</span>
<a href="#l76.178"></a><span id="l76.178">                 }</span>
<a href="#l76.179"></a><span id="l76.179">                 try {</span>
<a href="#l76.180"></a><span id="l76.180">                     respFunc(err, str);</span>
<a href="#l76.181"></a><span id="l76.181">                     err = null; // may have been handled</span>
<a href="#l76.182"></a><span id="l76.182" class="difflineat">@@ -395,73 +395,73 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l76.183"></a><span id="l76.183">             func(err, data);</span>
<a href="#l76.184"></a><span id="l76.184">         } catch (exc) {</span>
<a href="#l76.185"></a><span id="l76.185">             this.execRespFunc(exc);</span>
<a href="#l76.186"></a><span id="l76.186">         }</span>
<a href="#l76.187"></a><span id="l76.187">     }</span>
<a href="#l76.188"></a><span id="l76.188"> };</span>
<a href="#l76.189"></a><span id="l76.189"> </span>
<a href="#l76.190"></a><span id="l76.190"> function issueNetworkRequest(parentRequest, respFunc, url, bLogging) {</span>
<a href="#l76.191"></a><span id="l76.191" class="difflineminus">-    var netRequest = new calWcapNetworkRequest(url, respFunc, bLogging);</span>
<a href="#l76.192"></a><span id="l76.192" class="difflineplus">+    let netRequest = new calWcapNetworkRequest(url, respFunc, bLogging);</span>
<a href="#l76.193"></a><span id="l76.193">     if (parentRequest) {</span>
<a href="#l76.194"></a><span id="l76.194">         parentRequest.attachSubRequest(netRequest);</span>
<a href="#l76.195"></a><span id="l76.195">     }</span>
<a href="#l76.196"></a><span id="l76.196">     try {</span>
<a href="#l76.197"></a><span id="l76.197" class="difflineminus">-        var uri = Services.io.newURI(url, null, null);</span>
<a href="#l76.198"></a><span id="l76.198" class="difflineminus">-        var channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l76.199"></a><span id="l76.199" class="difflineplus">+        let uri = Services.io.newURI(url, null, null);</span>
<a href="#l76.200"></a><span id="l76.200" class="difflineplus">+        let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l76.201"></a><span id="l76.201">                                                      null,</span>
<a href="#l76.202"></a><span id="l76.202">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l76.203"></a><span id="l76.203">                                                      null,</span>
<a href="#l76.204"></a><span id="l76.204">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l76.205"></a><span id="l76.205">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l76.206"></a><span id="l76.206">         netRequest.prepareChannel(channel);</span>
<a href="#l76.207"></a><span id="l76.207">         channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l76.208"></a><span id="l76.208">         channel.redirectionLimit = 3;</span>
<a href="#l76.209"></a><span id="l76.209">         channel.notificationCallbacks = netRequest;</span>
<a href="#l76.210"></a><span id="l76.210" class="difflineminus">-        var loader = Components.classes[&quot;@mozilla.org/network/unichar-stream-loader;1&quot;]</span>
<a href="#l76.211"></a><span id="l76.211" class="difflineplus">+        let loader = Components.classes[&quot;@mozilla.org/network/unichar-stream-loader;1&quot;]</span>
<a href="#l76.212"></a><span id="l76.212">                                .createInstance(Components.interfaces.nsIUnicharStreamLoader);</span>
<a href="#l76.213"></a><span id="l76.213">         netRequest.m_loader = loader;</span>
<a href="#l76.214"></a><span id="l76.214"> </span>
<a href="#l76.215"></a><span id="l76.215">         log(&quot;opening channel.&quot;, netRequest);</span>
<a href="#l76.216"></a><span id="l76.216">         loader.init(netRequest,</span>
<a href="#l76.217"></a><span id="l76.217">                     Components.interfaces.nsIUnicharStreamLoader.DEFAULT_SEGMENT_SIZE);</span>
<a href="#l76.218"></a><span id="l76.218">         channel.asyncOpen(loader, null);</span>
<a href="#l76.219"></a><span id="l76.219">     } catch (exc) {</span>
<a href="#l76.220"></a><span id="l76.220">         netRequest.execRespFunc(exc);</span>
<a href="#l76.221"></a><span id="l76.221">     }</span>
<a href="#l76.222"></a><span id="l76.222"> }</span>
<a href="#l76.223"></a><span id="l76.223"> </span>
<a href="#l76.224"></a><span id="l76.224"> function getWcapRequestStatusString(xml) {</span>
<a href="#l76.225"></a><span id="l76.225" class="difflineminus">-    var str = &quot;request status: &quot;;</span>
<a href="#l76.226"></a><span id="l76.226" class="difflineminus">-    var items = xml.getElementsByTagName(&quot;RSTATUS&quot;);</span>
<a href="#l76.227"></a><span id="l76.227" class="difflineplus">+    let str = &quot;request status: &quot;;</span>
<a href="#l76.228"></a><span id="l76.228" class="difflineplus">+    let items = xml.getElementsByTagName(&quot;RSTATUS&quot;);</span>
<a href="#l76.229"></a><span id="l76.229">     if (items != null &amp;&amp; items.length &gt; 0) {</span>
<a href="#l76.230"></a><span id="l76.230">         str += items.item(0).textContent;</span>
<a href="#l76.231"></a><span id="l76.231">     } else {</span>
<a href="#l76.232"></a><span id="l76.232">         str += &quot;none&quot;;</span>
<a href="#l76.233"></a><span id="l76.233">     }</span>
<a href="#l76.234"></a><span id="l76.234">     return str;</span>
<a href="#l76.235"></a><span id="l76.235"> }</span>
<a href="#l76.236"></a><span id="l76.236"> </span>
<a href="#l76.237"></a><span id="l76.237"> function stringToIcal(session, data, expectedErrno) {</span>
<a href="#l76.238"></a><span id="l76.238">     if (!data || data.length == 0) { // assuming time-out; WTF.</span>
<a href="#l76.239"></a><span id="l76.239">         throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l76.240"></a><span id="l76.240">                                        calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l76.241"></a><span id="l76.241">     }</span>
<a href="#l76.242"></a><span id="l76.242" class="difflineminus">-    var icalRootComp;</span>
<a href="#l76.243"></a><span id="l76.243" class="difflineplus">+    let icalRootComp;</span>
<a href="#l76.244"></a><span id="l76.244">     try {</span>
<a href="#l76.245"></a><span id="l76.245">         icalRootComp = getIcsService().parseICS(data, session /* implements calITimezoneProvider */);</span>
<a href="#l76.246"></a><span id="l76.246">     } catch (exc) { // map into more useful error string:</span>
<a href="#l76.247"></a><span id="l76.247">         throw new Components.Exception(&quot;error parsing ical data!&quot;, calIErrors.ICS_PARSE);</span>
<a href="#l76.248"></a><span id="l76.248">     }</span>
<a href="#l76.249"></a><span id="l76.249">     checkWcapIcalErrno(icalRootComp, expectedErrno);</span>
<a href="#l76.250"></a><span id="l76.250">     return icalRootComp;</span>
<a href="#l76.251"></a><span id="l76.251"> }</span>
<a href="#l76.252"></a><span id="l76.252"> </span>
<a href="#l76.253"></a><span id="l76.253"> function stringToXml(session, data, expectedErrno) {</span>
<a href="#l76.254"></a><span id="l76.254">     if (!data || data.length == 0) { // assuming time-out</span>
<a href="#l76.255"></a><span id="l76.255">         throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l76.256"></a><span id="l76.256">                                        calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l76.257"></a><span id="l76.257">     }</span>
<a href="#l76.258"></a><span id="l76.258" class="difflineminus">-    var xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l76.259"></a><span id="l76.259" class="difflineplus">+    let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l76.260"></a><span id="l76.260">     checkWcapXmlErrno(xml, expectedErrno);</span>
<a href="#l76.261"></a><span id="l76.261">     return xml;</span>
<a href="#l76.262"></a><span id="l76.262"> }</span>
<a href="#l76.263"></a><span id="l76.263"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -137,18 +137,18 @@ calWcapSession.prototype = {</span>
<a href="#l77.4"></a><span id="l77.4">             logError(&quot;no default calendar!&quot;, this);</span>
<a href="#l77.5"></a><span id="l77.5">             logError(err, this);</span>
<a href="#l77.6"></a><span id="l77.6">         }</span>
<a href="#l77.7"></a><span id="l77.7">     },</span>
<a href="#l77.8"></a><span id="l77.8"> </span>
<a href="#l77.9"></a><span id="l77.9">     // calITimezoneProvider:</span>
<a href="#l77.10"></a><span id="l77.10">     m_serverTimezones: null,</span>
<a href="#l77.11"></a><span id="l77.11">     get timezoneIds() {</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-        var tzids = [];</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-        for (var tzid in this.m_serverTimezones) {</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+        let tzids = [];</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineplus">+        for (let tzid in this.m_serverTimezones) {</span>
<a href="#l77.16"></a><span id="l77.16">             tzids.push(tzid);</span>
<a href="#l77.17"></a><span id="l77.17">         }</span>
<a href="#l77.18"></a><span id="l77.18">         return { // nsIUTF8StringEnumerator:</span>
<a href="#l77.19"></a><span id="l77.19">             m_index: 0,</span>
<a href="#l77.20"></a><span id="l77.20">             getNext: function() {</span>
<a href="#l77.21"></a><span id="l77.21">                 if (this.m_index &gt;= tzids) {</span>
<a href="#l77.22"></a><span id="l77.22">                     ASSERT(false, &quot;calWcapSession::timezoneIds enumerator!&quot;);</span>
<a href="#l77.23"></a><span id="l77.23">                     throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineat">@@ -175,17 +175,17 @@ calWcapSession.prototype = {</span>
<a href="#l77.25"></a><span id="l77.25">     },</span>
<a href="#l77.26"></a><span id="l77.26"> </span>
<a href="#l77.27"></a><span id="l77.27">     m_serverTimeDiff: null,</span>
<a href="#l77.28"></a><span id="l77.28">     getServerTime: function calWcapSession_getServerTime(localTime) {</span>
<a href="#l77.29"></a><span id="l77.29">         if (this.m_serverTimeDiff === null) {</span>
<a href="#l77.30"></a><span id="l77.30">             throw new Components.Exception(&quot;early run into getServerTime()!&quot;,</span>
<a href="#l77.31"></a><span id="l77.31">                                            Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l77.32"></a><span id="l77.32">         }</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineminus">-        var ret = (localTime ? localTime.clone() : getTime());</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+        let ret = (localTime ? localTime.clone() : getTime());</span>
<a href="#l77.35"></a><span id="l77.35">         ret.addDuration(this.m_serverTimeDiff);</span>
<a href="#l77.36"></a><span id="l77.36">         return ret;</span>
<a href="#l77.37"></a><span id="l77.37">     },</span>
<a href="#l77.38"></a><span id="l77.38"> </span>
<a href="#l77.39"></a><span id="l77.39">     m_sessionId: null,</span>
<a href="#l77.40"></a><span id="l77.40">     m_loginQueue: null,</span>
<a href="#l77.41"></a><span id="l77.41">     m_loginLock: false,</span>
<a href="#l77.42"></a><span id="l77.42"> </span>
<a href="#l77.43"></a><span id="l77.43" class="difflineat">@@ -213,27 +213,27 @@ calWcapSession.prototype = {</span>
<a href="#l77.44"></a><span id="l77.44">             this.m_sessionId = null; // invalidate for relogin</span>
<a href="#l77.45"></a><span id="l77.45"> </span>
<a href="#l77.46"></a><span id="l77.46">             if (timedOutSessionId) {</span>
<a href="#l77.47"></a><span id="l77.47">                 log(&quot;reconnecting due to session timeout...&quot;, this);</span>
<a href="#l77.48"></a><span id="l77.48">                 getFreeBusyService().removeProvider(this);</span>
<a href="#l77.49"></a><span id="l77.49">                 getCalendarSearchService().removeProvider(this);</span>
<a href="#l77.50"></a><span id="l77.50">             }</span>
<a href="#l77.51"></a><span id="l77.51"> </span>
<a href="#l77.52"></a><span id="l77.52" class="difflineminus">-            var this_ = this;</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineplus">+            let this_ = this;</span>
<a href="#l77.54"></a><span id="l77.54">             this.getSessionId_(null, // don't couple to parent request parent may be cancelled</span>
<a href="#l77.55"></a><span id="l77.55">                                function getSessionId_resp_(err, sessionId) {</span>
<a href="#l77.56"></a><span id="l77.56">                                    log(&quot;getSessionId_resp_(): &quot; + sessionId, this_);</span>
<a href="#l77.57"></a><span id="l77.57">                                    if (!err) {</span>
<a href="#l77.58"></a><span id="l77.58">                                        this_.m_sessionId = sessionId;</span>
<a href="#l77.59"></a><span id="l77.59">                                        getFreeBusyService().addProvider(this_);</span>
<a href="#l77.60"></a><span id="l77.60">                                        getCalendarSearchService().addProvider(this_);</span>
<a href="#l77.61"></a><span id="l77.61">                                    }</span>
<a href="#l77.62"></a><span id="l77.62"> </span>
<a href="#l77.63"></a><span id="l77.63" class="difflineminus">-                                   var queue = this_.m_loginQueue;</span>
<a href="#l77.64"></a><span id="l77.64" class="difflineplus">+                                   let queue = this_.m_loginQueue;</span>
<a href="#l77.65"></a><span id="l77.65">                                    this_.m_loginLock = false;</span>
<a href="#l77.66"></a><span id="l77.66">                                    this_.m_loginQueue = [];</span>
<a href="#l77.67"></a><span id="l77.67">                                    log(&quot;unlocked login queue.&quot;, this_);</span>
<a href="#l77.68"></a><span id="l77.68"> </span>
<a href="#l77.69"></a><span id="l77.69">                                    function getSessionId_exec(func) {</span>
<a href="#l77.70"></a><span id="l77.70">                                        try {</span>
<a href="#l77.71"></a><span id="l77.71">                                            func(err, sessionId);</span>
<a href="#l77.72"></a><span id="l77.72">                                        } catch (exc) { // unexpected</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineat">@@ -247,17 +247,17 @@ calWcapSession.prototype = {</span>
<a href="#l77.74"></a><span id="l77.74">                                });</span>
<a href="#l77.75"></a><span id="l77.75">         }</span>
<a href="#l77.76"></a><span id="l77.76">     },</span>
<a href="#l77.77"></a><span id="l77.77"> </span>
<a href="#l77.78"></a><span id="l77.78">     // this is a server limit for recurrencies; default is 60</span>
<a href="#l77.79"></a><span id="l77.79">     recurrenceBound: 60,</span>
<a href="#l77.80"></a><span id="l77.80"> </span>
<a href="#l77.81"></a><span id="l77.81">     getSessionId_: function calWcapSession_getSessionId_(request, respFunc) {</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.84"></a><span id="l77.84">         this.checkServerVersion(</span>
<a href="#l77.85"></a><span id="l77.85">             request,</span>
<a href="#l77.86"></a><span id="l77.86">             // probe whether server is accessible and responds:</span>
<a href="#l77.87"></a><span id="l77.87">             function checkServerVersion_resp(err) {</span>
<a href="#l77.88"></a><span id="l77.88">                 if (err) {</span>
<a href="#l77.89"></a><span id="l77.89">                     respFunc(err);</span>
<a href="#l77.90"></a><span id="l77.90">                     return;</span>
<a href="#l77.91"></a><span id="l77.91">                 }</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineat">@@ -267,19 +267,19 @@ calWcapSession.prototype = {</span>
<a href="#l77.93"></a><span id="l77.93">                 if (!this_.sessionUri.schemeIs(&quot;https&quot;) &amp;&amp;</span>
<a href="#l77.94"></a><span id="l77.94">                     !confirmInsecureLogin(this_.sessionUri)) {</span>
<a href="#l77.95"></a><span id="l77.95">                     log(&quot;user rejected insecure login on &quot; + this_.sessionUri.spec, this_);</span>
<a href="#l77.96"></a><span id="l77.96">                     respFunc(new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l77.97"></a><span id="l77.97">                                                       calIWcapErrors.WCAP_LOGIN_FAILED));</span>
<a href="#l77.98"></a><span id="l77.98">                     return;</span>
<a href="#l77.99"></a><span id="l77.99">                 }</span>
<a href="#l77.100"></a><span id="l77.100"> </span>
<a href="#l77.101"></a><span id="l77.101" class="difflineminus">-                var outUser = { value: this_.credentials.userId };</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineminus">-                var outPW = { value: this_.credentials.pw };</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineminus">-                var outSavePW = { value: false };</span>
<a href="#l77.104"></a><span id="l77.104" class="difflineplus">+                let outUser = { value: this_.credentials.userId };</span>
<a href="#l77.105"></a><span id="l77.105" class="difflineplus">+                let outPW = { value: this_.credentials.pw };</span>
<a href="#l77.106"></a><span id="l77.106" class="difflineplus">+                let outSavePW = { value: false };</span>
<a href="#l77.107"></a><span id="l77.107"> </span>
<a href="#l77.108"></a><span id="l77.108">                 if (outUser.value &amp;&amp; !outPW.value) { // lookup pw manager</span>
<a href="#l77.109"></a><span id="l77.109">                     log(&quot;looking in pw db for: &quot; + this_.uri.spec, this_);</span>
<a href="#l77.110"></a><span id="l77.110">                     cal.auth.passwordManagerGet(outUser.value, outPW, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l77.111"></a><span id="l77.111">                 }</span>
<a href="#l77.112"></a><span id="l77.112"> </span>
<a href="#l77.113"></a><span id="l77.113">                 function promptAndLoginLoop_resp(loginerr, sessionId) {</span>
<a href="#l77.114"></a><span id="l77.114">                     if (checkErrorCode(loginerr, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineat">@@ -320,37 +320,37 @@ calWcapSession.prototype = {</span>
<a href="#l77.116"></a><span id="l77.116">                     this_.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l77.117"></a><span id="l77.117">                 } else {</span>
<a href="#l77.118"></a><span id="l77.118">                     promptAndLoginLoop_resp(calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l77.119"></a><span id="l77.119">                 }</span>
<a href="#l77.120"></a><span id="l77.120">             });</span>
<a href="#l77.121"></a><span id="l77.121">     },</span>
<a href="#l77.122"></a><span id="l77.122"> </span>
<a href="#l77.123"></a><span id="l77.123">     login: function calWcapSession_login(request, respFunc, user, pw) {</span>
<a href="#l77.124"></a><span id="l77.124" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.125"></a><span id="l77.125" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.126"></a><span id="l77.126">         issueNetworkRequest(</span>
<a href="#l77.127"></a><span id="l77.127">             request,</span>
<a href="#l77.128"></a><span id="l77.128">             function netResp(err, str) {</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineminus">-                var sessionId;</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineplus">+                let sessionId;</span>
<a href="#l77.131"></a><span id="l77.131">                 try {</span>
<a href="#l77.132"></a><span id="l77.132">                     if (err) {</span>
<a href="#l77.133"></a><span id="l77.133">                         throw err;</span>
<a href="#l77.134"></a><span id="l77.134">                     }</span>
<a href="#l77.135"></a><span id="l77.135">                     // currently, xml parsing at an early stage during</span>
<a href="#l77.136"></a><span id="l77.136">                     // process startup does not work reliably, so use</span>
<a href="#l77.137"></a><span id="l77.137">                     // libical parsing for now:</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineminus">-                    var icalRootComp = stringToIcal(this_, str);</span>
<a href="#l77.139"></a><span id="l77.139" class="difflineminus">-                    var prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-SESSION-ID&quot;);</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineplus">+                    let icalRootComp = stringToIcal(this_, str);</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineplus">+                    let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-SESSION-ID&quot;);</span>
<a href="#l77.142"></a><span id="l77.142">                     if (!prop) {</span>
<a href="#l77.143"></a><span id="l77.143">                         throw new Components.Exception(&quot;missing X-NSCP-WCAP-SESSION-ID in\n&quot; + str);</span>
<a href="#l77.144"></a><span id="l77.144">                     }</span>
<a href="#l77.145"></a><span id="l77.145">                     sessionId = prop.value;</span>
<a href="#l77.146"></a><span id="l77.146">                     prop = icalRootComp.getFirstProperty(&quot;X-NSCP-RECURRENCE-BOUND&quot;);</span>
<a href="#l77.147"></a><span id="l77.147">                     if (prop) {</span>
<a href="#l77.148"></a><span id="l77.148" class="difflineminus">-                        var val = parseInt(prop.value, 10);</span>
<a href="#l77.149"></a><span id="l77.149" class="difflineplus">+                        let val = parseInt(prop.value, 10);</span>
<a href="#l77.150"></a><span id="l77.150">                         if (!isNaN(val)) {</span>
<a href="#l77.151"></a><span id="l77.151">                             this_.recurrenceBound = val;</span>
<a href="#l77.152"></a><span id="l77.152">                             log(&quot;X-NSCP-RECURRENCE-BOUND:&quot; + this_.recurrenceBound);</span>
<a href="#l77.153"></a><span id="l77.153">                         }</span>
<a href="#l77.154"></a><span id="l77.154">                     }</span>
<a href="#l77.155"></a><span id="l77.155">                     log(&quot;login succeeded: &quot; + sessionId, this_);</span>
<a href="#l77.156"></a><span id="l77.156">                 } catch (exc) {</span>
<a href="#l77.157"></a><span id="l77.157">                     err = exc;</span>
<a href="#l77.158"></a><span id="l77.158" class="difflineat">@@ -365,31 +365,31 @@ calWcapSession.prototype = {</span>
<a href="#l77.159"></a><span id="l77.159">                 respFunc(err, sessionId);</span>
<a href="#l77.160"></a><span id="l77.160">             },</span>
<a href="#l77.161"></a><span id="l77.161">             this_.sessionUri.spec + &quot;login.wcap?fmt-out=text%2Fcalendar&amp;user=&quot; +</span>
<a href="#l77.162"></a><span id="l77.162">             encodeURIComponent(user) + &quot;&amp;password=&quot; + encodeURIComponent(pw),</span>
<a href="#l77.163"></a><span id="l77.163">             false /* no logging */);</span>
<a href="#l77.164"></a><span id="l77.164">     },</span>
<a href="#l77.165"></a><span id="l77.165"> </span>
<a href="#l77.166"></a><span id="l77.166">     logout: function calWcapSession_logout(listener) {</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.168"></a><span id="l77.168" class="difflineminus">-        var request = new calWcapRequest(</span>
<a href="#l77.169"></a><span id="l77.169" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.170"></a><span id="l77.170" class="difflineplus">+        let request = new calWcapRequest(</span>
<a href="#l77.171"></a><span id="l77.171">             function logout_resp(oprequest, err) {</span>
<a href="#l77.172"></a><span id="l77.172">                 if (err) {</span>
<a href="#l77.173"></a><span id="l77.173">                     logError(err, this_);</span>
<a href="#l77.174"></a><span id="l77.174">                 } else {</span>
<a href="#l77.175"></a><span id="l77.175">                     log(&quot;logout succeeded.&quot;, this_);</span>
<a href="#l77.176"></a><span id="l77.176">                 }</span>
<a href="#l77.177"></a><span id="l77.177">                 if (listener) {</span>
<a href="#l77.178"></a><span id="l77.178">                     listener.onResult(oprequest, null);</span>
<a href="#l77.179"></a><span id="l77.179">                 }</span>
<a href="#l77.180"></a><span id="l77.180">             },</span>
<a href="#l77.181"></a><span id="l77.181">             log(&quot;logout&quot;, this));</span>
<a href="#l77.182"></a><span id="l77.182"> </span>
<a href="#l77.183"></a><span id="l77.183" class="difflineminus">-        var url = null;</span>
<a href="#l77.184"></a><span id="l77.184" class="difflineplus">+        let url = null;</span>
<a href="#l77.185"></a><span id="l77.185">         if (this.m_sessionId) {</span>
<a href="#l77.186"></a><span id="l77.186">             log(&quot;attempting to log out...&quot;, this);</span>
<a href="#l77.187"></a><span id="l77.187">             // although io service's offline flag is already</span>
<a href="#l77.188"></a><span id="l77.188">             // set BEFORE notification</span>
<a href="#l77.189"></a><span id="l77.189">             // (about to go offline, nsIOService.cpp).</span>
<a href="#l77.190"></a><span id="l77.190">             // WTF.</span>
<a href="#l77.191"></a><span id="l77.191">             url = (this.sessionUri.spec + &quot;logout.wcap?fmt-out=text%2Fxml&amp;id=&quot; + this.m_sessionId);</span>
<a href="#l77.192"></a><span id="l77.192">             this.m_sessionId = null;</span>
<a href="#l77.193"></a><span id="l77.193" class="difflineat">@@ -410,22 +410,22 @@ calWcapSession.prototype = {</span>
<a href="#l77.194"></a><span id="l77.194">             request.execRespFunc();</span>
<a href="#l77.195"></a><span id="l77.195">         }</span>
<a href="#l77.196"></a><span id="l77.196">         return request;</span>
<a href="#l77.197"></a><span id="l77.197">     },</span>
<a href="#l77.198"></a><span id="l77.198"> </span>
<a href="#l77.199"></a><span id="l77.199">     checkServerVersion: function calWcapSession_checkServerVersion(request, respFunc) {</span>
<a href="#l77.200"></a><span id="l77.200">         // currently, xml parsing at an early stage during process startup</span>
<a href="#l77.201"></a><span id="l77.201">         // does not work reliably, so use libical:</span>
<a href="#l77.202"></a><span id="l77.202" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.203"></a><span id="l77.203" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.204"></a><span id="l77.204">         issueNetworkRequest(</span>
<a href="#l77.205"></a><span id="l77.205">             request,</span>
<a href="#l77.206"></a><span id="l77.206">             function netResp(err, str) {</span>
<a href="#l77.207"></a><span id="l77.207">                 try {</span>
<a href="#l77.208"></a><span id="l77.208" class="difflineminus">-                    var icalRootComp;</span>
<a href="#l77.209"></a><span id="l77.209" class="difflineplus">+                    let icalRootComp;</span>
<a href="#l77.210"></a><span id="l77.210">                     if (!err) {</span>
<a href="#l77.211"></a><span id="l77.211">                         try {</span>
<a href="#l77.212"></a><span id="l77.212">                             icalRootComp = stringToIcal(this_, str);</span>
<a href="#l77.213"></a><span id="l77.213">                         } catch (exc) {</span>
<a href="#l77.214"></a><span id="l77.214">                             err = exc;</span>
<a href="#l77.215"></a><span id="l77.215">                         }</span>
<a href="#l77.216"></a><span id="l77.216">                     }</span>
<a href="#l77.217"></a><span id="l77.217">                     if (err) {</span>
<a href="#l77.218"></a><span id="l77.218" class="difflineat">@@ -433,48 +433,48 @@ calWcapSession.prototype = {</span>
<a href="#l77.219"></a><span id="l77.219">                             throw err;</span>
<a href="#l77.220"></a><span id="l77.220">                         } else { // soft error; request denied etc.</span>
<a href="#l77.221"></a><span id="l77.221">                                  // map into localized message:</span>
<a href="#l77.222"></a><span id="l77.222">                             throw new Components.Exception(cal.calGetString(&quot;wcap&quot;, &quot;accessingServerFailedError.text&quot;,</span>
<a href="#l77.223"></a><span id="l77.223">                                                                             [this_.sessionUri.hostPort]),</span>
<a href="#l77.224"></a><span id="l77.224">                                                            calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l77.225"></a><span id="l77.225">                         }</span>
<a href="#l77.226"></a><span id="l77.226">                     }</span>
<a href="#l77.227"></a><span id="l77.227" class="difflineminus">-                    var prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAPVERSION&quot;);</span>
<a href="#l77.228"></a><span id="l77.228" class="difflineplus">+                    let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAPVERSION&quot;);</span>
<a href="#l77.229"></a><span id="l77.229">                     if (!prop) {</span>
<a href="#l77.230"></a><span id="l77.230">                         throw new Components.Exception(&quot;missing X-NSCP-WCAPVERSION!&quot;);</span>
<a href="#l77.231"></a><span id="l77.231">                     }</span>
<a href="#l77.232"></a><span id="l77.232" class="difflineminus">-                    var wcapVersion = parseInt(prop.value, 10);</span>
<a href="#l77.233"></a><span id="l77.233" class="difflineplus">+                    let wcapVersion = parseInt(prop.value, 10);</span>
<a href="#l77.234"></a><span id="l77.234">                     if (wcapVersion &lt; 3) {</span>
<a href="#l77.235"></a><span id="l77.235" class="difflineminus">-                        var strVers = prop.value;</span>
<a href="#l77.236"></a><span id="l77.236" class="difflineminus">-                        var vars = [this_.sessionUri.hostPort];</span>
<a href="#l77.237"></a><span id="l77.237" class="difflineplus">+                        let strVers = prop.value;</span>
<a href="#l77.238"></a><span id="l77.238" class="difflineplus">+                        let vars = [this_.sessionUri.hostPort];</span>
<a href="#l77.239"></a><span id="l77.239">                         prop = icalRootComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l77.240"></a><span id="l77.240">                         vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l77.241"></a><span id="l77.241">                         prop = icalRootComp.getFirstProperty(&quot;X-NSCP-SERVERVERSION&quot;);</span>
<a href="#l77.242"></a><span id="l77.242">                         vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l77.243"></a><span id="l77.243">                         vars.push(strVers);</span>
<a href="#l77.244"></a><span id="l77.244"> </span>
<a href="#l77.245"></a><span id="l77.245" class="difflineminus">-                        var prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l77.246"></a><span id="l77.246" class="difflineminus">-                        var labelText = cal.calGetString(&quot;wcap&quot;, &quot;insufficientWcapVersionConfirmation.label&quot;);</span>
<a href="#l77.247"></a><span id="l77.247" class="difflineplus">+                        let prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l77.248"></a><span id="l77.248" class="difflineplus">+                        let labelText = cal.calGetString(&quot;wcap&quot;, &quot;insufficientWcapVersionConfirmation.label&quot;);</span>
<a href="#l77.249"></a><span id="l77.249">                         if (!prompt.confirm(labelText,</span>
<a href="#l77.250"></a><span id="l77.250">                                             cal.calGetString(&quot;wcap&quot;, &quot;insufficientWcapVersionConfirmation.text&quot;, vars))) {</span>
<a href="#l77.251"></a><span id="l77.251">                             throw new Components.Exception(labelText, calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l77.252"></a><span id="l77.252">                         }</span>
<a href="#l77.253"></a><span id="l77.253">                     }</span>
<a href="#l77.254"></a><span id="l77.254">                 } catch (exc) {</span>
<a href="#l77.255"></a><span id="l77.255">                     err = exc;</span>
<a href="#l77.256"></a><span id="l77.256">                 }</span>
<a href="#l77.257"></a><span id="l77.257">                 respFunc(err);</span>
<a href="#l77.258"></a><span id="l77.258">             },</span>
<a href="#l77.259"></a><span id="l77.259">             this_.sessionUri.spec + &quot;version.wcap?fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l77.260"></a><span id="l77.260">     },</span>
<a href="#l77.261"></a><span id="l77.261"> </span>
<a href="#l77.262"></a><span id="l77.262">     setupSession: function calWcapSession_setupSession(sessionId, request_, respFunc) {</span>
<a href="#l77.263"></a><span id="l77.263" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.264"></a><span id="l77.264" class="difflineminus">-        var request = new calWcapRequest(</span>
<a href="#l77.265"></a><span id="l77.265" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.266"></a><span id="l77.266" class="difflineplus">+        let request = new calWcapRequest(</span>
<a href="#l77.267"></a><span id="l77.267">             function setupSession_resp(oprequest, err) {</span>
<a href="#l77.268"></a><span id="l77.268">                 log(&quot;setupSession_resp finished: &quot; + errorToString(err), this_);</span>
<a href="#l77.269"></a><span id="l77.269">                 respFunc(err);</span>
<a href="#l77.270"></a><span id="l77.270">             },</span>
<a href="#l77.271"></a><span id="l77.271">             log(&quot;setupSession&quot;, this));</span>
<a href="#l77.272"></a><span id="l77.272">         if (request_) {</span>
<a href="#l77.273"></a><span id="l77.273">             request_.attachSubRequest(request);</span>
<a href="#l77.274"></a><span id="l77.274">         }</span>
<a href="#l77.275"></a><span id="l77.275" class="difflineat">@@ -486,33 +486,33 @@ calWcapSession.prototype = {</span>
<a href="#l77.276"></a><span id="l77.276">                 function userprefs_resp(err, data) {</span>
<a href="#l77.277"></a><span id="l77.277">                     if (err) {</span>
<a href="#l77.278"></a><span id="l77.278">                         throw err;</span>
<a href="#l77.279"></a><span id="l77.279">                     }</span>
<a href="#l77.280"></a><span id="l77.280">                     this_.credentials.userPrefs = data;</span>
<a href="#l77.281"></a><span id="l77.281">                     log(&quot;installed user prefs.&quot;, this_);</span>
<a href="#l77.282"></a><span id="l77.282"> </span>
<a href="#l77.283"></a><span id="l77.283">                     // get calprops for all registered calendars:</span>
<a href="#l77.284"></a><span id="l77.284" class="difflineminus">-                    var cals = this_.getRegisteredCalendars(true);</span>
<a href="#l77.285"></a><span id="l77.285" class="difflineplus">+                    let cals = this_.getRegisteredCalendars(true);</span>
<a href="#l77.286"></a><span id="l77.286"> </span>
<a href="#l77.287"></a><span id="l77.287" class="difflineminus">-                    var calprops_resp = null;</span>
<a href="#l77.288"></a><span id="l77.288" class="difflineminus">-                    var defaultCal = this_.defaultCalendar;</span>
<a href="#l77.289"></a><span id="l77.289" class="difflineplus">+                    let calprops_resp = null;</span>
<a href="#l77.290"></a><span id="l77.290" class="difflineplus">+                    let defaultCal = this_.defaultCalendar;</span>
<a href="#l77.291"></a><span id="l77.291">                     if (defaultCal &amp;&amp; cals[defaultCal.calId] &amp;&amp; // default calendar is registered</span>
<a href="#l77.292"></a><span id="l77.292">                         getPref(&quot;calendar.wcap.subscriptions&quot;, true) &amp;&amp;</span>
<a href="#l77.293"></a><span id="l77.293">                         !defaultCal.getProperty(&quot;subscriptions_registered&quot;)) {</span>
<a href="#l77.294"></a><span id="l77.294" class="difflineminus">-                        var hasSubscriptions = false;</span>
<a href="#l77.295"></a><span id="l77.295" class="difflineplus">+                        let hasSubscriptions = false;</span>
<a href="#l77.296"></a><span id="l77.296">                         // post register subscribed calendars:</span>
<a href="#l77.297"></a><span id="l77.297" class="difflineminus">-                        var list = this_.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsSubscribed&quot;);</span>
<a href="#l77.298"></a><span id="l77.298" class="difflineminus">-                        for (var item of list) {</span>
<a href="#l77.299"></a><span id="l77.299" class="difflineminus">-                            var ar = item.split(',');</span>
<a href="#l77.300"></a><span id="l77.300" class="difflineplus">+                        let list = this_.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsSubscribed&quot;);</span>
<a href="#l77.301"></a><span id="l77.301" class="difflineplus">+                        for (let item of list) {</span>
<a href="#l77.302"></a><span id="l77.302" class="difflineplus">+                            let ar = item.split(',');</span>
<a href="#l77.303"></a><span id="l77.303">                             // ',', '$' are not encoded. ',' can be handled here. WTF.</span>
<a href="#l77.304"></a><span id="l77.304" class="difflineminus">-                            for (var a of ar) {</span>
<a href="#l77.305"></a><span id="l77.305" class="difflineminus">-                                var dollar = a.indexOf('$');</span>
<a href="#l77.306"></a><span id="l77.306" class="difflineplus">+                            for (let a of ar) {</span>
<a href="#l77.307"></a><span id="l77.307" class="difflineplus">+                                let dollar = a.indexOf('$');</span>
<a href="#l77.308"></a><span id="l77.308">                                 if (dollar &gt;= 0) {</span>
<a href="#l77.309"></a><span id="l77.309" class="difflineminus">-                                    var calId = a.substring(0, dollar);</span>
<a href="#l77.310"></a><span id="l77.310" class="difflineplus">+                                    let calId = a.substring(0, dollar);</span>
<a href="#l77.311"></a><span id="l77.311">                                     if (calId != this_.defaultCalId) {</span>
<a href="#l77.312"></a><span id="l77.312">                                         cals[calId] = null;</span>
<a href="#l77.313"></a><span id="l77.313">                                         hasSubscriptions = true;</span>
<a href="#l77.314"></a><span id="l77.314">                                     }</span>
<a href="#l77.315"></a><span id="l77.315">                                 }</span>
<a href="#l77.316"></a><span id="l77.316">                             }</span>
<a href="#l77.317"></a><span id="l77.317">                         }</span>
<a href="#l77.318"></a><span id="l77.318"> </span>
<a href="#l77.319"></a><span id="l77.319" class="difflineat">@@ -549,76 +549,76 @@ calWcapSession.prototype = {</span>
<a href="#l77.320"></a><span id="l77.320">             this.installServerTimezones(sessionId, request);</span>
<a href="#l77.321"></a><span id="l77.321">         } finally {</span>
<a href="#l77.322"></a><span id="l77.322">             request.unlockPending();</span>
<a href="#l77.323"></a><span id="l77.323">         }</span>
<a href="#l77.324"></a><span id="l77.324">     },</span>
<a href="#l77.325"></a><span id="l77.325"> </span>
<a href="#l77.326"></a><span id="l77.326">     installCalProps_get_calprops:</span>
<a href="#l77.327"></a><span id="l77.327">     function calWcapSession_installCalProps_get_calprops(respFunc, sessionId, cals, request) {</span>
<a href="#l77.328"></a><span id="l77.328" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.329"></a><span id="l77.329" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.330"></a><span id="l77.330">         function calprops_resp(err, data) {</span>
<a href="#l77.331"></a><span id="l77.331">             if (err) {</span>
<a href="#l77.332"></a><span id="l77.332">                 throw err;</span>
<a href="#l77.333"></a><span id="l77.333">             }</span>
<a href="#l77.334"></a><span id="l77.334">             // string to xml converter func without WCAP errno check:</span>
<a href="#l77.335"></a><span id="l77.335">             if (!data || data.length == 0) { // assuming time-out</span>
<a href="#l77.336"></a><span id="l77.336">                 throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l77.337"></a><span id="l77.337">                                                calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l77.338"></a><span id="l77.338">             }</span>
<a href="#l77.339"></a><span id="l77.339" class="difflineminus">-            var xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l77.340"></a><span id="l77.340" class="difflineminus">-            var nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l77.341"></a><span id="l77.341" class="difflineminus">-            for (var i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l77.342"></a><span id="l77.342" class="difflineplus">+            let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l77.343"></a><span id="l77.343" class="difflineplus">+            let nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l77.344"></a><span id="l77.344" class="difflineplus">+            for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l77.345"></a><span id="l77.345">                 try {</span>
<a href="#l77.346"></a><span id="l77.346" class="difflineminus">-                    var node = nodeList.item(i);</span>
<a href="#l77.347"></a><span id="l77.347" class="difflineplus">+                    let node = nodeList.item(i);</span>
<a href="#l77.348"></a><span id="l77.348">                     checkWcapXmlErrno(node);</span>
<a href="#l77.349"></a><span id="l77.349" class="difflineminus">-                    var ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l77.350"></a><span id="l77.350" class="difflineplus">+                    let ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l77.351"></a><span id="l77.351">                     if (ar.length &gt; 0) {</span>
<a href="#l77.352"></a><span id="l77.352" class="difflineminus">-                        var calId = ar[0];</span>
<a href="#l77.353"></a><span id="l77.353" class="difflineplus">+                        let calId = ar[0];</span>
<a href="#l77.354"></a><span id="l77.354">                         let calendar = cals[calId];</span>
<a href="#l77.355"></a><span id="l77.355">                         if (calendar === null) {</span>
<a href="#l77.356"></a><span id="l77.356">                             calendar = new calWcapCalendar(this_);</span>
<a href="#l77.357"></a><span id="l77.357" class="difflineminus">-                            var uri = this_.uri.clone();</span>
<a href="#l77.358"></a><span id="l77.358" class="difflineplus">+                            let uri = this_.uri.clone();</span>
<a href="#l77.359"></a><span id="l77.359">                             uri.path += (&quot;?calid=&quot; + encodeURIComponent(calId));</span>
<a href="#l77.360"></a><span id="l77.360">                             calendar.uri = uri;</span>
<a href="#l77.361"></a><span id="l77.361">                         }</span>
<a href="#l77.362"></a><span id="l77.362">                         if (calendar) {</span>
<a href="#l77.363"></a><span id="l77.363">                             calendar.m_calProps = node;</span>
<a href="#l77.364"></a><span id="l77.364">                             if (respFunc) {</span>
<a href="#l77.365"></a><span id="l77.365">                                 respFunc(calendar);</span>
<a href="#l77.366"></a><span id="l77.366">                             }</span>
<a href="#l77.367"></a><span id="l77.367">                         }</span>
<a href="#l77.368"></a><span id="l77.368">                     }</span>
<a href="#l77.369"></a><span id="l77.369">                 } catch (exc) { // ignore but log any errors on subscribed calendars:</span>
<a href="#l77.370"></a><span id="l77.370">                     logError(exc, this_);</span>
<a href="#l77.371"></a><span id="l77.371">                 }</span>
<a href="#l77.372"></a><span id="l77.372">             }</span>
<a href="#l77.373"></a><span id="l77.373">         }</span>
<a href="#l77.374"></a><span id="l77.374"> </span>
<a href="#l77.375"></a><span id="l77.375" class="difflineminus">-        var calidParam = &quot;&quot;;</span>
<a href="#l77.376"></a><span id="l77.376" class="difflineminus">-        for (var calId in cals) {</span>
<a href="#l77.377"></a><span id="l77.377" class="difflineplus">+        let calidParam = &quot;&quot;;</span>
<a href="#l77.378"></a><span id="l77.378" class="difflineplus">+        for (let calId in cals) {</span>
<a href="#l77.379"></a><span id="l77.379">             if (calidParam.length &gt; 0) {</span>
<a href="#l77.380"></a><span id="l77.380">                 calidParam += &quot;;&quot;;</span>
<a href="#l77.381"></a><span id="l77.381">             }</span>
<a href="#l77.382"></a><span id="l77.382">             calidParam += encodeURIComponent(calId);</span>
<a href="#l77.383"></a><span id="l77.383">         }</span>
<a href="#l77.384"></a><span id="l77.384">         this_.issueNetworkRequest_(request, calprops_resp,</span>
<a href="#l77.385"></a><span id="l77.385">                                    null, &quot;get_calprops&quot;,</span>
<a href="#l77.386"></a><span id="l77.386">                                    &quot;&amp;fmt-out=text%2Fxml&amp;calid=&quot; + calidParam,</span>
<a href="#l77.387"></a><span id="l77.387">                                    sessionId);</span>
<a href="#l77.388"></a><span id="l77.388">     },</span>
<a href="#l77.389"></a><span id="l77.389"> </span>
<a href="#l77.390"></a><span id="l77.390">     installCalProps_search_calprops:</span>
<a href="#l77.391"></a><span id="l77.391">     function calWcapSession_installCalProps_search_calprops(respFunc, sessionId, cals, request) {</span>
<a href="#l77.392"></a><span id="l77.392" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.393"></a><span id="l77.393" class="difflineminus">-        var retrievedCals = {};</span>
<a href="#l77.394"></a><span id="l77.394" class="difflineminus">-        var issuedSearchRequests = {};</span>
<a href="#l77.395"></a><span id="l77.395" class="difflineminus">-        for (var calId in cals) {</span>
<a href="#l77.396"></a><span id="l77.396" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.397"></a><span id="l77.397" class="difflineplus">+        let retrievedCals = {};</span>
<a href="#l77.398"></a><span id="l77.398" class="difflineplus">+        let issuedSearchRequests = {};</span>
<a href="#l77.399"></a><span id="l77.399" class="difflineplus">+        for (let calId in cals) {</span>
<a href="#l77.400"></a><span id="l77.400">             if (!retrievedCals[calId]) {</span>
<a href="#l77.401"></a><span id="l77.401" class="difflineminus">-                var listener = {</span>
<a href="#l77.402"></a><span id="l77.402" class="difflineplus">+                let listener = {</span>
<a href="#l77.403"></a><span id="l77.403">                     onResult: function search_onResult(oprequest, result) {</span>
<a href="#l77.404"></a><span id="l77.404">                         try {</span>
<a href="#l77.405"></a><span id="l77.405">                             if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l77.406"></a><span id="l77.406">                                 throw oprequest.status;</span>
<a href="#l77.407"></a><span id="l77.407">                             }</span>
<a href="#l77.408"></a><span id="l77.408">                             if (result.length &lt; 1) {</span>
<a href="#l77.409"></a><span id="l77.409">                                 throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l77.410"></a><span id="l77.410">                             }</span>
<a href="#l77.411"></a><span id="l77.411" class="difflineat">@@ -638,51 +638,51 @@ calWcapSession.prototype = {</span>
<a href="#l77.412"></a><span id="l77.412">                                 }</span>
<a href="#l77.413"></a><span id="l77.413">                             }</span>
<a href="#l77.414"></a><span id="l77.414">                         } catch (exc) { // ignore but log any errors on subscribed calendars:</span>
<a href="#l77.415"></a><span id="l77.415">                             logError(exc, this_);</span>
<a href="#l77.416"></a><span id="l77.416">                         }</span>
<a href="#l77.417"></a><span id="l77.417">                     }</span>
<a href="#l77.418"></a><span id="l77.418">                 };</span>
<a href="#l77.419"></a><span id="l77.419"> </span>
<a href="#l77.420"></a><span id="l77.420" class="difflineminus">-                var colon = calId.indexOf(':');</span>
<a href="#l77.421"></a><span id="l77.421" class="difflineplus">+                let colon = calId.indexOf(':');</span>
<a href="#l77.422"></a><span id="l77.422">                 if (colon &gt;= 0) { // searching for secondary calendars doesn't work. WTF.</span>
<a href="#l77.423"></a><span id="l77.423">                     calId = calId.substring(0, colon);</span>
<a href="#l77.424"></a><span id="l77.424">                 }</span>
<a href="#l77.425"></a><span id="l77.425">                 if (!issuedSearchRequests[calId]) {</span>
<a href="#l77.426"></a><span id="l77.426">                     issuedSearchRequests[calId] = true;</span>
<a href="#l77.427"></a><span id="l77.427">                     this.searchForCalendars(calId, calICalendarSearchProvider.HINT_EXACT_MATCH, 20, listener);</span>
<a href="#l77.428"></a><span id="l77.428">                 }</span>
<a href="#l77.429"></a><span id="l77.429">             }</span>
<a href="#l77.430"></a><span id="l77.430">         }</span>
<a href="#l77.431"></a><span id="l77.431">     },</span>
<a href="#l77.432"></a><span id="l77.432"> </span>
<a href="#l77.433"></a><span id="l77.433">     installServerTimeDiff: function calWcapSession_installServerTimeDiff(sessionId, request) {</span>
<a href="#l77.434"></a><span id="l77.434" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.435"></a><span id="l77.435" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.436"></a><span id="l77.436">         this.issueNetworkRequest_(</span>
<a href="#l77.437"></a><span id="l77.437">             request,</span>
<a href="#l77.438"></a><span id="l77.438">             function netResp(err, data) {</span>
<a href="#l77.439"></a><span id="l77.439">                 if (err) {</span>
<a href="#l77.440"></a><span id="l77.440">                     throw err;</span>
<a href="#l77.441"></a><span id="l77.441">                 }</span>
<a href="#l77.442"></a><span id="l77.442">                 // xxx todo: think about</span>
<a href="#l77.443"></a><span id="l77.443">                 // assure that locally calculated server time is smaller</span>
<a href="#l77.444"></a><span id="l77.444">                 // than the current (real) server time:</span>
<a href="#l77.445"></a><span id="l77.445" class="difflineminus">-                var localTime = getTime();</span>
<a href="#l77.446"></a><span id="l77.446" class="difflineminus">-                var serverTime = getDatetimeFromIcalProp(data.getFirstProperty(&quot;X-NSCP-WCAPTIME&quot;));</span>
<a href="#l77.447"></a><span id="l77.447" class="difflineplus">+                let localTime = getTime();</span>
<a href="#l77.448"></a><span id="l77.448" class="difflineplus">+                let serverTime = getDatetimeFromIcalProp(data.getFirstProperty(&quot;X-NSCP-WCAPTIME&quot;));</span>
<a href="#l77.449"></a><span id="l77.449">                 this_.m_serverTimeDiff = serverTime.subtractDate(localTime);</span>
<a href="#l77.450"></a><span id="l77.450">                 log(&quot;server time diff is: &quot; + this_.m_serverTimeDiff, this_);</span>
<a href="#l77.451"></a><span id="l77.451">             },</span>
<a href="#l77.452"></a><span id="l77.452">             stringToIcal, &quot;gettime&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l77.453"></a><span id="l77.453">             sessionId);</span>
<a href="#l77.454"></a><span id="l77.454">     },</span>
<a href="#l77.455"></a><span id="l77.455"> </span>
<a href="#l77.456"></a><span id="l77.456">     installServerTimezones: function calWcapSession_installServerTimezones(sessionId, request) {</span>
<a href="#l77.457"></a><span id="l77.457">         this.m_serverTimezones = {};</span>
<a href="#l77.458"></a><span id="l77.458" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.459"></a><span id="l77.459" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.460"></a><span id="l77.460">         this_.issueNetworkRequest_(</span>
<a href="#l77.461"></a><span id="l77.461">             request,</span>
<a href="#l77.462"></a><span id="l77.462">             function netResp(err, data) {</span>
<a href="#l77.463"></a><span id="l77.463">                 if (err) {</span>
<a href="#l77.464"></a><span id="l77.464">                     throw err;</span>
<a href="#l77.465"></a><span id="l77.465">                 }</span>
<a href="#l77.466"></a><span id="l77.466">                 for (let subComp of cal.ical.calendarComponentIterator(data, &quot;VTIMEZONE&quot;)) {</span>
<a href="#l77.467"></a><span id="l77.467">                     try {</span>
<a href="#l77.468"></a><span id="l77.468" class="difflineat">@@ -694,27 +694,27 @@ calWcapSession.prototype = {</span>
<a href="#l77.469"></a><span id="l77.469">                 }</span>
<a href="#l77.470"></a><span id="l77.470">                 log(&quot;installed timezones.&quot;, this_);</span>
<a href="#l77.471"></a><span id="l77.471">             },</span>
<a href="#l77.472"></a><span id="l77.472">             stringToIcal, &quot;get_all_timezones&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l77.473"></a><span id="l77.473">             sessionId);</span>
<a href="#l77.474"></a><span id="l77.474">     },</span>
<a href="#l77.475"></a><span id="l77.475"> </span>
<a href="#l77.476"></a><span id="l77.476">     getCommandUrl: function calWcapSession_getCommandUrl(wcapCommand, params, sessionId) {</span>
<a href="#l77.477"></a><span id="l77.477" class="difflineminus">-        var url = this.sessionUri.spec;</span>
<a href="#l77.478"></a><span id="l77.478" class="difflineplus">+        let url = this.sessionUri.spec;</span>
<a href="#l77.479"></a><span id="l77.479">         url += (wcapCommand + &quot;.wcap?appid=mozilla-calendar&amp;id=&quot;);</span>
<a href="#l77.480"></a><span id="l77.480">         url += sessionId;</span>
<a href="#l77.481"></a><span id="l77.481">         url += params;</span>
<a href="#l77.482"></a><span id="l77.482">         return url;</span>
<a href="#l77.483"></a><span id="l77.483">     },</span>
<a href="#l77.484"></a><span id="l77.484"> </span>
<a href="#l77.485"></a><span id="l77.485">     issueNetworkRequest: function calWcapSession_issueNetworkRequest(</span>
<a href="#l77.486"></a><span id="l77.486">                     request, respFunc, dataConvFunc, wcapCommand, params) {</span>
<a href="#l77.487"></a><span id="l77.487" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.488"></a><span id="l77.488" class="difflineminus">-        function getSessionId_resp(err, sessionId) {</span>
<a href="#l77.489"></a><span id="l77.489" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.490"></a><span id="l77.490" class="difflineplus">+        let getSessionId_resp = function(err, sessionId) {</span>
<a href="#l77.491"></a><span id="l77.491">             if (err) {</span>
<a href="#l77.492"></a><span id="l77.492">                 request.execSubRespFunc(respFunc, err);</span>
<a href="#l77.493"></a><span id="l77.493">             } else {</span>
<a href="#l77.494"></a><span id="l77.494">                 // else have session uri and id:</span>
<a href="#l77.495"></a><span id="l77.495">                 this_.issueNetworkRequest_(</span>
<a href="#l77.496"></a><span id="l77.496">                     request,</span>
<a href="#l77.497"></a><span id="l77.497">                     function issueNetworkRequest_resp(loginerr, data) {</span>
<a href="#l77.498"></a><span id="l77.498">                         // timeout?</span>
<a href="#l77.499"></a><span id="l77.499" class="difflineat">@@ -725,27 +725,27 @@ calWcapSession.prototype = {</span>
<a href="#l77.500"></a><span id="l77.500">                                 getSessionId_resp,</span>
<a href="#l77.501"></a><span id="l77.501">                                 sessionId/* (old) timed-out session */);</span>
<a href="#l77.502"></a><span id="l77.502">                             return;</span>
<a href="#l77.503"></a><span id="l77.503">                         }</span>
<a href="#l77.504"></a><span id="l77.504">                         request.execSubRespFunc(respFunc, loginerr, data);</span>
<a href="#l77.505"></a><span id="l77.505">                     },</span>
<a href="#l77.506"></a><span id="l77.506">                     dataConvFunc, wcapCommand, params, sessionId);</span>
<a href="#l77.507"></a><span id="l77.507">             }</span>
<a href="#l77.508"></a><span id="l77.508" class="difflineminus">-        }</span>
<a href="#l77.509"></a><span id="l77.509" class="difflineplus">+        };</span>
<a href="#l77.510"></a><span id="l77.510">         this.getSessionId(request, getSessionId_resp);</span>
<a href="#l77.511"></a><span id="l77.511">     },</span>
<a href="#l77.512"></a><span id="l77.512"> </span>
<a href="#l77.513"></a><span id="l77.513">     issueNetworkRequest_: function calWcapSession_issueNetworkRequest_(</span>
<a href="#l77.514"></a><span id="l77.514">                     request, respFunc, dataConvFunc, wcapCommand, params, sessionId) {</span>
<a href="#l77.515"></a><span id="l77.515" class="difflineminus">-        var url = this.getCommandUrl(wcapCommand, params, sessionId);</span>
<a href="#l77.516"></a><span id="l77.516" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.517"></a><span id="l77.517" class="difflineplus">+        let url = this.getCommandUrl(wcapCommand, params, sessionId);</span>
<a href="#l77.518"></a><span id="l77.518" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.519"></a><span id="l77.519">         issueNetworkRequest(request,</span>
<a href="#l77.520"></a><span id="l77.520">                             function netResp(err, str) {</span>
<a href="#l77.521"></a><span id="l77.521" class="difflineminus">-                                var data;</span>
<a href="#l77.522"></a><span id="l77.522" class="difflineplus">+                                let data;</span>
<a href="#l77.523"></a><span id="l77.523">                                 if (!err) {</span>
<a href="#l77.524"></a><span id="l77.524">                                     try {</span>
<a href="#l77.525"></a><span id="l77.525">                                         if (dataConvFunc) {</span>
<a href="#l77.526"></a><span id="l77.526">                                             data = dataConvFunc(this_, str);</span>
<a href="#l77.527"></a><span id="l77.527">                                         } else {</span>
<a href="#l77.528"></a><span id="l77.528">                                             data = str;</span>
<a href="#l77.529"></a><span id="l77.529">                                         }</span>
<a href="#l77.530"></a><span id="l77.530">                                     } catch (exc) {</span>
<a href="#l77.531"></a><span id="l77.531" class="difflineat">@@ -781,19 +781,19 @@ calWcapSession.prototype = {</span>
<a href="#l77.532"></a><span id="l77.532">         this.m_sessionUri.userPass = &quot;&quot;;</span>
<a href="#l77.533"></a><span id="l77.533">     },</span>
<a href="#l77.534"></a><span id="l77.534"> </span>
<a href="#l77.535"></a><span id="l77.535">     get userId() {</span>
<a href="#l77.536"></a><span id="l77.536">         return this.credentials.userId;</span>
<a href="#l77.537"></a><span id="l77.537">     },</span>
<a href="#l77.538"></a><span id="l77.538"> </span>
<a href="#l77.539"></a><span id="l77.539">     get defaultCalId() {</span>
<a href="#l77.540"></a><span id="l77.540" class="difflineminus">-        var list = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsCalendar&quot;);</span>
<a href="#l77.541"></a><span id="l77.541" class="difflineminus">-        var id = null;</span>
<a href="#l77.542"></a><span id="l77.542" class="difflineminus">-        for (var item of list) {</span>
<a href="#l77.543"></a><span id="l77.543" class="difflineplus">+        let list = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsCalendar&quot;);</span>
<a href="#l77.544"></a><span id="l77.544" class="difflineplus">+        let id = null;</span>
<a href="#l77.545"></a><span id="l77.545" class="difflineplus">+        for (let item of list) {</span>
<a href="#l77.546"></a><span id="l77.546">             if (item.length &gt; 0) {</span>
<a href="#l77.547"></a><span id="l77.547">                 id = item;</span>
<a href="#l77.548"></a><span id="l77.548">                 break;</span>
<a href="#l77.549"></a><span id="l77.549">             }</span>
<a href="#l77.550"></a><span id="l77.550">         }</span>
<a href="#l77.551"></a><span id="l77.551">         return (id ? id : this.credentials.userId);</span>
<a href="#l77.552"></a><span id="l77.552">     },</span>
<a href="#l77.553"></a><span id="l77.553"> </span>
<a href="#l77.554"></a><span id="l77.554" class="difflineat">@@ -830,63 +830,63 @@ calWcapSession.prototype = {</span>
<a href="#l77.555"></a><span id="l77.555">                     registeredCalendars.push(calendar);</span>
<a href="#l77.556"></a><span id="l77.556">                 }</span>
<a href="#l77.557"></a><span id="l77.557">             }</span>
<a href="#l77.558"></a><span id="l77.558">         }</span>
<a href="#l77.559"></a><span id="l77.559">         return registeredCalendars;</span>
<a href="#l77.560"></a><span id="l77.560">     },</span>
<a href="#l77.561"></a><span id="l77.561"> </span>
<a href="#l77.562"></a><span id="l77.562">     getUserPreferences: function calWcapSession_getUserPreferences(prefName) {</span>
<a href="#l77.563"></a><span id="l77.563" class="difflineminus">-        var prefs = filterXmlNodes(prefName, this.credentials.userPrefs);</span>
<a href="#l77.564"></a><span id="l77.564" class="difflineplus">+        let prefs = filterXmlNodes(prefName, this.credentials.userPrefs);</span>
<a href="#l77.565"></a><span id="l77.565">         return prefs;</span>
<a href="#l77.566"></a><span id="l77.566">     },</span>
<a href="#l77.567"></a><span id="l77.567"> </span>
<a href="#l77.568"></a><span id="l77.568">     get defaultAlarmStart() {</span>
<a href="#l77.569"></a><span id="l77.569" class="difflineminus">-        var alarmStart = null;</span>
<a href="#l77.570"></a><span id="l77.570" class="difflineminus">-        var ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmStart&quot;);</span>
<a href="#l77.571"></a><span id="l77.571" class="difflineplus">+        let alarmStart = null;</span>
<a href="#l77.572"></a><span id="l77.572" class="difflineplus">+        let ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmStart&quot;);</span>
<a href="#l77.573"></a><span id="l77.573">         if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l77.574"></a><span id="l77.574">             // workarounding cs duration bug, missing &quot;T&quot;:</span>
<a href="#l77.575"></a><span id="l77.575" class="difflineminus">-            var dur = ar[0].replace(/(^P)(\d+[HMS]$)/, &quot;$1T$2&quot;);</span>
<a href="#l77.576"></a><span id="l77.576" class="difflineplus">+            let dur = ar[0].replace(/(^P)(\d+[HMS]$)/, &quot;$1T$2&quot;);</span>
<a href="#l77.577"></a><span id="l77.577">             alarmStart = cal.createDuration(dur);</span>
<a href="#l77.578"></a><span id="l77.578">             alarmStart.isNegative = !alarmStart.isNegative;</span>
<a href="#l77.579"></a><span id="l77.579">         }</span>
<a href="#l77.580"></a><span id="l77.580">         return alarmStart;</span>
<a href="#l77.581"></a><span id="l77.581">     },</span>
<a href="#l77.582"></a><span id="l77.582"> </span>
<a href="#l77.583"></a><span id="l77.583">     getDefaultAlarmEmails: function calWcapSession_getDefaultAlarmEmails(out_count) {</span>
<a href="#l77.584"></a><span id="l77.584" class="difflineminus">-        var ret = [];</span>
<a href="#l77.585"></a><span id="l77.585" class="difflineminus">-        var ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmEmail&quot;);</span>
<a href="#l77.586"></a><span id="l77.586" class="difflineplus">+        let ret = [];</span>
<a href="#l77.587"></a><span id="l77.587" class="difflineplus">+        let ar = this.getUserPreferences(&quot;X-NSCP-WCAP-PREF-ceDefaultAlarmEmail&quot;);</span>
<a href="#l77.588"></a><span id="l77.588">         if (ar.length &gt; 0 &amp;&amp; ar[0].length &gt; 0) {</span>
<a href="#l77.589"></a><span id="l77.589" class="difflineminus">-            for (var i of ar) {</span>
<a href="#l77.590"></a><span id="l77.590" class="difflineplus">+            for (let i of ar) {</span>
<a href="#l77.591"></a><span id="l77.591">                 ret = ret.concat(i.split(/[;,]/).map(String.trim));</span>
<a href="#l77.592"></a><span id="l77.592">             }</span>
<a href="#l77.593"></a><span id="l77.593">         }</span>
<a href="#l77.594"></a><span id="l77.594">         out_count.value = ret.length;</span>
<a href="#l77.595"></a><span id="l77.595">         return ret;</span>
<a href="#l77.596"></a><span id="l77.596">     },</span>
<a href="#l77.597"></a><span id="l77.597"> </span>
<a href="#l77.598"></a><span id="l77.598">     // calICalendarSearchProvider:</span>
<a href="#l77.599"></a><span id="l77.599">     searchForCalendars:</span>
<a href="#l77.600"></a><span id="l77.600">     function calWcapSession_searchForCalendars(searchString, hints, maxResults, listener) {</span>
<a href="#l77.601"></a><span id="l77.601" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.602"></a><span id="l77.602" class="difflineminus">-        var request = new calWcapRequest(</span>
<a href="#l77.603"></a><span id="l77.603" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.604"></a><span id="l77.604" class="difflineplus">+        let request = new calWcapRequest(</span>
<a href="#l77.605"></a><span id="l77.605">             function searchForCalendars_resp(oprequest, err, data) {</span>
<a href="#l77.606"></a><span id="l77.606">                 if (err &amp;&amp; !checkErrorCode(err, calIErrors.OPERATION_CANCELLED)) {</span>
<a href="#l77.607"></a><span id="l77.607">                     this_.notifyError(err);</span>
<a href="#l77.608"></a><span id="l77.608">                 }</span>
<a href="#l77.609"></a><span id="l77.609">                 if (listener) {</span>
<a href="#l77.610"></a><span id="l77.610">                     listener.onResult(oprequest, data);</span>
<a href="#l77.611"></a><span id="l77.611">                 }</span>
<a href="#l77.612"></a><span id="l77.612">             },</span>
<a href="#l77.613"></a><span id="l77.613">             log(&quot;searchForCalendars, searchString=&quot; + searchString, this));</span>
<a href="#l77.614"></a><span id="l77.614"> </span>
<a href="#l77.615"></a><span id="l77.615">         try {</span>
<a href="#l77.616"></a><span id="l77.616" class="difflineminus">-            var registeredCalendars = this.getRegisteredCalendars(true);</span>
<a href="#l77.617"></a><span id="l77.617" class="difflineplus">+            let registeredCalendars = this.getRegisteredCalendars(true);</span>
<a href="#l77.618"></a><span id="l77.618"> </span>
<a href="#l77.619"></a><span id="l77.619" class="difflineminus">-            var params = (&quot;&amp;fmt-out=text%2Fxml&amp;search-string=&quot; + encodeURIComponent(searchString));</span>
<a href="#l77.620"></a><span id="l77.620" class="difflineplus">+            let params = (&quot;&amp;fmt-out=text%2Fxml&amp;search-string=&quot; + encodeURIComponent(searchString));</span>
<a href="#l77.621"></a><span id="l77.621">             if (maxResults &gt; 0) {</span>
<a href="#l77.622"></a><span id="l77.622">                 params += (&quot;&amp;maxResults=&quot; + maxResults);</span>
<a href="#l77.623"></a><span id="l77.623">             }</span>
<a href="#l77.624"></a><span id="l77.624">             params += (&quot;&amp;name=1&amp;calid=1&amp;primaryOwner=1&amp;searchOpts=&quot; +</span>
<a href="#l77.625"></a><span id="l77.625">                        ((hints &amp; calICalendarSearchProvider.HINT_EXACT_MATCH) ? &quot;3&quot; : &quot;0&quot;));</span>
<a href="#l77.626"></a><span id="l77.626"> </span>
<a href="#l77.627"></a><span id="l77.627">             this.issueNetworkRequest(</span>
<a href="#l77.628"></a><span id="l77.628">                 request,</span>
<a href="#l77.629"></a><span id="l77.629" class="difflineat">@@ -894,32 +894,32 @@ calWcapSession.prototype = {</span>
<a href="#l77.630"></a><span id="l77.630">                     if (err) {</span>
<a href="#l77.631"></a><span id="l77.631">                         throw err;</span>
<a href="#l77.632"></a><span id="l77.632">                     }</span>
<a href="#l77.633"></a><span id="l77.633">                     // string to xml converter func without WCAP errno check:</span>
<a href="#l77.634"></a><span id="l77.634">                     if (!data || data.length == 0) { // assuming time-out</span>
<a href="#l77.635"></a><span id="l77.635">                         throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l77.636"></a><span id="l77.636">                                                        calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l77.637"></a><span id="l77.637">                     }</span>
<a href="#l77.638"></a><span id="l77.638" class="difflineminus">-                    var xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l77.639"></a><span id="l77.639" class="difflineminus">-                    var ret = [];</span>
<a href="#l77.640"></a><span id="l77.640" class="difflineminus">-                    var nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l77.641"></a><span id="l77.641" class="difflineminus">-                    for (var i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l77.642"></a><span id="l77.642" class="difflineminus">-                        var node = nodeList.item(i);</span>
<a href="#l77.643"></a><span id="l77.643" class="difflineplus">+                    let xml = getDomParser().parseFromString(data, &quot;text/xml&quot;);</span>
<a href="#l77.644"></a><span id="l77.644" class="difflineplus">+                    let ret = [];</span>
<a href="#l77.645"></a><span id="l77.645" class="difflineplus">+                    let nodeList = xml.getElementsByTagName(&quot;iCal&quot;);</span>
<a href="#l77.646"></a><span id="l77.646" class="difflineplus">+                    for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l77.647"></a><span id="l77.647" class="difflineplus">+                        let node = nodeList.item(i);</span>
<a href="#l77.648"></a><span id="l77.648">                         try {</span>
<a href="#l77.649"></a><span id="l77.649">                             checkWcapXmlErrno(node);</span>
<a href="#l77.650"></a><span id="l77.650" class="difflineminus">-                            var ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l77.651"></a><span id="l77.651" class="difflineplus">+                            let ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l77.652"></a><span id="l77.652">                             if (ar.length &gt; 0) {</span>
<a href="#l77.653"></a><span id="l77.653" class="difflineminus">-                                var calId = ar[0];</span>
<a href="#l77.654"></a><span id="l77.654" class="difflineplus">+                                let calId = ar[0];</span>
<a href="#l77.655"></a><span id="l77.655">                                 let calendar = registeredCalendars[calId];</span>
<a href="#l77.656"></a><span id="l77.656">                                 if (calendar) {</span>
<a href="#l77.657"></a><span id="l77.657">                                     calendar.m_calProps = node; // update calprops</span>
<a href="#l77.658"></a><span id="l77.658">                                 } else {</span>
<a href="#l77.659"></a><span id="l77.659">                                     calendar = new calWcapCalendar(this_, node);</span>
<a href="#l77.660"></a><span id="l77.660" class="difflineminus">-                                    var uri = this_.uri.clone();</span>
<a href="#l77.661"></a><span id="l77.661" class="difflineplus">+                                    let uri = this_.uri.clone();</span>
<a href="#l77.662"></a><span id="l77.662">                                     uri.path += (&quot;?calid=&quot; + encodeURIComponent(calId));</span>
<a href="#l77.663"></a><span id="l77.663">                                     calendar.uri = uri;</span>
<a href="#l77.664"></a><span id="l77.664">                                 }</span>
<a href="#l77.665"></a><span id="l77.665">                                 ret.push(calendar);</span>
<a href="#l77.666"></a><span id="l77.666">                             }</span>
<a href="#l77.667"></a><span id="l77.667">                         } catch (exc) {</span>
<a href="#l77.668"></a><span id="l77.668">                             switch (getResultCode(exc)) {</span>
<a href="#l77.669"></a><span id="l77.669">                                 case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l77.670"></a><span id="l77.670" class="difflineat">@@ -942,23 +942,23 @@ calWcapSession.prototype = {</span>
<a href="#l77.671"></a><span id="l77.671">         return request;</span>
<a href="#l77.672"></a><span id="l77.672">     },</span>
<a href="#l77.673"></a><span id="l77.673"> </span>
<a href="#l77.674"></a><span id="l77.674">     // calIFreeBusyProvider:</span>
<a href="#l77.675"></a><span id="l77.675">     getFreeBusyIntervals:</span>
<a href="#l77.676"></a><span id="l77.676">     function calWcapCalendar_getFreeBusyIntervals(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l77.677"></a><span id="l77.677">         rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l77.678"></a><span id="l77.678">         rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l77.679"></a><span id="l77.679" class="difflineminus">-        var zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l77.680"></a><span id="l77.680" class="difflineminus">-        var zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l77.681"></a><span id="l77.681" class="difflineplus">+        let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l77.682"></a><span id="l77.682" class="difflineplus">+        let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l77.683"></a><span id="l77.683"> </span>
<a href="#l77.684"></a><span id="l77.684" class="difflineminus">-        var this_ = this;</span>
<a href="#l77.685"></a><span id="l77.685" class="difflineminus">-        var request = new calWcapRequest(</span>
<a href="#l77.686"></a><span id="l77.686" class="difflineplus">+        let this_ = this;</span>
<a href="#l77.687"></a><span id="l77.687" class="difflineplus">+        let request = new calWcapRequest(</span>
<a href="#l77.688"></a><span id="l77.688">             function _resp(oprequest, err, data) {</span>
<a href="#l77.689"></a><span id="l77.689" class="difflineminus">-                var rc = getResultCode(err);</span>
<a href="#l77.690"></a><span id="l77.690" class="difflineplus">+                let rc = getResultCode(err);</span>
<a href="#l77.691"></a><span id="l77.691">                 switch (rc) {</span>
<a href="#l77.692"></a><span id="l77.692">                     case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l77.693"></a><span id="l77.693">                     case calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR:</span>
<a href="#l77.694"></a><span id="l77.694">                     case calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST:</span>
<a href="#l77.695"></a><span id="l77.695">                         log(&quot;getFreeBusyIntervals_resp() error: &quot; + errorToString(err), this_);</span>
<a href="#l77.696"></a><span id="l77.696">                         break;</span>
<a href="#l77.697"></a><span id="l77.697">                     default:</span>
<a href="#l77.698"></a><span id="l77.698">                         if (!Components.isSuccessCode(rc)) {</span>
<a href="#l77.699"></a><span id="l77.699" class="difflineat">@@ -969,17 +969,17 @@ calWcapSession.prototype = {</span>
<a href="#l77.700"></a><span id="l77.700">                 if (listener) {</span>
<a href="#l77.701"></a><span id="l77.701">                     listener.onResult(oprequest, data);</span>
<a href="#l77.702"></a><span id="l77.702">                 }</span>
<a href="#l77.703"></a><span id="l77.703">             },</span>
<a href="#l77.704"></a><span id="l77.704">             log(&quot;getFreeBusyIntervals():\n\tcalId=&quot; + calId +</span>
<a href="#l77.705"></a><span id="l77.705">                 &quot;\n\trangeStart=&quot; + zRangeStart + &quot;,\n\trangeEnd=&quot; + zRangeEnd, this));</span>
<a href="#l77.706"></a><span id="l77.706"> </span>
<a href="#l77.707"></a><span id="l77.707">         try {</span>
<a href="#l77.708"></a><span id="l77.708" class="difflineminus">-            var params = (&quot;&amp;calid=&quot; + encodeURIComponent(calId));</span>
<a href="#l77.709"></a><span id="l77.709" class="difflineplus">+            let params = (&quot;&amp;calid=&quot; + encodeURIComponent(calId));</span>
<a href="#l77.710"></a><span id="l77.710">             params += (&quot;&amp;busyonly=&quot; + ((busyTypes &amp; calIFreeBusyInterval.FREE) ? &quot;0&quot; : &quot;1&quot;));</span>
<a href="#l77.711"></a><span id="l77.711">             params += (&quot;&amp;dtstart=&quot; + zRangeStart);</span>
<a href="#l77.712"></a><span id="l77.712">             params += (&quot;&amp;dtend=&quot; + zRangeEnd);</span>
<a href="#l77.713"></a><span id="l77.713">             params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l77.714"></a><span id="l77.714"> </span>
<a href="#l77.715"></a><span id="l77.715">             // cannot use stringToXml here, because cs 6.3 returns plain nothing</span>
<a href="#l77.716"></a><span id="l77.716">             // on invalid user freebusy requests. WTF.</span>
<a href="#l77.717"></a><span id="l77.717">             function stringToXml_(session, data) {</span>
<a href="#l77.718"></a><span id="l77.718" class="difflineat">@@ -995,28 +995,28 @@ calWcapSession.prototype = {</span>
<a href="#l77.719"></a><span id="l77.719">                     if (err) {</span>
<a href="#l77.720"></a><span id="l77.720">                         throw err;</span>
<a href="#l77.721"></a><span id="l77.721">                     }</span>
<a href="#l77.722"></a><span id="l77.722">                     if (LOG_LEVEL &gt; 0) {</span>
<a href="#l77.723"></a><span id="l77.723">                         log(&quot;getFreeBusyIntervals net_resp(): &quot; +</span>
<a href="#l77.724"></a><span id="l77.724">                             getWcapRequestStatusString(xml), this_);</span>
<a href="#l77.725"></a><span id="l77.725">                     }</span>
<a href="#l77.726"></a><span id="l77.726">                     if (listener) {</span>
<a href="#l77.727"></a><span id="l77.727" class="difflineminus">-                        var ret = [];</span>
<a href="#l77.728"></a><span id="l77.728" class="difflineminus">-                        var nodeList = xml.getElementsByTagName(&quot;FB&quot;);</span>
<a href="#l77.729"></a><span id="l77.729" class="difflineplus">+                        let ret = [];</span>
<a href="#l77.730"></a><span id="l77.730" class="difflineplus">+                        let nodeList = xml.getElementsByTagName(&quot;FB&quot;);</span>
<a href="#l77.731"></a><span id="l77.731"> </span>
<a href="#l77.732"></a><span id="l77.732" class="difflineminus">-                        var fbTypeMap = {};</span>
<a href="#l77.733"></a><span id="l77.733" class="difflineplus">+                        let fbTypeMap = {};</span>
<a href="#l77.734"></a><span id="l77.734">                         fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l77.735"></a><span id="l77.735">                         fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span>
<a href="#l77.736"></a><span id="l77.736">                         fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l77.737"></a><span id="l77.737">                         fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l77.738"></a><span id="l77.738"> </span>
<a href="#l77.739"></a><span id="l77.739" class="difflineminus">-                        for (var i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l77.740"></a><span id="l77.740" class="difflineminus">-                            var node = nodeList.item(i);</span>
<a href="#l77.741"></a><span id="l77.741" class="difflineminus">-                            var fbType = fbTypeMap[node.attributes.getNamedItem(&quot;FBTYPE&quot;).nodeValue];</span>
<a href="#l77.742"></a><span id="l77.742" class="difflineplus">+                        for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l77.743"></a><span id="l77.743" class="difflineplus">+                            let node = nodeList.item(i);</span>
<a href="#l77.744"></a><span id="l77.744" class="difflineplus">+                            let fbType = fbTypeMap[node.attributes.getNamedItem(&quot;FBTYPE&quot;).nodeValue];</span>
<a href="#l77.745"></a><span id="l77.745">                             if (!fbType || (fbType &amp; busyTypes)) {</span>
<a href="#l77.746"></a><span id="l77.746">                                 if (!fbType) {</span>
<a href="#l77.747"></a><span id="l77.747">                                     fbType = calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l77.748"></a><span id="l77.748">                                 }</span>
<a href="#l77.749"></a><span id="l77.749">                                 let str = node.textContent;</span>
<a href="#l77.750"></a><span id="l77.750">                                 let slash = str.indexOf('/');</span>
<a href="#l77.751"></a><span id="l77.751">                                 let start = getDatetimeFromIcalString(str.substr(0, slash));</span>
<a href="#l77.752"></a><span id="l77.752">                                 let end = getDatetimeFromIcalString(str.substr(slash + 1));</span>
<a href="#l77.753"></a><span id="l77.753" class="difflineat">@@ -1086,18 +1086,18 @@ calWcapSession.prototype = {</span>
<a href="#l77.754"></a><span id="l77.754">     onCalendarUnregistering: function calWcapSession_onCalendarUnregistering(aCalendar) {</span>
<a href="#l77.755"></a><span id="l77.755">         try {</span>
<a href="#l77.756"></a><span id="l77.756">             // make sure the calendar belongs to this session and is the default calendar,</span>
<a href="#l77.757"></a><span id="l77.757">             // then remove all subscribed calendars:</span>
<a href="#l77.758"></a><span id="l77.758">             aCalendar = this.belongsTo(aCalendar);</span>
<a href="#l77.759"></a><span id="l77.759">             if (aCalendar &amp;&amp; aCalendar.isDefaultCalendar) {</span>
<a href="#l77.760"></a><span id="l77.760">                 getFreeBusyService().removeProvider(this);</span>
<a href="#l77.761"></a><span id="l77.761">                 getCalendarSearchService().removeProvider(this);</span>
<a href="#l77.762"></a><span id="l77.762" class="difflineminus">-                var registeredCalendars = this.getRegisteredCalendars();</span>
<a href="#l77.763"></a><span id="l77.763" class="difflineminus">-                for (var regCal of registeredCalendars) {</span>
<a href="#l77.764"></a><span id="l77.764" class="difflineplus">+                let registeredCalendars = this.getRegisteredCalendars();</span>
<a href="#l77.765"></a><span id="l77.765" class="difflineplus">+                for (let regCal of registeredCalendars) {</span>
<a href="#l77.766"></a><span id="l77.766">                     try {</span>
<a href="#l77.767"></a><span id="l77.767">                         if (!regCal.isDefaultCalendar) {</span>
<a href="#l77.768"></a><span id="l77.768">                             cal.getCalendarManager().unregisterCalendar(regCal);</span>
<a href="#l77.769"></a><span id="l77.769">                         }</span>
<a href="#l77.770"></a><span id="l77.770">                     } catch (exc) {</span>
<a href="#l77.771"></a><span id="l77.771">                         this.notifyError(exc);</span>
<a href="#l77.772"></a><span id="l77.772">                     }</span>
<a href="#l77.773"></a><span id="l77.773">                 }</span>
<a href="#l77.774"></a><span id="l77.774" class="difflineat">@@ -1110,44 +1110,44 @@ calWcapSession.prototype = {</span>
<a href="#l77.775"></a><span id="l77.775">     // called before the delete actually takes place</span>
<a href="#l77.776"></a><span id="l77.776">     onCalendarDeleting: function calWcapSession_onCalendarDeleting(aCalendar) {</span>
<a href="#l77.777"></a><span id="l77.777">     }</span>
<a href="#l77.778"></a><span id="l77.778"> };</span>
<a href="#l77.779"></a><span id="l77.779"> </span>
<a href="#l77.780"></a><span id="l77.780"> function confirmInsecureLogin(uri) {</span>
<a href="#l77.781"></a><span id="l77.781">     if (!confirmInsecureLogin.m_confirmedHttpLogins) {</span>
<a href="#l77.782"></a><span id="l77.782">         confirmInsecureLogin.m_confirmedHttpLogins = {};</span>
<a href="#l77.783"></a><span id="l77.783" class="difflineminus">-        var confirmedHttpLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l77.784"></a><span id="l77.784" class="difflineminus">-        var tuples = confirmedHttpLogins.split(',');</span>
<a href="#l77.785"></a><span id="l77.785" class="difflineminus">-        for (var tuple of tuples) {</span>
<a href="#l77.786"></a><span id="l77.786" class="difflineminus">-            var ar = tuple.split(':');</span>
<a href="#l77.787"></a><span id="l77.787" class="difflineplus">+        let confirmedHttpLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l77.788"></a><span id="l77.788" class="difflineplus">+        let tuples = confirmedHttpLogins.split(',');</span>
<a href="#l77.789"></a><span id="l77.789" class="difflineplus">+        for (let tuple of tuples) {</span>
<a href="#l77.790"></a><span id="l77.790" class="difflineplus">+            let ar = tuple.split(':');</span>
<a href="#l77.791"></a><span id="l77.791">             confirmInsecureLogin.m_confirmedHttpLogins[ar[0]] = ar[1];</span>
<a href="#l77.792"></a><span id="l77.792">         }</span>
<a href="#l77.793"></a><span id="l77.793">     }</span>
<a href="#l77.794"></a><span id="l77.794"> </span>
<a href="#l77.795"></a><span id="l77.795" class="difflineminus">-    var bConfirmed = false;</span>
<a href="#l77.796"></a><span id="l77.796" class="difflineplus">+    let bConfirmed = false;</span>
<a href="#l77.797"></a><span id="l77.797"> </span>
<a href="#l77.798"></a><span id="l77.798" class="difflineminus">-    var host = uri.hostPort;</span>
<a href="#l77.799"></a><span id="l77.799" class="difflineminus">-    var encodedHost = encodeURIComponent(host);</span>
<a href="#l77.800"></a><span id="l77.800" class="difflineminus">-    var confirmedEntry = confirmInsecureLogin.m_confirmedHttpLogins[encodedHost];</span>
<a href="#l77.801"></a><span id="l77.801" class="difflineplus">+    let host = uri.hostPort;</span>
<a href="#l77.802"></a><span id="l77.802" class="difflineplus">+    let encodedHost = encodeURIComponent(host);</span>
<a href="#l77.803"></a><span id="l77.803" class="difflineplus">+    let confirmedEntry = confirmInsecureLogin.m_confirmedHttpLogins[encodedHost];</span>
<a href="#l77.804"></a><span id="l77.804">     if (confirmedEntry) {</span>
<a href="#l77.805"></a><span id="l77.805">         bConfirmed = (confirmedEntry == &quot;1&quot;);</span>
<a href="#l77.806"></a><span id="l77.806">     } else {</span>
<a href="#l77.807"></a><span id="l77.807" class="difflineminus">-        var prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l77.808"></a><span id="l77.808" class="difflineminus">-        var out_dontAskAgain = { value: false };</span>
<a href="#l77.809"></a><span id="l77.809" class="difflineplus">+        let prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l77.810"></a><span id="l77.810" class="difflineplus">+        let out_dontAskAgain = { value: false };</span>
<a href="#l77.811"></a><span id="l77.811">         bConfirmed = prompt.confirmCheck(</span>
<a href="#l77.812"></a><span id="l77.812">             cal.calGetString(&quot;wcap&quot;, &quot;noHttpsConfirmation.label&quot;),</span>
<a href="#l77.813"></a><span id="l77.813">             cal.calGetString(&quot;wcap&quot;, &quot;noHttpsConfirmation.text&quot;, [host]),</span>
<a href="#l77.814"></a><span id="l77.814">             cal.calGetString(&quot;wcap&quot;, &quot;noHttpsConfirmation.check.text&quot;),</span>
<a href="#l77.815"></a><span id="l77.815">             out_dontAskAgain);</span>
<a href="#l77.816"></a><span id="l77.816"> </span>
<a href="#l77.817"></a><span id="l77.817">         if (out_dontAskAgain.value) {</span>
<a href="#l77.818"></a><span id="l77.818">             // save decision for all running calendars and</span>
<a href="#l77.819"></a><span id="l77.819">             // all future confirmations:</span>
<a href="#l77.820"></a><span id="l77.820" class="difflineminus">-            var newConfirmedLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l77.821"></a><span id="l77.821" class="difflineplus">+            let newConfirmedLogins = getPref(&quot;calendar.wcap.confirmed_http_logins&quot;, &quot;&quot;);</span>
<a href="#l77.822"></a><span id="l77.822">             if (newConfirmedLogins.length &gt; 0) {</span>
<a href="#l77.823"></a><span id="l77.823">                 newConfirmedLogins += &quot;,&quot;;</span>
<a href="#l77.824"></a><span id="l77.824">             }</span>
<a href="#l77.825"></a><span id="l77.825">             confirmedEntry = (bConfirmed ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l77.826"></a><span id="l77.826">             newConfirmedLogins += (encodedHost + &quot;:&quot; + confirmedEntry);</span>
<a href="#l77.827"></a><span id="l77.827">             Preferences.set(&quot;calendar.wcap.confirmed_http_logins&quot;, newConfirmedLogins);</span>
<a href="#l77.828"></a><span id="l77.828">             getPref(&quot;calendar.wcap.confirmed_http_logins&quot;); // log written entry</span>
<a href="#l77.829"></a><span id="l77.829">             confirmInsecureLogin.m_confirmedHttpLogins[encodedHost] = confirmedEntry;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -21,25 +21,25 @@ function initLogging() {</span>
<a href="#l78.4"></a><span id="l78.4">     }</span>
<a href="#l78.5"></a><span id="l78.5"> </span>
<a href="#l78.6"></a><span id="l78.6">     LOG_LEVEL = getPref(&quot;calendar.wcap.log_level&quot;, 0);</span>
<a href="#l78.7"></a><span id="l78.7">     if (LOG_LEVEL &lt; 1 &amp;&amp; getPref(&quot;calendar.debug.log&quot;, false)) {</span>
<a href="#l78.8"></a><span id="l78.8">         LOG_LEVEL = 1; // at least basic logging when calendar.debug.log is set</span>
<a href="#l78.9"></a><span id="l78.9">     }</span>
<a href="#l78.10"></a><span id="l78.10"> </span>
<a href="#l78.11"></a><span id="l78.11">     if (LOG_LEVEL &gt; 0) {</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-        var logFileName = getPref(&quot;calendar.wcap.log_file&quot;, null);</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+        let logFileName = getPref(&quot;calendar.wcap.log_file&quot;, null);</span>
<a href="#l78.14"></a><span id="l78.14">         if (logFileName) {</span>
<a href="#l78.15"></a><span id="l78.15">             try {</span>
<a href="#l78.16"></a><span id="l78.16">                 // set up file:</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-                var logFile = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+                let logFile = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l78.19"></a><span id="l78.19">                                         .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l78.20"></a><span id="l78.20">                 logFile.initWithPath(logFileName);</span>
<a href="#l78.21"></a><span id="l78.21">                 // create output stream:</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineminus">-                var logFileStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineplus">+                let logFileStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l78.24"></a><span id="l78.24">                                               .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l78.25"></a><span id="l78.25">                 logFileStream.init(logFile,</span>
<a href="#l78.26"></a><span id="l78.26">                                    0x02 /* PR_WRONLY */ |</span>
<a href="#l78.27"></a><span id="l78.27">                                    0x08 /* PR_CREATE_FILE */ |</span>
<a href="#l78.28"></a><span id="l78.28">                                    (getPref(&quot;calendar.wcap.log_file_append&quot;, false)</span>
<a href="#l78.29"></a><span id="l78.29">                                     ? 0x10 /* PR_APPEND */ : 0x20 /* PR_TRUNCATE */),</span>
<a href="#l78.30"></a><span id="l78.30">                                    parseInt(&quot;0700&quot;, 8) /* read, write, execute/search by owner */,</span>
<a href="#l78.31"></a><span id="l78.31">                                    0 /* unused */);</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineat">@@ -65,77 +65,77 @@ function initLogging() {</span>
<a href="#l78.33"></a><span id="l78.33">                     }</span>
<a href="#l78.34"></a><span id="l78.34">                 }</span>
<a href="#l78.35"></a><span id="l78.35">             }</span>
<a href="#l78.36"></a><span id="l78.36">         };</span>
<a href="#l78.37"></a><span id="l78.37">         Services.prefs.addObserver(&quot;calendar.wcap.log_level&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l78.38"></a><span id="l78.38">         Services.prefs.addObserver(&quot;calendar.wcap.log_file&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l78.39"></a><span id="l78.39">         Services.prefs.addObserver(&quot;calendar.debug.log&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l78.40"></a><span id="l78.40"> </span>
<a href="#l78.41"></a><span id="l78.41" class="difflineminus">-        var appObserver = { // nsIObserver:</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineplus">+        let appObserver = { // nsIObserver:</span>
<a href="#l78.43"></a><span id="l78.43">             observe: function app_observe(subject, topic, data) {</span>
<a href="#l78.44"></a><span id="l78.44">                 if (topic == &quot;quit-application&quot;) {</span>
<a href="#l78.45"></a><span id="l78.45">                     Services.prefs.removeObserver(&quot;calendar.&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l78.46"></a><span id="l78.46">                 }</span>
<a href="#l78.47"></a><span id="l78.47">             }</span>
<a href="#l78.48"></a><span id="l78.48">         };</span>
<a href="#l78.49"></a><span id="l78.49">         Services.obs.addObserver(appObserver, &quot;quit-application&quot;, false);</span>
<a href="#l78.50"></a><span id="l78.50">     }</span>
<a href="#l78.51"></a><span id="l78.51"> }</span>
<a href="#l78.52"></a><span id="l78.52"> </span>
<a href="#l78.53"></a><span id="l78.53"> function log(msg, context, bForce) {</span>
<a href="#l78.54"></a><span id="l78.54">     if (bForce || LOG_LEVEL &gt; 0) {</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineminus">-        var ret = &quot;&quot;;</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+        let ret = &quot;&quot;;</span>
<a href="#l78.57"></a><span id="l78.57">         if (context) {</span>
<a href="#l78.58"></a><span id="l78.58">             ret += (&quot;[&quot; + context + &quot;]&quot;);</span>
<a href="#l78.59"></a><span id="l78.59">         }</span>
<a href="#l78.60"></a><span id="l78.60">         if (ret.length &gt; 0) {</span>
<a href="#l78.61"></a><span id="l78.61">             ret += &quot;\n&quot;;</span>
<a href="#l78.62"></a><span id="l78.62">         }</span>
<a href="#l78.63"></a><span id="l78.63">         ret += msg;</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineminus">-        var now = getTime();</span>
<a href="#l78.65"></a><span id="l78.65" class="difflineplus">+        let now = getTime();</span>
<a href="#l78.66"></a><span id="l78.66">         if (now &amp;&amp; initLogging.mLogTimezone) {</span>
<a href="#l78.67"></a><span id="l78.67">             now = now.getInTimezone(initLogging.mLogTimezone);</span>
<a href="#l78.68"></a><span id="l78.68">         }</span>
<a href="#l78.69"></a><span id="l78.69" class="difflineminus">-        var str = (&quot;### WCAP log entry: &quot; + now + &quot;\n&quot; + ret);</span>
<a href="#l78.70"></a><span id="l78.70" class="difflineplus">+        let str = (&quot;### WCAP log entry: &quot; + now + &quot;\n&quot; + ret);</span>
<a href="#l78.71"></a><span id="l78.71">         Services.console.logStringMessage(str);</span>
<a href="#l78.72"></a><span id="l78.72">         str = (&quot;\n&quot; + str + &quot;\n&quot;);</span>
<a href="#l78.73"></a><span id="l78.73">         dump(str);</span>
<a href="#l78.74"></a><span id="l78.74">         if (initLogging.mLogFilestream) {</span>
<a href="#l78.75"></a><span id="l78.75">             try {</span>
<a href="#l78.76"></a><span id="l78.76">                 // xxx todo?</span>
<a href="#l78.77"></a><span id="l78.77">                 // assuming ANSI chars here, for logging sufficient:</span>
<a href="#l78.78"></a><span id="l78.78">                 initLogging.mLogFilestream.write(str, str.length);</span>
<a href="#l78.79"></a><span id="l78.79">             } catch (exc) { // catching any io errors here:</span>
<a href="#l78.80"></a><span id="l78.80" class="difflineminus">-                var err = (&quot;error writing log file: &quot; + errorToString(exc));</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineplus">+                let err = (&quot;error writing log file: &quot; + errorToString(exc));</span>
<a href="#l78.82"></a><span id="l78.82">                 Components.utils.reportError(exc);</span>
<a href="#l78.83"></a><span id="l78.83">                 Services.console.logStringMessage(err);</span>
<a href="#l78.84"></a><span id="l78.84">                 dump(err + &quot;\n\n&quot;);</span>
<a href="#l78.85"></a><span id="l78.85">             }</span>
<a href="#l78.86"></a><span id="l78.86">         }</span>
<a href="#l78.87"></a><span id="l78.87">         return ret;</span>
<a href="#l78.88"></a><span id="l78.88">     } else {</span>
<a href="#l78.89"></a><span id="l78.89">         return msg;</span>
<a href="#l78.90"></a><span id="l78.90">     }</span>
<a href="#l78.91"></a><span id="l78.91"> }</span>
<a href="#l78.92"></a><span id="l78.92"> </span>
<a href="#l78.93"></a><span id="l78.93"> function logWarning(err, context) {</span>
<a href="#l78.94"></a><span id="l78.94" class="difflineminus">-    var msg = errorToString(err);</span>
<a href="#l78.95"></a><span id="l78.95" class="difflineminus">-    var scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l78.96"></a><span id="l78.96" class="difflineplus">+    let msg = errorToString(err);</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineplus">+    let scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l78.98"></a><span id="l78.98">                                 .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l78.99"></a><span id="l78.99">     scriptError.init(log(&quot;warning: &quot; + msg, context, true),</span>
<a href="#l78.100"></a><span id="l78.100">                      null, null, 0, 0,</span>
<a href="#l78.101"></a><span id="l78.101">                      Components.interfaces.nsIScriptError.warningFlag,</span>
<a href="#l78.102"></a><span id="l78.102">                      &quot;component javascript&quot;);</span>
<a href="#l78.103"></a><span id="l78.103">     Services.console.logMessage(scriptError);</span>
<a href="#l78.104"></a><span id="l78.104">     return msg;</span>
<a href="#l78.105"></a><span id="l78.105"> }</span>
<a href="#l78.106"></a><span id="l78.106"> </span>
<a href="#l78.107"></a><span id="l78.107"> function logError(err, context) {</span>
<a href="#l78.108"></a><span id="l78.108" class="difflineminus">-    var msg = errorToString(err);</span>
<a href="#l78.109"></a><span id="l78.109" class="difflineplus">+    let msg = errorToString(err);</span>
<a href="#l78.110"></a><span id="l78.110">     Components.utils.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + STACK(10), context, true));</span>
<a href="#l78.111"></a><span id="l78.111">     return msg;</span>
<a href="#l78.112"></a><span id="l78.112"> }</span>
<a href="#l78.113"></a><span id="l78.113"> </span>
<a href="#l78.114"></a><span id="l78.114"> // late-inited service accessors:</span>
<a href="#l78.115"></a><span id="l78.115"> </span>
<a href="#l78.116"></a><span id="l78.116"> function getCalendarSearchService() {</span>
<a href="#l78.117"></a><span id="l78.117">     if (!getCalendarSearchService.m_obj) {</span>
<a href="#l78.118"></a><span id="l78.118" class="difflineat">@@ -156,21 +156,21 @@ function getDomParser() {</span>
<a href="#l78.119"></a><span id="l78.119"> function isParent(item) {</span>
<a href="#l78.120"></a><span id="l78.120">     if (item.id != item.parentItem.id) {</span>
<a href="#l78.121"></a><span id="l78.121">         throw new Components.Exception(&quot;proxy has different id than its parent!&quot;);</span>
<a href="#l78.122"></a><span id="l78.122">     }</span>
<a href="#l78.123"></a><span id="l78.123">     return (!item.recurrenceId);</span>
<a href="#l78.124"></a><span id="l78.124"> }</span>
<a href="#l78.125"></a><span id="l78.125"> </span>
<a href="#l78.126"></a><span id="l78.126"> function filterXmlNodes(name, rootNode) {</span>
<a href="#l78.127"></a><span id="l78.127" class="difflineminus">-    var ret = [];</span>
<a href="#l78.128"></a><span id="l78.128" class="difflineplus">+    let ret = [];</span>
<a href="#l78.129"></a><span id="l78.129">     if (rootNode) {</span>
<a href="#l78.130"></a><span id="l78.130" class="difflineminus">-        var nodeList = rootNode.getElementsByTagName(name);</span>
<a href="#l78.131"></a><span id="l78.131" class="difflineminus">-        for (var i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l78.132"></a><span id="l78.132" class="difflineminus">-            var node = nodeList.item(i);</span>
<a href="#l78.133"></a><span id="l78.133" class="difflineplus">+        let nodeList = rootNode.getElementsByTagName(name);</span>
<a href="#l78.134"></a><span id="l78.134" class="difflineplus">+        for (let i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l78.135"></a><span id="l78.135" class="difflineplus">+            let node = nodeList.item(i);</span>
<a href="#l78.136"></a><span id="l78.136">             ret.push(node.textContent.trim());</span>
<a href="#l78.137"></a><span id="l78.137">         }</span>
<a href="#l78.138"></a><span id="l78.138">     }</span>
<a href="#l78.139"></a><span id="l78.139">     return ret;</span>
<a href="#l78.140"></a><span id="l78.140"> }</span>
<a href="#l78.141"></a><span id="l78.141"> </span>
<a href="#l78.142"></a><span id="l78.142"> function getTime() {</span>
<a href="#l78.143"></a><span id="l78.143">     if (g_bShutdown) {</span>
<a href="#l78.144"></a><span id="l78.144" class="difflineat">@@ -178,40 +178,40 @@ function getTime() {</span>
<a href="#l78.145"></a><span id="l78.145">     }</span>
<a href="#l78.146"></a><span id="l78.146">     return cal.jsDateToDateTime(new Date());</span>
<a href="#l78.147"></a><span id="l78.147"> }</span>
<a href="#l78.148"></a><span id="l78.148"> </span>
<a href="#l78.149"></a><span id="l78.149"> function getIcalUTC(dt) {</span>
<a href="#l78.150"></a><span id="l78.150">     if (!dt || !dt.isValid) {</span>
<a href="#l78.151"></a><span id="l78.151">         return &quot;0&quot;;</span>
<a href="#l78.152"></a><span id="l78.152">     } else {</span>
<a href="#l78.153"></a><span id="l78.153" class="difflineminus">-        var dtz = dt.timezone;</span>
<a href="#l78.154"></a><span id="l78.154" class="difflineplus">+        let dtz = dt.timezone;</span>
<a href="#l78.155"></a><span id="l78.155">         if (dtz.isUTC || dtz.isFloating) {</span>
<a href="#l78.156"></a><span id="l78.156">             return dt.icalString;</span>
<a href="#l78.157"></a><span id="l78.157">         } else {</span>
<a href="#l78.158"></a><span id="l78.158">             return dt.getInTimezone(UTC()).icalString;</span>
<a href="#l78.159"></a><span id="l78.159">         }</span>
<a href="#l78.160"></a><span id="l78.160">     }</span>
<a href="#l78.161"></a><span id="l78.161"> }</span>
<a href="#l78.162"></a><span id="l78.162"> </span>
<a href="#l78.163"></a><span id="l78.163"> function getDatetimeFromIcalString(val) {</span>
<a href="#l78.164"></a><span id="l78.164">     if (!val || val.length == 0 || val == &quot;0&quot;) {</span>
<a href="#l78.165"></a><span id="l78.165">         return null;</span>
<a href="#l78.166"></a><span id="l78.166">     }</span>
<a href="#l78.167"></a><span id="l78.167">     // assuming timezone is known:</span>
<a href="#l78.168"></a><span id="l78.168" class="difflineminus">-    var dt = createDateTime();</span>
<a href="#l78.169"></a><span id="l78.169" class="difflineplus">+    let dt = createDateTime();</span>
<a href="#l78.170"></a><span id="l78.170">     dt.icalString = val;</span>
<a href="#l78.171"></a><span id="l78.171">     return dt;</span>
<a href="#l78.172"></a><span id="l78.172"> }</span>
<a href="#l78.173"></a><span id="l78.173"> </span>
<a href="#l78.174"></a><span id="l78.174"> function getDatetimeFromIcalProp(prop) {</span>
<a href="#l78.175"></a><span id="l78.175">     if (!prop) {</span>
<a href="#l78.176"></a><span id="l78.176">         return null;</span>
<a href="#l78.177"></a><span id="l78.177">     }</span>
<a href="#l78.178"></a><span id="l78.178">     return getDatetimeFromIcalString(prop.valueAsIcalString);</span>
<a href="#l78.179"></a><span id="l78.179"> }</span>
<a href="#l78.180"></a><span id="l78.180"> </span>
<a href="#l78.181"></a><span id="l78.181"> function getPref(prefName, defaultValue) {</span>
<a href="#l78.182"></a><span id="l78.182" class="difflineminus">-    var ret = Preferences.get(prefName, defaultValue);</span>
<a href="#l78.183"></a><span id="l78.183" class="difflineplus">+    let ret = Preferences.get(prefName, defaultValue);</span>
<a href="#l78.184"></a><span id="l78.184">     log(ret, &quot;getPref(): prefName=&quot; + prefName);</span>
<a href="#l78.185"></a><span id="l78.185">     return ret;</span>
<a href="#l78.186"></a><span id="l78.186"> }</span>
<a href="#l78.187"></a><span id="l78.187"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -41,65 +41,64 @@</span>
<a href="#l79.4"></a><span id="l79.4">       &lt;field name=&quot;mRelativeDates&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l79.5"></a><span id="l79.5">       &lt;field name=&quot;mDayNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l79.6"></a><span id="l79.6">       &lt;field name=&quot;mRelationWords&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l79.7"></a><span id="l79.7">       &lt;field name=&quot;mMonthLongNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l79.8"></a><span id="l79.8">       &lt;field name=&quot;mMonthShortNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l79.9"></a><span id="l79.9"> </span>
<a href="#l79.10"></a><span id="l79.10">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l79.11"></a><span id="l79.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-        var goButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-go-button&quot;);</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+        let goButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-go-button&quot;);</span>
<a href="#l79.14"></a><span id="l79.14">         goButton.setAttribute(&quot;label&quot;, calGetString(&quot;calendar&quot;, &quot;go&quot;));</span>
<a href="#l79.15"></a><span id="l79.15">         // Load the stuff we're going to use to parse written dates</span>
<a href="#l79.16"></a><span id="l79.16">         this.mRelativeDates = [</span>
<a href="#l79.17"></a><span id="l79.17">             {word: cal.calGetString(&quot;calendar&quot;, &quot;today&quot;).toLowerCase(), offset: 0},</span>
<a href="#l79.18"></a><span id="l79.18">             {word: cal.calGetString(&quot;calendar&quot;, &quot;yesterday&quot;).toLowerCase(), offset: -1},</span>
<a href="#l79.19"></a><span id="l79.19">             {word: cal.calGetString(&quot;calendar&quot;, &quot;tomorrow&quot;).toLowerCase(), offset: 1}];</span>
<a href="#l79.20"></a><span id="l79.20" class="difflineminus">-        var i;</span>
<a href="#l79.21"></a><span id="l79.21" class="difflineminus">-        for (i = 1; i &lt;= 7; i++) {</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineplus">+        for (let i = 1; i &lt;= 7; i++) {</span>
<a href="#l79.23"></a><span id="l79.23">           this.mDayNames.push(calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l79.24"></a><span id="l79.24">         }</span>
<a href="#l79.25"></a><span id="l79.25"> </span>
<a href="#l79.26"></a><span id="l79.26" class="difflineminus">-        for (i = 1; i &lt;= 12; i++) {</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineplus">+        for (let i = 1; i &lt;= 12; i++) {</span>
<a href="#l79.28"></a><span id="l79.28">           this.mMonthLongNames.push(calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l79.29"></a><span id="l79.29">           this.mMonthShortNames.push(calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.Mmm&quot;).toLowerCase());</span>
<a href="#l79.30"></a><span id="l79.30">         }</span>
<a href="#l79.31"></a><span id="l79.31"> </span>
<a href="#l79.32"></a><span id="l79.32">         // note that some languages have different conjugations of</span>
<a href="#l79.33"></a><span id="l79.33">         // next/last depending on the day</span>
<a href="#l79.34"></a><span id="l79.34">         this.mRelationWords = [</span>
<a href="#l79.35"></a><span id="l79.35">             {word: cal.calGetString(&quot;calendar&quot;, &quot;last1&quot;), offset: -1},</span>
<a href="#l79.36"></a><span id="l79.36">             {word: cal.calGetString(&quot;calendar&quot;, &quot;last2&quot;), offset: -1},</span>
<a href="#l79.37"></a><span id="l79.37">             {word: cal.calGetString(&quot;calendar&quot;, &quot;next1&quot;), offset: 0},</span>
<a href="#l79.38"></a><span id="l79.38">             {word: cal.calGetString(&quot;calendar&quot;, &quot;next2&quot;), offset: 0}];</span>
<a href="#l79.39"></a><span id="l79.39"> </span>
<a href="#l79.40"></a><span id="l79.40">         // Set the value to today</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineminus">-        var text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineplus">+        let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l79.43"></a><span id="l79.43">         text.value = calGetString(&quot;calendar&quot;, &quot;today&quot;);</span>
<a href="#l79.44"></a><span id="l79.44">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l79.45"></a><span id="l79.45"> </span>
<a href="#l79.46"></a><span id="l79.46">       &lt;property name=&quot;value&quot;&gt;</span>
<a href="#l79.47"></a><span id="l79.47">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l79.48"></a><span id="l79.48">           return this.mValue;</span>
<a href="#l79.49"></a><span id="l79.49">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l79.50"></a><span id="l79.50">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineminus">-         var text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l79.52"></a><span id="l79.52" class="difflineplus">+         let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l79.53"></a><span id="l79.53">           try {</span>
<a href="#l79.54"></a><span id="l79.54">             text.value = this.formatDate(val);</span>
<a href="#l79.55"></a><span id="l79.55">           } catch (ex) {</span>
<a href="#l79.56"></a><span id="l79.56">             // Don't fail if date formatting fails.</span>
<a href="#l79.57"></a><span id="l79.57">           }</span>
<a href="#l79.58"></a><span id="l79.58">           return val;</span>
<a href="#l79.59"></a><span id="l79.59">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l79.60"></a><span id="l79.60">       &lt;/property&gt;</span>
<a href="#l79.61"></a><span id="l79.61"> </span>
<a href="#l79.62"></a><span id="l79.62">       &lt;method name=&quot;fireGoEvent&quot;&gt;</span>
<a href="#l79.63"></a><span id="l79.63">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l79.64"></a><span id="l79.64" class="difflineminus">-          var text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l79.65"></a><span id="l79.65" class="difflineminus">-          var date = this.parseLanguageDate(text.value);</span>
<a href="#l79.66"></a><span id="l79.66" class="difflineplus">+          let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l79.67"></a><span id="l79.67" class="difflineplus">+          let date = this.parseLanguageDate(text.value);</span>
<a href="#l79.68"></a><span id="l79.68">           if (!date) {</span>
<a href="#l79.69"></a><span id="l79.69">             date = this.parseDateTime(text.value);</span>
<a href="#l79.70"></a><span id="l79.70">           }</span>
<a href="#l79.71"></a><span id="l79.71">           let prettyDate;</span>
<a href="#l79.72"></a><span id="l79.72">           if (date) {</span>
<a href="#l79.73"></a><span id="l79.73">             // format fails if year &lt;= 1600 on win2k, so try format first.</span>
<a href="#l79.74"></a><span id="l79.74">             try {</span>
<a href="#l79.75"></a><span id="l79.75">               prettyDate = this.formatDate(date);</span>
<a href="#l79.76"></a><span id="l79.76" class="difflineat">@@ -254,20 +253,20 @@</span>
<a href="#l79.77"></a><span id="l79.77">         &lt;/xul:menulist&gt;</span>
<a href="#l79.78"></a><span id="l79.78">       &lt;/xul:hbox&gt;</span>
<a href="#l79.79"></a><span id="l79.79">     &lt;/content&gt;</span>
<a href="#l79.80"></a><span id="l79.80"> </span>
<a href="#l79.81"></a><span id="l79.81">     &lt;!-- ::::::::::::::::: INTERFACE ::::::::::::::::::::::::: --&gt;</span>
<a href="#l79.82"></a><span id="l79.82">     &lt;implementation&gt;</span>
<a href="#l79.83"></a><span id="l79.83">       &lt;constructor&gt;</span>
<a href="#l79.84"></a><span id="l79.84">         &lt;![CDATA[</span>
<a href="#l79.85"></a><span id="l79.85" class="difflineminus">-          var hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l79.86"></a><span id="l79.86" class="difflineplus">+          let hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l79.87"></a><span id="l79.87">           this.kTextBox = hbox.firstChild;</span>
<a href="#l79.88"></a><span id="l79.88"> </span>
<a href="#l79.89"></a><span id="l79.89" class="difflineminus">-          var val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l79.90"></a><span id="l79.90" class="difflineplus">+          let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l79.91"></a><span id="l79.91">           if (val) {</span>
<a href="#l79.92"></a><span id="l79.92">             this.value = new Date(val); // setting value property calls update</span>
<a href="#l79.93"></a><span id="l79.93">           } else {</span>
<a href="#l79.94"></a><span id="l79.94">             this.value = new Date();</span>
<a href="#l79.95"></a><span id="l79.95">           }</span>
<a href="#l79.96"></a><span id="l79.96"> </span>
<a href="#l79.97"></a><span id="l79.97">           this.kTextBox.kDatePicker = this; // enable call back to method in Moz1.7</span>
<a href="#l79.98"></a><span id="l79.98">           this.kTextBox.menupopup.kDatePicker = this;</span>
<a href="#l79.99"></a><span id="l79.99" class="difflineat">@@ -371,17 +370,17 @@</span>
<a href="#l79.100"></a><span id="l79.100">           ]]&gt;</span>
<a href="#l79.101"></a><span id="l79.101">         &lt;/body&gt;</span>
<a href="#l79.102"></a><span id="l79.102">       &lt;/method&gt;</span>
<a href="#l79.103"></a><span id="l79.103"> </span>
<a href="#l79.104"></a><span id="l79.104">       &lt;method name=&quot;clickDate&quot;&gt;</span>
<a href="#l79.105"></a><span id="l79.105">         &lt;parameter name=&quot;aEvent&quot; /&gt;</span>
<a href="#l79.106"></a><span id="l79.106">         &lt;body&gt;</span>
<a href="#l79.107"></a><span id="l79.107">           &lt;![CDATA[</span>
<a href="#l79.108"></a><span id="l79.108" class="difflineminus">-            var datepicker = aEvent.target.parentNode.parentNode.kDatePicker;</span>
<a href="#l79.109"></a><span id="l79.109" class="difflineplus">+            let datepicker = aEvent.target.parentNode.parentNode.kDatePicker;</span>
<a href="#l79.110"></a><span id="l79.110">             if (!datepicker.mInPopup) {</span>
<a href="#l79.111"></a><span id="l79.111">               // aEvent.target is the minimonth</span>
<a href="#l79.112"></a><span id="l79.112">               datepicker.update(new Date(aEvent.target.value), true);</span>
<a href="#l79.113"></a><span id="l79.113">               // select changed value so no cursor appears (can't type to it).</span>
<a href="#l79.114"></a><span id="l79.114">               datepicker.select();</span>
<a href="#l79.115"></a><span id="l79.115">               aEvent.target.parentNode.hidePopup();</span>
<a href="#l79.116"></a><span id="l79.116">             }</span>
<a href="#l79.117"></a><span id="l79.117">           ]]&gt;</span>
<a href="#l79.118"></a><span id="l79.118" class="difflineat">@@ -572,21 +571,21 @@</span>
<a href="#l79.119"></a><span id="l79.119">         &lt;/xul:menulist&gt;</span>
<a href="#l79.120"></a><span id="l79.120">       &lt;/xul:hbox&gt;</span>
<a href="#l79.121"></a><span id="l79.121">     &lt;/content&gt;</span>
<a href="#l79.122"></a><span id="l79.122"> </span>
<a href="#l79.123"></a><span id="l79.123">     &lt;!-- ::::::::::::::::: INTERFACE ::::::::::::::::::::::::: --&gt;</span>
<a href="#l79.124"></a><span id="l79.124">     &lt;implementation&gt;</span>
<a href="#l79.125"></a><span id="l79.125">       &lt;constructor&gt;</span>
<a href="#l79.126"></a><span id="l79.126">         &lt;![CDATA[</span>
<a href="#l79.127"></a><span id="l79.127" class="difflineminus">-          var hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l79.128"></a><span id="l79.128" class="difflineplus">+          let hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l79.129"></a><span id="l79.129">           this.kTextBox = hbox.childNodes[0];</span>
<a href="#l79.130"></a><span id="l79.130">           this.kTextBox.kTimePicker = this; // enable call back to method in Moz1.7</span>
<a href="#l79.131"></a><span id="l79.131"> </span>
<a href="#l79.132"></a><span id="l79.132" class="difflineminus">-          var val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l79.133"></a><span id="l79.133" class="difflineplus">+          let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l79.134"></a><span id="l79.134">           if (val) {</span>
<a href="#l79.135"></a><span id="l79.135">             this.value = (new Date(val));</span>
<a href="#l79.136"></a><span id="l79.136">           } else {</span>
<a href="#l79.137"></a><span id="l79.137">             this.value = (new Date());</span>
<a href="#l79.138"></a><span id="l79.138">           }</span>
<a href="#l79.139"></a><span id="l79.139"> </span>
<a href="#l79.140"></a><span id="l79.140">           // Change the grids in the timepicker-grids for 12-hours time format.</span>
<a href="#l79.141"></a><span id="l79.141">           if (this.ampmIndex) {</span>
<a href="#l79.142"></a><span id="l79.142" class="difflineat">@@ -647,17 +646,17 @@</span>
<a href="#l79.143"></a><span id="l79.143">       &lt;/method&gt;</span>
<a href="#l79.144"></a><span id="l79.144"> </span>
<a href="#l79.145"></a><span id="l79.145">       &lt;method name=&quot;onPopup&quot;&gt;</span>
<a href="#l79.146"></a><span id="l79.146">         &lt;parameter name=&quot;aPopup&quot; /&gt;</span>
<a href="#l79.147"></a><span id="l79.147">         &lt;body&gt;</span>
<a href="#l79.148"></a><span id="l79.148">           &lt;![CDATA[</span>
<a href="#l79.149"></a><span id="l79.149">             // select all to remove cursor since can't type while popped-up</span>
<a href="#l79.150"></a><span id="l79.150">             this.select();</span>
<a href="#l79.151"></a><span id="l79.151" class="difflineminus">-            var timePickerGrid = aPopup.childNodes[0];</span>
<a href="#l79.152"></a><span id="l79.152" class="difflineplus">+            let timePickerGrid = aPopup.childNodes[0];</span>
<a href="#l79.153"></a><span id="l79.153">             timePickerGrid.onPopupShowing(this, aPopup);</span>
<a href="#l79.154"></a><span id="l79.154">           ]]&gt;</span>
<a href="#l79.155"></a><span id="l79.155">         &lt;/body&gt;</span>
<a href="#l79.156"></a><span id="l79.156">       &lt;/method&gt;</span>
<a href="#l79.157"></a><span id="l79.157"> </span>
<a href="#l79.158"></a><span id="l79.158">       &lt;method name=&quot;onHide&quot;&gt;</span>
<a href="#l79.159"></a><span id="l79.159">         &lt;parameter name=&quot;aPopup&quot;/&gt;</span>
<a href="#l79.160"></a><span id="l79.160">         &lt;body&gt;</span>
<a href="#l79.161"></a><span id="l79.161" class="difflineat">@@ -1117,32 +1116,32 @@</span>
<a href="#l79.162"></a><span id="l79.162">         &lt;parameter name=&quot;aPopup&quot;/&gt;</span>
<a href="#l79.163"></a><span id="l79.163">         &lt;body&gt;</span>
<a href="#l79.164"></a><span id="l79.164">           &lt;![CDATA[</span>
<a href="#l79.165"></a><span id="l79.165">             this.mPicker = aPicker;</span>
<a href="#l79.166"></a><span id="l79.166">             this.mPopup = aPopup;</span>
<a href="#l79.167"></a><span id="l79.167"> </span>
<a href="#l79.168"></a><span id="l79.168">             // if there is a Date object in the popup item's</span>
<a href="#l79.169"></a><span id="l79.169">             // value attribute, use it, otherwise use Now.</span>
<a href="#l79.170"></a><span id="l79.170" class="difflineminus">-            var inputTime = this.mPicker.value;</span>
<a href="#l79.171"></a><span id="l79.171" class="difflineplus">+            let inputTime = this.mPicker.value;</span>
<a href="#l79.172"></a><span id="l79.172">             if (inputTime) {</span>
<a href="#l79.173"></a><span id="l79.173">               this.mSelectedTime = new Date(inputTime);</span>
<a href="#l79.174"></a><span id="l79.174">             } else {</span>
<a href="#l79.175"></a><span id="l79.175">               this.mSelectedTime = new Date();</span>
<a href="#l79.176"></a><span id="l79.176">             }</span>
<a href="#l79.177"></a><span id="l79.177"> </span>
<a href="#l79.178"></a><span id="l79.178">             // select the hour item</span>
<a href="#l79.179"></a><span id="l79.179" class="difflineminus">-            var hours24 = this.mSelectedTime.getHours();</span>
<a href="#l79.180"></a><span id="l79.180" class="difflineminus">-            var hourItemId = &quot;time-picker-hour-box-&quot; + hours24;</span>
<a href="#l79.181"></a><span id="l79.181" class="difflineminus">-            var hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l79.182"></a><span id="l79.182" class="difflineplus">+            let hours24 = this.mSelectedTime.getHours();</span>
<a href="#l79.183"></a><span id="l79.183" class="difflineplus">+            let hourItemId = &quot;time-picker-hour-box-&quot; + hours24;</span>
<a href="#l79.184"></a><span id="l79.184" class="difflineplus">+            let hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l79.185"></a><span id="l79.185">             this.selectHourItem(hourItem);</span>
<a href="#l79.186"></a><span id="l79.186"> </span>
<a href="#l79.187"></a><span id="l79.187">             // Show the five minute view if we are an even five minutes,</span>
<a href="#l79.188"></a><span id="l79.188">             // otherwise one minute view</span>
<a href="#l79.189"></a><span id="l79.189" class="difflineminus">-            var minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l79.190"></a><span id="l79.190" class="difflineplus">+            let minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l79.191"></a><span id="l79.191"> </span>
<a href="#l79.192"></a><span id="l79.192">             if (minutesByFive == this.mSelectedTime.getMinutes()) {</span>
<a href="#l79.193"></a><span id="l79.193">               this.clickLess();</span>
<a href="#l79.194"></a><span id="l79.194">             } else {</span>
<a href="#l79.195"></a><span id="l79.195">               this.clickMore();</span>
<a href="#l79.196"></a><span id="l79.196">             }</span>
<a href="#l79.197"></a><span id="l79.197">           ]]&gt;</span>
<a href="#l79.198"></a><span id="l79.198">         &lt;/body&gt;</span>
<a href="#l79.199"></a><span id="l79.199" class="difflineat">@@ -1161,38 +1160,38 @@</span>
<a href="#l79.200"></a><span id="l79.200">       &lt;!-- Called when the more tab is clicked, and possibly at startup --&gt;</span>
<a href="#l79.201"></a><span id="l79.201">       &lt;method name=&quot;clickMore&quot;&gt;</span>
<a href="#l79.202"></a><span id="l79.202">         &lt;body&gt;</span>
<a href="#l79.203"></a><span id="l79.203">           &lt;![CDATA[</span>
<a href="#l79.204"></a><span id="l79.204">             // switch to one minute view</span>
<a href="#l79.205"></a><span id="l79.205">             this.switchMinuteView(this.kMINUTE_VIEW_ONE);</span>
<a href="#l79.206"></a><span id="l79.206"> </span>
<a href="#l79.207"></a><span id="l79.207">             // select minute box corresponding to the time</span>
<a href="#l79.208"></a><span id="l79.208" class="difflineminus">-            var minutes = this.mSelectedTime.getMinutes();</span>
<a href="#l79.209"></a><span id="l79.209" class="difflineminus">-            var oneMinuteItemId = &quot;time-picker-one-minute-box-&quot; + minutes;</span>
<a href="#l79.210"></a><span id="l79.210" class="difflineminus">-            var oneMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, oneMinuteItemId);</span>
<a href="#l79.211"></a><span id="l79.211" class="difflineplus">+            let minutes = this.mSelectedTime.getMinutes();</span>
<a href="#l79.212"></a><span id="l79.212" class="difflineplus">+            let oneMinuteItemId = &quot;time-picker-one-minute-box-&quot; + minutes;</span>
<a href="#l79.213"></a><span id="l79.213" class="difflineplus">+            let oneMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, oneMinuteItemId);</span>
<a href="#l79.214"></a><span id="l79.214">             this.selectMinuteItem(oneMinuteItem);</span>
<a href="#l79.215"></a><span id="l79.215">           ]]&gt;</span>
<a href="#l79.216"></a><span id="l79.216">         &lt;/body&gt;</span>
<a href="#l79.217"></a><span id="l79.217">       &lt;/method&gt;</span>
<a href="#l79.218"></a><span id="l79.218"> </span>
<a href="#l79.219"></a><span id="l79.219">       &lt;!-- Called when the less tab is clicked, and possibly at startup --&gt;</span>
<a href="#l79.220"></a><span id="l79.220">       &lt;method name=&quot;clickLess&quot;&gt;</span>
<a href="#l79.221"></a><span id="l79.221">         &lt;body&gt;</span>
<a href="#l79.222"></a><span id="l79.222">           &lt;![CDATA[</span>
<a href="#l79.223"></a><span id="l79.223">             // switch to five minute view</span>
<a href="#l79.224"></a><span id="l79.224">             this.switchMinuteView(this.kMINUTE_VIEW_FIVE);</span>
<a href="#l79.225"></a><span id="l79.225"> </span>
<a href="#l79.226"></a><span id="l79.226">             // select closest five minute box,</span>
<a href="#l79.227"></a><span id="l79.227">             // BUT leave the selected time at what may NOT be an even five minutes</span>
<a href="#l79.228"></a><span id="l79.228">             // So that If they click more again the proper non-even-five minute</span>
<a href="#l79.229"></a><span id="l79.229">             // box will be selected</span>
<a href="#l79.230"></a><span id="l79.230" class="difflineminus">-            var minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l79.231"></a><span id="l79.231" class="difflineminus">-            var fiveMinuteItemId = &quot;time-picker-five-minute-box-&quot; + minutesByFive;</span>
<a href="#l79.232"></a><span id="l79.232" class="difflineminus">-            var fiveMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, fiveMinuteItemId);</span>
<a href="#l79.233"></a><span id="l79.233" class="difflineplus">+            let minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l79.234"></a><span id="l79.234" class="difflineplus">+            let fiveMinuteItemId = &quot;time-picker-five-minute-box-&quot; + minutesByFive;</span>
<a href="#l79.235"></a><span id="l79.235" class="difflineplus">+            let fiveMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, fiveMinuteItemId);</span>
<a href="#l79.236"></a><span id="l79.236">             this.selectMinuteItem(fiveMinuteItem);</span>
<a href="#l79.237"></a><span id="l79.237">           ]]&gt;</span>
<a href="#l79.238"></a><span id="l79.238">         &lt;/body&gt;</span>
<a href="#l79.239"></a><span id="l79.239">       &lt;/method&gt;</span>
<a href="#l79.240"></a><span id="l79.240"> </span>
<a href="#l79.241"></a><span id="l79.241">       &lt;!-- Called when one of the hour boxes is clicked --&gt;</span>
<a href="#l79.242"></a><span id="l79.242">       &lt;method name=&quot;clickHour&quot;&gt;</span>
<a href="#l79.243"></a><span id="l79.243">         &lt;parameter name=&quot;hourItem&quot;/&gt;</span>
<a href="#l79.244"></a><span id="l79.244" class="difflineat">@@ -1244,33 +1243,33 @@</span>
<a href="#l79.245"></a><span id="l79.245">       &lt;/method&gt;</span>
<a href="#l79.246"></a><span id="l79.246"> </span>
<a href="#l79.247"></a><span id="l79.247">       &lt;!-- Called by clickMinute when one of the minute boxes is clicked,</span>
<a href="#l79.248"></a><span id="l79.248">            Sets the value property and calls the client's onchange. --&gt;</span>
<a href="#l79.249"></a><span id="l79.249">       &lt;method name=&quot;timeSelected&quot;&gt;</span>
<a href="#l79.250"></a><span id="l79.250">         &lt;body&gt;</span>
<a href="#l79.251"></a><span id="l79.251">           &lt;![CDATA[</span>
<a href="#l79.252"></a><span id="l79.252">             // Copy picked time to avoid problems changing Date object in place</span>
<a href="#l79.253"></a><span id="l79.253" class="difflineminus">-            var pickedTime = new Date(this.mSelectedTime);</span>
<a href="#l79.254"></a><span id="l79.254" class="difflineplus">+            let pickedTime = new Date(this.mSelectedTime);</span>
<a href="#l79.255"></a><span id="l79.255"> </span>
<a href="#l79.256"></a><span id="l79.256">             // put the picked time in the value property, and update</span>
<a href="#l79.257"></a><span id="l79.257">             this.mPicker.update(pickedTime, true);</span>
<a href="#l79.258"></a><span id="l79.258">             // select changed value so no cursor appears (can't type to it).</span>
<a href="#l79.259"></a><span id="l79.259">             this.mPicker.select();</span>
<a href="#l79.260"></a><span id="l79.260">           ]]&gt;</span>
<a href="#l79.261"></a><span id="l79.261">         &lt;/body&gt;</span>
<a href="#l79.262"></a><span id="l79.262">       &lt;/method&gt;</span>
<a href="#l79.263"></a><span id="l79.263"> </span>
<a href="#l79.264"></a><span id="l79.264">       &lt;!-- Helper function to switch between &quot;one&quot; and &quot;five&quot; minute views --&gt;</span>
<a href="#l79.265"></a><span id="l79.265">       &lt;method name=&quot;switchMinuteView&quot;&gt;</span>
<a href="#l79.266"></a><span id="l79.266">         &lt;parameter name=&quot;view&quot;/&gt;</span>
<a href="#l79.267"></a><span id="l79.267">         &lt;body&gt;</span>
<a href="#l79.268"></a><span id="l79.268">           &lt;![CDATA[</span>
<a href="#l79.269"></a><span id="l79.269" class="difflineminus">-            var fiveMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l79.270"></a><span id="l79.270" class="difflineminus">-            var oneMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-one-minute-grid-box&quot;);</span>
<a href="#l79.271"></a><span id="l79.271" class="difflineplus">+            let fiveMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l79.272"></a><span id="l79.272" class="difflineplus">+            let oneMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-one-minute-grid-box&quot;);</span>
<a href="#l79.273"></a><span id="l79.273"> </span>
<a href="#l79.274"></a><span id="l79.274">             if (view == this.kMINUTE_VIEW_ONE) {</span>
<a href="#l79.275"></a><span id="l79.275">               fiveMinuteBox.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l79.276"></a><span id="l79.276">               oneMinuteBox.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l79.277"></a><span id="l79.277">             } else {</span>
<a href="#l79.278"></a><span id="l79.278">               fiveMinuteBox.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l79.279"></a><span id="l79.279">               oneMinuteBox.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l79.280"></a><span id="l79.280">             }</span>
<a href="#l79.281"></a><span id="l79.281" class="difflineat">@@ -1314,90 +1313,90 @@</span>
<a href="#l79.282"></a><span id="l79.282">       &lt;method name=&quot;moveMinutes&quot;&gt;</span>
<a href="#l79.283"></a><span id="l79.283">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l79.284"></a><span id="l79.284">         &lt;body&gt;</span>
<a href="#l79.285"></a><span id="l79.285">           &lt;![CDATA[</span>
<a href="#l79.286"></a><span id="l79.286">             if (!this.mSelectedTime) {</span>
<a href="#l79.287"></a><span id="l79.287">               return;</span>
<a href="#l79.288"></a><span id="l79.288">             }</span>
<a href="#l79.289"></a><span id="l79.289"> </span>
<a href="#l79.290"></a><span id="l79.290" class="difflineminus">-            var idPrefix = &quot;time-picker-one-minute-box-&quot;;</span>
<a href="#l79.291"></a><span id="l79.291" class="difflineplus">+            let idPrefix = &quot;time-picker-one-minute-box-&quot;;</span>
<a href="#l79.292"></a><span id="l79.292"> </span>
<a href="#l79.293"></a><span id="l79.293">             // Everything above assumes that we are showing the one-minute-grid,</span>
<a href="#l79.294"></a><span id="l79.294">             // If not, we need to do these corrections;</span>
<a href="#l79.295"></a><span id="l79.295" class="difflineminus">-            var fiveMinuteBox = document.getAnonymousElementByAttribute(</span>
<a href="#l79.296"></a><span id="l79.296" class="difflineplus">+            let fiveMinuteBox = document.getAnonymousElementByAttribute(</span>
<a href="#l79.297"></a><span id="l79.297">                                 this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l79.298"></a><span id="l79.298"> </span>
<a href="#l79.299"></a><span id="l79.299">             if (fiveMinuteBox.getAttribute(&quot;hidden&quot;) == 'false') {</span>
<a href="#l79.300"></a><span id="l79.300">               aNumber *= 5;</span>
<a href="#l79.301"></a><span id="l79.301">               idPrefix = &quot;time-picker-five-minute-box-&quot;;</span>
<a href="#l79.302"></a><span id="l79.302"> </span>
<a href="#l79.303"></a><span id="l79.303">               // If the detailed view was shown before, then mSelectedTime.getMinutes</span>
<a href="#l79.304"></a><span id="l79.304">               // might not be a multiple of 5.</span>
<a href="#l79.305"></a><span id="l79.305">               this.mSelectedTime.setMinutes(this.calcNearestFiveMinutes(this.mSelectedTime));</span>
<a href="#l79.306"></a><span id="l79.306">             }</span>
<a href="#l79.307"></a><span id="l79.307"> </span>
<a href="#l79.308"></a><span id="l79.308" class="difflineminus">-            var newMinutes = this.mSelectedTime.getMinutes() + aNumber;</span>
<a href="#l79.309"></a><span id="l79.309" class="difflineplus">+            let newMinutes = this.mSelectedTime.getMinutes() + aNumber;</span>
<a href="#l79.310"></a><span id="l79.310"> </span>
<a href="#l79.311"></a><span id="l79.311">             // Handle rollover cases</span>
<a href="#l79.312"></a><span id="l79.312">             if (newMinutes &lt; 0) {</span>
<a href="#l79.313"></a><span id="l79.313">                 newMinutes += 60;</span>
<a href="#l79.314"></a><span id="l79.314">             }</span>
<a href="#l79.315"></a><span id="l79.315">             if (newMinutes &gt; 59) {</span>
<a href="#l79.316"></a><span id="l79.316">                 newMinutes -= 60;</span>
<a href="#l79.317"></a><span id="l79.317">             }</span>
<a href="#l79.318"></a><span id="l79.318"> </span>
<a href="#l79.319"></a><span id="l79.319">             this.mSelectedTime.setMinutes(newMinutes);</span>
<a href="#l79.320"></a><span id="l79.320"> </span>
<a href="#l79.321"></a><span id="l79.321" class="difflineminus">-            var minuteItemId = idPrefix + this.mSelectedTime.getMinutes();</span>
<a href="#l79.322"></a><span id="l79.322" class="difflineminus">-            var minuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, minuteItemId);</span>
<a href="#l79.323"></a><span id="l79.323" class="difflineplus">+            let minuteItemId = idPrefix + this.mSelectedTime.getMinutes();</span>
<a href="#l79.324"></a><span id="l79.324" class="difflineplus">+            let minuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, minuteItemId);</span>
<a href="#l79.325"></a><span id="l79.325"> </span>
<a href="#l79.326"></a><span id="l79.326">             this.selectMinuteItem(minuteItem);</span>
<a href="#l79.327"></a><span id="l79.327">             this.mPicker.kTextBox.value = this.mPicker.formatTime(this.mSelectedTime);</span>
<a href="#l79.328"></a><span id="l79.328">             this.hasChanged = true;</span>
<a href="#l79.329"></a><span id="l79.329">           ]]&gt;</span>
<a href="#l79.330"></a><span id="l79.330">         &lt;/body&gt;</span>
<a href="#l79.331"></a><span id="l79.331">       &lt;/method&gt;</span>
<a href="#l79.332"></a><span id="l79.332">       &lt;method name=&quot;moveHours&quot;&gt;</span>
<a href="#l79.333"></a><span id="l79.333">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l79.334"></a><span id="l79.334">         &lt;body&gt;</span>
<a href="#l79.335"></a><span id="l79.335">           &lt;![CDATA[</span>
<a href="#l79.336"></a><span id="l79.336">             if (!this.mSelectedTime) {</span>
<a href="#l79.337"></a><span id="l79.337">               return;</span>
<a href="#l79.338"></a><span id="l79.338">             }</span>
<a href="#l79.339"></a><span id="l79.339"> </span>
<a href="#l79.340"></a><span id="l79.340" class="difflineminus">-            var newHours = this.mSelectedTime.getHours() + aNumber;</span>
<a href="#l79.341"></a><span id="l79.341" class="difflineplus">+            let newHours = this.mSelectedTime.getHours() + aNumber;</span>
<a href="#l79.342"></a><span id="l79.342"> </span>
<a href="#l79.343"></a><span id="l79.343">             // Handle rollover cases</span>
<a href="#l79.344"></a><span id="l79.344">             if (newHours &lt; 0) {</span>
<a href="#l79.345"></a><span id="l79.345">                 newHours += 24;</span>
<a href="#l79.346"></a><span id="l79.346">             }</span>
<a href="#l79.347"></a><span id="l79.347">             if (newHours &gt; 23) {</span>
<a href="#l79.348"></a><span id="l79.348">                 newHours -= 24;</span>
<a href="#l79.349"></a><span id="l79.349">             }</span>
<a href="#l79.350"></a><span id="l79.350"> </span>
<a href="#l79.351"></a><span id="l79.351">             this.mSelectedTime.setHours(newHours);</span>
<a href="#l79.352"></a><span id="l79.352"> </span>
<a href="#l79.353"></a><span id="l79.353" class="difflineminus">-            var hourItemId = &quot;time-picker-hour-box-&quot; + this.mSelectedTime.getHours();</span>
<a href="#l79.354"></a><span id="l79.354" class="difflineminus">-            var hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l79.355"></a><span id="l79.355" class="difflineplus">+            let hourItemId = &quot;time-picker-hour-box-&quot; + this.mSelectedTime.getHours();</span>
<a href="#l79.356"></a><span id="l79.356" class="difflineplus">+            let hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l79.357"></a><span id="l79.357"> </span>
<a href="#l79.358"></a><span id="l79.358">             this.selectHourItem(hourItem);</span>
<a href="#l79.359"></a><span id="l79.359">             this.mPicker.kTextBox.value = this.mPicker.formatTime(this.mSelectedTime);</span>
<a href="#l79.360"></a><span id="l79.360">             this.hasChanged = true;</span>
<a href="#l79.361"></a><span id="l79.361">           ]]&gt;</span>
<a href="#l79.362"></a><span id="l79.362">         &lt;/body&gt;</span>
<a href="#l79.363"></a><span id="l79.363">       &lt;/method&gt;</span>
<a href="#l79.364"></a><span id="l79.364"> </span>
<a href="#l79.365"></a><span id="l79.365">       &lt;!-- Helper function to calulate the nearest even five minutes --&gt;</span>
<a href="#l79.366"></a><span id="l79.366">       &lt;method name=&quot;calcNearestFiveMinutes&quot;&gt;</span>
<a href="#l79.367"></a><span id="l79.367">         &lt;parameter name=&quot;time&quot;/&gt;</span>
<a href="#l79.368"></a><span id="l79.368">         &lt;body&gt;</span>
<a href="#l79.369"></a><span id="l79.369">           &lt;![CDATA[</span>
<a href="#l79.370"></a><span id="l79.370" class="difflineminus">-            var minutes = time.getMinutes();</span>
<a href="#l79.371"></a><span id="l79.371" class="difflineminus">-            var minutesByFive = Math.round(minutes / 5) * 5;</span>
<a href="#l79.372"></a><span id="l79.372" class="difflineplus">+            let minutes = time.getMinutes();</span>
<a href="#l79.373"></a><span id="l79.373" class="difflineplus">+            let minutesByFive = Math.round(minutes / 5) * 5;</span>
<a href="#l79.374"></a><span id="l79.374"> </span>
<a href="#l79.375"></a><span id="l79.375">             if (minutesByFive &gt; 59) {</span>
<a href="#l79.376"></a><span id="l79.376">               minutesByFive = 55;</span>
<a href="#l79.377"></a><span id="l79.377">             }</span>
<a href="#l79.378"></a><span id="l79.378">             return minutesByFive;</span>
<a href="#l79.379"></a><span id="l79.379">           ]]&gt;</span>
<a href="#l79.380"></a><span id="l79.380">         &lt;/body&gt;</span>
<a href="#l79.381"></a><span id="l79.381">       &lt;/method&gt;</span>
<a href="#l79.382"></a><span id="l79.382" class="difflineat">@@ -1465,17 +1464,17 @@</span>
<a href="#l79.383"></a><span id="l79.383"> </span>
<a href="#l79.384"></a><span id="l79.384">       &lt;constructor&gt;</span>
<a href="#l79.385"></a><span id="l79.385">         &lt;![CDATA[</span>
<a href="#l79.386"></a><span id="l79.386">           this.kDatePicker =</span>
<a href="#l79.387"></a><span id="l79.387">       document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-picker&quot;);</span>
<a href="#l79.388"></a><span id="l79.388">           this.kTimePicker =</span>
<a href="#l79.389"></a><span id="l79.389">       document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l79.390"></a><span id="l79.390"> </span>
<a href="#l79.391"></a><span id="l79.391" class="difflineminus">-          var val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l79.392"></a><span id="l79.392" class="difflineplus">+          let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l79.393"></a><span id="l79.393">           this.mValue = (val ? new Date(val)</span>
<a href="#l79.394"></a><span id="l79.394">                              : new Date());</span>
<a href="#l79.395"></a><span id="l79.395">         ]]&gt;</span>
<a href="#l79.396"></a><span id="l79.396">       &lt;/constructor&gt;</span>
<a href="#l79.397"></a><span id="l79.397"> </span>
<a href="#l79.398"></a><span id="l79.398">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l79.399"></a><span id="l79.399">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l79.400"></a><span id="l79.400">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l79.401"></a><span id="l79.401" class="difflineat">@@ -1493,44 +1492,44 @@</span>
<a href="#l79.402"></a><span id="l79.402">           ]]&gt;</span>
<a href="#l79.403"></a><span id="l79.403">         &lt;/body&gt;</span>
<a href="#l79.404"></a><span id="l79.404">       &lt;/method&gt;</span>
<a href="#l79.405"></a><span id="l79.405"> </span>
<a href="#l79.406"></a><span id="l79.406">       &lt;!-- Date was changed by gui: update value. --&gt;</span>
<a href="#l79.407"></a><span id="l79.407">       &lt;method name=&quot;onDatePick&quot;&gt;</span>
<a href="#l79.408"></a><span id="l79.408">         &lt;body&gt;</span>
<a href="#l79.409"></a><span id="l79.409">           &lt;![CDATA[</span>
<a href="#l79.410"></a><span id="l79.410" class="difflineminus">-            var tempTime;</span>
<a href="#l79.411"></a><span id="l79.411" class="difflineplus">+            let tempTime;</span>
<a href="#l79.412"></a><span id="l79.412">             if (this.kDatePicker.lastDateParseIncludedTime) {</span>
<a href="#l79.413"></a><span id="l79.413">               tempTime = new Date(this.kDatePicker.value);</span>
<a href="#l79.414"></a><span id="l79.414">             } else {</span>
<a href="#l79.415"></a><span id="l79.415">               tempTime = new Date(this.mValue);</span>
<a href="#l79.416"></a><span id="l79.416">             }</span>
<a href="#l79.417"></a><span id="l79.417" class="difflineminus">-            var newDate = new Date(this.kDatePicker.value);</span>
<a href="#l79.418"></a><span id="l79.418" class="difflineplus">+            let newDate = new Date(this.kDatePicker.value);</span>
<a href="#l79.419"></a><span id="l79.419">             // Note: create new date because setting month and date of month in</span>
<a href="#l79.420"></a><span id="l79.420">             // either order can lead to unexpected results (month may be advanced</span>
<a href="#l79.421"></a><span id="l79.421">             // automatically if day of month is temporarily out of range).</span>
<a href="#l79.422"></a><span id="l79.422" class="difflineminus">-            var dateTime = new Date(newDate.getFullYear(),</span>
<a href="#l79.423"></a><span id="l79.423" class="difflineplus">+            let dateTime = new Date(newDate.getFullYear(),</span>
<a href="#l79.424"></a><span id="l79.424">                                     newDate.getMonth(),</span>
<a href="#l79.425"></a><span id="l79.425">                                     newDate.getDate(),</span>
<a href="#l79.426"></a><span id="l79.426">                                     tempTime.getHours(),</span>
<a href="#l79.427"></a><span id="l79.427">                                     tempTime.getMinutes(),</span>
<a href="#l79.428"></a><span id="l79.428">                                     tempTime.getSeconds());</span>
<a href="#l79.429"></a><span id="l79.429">             this.mValue = dateTime;</span>
<a href="#l79.430"></a><span id="l79.430">             this.kTimePicker.update(dateTime, false);</span>
<a href="#l79.431"></a><span id="l79.431">           ]]&gt;</span>
<a href="#l79.432"></a><span id="l79.432">         &lt;/body&gt;</span>
<a href="#l79.433"></a><span id="l79.433">       &lt;/method&gt;</span>
<a href="#l79.434"></a><span id="l79.434"> </span>
<a href="#l79.435"></a><span id="l79.435">       &lt;!-- Time was changed by gui: update value --&gt;</span>
<a href="#l79.436"></a><span id="l79.436">       &lt;method name=&quot;onTimePick&quot;&gt;</span>
<a href="#l79.437"></a><span id="l79.437">         &lt;body&gt;</span>
<a href="#l79.438"></a><span id="l79.438">           &lt;![CDATA[</span>
<a href="#l79.439"></a><span id="l79.439" class="difflineminus">-            var dateTime = new Date(this.mValue);</span>
<a href="#l79.440"></a><span id="l79.440" class="difflineminus">-            var newTime = this.kTimePicker.value;</span>
<a href="#l79.441"></a><span id="l79.441" class="difflineplus">+            let dateTime = new Date(this.mValue);</span>
<a href="#l79.442"></a><span id="l79.442" class="difflineplus">+            let newTime = this.kTimePicker.value;</span>
<a href="#l79.443"></a><span id="l79.443">             dateTime.setHours(newTime.getHours());</span>
<a href="#l79.444"></a><span id="l79.444">             dateTime.setMinutes(newTime.getMinutes());</span>
<a href="#l79.445"></a><span id="l79.445">             dateTime.setSeconds(newTime.getSeconds());</span>
<a href="#l79.446"></a><span id="l79.446">             this.mValue = dateTime;</span>
<a href="#l79.447"></a><span id="l79.447">             this.kDatePicker.update(dateTime, false);</span>
<a href="#l79.448"></a><span id="l79.448">           ]]&gt;</span>
<a href="#l79.449"></a><span id="l79.449">         &lt;/body&gt;</span>
<a href="#l79.450"></a><span id="l79.450">       &lt;/method&gt;</span>
<a href="#l79.451"></a><span id="l79.451" class="difflineat">@@ -1578,98 +1577,98 @@</span>
<a href="#l79.452"></a><span id="l79.452">         &lt;/body&gt;</span>
<a href="#l79.453"></a><span id="l79.453">       &lt;/method&gt;</span>
<a href="#l79.454"></a><span id="l79.454"> </span>
<a href="#l79.455"></a><span id="l79.455">       &lt;method name=&quot;fireEvent&quot;&gt;</span>
<a href="#l79.456"></a><span id="l79.456">         &lt;parameter name=&quot;aEventName&quot;/&gt;</span>
<a href="#l79.457"></a><span id="l79.457">         &lt;parameter name=&quot;aDetail&quot;/&gt;</span>
<a href="#l79.458"></a><span id="l79.458">         &lt;body&gt;</span>
<a href="#l79.459"></a><span id="l79.459">           &lt;![CDATA[</span>
<a href="#l79.460"></a><span id="l79.460" class="difflineminus">-            var event = document.createEvent('Events');</span>
<a href="#l79.461"></a><span id="l79.461" class="difflineplus">+            let event = document.createEvent('Events');</span>
<a href="#l79.462"></a><span id="l79.462">             event.initEvent(aEventName, true, true);</span>
<a href="#l79.463"></a><span id="l79.463">             event.detail = aDetail;</span>
<a href="#l79.464"></a><span id="l79.464">             this.dispatchEvent(event);</span>
<a href="#l79.465"></a><span id="l79.465">           ]]&gt;</span>
<a href="#l79.466"></a><span id="l79.466">         &lt;/body&gt;</span>
<a href="#l79.467"></a><span id="l79.467">       &lt;/method&gt;</span>
<a href="#l79.468"></a><span id="l79.468"> </span>
<a href="#l79.469"></a><span id="l79.469">       &lt;!-- Parameter aValue may be a date or a date time. Dates are</span>
<a href="#l79.470"></a><span id="l79.470">            read according to locale/OS setting (d-m-y or m-d-y or ...).</span>
<a href="#l79.471"></a><span id="l79.471">            (see initDateFormat). Uses parseTime() for times.</span>
<a href="#l79.472"></a><span id="l79.472">       --&gt;</span>
<a href="#l79.473"></a><span id="l79.473">       &lt;method name=&quot;parseDateTime&quot;&gt;</span>
<a href="#l79.474"></a><span id="l79.474">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l79.475"></a><span id="l79.475">         &lt;body&gt;</span>
<a href="#l79.476"></a><span id="l79.476">           &lt;![CDATA[</span>
<a href="#l79.477"></a><span id="l79.477">             this.mLastDateParseIncludedTime = false;</span>
<a href="#l79.478"></a><span id="l79.478" class="difflineminus">-            var tempDate = null;</span>
<a href="#l79.479"></a><span id="l79.479" class="difflineplus">+            let tempDate = null;</span>
<a href="#l79.480"></a><span id="l79.480">             if (!this.probeSucceeded) {</span>
<a href="#l79.481"></a><span id="l79.481">               return null; // avoid errors accessing uninitialized data.</span>
<a href="#l79.482"></a><span id="l79.482">             }</span>
<a href="#l79.483"></a><span id="l79.483"> </span>
<a href="#l79.484"></a><span id="l79.484" class="difflineminus">-            var year = Number.MIN_VALUE; var month = -1; var day = -1; let timeString = null;</span>
<a href="#l79.485"></a><span id="l79.485" class="difflineplus">+            let year = Number.MIN_VALUE; let month = -1; let day = -1; let timeString = null;</span>
<a href="#l79.486"></a><span id="l79.486">             if (this.alphaMonths == null) {</span>
<a href="#l79.487"></a><span id="l79.487">               // SHORT NUMERIC DATE, such as 2002-03-04, 4/3/2002, or CE2002Y03M04D.</span>
<a href="#l79.488"></a><span id="l79.488">               // Made of digits &amp; nonDigits.  (Nondigits may be unicode letters</span>
<a href="#l79.489"></a><span id="l79.489">               // which do not match \w, esp. in CJK locales.)</span>
<a href="#l79.490"></a><span id="l79.490">               // (.*)? binds to null if no suffix.</span>
<a href="#l79.491"></a><span id="l79.491" class="difflineminus">-              var parseNumShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)(.*)?$/;</span>
<a href="#l79.492"></a><span id="l79.492" class="difflineminus">-              var dateNumbersArray = parseNumShortDateRegex.exec(aValue);</span>
<a href="#l79.493"></a><span id="l79.493" class="difflineplus">+              let parseNumShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)(.*)?$/;</span>
<a href="#l79.494"></a><span id="l79.494" class="difflineplus">+              let dateNumbersArray = parseNumShortDateRegex.exec(aValue);</span>
<a href="#l79.495"></a><span id="l79.495">               if (dateNumbersArray != null) {</span>
<a href="#l79.496"></a><span id="l79.496">                 year = Number(dateNumbersArray[this.yearIndex]);</span>
<a href="#l79.497"></a><span id="l79.497">                 month = Number(dateNumbersArray[this.monthIndex]) - 1; // 0-based</span>
<a href="#l79.498"></a><span id="l79.498">                 day = Number(dateNumbersArray[this.dayIndex]);</span>
<a href="#l79.499"></a><span id="l79.499">                 timeString = dateNumbersArray[4];</span>
<a href="#l79.500"></a><span id="l79.500">               }</span>
<a href="#l79.501"></a><span id="l79.501">             } else {</span>
<a href="#l79.502"></a><span id="l79.502">               // SHORT DATE WITH ALPHABETIC MONTH, such as &quot;dd MMM yy&quot; or &quot;MMMM dd, yyyy&quot;</span>
<a href="#l79.503"></a><span id="l79.503">               // (\d+|[^\d\W]) is digits or letters, not both together.</span>
<a href="#l79.504"></a><span id="l79.504">               // Allows 31dec1999 (no delimiters between parts) if OS does (w2k does not).</span>
<a href="#l79.505"></a><span id="l79.505">               // Allows Dec 31, 1999 (comma and space between parts)</span>
<a href="#l79.506"></a><span id="l79.506">               // (Only accepts ASCII month names; JavaScript RegExp does not have an</span>
<a href="#l79.507"></a><span id="l79.507">               // easy way to describe unicode letters short of a HUGE character range</span>
<a href="#l79.508"></a><span id="l79.508">               // regexp derived from the Alphabetic ranges in</span>
<a href="#l79.509"></a><span id="l79.509">               // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l79.510"></a><span id="l79.510">               // (.*)? binds to null if no suffix.</span>
<a href="#l79.511"></a><span id="l79.511" class="difflineminus">-              var parseAlphShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)(.*)?$/;</span>
<a href="#l79.512"></a><span id="l79.512" class="difflineminus">-              var datePartsArray = parseAlphShortDateRegex.exec(aValue);</span>
<a href="#l79.513"></a><span id="l79.513" class="difflineplus">+              let parseAlphShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)(.*)?$/;</span>
<a href="#l79.514"></a><span id="l79.514" class="difflineplus">+              let datePartsArray = parseAlphShortDateRegex.exec(aValue);</span>
<a href="#l79.515"></a><span id="l79.515">               if (datePartsArray != null) {</span>
<a href="#l79.516"></a><span id="l79.516">                 year = Number(datePartsArray[this.yearIndex]);</span>
<a href="#l79.517"></a><span id="l79.517" class="difflineminus">-                var monthString = datePartsArray[this.monthIndex].toUpperCase();</span>
<a href="#l79.518"></a><span id="l79.518" class="difflineminus">-                for (var m = 0; m &lt; this.alphaMonths.length; m++) {</span>
<a href="#l79.519"></a><span id="l79.519" class="difflineplus">+                let monthString = datePartsArray[this.monthIndex].toUpperCase();</span>
<a href="#l79.520"></a><span id="l79.520" class="difflineplus">+                for (let m = 0; m &lt; this.alphaMonths.length; m++) {</span>
<a href="#l79.521"></a><span id="l79.521">                   if (monthString == this.alphaMonths[m]) {</span>
<a href="#l79.522"></a><span id="l79.522">                     month = m;</span>
<a href="#l79.523"></a><span id="l79.523">                     break;</span>
<a href="#l79.524"></a><span id="l79.524">                   }</span>
<a href="#l79.525"></a><span id="l79.525">                 }</span>
<a href="#l79.526"></a><span id="l79.526">                 day = Number(datePartsArray[this.dayIndex]);</span>
<a href="#l79.527"></a><span id="l79.527">                 timeString = datePartsArray[4];</span>
<a href="#l79.528"></a><span id="l79.528">               }</span>
<a href="#l79.529"></a><span id="l79.529">             }</span>
<a href="#l79.530"></a><span id="l79.530">             if (year != Number.MIN_VALUE &amp;&amp; month != -1 &amp;&amp; day != -1) {</span>
<a href="#l79.531"></a><span id="l79.531">               // year, month, day successfully parsed</span>
<a href="#l79.532"></a><span id="l79.532">               if (year &gt;= 0 &amp;&amp; year &lt; 100) {</span>
<a href="#l79.533"></a><span id="l79.533">                 // If 0 &lt;= year &lt; 100, treat as 2-digit year (like formatDate):</span>
<a href="#l79.534"></a><span id="l79.534">                 //   parse year as up to 30 years in future or 69 years in past.</span>
<a href="#l79.535"></a><span id="l79.535">                 //   (Covers 30-year mortgage and most working people's birthdate.)</span>
<a href="#l79.536"></a><span id="l79.536">                 // otherwise will be treated as four digit year.</span>
<a href="#l79.537"></a><span id="l79.537" class="difflineminus">-                var currentYear = new Date().getFullYear();</span>
<a href="#l79.538"></a><span id="l79.538" class="difflineminus">-                var currentCentury = currentYear - currentYear % 100;</span>
<a href="#l79.539"></a><span id="l79.539" class="difflineplus">+                let currentYear = new Date().getFullYear();</span>
<a href="#l79.540"></a><span id="l79.540" class="difflineplus">+                let currentCentury = currentYear - currentYear % 100;</span>
<a href="#l79.541"></a><span id="l79.541">                 year = currentCentury + year;</span>
<a href="#l79.542"></a><span id="l79.542">                 if (year &lt; currentYear - 69) {</span>
<a href="#l79.543"></a><span id="l79.543">                   year += 100;</span>
<a href="#l79.544"></a><span id="l79.544">                 }</span>
<a href="#l79.545"></a><span id="l79.545">                 if (year &gt; currentYear + 30) {</span>
<a href="#l79.546"></a><span id="l79.546">                   year -= 100;</span>
<a href="#l79.547"></a><span id="l79.547">                 }</span>
<a href="#l79.548"></a><span id="l79.548">               }</span>
<a href="#l79.549"></a><span id="l79.549">               // if time is also present, parse it</span>
<a href="#l79.550"></a><span id="l79.550" class="difflineminus">-              var hours = 0; var minutes = 0; var seconds = 0;</span>
<a href="#l79.551"></a><span id="l79.551" class="difflineplus">+              let hours = 0; let minutes = 0; let seconds = 0;</span>
<a href="#l79.552"></a><span id="l79.552">               if (timeString != null) {</span>
<a href="#l79.553"></a><span id="l79.553" class="difflineminus">-                var time = this.parseTime(timeString);</span>
<a href="#l79.554"></a><span id="l79.554" class="difflineplus">+                let time = this.parseTime(timeString);</span>
<a href="#l79.555"></a><span id="l79.555">                 if (time != null) {</span>
<a href="#l79.556"></a><span id="l79.556">                   hours = time.getHours();</span>
<a href="#l79.557"></a><span id="l79.557">                   minutes = time.getMinutes();</span>
<a href="#l79.558"></a><span id="l79.558">                   seconds = time.getSeconds();</span>
<a href="#l79.559"></a><span id="l79.559">                   this.mLastDateParseIncludedTime = true;</span>
<a href="#l79.560"></a><span id="l79.560">                 }</span>
<a href="#l79.561"></a><span id="l79.561">               }</span>
<a href="#l79.562"></a><span id="l79.562">               tempDate = new Date(year, month, day, hours, minutes, seconds, 0);</span>
<a href="#l79.563"></a><span id="l79.563" class="difflineat">@@ -1693,72 +1692,72 @@</span>
<a href="#l79.564"></a><span id="l79.564">            above/below noon      &quot;\u4e0a\u534802:34&quot;    &quot;\u4e0b\u5348 02 34&quot;</span>
<a href="#l79.565"></a><span id="l79.565">            noon before/after     &quot;\u5348\u524d02:34&quot;    &quot;\u5348\u5f8c 02 34&quot;</span>
<a href="#l79.566"></a><span id="l79.566">       --&gt;</span>
<a href="#l79.567"></a><span id="l79.567">       &lt;method name=&quot;parseTime&quot;&gt;</span>
<a href="#l79.568"></a><span id="l79.568">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l79.569"></a><span id="l79.569">         &lt;body&gt;</span>
<a href="#l79.570"></a><span id="l79.570">           &lt;![CDATA[</span>
<a href="#l79.571"></a><span id="l79.571">             try {</span>
<a href="#l79.572"></a><span id="l79.572" class="difflineminus">-              var noon = calGetString(&quot;dateFormat&quot;, &quot;noon&quot;);</span>
<a href="#l79.573"></a><span id="l79.573" class="difflineplus">+              let noon = calGetString(&quot;dateFormat&quot;, &quot;noon&quot;);</span>
<a href="#l79.574"></a><span id="l79.574">               if (aValue.toLowerCase() == noon.toLowerCase()) {</span>
<a href="#l79.575"></a><span id="l79.575">                 return new Date(0, 0, 0, 12, 0, 0, 0);</span>
<a href="#l79.576"></a><span id="l79.576">               }</span>
<a href="#l79.577"></a><span id="l79.577"> </span>
<a href="#l79.578"></a><span id="l79.578" class="difflineminus">-              var midnight = calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l79.579"></a><span id="l79.579" class="difflineplus">+              let midnight = calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l79.580"></a><span id="l79.580">               if (aValue.toLowerCase() == midnight.toLowerCase()) {</span>
<a href="#l79.581"></a><span id="l79.581">                 return new Date(0, 0, 0, 0, 0, 0, 0);</span>
<a href="#l79.582"></a><span id="l79.582">               }</span>
<a href="#l79.583"></a><span id="l79.583">             } catch (ex) {</span>
<a href="#l79.584"></a><span id="l79.584">               // Try/catch this, since some people are apparently</span>
<a href="#l79.585"></a><span id="l79.585">               // interested in using the datepicker in remote apps, where</span>
<a href="#l79.586"></a><span id="l79.586">               // calGetString wouldn't exist</span>
<a href="#l79.587"></a><span id="l79.587">             }</span>
<a href="#l79.588"></a><span id="l79.588"> </span>
<a href="#l79.589"></a><span id="l79.589" class="difflineminus">-            var time = null;</span>
<a href="#l79.590"></a><span id="l79.590" class="difflineminus">-            var timePartsArray = this.parseTimeRegExp.exec(aValue);</span>
<a href="#l79.591"></a><span id="l79.591" class="difflineplus">+            let time = null;</span>
<a href="#l79.592"></a><span id="l79.592" class="difflineplus">+            let timePartsArray = this.parseTimeRegExp.exec(aValue);</span>
<a href="#l79.593"></a><span id="l79.593">             const PRE_INDEX = 1, HR_INDEX = 2, MIN_INDEX = 4, SEC_INDEX = 6, POST_INDEX = 8;</span>
<a href="#l79.594"></a><span id="l79.594"> </span>
<a href="#l79.595"></a><span id="l79.595">             if (timePartsArray != null) {</span>
<a href="#l79.596"></a><span id="l79.596" class="difflineminus">-              var hoursString = timePartsArray[HR_INDEX];</span>
<a href="#l79.597"></a><span id="l79.597" class="difflineminus">-              var hours = Number(hoursString);</span>
<a href="#l79.598"></a><span id="l79.598" class="difflineminus">-              var hoursSuffix = timePartsArray[HR_INDEX + 1];</span>
<a href="#l79.599"></a><span id="l79.599" class="difflineplus">+              let hoursString = timePartsArray[HR_INDEX];</span>
<a href="#l79.600"></a><span id="l79.600" class="difflineplus">+              let hours = Number(hoursString);</span>
<a href="#l79.601"></a><span id="l79.601" class="difflineplus">+              let hoursSuffix = timePartsArray[HR_INDEX + 1];</span>
<a href="#l79.602"></a><span id="l79.602">               if (!(hours &gt;= 0 &amp;&amp; hours &lt; 24)) {</span>
<a href="#l79.603"></a><span id="l79.603">                 return null;</span>
<a href="#l79.604"></a><span id="l79.604">               }</span>
<a href="#l79.605"></a><span id="l79.605"> </span>
<a href="#l79.606"></a><span id="l79.606" class="difflineminus">-              var minutesString = timePartsArray[MIN_INDEX];</span>
<a href="#l79.607"></a><span id="l79.607" class="difflineminus">-              var minutes = (minutesString == null ? 0 : Number(minutesString));</span>
<a href="#l79.608"></a><span id="l79.608" class="difflineminus">-              var minutesSuffix = timePartsArray[MIN_INDEX + 1];</span>
<a href="#l79.609"></a><span id="l79.609" class="difflineplus">+              let minutesString = timePartsArray[MIN_INDEX];</span>
<a href="#l79.610"></a><span id="l79.610" class="difflineplus">+              let minutes = (minutesString == null ? 0 : Number(minutesString));</span>
<a href="#l79.611"></a><span id="l79.611" class="difflineplus">+              let minutesSuffix = timePartsArray[MIN_INDEX + 1];</span>
<a href="#l79.612"></a><span id="l79.612">               if (!(minutes &gt;= 0 &amp;&amp; minutes &lt; 60)) {</span>
<a href="#l79.613"></a><span id="l79.613">                 return null;</span>
<a href="#l79.614"></a><span id="l79.614">               }</span>
<a href="#l79.615"></a><span id="l79.615"> </span>
<a href="#l79.616"></a><span id="l79.616" class="difflineminus">-              var secondsString = timePartsArray[SEC_INDEX];</span>
<a href="#l79.617"></a><span id="l79.617" class="difflineminus">-              var seconds = (secondsString == null ? 0 : Number(secondsString));</span>
<a href="#l79.618"></a><span id="l79.618" class="difflineminus">-              var secondsSuffix = timePartsArray[SEC_INDEX + 1];</span>
<a href="#l79.619"></a><span id="l79.619" class="difflineplus">+              let secondsString = timePartsArray[SEC_INDEX];</span>
<a href="#l79.620"></a><span id="l79.620" class="difflineplus">+              let seconds = (secondsString == null ? 0 : Number(secondsString));</span>
<a href="#l79.621"></a><span id="l79.621" class="difflineplus">+              let secondsSuffix = timePartsArray[SEC_INDEX + 1];</span>
<a href="#l79.622"></a><span id="l79.622">               if (!(seconds &gt;= 0 &amp;&amp; seconds &lt; 60)) {</span>
<a href="#l79.623"></a><span id="l79.623">                 return null;</span>
<a href="#l79.624"></a><span id="l79.624">               }</span>
<a href="#l79.625"></a><span id="l79.625"> </span>
<a href="#l79.626"></a><span id="l79.626" class="difflineminus">-              var ampmCode = null;</span>
<a href="#l79.627"></a><span id="l79.627" class="difflineplus">+              let ampmCode = null;</span>
<a href="#l79.628"></a><span id="l79.628">               if (timePartsArray[PRE_INDEX] || timePartsArray[POST_INDEX]) {</span>
<a href="#l79.629"></a><span id="l79.629">                 if (this.ampmIndex &amp;&amp; timePartsArray[this.ampmIndex]) {</span>
<a href="#l79.630"></a><span id="l79.630">                   // try current format order first</span>
<a href="#l79.631"></a><span id="l79.631" class="difflineminus">-                  var ampmString = timePartsArray[this.ampmIndex];</span>
<a href="#l79.632"></a><span id="l79.632" class="difflineplus">+                  let ampmString = timePartsArray[this.ampmIndex];</span>
<a href="#l79.633"></a><span id="l79.633">                   if (this.amRegExp.test(ampmString)) {</span>
<a href="#l79.634"></a><span id="l79.634">                     ampmCode = &quot;AM&quot;;</span>
<a href="#l79.635"></a><span id="l79.635">                   } else if (this.pmRegExp.test(ampmString)) {</span>
<a href="#l79.636"></a><span id="l79.636">                     ampmCode = &quot;PM&quot;;</span>
<a href="#l79.637"></a><span id="l79.637">                   }</span>
<a href="#l79.638"></a><span id="l79.638">                 }</span>
<a href="#l79.639"></a><span id="l79.639">                 if (ampmCode == null) { // not yet found</span>
<a href="#l79.640"></a><span id="l79.640">                   // try any format order</span>
<a href="#l79.641"></a><span id="l79.641" class="difflineminus">-                  var preString = timePartsArray[PRE_INDEX];</span>
<a href="#l79.642"></a><span id="l79.642" class="difflineminus">-                  var postString = timePartsArray[POST_INDEX];</span>
<a href="#l79.643"></a><span id="l79.643" class="difflineplus">+                  let preString = timePartsArray[PRE_INDEX];</span>
<a href="#l79.644"></a><span id="l79.644" class="difflineplus">+                  let postString = timePartsArray[POST_INDEX];</span>
<a href="#l79.645"></a><span id="l79.645">                   if ((preString &amp;&amp; this.amRegExp.test(preString)) ||</span>
<a href="#l79.646"></a><span id="l79.646">                       (postString &amp;&amp; this.amRegExp.test(postString))) {</span>
<a href="#l79.647"></a><span id="l79.647">                     ampmCode = &quot;AM&quot;;</span>
<a href="#l79.648"></a><span id="l79.648">                   } else if ((preString &amp;&amp; this.pmRegExp.test(preString)) ||</span>
<a href="#l79.649"></a><span id="l79.649">                              (postString &amp;&amp; this.pmRegExp.test(postString))) {</span>
<a href="#l79.650"></a><span id="l79.650">                     ampmCode = &quot;PM&quot;;</span>
<a href="#l79.651"></a><span id="l79.651">                   } // else no match, ignore and treat as 24hour time.</span>
<a href="#l79.652"></a><span id="l79.652">                 }</span>
<a href="#l79.653"></a><span id="l79.653" class="difflineat">@@ -1790,22 +1789,22 @@</span>
<a href="#l79.654"></a><span id="l79.654">             this.alphaMonths = null;</span>
<a href="#l79.655"></a><span id="l79.655">             this.probeSucceeded = false;</span>
<a href="#l79.656"></a><span id="l79.656">             this.mLastDateParseIncludedTime = false;</span>
<a href="#l79.657"></a><span id="l79.657"> </span>
<a href="#l79.658"></a><span id="l79.658">             // SHORT NUMERIC DATE, such as 2002-03-04, 4/3/2002, or CE2002Y03M04D.</span>
<a href="#l79.659"></a><span id="l79.659">             // Made of digits &amp; nonDigits.  (Nondigits may be unicode letters</span>
<a href="#l79.660"></a><span id="l79.660">             // which do not match \w, esp. in CJK locales.)</span>
<a href="#l79.661"></a><span id="l79.661">             this.parseShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)\D?$/;</span>
<a href="#l79.662"></a><span id="l79.662" class="difflineminus">-            var probeDate = new Date(2002, 2, 4); // month is 0-based</span>
<a href="#l79.663"></a><span id="l79.663" class="difflineminus">-            var probeString = this.formatDate(probeDate);</span>
<a href="#l79.664"></a><span id="l79.664" class="difflineminus">-            var probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l79.665"></a><span id="l79.665" class="difflineplus">+            let probeDate = new Date(2002, 2, 4); // month is 0-based</span>
<a href="#l79.666"></a><span id="l79.666" class="difflineplus">+            let probeString = this.formatDate(probeDate);</span>
<a href="#l79.667"></a><span id="l79.667" class="difflineplus">+            let probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l79.668"></a><span id="l79.668">             if (probeArray != null) {</span>
<a href="#l79.669"></a><span id="l79.669">               // Numeric month format</span>
<a href="#l79.670"></a><span id="l79.670" class="difflineminus">-              for (var i = 1; i &lt;= 3; i++) {</span>
<a href="#l79.671"></a><span id="l79.671" class="difflineplus">+              for (let i = 1; i &lt;= 3; i++) {</span>
<a href="#l79.672"></a><span id="l79.672">                 switch (Number(probeArray[i])) {</span>
<a href="#l79.673"></a><span id="l79.673">                   case 2: this.twoDigitYear = true; // fall thru</span>
<a href="#l79.674"></a><span id="l79.674">                   case 2002: this.yearIndex = i; break;</span>
<a href="#l79.675"></a><span id="l79.675">                   case 3: this.monthIndex = i; break;</span>
<a href="#l79.676"></a><span id="l79.676">                   case 4: this.dayIndex = i; break;</span>
<a href="#l79.677"></a><span id="l79.677">                 }</span>
<a href="#l79.678"></a><span id="l79.678">               }</span>
<a href="#l79.679"></a><span id="l79.679">               // All three indexes are set (not -1) at this point.</span>
<a href="#l79.680"></a><span id="l79.680" class="difflineat">@@ -1817,29 +1816,29 @@</span>
<a href="#l79.681"></a><span id="l79.681">               // Allows Dec 31, 1999 (comma and space between parts)</span>
<a href="#l79.682"></a><span id="l79.682">               // (Only accepts ASCII month names; JavaScript RegExp does not have an</span>
<a href="#l79.683"></a><span id="l79.683">               // easy way to describe unicode letters short of a HUGE character range</span>
<a href="#l79.684"></a><span id="l79.684">               // regexp derived from the Alphabetic ranges in</span>
<a href="#l79.685"></a><span id="l79.685">               // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l79.686"></a><span id="l79.686">               this.parseShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\s*$/;</span>
<a href="#l79.687"></a><span id="l79.687">               probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l79.688"></a><span id="l79.688">               if (probeArray != null) {</span>
<a href="#l79.689"></a><span id="l79.689" class="difflineminus">-                for (var j = 1; j &lt;= 3; j++) {</span>
<a href="#l79.690"></a><span id="l79.690" class="difflineplus">+                for (let j = 1; j &lt;= 3; j++) {</span>
<a href="#l79.691"></a><span id="l79.691">                   switch (Number(probeArray[j])) {</span>
<a href="#l79.692"></a><span id="l79.692">                     case 2: this.twoDigitYear = true; // fall thru</span>
<a href="#l79.693"></a><span id="l79.693">                     case 2002: this.yearIndex = j; break;</span>
<a href="#l79.694"></a><span id="l79.694">                     case 4: this.dayIndex = j; break;</span>
<a href="#l79.695"></a><span id="l79.695">                     default: this.monthIndex = j; break;</span>
<a href="#l79.696"></a><span id="l79.696">                   }</span>
<a href="#l79.697"></a><span id="l79.697">                 }</span>
<a href="#l79.698"></a><span id="l79.698">                 if (this.yearIndex != -1 &amp;&amp; this.dayIndex != -1 &amp;&amp; this.monthIndex != -1) {</span>
<a href="#l79.699"></a><span id="l79.699">                   this.probeSucceeded = true;</span>
<a href="#l79.700"></a><span id="l79.700">                   // Fill this.alphaMonths with month names.</span>
<a href="#l79.701"></a><span id="l79.701">                   this.alphaMonths = new Array(12);</span>
<a href="#l79.702"></a><span id="l79.702" class="difflineminus">-                  for (var m = 0; m &lt; 12; m++) {</span>
<a href="#l79.703"></a><span id="l79.703" class="difflineplus">+                  for (let m = 0; m &lt; 12; m++) {</span>
<a href="#l79.704"></a><span id="l79.704">                     probeDate.setMonth(m);</span>
<a href="#l79.705"></a><span id="l79.705">                     probeString = this.formatDate(probeDate);</span>
<a href="#l79.706"></a><span id="l79.706">                     probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l79.707"></a><span id="l79.707">                     if (probeArray != null) {</span>
<a href="#l79.708"></a><span id="l79.708">                       this.alphaMonths[m] = probeArray[this.monthIndex].toUpperCase();</span>
<a href="#l79.709"></a><span id="l79.709">                     } else {</span>
<a href="#l79.710"></a><span id="l79.710">                       this.probeSucceeded = false;</span>
<a href="#l79.711"></a><span id="l79.711">                     }</span>
<a href="#l79.712"></a><span id="l79.712" class="difflineat">@@ -1869,105 +1868,105 @@</span>
<a href="#l79.713"></a><span id="l79.713">       --&gt;</span>
<a href="#l79.714"></a><span id="l79.714">       &lt;method name=&quot;initTimeFormat&quot;&gt;</span>
<a href="#l79.715"></a><span id="l79.715">         &lt;body&gt;</span>
<a href="#l79.716"></a><span id="l79.716">           &lt;![CDATA[</span>
<a href="#l79.717"></a><span id="l79.717">             // probe the Time format</span>
<a href="#l79.718"></a><span id="l79.718">             this.ampmIndex = null;</span>
<a href="#l79.719"></a><span id="l79.719">             // Digits         HR       sep      MIN     sep      SEC     sep</span>
<a href="#l79.720"></a><span id="l79.720">             //   Index:       2        3        4       5        6       7</span>
<a href="#l79.721"></a><span id="l79.721" class="difflineminus">-            var digitsExpr = &quot;(\\d?\\d)(\\D)?(?:(\\d\\d)(\\D)?(?:(\\d\\d)(\\D)?)?)?&quot;;</span>
<a href="#l79.722"></a><span id="l79.722" class="difflineplus">+            let digitsExpr = &quot;(\\d?\\d)(\\D)?(?:(\\d\\d)(\\D)?(?:(\\d\\d)(\\D)?)?)?&quot;;</span>
<a href="#l79.723"></a><span id="l79.723">             // any letters or '.': non-digit alphanumeric, period (a.m.), or space (P M)</span>
<a href="#l79.724"></a><span id="l79.724" class="difflineminus">-            var anyAmPmExpr = &quot;(?:[^\\d\\W]|[. ])+&quot;;</span>
<a href="#l79.725"></a><span id="l79.725" class="difflineplus">+            let anyAmPmExpr = &quot;(?:[^\\d\\W]|[. ])+&quot;;</span>
<a href="#l79.726"></a><span id="l79.726">             // digitsExpr has 6 captures, so index of first ampmExpr is 1, of last is 8.</span>
<a href="#l79.727"></a><span id="l79.727" class="difflineminus">-            var probeTimeRegExp =</span>
<a href="#l79.728"></a><span id="l79.728" class="difflineplus">+            let probeTimeRegExp =</span>
<a href="#l79.729"></a><span id="l79.729">               new RegExp(&quot;^(&quot; + anyAmPmExpr + &quot;)?\\s?&quot; + digitsExpr + &quot;(&quot; + anyAmPmExpr + &quot;)?\\s*$&quot;);</span>
<a href="#l79.730"></a><span id="l79.730">             const PRE_INDEX = 1, HR_INDEX = 2, MIN_INDEX = 4, SEC_INDEX = 6, POST_INDEX = 8;</span>
<a href="#l79.731"></a><span id="l79.731" class="difflineminus">-            var amProbeTime = new Date(2000, 0, 1, 6, 12, 34);</span>
<a href="#l79.732"></a><span id="l79.732" class="difflineminus">-            var amProbeString = amProbeTime.toLocaleFormat(&quot;%X&quot;);</span>
<a href="#l79.733"></a><span id="l79.733" class="difflineminus">-            var pmProbeTime = new Date(2000, 0, 1, 18, 12, 34);</span>
<a href="#l79.734"></a><span id="l79.734" class="difflineminus">-            var pmProbeString = pmProbeTime.toLocaleFormat(&quot;%X&quot;);</span>
<a href="#l79.735"></a><span id="l79.735" class="difflineminus">-            var amFormatExpr = null, pmFormatExpr = null;</span>
<a href="#l79.736"></a><span id="l79.736" class="difflineplus">+            let amProbeTime = new Date(2000, 0, 1, 6, 12, 34);</span>
<a href="#l79.737"></a><span id="l79.737" class="difflineplus">+            let amProbeString = amProbeTime.toLocaleFormat(&quot;%X&quot;);</span>
<a href="#l79.738"></a><span id="l79.738" class="difflineplus">+            let pmProbeTime = new Date(2000, 0, 1, 18, 12, 34);</span>
<a href="#l79.739"></a><span id="l79.739" class="difflineplus">+            let pmProbeString = pmProbeTime.toLocaleFormat(&quot;%X&quot;);</span>
<a href="#l79.740"></a><span id="l79.740" class="difflineplus">+            let amFormatExpr = null, pmFormatExpr = null;</span>
<a href="#l79.741"></a><span id="l79.741">             if (amProbeString != pmProbeString) {</span>
<a href="#l79.742"></a><span id="l79.742" class="difflineminus">-              var amProbeArray = probeTimeRegExp.exec(amProbeString);</span>
<a href="#l79.743"></a><span id="l79.743" class="difflineminus">-              var pmProbeArray = probeTimeRegExp.exec(pmProbeString);</span>
<a href="#l79.744"></a><span id="l79.744" class="difflineplus">+              let amProbeArray = probeTimeRegExp.exec(amProbeString);</span>
<a href="#l79.745"></a><span id="l79.745" class="difflineplus">+              let pmProbeArray = probeTimeRegExp.exec(pmProbeString);</span>
<a href="#l79.746"></a><span id="l79.746">               if (amProbeArray != null &amp;&amp; pmProbeArray != null) {</span>
<a href="#l79.747"></a><span id="l79.747">                 if (amProbeArray[PRE_INDEX] &amp;&amp; pmProbeArray[PRE_INDEX] &amp;&amp;</span>
<a href="#l79.748"></a><span id="l79.748">                     amProbeArray[PRE_INDEX] != pmProbeArray[PRE_INDEX]) {</span>
<a href="#l79.749"></a><span id="l79.749">                   this.ampmIndex = PRE_INDEX;</span>
<a href="#l79.750"></a><span id="l79.750">                 } else if (amProbeArray[POST_INDEX] &amp;&amp; pmProbeArray[POST_INDEX]) {</span>
<a href="#l79.751"></a><span id="l79.751">                   if (amProbeArray[POST_INDEX] != pmProbeArray[POST_INDEX]) {</span>
<a href="#l79.752"></a><span id="l79.752">                     this.ampmIndex = POST_INDEX;</span>
<a href="#l79.753"></a><span id="l79.753">                   } else {</span>
<a href="#l79.754"></a><span id="l79.754">                     // check if need to append previous character,</span>
<a href="#l79.755"></a><span id="l79.755">                     // captured by the optional separator pattern after seconds digits,</span>
<a href="#l79.756"></a><span id="l79.756">                     // or after minutes if no seconds, or after hours if no minutes.</span>
<a href="#l79.757"></a><span id="l79.757" class="difflineminus">-                    for (var k = SEC_INDEX; k &gt;= HR_INDEX; k -= 2) {</span>
<a href="#l79.758"></a><span id="l79.758" class="difflineminus">-                      var nextSepI = k + 1;</span>
<a href="#l79.759"></a><span id="l79.759" class="difflineminus">-                      var nextDigitsI = k + 2;</span>
<a href="#l79.760"></a><span id="l79.760" class="difflineplus">+                    for (let k = SEC_INDEX; k &gt;= HR_INDEX; k -= 2) {</span>
<a href="#l79.761"></a><span id="l79.761" class="difflineplus">+                      let nextSepI = k + 1;</span>
<a href="#l79.762"></a><span id="l79.762" class="difflineplus">+                      let nextDigitsI = k + 2;</span>
<a href="#l79.763"></a><span id="l79.763">                       if ((k == SEC_INDEX ||</span>
<a href="#l79.764"></a><span id="l79.764">                            (!amProbeArray[nextDigitsI] &amp;&amp; !pmProbeArray[nextDigitsI]))</span>
<a href="#l79.765"></a><span id="l79.765">                           &amp;&amp; amProbeArray[nextSepI] &amp;&amp; pmProbeArray[nextSepI]</span>
<a href="#l79.766"></a><span id="l79.766">                           &amp;&amp; amProbeArray[nextSepI] != pmProbeArray[nextSepI]) {</span>
<a href="#l79.767"></a><span id="l79.767">                         amProbeArray[POST_INDEX] =</span>
<a href="#l79.768"></a><span id="l79.768">                           amProbeArray[nextSepI] + amProbeArray[POST_INDEX];</span>
<a href="#l79.769"></a><span id="l79.769">                         pmProbeArray[POST_INDEX] =</span>
<a href="#l79.770"></a><span id="l79.770">                           pmProbeArray[nextSepI] + pmProbeArray[POST_INDEX];</span>
<a href="#l79.771"></a><span id="l79.771">                         this.ampmIndex = POST_INDEX;</span>
<a href="#l79.772"></a><span id="l79.772">                         break;</span>
<a href="#l79.773"></a><span id="l79.773">                       }</span>
<a href="#l79.774"></a><span id="l79.774">                     }</span>
<a href="#l79.775"></a><span id="l79.775">                   }</span>
<a href="#l79.776"></a><span id="l79.776">                 }</span>
<a href="#l79.777"></a><span id="l79.777">                 if (this.ampmIndex) {</span>
<a href="#l79.778"></a><span id="l79.778" class="difflineminus">-                  var makeFormatRegExp = function(string) {</span>
<a href="#l79.779"></a><span id="l79.779" class="difflineplus">+                  let makeFormatRegExp = function(string) {</span>
<a href="#l79.780"></a><span id="l79.780">                     // make expr to accept either as provided, lowercased, or uppercased</span>
<a href="#l79.781"></a><span id="l79.781" class="difflineminus">-                    var regExp = string.replace(/(\W)/g, &quot;[$1]&quot;); // escape punctuation</span>
<a href="#l79.782"></a><span id="l79.782" class="difflineminus">-                    var lowercased = string.toLowerCase();</span>
<a href="#l79.783"></a><span id="l79.783" class="difflineplus">+                    let regExp = string.replace(/(\W)/g, &quot;[$1]&quot;); // escape punctuation</span>
<a href="#l79.784"></a><span id="l79.784" class="difflineplus">+                    let lowercased = string.toLowerCase();</span>
<a href="#l79.785"></a><span id="l79.785">                     if (string != lowercased) {</span>
<a href="#l79.786"></a><span id="l79.786">                       regExp += &quot;|&quot; + lowercased;</span>
<a href="#l79.787"></a><span id="l79.787">                     }</span>
<a href="#l79.788"></a><span id="l79.788" class="difflineminus">-                    var uppercased = string.toUpperCase();</span>
<a href="#l79.789"></a><span id="l79.789" class="difflineplus">+                    let uppercased = string.toUpperCase();</span>
<a href="#l79.790"></a><span id="l79.790">                     if (string != uppercased) {</span>
<a href="#l79.791"></a><span id="l79.791">                       regExp += &quot;|&quot; + uppercased;</span>
<a href="#l79.792"></a><span id="l79.792">                     }</span>
<a href="#l79.793"></a><span id="l79.793">                     return regExp;</span>
<a href="#l79.794"></a><span id="l79.794">                   };</span>
<a href="#l79.795"></a><span id="l79.795">                   amFormatExpr = makeFormatRegExp(amProbeArray[this.ampmIndex]);</span>
<a href="#l79.796"></a><span id="l79.796">                   pmFormatExpr = makeFormatRegExp(pmProbeArray[this.ampmIndex]);</span>
<a href="#l79.797"></a><span id="l79.797">                 }</span>
<a href="#l79.798"></a><span id="l79.798">               }</span>
<a href="#l79.799"></a><span id="l79.799">             }</span>
<a href="#l79.800"></a><span id="l79.800">             // International formats ([roman, cyrillic]|arabic|chinese/kanji characters)</span>
<a href="#l79.801"></a><span id="l79.801">             // covering languages of U.N. (en,fr,sp,ru,ar,zh) and G8 (en,fr,de,it,ru,ja).</span>
<a href="#l79.802"></a><span id="l79.802">             // See examples at parseTimeOfDay.</span>
<a href="#l79.803"></a><span id="l79.803" class="difflineminus">-            var amExpr =</span>
<a href="#l79.804"></a><span id="l79.804" class="difflineplus">+            let amExpr =</span>
<a href="#l79.805"></a><span id="l79.805">               &quot;[Aa\u0410\u0430][. ]?[Mm\u041c\u043c][. ]?|\u0635|\u4e0a\u5348|\u5348\u524d&quot;;</span>
<a href="#l79.806"></a><span id="l79.806" class="difflineminus">-            var pmExpr =</span>
<a href="#l79.807"></a><span id="l79.807" class="difflineplus">+            let pmExpr =</span>
<a href="#l79.808"></a><span id="l79.808">               &quot;[Pp\u0420\u0440][. ]?[Mm\u041c\u043c][. ]?|\u0645|\u4e0b\u5348|\u5348\u5f8c&quot;;</span>
<a href="#l79.809"></a><span id="l79.809">             if (this.ampmIndex){</span>
<a href="#l79.810"></a><span id="l79.810">               amExpr = amFormatExpr + &quot;|&quot; + amExpr;</span>
<a href="#l79.811"></a><span id="l79.811">               pmExpr = pmFormatExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l79.812"></a><span id="l79.812">             }</span>
<a href="#l79.813"></a><span id="l79.813" class="difflineminus">-            var ampmExpr = amExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l79.814"></a><span id="l79.814" class="difflineplus">+            let ampmExpr = amExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l79.815"></a><span id="l79.815">             // Must build am/pm formats into parse time regexp so that it can</span>
<a href="#l79.816"></a><span id="l79.816">             // match them without mistaking the initial char for an optional divider.</span>
<a href="#l79.817"></a><span id="l79.817">             // (For example, want to be able to parse both &quot;12:34pm&quot; and</span>
<a href="#l79.818"></a><span id="l79.818">             // &quot;12H34M56Spm&quot; for any characters H,M,S and any language's &quot;pm&quot;.</span>
<a href="#l79.819"></a><span id="l79.819">             // The character between the last digit and the &quot;pm&quot; is optional.</span>
<a href="#l79.820"></a><span id="l79.820">             // Must recogize &quot;pm&quot; directly, otherwise in &quot;12:34pm&quot; the &quot;S&quot; pattern</span>
<a href="#l79.821"></a><span id="l79.821">             // matches the &quot;p&quot; character so only &quot;m&quot; is matched as ampm suffix.)</span>
<a href="#l79.822"></a><span id="l79.822">             //</span>
<a href="#l79.823"></a><span id="l79.823">             // digitsExpr has 6 captures, so index of first ampmExpr is 1, of last is 8.</span>
<a href="#l79.824"></a><span id="l79.824">             this.parseTimeRegExp =</span>
<a href="#l79.825"></a><span id="l79.825">               new RegExp(&quot;(&quot; + ampmExpr + &quot;)?\\s?&quot; + digitsExpr + &quot;(&quot; + ampmExpr + &quot;)?\\s*$&quot;);</span>
<a href="#l79.826"></a><span id="l79.826">             this.amRegExp = new RegExp(&quot;^(?:&quot; + amExpr + &quot;)$&quot;);</span>
<a href="#l79.827"></a><span id="l79.827">             this.pmRegExp = new RegExp(&quot;^(?:&quot; + pmExpr + &quot;)$&quot;);</span>
<a href="#l79.828"></a><span id="l79.828">             // build time display format that mimics &quot;%x&quot; format without seconds</span>
<a href="#l79.829"></a><span id="l79.829" class="difflineminus">-            var ampmSep = (pmProbeString.includes(' ') ? &quot; &quot; : &quot;&quot;);</span>
<a href="#l79.830"></a><span id="l79.830" class="difflineplus">+            let ampmSep = (pmProbeString.includes(' ') ? &quot; &quot; : &quot;&quot;);</span>
<a href="#l79.831"></a><span id="l79.831">             if (this.ampmIndex == PRE_INDEX) {</span>
<a href="#l79.832"></a><span id="l79.832">               this.kTimeFormatString = &quot;%p&quot; + ampmSep + &quot;%I:%M&quot;;</span>
<a href="#l79.833"></a><span id="l79.833">             } else if (this.ampmIndex == POST_INDEX) {</span>
<a href="#l79.834"></a><span id="l79.834">               this.kTimeFormatString = &quot;%I:%M&quot; + ampmSep + &quot;%p&quot;;</span>
<a href="#l79.835"></a><span id="l79.835">             } else {</span>
<a href="#l79.836"></a><span id="l79.836">               this.kTimeFormatString = &quot;%H:%M&quot;;</span>
<a href="#l79.837"></a><span id="l79.837">             }</span>
<a href="#l79.838"></a><span id="l79.838">           ]]&gt;</span>
<a href="#l79.839"></a><span id="l79.839" class="difflineat">@@ -1976,19 +1975,19 @@</span>
<a href="#l79.840"></a><span id="l79.840"> </span>
<a href="#l79.841"></a><span id="l79.841">       &lt;method name=&quot;formatDate&quot;&gt;</span>
<a href="#l79.842"></a><span id="l79.842">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l79.843"></a><span id="l79.843">         &lt;body&gt;</span>
<a href="#l79.844"></a><span id="l79.844">           &lt;![CDATA[</span>
<a href="#l79.845"></a><span id="l79.845">             // workaround for bugs 354073/327869:</span>
<a href="#l79.846"></a><span id="l79.846">             // aDate.toLocaleFormat(&quot;%x&quot;) exits application</span>
<a href="#l79.847"></a><span id="l79.847">             // if year before 1900 (e.g., typo) on MSWindows (due to MS bug).</span>
<a href="#l79.848"></a><span id="l79.848" class="difflineminus">-            var nsIScriptableDateFormat =</span>
<a href="#l79.849"></a><span id="l79.849" class="difflineplus">+            let nsIScriptableDateFormat =</span>
<a href="#l79.850"></a><span id="l79.850">               Components.interfaces.nsIScriptableDateFormat;</span>
<a href="#l79.851"></a><span id="l79.851" class="difflineminus">-            var dateService =</span>
<a href="#l79.852"></a><span id="l79.852" class="difflineplus">+            let dateService =</span>
<a href="#l79.853"></a><span id="l79.853">               Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l79.854"></a><span id="l79.854">                         .getService(nsIScriptableDateFormat);</span>
<a href="#l79.855"></a><span id="l79.855">             return dateService.FormatDate(&quot;&quot;, dateService.dateFormatShort,</span>
<a href="#l79.856"></a><span id="l79.856">                                           aDate.getFullYear(),</span>
<a href="#l79.857"></a><span id="l79.857">                                           aDate.getMonth() + 1,</span>
<a href="#l79.858"></a><span id="l79.858">                                           aDate.getDate());</span>
<a href="#l79.859"></a><span id="l79.859">           ]]&gt;</span>
<a href="#l79.860"></a><span id="l79.860">         &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -16,26 +16,26 @@</span>
<a href="#l80.4"></a><span id="l80.4">  *  This changes the mouseover preview based on the start and end dates</span>
<a href="#l80.5"></a><span id="l80.5">  *  of an occurrence of a (one-time or recurring) calEvent or calToDo.</span>
<a href="#l80.6"></a><span id="l80.6">  *  Used by all grid views.</span>
<a href="#l80.7"></a><span id="l80.7">  */</span>
<a href="#l80.8"></a><span id="l80.8"> </span>
<a href="#l80.9"></a><span id="l80.9"> function onMouseOverItem(occurrenceBoxMouseEvent) {</span>
<a href="#l80.10"></a><span id="l80.10">   if (&quot;occurrence&quot; in occurrenceBoxMouseEvent.currentTarget) {</span>
<a href="#l80.11"></a><span id="l80.11">     // occurrence of repeating event or todo</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-      var occurrence = occurrenceBoxMouseEvent.currentTarget.occurrence;</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+      let occurrence = occurrenceBoxMouseEvent.currentTarget.occurrence;</span>
<a href="#l80.14"></a><span id="l80.14">       const toolTip = document.getElementById(&quot;itemTooltip&quot;);</span>
<a href="#l80.15"></a><span id="l80.15">       return showToolTip(toolTip, occurrence);</span>
<a href="#l80.16"></a><span id="l80.16">   }</span>
<a href="#l80.17"></a><span id="l80.17">   return false;</span>
<a href="#l80.18"></a><span id="l80.18"> }</span>
<a href="#l80.19"></a><span id="l80.19"> </span>
<a href="#l80.20"></a><span id="l80.20"> function showToolTip(aToolTip, aItem) {</span>
<a href="#l80.21"></a><span id="l80.21">     if (aItem) {</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineminus">-        var holderBox;</span>
<a href="#l80.23"></a><span id="l80.23" class="difflineplus">+        let holderBox;</span>
<a href="#l80.24"></a><span id="l80.24">         if (isEvent(aItem)) {</span>
<a href="#l80.25"></a><span id="l80.25">             holderBox = getPreviewForEvent(aItem);</span>
<a href="#l80.26"></a><span id="l80.26">         } else if (isToDo(aItem)) {</span>
<a href="#l80.27"></a><span id="l80.27">             holderBox = getPreviewForTask(aItem);</span>
<a href="#l80.28"></a><span id="l80.28">         }</span>
<a href="#l80.29"></a><span id="l80.29">         if (holderBox) {</span>
<a href="#l80.30"></a><span id="l80.30">             removeChildren(aToolTip);</span>
<a href="#l80.31"></a><span id="l80.31">             aToolTip.appendChild(holderBox);</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineat">@@ -52,24 +52,24 @@ function getPreviewForTask(toDoItem) {</span>
<a href="#l80.33"></a><span id="l80.33">   if (toDoItem) {</span>
<a href="#l80.34"></a><span id="l80.34">     const vbox = document.createElement(&quot;vbox&quot;);</span>
<a href="#l80.35"></a><span id="l80.35">     vbox.setAttribute(&quot;class&quot;, &quot;tooltipBox&quot;);</span>
<a href="#l80.36"></a><span id="l80.36">     // tooltip appears above or below pointer, so may have as little as</span>
<a href="#l80.37"></a><span id="l80.37">     // one half the screen height available (avoid top going off screen).</span>
<a href="#l80.38"></a><span id="l80.38">     vbox.maxHeight = Math.floor(screen.height / 2);</span>
<a href="#l80.39"></a><span id="l80.39">     boxInitializeHeaderGrid(vbox);</span>
<a href="#l80.40"></a><span id="l80.40"> </span>
<a href="#l80.41"></a><span id="l80.41" class="difflineminus">-    var hasHeader = false;</span>
<a href="#l80.42"></a><span id="l80.42" class="difflineplus">+    let hasHeader = false;</span>
<a href="#l80.43"></a><span id="l80.43"> </span>
<a href="#l80.44"></a><span id="l80.44">     if (toDoItem.title) {</span>
<a href="#l80.45"></a><span id="l80.45">       boxAppendLabeledText(vbox, &quot;tooltipTitle&quot;, toDoItem.title);</span>
<a href="#l80.46"></a><span id="l80.46">       hasHeader = true;</span>
<a href="#l80.47"></a><span id="l80.47">     }</span>
<a href="#l80.48"></a><span id="l80.48"> </span>
<a href="#l80.49"></a><span id="l80.49" class="difflineminus">-    var location = toDoItem.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineplus">+    let location = toDoItem.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l80.51"></a><span id="l80.51">     if (location) {</span>
<a href="#l80.52"></a><span id="l80.52">       boxAppendLabeledText(vbox, &quot;tooltipLocation&quot;, location);</span>
<a href="#l80.53"></a><span id="l80.53">       hasHeader = true;</span>
<a href="#l80.54"></a><span id="l80.54">     }</span>
<a href="#l80.55"></a><span id="l80.55"> </span>
<a href="#l80.56"></a><span id="l80.56">     // First try to get calendar name appearing in tooltip</span>
<a href="#l80.57"></a><span id="l80.57">     if (toDoItem.calendar.name) {</span>
<a href="#l80.58"></a><span id="l80.58">       let calendarNameString = toDoItem.calendar.name;</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineat">@@ -82,50 +82,50 @@ function getPreviewForTask(toDoItem) {</span>
<a href="#l80.60"></a><span id="l80.60">     }</span>
<a href="#l80.61"></a><span id="l80.61"> </span>
<a href="#l80.62"></a><span id="l80.62">     if (toDoItem.dueDate &amp;&amp; toDoItem.dueDate.isValid) {</span>
<a href="#l80.63"></a><span id="l80.63">       boxAppendLabeledDateTime(vbox, &quot;tooltipDue&quot;, toDoItem.dueDate);</span>
<a href="#l80.64"></a><span id="l80.64">       hasHeader = true;</span>
<a href="#l80.65"></a><span id="l80.65">     }</span>
<a href="#l80.66"></a><span id="l80.66"> </span>
<a href="#l80.67"></a><span id="l80.67">     if (toDoItem.priority &amp;&amp; toDoItem.priority != 0) {</span>
<a href="#l80.68"></a><span id="l80.68" class="difflineminus">-      var priorityInteger = parseInt(toDoItem.priority, 10);</span>
<a href="#l80.69"></a><span id="l80.69" class="difflineminus">-      var priorityString;</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineplus">+      let priorityInteger = parseInt(toDoItem.priority, 10);</span>
<a href="#l80.71"></a><span id="l80.71" class="difflineplus">+      let priorityString;</span>
<a href="#l80.72"></a><span id="l80.72"> </span>
<a href="#l80.73"></a><span id="l80.73">       // These cut-offs should match calendar-event-dialog.js</span>
<a href="#l80.74"></a><span id="l80.74">       if (priorityInteger &gt;= 1 &amp;&amp; priorityInteger &lt;= 4) {</span>
<a href="#l80.75"></a><span id="l80.75">            priorityString = calGetString('calendar', 'highPriority'); // high priority</span>
<a href="#l80.76"></a><span id="l80.76">       } else if (priorityInteger == 5) {</span>
<a href="#l80.77"></a><span id="l80.77">           priorityString = calGetString('calendar', 'normalPriority'); // normal priority</span>
<a href="#l80.78"></a><span id="l80.78">       } else {</span>
<a href="#l80.79"></a><span id="l80.79">           priorityString = calGetString('calendar', 'lowPriority'); // low priority</span>
<a href="#l80.80"></a><span id="l80.80">       }</span>
<a href="#l80.81"></a><span id="l80.81">       boxAppendLabeledText(vbox, &quot;tooltipPriority&quot;, priorityString);</span>
<a href="#l80.82"></a><span id="l80.82">       hasHeader = true;</span>
<a href="#l80.83"></a><span id="l80.83">     }</span>
<a href="#l80.84"></a><span id="l80.84"> </span>
<a href="#l80.85"></a><span id="l80.85">     if (toDoItem.status &amp;&amp; toDoItem.status != &quot;NONE&quot;) {</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineminus">-      var status = getToDoStatusString(toDoItem);</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineplus">+      let status = getToDoStatusString(toDoItem);</span>
<a href="#l80.88"></a><span id="l80.88">       boxAppendLabeledText(vbox, &quot;tooltipStatus&quot;, status);</span>
<a href="#l80.89"></a><span id="l80.89">       hasHeader = true;</span>
<a href="#l80.90"></a><span id="l80.90">     }</span>
<a href="#l80.91"></a><span id="l80.91"> </span>
<a href="#l80.92"></a><span id="l80.92">     if (toDoItem.status != null &amp;&amp; toDoItem.percentComplete != 0 &amp;&amp; toDoItem.percentComplete != 100) {</span>
<a href="#l80.93"></a><span id="l80.93">       boxAppendLabeledText(vbox, &quot;tooltipPercent&quot;, String(toDoItem.percentComplete) + &quot;%&quot;);</span>
<a href="#l80.94"></a><span id="l80.94">       hasHeader = true;</span>
<a href="#l80.95"></a><span id="l80.95">     } else if (toDoItem.percentComplete == 100) {</span>
<a href="#l80.96"></a><span id="l80.96">       if (toDoItem.completedDate == null) {</span>
<a href="#l80.97"></a><span id="l80.97">         boxAppendLabeledText(vbox, &quot;tooltipPercent&quot;, &quot;100%&quot;);</span>
<a href="#l80.98"></a><span id="l80.98">       } else {</span>
<a href="#l80.99"></a><span id="l80.99">         boxAppendLabeledDateTime(vbox, &quot;tooltipCompleted&quot;, toDoItem.completedDate);</span>
<a href="#l80.100"></a><span id="l80.100">       }</span>
<a href="#l80.101"></a><span id="l80.101">       hasHeader = true;</span>
<a href="#l80.102"></a><span id="l80.102">     }</span>
<a href="#l80.103"></a><span id="l80.103"> </span>
<a href="#l80.104"></a><span id="l80.104" class="difflineminus">-    var description = toDoItem.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l80.105"></a><span id="l80.105" class="difflineplus">+    let description = toDoItem.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l80.106"></a><span id="l80.106">     if (description) {</span>
<a href="#l80.107"></a><span id="l80.107">       // display wrapped description lines like body of message below headers</span>
<a href="#l80.108"></a><span id="l80.108">       if (hasHeader) {</span>
<a href="#l80.109"></a><span id="l80.109">         boxAppendBodySeparator(vbox);</span>
<a href="#l80.110"></a><span id="l80.110">       }</span>
<a href="#l80.111"></a><span id="l80.111">       boxAppendBody(vbox, description);</span>
<a href="#l80.112"></a><span id="l80.112">     }</span>
<a href="#l80.113"></a><span id="l80.113"> </span>
<a href="#l80.114"></a><span id="l80.114" class="difflineat">@@ -138,30 +138,30 @@ function getPreviewForTask(toDoItem) {</span>
<a href="#l80.115"></a><span id="l80.115"> /**</span>
<a href="#l80.116"></a><span id="l80.116">  *  Called when mouse moves over a different, or</span>
<a href="#l80.117"></a><span id="l80.117">  *  when mouse moves over event in event list.</span>
<a href="#l80.118"></a><span id="l80.118">  *  The instStartDate is date of instance displayed at event box</span>
<a href="#l80.119"></a><span id="l80.119">  *  (recurring or multiday events may be displayed by more than one event box</span>
<a href="#l80.120"></a><span id="l80.120">  *  for different days), or null if should compute next instance from now.</span>
<a href="#l80.121"></a><span id="l80.121">  */</span>
<a href="#l80.122"></a><span id="l80.122"> function getPreviewForEvent(aEvent) {</span>
<a href="#l80.123"></a><span id="l80.123" class="difflineminus">-  var event = aEvent;</span>
<a href="#l80.124"></a><span id="l80.124" class="difflineplus">+  let event = aEvent;</span>
<a href="#l80.125"></a><span id="l80.125">   const vbox = document.createElement(&quot;vbox&quot;);</span>
<a href="#l80.126"></a><span id="l80.126">   vbox.setAttribute(&quot;class&quot;, &quot;tooltipBox&quot;);</span>
<a href="#l80.127"></a><span id="l80.127">   // tooltip appears above or below pointer, so may have as little as</span>
<a href="#l80.128"></a><span id="l80.128">   // one half the screen height available (avoid top going off screen).</span>
<a href="#l80.129"></a><span id="l80.129">   vbox.maxHeight = Math.floor(screen.height / 2);</span>
<a href="#l80.130"></a><span id="l80.130">   boxInitializeHeaderGrid(vbox);</span>
<a href="#l80.131"></a><span id="l80.131"> </span>
<a href="#l80.132"></a><span id="l80.132">   if (event) {</span>
<a href="#l80.133"></a><span id="l80.133">     if (event.title) {</span>
<a href="#l80.134"></a><span id="l80.134">       boxAppendLabeledText(vbox, &quot;tooltipTitle&quot;, aEvent.title);</span>
<a href="#l80.135"></a><span id="l80.135">     }</span>
<a href="#l80.136"></a><span id="l80.136"> </span>
<a href="#l80.137"></a><span id="l80.137" class="difflineminus">-    var location = event.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l80.138"></a><span id="l80.138" class="difflineplus">+    let location = event.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l80.139"></a><span id="l80.139">     if (location) {</span>
<a href="#l80.140"></a><span id="l80.140">       boxAppendLabeledText(vbox, &quot;tooltipLocation&quot;, location);</span>
<a href="#l80.141"></a><span id="l80.141">     }</span>
<a href="#l80.142"></a><span id="l80.142">     if (!(event.startDate &amp;&amp; event.endDate)) {</span>
<a href="#l80.143"></a><span id="l80.143">         // Event may be recurrent event.   If no displayed instance specified,</span>
<a href="#l80.144"></a><span id="l80.144">         // use next instance, or previous instance if no next instance.</span>
<a href="#l80.145"></a><span id="l80.145">         event = getCurrentNextOrPreviousRecurrence(event);</span>
<a href="#l80.146"></a><span id="l80.146">     }</span>
<a href="#l80.147"></a><span id="l80.147" class="difflineat">@@ -169,26 +169,26 @@ function getPreviewForEvent(aEvent) {</span>
<a href="#l80.148"></a><span id="l80.148"> </span>
<a href="#l80.149"></a><span id="l80.149">     // First try to get calendar name appearing in tooltip</span>
<a href="#l80.150"></a><span id="l80.150">     if (event.calendar.name) {</span>
<a href="#l80.151"></a><span id="l80.151">       let calendarNameString = event.calendar.name;</span>
<a href="#l80.152"></a><span id="l80.152">       boxAppendLabeledText(vbox, &quot;tooltipCalName&quot;, calendarNameString);</span>
<a href="#l80.153"></a><span id="l80.153">     }</span>
<a href="#l80.154"></a><span id="l80.154"> </span>
<a href="#l80.155"></a><span id="l80.155">     if (event.status &amp;&amp; event.status != &quot;NONE&quot;) {</span>
<a href="#l80.156"></a><span id="l80.156" class="difflineminus">-      var statusString = getEventStatusString(event);</span>
<a href="#l80.157"></a><span id="l80.157" class="difflineplus">+      let statusString = getEventStatusString(event);</span>
<a href="#l80.158"></a><span id="l80.158">       boxAppendLabeledText(vbox, &quot;tooltipStatus&quot;, statusString);</span>
<a href="#l80.159"></a><span id="l80.159">     }</span>
<a href="#l80.160"></a><span id="l80.160"> </span>
<a href="#l80.161"></a><span id="l80.161">     if (event.organizer &amp;&amp; event.getAttendees({}).length &gt; 0) {</span>
<a href="#l80.162"></a><span id="l80.162">       let organizer = event.organizer;</span>
<a href="#l80.163"></a><span id="l80.163">       boxAppendLabeledText(vbox, &quot;tooltipOrganizer&quot;, organizer);</span>
<a href="#l80.164"></a><span id="l80.164">     }</span>
<a href="#l80.165"></a><span id="l80.165"> </span>
<a href="#l80.166"></a><span id="l80.166" class="difflineminus">-    var description = event.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l80.167"></a><span id="l80.167" class="difflineplus">+    let description = event.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l80.168"></a><span id="l80.168">     if (description) {</span>
<a href="#l80.169"></a><span id="l80.169">       boxAppendBodySeparator(vbox);</span>
<a href="#l80.170"></a><span id="l80.170">       // display wrapped description lines, like body of message below headers</span>
<a href="#l80.171"></a><span id="l80.171">       boxAppendBody(vbox, description);</span>
<a href="#l80.172"></a><span id="l80.172">     }</span>
<a href="#l80.173"></a><span id="l80.173">     return (vbox);</span>
<a href="#l80.174"></a><span id="l80.174">   } else {</span>
<a href="#l80.175"></a><span id="l80.175">       return null;</span>
<a href="#l80.176"></a><span id="l80.176" class="difflineat">@@ -241,60 +241,60 @@ function boxAppendBodySeparator(vbox) {</span>
<a href="#l80.177"></a><span id="l80.177"> </span>
<a href="#l80.178"></a><span id="l80.178"> /**</span>
<a href="#l80.179"></a><span id="l80.179">  * PRIVATE: Append description to box for body text.  Text may contain</span>
<a href="#l80.180"></a><span id="l80.180">  * paragraphs; line indent and line breaks will be preserved by CSS.</span>
<a href="#l80.181"></a><span id="l80.181">  * @param box           box to which to append body</span>
<a href="#l80.182"></a><span id="l80.182">  * @param textString    text of body</span>
<a href="#l80.183"></a><span id="l80.183">  */</span>
<a href="#l80.184"></a><span id="l80.184"> function boxAppendBody(box, textString) {</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineminus">-  var textNode = document.createTextNode(textString);</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineminus">-  var xulDescription = document.createElement(&quot;description&quot;);</span>
<a href="#l80.187"></a><span id="l80.187" class="difflineplus">+  let textNode = document.createTextNode(textString);</span>
<a href="#l80.188"></a><span id="l80.188" class="difflineplus">+  let xulDescription = document.createElement(&quot;description&quot;);</span>
<a href="#l80.189"></a><span id="l80.189">   xulDescription.setAttribute(&quot;class&quot;, &quot;tooltipBody&quot;);</span>
<a href="#l80.190"></a><span id="l80.190">   xulDescription.appendChild(textNode);</span>
<a href="#l80.191"></a><span id="l80.191">   box.appendChild(xulDescription);</span>
<a href="#l80.192"></a><span id="l80.192"> }</span>
<a href="#l80.193"></a><span id="l80.193"> </span>
<a href="#l80.194"></a><span id="l80.194"> /**</span>
<a href="#l80.195"></a><span id="l80.195">  * PRIVATE: Use dateFormatter to format date and time,</span>
<a href="#l80.196"></a><span id="l80.196">  * and to header grid append a row containing localized Label: date.</span>
<a href="#l80.197"></a><span id="l80.197">  */</span>
<a href="#l80.198"></a><span id="l80.198"> function boxAppendLabeledDateTime(box, labelProperty, date) {</span>
<a href="#l80.199"></a><span id="l80.199">   date = date.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l80.200"></a><span id="l80.200" class="difflineminus">-  var formattedDateTime = getDateFormatter().formatDateTime(date);</span>
<a href="#l80.201"></a><span id="l80.201" class="difflineplus">+  let formattedDateTime = getDateFormatter().formatDateTime(date);</span>
<a href="#l80.202"></a><span id="l80.202">   boxAppendLabeledText(box, labelProperty, formattedDateTime);</span>
<a href="#l80.203"></a><span id="l80.203"> }</span>
<a href="#l80.204"></a><span id="l80.204"> </span>
<a href="#l80.205"></a><span id="l80.205"> /**</span>
<a href="#l80.206"></a><span id="l80.206">  * PRIVATE: Use dateFormatter to format date and time interval,</span>
<a href="#l80.207"></a><span id="l80.207">  * and to header grid append a row containing localized Label: interval.</span>
<a href="#l80.208"></a><span id="l80.208">  * @param box               contains header grid.</span>
<a href="#l80.209"></a><span id="l80.209">  * @param labelProperty     name of property for localized field label.</span>
<a href="#l80.210"></a><span id="l80.210">  * @param item              the event or task</span>
<a href="#l80.211"></a><span id="l80.211">  */</span>
<a href="#l80.212"></a><span id="l80.212"> function boxAppendLabeledDateTimeInterval(box, labelProperty, item) {</span>
<a href="#l80.213"></a><span id="l80.213" class="difflineminus">-  var dateString = getDateFormatter().formatItemInterval(item);</span>
<a href="#l80.214"></a><span id="l80.214" class="difflineplus">+  let dateString = getDateFormatter().formatItemInterval(item);</span>
<a href="#l80.215"></a><span id="l80.215">   boxAppendLabeledText(box, labelProperty, dateString);</span>
<a href="#l80.216"></a><span id="l80.216"> }</span>
<a href="#l80.217"></a><span id="l80.217"> </span>
<a href="#l80.218"></a><span id="l80.218"> /**</span>
<a href="#l80.219"></a><span id="l80.219">  * PRIVATE: create empty 2-column grid for header fields,</span>
<a href="#l80.220"></a><span id="l80.220">  * and append it to box.</span>
<a href="#l80.221"></a><span id="l80.221">  */</span>
<a href="#l80.222"></a><span id="l80.222"> function boxInitializeHeaderGrid(box) {</span>
<a href="#l80.223"></a><span id="l80.223" class="difflineminus">-  var grid = document.createElement(&quot;grid&quot;);</span>
<a href="#l80.224"></a><span id="l80.224" class="difflineplus">+  let grid = document.createElement(&quot;grid&quot;);</span>
<a href="#l80.225"></a><span id="l80.225">   grid.setAttribute(&quot;class&quot;, &quot;tooltipHeaderGrid&quot;);</span>
<a href="#l80.226"></a><span id="l80.226" class="difflineminus">-  var rows;</span>
<a href="#l80.227"></a><span id="l80.227" class="difflineplus">+  let rows;</span>
<a href="#l80.228"></a><span id="l80.228">   {</span>
<a href="#l80.229"></a><span id="l80.229" class="difflineminus">-    var columns = document.createElement(&quot;columns&quot;);</span>
<a href="#l80.230"></a><span id="l80.230" class="difflineplus">+    let columns = document.createElement(&quot;columns&quot;);</span>
<a href="#l80.231"></a><span id="l80.231">     {</span>
<a href="#l80.232"></a><span id="l80.232" class="difflineminus">-      var labelColumn = document.createElement(&quot;column&quot;);</span>
<a href="#l80.233"></a><span id="l80.233" class="difflineplus">+      let labelColumn = document.createElement(&quot;column&quot;);</span>
<a href="#l80.234"></a><span id="l80.234">       labelColumn.setAttribute(&quot;class&quot;, &quot;tooltipLabelColumn&quot;);</span>
<a href="#l80.235"></a><span id="l80.235">       columns.appendChild(labelColumn);</span>
<a href="#l80.236"></a><span id="l80.236" class="difflineminus">-      var valueColumn = document.createElement(&quot;column&quot;);</span>
<a href="#l80.237"></a><span id="l80.237" class="difflineplus">+      let valueColumn = document.createElement(&quot;column&quot;);</span>
<a href="#l80.238"></a><span id="l80.238">       valueColumn.setAttribute(&quot;class&quot;, &quot;tooltipValueColumn&quot;);</span>
<a href="#l80.239"></a><span id="l80.239">       columns.appendChild(valueColumn);</span>
<a href="#l80.240"></a><span id="l80.240">     }</span>
<a href="#l80.241"></a><span id="l80.241">     grid.appendChild(columns);</span>
<a href="#l80.242"></a><span id="l80.242">     rows = document.createElement(&quot;rows&quot;);</span>
<a href="#l80.243"></a><span id="l80.243">     grid.appendChild(rows);</span>
<a href="#l80.244"></a><span id="l80.244">   }</span>
<a href="#l80.245"></a><span id="l80.245">   box.appendChild(grid);</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineat">@@ -303,62 +303,62 @@ function boxInitializeHeaderGrid(box) {</span>
<a href="#l80.247"></a><span id="l80.247"> /**</span>
<a href="#l80.248"></a><span id="l80.248">  * PRIVATE: To headers grid, append a row containing Label: value,</span>
<a href="#l80.249"></a><span id="l80.249">  * where label is localized text for labelProperty.</span>
<a href="#l80.250"></a><span id="l80.250">  * @param box               box containing headers grid</span>
<a href="#l80.251"></a><span id="l80.251">  * @param labelProperty     name of property for localized name of header</span>
<a href="#l80.252"></a><span id="l80.252">  * @param textString        value of header field.</span>
<a href="#l80.253"></a><span id="l80.253">  */</span>
<a href="#l80.254"></a><span id="l80.254"> function boxAppendLabeledText(box, labelProperty, textString) {</span>
<a href="#l80.255"></a><span id="l80.255" class="difflineminus">-  var labelText = calGetString('calendar', labelProperty);</span>
<a href="#l80.256"></a><span id="l80.256" class="difflineminus">-  var rows = box.getElementsByTagNameNS(box.namespaceURI, &quot;rows&quot;)[0];</span>
<a href="#l80.257"></a><span id="l80.257" class="difflineplus">+  let labelText = calGetString('calendar', labelProperty);</span>
<a href="#l80.258"></a><span id="l80.258" class="difflineplus">+  let rows = box.getElementsByTagNameNS(box.namespaceURI, &quot;rows&quot;)[0];</span>
<a href="#l80.259"></a><span id="l80.259">   {</span>
<a href="#l80.260"></a><span id="l80.260" class="difflineminus">-    var row = document.createElement(&quot;row&quot;);</span>
<a href="#l80.261"></a><span id="l80.261" class="difflineplus">+    let row = document.createElement(&quot;row&quot;);</span>
<a href="#l80.262"></a><span id="l80.262">     {</span>
<a href="#l80.263"></a><span id="l80.263">       row.appendChild(createTooltipHeaderLabel(labelText));</span>
<a href="#l80.264"></a><span id="l80.264">       row.appendChild(createTooltipHeaderDescription(textString));</span>
<a href="#l80.265"></a><span id="l80.265">     }</span>
<a href="#l80.266"></a><span id="l80.266">     rows.appendChild(row);</span>
<a href="#l80.267"></a><span id="l80.267">   }</span>
<a href="#l80.268"></a><span id="l80.268"> }</span>
<a href="#l80.269"></a><span id="l80.269"> </span>
<a href="#l80.270"></a><span id="l80.270"> /** PRIVATE: create element for field label (for header grid). **/</span>
<a href="#l80.271"></a><span id="l80.271"> function createTooltipHeaderLabel(text) {</span>
<a href="#l80.272"></a><span id="l80.272" class="difflineminus">-  var label = document.createElement(&quot;label&quot;);</span>
<a href="#l80.273"></a><span id="l80.273" class="difflineplus">+  let label = document.createElement(&quot;label&quot;);</span>
<a href="#l80.274"></a><span id="l80.274">   label.setAttribute(&quot;class&quot;, &quot;tooltipHeaderLabel&quot;);</span>
<a href="#l80.275"></a><span id="l80.275">   label.appendChild(document.createTextNode(text));</span>
<a href="#l80.276"></a><span id="l80.276">   return label;</span>
<a href="#l80.277"></a><span id="l80.277"> }</span>
<a href="#l80.278"></a><span id="l80.278"> </span>
<a href="#l80.279"></a><span id="l80.279"> /** PRIVATE: create element for field value (for header grid). **/</span>
<a href="#l80.280"></a><span id="l80.280"> function createTooltipHeaderDescription(text) {</span>
<a href="#l80.281"></a><span id="l80.281" class="difflineminus">-  var label = document.createElement(&quot;description&quot;);</span>
<a href="#l80.282"></a><span id="l80.282" class="difflineplus">+  let label = document.createElement(&quot;description&quot;);</span>
<a href="#l80.283"></a><span id="l80.283">   label.setAttribute(&quot;class&quot;, &quot;tooltipHeaderDescription&quot;);</span>
<a href="#l80.284"></a><span id="l80.284">   label.appendChild(document.createTextNode(text));</span>
<a href="#l80.285"></a><span id="l80.285">   return label;</span>
<a href="#l80.286"></a><span id="l80.286"> }</span>
<a href="#l80.287"></a><span id="l80.287"> </span>
<a href="#l80.288"></a><span id="l80.288"> /**</span>
<a href="#l80.289"></a><span id="l80.289">  * If now is during an occurrence, return the occurrence.</span>
<a href="#l80.290"></a><span id="l80.290">  * Else if now is before an occurrence, return the next occurrence.</span>
<a href="#l80.291"></a><span id="l80.291">  * Otherwise return the previous occurrence.</span>
<a href="#l80.292"></a><span id="l80.292">  */</span>
<a href="#l80.293"></a><span id="l80.293"> function getCurrentNextOrPreviousRecurrence(calendarEvent) {</span>
<a href="#l80.294"></a><span id="l80.294">     if (!calendarEvent.recurrenceInfo) {</span>
<a href="#l80.295"></a><span id="l80.295">         return calendarEvent;</span>
<a href="#l80.296"></a><span id="l80.296">     }</span>
<a href="#l80.297"></a><span id="l80.297"> </span>
<a href="#l80.298"></a><span id="l80.298" class="difflineminus">-    var dur = calendarEvent.duration.clone();</span>
<a href="#l80.299"></a><span id="l80.299" class="difflineplus">+    let dur = calendarEvent.duration.clone();</span>
<a href="#l80.300"></a><span id="l80.300">     dur.isNegative = true;</span>
<a href="#l80.301"></a><span id="l80.301"> </span>
<a href="#l80.302"></a><span id="l80.302">     // To find current event when now is during event, look for occurrence</span>
<a href="#l80.303"></a><span id="l80.303">     // starting duration ago.</span>
<a href="#l80.304"></a><span id="l80.304" class="difflineminus">-    var probeTime = now();</span>
<a href="#l80.305"></a><span id="l80.305" class="difflineplus">+    let probeTime = now();</span>
<a href="#l80.306"></a><span id="l80.306">     probeTime.addDuration(dur);</span>
<a href="#l80.307"></a><span id="l80.307"> </span>
<a href="#l80.308"></a><span id="l80.308" class="difflineminus">-    var occ = calendarEvent.recurrenceInfo.getNextOccurrence(probeTime);</span>
<a href="#l80.309"></a><span id="l80.309" class="difflineplus">+    let occ = calendarEvent.recurrenceInfo.getNextOccurrence(probeTime);</span>
<a href="#l80.310"></a><span id="l80.310"> </span>
<a href="#l80.311"></a><span id="l80.311">     if (!occ) {</span>
<a href="#l80.312"></a><span id="l80.312" class="difflineminus">-        var occs = calendarEvent.recurrenceInfo.getOccurrences(calendarEvent.startDate, probeTime, 0, {});</span>
<a href="#l80.313"></a><span id="l80.313" class="difflineplus">+        let occs = calendarEvent.recurrenceInfo.getOccurrences(calendarEvent.startDate, probeTime, 0, {});</span>
<a href="#l80.314"></a><span id="l80.314">         occ = occs[occs.length - 1];</span>
<a href="#l80.315"></a><span id="l80.315">     }</span>
<a href="#l80.316"></a><span id="l80.316">     return occ;</span>
<a href="#l80.317"></a><span id="l80.317"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/resources/content/publish.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/resources/content/publish.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -7,17 +7,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l81.4"></a><span id="l81.4"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l81.5"></a><span id="l81.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l81.6"></a><span id="l81.6"> </span>
<a href="#l81.7"></a><span id="l81.7"> /**</span>
<a href="#l81.8"></a><span id="l81.8">  * publishCalendarData</span>
<a href="#l81.9"></a><span id="l81.9">  * Show publish dialog, ask for URL and publish all selected items.</span>
<a href="#l81.10"></a><span id="l81.10">  */</span>
<a href="#l81.11"></a><span id="l81.11"> function publishCalendarData() {</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-   var args = {};</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+   let args = {};</span>
<a href="#l81.14"></a><span id="l81.14"> </span>
<a href="#l81.15"></a><span id="l81.15">    args.onOk = self.publishCalendarDataDialogResponse;</span>
<a href="#l81.16"></a><span id="l81.16"> </span>
<a href="#l81.17"></a><span id="l81.17">    openDialog(&quot;chrome://calendar/content/publishDialog.xul&quot;, &quot;caPublishEvents&quot;,</span>
<a href="#l81.18"></a><span id="l81.18">               &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l81.19"></a><span id="l81.19"> }</span>
<a href="#l81.20"></a><span id="l81.20"> </span>
<a href="#l81.21"></a><span id="l81.21"> /**</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineat">@@ -84,50 +84,50 @@ function publishEntireCalendar(aCalendar</span>
<a href="#l81.23"></a><span id="l81.23">  * Callback method for publishEntireCalendar() that is called when the user</span>
<a href="#l81.24"></a><span id="l81.24">  * presses the OK button in the publish dialog.</span>
<a href="#l81.25"></a><span id="l81.25">  */</span>
<a href="#l81.26"></a><span id="l81.26"> function publishEntireCalendarDialogResponse(CalendarPublishObject, aProgressDialog) {</span>
<a href="#l81.27"></a><span id="l81.27">     // store the selected remote ics path as a calendar preference</span>
<a href="#l81.28"></a><span id="l81.28">     CalendarPublishObject.calendar.setProperty(&quot;remote-ics-path&quot;,</span>
<a href="#l81.29"></a><span id="l81.29">                                            CalendarPublishObject.remotePath);</span>
<a href="#l81.30"></a><span id="l81.30"> </span>
<a href="#l81.31"></a><span id="l81.31" class="difflineminus">-    var itemArray = [];</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineminus">-    var getListener = {</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+    let itemArray = [];</span>
<a href="#l81.34"></a><span id="l81.34" class="difflineplus">+    let getListener = {</span>
<a href="#l81.35"></a><span id="l81.35">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l81.36"></a><span id="l81.36">         onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l81.37"></a><span id="l81.37">             publishItemArray(itemArray, CalendarPublishObject.remotePath, aProgressDialog);</span>
<a href="#l81.38"></a><span id="l81.38">         },</span>
<a href="#l81.39"></a><span id="l81.39">         onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l81.40"></a><span id="l81.40">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l81.41"></a><span id="l81.41">                 aborted = true;</span>
<a href="#l81.42"></a><span id="l81.42">                 return;</span>
<a href="#l81.43"></a><span id="l81.43">             }</span>
<a href="#l81.44"></a><span id="l81.44">             if (aCount) {</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineminus">-                for (var i = 0; i &lt; aCount; ++i) {</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineplus">+                for (let i = 0; i &lt; aCount; ++i) {</span>
<a href="#l81.47"></a><span id="l81.47">                     // Store a (short living) reference to the item.</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-                    var itemCopy = aItems[i].clone();</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineplus">+                    let itemCopy = aItems[i].clone();</span>
<a href="#l81.50"></a><span id="l81.50">                     itemArray.push(itemCopy);</span>
<a href="#l81.51"></a><span id="l81.51">                 }</span>
<a href="#l81.52"></a><span id="l81.52">             }</span>
<a href="#l81.53"></a><span id="l81.53">         }</span>
<a href="#l81.54"></a><span id="l81.54">     };</span>
<a href="#l81.55"></a><span id="l81.55">     aProgressDialog.onStartUpload();</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineminus">-    var oldCalendar = CalendarPublishObject.calendar;</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+    let oldCalendar = CalendarPublishObject.calendar;</span>
<a href="#l81.58"></a><span id="l81.58">     oldCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l81.59"></a><span id="l81.59">                          0, null, null, getListener);</span>
<a href="#l81.60"></a><span id="l81.60"> }</span>
<a href="#l81.61"></a><span id="l81.61"> </span>
<a href="#l81.62"></a><span id="l81.62"> function publishItemArray(aItemArray, aPath, aProgressDialog) {</span>
<a href="#l81.63"></a><span id="l81.63" class="difflineminus">-    var outputStream;</span>
<a href="#l81.64"></a><span id="l81.64" class="difflineminus">-    var inputStream;</span>
<a href="#l81.65"></a><span id="l81.65" class="difflineminus">-    var storageStream;</span>
<a href="#l81.66"></a><span id="l81.66" class="difflineplus">+    let outputStream;</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineplus">+    let inputStream;</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineplus">+    let storageStream;</span>
<a href="#l81.69"></a><span id="l81.69"> </span>
<a href="#l81.70"></a><span id="l81.70" class="difflineminus">-    var icsURL = makeURL(aPath);</span>
<a href="#l81.71"></a><span id="l81.71" class="difflineplus">+    let icsURL = makeURL(aPath);</span>
<a href="#l81.72"></a><span id="l81.72"> </span>
<a href="#l81.73"></a><span id="l81.73" class="difflineminus">-    var channel = Services.io.newChannelFromURI2(icsURL,</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineplus">+    let channel = Services.io.newChannelFromURI2(icsURL,</span>
<a href="#l81.75"></a><span id="l81.75">                                                  null,</span>
<a href="#l81.76"></a><span id="l81.76">                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l81.77"></a><span id="l81.77">                                                  null,</span>
<a href="#l81.78"></a><span id="l81.78">                                                  Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l81.79"></a><span id="l81.79">                                                  Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l81.80"></a><span id="l81.80">     if (icsURL.schemeIs('webcal')) {</span>
<a href="#l81.81"></a><span id="l81.81">         icsURL.scheme = 'http';</span>
<a href="#l81.82"></a><span id="l81.82">     }</span>
<a href="#l81.83"></a><span id="l81.83" class="difflineat">@@ -146,42 +146,42 @@ function publishItemArray(aItemArray, aP</span>
<a href="#l81.84"></a><span id="l81.84">         case 'file':</span>
<a href="#l81.85"></a><span id="l81.85">             channel = channel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l81.86"></a><span id="l81.86">             break;</span>
<a href="#l81.87"></a><span id="l81.87">         default:</span>
<a href="#l81.88"></a><span id="l81.88">             dump(&quot;No such scheme\n&quot;);</span>
<a href="#l81.89"></a><span id="l81.89">             return;</span>
<a href="#l81.90"></a><span id="l81.90">     }</span>
<a href="#l81.91"></a><span id="l81.91"> </span>
<a href="#l81.92"></a><span id="l81.92" class="difflineminus">-    var uploadChannel = channel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineplus">+    let uploadChannel = channel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l81.94"></a><span id="l81.94">     uploadChannel.notificationCallbacks = notificationCallbacks;</span>
<a href="#l81.95"></a><span id="l81.95"> </span>
<a href="#l81.96"></a><span id="l81.96">     storageStream = Components.classes[&quot;@mozilla.org/storagestream;1&quot;]</span>
<a href="#l81.97"></a><span id="l81.97">                                   .createInstance(Components.interfaces.nsIStorageStream);</span>
<a href="#l81.98"></a><span id="l81.98">     storageStream.init(32768, 0xffffffff, null);</span>
<a href="#l81.99"></a><span id="l81.99">     outputStream = storageStream.getOutputStream(0);</span>
<a href="#l81.100"></a><span id="l81.100"> </span>
<a href="#l81.101"></a><span id="l81.101" class="difflineminus">-    var serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l81.102"></a><span id="l81.102" class="difflineplus">+    let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l81.103"></a><span id="l81.103">                                .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l81.104"></a><span id="l81.104">     serializer.addItems(aItemArray, aItemArray.length);</span>
<a href="#l81.105"></a><span id="l81.105">     // Outlook requires METHOD:PUBLISH property:</span>
<a href="#l81.106"></a><span id="l81.106" class="difflineminus">-    var methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l81.107"></a><span id="l81.107" class="difflineplus">+    let methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l81.108"></a><span id="l81.108">     methodProp.value = &quot;PUBLISH&quot;;</span>
<a href="#l81.109"></a><span id="l81.109">     serializer.addProperty(methodProp);</span>
<a href="#l81.110"></a><span id="l81.110">     serializer.serializeToStream(outputStream);</span>
<a href="#l81.111"></a><span id="l81.111">     outputStream.close();</span>
<a href="#l81.112"></a><span id="l81.112"> </span>
<a href="#l81.113"></a><span id="l81.113">     inputStream = storageStream.newInputStream(0);</span>
<a href="#l81.114"></a><span id="l81.114"> </span>
<a href="#l81.115"></a><span id="l81.115">     uploadChannel.setUploadStream(inputStream,</span>
<a href="#l81.116"></a><span id="l81.116">                                   &quot;text/calendar&quot;, -1);</span>
<a href="#l81.117"></a><span id="l81.117">     try {</span>
<a href="#l81.118"></a><span id="l81.118">         channel.asyncOpen(publishingListener, aProgressDialog);</span>
<a href="#l81.119"></a><span id="l81.119">     } catch (e) {</span>
<a href="#l81.120"></a><span id="l81.120" class="difflineminus">-        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l81.121"></a><span id="l81.121" class="difflineplus">+        let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l81.122"></a><span id="l81.122">         Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l81.123"></a><span id="l81.123">                               props.formatStringFromName('otherPutError', [e.message], 1));</span>
<a href="#l81.124"></a><span id="l81.124">     }</span>
<a href="#l81.125"></a><span id="l81.125"> }</span>
<a href="#l81.126"></a><span id="l81.126"> </span>
<a href="#l81.127"></a><span id="l81.127"> </span>
<a href="#l81.128"></a><span id="l81.128"> var notificationCallbacks =</span>
<a href="#l81.129"></a><span id="l81.129"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/resources/content/publishDialog.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/resources/content/publishDialog.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -6,33 +6,33 @@ var gOnOkFunction;   // function to be c</span>
<a href="#l82.4"></a><span id="l82.4"> var gPublishObject;</span>
<a href="#l82.5"></a><span id="l82.5"> </span>
<a href="#l82.6"></a><span id="l82.6"> /**</span>
<a href="#l82.7"></a><span id="l82.7"> *   Called when the dialog is loaded.</span>
<a href="#l82.8"></a><span id="l82.8"> */</span>
<a href="#l82.9"></a><span id="l82.9"> function loadCalendarPublishDialog() {</span>
<a href="#l82.10"></a><span id="l82.10">    // Get arguments, see description at top of file</span>
<a href="#l82.11"></a><span id="l82.11"> </span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-   var args = window.arguments[0];</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+   let args = window.arguments[0];</span>
<a href="#l82.14"></a><span id="l82.14"> </span>
<a href="#l82.15"></a><span id="l82.15">    gOnOkFunction = args.onOk;</span>
<a href="#l82.16"></a><span id="l82.16"> </span>
<a href="#l82.17"></a><span id="l82.17">    if (args.publishObject) {</span>
<a href="#l82.18"></a><span id="l82.18">       gPublishObject = args.publishObject;</span>
<a href="#l82.19"></a><span id="l82.19">       if (args.publishObject.remotePath) {</span>
<a href="#l82.20"></a><span id="l82.20">           document.getElementById(&quot;publish-remotePath-textbox&quot;).value = args.publishObject.remotePath;</span>
<a href="#l82.21"></a><span id="l82.21">       }</span>
<a href="#l82.22"></a><span id="l82.22">    } else {</span>
<a href="#l82.23"></a><span id="l82.23">       gPublishObject = {};</span>
<a href="#l82.24"></a><span id="l82.24">    }</span>
<a href="#l82.25"></a><span id="l82.25">    document.getElementById(&quot;calendar-publishwindow&quot;).getButton(&quot;accept&quot;).setAttribute(&quot;label&quot;, publishButtonLabel);</span>
<a href="#l82.26"></a><span id="l82.26"> </span>
<a href="#l82.27"></a><span id="l82.27">    checkURLField();</span>
<a href="#l82.28"></a><span id="l82.28"> </span>
<a href="#l82.29"></a><span id="l82.29" class="difflineminus">-   var firstFocus = document.getElementById(&quot;publish-remotePath-textbox&quot;);</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineplus">+   let firstFocus = document.getElementById(&quot;publish-remotePath-textbox&quot;);</span>
<a href="#l82.31"></a><span id="l82.31">    firstFocus.focus();</span>
<a href="#l82.32"></a><span id="l82.32"> }</span>
<a href="#l82.33"></a><span id="l82.33"> </span>
<a href="#l82.34"></a><span id="l82.34"> </span>
<a href="#l82.35"></a><span id="l82.35"> </span>
<a href="#l82.36"></a><span id="l82.36"> /**</span>
<a href="#l82.37"></a><span id="l82.37"> *   Called when the OK button is clicked.</span>
<a href="#l82.38"></a><span id="l82.38"> */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testAnnualRecurrence.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testAnnualRecurrence.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -10,17 +10,17 @@ var startYear = 1950;</span>
<a href="#l83.4"></a><span id="l83.4"> var epoch = 1970;</span>
<a href="#l83.5"></a><span id="l83.5"> </span>
<a href="#l83.6"></a><span id="l83.6"> var setupModule = function(module) {</span>
<a href="#l83.7"></a><span id="l83.7">   controller = mozmill.getMail3PaneController();</span>
<a href="#l83.8"></a><span id="l83.8">   calUtils.createCalendar(controller, calendar);</span>
<a href="#l83.9"></a><span id="l83.9"> };</span>
<a href="#l83.10"></a><span id="l83.10"> </span>
<a href="#l83.11"></a><span id="l83.11"> var testAnnualRecurrence = function() {</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-  var eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+  let eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l83.14"></a><span id="l83.14"> </span>
<a href="#l83.15"></a><span id="l83.15">   controller.click(new elementslib.ID(controller.window.document, &quot;calendar-tab-button&quot;));</span>
<a href="#l83.16"></a><span id="l83.16">   controller.sleep(sleep);</span>
<a href="#l83.17"></a><span id="l83.17"> </span>
<a href="#l83.18"></a><span id="l83.18">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l83.19"></a><span id="l83.19">   calUtils.goToDate(controller, startYear, 1, 1);</span>
<a href="#l83.20"></a><span id="l83.20"> </span>
<a href="#l83.21"></a><span id="l83.21">   // create yearly recurring all-day event</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testBiweeklyRecurrence.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -9,17 +9,17 @@ var calendar = &quot;Mozmill&quot;;</span>
<a href="#l84.4"></a><span id="l84.4"> var hour = 8;</span>
<a href="#l84.5"></a><span id="l84.5"> </span>
<a href="#l84.6"></a><span id="l84.6"> var setupModule = function(module) {</span>
<a href="#l84.7"></a><span id="l84.7">   controller = mozmill.getMail3PaneController();</span>
<a href="#l84.8"></a><span id="l84.8">   calUtils.createCalendar(controller, calendar);</span>
<a href="#l84.9"></a><span id="l84.9"> };</span>
<a href="#l84.10"></a><span id="l84.10"> </span>
<a href="#l84.11"></a><span id="l84.11"> var testBiweeklyRecurrence = function() {</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-  var eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+  let eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l84.14"></a><span id="l84.14"> </span>
<a href="#l84.15"></a><span id="l84.15">   controller.click(new elementslib.ID(controller.window.document, &quot;calendar-tab-button&quot;));</span>
<a href="#l84.16"></a><span id="l84.16">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l84.17"></a><span id="l84.17">   calUtils.goToDate(controller, 2009, 1, 31);</span>
<a href="#l84.18"></a><span id="l84.18"> </span>
<a href="#l84.19"></a><span id="l84.19">   // create biweekly event</span>
<a href="#l84.20"></a><span id="l84.20">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l84.21"></a><span id="l84.21">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testDailyRecurrence.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testDailyRecurrence.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -138,17 +138,17 @@ var testDailyRecurrence = function() {</span>
<a href="#l85.4"></a><span id="l85.4">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined,</span>
<a href="#l85.5"></a><span id="l85.5">     &quot;every.weekday&quot;);</span>
<a href="#l85.6"></a><span id="l85.6">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l85.7"></a><span id="l85.7">   controller.waitFor(function() {return mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0;});</span>
<a href="#l85.8"></a><span id="l85.8"> </span>
<a href="#l85.9"></a><span id="l85.9">   // check day view for 7 days</span>
<a href="#l85.10"></a><span id="l85.10">   let day = calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, undefined)</span>
<a href="#l85.11"></a><span id="l85.11">     + eventPath;</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-  var dates = [[2009, 1, 3],</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+  let dates = [[2009, 1, 3],</span>
<a href="#l85.14"></a><span id="l85.14">                [2009, 1, 4]];</span>
<a href="#l85.15"></a><span id="l85.15">   for (let i = 0; i &lt; dates.length; i++){</span>
<a href="#l85.16"></a><span id="l85.16">     calUtils.goToDate(controller, dates[i][0], dates[i][1], dates[i][2]);</span>
<a href="#l85.17"></a><span id="l85.17">     controller.assertNodeNotExist(new elementslib.Lookup(controller.window.document, day));</span>
<a href="#l85.18"></a><span id="l85.18">   }</span>
<a href="#l85.19"></a><span id="l85.19"> </span>
<a href="#l85.20"></a><span id="l85.20">   // check week view for 2 weeks</span>
<a href="#l85.21"></a><span id="l85.21">   calUtils.switchToView(controller, &quot;week&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrence/testLastDayOfMonthRecurrence.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -10,17 +10,17 @@ var calendar = &quot;Mozmill&quot;;</span>
<a href="#l86.4"></a><span id="l86.4"> var hour = 8;</span>
<a href="#l86.5"></a><span id="l86.5"> </span>
<a href="#l86.6"></a><span id="l86.6"> var setupModule = function(module) {</span>
<a href="#l86.7"></a><span id="l86.7">   controller = mozmill.getMail3PaneController();</span>
<a href="#l86.8"></a><span id="l86.8">   calUtils.createCalendar(controller, calendar);</span>
<a href="#l86.9"></a><span id="l86.9"> };</span>
<a href="#l86.10"></a><span id="l86.10"> </span>
<a href="#l86.11"></a><span id="l86.11"> var testLastDayOfMonthRecurrence = function() {</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-  var eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineplus">+  let eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l86.14"></a><span id="l86.14">   controller.click(new elementslib.ID(controller.window.document, &quot;calendar-tab-button&quot;));</span>
<a href="#l86.15"></a><span id="l86.15">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l86.16"></a><span id="l86.16">   calUtils.goToDate(controller, 2008, 1, 31); // start with a leap year</span>
<a href="#l86.17"></a><span id="l86.17"> </span>
<a href="#l86.18"></a><span id="l86.18">   // create monthly recurring event</span>
<a href="#l86.19"></a><span id="l86.19">   controller.doubleClick(new elementslib.Lookup(controller.window.document,</span>
<a href="#l86.20"></a><span id="l86.20">     calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.CANVAS_BOX, undefined, 1, hour)), 1, 1);</span>
<a href="#l86.21"></a><span id="l86.21">   controller.waitFor(function() {return mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0;}, sleep);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -10,17 +10,17 @@ var startYear = 1950;</span>
<a href="#l87.4"></a><span id="l87.4"> var epoch = 1970;</span>
<a href="#l87.5"></a><span id="l87.5"> </span>
<a href="#l87.6"></a><span id="l87.6"> var setupModule = function(module) {</span>
<a href="#l87.7"></a><span id="l87.7">   controller = mozmill.getMail3PaneController();</span>
<a href="#l87.8"></a><span id="l87.8">   calUtils.createCalendar(controller, calendar);</span>
<a href="#l87.9"></a><span id="l87.9"> };</span>
<a href="#l87.10"></a><span id="l87.10"> </span>
<a href="#l87.11"></a><span id="l87.11"> var testAnnualRecurrence = function() {</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-  var eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+  let eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l87.14"></a><span id="l87.14"> </span>
<a href="#l87.15"></a><span id="l87.15">   controller.click(new elementslib.ID(controller.window.document, &quot;calendar-tab-button&quot;));</span>
<a href="#l87.16"></a><span id="l87.16">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l87.17"></a><span id="l87.17">   calUtils.goToDate(controller, startYear, 1, 1);</span>
<a href="#l87.18"></a><span id="l87.18"> </span>
<a href="#l87.19"></a><span id="l87.19">   // rotate view</span>
<a href="#l87.20"></a><span id="l87.20">   controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l87.21"></a><span id="l87.21">   controller.waitFor(function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -9,17 +9,17 @@ var calendar = &quot;Mozmill&quot;;</span>
<a href="#l88.4"></a><span id="l88.4"> var hour = 8;</span>
<a href="#l88.5"></a><span id="l88.5"> </span>
<a href="#l88.6"></a><span id="l88.6"> var setupModule = function(module) {</span>
<a href="#l88.7"></a><span id="l88.7">   controller = mozmill.getMail3PaneController();</span>
<a href="#l88.8"></a><span id="l88.8">   calUtils.createCalendar(controller, calendar);</span>
<a href="#l88.9"></a><span id="l88.9"> };</span>
<a href="#l88.10"></a><span id="l88.10"> </span>
<a href="#l88.11"></a><span id="l88.11"> var testBiweeklyRecurrence = function() {</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-  var eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+  let eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l88.14"></a><span id="l88.14"> </span>
<a href="#l88.15"></a><span id="l88.15">   controller.click(new elementslib.ID(controller.window.document, &quot;calendar-tab-button&quot;));</span>
<a href="#l88.16"></a><span id="l88.16">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l88.17"></a><span id="l88.17">   calUtils.goToDate(controller, 2009, 1, 31);</span>
<a href="#l88.18"></a><span id="l88.18"> </span>
<a href="#l88.19"></a><span id="l88.19">   // rotate view</span>
<a href="#l88.20"></a><span id="l88.20">   controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l88.21"></a><span id="l88.21">   controller.waitFor(function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -145,17 +145,17 @@ var testDailyRecurrence = function() {</span>
<a href="#l89.4"></a><span id="l89.4">   event.select(new elementslib.ID(event.window.document, &quot;item-repeat&quot;), undefined, undefined,</span>
<a href="#l89.5"></a><span id="l89.5">     &quot;every.weekday&quot;);</span>
<a href="#l89.6"></a><span id="l89.6">   event.click(new elementslib.ID(event.window.document, &quot;button-save&quot;));</span>
<a href="#l89.7"></a><span id="l89.7">   controller.waitFor(function() {return mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0;});</span>
<a href="#l89.8"></a><span id="l89.8"> </span>
<a href="#l89.9"></a><span id="l89.9">   // check day view for 7 days</span>
<a href="#l89.10"></a><span id="l89.10">   let day = calUtils.getEventBoxPath(controller, &quot;day&quot;, calUtils.EVENT_BOX, undefined, 1, undefined)</span>
<a href="#l89.11"></a><span id="l89.11">     + eventPath;</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-  var dates = [[2009, 1, 3],</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+  let dates = [[2009, 1, 3],</span>
<a href="#l89.14"></a><span id="l89.14">                [2009, 1, 4]];</span>
<a href="#l89.15"></a><span id="l89.15">   for (let i = 0; i &lt; dates.length; i++){</span>
<a href="#l89.16"></a><span id="l89.16">     calUtils.goToDate(controller, dates[i][0], dates[i][1], dates[i][2]);</span>
<a href="#l89.17"></a><span id="l89.17">     controller.assertNodeNotExist(new elementslib.Lookup(controller.window.document, day));</span>
<a href="#l89.18"></a><span id="l89.18">   }</span>
<a href="#l89.19"></a><span id="l89.19"> </span>
<a href="#l89.20"></a><span id="l89.20">   // check week view for 2 weeks</span>
<a href="#l89.21"></a><span id="l89.21">   calUtils.switchToView(controller, &quot;week&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -10,17 +10,17 @@ var calendar = &quot;Mozmill&quot;;</span>
<a href="#l90.4"></a><span id="l90.4"> var hour = 8;</span>
<a href="#l90.5"></a><span id="l90.5"> </span>
<a href="#l90.6"></a><span id="l90.6"> var setupModule = function(module) {</span>
<a href="#l90.7"></a><span id="l90.7">   controller = mozmill.getMail3PaneController();</span>
<a href="#l90.8"></a><span id="l90.8">   calUtils.createCalendar(controller, calendar);</span>
<a href="#l90.9"></a><span id="l90.9"> };</span>
<a href="#l90.10"></a><span id="l90.10"> </span>
<a href="#l90.11"></a><span id="l90.11"> var testLastDayOfMonthRecurrence = function() {</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-  var eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+  let eventPath = '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;' + calendar.toLowerCase() + '&quot;}';</span>
<a href="#l90.14"></a><span id="l90.14">   controller.click(new elementslib.ID(controller.window.document, &quot;calendar-tab-button&quot;));</span>
<a href="#l90.15"></a><span id="l90.15">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l90.16"></a><span id="l90.16">   calUtils.goToDate(controller, 2008, 1, 31); // start with a leap year</span>
<a href="#l90.17"></a><span id="l90.17"> </span>
<a href="#l90.18"></a><span id="l90.18">   // rotate view</span>
<a href="#l90.19"></a><span id="l90.19">   controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l90.20"></a><span id="l90.20">   controller.waitFor(function() {</span>
<a href="#l90.21"></a><span id="l90.21">     let view = (new elementslib.ID(controller.window.document, &quot;day-view&quot;)).getNode();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -24,73 +24,73 @@ var Cr = Components.results;</span>
<a href="#l91.4"></a><span id="l91.4"> </span>
<a href="#l91.5"></a><span id="l91.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l91.6"></a><span id="l91.6"> </span>
<a href="#l91.7"></a><span id="l91.7"> // we might want to use calUtils.jsm only in the future throughout all tests,</span>
<a href="#l91.8"></a><span id="l91.8"> // but for now source in good old calUtils.js:</span>
<a href="#l91.9"></a><span id="l91.9"> cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(Cc));</span>
<a href="#l91.10"></a><span id="l91.10"> </span>
<a href="#l91.11"></a><span id="l91.11"> function createDate(aYear, aMonth, aDay, aHasTime, aHour, aMinute, aSecond, aTimezone) {</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-    var cd = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+    let cd = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l91.14"></a><span id="l91.14">              .createInstance(Ci.calIDateTime);</span>
<a href="#l91.15"></a><span id="l91.15">     cd.resetTo(aYear,</span>
<a href="#l91.16"></a><span id="l91.16">                aMonth,</span>
<a href="#l91.17"></a><span id="l91.17">                aDay,</span>
<a href="#l91.18"></a><span id="l91.18">                aHour || 0,</span>
<a href="#l91.19"></a><span id="l91.19">                aMinute || 0,</span>
<a href="#l91.20"></a><span id="l91.20">                aSecond || 0,</span>
<a href="#l91.21"></a><span id="l91.21">                aTimezone || UTC());</span>
<a href="#l91.22"></a><span id="l91.22">     cd.isDate = !aHasTime;</span>
<a href="#l91.23"></a><span id="l91.23">     return cd;</span>
<a href="#l91.24"></a><span id="l91.24"> }</span>
<a href="#l91.25"></a><span id="l91.25"> </span>
<a href="#l91.26"></a><span id="l91.26"> function createEventFromIcalString(icalString) {</span>
<a href="#l91.27"></a><span id="l91.27">     if (/^BEGIN:VCALENDAR/.test(icalString)) {</span>
<a href="#l91.28"></a><span id="l91.28" class="difflineminus">-        var parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l91.29"></a><span id="l91.29" class="difflineplus">+        let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l91.30"></a><span id="l91.30">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l91.31"></a><span id="l91.31">         parser.parseString(icalString);</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineminus">-        var items = parser.getItems({});</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineplus">+        let items = parser.getItems({});</span>
<a href="#l91.34"></a><span id="l91.34">         ASSERT(items.length == 1);</span>
<a href="#l91.35"></a><span id="l91.35">         return items[0];</span>
<a href="#l91.36"></a><span id="l91.36">     } else {</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineminus">-        var event = Cc[&quot;@mozilla.org/calendar/event;1&quot;].createInstance(Ci.calIEvent);</span>
<a href="#l91.38"></a><span id="l91.38" class="difflineplus">+        let event = Cc[&quot;@mozilla.org/calendar/event;1&quot;].createInstance(Ci.calIEvent);</span>
<a href="#l91.39"></a><span id="l91.39">         event.icalString = icalString;</span>
<a href="#l91.40"></a><span id="l91.40">         return event;</span>
<a href="#l91.41"></a><span id="l91.41">     }</span>
<a href="#l91.42"></a><span id="l91.42"> }</span>
<a href="#l91.43"></a><span id="l91.43"> </span>
<a href="#l91.44"></a><span id="l91.44"> function createTodoFromIcalString(icalString) {</span>
<a href="#l91.45"></a><span id="l91.45" class="difflineminus">-    var todo = Cc[&quot;@mozilla.org/calendar/todo;1&quot;]</span>
<a href="#l91.46"></a><span id="l91.46" class="difflineplus">+    let todo = Cc[&quot;@mozilla.org/calendar/todo;1&quot;]</span>
<a href="#l91.47"></a><span id="l91.47">                .createInstance(Ci.calITodo);</span>
<a href="#l91.48"></a><span id="l91.48">     todo.icalString = icalString;</span>
<a href="#l91.49"></a><span id="l91.49">     return todo;</span>
<a href="#l91.50"></a><span id="l91.50"> }</span>
<a href="#l91.51"></a><span id="l91.51"> </span>
<a href="#l91.52"></a><span id="l91.52"> function getMemoryCal() {</span>
<a href="#l91.53"></a><span id="l91.53">     return Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l91.54"></a><span id="l91.54">              .createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l91.55"></a><span id="l91.55"> }</span>
<a href="#l91.56"></a><span id="l91.56"> </span>
<a href="#l91.57"></a><span id="l91.57"> function getStorageCal() {</span>
<a href="#l91.58"></a><span id="l91.58">     // Whenever we get the storage calendar we need to request a profile,</span>
<a href="#l91.59"></a><span id="l91.59">     // otherwise the cleanup functions will not run</span>
<a href="#l91.60"></a><span id="l91.60">     do_get_profile();</span>
<a href="#l91.61"></a><span id="l91.61"> </span>
<a href="#l91.62"></a><span id="l91.62">     // create URI</span>
<a href="#l91.63"></a><span id="l91.63" class="difflineminus">-    var db = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l91.64"></a><span id="l91.64" class="difflineplus">+    let db = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l91.65"></a><span id="l91.65">     db.append(&quot;test_storage.sqlite&quot;);</span>
<a href="#l91.66"></a><span id="l91.66" class="difflineminus">-    var uri = Services.io.newFileURI(db);</span>
<a href="#l91.67"></a><span id="l91.67" class="difflineplus">+    let uri = Services.io.newFileURI(db);</span>
<a href="#l91.68"></a><span id="l91.68"> </span>
<a href="#l91.69"></a><span id="l91.69">     // Make sure timezone service is initialized</span>
<a href="#l91.70"></a><span id="l91.70">     Components.classes[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l91.71"></a><span id="l91.71">               .getService(Components.interfaces.calIStartupService)</span>
<a href="#l91.72"></a><span id="l91.72">               .startup(null);</span>
<a href="#l91.73"></a><span id="l91.73"> </span>
<a href="#l91.74"></a><span id="l91.74">     // create storage calendar</span>
<a href="#l91.75"></a><span id="l91.75" class="difflineminus">-    var stor = Cc[&quot;@mozilla.org/calendar/calendar;1?type=storage&quot;]</span>
<a href="#l91.76"></a><span id="l91.76" class="difflineplus">+    let stor = Cc[&quot;@mozilla.org/calendar/calendar;1?type=storage&quot;]</span>
<a href="#l91.77"></a><span id="l91.77">               .createInstance(Ci.calISyncWriteCalendar);</span>
<a href="#l91.78"></a><span id="l91.78">     stor.uri = uri;</span>
<a href="#l91.79"></a><span id="l91.79">     stor.id = cal.getUUID();</span>
<a href="#l91.80"></a><span id="l91.80">     return stor;</span>
<a href="#l91.81"></a><span id="l91.81"> }</span>
<a href="#l91.82"></a><span id="l91.82"> </span>
<a href="#l91.83"></a><span id="l91.83"> /**</span>
<a href="#l91.84"></a><span id="l91.84">  * Return an item property as string.</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineat">@@ -98,17 +98,17 @@ function getStorageCal() {</span>
<a href="#l91.86"></a><span id="l91.86">  * @param string aProp possible item properties: start, end, duration,</span>
<a href="#l91.87"></a><span id="l91.87">  *                     generation, title,</span>
<a href="#l91.88"></a><span id="l91.88">  *                     id, calendar, creationDate, lastModifiedTime,</span>
<a href="#l91.89"></a><span id="l91.89">  *                     stampTime, priority, privacy, status,</span>
<a href="#l91.90"></a><span id="l91.90">  *                     alarmLastAck, recurrenceStartDate</span>
<a href="#l91.91"></a><span id="l91.91">  *                     and any property that can be obtained using getProperty()</span>
<a href="#l91.92"></a><span id="l91.92">  */</span>
<a href="#l91.93"></a><span id="l91.93"> function getProps(aItem, aProp) {</span>
<a href="#l91.94"></a><span id="l91.94" class="difflineminus">-    var value = null;</span>
<a href="#l91.95"></a><span id="l91.95" class="difflineplus">+    let value = null;</span>
<a href="#l91.96"></a><span id="l91.96">     switch (aProp) {</span>
<a href="#l91.97"></a><span id="l91.97">         case &quot;start&quot;:</span>
<a href="#l91.98"></a><span id="l91.98">             value = aItem.startDate || aItem.entryDate || null;</span>
<a href="#l91.99"></a><span id="l91.99">             break;</span>
<a href="#l91.100"></a><span id="l91.100">         case &quot;end&quot;:</span>
<a href="#l91.101"></a><span id="l91.101">             value = aItem.endDate || aItem.dueDate || null;</span>
<a href="#l91.102"></a><span id="l91.102">             break;</span>
<a href="#l91.103"></a><span id="l91.103">         case &quot;duration&quot;:</span>
<a href="#l91.104"></a><span id="l91.104" class="difflineat">@@ -164,17 +164,17 @@ function compareItemsSpecific(aLeftItem,</span>
<a href="#l91.105"></a><span id="l91.105">     if (!aPropArray) {</span>
<a href="#l91.106"></a><span id="l91.106">         // left out:  &quot;id&quot;, &quot;calendar&quot;, &quot;lastModifiedTime&quot;, &quot;generation&quot;,</span>
<a href="#l91.107"></a><span id="l91.107">         // &quot;stampTime&quot; as these are expected to change</span>
<a href="#l91.108"></a><span id="l91.108">         aPropArray = [&quot;start&quot;, &quot;end&quot;, &quot;duration&quot;,</span>
<a href="#l91.109"></a><span id="l91.109">                       &quot;title&quot;, &quot;priority&quot;, &quot;privacy&quot;, &quot;creationDate&quot;,</span>
<a href="#l91.110"></a><span id="l91.110">                       &quot;status&quot;, &quot;alarmLastAck&quot;,</span>
<a href="#l91.111"></a><span id="l91.111">                       &quot;recurrenceStartDate&quot;];</span>
<a href="#l91.112"></a><span id="l91.112">     }</span>
<a href="#l91.113"></a><span id="l91.113" class="difflineminus">-    for (var i = 0; i &lt; aPropArray.length; i++) {</span>
<a href="#l91.114"></a><span id="l91.114" class="difflineplus">+    for (let i = 0; i &lt; aPropArray.length; i++) {</span>
<a href="#l91.115"></a><span id="l91.115">         equal(getProps(aLeftItem, aPropArray[i]),</span>
<a href="#l91.116"></a><span id="l91.116">               getProps(aRightItem, aPropArray[i]),</span>
<a href="#l91.117"></a><span id="l91.117">               Components.stack.caller);</span>
<a href="#l91.118"></a><span id="l91.118">     }</span>
<a href="#l91.119"></a><span id="l91.119"> }</span>
<a href="#l91.120"></a><span id="l91.120"> </span>
<a href="#l91.121"></a><span id="l91.121"> </span>
<a href="#l91.122"></a><span id="l91.122"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/calendar/test/unit/test_attendee.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/calendar/test/unit/test_attendee.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -45,31 +45,31 @@ function test_values() {</span>
<a href="#l92.4"></a><span id="l92.4"> </span>
<a href="#l92.5"></a><span id="l92.5">             equal(a[properties[i]], old);</span>
<a href="#l92.6"></a><span id="l92.6">         }</span>
<a href="#l92.7"></a><span id="l92.7">     }</span>
<a href="#l92.8"></a><span id="l92.8"> </span>
<a href="#l92.9"></a><span id="l92.9">     const cIA = Components.interfaces.calIAttendee;</span>
<a href="#l92.10"></a><span id="l92.10"> </span>
<a href="#l92.11"></a><span id="l92.11">     // Create Attendee</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-    var a1 = cal.createAttendee();</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+    let a1 = cal.createAttendee();</span>
<a href="#l92.14"></a><span id="l92.14">     // Testing attendee set/get.</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineminus">-    var properties = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;,</span>
<a href="#l92.16"></a><span id="l92.16" class="difflineplus">+    let properties = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;,</span>
<a href="#l92.17"></a><span id="l92.17">                       &quot;userType&quot;];</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineminus">-    var values = [&quot;myid&quot;, &quot;mycn&quot;, &quot;TRUE&quot;, &quot;CHAIR&quot;, &quot;DECLINED&quot;, &quot;RESOURCE&quot;];</span>
<a href="#l92.19"></a><span id="l92.19" class="difflineplus">+    let values = [&quot;myid&quot;, &quot;mycn&quot;, &quot;TRUE&quot;, &quot;CHAIR&quot;, &quot;DECLINED&quot;, &quot;RESOURCE&quot;];</span>
<a href="#l92.20"></a><span id="l92.20">     // Make sure test is valid</span>
<a href="#l92.21"></a><span id="l92.21">     equal(properties.length, values.length);</span>
<a href="#l92.22"></a><span id="l92.22"> </span>
<a href="#l92.23"></a><span id="l92.23">     for (let i = 0; i &lt; properties.length; i++) {</span>
<a href="#l92.24"></a><span id="l92.24">         a1[properties[i]] = values[i];</span>
<a href="#l92.25"></a><span id="l92.25">         equal(a1[properties[i]], values[i]);</span>
<a href="#l92.26"></a><span id="l92.26">     }</span>
<a href="#l92.27"></a><span id="l92.27"> </span>
<a href="#l92.28"></a><span id="l92.28">     // Create event</span>
<a href="#l92.29"></a><span id="l92.29" class="difflineminus">-    var event = cal.createEvent();</span>
<a href="#l92.30"></a><span id="l92.30" class="difflineplus">+    let event = cal.createEvent();</span>
<a href="#l92.31"></a><span id="l92.31"> </span>
<a href="#l92.32"></a><span id="l92.32">     // Add attendee to event</span>
<a href="#l92.33"></a><span id="l92.33">     event.addAttendee(a1);</span>
<a href="#l92.34"></a><span id="l92.34"> </span>
<a href="#l92.35"></a><span id="l92.35">     // Add 2nd attendee to event.</span>
<a href="#l92.36"></a><span id="l92.36">     let a2 = cal.createAttendee();</span>
<a href="#l92.37"></a><span id="l92.37">     a2.id = &quot;myid2&quot;;</span>
<a href="#l92.38"></a><span id="l92.38">     event.addAttendee(a2);</span>
<a href="#l92.39"></a><span id="l92.39" class="difflineat">@@ -83,19 +83,19 @@ function test_values() {</span>
<a href="#l92.40"></a><span id="l92.40">     // Making attendee immutable</span>
<a href="#l92.41"></a><span id="l92.41">     a1.makeImmutable();</span>
<a href="#l92.42"></a><span id="l92.42">     testImmutability(a1, properties);</span>
<a href="#l92.43"></a><span id="l92.43">     // Testing cascaded immutability (event -&gt; attendee)</span>
<a href="#l92.44"></a><span id="l92.44">     event.makeImmutable();</span>
<a href="#l92.45"></a><span id="l92.45">     testImmutability(a2, properties);</span>
<a href="#l92.46"></a><span id="l92.46"> </span>
<a href="#l92.47"></a><span id="l92.47">     // Testing cloning</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineminus">-    var ec = event.clone();</span>
<a href="#l92.49"></a><span id="l92.49" class="difflineminus">-    var clonedatts = ec.getAttendees({});</span>
<a href="#l92.50"></a><span id="l92.50" class="difflineminus">-    var atts = event.getAttendees({});</span>
<a href="#l92.51"></a><span id="l92.51" class="difflineplus">+    let ec = event.clone();</span>
<a href="#l92.52"></a><span id="l92.52" class="difflineplus">+    let clonedatts = ec.getAttendees({});</span>
<a href="#l92.53"></a><span id="l92.53" class="difflineplus">+    let atts = event.getAttendees({});</span>
<a href="#l92.54"></a><span id="l92.54">     equal(atts.length, clonedatts.length);</span>
<a href="#l92.55"></a><span id="l92.55"> </span>
<a href="#l92.56"></a><span id="l92.56">     for (let i = 0; i &lt; clonedatts.length; i++) {</span>
<a href="#l92.57"></a><span id="l92.57">         // The attributes should not be equal</span>
<a href="#l92.58"></a><span id="l92.58">         notEqual(atts[i], clonedatts[i]);</span>
<a href="#l92.59"></a><span id="l92.59">         // But the ids should</span>
<a href="#l92.60"></a><span id="l92.60">         equal(atts[i].id, clonedatts[i].id);</span>
<a href="#l92.61"></a><span id="l92.61">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -7,31 +7,31 @@ function run_test() {</span>
<a href="#l93.4"></a><span id="l93.4"> }</span>
<a href="#l93.5"></a><span id="l93.5"> </span>
<a href="#l93.6"></a><span id="l93.6"> function really_run_test() {</span>
<a href="#l93.7"></a><span id="l93.7">     test_freebusy();</span>
<a href="#l93.8"></a><span id="l93.8">     test_period();</span>
<a href="#l93.9"></a><span id="l93.9"> }</span>
<a href="#l93.10"></a><span id="l93.10"> </span>
<a href="#l93.11"></a><span id="l93.11"> function test_freebusy() {</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-    var icsService = Components.classes[&quot;@mozilla.org/calendar/ics-service;1&quot;]</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+    let icsService = Components.classes[&quot;@mozilla.org/calendar/ics-service;1&quot;]</span>
<a href="#l93.14"></a><span id="l93.14">                                .getService(Components.interfaces.calIICSService);</span>
<a href="#l93.15"></a><span id="l93.15"> </span>
<a href="#l93.16"></a><span id="l93.16">     // Bug 415987 - FREEBUSY decoding does not support comma-separated entries</span>
<a href="#l93.17"></a><span id="l93.17">     // (https://bugzilla.mozilla.org/show_bug.cgi?id=415987)</span>
<a href="#l93.18"></a><span id="l93.18" class="difflineminus">-    var fbVal1 = &quot;20080206T160000Z/PT1H&quot;;</span>
<a href="#l93.19"></a><span id="l93.19" class="difflineminus">-    var fbVal2 = &quot;20080206T180000Z/PT1H&quot;;</span>
<a href="#l93.20"></a><span id="l93.20" class="difflineminus">-    var fbVal3 = &quot;20080206T220000Z/PT1H&quot;;</span>
<a href="#l93.21"></a><span id="l93.21" class="difflineminus">-    var data =</span>
<a href="#l93.22"></a><span id="l93.22" class="difflineplus">+    let fbVal1 = &quot;20080206T160000Z/PT1H&quot;;</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineplus">+    let fbVal2 = &quot;20080206T180000Z/PT1H&quot;;</span>
<a href="#l93.24"></a><span id="l93.24" class="difflineplus">+    let fbVal3 = &quot;20080206T220000Z/PT1H&quot;;</span>
<a href="#l93.25"></a><span id="l93.25" class="difflineplus">+    let data =</span>
<a href="#l93.26"></a><span id="l93.26">         &quot;BEGIN:VCALENDAR\n&quot; +</span>
<a href="#l93.27"></a><span id="l93.27">         &quot;BEGIN:VFREEBUSY\n&quot; +</span>
<a href="#l93.28"></a><span id="l93.28">         &quot;FREEBUSY;FBTYPE=BUSY:&quot; + fbVal1 + &quot;,&quot; + fbVal2 + &quot;,&quot; + fbVal3 + &quot;\n&quot; +</span>
<a href="#l93.29"></a><span id="l93.29">         &quot;END:VFREEBUSY\n&quot; +</span>
<a href="#l93.30"></a><span id="l93.30">         &quot;END:VCALENDAR\n&quot;;</span>
<a href="#l93.31"></a><span id="l93.31" class="difflineminus">-    var fbComp = icsService.parseICS(data, null).getFirstSubcomponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l93.32"></a><span id="l93.32" class="difflineplus">+    let fbComp = icsService.parseICS(data, null).getFirstSubcomponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l93.33"></a><span id="l93.33">     equal(fbComp.getFirstProperty(&quot;FREEBUSY&quot;).value, fbVal1);</span>
<a href="#l93.34"></a><span id="l93.34">     equal(fbComp.getNextProperty(&quot;FREEBUSY&quot;).value, fbVal2);</span>
<a href="#l93.35"></a><span id="l93.35">     equal(fbComp.getNextProperty(&quot;FREEBUSY&quot;).value, fbVal3);</span>
<a href="#l93.36"></a><span id="l93.36"> }</span>
<a href="#l93.37"></a><span id="l93.37"> </span>
<a href="#l93.38"></a><span id="l93.38"> function test_period() {</span>
<a href="#l93.39"></a><span id="l93.39">     let period = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l93.40"></a><span id="l93.40">                            .createInstance(Components.interfaces.calIPeriod);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/calendar/test/unit/test_ics.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/calendar/test/unit/test_ics.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -111,17 +111,17 @@ function test_roundtrip() {</span>
<a href="#l94.4"></a><span id="l94.4">         if (&quot;expectedDateProps&quot; in data) {</span>
<a href="#l94.5"></a><span id="l94.5">             checkProps(data.expectedDateProps, event.startDate);</span>
<a href="#l94.6"></a><span id="l94.6">             checkProps(data.expectedDateProps, event.endDate);</span>
<a href="#l94.7"></a><span id="l94.7">         }</span>
<a href="#l94.8"></a><span id="l94.8">     }</span>
<a href="#l94.9"></a><span id="l94.9"> </span>
<a href="#l94.10"></a><span id="l94.10">     let icssrv = cal.getIcsService();</span>
<a href="#l94.11"></a><span id="l94.11"> </span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-    for (var data of test_data) {</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+    for (let data of test_data) {</span>
<a href="#l94.14"></a><span id="l94.14">         // First round, use the icalString setter which uses synchronous parsing</span>
<a href="#l94.15"></a><span id="l94.15">         dump(&quot;Checking&quot; + data.ics + &quot;\n&quot;);</span>
<a href="#l94.16"></a><span id="l94.16">         let event = createEventFromIcalString(data.ics);</span>
<a href="#l94.17"></a><span id="l94.17">         checkEvent(data, event);</span>
<a href="#l94.18"></a><span id="l94.18"> </span>
<a href="#l94.19"></a><span id="l94.19">         // Now, try the same thing with asynchronous parsing. We need a copy of</span>
<a href="#l94.20"></a><span id="l94.20">         // the data variable, otherwise javascript will mix the data between</span>
<a href="#l94.21"></a><span id="l94.21">         // foreach loop iterations.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/calendar/test/unit/test_providers.js</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/calendar/test/unit/test_providers.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -190,17 +190,17 @@ var icalStringArray = [</span>
<a href="#l95.4"></a><span id="l95.4">                 &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l95.5"></a><span id="l95.5">                 &quot;DTSTART:20020403T000000Z\n&quot; +</span>
<a href="#l95.6"></a><span id="l95.6">                 &quot;DURATION:P1D\n&quot; +</span>
<a href="#l95.7"></a><span id="l95.7">                 &quot;END:VEVENT\n&quot;</span>
<a href="#l95.8"></a><span id="l95.8">                 ];</span>
<a href="#l95.9"></a><span id="l95.9"> </span>
<a href="#l95.10"></a><span id="l95.10"> function run_test() {</span>
<a href="#l95.11"></a><span id="l95.11">     // First entry is test number, second item is expected result for testGetItems().</span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-    var wantedArray = [[ 1, 1],</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineplus">+    let wantedArray = [[ 1, 1],</span>
<a href="#l95.14"></a><span id="l95.14">                        [ 2, 1],</span>
<a href="#l95.15"></a><span id="l95.15">                        [ 3, 1],</span>
<a href="#l95.16"></a><span id="l95.16">                        [ 5, 0],</span>
<a href="#l95.17"></a><span id="l95.17">                        [ 6, 1],</span>
<a href="#l95.18"></a><span id="l95.18">                        [ 7, 1],</span>
<a href="#l95.19"></a><span id="l95.19">                        [ 8, 0],</span>
<a href="#l95.20"></a><span id="l95.20">                        [ 9, 1],</span>
<a href="#l95.21"></a><span id="l95.21">                        [ 10, 0],</span>
<a href="#l95.22"></a><span id="l95.22" class="difflineat">@@ -258,28 +258,28 @@ function run_test() {</span>
<a href="#l95.23"></a><span id="l95.23">     function testGetItems(aItem, aResult) {</span>
<a href="#l95.24"></a><span id="l95.24">         for (let calendar of [getStorageCal(), getMemoryCal()]) {</span>
<a href="#l95.25"></a><span id="l95.25">             checkCalendar(calendar, aItem, aResult);</span>
<a href="#l95.26"></a><span id="l95.26">         }</span>
<a href="#l95.27"></a><span id="l95.27">     }</span>
<a href="#l95.28"></a><span id="l95.28"> </span>
<a href="#l95.29"></a><span id="l95.29">     function checkCalendar(calendar, aItem, aResult) {</span>
<a href="#l95.30"></a><span id="l95.30">         // construct range</span>
<a href="#l95.31"></a><span id="l95.31" class="difflineminus">-        var rangeStart = createDate(2002, 3, 2); // 3 = April</span>
<a href="#l95.32"></a><span id="l95.32" class="difflineminus">-        var rangeEnd = rangeStart.clone();</span>
<a href="#l95.33"></a><span id="l95.33" class="difflineplus">+        let rangeStart = createDate(2002, 3, 2); // 3 = April</span>
<a href="#l95.34"></a><span id="l95.34" class="difflineplus">+        let rangeEnd = rangeStart.clone();</span>
<a href="#l95.35"></a><span id="l95.35">         rangeEnd.day += 1;</span>
<a href="#l95.36"></a><span id="l95.36"> </span>
<a href="#l95.37"></a><span id="l95.37">         // filter options</span>
<a href="#l95.38"></a><span id="l95.38" class="difflineminus">-        var filter = Ci.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l95.39"></a><span id="l95.39" class="difflineplus">+        let filter = Ci.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l95.40"></a><span id="l95.40">                      Ci.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l95.41"></a><span id="l95.41">                      Ci.calICalendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l95.42"></a><span id="l95.42"> </span>
<a href="#l95.43"></a><span id="l95.43">         // implement listener</span>
<a href="#l95.44"></a><span id="l95.44" class="difflineminus">-        var count = 0;</span>
<a href="#l95.45"></a><span id="l95.45" class="difflineminus">-        var listener = {</span>
<a href="#l95.46"></a><span id="l95.46" class="difflineplus">+        let count = 0;</span>
<a href="#l95.47"></a><span id="l95.47" class="difflineplus">+        let listener = {</span>
<a href="#l95.48"></a><span id="l95.48">             onOperationComplete: function(aCalendar,</span>
<a href="#l95.49"></a><span id="l95.49">                                           aStatus,</span>
<a href="#l95.50"></a><span id="l95.50">                                           aOperationType,</span>
<a href="#l95.51"></a><span id="l95.51">                                           aId,</span>
<a href="#l95.52"></a><span id="l95.52">                                           aDetail) {</span>
<a href="#l95.53"></a><span id="l95.53">                 equal(aStatus, 0);</span>
<a href="#l95.54"></a><span id="l95.54">                 if (aOperationType == Ci.calIOperationListener.ADD) {</span>
<a href="#l95.55"></a><span id="l95.55">                     // perform getItems() on calendar</span>
<a href="#l95.56"></a><span id="l95.56" class="difflineat">@@ -292,17 +292,17 @@ function run_test() {</span>
<a href="#l95.57"></a><span id="l95.57">             onGetResult: function(aCalendar,</span>
<a href="#l95.58"></a><span id="l95.58">                                   aStatus,</span>
<a href="#l95.59"></a><span id="l95.59">                                   aItemType,</span>
<a href="#l95.60"></a><span id="l95.60">                                   aDetail,</span>
<a href="#l95.61"></a><span id="l95.61">                                   aCount,</span>
<a href="#l95.62"></a><span id="l95.62">                                   aItems) {</span>
<a href="#l95.63"></a><span id="l95.63">                 if (aCount) {</span>
<a href="#l95.64"></a><span id="l95.64">                     count += aCount;</span>
<a href="#l95.65"></a><span id="l95.65" class="difflineminus">-                    for (var i = 0; i &lt; aCount; i++) {</span>
<a href="#l95.66"></a><span id="l95.66" class="difflineplus">+                    for (let i = 0; i &lt; aCount; i++) {</span>
<a href="#l95.67"></a><span id="l95.67">                         compareItemsSpecific(aItems[i].parentItem, aItem);</span>
<a href="#l95.68"></a><span id="l95.68">                     }</span>
<a href="#l95.69"></a><span id="l95.69">                 }</span>
<a href="#l95.70"></a><span id="l95.70">             }</span>
<a href="#l95.71"></a><span id="l95.71">         };</span>
<a href="#l95.72"></a><span id="l95.72"> </span>
<a href="#l95.73"></a><span id="l95.73">         // add item to calendar</span>
<a href="#l95.74"></a><span id="l95.74">         do_test_pending();</span>
<a href="#l95.75"></a><span id="l95.75" class="difflineat">@@ -312,24 +312,24 @@ function run_test() {</span>
<a href="#l95.76"></a><span id="l95.76">    /**</span>
<a href="#l95.77"></a><span id="l95.77">     * (1) Add aItem to a calendar.</span>
<a href="#l95.78"></a><span id="l95.78">     * The properties of the added item are compared with the passed item.</span>
<a href="#l95.79"></a><span id="l95.79">     * (2) Perform a getItem() call.</span>
<a href="#l95.80"></a><span id="l95.80">     * The properties of the returned item are compared with the passed item.</span>
<a href="#l95.81"></a><span id="l95.81">     */</span>
<a href="#l95.82"></a><span id="l95.82">     function testGetItem(aItem) {</span>
<a href="#l95.83"></a><span id="l95.83">         // get calendars</span>
<a href="#l95.84"></a><span id="l95.84" class="difflineminus">-        var calArray = [];</span>
<a href="#l95.85"></a><span id="l95.85" class="difflineplus">+        let calArray = [];</span>
<a href="#l95.86"></a><span id="l95.86">         calArray.push(getStorageCal());</span>
<a href="#l95.87"></a><span id="l95.87">         calArray.push(getMemoryCal());</span>
<a href="#l95.88"></a><span id="l95.88">         for (let calendar of calArray) {</span>
<a href="#l95.89"></a><span id="l95.89">             // implement listener</span>
<a href="#l95.90"></a><span id="l95.90" class="difflineminus">-            var count = 0;</span>
<a href="#l95.91"></a><span id="l95.91" class="difflineminus">-            var returnedItem = null;</span>
<a href="#l95.92"></a><span id="l95.92" class="difflineminus">-            var listener = {</span>
<a href="#l95.93"></a><span id="l95.93" class="difflineplus">+            let count = 0;</span>
<a href="#l95.94"></a><span id="l95.94" class="difflineplus">+            let returnedItem = null;</span>
<a href="#l95.95"></a><span id="l95.95" class="difflineplus">+            let listener = {</span>
<a href="#l95.96"></a><span id="l95.96">                 onOperationComplete: function(aCalendar,</span>
<a href="#l95.97"></a><span id="l95.97">                                               aStatus,</span>
<a href="#l95.98"></a><span id="l95.98">                                               aOperationType,</span>
<a href="#l95.99"></a><span id="l95.99">                                               aId,</span>
<a href="#l95.100"></a><span id="l95.100">                                               aDetail) {</span>
<a href="#l95.101"></a><span id="l95.101">                     equal(aStatus, 0);</span>
<a href="#l95.102"></a><span id="l95.102">                     if (aOperationType == Ci.calIOperationListener.ADD) {</span>
<a href="#l95.103"></a><span id="l95.103">                         compareItemsSpecific(aDetail, aItem);</span>
<a href="#l95.104"></a><span id="l95.104" class="difflineat">@@ -358,38 +358,38 @@ function run_test() {</span>
<a href="#l95.105"></a><span id="l95.105">     }</span>
<a href="#l95.106"></a><span id="l95.106"> </span>
<a href="#l95.107"></a><span id="l95.107">     testMetaData();</span>
<a href="#l95.108"></a><span id="l95.108"> }</span>
<a href="#l95.109"></a><span id="l95.109"> </span>
<a href="#l95.110"></a><span id="l95.110"> function testMetaData() {</span>
<a href="#l95.111"></a><span id="l95.111">     function testMetaData_(aCalendar) {</span>
<a href="#l95.112"></a><span id="l95.112">         dump(&quot;testMetaData_() calendar type: &quot; + aCalendar.type + &quot;\n&quot;);</span>
<a href="#l95.113"></a><span id="l95.113" class="difflineminus">-        var event1 = createEventFromIcalString(&quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l95.114"></a><span id="l95.114" class="difflineplus">+        let event1 = createEventFromIcalString(&quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l95.115"></a><span id="l95.115">                                                &quot;DTSTART;VALUE=DATE:20020402\n&quot; +</span>
<a href="#l95.116"></a><span id="l95.116">                                                &quot;END:VEVENT\n&quot;);</span>
<a href="#l95.117"></a><span id="l95.117"> </span>
<a href="#l95.118"></a><span id="l95.118">         event1.id = &quot;item1&quot;;</span>
<a href="#l95.119"></a><span id="l95.119">         aCalendar.addItem(event1, null);</span>
<a href="#l95.120"></a><span id="l95.120">         aCalendar.setMetaData(&quot;item1&quot;, &quot;meta1&quot;);</span>
<a href="#l95.121"></a><span id="l95.121">         equal(aCalendar.getMetaData(&quot;item1&quot;), &quot;meta1&quot;);</span>
<a href="#l95.122"></a><span id="l95.122">         equal(aCalendar.getMetaData(&quot;unknown&quot;), null);</span>
<a href="#l95.123"></a><span id="l95.123"> </span>
<a href="#l95.124"></a><span id="l95.124" class="difflineminus">-        var event2 = event1.clone();</span>
<a href="#l95.125"></a><span id="l95.125" class="difflineplus">+        let event2 = event1.clone();</span>
<a href="#l95.126"></a><span id="l95.126">         event2.id = &quot;item2&quot;;</span>
<a href="#l95.127"></a><span id="l95.127">         aCalendar.addItem(event2, null);</span>
<a href="#l95.128"></a><span id="l95.128">         aCalendar.setMetaData(&quot;item2&quot;, &quot;meta2-&quot;);</span>
<a href="#l95.129"></a><span id="l95.129">         equal(aCalendar.getMetaData(&quot;item2&quot;), &quot;meta2-&quot;);</span>
<a href="#l95.130"></a><span id="l95.130"> </span>
<a href="#l95.131"></a><span id="l95.131">         aCalendar.setMetaData(&quot;item2&quot;, &quot;meta2&quot;);</span>
<a href="#l95.132"></a><span id="l95.132">         equal(aCalendar.getMetaData(&quot;item2&quot;), &quot;meta2&quot;);</span>
<a href="#l95.133"></a><span id="l95.133"> </span>
<a href="#l95.134"></a><span id="l95.134" class="difflineminus">-        var count = {};</span>
<a href="#l95.135"></a><span id="l95.135" class="difflineminus">-        var ids = {};</span>
<a href="#l95.136"></a><span id="l95.136" class="difflineminus">-        var values = {};</span>
<a href="#l95.137"></a><span id="l95.137" class="difflineplus">+        let count = {};</span>
<a href="#l95.138"></a><span id="l95.138" class="difflineplus">+        let ids = {};</span>
<a href="#l95.139"></a><span id="l95.139" class="difflineplus">+        let values = {};</span>
<a href="#l95.140"></a><span id="l95.140">         aCalendar.getAllMetaData(count, ids, values);</span>
<a href="#l95.141"></a><span id="l95.141">         equal(count.value, 2);</span>
<a href="#l95.142"></a><span id="l95.142">         ok(ids.value[0] == &quot;item1&quot; || ids.value[1] == &quot;item1&quot;);</span>
<a href="#l95.143"></a><span id="l95.143">         ok(ids.value[0] == &quot;item2&quot; || ids.value[1] == &quot;item2&quot;);</span>
<a href="#l95.144"></a><span id="l95.144">         ok(values.value[0] == &quot;meta1&quot; || values.value[1] == &quot;meta1&quot;);</span>
<a href="#l95.145"></a><span id="l95.145">         ok(values.value[0] == &quot;meta2&quot; || values.value[1] == &quot;meta2&quot;);</span>
<a href="#l95.146"></a><span id="l95.146"> </span>
<a href="#l95.147"></a><span id="l95.147">         aCalendar.deleteItem(event1, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -808,17 +808,17 @@ function test_immutable() {</span>
<a href="#l96.4"></a><span id="l96.4">     throws(() =&gt; rinfo2.appendRecurrenceItem(ritem), /Can not modify immutable data container/);</span>
<a href="#l96.5"></a><span id="l96.5">     ok(!rinfo2.isMutable);</span>
<a href="#l96.6"></a><span id="l96.6"> </span>
<a href="#l96.7"></a><span id="l96.7">     let ritem = cal.createRecurrenceDate();</span>
<a href="#l96.8"></a><span id="l96.8">     rinfo.appenRecurrenceItem(ritem);</span>
<a href="#l96.9"></a><span id="l96.9"> }</span>
<a href="#l96.10"></a><span id="l96.10"> </span>
<a href="#l96.11"></a><span id="l96.11"> function test_rrule_icalstring() {</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-    var recRule = createRecurrenceRule();</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+    let recRule = createRecurrenceRule();</span>
<a href="#l96.14"></a><span id="l96.14">     recRule.type = &quot;DAILY&quot;;</span>
<a href="#l96.15"></a><span id="l96.15">     recRule.interval = 4;</span>
<a href="#l96.16"></a><span id="l96.16">     equal(recRule.icalString, &quot;RRULE:FREQ=DAILY;INTERVAL=4\r\n&quot;);</span>
<a href="#l96.17"></a><span id="l96.17"> </span>
<a href="#l96.18"></a><span id="l96.18">     recRule = createRecurrenceRule();</span>
<a href="#l96.19"></a><span id="l96.19">     recRule.type = &quot;DAILY&quot;;</span>
<a href="#l96.20"></a><span id="l96.20">     recRule.setComponent(&quot;BYDAY&quot;, 5, [2, 3, 4, 5, 6]);</span>
<a href="#l96.21"></a><span id="l96.21">     equal(recRule.icalString, &quot;RRULE:FREQ=DAILY;BYDAY=MO,TU,WE,TH,FR\r\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/calendar/test/unit/test_timezone.js</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/calendar/test/unit/test_timezone.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -8,19 +8,19 @@ function run_test() {</span>
<a href="#l97.4"></a><span id="l97.4">         onResult: function() {</span>
<a href="#l97.5"></a><span id="l97.5">             really_run_test();</span>
<a href="#l97.6"></a><span id="l97.6">             do_test_finished();</span>
<a href="#l97.7"></a><span id="l97.7">         }</span>
<a href="#l97.8"></a><span id="l97.8">     });</span>
<a href="#l97.9"></a><span id="l97.9"> }</span>
<a href="#l97.10"></a><span id="l97.10"> </span>
<a href="#l97.11"></a><span id="l97.11"> function really_run_test() {</span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-    var f = cal.createEvent();</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+    let f = cal.createEvent();</span>
<a href="#l97.14"></a><span id="l97.14"> </span>
<a href="#l97.15"></a><span id="l97.15" class="difflineminus">-    var str =</span>
<a href="#l97.16"></a><span id="l97.16" class="difflineplus">+    let str =</span>
<a href="#l97.17"></a><span id="l97.17">          [&quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l97.18"></a><span id="l97.18">           &quot;PRODID:-//RDU Software//NONSGML HandCal//EN&quot;,</span>
<a href="#l97.19"></a><span id="l97.19">           &quot;VERSION:2.0&quot;,</span>
<a href="#l97.20"></a><span id="l97.20">           &quot;BEGIN:VTIMEZONE&quot;,</span>
<a href="#l97.21"></a><span id="l97.21">           &quot;TZID:America/New_York&quot;,</span>
<a href="#l97.22"></a><span id="l97.22">           &quot;BEGIN:STANDARD&quot;,</span>
<a href="#l97.23"></a><span id="l97.23">           &quot;DTSTART:19981025T020000&quot;,</span>
<a href="#l97.24"></a><span id="l97.24">           &quot;TZOFFSETFROM:-0400&quot;,</span>
<a href="#l97.25"></a><span id="l97.25" class="difflineat">@@ -47,17 +47,17 @@ function really_run_test() {</span>
<a href="#l97.26"></a><span id="l97.26">           &quot;SUMMARY:XYZ Project Review&quot;,</span>
<a href="#l97.27"></a><span id="l97.27">           &quot;DTSTART;TZID=America/New_York:19980312T083000&quot;,</span>
<a href="#l97.28"></a><span id="l97.28">           &quot;DTEND;TZID=America/New_York:19980312T093000&quot;,</span>
<a href="#l97.29"></a><span id="l97.29">           &quot;LOCATION:1CP Conference Room 4350&quot;,</span>
<a href="#l97.30"></a><span id="l97.30">           &quot;END:VEVENT&quot;,</span>
<a href="#l97.31"></a><span id="l97.31">           &quot;END:VCALENDAR&quot;,</span>
<a href="#l97.32"></a><span id="l97.32">           &quot;&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l97.33"></a><span id="l97.33"> </span>
<a href="#l97.34"></a><span id="l97.34" class="difflineminus">-    var strTz =</span>
<a href="#l97.35"></a><span id="l97.35" class="difflineplus">+    let strTz =</span>
<a href="#l97.36"></a><span id="l97.36">          [&quot;BEGIN:VTIMEZONE&quot;,</span>
<a href="#l97.37"></a><span id="l97.37">           &quot;TZID:America/New_York&quot;,</span>
<a href="#l97.38"></a><span id="l97.38">           &quot;BEGIN:STANDARD&quot;,</span>
<a href="#l97.39"></a><span id="l97.39">           &quot;DTSTART:19981025T020000&quot;,</span>
<a href="#l97.40"></a><span id="l97.40">           &quot;TZOFFSETFROM:-0400&quot;,</span>
<a href="#l97.41"></a><span id="l97.41">           &quot;TZOFFSETTO:-0500&quot;,</span>
<a href="#l97.42"></a><span id="l97.42">           &quot;TZNAME:EST&quot;,</span>
<a href="#l97.43"></a><span id="l97.43">           &quot;END:STANDARD&quot;,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

