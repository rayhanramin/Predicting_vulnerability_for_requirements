<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10435:13e86c34c73f425dd01c4004cb89b286abf1fd91</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 13e86c34c73f425dd01c4004cb89b286abf1fd91" />
<meta property="og:url" content="/comm-central/rev/13e86c34c73f425dd01c4004cb89b286abf1fd91" />
<meta property="og:description" content="Bug 763471 - Remove Dropbox nsIMsgCloudFileProvider and related files from comm-central. r=bienvenu." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 13e86c34c73f425dd01c4004cb89b286abf1fd91 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/13e86c34c73f425dd01c4004cb89b286abf1fd91">shortlog</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/13e86c34c73f425dd01c4004cb89b286abf1fd91">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91">files</a> |
changeset |
<a href="/comm-central/raw-rev/13e86c34c73f425dd01c4004cb89b286abf1fd91">raw</a>  | <a href="/comm-central/archive/13e86c34c73f425dd01c4004cb89b286abf1fd91.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763471">Bug 763471</a> - Remove Dropbox nsIMsgCloudFileProvider and related files from comm-central. r=bienvenu.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 14 Jun 2012 13:12:15 -0400</td></tr>

<tr>
 <td>changeset 10435</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/13e86c34c73f425dd01c4004cb89b286abf1fd91">13e86c34c73f425dd01c4004cb89b286abf1fd91</a></td>
</tr>



<tr>
<td>parent 10434</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6be9b667699d746994edaa4f7768dd716cf384b5">6be9b667699d746994edaa4f7768dd716cf384b5</a>
</td>
</tr>

<tr>
<td>child 10436</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/13b5b398738cffefe6c511db8fef272c991103ca">13b5b398738cffefe6c511db8fef272c991103ca</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=13e86c34c73f425dd01c4004cb89b286abf1fd91">7891</a></td></tr>
<tr><td>push user</td><td>mconley@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 14 Jun 2012 17:12:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@13e86c34c73f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=13e86c34c73f425dd01c4004cb89b286abf1fd91">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=13e86c34c73f425dd01c4004cb89b286abf1fd91&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=13e86c34c73f425dd01c4004cb89b286abf1fd91&newProject=comm-central&newRevision=13e86c34c73f425dd01c4004cb89b286abf1fd91&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=13e86c34c73f425dd01c4004cb89b286abf1fd91&newProject=comm-central&newRevision=13e86c34c73f425dd01c4004cb89b286abf1fd91&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=13e86c34c73f425dd01c4004cb89b286abf1fd91&newProject=comm-central&newRevision=13e86c34c73f425dd01c4004cb89b286abf1fd91&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763471">763471</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=763471">Bug 763471</a> - Remove Dropbox nsIMsgCloudFileProvider and related files from comm-central. r=bienvenu.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/Makefile.in">mail/components/cloudfile/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/Makefile.in">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/Makefile.in">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/Makefile.in">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/Makefile.in">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileAccounts.js">mail/components/cloudfile/cloudFileAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileAccounts.js">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileAccounts.js">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileAccounts.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileAccounts.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileComponents.manifest">mail/components/cloudfile/cloudFileComponents.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileComponents.manifest">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileComponents.manifest">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileComponents.manifest">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileComponents.manifest">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/cloudFileComponents.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.js">mail/components/cloudfile/content/Dropbox/management.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.xhtml">mail/components/cloudfile/content/Dropbox/management.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.xhtml">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.xhtml">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/settings.xhtml">mail/components/cloudfile/content/Dropbox/settings.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/settings.xhtml">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/settings.xhtml">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/Dropbox/settings.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.js">mail/components/cloudfile/content/UbuntuOne/management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.js">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.js">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.xhtml">mail/components/cloudfile/content/UbuntuOne/management.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.xhtml">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.xhtml">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.xhtml">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.xhtml">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/content/UbuntuOne/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/jar.mn">mail/components/cloudfile/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/jar.mn">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/jar.mn">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/jar.mn">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/jar.mn">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/nsDropbox.js">mail/components/cloudfile/nsDropbox.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/nsDropbox.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/nsDropbox.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/components/cloudfile/nsDropbox.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/removed-files.in">mail/installer/removed-files.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/removed-files.in">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/removed-files.in">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/removed-files.in">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/removed-files.in">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/installer/removed-files.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/management.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/management.dtd">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/management.dtd">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/settings.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/settings.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/settings.dtd">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/settings.dtd">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/settings.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/jar.mn">mail/themes/gnomestripe/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/jar.mn">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/jar.mn">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/jar.mn">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/jar.mn">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/mail/icons/dropbox.png">mail/themes/gnomestripe/mail/icons/dropbox.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/mail/icons/dropbox.png">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/mail/icons/dropbox.png">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/gnomestripe/mail/icons/dropbox.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/jar.mn">mail/themes/pinstripe/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/jar.mn">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/jar.mn">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/jar.mn">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/jar.mn">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/mail/icons/dropbox.png">mail/themes/pinstripe/mail/icons/dropbox.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/mail/icons/dropbox.png">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/mail/icons/dropbox.png">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/pinstripe/mail/icons/dropbox.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/jar.mn">mail/themes/qute/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/jar.mn">file</a> |
<a href="/comm-central/annotate/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/jar.mn">annotate</a> |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/jar.mn">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/jar.mn">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/mail/icons/dropbox.png">mail/themes/qute/mail/icons/dropbox.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/mail/icons/dropbox.png">diff</a> |
<a href="/comm-central/comparison/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/mail/icons/dropbox.png">comparison</a> |
<a href="/comm-central/log/13e86c34c73f425dd01c4004cb89b286abf1fd91/mail/themes/qute/mail/icons/dropbox.png">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/cloudfile/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/cloudfile/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -8,17 +8,16 @@ srcdir		= @srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> VPATH		= @srcdir@</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> MODULE    = cloudfile</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> EXTRA_COMPONENTS = \</span>
<a href="#l1.11"></a><span id="l1.11">   nsYouSendIt.js \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  nsDropbox.js \</span>
<a href="#l1.13"></a><span id="l1.13">   nsUbuntuOne.js \</span>
<a href="#l1.14"></a><span id="l1.14">   cloudFileComponents.manifest \</span>
<a href="#l1.15"></a><span id="l1.15">   $(NULL)</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> EXTRA_JS_MODULES = \</span>
<a href="#l1.18"></a><span id="l1.18">   cloudFileAccounts.js \</span>
<a href="#l1.19"></a><span id="l1.19">   $(NULL)</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -90,27 +90,34 @@ var cloudFileAccounts = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">     let provider = Cc[className].createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l2.6"></a><span id="l2.6">     return provider;</span>
<a href="#l2.7"></a><span id="l2.7">   },</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   // aExtraPrefs are prefs specific to an account provider.</span>
<a href="#l2.10"></a><span id="l2.10">   createAccount: function(aType, aRequestObserver, aExtraPrefs) {</span>
<a href="#l2.11"></a><span id="l2.11">     let key = this._createUniqueAccountKey();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    Services.prefs</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-            .setCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;, aType);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    if (aExtraPrefs !== undefined)</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      this._processExtraPrefs(key, aExtraPrefs);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    try {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+      Services.prefs</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+              .setCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;, aType);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+      if (aExtraPrefs !== undefined)</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+        this._processExtraPrefs(key, aExtraPrefs);</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    let provider = this._getInitedProviderForType(key, aType);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    if (provider)</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      provider.createExistingAccount(aRequestObserver);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+      let provider = this._getInitedProviderForType(key, aType);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+      if (provider)</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+        provider.createExistingAccount(aRequestObserver);</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    return provider;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+      return provider;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    }</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    catch(e) {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+      Services.prefs.deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+      throw e;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    }</span>
<a href="#l2.38"></a><span id="l2.38">   },</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">   // Set provider-specific prefs</span>
<a href="#l2.41"></a><span id="l2.41">   _processExtraPrefs: function CFA__processExtraPrefs(aAccountKey,</span>
<a href="#l2.42"></a><span id="l2.42">                                                       aExtraPrefs) {</span>
<a href="#l2.43"></a><span id="l2.43">     const kFuncMap = {</span>
<a href="#l2.44"></a><span id="l2.44">       &quot;int&quot;: &quot;setIntPref&quot;,</span>
<a href="#l2.45"></a><span id="l2.45">       &quot;bool&quot;: &quot;setBoolPref&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,11 +1,7 @@</span>
<a href="#l3.4"></a><span id="l3.4"> component {32fd439f-9eb6-4907-ac0b-2c88eb14d98d} nsYouSendIt.js</span>
<a href="#l3.5"></a><span id="l3.5"> contract @mozilla.org/mail/yousendit;1 {32fd439f-9eb6-4907-ac0b-2c88eb14d98d}</span>
<a href="#l3.6"></a><span id="l3.6"> category cloud-files YouSendIt @mozilla.org/mail/yousendit;1</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-component {2fd8a64a-a496-4cf4-9d6b-d3f9800c6322} nsDropbox.js</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-contract @mozilla.org/mail/dropbox;1 {2fd8a64a-a496-4cf4-9d6b-d3f9800c6322}</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-category cloud-files Dropbox @mozilla.org/mail/dropbox;1</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-</span>
<a href="#l3.12"></a><span id="l3.12"> component {9a44742b-a7b1-4f44-919e-6f3b28902c1a} nsUbuntuOne.js</span>
<a href="#l3.13"></a><span id="l3.13"> contract @mozilla.org/mail/ubuntuone;1 {9a44742b-a7b1-4f44-919e-6f3b28902c1a}</span>
<a href="#l3.14"></a><span id="l3.14"> category cloud-files UbuntuOne @mozilla.org/mail/ubuntuone;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mail/components/cloudfile/content/Dropbox/management.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,44 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-function onLoadProvider(provider) {</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-  let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-  let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  remainingFileSpace.textContent = messenger.formatFileSize(</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    provider.remainingFileSpace);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  let totalSpace = provider.fileSpaceUsed + provider.remainingFileSpace;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-  let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-    .width(150)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-    .height(150);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  vis.add(pv.Wedge)</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    .data([provider.fileSpaceUsed, provider.remainingFileSpace])</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    .left(75)</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-    .top(75)</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    .innerRadius(30)</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-    .outerRadius(65)</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    .angle(function(d) d * pieScale);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  vis.add(pv.Label)</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    .left(75)</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    .top(75)</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    .font(&quot;14px Sans-Serif&quot;)</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    .textAlign(&quot;center&quot;)</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-    .textBaseline(&quot;middle&quot;)</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    .text(messenger.formatFileSize(totalSpace));</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-  vis.render();</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/mail/components/cloudfile/content/Dropbox/management.xhtml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,49 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  &lt;!ENTITY % dropboxDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Dropbox/management.dtd&quot;&gt; %dropboxDTD;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-]&gt;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-            src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-    &lt;script type=&quot;text/javascript;version=1.8&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/Dropbox/management.js&quot;/&gt;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-        href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-    &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-      &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-      &lt;a href=&quot;https://www.dropbox.com/terms#privacy&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-      &lt;a href=&quot;https://www.dropbox.com/terms#terms&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-      &lt;h1&gt;Dropbox&lt;/h1&gt;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    &lt;div id=&quot;provider-spacebox&quot;&gt;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-      &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-      &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.usedSpace;&lt;/label&gt;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-          &lt;span id=&quot;file-space-used&quot;/&gt;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-          &lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.unusedSpace;&lt;/label&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-          &lt;span id=&quot;remaining-file-space&quot;/&gt;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-          &lt;span id=&quot;remaining-file-space-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-        &lt;div id=&quot;upgrade&quot;&gt;&lt;a href=&quot;https://www.dropbox.com/plans&quot;&gt;&amp;cloudfileMgmt.upgradeOffer;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-   &lt;/div&gt;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-   &lt;div id=&quot;provider-account-settings&quot;&gt;&lt;a href=&quot;https://www.dropbox.com/account#settings&quot;&gt;&amp;dropboxMgmt.viewSettings;&lt;/a&gt;&lt;/div&gt; </span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/components/cloudfile/content/Dropbox/settings.xhtml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,21 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  &lt;!ENTITY % dbDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Dropbox/settings.dtd&quot;&gt; %dbDTD;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-]&gt;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-        href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot; /&gt;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    &lt;div id=&quot;learn-more&quot;&gt;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-      &lt;a href=&quot;https://www.dropbox.com/&quot;&gt;&amp;dropboxSettings.learnMore;&lt;/a&gt;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/components/cloudfile/content/UbuntuOne/management.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,44 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+function onLoadProvider(provider) {</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+  let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  remainingFileSpace.textContent = messenger.formatFileSize(</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    provider.remainingFileSpace);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+  let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  let totalSpace = provider.fileSpaceUsed + provider.remainingFileSpace;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+    .width(150)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    .height(150);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+  vis.add(pv.Wedge)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    .data([provider.fileSpaceUsed, provider.remainingFileSpace])</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    .left(75)</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    .top(75)</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    .innerRadius(30)</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    .outerRadius(65)</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    .angle(function(d) d * pieScale);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  vis.add(pv.Label)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    .left(75)</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    .top(75)</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    .font(&quot;14px Sans-Serif&quot;)</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    .textAlign(&quot;center&quot;)</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    .textBaseline(&quot;middle&quot;)</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    .text(messenger.formatFileSize(totalSpace));</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  vis.render();</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/cloudfile/content/UbuntuOne/management.xhtml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/cloudfile/content/UbuntuOne/management.xhtml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">   &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l8.5"></a><span id="l8.5">   &lt;!ENTITY % u1DTD SYSTEM &quot;chrome://messenger/locale/cloudfile/UbuntuOne/management.dtd&quot;&gt; %u1DTD;</span>
<a href="#l8.6"></a><span id="l8.6"> ]&gt;</span>
<a href="#l8.7"></a><span id="l8.7"> &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;</span>
<a href="#l8.8"></a><span id="l8.8">   &lt;head&gt;</span>
<a href="#l8.9"></a><span id="l8.9">     &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l8.10"></a><span id="l8.10">             src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l8.11"></a><span id="l8.11">     &lt;script type=&quot;text/javascript;version=1.8&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/Dropbox/management.js&quot;/&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+            src=&quot;chrome://messenger/content/cloudfile/UbuntuOne/management.js&quot;/&gt;</span>
<a href="#l8.14"></a><span id="l8.14">     &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l8.15"></a><span id="l8.15">         type=&quot;text/css&quot;</span>
<a href="#l8.16"></a><span id="l8.16">         href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l8.17"></a><span id="l8.17">   &lt;/head&gt;</span>
<a href="#l8.18"></a><span id="l8.18">   &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l8.19"></a><span id="l8.19">     &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l8.20"></a><span id="l8.20">       &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l8.21"></a><span id="l8.21">       &lt;a href=&quot;https://one.ubuntu.com/referrals/referee/2149434/?next=/privacy/&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/cloudfile/jar.mn</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/cloudfile/jar.mn</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -2,18 +2,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.5"></a><span id="l9.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> messenger.jar:</span>
<a href="#l9.8"></a><span id="l9.8"> *   content/messenger/cloudfile/addAccountDialog.xul (content/addAccountDialog.xul)</span>
<a href="#l9.9"></a><span id="l9.9">     content/messenger/cloudfile/addAccountDialog.js  (content/addAccountDialog.js)</span>
<a href="#l9.10"></a><span id="l9.10">     content/messenger/cloudfile/attachment-24.png (content/attachment-24.png)</span>
<a href="#l9.11"></a><span id="l9.11">     content/messenger/cloudfile/emptySettings.xhtml (content/emptySettings.xhtml)</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    content/messenger/cloudfile/Dropbox/management.xhtml (content/Dropbox/management.xhtml)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    content/messenger/cloudfile/Dropbox/management.js    (content/Dropbox/management.js)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    content/messenger/cloudfile/Dropbox/settings.xhtml (content/Dropbox/settings.xhtml)</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    content/messenger/cloudfile/UbuntuOne/management.js (content/UbuntuOne/management.js)</span>
<a href="#l9.16"></a><span id="l9.16">     content/messenger/cloudfile/UbuntuOne/management.xhtml (content/UbuntuOne/management.xhtml)</span>
<a href="#l9.17"></a><span id="l9.17">     content/messenger/cloudfile/UbuntuOne/settings.js (content/UbuntuOne/settings.js)</span>
<a href="#l9.18"></a><span id="l9.18">     content/messenger/cloudfile/UbuntuOne/settings.xhtml (content/UbuntuOne/settings.xhtml)</span>
<a href="#l9.19"></a><span id="l9.19">     content/messenger/cloudfile/YouSendIt/management.xhtml (content/YouSendIt/management.xhtml)</span>
<a href="#l9.20"></a><span id="l9.20">     content/messenger/cloudfile/YouSendIt/management.js (content/YouSendIt/management.js)</span>
<a href="#l9.21"></a><span id="l9.21">     content/messenger/cloudfile/YouSendIt/settings.js (content/YouSendIt/settings.js)</span>
<a href="#l9.22"></a><span id="l9.22">     content/messenger/cloudfile/YouSendIt/settings.xhtml (content/YouSendIt/settings.xhtml)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mail/components/cloudfile/nsDropbox.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,628 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-/* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">- *</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">- * This component handles the Dropbox implementation of the</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- * nsIMsgCloudFileProvider interface.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">- */</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-const Cu = Components.utils;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-const Cr = Components.results;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-Cu.import(&quot;resource:///modules/oauth.jsm&quot;);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-Cu.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-const kBadAccessToken = 401;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-const kAuthSecretRealm = &quot;Dropbox Auth Secret&quot;;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-// According to Dropbox, the kMaxFileSize is a fixed limit.</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-const kMaxFileSize = 157286400;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-const kUserInfoPath = &quot;account/info&quot;;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-const kDeletePath = &quot;fileops/delete/?root=sandbox&quot;;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-const kAppKey = &quot;7xkhuze09iqkghm&quot;;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-const kAppSecret = &quot;3i5kwjkt74rkkjc&quot;;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-const kSharesPath = &quot;shares/sandbox/&quot;;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-const kFilesPutPath = &quot;files_put/sandbox/&quot;;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-var gServerUrl = &quot;https://api.dropbox.com/1/&quot;;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-var gContentUrl = &quot;https://api-content.dropbox.com/1/&quot;;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-var gAuthUrl = &quot;https://www.dropbox.com/1/&quot;;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-var gLogoutUrl = &quot;https://www.dropbox.com/logout&quot;;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-function wwwFormUrlEncode(aStr) {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  return encodeURIComponent(aStr).replace(/!/g, '%21')</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-                                 .replace(/'/g, '%27')</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-                                 .replace(/\(/g, '%28')</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-                                 .replace(/\)/g, '%29')</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-                                 .replace(/\*/g, '%2A');</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-}</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-function nsDropbox() {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  this.log = Log4Moz.getConfiguredLogger(&quot;Dropbox&quot;);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-}</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-nsDropbox.prototype = {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  /* nsISupports */</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  classID: Components.ID(&quot;{2fd8a64a-a496-4cf4-9d6b-d3f9800c6322}&quot;),</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  get type() &quot;Dropbox&quot;,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-  get displayName() &quot;Dropbox&quot;,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-  get serviceURL() &quot;https://www.dropbox.com/&quot;,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  get iconClass() &quot;chrome://messenger/skin/icons/dropbox.png&quot;,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  get accountKey() this._accountKey,</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  get lastError() this._lastErrorText,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-  get settingsURL() &quot;chrome://messenger/content/cloudfile/Dropbox/settings.xhtml&quot;,</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  get managementURL() &quot;chrome://messenger/content/cloudfile/Dropbox/management.xhtml&quot;,</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  _accountKey: false,</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  _prefBranch: null,</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  _loggedIn: false,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  _authToken: &quot;&quot;,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-  _userInfo: null,</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  _file : null,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  _requestDate: null,</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  _successCallback: null,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  _connection: null,</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  _request: null,</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-  _uploadingFile : null,</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  _uploader : null,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  _lastErrorStatus : 0,</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-  _lastErrorText : &quot;&quot;,</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  _maxFileSize : kMaxFileSize,</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  _totalStorage: -1,</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-  _fileSpaceUsed : -1,</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-  _uploads: [],</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-  _urlsForFiles : {},</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  _uploadInfo : {}, // upload info keyed on aFiles.</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-  /**</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-   * Initialize this instance of nsDropbox, setting the accountKey.</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-   *</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-   * @param aAccountKey the account key to initialize this provider with</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-   */</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-  init: function nsDropbox_init(aAccountKey) {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-    this._accountKey = aAccountKey;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-    this._prefBranch = Services.prefs.getBranch(&quot;mail.cloud_files.accounts.&quot; + </span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-                                                aAccountKey + &quot;.&quot;);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-  },</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-  /**</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-   * The callback passed to an nsDropboxFileUploader, which is fired when</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-   * nsDropboxFileUploader exits.</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-   *</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-   * @param aRequestObserver the request observer originally passed to</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-   *                         uploadFile for the file associated with the</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-   *                         nsDropboxFileUploader</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-   * @param aStatus the result of the upload</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-   */</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-  _uploaderCallback : function nsDropbox__uploaderCallback(aRequestObserver,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-                                                           aStatus) {</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-    aRequestObserver.onStopRequest(null, null, aStatus);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-    this._uploadingFile = null;</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-    this._uploads.shift();</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-    if (this._uploads.length &gt; 0) {</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-      let nextUpload = this._uploads[0];</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-      this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-      this._uploadingFile = nextUpload.file;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-      this._uploader = nextUpload;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-      try {</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-        this.uploadFile(nextUpload.file, nextUpload.callback);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-      }</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-      catch (ex) {</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-        nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-      }</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-    }</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-    else</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-      this._uploader = null;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-  },</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  /** </span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-   * Attempts to upload a file to Dropbox.</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-   *</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-   * @param aFile the nsILocalFile to be uploaded</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-   * @param aCallback an nsIRequestObserver for listening for the starting</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-   *                  and ending states of the upload.</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-   */</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-  uploadFile: function nsDropbox_uploadFile(aFile, aCallback) {</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-    this.log.info(&quot;uploading &quot; + aFile.leafName);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-    // Some ugliness here - we stash requestObserver here, because we might</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    // use it again in _getUserInfo.</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-    // if we're uploading a file, queue this request.</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-    if (this._uploadingFile &amp;&amp; this._uploadingFile != aFile) {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-      let uploader = new nsDropboxFileUploader(this, aFile,</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-                                               this._uploaderCallback</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-                                                   .bind(this),</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-                                               aCallback);</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-      this._uploads.push(uploader);</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-      return;</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-    }</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-    this._file = aFile;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-    let successCallback = this._finishUpload.bind(this, aFile, aCallback);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-    if (!this._loggedIn)</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-      return this._logonAndGetUserInfo(successCallback, null, true);</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-    this.log.info(&quot;getting user info&quot;);</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-      return this._getUserInfo(successCallback);</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-    successCallback();</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-  },</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-  /**</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-   * A private function used to ensure that we can actually upload the file</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-   * (we haven't exceeded file size or quota limitations), and then attempts</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-   * to kick-off the upload.</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-   *</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-   * @param aFile the nsILocalFile to upload</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-   *                  ending states of the upload.</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-   */</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-  _finishUpload: function nsDropbox__finishUpload(aFile, aCallback) {</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineminus">-    let exceedsFileLimit = Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-    let exceedsQuota = Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota;</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-    if (aFile.fileSize &gt; this._maxFileSize)</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-      return aCallback.onStopRequest(null, null, exceedsFileLimit);</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-    if (aFile.fileSize &gt; this.remainingFileSpace)</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-      return aCallback.onStopRequest(null, null, exceedsQuota);</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-    delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-    if (!this._uploader) {</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-      this._uploader = new nsDropboxFileUploader(this, aFile,</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-                                                 this._uploaderCallback</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-                                                     .bind(this),</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-                                                 aCallback);</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-      this._uploads.unshift(this._uploader);</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-    }</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-    this._uploader.uploadFile();</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-  },</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-  /**</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-   * Attempts to cancel a file upload.</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-   *</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-   * @param aFile the nsILocalFile to cancel the upload for.</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-   */</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-  cancelFileUpload: function nsDropbox_cancelFileUpload(aFile) {</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-    if (this._uploadingFile.equals(aFile)) {</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-      this._uploader.cancel();</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-    }</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-    else {</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-      for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-        if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-          this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-            null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-          this._uploads.splice(i, 1);</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-          return;</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-        }</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-    }</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-  },</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-  /**</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-   * A private function used to retrieve the profile information for the</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-   * user account associated with the accountKey.</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-   *</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-   * @param successCallback the function called if information retrieval</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-   *                        is successful</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-   * @param failureCallback the function called if information retrieval fails</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-   */</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-  _getUserInfo: function nsDropbox__getUserInfo(successCallback,</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-                                                failureCallback) {</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-    if (!successCallback)</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-      successCallback = function() {</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-        this.requestObserver</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-            .onStopRequest(null, null,</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-                           this._loggedIn ? Cr.NS_OK : Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-    if (!failureCallback)</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-      failureCallback = function () {</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-        this.requestObserver</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-    this._connection.signAndSend(</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-      gServerUrl + kUserInfoPath, &quot;&quot;, &quot;GET&quot;, [],</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-        this.log.info(&quot;user info = &quot; + aResponseText);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-        this._userInfo = JSON.parse(aResponseText);</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-        let quota = this._userInfo.quota_info;</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-        this._totalStorage = quota.quota;</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-        this._fileSpaceUsed = quota.normal + quota.shared;</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-        this.log.info(&quot;storage total = &quot; + this._totalStorage);</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-        this.log.info(&quot;storage used = &quot; + this._fileSpaceUsed);</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-        successCallback();</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-      }.bind(this),</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-        // Treat bad token specially, and fallback to</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-        // going through the uploadFiles process</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-        // again, and getting new tokens.</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-        if (aRequest.status == kBadAccessToken) {</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-          this.log.info(&quot;got bad token&quot;);</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-          this._loggedIn = false;</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-          this._cachedAuthToken = &quot;&quot;;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-          this._cachedAuthSecret = &quot;&quot;;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-          successCallback();</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-          return;</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-        }</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-        this.log.error(&quot;user info failed, status = &quot; + aRequest.status);</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-        this.log.error(&quot;response text = &quot; + aResponseText);</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-        this.log.error(&quot;exception = &quot; + aException);</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-        failureCallback();</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-      }.bind(this), this);</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-  },</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-  /**</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-   * A private function that first ensures that the user is logged in, and then</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-   * retrieves the user's profile information.</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-   *</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-   * @param aSuccessCallback the function called on successful information</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-   *                         retrieval</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-   * @param aFailureCallback the function called on failed information retrieval</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-   */</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-  _logonAndGetUserInfo: function nsDropbox_logonAndGetUserInfo(aSuccessCallback,</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-                                                               aFailureCallback,</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-                                                               aWithUI) {</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-    if (!aFailureCallback)</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-      aFailureCallback = function () {</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-        this.requestObserver</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-    return this.logon(function() {</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-      this._getUserInfo(aSuccessCallback, aFailureCallback);</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-    }.bind(this), aFailureCallback, aWithUI);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-  },</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-  /**</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-   * For some nsILocalFile, return the associated sharing URL.</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-   *</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-   * @param aFile the nsILocalFile to retrieve the URL for</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-   */</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-  urlForFile: function nsDropbox_urlForFile(aFile) {</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-    return this._urlsForFiles[aFile.path];</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-  },</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-  /**</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-   * Updates the profile information for the account associated with the</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-   * account key.</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-   *</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-   * @param aCallback an nsIRequestObserver for observing the starting and</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-   *                  ending states of the request.</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-   */</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-  refreshUserInfo: function nsDropbox_refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-    aCallback.onStartRequest(null, null);</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-    if (!this._loggedIn)</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-      return this._logonAndGetUserInfo(null, null, aWithUI);</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-      return this._getUserInfo();</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-    return this._userInfo;</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-  },</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-  /**</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-   * Our Dropbox implementation does not implement the createNewAccount</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-   * function defined in nsIMsgCloudFileProvider.idl.</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-   */</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-  createNewAccount: function nsDropbox_createNewAccount(aEmailAddress,</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-                                                        aPassword, aFirstName,</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-                                                        aLastName) {</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-    return Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-  },</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-  /**</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-   * If the user already has an account, we can get the user to just login</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-   * to it via OAuth.</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-   *</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-   * This function does not appear to be called from the BigFiles UI, and</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-   * might be excisable.</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-   */</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-  createExistingAccount: function nsDropbox_createExistingAccount(aRequestObserver) {</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-     // XXX: replace this with a better function</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-    let successCb = function(aResponseText, aRequest) {</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-      aRequestObserver.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-    let failureCb = function(aResponseText, aRequest) {</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-      aRequestObserver.onStopRequest(null, this,</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-                                     Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-    this.logon(successCb, failureCb, true);</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-  },</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-  /**</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-   * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineminus">-   * there's a url we can load in a content tab that will allow the user</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-   * to create an account.</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-   */</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineminus">-  get createNewAccountUrl() &quot;&quot;,</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-  /**</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-   * For a particular error, return a URL if Dropbox has a page for handling</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-   * that particular error.</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineminus">-   *</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineminus">-   * @param aError the error to get the URL for</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-   */</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineminus">-  providerUrlForError: function nsDropbox_providerUrlForError(aError) {</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineminus">-    if (aError == Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota)</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineminus">-      return &quot;https://www.dropbox.com/plans&quot;;</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineminus">-  },</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineminus">-</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineminus">-  /**</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineminus">-   * If we don't know the limit, this will return -1.</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-   */</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineminus">-  get fileUploadSizeLimit() this._maxFileSize,</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineminus">-  get remainingFileSpace() this._totalStorage - this._fileSpaceUsed,</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineminus">-  get fileSpaceUsed() this._fileSpaceUsed,</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineminus">-  /**</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-   * Attempt to delete an upload file if we've uploaded it.</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-   *</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-   * @param aFile the file that was originall uploaded</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-   *                  ending states of the deletion request.</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-   */</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-  deleteFile: function nsDropbox_deleteFile(aFile, aCallback) {</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-    let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-    if (!uploadInfo)</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineminus">-      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-    let path = wwwFormUrlEncode(uploadInfo.path);</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-    let url = gServerUrl + kDeletePath + &quot;&amp;path=&quot; + uploadInfo.path;</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineminus">-    this.log.info(&quot;Sending delete request to &quot; + url);</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-    let oauthParams =</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-      [[&quot;root&quot;, &quot;sandbox&quot;], [&quot;path&quot;, path]];</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-    this._connection.signAndSend(url, &quot;&quot;, &quot;POST&quot;, null,</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-        this.log.info(&quot;success deleting file; response = &quot; + aResponseText);</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-        aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-      }.bind(this),</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-        this.log.error(&quot;failed deleting file; response = &quot; + aResponseText);</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-        aCallback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-      }.bind(this), this, null);</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-  },</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-  /**</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-   * This function is used by our testing framework to override the default</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineminus">-   * URL's that nsDropbox connects to.</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineminus">-   */</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineminus">-  overrideUrls : function nsDropbox_overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-    gServerUrl = aUrls[0];</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-    gContentUrl = aUrls[1];</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineminus">-    gAuthUrl = aUrls[2];</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineminus">-    gLogoutUrl = aUrls[3];</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineminus">-  },</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineminus">-</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-  /**</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineminus">-   * logon to the dropbox account.</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineminus">-   *</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-   * @param successCallback - called if logon is successful</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineminus">-   * @param failureCallback - called back on error.</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineminus">-   * @param aWithUI if false, logon fails if it would have needed to put up UI.</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineminus">-   *                This is used for things like displaying account settings,</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineminus">-   *                where we don't want to pop up the oauth ui.</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineminus">-   */</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineminus">-  logon: function nsDropbox_logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-    let authToken = this._cachedAuthToken;</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineminus">-    let authSecret = this._cachedAuthSecret;</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineminus">-    if (!aWithUI &amp;&amp; (!authToken.length || !authSecret.length)) {</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-      failureCallback();</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-      return;</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-    }</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-    this._connection = new OAuth(this.displayName, gServerUrl, gAuthUrl,</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineminus">-                                 authToken, authSecret, kAppKey, kAppSecret);</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-    this._connection.connect(</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-      function () {</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineminus">-        this.log.info(&quot;success connecting&quot;);</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineminus">-        this._loggedIn = true;</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineminus">-        this._cachedAuthToken = this._connection.token;</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineminus">-        this._cachedAuthSecret = this._connection.tokenSecret;</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineminus">-</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineminus">-        // Attempt to end the session we just opened to get these tokens...</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-        let xhr = Cc[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineminus">-                    .createInstance(Ci.nsIXMLHttpRequest);</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineminus">-        xhr.mozBackgroundRequest = true;</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineminus">-        xhr.open(&quot;GET&quot;, gLogoutUrl);</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineminus">-        xhr.onerror = function(aProgressEvent) {</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineminus">-          this.log.error(&quot;Could not end authorization session!&quot;);</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineminus">-          this.log.error(&quot;Status was: &quot; + aProgressEvent.target.status);</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineminus">-          this.log.error(&quot;Message was: &quot; + aProgressEvent.target.statusText);</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-        }.bind(this);</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-        xhr.onload = function(aRequest) {</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-          if (aRequest.target.status == 200)</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineminus">-            this.log.info(&quot;Successfully ended authorization session.&quot;);</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-          else {</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-            this.log.error(&quot;Could not end authorization session!&quot;);</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineminus">-            this.log.error(&quot;Status was: &quot; + aRequest.target.status);</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineminus">-            this.log.error(&quot;Message was: &quot; + aRequest.target.statusText);</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineminus">-          }</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-        }.bind(this);</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineminus">-</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineminus">-        this.log.info(&quot;Sending logout request to: &quot; + gLogoutUrl);</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineminus">-        xhr.send();</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineminus">-</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineminus">-        successCallback();</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-      }.bind(this),</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-      function () {</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-        this.log.info(&quot;failed connecting&quot;);</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineminus">-        failureCallback();</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineminus">-      }.bind(this),</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineminus">-      true);</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineminus">-  },</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineminus">-</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-  /**</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineminus">-   * Retrieves the cached auth token for this account.</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineminus">-   */</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineminus">-  get _cachedAuthToken() {</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineminus">-    let authToken = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-                                                     cloudFileAccounts.kTokenRealm);</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-    if (!authToken)</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineminus">-    return authToken;</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineminus">-  },</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineminus">-  /**</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineminus">-   * Sets the cached auth token for this account.</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineminus">-   *</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineminus">-   * @param aAuthToken the auth token to cache.</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-   */</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-  set _cachedAuthToken(aAuthToken) {</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineminus">-                                     cloudFileAccounts.kTokenRealm,</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineminus">-                                     aAuthToken);</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineminus">-  },</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineminus">-</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-  /**</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-   * Retrieves the cached auth secret for this account.</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-   */</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineminus">-  get _cachedAuthSecret() {</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineminus">-    let authSecret = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineminus">-                                                      kAuthSecretRealm);</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineminus">-</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineminus">-    if (!authSecret)</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineminus">-</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineminus">-    return authSecret;</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineminus">-  },</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineminus">-</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineminus">-  /**</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineminus">-   * Sets the cached auth secret for this account.</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineminus">-   *</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-   * @param aAuthSecret the auth secret to cache.</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineminus">-   */</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineminus">-  set _cachedAuthSecret(aAuthSecret) {</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineminus">-                                     kAuthSecretRealm,</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-                                     aAuthSecret);</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-  },</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineminus">-};</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineminus">-</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineminus">-function nsDropboxFileUploader(aDropbox, aFile, aCallback, aRequestObserver) {</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineminus">-  this.dropbox = aDropbox;</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineminus">-  this.log = this.dropbox.log;</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineminus">-  this.log.info(&quot;new nsDropboxFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineminus">-  this.file = aFile;</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineminus">-  this.callback = aCallback;</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineminus">-  this.requestObserver = aRequestObserver;</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineminus">-}</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineminus">-</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineminus">-nsDropboxFileUploader.prototype = {</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineminus">-  dropbox : null,</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineminus">-  file : null,</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineminus">-  callback : null,</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineminus">-  request : null,</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-  /**</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-   * Kicks off the upload request for the file associated with this Uploader.</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineminus">-   */</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineminus">-  uploadFile: function nsDFU_uploadFile() {</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineminus">-    this.requestObserver.onStartRequest(null, null);</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineminus">-    this.log.info(&quot;ready to upload file &quot; + wwwFormUrlEncode(this.file.leafName));</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineminus">-    let url = gContentUrl + kFilesPutPath + </span>
<a href="#l10.559"></a><span id="l10.559" class="difflineminus">-              wwwFormUrlEncode(this.file.leafName) + &quot;?overwrite=false&quot;;</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-    let fileContents = &quot;&quot;;</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineminus">-    let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-                     .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineminus">-    fstream.init(this.file, -1, 0, 0);</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineminus">-    let bufStream = Cc[&quot;@mozilla.org/network/buffered-input-stream;1&quot;].</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-      createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-    bufStream.init(fstream, this.file.fileSize);</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-    bufStream = bufStream.QueryInterface(Ci.nsIInputStream);</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-    let contentLength = fstream.available();</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-    let oauthParams =</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-      [[&quot;Content-Length&quot;, contentLength]];</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineminus">-    this.request = this.dropbox._connection.signAndSend(url, &quot;&quot;, &quot;PUT&quot;, bufStream,</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineminus">-        this.request = null;</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineminus">-        this.log.info(&quot;success putting file &quot; + aResponseText);</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineminus">-        let putInfo = JSON.parse(aResponseText);</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineminus">-        this.dropbox._uploadInfo[this.file.path] = putInfo;</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineminus">-        this._getShareUrl(this.file, this.callback);</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineminus">-      }.bind(this),</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineminus">-        this.request = null;</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineminus">-        this.log.info(&quot;failed putting file response = &quot; + aResponseText);</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineminus">-        if (this.callback)</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineminus">-          this.callback(this.requestObserver,</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineminus">-                        Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-      }.bind(this), this, oauthParams);</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineminus">-  },</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineminus">-</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineminus">-  /**</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-   * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineminus">-   */</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineminus">-  cancel: function nsDFU_cancel() {</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineminus">-    this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-    if (this.request) {</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-      let req = this.request;</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-      if (req.channel) {</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-        this.log.info(&quot;canceling channel upload&quot;);</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineminus">-        delete this.callback;</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineminus">-        req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineminus">-      }</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineminus">-      this.request = null;</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-    }</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineminus">-  },</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineminus">-</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineminus">-  /**</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-   * Private function that attempts to retrieve the sharing URL for the file</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-   * uploaded with this Uploader.</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineminus">-   *</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineminus">-   * @param aFile ...</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the starting and</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-   *                  ending states of the URL retrieval request.</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-   */</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-  _getShareUrl: function nsDFU__getShareUrl(aFile, aCallback) {</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineminus">-    let url = gServerUrl + kSharesPath + wwwFormUrlEncode(aFile.leafName);</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineminus">-    this.file = aFile;</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineminus">-    this.dropbox._connection.signAndSend(</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineminus">-      url, &quot;&quot;, &quot;POST&quot;, null,</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-      function(aResponseText, aRequest) {</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-        this.log.info(&quot;Getting share URL successful with response text: &quot;</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineminus">-                      + aResponseText);</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-        let shareInfo = JSON.parse(aResponseText);</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-        this.dropbox._urlsForFiles[this.file.path] = shareInfo.url;</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-        aCallback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-      }.bind(this),</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-      function(aException, aResponseText, aRequest) {</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-        this.log.error(&quot;Getting share URL failed with response text: &quot;</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineminus">-                       + aResponseText);</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineminus">-        aCallback(this.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineminus">-      }.bind(this), this);</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineminus">-  },</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineminus">-};</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineminus">-</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineminus">-const NSGetFactory = XPCOMUtils.generateNSGetFactory([nsDropbox]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -171,17 +171,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> @BINPATH@/components/mailview.xpt</span>
<a href="#l11.5"></a><span id="l11.5"> @BINPATH@/components/mailprofilemigration.xpt</span>
<a href="#l11.6"></a><span id="l11.6"> @BINPATH@/components/messageWakeupService.js</span>
<a href="#l11.7"></a><span id="l11.7"> @BINPATH@/components/messageWakeupService.manifest</span>
<a href="#l11.8"></a><span id="l11.8"> @BINPATH@/components/nsActivity.js</span>
<a href="#l11.9"></a><span id="l11.9"> @BINPATH@/components/nsActivityManager.js</span>
<a href="#l11.10"></a><span id="l11.10"> @BINPATH@/components/nsActivityManagerUI.js</span>
<a href="#l11.11"></a><span id="l11.11"> @BINPATH@/components/nsYouSendIt.js</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-@BINPATH@/components/nsDropbox.js</span>
<a href="#l11.13"></a><span id="l11.13"> @BINPATH@/components/nsUbuntuOne.js</span>
<a href="#l11.14"></a><span id="l11.14"> @BINPATH@/components/cloudFileAccounts.js</span>
<a href="#l11.15"></a><span id="l11.15"> @BINPATH@/components/nsAddrbook.manifest</span>
<a href="#l11.16"></a><span id="l11.16"> @BINPATH@/components/nsMailNewsCommandLineHandler.js</span>
<a href="#l11.17"></a><span id="l11.17"> @BINPATH@/components/services-crypto-component.xpt</span>
<a href="#l11.18"></a><span id="l11.18"> #ifndef XP_OS2</span>
<a href="#l11.19"></a><span id="l11.19"> @BINPATH@/components/shellservice.xpt</span>
<a href="#l11.20"></a><span id="l11.20"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/installer/removed-files.in</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/installer/removed-files.in</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -55,16 +55,17 @@ components/mozgnome.xpt</span>
<a href="#l12.4"></a><span id="l12.4"> components/@DLL_PREFIX@myspell@DLL_SUFFIX@</span>
<a href="#l12.5"></a><span id="l12.5"> components/necko_data.xpt</span>
<a href="#l12.6"></a><span id="l12.6"> components/aboutRights.js</span>
<a href="#l12.7"></a><span id="l12.7"> components/nsAddonRepository.js</span>
<a href="#l12.8"></a><span id="l12.8"> components/nsBackgroundUpdateService.js</span>
<a href="#l12.9"></a><span id="l12.9"> components/nsCloseAllWindows.js</span>
<a href="#l12.10"></a><span id="l12.10"> components/nsComposerCmdLineHandler.js</span>
<a href="#l12.11"></a><span id="l12.11"> components/nsDownloadProgressListener.js</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+components/nsDropbox.js</span>
<a href="#l12.13"></a><span id="l12.13"> components/nsExtensionManager.js</span>
<a href="#l12.14"></a><span id="l12.14"> components/nsInterfaceInfoToIDL.js</span>
<a href="#l12.15"></a><span id="l12.15"> components/nsLDAPPrefsService.js</span>
<a href="#l12.16"></a><span id="l12.16"> #ifdef XP_WIN</span>
<a href="#l12.17"></a><span id="l12.17">   components/nsPostUpdateWin.js</span>
<a href="#l12.18"></a><span id="l12.18"> #endif</span>
<a href="#l12.19"></a><span id="l12.19"> components/nsProgressDialog.js</span>
<a href="#l12.20"></a><span id="l12.20"> components/nsScriptableIO.js</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -1177,9 +1178,9 @@ components/xmlextras.xpt</span>
<a href="#l12.22"></a><span id="l12.22">   #endif</span>
<a href="#l12.23"></a><span id="l12.23"> #endif</span>
<a href="#l12.24"></a><span id="l12.24"> # ****************************************************************************</span>
<a href="#l12.25"></a><span id="l12.25"> # * End of XPTs at the time we started linking them on Linux and Mac.        *</span>
<a href="#l12.26"></a><span id="l12.26"> # ****************************************************************************</span>
<a href="#l12.27"></a><span id="l12.27"> #ifndef MOZ_MAINTENANCE_SERVICE</span>
<a href="#l12.28"></a><span id="l12.28"> maintenanceservice.exe</span>
<a href="#l12.29"></a><span id="l12.29"> maintenanceservice_installer.exe</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-#endif</span>
<a href="#l12.31"></a><span id="l12.31">\ No newline at end of file</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/management.dtd</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,4 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-&lt;!ENTITY dropboxMgmt.viewSettings &quot;View my account settings on dropbox.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Dropbox/settings.dtd</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,4 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-&lt;!ENTITY dropboxSettings.learnMore &quot;Learn more…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -122,18 +122,16 @@</span>
<a href="#l15.4"></a><span id="l15.4">   locale/@AB_CD@/messenger/addressbook/abMailListDialog.dtd             (%chrome/messenger/addressbook/abMailListDialog.dtd)</span>
<a href="#l15.5"></a><span id="l15.5">   locale/@AB_CD@/messenger/addressbook/addressBook.properties           (%chrome/messenger/addressbook/addressBook.properties)</span>
<a href="#l15.6"></a><span id="l15.6">   locale/@AB_CD@/messenger/addressbook/ldapAutoCompErrs.properties      (%chrome/messenger/addressbook/ldapAutoCompErrs.properties)</span>
<a href="#l15.7"></a><span id="l15.7">   locale/@AB_CD@/messenger/addressbook/pref-directory.dtd               (%chrome/messenger/addressbook/pref-directory.dtd)</span>
<a href="#l15.8"></a><span id="l15.8">   locale/@AB_CD@/messenger/addressbook/pref-directory-add.dtd           (%chrome/messenger/addressbook/pref-directory-add.dtd)</span>
<a href="#l15.9"></a><span id="l15.9">   locale/@AB_CD@/messenger/addressbook/replicationProgress.properties   (%chrome/messenger/addressbook/replicationProgress.properties)</span>
<a href="#l15.10"></a><span id="l15.10">   locale/@AB_CD@/messenger/cloudfile/addAccountDialog.dtd               (%chrome/messenger/cloudfile/addAccountDialog.dtd)</span>
<a href="#l15.11"></a><span id="l15.11">   locale/@AB_CD@/messenger/cloudfile/management.dtd                     (%chrome/messenger/cloudfile/management.dtd)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Dropbox/management.dtd             (%chrome/messenger/cloudfile/Dropbox/management.dtd)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Dropbox/settings.dtd               (%chrome/messenger/cloudfile/Dropbox/settings.dtd)</span>
<a href="#l15.14"></a><span id="l15.14">   locale/@AB_CD@/messenger/cloudfile/UbuntuOne/management.dtd           (%chrome/messenger/cloudfile/UbuntuOne/management.dtd)</span>
<a href="#l15.15"></a><span id="l15.15">   locale/@AB_CD@/messenger/cloudfile/UbuntuOne/settings.dtd             (%chrome/messenger/cloudfile/UbuntuOne/settings.dtd)</span>
<a href="#l15.16"></a><span id="l15.16">   locale/@AB_CD@/messenger/cloudfile/YouSendIt/management.dtd           (%chrome/messenger/cloudfile/YouSendIt/management.dtd)</span>
<a href="#l15.17"></a><span id="l15.17">   locale/@AB_CD@/messenger/cloudfile/YouSendIt/settings.dtd             (%chrome/messenger/cloudfile/YouSendIt/settings.dtd)</span>
<a href="#l15.18"></a><span id="l15.18">   locale/@AB_CD@/messenger/messengercompose/messengercompose.dtd        (%chrome/messenger/messengercompose/messengercompose.dtd)</span>
<a href="#l15.19"></a><span id="l15.19">   locale/@AB_CD@/messenger/messengercompose/addressingWidgetOverlay.dtd (%chrome/messenger/messengercompose/addressingWidgetOverlay.dtd)</span>
<a href="#l15.20"></a><span id="l15.20">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.dtd           (%chrome/messenger/messengercompose/askSendFormat.dtd)</span>
<a href="#l15.21"></a><span id="l15.21">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.properties    (%chrome/messenger/messengercompose/askSendFormat.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,296 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">-  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-/**</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">- * Tests the Dropbox Bigfile backend.</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">- */</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-const Cr = Components.results;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-const MODULE_NAME = 'test-cloudfile-backend-dropbox';</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-const MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-                         'compose-helpers',</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-                         'cloudfile-dropbox-helpers',</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-                         'observer-helpers',];</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-var gServer, gObsManager;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-function setupModule(module) {</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  fdh.installInto(module);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-  let ch = collector.getModule('compose-helpers');</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  ch.installInto(module);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  let cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  cfh.installInto(module);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  let cbh = collector.getModule('cloudfile-backend-helpers');</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-  cbh.installInto(module);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  let cdh = collector.getModule('cloudfile-dropbox-helpers');</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  cdh.installInto(module);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  let oh = collector.getModule('observer-helpers');</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-  oh.installInto(module);</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-  gObsManager = new cbh.SimpleRequestObserverManager();</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-  // Enable logging for this test.</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-  Services.prefs.setCharPref(&quot;Dropbox.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  Services.prefs.setCharPref(&quot;TBOAuth.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-};</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-function teardownModule() {</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-  Services.prefs.clearUserPref(&quot;Dropbox.logging.dump&quot;);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  Services.prefs.clearUserPref(&quot;TBOAuth.logging.dump&quot;);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-}</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-function setupTest() {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-  gServer = new MockDropboxServer();</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  gServer.init();</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-  gServer.start();</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-}</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-function teardownTest() {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  gObsManager.check();</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-  gObsManager.reset();</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  gServer.stop(mc);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-}</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-function test_simple_case() {</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-    obs.planFor(topic);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-  }</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-  mc.waitFor(function () requestObserver.success);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-  let urlForFile = provider.urlForFile(file);</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-  mc.waitFor(function () requestObserver.success);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-  urlForFile = provider.urlForFile(file);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-  assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-  assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-    Services.obs.removeObserver(obs, topic);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-  }</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-}</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-function test_chained_uploads() {</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-  const kExpectedUrlRoot = &quot;http://www.example.com/&quot;;</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-  const kFilenames = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-  for each (let [, filename] in Iterator(kFilenames)) {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-    let expectedUrl = kExpectedUrlRoot + filename;</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-    gServer.planForUploadFile(filename);</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-    gServer.planForGetFileURL(filename, {url: expectedUrl});</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-  }</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-    obs.planFor(topic);</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-  }</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-  let files = [];</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-  let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-    let requestObserver = gObsManager.create(&quot;test_chained_uploads for filename &quot; + aFilename);</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-    let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-    files.push(file);</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-    provider.uploadFile(file, requestObserver);</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-    return requestObserver;</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-  });</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-  mc.waitFor(function() {</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-    return observers.every(function(aListener) aListener.success);</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-  }, &quot;Timed out waiting for chained uploads to complete.&quot;);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-  assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-  for (let [index, filename] in Iterator(kFilenames)) {</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-    assert_equals(obs.data[kUploadFile][index], filename);</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-    let file = getFile(&quot;./data/&quot; + filename, __file__);</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-    let expectedUriForFile = kExpectedUrlRoot + filename;</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-    let uriForFile = provider.urlForFile(files[index]);</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-    assert_equals(expectedUriForFile, uriForFile);</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-  }</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-  assert_equals(kFilenames.length, obs.numSightings(kGetFileURL));</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-    Services.obs.removeObserver(obs, topic);</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-  }</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-}</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-function test_deleting_uploads() {</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-  // Upload a file</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-  gServer.planForUploadFile(kFilename);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-  gServer.planForGetFileURL(kFilename,</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-                                {url: &quot;http://www.example.com/someFile&quot;});</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-  mc.waitFor(function() requestObserver.success);</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-  // Try deleting a file</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-  obs.planFor(kDeleteFile);</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-  Services.obs.addObserver(obs, kDeleteFile, false);</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-  gServer.planForDeleteFile(kFilename);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-  let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-  provider.deleteFile(file, deleteObserver);</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-  mc.waitFor(function() deleteObserver.success);</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-  // Check to make sure the file was deleted on the server</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-  assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-  assert_equals(obs.data[kDeleteFile][0], kFilename);</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-  Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-}</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-/**</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">- * Test that when we call createExistingAccount, onStopRequest is successfully</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineminus">- * called, and we pass the correct parameters.</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">- */</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-function test_create_existing_account() {</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineminus">-  let done = false;</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">-  let myObs = {</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-    onStartRequest: function(aRequest, aContext) {</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-    },</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">-    onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-      assert_true(aContext instanceof Ci.nsIMsgCloudFileProvider);</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-      assert_equals(aStatusCode, Components.results.NS_OK);</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-      done = true;</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-    },</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-  }</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-  provider.createExistingAccount(myObs);</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-  mc.waitFor(function() done);</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-}</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-/**</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">- * Test that cancelling an upload causes onStopRequest to be</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">- * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">- */</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-function test_can_cancel_upload() {</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-  gServer.planForUploadFile(kFilename, 2000);</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-  assert_can_cancel_uploads(mc, provider, [file]);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-}</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-/**</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">- * Test that cancelling several uploads causes onStopRequest to be</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">- * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineminus">- */</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-function test_can_cancel_uploads() {</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-  const kFiles = [&quot;testFile2&quot;, &quot;testFile3&quot;, &quot;testFile4&quot;];</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-  gServer.setupUser();</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-  let files = [];</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-  for each (let [, filename] in Iterator(kFiles)) {</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-    gServer.planForUploadFile(filename, 2000);</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-    files.push(getFile(&quot;./data/&quot; + filename, __file__));</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-  }</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-  assert_can_cancel_uploads(mc, provider, files);</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-}</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-/**</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">- * Test that completing the OAuth procedure results in an attempt to logout.</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">- */</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-function test_oauth_complete_causes_logout() {</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-  let dummyObs = gObsManager.create(&quot;test_oauth_complete_causes_logout&quot;);</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-  obs.planFor(kLogout);</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-  Services.obs.addObserver(obs, kLogout, false);</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-  provider.createExistingAccount(dummyObs);</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-  mc.waitFor(function() dummyObs.success);</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-  mc.waitFor(function() 1 == obs.numSightings(kLogout));</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-  Services.obs.removeObserver(obs, kLogout);</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-}</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-/**</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">- * Test that we calculate the used and remaining storage amounts correctly.</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">- */</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-function test_calculate_used_and_remaining_storage_correctly() {</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-  const kShared = 12345;</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-  const kNormal = 67890;</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-  const kQuota = 31415926535;</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-  // Override the returned user profile values with the ones we defined</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-  // above.</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-  gServer.setupUser({</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-    quota_info: {</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-      shared: kShared,</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineminus">-      quota: kQuota,</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineminus">-      normal: kNormal,</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-    }</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-  });</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineminus">-  let gotUserInfo = false;</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineminus">-  let statusCode = null;</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-  // Make the provider get the user profile from the fake server.</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-  provider.refreshUserInfo(false, {</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-    onStartRequest: function(aRequest, aContext) {},</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineminus">-    onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineminus">-      gotUserInfo = true;</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-      statusCode = aStatusCode;</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-    },</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineminus">-  });</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineminus">-</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineminus">-  // These are the correct calculations that we should get back.</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-  const kUsedSpace = kShared + kNormal;</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-  const kRemainingSpace = kQuota - kUsedSpace;</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineminus">-</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-  mc.waitFor(function() gotUserInfo);</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-  assert_equals(statusCode, Cr.NS_OK);</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-  assert_equals(provider.fileSpaceUsed, kUsedSpace);</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineminus">-  assert_equals(provider.remainingFileSpace, kRemainingSpace);</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,318 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-let Cu = Components.utils;</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-let Cc = Components.classes;</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-let Ci = Components.interfaces;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-const MODULE_NAME = 'cloudfile-dropbox-helpers';</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-const MODULE_REQUIRES = [];</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-let httpd = {};</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-Cu.import('resource://mozmill/stdlib/httpd.js', httpd);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-const kDefaultServerPort = 4444;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-const kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-const kServerPath = &quot;/server/&quot;;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-const kContentPath = &quot;/content/&quot;;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-const kAuthPath = &quot;/auth/&quot;;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-const kServerURL = kServerRoot + kServerPath;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-const kContentURL = kServerRoot + kContentPath;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-const kAuthURL = kServerRoot + kAuthPath;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-const kOAuthTokenPath = &quot;oauth/request_token&quot;;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-const kOAuthAuthorizePath = &quot;oauth/authorize&quot;;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-const kOAuthAccessTokenPath = &quot;oauth/access_token&quot;;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-const kUserInfoPath = &quot;account/info&quot;;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-const kPutFilePath = &quot;files_put/sandbox/&quot;;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-const kSharesPath = &quot;shares/sandbox/&quot;;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-const kDeletePath = &quot;fileops/delete/&quot;;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-const kLogoutPath = &quot;/logout&quot;;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-const kLogoutURL = kServerRoot + kLogoutPath;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-const kDefaultConfig = {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-  port: kDefaultServerPort</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-}</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-const kAuthTokenString = &quot;oauth_token=requestkey&amp;oauth_token_secret=requestsecret&quot;;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-const kDefaultUser = {</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  referral_link: &quot;https://www.dropbox.com/referrals/r1a2n3d4m5s6t7&quot;,</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-  display_name: &quot;John P. User&quot;,</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  uid: 12345678,</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-  country: &quot;US&quot;,</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  quota_info: {</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-    shared: 253738410565,</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-    quota: 107374182400000,</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-    normal: 680031877871</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-  },</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  email: &quot;john@example.com&quot;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-}</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-const kDefaultFilePutReturn = {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-  size: &quot;225.4KB&quot;,</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-  rev: &quot;35e97029684fe&quot;,</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-  thumb_exists: false,</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-  bytes: 230783,</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-  modified: &quot;Tue, 19 Jul 2011 21:55:38 +0000&quot;,</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-//  path: &quot;/Getting_Started.pdf&quot;,</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  is_dir: false,</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-  icon: &quot;page_white_acrobat&quot;,</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  root: &quot;dropbox&quot;,</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-  mime_type: &quot;application/pdf&quot;,</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  revision: 220823</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-}</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-const kDefaultShareReturn = {</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-  url: &quot;http://db.tt/APqhX1&quot;,</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-  expires: &quot;Wed, 17 Aug 2011 02:34:33 +0000&quot;</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-}</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-const kDefaultReturnHeader = {</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-  statusCode: 200,</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-  statusString: &quot;OK&quot;,</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-  contentType: &quot;text/plain&quot;,</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-}</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-const kDefaultDeleteReturn = {</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-  size: &quot;0 bytes&quot;,</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-  is_deleted: true,</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-  bytes: 0,</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-  thumb_exists: false,</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-  rev: &quot;1f33043551f&quot;,</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-  modified: &quot;Wed, 10 Aug 2011 18:21:30 +0000&quot;,</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-//  path: &quot;/test .txt&quot;,</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-  is_dir: false,</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  icon: &quot;page_white_text&quot;,</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-  root: &quot;dropbox&quot;,</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  mime_type: &quot;text/plain&quot;,</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-  revision: 492341,</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-}</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-function installInto(module) {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-  module.MockDropboxServer = MockDropboxServer;</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-}</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-function MockDropboxServer() {}</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-MockDropboxServer.prototype = {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-  _server: null,</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-  _toDelete: [],</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-  _timers: [],</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-  getPreparedBackend: function MDBS_getPreparedBackend(aAccountKey) {</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-    let dropbox = Cc[&quot;@mozilla.org/mail/dropbox;1&quot;]</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-                  .createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-    let urls = [kServerURL, kContentURL, kAuthURL, kLogoutURL];</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    dropbox.overrideUrls(urls.length, urls);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-    dropbox.init(aAccountKey);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-    return dropbox;</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-  },</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-  init: function MDBS_init(aConfig) {</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-    this._config = kDefaultConfig;</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-    for (let param in aConfig) {</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-      this._config[param] = aConfig[param];</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-    }</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-    this._server = httpd.getServer(this._config.port, '');</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-    this._wireOAuth();</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-    this._wireDeleter();</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-  },</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-  start: function MDBS_start() {</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-    this._server.start(this._config.port);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-  },</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-  stop: function MDBS_stop(aController) {</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-    let allDone = false;</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-    this._server.stop(function() {</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-      allDone = true;</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-    });</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    aController.waitFor(function () allDone,</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-                        &quot;Timed out waiting for Dropbox server to stop!&quot;,</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-                        10000);</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-  },</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-  setupUser: function MDBS_wireUser(aData) {</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-    aData = this._overrideDefault(kDefaultUser, aData);</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-    let userFunc = this._noteAndReturnString(&quot;cloudfile:user&quot;, &quot;&quot;,</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-                                             JSON.stringify(aData));</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-    this._server.registerPathHandler(kServerPath + kUserInfoPath,</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-                                     userFunc);</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-  },</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-  /**</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-   * Plan to upload a file with a particular filename.</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-   *</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-   * @param aFilename the name of the file that will be uploaded.</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-   * @param aMSeconds an optional argument, for how long the upload should</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-   *                  last in milliseconds.</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-   */</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-  planForUploadFile: function MDBS_planForUploadFile(aFilename, aMSeconds) {</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-    let data = kDefaultFilePutReturn;</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-    data.path = aFilename;</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-    // Prepare the function that will receive the upload and respond</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-    // appropriately.</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-    let putFileFunc = this._noteAndReturnString(&quot;cloudfile:uploadFile&quot;,</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-                                                aFilename,</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-                                                JSON.stringify(data));</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-    // Also prepare a function that will, if necessary, wait aMSeconds before</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-    // firing putFileFunc.</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-    let waitWrapperFunc = function(aRequest, aResponse) {</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-      Services.obs.notifyObservers(null, &quot;cloudfile:uploadStarted&quot;,</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-                                   aFilename);</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-      if (!aMSeconds) {</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-        putFileFunc(aRequest, aResponse);</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-        return;</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-      }</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-      // Ok, we're waiting a bit.  Tell the HTTP server that we're going to</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-      // generate a response asynchronously, then set a timer to send the</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-      // response after aMSeconds milliseconds.</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-      aResponse.processAsync();</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-      let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-      let timerEvent = {</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-        notify: function(aTimer) {</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-          putFileFunc(aRequest, aResponse);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-          aResponse.finish();</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-        },</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-      };</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-      timer.initWithCallback(timerEvent, aMSeconds,</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-                             Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-      // We can't let the timer get garbage collected, so we store it.</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-      this._timers.push(timer);</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-    }.bind(this);</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-    this._server.registerPathHandler(kContentPath + kPutFilePath + aFilename,</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-                                     waitWrapperFunc);</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-  },</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-  planForGetFileURL: function MDBS_planForGetShare(aFileName, aData) {</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-    aData = this._overrideDefault(kDefaultShareReturn, aData);</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-    let getShareFunc = this._noteAndReturnString(&quot;cloudfile:getFileURL&quot;,</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-                                                 aFileName,</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-                                                 JSON.stringify(aData));</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-    this._server.registerPathHandler(kServerPath + kSharesPath + aFileName,</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-                                     getShareFunc);</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-  },</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-  planForDeleteFile: function MDBS_planForDeleteFile(aFilename) {</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-    this._toDelete.push(aFilename);</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-  },</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-  _wireDeleter: function MDBS__wireDeleter() {</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-    this._server.registerPathHandler(kServerPath + kDeletePath,</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-                                     this._delete.bind(this));</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-  },</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-  _delete: function MDBS__delete(aRequest, aResponse) {</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-    // Extract the query params</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-    let params = parseQueryString(aRequest.queryString);</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-    let pathIndex = this._toDelete.indexOf(params.path);</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-    if (pathIndex == -1) {</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-      aResponse.write(&quot;Was not prepared to delete a file at path: &quot;</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-                      + params.path);</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-      return;</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-    }</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-    this._toDelete.splice(pathIndex, 1);</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-    Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;,</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-                                 params.path);</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-    let data = kDefaultDeleteReturn;</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-    data.path = params.path;</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;text/plain&quot;);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-    aResponse.write(JSON.stringify(data));</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-  },</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineminus">-  _noteAndReturnString: function MDBS__noteAndReturnString(aKey, aValue,</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineminus">-                                                           aString,</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-                                                           aOptions) {</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-    aOptions = this._overrideDefault(kDefaultReturnHeader, aOptions);</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineminus">-    let self = this;</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineminus">-</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-    let subjectString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-                        .createInstance(Ci.nsISupportsString);</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-    subjectString.data = aString;</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-    let func = function(aMeta, aResponse) {</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-      try {</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineminus">-        aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-                                aOptions.statusString);</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-        aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineminus">-        aResponse.write(aString);</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-        Services.obs.notifyObservers(subjectString, aKey, aValue);</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-      } catch(e) {</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-        dump(&quot;Failed to generate server response: &quot; + e);</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-      }</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-    }</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-    return func;</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-  },</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineminus">-  _overrideDefault: function MDBS__overrideDefault(aDefault, aData) {</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-    if (aData === undefined)</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineminus">-      return aDefault;</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-    for (let param in aDefault) {</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineminus">-      if (param in aData)</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-        aDefault[param] = aData[param];</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineminus">-    }</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineminus">-    return aDefault;</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineminus">-  },</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineminus">-</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineminus">-  _wireOAuth: function MDBS__wireOAuth() {</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineminus">-    let authFunc = this._noteAndReturnString(&quot;cloudfile:auth&quot;, &quot;&quot;,</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineminus">-                                             kAuthTokenString);</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineminus">-    this._server.registerPathHandler(kServerPath + kOAuthTokenPath,</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineminus">-                                     authFunc);</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-    this._server.registerPathHandler(kServerPath + kOAuthAccessTokenPath,</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-                                     authFunc);</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-    this._server.registerPathHandler(kAuthPath + kOAuthAuthorizePath,</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-                                     this._authHandler);</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineminus">-</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-    let logoutFunc = this._noteAndReturnString(&quot;cloudfile:logout&quot;, &quot;&quot;,</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineminus">-                                               &quot;Successfully logged out!&quot;);</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineminus">-    this._server.registerPathHandler(kLogoutPath, logoutFunc);</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineminus">-  },</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-  _authHandler: function MDBS__authHandler(meta, response) {</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineminus">-    response.setStatusLine(null, 302, &quot;Found&quot;);</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineminus">-    response.setHeader(&quot;Location&quot;, &quot;http://oauthcallback.local/&quot;,</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-                       false);</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-  },</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-}</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-function parseQueryString(str)</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-{</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  let paramArray = str.split(&quot;&amp;&quot;);</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineminus">-  let regex = /^([^=]+)=(.*)$/;</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineminus">-  let params = {};</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineminus">-  for (let i = 0; i &lt; paramArray.length; i++)</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineminus">-  {</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineminus">-    let match = regex.exec(paramArray[i]);</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineminus">-    if (!match)</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineminus">-      throw &quot;Bad parameter in queryString!  '&quot; + paramArray[i] + &quot;'&quot;;</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineminus">-    params[decodeURIComponent(match[1])] = decodeURIComponent(match[2]);</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineminus">-  }</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineminus">-</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineminus">-  return params;</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-ubuntuone-helpers.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -133,17 +133,17 @@ MockUbuntuOneServer.prototype = {</span>
<a href="#l18.4"></a><span id="l18.4">   },</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">   stop: function MU1S_stop(aController) {</span>
<a href="#l18.7"></a><span id="l18.7">     let allDone = false;</span>
<a href="#l18.8"></a><span id="l18.8">     this._server.stop(function() {</span>
<a href="#l18.9"></a><span id="l18.9">       allDone = true;</span>
<a href="#l18.10"></a><span id="l18.10">     });</span>
<a href="#l18.11"></a><span id="l18.11">     aController.waitFor(function () allDone,</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-                        &quot;Timed out waiting for Dropbox server to stop!&quot;,</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+                        &quot;Timed out waiting for UbuntuOne server to stop!&quot;,</span>
<a href="#l18.14"></a><span id="l18.14">                         10000);</span>
<a href="#l18.15"></a><span id="l18.15">   },</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17">   setupUser: function MU1S_wireUser(aData) {</span>
<a href="#l18.18"></a><span id="l18.18">     this._userInfo = this._overrideDefault(kDefaultUser, aData);</span>
<a href="#l18.19"></a><span id="l18.19">     this._server.registerPathHandler(kServerPath, this._getUserInfo.bind(this));</span>
<a href="#l18.20"></a><span id="l18.20">   },</span>
<a href="#l18.21"></a><span id="l18.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/themes/gnomestripe/jar.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/themes/gnomestripe/jar.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -250,11 +250,10 @@ classic.jar:</span>
<a href="#l19.4"></a><span id="l19.4">   skin/classic/messenger/newmailaccount/accountProvisioner.css          (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l19.5"></a><span id="l19.5">   skin/classic/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l19.6"></a><span id="l19.6">   skin/classic/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l19.7"></a><span id="l19.7">   skin/classic/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l19.8"></a><span id="l19.8">   skin/classic/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l19.9"></a><span id="l19.9">   skin/classic/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l19.10"></a><span id="l19.10">   skin/classic/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l19.11"></a><span id="l19.11">   skin/classic/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  skin/classic/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l19.13"></a><span id="l19.13">   skin/classic/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l19.14"></a><span id="l19.14">   skin/classic/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2">index 05503833f7114aa1c8efddebc944a35bc3dbb126..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l20.3"></a><span id="l20.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/themes/pinstripe/jar.mn</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/themes/pinstripe/jar.mn</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -295,11 +295,10 @@ classic.jar:</span>
<a href="#l21.4"></a><span id="l21.4">   skin/classic/messenger/newmailaccount/accountProvisioner.css          (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l21.5"></a><span id="l21.5">   skin/classic/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l21.6"></a><span id="l21.6">   skin/classic/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l21.7"></a><span id="l21.7">   skin/classic/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l21.8"></a><span id="l21.8">   skin/classic/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l21.9"></a><span id="l21.9">   skin/classic/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l21.10"></a><span id="l21.10">   skin/classic/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l21.11"></a><span id="l21.11">   skin/classic/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  skin/classic/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l21.13"></a><span id="l21.13">   skin/classic/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l21.14"></a><span id="l21.14">   skin/classic/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2">index 05503833f7114aa1c8efddebc944a35bc3dbb126..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l22.3"></a><span id="l22.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -258,17 +258,16 @@ classic.jar:</span>
<a href="#l23.4"></a><span id="l23.4">   skin/classic/messenger/newmailaccount/accountProvisioner.css          (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l23.5"></a><span id="l23.5">   skin/classic/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l23.6"></a><span id="l23.6">   skin/classic/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l23.7"></a><span id="l23.7">   skin/classic/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l23.8"></a><span id="l23.8">   skin/classic/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l23.9"></a><span id="l23.9">   skin/classic/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l23.10"></a><span id="l23.10">   skin/classic/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l23.11"></a><span id="l23.11">   skin/classic/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">- skin/classic/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l23.13"></a><span id="l23.13">  skin/classic/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l23.14"></a><span id="l23.14">  skin/classic/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span>
<a href="#l23.15"></a><span id="l23.15"> #ifdef XP_WIN</span>
<a href="#l23.16"></a><span id="l23.16"> % skin communicator classic/1.0 %skin/classic/aero/communicator/ os=WINNT osversion&gt;=6</span>
<a href="#l23.17"></a><span id="l23.17">   skin/classic/aero/communicator/communicator.css                       (mail/communicator.css)</span>
<a href="#l23.18"></a><span id="l23.18">   skin/classic/aero/communicator/smileys.css                            (mail/smileys.css)</span>
<a href="#l23.19"></a><span id="l23.19">   skin/classic/aero/communicator/icons/smileys/smiley-smile.png         (mail/icons/smiley-smile-aero.png)</span>
<a href="#l23.20"></a><span id="l23.20">   skin/classic/aero/communicator/icons/smileys/smiley-frown.png         (mail/icons/smiley-frown-aero.png)</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -511,12 +510,11 @@ classic.jar:</span>
<a href="#l23.22"></a><span id="l23.22">   skin/classic/aero/messenger/newmailaccount/accountProvisioner.css          (mail/newmailaccount/accountProvisioner-aero.css)</span>
<a href="#l23.23"></a><span id="l23.23">   skin/classic/aero/messenger/newmailaccount/search.gif                      (mail/newmailaccount/search.gif)</span>
<a href="#l23.24"></a><span id="l23.24">   skin/classic/aero/messenger/newmailaccount/spinner.gif                     (mail/newmailaccount/spinner.gif)</span>
<a href="#l23.25"></a><span id="l23.25">   skin/classic/aero/messenger/newmailaccount/success-addons.png              (mail/newmailaccount/success-addons.png)</span>
<a href="#l23.26"></a><span id="l23.26">   skin/classic/aero/messenger/newmailaccount/success-border.png              (mail/newmailaccount/success-border.png)</span>
<a href="#l23.27"></a><span id="l23.27">   skin/classic/aero/messenger/newmailaccount/success-compose.png             (mail/newmailaccount/success-compose.png)</span>
<a href="#l23.28"></a><span id="l23.28">   skin/classic/aero/messenger/newmailaccount/success-signature.png           (mail/newmailaccount/success-signature.png)</span>
<a href="#l23.29"></a><span id="l23.29">   skin/classic/aero/messenger/newmailaccount/search.png                      (mail/newmailaccount/search.png)</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-  skin/classic/aero/messenger/icons/dropbox.png                    (mail/icons/dropbox.png)</span>
<a href="#l23.31"></a><span id="l23.31">   skin/classic/aero/messenger/icons/ubuntuone.png                    (mail/icons/ubuntuone.png)</span>
<a href="#l23.32"></a><span id="l23.32">   skin/classic/aero/messenger/icons/yousendit.png                  (mail/icons/yousendit.png)</span>
<a href="#l23.33"></a><span id="l23.33"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2">index 05503833f7114aa1c8efddebc944a35bc3dbb126..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l24.3"></a><span id="l24.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

