<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22279:91eec4d4f89b73547050d1e6bfbde7e40c90ba4a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 91eec4d4f89b73547050d1e6bfbde7e40c90ba4a" />
<meta property="og:url" content="/comm-central/rev/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a" />
<meta property="og:description" content="Bug 1396897 - Don't use query parameters getter in sql related code. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 91eec4d4f89b73547050d1e6bfbde7e40c90ba4a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">shortlog</a> |
<a href="/comm-central/log/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">files</a> |
changeset |
<a href="/comm-central/raw-rev/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">raw</a>  | <a href="/comm-central/archive/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1396897">Bug 1396897</a> - Don't use query parameters getter in sql related code. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 06 Oct 2017 01:52:17 +0200</td></tr>

<tr>
 <td>changeset 22279</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">91eec4d4f89b73547050d1e6bfbde7e40c90ba4a</a></td>
</tr>



<tr>
<td>parent 22278</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/55159bf4efc9b3960577e5c6f55e334a061a3723">55159bf4efc9b3960577e5c6f55e334a061a3723</a>
</td>
</tr>

<tr>
<td>child 22280</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b">66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=91eec4d4f89b73547050d1e6bfbde7e40c90ba4a">13588</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 07 Oct 2017 07:10:38 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@66b336c0c7f7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b&newProject=comm-central&newRevision=91eec4d4f89b73547050d1e6bfbde7e40c90ba4a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b&newProject=comm-central&newRevision=91eec4d4f89b73547050d1e6bfbde7e40c90ba4a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=66b336c0c7f7165ed34ca5aecfe243acf2ba8f4b&newProject=comm-central&newRevision=91eec4d4f89b73547050d1e6bfbde7e40c90ba4a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1396897">1396897</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1392554">1392554</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1396897">Bug 1396897</a> - Don't use query parameters getter in sql related code. r=MakeMyDay

Over in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1392554">bug 1392554</a>, some internal changes to the sql statement parameters
implementation were made which removed the getters for the properties. They can
be set, but always return undefined if retrieved. This patch works around by
not using the parmeters, and also aligns the memory calendar behavior with the
storage calendar.

MozReview-Commit-ID: 8NGZY7BODgf</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/base/modules/calAsyncUtils.jsm">calendar/base/modules/calAsyncUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/base/modules/calAsyncUtils.jsm">file</a> |
<a href="/comm-central/annotate/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/base/modules/calAsyncUtils.jsm">annotate</a> |
<a href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/base/modules/calAsyncUtils.jsm">diff</a> |
<a href="/comm-central/comparison/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/base/modules/calAsyncUtils.jsm">comparison</a> |
<a href="/comm-central/log/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/base/modules/calAsyncUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_providers.js">calendar/test/unit/test_providers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_providers.js">file</a> |
<a href="/comm-central/annotate/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_providers.js">annotate</a> |
<a href="/comm-central/diff/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_providers.js">diff</a> |
<a href="/comm-central/comparison/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_providers.js">comparison</a> |
<a href="/comm-central/log/91eec4d4f89b73547050d1e6bfbde7e40c90ba4a/calendar/test/unit/test_providers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/calAsyncUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/calAsyncUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -19,23 +19,35 @@ var promisifyProxyHandler = {</span>
<a href="#l1.4"></a><span id="l1.4">         let deferred = PromiseUtils.defer();</span>
<a href="#l1.5"></a><span id="l1.5">         let listener = cal.async.promiseOperationListener(deferred);</span>
<a href="#l1.6"></a><span id="l1.6">         args.push(listener);</span>
<a href="#l1.7"></a><span id="l1.7">         target[name](...args);</span>
<a href="#l1.8"></a><span id="l1.8">         return deferred.promise;</span>
<a href="#l1.9"></a><span id="l1.9">     },</span>
<a href="#l1.10"></a><span id="l1.10">     get: function(target, name) {</span>
<a href="#l1.11"></a><span id="l1.11">         switch (name) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+            // calICalendar methods</span>
<a href="#l1.13"></a><span id="l1.13">             case &quot;adoptItem&quot;:</span>
<a href="#l1.14"></a><span id="l1.14">             case &quot;addItem&quot;:</span>
<a href="#l1.15"></a><span id="l1.15">             case &quot;modifyItem&quot;:</span>
<a href="#l1.16"></a><span id="l1.16">             case &quot;deleteItem&quot;:</span>
<a href="#l1.17"></a><span id="l1.17">             case &quot;getItem&quot;:</span>
<a href="#l1.18"></a><span id="l1.18">             case &quot;getItems&quot;:</span>
<a href="#l1.19"></a><span id="l1.19">                 return (...args) =&gt; this.promiseOperation(target, name, args);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+            // calIOfflineStorage methods</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+            case &quot;addOfflineItem&quot;:</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+            case &quot;modifyOfflineItem&quot;:</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+            case &quot;deleteOfflineItem&quot;:</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+            case &quot;getOfflineItemFlag&quot;:</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+            case &quot;resetItemOfflineFlag&quot;: {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+                let offline = target.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                return (...args) =&gt; this.promiseOperation(offline, name, args);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+            }</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+            // Special getAllItems shortcut</span>
<a href="#l1.31"></a><span id="l1.31">             case &quot;getAllItems&quot;:</span>
<a href="#l1.32"></a><span id="l1.32">                 return () =&gt; this.promiseOperation(target, &quot;getItems&quot;, [cIC.ITEM_FILTER_ALL_ITEMS, 0, null, null]);</span>
<a href="#l1.33"></a><span id="l1.33">             default:</span>
<a href="#l1.34"></a><span id="l1.34">                 return target[name];</span>
<a href="#l1.35"></a><span id="l1.35">         }</span>
<a href="#l1.36"></a><span id="l1.36">     }</span>
<a href="#l1.37"></a><span id="l1.37"> };</span>
<a href="#l1.38"></a><span id="l1.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -421,33 +421,56 @@ calMemoryCalendar.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">         aRangeEnd = cal.ensureDateTime(aRangeEnd);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">         let offline_filter = aItemFilter &amp;</span>
<a href="#l2.8"></a><span id="l2.8">             (calICalendar.ITEM_FILTER_OFFLINE_DELETED |</span>
<a href="#l2.9"></a><span id="l2.9">              calICalendar.ITEM_FILTER_OFFLINE_CREATED |</span>
<a href="#l2.10"></a><span id="l2.10">              calICalendar.ITEM_FILTER_OFFLINE_MODIFIED);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+        let requestedFlag = 0;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_CREATED) != 0) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+            requestedFlag = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+        } else if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_MODIFIED) != 0) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+            requestedFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+        } else if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_DELETED) != 0) {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            requestedFlag = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+        }</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+        let matchOffline = function(itemFlag, requestedFlag) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+            // Same as storage calendar sql query. For comparison:</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+            // requestedFlag is :offline_journal (parameter),</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+            // itemFlag is offline_journal (field value)</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+            // ...</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+            // AND (:offline_journal IS NULL</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+            // AND  (offline_journal IS NULL</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+            //  OR   offline_journal != ${cICL.OFFLINE_FLAG_DELETED_RECORD}))</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+            //  OR offline_journal == :offline_journal</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+            return (!requestedFlag &amp;&amp;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+                    (!itemFlag ||</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+                     itemFlag != cICL.OFFLINE_FLAG_DELETED_RECORD)) ||</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+                   itemFlag == requestedFlag;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+        };</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37">         cal.forEach(this.mItems, ([id, item]) =&gt; {</span>
<a href="#l2.38"></a><span id="l2.38">             let isEvent_ = cal.isEvent(item);</span>
<a href="#l2.39"></a><span id="l2.39">             if (isEvent_) {</span>
<a href="#l2.40"></a><span id="l2.40">                 if (!wantEvents) {</span>
<a href="#l2.41"></a><span id="l2.41">                     return cal.forEach.CONTINUE;</span>
<a href="#l2.42"></a><span id="l2.42">                 }</span>
<a href="#l2.43"></a><span id="l2.43">             } else if (!wantTodos) {</span>
<a href="#l2.44"></a><span id="l2.44">                 return cal.forEach.CONTINUE;</span>
<a href="#l2.45"></a><span id="l2.45">             }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">             let hasItemFlag = (item.id in this.mOfflineFlags);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-            let offlineFlag = (hasItemFlag ? this.mOfflineFlags[item.id] : null);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+            let itemFlag = (hasItemFlag ? this.mOfflineFlags[item.id] : 0);</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">             // If the offline flag doesn't match, skip the item</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-            if ((hasItemFlag ||</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-                    (offline_filter != 0 &amp;&amp; offlineFlag == cICL.OFFLINE_FLAG_DELETED_RECORD)) &amp;&amp;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                (offlineFlag != offline_filter)) {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+            if (!matchOffline(itemFlag, requestedFlag)) {</span>
<a href="#l2.56"></a><span id="l2.56">                 return cal.forEach.CONTINUE;</span>
<a href="#l2.57"></a><span id="l2.57">             }</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">             if (itemReturnOccurrences &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l2.60"></a><span id="l2.60">                 let startDate = aRangeStart;</span>
<a href="#l2.61"></a><span id="l2.61">                 if (!aRangeStart &amp;&amp; cal.isToDo(item)) {</span>
<a href="#l2.62"></a><span id="l2.62">                     startDate = item.entryDate;</span>
<a href="#l2.63"></a><span id="l2.63">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -804,35 +804,36 @@ calStorageCalendar.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">             return false;</span>
<a href="#l3.6"></a><span id="l3.6">         }</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">         // First fetch all the events</span>
<a href="#l3.9"></a><span id="l3.9">         if (wantEvents) {</span>
<a href="#l3.10"></a><span id="l3.10">             let params;             // stmt params</span>
<a href="#l3.11"></a><span id="l3.11">             let resultItems = [];</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+            let requestedOfflineJournal = null;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+            if (wantOfflineDeletedItems) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                requestedOfflineJournal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+            } else if (wantOfflineCreatedItems) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+                requestedOfflineJournal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+            } else if (wantOfflineModifiedItems) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                requestedOfflineJournal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+            }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">             // first get non-recurring events that happen to fall within the range</span>
<a href="#l3.23"></a><span id="l3.23">             //</span>
<a href="#l3.24"></a><span id="l3.24">             try {</span>
<a href="#l3.25"></a><span id="l3.25">                 this.prepareStatement(this.mSelectNonRecurringEventsByRange);</span>
<a href="#l3.26"></a><span id="l3.26">                 params = this.mSelectNonRecurringEventsByRange.params;</span>
<a href="#l3.27"></a><span id="l3.27">                 params.range_start = startTime;</span>
<a href="#l3.28"></a><span id="l3.28">                 params.range_end = endTime;</span>
<a href="#l3.29"></a><span id="l3.29">                 params.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l3.30"></a><span id="l3.30">                 params.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-                params.offline_journal = null;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                if (wantOfflineDeletedItems) {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                    params.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-                } else if (wantOfflineCreatedItems) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-                    params.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-                } else if (wantOfflineModifiedItems) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-                    params.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-                }</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+                params.offline_journal = requestedOfflineJournal;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">                 while (this.mSelectNonRecurringEventsByRange.executeStep()) {</span>
<a href="#l3.43"></a><span id="l3.43">                     let row = this.mSelectNonRecurringEventsByRange.row;</span>
<a href="#l3.44"></a><span id="l3.44">                     resultItems.push(this.getEventFromRow(row, {}));</span>
<a href="#l3.45"></a><span id="l3.45">                 }</span>
<a href="#l3.46"></a><span id="l3.46">             } catch (e) {</span>
<a href="#l3.47"></a><span id="l3.47">                 this.logError(&quot;Error selecting non recurring events by range!\n&quot;, e);</span>
<a href="#l3.48"></a><span id="l3.48">             } finally {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineat">@@ -845,52 +846,52 @@ calStorageCalendar.prototype = {</span>
<a href="#l3.50"></a><span id="l3.50">                 if (checkCount()) {</span>
<a href="#l3.51"></a><span id="l3.51">                     return;</span>
<a href="#l3.52"></a><span id="l3.52">                 }</span>
<a href="#l3.53"></a><span id="l3.53">             }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">             // Process the recurring events from the cache</span>
<a href="#l3.56"></a><span id="l3.56">             for (let id in this.mRecEventCache) {</span>
<a href="#l3.57"></a><span id="l3.57">                 let evitem = this.mRecEventCache[id];</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-                let offline_journal_flag = this.mRecEventCacheOfflineFlags[evitem.id] || null;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-                // No need to return flagged unless asked i.e. params.offline_journal == offline_journal_flag</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-                // Return created and modified offline records if params.offline_journal is null alongwith events that have no flag</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-                if ((params.offline_journal == null &amp;&amp; offline_journal_flag != cICL.OFFLINE_FLAG_DELETED_RECORD) ||</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-                    (params.offline_journal != null &amp;&amp; offline_journal_flag == params.offline_journal)) {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+                let cachedJournalFlag = this.mRecEventCacheOfflineFlags[evitem.id] || null;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+                // No need to return flagged unless asked i.e. requestedOfflineJournal == cachedJournalFlag</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+                // Return created and modified offline records if requestedOfflineJournal is null alongwith events that have no flag</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+                if ((requestedOfflineJournal == null &amp;&amp; cachedJournalFlag != cICL.OFFLINE_FLAG_DELETED_RECORD) ||</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+                    (requestedOfflineJournal != null &amp;&amp; cachedJournalFlag == requestedOfflineJournal)) {</span>
<a href="#l3.68"></a><span id="l3.68">                     count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l3.69"></a><span id="l3.69">                     if (checkCount()) {</span>
<a href="#l3.70"></a><span id="l3.70">                         return;</span>
<a href="#l3.71"></a><span id="l3.71">                     }</span>
<a href="#l3.72"></a><span id="l3.72">                 }</span>
<a href="#l3.73"></a><span id="l3.73">             }</span>
<a href="#l3.74"></a><span id="l3.74">         }</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">         // if todos are wanted, do them next</span>
<a href="#l3.77"></a><span id="l3.77">         if (wantTodos) {</span>
<a href="#l3.78"></a><span id="l3.78">             let params;             // stmt params</span>
<a href="#l3.79"></a><span id="l3.79">             let resultItems = [];</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+            let requestedOfflineJournal = null;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+            if (wantOfflineCreatedItems) {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+                requestedOfflineJournal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+            } else if (wantOfflineDeletedItems) {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+                requestedOfflineJournal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+            } else if (wantOfflineModifiedItems) {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+                requestedOfflineJournal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+            }</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">             // first get non-recurring todos that happen to fall within the range</span>
<a href="#l3.91"></a><span id="l3.91">             try {</span>
<a href="#l3.92"></a><span id="l3.92">                 this.prepareStatement(this.mSelectNonRecurringTodosByRange);</span>
<a href="#l3.93"></a><span id="l3.93">                 params = this.mSelectNonRecurringTodosByRange.params;</span>
<a href="#l3.94"></a><span id="l3.94">                 params.range_start = startTime;</span>
<a href="#l3.95"></a><span id="l3.95">                 params.range_end = endTime;</span>
<a href="#l3.96"></a><span id="l3.96">                 params.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l3.97"></a><span id="l3.97">                 params.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-                params.offline_journal = null;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-                if (wantOfflineCreatedItems) {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-                    params.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-                }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-                if (wantOfflineDeletedItems) {</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-                    params.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-                }</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-                if (wantOfflineModifiedItems) {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-                    params.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-                }</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                params.offline_journal = requestedOfflineJournal;</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">                 while (this.mSelectNonRecurringTodosByRange.executeStep()) {</span>
<a href="#l3.111"></a><span id="l3.111">                     let row = this.mSelectNonRecurringTodosByRange.row;</span>
<a href="#l3.112"></a><span id="l3.112">                     resultItems.push(this.getTodoFromRow(row, {}));</span>
<a href="#l3.113"></a><span id="l3.113">                 }</span>
<a href="#l3.114"></a><span id="l3.114">             } catch (e) {</span>
<a href="#l3.115"></a><span id="l3.115">                 this.logError(&quot;Error selecting non recurring todos by range&quot;, e);</span>
<a href="#l3.116"></a><span id="l3.116">             } finally {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineat">@@ -907,23 +908,23 @@ calStorageCalendar.prototype = {</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119">             // Note: Reading the code, completed *occurrences* seems to be broken, because</span>
<a href="#l3.120"></a><span id="l3.120">             //       only the parent item has been filtered; I fixed that.</span>
<a href="#l3.121"></a><span id="l3.121">             //       Moreover item.todo_complete etc seems to be a leftover...</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123">             // process the recurring todos from the cache</span>
<a href="#l3.124"></a><span id="l3.124">             for (let id in this.mRecTodoCache) {</span>
<a href="#l3.125"></a><span id="l3.125">                 let todoitem = this.mRecTodoCache[id];</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-                let offline_journal_flag = this.mRecTodoCacheOfflineFlags[todoitem.id] || null;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-                if ((params.offline_journal == null &amp;&amp;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-                     (offline_journal_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD ||</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-                      offline_journal_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-                      offline_journal_flag == null)) ||</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-                    (params.offline_journal != null &amp;&amp;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-                     (offline_journal_flag == params.offline_journal))) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                let cachedJournalFlag = this.mRecTodoCacheOfflineFlags[todoitem.id] || null;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+                if ((requestedOfflineJournal == null &amp;&amp;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+                     (cachedJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD ||</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                      cachedJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+                      cachedJournalFlag == null)) ||</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+                    (requestedOfflineJournal != null &amp;&amp;</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+                     (cachedJournalFlag == requestedOfflineJournal))) {</span>
<a href="#l3.140"></a><span id="l3.140">                     count += handleResultItem(todoitem,</span>
<a href="#l3.141"></a><span id="l3.141">                                               Components.interfaces.calITodo,</span>
<a href="#l3.142"></a><span id="l3.142">                                               checkCompleted);</span>
<a href="#l3.143"></a><span id="l3.143">                     if (checkCount()) {</span>
<a href="#l3.144"></a><span id="l3.144">                         return;</span>
<a href="#l3.145"></a><span id="l3.145">                     }</span>
<a href="#l3.146"></a><span id="l3.146">                 }</span>
<a href="#l3.147"></a><span id="l3.147">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1175,21 +1175,20 @@ add_task(function* test_recurring_except</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">     let ex = items[0].recurrenceInfo.getExceptionFor(exIds[0]);</span>
<a href="#l4.6"></a><span id="l4.6">     equal(ex.title, &quot;New Event changed&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">     client.refresh();</span>
<a href="#l4.9"></a><span id="l4.9">     yield gServer.waitForLoad(client);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">     items = yield pclient.getAllItems();</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    // Disabled for bug 1393704: Failed on the next line with 0 == 1:</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    // equal(items.length, 1);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    equal(items.length, 1);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    // exIds = items[0].recurrenceInfo.getExceptionIds({});</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    // equal(exIds.length, 0);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    exIds = items[0].recurrenceInfo.getExceptionIds({});</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    equal(exIds.length, 0);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">     gServer.resetClient(client);</span>
<a href="#l4.22"></a><span id="l4.22"> });</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> add_task(function* test_recurring_cancelled_exception() {</span>
<a href="#l4.25"></a><span id="l4.25">     gServer.syncs = [{</span>
<a href="#l4.26"></a><span id="l4.26">         token: &quot;1&quot;,</span>
<a href="#l4.27"></a><span id="l4.27">         events: [{</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/test/unit/test_providers.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/test/unit/test_providers.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,12 +1,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAsyncUtils.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+const cIC = Components.interfaces.calICalendar;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12"> var icalStringArray = [</span>
<a href="#l5.13"></a><span id="l5.13">     // Comments refer to the range defined in testGetItems().</span>
<a href="#l5.14"></a><span id="l5.14">     // 1: one-hour event</span>
<a href="#l5.15"></a><span id="l5.15">     &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l5.16"></a><span id="l5.16">     &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l5.17"></a><span id="l5.17">     &quot;DTEND:20020402T124500Z\n&quot; +</span>
<a href="#l5.18"></a><span id="l5.18">     &quot;END:VEVENT\n&quot;,</span>
<a href="#l5.19"></a><span id="l5.19">     // 2: Test a zero-length event with DTSTART and DTEND</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineat">@@ -189,16 +193,23 @@ var icalStringArray = [</span>
<a href="#l5.21"></a><span id="l5.21">     // 36: one-day event with duration (after the range). See bug 390492.</span>
<a href="#l5.22"></a><span id="l5.22">     &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l5.23"></a><span id="l5.23">     &quot;DTSTART:20020403T000000Z\n&quot; +</span>
<a href="#l5.24"></a><span id="l5.24">     &quot;DURATION:P1D\n&quot; +</span>
<a href="#l5.25"></a><span id="l5.25">     &quot;END:VEVENT\n&quot;</span>
<a href="#l5.26"></a><span id="l5.26"> ];</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28"> function run_test() {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    testIcalData();</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    testMetaData();</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    run_next_test();</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+}</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+function testIcalData() {</span>
<a href="#l5.36"></a><span id="l5.36">     // First entry is test number, second item is expected result for testGetItems().</span>
<a href="#l5.37"></a><span id="l5.37">     let wantedArray = [[1, 1],</span>
<a href="#l5.38"></a><span id="l5.38">                        [2, 1],</span>
<a href="#l5.39"></a><span id="l5.39">                        [3, 1],</span>
<a href="#l5.40"></a><span id="l5.40">                        [5, 0],</span>
<a href="#l5.41"></a><span id="l5.41">                        [6, 1],</span>
<a href="#l5.42"></a><span id="l5.42">                        [7, 1],</span>
<a href="#l5.43"></a><span id="l5.43">                        [8, 0],</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineat">@@ -351,18 +362,16 @@ function run_test() {</span>
<a href="#l5.45"></a><span id="l5.45">                         returnedItem = aItems[0];</span>
<a href="#l5.46"></a><span id="l5.46">                     }</span>
<a href="#l5.47"></a><span id="l5.47">                 }</span>
<a href="#l5.48"></a><span id="l5.48">             };</span>
<a href="#l5.49"></a><span id="l5.49">             // add item to calendar</span>
<a href="#l5.50"></a><span id="l5.50">             calendar.addItem(aItem, listener);</span>
<a href="#l5.51"></a><span id="l5.51">         }</span>
<a href="#l5.52"></a><span id="l5.52">     }</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-    testMetaData();</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57"> function testMetaData() {</span>
<a href="#l5.58"></a><span id="l5.58">     function testMetaData_(aCalendar) {</span>
<a href="#l5.59"></a><span id="l5.59">         dump(&quot;testMetaData_() calendar type: &quot; + aCalendar.type + &quot;\n&quot;);</span>
<a href="#l5.60"></a><span id="l5.60">         let event1 = createEventFromIcalString(&quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l5.61"></a><span id="l5.61">                                                &quot;DTSTART;VALUE=DATE:20020402\n&quot; +</span>
<a href="#l5.62"></a><span id="l5.62">                                                &quot;END:VEVENT\n&quot;);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineat">@@ -412,8 +421,91 @@ function testMetaData() {</span>
<a href="#l5.64"></a><span id="l5.64">         equal(count.value, 0);</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">         aCalendar.deleteMetaData(&quot;unknown&quot;); // check graceful return</span>
<a href="#l5.67"></a><span id="l5.67">     }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">     testMetaData_(getMemoryCal());</span>
<a href="#l5.70"></a><span id="l5.70">     testMetaData_(getStorageCal());</span>
<a href="#l5.71"></a><span id="l5.71"> }</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+async function testOfflineStorage(storageGetter, isRecurring) {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+    let storage = storageGetter();</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    print(`Running offline storage test for ${storage.type} calendar for ${isRecurring ? &quot;recurring&quot; : &quot;normal&quot;} item`);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+    let pcal = cal.async.promisifyCalendar(storage);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+    let event1 = createEventFromIcalString(&quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+                                           &quot;DTSTART;VALUE=DATE:20020402\n&quot; +</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+                                           &quot;DTEND;VALUE=DATE:20020403\n&quot; +</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+                                           &quot;SUMMARY:event1\n&quot; +</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+                                           (isRecurring ? &quot;RRULE:FREQ=DAILY;INTERVAL=1;COUNT=10\n&quot; : &quot;&quot;) +</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+                                           &quot;END:VEVENT\n&quot;);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+    event1 = await pcal.addItem(event1);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+    // Make sure the event is really in the calendar</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+    let result = await pcal.getAllItems();</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+    equal(result.length, 1);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+    // When searching for offline added items, there are none</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+    let filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+    equal(result.length, 0);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    // Mark the item as offline added</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+    await pcal.addOfflineItem(event1);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    // Now there should be an offline item</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    equal(result.length, 1);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+    let event2 = event1.clone();</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    event2.title = &quot;event2&quot;;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    event2 = await pcal.modifyItem(event2, event1);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    await pcal.modifyOfflineItem(event2);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+    // The flag should still be offline added, as it was already marked as such</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    equal(result.length, 1);</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+    // Reset the flag</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+    await pcal.resetItemOfflineFlag(event2);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+    // No more offline items after resetting the flag</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+    equal(result.length, 0);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    // Setting modify flag without one set should actually set that flag</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+    await pcal.modifyOfflineItem(event2);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+    equal(result.length, 0);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+    equal(result.length, 1);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+    // Setting the delete flag should modify the flag accordingly</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+    await pcal.deleteOfflineItem(event2);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    equal(result.length, 0);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+    filter = cIC.ITEM_FILTER_ALL_ITEMS | cIC.ITEM_FILTER_OFFLINE_DELETED;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+    result = await pcal.getItems(filter, 0, null, null);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+    equal(result.length, 1);</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    // Setting the delete flag on an offline added item should remove it</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+    await pcal.resetItemOfflineFlag(event2);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    await pcal.addOfflineItem(event2);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+    await pcal.deleteOfflineItem(event2);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+    result = await pcal.getAllItems();</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    equal(result.length, 0);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+}</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+add_task(testOfflineStorage.bind(null, () =&gt; getMemoryCal(), false));</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+add_task(testOfflineStorage.bind(null, () =&gt; getStorageCal(), false));</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+add_task(testOfflineStorage.bind(null, () =&gt; getMemoryCal(), true));</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+add_task(testOfflineStorage.bind(null, () =&gt; getStorageCal(), true));</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

