<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3897:c41b9cf09178bce40edea89a3fa205e4d7dd483d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c41b9cf09178bce40edea89a3fa205e4d7dd483d" />
<meta property="og:url" content="/comm-central/rev/c41b9cf09178bce40edea89a3fa205e4d7dd483d" />
<meta property="og:description" content="Bug 311774 - Newsgroup unread counts don't reflect filter actions. r=Neil sr=bienvenu a-sm=KaiRo a-tb=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c41b9cf09178bce40edea89a3fa205e4d7dd483d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c41b9cf09178bce40edea89a3fa205e4d7dd483d">shortlog</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c41b9cf09178bce40edea89a3fa205e4d7dd483d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d">files</a> |
changeset |
<a href="/comm-central/raw-rev/c41b9cf09178bce40edea89a3fa205e4d7dd483d">raw</a>  | <a href="/comm-central/archive/c41b9cf09178bce40edea89a3fa205e4d7dd483d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=311774">Bug 311774</a> - Newsgroup unread counts don't reflect filter actions. r=Neil sr=bienvenu a-sm=KaiRo a-tb=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 23 Sep 2009 15:39:47 -0400</td></tr>

<tr>
 <td>changeset 3897</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c41b9cf09178bce40edea89a3fa205e4d7dd483d">c41b9cf09178bce40edea89a3fa205e4d7dd483d</a></td>
</tr>



<tr>
<td>parent 3896</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/765e1e92f04e62aae0d439033f365517dd81d3c3">765e1e92f04e62aae0d439033f365517dd81d3c3</a>
</td>
</tr>

<tr>
<td>child 3898</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1604ff108a8ffe74eb9e2f84cf70b00d2ce45b4d">1604ff108a8ffe74eb9e2f84cf70b00d2ce45b4d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c41b9cf09178bce40edea89a3fa205e4d7dd483d">3045</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 24 Sep 2009 11:38:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c41b9cf09178 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c41b9cf09178bce40edea89a3fa205e4d7dd483d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&newProject=comm-central&newRevision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&newProject=comm-central&newRevision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&newProject=comm-central&newRevision=c41b9cf09178bce40edea89a3fa205e4d7dd483d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=311774">311774</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=311774">Bug 311774</a> - Newsgroup unread counts don't reflect filter actions. r=Neil sr=bienvenu a-sm=KaiRo a-tb=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mail/locales/en-US/chrome/messenger/news.properties">mail/locales/en-US/chrome/messenger/news.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mail/locales/en-US/chrome/messenger/news.properties">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mail/locales/en-US/chrome/messenger/news.properties">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mail/locales/en-US/chrome/messenger/news.properties">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mail/locales/en-US/chrome/messenger/news.properties">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mail/locales/en-US/chrome/messenger/news.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsIMsgNewsFolder.idl">mailnews/news/public/nsIMsgNewsFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsIMsgNewsFolder.idl">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsIMsgNewsFolder.idl">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsIMsgNewsFolder.idl">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsIMsgNewsFolder.idl">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsIMsgNewsFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpIncomingServer.idl">mailnews/news/public/nsINntpIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpService.idl">mailnews/news/public/nsINntpService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpService.idl">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpService.idl">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpService.idl">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpService.idl">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/public/nsINntpService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.h">mailnews/news/src/nsNNTPProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.h">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.h">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.h">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.h">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNNTPProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.h">mailnews/news/src/nsNntpIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.h">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.h">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_biff.js">mailnews/news/test/unit/test_biff.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_biff.js">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_biff.js">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_biff.js">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_biff.js">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_biff.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_filter.js">mailnews/news/test/unit/test_filter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_filter.js">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_filter.js">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_filter.js">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_filter.js">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_filter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_server.js">mailnews/news/test/unit/test_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_server.js">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_server.js">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_server.js">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_server.js">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/news/test/unit/test_server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/test/resources/filterTestUtils.js">mailnews/test/resources/filterTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/test/resources/filterTestUtils.js">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/test/resources/filterTestUtils.js">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/test/resources/filterTestUtils.js">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/test/resources/filterTestUtils.js">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/mailnews/test/resources/filterTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/suite/locales/en-US/chrome/mailnews/news.properties">suite/locales/en-US/chrome/mailnews/news.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c41b9cf09178bce40edea89a3fa205e4d7dd483d/suite/locales/en-US/chrome/mailnews/news.properties">file</a> |
<a href="/comm-central/annotate/c41b9cf09178bce40edea89a3fa205e4d7dd483d/suite/locales/en-US/chrome/mailnews/news.properties">annotate</a> |
<a href="/comm-central/diff/c41b9cf09178bce40edea89a3fa205e4d7dd483d/suite/locales/en-US/chrome/mailnews/news.properties">diff</a> |
<a href="/comm-central/comparison/c41b9cf09178bce40edea89a3fa205e4d7dd483d/suite/locales/en-US/chrome/mailnews/news.properties">comparison</a> |
<a href="/comm-central/log/c41b9cf09178bce40edea89a3fa205e4d7dd483d/suite/locales/en-US/chrome/mailnews/news.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/news.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/news.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -49,21 +49,20 @@ messageCancelled=Message cancelled.</span>
<a href="#l1.4"></a><span id="l1.4"> enterUsername=Please enter a username for news server access:</span>
<a href="#l1.5"></a><span id="l1.5"> enterUsernameTitle=News Server Username Required</span>
<a href="#l1.6"></a><span id="l1.6"> saveUsername=Use Password Manager to remember this value.</span>
<a href="#l1.7"></a><span id="l1.7"> enterPassword=Please enter a password for news server access:</span>
<a href="#l1.8"></a><span id="l1.8"> enterPasswordTitle=News Server Password Required</span>
<a href="#l1.9"></a><span id="l1.9"> okButtonText=Download</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> noNewMessages=There are no new messages on the server.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-downloadingHeaders=Downloading %S of %S headers</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-downloadingFilterHeaders=Getting headers for filters: %S (%S/%S)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+newNewsgroupHeaders=Downloading %S of %S headers for %S</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+newNewsgroupFilteringHeaders=Getting headers for filters: %S (%S/%S) on %S</span>
<a href="#l1.16"></a><span id="l1.16"> downloadingArticles=Downloading articles %S-%S</span>
<a href="#l1.17"></a><span id="l1.17"> bytesReceived=Downloading newsgroups: %S received (%SKB read at %SKB/sec)</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-checkingForNewNews=Checking newsgroup %S of %S on %S for new messages</span>
<a href="#l1.19"></a><span id="l1.19"> downloadingArticlesForOffline=Downloading articles %S-%S in %S</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> onlyCancelOneMessage=You can only cancel one article at a time.</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> # LOCALIZATION NOTE (autoUnsubscribeText): %1$S is the newsgroup and %2$S is the newsgroup-server it is being removed from.</span>
<a href="#l1.24"></a><span id="l1.24"> autoUnsubscribeText=The newsgroup %1$S does not appear to exist on the host %2$S.  Would you like to unsubscribe from it?</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> # LOCALIZATION NOTE (autoSubscribeText): %1$S is the newsgroup.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/news/public/nsIMsgNewsFolder.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/news/public/nsIMsgNewsFolder.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,17 +42,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> %}</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> interface nsIMsgWindow;</span>
<a href="#l2.8"></a><span id="l2.8"> interface nsINntpIncomingServer;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> [ref] native nsMsgKeyArrayRef(nsTArray&lt;nsMsgKey&gt;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(7fe8c961-3fce-41e2-aa49-9ea3bc332d40)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(e56a2366-e66c-4240-a9a1-48c4a0a9ffbc)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgNewsFolder : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15">   attribute ACString groupUsername;</span>
<a href="#l2.16"></a><span id="l2.16">   attribute ACString groupPassword;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   readonly attribute AString unicodeName;</span>
<a href="#l2.19"></a><span id="l2.19">   /**|rawName| is an 8-bit string to represent the name of a newsgroup used by </span>
<a href="#l2.20"></a><span id="l2.20">    * a news server. It's offered for the convenience of callers so that they </span>
<a href="#l2.21"></a><span id="l2.21">    * don't have to convert |unicodeName| to the server-side name when </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -89,9 +89,16 @@ interface nsIMsgNewsFolder : nsISupports</span>
<a href="#l2.23"></a><span id="l2.23">   void cancelComplete();</span>
<a href="#l2.24"></a><span id="l2.24">   void cancelFailed();</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   ACString getMessageIdForKey(in nsMsgKey key);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   void getNextNMessages(in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.29"></a><span id="l2.29">   void notifyDownloadedLine(in string line, in nsMsgKey key);</span>
<a href="#l2.30"></a><span id="l2.30">   void notifyFinishedDownloadinghdrs();</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  /**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * Retrieves the database, but does not cache it in mDatabase.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   *</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   * This is useful for operations that shouldn't hold open the database.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  nsIMsgDatabase getDatabaseWithoutCache();</span>
<a href="#l2.38"></a><span id="l2.38"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/news/public/nsINntpIncomingServer.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/news/public/nsINntpIncomingServer.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> interface nsILocalFile;</span>
<a href="#l3.5"></a><span id="l3.5"> interface nsIMsgNewsFolder;</span>
<a href="#l3.6"></a><span id="l3.6"> interface nsINNTPProtocol;</span>
<a href="#l3.7"></a><span id="l3.7"> interface nsNNTPProtocol;</span>
<a href="#l3.8"></a><span id="l3.8"> interface nsIChannel;</span>
<a href="#l3.9"></a><span id="l3.9"> interface nsIURI;</span>
<a href="#l3.10"></a><span id="l3.10"> interface nsIMsgWindow;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(113e9e21-3313-4e73-83f1-0d675251b607)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(720a808c-17b5-4a96-837f-494541db15f2)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsINntpIncomingServer : nsISupports {</span>
<a href="#l3.15"></a><span id="l3.15">     /* the on-disk path to the newsrc file for this server */</span>
<a href="#l3.16"></a><span id="l3.16">     attribute nsILocalFile newsrcFilePath;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     /* the newsrc root path (the directories all the newsrc files live) */</span>
<a href="#l3.19"></a><span id="l3.19">     attribute nsILocalFile newsrcRootPath;</span>
<a href="#l3.20"></a><span id="l3.20">     </span>
<a href="#l3.21"></a><span id="l3.21">     /* ask the user before downloading more than maxArticles? */</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -87,19 +87,16 @@ interface nsINntpIncomingServer : nsISup</span>
<a href="#l3.23"></a><span id="l3.23">      *</span>
<a href="#l3.24"></a><span id="l3.24">      * This preference (internally max_cached_connections) controls how many</span>
<a href="#l3.25"></a><span id="l3.25">      * connections we can make. A negative connection count is treated as only</span>
<a href="#l3.26"></a><span id="l3.26">      * one connection, while 0 (the default) loads the default number of</span>
<a href="#l3.27"></a><span id="l3.27">      * connections, presently 2.</span>
<a href="#l3.28"></a><span id="l3.28">      */</span>
<a href="#l3.29"></a><span id="l3.29">     attribute long maximumConnectionsNumber;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    readonly attribute long numGroupsNeedingCounts;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    readonly attribute nsISupports firstGroupNeedingCounts;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-</span>
<a href="#l3.34"></a><span id="l3.34">     void displaySubscribedGroup(in nsIMsgNewsFolder msgFolder,</span>
<a href="#l3.35"></a><span id="l3.35">                                 in long firstMessage, in long lastMessage,</span>
<a href="#l3.36"></a><span id="l3.36">                                 in long totalMessages);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39">     /**</span>
<a href="#l3.40"></a><span id="l3.40">      * Get a new NNTP channel to run the URI.</span>
<a href="#l3.41"></a><span id="l3.41">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/news/public/nsINntpService.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/news/public/nsINntpService.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -44,17 +44,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> interface nsIURI;</span>
<a href="#l4.6"></a><span id="l4.6"> interface nsIStreamListener;  </span>
<a href="#l4.7"></a><span id="l4.7"> interface nsIFile;</span>
<a href="#l4.8"></a><span id="l4.8"> interface nsIMsgWindow;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIMsgFolder;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsICacheSession;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(ecd8087f-f71a-4d44-a285-4caacd57f217)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(dc5cadb0-966c-4ef1-a4c8-cc1e48d1ac61)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsINntpService : nsISupports {</span>
<a href="#l4.15"></a><span id="l4.15">   </span>
<a href="#l4.16"></a><span id="l4.16">   /* newsgroupsList is a comma separated list of newsgroups, which may be</span>
<a href="#l4.17"></a><span id="l4.17">    * in news://host/group or group form</span>
<a href="#l4.18"></a><span id="l4.18">    * &quot;news://host/group1,news://host/group2&quot; or &quot;group1,group2&quot;</span>
<a href="#l4.19"></a><span id="l4.19">    *</span>
<a href="#l4.20"></a><span id="l4.20">    * newsgroupsHeaderVal is a comma separated list of groups in the group form</span>
<a href="#l4.21"></a><span id="l4.21">    * &quot;group1,group2&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -67,18 +67,16 @@ interface nsINntpService : nsISupports {</span>
<a href="#l4.23"></a><span id="l4.23">   nsIURI postMessage(in nsIFile aFileToPost, in string newsgroupNames, in string aAccountKey, in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   nsIURI getNewNews(in nsINntpIncomingServer nntpServer, in string uri, in boolean getOld, in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   nsIURI cancelMessage(in string cancelURL, in string messageURI, in nsISupports aConsumer, in nsIUrlListener aUrlListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.28"></a><span id="l4.28">  </span>
<a href="#l4.29"></a><span id="l4.29">   void getListOfGroupsOnServer(in nsINntpIncomingServer nntpServer, in nsIMsgWindow aMsgWindow, in boolean getOnlyNew);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  void updateCounts(in nsINntpIncomingServer nntpServer, in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33">   nsIURI fetchMessage(in nsIMsgFolder newsFolder, in nsMsgKey key, in nsIMsgWindow aMsgWindow, in nsISupports aConsumer, in nsIUrlListener aUrlListener);</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   void downloadNewsgroupsForOffline(in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l4.36"></a><span id="l4.36">   /** </span>
<a href="#l4.37"></a><span id="l4.37">    * can handle news-message:// and news:// </span>
<a href="#l4.38"></a><span id="l4.38">    */</span>
<a href="#l4.39"></a><span id="l4.39">   void decomposeNewsURI(in string uri, out nsIMsgFolder folder, out nsMsgKey key);</span>
<a href="#l4.40"></a><span id="l4.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -125,17 +125,18 @@ NS_IMPL_ISUPPORTS2(nsNNTPNewsgroupList, </span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> nsresult</span>
<a href="#l5.6"></a><span id="l5.6"> nsNNTPNewsgroupList::Initialize(nsINntpUrl *runningURL, nsIMsgNewsFolder *newsFolder)</span>
<a href="#l5.7"></a><span id="l5.7"> {</span>
<a href="#l5.8"></a><span id="l5.8">   m_newsFolder = newsFolder;</span>
<a href="#l5.9"></a><span id="l5.9">   m_runningURL = runningURL;</span>
<a href="#l5.10"></a><span id="l5.10">   m_knownArts.set = nsMsgKeySet::Create();</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsresult rv;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  nsresult rv = m_newsFolder-&gt;GetDatabaseWithoutCache(getter_AddRefs(m_newsDB));</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.17"></a><span id="l5.17">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   rv = folder-&gt;GetFilterList(m_msgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l5.20"></a><span id="l5.20">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.21"></a><span id="l5.21">   nsCString ngHeaders;</span>
<a href="#l5.22"></a><span id="l5.22">   m_filterList-&gt;GetArbitraryHeaders(ngHeaders);</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -290,19 +291,16 @@ nsNNTPNewsgroupList::GetRangeOfArtsToDow</span>
<a href="#l5.24"></a><span id="l5.24">   NS_ENSURE_ARG_POINTER(status);</span>
<a href="#l5.25"></a><span id="l5.25">   *first = 0;</span>
<a href="#l5.26"></a><span id="l5.26">   *last = 0;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l5.29"></a><span id="l5.29">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.30"></a><span id="l5.30">   m_msgWindow = aMsgWindow;</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  if (!m_newsDB)</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    rv = folder-&gt;GetMsgDatabase(getter_AddRefs(m_newsDB));</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-</span>
<a href="#l5.35"></a><span id="l5.35">   nsCOMPtr&lt;nsINewsDatabase&gt; db(do_QueryInterface(m_newsDB, &amp;rv));</span>
<a href="#l5.36"></a><span id="l5.36">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   rv = db-&gt;GetReadSet(&amp;m_set);</span>
<a href="#l5.39"></a><span id="l5.39">   if (NS_FAILED(rv) || !m_set)</span>
<a href="#l5.40"></a><span id="l5.40">     return rv;</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">   m_set-&gt;SetLastMember(last_possible); // make sure highwater mark is valid.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineat">@@ -1271,41 +1269,45 @@ nsNNTPNewsgroupList::UpdateStatus(PRBool</span>
<a href="#l5.44"></a><span id="l5.44">   PRInt32 percent = numerator * 100 / denominator;</span>
<a href="#l5.45"></a><span id="l5.45">   </span>
<a href="#l5.46"></a><span id="l5.46">   nsAutoString numDownloadedStr;</span>
<a href="#l5.47"></a><span id="l5.47">   numDownloadedStr.AppendInt(numDLed);</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">   nsAutoString totalToDownloadStr;</span>
<a href="#l5.50"></a><span id="l5.50">   totalToDownloadStr.AppendInt(totToDL);</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-  nsresult rv;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+  nsAutoString newsgroupName;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  nsresult rv = m_newsFolder-&gt;GetUnicodeName(newsgroupName);</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      return;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+</span>
<a href="#l5.58"></a><span id="l5.58">   nsString statusString;</span>
<a href="#l5.59"></a><span id="l5.59">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l5.60"></a><span id="l5.60">   if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.61"></a><span id="l5.61">     return;</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.64"></a><span id="l5.64">   rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l5.65"></a><span id="l5.65">   if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.66"></a><span id="l5.66">     return;</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   if (filtering)</span>
<a href="#l5.69"></a><span id="l5.69">   {</span>
<a href="#l5.70"></a><span id="l5.70">     NS_ConvertUTF8toUTF16 header(m_filterHeaders[m_currentXHDRIndex]);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    const PRUnichar *formatStrings[3] = { header.get(),</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-      numDownloadedStr.get(), totalToDownloadStr.get() };</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;downloadingFilterHeaders&quot;).get(),</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-      formatStrings, 3, getter_Copies(statusString));</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    const PRUnichar *formatStrings[4] = { header.get(),</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      numDownloadedStr.get(), totalToDownloadStr.get(), newsgroupName.get() };</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;newNewsgroupFilteringHeaders&quot;).get(),</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      formatStrings, 4, getter_Copies(statusString));</span>
<a href="#l5.79"></a><span id="l5.79">   }</span>
<a href="#l5.80"></a><span id="l5.80">   else</span>
<a href="#l5.81"></a><span id="l5.81">   {</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-    const PRUnichar *formatStrings[2] = { numDownloadedStr.get(),</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-      totalToDownloadStr.get() };</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;downloadingHeaders&quot;).get(),</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-      formatStrings, 2, getter_Copies(statusString));</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+    const PRUnichar *formatStrings[3] = { numDownloadedStr.get(),</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+      totalToDownloadStr.get(), newsgroupName.get() };</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;newNewsgroupHeaders&quot;).get(),</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+      formatStrings, 3, getter_Copies(statusString));</span>
<a href="#l5.90"></a><span id="l5.90">   }</span>
<a href="#l5.91"></a><span id="l5.91">   if (!NS_SUCCEEDED(rv))</span>
<a href="#l5.92"></a><span id="l5.92">     return;</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94">   SetProgressStatus(statusString.get());</span>
<a href="#l5.95"></a><span id="l5.95">   m_lastStatusUpdate = PR_Now();</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97">   // only update the progress meter if it has changed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -215,19 +215,16 @@ const char *const stateLabels[] = {</span>
<a href="#l6.4"></a><span id="l6.4"> &quot;NNTP_PROFILE_DELETE&quot;,</span>
<a href="#l6.5"></a><span id="l6.5"> &quot;NNTP_PROFILE_DELETE_RESPONSE&quot;,</span>
<a href="#l6.6"></a><span id="l6.6"> &quot;NNTP_SEND_ARTICLE_NUMBER&quot;,</span>
<a href="#l6.7"></a><span id="l6.7"> &quot;NEWS_PROCESS_BODIES&quot;,</span>
<a href="#l6.8"></a><span id="l6.8"> &quot;NNTP_PRINT_ARTICLE_HEADERS&quot;,</span>
<a href="#l6.9"></a><span id="l6.9"> &quot;NNTP_SEND_POST_DATA&quot;,</span>
<a href="#l6.10"></a><span id="l6.10"> &quot;NNTP_SEND_POST_DATA_RESPONSE&quot;,</span>
<a href="#l6.11"></a><span id="l6.11"> &quot;NNTP_CHECK_FOR_MESSAGE&quot;,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-&quot;NEWS_NEWS_RC_POST&quot;,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-&quot;NEWS_DISPLAY_NEWS_RC&quot;,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-&quot;NEWS_DISPLAY_NEWS_RC_RESPONSE&quot;,</span>
<a href="#l6.15"></a><span id="l6.15"> &quot;NEWS_START_CANCEL&quot;,</span>
<a href="#l6.16"></a><span id="l6.16"> &quot;NEWS_DO_CANCEL&quot;,</span>
<a href="#l6.17"></a><span id="l6.17"> &quot;NNTP_XPAT_SEND&quot;,</span>
<a href="#l6.18"></a><span id="l6.18"> &quot;NNTP_XPAT_RESPONSE&quot;,</span>
<a href="#l6.19"></a><span id="l6.19"> &quot;NNTP_SEARCH&quot;,</span>
<a href="#l6.20"></a><span id="l6.20"> &quot;NNTP_SEARCH_RESPONSE&quot;,</span>
<a href="#l6.21"></a><span id="l6.21"> &quot;NNTP_SEARCH_RESULTS&quot;,</span>
<a href="#l6.22"></a><span id="l6.22"> &quot;NNTP_LIST_PRETTY_NAMES&quot;,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -249,17 +246,16 @@ const char *const stateLabels[] = {</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> /* Forward declarations */</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> #define LIST_WANTED     0</span>
<a href="#l6.28"></a><span id="l6.28"> #define ARTICLE_WANTED  1</span>
<a href="#l6.29"></a><span id="l6.29"> #define CANCEL_WANTED   2</span>
<a href="#l6.30"></a><span id="l6.30"> #define GROUP_WANTED    3</span>
<a href="#l6.31"></a><span id="l6.31"> #define NEWS_POST       4</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-#define READ_NEWS_RC    5</span>
<a href="#l6.33"></a><span id="l6.33"> #define NEW_GROUPS      6</span>
<a href="#l6.34"></a><span id="l6.34"> #define SEARCH_WANTED   7</span>
<a href="#l6.35"></a><span id="l6.35"> #define PRETTY_NAMES_WANTED 8</span>
<a href="#l6.36"></a><span id="l6.36"> #define PROFILE_WANTED  9</span>
<a href="#l6.37"></a><span id="l6.37"> #define IDS_WANTED    10</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39"> /* the output_buffer_size must be larger than the largest possible line</span>
<a href="#l6.40"></a><span id="l6.40">  * 2000 seems good for news</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -547,20 +543,16 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">   m_firstArticle = 0;</span>
<a href="#l6.44"></a><span id="l6.44">   m_lastArticle = 0;</span>
<a href="#l6.45"></a><span id="l6.45">   m_firstPossibleArticle = 0;</span>
<a href="#l6.46"></a><span id="l6.46">   m_lastPossibleArticle = 0;</span>
<a href="#l6.47"></a><span id="l6.47">   m_numArticlesLoaded = 0;</span>
<a href="#l6.48"></a><span id="l6.48">   m_numArticlesWanted = 0;</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  m_newsRCListIndex = 0;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  m_RCIndexToResumeAfterAuthRequest  = 0;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  m_newsRCListCount = 0;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-</span>
<a href="#l6.54"></a><span id="l6.54">   PR_FREEIF(m_messageID);</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   m_key = nsMsgKey_None;</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">   m_articleNumber = 0;</span>
<a href="#l6.59"></a><span id="l6.59">   m_originalContentLength = 0;</span>
<a href="#l6.60"></a><span id="l6.60">   m_cancelID = nsnull;</span>
<a href="#l6.61"></a><span id="l6.61">   m_cancelFromHdr = nsnull;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineat">@@ -1198,18 +1190,21 @@ nsresult nsNNTPProtocol::LoadUrl(nsIURI </span>
<a href="#l6.63"></a><span id="l6.63">             rv = m_nntpServer-&gt;FindGroup(group, getter_AddRefs(m_newsFolder));</span>
<a href="#l6.64"></a><span id="l6.64">             if (!m_newsFolder) goto FAIL;</span>
<a href="#l6.65"></a><span id="l6.65">           }</span>
<a href="#l6.66"></a><span id="l6.66">         }</span>
<a href="#l6.67"></a><span id="l6.67">         m_typeWanted = GROUP_WANTED;</span>
<a href="#l6.68"></a><span id="l6.68">       }</span>
<a href="#l6.69"></a><span id="l6.69">     }</span>
<a href="#l6.70"></a><span id="l6.70">     else</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    {</span>
<a href="#l6.72"></a><span id="l6.72">       // news: or news://HOST</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-      m_typeWanted = READ_NEWS_RC;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+      NS_ASSERTION(0, &quot;Should not get here!&quot;);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    }</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78">     // if this connection comes from the cache, we need to initialize the</span>
<a href="#l6.79"></a><span id="l6.79">     // load group here, by generating the start request notification. nsMsgProtocol::OnStartRequest</span>
<a href="#l6.80"></a><span id="l6.80">     // ignores the first parameter (which is supposed to be the channel) so we'll pass in null.</span>
<a href="#l6.81"></a><span id="l6.81">     if (m_fromCache)</span>
<a href="#l6.82"></a><span id="l6.82">       nsMsgProtocol::OnStartRequest(nsnull, aURL);</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">       /* At this point, we're all done parsing the URL, and know exactly</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineat">@@ -1610,17 +1605,16 @@ PRInt32 nsNNTPProtocol::NewsResponse(nsI</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88">   /* authentication required can come at any time</span>
<a href="#l6.89"></a><span id="l6.89">   */</span>
<a href="#l6.90"></a><span id="l6.90">   if (MK_NNTP_RESPONSE_AUTHINFO_REQUIRE == m_responseCode ||</span>
<a href="#l6.91"></a><span id="l6.91">     MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REQUIRE == m_responseCode)</span>
<a href="#l6.92"></a><span id="l6.92">   {</span>
<a href="#l6.93"></a><span id="l6.93">     m_nextState = NNTP_BEGIN_AUTHORIZE;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-    GotAuthorizationRequest();</span>
<a href="#l6.95"></a><span id="l6.95">   }</span>
<a href="#l6.96"></a><span id="l6.96">   else if (MK_NNTP_RESPONSE_PERMISSION_DENIED == m_responseCode)</span>
<a href="#l6.97"></a><span id="l6.97">   {</span>
<a href="#l6.98"></a><span id="l6.98">     PR_FREEIF(line);</span>
<a href="#l6.99"></a><span id="l6.99">     return (0);</span>
<a href="#l6.100"></a><span id="l6.100">   }</span>
<a href="#l6.101"></a><span id="l6.101">   else {</span>
<a href="#l6.102"></a><span id="l6.102">     m_nextState = m_nextStateAfterResponse;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineat">@@ -2025,28 +2019,16 @@ PRInt32 nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l6.104"></a><span id="l6.104">             return 0;</span>
<a href="#l6.105"></a><span id="l6.105">         }</span>
<a href="#l6.106"></a><span id="l6.106">     }</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108">     if(m_typeWanted == NEWS_POST)</span>
<a href="#l6.109"></a><span id="l6.109">     {  /* posting to the news group */</span>
<a href="#l6.110"></a><span id="l6.110">         NS_MsgSACopy(&amp;command, &quot;POST&quot;);</span>
<a href="#l6.111"></a><span id="l6.111">     }</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-    else if(m_typeWanted == READ_NEWS_RC)</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    {</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-    /* extract post method from the url when we have it... */</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-#ifdef HAVE_NEWS_URL</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    if(ce-&gt;URL_s-&gt;method == URL_POST_METHOD ||</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-                PL_strchr(ce-&gt;URL_s-&gt;address, '?'))</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-          m_nextState = NEWS_NEWS_RC_POST;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-    else</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-#endif</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-          m_nextState = NEWS_DISPLAY_NEWS_RC;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-    return(0);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    }</span>
<a href="#l6.124"></a><span id="l6.124">   else if (m_typeWanted == NEW_GROUPS)</span>
<a href="#l6.125"></a><span id="l6.125">   {</span>
<a href="#l6.126"></a><span id="l6.126">       PRUint32 last_update;</span>
<a href="#l6.127"></a><span id="l6.127">       nsresult rv;</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129">       if (!m_nntpServer)</span>
<a href="#l6.130"></a><span id="l6.130">       {</span>
<a href="#l6.131"></a><span id="l6.131">         NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineat">@@ -3565,19 +3547,23 @@ PRInt32 nsNNTPProtocol::ReadXover(nsIInp</span>
<a href="#l6.133"></a><span id="l6.133"> PRInt32 nsNNTPProtocol::ProcessXover()</span>
<a href="#l6.134"></a><span id="l6.134"> {</span>
<a href="#l6.135"></a><span id="l6.135">   nsresult rv;</span>
<a href="#l6.136"></a><span id="l6.136"> </span>
<a href="#l6.137"></a><span id="l6.137">   /* xover_parse_state stored in MSG_Pane cd-&gt;pane */</span>
<a href="#l6.138"></a><span id="l6.138">   NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l6.139"></a><span id="l6.139">   if (!m_newsgroupList) return -1;</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  // Some people may use the notifications in CallFilters to close the cached</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  // connections, which will clear m_newsgroupList. So we keep a copy for</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  // ourselves to ward off this threat.</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  nsCOMPtr&lt;nsINNTPNewsgroupList&gt; list(m_newsgroupList);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+  list-&gt;CallFilters();</span>
<a href="#l6.146"></a><span id="l6.146">   PRInt32 status = 0;</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  m_newsgroupList-&gt;CallFilters();</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-  rv = m_newsgroupList-&gt;FinishXOVERLINE(0,&amp;status);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  rv = list-&gt;FinishXOVERLINE(0, &amp;status);</span>
<a href="#l6.150"></a><span id="l6.150">   m_newsgroupList = nsnull;</span>
<a href="#l6.151"></a><span id="l6.151">   if (NS_SUCCEEDED(rv) &amp;&amp; status &lt; 0) return status;</span>
<a href="#l6.152"></a><span id="l6.152"> </span>
<a href="#l6.153"></a><span id="l6.153">   m_nextState = NEWS_DONE;</span>
<a href="#l6.154"></a><span id="l6.154"> </span>
<a href="#l6.155"></a><span id="l6.155">   return(MK_DATA_LOADED);</span>
<a href="#l6.156"></a><span id="l6.156"> }</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158" class="difflineat">@@ -3901,249 +3887,16 @@ PRInt32 nsNNTPProtocol::CheckForArticle(</span>
<a href="#l6.159"></a><span id="l6.159">   {</span>
<a href="#l6.160"></a><span id="l6.160">   /* The article isn't there, so the failure we had earlier wasn't due to</span>
<a href="#l6.161"></a><span id="l6.161">      a duplicate message-id.  Return the error from that previous</span>
<a href="#l6.162"></a><span id="l6.162">      posting attempt (which is already in ce-&gt;URL_s-&gt;error_msg). */</span>
<a href="#l6.163"></a><span id="l6.163">   return MK_NNTP_ERROR_MESSAGE;</span>
<a href="#l6.164"></a><span id="l6.164">   }</span>
<a href="#l6.165"></a><span id="l6.165"> }</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-#define NEWS_GROUP_DISPLAY_FREQ 1</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-nsresult</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-nsNNTPProtocol::SetCheckingForNewNewsStatus(PRInt32 current, PRInt32 total)</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-{</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-    nsresult rv;</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-    nsString statusString;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(NEWS_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer, &amp;rv);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    nsCString hostName;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    rv = server-&gt;GetHostName(hostName);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    nsAutoString thisGroupStr;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    thisGroupStr.AppendInt(current);</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    nsAutoString totalGroupStr;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    totalGroupStr.AppendInt(total);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    nsAutoString hostNameStr;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    CopyASCIItoUTF16(hostName, hostNameStr);</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-    const PRUnichar *formatStrings[] = { thisGroupStr.get(), totalGroupStr.get(), hostNameStr.get() };</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(NS_LITERAL_STRING(&quot;checkingForNewNews&quot;).get(),</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-                                                  formatStrings, 3,</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-                                                  getter_Copies(statusString));</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    rv = SetProgressStatus(statusString.get());</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-    SetProgressBarPercent(current, total);</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-    return NS_OK;</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-}</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-PRInt32 nsNNTPProtocol::GetNextGroupNeedingCounts( nsISupports** pNextGroup, PRInt32* returnStatus )</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-{</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-  nsresult rv = m_nntpServer-&gt;GetFirstGroupNeedingCounts( pNextGroup );</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    ClearFlag(NNTP_NEWSRC_PERFORMED);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-    *returnStatus = -1;</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    return rv;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-  }</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-  else if (!*pNextGroup) {</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-    ClearFlag(NNTP_NEWSRC_PERFORMED);</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-    m_nextState = NEWS_DONE;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-    if (m_newsRCListCount) {</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-      // clear the status text.</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-      rv = SetProgressStatus(EmptyString().get());</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-      SetProgressBarPercent(0, PR_UINT32_MAX);</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-      m_newsRCListCount = 0;</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-      *returnStatus = 0;</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-    }</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-    else if (m_responseCode == MK_NNTP_RESPONSE_LIST_OK)  {</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-    /*</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-     * 5-9-96 jefft</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-     * If for some reason the news server returns an empty</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-     * newsgroups list with a nntp response code MK_NNTP_RESPONSE_LIST_OK -- list of</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-     * newsgroups follows. We set status to MK_EMPTY_NEWS_LIST</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-     * to end the infinite dialog loop.</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-     */</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-      *returnStatus = MK_EMPTY_NEWS_LIST;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    }</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-    if(*returnStatus &gt; -1)</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-      *returnStatus = MK_DATA_LOADED;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-  }</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-  return NS_OK;</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-}</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-PRInt32 nsNNTPProtocol::DisplayNewsRC()</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-{</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-  PRInt32 status = 0;</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-  nsresult rv;</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-  if(!TestFlag(NNTP_NEWSRC_PERFORMED)) {</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-    SetFlag(NNTP_NEWSRC_PERFORMED);</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-    rv = m_nntpServer-&gt;GetNumGroupsNeedingCounts(&amp;m_newsRCListCount);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-  }</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; currChild;</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-  PRInt32 groupsToAdvance = m_RCIndexToResumeAfterAuthRequest + 1;</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-  m_RCIndexToResumeAfterAuthRequest = 0;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-  // if we entered this method with a m_RCIndexToResumeAfterAuthRequest &gt; 0, then this is a</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-  // re-incarnation: we already did a run before, but it was disrupted by</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-  // an authorization request (see GotAuthorizationRequest)</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-  while ( groupsToAdvance-- )</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-    if ( NS_FAILED( GetNextGroupNeedingCounts( getter_AddRefs( currChild ), &amp;status ) ) )</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-      return status;</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; currFolder = do_QueryInterface(currChild, &amp;rv);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-    if (NS_FAILED(rv)) return -1;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-    if (!currFolder) return -1;</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-    m_newsFolder = do_QueryInterface(currFolder, &amp;rv);</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    if (NS_FAILED(rv)) return -1;</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-    if (!m_newsFolder) return -1;</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-    nsCString name;</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-    rv = m_newsFolder-&gt;GetRawName(name);</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-    if (NS_FAILED(rv) || name.IsEmpty()) return -1;</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-    /* send group command to server */</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-    char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-    PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;GROUP %.512s&quot; CRLF, name.get());</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-    if (mailnewsurl) {</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-      status = SendData(mailnewsurl, outputBuffer);</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-    }</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-    /* only update every NEWS_GROUP_DISPLAY_FREQ groups for speed */</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-    if ((m_newsRCListCount &gt;= NEWS_GROUP_DISPLAY_FREQ) &amp;&amp; ((m_newsRCListIndex % NEWS_GROUP_DISPLAY_FREQ) == 0 || ((m_newsRCListIndex+1) == m_newsRCListCount))) {</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-      rv = SetCheckingForNewNewsStatus(m_newsRCListIndex+1, m_newsRCListCount);</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-      if (NS_FAILED(rv)) return -1;</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-    }</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-    m_newsRCListIndex++;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-    SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-    m_nextState = NNTP_RESPONSE;</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-    m_nextStateAfterResponse = NEWS_DISPLAY_NEWS_RC_RESPONSE;</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-    return status; /* keep going */</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-}</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-/* Parses output of GROUP command */</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-PRInt32 nsNNTPProtocol::DisplayNewsRCResponse()</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-{</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-  PRInt32 status = 0;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-  if(m_responseCode == MK_NNTP_RESPONSE_GROUP_SELECTED)</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-  {</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-    char *num_arts = 0, *low = 0, *high = 0, *group = 0;</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-    PRInt32 first_art, last_art;</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-    /* line looks like:</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-    *     211 91 3693 3789 comp.infosystems</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-    */</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-    num_arts = m_responseText;</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-    low = PL_strchr(num_arts, ' ');</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-    if(low)</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-    {</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-      first_art = atol(low);</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-      *low++ = '\0';</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-      high= PL_strchr(low, ' ');</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-    }</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-    if(high)</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-    {</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-      *high++ = '\0';</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-      group = PL_strchr(high, ' ');</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-    }</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-    if(group)</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-    {</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-      *group++ = '\0';</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-      /* the group name may be contaminated by &quot;group selected&quot; at</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-         the end.  This will be space separated from the group name.</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-                           If a space is found in the group name terminate at that</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-         point. */</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-      strtok(group, &quot; &quot;);</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-      last_art = atol(high);</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-    }</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    // this might save us a GROUP command, if the user reads a message in the</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-    // last group we update.</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-    m_currentGroup = group;</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-    // prevent crash when</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-    // if going offline in the middle of</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-    // updating the unread counts on a news server</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-    // (running a &quot;news://host/*&quot; url)</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-    NS_ASSERTION(m_nntpServer,&quot;no server&quot;);</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-    if (!m_nntpServer) return -1;</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-    rv = m_nntpServer-&gt;DisplaySubscribedGroup(m_newsFolder,</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-      low ? atol(low) : 0,</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-      high ? atol(high) : 0,</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-      atol(num_arts));</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;DisplaySubscribedGroup() failed&quot;);</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-    if (NS_FAILED(rv)) status = -1;</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-    if (status &lt; 0) return status;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-  }</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-  else if (m_responseCode == MK_NNTP_RESPONSE_GROUP_NO_GROUP)</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-  {</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-    nsString name;</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-    rv = m_newsFolder-&gt;GetUnicodeName(name);</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-        m_nntpServer-&gt;GroupNotFound(m_msgWindow, name, PR_FALSE);</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-    }</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-    PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) NO_GROUP, so unset m_currentGroup&quot;, this));</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-    m_currentGroup.Truncate();</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-  }</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-  /* it turns out subscribe ui depends on getting this displaysubscribedgroup call,</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-  even if there was an error.</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-  */</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-  if(m_responseCode != MK_NNTP_RESPONSE_GROUP_SELECTED)</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-  {</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-    /* only on news server error or when zero articles */</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-    rv = m_nntpServer-&gt;DisplaySubscribedGroup(m_newsFolder, 0, 0, 0);</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;DisplaySubscribedGroup() failed&quot;);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-    PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) error, so unset m_currentGroup&quot;, this));</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-    m_currentGroup.Truncate();</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-  }</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-  m_nextState = NEWS_DISPLAY_NEWS_RC;</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-  return 0;</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-}</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-</span>
<a href="#l6.400"></a><span id="l6.400"> PRInt32 nsNNTPProtocol::StartCancel()</span>
<a href="#l6.401"></a><span id="l6.401"> {</span>
<a href="#l6.402"></a><span id="l6.402">   PRInt32 status = 0;</span>
<a href="#l6.403"></a><span id="l6.403">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l6.404"></a><span id="l6.404">   if (mailnewsurl)</span>
<a href="#l6.405"></a><span id="l6.405">     status = SendData(mailnewsurl, NNTP_CMD_POST);</span>
<a href="#l6.406"></a><span id="l6.406"> </span>
<a href="#l6.407"></a><span id="l6.407">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineat">@@ -5185,32 +4938,16 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l6.409"></a><span id="l6.409">       else</span>
<a href="#l6.410"></a><span id="l6.410">         status = PostDataResponse();</span>
<a href="#l6.411"></a><span id="l6.411">       break;</span>
<a href="#l6.412"></a><span id="l6.412"> </span>
<a href="#l6.413"></a><span id="l6.413">     case NNTP_CHECK_FOR_MESSAGE:</span>
<a href="#l6.414"></a><span id="l6.414">       status = CheckForArticle();</span>
<a href="#l6.415"></a><span id="l6.415">       break;</span>
<a href="#l6.416"></a><span id="l6.416"> </span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-    case NEWS_NEWS_RC_POST:</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-#ifdef UNREADY_CODE</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-      status = net_NewsRCProcessPost(ce);</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-#endif</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-      break;</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-    case NEWS_DISPLAY_NEWS_RC:</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-      status = DisplayNewsRC();</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-      break;</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-    case NEWS_DISPLAY_NEWS_RC_RESPONSE:</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-      if (inputStream == nsnull)</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-        SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-      else</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-        status = DisplayNewsRCResponse();</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-      break;</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-</span>
<a href="#l6.433"></a><span id="l6.433">       // cancel</span>
<a href="#l6.434"></a><span id="l6.434">     case NEWS_START_CANCEL:</span>
<a href="#l6.435"></a><span id="l6.435">       status = StartCancel();</span>
<a href="#l6.436"></a><span id="l6.436">       break;</span>
<a href="#l6.437"></a><span id="l6.437"> </span>
<a href="#l6.438"></a><span id="l6.438">     case NEWS_DO_CANCEL:</span>
<a href="#l6.439"></a><span id="l6.439">       status = DoCancel();</span>
<a href="#l6.440"></a><span id="l6.440">       break;</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineat">@@ -5492,34 +5229,8 @@ NS_IMETHODIMP nsNNTPProtocol::GetCurrent</span>
<a href="#l6.442"></a><span id="l6.442"> {</span>
<a href="#l6.443"></a><span id="l6.443">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l6.444"></a><span id="l6.444">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l6.445"></a><span id="l6.445">   if (m_newsFolder)</span>
<a href="#l6.446"></a><span id="l6.446">     rv = m_newsFolder-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder), (void **) aFolder);</span>
<a href="#l6.447"></a><span id="l6.447">   return rv;</span>
<a href="#l6.448"></a><span id="l6.448"> }</span>
<a href="#l6.449"></a><span id="l6.449"> </span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-void nsNNTPProtocol::GotAuthorizationRequest()</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-{</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-  if ( m_nextStateAfterResponse == NEWS_DISPLAY_NEWS_RC_RESPONSE )</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-  {</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-    // the authorization request disrupted our NEWSRC reading.</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-    // =&gt; restart it, to not lose groups</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-    // (see http://bugzilla.mozilla.org/show_bug.cgi?id=111855)</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-    ClearFlag( NNTP_NEWSRC_PERFORMED );</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-    // with setting m_newsRCListIndex to 0, we could simply restart</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-    // the whole process, starting over with the very first group.</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-    // However, this may lead to problems in some rare scenarios:</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-    // Consider, for instance, an account which has n newsgroups which</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-    // all require different authentication, and a user which does not</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">-    // allow the password manager to remember the user/pwd settings. This</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-    // would lead to constantly annoying this user with the authorization</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">-    // request for the first group.</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">-    // To prevent this (well, and to save some network traffic :), we go</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-    // back one step only</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-    NS_ASSERTION( m_newsRCListIndex &gt; 0, &quot;next state == NEWS_DISPLAY_NEWS_RC_RESPONSE, but no single group handled, yet?&quot; );</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-    if ( m_newsRCListIndex &gt; 0 )</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-    {   // yes, I'm paranoid :)</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-        m_RCIndexToResumeAfterAuthRequest = --m_newsRCListIndex;</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-    }</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-  }</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -62,17 +62,16 @@</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> // State Flags (Note, I use the word state in terms of storing</span>
<a href="#l7.6"></a><span id="l7.6"> // state information about the connection (authentication, have we sent</span>
<a href="#l7.7"></a><span id="l7.7"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #define NNTP_PAUSE_FOR_READ      0x00000001  /* should we pause for the next read */</span>
<a href="#l7.10"></a><span id="l7.10"> #define NNTP_PROXY_AUTH_REQUIRED    0x00000002  /* is auth required */</span>
<a href="#l7.11"></a><span id="l7.11"> #define NNTP_SENT_PROXY_AUTH        0x00000004  /* have we sent a proxy auth? */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#define NNTP_NEWSRC_PERFORMED       0x00000008  /* have we done a newsrc update? */</span>
<a href="#l7.13"></a><span id="l7.13"> #define NNTP_READER_PERFORMED       0x00000010  /* have we sent any cmds to the server yet? */</span>
<a href="#l7.14"></a><span id="l7.14"> #define NNTP_USE_FANCY_NEWSGROUP    0x00000020  /* use LIST XACTIVE or LIST */</span>
<a href="#l7.15"></a><span id="l7.15"> #define NNTP_DESTROY_PROGRESS_GRAPH 0x00000040  /* do we need to destroy graph progress */</span>
<a href="#l7.16"></a><span id="l7.16"> #define NNTP_SOME_PROTOCOL_SUCCEEDED 0x0000080  /* some protocol has suceeded so don't kill the connection */</span>
<a href="#l7.17"></a><span id="l7.17"> #define NNTP_NO_XOVER_SUPPORT       0x00000100  /* xover command is not supported here */</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> /* states of the machine</span>
<a href="#l7.20"></a><span id="l7.20">  */</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -128,19 +127,16 @@ NNTP_PROFILE_ADD_RESPONSE,</span>
<a href="#l7.22"></a><span id="l7.22"> NNTP_PROFILE_DELETE,</span>
<a href="#l7.23"></a><span id="l7.23"> NNTP_PROFILE_DELETE_RESPONSE,</span>
<a href="#l7.24"></a><span id="l7.24"> NNTP_SEND_ARTICLE_NUMBER,</span>
<a href="#l7.25"></a><span id="l7.25"> NEWS_PROCESS_BODIES,</span>
<a href="#l7.26"></a><span id="l7.26"> NNTP_PRINT_ARTICLE_HEADERS,</span>
<a href="#l7.27"></a><span id="l7.27"> NNTP_SEND_POST_DATA,</span>
<a href="#l7.28"></a><span id="l7.28"> NNTP_SEND_POST_DATA_RESPONSE,</span>
<a href="#l7.29"></a><span id="l7.29"> NNTP_CHECK_FOR_MESSAGE,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-NEWS_NEWS_RC_POST,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-NEWS_DISPLAY_NEWS_RC,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-NEWS_DISPLAY_NEWS_RC_RESPONSE,</span>
<a href="#l7.33"></a><span id="l7.33"> NEWS_START_CANCEL,</span>
<a href="#l7.34"></a><span id="l7.34"> NEWS_DO_CANCEL,</span>
<a href="#l7.35"></a><span id="l7.35"> NNTP_XPAT_SEND,</span>
<a href="#l7.36"></a><span id="l7.36"> NNTP_XPAT_RESPONSE,</span>
<a href="#l7.37"></a><span id="l7.37"> NNTP_SEARCH,</span>
<a href="#l7.38"></a><span id="l7.38"> NNTP_SEARCH_RESPONSE,</span>
<a href="#l7.39"></a><span id="l7.39"> NNTP_SEARCH_RESULTS,</span>
<a href="#l7.40"></a><span id="l7.40"> NNTP_LIST_PRETTY_NAMES,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -249,21 +245,16 @@ private:</span>
<a href="#l7.42"></a><span id="l7.42">   // used for the cancelation message.</span>
<a href="#l7.43"></a><span id="l7.43">   // mscott: we can probably replace this stuff with nsString</span>
<a href="#l7.44"></a><span id="l7.44">   char   *m_cancelFromHdr;</span>
<a href="#l7.45"></a><span id="l7.45">   char     *m_cancelNewsgroups;</span>
<a href="#l7.46"></a><span id="l7.46">   char     *m_cancelDistribution;</span>
<a href="#l7.47"></a><span id="l7.47">   char     *m_cancelID;</span>
<a href="#l7.48"></a><span id="l7.48">   PRInt32    m_cancelStatus;</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  // variables for ReadNewsRC</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  PRInt32   m_newsRCListIndex;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  PRInt32   m_RCIndexToResumeAfterAuthRequest;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  PRInt32   m_newsRCListCount;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-</span>
<a href="#l7.55"></a><span id="l7.55">   // variable for ReadNewsList</span>
<a href="#l7.56"></a><span id="l7.56">   PRInt32   m_readNewsListCount;</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">   // Per news article state information. (article number, author, subject, id, etc</span>
<a href="#l7.59"></a><span id="l7.59">   char   *m_messageID;</span>
<a href="#l7.60"></a><span id="l7.60">   PRInt32   m_articleNumber;   /* current article number */</span>
<a href="#l7.61"></a><span id="l7.61">   char   *m_commandSpecificData;</span>
<a href="#l7.62"></a><span id="l7.62">   char   *m_searchData;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineat">@@ -348,20 +339,16 @@ private:</span>
<a href="#l7.64"></a><span id="l7.64">   PRInt32 ProcessNewsgroups(nsIInputStream * inputStream, PRUint32 length);</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66">   // Protocol handlers used for posting data</span>
<a href="#l7.67"></a><span id="l7.67">   PRInt32 PostData();</span>
<a href="#l7.68"></a><span id="l7.68">   PRInt32 PostDataResponse();</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">   PRInt32 CheckForArticle();</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  // NewsRC specific</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  PRInt32 DisplayNewsRC();</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  PRInt32 DisplayNewsRCResponse();</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-</span>
<a href="#l7.76"></a><span id="l7.76">   /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.77"></a><span id="l7.77">   // XHDR, XOVER, HEAD filtering process handlers</span>
<a href="#l7.78"></a><span id="l7.78">   // These are ordered by the rough order of usage</span>
<a href="#l7.79"></a><span id="l7.79">   /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.80"></a><span id="l7.80">  </span>
<a href="#l7.81"></a><span id="l7.81">   /**</span>
<a href="#l7.82"></a><span id="l7.82">    * The first step in the filtering process, the state NNTP_XOVER_BEGIN.</span>
<a href="#l7.83"></a><span id="l7.83">    * This method sets up m_newsgroupList.</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineat">@@ -477,36 +464,32 @@ private:</span>
<a href="#l7.85"></a><span id="l7.85">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.86"></a><span id="l7.86">   // End of Protocol Methods</span>
<a href="#l7.87"></a><span id="l7.87">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89">   nsresult ParseURL(nsIURI * aURL, char ** aGroup, char ** aMessageID, char ** aCommandSpecificData);</span>
<a href="#l7.90"></a><span id="l7.90"> </span>
<a href="#l7.91"></a><span id="l7.91">   void SetProgressBarPercent(PRUint32 aProgress, PRUint32 aProgressMax);</span>
<a href="#l7.92"></a><span id="l7.92">   nsresult SetProgressStatus(const PRUnichar *aMessage);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-  nsresult SetCheckingForNewNewsStatus(PRInt32 current, PRInt32 total);</span>
<a href="#l7.94"></a><span id="l7.94">   nsresult InitializeNewsFolderFromUri(const char *uri);</span>
<a href="#l7.95"></a><span id="l7.95">   void TimerCallback();</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97">   void HandleAuthenticationFailure();</span>
<a href="#l7.98"></a><span id="l7.98">   nsCOMPtr &lt;nsIInputStream&gt; mInputStream;</span>
<a href="#l7.99"></a><span id="l7.99">   nsCOMPtr &lt;nsITimer&gt; mUpdateTimer;</span>
<a href="#l7.100"></a><span id="l7.100">   nsresult AlertError(PRInt32 errorCode, const char *text);</span>
<a href="#l7.101"></a><span id="l7.101">   PRInt32 mBytesReceived;</span>
<a href="#l7.102"></a><span id="l7.102">   PRInt32 mBytesReceivedSinceLastStatusUpdate;</span>
<a href="#l7.103"></a><span id="l7.103">   PRTime m_startTime;</span>
<a href="#l7.104"></a><span id="l7.104">   PRInt32 mNumGroupsListed;</span>
<a href="#l7.105"></a><span id="l7.105">   nsMsgKey m_key;</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107">   nsresult SetCurrentGroup(); /* sets m_currentGroup.  should be called after doing a successful GROUP command */</span>
<a href="#l7.108"></a><span id="l7.108">   nsresult CleanupNewsgroupList(); /* cleans up m_newsgroupList, and set it to null */</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  void    GotAuthorizationRequest(); /* called when we got an authorization request, which potentially disrupted something */</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-  PRInt32 GetNextGroupNeedingCounts( nsISupports** pNextGroup, PRInt32* returnStatus );</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-</span>
<a href="#l7.113"></a><span id="l7.113">   // cache related helper methods</span>
<a href="#l7.114"></a><span id="l7.114">   void FinishMemCacheEntry(PRBool valid); // either mark it valid, or doom it</span>
<a href="#l7.115"></a><span id="l7.115">   nsresult OpenCacheEntry(); // makes a request to the cache service for a cache entry for a url</span>
<a href="#l7.116"></a><span id="l7.116">   PRBool ReadFromLocalCache(); // attempts to read the url out of our local (offline) cache....</span>
<a href="#l7.117"></a><span id="l7.117">   nsresult ReadFromNewsConnection(); // creates a new news connection to read the url</span>
<a href="#l7.118"></a><span id="l7.118">   nsresult ReadFromMemCache(nsICacheEntryDescriptor *entry); // attempts to read the url out of our memory cache</span>
<a href="#l7.119"></a><span id="l7.119">   nsresult SetupPartExtractorListener(nsIStreamListener * aConsumer);</span>
<a href="#l7.120"></a><span id="l7.120"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -314,16 +314,37 @@ nsresult nsMsgNewsFolder::GetDatabase()</span>
<a href="#l8.4"></a><span id="l8.4">     rv = UpdateSummaryTotals(PR_TRUE);</span>
<a href="#l8.5"></a><span id="l8.5">     if (NS_FAILED(rv))</span>
<a href="#l8.6"></a><span id="l8.6">       return rv;</span>
<a href="#l8.7"></a><span id="l8.7">   }</span>
<a href="#l8.8"></a><span id="l8.8">   return NS_OK;</span>
<a href="#l8.9"></a><span id="l8.9"> }</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> NS_IMETHODIMP</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+nsMsgNewsFolder::GetDatabaseWithoutCache(nsIMsgDatabase **db)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(db);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  // The simplest way to perform this operation is to get the database normally</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  // and then clear our information about it if we didn't already hold it open.</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  PRBool wasCached = !!mDatabase;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  nsresult rv = GetDatabase();</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  NS_IF_ADDREF(*db = mDatabase);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  // If the DB was not open before, close our reference to it now.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  if (!wasCached &amp;&amp; mDatabase)</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    mDatabase-&gt;RemoveListener(this);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+    mDatabase = nsnull;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  }</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  return rv;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+}</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.33"></a><span id="l8.33"> nsMsgNewsFolder::UpdateFolder(nsIMsgWindow *aWindow)</span>
<a href="#l8.34"></a><span id="l8.34"> {</span>
<a href="#l8.35"></a><span id="l8.35">   // Get news.get_messages_on_select pref</span>
<a href="#l8.36"></a><span id="l8.36">   nsresult rv;</span>
<a href="#l8.37"></a><span id="l8.37">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.38"></a><span id="l8.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.39"></a><span id="l8.39">   PRBool getMessagesOnSelect = PR_TRUE;</span>
<a href="#l8.40"></a><span id="l8.40">   prefBranch-&gt;GetBoolPref(&quot;news.get_messages_on_select&quot;, &amp;getMessagesOnSelect);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -1791,22 +1812,35 @@ NS_IMETHODIMP nsMsgNewsFolder::NotifyDow</span>
<a href="#l8.42"></a><span id="l8.42">     }</span>
<a href="#l8.43"></a><span id="l8.43">   }</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   return rv;</span>
<a href="#l8.46"></a><span id="l8.46"> }</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48"> NS_IMETHODIMP nsMsgNewsFolder::NotifyFinishedDownloadinghdrs()</span>
<a href="#l8.49"></a><span id="l8.49"> {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  PRBool wasCached = !!mDatabase;</span>
<a href="#l8.51"></a><span id="l8.51">   ChangeNumPendingTotalMessages(-GetNumPendingTotalMessages());</span>
<a href="#l8.52"></a><span id="l8.52">   ChangeNumPendingUnread(-GetNumPendingUnread());</span>
<a href="#l8.53"></a><span id="l8.53">   PRBool filtersRun;</span>
<a href="#l8.54"></a><span id="l8.54">   // run the bayesian spam filters, if enabled.</span>
<a href="#l8.55"></a><span id="l8.55">   CallFilterPlugins(nsnull, &amp;filtersRun);</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  // If the DB was not open before, close our reference to it now.</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  if (!wasCached &amp;&amp; mDatabase)</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    mDatabase-&gt;RemoveListener(this);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    // This also clears all of the cached headers that may have been added while</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    // we were downloading messages (and those clearing refcount cycles in the</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    // database).</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+    mDatabase-&gt;ClearCachedHdrs();</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    mDatabase = nsnull;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  }</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69">   return NS_OK;</span>
<a href="#l8.70"></a><span id="l8.70"> }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72"> NS_IMETHODIMP nsMsgNewsFolder::Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l8.73"></a><span id="l8.73"> {</span>
<a href="#l8.74"></a><span id="l8.74">   nsresult rv;</span>
<a href="#l8.75"></a><span id="l8.75">   rv = GetDatabase();</span>
<a href="#l8.76"></a><span id="l8.76">   if (mDatabase)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -103,17 +103,16 @@ NS_INTERFACE_MAP_BEGIN(nsNntpIncomingSer</span>
<a href="#l9.4"></a><span id="l9.4">     NS_INTERFACE_MAP_ENTRY(nsIUrlListener)</span>
<a href="#l9.5"></a><span id="l9.5">     NS_INTERFACE_MAP_ENTRY(nsISubscribableServer)</span>
<a href="#l9.6"></a><span id="l9.6">     NS_INTERFACE_MAP_ENTRY(nsITreeView)</span>
<a href="#l9.7"></a><span id="l9.7"> NS_INTERFACE_MAP_END_INHERITING(nsMsgIncomingServer)</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> nsNntpIncomingServer::nsNntpIncomingServer()</span>
<a href="#l9.10"></a><span id="l9.10"> {</span>
<a href="#l9.11"></a><span id="l9.11">   mNewsrcHasChanged = PR_FALSE;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  mGroupsEnumerator = nsnull;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14">   mHostInfoLoaded = PR_FALSE;</span>
<a href="#l9.15"></a><span id="l9.15">   mHostInfoHasChanged = PR_FALSE;</span>
<a href="#l9.16"></a><span id="l9.16">   mVersion = INVALID_VERSION;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   mLastGroupDate = 0;</span>
<a href="#l9.19"></a><span id="l9.19">   mUniqueId = 0;</span>
<a href="#l9.20"></a><span id="l9.20">   mHasSeenBeginGroups = PR_FALSE;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -398,17 +397,17 @@ nsNntpIncomingServer::WriteNewsrcFile()</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">         newsrcStream-&gt;Close();</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">         rv = SetNewsrcHasChanged(PR_FALSE);</span>
<a href="#l9.26"></a><span id="l9.26">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.27"></a><span id="l9.27">     }</span>
<a href="#l9.28"></a><span id="l9.28"> #ifdef DEBUG_NEWS</span>
<a href="#l9.29"></a><span id="l9.29">     else {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-        printf(&quot;no need to write newsrc file for %s, it was not dirty\n&quot;, (hostname.get());</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+        printf(&quot;no need to write newsrc file for %s, it was not dirty\n&quot;, (hostname.get()));</span>
<a href="#l9.32"></a><span id="l9.32">     }</span>
<a href="#l9.33"></a><span id="l9.33"> #endif /* DEBUG_NEWS */</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">     return NS_OK;</span>
<a href="#l9.36"></a><span id="l9.36"> }</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> NS_IMETHODIMP</span>
<a href="#l9.39"></a><span id="l9.39"> nsNntpIncomingServer::SetNewsrcHasChanged(PRBool aNewsrcHasChanged)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineat">@@ -653,107 +652,55 @@ nsNntpIncomingServer::PrepareForNextUrl(</span>
<a href="#l9.41"></a><span id="l9.41"> NS_IMETHODIMP nsNntpIncomingServer::RemoveConnection(nsINNTPProtocol *aNntpConnection)</span>
<a href="#l9.42"></a><span id="l9.42"> {</span>
<a href="#l9.43"></a><span id="l9.43">   if (aNntpConnection)</span>
<a href="#l9.44"></a><span id="l9.44">     mConnectionCache.RemoveObject(aNntpConnection);</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">   return NS_OK;</span>
<a href="#l9.47"></a><span id="l9.47"> }</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-</span>
<a href="#l9.50"></a><span id="l9.50"> NS_IMETHODIMP</span>
<a href="#l9.51"></a><span id="l9.51"> nsNntpIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow)</span>
<a href="#l9.52"></a><span id="l9.52"> {</span>
<a href="#l9.53"></a><span id="l9.53">   // Get news.update_unread_on_expand pref</span>
<a href="#l9.54"></a><span id="l9.54">   nsresult rv;</span>
<a href="#l9.55"></a><span id="l9.55">   PRBool updateUnreadOnExpand = PR_TRUE;</span>
<a href="#l9.56"></a><span id="l9.56">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.57"></a><span id="l9.57">   if (NS_SUCCEEDED(rv))</span>
<a href="#l9.58"></a><span id="l9.58">     prefBranch-&gt;GetBoolPref(&quot;news.update_unread_on_expand&quot;, &amp;updateUnreadOnExpand);</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">   // Only if news.update_unread_on_expand is true do we update the unread counts</span>
<a href="#l9.61"></a><span id="l9.61">   if (updateUnreadOnExpand)</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    // a user might have a new server without any groups.</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-    // if so, bail out.  no need to establish a connection to the server</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    PRInt32 numGroups = 0;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    rv = GetNumGroupsNeedingCounts(&amp;numGroups);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    if (!numGroups)</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-      return NS_OK;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    nsCOMPtr&lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    rv = nntpService-&gt;UpdateCounts(this, aMsgWindow);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  }</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+    return DownloadMail(aMsgWindow);</span>
<a href="#l9.79"></a><span id="l9.79">   return NS_OK;</span>
<a href="#l9.80"></a><span id="l9.80"> }</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-nsNntpIncomingServer::GetNumGroupsNeedingCounts(PRInt32 *aNumGroupsNeedingCounts)</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+nsresult</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+nsNntpIncomingServer::DownloadMail(nsIMsgWindow *aMsgWindow)</span>
<a href="#l9.86"></a><span id="l9.86"> {</span>
<a href="#l9.87"></a><span id="l9.87">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-</span>
<a href="#l9.89"></a><span id="l9.89">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-    return rv;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  // Ensure the sub folders are initialised.</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(mGroupsEnumerator));</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    return rv;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-  PRUint32 count = 0;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-  rv = rootFolder-&gt;GetNumSubFolders(&amp;count);</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-    return rv;</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-  *aNumGroupsNeedingCounts = (PRInt32) count;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-}</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-nsNntpIncomingServer::GetFirstGroupNeedingCounts(nsISupports **aFirstGroupNeedingCounts)</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-{</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-  if (!aFirstGroupNeedingCounts) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; groups;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(groups));</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  PRBool moreFolders;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-  if (!mGroupsEnumerator) return NS_ERROR_FAILURE;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-  rv = mGroupsEnumerator-&gt;HasMoreElements(&amp;moreFolders);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-  if (!moreFolders)</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-  {</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-    *aFirstGroupNeedingCounts = nsnull;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-    mGroupsEnumerator = nsnull;</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    return NS_OK; // this is not an error - it just means we reached the end of the groups.</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  }</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  do</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+  PRBool hasNext;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+  while (NS_SUCCEEDED(rv = groups-&gt;HasMoreElements(&amp;hasNext)) &amp;&amp; hasNext)</span>
<a href="#l9.134"></a><span id="l9.134">   {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-    rv = mGroupsEnumerator-&gt;GetNext(aFirstGroupNeedingCounts);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-    if (!*aFirstGroupNeedingCounts) return NS_ERROR_FAILURE;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-    (*aFirstGroupNeedingCounts)-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder), getter_AddRefs(folder));</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-    PRUint32 folderFlags;</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-    folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-    if (folderFlags &amp; nsMsgFolderFlags::Virtual)</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-      continue;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-    else</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-      break;</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; nextGroup;</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+    rv = groups-&gt;GetNext(getter_AddRefs(nextGroup));</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; group(do_QueryInterface(nextGroup));</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+    rv = group-&gt;GetNewMessages(aMsgWindow, nsnull);</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.153"></a><span id="l9.153">   }</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-  while (PR_TRUE);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+  return rv;</span>
<a href="#l9.157"></a><span id="l9.157"> }</span>
<a href="#l9.158"></a><span id="l9.158"> </span>
<a href="#l9.159"></a><span id="l9.159"> NS_IMETHODIMP</span>
<a href="#l9.160"></a><span id="l9.160"> nsNntpIncomingServer::DisplaySubscribedGroup(nsIMsgNewsFolder *aMsgFolder, PRInt32 aFirstMessage, PRInt32 aLastMessage, PRInt32 aTotalMessages)</span>
<a href="#l9.161"></a><span id="l9.161"> {</span>
<a href="#l9.162"></a><span id="l9.162">   nsresult rv;</span>
<a href="#l9.163"></a><span id="l9.163"> </span>
<a href="#l9.164"></a><span id="l9.164">   if (!aMsgFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineat">@@ -762,20 +709,20 @@ nsNntpIncomingServer::DisplaySubscribedG</span>
<a href="#l9.166"></a><span id="l9.166"> #endif</span>
<a href="#l9.167"></a><span id="l9.167">   rv = aMsgFolder-&gt;UpdateSummaryFromNNTPInfo(aFirstMessage,aLastMessage,aTotalMessages);</span>
<a href="#l9.168"></a><span id="l9.168">   return rv;</span>
<a href="#l9.169"></a><span id="l9.169"> }</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171"> NS_IMETHODIMP</span>
<a href="#l9.172"></a><span id="l9.172"> nsNntpIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow)</span>
<a href="#l9.173"></a><span id="l9.173"> {</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-#ifdef DEBUG_NEWS</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-  printf(&quot;PerformBiff for nntp\n&quot;);</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-#endif</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-  return PerformExpand(nsnull);</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+  // Biff will force a download of the messages. If the user doesn't want this</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+  // (e.g., there is a lot of high-traffic newsgroups), the better option is to</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+  // just ignore biff.</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+  return PerformExpand(aMsgWindow);</span>
<a href="#l9.182"></a><span id="l9.182"> }</span>
<a href="#l9.183"></a><span id="l9.183"> </span>
<a href="#l9.184"></a><span id="l9.184"> NS_IMETHODIMP nsNntpIncomingServer::GetServerRequiresPasswordForBiff(PRBool *aServerRequiresPasswordForBiff)</span>
<a href="#l9.185"></a><span id="l9.185"> {</span>
<a href="#l9.186"></a><span id="l9.186">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l9.187"></a><span id="l9.187">   *aServerRequiresPasswordForBiff = PR_FALSE;  // for news, biff is getting the unread counts</span>
<a href="#l9.188"></a><span id="l9.188">   return NS_OK;</span>
<a href="#l9.189"></a><span id="l9.189"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -111,16 +111,21 @@ protected:</span>
<a href="#l10.4"></a><span id="l10.4">     nsresult GetNntpConnection(nsIURI *url, nsIMsgWindow *window,</span>
<a href="#l10.5"></a><span id="l10.5">                                nsINNTPProtocol **aNntpConnection);</span>
<a href="#l10.6"></a><span id="l10.6">     nsresult CreateProtocolInstance(nsINNTPProtocol **aNntpConnection,</span>
<a href="#l10.7"></a><span id="l10.7">                                     nsIURI *url, nsIMsgWindow *window);</span>
<a href="#l10.8"></a><span id="l10.8">     PRBool ConnectionTimeOut(nsINNTPProtocol* aNntpConnection);</span>
<a href="#l10.9"></a><span id="l10.9">     nsCOMArray&lt;nsINNTPProtocol&gt; mConnectionCache;</span>
<a href="#l10.10"></a><span id="l10.10">     nsTArray&lt;nsRefPtr&lt;nsNntpMockChannel&gt; &gt; m_queuedChannels;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    /**</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+     * Downloads the newsgroup headers.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+     */</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+    nsresult DownloadMail(nsIMsgWindow *aMsgWindow);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17">     NS_IMETHOD GetServerRequiresPasswordForBiff(PRBool *aServerRequiresPasswordForBiff);</span>
<a href="#l10.18"></a><span id="l10.18">     nsresult SetupNewsrcSaveTimer();</span>
<a href="#l10.19"></a><span id="l10.19">     static void OnNewsrcSaveTimer(nsITimer *timer, void *voidIncomingServer);</span>
<a href="#l10.20"></a><span id="l10.20">     void WriteLine(nsIOutputStream *stream, nsCString &amp;str);</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> private:</span>
<a href="#l10.23"></a><span id="l10.23">     nsCStringArray mSubscribedNewsgroups;</span>
<a href="#l10.24"></a><span id="l10.24">     nsCStringArray mGroupsOnServer;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -140,17 +145,16 @@ private:</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">     PRBool   mHasSeenBeginGroups;</span>
<a href="#l10.28"></a><span id="l10.28">     PRBool   mGetOnlyNew;</span>
<a href="#l10.29"></a><span id="l10.29">     nsresult WriteHostInfoFile();</span>
<a href="#l10.30"></a><span id="l10.30">     nsresult LoadHostInfoFile();</span>
<a href="#l10.31"></a><span id="l10.31">     nsresult AddGroupOnServer(const nsACString &amp;name);</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">     PRBool mNewsrcHasChanged;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; mGroupsEnumerator;</span>
<a href="#l10.35"></a><span id="l10.35">     PRBool mHostInfoLoaded;</span>
<a href="#l10.36"></a><span id="l10.36">     PRBool mHostInfoHasChanged;</span>
<a href="#l10.37"></a><span id="l10.37">     nsCOMPtr &lt;nsILocalFile&gt; mHostInfoFile;</span>
<a href="#l10.38"></a><span id="l10.38">     </span>
<a href="#l10.39"></a><span id="l10.39">     PRUint32 mLastGroupDate;</span>
<a href="#l10.40"></a><span id="l10.40">     PRTime mFirstNewDate;</span>
<a href="#l10.41"></a><span id="l10.41">     PRInt32 mUniqueId;    </span>
<a href="#l10.42"></a><span id="l10.42">     PRUint32 mLastUpdatedTime;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1682,38 +1682,16 @@ NS_IMETHODIMP nsNntpService::Search(nsIM</span>
<a href="#l11.4"></a><span id="l11.4">   if (msgurl)</span>
<a href="#l11.5"></a><span id="l11.5">     msgurl-&gt;SetSearchSession(aSearchSession);</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">   // run the url to update the counts</span>
<a href="#l11.8"></a><span id="l11.8">   return RunNewsUrl(url, nsnull, nsnull);</span>
<a href="#l11.9"></a><span id="l11.9"> }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> NS_IMETHODIMP</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-nsNntpService::UpdateCounts(nsINntpIncomingServer *aNntpServer, nsIMsgWindow *aMsgWindow)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  nsresult rv;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aNntpServer);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aNntpServer, &amp;rv);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  nsCString serverUri;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  rv = server-&gt;GetServerURI(serverUri);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  rv = ConstructNntpUrl(serverUri.get(), nsnull, aMsgWindow, nsnull, nsINntpUrl::ActionUpdateCounts, getter_AddRefs(url));</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  // run the url to update the counts</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  rv = RunNewsUrl(url, aMsgWindow, nsnull);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  return NS_SUCCEEDED(rv) || (rv == NS_MSG_ERROR_OFFLINE) ? NS_OK : rv;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-}</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l11.34"></a><span id="l11.34"> nsNntpService::GetListOfGroupsOnServer(nsINntpIncomingServer *aNntpServer, nsIMsgWindow *aMsgWindow, PRBool aGetOnlyNew)</span>
<a href="#l11.35"></a><span id="l11.35"> {</span>
<a href="#l11.36"></a><span id="l11.36">   nsresult rv;</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">   NS_ENSURE_ARG_POINTER(aNntpServer);</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aNntpServer, &amp;rv);</span>
<a href="#l11.41"></a><span id="l11.41">   if (NS_FAILED(rv)) return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/news/test/unit/test_biff.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,49 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+// This tests that we can execute biff properly, specifically that filters are</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+// run during biff, producing correct counts.</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+load(&quot;../../mailnews/resources/filterTestUtils.js&quot;);</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+function run_test() {</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+  // Set up the server and add in filters</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+  let daemon = setupNNTPDaemon();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  let localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  // Remove all but the test.filter folder</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  let rootFolder = localserver.rootFolder;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  let enumerator = rootFolder.subFolders;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    let folder = enumerator.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+    if (folder.name != &quot;test.filter&quot;)</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+      rootFolder.propagateDelete(folder, true, null);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  }</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+  // Create a filter to mark one message read.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  let filters = localserver.getFilterList(null);</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+  filters.loggingEnabled = true;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  createFilter(filters, &quot;subject&quot;, &quot;Odd&quot;, &quot;read&quot;);</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+  localserver.setFilterList(filters);</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  let server = new nsMailServer(new NNTP_RFC2980_handler(daemon));</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+  server.start(NNTP_PORT);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  // This is a bit hackish, but we don't have any really functional callbacks</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+  // for biff. Instead, we use the notifier to look for all 7 messages to be</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  // added and take that as our sign that the download is finished.</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  let expectCount = 7, seen = 0;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  let notifier = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+                   .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  let listener = { msgAdded: function() {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    if (++seen == expectCount)</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+      localserver.closeCachedConnections();</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    }};</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  notifier.addListener(listener, Ci.nsIMsgFolderNotificationService.msgAdded);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  localserver.performBiff(null);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  server.performTest();</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  notifier.removeListener(listener);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+  // We marked, via our filters, one of the messages read. So if we do not</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  // have 1 read message, either we're not running the filters on biff, or the</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  // filters aren't working. This is disambiguated by the test_filter.js test.</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  let folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  do_check_eq(folder.getTotalMessages(false), folder.getNumUnread(false) + 1);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+  server.stop();</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/news/test/unit/test_filter.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_filter.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -13,80 +13,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> //   - From</span>
<a href="#l13.5"></a><span id="l13.5"> //   - Date</span>
<a href="#l13.6"></a><span id="l13.6"> //   - Size</span>
<a href="#l13.7"></a><span id="l13.7"> //   - Message-ID (header retrievable by XOVER)</span>
<a href="#l13.8"></a><span id="l13.8"> //   - User-Agent (header not retrievable by XHDR)</span>
<a href="#l13.9"></a><span id="l13.9"> // * Test all actions</span>
<a href="#l13.10"></a><span id="l13.10"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-var contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-// This maps strings to a filter attribute (excluding the parameter)</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-var ATTRIB_MAP = {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  // Template : [attrib, op, field of value, otherHeader]</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-  &quot;subject&quot; : [Ci.nsMsgSearchAttrib.Subject, contains, &quot;str&quot;, null],</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  &quot;from&quot; : [Ci.nsMsgSearchAttrib.Sender, contains, &quot;str&quot;, null],</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  &quot;date&quot; : [Ci.nsMsgSearchAttrib.Date, Ci.nsMsgSearchOp.Is, &quot;date&quot;, null],</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  &quot;size&quot; : [Ci.nsMsgSearchAttrib.Size, Ci.nsMsgSearchOp.Is, &quot;size&quot;, null],</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  &quot;message-id&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+1, contains, &quot;str&quot;,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-                  &quot;Message-ID&quot;],</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  &quot;user-agent&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+2, contains, &quot;str&quot;,</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-                  &quot;User-Agent&quot;]</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-};</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-// And this maps strings to filter actions</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-var ACTION_MAP = {</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  // Template : [action, auxiliary attribute field, auxiliary value]</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  &quot;priority&quot; : [Ci.nsMsgFilterAction.ChangePriority, &quot;priority&quot;, 6],</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-  &quot;delete&quot; : [Ci.nsMsgFilterAction.Delete],</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  &quot;read&quot; : [Ci.nsMsgFilterAction.MarkRead],</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  &quot;kill&quot; : [Ci.nsMsgFilterAction.KillThread],</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  &quot;watch&quot; : [Ci.nsMsgFilterAction.WatchThread],</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  &quot;flag&quot; : [Ci.nsMsgFilterAction.MarkFlagged],</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  &quot;stop&quot;: [Ci.nsMsgFilterAction.StopExecution],</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  &quot;tag&quot; : [Ci.nsMsgFilterAction.AddTag, &quot;strValue&quot;, &quot;tag&quot;]</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-};</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-function createFilter(list, header, value, action) {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  var filter = list.createFilter(header+action+&quot;Test&quot;);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  filter.filterType = Ci.nsMsgFilterType.NewsRule;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  var searchTerm = filter.createTerm();</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  searchTerm.matchAll = false;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  if (header in ATTRIB_MAP) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-    let information = ATTRIB_MAP[header];</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    searchTerm.attrib = information[0];</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-    if (information[3] != null)</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-      searchTerm.arbitraryHeader = information[3];</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    searchTerm.op = information[1];</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    var oldValue = searchTerm.value;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    oldValue.attrib = information[0];</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-    oldValue[information[2]] = value;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    searchTerm.value = oldValue;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  } else {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    throw &quot;Unknown header &quot;+header;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-  }</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  searchTerm.booleanAnd = true;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  filter.appendTerm(searchTerm);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  var filterAction = filter.createAction();</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-  if (action in ACTION_MAP) {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-    let information = ACTION_MAP[action];</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    filterAction.type = information[0];</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-    if (1 in information)</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-      filterAction[information[1]] = information[2];</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-  } else {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-    throw &quot;Unknown action &quot;+action;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-  }</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  filter.appendAction(filterAction);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  filter.enabled = true;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-  // Add to the end</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-  list.insertFilterAt(list.filterCount, filter);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-}</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+load(&quot;../../mailnews/resources/filterTestUtils.js&quot;);</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78"> // These are the expected results for testing filter triggers</span>
<a href="#l13.79"></a><span id="l13.79"> var attribResults = {</span>
<a href="#l13.80"></a><span id="l13.80">   &quot;1@regular.invalid&quot; : [&quot;isRead&quot;, false],</span>
<a href="#l13.81"></a><span id="l13.81">   &quot;2@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l13.82"></a><span id="l13.82">   &quot;3@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l13.83"></a><span id="l13.83">   &quot;4@regular.invalid&quot; : [&quot;isRead&quot;, true],</span>
<a href="#l13.84"></a><span id="l13.84">   &quot;5@regular.invalid&quot; : [&quot;isRead&quot;, true],</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/news/test/unit/test_server.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_server.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -49,26 +49,16 @@ function testRFC977() {</span>
<a href="#l14.4"></a><span id="l14.4">     // Test - getting group headers</span>
<a href="#l14.5"></a><span id="l14.5">     /*test = &quot;news:test.empty&quot;;</span>
<a href="#l14.6"></a><span id="l14.6">     server.resetTest();</span>
<a href="#l14.7"></a><span id="l14.7">     setupProtocolTest(NNTP_PORT, prefix+&quot;test.empty&quot;);</span>
<a href="#l14.8"></a><span id="l14.8">     server.performTest();</span>
<a href="#l14.9"></a><span id="l14.9">     transaction = server.playTransaction();</span>
<a href="#l14.10"></a><span id="l14.10">     do_check_transaction(transaction, []);*/</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    // Test - newsrc</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-    test = &quot;news:&quot;;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    server.resetTest();</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-    setupProtocolTest(NNTP_PORT, prefix+&quot;&quot;);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    server.performTest();</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    transaction = server.playTransaction();</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    do_check_transaction(transaction, [&quot;MODE READER&quot;].concat(</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-          groups.filter(function (group) { return group[1]; })</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-                .map(function (group) { return &quot;GROUP &quot;+group[0]; })));</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22">     // Test - getting an article</span>
<a href="#l14.23"></a><span id="l14.23">     test = &quot;news:MESSAGE_ID&quot;;</span>
<a href="#l14.24"></a><span id="l14.24">     server.resetTest();</span>
<a href="#l14.25"></a><span id="l14.25">     setupProtocolTest(NNTP_PORT, prefix+&quot;TSS1@nntp.test&quot;);</span>
<a href="#l14.26"></a><span id="l14.26">     server.performTest();</span>
<a href="#l14.27"></a><span id="l14.27">     transaction = server.playTransaction();</span>
<a href="#l14.28"></a><span id="l14.28">     do_check_transaction(transaction, [&quot;MODE READER&quot;,</span>
<a href="#l14.29"></a><span id="l14.29">         &quot;ARTICLE &lt;TSS1@nntp.test&gt;&quot;]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mailnews/test/resources/filterTestUtils.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,75 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+// Utility functions for testing interactions with filters.</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+var contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+// This maps strings to a filter attribute (excluding the parameter)</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+var ATTRIB_MAP = {</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+  // Template : [attrib, op, field of value, otherHeader]</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+  &quot;subject&quot; : [Ci.nsMsgSearchAttrib.Subject, contains, &quot;str&quot;, null],</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  &quot;from&quot; : [Ci.nsMsgSearchAttrib.Sender, contains, &quot;str&quot;, null],</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  &quot;date&quot; : [Ci.nsMsgSearchAttrib.Date, Ci.nsMsgSearchOp.Is, &quot;date&quot;, null],</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  &quot;size&quot; : [Ci.nsMsgSearchAttrib.Size, Ci.nsMsgSearchOp.Is, &quot;size&quot;, null],</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  &quot;message-id&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+1, contains, &quot;str&quot;,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+                  &quot;Message-ID&quot;],</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  &quot;user-agent&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+2, contains, &quot;str&quot;,</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+                  &quot;User-Agent&quot;]</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+};</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+// And this maps strings to filter actions</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+var ACTION_MAP = {</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  // Template : [action, auxiliary attribute field, auxiliary value]</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+  &quot;priority&quot; : [Ci.nsMsgFilterAction.ChangePriority, &quot;priority&quot;, 6],</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  &quot;delete&quot; : [Ci.nsMsgFilterAction.Delete],</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  &quot;read&quot; : [Ci.nsMsgFilterAction.MarkRead],</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+  &quot;kill&quot; : [Ci.nsMsgFilterAction.KillThread],</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+  &quot;watch&quot; : [Ci.nsMsgFilterAction.WatchThread],</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  &quot;flag&quot; : [Ci.nsMsgFilterAction.MarkFlagged],</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  &quot;stop&quot;: [Ci.nsMsgFilterAction.StopExecution],</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  &quot;tag&quot; : [Ci.nsMsgFilterAction.AddTag, &quot;strValue&quot;, &quot;tag&quot;]</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+};</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+/**</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * Creates a filter and appends it to the nsIMsgFilterList.</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ *</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * @param list    An nsIMsgFilter to which the new filter will be appended.</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * @param trigger A key of ATTRIB_MAP that represents the filter trigger.</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * @param value   The value of the filter trigger.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ * @param action  A key of ACTION_MAP that represents the action to be taken.</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ */</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+function createFilter(list, trigger, value, action) {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  var filter = list.createFilter(trigger + action + &quot;Test&quot;);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  filter.filterType = Ci.nsMsgFilterType.NewsRule;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  var searchTerm = filter.createTerm();</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  searchTerm.matchAll = false;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  if (trigger in ATTRIB_MAP) {</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+    let information = ATTRIB_MAP[trigger];</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    searchTerm.attrib = information[0];</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+    if (information[3] != null)</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+      searchTerm.arbitraryHeader = information[3];</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+    searchTerm.op = information[1];</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+    var oldValue = searchTerm.value;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+    oldValue.attrib = information[0];</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+    oldValue[information[2]] = value;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+    searchTerm.value = oldValue;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  } else {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    throw &quot;Unknown trigger &quot; + trigger;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  }</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  searchTerm.booleanAnd = true;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  filter.appendTerm(searchTerm);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  var filterAction = filter.createAction();</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  if (action in ACTION_MAP) {</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+    let information = ACTION_MAP[action];</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+    filterAction.type = information[0];</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+    if (1 in information)</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+      filterAction[information[1]] = information[2];</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  } else {</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+    throw &quot;Unknown action &quot; + action;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  }</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  filter.appendAction(filterAction);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  filter.enabled = true;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  // Add to the end</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  list.insertFilterAt(list.filterCount, filter);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+}</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/news.properties</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/news.properties</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -49,21 +49,20 @@ messageCancelled=Message cancelled.</span>
<a href="#l16.4"></a><span id="l16.4"> enterUsername=Please enter a username for news server access:</span>
<a href="#l16.5"></a><span id="l16.5"> enterUsernameTitle=News Server Username Required</span>
<a href="#l16.6"></a><span id="l16.6"> saveUsername=Use Password Manager to remember this value.</span>
<a href="#l16.7"></a><span id="l16.7"> enterPassword=Please enter a password for news server access:</span>
<a href="#l16.8"></a><span id="l16.8"> enterPasswordTitle=News Server Password Required</span>
<a href="#l16.9"></a><span id="l16.9"> okButtonText=Download</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> noNewMessages=There are no new messages on the server.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-downloadingHeaders=Downloading %S of %S headers</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-downloadingFilterHeaders=Getting headers for filters: %S (%S/%S)</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+newNewsgroupHeaders=Downloading %S of %S headers on %S</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+newNewsgroupFilteringHeaders=Getting headers for filters: %S (%S/%S) on %S</span>
<a href="#l16.16"></a><span id="l16.16"> downloadingArticles=Downloading articles %S-%S</span>
<a href="#l16.17"></a><span id="l16.17"> bytesReceived=Downloading newsgroups: %S received (%SKB read at %SKB/sec)</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-checkingForNewNews=Checking newsgroup %S of %S on %S for new messages</span>
<a href="#l16.19"></a><span id="l16.19"> downloadingArticlesForOffline=Downloading articles %S-%S in %S</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> onlyCancelOneMessage=You can only cancel one article at a time.</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23"> # LOCALIZATION NOTE (autoUnsubscribeText): %1$S is the newsgroup and %2$S is the newsgroup-server it is being removed from.</span>
<a href="#l16.24"></a><span id="l16.24"> autoUnsubscribeText=The newsgroup %1$S does not appear to exist on the host %2$S.  Would you like to unsubscribe from it?</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> # LOCALIZATION NOTE (autoSubscribeText): %1$S is the newsgroup.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

