<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28819:81b27762e885346226b97124cdea45a96fe15d08</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 81b27762e885346226b97124cdea45a96fe15d08" />
<meta property="og:url" content="/comm-central/rev/81b27762e885346226b97124cdea45a96fe15d08" />
<meta property="og:description" content="Bug 1616558, remove code for gnupg subprocess execution and gpg-agent interaction. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 81b27762e885346226b97124cdea45a96fe15d08 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/81b27762e885346226b97124cdea45a96fe15d08">shortlog</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/81b27762e885346226b97124cdea45a96fe15d08">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08">files</a> |
changeset |
<a href="/comm-central/raw-rev/81b27762e885346226b97124cdea45a96fe15d08">raw</a>  | <a href="/comm-central/archive/81b27762e885346226b97124cdea45a96fe15d08.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1616558">Bug 1616558</a>, remove code for gnupg subprocess execution and gpg-agent interaction. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 19 Feb 2020 15:06:36 +0100</td></tr>

<tr>
 <td>changeset 28819</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/81b27762e885346226b97124cdea45a96fe15d08">81b27762e885346226b97124cdea45a96fe15d08</a></td>
</tr>



<tr>
<td>parent 28818</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0eec44e4527301489f7255c61b2ec51b62d1e392">0eec44e4527301489f7255c61b2ec51b62d1e392</a>
</td>
</tr>

<tr>
<td>child 28820</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/59fc6dacc978d7a7ed090927f311f845b78084a4">59fc6dacc978d7a7ed090927f311f845b78084a4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=81b27762e885346226b97124cdea45a96fe15d08">17055</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Sat, 22 Feb 2020 11:56:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6c75755a02eb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6c75755a02eb770ba6a25edb88d7e5dce9c40c20">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6c75755a02eb770ba6a25edb88d7e5dce9c40c20&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c75755a02eb770ba6a25edb88d7e5dce9c40c20&newProject=comm-central&newRevision=81b27762e885346226b97124cdea45a96fe15d08&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c75755a02eb770ba6a25edb88d7e5dce9c40c20&newProject=comm-central&newRevision=81b27762e885346226b97124cdea45a96fe15d08&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c75755a02eb770ba6a25edb88d7e5dce9c40c20&newProject=comm-central&newRevision=81b27762e885346226b97124cdea45a96fe15d08&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1616558">1616558</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1616558">Bug 1616558</a>, remove code for gnupg subprocess execution and gpg-agent interaction. r=PatrickBrunschwig

Differential Revision: <a href="https://phabricator.services.mozilla.com/D63325">https://phabricator.services.mozilla.com/D63325</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/BondOpenPGP.jsm">mail/extensions/openpgp/content/BondOpenPGP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/BondOpenPGP.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/BondOpenPGP.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/BondOpenPGP.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/BondOpenPGP.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/BondOpenPGP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/autocrypt.jsm">mail/extensions/openpgp/content/modules/autocrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/autocrypt.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/autocrypt.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/autocrypt.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/autocrypt.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/autocrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/card.jsm">mail/extensions/openpgp/content/modules/card.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/card.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/card.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/card.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/core.jsm">mail/extensions/openpgp/content/modules/core.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/core.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/core.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/core.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/core.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/core.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/data.jsm">mail/extensions/openpgp/content/modules/data.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/data.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/data.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/data.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/data.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/data.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/decryption.jsm">mail/extensions/openpgp/content/modules/decryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/decryption.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/decryption.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/decryption.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/decryption.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/decryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/dns.jsm">mail/extensions/openpgp/content/modules/dns.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/dns.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/dns.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/dns.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/encryption.jsm">mail/extensions/openpgp/content/modules/encryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/encryption.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/encryption.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/encryption.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/encryption.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/encryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_common.jsm">mail/extensions/openpgp/content/modules/enigmailprocess_common.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_common.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_common.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_common.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_main.jsm">mail/extensions/openpgp/content/modules/enigmailprocess_main.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_main.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_main.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_main.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared.js">mail/extensions/openpgp/content/modules/enigmailprocess_shared.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_unix.js">mail/extensions/openpgp/content/modules/enigmailprocess_shared_unix.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_unix.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_unix.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_unix.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_win.js">mail/extensions/openpgp/content/modules/enigmailprocess_shared_win.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_win.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_win.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_shared_win.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_unix.jsm">mail/extensions/openpgp/content/modules/enigmailprocess_unix.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_unix.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_unix.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_unix.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_win.jsm">mail/extensions/openpgp/content/modules/enigmailprocess_win.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_win.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_win.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_win.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_common.js">mail/extensions/openpgp/content/modules/enigmailprocess_worker_common.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_common.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_common.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_common.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_unix.js">mail/extensions/openpgp/content/modules/enigmailprocess_worker_unix.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_unix.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_unix.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_unix.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_win.js">mail/extensions/openpgp/content/modules/enigmailprocess_worker_win.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_win.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_win.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/enigmailprocess_worker_win.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/errorHandling.jsm">mail/extensions/openpgp/content/modules/errorHandling.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/errorHandling.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/errorHandling.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/errorHandling.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/errorHandling.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/errorHandling.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/execution.jsm">mail/extensions/openpgp/content/modules/execution.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/execution.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/execution.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/execution.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpg.jsm">mail/extensions/openpgp/content/modules/gpg.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpg.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpg.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpg.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpg.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpg.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpgAgent.jsm">mail/extensions/openpgp/content/modules/gpgAgent.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpgAgent.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpgAgent.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/gpgAgent.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyEditor.jsm">mail/extensions/openpgp/content/modules/keyEditor.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyEditor.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyEditor.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyEditor.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyserver.jsm">mail/extensions/openpgp/content/modules/keyserver.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyserver.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyserver.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyserver.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyserver.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/keyserver.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/localizeHtml.jsm">mail/extensions/openpgp/content/modules/localizeHtml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/localizeHtml.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/localizeHtml.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/localizeHtml.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/localizeHtml.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/localizeHtml.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/msgRead.jsm">mail/extensions/openpgp/content/modules/msgRead.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/msgRead.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/msgRead.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/msgRead.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/msgRead.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/msgRead.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/os.jsm">mail/extensions/openpgp/content/modules/os.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/os.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/os.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/os.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/os.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/os.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/passwords.jsm">mail/extensions/openpgp/content/modules/passwords.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/passwords.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/passwords.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/passwords.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/persistentCrypto.jsm">mail/extensions/openpgp/content/modules/persistentCrypto.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/persistentCrypto.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/persistentCrypto.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/persistentCrypto.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/persistentCrypto.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/persistentCrypto.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/subprocess.jsm">mail/extensions/openpgp/content/modules/subprocess.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/subprocess.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/subprocess.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/subprocess.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/system.jsm">mail/extensions/openpgp/content/modules/system.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/system.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/system.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/system.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/tor.jsm">mail/extensions/openpgp/content/modules/tor.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/tor.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/tor.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/tor.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/versioning.jsm">mail/extensions/openpgp/content/modules/versioning.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/versioning.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/versioning.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/versioning.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/versioning.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/versioning.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/webKey.jsm">mail/extensions/openpgp/content/modules/webKey.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/webKey.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/webKey.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/webKey.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/webKey.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/webKey.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/wkdLookup.jsm">mail/extensions/openpgp/content/modules/wkdLookup.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/wkdLookup.jsm">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/wkdLookup.jsm">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/wkdLookup.jsm">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/wkdLookup.jsm">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/modules/wkdLookup.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/strings/enigmail.properties">mail/extensions/openpgp/content/strings/enigmail.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/strings/enigmail.properties">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/strings/enigmail.properties">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/strings/enigmail.properties">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/strings/enigmail.properties">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/strings/enigmail.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailCommon.js">mail/extensions/openpgp/content/ui/enigmailCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailCommon.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailCommon.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailCommon.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailCommon.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">mail/extensions/openpgp/content/ui/enigmailKeyManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">mail/extensions/openpgp/content/ui/enigmailKeySelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeygen.js">mail/extensions/openpgp/content/ui/enigmailKeygen.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeygen.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeygen.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeygen.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeygen.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailKeygen.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/prefs/openpgp-prefs.js">mail/extensions/openpgp/prefs/openpgp-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/prefs/openpgp-prefs.js">file</a> |
<a href="/comm-central/annotate/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/prefs/openpgp-prefs.js">annotate</a> |
<a href="/comm-central/diff/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/prefs/openpgp-prefs.js">diff</a> |
<a href="/comm-central/comparison/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/prefs/openpgp-prefs.js">comparison</a> |
<a href="/comm-central/log/81b27762e885346226b97124cdea45a96fe15d08/mail/extensions/openpgp/prefs/openpgp-prefs.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/openpgp/content/BondOpenPGP.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/BondOpenPGP.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -48,25 +48,19 @@ var BondOpenPGP = {</span>
<a href="#l1.4"></a><span id="l1.4">   },</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">   initDone: false,</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   init() {</span>
<a href="#l1.9"></a><span id="l1.9">     if (!MailConstants.MOZ_OPENPGP) {</span>
<a href="#l1.10"></a><span id="l1.10">       return;</span>
<a href="#l1.11"></a><span id="l1.11">     }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    const engine = Services.prefs.getIntPref(&quot;temp.openpgp.engine&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    if (!engine) {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-      return;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    }</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-</span>
<a href="#l1.17"></a><span id="l1.17">     if (this.initDone) {</span>
<a href="#l1.18"></a><span id="l1.18">       return;</span>
<a href="#l1.19"></a><span id="l1.19">     }</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-</span>
<a href="#l1.21"></a><span id="l1.21">     this.initDone = true;</span>
<a href="#l1.22"></a><span id="l1.22">     console.log(&quot;loading OpenPGP&quot;);</span>
<a href="#l1.23"></a><span id="l1.23">     try {</span>
<a href="#l1.24"></a><span id="l1.24">       getRNP().init({});</span>
<a href="#l1.25"></a><span id="l1.25">       //TODO: check RNP.libLoaded</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">       getEnigmailApp().initAddon();</span>
<a href="#l1.28"></a><span id="l1.28">       getEnigmailAmPrefsService().startup(0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/autocrypt.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/autocrypt.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -28,17 +28,16 @@ const EnigmailKey = ChromeUtils.import(&quot;</span>
<a href="#l2.4"></a><span id="l2.4"> const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l2.5"></a><span id="l2.5"> const EnigmailOpenPGP = ChromeUtils.import(&quot;chrome://openpgp/content/modules/openpgp.jsm&quot;).EnigmailOpenPGP;</span>
<a href="#l2.6"></a><span id="l2.6"> const EnigmailRNG = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rng.jsm&quot;).EnigmailRNG;</span>
<a href="#l2.7"></a><span id="l2.7"> const EnigmailSend = ChromeUtils.import(&quot;chrome://openpgp/content/modules/send.jsm&quot;).EnigmailSend;</span>
<a href="#l2.8"></a><span id="l2.8"> const EnigmailStreams = ChromeUtils.import(&quot;chrome://openpgp/content/modules/streams.jsm&quot;).EnigmailStreams;</span>
<a href="#l2.9"></a><span id="l2.9"> const EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l2.10"></a><span id="l2.10"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l2.11"></a><span id="l2.11"> const EnigmailRules = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rules.jsm&quot;).EnigmailRules;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-const EnigmailKeyEditor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyEditor.jsm&quot;).EnigmailKeyEditor;</span>
<a href="#l2.13"></a><span id="l2.13"> const EnigmailStdlib = ChromeUtils.import(&quot;chrome://openpgp/content/modules/stdlib.jsm&quot;).EnigmailStdlib;</span>
<a href="#l2.14"></a><span id="l2.14"> const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l2.15"></a><span id="l2.15"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l2.16"></a><span id="l2.16"> const EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> var gCreatedSetupIds = [];</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> var EnigmailAutocrypt = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/card.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,33 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/*</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">- */</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailCard&quot;];</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-var EnigmailCard = {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  getCardStatus: function(exitCodeObj, errorMsgObj) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    EnigmailLog.DEBUG(&quot;card.jsm: EnigmailCard.getCardStatus\n&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    const GPG_ADDITIONAL_OPTIONS=[&quot;--no-verbose&quot;, &quot;--status-fd&quot;, &quot;2&quot;, &quot;--fixed-list-mode&quot;, &quot;--with-colons&quot;, &quot;--card-status&quot;];</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(false).concat(GPG_ADDITIONAL_OPTIONS);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    const statusMsgObj = {};</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    const statusFlagsObj = {};</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-    const outputTxt = EnigmailExecution.execCmd(EnigmailGpg.agentPath, args, &quot;&quot;, exitCodeObj, statusFlagsObj, statusMsgObj, errorMsgObj);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    if ((exitCodeObj.value === 0) &amp;&amp; !outputTxt) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-      exitCodeObj.value = -1;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    }</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    return outputTxt;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  }</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -8,23 +8,21 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &quot;use strict&quot;;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> const {</span>
<a href="#l4.7"></a><span id="l4.7">   manager: Cm,</span>
<a href="#l4.8"></a><span id="l4.8">   Constructor: CC</span>
<a href="#l4.9"></a><span id="l4.9"> } = Components;</span>
<a href="#l4.10"></a><span id="l4.10"> Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l4.13"></a><span id="l4.13"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l4.14"></a><span id="l4.14"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> // load all modules lazily to avoid possible cross-reference errors</span>
<a href="#l4.17"></a><span id="l4.17"> const getEnigmailConsole = EnigmailLazy.loader(&quot;enigmail/pipeConsole.jsm&quot;, &quot;EnigmailConsole&quot;);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-//const getEnigmailGpgAgent = EnigmailLazy.loader(&quot;enigmail/gpgAgent.jsm&quot;, &quot;EnigmailGpgAgent&quot;);</span>
<a href="#l4.19"></a><span id="l4.19"> const getEnigmailMimeEncrypt = EnigmailLazy.loader(&quot;enigmail/mimeEncrypt.jsm&quot;, &quot;EnigmailMimeEncrypt&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> const getEnigmailProtocolHandler = EnigmailLazy.loader(&quot;enigmail/protocolHandler.jsm&quot;, &quot;EnigmailProtocolHandler&quot;);</span>
<a href="#l4.21"></a><span id="l4.21"> const getEnigmailFiltersWrapper = EnigmailLazy.loader(&quot;enigmail/filtersWrapper.jsm&quot;, &quot;EnigmailFiltersWrapper&quot;);</span>
<a href="#l4.22"></a><span id="l4.22"> const getEnigmailLog = EnigmailLazy.loader(&quot;enigmail/log.jsm&quot;, &quot;EnigmailLog&quot;);</span>
<a href="#l4.23"></a><span id="l4.23"> const getEnigmailOS = EnigmailLazy.loader(&quot;enigmail/os.jsm&quot;, &quot;EnigmailOS&quot;);</span>
<a href="#l4.24"></a><span id="l4.24"> const getEnigmailLocale = EnigmailLazy.loader(&quot;enigmail/locale.jsm&quot;, &quot;EnigmailLocale&quot;);</span>
<a href="#l4.25"></a><span id="l4.25"> const getEnigmailCommandLine = EnigmailLazy.loader(&quot;enigmail/commandLine.jsm&quot;, &quot;EnigmailCommandLine&quot;);</span>
<a href="#l4.26"></a><span id="l4.26"> const getEnigmailPrefs = EnigmailLazy.loader(&quot;enigmail/prefs.jsm&quot;, &quot;EnigmailPrefs&quot;);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineat">@@ -117,17 +115,16 @@ var EnigmailCore = {</span>
<a href="#l4.28"></a><span id="l4.28">       for (let fct of this.factories) {</span>
<a href="#l4.29"></a><span id="l4.29">         fct.unregister();</span>
<a href="#l4.30"></a><span id="l4.30">       }</span>
<a href="#l4.31"></a><span id="l4.31">     }</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33">     getEnigmailFiltersWrapper().onShutdown();</span>
<a href="#l4.34"></a><span id="l4.34">     getEnigmailVerify().unregisterContentTypeHandler();</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-    //getEnigmailGpgAgent().finalize();</span>
<a href="#l4.37"></a><span id="l4.37">     getEnigmailLocale().shutdown();</span>
<a href="#l4.38"></a><span id="l4.38">     getEnigmailLog().onShutdown();</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">     getEnigmailLog().setLogLevel(3);</span>
<a href="#l4.41"></a><span id="l4.41">     gEnigmailService = null;</span>
<a href="#l4.42"></a><span id="l4.42">   },</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">   version: &quot;&quot;,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineat">@@ -218,39 +215,16 @@ function initializeLogging(env) {</span>
<a href="#l4.46"></a><span id="l4.46">   const matches = nspr_log_modules.match(/enigmail.js:(\d+)/);</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">   if (matches &amp;&amp; (matches.length &gt; 1)) {</span>
<a href="#l4.49"></a><span id="l4.49">     getEnigmailLog().setLogLevel(Number(matches[1]));</span>
<a href="#l4.50"></a><span id="l4.50">     getEnigmailLog().WARNING(&quot;core.jsm: Enigmail: LogLevel=&quot; + matches[1] + &quot;\n&quot;);</span>
<a href="#l4.51"></a><span id="l4.51">   }</span>
<a href="#l4.52"></a><span id="l4.52"> }</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-function initializeSubprocessLogging(env) {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  const nspr_log_modules = env.get(&quot;NSPR_LOG_MODULES&quot;);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  const matches = nspr_log_modules.match(/subprocess:(\d+)/);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  subprocess.registerLogHandler(function(txt) {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-    getEnigmailLog().ERROR(&quot;subprocess.jsm: &quot; + txt);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  });</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-  if (matches &amp;&amp; matches.length &gt; 1 &amp;&amp; matches[1] &gt; 2) {</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-    subprocess.registerDebugHandler(function(txt) {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-      getEnigmailLog().DEBUG(&quot;subprocess.jsm: &quot; + txt);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    });</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  }</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-}</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-function initializeAgentInfo() {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  return;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  if (!getEnigmailOS().isDosLike &amp;&amp; !getEnigmailGpgAgent().isDummy()) {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    EnigmailCore.addToEnvList(&quot;GPG_AGENT_INFO=&quot; + getEnigmailGpgAgent().gpgAgentInfo.envStr);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-}</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-</span>
<a href="#l4.77"></a><span id="l4.77"> function failureOn(ex, status) {</span>
<a href="#l4.78"></a><span id="l4.78">   status.initializationError = getEnigmailLocale().getString(&quot;enigmailNotAvailable&quot;);</span>
<a href="#l4.79"></a><span id="l4.79">   getEnigmailLog().ERROR(&quot;core.jsm: Enigmail.initialize: Error - &quot; + status.initializationError + &quot;\n&quot;);</span>
<a href="#l4.80"></a><span id="l4.80">   getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.initialize: exception=&quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l4.81"></a><span id="l4.81">   throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l4.82"></a><span id="l4.82"> }</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84"> function getEnvironment(status) {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineat">@@ -335,45 +309,38 @@ Enigmail.prototype = {</span>
<a href="#l4.86"></a><span id="l4.86">     this.initializationAttempted = true;</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.initialize: START\n&quot;);</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">     if (this.initialized) return;</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">     this.environment = getEnvironment(this);</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-    initializeSubprocessLogging(this.environment);</span>
<a href="#l4.95"></a><span id="l4.95">     initializeEnvironment(this.environment);</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">     try {</span>
<a href="#l4.98"></a><span id="l4.98">       getEnigmailConsole().write(&quot;Initializing Enigmail service ...\n&quot;);</span>
<a href="#l4.99"></a><span id="l4.99">     } catch (ex) {</span>
<a href="#l4.100"></a><span id="l4.100">       failureOn(ex, this);</span>
<a href="#l4.101"></a><span id="l4.101">     }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-    //getEnigmailGpgAgent().setAgentPath(domWindow, this, gPreferredGpgPath);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    //getEnigmailGpgAgent().detectGpgAgent(domWindow, this);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-    //initializeAgentInfo();</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-</span>
<a href="#l4.108"></a><span id="l4.108">     //getEnigmailKeyRefreshService().start(getEnigmailKeyServer());</span>
<a href="#l4.109"></a><span id="l4.109"> </span>
<a href="#l4.110"></a><span id="l4.110">     this.initialized = true;</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.initialize: END\n&quot;);</span>
<a href="#l4.113"></a><span id="l4.113">   },</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115">   reinitialize: function() {</span>
<a href="#l4.116"></a><span id="l4.116">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.reinitialize:\n&quot;);</span>
<a href="#l4.117"></a><span id="l4.117">     this.initialized = false;</span>
<a href="#l4.118"></a><span id="l4.118">     this.initializationAttempted = true;</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120">     getEnigmailConsole().write(&quot;Reinitializing Enigmail service ...\n&quot;);</span>
<a href="#l4.121"></a><span id="l4.121">     initializeEnvironment(this.environment);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    //getEnigmailGpgAgent().setAgentPath(null, this, gPreferredGpgPath);</span>
<a href="#l4.123"></a><span id="l4.123">     this.initialized = true;</span>
<a href="#l4.124"></a><span id="l4.124">   },</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126">   perferGpgPath: function(gpgPath) {</span>
<a href="#l4.127"></a><span id="l4.127">     getEnigmailLog().DEBUG(&quot;core.jsm: Enigmail.perferGpgPath = &quot; + gpgPath + &quot;\n&quot;);</span>
<a href="#l4.128"></a><span id="l4.128">     gPreferredGpgPath = gpgPath;</span>
<a href="#l4.129"></a><span id="l4.129">   },</span>
<a href="#l4.130"></a><span id="l4.130"> </span>
<a href="#l4.131"></a><span id="l4.131" class="difflineat">@@ -439,23 +406,16 @@ Enigmail.prototype = {</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133">         return null;</span>
<a href="#l4.134"></a><span id="l4.134">       }</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">       const configuredVersion = getEnigmailPrefs().getPref(&quot;configuredVersion&quot;);</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">       getEnigmailLog().DEBUG(&quot;core.jsm: getService: last used version: &quot; + configuredVersion + &quot;\n&quot;);</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-      /*</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-      if (firstInitialization &amp;&amp; this.initialized &amp;&amp;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-        getEnigmailGpgAgent().agentType === &quot;pgp&quot;) {</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-        getEnigmailDialog().alert(win, getEnigmailLocale().getString(&quot;pgpNotSupported&quot;));</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-      }</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-      */</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-</span>
<a href="#l4.147"></a><span id="l4.147">       if (this.initialized &amp;&amp; (getEnigmailApp().getVersion() != configuredVersion)) {</span>
<a href="#l4.148"></a><span id="l4.148">         getEnigmailConfigure().configureEnigmail(win, startingPreferences);</span>
<a href="#l4.149"></a><span id="l4.149">       }</span>
<a href="#l4.150"></a><span id="l4.150">     }</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152">     return this.initialized ? this : null;</span>
<a href="#l4.153"></a><span id="l4.153">   }</span>
<a href="#l4.154"></a><span id="l4.154"> }; // Enigmail.prototype</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,33 +1,33 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /*</span>
<a href="#l5.5"></a><span id="l5.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.8"></a><span id="l5.8">  */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-</span>
<a href="#l5.11"></a><span id="l5.11"> &quot;use strict&quot;;</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> var EXPORTED_SYMBOLS = [&quot;EnigmailCryptoAPI&quot;];</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> var gCurrentApi = null;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+var gGnuPGApi = null;</span>
<a href="#l5.17"></a><span id="l5.17"> var Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> function EnigmailCryptoAPI() {</span>
<a href="#l5.20"></a><span id="l5.20">   if (!gCurrentApi) {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-    const gOpenPGPEngine = Services.prefs.getIntPref(&quot;temp.openpgp.engine&quot;);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-    </span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-    if (gOpenPGPEngine == 1) {</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-      const {</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-        getRNPAPI</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-      } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm&quot;);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-      gCurrentApi = getRNPAPI();</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    } else if (gOpenPGPEngine == 2) {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-      const {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-        getGnuPGAPI</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm&quot;);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-      gCurrentApi = getGnuPGAPI();</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    }</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+    const {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+      getRNPAPI</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm&quot;);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+    gCurrentApi = getRNPAPI();</span>
<a href="#l5.38"></a><span id="l5.38">   }</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-</span>
<a href="#l5.40"></a><span id="l5.40">   return gCurrentApi;</span>
<a href="#l5.41"></a><span id="l5.41"> }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+function EnigmailGnuPGAPI() {</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  if (!gGnuPGApi) {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+    const {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+      getGnuPGAPI</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm&quot;);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    gGnuPGApi = getGnuPGAPI();</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  }</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  return gGnuPGApi;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -14,29 +14,25 @@ var Services = Components.utils.import(&quot;</span>
<a href="#l6.4"></a><span id="l6.4"> Services.scriptloader.loadSubScript(&quot;chrome://openpgp/content/modules/cryptoAPI/interface.js&quot;,</span>
<a href="#l6.5"></a><span id="l6.5">   null, &quot;UTF-8&quot;); /* global CryptoAPI */</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> /* global getOpenPGP: false, EnigmailLog: false */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l6.10"></a><span id="l6.10"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l6.11"></a><span id="l6.11"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l6.13"></a><span id="l6.13"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l6.14"></a><span id="l6.14"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l6.15"></a><span id="l6.15"> const EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l6.16"></a><span id="l6.16"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l6.17"></a><span id="l6.17"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-const EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l6.19"></a><span id="l6.19"> const EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-const GnuPGDecryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm&quot;).GnuPGDecryption;</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> const {</span>
<a href="#l6.23"></a><span id="l6.23">   obtainKeyList,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  createKeyObj,</span>
<a href="#l6.25"></a><span id="l6.25">   getPhotoFileFromGnuPG,</span>
<a href="#l6.26"></a><span id="l6.26">   extractSignatures,</span>
<a href="#l6.27"></a><span id="l6.27">   getGpgKeyData</span>
<a href="#l6.28"></a><span id="l6.28"> } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm&quot;);</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> const {</span>
<a href="#l6.31"></a><span id="l6.31">   GnuPG_importKeyFromFile,</span>
<a href="#l6.32"></a><span id="l6.32">   GnuPG_extractSecretKey</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineat">@@ -59,76 +55,26 @@ class GnuPGCryptoAPI extends CryptoAPI {</span>
<a href="#l6.34"></a><span id="l6.34">    * @return {Promise&lt;Array of Object&gt;}</span>
<a href="#l6.35"></a><span id="l6.35">    */</span>
<a href="#l6.36"></a><span id="l6.36">   async getKeys(onlyKeys = null) {</span>
<a href="#l6.37"></a><span id="l6.37">     let keyList = await obtainKeyList(onlyKeys);</span>
<a href="#l6.38"></a><span id="l6.38">     return keyList.keys;</span>
<a href="#l6.39"></a><span id="l6.39">   }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   /**</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-   * Get groups defined in gpg.conf in the same structure as KeyObject</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-   *</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-   * @return {Array of KeyObject} with type = &quot;grp&quot;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-   */</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  getGroups() {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    let groups = EnigmailGpg.getGpgGroups();</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-    let r = [];</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    for (var i = 0; i &lt; groups.length; i++) {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-      let keyObj = createKeyObj([&quot;grp&quot;]);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-      keyObj.keyTrust = &quot;g&quot;;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-      keyObj.userId = EnigmailData.convertGpgToUnicode(groups[i].alias).replace(/\\e3A/g, &quot;:&quot;);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-      keyObj.keyId = keyObj.userId;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-      var grpMembers = EnigmailData.convertGpgToUnicode(groups[i].keylist).replace(/\\e3A/g, &quot;:&quot;).split(/[,;]/);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-      for (var grpIdx = 0; grpIdx &lt; grpMembers.length; grpIdx++) {</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-        keyObj.userIds.push({</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-          userId: grpMembers[grpIdx],</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-          keyTrust: &quot;q&quot;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-        });</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-      }</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-      r.push(keyObj);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-    }</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    return r;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  }</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  /**</span>
<a href="#l6.71"></a><span id="l6.71">    * Obtain signatures for a given set of key IDs.</span>
<a href="#l6.72"></a><span id="l6.72">    *</span>
<a href="#l6.73"></a><span id="l6.73">    * @param {String}  keyId:            space-separated list of key IDs</span>
<a href="#l6.74"></a><span id="l6.74">    * @param {Boolean} ignoreUnknownUid: if true, filter out unknown signer's UIDs</span>
<a href="#l6.75"></a><span id="l6.75">    *</span>
<a href="#l6.76"></a><span id="l6.76">    * @return {Promise&lt;Array of Object&gt;} - see extractSignatures()</span>
<a href="#l6.77"></a><span id="l6.77">    */</span>
<a href="#l6.78"></a><span id="l6.78">   async getKeySignatures(keyId, ignoreUnknownUid = false) {</span>
<a href="#l6.79"></a><span id="l6.79">     EnigmailLog.DEBUG(`gnupg.js: getKeySignatures: ${keyId}\n`);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(true).concat([&quot;--with-fingerprint&quot;, &quot;--fixed-list-mode&quot;, &quot;--with-colons&quot;, &quot;--list-sig&quot;]).concat(keyId.split(&quot; &quot;));</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-    let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, &quot;&quot;);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-    if (!(res.statusFlags &amp; EnigmailConstants.BAD_SIGNATURE)) {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-      // ignore exit code as recommended by GnuPG authors</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-      res.exitCode = 0;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    }</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    if (res.exitCode !== 0) {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-      if (res.errorMsg) {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-        res.errorMsg += &quot;\n&quot; + EnigmailFiles.formatCmdLine(EnigmailGpg.agentPath, args);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-        res.errorMsg += &quot;\n&quot; + res.errorMsg;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-      }</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    }</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-    if (res.stdoutData.length &gt; 0) {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-      return extractSignatures(res.stdoutData, ignoreUnknownUid);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-    }</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    return null;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l6.103"></a><span id="l6.103">   }</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105"> </span>
<a href="#l6.106"></a><span id="l6.106">   /**</span>
<a href="#l6.107"></a><span id="l6.107">    * Export the minimum key for the public key object:</span>
<a href="#l6.108"></a><span id="l6.108">    * public key, primary user ID, newest encryption subkey</span>
<a href="#l6.109"></a><span id="l6.109">    *</span>
<a href="#l6.110"></a><span id="l6.110">    * @param {String} fpr:                a single FPR</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineat">@@ -138,61 +84,17 @@ class GnuPGCryptoAPI extends CryptoAPI {</span>
<a href="#l6.112"></a><span id="l6.112">    *</span>
<a href="#l6.113"></a><span id="l6.113">    * @return {Promise&lt;Object&gt;}:</span>
<a href="#l6.114"></a><span id="l6.114">    *    - exitCode (0 = success)</span>
<a href="#l6.115"></a><span id="l6.115">    *    - errorMsg (if exitCode != 0)</span>
<a href="#l6.116"></a><span id="l6.116">    *    - keyData: BASE64-encded string of key data</span>
<a href="#l6.117"></a><span id="l6.117">    */</span>
<a href="#l6.118"></a><span id="l6.118">   async getMinimalPubKey(fpr, email, subkeyDates) {</span>
<a href="#l6.119"></a><span id="l6.119">     EnigmailLog.DEBUG(`gnupg.js: getMinimalPubKey: ${fpr}\n`);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-    let retObj = {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-      exitCode: 0,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-      errorMsg: &quot;&quot;,</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-      keyData: &quot;&quot;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-    };</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-    let minimalKeyBlock = null;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-    if (EnigmailGpg.getGpgFeature(&quot;export-specific-uid&quot;)) {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-      // Use GnuPG filters if possible</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-      let dropSubkeyFilter = &quot;usage!~e &amp;&amp; usage!~s&quot;;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-      if (subkeyDates &amp;&amp; subkeyDates.length &gt; 0) {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-        dropSubkeyFilter = subkeyDates.map(x =&gt; `key_created!=${x}`).join(&quot; &amp;&amp; &quot;);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-      }</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-      args = args.concat([&quot;--export-options&quot;, &quot;export-minimal,no-export-attributes&quot;,</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-        &quot;--export-filter&quot;, &quot;keep-uid=&quot; + (email ? &quot;mbox=&quot; + email : &quot;primary=1&quot;),</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-        &quot;--export-filter&quot;, &quot;drop-subkey=&quot; + dropSubkeyFilter,</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-        &quot;--export&quot;, fpr</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-      ]);</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-    } else {</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-      args = args.concat([&quot;--export-options&quot;, &quot;export-minimal,no-export-attributes&quot;, &quot;-a&quot;, &quot;--export&quot;, fpr]);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    }</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-    const statusObj = {};</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-    const exitCodeObj = {};</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-    let keyBlock = res.stdoutData;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-    // GnuPG 2.1.10+</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    if (!EnigmailGpg.getGpgFeature(&quot;export-result&quot;)) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-      retObj.exitCode = 2;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-      retObj.errorMsg = EnigmailLocale.getString(&quot;failKeyExtract&quot;);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-    }</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-    let r = new RegExp(&quot;^\\[GNUPG:\\] EXPORTED &quot; + fpr, &quot;m&quot;);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    if (res.stderrData.search(r) &lt; 0) {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-      retObj.exitCode = 2;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-      retObj.errorMsg = EnigmailLocale.getString(&quot;failKeyExtract&quot;);</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    }</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-    retObj.keyData = btoa(keyBlock);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    return retObj;</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l6.166"></a><span id="l6.166">   }</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168">   /**</span>
<a href="#l6.169"></a><span id="l6.169">    * Extract a photo ID from a key, store it as file and return the file object.</span>
<a href="#l6.170"></a><span id="l6.170">    *</span>
<a href="#l6.171"></a><span id="l6.171">    * @param {String} keyId:       Key ID / fingerprint</span>
<a href="#l6.172"></a><span id="l6.172">    * @param {Number} photoNumber: number of the photo on the key, starting with 0</span>
<a href="#l6.173"></a><span id="l6.173">    *</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineat">@@ -249,83 +151,50 @@ class GnuPGCryptoAPI extends CryptoAPI {</span>
<a href="#l6.175"></a><span id="l6.175">    *</span>
<a href="#l6.176"></a><span id="l6.176">    * @param {byte} byteData    The encrypted data</span>
<a href="#l6.177"></a><span id="l6.177">    *</span>
<a href="#l6.178"></a><span id="l6.178">    * @return {String or null} - the name of the attached file</span>
<a href="#l6.179"></a><span id="l6.179">    */</span>
<a href="#l6.180"></a><span id="l6.180"> </span>
<a href="#l6.181"></a><span id="l6.181">   async getFileName(byteData) {</span>
<a href="#l6.182"></a><span id="l6.182">     EnigmailLog.DEBUG(`gnupg.js: getFileName()\n`);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(true).concat(EnigmailPassword.command()).concat([&quot;--decrypt&quot;]);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, byteData + &quot;\n&quot;);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    const matches = res.stderrData.match(/^(\[GNUPG:\] PLAINTEXT [0-9]+ [0-9]+ )(.*)$/m);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-    if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-      var filename = matches[2];</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-      if (filename.indexOf(&quot; &quot;) &gt; 0) {</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-        filename = filename.replace(/ .*$/, &quot;&quot;);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-      }</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-      return EnigmailData.convertToUnicode(unescape(filename), &quot;utf-8&quot;);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    } else {</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-      return null;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    }</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l6.198"></a><span id="l6.198">   }</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200">   /**</span>
<a href="#l6.201"></a><span id="l6.201">    *</span>
<a href="#l6.202"></a><span id="l6.202">    * @param {Path} filePath    The signed file</span>
<a href="#l6.203"></a><span id="l6.203">    * @param {Path} sigPath       The signature to verify</span>
<a href="#l6.204"></a><span id="l6.204">    *</span>
<a href="#l6.205"></a><span id="l6.205">    * @return {Promise&lt;String&gt;} - A message from the verification.</span>
<a href="#l6.206"></a><span id="l6.206">    *</span>
<a href="#l6.207"></a><span id="l6.207">    * Use Promise.catch to handle failed verifications.</span>
<a href="#l6.208"></a><span id="l6.208">    * The message will be an error message in this case.</span>
<a href="#l6.209"></a><span id="l6.209">    */</span>
<a href="#l6.210"></a><span id="l6.210"> </span>
<a href="#l6.211"></a><span id="l6.211">   async verifyAttachment(filePath, sigPath) {</span>
<a href="#l6.212"></a><span id="l6.212">     EnigmailLog.DEBUG(`gnupg.js: verifyAttachment()\n`);</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(true).concat([&quot;--verify&quot;, sigPath, filePath]);</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-    let result = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-    const decrypted = {};</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-    GnuPGDecryption.decryptMessageEnd(result.stderrData, result.exitCode, 1, true, true, EnigmailConstants.UI_INTERACTIVE, decrypted);</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    if (result.exitCode === 0) {</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-      const detailArr = decrypted.sigDetails.split(/ /);</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-      const dateTime = EnigmailTime.getDateTime(detailArr[2], true, true);</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-      const msg1 = decrypted.errorMsg.split(/\n/)[0];</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-      const msg2 = EnigmailLocale.getString(&quot;keyAndSigDate&quot;, [&quot;0x&quot; + decrypted.keyId, dateTime]);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-      const message = msg1 + &quot;\n&quot; + msg2;</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-      return (message);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-    } else {</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-      throw (decrypted.errorMsg);</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-    }</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l6.228"></a><span id="l6.228">   }</span>
<a href="#l6.229"></a><span id="l6.229"> </span>
<a href="#l6.230"></a><span id="l6.230"> </span>
<a href="#l6.231"></a><span id="l6.231">   /**</span>
<a href="#l6.232"></a><span id="l6.232">    *</span>
<a href="#l6.233"></a><span id="l6.233">    * @param {Bytes}  encrypted     The encrypted data</span>
<a href="#l6.234"></a><span id="l6.234">    *</span>
<a href="#l6.235"></a><span id="l6.235">    * @return {Promise&lt;Object&gt;} - Return object with decryptedData and</span>
<a href="#l6.236"></a><span id="l6.236">    * status information</span>
<a href="#l6.237"></a><span id="l6.237">    *</span>
<a href="#l6.238"></a><span id="l6.238">    * Use Promise.catch to handle failed decryption.</span>
<a href="#l6.239"></a><span id="l6.239">    * retObj.errorMsg will be an error message in this case.</span>
<a href="#l6.240"></a><span id="l6.240">    */</span>
<a href="#l6.241"></a><span id="l6.241"> </span>
<a href="#l6.242"></a><span id="l6.242">   async decryptAttachment(encrypted) {</span>
<a href="#l6.243"></a><span id="l6.243">     EnigmailLog.DEBUG(`gnupg.js: decryptAttachment()\n`);</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-    args.push(&quot;--yes&quot;);</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-    args = args.concat(EnigmailPassword.command());</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-    args.push(&quot;-d&quot;);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-    let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, encrypted);</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-    return res;</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l6.253"></a><span id="l6.253">   }</span>
<a href="#l6.254"></a><span id="l6.254"> </span>
<a href="#l6.255"></a><span id="l6.255"> </span>
<a href="#l6.256"></a><span id="l6.256">   /**</span>
<a href="#l6.257"></a><span id="l6.257">    *</span>
<a href="#l6.258"></a><span id="l6.258">    * @param {String} encrypted     The encrypted data</span>
<a href="#l6.259"></a><span id="l6.259">    * @param {Object} options       Decryption options</span>
<a href="#l6.260"></a><span id="l6.260">    *</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineat">@@ -333,36 +202,17 @@ class GnuPGCryptoAPI extends CryptoAPI {</span>
<a href="#l6.262"></a><span id="l6.262">    * status information</span>
<a href="#l6.263"></a><span id="l6.263">    *</span>
<a href="#l6.264"></a><span id="l6.264">    * Use Promise.catch to handle failed decryption.</span>
<a href="#l6.265"></a><span id="l6.265">    * retObj.errorMsg will be an error message in this case.</span>
<a href="#l6.266"></a><span id="l6.266">    */</span>
<a href="#l6.267"></a><span id="l6.267"> </span>
<a href="#l6.268"></a><span id="l6.268">   async decrypt(encrypted, options) {</span>
<a href="#l6.269"></a><span id="l6.269">     EnigmailLog.DEBUG(`gnupg.js: decrypt()\n`);</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-    options.logFile = EnigmailErrorHandling.getTempLogFile();</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-    const args = GnuPGDecryption.getDecryptionArgs(options);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-    let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, encrypted);</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-    EnigmailErrorHandling.appendLogFileToDebug(options.logFile);</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-    if (res.statusFlags &amp; EnigmailConstants.MISSING_PASSPHRASE) {</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-      EnigmailLog.ERROR(&quot;decryption.jsm: decryptMessageStart: Error - no passphrase supplied\n&quot;);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-      throw {</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-        errorMsg: EnigmailLocale.getString(&quot;noPassphrase&quot;)</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-      };</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    }</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    const result = {</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-      exitCode: res.exitCode,</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-      decryptedData: res.stdoutData</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-    };</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-    GnuPGDecryption.decryptMessageEnd(res.stderrData, res.exitCode, res.stdoutData.length, options.verifyOnly, options.noOutput, options.uiFlags, result);</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-    return result;</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l6.291"></a><span id="l6.291">   }</span>
<a href="#l6.292"></a><span id="l6.292"> </span>
<a href="#l6.293"></a><span id="l6.293">   /**</span>
<a href="#l6.294"></a><span id="l6.294">    *</span>
<a href="#l6.295"></a><span id="l6.295">    * @param {String} encrypted     The encrypted data</span>
<a href="#l6.296"></a><span id="l6.296">    * @param {Object} options       Decryption options</span>
<a href="#l6.297"></a><span id="l6.297">    *</span>
<a href="#l6.298"></a><span id="l6.298">    * @return {Promise&lt;Object&gt;} - Return object with decryptedData and</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -35,31 +35,16 @@ const EnigmailTime = ChromeUtils.import(</span>
<a href="#l7.4"></a><span id="l7.4"> ).EnigmailTime;</span>
<a href="#l7.5"></a><span id="l7.5"> const EnigmailData = ChromeUtils.import(</span>
<a href="#l7.6"></a><span id="l7.6">   &quot;chrome://openpgp/content/modules/data.jsm&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> ).EnigmailData;</span>
<a href="#l7.8"></a><span id="l7.8"> const EnigmailLocale = ChromeUtils.import(</span>
<a href="#l7.9"></a><span id="l7.9">   &quot;chrome://openpgp/content/modules/locale.jsm&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> ).EnigmailLocale;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-/*</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-const {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  obtainKeyList,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  createKeyObj,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  getPhotoFileFromGnuPG,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  extractSignatures,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  getGpgKeyData</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-} = ChromeUtils.import(&quot;chrome://openpgp/content/cryptoAPI/gnupg-keylist.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-const {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  GnuPG_importKeyFromFile,</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  GnuPG_extractSecretKey</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-} = ChromeUtils.import(&quot;chrome://openpgp/content/cryptoAPI/gnupg-key.jsm&quot;);</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-*/</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-</span>
<a href="#l7.27"></a><span id="l7.27"> /**</span>
<a href="#l7.28"></a><span id="l7.28">  * RNP implementation of CryptoAPI</span>
<a href="#l7.29"></a><span id="l7.29">  */</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31"> class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l7.32"></a><span id="l7.32">   constructor() {</span>
<a href="#l7.33"></a><span id="l7.33">     super();</span>
<a href="#l7.34"></a><span id="l7.34">     this.api_name = &quot;RNP&quot;;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineat">@@ -71,57 +56,56 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l7.36"></a><span id="l7.36">    *</span>
<a href="#l7.37"></a><span id="l7.37">    * @return {Promise&lt;Array of Object&gt;}</span>
<a href="#l7.38"></a><span id="l7.38">    */</span>
<a href="#l7.39"></a><span id="l7.39">   async getKeys(onlyKeys = null) {</span>
<a href="#l7.40"></a><span id="l7.40">     return RNP.getKeys(onlyKeys);</span>
<a href="#l7.41"></a><span id="l7.41">   }</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">   /**</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-   * Get groups defined in gpg.conf in the same structure as KeyObject</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-   *</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-   * @return {Array of KeyObject} with type = &quot;grp&quot;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-   */</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  getGroups() {}</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  /**</span>
<a href="#l7.51"></a><span id="l7.51">    * Obtain signatures for a given set of key IDs.</span>
<a href="#l7.52"></a><span id="l7.52">    *</span>
<a href="#l7.53"></a><span id="l7.53">    * @param {String}  keyId:            space-separated list of key IDs</span>
<a href="#l7.54"></a><span id="l7.54">    * @param {Boolean} ignoreUnknownUid: if true, filter out unknown signer's UIDs</span>
<a href="#l7.55"></a><span id="l7.55">    *</span>
<a href="#l7.56"></a><span id="l7.56">    * @return {Promise&lt;Array of Object&gt;} - see extractSignatures()</span>
<a href="#l7.57"></a><span id="l7.57">    */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  async getKeySignatures(keyId, ignoreUnknownUid = false) {}</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  async getKeySignatures(keyId, ignoreUnknownUid = false) {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  }</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63">   /**</span>
<a href="#l7.64"></a><span id="l7.64">    * Export the minimum key for the public key object:</span>
<a href="#l7.65"></a><span id="l7.65">    * public key, primary user ID, newest encryption subkey</span>
<a href="#l7.66"></a><span id="l7.66">    *</span>
<a href="#l7.67"></a><span id="l7.67">    * @param {String} fpr:                a single FPR</span>
<a href="#l7.68"></a><span id="l7.68">    * @param {String} email:              [optional] the email address of the desired user ID.</span>
<a href="#l7.69"></a><span id="l7.69">    *                                     If the desired user ID cannot be found or is not valid, use the primary UID instead</span>
<a href="#l7.70"></a><span id="l7.70">    * @param {Array&lt;Number&gt;} subkeyDates: [optional] remove subkeys with sepcific creation Dates</span>
<a href="#l7.71"></a><span id="l7.71">    *</span>
<a href="#l7.72"></a><span id="l7.72">    * @return {Promise&lt;Object&gt;}:</span>
<a href="#l7.73"></a><span id="l7.73">    *    - exitCode (0 = success)</span>
<a href="#l7.74"></a><span id="l7.74">    *    - errorMsg (if exitCode != 0)</span>
<a href="#l7.75"></a><span id="l7.75">    *    - keyData: BASE64-encded string of key data</span>
<a href="#l7.76"></a><span id="l7.76">    */</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-  async getMinimalPubKey(fpr, email, subkeyDates) {}</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  async getMinimalPubKey(fpr, email, subkeyDates) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  }</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">   /**</span>
<a href="#l7.83"></a><span id="l7.83">    * Extract a photo ID from a key, store it as file and return the file object.</span>
<a href="#l7.84"></a><span id="l7.84">    *</span>
<a href="#l7.85"></a><span id="l7.85">    * @param {String} keyId:       Key ID / fingerprint</span>
<a href="#l7.86"></a><span id="l7.86">    * @param {Number} photoNumber: number of the photo on the key, starting with 0</span>
<a href="#l7.87"></a><span id="l7.87">    *</span>
<a href="#l7.88"></a><span id="l7.88">    * @return {nsIFile} object or null in case no data / error.</span>
<a href="#l7.89"></a><span id="l7.89">    */</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  async getPhotoFile(keyId, photoNumber) {}</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  async getPhotoFile(keyId, photoNumber) {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  }</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95">   async importKeyBlock(keyBlock) {</span>
<a href="#l7.96"></a><span id="l7.96">     // TODO: get status results</span>
<a href="#l7.97"></a><span id="l7.97">     let res = RNP.importKeyBlock(keyBlock);</span>
<a href="#l7.98"></a><span id="l7.98">     RNP.saveKeyRings();</span>
<a href="#l7.99"></a><span id="l7.99">     return res;</span>
<a href="#l7.100"></a><span id="l7.100">   }</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102" class="difflineat">@@ -132,66 +116,76 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l7.103"></a><span id="l7.103">    *</span>
<a href="#l7.104"></a><span id="l7.104">    * @return {Object} or null in case no data / error:</span>
<a href="#l7.105"></a><span id="l7.105">    *   - {Number}          exitCode:        result code (0: OK)</span>
<a href="#l7.106"></a><span id="l7.106">    *   - {Array of String) importedKeys:    imported fingerprints</span>
<a href="#l7.107"></a><span id="l7.107">    *   - {String}          errorMsg:        human readable error message</span>
<a href="#l7.108"></a><span id="l7.108">    *   - {Number}          importSum:       total number of processed keys</span>
<a href="#l7.109"></a><span id="l7.109">    *   - {Number}          importUnchanged: number of unchanged keys</span>
<a href="#l7.110"></a><span id="l7.110">    */</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-  async importKeyFromFile(inputFile) {}</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  async importKeyFromFile(inputFile) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  }</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116">   /**</span>
<a href="#l7.117"></a><span id="l7.117">    * Export secret key(s) to a file</span>
<a href="#l7.118"></a><span id="l7.118">    *</span>
<a href="#l7.119"></a><span id="l7.119">    * @param {String}  keyId      Specification by fingerprint or keyID</span>
<a href="#l7.120"></a><span id="l7.120">    * @param {Boolean} minimalKey  if true, reduce key to minimum required</span>
<a href="#l7.121"></a><span id="l7.121">    *</span>
<a href="#l7.122"></a><span id="l7.122">    * @return {Object}:</span>
<a href="#l7.123"></a><span id="l7.123">    *   - {Number} exitCode:  result code (0: OK)</span>
<a href="#l7.124"></a><span id="l7.124">    *   - {String} keyData:   ASCII armored key data material</span>
<a href="#l7.125"></a><span id="l7.125">    *   - {String} errorMsg:  error message in case exitCode !== 0</span>
<a href="#l7.126"></a><span id="l7.126">    */</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-  async extractSecretKey(keyId, minimalKey) {}</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  async extractSecretKey(keyId, minimalKey) {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+  }</span>
<a href="#l7.132"></a><span id="l7.132"> </span>
<a href="#l7.133"></a><span id="l7.133">   /**</span>
<a href="#l7.134"></a><span id="l7.134">    *</span>
<a href="#l7.135"></a><span id="l7.135">    * @param {byte} byteData    The encrypted data</span>
<a href="#l7.136"></a><span id="l7.136">    *</span>
<a href="#l7.137"></a><span id="l7.137">    * @return {String or null} - the name of the attached file</span>
<a href="#l7.138"></a><span id="l7.138">    */</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-  async getFileName(byteData) {}</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  async getFileName(byteData) {</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  }</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145">   /**</span>
<a href="#l7.146"></a><span id="l7.146">    *</span>
<a href="#l7.147"></a><span id="l7.147">    * @param {Path} filePath    The signed file</span>
<a href="#l7.148"></a><span id="l7.148">    * @param {Path} sigPath       The signature to verify</span>
<a href="#l7.149"></a><span id="l7.149">    *</span>
<a href="#l7.150"></a><span id="l7.150">    * @return {Promise&lt;String&gt;} - A message from the verification.</span>
<a href="#l7.151"></a><span id="l7.151">    *</span>
<a href="#l7.152"></a><span id="l7.152">    * Use Promise.catch to handle failed verifications.</span>
<a href="#l7.153"></a><span id="l7.153">    * The message will be an error message in this case.</span>
<a href="#l7.154"></a><span id="l7.154">    */</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  async verifyAttachment(filePath, sigPath) {}</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  async verifyAttachment(filePath, sigPath) {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  }</span>
<a href="#l7.160"></a><span id="l7.160"> </span>
<a href="#l7.161"></a><span id="l7.161">   /**</span>
<a href="#l7.162"></a><span id="l7.162">    *</span>
<a href="#l7.163"></a><span id="l7.163">    * @param {Bytes}  encrypted     The encrypted data</span>
<a href="#l7.164"></a><span id="l7.164">    *</span>
<a href="#l7.165"></a><span id="l7.165">    * @return {Promise&lt;Object&gt;} - Return object with decryptedData and</span>
<a href="#l7.166"></a><span id="l7.166">    * status information</span>
<a href="#l7.167"></a><span id="l7.167">    *</span>
<a href="#l7.168"></a><span id="l7.168">    * Use Promise.catch to handle failed decryption.</span>
<a href="#l7.169"></a><span id="l7.169">    * retObj.errorMsg will be an error message in this case.</span>
<a href="#l7.170"></a><span id="l7.170">    */</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-  async decryptAttachment(encrypted) {}</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  async decryptAttachment(encrypted) {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  }</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177">   /**</span>
<a href="#l7.178"></a><span id="l7.178">    *</span>
<a href="#l7.179"></a><span id="l7.179">    * @param {String} encrypted     The encrypted data</span>
<a href="#l7.180"></a><span id="l7.180">    * @param {Object} options       Decryption options</span>
<a href="#l7.181"></a><span id="l7.181">    *</span>
<a href="#l7.182"></a><span id="l7.182">    * @return {Promise&lt;Object&gt;} - Return object with decryptedData and</span>
<a href="#l7.183"></a><span id="l7.183">    * status information</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-decryption.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,376 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/*</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">- */</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;GnuPGDecryption&quot;];</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-const EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-const EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-const EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-const STATUS_ERROR = EnigmailConstants.BAD_SIGNATURE | EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-const STATUS_DECRYPTION_OK = EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-const STATUS_GOODSIG = EnigmailConstants.GOOD_SIGNATURE;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-var GnuPGDecryption = {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  /*</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-   * options:</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-   *  - logFile (the actual file)</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-   *  - keyserver</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-   *  - keyserverProxy</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-   *  - fromAddr</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-   *  - noOutput</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-   *  - verifyOnly</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-   *  - mimeSignatureFile</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-   *  - maxOutputLength</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-   *</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-   */</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  getDecryptionArgs: function(options) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    var args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    args.push(&quot;--log-file&quot;);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    args.push(EnigmailFiles.getEscapedFilename(EnigmailFiles.getFilePath(options.logFile)));</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    if (options.keyserver &amp;&amp; options.keyserver !== &quot;&quot;) {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-      var keyserver = options.keyserver.trim();</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-      args.push(&quot;--keyserver-options&quot;);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-      var keySrvArgs = &quot;auto-key-retrieve&quot;;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-      var srvProxy = options.keyserverProxy;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-      if (srvProxy) {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-        keySrvArgs += &quot;,http-proxy=&quot; + srvProxy;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-      }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-      args.push(keySrvArgs);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-      args.push(&quot;--keyserver&quot;);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-      args.push(keyserver);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-    }</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    if (EnigmailGpg.getGpgFeature(&quot;supports-sender&quot;) &amp;&amp; options.fromAddr) {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-      args.push(&quot;--sender&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-      args.push(options.fromAddr.toLowerCase());</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    }</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    if (options.noOutput) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-      args.push(&quot;--verify&quot;);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-      if (options.mimeSignatureFile) {</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-        args.push(options.mimeSignatureFile);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-        args.push(&quot;-&quot;);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-      }</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    }</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    else {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-      if (options.maxOutputLength) {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-        args.push(&quot;--max-output&quot;);</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-        args.push(String(options.maxOutputLength));</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-      }</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-      args.push(&quot;--decrypt&quot;);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    }</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    return args;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  },</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  decryptMessageEnd: function(stderrStr, exitCode, outputLen, verifyOnly, noOutput, uiFlags, retStatusObj) {</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: uiFlags=&quot; + uiFlags + &quot;, verifyOnly=&quot; + verifyOnly + &quot;, noOutput=&quot; + noOutput + &quot;\n&quot;);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-    stderrStr = stderrStr.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: stderrStr=\n&quot; + stderrStr + &quot;\n&quot;);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-    var interactive = uiFlags &amp; EnigmailConstants.UI_INTERACTIVE;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-    var pgpMime = uiFlags &amp; EnigmailConstants.UI_PGP_MIME;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-    var allowImport = uiFlags &amp; EnigmailConstants.UI_ALLOW_KEY_IMPORT;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-    var unverifiedEncryptedOK = uiFlags &amp; EnigmailConstants.UI_UNVERIFIED_ENC_OK;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-    var j;</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-    retStatusObj.statusFlags = 0;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-    retStatusObj.errorMsg = &quot;&quot;;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-    retStatusObj.blockSeparation = &quot;&quot;;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    var errorMsg = EnigmailErrorHandling.parseErrorOutput(stderrStr, retStatusObj);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-    if (retStatusObj.statusFlags &amp; STATUS_ERROR) {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-      retStatusObj.errorMsg = errorMsg;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-    }</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-    else {</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-      retStatusObj.errorMsg = &quot;&quot;;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    }</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-    if (pgpMime) {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-      retStatusObj.statusFlags |= verifyOnly ? EnigmailConstants.PGP_MIME_SIGNED : EnigmailConstants.PGP_MIME_ENCRYPTED;</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    }</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    var statusMsg = retStatusObj.statusMsg;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-    exitCode = EnigmailExecution.fixExitCode(exitCode, retStatusObj);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-    if ((exitCode === 0) &amp;&amp; !noOutput &amp;&amp; !outputLen &amp;&amp;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-      ((retStatusObj.statusFlags &amp; (STATUS_DECRYPTION_OK | STATUS_GOODSIG)) === 0)) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-      exitCode = -1;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-    }</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-    if (retStatusObj.statusFlags &amp; EnigmailConstants.DISPLAY_MESSAGE &amp;&amp; retStatusObj.extendedStatus.search(/\bdisp:/) &gt;= 0) {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-      EnigmailDialog.alert(null, statusMsg);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-      return -1;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    }</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-    var errLines;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-    if (statusMsg) {</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-      errLines = statusMsg.split(/\r?\n/);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-    }</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-    else {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-      // should not really happen ...</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-      errLines = stderrStr.split(/\r?\n/);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-    }</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    // possible STATUS Patterns (see GPG dod DETAILS.txt):</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-    // one of these should be set for a signature:</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-    var newsigPat = /^NEWSIG ?.*$/i;</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-    var trustedsigPat = /^TRUST_(FULLY|ULTIMATE) ?.*$/i;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-    var goodsigPat = /^GOODSIG (\w{16}) (.*)$/i;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-    var badsigPat = /^BADSIG (\w{16}) (.*)$/i;</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-    var expsigPat = /^EXPSIG (\w{16}) (.*)$/i;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    var expkeysigPat = /^EXPKEYSIG (\w{16}) (.*)$/i;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-    var revkeysigPat = /^REVKEYSIG (\w{16}) (.*)$/i;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    var errsigPat = /^ERRSIG (\w{16}) (.*)$/i;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-    // additional infos for good signatures:</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    var validSigPat = /^VALIDSIG (\w+) (.*) (\d+) (.*)/i;</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-    // hint for a certain key id:</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    var userIdHintPat = /^USERID_HINT (\w{16}) (.*)$/i;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    // to find out for which recipients the email was encrypted:</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    var encToPat = /^ENC_TO (\w{16}) (.*)$/i;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    var matches;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-    var signed = false;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-    var goodOrExpOrRevSignature = false;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-    var sigKeyId = &quot;&quot;; // key of sender</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-    var sigUserId = &quot;&quot;; // user ID of sender</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-    var sigDetails = &quot;&quot;;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    var sigTrusted = false;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-    var encToDetails = &quot;&quot;;</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-    var encToArray = []; // collect ENC_TO lines here</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    for (j = 0; j &lt; errLines.length; j++) {</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: process: &quot; + errLines[j] + &quot;\n&quot;);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-      // ENC_TO entry</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-      // - collect them for later processing to print details</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-      matches = errLines[j].match(encToPat);</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-      if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-        encToArray.push(&quot;0x&quot; + matches[1]);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-      }</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-      // USERID_HINT entry</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-      // - NOTE: NO END of loop</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-      // ERROR: wrong to set userId because ecom is NOT the sender:</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-      //matches = errLines[j].match(userIdHintPat);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-      //if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-      //  sigKeyId = matches[1];</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-      //  sigUserId = matches[2];</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-      //}</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-      // check for one of the possible SIG entries:</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-      matches = errLines[j].match(newsigPat);</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-      if (matches) {</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-        if (signed) {</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-          EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: multiple SIGN entries - ignoring previous signature\n&quot;);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-        }</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-        signed = true;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-        goodOrExpOrRevSignature = false;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-        sigKeyId = &quot;&quot;;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-        sigUserId = &quot;&quot;;</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-        sigDetails = &quot;&quot;;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-        sigTrusted = false;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-        continue;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-      }</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-      matches = errLines[j].match(trustedsigPat);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-      if (matches) {</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-        sigTrusted = true;</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-        continue;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-      }</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-      matches = errLines[j].match(validSigPat);</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-      if (matches &amp;&amp; (matches.length &gt; 4)) {</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-        if (matches[4].length == 40) {</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-          // in case of several subkeys refer to the main key ID.</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-          // Only works with PGP V4 keys (Fingerprint length ==40)</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-          sigKeyId = matches[4];</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-        }</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-        if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-          sigDetails = errLines[j].substr(9);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-        }</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-        continue;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-      }</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-      // GOODSIG entry</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-      matches = errLines[j].match(goodsigPat);</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-      if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-        if (signed) {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-          EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: OOPS: multiple SIGN entries\n&quot;);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-        }</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-        signed = true;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-        goodOrExpOrRevSignature = true;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-        sigKeyId = matches[1];</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-        sigUserId = matches[2];</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-      }</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-      else {</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        // BADSIG entry =&gt; signature found but bad</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-        matches = errLines[j].match(badsigPat);</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-        if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-          if (signed) {</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-            EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: OOPS: multiple SIGN entries\n&quot;);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-          }</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-          signed = true;</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-          goodOrExpOrRevSignature = false;</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-          sigKeyId = matches[1];</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-          sigUserId = matches[2];</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-        }</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-        else {</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-          // EXPSIG entry =&gt; expired signature found</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-          matches = errLines[j].match(expsigPat);</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-          if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-            if (signed) {</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-              EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: OOPS: multiple SIGN entries\n&quot;);</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-            }</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-            signed = true;</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-            goodOrExpOrRevSignature = true;</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-            sigKeyId = matches[1];</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-            sigUserId = matches[2];</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-          }</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-          else {</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-            // EXPKEYSIG entry =&gt; signature found but key expired</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-            matches = errLines[j].match(expkeysigPat);</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-            if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-              if (signed) {</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-                EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: OOPS: multiple SIGN entries\n&quot;);</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-              }</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-              signed = true;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-              goodOrExpOrRevSignature = true;</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-              sigKeyId = matches[1];</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-              sigUserId = matches[2];</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-            }</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-            else {</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-              // REVKEYSIG entry =&gt; signature found but key revoked</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-              matches = errLines[j].match(revkeysigPat);</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-              if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-                if (signed) {</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-                  EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: OOPS: multiple SIGN entries\n&quot;);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-                }</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-                signed = true;</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-                goodOrExpOrRevSignature = true;</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-                sigKeyId = matches[1];</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-                sigUserId = matches[2];</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-              }</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-              else {</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-                // ERRSIG entry =&gt; signature found but key not usable or unavailable</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-                matches = errLines[j].match(errsigPat);</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-                if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-                  if (signed) {</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-                    EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: OOPS: multiple SIGN entries\n&quot;);</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-                  }</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-                  signed = true;</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-                  goodOrExpOrRevSignature = false;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-                  sigKeyId = matches[1];</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-                  // no user id with ecom istatus entry</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-                }</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-              }</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-            }</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-          }</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-        }</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-      }</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-    } // end loop of processing errLines</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-    if (sigTrusted) {</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-      retStatusObj.statusFlags |= EnigmailConstants.TRUSTED_IDENTITY;</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-    }</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-    if (sigUserId &amp;&amp; sigKeyId &amp;&amp; EnigmailPrefs.getPref(&quot;displaySecondaryUid&quot;)) {</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-      let keyObj = EnigmailKeyRing.getKeyById(sigKeyId);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-      if (keyObj) {</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-        if (keyObj.photoAvailable) {</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-          retStatusObj.statusFlags |= EnigmailConstants.PHOTO_AVAILABLE;</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-        }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-        sigUserId = EnigmailKeyRing.getValidUids(sigKeyId).join(&quot;\n&quot;);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-      }</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-    }</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-    else if (sigUserId) {</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-      sigUserId = EnigmailData.convertToUnicode(sigUserId, &quot;UTF-8&quot;);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-    }</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-    // add list of keys used for encryption if known (and their user IDs) if known</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-    // Parsed status messages are something like (here the German version):</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-    //    [GNUPG:] ENC_TO AAAAAAAAAAAAAAAA 1 0</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-    //    [GNUPG:] ENC_TO 5B820D2D4553884F 16 0</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-    //    [GNUPG:] ENC_TO 37904DF2E631552F 1 0</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-    //    [GNUPG:] ENC_TO BBBBBBBBBBBBBBBB 1 0</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-    //    gpg: verschlsselt mit 3072-Bit RSA Schlssel, ID BBBBBBBB, erzeugt 2009-11-28</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-    //          &quot;Joe Doo &lt;joe.doo@domain.de&gt;&quot;</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-    //    [GNUPG:] NO_SECKEY E71712DF47BBCC40</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-    //    gpg: verschlsselt mit RSA Schlssel, ID AAAAAAAA</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-    //    [GNUPG:] NO_SECKEY AAAAAAAAAAAAAAAA</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-    if (encToArray.length &gt; 0) {</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-      // for each key also show an associated user ID if known:</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-      for (var encIdx = 0; encIdx &lt; encToArray.length; ++encIdx) {</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-        var localKeyId = encToArray[encIdx];</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-        // except for ID 00000000, which signals hidden keys</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-        if (localKeyId != &quot;0x0000000000000000&quot;) {</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-          let localKey = EnigmailKeyRing.getKeyById(localKeyId);</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-          if (localKey) {</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-            encToArray[encIdx] += &quot; (&quot; + localKey.userId + &quot;)&quot;;</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-          }</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-        }</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-        else {</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-          encToArray[encIdx] = EnigmailLocale.getString(&quot;hiddenKey&quot;);</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-        }</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-      }</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-      encToDetails = &quot;\n  &quot; + encToArray.join(&quot;,\n  &quot;) + &quot;\n&quot;;</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-    }</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-    retStatusObj.userId = sigUserId;</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-    retStatusObj.keyId = sigKeyId;</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-    retStatusObj.sigDetails = sigDetails;</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-    retStatusObj.encToDetails = encToDetails;</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-    if (signed) {</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-      if (goodOrExpOrRevSignature) {</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-        retStatusObj.errorMsg = EnigmailLocale.getString(&quot;prefGood&quot;, [sigUserId]);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-        /* + &quot;, &quot; + EnigmailLocale.getString(&quot;keyId&quot;) + &quot; 0x&quot; + sigKeyId.substring(8,16); */</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-      }</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-      else {</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-        if (sigUserId.length &gt; 0) {</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-          retStatusObj.errorMsg = EnigmailLocale.getString(&quot;prefBad&quot;, [sigUserId]);</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-        }</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-        if (!exitCode)</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-          exitCode = 1;</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-      }</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-    }</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-    if (retStatusObj.statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-      retStatusObj.keyId = EnigmailKey.extractPubkey(statusMsg);</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-      if (retStatusObj.statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-        exitCode = 0;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-      }</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    }</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-    if (exitCode !== 0) {</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-      // Error processing</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gnupg-decryption.jsm: decryptMessageEnd: command execution exit code: &quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-    }</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    return exitCode;</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-  }</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-key.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,115 +7,20 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /****</span>
<a href="#l9.5"></a><span id="l9.5">    Private sub-module to GnuPGCryptoAPI.jsm for handling key import/export</span>
<a href="#l9.6"></a><span id="l9.6">  ****/</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> &quot;use strict&quot;;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> var EXPORTED_SYMBOLS = [&quot;GnuPG_importKeyFromFile&quot;, &quot;GnuPG_extractSecretKey&quot;];</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l9.13"></a><span id="l9.13"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailLocale;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> async function GnuPG_importKeyFromFile(inputFile) {</span>
<a href="#l9.20"></a><span id="l9.20">   EnigmailLog.DEBUG(&quot;gnupg-key.jsm: importKeysFromFile: fileName=&quot; + inputFile.path + &quot;\n&quot;);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-  var command = EnigmailGpg.agentPath;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  var args = EnigmailGpg.getStandardArgs(false).concat([&quot;--no-tty&quot;, &quot;--batch&quot;, &quot;--no-verbose&quot;, &quot;--status-fd&quot;, &quot;2&quot;, &quot;--no-auto-check-trustdb&quot;, &quot;--import&quot;]);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  var fileName = EnigmailFiles.getEscapedFilename((inputFile.QueryInterface(Ci.nsIFile)).path);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-  args.push(fileName);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-  let res = await EnigmailExecution.execAsync(command, args, &quot;&quot;);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  let statusMsg = res.statusMsg;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  var keyList = [];</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-  let importedKeys = [];</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  let importSum = 0;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  let importUnchanged = 0;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  // IMPORT_RES &lt;count&gt; &lt;no_user_id&gt; &lt;imported&gt; 0 &lt;unchanged&gt;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  //    &lt;n_uids&gt; &lt;n_subk&gt; &lt;n_sigs&gt; &lt;n_revoc&gt; &lt;sec_read&gt; &lt;sec_imported&gt; &lt;sec_dups&gt; &lt;not_imported&gt;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  if (statusMsg) {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    let import_res = statusMsg.match(/^IMPORT_RES ([0-9]+) ([0-9]+) ([0-9]+) 0 ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+)/m);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    if (import_res !== null) {</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-      let secCount = parseInt(import_res[9], 10); // number of secret keys found</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-      let secImported = parseInt(import_res[10], 10); // number of secret keys imported</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-      let secDups = parseInt(import_res[11], 10); // number of secret keys already on the keyring</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      if (secCount !== secImported + secDups) {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-        res.errorMsg = EnigmailLocale.getString(&quot;import.secretKeyImportError&quot;);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-        res.exitCode = 1;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-      }</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-      else {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-        importSum = parseInt(import_res[1], 10);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-        importUnchanged = parseInt(import_res[4], 10);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-        res.exitCode = 0;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-        var statusLines = statusMsg.split(/\r?\n/);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-        for (let j = 0; j &lt; statusLines.length; j++) {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-          var matches = statusLines[j].match(/IMPORT_OK ([0-9]+) (\w+)/);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-          if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-            if (typeof (keyList[matches[2]]) != &quot;undefined&quot;) {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-              keyList[matches[2]] |= Number(matches[1]);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-            }</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-            else</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-              keyList[matches[2]] = Number(matches[1]);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-            importedKeys.push(matches[2]);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-            EnigmailLog.DEBUG(&quot;gnupg-key.jsm: importKeysFromFile: imported &quot; + matches[2] + &quot;:&quot; + matches[1] + &quot;\n&quot;);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-          }</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-        }</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-      }</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-    }</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  }</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  return {</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-    exitCode: res.exitCode,</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    errorMsg: res.errorMsg,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-    importedKeys: importedKeys,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-    importSum: importSum,</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    importUnchanged: importUnchanged</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  };</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l9.81"></a><span id="l9.81"> }</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84"> async function GnuPG_extractSecretKey(userId, minimalKey) {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  let args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  let exitCode = -1,</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    errorMsg = &quot;&quot;;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-  if (minimalKey) {</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    args.push(&quot;--export-options&quot;);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-    args.push(&quot;export-minimal,no-export-attributes&quot;);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-  }</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  args.push(&quot;-a&quot;);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  args.push(&quot;--export-secret-keys&quot;);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  if (userId) {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    args = args.concat(userId.split(/[ ,\t]+/));</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-  }</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, &quot;&quot;);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  if (res.stdoutData) {</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-    exitCode = 0;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  }</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-  if (exitCode !== 0) {</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-    if (res.errorMsg) {</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-      errorMsg = EnigmailFiles.formatCmdLine(EnigmailGpg.agentPath, args);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-      errorMsg += &quot;\n&quot; + res.errorMsg;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    }</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-  }</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  return {</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-    keyData: res.stdoutData,</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    exitCode: exitCode,</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    errorMsg: errorMsg</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  };</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l9.120"></a><span id="l9.120"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/gnupg-keylist.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -5,23 +5,22 @@</span>
<a href="#l10.4"></a><span id="l10.4">  */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> /****</span>
<a href="#l10.7"></a><span id="l10.7">    Private sub-module to GnuPGCryptoAPI.jsm for handling key lists from GnuPG</span>
<a href="#l10.8"></a><span id="l10.8">  ****/</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> &quot;use strict&quot;;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;obtainKeyList&quot;, &quot;createKeyObj&quot;,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;obtainKeyList&quot;,</span>
<a href="#l10.14"></a><span id="l10.14">   &quot;getPhotoFileFromGnuPG&quot;, &quot;extractSignatures&quot;, &quot;getGpgKeyData&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> ];</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> const EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l10.18"></a><span id="l10.18"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l10.20"></a><span id="l10.20"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l10.21"></a><span id="l10.21"> const EnigmailTrust = ChromeUtils.import(&quot;chrome://openpgp/content/modules/trust.jsm&quot;).EnigmailTrust;</span>
<a href="#l10.22"></a><span id="l10.22"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l10.23"></a><span id="l10.23"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l10.24"></a><span id="l10.24"> const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l10.25"></a><span id="l10.25"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> // field ID's of key list (as described in the doc/DETAILS file in the GnuPG distribution)</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -65,50 +64,17 @@ const NS_LOCALFILEOUTPUTSTREAM_CONTRACTI</span>
<a href="#l10.29"></a><span id="l10.29">  *</span>
<a href="#l10.30"></a><span id="l10.30">  * @param {Array of String} onlyKeys: only load data for specified key IDs</span>
<a href="#l10.31"></a><span id="l10.31">  *</span>
<a href="#l10.32"></a><span id="l10.32">  * @return {Promise&lt;Array Object&gt;}:</span>
<a href="#l10.33"></a><span id="l10.33">  * key objects as specified in EnigmailKeyObj.constructor</span>
<a href="#l10.34"></a><span id="l10.34">  */</span>
<a href="#l10.35"></a><span id="l10.35"> async function obtainKeyList(onlyKeys = null) {</span>
<a href="#l10.36"></a><span id="l10.36">   EnigmailLog.DEBUG(&quot;gnupg-keylist.jsm: obtainKeyList()\n&quot;);</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  let secKeyList = [],</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    pubKeyList = [];</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  let commonArgs = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  commonArgs = commonArgs.concat([&quot;--with-fingerprint&quot;, &quot;--fixed-list-mode&quot;, &quot;--with-colons&quot;]);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  let args = commonArgs.concat([&quot;--list-keys&quot;]);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  if (onlyKeys) {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-    args = args.concat(onlyKeys);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  }</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, &quot;&quot;);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  pubKeyList = res.stdoutData.split(/\n/);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  let keyList = {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-    keys: [],</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-    index: []</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  };</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  EnigmailLog.DEBUG(`gnupg-keylist.jsm: obtainKeyList: #lines: ${pubKeyList.length}\n`);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  if (pubKeyList.length &gt; 0) {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    appendKeyItems(pubKeyList, keyList);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    args = commonArgs.concat([&quot;--list-secret-keys&quot;]);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-    if (onlyKeys) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-      args = args.concat(onlyKeys);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-    }</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-    res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, &quot;&quot;);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-    secKeyList = res.stdoutData.split(/\n/);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-    appendKeyItems(secKeyList, keyList);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  }</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  return keyList;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l10.72"></a><span id="l10.72"> }</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74"> </span>
<a href="#l10.75"></a><span id="l10.75"> /**</span>
<a href="#l10.76"></a><span id="l10.76">  * Append key objects to a given key cache</span>
<a href="#l10.77"></a><span id="l10.77">  *</span>
<a href="#l10.78"></a><span id="l10.78">  * @param keyListString: array of |string| formatted output from GnuPG for key listing</span>
<a href="#l10.79"></a><span id="l10.79">  * @param keyList:    |object| holding the resulting key list</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineat">@@ -257,92 +223,17 @@ function appendUnkownSecretKey(keyId, aK</span>
<a href="#l10.81"></a><span id="l10.81">  </span>
<a href="#l10.82"></a><span id="l10.82">  * @param {String} keyId:       Key ID / fingerprint</span>
<a href="#l10.83"></a><span id="l10.83">  * @param {Number} photoNumber: number of the photo on the key, starting with 0</span>
<a href="#l10.84"></a><span id="l10.84">  *</span>
<a href="#l10.85"></a><span id="l10.85">  * @return {Promise&lt;nsIFile&gt;} object or null in case no data / error.</span>
<a href="#l10.86"></a><span id="l10.86">  */</span>
<a href="#l10.87"></a><span id="l10.87"> async function getPhotoFileFromGnuPG(keyId, photoNumber) {</span>
<a href="#l10.88"></a><span id="l10.88">   EnigmailLog.DEBUG(`gnupg-keylist.jsm: getPhotoFileFromGnuPG, keyId=${keyId} photoNumber=${photoNumber}\n`);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  const GPG_ADDITIONAL_OPTIONS = [&quot;--no-secmem-warning&quot;, &quot;--no-verbose&quot;, &quot;--no-auto-check-trustdb&quot;,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    &quot;--batch&quot;, &quot;--no-tty&quot;, &quot;--no-verbose&quot;, &quot;--status-fd&quot;, &quot;1&quot;, &quot;--attribute-fd&quot;, &quot;2&quot;,</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-    &quot;--fixed-list-mode&quot;, &quot;--list-keys&quot;, keyId</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-  ];</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-  const args = EnigmailGpg.getStandardArgs(false).concat(GPG_ADDITIONAL_OPTIONS);</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-  let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args);</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-  let photoData = res.stderrData;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-  let outputTxt = res.stdoutData;</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-  if (!outputTxt || !photoData) {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    return null;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-  }</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-  if (EnigmailOS.isDosLike &amp;&amp; EnigmailGpg.getGpgFeature(&quot;windows-photoid-bug&quot;)) {</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    // workaround for error in gpg</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-    photoData = photoData.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-  }</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-  // [GNUPG:] ATTRIBUTE A053069284158FC1E6770BDB57C9EB602B0717E2 2985</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-  let foundPicture = -1;</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-  let skipData = 0;</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-  let imgSize = -1;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-  const statusLines = outputTxt.split(/[\n\r+]/);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-  for (let i = 0; i &lt; statusLines.length; i++) {</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-    const matches = statusLines[i].match(/\[GNUPG:\] ATTRIBUTE ([A-F\d]+) (\d+) (\d+) (\d+) (\d+) (\d+) (\d+) (\d+)/);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-    if (matches &amp;&amp; matches[3] == &quot;1&quot;) {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-      // attribute is an image</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-      foundPicture++;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-      if (foundPicture === photoNumber) {</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-        imgSize = Number(matches[2]);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-        break;</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-      } else {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-        skipData += Number(matches[2]);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-      }</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-    }</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-  }</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-  if (foundPicture &gt;= 0 &amp;&amp; foundPicture === photoNumber) {</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-    if (photoData.search(/^gpg: /) === 0) {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-      // skip disturbing gpg output</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-      let i = photoData.search(/\n/) + 1;</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-      skipData += i;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    }</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-    const pictureData = photoData.substr(16 + skipData, imgSize);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-    if (!pictureData.length) {</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-      return null;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-    }</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-    try {</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-      const flags = NS_WRONLY | NS_CREATE_FILE | NS_TRUNCATE;</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-      const picFile = EnigmailFiles.getTempDirObj();</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-      picFile.append(keyId + &quot;.jpg&quot;);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-      picFile.createUnique(picFile.NORMAL_FILE_TYPE, STANDARD_FILE_PERMS);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-      const fileStream = Cc[NS_LOCALFILEOUTPUTSTREAM_CONTRACTID].createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-      fileStream.init(picFile, flags, STANDARD_FILE_PERMS, 0);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-      if (fileStream.write(pictureData, pictureData.length) !== pictureData.length) {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-        fileStream.close();</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-        throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-      }</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-      fileStream.flush();</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-      fileStream.close();</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-      // delete picFile upon exit</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-      let extAppLauncher = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsPIExternalAppLauncher);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-      extAppLauncher.deleteTemporaryFileOnExit(picFile);</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-      return picFile;</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-  }</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-  return null;</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l10.166"></a><span id="l10.166"> }</span>
<a href="#l10.167"></a><span id="l10.167"> </span>
<a href="#l10.168"></a><span id="l10.168"> </span>
<a href="#l10.169"></a><span id="l10.169"> /**</span>
<a href="#l10.170"></a><span id="l10.170">  * Return signatures for a given key list</span>
<a href="#l10.171"></a><span id="l10.171">  *</span>
<a href="#l10.172"></a><span id="l10.172">  * @param {String} gpgKeyList         Output from gpg such as produced by getKeySig()</span>
<a href="#l10.173"></a><span id="l10.173">  *                                    Only the first public key is processed!</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineat">@@ -418,86 +309,12 @@ function extractSignatures(gpgKeyList, i</span>
<a href="#l10.175"></a><span id="l10.175">         }</span>
<a href="#l10.176"></a><span id="l10.176">         break;</span>
<a href="#l10.177"></a><span id="l10.177">     }</span>
<a href="#l10.178"></a><span id="l10.178">   }</span>
<a href="#l10.179"></a><span id="l10.179"> </span>
<a href="#l10.180"></a><span id="l10.180">   return listObj;</span>
<a href="#l10.181"></a><span id="l10.181"> }</span>
<a href="#l10.182"></a><span id="l10.182"> </span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-</span>
<a href="#l10.184"></a><span id="l10.184"> async function getGpgKeyData(armorKeyString) {</span>
<a href="#l10.185"></a><span id="l10.185">   EnigmailLog.DEBUG(&quot;GnuPGCryptoAPI.jsm: getGpgKeyData()\n&quot;);</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-  if (!EnigmailGpg.getGpgFeature(&quot;supports-show-only&quot;)) {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-    throw &quot;unsupported&quot;;</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-  }</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-  let args = EnigmailGpg.getStandardArgs(false).concat([&quot;--no-tty&quot;, &quot;--batch&quot;, &quot;--no-verbose&quot;, &quot;--with-fingerprint&quot;, &quot;--with-colons&quot;, &quot;--import-options&quot;, &quot;import-show&quot;, &quot;--dry-run&quot;, &quot;--import&quot;]);</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-  let res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, armorKeyString);</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-  let lines = res.stdoutData.split(/\n/);</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-  let key = {};</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-  let keyId = &quot;&quot;;</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-  let keyList = [];</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-  /*</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-  pub:u:256:22:84F83BE88C892606:1525969855:1683649855::u:::scESC:::::ed25519:::0:</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-  fpr:::::::::AFE1B65C5F39ACA7960B22CD84F83BE88C892606:</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-  uid:u::::1525969914::22DB32406212400B52CDC74DA2B33418637430F1::Patrick (ECC) &lt;patrick@enigmail.net&gt;::::::::::0:</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-  uid:u::::1525969855::F70B7A77F085AA7BA003D6AFAB6FF0DB1FC901B0::enigmail &lt;patrick@enigmail.net&gt;::::::::::0:</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-  sub:u:256:18:329DAB3350400C40:1525969855:1683649855:::::e:::::cv25519::</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-  fpr:::::::::3B154538D4DFAA19BDADAAD0329DAB3350400C40:</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-  */</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-  for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-    const lineTokens = lines[i].split(/:/);</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-    switch (lineTokens[ENTRY_ID]) {</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-      case &quot;pub&quot;:</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-      case &quot;sec&quot;:</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-        key = {</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-          id: lineTokens[KEY_ID],</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-          fpr: null,</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-          name: null,</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-          isSecret: false,</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-          created: EnigmailTime.getDateTime(lineTokens[CREATED_ID], true, false),</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-          uids: []</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-        };</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-        if (!(key.id in keyList)) {</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-          keyList[key.id] = key;</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-        }</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-        if (lineTokens[ENTRY_ID] === &quot;sec&quot;) {</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-          keyList[key.id].isSecret = true;</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-        }</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-        break;</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-      case &quot;fpr&quot;:</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-        if (!key.fpr) {</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-          key.fpr = lineTokens[USERID_ID];</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-        }</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-        break;</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-      case &quot;uid&quot;:</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-        if (!key.name) {</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-          key.name = lineTokens[USERID_ID];</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-        }</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-        else {</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-          key.uids.push(lineTokens[USERID_ID]);</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-        }</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-        break;</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-      case &quot;rvs&quot;:</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-      case &quot;rvk&quot;:</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-        keyId = lineTokens[KEY_ID];</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-        if (keyId in keyList) {</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-          keyList[keyId].revoke = true;</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-        } else {</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-          keyList[keyId] = {</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-            revoke: true,</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-            id: keyId</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-          };</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-        }</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-        break;</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-    }</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-  }</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-  return keyList;</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l10.261"></a><span id="l10.261"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -94,26 +94,16 @@ class CryptoAPI {</span>
<a href="#l11.4"></a><span id="l11.4">    *</span>
<a href="#l11.5"></a><span id="l11.5">    * @return {Promise&lt;Array of Object&gt;}</span>
<a href="#l11.6"></a><span id="l11.6">    */</span>
<a href="#l11.7"></a><span id="l11.7">   async getKeys(onlyKeys = null) {</span>
<a href="#l11.8"></a><span id="l11.8">     return [];</span>
<a href="#l11.9"></a><span id="l11.9">   }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   /**</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-   * Get groups defined in gpg.conf in the same structure as KeyObject</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-   * [synchronous]</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-   *</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-   * @return {Array of KeyObject} with type = &quot;grp&quot;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-   */</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  getGroups() {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-    return [];</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  }</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  /**</span>
<a href="#l11.22"></a><span id="l11.22">    * Extract a photo ID from a key, store it as file and return the file object.</span>
<a href="#l11.23"></a><span id="l11.23">    *</span>
<a href="#l11.24"></a><span id="l11.24">    * @param {String} keyId:       Key ID / fingerprint</span>
<a href="#l11.25"></a><span id="l11.25">    * @param {Number} photoNumber: number of the photo on the key, starting with 0</span>
<a href="#l11.26"></a><span id="l11.26">    *</span>
<a href="#l11.27"></a><span id="l11.27">    * @return {nsIFile} object or null in case no data / error.</span>
<a href="#l11.28"></a><span id="l11.28">    */</span>
<a href="#l11.29"></a><span id="l11.29">   async getPhotoFile(keyId, photoNumber) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/data.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/data.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -16,17 +16,17 @@ const HEX_TABLE = &quot;0123456789abcdef&quot;;</span>
<a href="#l12.4"></a><span id="l12.4"> function converter(charset) {</span>
<a href="#l12.5"></a><span id="l12.5">   let unicodeConv = Cc[SCRIPTABLEUNICODECONVERTER_CONTRACTID].getService(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l12.6"></a><span id="l12.6">   unicodeConv.charset = charset || &quot;utf-8&quot;;</span>
<a href="#l12.7"></a><span id="l12.7">   return unicodeConv;</span>
<a href="#l12.8"></a><span id="l12.8"> }</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> var EnigmailData = {</span>
<a href="#l12.11"></a><span id="l12.11">   getUnicodeData: function(data) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    // convert output from subprocess to Unicode</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    // convert output to Unicode</span>
<a href="#l12.14"></a><span id="l12.14">     var tmpStream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;].createInstance(Ci.nsIStringInputStream);</span>
<a href="#l12.15"></a><span id="l12.15">     tmpStream.setData(data, data.length);</span>
<a href="#l12.16"></a><span id="l12.16">     var inStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l12.17"></a><span id="l12.17">     inStream.init(tmpStream);</span>
<a href="#l12.18"></a><span id="l12.18">     return inStream.read(tmpStream.available());</span>
<a href="#l12.19"></a><span id="l12.19">   },</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   extractMessageId: function(uri) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -11,23 +11,21 @@ var EXPORTED_SYMBOLS = [&quot;EnigmailDecrypt</span>
<a href="#l13.4"></a><span id="l13.4"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l13.5"></a><span id="l13.5"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l13.6"></a><span id="l13.6"> const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l13.7"></a><span id="l13.7"> const EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l13.8"></a><span id="l13.8"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l13.9"></a><span id="l13.9"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l13.10"></a><span id="l13.10"> const EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l13.11"></a><span id="l13.11"> const EnigmailHttpProxy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/httpProxy.jsm&quot;).EnigmailHttpProxy;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-const EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l13.13"></a><span id="l13.13"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l13.14"></a><span id="l13.14"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l13.15"></a><span id="l13.15"> const EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l13.16"></a><span id="l13.16"> const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l13.17"></a><span id="l13.17"> const EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-const EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l13.19"></a><span id="l13.19"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l13.20"></a><span id="l13.20"> const EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l13.21"></a><span id="l13.21"> const EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> const STATUS_ERROR = EnigmailConstants.BAD_SIGNATURE | EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l13.24"></a><span id="l13.24"> const STATUS_DECRYPTION_OK = EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l13.25"></a><span id="l13.25"> const STATUS_GOODSIG = EnigmailConstants.GOOD_SIGNATURE;</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27" class="difflineat">@@ -50,17 +48,18 @@ function statusObjectFrom(signatureObj, </span>
<a href="#l13.28"></a><span id="l13.28"> function newStatusObject() {</span>
<a href="#l13.29"></a><span id="l13.29">   return statusObjectFrom({</span>
<a href="#l13.30"></a><span id="l13.30">     value: &quot;&quot;</span>
<a href="#l13.31"></a><span id="l13.31">   }, {}, {}, {}, {}, {}, {}, {}, {});</span>
<a href="#l13.32"></a><span id="l13.32"> }</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34"> var EnigmailDecryption = {</span>
<a href="#l13.35"></a><span id="l13.35">   isReady: function(win) {</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    return (EnigmailCore.getService(win)) &amp;&amp; (!EnigmailKeyRing.isGeneratingKey());</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+    // this used to return false while generating a key. still necessary?</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+    return EnigmailCore.getService(win);</span>
<a href="#l13.39"></a><span id="l13.39">   },</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">   getFromAddr: function(win) {</span>
<a href="#l13.42"></a><span id="l13.42">     var fromAddr;</span>
<a href="#l13.43"></a><span id="l13.43">     if (win &amp;&amp; win.gFolderDisplay &amp;&amp; win.gFolderDisplay.selectedMessage) {</span>
<a href="#l13.44"></a><span id="l13.44">       fromAddr = win.gFolderDisplay.selectedMessage.author;</span>
<a href="#l13.45"></a><span id="l13.45">       try {</span>
<a href="#l13.46"></a><span id="l13.46">         fromAddr = EnigmailFuncs.stripEmail(fromAddr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/dns.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,345 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/*</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">- */</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-/**</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">- * This module provides DNS query functionality via subprocesses.</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">- * Supported record types: MX, SRV</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">- *</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">- * The following tools are currently supported:</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">- *   Windows:    nslookup</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">- *   Unix/Linux: dig, kdig, host, nslookup</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">- */</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailDns&quot;];</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-const RESTYPE_WIN_NLSOOKUP = 1;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-const RESTYPE_UNIX_NLSOOKUP = 2;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-const RESTYPE_DIG = 3;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-const RESTYPE_HOST = 4;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-const RESTYPE_NOT_AVAILABLE = 99;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-var gHandler = null,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  gResolverExecutable = null;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-var EnigmailDns = {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  /**</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-   * Perform a DNS lookup</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-   *</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-   * @param {String} recordType: The resource record type to query. MX and SRV are currently supported.</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-   * @param {String} queryName:  The name to search for, e.g. &quot;enigmail.net&quot;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-   *</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-   * @return {Promise&lt;Array{String}&gt;}: array of server(s) handling</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-   *</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-   */</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  lookup: async function(recordType, queryName) {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-    EnigmailLog.DEBUG(`dns.jsm: lookup(${recordType}, ${queryName})\n`);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-    if (!determineResolver()) return null;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    switch (recordType.toUpperCase()) {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-      case &quot;MX&quot;:</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-      case &quot;SRV&quot;:</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-        break;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-      default:</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-    }</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-    let dnsHandler = new gHandler(gResolverExecutable);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-    return dnsHandler.execute(recordType, queryName);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  }</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-};</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-/**</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">- * Determine the DNS resolver tool to use (e.g. dig, nslookup)</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">- *</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">- * @return {Boolean}: true: tool found / false: no tool found</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">- */</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-function determineResolver() {</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-  if (!gHandler) {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-    gHandler = GenericHandler;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-    if (EnigmailOS.isWin32) {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-      gResolverExecutable = EnigmailFiles.resolvePathWithEnv(&quot;nslookup&quot;);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-      if (gResolverExecutable) {</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-        EnigmailLog.DEBUG(`dns.jsm: determineResolver: executable = ${gResolverExecutable.path}\n`);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-        gHandler = NsLookupHandler_Windows;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-      }</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-    }</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-    else {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-      determineLinuxResolver();</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-    }</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-    if (!gResolverExecutable) EnigmailLog.DEBUG(`dns.jsm: determineResolver: no executable found\n`);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-  }</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-  return gHandler !== GenericHandler;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-}</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-function determineLinuxResolver() {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  EnigmailLog.DEBUG(`dns.jsm: determineLinuxResolver()\n`);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-  const services = [{</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-    exe: &quot;dig&quot;,</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-    class: DigHandler</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-  }, {</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-    exe: &quot;kdig&quot;,</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-    class: DigHandler</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-  }, {</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-    exe: &quot;host&quot;,</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-    class: HostHandler</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  }, {</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-    exe: &quot;nslookup&quot;,</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-    class: NsLookupHandler</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-  }];</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-  for (let i of services) {</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-    gResolverExecutable = EnigmailFiles.resolvePathWithEnv(i.exe);</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-    if (gResolverExecutable) {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-      EnigmailLog.DEBUG(`dns.jsm: determineLinuxResolver: found ${i.class.handlerType}\n`);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-      gHandler = i.class;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-      return;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-    }</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-  }</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-}</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-/**</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">- * Base class for executing DNS requests</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">- */</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-class GenericHandler {</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  constructor(handlerFile) {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-    this._handlerFile = handlerFile;</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-    this.recordType = &quot;&quot;;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-    this.hostName = &quot;&quot;;</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-  }</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-  getCmdArgs() {</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-    return [];</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-  }</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-  execute(recordType, hostName) {</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-      this.recordType = recordType.toUpperCase();</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-      this.hostName = hostName;</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-      let args = this.getCmdArgs();</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-      if (args.length === 0) {</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-        resolve([]);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-        return;</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-      }</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-      let stdoutData = &quot;&quot;,</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-        stderrData = &quot;&quot;;</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-      let self = this;</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-      EnigmailLog.DEBUG(`dns.jsm: execute(): launching ${EnigmailFiles.formatCmdLine(this._handlerFile, args)}\n`);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-      subprocess.call({</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-        command: this._handlerFile,</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-        arguments: args,</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-        environment: EnigmailCore.getEnvList(),</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-        charset: null,</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-        stdout: function(data) {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-          //EnigmailLog.DEBUG(`dns.jsm: execute.stdout: got data ${data}\n`);</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-          stdoutData += data;</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-        },</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-        stderr: function(data) {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-          //EnigmailLog.DEBUG(`dns.jsm: execute.stderr: got data ${data}\n`);</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-          stderrData += data;</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-        },</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-        done: function(result) {</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-          EnigmailLog.DEBUG(`dns.jsm: execute.done(${result.exitCode})\n`);</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-          try {</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-            if (result.exitCode === 0) {</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-              resolve(self.parseResult(stdoutData));</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-            }</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-            else {</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-              resolve([]);</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-            }</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-          }</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-          catch (ex) {</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-            reject(ex);</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-          }</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-        },</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-        mergeStderr: false</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-      });</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-    });</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-  }</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-  parseResult() {</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-    return [];</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-  }</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-}</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-/**</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">- * Handler class for &quot;dig&quot; and &quot;kdig&quot;</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">- */</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-class DigHandler extends GenericHandler {</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-  constructor(handlerFile) {</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-    super(handlerFile);</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-    this.handlerType = &quot;dig&quot;;</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-  }</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-  getCmdArgs() {</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-    return [&quot;-t&quot;, this.recordType, &quot;+short&quot;, this.hostName];</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-  }</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-  parseResult(stdoutData) {</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-    let hosts = [];</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-    let lines = stdoutData.split(/[\r\n]+/);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-    if (this.recordType === &quot;MX&quot;) {</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-      for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-        let m = lines[i].match(/^(\d+ )(.*)\./);</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 3) hosts.push(m[2]);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-      }</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-    }</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-    else if (this.recordType === &quot;SRV&quot;) {</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-      for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-        let m = lines[i].match(/^(\d+) (\d+) (\d+) ([^ ]+)\.$/);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 5) hosts.push(m[4] + &quot;:&quot; + m[3]);</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-      }</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-    }</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-    return hosts;</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-  }</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineminus">-}</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-/**</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">- * Handler class for &quot;host&quot;</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineminus">- */</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineminus">-</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-class HostHandler extends GenericHandler {</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-  constructor(handlerFile) {</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-    super(handlerFile);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    this.handlerType = &quot;host&quot;;</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-  }</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-  getCmdArgs() {</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-    return [&quot;-t&quot;, this.recordType, this.hostName];</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-  }</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-  parseResult(stdoutData) {</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-    if (stdoutData.search(/3\(NXDOMAIN\)/) &gt;= 0) return [];</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-    let hosts = [];</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-    let lines = stdoutData.split(/[\r\n]+/);</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-    if (this.recordType === &quot;MX&quot;) {</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-      for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-        let m = lines[i].match(/^(.* )([^ ]+)\.$/);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 3) hosts.push(m[2]);</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-      }</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-    }</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-    else if (this.recordType === &quot;SRV&quot;) {</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-      for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-        let m = lines[i].match(/^(.*) (\d+) ([^ ]+)\.$/);</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 4) hosts.push(m[3] + &quot;:&quot; + m[2]);</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-      }</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-    }</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-    return hosts;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-  }</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-}</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-/**</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">- * Handler class for &quot;nslookup&quot; (on Linux/Unix)</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">- */</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-class NsLookupHandler extends GenericHandler {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-  constructor(handlerFile) {</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-    super(handlerFile);</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-    this.handlerType = &quot;nslookup&quot;;</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-  }</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-  getCmdArgs() {</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-    return [&quot;-type=&quot; + this.recordType, this.hostName];</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-  }</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-  parseResult(stdoutData) {</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-    let hosts = [];</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineminus">-    let lines = stdoutData.split(/[\r\n]+/);</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-    if (lines.length &gt; 3 &amp;&amp; lines[3].search(/: NXDOMAIN/) &gt; 0) return [];</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-    if (this.recordType === &quot;MX&quot;) {</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-      let reg = new RegExp(&quot;^&quot; + this.hostName.toLowerCase() + &quot;(.* )([^ \t]+.*[^\.])\\.?$&quot;);</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-      for (let i = 2; i &lt; lines.length; i++) {</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineminus">-        let m = lines[i].match(reg);</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 3) hosts.push(m[2]);</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-        if (lines[i].length &lt; 5) break;</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-      }</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-    }</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineminus">-    else if (this.recordType === &quot;SRV&quot;) {</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineminus">-      for (let i = 2; i &lt; lines.length; i++) {</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-        let m = lines[i].match(/^(.*) (\d+) ([^ ]+)\.$/);</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 3) hosts.push(m[3] + &quot;:&quot; + m[2]);</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-        if (lines[i].length &lt; 5) break;</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-      }</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-    }</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-    return hosts;</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-  }</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-}</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-/**</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">- * Handler class for &quot;nslookup&quot; on Windows</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">- */</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-class NsLookupHandler_Windows extends NsLookupHandler {</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-  parseResult(stdoutData) {</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-    let hosts = [];</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-    let lines = stdoutData.split(/[\r\n]+/);</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-    if (this.recordType === &quot;MX&quot;) {</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-      let reg = new RegExp(&quot;^&quot; + this.hostName.toLowerCase() + &quot;(.* )([^ \t]+.*[^\.])\\.?$&quot;);</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-      for (let i = 2; i &lt; lines.length; i++) {</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-        let m = lines[i].match(reg);</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 3) hosts.push(m[2]);</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-        if (lines[i].length &lt; 5) break;</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-      }</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-    }</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineminus">-    else if (this.recordType === &quot;SRV&quot;) {</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-      let svc = null;</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineminus">-      for (let i = 2; i &lt; lines.length; i++) {</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-        if (lines[i].search(/SRV service location:$/) &gt; 0) {</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-          svc = null;</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-          continue;</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-        }</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-        let m = lines[i].match(/^[\t ]+(port|svr hostname)([\t =]+)([^ \t]+)$/);</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineminus">-        if (m &amp;&amp; m.length &gt;= 4) {</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineminus">-          if (m[1] === &quot;port&quot; &amp;&amp; svc === null) {</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineminus">-            svc = m[3];</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-          }</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-          else if (m[1] === &quot;svr hostname&quot; &amp;&amp; svc) {</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-            hosts.push(m[3] + &quot;:&quot; + svc);</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-          }</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-        }</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-        if (lines[i].length &lt; 5) break;</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-      }</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-    }</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-    return hosts;</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineminus">-  }</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -11,22 +11,19 @@ var EXPORTED_SYMBOLS = [&quot;EnigmailEncrypt</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l15.6"></a><span id="l15.6"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l15.7"></a><span id="l15.7"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l15.8"></a><span id="l15.8"> const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l15.9"></a><span id="l15.9"> const EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l15.10"></a><span id="l15.10"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l15.11"></a><span id="l15.11"> const EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-const EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l15.13"></a><span id="l15.13"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l15.14"></a><span id="l15.14"> const EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l15.16"></a><span id="l15.16"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-const EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l15.18"></a><span id="l15.18"> const EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l15.19"></a><span id="l15.19"> const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l15.20"></a><span id="l15.20"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l15.21"></a><span id="l15.21"> const EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> const gMimeHashAlgorithms = [null, &quot;sha1&quot;, &quot;ripemd160&quot;, &quot;sha256&quot;, &quot;sha384&quot;, &quot;sha512&quot;, &quot;sha224&quot;, &quot;md5&quot;];</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25"> const ENC_TYPE_MSG = 0;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineat">@@ -391,25 +388,16 @@ var EnigmailEncryption = {</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28">     listener.done = function(exitCode) {</span>
<a href="#l15.29"></a><span id="l15.29">       EnigmailErrorHandling.appendLogFileToDebug(logFileObj.value);</span>
<a href="#l15.30"></a><span id="l15.30">       if (this.outerDone) {</span>
<a href="#l15.31"></a><span id="l15.31">         this.outerDone(exitCode);</span>
<a href="#l15.32"></a><span id="l15.32">       }</span>
<a href="#l15.33"></a><span id="l15.33">     };</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-    // GnuPG</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-    /*</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-    var proc = EnigmailExecution.execStart(EnigmailGpgAgent.agentPath, encryptArgs, signMsg, win, listener, statusFlagsObj);</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-    if (statusFlagsObj.value &amp; EnigmailConstants.MISSING_PASSPHRASE) {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-      EnigmailLog.ERROR(&quot;encryption.jsm: encryptMessageStart: Error - no passphrase supplied\n&quot;);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-      errorMsgObj.value = &quot;&quot;;</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-    }</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    */</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-</span>
<a href="#l15.44"></a><span id="l15.44">     let resultStatus = {};</span>
<a href="#l15.45"></a><span id="l15.45">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l15.46"></a><span id="l15.46">     console.debug(&quot;listener: %o&quot;, listener);</span>
<a href="#l15.47"></a><span id="l15.47">     let encrypted = cApi.sync(cApi.encryptAndOrSign(listener.getInputForEncryption(), encryptArgs, resultStatus));</span>
<a href="#l15.48"></a><span id="l15.48">     console.debug(`encryptAndOrSign returned: ${encrypted}`);</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50">     listener.addEncryptedOutput(encrypted);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52" class="difflineat">@@ -436,19 +424,19 @@ var EnigmailEncryption = {</span>
<a href="#l15.53"></a><span id="l15.53">     retStatusObj.blockSeparation = &quot;&quot;;</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">     if (!EnigmailCore.getService().initialized) {</span>
<a href="#l15.56"></a><span id="l15.56">       EnigmailLog.ERROR(&quot;encryption.jsm: encryptMessageEnd: not yet initialized\n&quot;);</span>
<a href="#l15.57"></a><span id="l15.57">       retStatusObj.errorMsg = EnigmailLocale.getString(&quot;notInit&quot;);</span>
<a href="#l15.58"></a><span id="l15.58">       return -1;</span>
<a href="#l15.59"></a><span id="l15.59">     }</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    EnigmailErrorHandling.parseErrorOutput(stderrStr, retStatusObj);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+    //EnigmailErrorHandling.parseErrorOutput(stderrStr, retStatusObj);</span>
<a href="#l15.63"></a><span id="l15.63"> </span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-    exitCode = EnigmailExecution.fixExitCode(exitCode, retStatusObj);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+    //exitCode = EnigmailExecution.fixExitCode(exitCode, retStatusObj);</span>
<a href="#l15.66"></a><span id="l15.66">     if ((exitCode === 0) &amp;&amp; !outputLen) {</span>
<a href="#l15.67"></a><span id="l15.67">       exitCode = -1;</span>
<a href="#l15.68"></a><span id="l15.68">     }</span>
<a href="#l15.69"></a><span id="l15.69"> </span>
<a href="#l15.70"></a><span id="l15.70">     if (exitCode !== 0 &amp;&amp; (signMsg || encryptMsg)) {</span>
<a href="#l15.71"></a><span id="l15.71">       // GnuPG might return a non-zero exit code, even though the message was correctly</span>
<a href="#l15.72"></a><span id="l15.72">       // signed or encryped -&gt; try to fix the exit code</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74" class="difflineat">@@ -493,17 +481,19 @@ var EnigmailEncryption = {</span>
<a href="#l15.75"></a><span id="l15.75">     }</span>
<a href="#l15.76"></a><span id="l15.76"> </span>
<a href="#l15.77"></a><span id="l15.77">     return exitCode;</span>
<a href="#l15.78"></a><span id="l15.78">   },</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80">   encryptMessage: function(parent, uiFlags, plainText, fromMailAddr, toMailAddr, bccMailAddr, sendFlags,</span>
<a href="#l15.81"></a><span id="l15.81">     exitCodeObj, statusFlagsObj, errorMsgObj) {</span>
<a href="#l15.82"></a><span id="l15.82">     EnigmailLog.DEBUG(&quot;enigmail.js: Enigmail.encryptMessage: &quot; + plainText.length + &quot; bytes from &quot; + fromMailAddr + &quot; to &quot; + toMailAddr + &quot; (&quot; + sendFlags + &quot;)\n&quot;);</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l15.84"></a><span id="l15.84"> </span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+    /*</span>
<a href="#l15.86"></a><span id="l15.86">     exitCodeObj.value = -1;</span>
<a href="#l15.87"></a><span id="l15.87">     statusFlagsObj.value = 0;</span>
<a href="#l15.88"></a><span id="l15.88">     errorMsgObj.value = &quot;&quot;;</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90">     if (!plainText) {</span>
<a href="#l15.91"></a><span id="l15.91">       EnigmailLog.DEBUG(&quot;enigmail.js: Enigmail.encryptMessage: NO ENCRYPTION!\n&quot;);</span>
<a href="#l15.92"></a><span id="l15.92">       exitCodeObj.value = 0;</span>
<a href="#l15.93"></a><span id="l15.93">       EnigmailLog.DEBUG(&quot;  &lt;=== encryptMessage()\n&quot;);</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineat">@@ -562,61 +552,11 @@ var EnigmailEncryption = {</span>
<a href="#l15.95"></a><span id="l15.95">       // Normal return</span>
<a href="#l15.96"></a><span id="l15.96">       EnigmailLog.DEBUG(&quot;  &lt;=== encryptMessage()\n&quot;);</span>
<a href="#l15.97"></a><span id="l15.97">       return EnigmailData.getUnicodeData(listener.stdoutData);</span>
<a href="#l15.98"></a><span id="l15.98">     }</span>
<a href="#l15.99"></a><span id="l15.99"> </span>
<a href="#l15.100"></a><span id="l15.100">     // Error processing</span>
<a href="#l15.101"></a><span id="l15.101">     EnigmailLog.DEBUG(&quot;enigmail.js: Enigmail.encryptMessage: command execution exit code: &quot; + exitCodeObj.value + &quot;\n&quot;);</span>
<a href="#l15.102"></a><span id="l15.102">     return &quot;&quot;;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  */</span>
<a href="#l15.104"></a><span id="l15.104">   },</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-  encryptAttachment: function(parent, fromMailAddr, toMailAddr, bccMailAddr, sendFlags, inFile, outFile,</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-    exitCodeObj, statusFlagsObj, errorMsgObj) {</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-    EnigmailLog.DEBUG(&quot;encryption.jsm: EnigmailEncryption.encryptAttachment infileName=&quot; + inFile.path + &quot;\n&quot;);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-    statusFlagsObj.value = 0;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-    sendFlags |= EnigmailConstants.SEND_ATTACHMENT;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-    let asciiArmor = false;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-    try {</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-      asciiArmor = EnigmailPrefs.getPrefBranch().getBoolPref(&quot;inlineAttachAsciiArmor&quot;);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-    }</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-    catch (ex) {}</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-    const asciiFlags = (asciiArmor ? ENC_TYPE_ATTACH_ASCII : ENC_TYPE_ATTACH_BINARY);</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-    let args = EnigmailEncryption.getEncryptCommand(fromMailAddr, toMailAddr, bccMailAddr, &quot;&quot;, sendFlags, asciiFlags, errorMsgObj);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-    if (!args) {</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-      return null;</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-    }</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-    const signMessage = (sendFlags &amp; EnigmailConstants.SEND_SIGNED);</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-    if (signMessage) {</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-      args = args.concat(EnigmailPassword.command());</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-    }</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-    //const inFilePath = EnigmailFiles.getEscapedFilename(EnigmailFiles.getFilePathReadonly(inFile.QueryInterface(Ci.nsIFile)));</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-    const fileContents = EnigmailFiles.readBinaryFile(inFile.QueryInterface(Ci.nsIFile));</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-    const inFileName = inFile.QueryInterface(Ci.nsIFile).leafName;</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-    const outFilePath = EnigmailFiles.getEscapedFilename(EnigmailFiles.getFilePathReadonly(outFile.QueryInterface(Ci.nsIFile)));</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    args = args.concat([&quot;--yes&quot;, &quot;-o&quot;, outFilePath, &quot;--set-filename&quot;, inFileName]);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-    let cmdErrorMsgObj = {};</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-    const msg = EnigmailExecution.execCmd(EnigmailGpgAgent.agentPath, args, fileContents, exitCodeObj, statusFlagsObj, {}, cmdErrorMsgObj);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-    if (exitCodeObj.value !== 0) {</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-      if (cmdErrorMsgObj.value) {</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-        errorMsgObj.value = EnigmailFiles.formatCmdLine(EnigmailGpgAgent.agentPath, args);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-        errorMsgObj.value += &quot;\n&quot; + cmdErrorMsgObj.value;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-      }</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-      else {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-        errorMsgObj.value = &quot;An unknown error has occurred&quot;;</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-      }</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-    }</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-    return msg;</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-  }</span>
<a href="#l15.156"></a><span id="l15.156"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_common.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,752 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-/* exported BaseProcess, PromiseWorker */</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-/* global ChromeWorker: false,  */</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-var {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-  results: Cr</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-} = Components;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-const XPCOMUtils = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;).XPCOMUtils;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-Components.utils.importGlobalProperties([&quot;TextDecoder&quot;, &quot;TextEncoder&quot;]);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-var _AsyncShutdown, _setTimeout;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-var SubScriptLoader = Cc[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;].getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-SubScriptLoader.loadSubScript(&quot;chrome://openpgp/content/modules/enigmailprocess_shared.js&quot;, this);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;BaseProcess&quot;, &quot;PromiseWorker&quot;, &quot;SubprocessConstants&quot;];</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-const BUFFER_SIZE = 32768;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-let nextResponseId = 0;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-function getAsyncShutdown() {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-  if (!_AsyncShutdown) {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-    _AsyncShutdown = ChromeUtils.import(&quot;resource://gre/modules/AsyncShutdown.jsm&quot;).AsyncShutdown;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-  }</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  return _AsyncShutdown;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-}</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-function getSetTimeout() {</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  if (!_setTimeout) {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-    _setTimeout = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;).setTimeout;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-  }</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-  return _setTimeout;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-}</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-/* global SubprocessConstants: true */</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-/**</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">- * Wraps a ChromeWorker so that messages sent to it return a promise which</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">- * resolves when the message has been received and the operation it triggers is</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">- * complete.</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">- */</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-class _PromiseWorker extends ChromeWorker {</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  constructor(url) {</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-    super(url);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-    this.listeners = new Map();</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    this.pendingResponses = new Map();</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-    this.addListener(&quot;close&quot;, this.onClose.bind(this));</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-    this.addListener(&quot;failure&quot;, this.onFailure.bind(this));</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-    this.addListener(&quot;success&quot;, this.onSuccess.bind(this));</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-    this.addListener(&quot;debug&quot;, this.onDebug.bind(this));</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-    this.addEventListener(&quot;message&quot;, this.onmessage);</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-    this.shutdown = this.shutdown.bind(this);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-    getAsyncShutdown().webWorkersShutdown.addBlocker(</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-      &quot;Subprocess.jsm: Shut down IO worker&quot;,</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-      this.shutdown);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  }</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  onClose() {</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-    getAsyncShutdown().webWorkersShutdown.removeBlocker(this.shutdown);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-  }</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-  shutdown() {</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-    return this.call(&quot;shutdown&quot;, []);</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-  }</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-  /**</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-   * Adds a listener for the given message from the worker. Any message received</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-   * from the worker with a `data.msg` property matching the given `msg`</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-   * parameter are passed to the given listener.</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-   *</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-   * @param {string} msg</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-   *        The message to listen for.</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-   * @param {function(Event)} listener</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-   *        The listener to call when matching messages are received.</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-   */</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-  addListener(msg, listener) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-    if (!this.listeners.has(msg)) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-      this.listeners.set(msg, new Set());</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-    }</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-    this.listeners.get(msg).add(listener);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-  }</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  /**</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-   * Removes the given message listener.</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-   *</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-   * @param {string} msg</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-   *        The message to stop listening for.</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-   * @param {function(Event)} listener</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-   *        The listener to remove.</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-   */</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-  removeListener(msg, listener) {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-    let listeners = this.listeners.get(msg);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-    if (listeners) {</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-      listeners.delete(listener);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-      if (!listeners.size) {</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-        this.listeners.delete(msg);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-      }</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-    }</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-  }</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-  onmessage(event) {</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-    let {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-      msg</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-    } = event.data;</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-    let listeners = this.listeners.get(msg) || new Set();</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-    for (let listener of listeners) {</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-      try {</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-        listener(event.data);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-      }</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-      catch (e) {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-      }</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-    }</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-  }</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-  /**</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-   * Called when a message sent to the worker has failed, and rejects its</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-   * corresponding promise.</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-   *</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-   * @private</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-   */</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-  onFailure({</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-    msgId, error</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-  }) {</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-    this.pendingResponses.get(msgId).reject(error);</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-    this.pendingResponses.delete(msgId);</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-  }</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-  /**</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-   * Called when a message sent to the worker has succeeded, and resolves its</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-   * corresponding promise.</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-   *</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-   * @private</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-   */</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-  onSuccess({</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-    msgId, data</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-  }) {</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-    this.pendingResponses.get(msgId).resolve(data);</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-    this.pendingResponses.delete(msgId);</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-  }</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-  onDebug({</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-    message</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-  }) {</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-    //dump(`Worker debug: ${message}\n`);</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-  }</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-  /**</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-   * Calls the given method in the worker, and returns a promise which resolves</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-   * or rejects when the method has completed.</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-   *</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-   * @param {string} method</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-   *        The name of the method to call.</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-   * @param {Array} args</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-   *        The arguments to pass to the method.</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-   * @param {Array} [transferList]</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-   *        A list of objects to transfer to the worker, rather than cloning.</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-   * @returns {Promise}</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-   */</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-  call(method, args, transferList = []) {</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-    let msgId = nextResponseId++;</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-      this.pendingResponses.set(msgId, {</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-        resolve, reject</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-      });</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-      let message = {</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-        msg: method,</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-        msgId,</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-        args</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-      };</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-      this.postMessage(message, transferList);</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-    });</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-  }</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-}</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineminus">-</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-var PromiseWorker = _PromiseWorker;</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-/**</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineminus">- * Represents an input or output pipe connected to a subprocess.</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">- *</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">- * @property {integer} fd</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">- *           The file descriptor number of the pipe on the child process's side.</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">- *           @readonly</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">- */</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-class Pipe {</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-  /**</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-   * @param {Process} process</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-   *        The child process that this pipe is connected to.</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-   * @param {integer} fd</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-   *        The file descriptor number of the pipe on the child process's side.</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-   * @param {integer} id</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-   *        The internal ID of the pipe, which ties it to the corresponding Pipe</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-   *        object on the Worker side.</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-   */</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-  constructor(process, fd, id) {</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-    this.id = id;</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-    this.fd = fd;</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-    this.processId = process.id;</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-    this.worker = process.worker;</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-    /**</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-     * @property {boolean} closed</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-     *           True if the file descriptor has been closed, and can no longer</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-     *           be read from or written to. Pending IO operations may still</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-     *           complete, but new operations may not be initiated.</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-     *           @readonly</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-     */</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-    this.closed = false;</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">-  }</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineminus">-</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-  /**</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-   * Closes the end of the pipe which belongs to this process.</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-   *</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-   * @param {boolean} force</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-   *        If true, the pipe is closed immediately, regardless of any pending</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-   *        IO operations. If false, the pipe is closed after any existing</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-   *        pending IO operations have completed.</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-   * @returns {Promise&lt;object&gt;}</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-   *          Resolves to an object with no properties once the pipe has been</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-   *          closed.</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-   */</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-  close(force = false) {</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-    this.closed = true;</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-    return this.worker.call(&quot;close&quot;, [this.id, force]);</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-  }</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-}</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-/**</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">- * Represents an output-only pipe, to which data may be written.</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">- */</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-class OutputPipe extends Pipe {</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-  constructor(...args) {</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-    super(...args);</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-    this.encoder = new TextEncoder();</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-  }</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-  /**</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-   * Writes the given data to the stream.</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-   *</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-   * When given an array buffer or typed array, ownership of the buffer is</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-   * transferred to the IO worker, and it may no longer be used from this</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-   * thread.</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-   *</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-   * @param {ArrayBuffer|TypedArray|string} buffer</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-   *        Data to write to the stream.</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-   * @returns {Promise&lt;object&gt;}</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-   *          Resolves to an object with a `bytesWritten` property, containing</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-   *          the number of bytes successfully written, once the operation has</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-   *          completed.</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-   *</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-   * @rejects {object}</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineminus">-   *          May be rejected with an Error object, or an object with similar</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineminus">-   *          properties. The object will include an `errorCode` property with</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-   *          one of the following values if it was rejected for the</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-   *          corresponding reason:</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-   *</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineminus">-   *            - Subprocess.ERROR_END_OF_FILE: The pipe was closed before</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineminus">-   *              all of the data in `buffer` could be written to it.</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-   */</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-  write(buffer) {</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-    if (typeof buffer === &quot;string&quot;) {</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-      buffer = this.encoder.encode(buffer);</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineminus">-    }</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineminus">-</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-    if (Cu.getClassName(buffer, true) !== &quot;ArrayBuffer&quot;) {</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-      if (buffer.byteLength === buffer.buffer.byteLength) {</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineminus">-        buffer = buffer.buffer;</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineminus">-      }</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineminus">-      else {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-        buffer = buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength);</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-      }</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineminus">-    }</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-    let args = [this.id, buffer];</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineminus">-    return this.worker.call(&quot;write&quot;, args, [buffer]);</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineminus">-  }</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineminus">-}</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineminus">-</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineminus">-/**</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineminus">- * Represents an input-only pipe, from which data may be read.</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineminus">- */</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineminus">-class InputPipe extends Pipe {</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineminus">-  constructor(...args) {</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineminus">-    super(...args);</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineminus">-</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineminus">-    this.buffers = [];</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineminus">-</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineminus">-    /**</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineminus">-     * @property {integer} dataAvailable</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineminus">-     *           The number of readable bytes currently stored in the input</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineminus">-     *           buffer.</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineminus">-     *           @readonly</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineminus">-     */</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-    this.dataAvailable = 0;</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineminus">-</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineminus">-    this.decoder = new TextDecoder();</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineminus">-</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineminus">-    this.pendingReads = [];</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineminus">-    this._pendingBufferRead = null;</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineminus">-</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineminus">-    this.fillBuffer();</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineminus">-  }</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineminus">-</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineminus">-  /**</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineminus">-   * @property {integer} bufferSize</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineminus">-   *           The current size of the input buffer. This varies depending on</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineminus">-   *           the size of pending read operations.</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineminus">-   *           @readonly</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-   */</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineminus">-  get bufferSize() {</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-    if (this.pendingReads.length) {</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-      return Math.max(this.pendingReads[0].length, BUFFER_SIZE);</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineminus">-    }</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineminus">-    return BUFFER_SIZE;</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineminus">-  }</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineminus">-</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-  /**</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineminus">-   * Attempts to fill the input buffer.</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineminus">-   *</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineminus">-   * @private</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-   */</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-  fillBuffer() {</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineminus">-    let dataWanted = this.bufferSize - this.dataAvailable;</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineminus">-</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-    if (!this._pendingBufferRead &amp;&amp; dataWanted &gt; 0) {</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-      this._pendingBufferRead = this._read(dataWanted);</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineminus">-</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineminus">-      this._pendingBufferRead.then((result) =&gt; {</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineminus">-        this._pendingBufferRead = null;</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineminus">-</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineminus">-        if (result) {</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineminus">-          this.onInput(result.buffer);</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineminus">-</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineminus">-          this.fillBuffer();</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineminus">-        }</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineminus">-      });</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineminus">-    }</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineminus">-  }</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineminus">-</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineminus">-  _read(size) {</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineminus">-    let args = [this.id, size];</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineminus">-</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineminus">-    return this.worker.call(&quot;read&quot;, args).catch(e =&gt; {</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineminus">-      this.closed = true;</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineminus">-</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineminus">-      for (let {</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineminus">-          length, resolve, reject</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineminus">-        }</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineminus">-        of this.pendingReads.splice(0)) {</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineminus">-        if (length === null &amp;&amp; e.errorCode === SubprocessConstants.ERROR_END_OF_FILE) {</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineminus">-          resolve(new ArrayBuffer(0));</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineminus">-        }</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineminus">-        else {</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-          reject(e);</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineminus">-        }</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-      }</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineminus">-    });</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineminus">-  }</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineminus">-</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineminus">-  /**</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineminus">-   * Adds the given data to the end of the input buffer.</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineminus">-   *</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineminus">-   * @param {ArrayBuffer} buffer</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineminus">-   *        An input buffer to append to the current buffered input.</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineminus">-   * @private</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineminus">-   */</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineminus">-  onInput(buffer) {</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineminus">-    this.buffers.push(buffer);</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineminus">-    this.dataAvailable += buffer.byteLength;</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineminus">-    this.checkPendingReads();</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineminus">-  }</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineminus">-</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineminus">-  /**</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineminus">-   * Checks the topmost pending read operations and fulfills as many as can be</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineminus">-   * filled from the current input buffer.</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineminus">-   *</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineminus">-   * @private</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineminus">-   */</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineminus">-  checkPendingReads() {</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineminus">-    this.fillBuffer();</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineminus">-</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineminus">-    let reads = this.pendingReads;</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineminus">-    while (reads.length &amp;&amp; this.dataAvailable &amp;&amp;</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineminus">-      reads[0].length &lt;= this.dataAvailable) {</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineminus">-      let pending = this.pendingReads.shift();</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineminus">-</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineminus">-      let length = pending.length || this.dataAvailable;</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineminus">-</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineminus">-      let result;</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineminus">-      let byteLength = this.buffers[0].byteLength;</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineminus">-      if (byteLength == length) {</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineminus">-        result = this.buffers.shift();</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineminus">-      }</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineminus">-      else if (byteLength &gt; length) {</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-        let buffer = this.buffers[0];</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineminus">-</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineminus">-        this.buffers[0] = buffer.slice(length);</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineminus">-        result = ArrayBuffer.transfer(buffer, length);</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineminus">-      }</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineminus">-      else {</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineminus">-        result = ArrayBuffer.transfer(this.buffers.shift(), length);</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineminus">-        let u8result = new Uint8Array(result);</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineminus">-</span>
<a href="#l16.429"></a><span id="l16.429" class="difflineminus">-        while (byteLength &lt; length) {</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineminus">-          let buffer = this.buffers[0];</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineminus">-          let u8buffer = new Uint8Array(buffer);</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineminus">-</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineminus">-          let remaining = length - byteLength;</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineminus">-</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineminus">-          if (buffer.byteLength &lt;= remaining) {</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineminus">-            this.buffers.shift();</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineminus">-</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineminus">-            u8result.set(u8buffer, byteLength);</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineminus">-          }</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineminus">-          else {</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineminus">-            this.buffers[0] = buffer.slice(remaining);</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineminus">-</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineminus">-            u8result.set(u8buffer.subarray(0, remaining), byteLength);</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineminus">-          }</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineminus">-</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineminus">-          byteLength += Math.min(buffer.byteLength, remaining);</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineminus">-        }</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineminus">-      }</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineminus">-</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineminus">-      this.dataAvailable -= result.byteLength;</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineminus">-      pending.resolve(result);</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineminus">-    }</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineminus">-  }</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineminus">-</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineminus">-  /**</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineminus">-   * Reads exactly `length` bytes of binary data from the input stream, or, if</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineminus">-   * length is not provided, reads the first chunk of data to become available.</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineminus">-   * In the latter case, returns an empty array buffer on end of file.</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineminus">-   *</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineminus">-   * The read operation will not complete until enough data is available to</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineminus">-   * fulfill the request. If the pipe closes without enough available data to</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineminus">-   * fulfill the read, the operation fails, and any remaining buffered data is</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineminus">-   * lost.</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineminus">-   *</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineminus">-   * @param {integer} [length]</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineminus">-   * @returns {Promise&lt;ArrayBuffer&gt;}</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineminus">-   *</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineminus">-   * @rejects {object}</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineminus">-   *          May be rejected with an Error object, or an object with similar</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineminus">-   *          properties. The object will include an `errorCode` property with</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineminus">-   *          one of the following values if it was rejected for the</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineminus">-   *          corresponding reason:</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineminus">-   *</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineminus">-   *            - Subprocess.ERROR_END_OF_FILE: The pipe was closed before</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineminus">-   *              enough input could be read to satisfy the request.</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineminus">-   */</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineminus">-  read(length = null) {</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineminus">-    if (length !== null &amp;&amp; !(Number.isInteger(length) &amp;&amp; length &gt;= 0)) {</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineminus">-      throw new RangeError(&quot;Length must be a non-negative integer&quot;);</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineminus">-    }</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineminus">-</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineminus">-    if (length == 0) {</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineminus">-      return Promise.resolve(new ArrayBuffer(0));</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineminus">-    }</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineminus">-</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineminus">-      this.pendingReads.push({</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineminus">-        length, resolve, reject</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineminus">-      });</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineminus">-      this.checkPendingReads();</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineminus">-    });</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineminus">-  }</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineminus">-</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineminus">-  /**</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineminus">-   * Reads exactly `length` bytes from the input stream, and parses them as</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineminus">-   * UTF-8 JSON data.</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineminus">-   *</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineminus">-   * @param {integer} length</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineminus">-   * @returns {Promise&lt;object&gt;}</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineminus">-   *</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineminus">-   * @rejects {object}</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineminus">-   *          May be rejected with an Error object, or an object with similar</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineminus">-   *          properties. The object will include an `errorCode` property with</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineminus">-   *          one of the following values if it was rejected for the</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineminus">-   *          corresponding reason:</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineminus">-   *</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineminus">-   *            - Subprocess.ERROR_END_OF_FILE: The pipe was closed before</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineminus">-   *              enough input could be read to satisfy the request.</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineminus">-   *            - Subprocess.ERROR_INVALID_JSON: The data read from the pipe</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineminus">-   *              could not be parsed as a valid JSON string.</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineminus">-   */</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineminus">-  readJSON(length) {</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineminus">-    if (!Number.isInteger(length) || length &lt;= 0) {</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineminus">-      throw new RangeError(&quot;Length must be a positive integer&quot;);</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineminus">-    }</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineminus">-</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineminus">-    return this.readString(length).then(string =&gt; {</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineminus">-      try {</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineminus">-        return JSON.parse(string);</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineminus">-      }</span>
<a href="#l16.523"></a><span id="l16.523" class="difflineminus">-      catch (e) {</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineminus">-        e.errorCode = SubprocessConstants.ERROR_INVALID_JSON;</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineminus">-        throw e;</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineminus">-      }</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineminus">-    });</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineminus">-  }</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineminus">-</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineminus">-  /**</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineminus">-   * Reads a chunk of UTF-8 data from the input stream, and converts it to a</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineminus">-   * JavaScript string.</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineminus">-   *</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineminus">-   * If `length` is provided, reads exactly `length` bytes. Otherwise, reads the</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-   * first chunk of data to become available, and returns an empty string on end</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineminus">-   * of file. In the latter case, the chunk is decoded in streaming mode, and</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineminus">-   * any incomplete UTF-8 sequences at the end of a chunk are returned at the</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineminus">-   * start of a subsequent read operation.</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineminus">-   *</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineminus">-   * @param {integer} [length]</span>
<a href="#l16.541"></a><span id="l16.541" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l16.542"></a><span id="l16.542" class="difflineminus">-   * @param {object} [options]</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineminus">-   *        An options object as expected by TextDecoder.decode.</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineminus">-   * @returns {Promise&lt;string&gt;}</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineminus">-   *</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineminus">-   * @rejects {object}</span>
<a href="#l16.547"></a><span id="l16.547" class="difflineminus">-   *          May be rejected with an Error object, or an object with similar</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineminus">-   *          properties. The object will include an `errorCode` property with</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineminus">-   *          one of the following values if it was rejected for the</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineminus">-   *          corresponding reason:</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineminus">-   *</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineminus">-   *            - Subprocess.ERROR_END_OF_FILE: The pipe was closed before</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineminus">-   *              enough input could be read to satisfy the request.</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineminus">-   */</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineminus">-  readString(length = null, options = {</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineminus">-    stream: length === null</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineminus">-  }) {</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineminus">-    if (length !== null &amp;&amp; !(Number.isInteger(length) &amp;&amp; length &gt;= 0)) {</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineminus">-      throw new RangeError(&quot;Length must be a non-negative integer&quot;);</span>
<a href="#l16.560"></a><span id="l16.560" class="difflineminus">-    }</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineminus">-</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineminus">-    return this.read(length).then(buffer =&gt; {</span>
<a href="#l16.563"></a><span id="l16.563" class="difflineminus">-      return this.decoder.decode(buffer, options);</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineminus">-    });</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineminus">-  }</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineminus">-</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineminus">-  /**</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineminus">-   * Reads 4 bytes from the input stream, and parses them as an unsigned</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineminus">-   * integer, in native byte order.</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineminus">-   *</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineminus">-   * @returns {Promise&lt;integer&gt;}</span>
<a href="#l16.572"></a><span id="l16.572" class="difflineminus">-   *</span>
<a href="#l16.573"></a><span id="l16.573" class="difflineminus">-   * @rejects {object}</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineminus">-   *          May be rejected with an Error object, or an object with similar</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineminus">-   *          properties. The object will include an `errorCode` property with</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineminus">-   *          one of the following values if it was rejected for the</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineminus">-   *          corresponding reason:</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineminus">-   *</span>
<a href="#l16.579"></a><span id="l16.579" class="difflineminus">-   *            - Subprocess.ERROR_END_OF_FILE: The pipe was closed before</span>
<a href="#l16.580"></a><span id="l16.580" class="difflineminus">-   *              enough input could be read to satisfy the request.</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineminus">-   */</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineminus">-  readUint32() {</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineminus">-    return this.read(4).then(buffer =&gt; {</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineminus">-      return new Uint32Array(buffer)[0];</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineminus">-    });</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineminus">-  }</span>
<a href="#l16.587"></a><span id="l16.587" class="difflineminus">-}</span>
<a href="#l16.588"></a><span id="l16.588" class="difflineminus">-</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineminus">-/**</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineminus">- * @class Process</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineminus">- * @extends BaseProcess</span>
<a href="#l16.592"></a><span id="l16.592" class="difflineminus">- */</span>
<a href="#l16.593"></a><span id="l16.593" class="difflineminus">-</span>
<a href="#l16.594"></a><span id="l16.594" class="difflineminus">-/**</span>
<a href="#l16.595"></a><span id="l16.595" class="difflineminus">- * Represents a currently-running process, and allows interaction with it.</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineminus">- */</span>
<a href="#l16.597"></a><span id="l16.597" class="difflineminus">-class _BaseProcess {</span>
<a href="#l16.598"></a><span id="l16.598" class="difflineminus">-  /**</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineminus">-   * @param {PromiseWorker} worker</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineminus">-   *        The worker instance which owns the process.</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineminus">-   * @param {integer} processId</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-   *        The internal ID of the Process object, which ties it to the</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineminus">-   *        corresponding process on the Worker side.</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineminus">-   * @param {integer[]} fds</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineminus">-   *        An array of internal Pipe IDs, one for each standard file descriptor</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineminus">-   *        in the child process.</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineminus">-   * @param {integer} pid</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineminus">-   *        The operating system process ID of the process.</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineminus">-   */</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineminus">-  constructor(worker, processId, fds, pid) {</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineminus">-    this.id = processId;</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineminus">-    this.worker = worker;</span>
<a href="#l16.613"></a><span id="l16.613" class="difflineminus">-</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineminus">-    /**</span>
<a href="#l16.615"></a><span id="l16.615" class="difflineminus">-     * @property {integer} pid</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineminus">-     *           The process ID of the process, assigned by the operating system.</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineminus">-     *           @readonly</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineminus">-     */</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineminus">-    this.pid = pid;</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineminus">-</span>
<a href="#l16.621"></a><span id="l16.621" class="difflineminus">-    this.exitCode = null;</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineminus">-</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineminus">-    this.exitPromise = new Promise(resolve =&gt; {</span>
<a href="#l16.624"></a><span id="l16.624" class="difflineminus">-      this.worker.call(&quot;wait&quot;, [this.id]).then(({</span>
<a href="#l16.625"></a><span id="l16.625" class="difflineminus">-        exitCode</span>
<a href="#l16.626"></a><span id="l16.626" class="difflineminus">-      }) =&gt; {</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineminus">-        resolve(Object.freeze({</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineminus">-          exitCode</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineminus">-        }));</span>
<a href="#l16.630"></a><span id="l16.630" class="difflineminus">-        this.exitCode = exitCode;</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineminus">-      });</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineminus">-    });</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineminus">-</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineminus">-    if (fds[0] !== undefined) {</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineminus">-      /**</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineminus">-       * @property {OutputPipe} stdin</span>
<a href="#l16.637"></a><span id="l16.637" class="difflineminus">-       *           A Pipe object which allows writing to the process's standard</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineminus">-       *           input.</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineminus">-       *           @readonly</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineminus">-       */</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineminus">-      this.stdin = new OutputPipe(this, 0, fds[0]);</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineminus">-    }</span>
<a href="#l16.643"></a><span id="l16.643" class="difflineminus">-    if (fds[1] !== undefined) {</span>
<a href="#l16.644"></a><span id="l16.644" class="difflineminus">-      /**</span>
<a href="#l16.645"></a><span id="l16.645" class="difflineminus">-       * @property {InputPipe} stdout</span>
<a href="#l16.646"></a><span id="l16.646" class="difflineminus">-       *           A Pipe object which allows reading from the process's standard</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineminus">-       *           output.</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineminus">-       *           @readonly</span>
<a href="#l16.649"></a><span id="l16.649" class="difflineminus">-       */</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineminus">-      this.stdout = new InputPipe(this, 1, fds[1]);</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineminus">-    }</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineminus">-    if (fds[2] !== undefined) {</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineminus">-      /**</span>
<a href="#l16.654"></a><span id="l16.654" class="difflineminus">-       * @property {InputPipe} [stderr]</span>
<a href="#l16.655"></a><span id="l16.655" class="difflineminus">-       *           An optional Pipe object which allows reading from the</span>
<a href="#l16.656"></a><span id="l16.656" class="difflineminus">-       *           process's standard error output.</span>
<a href="#l16.657"></a><span id="l16.657" class="difflineminus">-       *           @readonly</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineminus">-       */</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineminus">-      this.stderr = new InputPipe(this, 2, fds[2]);</span>
<a href="#l16.660"></a><span id="l16.660" class="difflineminus">-    }</span>
<a href="#l16.661"></a><span id="l16.661" class="difflineminus">-  }</span>
<a href="#l16.662"></a><span id="l16.662" class="difflineminus">-</span>
<a href="#l16.663"></a><span id="l16.663" class="difflineminus">-  /**</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineminus">-   * Spawns a process, and resolves to a BaseProcess instance on success.</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineminus">-   *</span>
<a href="#l16.666"></a><span id="l16.666" class="difflineminus">-   * @param {object} options</span>
<a href="#l16.667"></a><span id="l16.667" class="difflineminus">-   *        An options object as passed to `Subprocess.call`.</span>
<a href="#l16.668"></a><span id="l16.668" class="difflineminus">-   *</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineminus">-   * @returns {Promise&lt;BaseProcess&gt;}</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineminus">-   */</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineminus">-  static create(options) {</span>
<a href="#l16.672"></a><span id="l16.672" class="difflineminus">-    let worker = this.getWorker();</span>
<a href="#l16.673"></a><span id="l16.673" class="difflineminus">-</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineminus">-    return worker.call(&quot;spawn&quot;, [options]).then(({</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineminus">-      processId, fds, pid</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineminus">-    }) =&gt; {</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineminus">-      return new this(worker, processId, fds, pid);</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineminus">-    });</span>
<a href="#l16.679"></a><span id="l16.679" class="difflineminus">-  }</span>
<a href="#l16.680"></a><span id="l16.680" class="difflineminus">-</span>
<a href="#l16.681"></a><span id="l16.681" class="difflineminus">-  static get WORKER_URL() {</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineminus">-    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineminus">-  }</span>
<a href="#l16.684"></a><span id="l16.684" class="difflineminus">-</span>
<a href="#l16.685"></a><span id="l16.685" class="difflineminus">-  static get WorkerClass() {</span>
<a href="#l16.686"></a><span id="l16.686" class="difflineminus">-    return PromiseWorker;</span>
<a href="#l16.687"></a><span id="l16.687" class="difflineminus">-  }</span>
<a href="#l16.688"></a><span id="l16.688" class="difflineminus">-</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineminus">-  /**</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineminus">-   * Gets the current subprocess worker, or spawns a new one if it does not</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineminus">-   * currently exist.</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineminus">-   *</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineminus">-   * @returns {PromiseWorker}</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineminus">-   */</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineminus">-  static getWorker() {</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineminus">-    if (!this._worker) {</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineminus">-      this._worker = new this.WorkerClass(this.WORKER_URL);</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineminus">-    }</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineminus">-    return this._worker;</span>
<a href="#l16.700"></a><span id="l16.700" class="difflineminus">-  }</span>
<a href="#l16.701"></a><span id="l16.701" class="difflineminus">-</span>
<a href="#l16.702"></a><span id="l16.702" class="difflineminus">-  /**</span>
<a href="#l16.703"></a><span id="l16.703" class="difflineminus">-   * Kills the process.</span>
<a href="#l16.704"></a><span id="l16.704" class="difflineminus">-   *</span>
<a href="#l16.705"></a><span id="l16.705" class="difflineminus">-   * @param {integer} [timeout=300]</span>
<a href="#l16.706"></a><span id="l16.706" class="difflineminus">-   *        A timeout, in milliseconds, after which the process will be forcibly</span>
<a href="#l16.707"></a><span id="l16.707" class="difflineminus">-   *        killed. On platforms which support it, the process will be sent</span>
<a href="#l16.708"></a><span id="l16.708" class="difflineminus">-   *        a `SIGTERM` signal immediately, so that it has a chance to terminate</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineminus">-   *        gracefully, and a `SIGKILL` signal if it hasn't exited within</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineminus">-   *        `timeout` milliseconds. On other platforms (namely Windows), the</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineminus">-   *        process will be forcibly terminated immediately.</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineminus">-   *</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineminus">-   * @returns {Promise&lt;object&gt;}</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineminus">-   *          Resolves to an object with an `exitCode` property when the process</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineminus">-   *          has exited.</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineminus">-   */</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineminus">-  kill(timeout = 300) {</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineminus">-    // If the process has already exited, don't bother sending a signal.</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineminus">-    if (this.exitCode !== null) {</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineminus">-      return this.wait();</span>
<a href="#l16.721"></a><span id="l16.721" class="difflineminus">-    }</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineminus">-</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineminus">-    let force = timeout &lt;= 0;</span>
<a href="#l16.724"></a><span id="l16.724" class="difflineminus">-    this.worker.call(&quot;kill&quot;, [this.id, force]);</span>
<a href="#l16.725"></a><span id="l16.725" class="difflineminus">-</span>
<a href="#l16.726"></a><span id="l16.726" class="difflineminus">-    if (!force) {</span>
<a href="#l16.727"></a><span id="l16.727" class="difflineminus">-      getSetTimeout()(() =&gt; {</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineminus">-        if (this.exitCode === null) {</span>
<a href="#l16.729"></a><span id="l16.729" class="difflineminus">-          this.worker.call(&quot;kill&quot;, [this.id, true]);</span>
<a href="#l16.730"></a><span id="l16.730" class="difflineminus">-        }</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineminus">-      }, timeout);</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineminus">-    }</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineminus">-</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineminus">-    return this.wait();</span>
<a href="#l16.735"></a><span id="l16.735" class="difflineminus">-  }</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineminus">-</span>
<a href="#l16.737"></a><span id="l16.737" class="difflineminus">-  /**</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineminus">-   * Returns a promise which resolves to the process's exit code, once it has</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineminus">-   * exited.</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineminus">-   *</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineminus">-   * @returns {Promise&lt;object&gt;}</span>
<a href="#l16.742"></a><span id="l16.742" class="difflineminus">-   * Resolves to an object with an `exitCode` property, containing the</span>
<a href="#l16.743"></a><span id="l16.743" class="difflineminus">-   * process's exit code, once the process has exited.</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineminus">-   *</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineminus">-   * On Unix-like systems, a negative exit code indicates that the</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineminus">-   * process was killed by a signal whose signal number is the absolute</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineminus">-   * value of the error code. On Windows, an exit code of -9 indicates</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineminus">-   * that the process was killed via the {@linkcode BaseProcess#kill kill()}</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineminus">-   * method.</span>
<a href="#l16.750"></a><span id="l16.750" class="difflineminus">-   */</span>
<a href="#l16.751"></a><span id="l16.751" class="difflineminus">-  wait() {</span>
<a href="#l16.752"></a><span id="l16.752" class="difflineminus">-    return this.exitPromise;</span>
<a href="#l16.753"></a><span id="l16.753" class="difflineminus">-  }</span>
<a href="#l16.754"></a><span id="l16.754" class="difflineminus">-}</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineminus">-</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineminus">-var BaseProcess = _BaseProcess;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_main.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,178 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-/*</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">- * These modules are loosely based on the subprocess.jsm module created</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">- * by Jan Gerber and Patrick Brunschwig, though the implementation</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">- * differs drastically.</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">- */</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-let EXPORTED_SYMBOLS = [&quot;SubprocessMain&quot;];</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-/* exported SubprocessMain */</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-var {</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  results: Cr</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-} = Components;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-Components.utils.importGlobalProperties([&quot;TextEncoder&quot;]);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-const AppConstants = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;).AppConstants;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-const XPCOMUtils = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;).XPCOMUtils;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-var SubprocessConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/enigmailprocess_common.jsm&quot;).SubprocessConstants;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-  XPCOMUtils.defineLazyModuleGetter(this, &quot;SubprocessImpl&quot;,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    &quot;chrome://openpgp/content/modules/enigmailprocess_win.jsm&quot;); /* global SubprocessImpl: false */</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-}</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-else {</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-  XPCOMUtils.defineLazyModuleGetter(this, &quot;SubprocessImpl&quot;,</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-    &quot;chrome://openpgp/content/modules/enigmailprocess_unix.jsm&quot;);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-}</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-function encodeEnvVar(name, value) {</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-  if (typeof name === &quot;string&quot; &amp;&amp; typeof value === &quot;string&quot;) {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    return `${name}=${value}`;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-  }</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-  let encoder = new TextEncoder(&quot;utf-8&quot;);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  function encode(val) {</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-    return typeof val === &quot;string&quot; ? encoder.encode(val) : val;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  }</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  return Uint8Array.of(...encode(name), ...encode(&quot;=&quot;), ...encode(value), 0);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-}</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-/**</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">- * Allows for creation of and communication with OS-level sub-processes.</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">- * @namespace</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">- */</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-var SubprocessMain = {</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  /**</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-   * Launches a process, and returns a handle to it.</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-   *</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-   * @param {object} options</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-   * An object describing the process to launch.</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-   *</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-   * @param {string} options.command</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-   * The full path of the execuable to launch. Relative paths are not</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-   * accepted, and `$PATH` is not searched.</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-   *</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-   * If a path search is necessary, the {@link SubprocessMain.pathSearch} method may</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-   * be used to map a bare executable name to a full path.</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-   *</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-   * @param {string[]} [options.arguments]</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-   * A list of strings to pass as arguments to the process.</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-   *</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-   * @param {object} [options.environment]</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-   * An object containing a key and value for each environment variable</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-   * to pass to the process. Only the object's own, enumerable properties</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-   * are added to the environment.</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-   *</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-   * @param {boolean} [options.environmentAppend]</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-   * If true, append the environment variables passed in `environment` to</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-   * the existing set of environment variables. Otherwise, the values in</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-   * 'environment' constitute the entire set of environment variables</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-   * passed to the new process.</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-   *</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-   * @param {string} [options.stderr]</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-   * Defines how the process's stderr output is handled. One of:</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-   *</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-   * - `&quot;ignore&quot;`: (default) The process's standard error is not redirected.</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-   * - `&quot;stdout&quot;`: The process's stderr is merged with its stdout.</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-   * - `&quot;pipe&quot;`: The process's stderr is redirected to a pipe, which can be read</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-   *   from via its `stderr` property.</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-   *</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-   * @param {string} [options.workdir]</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-   *        The working directory in which to launch the new process.</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-   *</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-   * @returns {Promise&lt;Process&gt;}</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-   *</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-   * @rejects {Error}</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-   * May be rejected with an Error object if the process can not be</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-   * launched. The object will include an `errorCode` property with</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-   * one of the following values if it was rejected for the</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-   * corresponding reason:</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-   *</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-   * - SubprocessMain.ERROR_BAD_EXECUTABLE: The given command could not</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-   *   be found, or the file that it references is not executable.</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-   *</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-   * Note that if the process is successfully launched, but exits with</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-   * a non-zero exit code, the promise will still resolve successfully.</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-   */</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-  call(options) {</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-      options = Object.assign({}, options);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-      options.stderr = options.stderr || &quot;ignore&quot;;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-      options.workdir = options.workdir || null;</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-      let environment = {};</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-      if (!options.environment || options.environmentAppend) {</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-        environment = this.getEnvironment();</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-      }</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-      if (options.environment) {</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-        Object.assign(environment, options.environment);</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-      }</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-      options.environment = Object.entries(environment)</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-        .map(([key, val]) =&gt; encodeEnvVar(key, val));</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-      options.arguments = Array.from(options.arguments || []);</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-      return Promise.resolve(SubprocessImpl.isExecutableFile(options.command)).then(isExecutable =&gt; {</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-        if (!isExecutable) {</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-          let error = new Error(`File at path &quot;${options.command}&quot; does not exist, or is not executable`);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-          error.errorCode = SubprocessConstants.ERROR_BAD_EXECUTABLE;</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-          throw error;</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-        }</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-        options.arguments.unshift(options.command);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-        return SubprocessImpl.call(options);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-      });</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-    },</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-    /**</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-     * Returns an object with a key-value pair for every variable in the process's</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-     * current environment.</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-     *</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-     * @returns {object}</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-     */</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-    getEnvironment() {</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-      let environment = Object.create(null);</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-      for (let [k, v] of SubprocessImpl.getEnvironment()) {</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-        environment[k] = v;</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-      }</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-      return environment;</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-    },</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-    /**</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-     * Searches for the given executable file in the system executable</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-     * file paths as specified by the PATH environment variable.</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-     *</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-     * On Windows, if the unadorned filename cannot be found, the</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-     * extensions in the semicolon-separated list in the PATHSEP</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-     * environment variable are successively appended to the original</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-     * name and searched for in turn.</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-     *</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-     * @param {string} command</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-     *        The name of the executable to find.</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-     * @param {object} [environment]</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-     *        An object containing a key for each environment variable to be used</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-     *        in the search. If not provided, full the current process environment</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-     *        is used.</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-     * @returns {Promise&lt;string&gt;}</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-     */</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-    pathSearch(command, environment = this.getEnvironment()) {</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-      let path = SubprocessImpl.pathSearch(command, environment);</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-      return Promise.resolve(path);</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-    }</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-};</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-Object.assign(SubprocessMain, SubprocessConstants);</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-Object.freeze(SubprocessMain);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_shared.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,102 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-/* exported Library, SubprocessConstants */</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-/* global ctypes: false */</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-if (!ArrayBuffer.transfer) {</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  /**</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-   * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer/transfer</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-   *</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-   * @param {ArrayBuffer} buffer</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-   * @param {integer} [size = buffer.byteLength]</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-   * @returns {ArrayBuffer}</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-   */</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-  ArrayBuffer.transfer = function(buffer, size = buffer.byteLength) {</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-    let u8out = new Uint8Array(size);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-    let u8buffer = new Uint8Array(buffer, 0, Math.min(size, buffer.byteLength));</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-    u8out.set(u8buffer);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-    return u8out.buffer;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  };</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-}</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-var libraries = {};</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-class Library {</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  constructor(name, names, definitions) {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-    if (name in libraries) {</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-      return libraries[name];</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-    }</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-    for (let name of names) {</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-      try {</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-        if (!this.library) {</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-          this.library = ctypes.open(name);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-        }</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-      } catch (e) {</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-        // Ignore errors until we've tried all the options.</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-      }</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    }</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-    if (!this.library) {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-      throw new Error(&quot;Could not load libc&quot;);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-    }</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-    libraries[name] = this;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    for (let symbol of Object.keys(definitions)) {</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-      this.declare(symbol, ...definitions[symbol]);</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-    }</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-    return this;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-  }</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-  declare(name, ...args) {</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-    Object.defineProperty(this, name, {</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-      configurable: true,</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-      get() {</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-        Object.defineProperty(this, name, {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-          configurable: true,</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-          value: this.library.declare(name, ...args)</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-        });</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-        return this[name];</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-      }</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-    });</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-  }</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-}</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-/**</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">- * Holds constants which apply to various Subprocess operations.</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">- * @namespace</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">- * @lends Subprocess</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">- */</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-var SubprocessConstants = {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-  /**</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-   * @property {integer} ERROR_END_OF_FILE</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-   *           The operation failed because the end of the file was reached.</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-   *           @constant</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-   */</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-  ERROR_END_OF_FILE: 0xff7a0001,</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-  /**</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-   * @property {integer} ERROR_INVALID_JSON</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-   *           The operation failed because an invalid JSON was encountered.</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-   *           @constant</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-   */</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-  ERROR_INVALID_JSON: 0xff7a0002,</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-  /**</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-   * @property {integer} ERROR_BAD_EXECUTABLE</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-   *           The operation failed because the given file did not exist, or</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-   *           could not be executed.</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-   *           @constant</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-   */</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-  ERROR_BAD_EXECUTABLE: 0xff7a0003</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-};</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-Object.freeze(SubprocessConstants);</span>
<a href="#l18.107"></a><span id="l18.107">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_shared_unix.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,169 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-/* exported libc */</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-/* global ctypes: false, OS: false, Library: false */</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-const LIBC = OS.Constants.libc;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-const LIBC_CHOICES = [&quot;libc.so&quot;, &quot;libSystem.B.dylib&quot;, &quot;a.out&quot;];</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-const unix = {</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-  pid_t: ctypes.int32_t,</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-  pollfd: new ctypes.StructType(&quot;pollfd&quot;, [{</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-    &quot;fd&quot;: ctypes.int</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-  }, {</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-    &quot;events&quot;: ctypes.short</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-  }, {</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-    &quot;revents&quot;: ctypes.short</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-  }]),</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  posix_spawn_file_actions_t: ctypes.uint8_t.array(</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-    LIBC.OSFILE_SIZEOF_POSIX_SPAWN_FILE_ACTIONS_T),</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-  WEXITSTATUS(status) {</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-    return (status &gt;&gt; 8) &amp; 0xff;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-  },</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-  WTERMSIG(status) {</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-    return status &amp; 0x7f;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  }</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-};</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-var libc = new Library(&quot;libc&quot;, LIBC_CHOICES, {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  environ: [ctypes.char.ptr.ptr],</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  // Darwin-only.</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-  _NSGetEnviron: [</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-    ctypes.char.ptr.ptr.ptr</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-  ],</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-  setenv: [</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-    ctypes.int</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-  ],</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-  chdir: [</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-    ctypes.char.ptr /* path */</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-  ],</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-  close: [</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-    ctypes.int /* fildes */</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  ],</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-  fcntl: [</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-    ctypes.int, /* fildes */</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-    ctypes.int, /* cmd */</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-    ctypes.int /* ... */</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-  ],</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-  getcwd: [</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-    ctypes.char.ptr,</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-    ctypes.char.ptr, /* buf */</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-    ctypes.size_t /* size */</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-  ],</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-  kill: [</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-    unix.pid_t, /* pid */</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-    ctypes.int /* signal */</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-  ],</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-  pipe: [</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-    ctypes.int.array(2) /* pipefd */</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-  ],</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-  poll: [</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-    unix.pollfd.array(), /* fds */</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-    ctypes.unsigned_int, /* nfds */</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-    ctypes.int /* timeout */</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-  ],</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-  posix_spawn: [</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-    unix.pid_t.ptr, /* pid */</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-    ctypes.char.ptr, /* path */</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-    unix.posix_spawn_file_actions_t.ptr, /* file_actions */</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-    ctypes.voidptr_t, /* attrp */</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-    ctypes.char.ptr.ptr, /* argv */</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-    ctypes.char.ptr.ptr /* envp */</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-  ],</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-  posix_spawn_file_actions_addclose: [</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-    unix.posix_spawn_file_actions_t.ptr, /* file_actions */</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-    ctypes.int /* fildes */</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-  ],</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-  posix_spawn_file_actions_adddup2: [</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-    unix.posix_spawn_file_actions_t.ptr, /* file_actions */</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-    ctypes.int, /* fildes */</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-    ctypes.int /* newfildes */</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-  ],</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-  posix_spawn_file_actions_destroy: [</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-    unix.posix_spawn_file_actions_t.ptr /* file_actions */</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-  ],</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-  posix_spawn_file_actions_init: [</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-    ctypes.int,</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-    unix.posix_spawn_file_actions_t.ptr /* file_actions */</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-  ],</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-  read: [</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-    ctypes.ssize_t,</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-    ctypes.int, /* fildes */</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-    ctypes.char.ptr, /* buf */</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-    ctypes.size_t /* nbyte */</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-  ],</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-  waitpid: [</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-    unix.pid_t,</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-    unix.pid_t, /* pid */</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-    ctypes.int.ptr, /* status */</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-    ctypes.int /* options */</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-  ],</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-  write: [</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-    ctypes.default_abi,</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-    ctypes.ssize_t,</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-    ctypes.int, /* fildes */</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-    ctypes.char.ptr, /* buf */</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-    ctypes.size_t /* nbyte */</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-  ]</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-});</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-unix.Fd = function(fd) {</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-  return ctypes.CDataFinalizer(ctypes.int(fd), libc.close);</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_shared_win.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,581 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-/* exported LIBC, Win, createPipe, libc */</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-/* global ctypes: false, OS: false, Library: false */</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-/* eslint no-void: 0 */</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-const LIBC = OS.Constants.libc;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-const Win = OS.Constants.Win;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-const LIBC_CHOICES = [&quot;kernel32.dll&quot;];</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-var win32 = {</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-  // On Windows 64, winapi_abi is an alias for default_abi.</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  WINAPI: ctypes.winapi_abi,</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-  VOID: ctypes.void_t,</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-  BYTE: ctypes.uint8_t,</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  WORD: ctypes.uint16_t,</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  DWORD: ctypes.uint32_t,</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  LONG: ctypes.long,</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  LARGE_INTEGER: ctypes.int64_t,</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  ULONGLONG: ctypes.uint64_t,</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  UINT: ctypes.unsigned_int,</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  UCHAR: ctypes.unsigned_char,</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  BOOL: ctypes.bool,</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  HANDLE: ctypes.voidptr_t,</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-  PVOID: ctypes.voidptr_t,</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  LPVOID: ctypes.voidptr_t,</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-  CHAR: ctypes.char,</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-  WCHAR: ctypes.jschar,</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-  ULONG_PTR: ctypes.uintptr_t,</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  SIZE_T: ctypes.size_t,</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  PSIZE_T: ctypes.size_t.ptr</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-};</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-Object.assign(win32, {</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  DWORD_PTR: win32.ULONG_PTR,</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-  LPSTR: win32.CHAR.ptr,</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-  LPWSTR: win32.WCHAR.ptr,</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  LPBYTE: win32.BYTE.ptr,</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-  LPDWORD: win32.DWORD.ptr,</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  LPHANDLE: win32.HANDLE.ptr,</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-  // This is an opaque type.</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  PROC_THREAD_ATTRIBUTE_LIST: ctypes.char.array(),</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-  LPPROC_THREAD_ATTRIBUTE_LIST: ctypes.char.ptr</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-});</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-Object.assign(win32, {</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-  LPCSTR: win32.LPSTR,</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-  LPCWSTR: win32.LPWSTR,</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-  LPCVOID: win32.LPVOID</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-});</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-Object.assign(win32, {</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-  INVALID_HANDLE_VALUE: ctypes.cast(ctypes.int64_t(-1), win32.HANDLE),</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  NULL_HANDLE_VALUE: ctypes.cast(ctypes.uintptr_t(0), win32.HANDLE),</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  CREATE_SUSPENDED: 0x00000004,</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-  CREATE_NEW_CONSOLE: 0x00000010,</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-  CREATE_UNICODE_ENVIRONMENT: 0x00000400,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-  CREATE_NO_WINDOW: 0x08000000,</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-  CREATE_BREAKAWAY_FROM_JOB: 0x01000000,</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-  EXTENDED_STARTUPINFO_PRESENT: 0x00080000,</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-  STARTF_USESTDHANDLES: 0x0100,</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-  DUPLICATE_CLOSE_SOURCE: 0x01,</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-  DUPLICATE_SAME_ACCESS: 0x02,</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-  ERROR_HANDLE_EOF: 38,</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-  ERROR_BROKEN_PIPE: 109,</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-  ERROR_INSUFFICIENT_BUFFER: 122,</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-  FILE_FLAG_OVERLAPPED: 0x40000000,</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-  PIPE_TYPE_BYTE: 0x00,</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-  PIPE_ACCESS_INBOUND: 0x01,</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-  PIPE_ACCESS_OUTBOUND: 0x02,</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-  PIPE_ACCESS_DUPLEX: 0x03,</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-  PIPE_WAIT: 0x00,</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-  PIPE_NOWAIT: 0x01,</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-  STILL_ACTIVE: 259,</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-  PROC_THREAD_ATTRIBUTE_HANDLE_LIST: 0x00020002,</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-  JobObjectBasicLimitInformation: 2,</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-  JobObjectExtendedLimitInformation: 9,</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-  JOB_OBJECT_LIMIT_BREAKAWAY_OK: 0x00000800,</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-  // These constants are 32-bit unsigned integers, but Windows defines</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-  // them as negative integers cast to an unsigned type.</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-  STD_INPUT_HANDLE: -10 + 0x100000000,</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-  STD_OUTPUT_HANDLE: -11 + 0x100000000,</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-  STD_ERROR_HANDLE: -12 + 0x100000000,</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-  WAIT_TIMEOUT: 0x00000102,</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-  WAIT_FAILED: 0xffffffff</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-});</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-Object.assign(win32, {</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  JOBOBJECT_BASIC_LIMIT_INFORMATION: new ctypes.StructType(&quot;JOBOBJECT_BASIC_LIMIT_INFORMATION&quot;, [{</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-    &quot;PerProcessUserTimeLimit&quot;: win32.LARGE_INTEGER</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-  }, {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-    &quot;PerJobUserTimeLimit&quot;: win32.LARGE_INTEGER</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-  }, {</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-    &quot;LimitFlags&quot;: win32.DWORD</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-  }, {</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-    &quot;MinimumWorkingSetSize&quot;: win32.SIZE_T</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-  }, {</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-    &quot;MaximumWorkingSetSize&quot;: win32.SIZE_T</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-  }, {</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-    &quot;ActiveProcessLimit&quot;: win32.DWORD</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-  }, {</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-    &quot;Affinity&quot;: win32.ULONG_PTR</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-  }, {</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-    &quot;PriorityClass&quot;: win32.DWORD</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  }, {</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-    &quot;SchedulingClass&quot;: win32.DWORD</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-  }]),</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-  IO_COUNTERS: new ctypes.StructType(&quot;IO_COUNTERS&quot;, [{</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-    &quot;ReadOperationCount&quot;: win32.ULONGLONG</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-  }, {</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-    &quot;WriteOperationCount&quot;: win32.ULONGLONG</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-  }, {</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-    &quot;OtherOperationCount&quot;: win32.ULONGLONG</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-  }, {</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-    &quot;ReadTransferCount&quot;: win32.ULONGLONG</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-  }, {</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-    &quot;WriteTransferCount&quot;: win32.ULONGLONG</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-  }, {</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-    &quot;OtherTransferCount&quot;: win32.ULONGLONG</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-  }])</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-});</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-Object.assign(win32, {</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-  JOBOBJECT_EXTENDED_LIMIT_INFORMATION: new ctypes.StructType(&quot;JOBOBJECT_EXTENDED_LIMIT_INFORMATION&quot;, [{</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-    &quot;BasicLimitInformation&quot;: win32.JOBOBJECT_BASIC_LIMIT_INFORMATION</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-  }, {</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-    &quot;IoInfo&quot;: win32.IO_COUNTERS</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-  }, {</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-    &quot;ProcessMemoryLimit&quot;: win32.SIZE_T</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-  }, {</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-    &quot;JobMemoryLimit&quot;: win32.SIZE_T</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-  }, {</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-    &quot;PeakProcessMemoryUsed&quot;: win32.SIZE_T</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-  }, {</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-    &quot;PeakJobMemoryUsed&quot;: win32.SIZE_T</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-  }]),</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-  OVERLAPPED: new ctypes.StructType(&quot;OVERLAPPED&quot;, [{</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-    &quot;Internal&quot;: win32.ULONG_PTR</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-  }, {</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-    &quot;InternalHigh&quot;: win32.ULONG_PTR</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-  }, {</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-    &quot;Offset&quot;: win32.DWORD</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-  }, {</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-    &quot;OffsetHigh&quot;: win32.DWORD</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-  }, {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-    &quot;hEvent&quot;: win32.HANDLE</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-  }]),</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-  PROCESS_INFORMATION: new ctypes.StructType(&quot;PROCESS_INFORMATION&quot;, [{</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-    &quot;hProcess&quot;: win32.HANDLE</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-  }, {</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-    &quot;hThread&quot;: win32.HANDLE</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-  }, {</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-    &quot;dwProcessId&quot;: win32.DWORD</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-  }, {</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-    &quot;dwThreadId&quot;: win32.DWORD</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-  }]),</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-  SECURITY_ATTRIBUTES: new ctypes.StructType(&quot;SECURITY_ATTRIBUTES&quot;, [{</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-    &quot;nLength&quot;: win32.DWORD</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-  }, {</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-    &quot;lpSecurityDescriptor&quot;: win32.LPVOID</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-  }, {</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-    &quot;bInheritHandle&quot;: win32.BOOL</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-  }]),</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-  STARTUPINFOW: new ctypes.StructType(&quot;STARTUPINFOW&quot;, [{</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-    &quot;cb&quot;: win32.DWORD</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-  }, {</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-    &quot;lpReserved&quot;: win32.LPWSTR</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineminus">-  }, {</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-    &quot;lpDesktop&quot;: win32.LPWSTR</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineminus">-  }, {</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-    &quot;lpTitle&quot;: win32.LPWSTR</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-  }, {</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-    &quot;dwX&quot;: win32.DWORD</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-  }, {</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-    &quot;dwY&quot;: win32.DWORD</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-  }, {</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-    &quot;dwXSize&quot;: win32.DWORD</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-  }, {</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineminus">-    &quot;dwYSize&quot;: win32.DWORD</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-  }, {</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-    &quot;dwXCountChars&quot;: win32.DWORD</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-  }, {</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-    &quot;dwYCountChars&quot;: win32.DWORD</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-  }, {</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-    &quot;dwFillAttribute&quot;: win32.DWORD</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-  }, {</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-    &quot;dwFlags&quot;: win32.DWORD</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-  }, {</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-    &quot;wShowWindow&quot;: win32.WORD</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineminus">-  }, {</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineminus">-    &quot;cbReserved2&quot;: win32.WORD</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-  }, {</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-    &quot;lpReserved2&quot;: win32.LPBYTE</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-  }, {</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-    &quot;hStdInput&quot;: win32.HANDLE</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-  }, {</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-    &quot;hStdOutput&quot;: win32.HANDLE</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-  }, {</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-    &quot;hStdError&quot;: win32.HANDLE</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-  }])</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-});</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-Object.assign(win32, {</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-  STARTUPINFOEXW: new ctypes.StructType(&quot;STARTUPINFOEXW&quot;, [{</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-    &quot;StartupInfo&quot;: win32.STARTUPINFOW</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-  }, {</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-    &quot;lpAttributeList&quot;: win32.LPPROC_THREAD_ATTRIBUTE_LIST</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-  }])</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-});</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-var libc = new Library(&quot;libc&quot;, LIBC_CHOICES, {</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-  AssignProcessToJobObject: [</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-    win32.HANDLE, /* hJob */</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-    win32.HANDLE /* hProcess */</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-  ],</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-  CloseHandle: [</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-    win32.HANDLE /* hObject */</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-  ],</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-  CreateEventW: [</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineminus">-    win32.HANDLE,</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* opt lpEventAttributes */</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineminus">-    win32.BOOL, /* bManualReset */</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineminus">-    win32.BOOL, /* bInitialState */</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-    win32.LPWSTR /* lpName */</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineminus">-  ],</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineminus">-</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineminus">-  CreateFileW: [</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-    win32.HANDLE,</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-    win32.LPWSTR, /* lpFileName */</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-    win32.DWORD, /* dwDesiredAccess */</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineminus">-    win32.DWORD, /* dwShareMode */</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* opt lpSecurityAttributes */</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineminus">-    win32.DWORD, /* dwCreationDisposition */</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineminus">-    win32.DWORD, /* dwFlagsAndAttributes */</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineminus">-    win32.HANDLE /* opt hTemplateFile */</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineminus">-  ],</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineminus">-</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-  CreateJobObjectW: [</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-    win32.HANDLE,</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* opt lpJobAttributes */</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-    win32.LPWSTR /* lpName */</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-  ],</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-  CreateNamedPipeW: [</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-    win32.HANDLE,</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineminus">-    win32.LPWSTR, /* lpName */</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-    win32.DWORD, /* dwOpenMode */</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-    win32.DWORD, /* dwPipeMode */</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-    win32.DWORD, /* nMaxInstances */</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineminus">-    win32.DWORD, /* nOutBufferSize */</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-    win32.DWORD, /* nInBufferSize */</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-    win32.DWORD, /* nDefaultTimeOut */</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr /* opt lpSecurityAttributes */</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-  ],</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-  CreatePipe: [</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineminus">-    win32.LPHANDLE, /* out hReadPipe */</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineminus">-    win32.LPHANDLE, /* out hWritePipe */</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* opt lpPipeAttributes */</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-    win32.DWORD /* nSize */</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-  ],</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-  CreateProcessW: [</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-    win32.LPCWSTR, /* lpApplicationName */</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineminus">-    win32.LPWSTR, /* lpCommandLine */</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* lpProcessAttributes */</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* lpThreadAttributes */</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-    win32.BOOL, /* bInheritHandle */</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-    win32.DWORD, /* dwCreationFlags */</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-    win32.LPVOID, /* opt lpEnvironment */</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-    win32.LPCWSTR, /* opt lpCurrentDirectory */</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineminus">-    win32.STARTUPINFOW.ptr, /* lpStartupInfo */</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-    win32.PROCESS_INFORMATION.ptr /* out lpProcessInformation */</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-  ],</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-  CreateSemaphoreW: [</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-    win32.HANDLE,</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineminus">-    win32.SECURITY_ATTRIBUTES.ptr, /* opt lpSemaphoreAttributes */</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineminus">-    win32.LONG, /* lInitialCount */</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineminus">-    win32.LONG, /* lMaximumCount */</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-    win32.LPCWSTR /* opt lpName */</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineminus">-  ],</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineminus">-</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineminus">-  DeleteProcThreadAttributeList: [</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineminus">-    win32.VOID,</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineminus">-    win32.LPPROC_THREAD_ATTRIBUTE_LIST /* in/out lpAttributeList */</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineminus">-  ],</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineminus">-</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineminus">-  DuplicateHandle: [</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineminus">-    win32.HANDLE, /* hSourceProcessHandle */</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-    win32.HANDLE, /* hSourceHandle */</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineminus">-    win32.HANDLE, /* hTargetProcessHandle */</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineminus">-    win32.LPHANDLE, /* out lpTargetHandle */</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineminus">-    win32.DWORD, /* dwDesiredAccess */</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineminus">-    win32.BOOL, /* bInheritHandle */</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineminus">-    win32.DWORD /* dwOptions */</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineminus">-  ],</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineminus">-</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineminus">-  FreeEnvironmentStringsW: [</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-    win32.LPCWSTR /* lpszEnvironmentBlock */</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineminus">-  ],</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-  GetCurrentProcess: [</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-    win32.HANDLE</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-  ],</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-  GetCurrentProcessId: [</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineminus">-    win32.DWORD</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineminus">-  ],</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineminus">-</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineminus">-  GetEnvironmentStringsW: [</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-    win32.LPCWSTR</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-  ],</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineminus">-  GetExitCodeProcess: [</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineminus">-    win32.HANDLE, /* hProcess */</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineminus">-    win32.LPDWORD /* lpExitCode */</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineminus">-  ],</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-  GetOverlappedResult: [</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-    win32.HANDLE, /* hFile */</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineminus">-    win32.OVERLAPPED.ptr, /* lpOverlapped */</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-    win32.LPDWORD, /* lpNumberOfBytesTransferred */</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-    win32.BOOL /* bWait */</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineminus">-  ],</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineminus">-</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineminus">-  GetStdHandle: [</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineminus">-    win32.HANDLE,</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-    win32.DWORD /* nStdHandle */</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-  ],</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineminus">-</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineminus">-  InitializeProcThreadAttributeList: [</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-    win32.LPPROC_THREAD_ATTRIBUTE_LIST, /* out opt lpAttributeList */</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineminus">-    win32.DWORD, /* dwAttributeCount */</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineminus">-    win32.DWORD, /* dwFlags */</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineminus">-    win32.PSIZE_T /* in/out lpSize */</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineminus">-  ],</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineminus">-</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineminus">-  ReadFile: [</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineminus">-    win32.HANDLE, /* hFile */</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineminus">-    win32.LPVOID, /* out lpBuffer */</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineminus">-    win32.DWORD, /* nNumberOfBytesToRead */</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineminus">-    win32.LPDWORD, /* opt out lpNumberOfBytesRead */</span>
<a href="#l20.418"></a><span id="l20.418" class="difflineminus">-    win32.OVERLAPPED.ptr /* opt in/out lpOverlapped */</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineminus">-  ],</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineminus">-  ReleaseSemaphore: [</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineminus">-    win32.HANDLE, /* hSemaphore */</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineminus">-    win32.LONG, /* lReleaseCount */</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineminus">-    win32.LONG.ptr /* opt out lpPreviousCount */</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineminus">-  ],</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineminus">-</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineminus">-  ResumeThread: [</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineminus">-    win32.DWORD,</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineminus">-    win32.HANDLE /* hThread */</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineminus">-  ],</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineminus">-</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineminus">-  SetInformationJobObject: [</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-    win32.HANDLE, /* hJob */</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineminus">-    ctypes.int, /* JobObjectInfoClass */</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineminus">-    win32.LPVOID, /* lpJobObjectInfo */</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineminus">-    win32.DWORD /* cbJobObjectInfoLengt */</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineminus">-  ],</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineminus">-</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineminus">-  TerminateJobObject: [</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineminus">-    win32.HANDLE, /* hJob */</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineminus">-    win32.UINT /* uExitCode */</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineminus">-  ],</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineminus">-</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineminus">-  TerminateProcess: [</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineminus">-    win32.HANDLE, /* hProcess */</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineminus">-    win32.UINT /* uExitCode */</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineminus">-  ],</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineminus">-</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineminus">-  UpdateProcThreadAttribute: [</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineminus">-    win32.LPPROC_THREAD_ATTRIBUTE_LIST, /* in/out lpAttributeList */</span>
<a href="#l20.462"></a><span id="l20.462" class="difflineminus">-    win32.DWORD, /* dwFlags */</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineminus">-    win32.DWORD_PTR, /* Attribute */</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineminus">-    win32.PVOID, /* lpValue */</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-    win32.SIZE_T, /* cbSize */</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-    win32.PVOID, /* out opt lpPreviousValue */</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineminus">-    win32.PSIZE_T /* opt lpReturnSize */</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineminus">-  ],</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineminus">-</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineminus">-  WaitForMultipleObjects: [</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineminus">-    win32.DWORD,</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineminus">-    win32.DWORD, /* nCount */</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineminus">-    win32.HANDLE.ptr, /* hHandles */</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineminus">-    win32.BOOL, /* bWaitAll */</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineminus">-    win32.DWORD /* dwMilliseconds */</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineminus">-  ],</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineminus">-</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineminus">-  WaitForSingleObject: [</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineminus">-    win32.DWORD,</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineminus">-    win32.HANDLE, /* hHandle */</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineminus">-    win32.BOOL, /* bWaitAll */</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineminus">-    win32.DWORD /* dwMilliseconds */</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineminus">-  ],</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineminus">-</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineminus">-  WriteFile: [</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineminus">-    win32.HANDLE, /* hFile */</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineminus">-    win32.LPCVOID, /* lpBuffer */</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineminus">-    win32.DWORD, /* nNumberOfBytesToRead */</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineminus">-    win32.LPDWORD, /* opt out lpNumberOfBytesWritten */</span>
<a href="#l20.494"></a><span id="l20.494" class="difflineminus">-    win32.OVERLAPPED.ptr /* opt in/out lpOverlapped */</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineminus">-  ]</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineminus">-});</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineminus">-</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineminus">-var user32 = new Library(&quot;user32&quot;, [&quot;user32.dll&quot;], {</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineminus">-  AllowSetForegroundWindow: [</span>
<a href="#l20.500"></a><span id="l20.500" class="difflineminus">-    win32.WINAPI,</span>
<a href="#l20.501"></a><span id="l20.501" class="difflineminus">-    win32.BOOL,</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineminus">-    win32.DWORD /* dwProcessId */</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineminus">-  ]</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineminus">-});</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineminus">-</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-let nextNamedPipeId = 0;</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineminus">-</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineminus">-win32.Handle = function(handle) {</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineminus">-  return ctypes.CDataFinalizer(win32.HANDLE(handle), libc.CloseHandle);</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineminus">-};</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-win32.createPipe = function(secAttr, readFlags = 0, writeFlags = 0, size = 0) {</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-  readFlags |= win32.PIPE_ACCESS_INBOUND;</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineminus">-  writeFlags |= Win.FILE_ATTRIBUTE_NORMAL;</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineminus">-</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineminus">-  if (size == 0) {</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineminus">-    size = 4096;</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineminus">-  }</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineminus">-</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineminus">-  let pid = libc.GetCurrentProcessId();</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineminus">-  const pipePrefix = &quot;\\\\.\\Pipe\\SubProcessPipe&quot;;</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineminus">-  let pipeName = String.raw `${pipePrefix}.${pid}.${nextNamedPipeId++}`;</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineminus">-</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineminus">-  let readHandle = libc.CreateNamedPipeW(</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineminus">-    pipeName, readFlags,</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineminus">-    win32.PIPE_TYPE_BYTE | win32.PIPE_WAIT,</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineminus">-    1, /* number of connections */</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineminus">-    size, /* output buffer size */</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineminus">-    size, /* input buffer size */</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineminus">-    0, /* timeout */</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineminus">-    secAttr.address());</span>
<a href="#l20.532"></a><span id="l20.532" class="difflineminus">-</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineminus">-  let isInvalid = handle =&gt; String(handle) == String(win32.HANDLE(Win.INVALID_HANDLE_VALUE));</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-  if (isInvalid(readHandle)) {</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-    return [];</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineminus">-  }</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineminus">-</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-  let writeHandle = libc.CreateFileW(</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-    pipeName, Win.GENERIC_WRITE, 0, secAttr.address(),</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineminus">-    Win.OPEN_EXISTING, writeFlags, null);</span>
<a href="#l20.542"></a><span id="l20.542" class="difflineminus">-</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineminus">-  if (isInvalid(writeHandle)) {</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineminus">-    libc.CloseHandle(readHandle);</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineminus">-    return [];</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineminus">-  }</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineminus">-</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineminus">-  return [win32.Handle(readHandle),</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineminus">-    win32.Handle(writeHandle)</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineminus">-  ];</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineminus">-};</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineminus">-</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineminus">-win32.createThreadAttributeList = function(handles) {</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineminus">-  try {</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineminus">-    void libc.InitializeProcThreadAttributeList;</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineminus">-    void libc.DeleteProcThreadAttributeList;</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineminus">-    void libc.UpdateProcThreadAttribute;</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineminus">-  } catch (e) {</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineminus">-    // This is only supported in Windows Vista and later.</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineminus">-    return null;</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineminus">-  }</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineminus">-</span>
<a href="#l20.563"></a><span id="l20.563" class="difflineminus">-  let size = win32.SIZE_T();</span>
<a href="#l20.564"></a><span id="l20.564" class="difflineminus">-  if (!libc.InitializeProcThreadAttributeList(null, 1, 0, size.address()) &amp;&amp;</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineminus">-    ctypes.winLastError != win32.ERROR_INSUFFICIENT_BUFFER) {</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineminus">-    return null;</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineminus">-  }</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineminus">-</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineminus">-  let attrList = win32.PROC_THREAD_ATTRIBUTE_LIST(size.value);</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineminus">-</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineminus">-  if (!libc.InitializeProcThreadAttributeList(attrList, 1, 0, size.address())) {</span>
<a href="#l20.572"></a><span id="l20.572" class="difflineminus">-    return null;</span>
<a href="#l20.573"></a><span id="l20.573" class="difflineminus">-  }</span>
<a href="#l20.574"></a><span id="l20.574" class="difflineminus">-</span>
<a href="#l20.575"></a><span id="l20.575" class="difflineminus">-  let ok = libc.UpdateProcThreadAttribute(</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineminus">-    attrList, 0, win32.PROC_THREAD_ATTRIBUTE_HANDLE_LIST,</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-    handles, handles.constructor.size, null, null);</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineminus">-</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineminus">-  if (!ok) {</span>
<a href="#l20.580"></a><span id="l20.580" class="difflineminus">-    libc.DeleteProcThreadAttributeList(attrList);</span>
<a href="#l20.581"></a><span id="l20.581" class="difflineminus">-    return null;</span>
<a href="#l20.582"></a><span id="l20.582" class="difflineminus">-  }</span>
<a href="#l20.583"></a><span id="l20.583" class="difflineminus">-</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-  return attrList;</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_unix.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,209 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-/* exported SubprocessImpl */</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-/* globals BaseProcess, PromiseWorker */</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-/* global libc: false, LIBC: false */</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-var {</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-  results: Cr</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-} = Components;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SubprocessImpl&quot;];</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-Components.utils.importGlobalProperties([&quot;TextDecoder&quot;]);</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-const ctypes = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;).ctypes;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-const OS = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;).OS;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-const Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-var {</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  SubprocessConstants,</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  BaseProcess,</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-  PromiseWorker</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-} = ChromeUtils.import(&quot;chrome://openpgp/content/modules/enigmailprocess_common.jsm&quot;, this);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;chrome://openpgp/content/modules/enigmailprocess_shared.js&quot;, this);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;chrome://openpgp/content/modules/enigmailprocess_shared_unix.js&quot;, this);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-class UnixPromiseWorker extends PromiseWorker {</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  constructor(...args) {</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-    super(...args);</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-    let fds = ctypes.int.array(2)();</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-    let res = libc.pipe(fds);</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-    if (res == -1) {</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-      throw new Error(&quot;Unable to create pipe&quot;);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-    }</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-    this.signalFd = fds[1];</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-    libc.fcntl(fds[0], LIBC.F_SETFL, LIBC.O_NONBLOCK);</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-    libc.fcntl(fds[0], LIBC.F_SETFD, LIBC.FD_CLOEXEC);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-    libc.fcntl(fds[1], LIBC.F_SETFD, LIBC.FD_CLOEXEC);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-    this.call(&quot;init&quot;, [{</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-      signalFd: fds[0]</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-    }]);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  }</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  closePipe() {</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-    if (this.signalFd) {</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-      libc.close(this.signalFd);</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-      this.signalFd = null;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-    }</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  }</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  onClose() {</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-    this.closePipe();</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-    super.onClose();</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-  }</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  signalWorker() {</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-    libc.write(this.signalFd, new ArrayBuffer(1), 1);</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  }</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-  postMessage(...args) {</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-    this.signalWorker();</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-    return super.postMessage(...args);</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-  }</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-}</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-class Process extends BaseProcess {</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-  static get WORKER_URL() {</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-    return &quot;chrome://openpgp/content/modules/enigmailprocess_worker_unix.js&quot;;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-  }</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-  static get WorkerClass() {</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-    return UnixPromiseWorker;</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-  }</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-}</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-// Convert a null-terminated char pointer into a sized char array, and then</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-// convert that into a JS typed array.</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-// The resulting array will not be null-terminated.</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-function ptrToUint8Array(input) {</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-  let {</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-    cast,</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-    uint8_t</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-  } = ctypes;</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-  let len = 0;</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-  for (let ptr = cast(input, uint8_t.ptr); ptr.contents; ptr = ptr.increment()) {</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-    len++;</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-  }</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-  let aryPtr = cast(input, uint8_t.array(len).ptr);</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-  return new Uint8Array(aryPtr.contents);</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-}</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-var SubprocessUnix = {</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-  Process,</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-  call(options) {</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-    return Process.create(options);</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-  },</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-  * getEnvironment() {</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-    let environ;</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-    if (OS.Constants.Sys.Name == &quot;Darwin&quot;) {</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-      environ = libc._NSGetEnviron().contents;</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineminus">-    } else {</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-      environ = libc.environ;</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineminus">-    }</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineminus">-</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-    const EQUAL = &quot;=&quot;.charCodeAt(0);</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-    let decoder = new TextDecoder(&quot;utf-8&quot;, {</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-      fatal: true</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-    });</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-    function decode(array) {</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineminus">-      try {</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineminus">-        return decoder.decode(array);</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineminus">-      } catch (e) {</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineminus">-        return array;</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-      }</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-    }</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-    for (let envp = environ; !envp.contents.isNull(); envp = envp.increment()) {</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineminus">-      let buf = ptrToUint8Array(envp.contents);</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineminus">-</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-      for (let i = 0; i &lt; buf.length; i++) {</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-        if (buf[i] == EQUAL) {</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-          yield [decode(buf.subarray(0, i)),</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-            decode(buf.subarray(i + 1))</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-          ];</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-          break;</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-        }</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineminus">-      }</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineminus">-    }</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-  },</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineminus">-  async isExecutableFile(path) {</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineminus">-    if (!OS.Path.split(path).absolute) {</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineminus">-      return false;</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-    }</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-    try {</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-      let info = await OS.File.stat(path);</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineminus">-</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-      // FIXME: We really want access(path, X_OK) here, but OS.File does not</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-      // support it.</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-      return !info.isDir &amp;&amp; (info.unixMode &amp; 0x49);</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-    } catch (e) {</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-      return false;</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-    }</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineminus">-  },</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineminus">-</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-  /**</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-   * Searches for the given executable file in the system executable</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-   * file paths as specified by the PATH environment variable.</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-   *</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineminus">-   * On Windows, if the unadorned filename cannot be found, the</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-   * extensions in the semicolon-separated list in the PATHEXT</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-   * environment variable are successively appended to the original</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineminus">-   * name and searched for in turn.</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-   *</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-   * @param {string} bin</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-   *        The name of the executable to find.</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-   * @param {object} environment</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-   *        An object containing a key for each environment variable to be used</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineminus">-   *        in the search.</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-   * @returns {Promise&lt;string&gt;}</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineminus">-   */</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-  async pathSearch(bin, environment) {</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-    let split = OS.Path.split(bin);</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-    if (split.absolute) {</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-      if (await this.isExecutableFile(bin)) {</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineminus">-        return bin;</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineminus">-      }</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-      let error = new Error(`File at path &quot;${bin}&quot; does not exist, or is not executable`);</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineminus">-      error.errorCode = SubprocessConstants.ERROR_BAD_EXECUTABLE;</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineminus">-      throw error;</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineminus">-    }</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineminus">-</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-    let dirs = [];</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineminus">-    if (typeof environment.PATH === &quot;string&quot;) {</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineminus">-      dirs = environment.PATH.split(&quot;:&quot;);</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineminus">-    }</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineminus">-    for (let dir of dirs) {</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineminus">-      let path = OS.Path.join(dir, bin);</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineminus">-</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineminus">-      if (await this.isExecutableFile(path)) {</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineminus">-        return path;</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineminus">-      }</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineminus">-    }</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineminus">-    let error = new Error(`Executable not found: ${bin}`);</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineminus">-    error.errorCode = SubprocessConstants.ERROR_BAD_EXECUTABLE;</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-    throw error;</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-  }</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-};</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-var SubprocessImpl = SubprocessUnix;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_win.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,176 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-/* exported SubprocessImpl */</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-/* global libc: false */</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-/* globals BaseProcess, PromiseWorker */</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-var {</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-  results: Cr</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-} = Components;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SubprocessImpl&quot;];</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-const AppConstants = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;).AppConstants;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-const ctypes = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;).ctypes;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-const OS = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;).OS;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-const Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-const XPCOMUtils = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;).XPCOMUtils;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-var {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  SubprocessConstants,</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-  BaseProcess,</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  PromiseWorker</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-} = ChromeUtils.import(&quot;chrome://openpgp/content/modules/enigmailprocess_common.jsm&quot;, this);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;env&quot;, &quot;@mozilla.org/process/environment;1&quot;,</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  &quot;nsIEnvironment&quot;); /* global env: false */</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;chrome://openpgp/content/modules/enigmailprocess_shared.js&quot;, this);</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-Services.scriptloader.loadSubScript(&quot;chrome://openpgp/content/modules/enigmailprocess_shared_win.js&quot;, this);</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-class WinPromiseWorker extends PromiseWorker {</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-  constructor(...args) {</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-    super(...args);</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    this.signalEvent = libc.CreateSemaphoreW(null, 0, 32, null);</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-    this.call(&quot;init&quot;, [{</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-      breakAwayFromJob: !AppConstants.isPlatformAndVersionAtLeast(&quot;win&quot;, &quot;6.2&quot;),</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-      comspec: env.get(&quot;COMSPEC&quot;),</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-      signalEvent: String(ctypes.cast(this.signalEvent, ctypes.uintptr_t).value)</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-    }]);</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-  }</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-  signalWorker() {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    libc.ReleaseSemaphore(this.signalEvent, 1, null);</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  }</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-  postMessage(...args) {</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-    this.signalWorker();</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-    return super.postMessage(...args);</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-  }</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-}</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-class Process extends BaseProcess {</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-  static get WORKER_URL() {</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-    return &quot;chrome://openpgp/content/modules/enigmailprocess_worker_win.js&quot;;</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-  }</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-  static get WorkerClass() {</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-    return WinPromiseWorker;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-  }</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-}</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-var SubprocessWin = {</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-  Process,</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-  call(options) {</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-      return Process.create(options);</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-    },</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-    * getEnvironment() {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-      let env = libc.GetEnvironmentStringsW();</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-      try {</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-        for (let p = env, q = env;; p = p.increment()) {</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-          if (p.contents == &quot;\0&quot;) {</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-            if (String(p) == String(q)) {</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-              break;</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-            }</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-            let str = q.readString();</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-            q = p.increment();</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-            let idx = str.indexOf(&quot;=&quot;);</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-            if (idx == 0) {</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-              idx = str.indexOf(&quot;=&quot;, 1);</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-            }</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-            if (idx &gt;= 0) {</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-              yield [str.slice(0, idx), str.slice(idx + 1)];</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-            }</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-          }</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-        }</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-      }</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-      finally {</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-        libc.FreeEnvironmentStringsW(env);</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-      }</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-    },</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-    async isExecutableFile(path) {</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-      if (!OS.Path.split(path).absolute) {</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-        return false;</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-      }</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-      try {</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-        let info = await OS.File.stat(path);</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-        return !(info.isDir || info.isSymlink);</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-      }</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-      catch (e) {</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-        return false;</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-      }</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-    },</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-    /**</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-     * Searches for the given executable file in the system executable</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-     * file paths as specified by the PATH environment variable.</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-     *</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-     * On Windows, if the unadorned filename cannot be found, the</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-     * extensions in the semicolon-separated list in the PATHEXT</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-     * environment variable are successively appended to the original</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-     * name and searched for in turn.</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-     *</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-     * @param {string} bin</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-     *        The name of the executable to find.</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-     * @param {object} environment</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-     *        An object containing a key for each environment variable to be used</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-     *        in the search.</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-     * @returns {Promise&lt;string&gt;}</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-     */</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-    async pathSearch(bin, environment) {</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-      let split = OS.Path.split(bin);</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-      if (split.absolute) {</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-        if (await this.isExecutableFile(bin)) {</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-          return bin;</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-        }</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-        let error = new Error(`File at path &quot;${bin}&quot; does not exist, or is not a normal file`);</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-        error.errorCode = SubprocessConstants.ERROR_BAD_EXECUTABLE;</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-        throw error;</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-      }</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-      let dirs = [];</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-      let exts = [];</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineminus">-      if (environment.PATH) {</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-        dirs = environment.PATH.split(&quot;;&quot;);</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-      }</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-      if (environment.PATHEXT) {</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-        exts = environment.PATHEXT.split(&quot;;&quot;);</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-      }</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-      for (let dir of dirs) {</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-        let path = OS.Path.join(dir, bin);</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-        if (await this.isExecutableFile(path)) {</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-          return path;</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-        }</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineminus">-        for (let ext of exts) {</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-          let file = path + ext;</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-          if (await this.isExecutableFile(file)) {</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-            return file;</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-          }</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-        }</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineminus">-      }</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-      let error = new Error(`Executable not found: ${bin}`);</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-      error.errorCode = SubprocessConstants.ERROR_BAD_EXECUTABLE;</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineminus">-      throw error;</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-    }</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-};</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-var SubprocessImpl = SubprocessWin;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_worker_common.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,269 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-/* exported BasePipe, BaseProcess, debug */</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-/* globals Process, io */</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-/* global ctypes: false */</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-/* eslint no-console: 0 */</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-function debug(message) {</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-  self.postMessage({</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-    msg: &quot;debug&quot;,</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-    message</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-  });</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-}</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-class BasePipe {</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-  constructor() {</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-    this.closing = false;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-    this.closed = false;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    this.closedPromise = new Promise(resolve =&gt; {</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-      this.resolveClosed = resolve;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-    });</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    this.pending = [];</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-  }</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-  shiftPending() {</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-    let result = this.pending.shift();</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-    if (this.closing &amp;&amp; this.pending.length == 0) {</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-      this.close();</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    }</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-    return result;</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-  }</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-}</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-let nextProcessId = 0;</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-class BaseProcess {</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-  constructor(options) {</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-    this.id = nextProcessId++;</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-    this.exitCode = null;</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-    this.exitPromise = new Promise(resolve =&gt; {</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-      this.resolveExit = resolve;</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-    });</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-    this.exitPromise.then(() =&gt; {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-      // The input file descriptors will be closed after poll</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-      // reports that their input buffers are empty. If we close</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-      // them now, we may lose output.</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-      this.pipes[0].close(true);</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-    });</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-    this.pid = null;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-    this.pipes = [];</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-    this.stringArrays = [];</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-    this.spawn(options);</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-  }</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-  /**</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-   * Waits for the process to exit and all of its pending IO operations to</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-   * complete.</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-   *</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-   * @returns {Promise&lt;void&gt;}</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-   */</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-  awaitFinished() {</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-    return Promise.all([</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-      this.exitPromise,</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-      ...this.pipes.map(pipe =&gt; pipe.closedPromise)</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-    ]);</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-  }</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-  /**</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-   * Creates a null-terminated array of pointers to null-terminated C-strings,</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-   * and returns it.</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-   *</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-   * @param {string[]} strings</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-   *        The strings to convert into a C string array.</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-   *</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-   * @returns {ctypes.char.ptr.array}</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-   */</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-  stringArray(strings) {</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-    let result = ctypes.char.ptr.array(strings.length + 1)();</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-    let cstrings = strings.map(str =&gt; ctypes.char.array()(str));</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-    for (let [i, cstring] of cstrings.entries()) {</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-      result[i] = cstring;</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-    }</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-    // Char arrays used in char arg and environment vectors must be</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-    // explicitly kept alive in a JS object, or they will be reaped</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-    // by the GC if it runs before our process is started.</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-    this.stringArrays.push(cstrings);</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-    return result;</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-  }</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-}</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-let requests = {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-  init(details) {</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-    io.init(details);</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-    return {</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-      data: {}</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-    };</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-  },</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-  shutdown() {</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-    io.shutdown();</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineminus">-</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-    return {</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-      data: {}</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-    };</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-  },</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-  close(pipeId, force = false) {</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-    let pipe = io.getPipe(pipeId);</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-    return pipe.close(force).then(() =&gt; ({</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-      data: {}</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-    }));</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-  },</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-  spawn(options) {</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-    let process = new Process(options);</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-    let processId = process.id;</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-    io.addProcess(process);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-    let fds = process.pipes.map(pipe =&gt; pipe.id);</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineminus">-</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-    return {</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-      data: {</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-        processId,</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-        fds,</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-        pid: process.pid</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-      }</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-    };</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-  },</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-  kill(processId, force = false) {</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-    let process = io.getProcess(processId);</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-    process.kill(force ? 9 : 15);</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-    return {</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-      data: {}</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-    };</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-  },</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-  wait(processId) {</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-    let process = io.getProcess(processId);</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-    process.wait();</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-    process.awaitFinished().then(() =&gt; {</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-      io.cleanupProcess(process);</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-    });</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-    return process.exitPromise.then(exitCode =&gt; {</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-      return {</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-        data: {</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-          exitCode</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-        }</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-      };</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-    });</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-  },</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-  read(pipeId, count) {</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-    let pipe = io.getPipe(pipeId);</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-    return pipe.read(count).then(buffer =&gt; {</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-      return {</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-        data: {</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-          buffer</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-        }</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-      };</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-    });</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-  },</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-  write(pipeId, buffer) {</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-    let pipe = io.getPipe(pipeId);</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-    return pipe.write(buffer).then(bytesWritten =&gt; {</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-      return {</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-        data: {</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-          bytesWritten</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineminus">-        }</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineminus">-      };</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineminus">-    });</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineminus">-  },</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-  getOpenFiles() {</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-    return {</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-      data: new Set(io.pipes.keys())</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-    };</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-  },</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-  getProcesses() {</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineminus">-    let data = new Map(Array.from(io.processes.values())</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-      .filter(proc =&gt; proc.exitCode === null)</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineminus">-      .map(proc =&gt; [proc.id, proc.pid]));</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-    return {</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineminus">-      data</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-    };</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-  },</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineminus">-  waitForNoProcesses() {</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineminus">-    return Promise.all(Array.from(io.processes.values(),</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-      proc =&gt; proc.awaitFinished()));</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineminus">-  }</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-};</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineminus">-</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineminus">-onmessage = event =&gt; {</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-  io.messageCount--;</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-  let {</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-    msg,</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-    msgId,</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-    args</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-  } = event.data;</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-  new Promise(resolve =&gt; {</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-    resolve(requests[msg](...args));</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-  }).then(result =&gt; {</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-    let response = {</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-      msg: &quot;success&quot;,</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-      msgId,</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-      data: result.data</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-    };</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineminus">-</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-    self.postMessage(response, result.transfer || []);</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-  }).catch(error =&gt; {</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-    if (error instanceof Error) {</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-      error = {</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-        message: error.message,</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-        fileName: error.fileName,</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-        lineNumber: error.lineNumber,</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-        column: error.column,</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-        stack: error.stack,</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-        errorCode: error.errorCode</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-      };</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-    }</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-    self.postMessage({</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-      msg: &quot;failure&quot;,</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-      msgId,</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-      error</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineminus">-    });</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-  }).catch(error =&gt; {</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-    console.error(error);</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineminus">-    self.postMessage({</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-      msg: &quot;failure&quot;,</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineminus">-      msgId,</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineminus">-      error: {}</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineminus">-    });</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineminus">-  });</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineminus">-};</span>
<a href="#l23.274"></a><span id="l23.274">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_worker_unix.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ /dev/null</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -1,650 +0,0 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-/* exported Process */</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-/* globals BaseProcess, BasePipe */</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-/* global importScripts: false */</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-importScripts(&quot;chrome://openpgp/content/modules/enigmailprocess_shared.js&quot;,</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-  &quot;chrome://openpgp/content/modules/enigmailprocess_shared_unix.js&quot;,</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-  &quot;chrome://openpgp/content/modules/enigmailprocess_worker_common.js&quot;);</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-/* global ctypes: false, LIBC: false, libc: false, unix: false, SubprocessConstants: false */</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-/* global debug: false */</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-/* eslint no-console: 0 */</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-const POLL_TIMEOUT = 5000;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-let io;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-let nextPipeId = 0;</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-class Pipe extends BasePipe {</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  constructor(process, fd) {</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    super();</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-    this.process = process;</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-    this.fd = fd;</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    this.id = nextPipeId++;</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  }</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-  get pollEvents() {</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-  }</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-  /**</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-   * Closes the file descriptor.</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-   *</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-   * @param {boolean} [force=false]</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-   *        If true, the file descriptor is closed immediately. If false, the</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-   *        file descriptor is closed after all current pending IO operations</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-   *        have completed.</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-   *</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-   * @returns {Promise&lt;void&gt;}</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-   *          Resolves when the file descriptor has been closed.</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-   */</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-  close(force = false) {</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-    if (!force &amp;&amp; this.pending.length) {</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-      this.closing = true;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-      return this.closedPromise;</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-    }</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    for (let {</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-        reject</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-      }</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-      of this.pending) {</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-      let error = new Error(&quot;File closed&quot;);</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-      error.errorCode = SubprocessConstants.ERROR_END_OF_FILE;</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-      reject(error);</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-    }</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    this.pending.length = 0;</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    if (!this.closed) {</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-      this.fd.dispose();</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-      this.closed = true;</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-      this.resolveClosed();</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-      io.pipes.delete(this.id);</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-      io.updatePollFds();</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-    }</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-    return this.closedPromise;</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-  }</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-  /**</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-   * Called when an error occurred while polling our file descriptor.</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-   */</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-  onError() {</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-    this.close(true);</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-    this.process.wait();</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-  }</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-}</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-class InputPipe extends Pipe {</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-  /**</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-   * A bit mask of poll() events which we currently wish to be notified of on</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-   * this file descriptor.</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-   */</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-  get pollEvents() {</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-    if (this.pending.length) {</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-      return LIBC.POLLIN;</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-    }</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-    return 0;</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-  }</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-  /**</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-   * Asynchronously reads at most `length` bytes of binary data from the file</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-   * descriptor into an ArrayBuffer of the same size. Returns a promise which</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-   * resolves when the operation is complete.</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-   *</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-   * @param {integer} length</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-   *</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-   * @returns {Promise&lt;ArrayBuffer&gt;}</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-   */</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-  read(length) {</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-    if (this.closing || this.closed) {</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-      throw new Error(&quot;Attempt to read from closed pipe&quot;);</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-    }</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-      this.pending.push({</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-        resolve, reject, length</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-      });</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-      io.updatePollFds();</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-    });</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-  }</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-  /**</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-   * Synchronously reads at most `count` bytes of binary data into an</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-   * ArrayBuffer, and returns that buffer. If no data can be read without</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-   * blocking, returns null instead.</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-   *</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-   * @param {integer} count</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-   *</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-   * @returns {ArrayBuffer|null}</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-   */</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-  readBuffer(count) {</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-    let buffer = new ArrayBuffer(count);</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-    let read = Number(libc.read(this.fd, buffer, buffer.byteLength));</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-    if (read &lt; 0 &amp;&amp; ctypes.errno != LIBC.EAGAIN) {</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-      this.onError();</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-    }</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-    if (read &lt;= 0) {</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-      return null;</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-    }</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-    if (read &lt; buffer.byteLength) {</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-      return ArrayBuffer.transfer(buffer, read);</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-    }</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-    return buffer;</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-  }</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-  /**</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-   * Called when one of the IO operations matching the `pollEvents` mask may be</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-   * performed without blocking.</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-   *</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-   * @returns {boolean}</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-   *        True if any data was successfully read.</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-   */</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-  onReady() {</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-    let result = false;</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-    let reads = this.pending;</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-    while (reads.length) {</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-      let {</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-        resolve, length</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-      } = reads[0];</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-      let buffer = this.readBuffer(length);</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-      if (buffer) {</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-        result = true;</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-        this.shiftPending();</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-        resolve(buffer);</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-      }</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-      else {</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-        break;</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-      }</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-    }</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-    if (reads.length == 0) {</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-      io.updatePollFds();</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-    }</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-    return result;</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-  }</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-}</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineminus">-</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">-class OutputPipe extends Pipe {</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">-  /**</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">-   * A bit mask of poll() events which we currently wish to be notified of on</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineminus">-   * this file discriptor.</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-   */</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineminus">-  get pollEvents() {</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-    if (this.pending.length) {</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-      return LIBC.POLLOUT;</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-    }</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-    return 0;</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-  }</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-  /**</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-   * Asynchronously writes the given buffer to our file descriptor, and returns</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-   * a promise which resolves when the operation is complete.</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-   *</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-   * @param {ArrayBuffer} buffer</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineminus">-   *        The buffer to write.</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-   *</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-   * @returns {Promise&lt;integer&gt;}</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineminus">-   *          Resolves to the number of bytes written when the operation is</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-   *          complete.</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-   */</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineminus">-  write(buffer) {</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-    if (this.closing || this.closed) {</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineminus">-      throw new Error(&quot;Attempt to write to closed pipe&quot;);</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineminus">-    }</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">-</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-      this.pending.push({</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-        resolve, reject, buffer, length: buffer.byteLength</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-      });</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-      io.updatePollFds();</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-    });</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-  }</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineminus">-  /**</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-   * Attempts to synchronously write the given buffer to our file descriptor.</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-   * Writes only as many bytes as can be written without blocking, and returns</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineminus">-   * the number of byes successfully written.</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-   *</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-   * Closes the file descriptor if an IO error occurs.</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineminus">-   *</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-   * @param {ArrayBuffer} buffer</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-   *        The buffer to write.</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-   *</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-   * @returns {integer}</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-   *          The number of bytes successfully written.</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-   */</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-  writeBuffer(buffer) {</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-    let bytesWritten = libc.write(this.fd, buffer, buffer.byteLength);</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-    if (bytesWritten &lt; 0 &amp;&amp; ctypes.errno != LIBC.EAGAIN) {</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">-      this.onError();</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-    }</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineminus">-    return bytesWritten;</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineminus">-  }</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineminus">-</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineminus">-  /**</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-   * Called when one of the IO operations matching the `pollEvents` mask may be</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-   * performed without blocking.</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineminus">-   */</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineminus">-  onReady() {</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineminus">-    let writes = this.pending;</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineminus">-    while (writes.length) {</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineminus">-      let {</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-        buffer, resolve, length</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-      } = writes[0];</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineminus">-      let written = this.writeBuffer(buffer);</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineminus">-</span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-      if (written == buffer.byteLength) {</span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-        resolve(length);</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineminus">-        this.shiftPending();</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineminus">-      }</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineminus">-      else if (written &gt; 0) {</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineminus">-        writes[0].buffer = buffer.slice(written);</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineminus">-      }</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-      else {</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-        break;</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-      }</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-    }</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-    if (writes.length == 0) {</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineminus">-      io.updatePollFds();</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-    }</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-  }</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineminus">-}</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineminus">-</span>
<a href="#l24.279"></a><span id="l24.279" class="difflineminus">-class Signal {</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineminus">-  constructor(fd) {</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-    this.fd = fd;</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineminus">-  }</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineminus">-</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-  cleanup() {</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineminus">-    libc.close(this.fd);</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineminus">-    this.fd = null;</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineminus">-  }</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineminus">-</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-  get pollEvents() {</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineminus">-    return LIBC.POLLIN;</span>
<a href="#l24.291"></a><span id="l24.291" class="difflineminus">-  }</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineminus">-  /**</span>
<a href="#l24.294"></a><span id="l24.294" class="difflineminus">-   * Called when an error occurred while polling our file descriptor.</span>
<a href="#l24.295"></a><span id="l24.295" class="difflineminus">-   */</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineminus">-  onError() {</span>
<a href="#l24.297"></a><span id="l24.297" class="difflineminus">-    io.shutdown();</span>
<a href="#l24.298"></a><span id="l24.298" class="difflineminus">-  }</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-  /**</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineminus">-   * Called when one of the IO operations matching the `pollEvents` mask may be</span>
<a href="#l24.302"></a><span id="l24.302" class="difflineminus">-   * performed without blocking.</span>
<a href="#l24.303"></a><span id="l24.303" class="difflineminus">-   */</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineminus">-  onReady() {</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-    let buffer = new ArrayBuffer(16);</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-    let count = Number(libc.read(this.fd, buffer, buffer.byteLength));</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineminus">-    if (count &gt; 0) {</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-      io.messageCount += count;</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineminus">-    }</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineminus">-  }</span>
<a href="#l24.311"></a><span id="l24.311" class="difflineminus">-}</span>
<a href="#l24.312"></a><span id="l24.312" class="difflineminus">-</span>
<a href="#l24.313"></a><span id="l24.313" class="difflineminus">-class Process extends BaseProcess {</span>
<a href="#l24.314"></a><span id="l24.314" class="difflineminus">-  /**</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-   * Each Process object opens an additional pipe from the target object, which</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-   * will be automatically closed when the process exits, but otherwise</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineminus">-   * carries no data.</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-   *</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-   * This property contains a bit mask of poll() events which we wish to be</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineminus">-   * notified of on this descriptor. We're not expecting any input from this</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineminus">-   * pipe, but we need to poll for input until the process exits in order to be</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineminus">-   * notified when the pipe closes.</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineminus">-   */</span>
<a href="#l24.324"></a><span id="l24.324" class="difflineminus">-  get pollEvents() {</span>
<a href="#l24.325"></a><span id="l24.325" class="difflineminus">-    if (this.exitCode === null) {</span>
<a href="#l24.326"></a><span id="l24.326" class="difflineminus">-      return LIBC.POLLIN;</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-    }</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineminus">-    return 0;</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineminus">-  }</span>
<a href="#l24.330"></a><span id="l24.330" class="difflineminus">-</span>
<a href="#l24.331"></a><span id="l24.331" class="difflineminus">-  /**</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineminus">-   * Kills the process with the given signal.</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineminus">-   *</span>
<a href="#l24.334"></a><span id="l24.334" class="difflineminus">-   * @param {integer} signal</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineminus">-   */</span>
<a href="#l24.336"></a><span id="l24.336" class="difflineminus">-  kill(signal) {</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineminus">-    libc.kill(this.pid, signal);</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineminus">-    this.wait();</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineminus">-  }</span>
<a href="#l24.340"></a><span id="l24.340" class="difflineminus">-</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">-  /**</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineminus">-   * Initializes the IO pipes for use as standard input, output, and error</span>
<a href="#l24.343"></a><span id="l24.343" class="difflineminus">-   * descriptors in the spawned process.</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineminus">-   *</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineminus">-   * @param {object} options</span>
<a href="#l24.346"></a><span id="l24.346" class="difflineminus">-   *        The Subprocess options object for this process.</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineminus">-   * @returns {unix.Fd[]}</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineminus">-   *          The array of file descriptors belonging to the spawned process.</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineminus">-   */</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineminus">-  initPipes(options) {</span>
<a href="#l24.351"></a><span id="l24.351" class="difflineminus">-    let stderr = options.stderr;</span>
<a href="#l24.352"></a><span id="l24.352" class="difflineminus">-</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineminus">-    let our_pipes = [];</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineminus">-    let their_pipes = new Map();</span>
<a href="#l24.355"></a><span id="l24.355" class="difflineminus">-</span>
<a href="#l24.356"></a><span id="l24.356" class="difflineminus">-    let pipe = (input, id) =&gt; {</span>
<a href="#l24.357"></a><span id="l24.357" class="difflineminus">-      let fds = ctypes.int.array(2)();</span>
<a href="#l24.358"></a><span id="l24.358" class="difflineminus">-</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-      let res = libc.pipe(fds);</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineminus">-      if (res == -1) {</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineminus">-        throw new Error(&quot;Unable to create pipe&quot;);</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineminus">-      }</span>
<a href="#l24.363"></a><span id="l24.363" class="difflineminus">-</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineminus">-      fds = Array.from(fds, unix.Fd);</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineminus">-</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineminus">-      if (input) {</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineminus">-        fds.reverse();</span>
<a href="#l24.368"></a><span id="l24.368" class="difflineminus">-      }</span>
<a href="#l24.369"></a><span id="l24.369" class="difflineminus">-</span>
<a href="#l24.370"></a><span id="l24.370" class="difflineminus">-      if (input) {</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineminus">-        our_pipes[id] = new InputPipe(this, fds[1]);</span>
<a href="#l24.372"></a><span id="l24.372" class="difflineminus">-      }</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineminus">-      else {</span>
<a href="#l24.374"></a><span id="l24.374" class="difflineminus">-        our_pipes[id] = new OutputPipe(this, fds[1]);</span>
<a href="#l24.375"></a><span id="l24.375" class="difflineminus">-      }</span>
<a href="#l24.376"></a><span id="l24.376" class="difflineminus">-</span>
<a href="#l24.377"></a><span id="l24.377" class="difflineminus">-      libc.fcntl(fds[0], LIBC.F_SETFD, LIBC.FD_CLOEXEC);</span>
<a href="#l24.378"></a><span id="l24.378" class="difflineminus">-      libc.fcntl(fds[1], LIBC.F_SETFD, LIBC.FD_CLOEXEC);</span>
<a href="#l24.379"></a><span id="l24.379" class="difflineminus">-      libc.fcntl(fds[1], LIBC.F_SETFL, LIBC.O_NONBLOCK);</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">-</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineminus">-      return fds[0];</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineminus">-    };</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineminus">-</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineminus">-    their_pipes.set(0, pipe(false, 0));</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineminus">-    their_pipes.set(1, pipe(true, 1));</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineminus">-</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineminus">-    if (stderr == &quot;pipe&quot;) {</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineminus">-      their_pipes.set(2, pipe(true, 2));</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineminus">-    }</span>
<a href="#l24.390"></a><span id="l24.390" class="difflineminus">-    else if (stderr == &quot;stdout&quot;) {</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineminus">-      their_pipes.set(2, their_pipes.get(1));</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineminus">-    }</span>
<a href="#l24.393"></a><span id="l24.393" class="difflineminus">-</span>
<a href="#l24.394"></a><span id="l24.394" class="difflineminus">-    // Create an additional pipe that we can use to monitor for process exit.</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineminus">-    their_pipes.set(3, pipe(true, 3));</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineminus">-    this.fd = our_pipes[3].fd;</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineminus">-    delete our_pipes[3];</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineminus">-</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineminus">-    this.pipes = our_pipes;</span>
<a href="#l24.400"></a><span id="l24.400" class="difflineminus">-</span>
<a href="#l24.401"></a><span id="l24.401" class="difflineminus">-    return their_pipes;</span>
<a href="#l24.402"></a><span id="l24.402" class="difflineminus">-  }</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineminus">-</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineminus">-  spawn(options) {</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineminus">-    let {</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineminus">-      command, arguments: args</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineminus">-    } = options;</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineminus">-</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineminus">-    let argv = this.stringArray(args);</span>
<a href="#l24.410"></a><span id="l24.410" class="difflineminus">-    let envp = this.stringArray(options.environment);</span>
<a href="#l24.411"></a><span id="l24.411" class="difflineminus">-</span>
<a href="#l24.412"></a><span id="l24.412" class="difflineminus">-    let actions = unix.posix_spawn_file_actions_t();</span>
<a href="#l24.413"></a><span id="l24.413" class="difflineminus">-    let actionsp = actions.address();</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineminus">-</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineminus">-    let fds = this.initPipes(options);</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineminus">-    let cwd;</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineminus">-    try {</span>
<a href="#l24.419"></a><span id="l24.419" class="difflineminus">-      if (options.workdir) {</span>
<a href="#l24.420"></a><span id="l24.420" class="difflineminus">-        cwd = ctypes.char.array(LIBC.PATH_MAX)();</span>
<a href="#l24.421"></a><span id="l24.421" class="difflineminus">-        libc.getcwd(cwd, cwd.length);</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineminus">-</span>
<a href="#l24.423"></a><span id="l24.423" class="difflineminus">-        if (libc.chdir(options.workdir) &lt; 0) {</span>
<a href="#l24.424"></a><span id="l24.424" class="difflineminus">-          throw new Error(`Unable to change working directory to ${options.workdir}`);</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineminus">-        }</span>
<a href="#l24.426"></a><span id="l24.426" class="difflineminus">-      }</span>
<a href="#l24.427"></a><span id="l24.427" class="difflineminus">-</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineminus">-      libc.posix_spawn_file_actions_init(actionsp);</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-      for (let [i, fd] of fds.entries()) {</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineminus">-        libc.posix_spawn_file_actions_adddup2(actionsp, fd, i);</span>
<a href="#l24.431"></a><span id="l24.431" class="difflineminus">-      }</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineminus">-      let pid = unix.pid_t();</span>
<a href="#l24.434"></a><span id="l24.434" class="difflineminus">-      let rv = libc.posix_spawn(pid.address(), command, actionsp, null, argv, envp);</span>
<a href="#l24.435"></a><span id="l24.435" class="difflineminus">-</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineminus">-      if (rv != 0) {</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineminus">-        for (let pipe of this.pipes) {</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineminus">-          pipe.close();</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineminus">-        }</span>
<a href="#l24.440"></a><span id="l24.440" class="difflineminus">-        throw new Error(`Failed to execute command &quot;${command}&quot;`);</span>
<a href="#l24.441"></a><span id="l24.441" class="difflineminus">-      }</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineminus">-</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineminus">-      this.pid = pid.value;</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineminus">-    }</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineminus">-    finally {</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineminus">-      libc.posix_spawn_file_actions_destroy(actionsp);</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineminus">-</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineminus">-      this.stringArrays.length = 0;</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineminus">-</span>
<a href="#l24.450"></a><span id="l24.450" class="difflineminus">-      if (cwd) {</span>
<a href="#l24.451"></a><span id="l24.451" class="difflineminus">-        libc.chdir(cwd);</span>
<a href="#l24.452"></a><span id="l24.452" class="difflineminus">-      }</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineminus">-      for (let fd of new Set(fds.values())) {</span>
<a href="#l24.454"></a><span id="l24.454" class="difflineminus">-        fd.dispose();</span>
<a href="#l24.455"></a><span id="l24.455" class="difflineminus">-      }</span>
<a href="#l24.456"></a><span id="l24.456" class="difflineminus">-    }</span>
<a href="#l24.457"></a><span id="l24.457" class="difflineminus">-  }</span>
<a href="#l24.458"></a><span id="l24.458" class="difflineminus">-</span>
<a href="#l24.459"></a><span id="l24.459" class="difflineminus">-  /**</span>
<a href="#l24.460"></a><span id="l24.460" class="difflineminus">-   * Called when input is available on our sentinel file descriptor.</span>
<a href="#l24.461"></a><span id="l24.461" class="difflineminus">-   *</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineminus">-   * @see pollEvents</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineminus">-   */</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineminus">-  onReady() {</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineminus">-    // We're not actually expecting any input on this pipe. If we get any, we</span>
<a href="#l24.466"></a><span id="l24.466" class="difflineminus">-    // can't poll the pipe any further without reading it.</span>
<a href="#l24.467"></a><span id="l24.467" class="difflineminus">-    if (this.wait() == undefined) {</span>
<a href="#l24.468"></a><span id="l24.468" class="difflineminus">-      this.kill(9);</span>
<a href="#l24.469"></a><span id="l24.469" class="difflineminus">-    }</span>
<a href="#l24.470"></a><span id="l24.470" class="difflineminus">-  }</span>
<a href="#l24.471"></a><span id="l24.471" class="difflineminus">-</span>
<a href="#l24.472"></a><span id="l24.472" class="difflineminus">-  /**</span>
<a href="#l24.473"></a><span id="l24.473" class="difflineminus">-   * Called when an error occurred while polling our sentinel file descriptor.</span>
<a href="#l24.474"></a><span id="l24.474" class="difflineminus">-   *</span>
<a href="#l24.475"></a><span id="l24.475" class="difflineminus">-   * @see pollEvents</span>
<a href="#l24.476"></a><span id="l24.476" class="difflineminus">-   */</span>
<a href="#l24.477"></a><span id="l24.477" class="difflineminus">-  onError() {</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineminus">-    this.wait();</span>
<a href="#l24.479"></a><span id="l24.479" class="difflineminus">-  }</span>
<a href="#l24.480"></a><span id="l24.480" class="difflineminus">-</span>
<a href="#l24.481"></a><span id="l24.481" class="difflineminus">-  /**</span>
<a href="#l24.482"></a><span id="l24.482" class="difflineminus">-   * Attempts to wait for the process's exit status, without blocking. If</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineminus">-   * successful, resolves the `exitPromise` to the process's exit value.</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineminus">-   *</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineminus">-   * @returns {integer|null}</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineminus">-   *          The process's exit status, if it has already exited.</span>
<a href="#l24.487"></a><span id="l24.487" class="difflineminus">-   */</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineminus">-  wait() {</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineminus">-    if (this.exitCode !== null) {</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineminus">-      return this.exitCode;</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineminus">-    }</span>
<a href="#l24.492"></a><span id="l24.492" class="difflineminus">-</span>
<a href="#l24.493"></a><span id="l24.493" class="difflineminus">-    let status = ctypes.int();</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineminus">-</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineminus">-    let res = libc.waitpid(this.pid, status.address(), LIBC.WNOHANG);</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineminus">-</span>
<a href="#l24.497"></a><span id="l24.497" class="difflineminus">-    const EINTR = 4; // TODO: change to LIBC.EINTR with TB 59</span>
<a href="#l24.498"></a><span id="l24.498" class="difflineminus">-</span>
<a href="#l24.499"></a><span id="l24.499" class="difflineminus">-    // If there's a failure here and we get any errno other than EINTR, it</span>
<a href="#l24.500"></a><span id="l24.500" class="difflineminus">-    // means that the process has been reaped by another thread (most likely</span>
<a href="#l24.501"></a><span id="l24.501" class="difflineminus">-    // the nspr process wait thread), and its actual exit status is not</span>
<a href="#l24.502"></a><span id="l24.502" class="difflineminus">-    // available to us. In that case, we have to assume success.</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineminus">-    if (res == 0 || (res == -1 &amp;&amp; ctypes.errno == EINTR)) {</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineminus">-      return null;</span>
<a href="#l24.505"></a><span id="l24.505" class="difflineminus">-    }</span>
<a href="#l24.506"></a><span id="l24.506" class="difflineminus">-</span>
<a href="#l24.507"></a><span id="l24.507" class="difflineminus">-    let sig = unix.WTERMSIG(status.value);</span>
<a href="#l24.508"></a><span id="l24.508" class="difflineminus">-    if (sig) {</span>
<a href="#l24.509"></a><span id="l24.509" class="difflineminus">-      this.exitCode = -sig;</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineminus">-    }</span>
<a href="#l24.511"></a><span id="l24.511" class="difflineminus">-    else {</span>
<a href="#l24.512"></a><span id="l24.512" class="difflineminus">-      this.exitCode = unix.WEXITSTATUS(status.value);</span>
<a href="#l24.513"></a><span id="l24.513" class="difflineminus">-    }</span>
<a href="#l24.514"></a><span id="l24.514" class="difflineminus">-</span>
<a href="#l24.515"></a><span id="l24.515" class="difflineminus">-    this.fd.dispose();</span>
<a href="#l24.516"></a><span id="l24.516" class="difflineminus">-    io.updatePollFds();</span>
<a href="#l24.517"></a><span id="l24.517" class="difflineminus">-    this.resolveExit(this.exitCode);</span>
<a href="#l24.518"></a><span id="l24.518" class="difflineminus">-    return this.exitCode;</span>
<a href="#l24.519"></a><span id="l24.519" class="difflineminus">-  }</span>
<a href="#l24.520"></a><span id="l24.520" class="difflineminus">-}</span>
<a href="#l24.521"></a><span id="l24.521" class="difflineminus">-</span>
<a href="#l24.522"></a><span id="l24.522" class="difflineminus">-io = {</span>
<a href="#l24.523"></a><span id="l24.523" class="difflineminus">-  pollFds: null,</span>
<a href="#l24.524"></a><span id="l24.524" class="difflineminus">-  pollHandlers: null,</span>
<a href="#l24.525"></a><span id="l24.525" class="difflineminus">-</span>
<a href="#l24.526"></a><span id="l24.526" class="difflineminus">-  pipes: new Map(),</span>
<a href="#l24.527"></a><span id="l24.527" class="difflineminus">-</span>
<a href="#l24.528"></a><span id="l24.528" class="difflineminus">-  processes: new Map(),</span>
<a href="#l24.529"></a><span id="l24.529" class="difflineminus">-</span>
<a href="#l24.530"></a><span id="l24.530" class="difflineminus">-  messageCount: 0,</span>
<a href="#l24.531"></a><span id="l24.531" class="difflineminus">-</span>
<a href="#l24.532"></a><span id="l24.532" class="difflineminus">-  running: true,</span>
<a href="#l24.533"></a><span id="l24.533" class="difflineminus">-</span>
<a href="#l24.534"></a><span id="l24.534" class="difflineminus">-  init(details) {</span>
<a href="#l24.535"></a><span id="l24.535" class="difflineminus">-    this.signal = new Signal(details.signalFd);</span>
<a href="#l24.536"></a><span id="l24.536" class="difflineminus">-    this.updatePollFds();</span>
<a href="#l24.537"></a><span id="l24.537" class="difflineminus">-</span>
<a href="#l24.538"></a><span id="l24.538" class="difflineminus">-    setTimeout(this.loop.bind(this), 0);</span>
<a href="#l24.539"></a><span id="l24.539" class="difflineminus">-  },</span>
<a href="#l24.540"></a><span id="l24.540" class="difflineminus">-</span>
<a href="#l24.541"></a><span id="l24.541" class="difflineminus">-  shutdown() {</span>
<a href="#l24.542"></a><span id="l24.542" class="difflineminus">-    if (this.running) {</span>
<a href="#l24.543"></a><span id="l24.543" class="difflineminus">-      this.running = false;</span>
<a href="#l24.544"></a><span id="l24.544" class="difflineminus">-</span>
<a href="#l24.545"></a><span id="l24.545" class="difflineminus">-      this.signal.cleanup();</span>
<a href="#l24.546"></a><span id="l24.546" class="difflineminus">-      this.signal = null;</span>
<a href="#l24.547"></a><span id="l24.547" class="difflineminus">-</span>
<a href="#l24.548"></a><span id="l24.548" class="difflineminus">-      self.postMessage({</span>
<a href="#l24.549"></a><span id="l24.549" class="difflineminus">-        msg: &quot;close&quot;</span>
<a href="#l24.550"></a><span id="l24.550" class="difflineminus">-      });</span>
<a href="#l24.551"></a><span id="l24.551" class="difflineminus">-      self.close();</span>
<a href="#l24.552"></a><span id="l24.552" class="difflineminus">-    }</span>
<a href="#l24.553"></a><span id="l24.553" class="difflineminus">-  },</span>
<a href="#l24.554"></a><span id="l24.554" class="difflineminus">-</span>
<a href="#l24.555"></a><span id="l24.555" class="difflineminus">-  getPipe(pipeId) {</span>
<a href="#l24.556"></a><span id="l24.556" class="difflineminus">-    let pipe = this.pipes.get(pipeId);</span>
<a href="#l24.557"></a><span id="l24.557" class="difflineminus">-</span>
<a href="#l24.558"></a><span id="l24.558" class="difflineminus">-    if (!pipe) {</span>
<a href="#l24.559"></a><span id="l24.559" class="difflineminus">-      let error = new Error(&quot;File closed&quot;);</span>
<a href="#l24.560"></a><span id="l24.560" class="difflineminus">-      error.errorCode = SubprocessConstants.ERROR_END_OF_FILE;</span>
<a href="#l24.561"></a><span id="l24.561" class="difflineminus">-      throw error;</span>
<a href="#l24.562"></a><span id="l24.562" class="difflineminus">-    }</span>
<a href="#l24.563"></a><span id="l24.563" class="difflineminus">-    return pipe;</span>
<a href="#l24.564"></a><span id="l24.564" class="difflineminus">-  },</span>
<a href="#l24.565"></a><span id="l24.565" class="difflineminus">-</span>
<a href="#l24.566"></a><span id="l24.566" class="difflineminus">-  getProcess(processId) {</span>
<a href="#l24.567"></a><span id="l24.567" class="difflineminus">-    let process = this.processes.get(processId);</span>
<a href="#l24.568"></a><span id="l24.568" class="difflineminus">-</span>
<a href="#l24.569"></a><span id="l24.569" class="difflineminus">-    if (!process) {</span>
<a href="#l24.570"></a><span id="l24.570" class="difflineminus">-      throw new Error(`Invalid process ID: ${processId}`);</span>
<a href="#l24.571"></a><span id="l24.571" class="difflineminus">-    }</span>
<a href="#l24.572"></a><span id="l24.572" class="difflineminus">-    return process;</span>
<a href="#l24.573"></a><span id="l24.573" class="difflineminus">-  },</span>
<a href="#l24.574"></a><span id="l24.574" class="difflineminus">-</span>
<a href="#l24.575"></a><span id="l24.575" class="difflineminus">-  updatePollFds() {</span>
<a href="#l24.576"></a><span id="l24.576" class="difflineminus">-    let handlers = [this.signal,</span>
<a href="#l24.577"></a><span id="l24.577" class="difflineminus">-      ...this.pipes.values(),</span>
<a href="#l24.578"></a><span id="l24.578" class="difflineminus">-      ...this.processes.values()</span>
<a href="#l24.579"></a><span id="l24.579" class="difflineminus">-    ];</span>
<a href="#l24.580"></a><span id="l24.580" class="difflineminus">-</span>
<a href="#l24.581"></a><span id="l24.581" class="difflineminus">-    handlers = handlers.filter(handler =&gt; handler.pollEvents);</span>
<a href="#l24.582"></a><span id="l24.582" class="difflineminus">-</span>
<a href="#l24.583"></a><span id="l24.583" class="difflineminus">-    let pollfds = unix.pollfd.array(handlers.length)();</span>
<a href="#l24.584"></a><span id="l24.584" class="difflineminus">-</span>
<a href="#l24.585"></a><span id="l24.585" class="difflineminus">-    for (let [i, handler] of handlers.entries()) {</span>
<a href="#l24.586"></a><span id="l24.586" class="difflineminus">-      let pollfd = pollfds[i];</span>
<a href="#l24.587"></a><span id="l24.587" class="difflineminus">-</span>
<a href="#l24.588"></a><span id="l24.588" class="difflineminus">-      pollfd.fd = handler.fd;</span>
<a href="#l24.589"></a><span id="l24.589" class="difflineminus">-      pollfd.events = handler.pollEvents;</span>
<a href="#l24.590"></a><span id="l24.590" class="difflineminus">-      pollfd.revents = 0;</span>
<a href="#l24.591"></a><span id="l24.591" class="difflineminus">-    }</span>
<a href="#l24.592"></a><span id="l24.592" class="difflineminus">-</span>
<a href="#l24.593"></a><span id="l24.593" class="difflineminus">-    this.pollFds = pollfds;</span>
<a href="#l24.594"></a><span id="l24.594" class="difflineminus">-    this.pollHandlers = handlers;</span>
<a href="#l24.595"></a><span id="l24.595" class="difflineminus">-  },</span>
<a href="#l24.596"></a><span id="l24.596" class="difflineminus">-</span>
<a href="#l24.597"></a><span id="l24.597" class="difflineminus">-  loop() {</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineminus">-    this.poll();</span>
<a href="#l24.599"></a><span id="l24.599" class="difflineminus">-    if (this.running) {</span>
<a href="#l24.600"></a><span id="l24.600" class="difflineminus">-      setTimeout(this.loop.bind(this), 0);</span>
<a href="#l24.601"></a><span id="l24.601" class="difflineminus">-    }</span>
<a href="#l24.602"></a><span id="l24.602" class="difflineminus">-  },</span>
<a href="#l24.603"></a><span id="l24.603" class="difflineminus">-</span>
<a href="#l24.604"></a><span id="l24.604" class="difflineminus">-  poll() {</span>
<a href="#l24.605"></a><span id="l24.605" class="difflineminus">-    let handlers = this.pollHandlers;</span>
<a href="#l24.606"></a><span id="l24.606" class="difflineminus">-    let pollfds = this.pollFds;</span>
<a href="#l24.607"></a><span id="l24.607" class="difflineminus">-</span>
<a href="#l24.608"></a><span id="l24.608" class="difflineminus">-    let timeout = this.messageCount &gt; 0 ? 0 : POLL_TIMEOUT;</span>
<a href="#l24.609"></a><span id="l24.609" class="difflineminus">-    let count = libc.poll(pollfds, pollfds.length, timeout);</span>
<a href="#l24.610"></a><span id="l24.610" class="difflineminus">-</span>
<a href="#l24.611"></a><span id="l24.611" class="difflineminus">-    for (let i = 0; count &amp;&amp; i &lt; pollfds.length; i++) {</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineminus">-      let pollfd = pollfds[i];</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineminus">-      if (pollfd.revents) {</span>
<a href="#l24.614"></a><span id="l24.614" class="difflineminus">-        count--;</span>
<a href="#l24.615"></a><span id="l24.615" class="difflineminus">-</span>
<a href="#l24.616"></a><span id="l24.616" class="difflineminus">-        let handler = handlers[i];</span>
<a href="#l24.617"></a><span id="l24.617" class="difflineminus">-        try {</span>
<a href="#l24.618"></a><span id="l24.618" class="difflineminus">-          let success = false;</span>
<a href="#l24.619"></a><span id="l24.619" class="difflineminus">-          if (pollfd.revents &amp; handler.pollEvents) {</span>
<a href="#l24.620"></a><span id="l24.620" class="difflineminus">-            success = handler.onReady();</span>
<a href="#l24.621"></a><span id="l24.621" class="difflineminus">-          }</span>
<a href="#l24.622"></a><span id="l24.622" class="difflineminus">-          // Only call the error handler in this iteration if we didn't also</span>
<a href="#l24.623"></a><span id="l24.623" class="difflineminus">-          // have a success. This is necessary because Linux systems set POLLHUP</span>
<a href="#l24.624"></a><span id="l24.624" class="difflineminus">-          // on a pipe when it's closed but there's still buffered data to be</span>
<a href="#l24.625"></a><span id="l24.625" class="difflineminus">-          // read, and Darwin sets POLLIN and POLLHUP on a closed pipe, even</span>
<a href="#l24.626"></a><span id="l24.626" class="difflineminus">-          // when there's no data to be read.</span>
<a href="#l24.627"></a><span id="l24.627" class="difflineminus">-          if (!success &amp;&amp; (pollfd.revents &amp; (LIBC.POLLERR | LIBC.POLLHUP | LIBC.POLLNVAL))) {</span>
<a href="#l24.628"></a><span id="l24.628" class="difflineminus">-            handler.onError();</span>
<a href="#l24.629"></a><span id="l24.629" class="difflineminus">-          }</span>
<a href="#l24.630"></a><span id="l24.630" class="difflineminus">-        }</span>
<a href="#l24.631"></a><span id="l24.631" class="difflineminus">-        catch (e) {</span>
<a href="#l24.632"></a><span id="l24.632" class="difflineminus">-          console.error(e);</span>
<a href="#l24.633"></a><span id="l24.633" class="difflineminus">-          debug(`Worker error: ${e} :: ${e.stack}`);</span>
<a href="#l24.634"></a><span id="l24.634" class="difflineminus">-          handler.onError();</span>
<a href="#l24.635"></a><span id="l24.635" class="difflineminus">-        }</span>
<a href="#l24.636"></a><span id="l24.636" class="difflineminus">-</span>
<a href="#l24.637"></a><span id="l24.637" class="difflineminus">-        pollfd.revents = 0;</span>
<a href="#l24.638"></a><span id="l24.638" class="difflineminus">-      }</span>
<a href="#l24.639"></a><span id="l24.639" class="difflineminus">-    }</span>
<a href="#l24.640"></a><span id="l24.640" class="difflineminus">-  },</span>
<a href="#l24.641"></a><span id="l24.641" class="difflineminus">-</span>
<a href="#l24.642"></a><span id="l24.642" class="difflineminus">-  addProcess(process) {</span>
<a href="#l24.643"></a><span id="l24.643" class="difflineminus">-    this.processes.set(process.id, process);</span>
<a href="#l24.644"></a><span id="l24.644" class="difflineminus">-</span>
<a href="#l24.645"></a><span id="l24.645" class="difflineminus">-    for (let pipe of process.pipes) {</span>
<a href="#l24.646"></a><span id="l24.646" class="difflineminus">-      if (pipe !== undefined)</span>
<a href="#l24.647"></a><span id="l24.647" class="difflineminus">-        this.pipes.set(pipe.id, pipe);</span>
<a href="#l24.648"></a><span id="l24.648" class="difflineminus">-    }</span>
<a href="#l24.649"></a><span id="l24.649" class="difflineminus">-  },</span>
<a href="#l24.650"></a><span id="l24.650" class="difflineminus">-</span>
<a href="#l24.651"></a><span id="l24.651" class="difflineminus">-  cleanupProcess(process) {</span>
<a href="#l24.652"></a><span id="l24.652" class="difflineminus">-    this.processes.delete(process.id);</span>
<a href="#l24.653"></a><span id="l24.653" class="difflineminus">-  }</span>
<a href="#l24.654"></a><span id="l24.654" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/enigmailprocess_worker_win.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,753 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-/* exported Process */</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-/* globals BaseProcess, BasePipe, win32 */</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-/* global importScripts: false */</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-importScripts(&quot;chrome://openpgp/content/modules/enigmailprocess_shared.js&quot;,</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-  &quot;chrome://openpgp/content/modules/enigmailprocess_shared_win.js&quot;,</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-  &quot;chrome://openpgp/content/modules/enigmailprocess_worker_common.js&quot;);</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-/* global ctypes: false, libc: false, unix: false, SubprocessConstants: false, user32: false */</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-  /* global debug: false */</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-  /* eslint no-console: 0 */</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-const POLL_TIMEOUT = 5000;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-// The exit code that we send when we forcibly terminate a process.</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-const TERMINATE_EXIT_CODE = 0x7f;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-let io;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-let nextPipeId = 0;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-class Pipe extends BasePipe {</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-  constructor(process, origHandle) {</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-    super();</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-    let handle = win32.HANDLE();</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-    let curProc = libc.GetCurrentProcess();</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-    libc.DuplicateHandle(curProc, origHandle, curProc, handle.address(),</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-      0, false /* inheritable */ , win32.DUPLICATE_SAME_ACCESS);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-    origHandle.dispose();</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-    this.id = nextPipeId++;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-    this.process = process;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-    this.handle = win32.Handle(handle);</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-    let event = libc.CreateEventW(null, false, false, null);</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-    this.overlapped = win32.OVERLAPPED();</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-    this.overlapped.hEvent = event;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-    this._event = win32.Handle(event);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-    this.buffer = null;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-  }</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-  get event() {</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-    if (this.pending.length) {</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-      return this._event;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-    }</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-    return null;</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-  }</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-  maybeClose() {}</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-  /**</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-   * Closes the file handle.</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-   *</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-   * @param {boolean} [force=false]</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-   *        If true, the file handle is closed immediately. If false, the</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-   *        file handle is closed after all current pending IO operations</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-   *        have completed.</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-   *</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-   * @returns {Promise&lt;void&gt;}</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-   *          Resolves when the file handle has been closed.</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-   */</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  close(force = false) {</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-    if (!force &amp;&amp; this.pending.length) {</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-      this.closing = true;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-      return this.closedPromise;</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-    }</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    for (let {reject} of this.pending) {</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-      let error = new Error(&quot;File closed&quot;);</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-      error.errorCode = SubprocessConstants.ERROR_END_OF_FILE;</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-      reject(error);</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-    }</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-    this.pending.length = 0;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-    this.buffer = null;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-    if (!this.closed) {</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-      this.handle.dispose();</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-      this._event.dispose();</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-      io.pipes.delete(this.id);</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-      this.handle = null;</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-      this.closed = true;</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-      this.resolveClosed();</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-      io.updatePollEvents();</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-    }</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-    return this.closedPromise;</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-  }</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-  /**</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-   * Called when an error occurred while attempting an IO operation on our file</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-   * handle.</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-   */</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-  onError() {</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-    this.close(true);</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-  }</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-}</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-class InputPipe extends Pipe {</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-  /**</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-   * Queues the next chunk of data to be read from the pipe if, and only if,</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-   * there is no IO operation currently pending.</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-   */</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-  readNext() {</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-    if (this.buffer === null) {</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-      this.readBuffer(this.pending[0].length);</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-    }</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-  }</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-  /**</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-   * Closes the pipe if there is a pending read operation with no more</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-   * buffered data to be read.</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-   */</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-  maybeClose() {</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-    if (this.buffer) {</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-      let read = win32.DWORD();</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-      let ok = libc.GetOverlappedResult(</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-        this.handle, this.overlapped.address(),</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-        read.address(), false);</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-      if (!ok) {</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineminus">-        this.onError();</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineminus">-      }</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-    }</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineminus">-  }</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineminus">-  /**</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineminus">-   * Asynchronously reads at most `length` bytes of binary data from the file</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-   * descriptor into an ArrayBuffer of the same size. Returns a promise which</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-   * resolves when the operation is complete.</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineminus">-   *</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineminus">-   * @param {integer} length</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-   *</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-   * @returns {Promise&lt;ArrayBuffer&gt;}</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineminus">-   */</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineminus">-  read(length) {</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-    if (this.closing || this.closed) {</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineminus">-      throw new Error(&quot;Attempt to read from closed pipe&quot;);</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-    }</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineminus">-</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-      this.pending.push({</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineminus">-        resolve,</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineminus">-        reject,</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineminus">-        length</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-      });</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineminus">-      this.readNext();</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineminus">-    });</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineminus">-  }</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-  /**</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-   * Initializes an overlapped IO read operation to read exactly `count` bytes</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-   * into a new ArrayBuffer, which is stored in the `buffer` property until the</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-   * operation completes.</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-   *</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-   * @param {integer} count</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-   *        The number of bytes to read.</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineminus">-   */</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineminus">-  readBuffer(count) {</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-    this.buffer = new ArrayBuffer(count);</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-    let ok = libc.ReadFile(this.handle, this.buffer, count,</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-      null, this.overlapped.address());</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-    if (!ok &amp;&amp; (!this.process.handle || libc.winLastError)) {</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-      this.onError();</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-    }</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineminus">-    else {</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineminus">-      io.updatePollEvents();</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineminus">-    }</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineminus">-  }</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineminus">-</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineminus">-  /**</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-   * Called when our pending overlapped IO operation has completed, whether</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-   * successfully or in failure.</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineminus">-   */</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineminus">-  onReady() {</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineminus">-    let read = win32.DWORD();</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineminus">-</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineminus">-    let ok = libc.GetOverlappedResult(</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-      this.handle, this.overlapped.address(),</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineminus">-      read.address(), false);</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineminus">-</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineminus">-    read = read.value;</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineminus">-</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-    if (!ok) {</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineminus">-      this.onError();</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineminus">-    }</span>
<a href="#l25.212"></a><span id="l25.212" class="difflineminus">-    else if (read &gt; 0) {</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineminus">-      let buffer = this.buffer;</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineminus">-      this.buffer = null;</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineminus">-</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineminus">-      let {resolve} = this.shiftPending();</span>
<a href="#l25.217"></a><span id="l25.217" class="difflineminus">-</span>
<a href="#l25.218"></a><span id="l25.218" class="difflineminus">-      if (read == buffer.byteLength) {</span>
<a href="#l25.219"></a><span id="l25.219" class="difflineminus">-        resolve(buffer);</span>
<a href="#l25.220"></a><span id="l25.220" class="difflineminus">-      }</span>
<a href="#l25.221"></a><span id="l25.221" class="difflineminus">-      else {</span>
<a href="#l25.222"></a><span id="l25.222" class="difflineminus">-        resolve(ArrayBuffer.transfer(buffer, read));</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineminus">-      }</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineminus">-</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineminus">-      if (this.pending.length) {</span>
<a href="#l25.226"></a><span id="l25.226" class="difflineminus">-        this.readNext();</span>
<a href="#l25.227"></a><span id="l25.227" class="difflineminus">-      }</span>
<a href="#l25.228"></a><span id="l25.228" class="difflineminus">-      else {</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineminus">-        io.updatePollEvents();</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineminus">-      }</span>
<a href="#l25.231"></a><span id="l25.231" class="difflineminus">-    }</span>
<a href="#l25.232"></a><span id="l25.232" class="difflineminus">-  }</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineminus">-}</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineminus">-</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineminus">-class OutputPipe extends Pipe {</span>
<a href="#l25.236"></a><span id="l25.236" class="difflineminus">-  /**</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-   * Queues the next chunk of data to be written to the pipe if, and only if,</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineminus">-   * there is no IO operation currently pending.</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineminus">-   */</span>
<a href="#l25.240"></a><span id="l25.240" class="difflineminus">-  writeNext() {</span>
<a href="#l25.241"></a><span id="l25.241" class="difflineminus">-    if (this.buffer === null) {</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineminus">-      this.writeBuffer(this.pending[0].buffer);</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineminus">-    }</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineminus">-  }</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineminus">-</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineminus">-  /**</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineminus">-   * Asynchronously writes the given buffer to our file descriptor, and returns</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineminus">-   * a promise which resolves when the operation is complete.</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineminus">-   *</span>
<a href="#l25.250"></a><span id="l25.250" class="difflineminus">-   * @param {ArrayBuffer} buffer</span>
<a href="#l25.251"></a><span id="l25.251" class="difflineminus">-   *        The buffer to write.</span>
<a href="#l25.252"></a><span id="l25.252" class="difflineminus">-   *</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineminus">-   * @returns {Promise&lt;integer&gt;}</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-   *          Resolves to the number of bytes written when the operation is</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineminus">-   *          complete.</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineminus">-   */</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-  write(buffer) {</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineminus">-    if (this.closing || this.closed) {</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineminus">-      throw new Error(&quot;Attempt to write to closed pipe&quot;);</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineminus">-    }</span>
<a href="#l25.261"></a><span id="l25.261" class="difflineminus">-</span>
<a href="#l25.262"></a><span id="l25.262" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l25.263"></a><span id="l25.263" class="difflineminus">-      this.pending.push({</span>
<a href="#l25.264"></a><span id="l25.264" class="difflineminus">-        resolve,</span>
<a href="#l25.265"></a><span id="l25.265" class="difflineminus">-        reject,</span>
<a href="#l25.266"></a><span id="l25.266" class="difflineminus">-        buffer</span>
<a href="#l25.267"></a><span id="l25.267" class="difflineminus">-      });</span>
<a href="#l25.268"></a><span id="l25.268" class="difflineminus">-      this.writeNext();</span>
<a href="#l25.269"></a><span id="l25.269" class="difflineminus">-    });</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineminus">-  }</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineminus">-</span>
<a href="#l25.272"></a><span id="l25.272" class="difflineminus">-  /**</span>
<a href="#l25.273"></a><span id="l25.273" class="difflineminus">-   * Initializes an overapped IO read operation to write the data in `buffer` to</span>
<a href="#l25.274"></a><span id="l25.274" class="difflineminus">-   * our file descriptor.</span>
<a href="#l25.275"></a><span id="l25.275" class="difflineminus">-   *</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-   * @param {ArrayBuffer} buffer</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineminus">-   *        The buffer to write.</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineminus">-   */</span>
<a href="#l25.279"></a><span id="l25.279" class="difflineminus">-  writeBuffer(buffer) {</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineminus">-    this.buffer = buffer;</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineminus">-</span>
<a href="#l25.282"></a><span id="l25.282" class="difflineminus">-    let ok = libc.WriteFile(this.handle, buffer, buffer.byteLength,</span>
<a href="#l25.283"></a><span id="l25.283" class="difflineminus">-      null, this.overlapped.address());</span>
<a href="#l25.284"></a><span id="l25.284" class="difflineminus">-</span>
<a href="#l25.285"></a><span id="l25.285" class="difflineminus">-    if (!ok &amp;&amp; libc.winLastError) {</span>
<a href="#l25.286"></a><span id="l25.286" class="difflineminus">-      this.onError();</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineminus">-    }</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineminus">-    else {</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineminus">-      io.updatePollEvents();</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineminus">-    }</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineminus">-  }</span>
<a href="#l25.292"></a><span id="l25.292" class="difflineminus">-</span>
<a href="#l25.293"></a><span id="l25.293" class="difflineminus">-  /**</span>
<a href="#l25.294"></a><span id="l25.294" class="difflineminus">-   * Called when our pending overlapped IO operation has completed, whether</span>
<a href="#l25.295"></a><span id="l25.295" class="difflineminus">-   * successfully or in failure.</span>
<a href="#l25.296"></a><span id="l25.296" class="difflineminus">-   */</span>
<a href="#l25.297"></a><span id="l25.297" class="difflineminus">-  onReady() {</span>
<a href="#l25.298"></a><span id="l25.298" class="difflineminus">-    let written = win32.DWORD();</span>
<a href="#l25.299"></a><span id="l25.299" class="difflineminus">-</span>
<a href="#l25.300"></a><span id="l25.300" class="difflineminus">-    let ok = libc.GetOverlappedResult(</span>
<a href="#l25.301"></a><span id="l25.301" class="difflineminus">-      this.handle, this.overlapped.address(),</span>
<a href="#l25.302"></a><span id="l25.302" class="difflineminus">-      written.address(), false);</span>
<a href="#l25.303"></a><span id="l25.303" class="difflineminus">-</span>
<a href="#l25.304"></a><span id="l25.304" class="difflineminus">-    written = written.value;</span>
<a href="#l25.305"></a><span id="l25.305" class="difflineminus">-</span>
<a href="#l25.306"></a><span id="l25.306" class="difflineminus">-    if (!ok || written != this.buffer.byteLength) {</span>
<a href="#l25.307"></a><span id="l25.307" class="difflineminus">-      this.onError();</span>
<a href="#l25.308"></a><span id="l25.308" class="difflineminus">-    }</span>
<a href="#l25.309"></a><span id="l25.309" class="difflineminus">-    else if (written &gt; 0) {</span>
<a href="#l25.310"></a><span id="l25.310" class="difflineminus">-      let {resolve} = this.shiftPending();</span>
<a href="#l25.311"></a><span id="l25.311" class="difflineminus">-</span>
<a href="#l25.312"></a><span id="l25.312" class="difflineminus">-      this.buffer = null;</span>
<a href="#l25.313"></a><span id="l25.313" class="difflineminus">-      resolve(written);</span>
<a href="#l25.314"></a><span id="l25.314" class="difflineminus">-</span>
<a href="#l25.315"></a><span id="l25.315" class="difflineminus">-      if (this.pending.length) {</span>
<a href="#l25.316"></a><span id="l25.316" class="difflineminus">-        this.writeNext();</span>
<a href="#l25.317"></a><span id="l25.317" class="difflineminus">-      }</span>
<a href="#l25.318"></a><span id="l25.318" class="difflineminus">-      else {</span>
<a href="#l25.319"></a><span id="l25.319" class="difflineminus">-        io.updatePollEvents();</span>
<a href="#l25.320"></a><span id="l25.320" class="difflineminus">-      }</span>
<a href="#l25.321"></a><span id="l25.321" class="difflineminus">-    }</span>
<a href="#l25.322"></a><span id="l25.322" class="difflineminus">-  }</span>
<a href="#l25.323"></a><span id="l25.323" class="difflineminus">-}</span>
<a href="#l25.324"></a><span id="l25.324" class="difflineminus">-</span>
<a href="#l25.325"></a><span id="l25.325" class="difflineminus">-class Signal {</span>
<a href="#l25.326"></a><span id="l25.326" class="difflineminus">-  constructor(event) {</span>
<a href="#l25.327"></a><span id="l25.327" class="difflineminus">-    this.event = event;</span>
<a href="#l25.328"></a><span id="l25.328" class="difflineminus">-  }</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineminus">-</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineminus">-  cleanup() {</span>
<a href="#l25.331"></a><span id="l25.331" class="difflineminus">-    libc.CloseHandle(this.event);</span>
<a href="#l25.332"></a><span id="l25.332" class="difflineminus">-    this.event = null;</span>
<a href="#l25.333"></a><span id="l25.333" class="difflineminus">-  }</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineminus">-</span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-  onError() {</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineminus">-    io.shutdown();</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineminus">-  }</span>
<a href="#l25.338"></a><span id="l25.338" class="difflineminus">-</span>
<a href="#l25.339"></a><span id="l25.339" class="difflineminus">-  onReady() {</span>
<a href="#l25.340"></a><span id="l25.340" class="difflineminus">-    io.messageCount += 1;</span>
<a href="#l25.341"></a><span id="l25.341" class="difflineminus">-  }</span>
<a href="#l25.342"></a><span id="l25.342" class="difflineminus">-}</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineminus">-</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineminus">-class Process extends BaseProcess {</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineminus">-  constructor(...args) {</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineminus">-    super(...args);</span>
<a href="#l25.347"></a><span id="l25.347" class="difflineminus">-</span>
<a href="#l25.348"></a><span id="l25.348" class="difflineminus">-    this.killed = false;</span>
<a href="#l25.349"></a><span id="l25.349" class="difflineminus">-  }</span>
<a href="#l25.350"></a><span id="l25.350" class="difflineminus">-</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineminus">-  /**</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineminus">-   * Returns our process handle for use as an event in a WaitForMultipleObjects</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineminus">-   * call.</span>
<a href="#l25.354"></a><span id="l25.354" class="difflineminus">-   */</span>
<a href="#l25.355"></a><span id="l25.355" class="difflineminus">-  get event() {</span>
<a href="#l25.356"></a><span id="l25.356" class="difflineminus">-    return this.handle;</span>
<a href="#l25.357"></a><span id="l25.357" class="difflineminus">-  }</span>
<a href="#l25.358"></a><span id="l25.358" class="difflineminus">-</span>
<a href="#l25.359"></a><span id="l25.359" class="difflineminus">-  /**</span>
<a href="#l25.360"></a><span id="l25.360" class="difflineminus">-   * Forcibly terminates the process and all children.</span>
<a href="#l25.361"></a><span id="l25.361" class="difflineminus">-   */</span>
<a href="#l25.362"></a><span id="l25.362" class="difflineminus">-  kill() {</span>
<a href="#l25.363"></a><span id="l25.363" class="difflineminus">-    this.killed = true;</span>
<a href="#l25.364"></a><span id="l25.364" class="difflineminus">-    libc.TerminateJobObject(this.jobHandle, TERMINATE_EXIT_CODE);</span>
<a href="#l25.365"></a><span id="l25.365" class="difflineminus">-  }</span>
<a href="#l25.366"></a><span id="l25.366" class="difflineminus">-</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineminus">-  /**</span>
<a href="#l25.368"></a><span id="l25.368" class="difflineminus">-   * Initializes the IO pipes for use as standard input, output, and error</span>
<a href="#l25.369"></a><span id="l25.369" class="difflineminus">-   * descriptors in the spawned process.</span>
<a href="#l25.370"></a><span id="l25.370" class="difflineminus">-   *</span>
<a href="#l25.371"></a><span id="l25.371" class="difflineminus">-   * @returns {win32.Handle[]}</span>
<a href="#l25.372"></a><span id="l25.372" class="difflineminus">-   *          The array of file handles belonging to the spawned process.</span>
<a href="#l25.373"></a><span id="l25.373" class="difflineminus">-   */</span>
<a href="#l25.374"></a><span id="l25.374" class="difflineminus">-  initPipes({stderr}) {</span>
<a href="#l25.375"></a><span id="l25.375" class="difflineminus">-    let our_pipes = [];</span>
<a href="#l25.376"></a><span id="l25.376" class="difflineminus">-    let their_pipes = [];</span>
<a href="#l25.377"></a><span id="l25.377" class="difflineminus">-</span>
<a href="#l25.378"></a><span id="l25.378" class="difflineminus">-    let secAttr = new win32.SECURITY_ATTRIBUTES();</span>
<a href="#l25.379"></a><span id="l25.379" class="difflineminus">-    secAttr.nLength = win32.SECURITY_ATTRIBUTES.size;</span>
<a href="#l25.380"></a><span id="l25.380" class="difflineminus">-    secAttr.bInheritHandle = true;</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineminus">-</span>
<a href="#l25.382"></a><span id="l25.382" class="difflineminus">-    let pipe = input =&gt; {</span>
<a href="#l25.383"></a><span id="l25.383" class="difflineminus">-      if (input) {</span>
<a href="#l25.384"></a><span id="l25.384" class="difflineminus">-        let handles = win32.createPipe(secAttr, win32.FILE_FLAG_OVERLAPPED);</span>
<a href="#l25.385"></a><span id="l25.385" class="difflineminus">-        our_pipes.push(new InputPipe(this, handles[0]));</span>
<a href="#l25.386"></a><span id="l25.386" class="difflineminus">-        return handles[1];</span>
<a href="#l25.387"></a><span id="l25.387" class="difflineminus">-      }</span>
<a href="#l25.388"></a><span id="l25.388" class="difflineminus">-      let handles = win32.createPipe(secAttr, 0, win32.FILE_FLAG_OVERLAPPED);</span>
<a href="#l25.389"></a><span id="l25.389" class="difflineminus">-      our_pipes.push(new OutputPipe(this, handles[1]));</span>
<a href="#l25.390"></a><span id="l25.390" class="difflineminus">-      return handles[0];</span>
<a href="#l25.391"></a><span id="l25.391" class="difflineminus">-    };</span>
<a href="#l25.392"></a><span id="l25.392" class="difflineminus">-</span>
<a href="#l25.393"></a><span id="l25.393" class="difflineminus">-    their_pipes[0] = pipe(false);</span>
<a href="#l25.394"></a><span id="l25.394" class="difflineminus">-    their_pipes[1] = pipe(true);</span>
<a href="#l25.395"></a><span id="l25.395" class="difflineminus">-</span>
<a href="#l25.396"></a><span id="l25.396" class="difflineminus">-    if (stderr == &quot;pipe&quot;) {</span>
<a href="#l25.397"></a><span id="l25.397" class="difflineminus">-      their_pipes[2] = pipe(true);</span>
<a href="#l25.398"></a><span id="l25.398" class="difflineminus">-    }</span>
<a href="#l25.399"></a><span id="l25.399" class="difflineminus">-    else {</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineminus">-      let srcHandle;</span>
<a href="#l25.401"></a><span id="l25.401" class="difflineminus">-      if (stderr == &quot;stdout&quot;) {</span>
<a href="#l25.402"></a><span id="l25.402" class="difflineminus">-        srcHandle = their_pipes[1];</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineminus">-      }</span>
<a href="#l25.404"></a><span id="l25.404" class="difflineminus">-      else {</span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-        srcHandle = libc.GetStdHandle(win32.STD_ERROR_HANDLE);</span>
<a href="#l25.406"></a><span id="l25.406" class="difflineminus">-      }</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineminus">-</span>
<a href="#l25.408"></a><span id="l25.408" class="difflineminus">-      // If we don't have a valid stderr handle, just pass it along without duplicating.</span>
<a href="#l25.409"></a><span id="l25.409" class="difflineminus">-      if (String(srcHandle) == win32.INVALID_HANDLE_VALUE ||</span>
<a href="#l25.410"></a><span id="l25.410" class="difflineminus">-        String(srcHandle) == win32.NULL_HANDLE_VALUE) {</span>
<a href="#l25.411"></a><span id="l25.411" class="difflineminus">-        their_pipes[2] = srcHandle;</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-      }</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineminus">-      else {</span>
<a href="#l25.414"></a><span id="l25.414" class="difflineminus">-</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineminus">-        let handle = win32.HANDLE();</span>
<a href="#l25.416"></a><span id="l25.416" class="difflineminus">-</span>
<a href="#l25.417"></a><span id="l25.417" class="difflineminus">-        let curProc = libc.GetCurrentProcess();</span>
<a href="#l25.418"></a><span id="l25.418" class="difflineminus">-        let ok = libc.DuplicateHandle(curProc, srcHandle, curProc, handle.address(),</span>
<a href="#l25.419"></a><span id="l25.419" class="difflineminus">-          0, true /* inheritable */ ,</span>
<a href="#l25.420"></a><span id="l25.420" class="difflineminus">-          win32.DUPLICATE_SAME_ACCESS);</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineminus">-</span>
<a href="#l25.422"></a><span id="l25.422" class="difflineminus">-        their_pipes[2] = ok &amp;&amp; win32.Handle(handle);</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineminus">-      }</span>
<a href="#l25.424"></a><span id="l25.424" class="difflineminus">-    }</span>
<a href="#l25.425"></a><span id="l25.425" class="difflineminus">-</span>
<a href="#l25.426"></a><span id="l25.426" class="difflineminus">-    if (!their_pipes.every(handle =&gt; handle)) {</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineminus">-      throw new Error(&quot;Failed to create pipe&quot;);</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineminus">-    }</span>
<a href="#l25.429"></a><span id="l25.429" class="difflineminus">-</span>
<a href="#l25.430"></a><span id="l25.430" class="difflineminus">-    this.pipes = our_pipes;</span>
<a href="#l25.431"></a><span id="l25.431" class="difflineminus">-</span>
<a href="#l25.432"></a><span id="l25.432" class="difflineminus">-    return their_pipes;</span>
<a href="#l25.433"></a><span id="l25.433" class="difflineminus">-  }</span>
<a href="#l25.434"></a><span id="l25.434" class="difflineminus">-</span>
<a href="#l25.435"></a><span id="l25.435" class="difflineminus">-  /**</span>
<a href="#l25.436"></a><span id="l25.436" class="difflineminus">-   * Creates a null-separated, null-terminated string list.</span>
<a href="#l25.437"></a><span id="l25.437" class="difflineminus">-   *</span>
<a href="#l25.438"></a><span id="l25.438" class="difflineminus">-   * @param {Array&lt;string&gt;} strings</span>
<a href="#l25.439"></a><span id="l25.439" class="difflineminus">-   * @returns {win32.WCHAR.array}</span>
<a href="#l25.440"></a><span id="l25.440" class="difflineminus">-   */</span>
<a href="#l25.441"></a><span id="l25.441" class="difflineminus">-  stringList(strings) {</span>
<a href="#l25.442"></a><span id="l25.442" class="difflineminus">-    // Remove empty strings, which would terminate the list early.</span>
<a href="#l25.443"></a><span id="l25.443" class="difflineminus">-    strings = strings.filter(string =&gt; string);</span>
<a href="#l25.444"></a><span id="l25.444" class="difflineminus">-</span>
<a href="#l25.445"></a><span id="l25.445" class="difflineminus">-    let string = strings.join(&quot;\0&quot;) + &quot;\0\0&quot;;</span>
<a href="#l25.446"></a><span id="l25.446" class="difflineminus">-</span>
<a href="#l25.447"></a><span id="l25.447" class="difflineminus">-    return win32.WCHAR.array()(string);</span>
<a href="#l25.448"></a><span id="l25.448" class="difflineminus">-  }</span>
<a href="#l25.449"></a><span id="l25.449" class="difflineminus">-</span>
<a href="#l25.450"></a><span id="l25.450" class="difflineminus">-  /**</span>
<a href="#l25.451"></a><span id="l25.451" class="difflineminus">-   * Quotes a string for use as a single command argument, using Windows quoting</span>
<a href="#l25.452"></a><span id="l25.452" class="difflineminus">-   * conventions.</span>
<a href="#l25.453"></a><span id="l25.453" class="difflineminus">-   *</span>
<a href="#l25.454"></a><span id="l25.454" class="difflineminus">-   * @see https://msdn.microsoft.com/en-us/library/17w5ykft(v=vs.85).aspx</span>
<a href="#l25.455"></a><span id="l25.455" class="difflineminus">-   *</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineminus">-   * @param {string} str</span>
<a href="#l25.457"></a><span id="l25.457" class="difflineminus">-   *        The argument string to quote.</span>
<a href="#l25.458"></a><span id="l25.458" class="difflineminus">-   * @returns {string}</span>
<a href="#l25.459"></a><span id="l25.459" class="difflineminus">-   */</span>
<a href="#l25.460"></a><span id="l25.460" class="difflineminus">-  quoteString(str) {</span>
<a href="#l25.461"></a><span id="l25.461" class="difflineminus">-    if (!/[\s&quot;]/.test(str)) {</span>
<a href="#l25.462"></a><span id="l25.462" class="difflineminus">-      return str;</span>
<a href="#l25.463"></a><span id="l25.463" class="difflineminus">-    }</span>
<a href="#l25.464"></a><span id="l25.464" class="difflineminus">-</span>
<a href="#l25.465"></a><span id="l25.465" class="difflineminus">-    let escaped = str.replace(/(\\*)(&quot;|$)/g, (m0, m1, m2) =&gt; {</span>
<a href="#l25.466"></a><span id="l25.466" class="difflineminus">-      if (m2) {</span>
<a href="#l25.467"></a><span id="l25.467" class="difflineminus">-        m2 = `${m2}`;</span>
<a href="#l25.468"></a><span id="l25.468" class="difflineminus">-      }</span>
<a href="#l25.469"></a><span id="l25.469" class="difflineminus">-      return `${m1}${m1}${m2}`;</span>
<a href="#l25.470"></a><span id="l25.470" class="difflineminus">-    });</span>
<a href="#l25.471"></a><span id="l25.471" class="difflineminus">-</span>
<a href="#l25.472"></a><span id="l25.472" class="difflineminus">-    return `&quot;${escaped}&quot;`;</span>
<a href="#l25.473"></a><span id="l25.473" class="difflineminus">-  }</span>
<a href="#l25.474"></a><span id="l25.474" class="difflineminus">-</span>
<a href="#l25.475"></a><span id="l25.475" class="difflineminus">-  spawn(options) {</span>
<a href="#l25.476"></a><span id="l25.476" class="difflineminus">-    let {command, arguments: args} = options;</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineminus">-</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineminus">-    if (/\\cmd\.exe$/i.test(command) &amp;&amp; args.length == 3 &amp;&amp; /^(\/S)?\/C$/i.test(args[1])) {</span>
<a href="#l25.479"></a><span id="l25.479" class="difflineminus">-      // cmd.exe is insane and requires special treatment.</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineminus">-      args = [this.quoteString(args[0]), &quot;/S/C&quot;, `&quot;${args[2]}&quot;`];</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineminus">-    }</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineminus">-    else {</span>
<a href="#l25.483"></a><span id="l25.483" class="difflineminus">-      args = args.map(arg =&gt; this.quoteString(arg));</span>
<a href="#l25.484"></a><span id="l25.484" class="difflineminus">-    }</span>
<a href="#l25.485"></a><span id="l25.485" class="difflineminus">-</span>
<a href="#l25.486"></a><span id="l25.486" class="difflineminus">-    if (/\.(bat|cmd)$/i.test(command)) {</span>
<a href="#l25.487"></a><span id="l25.487" class="difflineminus">-      command = io.comspec;</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineminus">-      args = [&quot;cmd.exe&quot;, &quot;/s/c&quot;, `&quot;${args.join(&quot; &quot;)}&quot;`];</span>
<a href="#l25.489"></a><span id="l25.489" class="difflineminus">-    }</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineminus">-</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineminus">-    let envp = this.stringList(options.environment);</span>
<a href="#l25.492"></a><span id="l25.492" class="difflineminus">-</span>
<a href="#l25.493"></a><span id="l25.493" class="difflineminus">-    let handles = this.initPipes(options);</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineminus">-</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineminus">-    let processFlags = win32.CREATE_NO_WINDOW | win32.CREATE_SUSPENDED | win32.CREATE_UNICODE_ENVIRONMENT;</span>
<a href="#l25.496"></a><span id="l25.496" class="difflineminus">-</span>
<a href="#l25.497"></a><span id="l25.497" class="difflineminus">-    if (io.breakAwayFromJob) {</span>
<a href="#l25.498"></a><span id="l25.498" class="difflineminus">-      processFlags |= win32.CREATE_BREAKAWAY_FROM_JOB;</span>
<a href="#l25.499"></a><span id="l25.499" class="difflineminus">-    }</span>
<a href="#l25.500"></a><span id="l25.500" class="difflineminus">-</span>
<a href="#l25.501"></a><span id="l25.501" class="difflineminus">-    let startupInfoEx = new win32.STARTUPINFOEXW();</span>
<a href="#l25.502"></a><span id="l25.502" class="difflineminus">-    let startupInfo = startupInfoEx.StartupInfo;</span>
<a href="#l25.503"></a><span id="l25.503" class="difflineminus">-</span>
<a href="#l25.504"></a><span id="l25.504" class="difflineminus">-    startupInfo.cb = win32.STARTUPINFOW.size;</span>
<a href="#l25.505"></a><span id="l25.505" class="difflineminus">-    startupInfo.dwFlags = win32.STARTF_USESTDHANDLES;</span>
<a href="#l25.506"></a><span id="l25.506" class="difflineminus">-</span>
<a href="#l25.507"></a><span id="l25.507" class="difflineminus">-    startupInfo.hStdInput = handles[0];</span>
<a href="#l25.508"></a><span id="l25.508" class="difflineminus">-    startupInfo.hStdOutput = handles[1];</span>
<a href="#l25.509"></a><span id="l25.509" class="difflineminus">-    startupInfo.hStdError = handles[2];</span>
<a href="#l25.510"></a><span id="l25.510" class="difflineminus">-</span>
<a href="#l25.511"></a><span id="l25.511" class="difflineminus">-    // Note: This needs to be kept alive until we destroy the attribute list.</span>
<a href="#l25.512"></a><span id="l25.512" class="difflineminus">-    let handleArray = win32.HANDLE.array()(handles);</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineminus">-</span>
<a href="#l25.514"></a><span id="l25.514" class="difflineminus">-    let threadAttrs = win32.createThreadAttributeList(handleArray);</span>
<a href="#l25.515"></a><span id="l25.515" class="difflineminus">-    if (threadAttrs) {</span>
<a href="#l25.516"></a><span id="l25.516" class="difflineminus">-      // If have thread attributes to pass, pass the size of the full extended</span>
<a href="#l25.517"></a><span id="l25.517" class="difflineminus">-      // startup info struct.</span>
<a href="#l25.518"></a><span id="l25.518" class="difflineminus">-      processFlags |= win32.EXTENDED_STARTUPINFO_PRESENT;</span>
<a href="#l25.519"></a><span id="l25.519" class="difflineminus">-      startupInfo.cb = win32.STARTUPINFOEXW.size;</span>
<a href="#l25.520"></a><span id="l25.520" class="difflineminus">-</span>
<a href="#l25.521"></a><span id="l25.521" class="difflineminus">-      startupInfoEx.lpAttributeList = threadAttrs;</span>
<a href="#l25.522"></a><span id="l25.522" class="difflineminus">-    }</span>
<a href="#l25.523"></a><span id="l25.523" class="difflineminus">-</span>
<a href="#l25.524"></a><span id="l25.524" class="difflineminus">-    let procInfo = new win32.PROCESS_INFORMATION();</span>
<a href="#l25.525"></a><span id="l25.525" class="difflineminus">-</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineminus">-    let errorMessage = &quot;Failed to create process&quot;;</span>
<a href="#l25.527"></a><span id="l25.527" class="difflineminus">-    let ok = libc.CreateProcessW(</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineminus">-      command, args.join(&quot; &quot;),</span>
<a href="#l25.529"></a><span id="l25.529" class="difflineminus">-      null, /* Security attributes */</span>
<a href="#l25.530"></a><span id="l25.530" class="difflineminus">-      null, /* Thread security attributes */</span>
<a href="#l25.531"></a><span id="l25.531" class="difflineminus">-      true, /* Inherits handles */</span>
<a href="#l25.532"></a><span id="l25.532" class="difflineminus">-      processFlags, envp, options.workdir,</span>
<a href="#l25.533"></a><span id="l25.533" class="difflineminus">-      startupInfo.address(),</span>
<a href="#l25.534"></a><span id="l25.534" class="difflineminus">-      procInfo.address());</span>
<a href="#l25.535"></a><span id="l25.535" class="difflineminus">-</span>
<a href="#l25.536"></a><span id="l25.536" class="difflineminus">-    for (let handle of new Set(handles)) {</span>
<a href="#l25.537"></a><span id="l25.537" class="difflineminus">-      // If any of our handles are invalid, they don't have finalizers.</span>
<a href="#l25.538"></a><span id="l25.538" class="difflineminus">-      if (handle &amp;&amp; handle.dispose) {</span>
<a href="#l25.539"></a><span id="l25.539" class="difflineminus">-        handle.dispose();</span>
<a href="#l25.540"></a><span id="l25.540" class="difflineminus">-      }</span>
<a href="#l25.541"></a><span id="l25.541" class="difflineminus">-    }</span>
<a href="#l25.542"></a><span id="l25.542" class="difflineminus">-</span>
<a href="#l25.543"></a><span id="l25.543" class="difflineminus">-    if (threadAttrs) {</span>
<a href="#l25.544"></a><span id="l25.544" class="difflineminus">-      libc.DeleteProcThreadAttributeList(threadAttrs);</span>
<a href="#l25.545"></a><span id="l25.545" class="difflineminus">-    }</span>
<a href="#l25.546"></a><span id="l25.546" class="difflineminus">-</span>
<a href="#l25.547"></a><span id="l25.547" class="difflineminus">-    if (ok) {</span>
<a href="#l25.548"></a><span id="l25.548" class="difflineminus">-      this.jobHandle = win32.Handle(libc.CreateJobObjectW(null, null));</span>
<a href="#l25.549"></a><span id="l25.549" class="difflineminus">-</span>
<a href="#l25.550"></a><span id="l25.550" class="difflineminus">-      let info = win32.JOBOBJECT_EXTENDED_LIMIT_INFORMATION();</span>
<a href="#l25.551"></a><span id="l25.551" class="difflineminus">-      info.BasicLimitInformation.LimitFlags = win32.JOB_OBJECT_LIMIT_BREAKAWAY_OK;</span>
<a href="#l25.552"></a><span id="l25.552" class="difflineminus">-</span>
<a href="#l25.553"></a><span id="l25.553" class="difflineminus">-      ok = libc.SetInformationJobObject(this.jobHandle, win32.JobObjectExtendedLimitInformation,</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineminus">-        ctypes.cast(info.address(), ctypes.voidptr_t),</span>
<a href="#l25.555"></a><span id="l25.555" class="difflineminus">-        info.constructor.size);</span>
<a href="#l25.556"></a><span id="l25.556" class="difflineminus">-      errorMessage = `Failed to set job limits: 0x${(ctypes.winLastError || 0).toString(16)}`;</span>
<a href="#l25.557"></a><span id="l25.557" class="difflineminus">-    }</span>
<a href="#l25.558"></a><span id="l25.558" class="difflineminus">-</span>
<a href="#l25.559"></a><span id="l25.559" class="difflineminus">-    if (ok) {</span>
<a href="#l25.560"></a><span id="l25.560" class="difflineminus">-      ok = libc.AssignProcessToJobObject(this.jobHandle, procInfo.hProcess);</span>
<a href="#l25.561"></a><span id="l25.561" class="difflineminus">-      if (!ok) {</span>
<a href="#l25.562"></a><span id="l25.562" class="difflineminus">-        errorMessage = `Failed to attach process to job object: 0x${(ctypes.winLastError || 0).toString(16)}`;</span>
<a href="#l25.563"></a><span id="l25.563" class="difflineminus">-        libc.TerminateProcess(procInfo.hProcess, TERMINATE_EXIT_CODE);</span>
<a href="#l25.564"></a><span id="l25.564" class="difflineminus">-      }</span>
<a href="#l25.565"></a><span id="l25.565" class="difflineminus">-    }</span>
<a href="#l25.566"></a><span id="l25.566" class="difflineminus">-</span>
<a href="#l25.567"></a><span id="l25.567" class="difflineminus">-    if (!ok) {</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineminus">-      for (let pipe of this.pipes) {</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineminus">-        pipe.close();</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineminus">-      }</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineminus">-      throw new Error(errorMessage);</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineminus">-    }</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineminus">-</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineminus">-    // Allow child processes to obtain focus via Alt-Tab</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineminus">-    try {</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineminus">-      user32.AllowSetForegroundWindow(procInfo.dwProcessId);</span>
<a href="#l25.577"></a><span id="l25.577" class="difflineminus">-    } catch (x) {}</span>
<a href="#l25.578"></a><span id="l25.578" class="difflineminus">-</span>
<a href="#l25.579"></a><span id="l25.579" class="difflineminus">-    this.handle = win32.Handle(procInfo.hProcess);</span>
<a href="#l25.580"></a><span id="l25.580" class="difflineminus">-    this.pid = procInfo.dwProcessId;</span>
<a href="#l25.581"></a><span id="l25.581" class="difflineminus">-</span>
<a href="#l25.582"></a><span id="l25.582" class="difflineminus">-    libc.ResumeThread(procInfo.hThread);</span>
<a href="#l25.583"></a><span id="l25.583" class="difflineminus">-    libc.CloseHandle(procInfo.hThread);</span>
<a href="#l25.584"></a><span id="l25.584" class="difflineminus">-  }</span>
<a href="#l25.585"></a><span id="l25.585" class="difflineminus">-</span>
<a href="#l25.586"></a><span id="l25.586" class="difflineminus">-  /**</span>
<a href="#l25.587"></a><span id="l25.587" class="difflineminus">-   * Called when our process handle is signaled as active, meaning the process</span>
<a href="#l25.588"></a><span id="l25.588" class="difflineminus">-   * has exited.</span>
<a href="#l25.589"></a><span id="l25.589" class="difflineminus">-   */</span>
<a href="#l25.590"></a><span id="l25.590" class="difflineminus">-  onReady() {</span>
<a href="#l25.591"></a><span id="l25.591" class="difflineminus">-    this.wait();</span>
<a href="#l25.592"></a><span id="l25.592" class="difflineminus">-  }</span>
<a href="#l25.593"></a><span id="l25.593" class="difflineminus">-</span>
<a href="#l25.594"></a><span id="l25.594" class="difflineminus">-  /**</span>
<a href="#l25.595"></a><span id="l25.595" class="difflineminus">-   * Attempts to wait for the process's exit status, without blocking. If</span>
<a href="#l25.596"></a><span id="l25.596" class="difflineminus">-   * successful, resolves the `exitPromise` to the process's exit value.</span>
<a href="#l25.597"></a><span id="l25.597" class="difflineminus">-   *</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineminus">-   * @returns {integer|null}</span>
<a href="#l25.599"></a><span id="l25.599" class="difflineminus">-   *          The process's exit status, if it has already exited.</span>
<a href="#l25.600"></a><span id="l25.600" class="difflineminus">-   */</span>
<a href="#l25.601"></a><span id="l25.601" class="difflineminus">-  wait() {</span>
<a href="#l25.602"></a><span id="l25.602" class="difflineminus">-    if (this.exitCode !== null) {</span>
<a href="#l25.603"></a><span id="l25.603" class="difflineminus">-      return this.exitCode;</span>
<a href="#l25.604"></a><span id="l25.604" class="difflineminus">-    }</span>
<a href="#l25.605"></a><span id="l25.605" class="difflineminus">-</span>
<a href="#l25.606"></a><span id="l25.606" class="difflineminus">-    let status = win32.DWORD();</span>
<a href="#l25.607"></a><span id="l25.607" class="difflineminus">-</span>
<a href="#l25.608"></a><span id="l25.608" class="difflineminus">-    let ok = libc.GetExitCodeProcess(this.handle, status.address());</span>
<a href="#l25.609"></a><span id="l25.609" class="difflineminus">-    if (ok &amp;&amp; status.value != win32.STILL_ACTIVE) {</span>
<a href="#l25.610"></a><span id="l25.610" class="difflineminus">-      let exitCode = status.value;</span>
<a href="#l25.611"></a><span id="l25.611" class="difflineminus">-      if (this.killed &amp;&amp; exitCode == TERMINATE_EXIT_CODE) {</span>
<a href="#l25.612"></a><span id="l25.612" class="difflineminus">-        // If we forcibly terminated the process, return the force kill exit</span>
<a href="#l25.613"></a><span id="l25.613" class="difflineminus">-        // code that we return on other platforms.</span>
<a href="#l25.614"></a><span id="l25.614" class="difflineminus">-        exitCode = -9;</span>
<a href="#l25.615"></a><span id="l25.615" class="difflineminus">-      }</span>
<a href="#l25.616"></a><span id="l25.616" class="difflineminus">-</span>
<a href="#l25.617"></a><span id="l25.617" class="difflineminus">-      this.resolveExit(exitCode);</span>
<a href="#l25.618"></a><span id="l25.618" class="difflineminus">-      this.exitCode = exitCode;</span>
<a href="#l25.619"></a><span id="l25.619" class="difflineminus">-</span>
<a href="#l25.620"></a><span id="l25.620" class="difflineminus">-      this.handle.dispose();</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineminus">-      this.handle = null;</span>
<a href="#l25.622"></a><span id="l25.622" class="difflineminus">-</span>
<a href="#l25.623"></a><span id="l25.623" class="difflineminus">-      //libc.TerminateJobObject(this.jobHandle, TERMINATE_EXIT_CODE);</span>
<a href="#l25.624"></a><span id="l25.624" class="difflineminus">-      this.jobHandle.dispose();</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineminus">-      this.jobHandle = null;</span>
<a href="#l25.626"></a><span id="l25.626" class="difflineminus">-</span>
<a href="#l25.627"></a><span id="l25.627" class="difflineminus">-      for (let pipe of this.pipes) {</span>
<a href="#l25.628"></a><span id="l25.628" class="difflineminus">-        pipe.maybeClose();</span>
<a href="#l25.629"></a><span id="l25.629" class="difflineminus">-      }</span>
<a href="#l25.630"></a><span id="l25.630" class="difflineminus">-</span>
<a href="#l25.631"></a><span id="l25.631" class="difflineminus">-      io.updatePollEvents();</span>
<a href="#l25.632"></a><span id="l25.632" class="difflineminus">-</span>
<a href="#l25.633"></a><span id="l25.633" class="difflineminus">-      return exitCode;</span>
<a href="#l25.634"></a><span id="l25.634" class="difflineminus">-    }</span>
<a href="#l25.635"></a><span id="l25.635" class="difflineminus">-    else {</span>
<a href="#l25.636"></a><span id="l25.636" class="difflineminus">-      return null;</span>
<a href="#l25.637"></a><span id="l25.637" class="difflineminus">-    }</span>
<a href="#l25.638"></a><span id="l25.638" class="difflineminus">-  }</span>
<a href="#l25.639"></a><span id="l25.639" class="difflineminus">-}</span>
<a href="#l25.640"></a><span id="l25.640" class="difflineminus">-</span>
<a href="#l25.641"></a><span id="l25.641" class="difflineminus">-io = {</span>
<a href="#l25.642"></a><span id="l25.642" class="difflineminus">-  events: null,</span>
<a href="#l25.643"></a><span id="l25.643" class="difflineminus">-  eventHandlers: null,</span>
<a href="#l25.644"></a><span id="l25.644" class="difflineminus">-</span>
<a href="#l25.645"></a><span id="l25.645" class="difflineminus">-  pipes: new Map(),</span>
<a href="#l25.646"></a><span id="l25.646" class="difflineminus">-</span>
<a href="#l25.647"></a><span id="l25.647" class="difflineminus">-  processes: new Map(),</span>
<a href="#l25.648"></a><span id="l25.648" class="difflineminus">-</span>
<a href="#l25.649"></a><span id="l25.649" class="difflineminus">-  messageCount: 0,</span>
<a href="#l25.650"></a><span id="l25.650" class="difflineminus">-</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineminus">-  running: true,</span>
<a href="#l25.652"></a><span id="l25.652" class="difflineminus">-</span>
<a href="#l25.653"></a><span id="l25.653" class="difflineminus">-  init(details) {</span>
<a href="#l25.654"></a><span id="l25.654" class="difflineminus">-    this.comspec = details.comspec;</span>
<a href="#l25.655"></a><span id="l25.655" class="difflineminus">-</span>
<a href="#l25.656"></a><span id="l25.656" class="difflineminus">-    let signalEvent = ctypes.cast(ctypes.uintptr_t(details.signalEvent),</span>
<a href="#l25.657"></a><span id="l25.657" class="difflineminus">-      win32.HANDLE);</span>
<a href="#l25.658"></a><span id="l25.658" class="difflineminus">-    this.signal = new Signal(signalEvent);</span>
<a href="#l25.659"></a><span id="l25.659" class="difflineminus">-    this.updatePollEvents();</span>
<a href="#l25.660"></a><span id="l25.660" class="difflineminus">-</span>
<a href="#l25.661"></a><span id="l25.661" class="difflineminus">-    this.breakAwayFromJob = details.breakAwayFromJob;</span>
<a href="#l25.662"></a><span id="l25.662" class="difflineminus">-</span>
<a href="#l25.663"></a><span id="l25.663" class="difflineminus">-    setTimeout(this.loop.bind(this), 0);</span>
<a href="#l25.664"></a><span id="l25.664" class="difflineminus">-  },</span>
<a href="#l25.665"></a><span id="l25.665" class="difflineminus">-</span>
<a href="#l25.666"></a><span id="l25.666" class="difflineminus">-  shutdown() {</span>
<a href="#l25.667"></a><span id="l25.667" class="difflineminus">-    if (this.running) {</span>
<a href="#l25.668"></a><span id="l25.668" class="difflineminus">-      this.running = false;</span>
<a href="#l25.669"></a><span id="l25.669" class="difflineminus">-</span>
<a href="#l25.670"></a><span id="l25.670" class="difflineminus">-      this.signal.cleanup();</span>
<a href="#l25.671"></a><span id="l25.671" class="difflineminus">-      this.signal = null;</span>
<a href="#l25.672"></a><span id="l25.672" class="difflineminus">-</span>
<a href="#l25.673"></a><span id="l25.673" class="difflineminus">-      self.postMessage({</span>
<a href="#l25.674"></a><span id="l25.674" class="difflineminus">-        msg: &quot;close&quot;</span>
<a href="#l25.675"></a><span id="l25.675" class="difflineminus">-      });</span>
<a href="#l25.676"></a><span id="l25.676" class="difflineminus">-      self.close();</span>
<a href="#l25.677"></a><span id="l25.677" class="difflineminus">-    }</span>
<a href="#l25.678"></a><span id="l25.678" class="difflineminus">-  },</span>
<a href="#l25.679"></a><span id="l25.679" class="difflineminus">-</span>
<a href="#l25.680"></a><span id="l25.680" class="difflineminus">-  getPipe(pipeId) {</span>
<a href="#l25.681"></a><span id="l25.681" class="difflineminus">-    let pipe = this.pipes.get(pipeId);</span>
<a href="#l25.682"></a><span id="l25.682" class="difflineminus">-</span>
<a href="#l25.683"></a><span id="l25.683" class="difflineminus">-    if (!pipe) {</span>
<a href="#l25.684"></a><span id="l25.684" class="difflineminus">-      let error = new Error(&quot;File closed&quot;);</span>
<a href="#l25.685"></a><span id="l25.685" class="difflineminus">-      error.errorCode = SubprocessConstants.ERROR_END_OF_FILE;</span>
<a href="#l25.686"></a><span id="l25.686" class="difflineminus">-      throw error;</span>
<a href="#l25.687"></a><span id="l25.687" class="difflineminus">-    }</span>
<a href="#l25.688"></a><span id="l25.688" class="difflineminus">-    return pipe;</span>
<a href="#l25.689"></a><span id="l25.689" class="difflineminus">-  },</span>
<a href="#l25.690"></a><span id="l25.690" class="difflineminus">-</span>
<a href="#l25.691"></a><span id="l25.691" class="difflineminus">-  getProcess(processId) {</span>
<a href="#l25.692"></a><span id="l25.692" class="difflineminus">-    let process = this.processes.get(processId);</span>
<a href="#l25.693"></a><span id="l25.693" class="difflineminus">-</span>
<a href="#l25.694"></a><span id="l25.694" class="difflineminus">-    if (!process) {</span>
<a href="#l25.695"></a><span id="l25.695" class="difflineminus">-      throw new Error(`Invalid process ID: ${processId}`);</span>
<a href="#l25.696"></a><span id="l25.696" class="difflineminus">-    }</span>
<a href="#l25.697"></a><span id="l25.697" class="difflineminus">-    return process;</span>
<a href="#l25.698"></a><span id="l25.698" class="difflineminus">-  },</span>
<a href="#l25.699"></a><span id="l25.699" class="difflineminus">-</span>
<a href="#l25.700"></a><span id="l25.700" class="difflineminus">-  updatePollEvents() {</span>
<a href="#l25.701"></a><span id="l25.701" class="difflineminus">-    let handlers = [this.signal,</span>
<a href="#l25.702"></a><span id="l25.702" class="difflineminus">-      ...this.pipes.values(),</span>
<a href="#l25.703"></a><span id="l25.703" class="difflineminus">-      ...this.processes.values()</span>
<a href="#l25.704"></a><span id="l25.704" class="difflineminus">-    ];</span>
<a href="#l25.705"></a><span id="l25.705" class="difflineminus">-</span>
<a href="#l25.706"></a><span id="l25.706" class="difflineminus">-    handlers = handlers.filter(handler =&gt; handler.event);</span>
<a href="#l25.707"></a><span id="l25.707" class="difflineminus">-</span>
<a href="#l25.708"></a><span id="l25.708" class="difflineminus">-    this.eventHandlers = handlers;</span>
<a href="#l25.709"></a><span id="l25.709" class="difflineminus">-</span>
<a href="#l25.710"></a><span id="l25.710" class="difflineminus">-    let handles = handlers.map(handler =&gt; handler.event);</span>
<a href="#l25.711"></a><span id="l25.711" class="difflineminus">-    this.events = win32.HANDLE.array()(handles);</span>
<a href="#l25.712"></a><span id="l25.712" class="difflineminus">-  },</span>
<a href="#l25.713"></a><span id="l25.713" class="difflineminus">-</span>
<a href="#l25.714"></a><span id="l25.714" class="difflineminus">-  loop() {</span>
<a href="#l25.715"></a><span id="l25.715" class="difflineminus">-    this.poll();</span>
<a href="#l25.716"></a><span id="l25.716" class="difflineminus">-    if (this.running) {</span>
<a href="#l25.717"></a><span id="l25.717" class="difflineminus">-      setTimeout(this.loop.bind(this), 0);</span>
<a href="#l25.718"></a><span id="l25.718" class="difflineminus">-    }</span>
<a href="#l25.719"></a><span id="l25.719" class="difflineminus">-  },</span>
<a href="#l25.720"></a><span id="l25.720" class="difflineminus">-</span>
<a href="#l25.721"></a><span id="l25.721" class="difflineminus">-</span>
<a href="#l25.722"></a><span id="l25.722" class="difflineminus">-  poll() {</span>
<a href="#l25.723"></a><span id="l25.723" class="difflineminus">-    let timeout = this.messageCount &gt; 0 ? 0 : POLL_TIMEOUT;</span>
<a href="#l25.724"></a><span id="l25.724" class="difflineminus">-    for (;; timeout = 0) {</span>
<a href="#l25.725"></a><span id="l25.725" class="difflineminus">-      let events = this.events;</span>
<a href="#l25.726"></a><span id="l25.726" class="difflineminus">-      let handlers = this.eventHandlers;</span>
<a href="#l25.727"></a><span id="l25.727" class="difflineminus">-</span>
<a href="#l25.728"></a><span id="l25.728" class="difflineminus">-      let result = libc.WaitForMultipleObjects(events.length, events,</span>
<a href="#l25.729"></a><span id="l25.729" class="difflineminus">-        false, timeout);</span>
<a href="#l25.730"></a><span id="l25.730" class="difflineminus">-</span>
<a href="#l25.731"></a><span id="l25.731" class="difflineminus">-      if (result &lt; handlers.length) {</span>
<a href="#l25.732"></a><span id="l25.732" class="difflineminus">-        try {</span>
<a href="#l25.733"></a><span id="l25.733" class="difflineminus">-          handlers[result].onReady();</span>
<a href="#l25.734"></a><span id="l25.734" class="difflineminus">-        } catch (e) {</span>
<a href="#l25.735"></a><span id="l25.735" class="difflineminus">-          console.error(e);</span>
<a href="#l25.736"></a><span id="l25.736" class="difflineminus">-          debug(`Worker error: ${e} :: ${e.stack}`);</span>
<a href="#l25.737"></a><span id="l25.737" class="difflineminus">-          handlers[result].onError();</span>
<a href="#l25.738"></a><span id="l25.738" class="difflineminus">-        }</span>
<a href="#l25.739"></a><span id="l25.739" class="difflineminus">-      }</span>
<a href="#l25.740"></a><span id="l25.740" class="difflineminus">-      else {</span>
<a href="#l25.741"></a><span id="l25.741" class="difflineminus">-        break;</span>
<a href="#l25.742"></a><span id="l25.742" class="difflineminus">-      }</span>
<a href="#l25.743"></a><span id="l25.743" class="difflineminus">-    }</span>
<a href="#l25.744"></a><span id="l25.744" class="difflineminus">-  },</span>
<a href="#l25.745"></a><span id="l25.745" class="difflineminus">-</span>
<a href="#l25.746"></a><span id="l25.746" class="difflineminus">-  addProcess(process) {</span>
<a href="#l25.747"></a><span id="l25.747" class="difflineminus">-    this.processes.set(process.id, process);</span>
<a href="#l25.748"></a><span id="l25.748" class="difflineminus">-</span>
<a href="#l25.749"></a><span id="l25.749" class="difflineminus">-    for (let pipe of process.pipes) {</span>
<a href="#l25.750"></a><span id="l25.750" class="difflineminus">-      this.pipes.set(pipe.id, pipe);</span>
<a href="#l25.751"></a><span id="l25.751" class="difflineminus">-    }</span>
<a href="#l25.752"></a><span id="l25.752" class="difflineminus">-  },</span>
<a href="#l25.753"></a><span id="l25.753" class="difflineminus">-</span>
<a href="#l25.754"></a><span id="l25.754" class="difflineminus">-  cleanupProcess(process) {</span>
<a href="#l25.755"></a><span id="l25.755" class="difflineminus">-    this.processes.delete(process.id);</span>
<a href="#l25.756"></a><span id="l25.756" class="difflineminus">-  }</span>
<a href="#l25.757"></a><span id="l25.757" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/errorHandling.jsm</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/errorHandling.jsm</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -7,17 +7,16 @@</span>
<a href="#l26.4"></a><span id="l26.4"> &quot;use strict&quot;;</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> var EXPORTED_SYMBOLS = [&quot;EnigmailErrorHandling&quot;];</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l26.9"></a><span id="l26.9"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l26.10"></a><span id="l26.10"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l26.11"></a><span id="l26.11"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-const EnigmailSystem = ChromeUtils.import(&quot;chrome://openpgp/content/modules/system.jsm&quot;).EnigmailSystem;</span>
<a href="#l26.13"></a><span id="l26.13"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l26.14"></a><span id="l26.14"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16"> const getEnigmailKeyRing = EnigmailLazy.loader(&quot;enigmail/keyRing.jsm&quot;, &quot;EnigmailKeyRing&quot;);</span>
<a href="#l26.17"></a><span id="l26.17"> const getEnigmailGpg = EnigmailLazy.loader(&quot;enigmail/gpg.jsm&quot;, &quot;EnigmailGpg&quot;);</span>
<a href="#l26.18"></a><span id="l26.18"> const getEnigmailFiles = EnigmailLazy.loader(&quot;enigmail/files.jsm&quot;, &quot;EnigmailFiles&quot;);</span>
<a href="#l26.19"></a><span id="l26.19"> const getEnigmailRNG = EnigmailLazy.loader(&quot;enigmail/rng.jsm&quot;, &quot;EnigmailRNG&quot;);</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineat">@@ -124,17 +123,17 @@ function handleErrorCode(c, errorNumber)</span>
<a href="#l26.22"></a><span id="l26.22">         c.retStatusObj.extendedStatus += &quot;disp:get_passphrase &quot;;</span>
<a href="#l26.23"></a><span id="l26.23">         c.retStatusObj.statusMsg = EnigmailLocale.getString(&quot;errorHandling.pinentryError&quot;) + &quot;\n\n&quot; + EnigmailLocale.getString(&quot;errorHandling.readFaq&quot;);</span>
<a href="#l26.24"></a><span id="l26.24">         c.isError = true;</span>
<a href="#l26.25"></a><span id="l26.25">         break;</span>
<a href="#l26.26"></a><span id="l26.26">       case 92: // no dirmngr</span>
<a href="#l26.27"></a><span id="l26.27">       case 93: // dirmngr error</span>
<a href="#l26.28"></a><span id="l26.28">         c.statusFlags |= EnigmailConstants.DISPLAY_MESSAGE;</span>
<a href="#l26.29"></a><span id="l26.29">         c.retStatusObj.extendedStatus += &quot;disp:get_passphrase &quot;;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-        c.retStatusObj.statusMsg = EnigmailLocale.getString(&quot;errorHandling.dirmngrError&quot;) + &quot;\n\n&quot; + EnigmailLocale.getString(&quot;errorHandling.readFaq&quot;);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+        c.retStatusObj.statusMsg = &quot;&quot;;</span>
<a href="#l26.32"></a><span id="l26.32">         c.isError = true;</span>
<a href="#l26.33"></a><span id="l26.33">         break;</span>
<a href="#l26.34"></a><span id="l26.34">       case 2:</span>
<a href="#l26.35"></a><span id="l26.35">       case 3:</span>
<a href="#l26.36"></a><span id="l26.36">       case 149:</span>
<a href="#l26.37"></a><span id="l26.37">       case 188:</span>
<a href="#l26.38"></a><span id="l26.38">         c.statusFlags |= EnigmailConstants.UNKNOWN_ALGO;</span>
<a href="#l26.39"></a><span id="l26.39">         break;</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineat">@@ -479,72 +478,17 @@ function buildErrorMessageForCardCtrl(c,</span>
<a href="#l26.41"></a><span id="l26.41">       break;</span>
<a href="#l26.42"></a><span id="l26.42">     case 5:</span>
<a href="#l26.43"></a><span id="l26.43">       errorMsg = EnigmailLocale.getString(&quot;sc.noReaderAvailable&quot;);</span>
<a href="#l26.44"></a><span id="l26.44">       break;</span>
<a href="#l26.45"></a><span id="l26.45">   }</span>
<a href="#l26.46"></a><span id="l26.46">   return errorMsg;</span>
<a href="#l26.47"></a><span id="l26.47"> }</span>
<a href="#l26.48"></a><span id="l26.48"> </span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-function parseErrorOutputWith(c) {</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  EnigmailLog.DEBUG(&quot;errorHandling.jsm: parseErrorOutputWith: status message: \n&quot; + c.errOutput + &quot;\n&quot;);</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-  c.errLines = splitErrorOutput(c.errOutput);</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  c.isError = false; // set to true if a hard error was found</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  // parse all error lines</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-  c.inDecryptionFailed = false; // to save details of encryption failed messages</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-  for (var j = 0; j &lt; c.errLines.length; j++) {</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-    var errLine = c.errLines[j];</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-    parseErrorLine(errLine, c);</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-    if (c.isError) break;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-  }</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  detectForgedInsets(c);</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-  c.retStatusObj.blockSeparation = c.retStatusObj.blockSeparation.replace(/ $/, &quot;&quot;);</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-  c.retStatusObj.statusFlags = c.statusFlags;</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-  if (c.retStatusObj.statusMsg.length === 0) c.retStatusObj.statusMsg = c.statusArray.join(&quot;\n&quot;);</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-  if (c.errorMsg.length === 0) {</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-    c.errorMsg = c.errArray.map(function f(str, idx) {</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-      return EnigmailSystem.convertNativeToUnicode(str);</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-    }, EnigmailSystem).join(&quot;\n&quot;);</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-  } else {</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-    c.errorMsg = EnigmailSystem.convertNativeToUnicode(c.errorMsg);</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-  }</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineminus">-</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineminus">-  if ((c.statusFlags &amp; EnigmailConstants.CARDCTRL) &amp;&amp; c.errCode &gt; 0) {</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineminus">-    c.errorMsg = buildErrorMessageForCardCtrl(c, c.errCode, c.detectedCard);</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineminus">-    c.statusFlags |= EnigmailConstants.DISPLAY_MESSAGE;</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-  }</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-  let inDecryption = 0;</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-  let m;</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-  for (let i in c.statusArray) {</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineminus">-    if (c.statusArray[i].search(/^BEGIN_DECRYPTION( .*)?$/) === 0) {</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineminus">-      inDecryption = 1;</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-    } else if (c.statusArray[i].search(/^END_DECRYPTION( .*)?$/) === 0) {</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-      inDecryption = 0;</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-    } else if (inDecryption &gt;0) {</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-      m = c.statusArray[i].match(/^(PLAINTEXT [0-9]+ [0-9]+ )(.*)$/);</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineminus">-      if (m &amp;&amp; m.length &gt;= 3) c.retStatusObj.encryptedFileName = m[2];        </span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-    }</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-  }</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-  EnigmailLog.DEBUG(&quot;errorHandling.jsm: parseErrorOutputWith: statusFlags = &quot; + EnigmailData.bytesToHex(EnigmailData.pack(c.statusFlags, 4)) + &quot;\n&quot;);</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-  EnigmailLog.DEBUG(&quot;errorHandling.jsm: parseErrorOutputWith: return with c.errorMsg = &quot; + c.errorMsg + &quot;\n&quot;);</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineminus">-  return c.errorMsg;</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-}</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-</span>
<a href="#l26.99"></a><span id="l26.99"> var EnigmailErrorHandling = {</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-  parseErrorOutput: function(errOutput, retStatusObj) {</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-    var context = newContext(errOutput, retStatusObj);</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineminus">-    return parseErrorOutputWith(context);</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineminus">-  },</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-</span>
<a href="#l26.105"></a><span id="l26.105">   /**</span>
<a href="#l26.106"></a><span id="l26.106">    * Determin why a given key or userID cannot be used for signing</span>
<a href="#l26.107"></a><span id="l26.107">    *</span>
<a href="#l26.108"></a><span id="l26.108">    * @param keySpec String - key ID or user ID</span>
<a href="#l26.109"></a><span id="l26.109">    *</span>
<a href="#l26.110"></a><span id="l26.110">    * @return String - the reason(s) as message to display to the user</span>
<a href="#l26.111"></a><span id="l26.111">    *                  &quot;&quot; in case the key is valid</span>
<a href="#l26.112"></a><span id="l26.112">    */</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineat">@@ -634,9 +578,9 @@ var EnigmailErrorHandling = {</span>
<a href="#l26.114"></a><span id="l26.114">       let logData = getEnigmailFiles().readFile(logFile);</span>
<a href="#l26.115"></a><span id="l26.115"> </span>
<a href="#l26.116"></a><span id="l26.116">       EnigmailLog.DEBUG(`errorHandling.jsm: Process terminated. Human-readable output from gpg:\n-----\n${logData}-----\n`);</span>
<a href="#l26.117"></a><span id="l26.117">       try {</span>
<a href="#l26.118"></a><span id="l26.118">         logFile.remove(false);</span>
<a href="#l26.119"></a><span id="l26.119">       } catch (ex) {}</span>
<a href="#l26.120"></a><span id="l26.120">     }</span>
<a href="#l26.121"></a><span id="l26.121">   }</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineminus">-};</span>
<a href="#l26.123"></a><span id="l26.123">\ No newline at end of file</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/execution.jsm</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,525 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-/*</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">- */</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-const EXPORTED_SYMBOLS = [&quot;EnigmailExecution&quot;];</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-const EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-const loadOS = EnigmailLazy.loader(&quot;enigmail/os.jsm&quot;, &quot;EnigmailOS&quot;);</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-var EnigmailExecution = {</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-  agentType: &quot;&quot;,</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-  /**</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-   * execStart Listener Object</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-   *</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-   * The listener object must implement at least the following methods:</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-   *</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-   *  stdin(pipe)    - OPTIONAL - write data to subprocess stdin via |pipe| hanlde</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-   *  stdout(data)   - receive |data| from subprocess stdout</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-   *  stderr(data)   - receive |data| from subprocess stderr</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-   *  done(exitCode) - receive signal when subprocess has terminated</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-   */</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-  /**</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-   *  start a subprocess (usually gpg) that gets and/or receives data via stdin/stdout/stderr.</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-   *</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-   * @param {String/nsIFile}  command: either full path to executable</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-   *                                    or: object referencing executable</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-   * @param {Array of Strings}   args: command line parameters for executable</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-   * @param {Boolean}  needPassphrase: is a passphrase required for the action?</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-   *                                   (this is currently a no-op)</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-   * @param {nsIWindow}     domWindow: window on top of which password dialog is shown</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-   * @param {Object}         listener: Listener to interact with subprocess; see spec. above</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-   * @param {Object}   statusflagsObj: .value will hold status Flags</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-   *</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-   * @return {Object}:         handle to subprocess</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-   */</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-  execStart: function(command, args, needPassphrase, domWindow, listener, statusFlagsObj) {</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-    EnigmailLog.WRITE(&quot;execution.jsm: execStart: &quot; +</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-      &quot;command = &quot; + EnigmailFiles.formatCmdLine(command, args) +</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-      &quot;, needPassphrase=&quot; + needPassphrase +</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-      &quot;, domWindow=&quot; + domWindow +</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-      &quot;, listener=&quot; + listener + &quot;\n&quot;);</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-    listener = listener || {};</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-    statusFlagsObj.value = 0;</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-    let proc = null;</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-    listener.command = command;</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineminus">-</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineminus">-    try {</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-      proc = subprocess.call({</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-        command: command,</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-        arguments: args,</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-        environment: EnigmailCore.getEnvList(),</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineminus">-        charset: null,</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-        bufferedOutput: true,</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-        stdin: function(pipe) {</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-          if (listener.stdin) listener.stdin(pipe);</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-        },</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-        stdout: function(data) {</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-          listener.stdout(data);</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineminus">-        },</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-        stderr: function(data) {</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-          listener.stderr(data);</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-        },</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-        done: function(result) {</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineminus">-          try {</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-            listener.done(result.exitCode);</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-          }</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-          catch (ex) {</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-            EnigmailLog.writeException(&quot;execution.jsm&quot;, ex);</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-          }</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineminus">-        },</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-        mergeStderr: false</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-      });</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-    }</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-    catch (ex) {</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-      EnigmailLog.ERROR(&quot;execution.jsm: execStart: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-      EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-      return null;</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-    }</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE\n&quot;);</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-    return proc;</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-  },</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineminus">-</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineminus">-  /*</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-   requirements for listener object:</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-   exitCode</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-   stderrData</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-   */</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-  execEnd: function(listener, statusFlagsObj, statusMsgObj, cmdLineObj, errorMsgObj, blockSeparationObj) {</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: execEnd:\n&quot;);</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-    cmdLineObj.value = listener.command;</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineminus">-</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineminus">-    let exitCode = listener.exitCode;</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineminus">-    const errOutput = listener.stderrData;</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: execEnd: exitCode = &quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: execEnd: errOutput = &quot; + errOutput.substr(0, 500) + &quot;\n&quot;);</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineminus">-    const retObj = {};</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-    errorMsgObj.value = EnigmailErrorHandling.parseErrorOutput(errOutput, retObj);</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-    statusFlagsObj.value = retObj.statusFlags;</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineminus">-    statusMsgObj.value = retObj.statusMsg;</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-    statusFlagsObj.encryptedFileName = retObj.encryptedFileName;</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">-    if (!blockSeparationObj) blockSeparationObj = {};</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-    blockSeparationObj.value = retObj.blockSeparation;</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-    if (errOutput.search(/jpeg image of size \d+/) &gt; -1) {</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-      statusFlagsObj.value |= EnigmailConstants.PHOTO_AVAILABLE;</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineminus">-    }</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-    if (blockSeparationObj &amp;&amp; blockSeparationObj.value.indexOf(&quot; &quot;) &gt; 0) {</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-      exitCode = 2;</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-    }</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineminus">-    EnigmailLog.CONSOLE(EnigmailData.convertFromUnicode(errorMsgObj.value) + &quot;\n&quot;);</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineminus">-</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineminus">-    return exitCode;</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-  },</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineminus">-</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-  /**</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-   * Resolve the path to the command and execute it if available</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-   * Returns output from simpleExecCmd</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineminus">-   */</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-  resolveAndSimpleExec: function(command, args, exitCodeObj, errorMsgObj) {</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-    const resolvedCommand = EnigmailFiles.resolvePathWithEnv(command);</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-    if (resolvedCommand === null) {</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-      return null;</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-    }</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-    return EnigmailExecution.simpleExecCmd(resolvedCommand, args, exitCodeObj, errorMsgObj);</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-  },</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineminus">-</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-  /**</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineminus">-   * Execute a command and return the output from stdout</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-   * No input and no statusFlags are returned.</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-   */</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineminus">-  simpleExecCmd: function(command, args, exitCodeObj, errorMsgObj) {</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-    EnigmailLog.WRITE(&quot;execution.jsm: EnigmailExecution.simpleExecCmd: command = &quot; + command + &quot; &quot; + args.join(&quot; &quot;) + &quot;\n&quot;);</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">-    let outputData = &quot;&quot;;</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-    let errOutput = &quot;&quot;;</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-    errorMsgObj.value = &quot;&quot;;</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-    exitCodeObj.value = -1;</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-    try {</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-      subprocess.call({</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-        command: command,</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-        arguments: args,</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-        charset: null,</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-        environment: EnigmailCore.getEnvList(),</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineminus">-        done: function(result) {</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">-          exitCodeObj.value = result.exitCode;</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-          outputData = result.stdout;</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-          errOutput = result.stderr;</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-        },</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineminus">-        mergeStderr: false</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineminus">-      }).wait();</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineminus">-    }</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-    catch (ex) {</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineminus">-      EnigmailLog.ERROR(&quot;execution.jsm: EnigmailExecution.simpleExecCmd: &quot; + command.path + &quot; failed\n&quot;);</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineminus">-      EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineminus">-      exitCodeObj.value = -1;</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-    }</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE\n&quot;);</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineminus">-</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineminus">-    if (errOutput) {</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineminus">-      errorMsgObj.value = errOutput;</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineminus">-    }</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">-</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: EnigmailExecution.simpleExecCmd: exitCode = &quot; + exitCodeObj.value + &quot;\n&quot;);</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: EnigmailExecution.simpleExecCmd: errOutput = &quot; + errOutput.substr(0, 500) + &quot;\n&quot;);</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineminus">-</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineminus">-    return outputData;</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-  },</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineminus">-  /**</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-   * Execute a command and return the output from stdout.</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineminus">-   * Accepts input and returns error message and statusFlags.</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineminus">-   */</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineminus">-  execCmd: function(command, args, input, exitCodeObj, statusFlagsObj, statusMsgObj,</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineminus">-    errorMsgObj, retStatusObj) {</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-    EnigmailLog.WRITE(&quot;execution.jsm: EnigmailExecution.execCmd: subprocess = '&quot; + command.path + &quot;'\n&quot;);</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineminus">-    if ((typeof input) != &quot;string&quot;) input = &quot;&quot;;</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineminus">-</span>
<a href="#l27.212"></a><span id="l27.212" class="difflineminus">-    let preInput = &quot;&quot;;</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineminus">-    let outputData = &quot;&quot;;</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineminus">-    let errOutput = &quot;&quot;;</span>
<a href="#l27.215"></a><span id="l27.215" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l27.216"></a><span id="l27.216" class="difflineminus">-</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-    const procBuilder = new EnigmailExecution.processBuilder();</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineminus">-    procBuilder.setCommand(command);</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineminus">-    procBuilder.setArguments(args);</span>
<a href="#l27.220"></a><span id="l27.220" class="difflineminus">-    procBuilder.setEnvironment(EnigmailCore.getEnvList());</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineminus">-    procBuilder.setStdin(</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineminus">-      function(pipe) {</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-        if (input.length &gt; 0 || preInput.length &gt; 0) {</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-          pipe.write(preInput + input);</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-        }</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineminus">-        pipe.close();</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineminus">-      }</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineminus">-    );</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineminus">-    procBuilder.setStdout(</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineminus">-      function(data) {</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineminus">-        outputData += data;</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineminus">-      }</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">-    );</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineminus">-    procBuilder.setStderr(</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineminus">-      function(data) {</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineminus">-        errOutput += data;</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineminus">-      }</span>
<a href="#l27.238"></a><span id="l27.238" class="difflineminus">-    );</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineminus">-    procBuilder.setDone(</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-      function(result) {</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineminus">-        exitCodeObj.value = result.exitCode;</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-      }</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineminus">-    );</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineminus">-</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-    const proc = procBuilder.build();</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineminus">-    try {</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineminus">-      subprocess.call(proc).wait();</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineminus">-    }</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-    catch (ex) {</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineminus">-      EnigmailLog.ERROR(&quot;execution.jsm: EnigmailExecution.execCmd: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineminus">-      EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineminus">-      exitCodeObj.value = -1;</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineminus">-    }</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE\n&quot;);</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-    if (proc.resultData) outputData = proc.resultData;</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-    if (proc.errorData) errOutput = proc.errorData;</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: EnigmailExecution.execCmd: exitCode = &quot; + exitCodeObj.value + &quot;\n&quot;);</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: EnigmailExecution.execCmd: errOutput = &quot; + errOutput.substr(0, 500) + &quot;\n&quot;);</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineminus">-</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineminus">-    if (!retStatusObj) {</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineminus">-      retStatusObj = {};</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-    }</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineminus">-    errorMsgObj.value = EnigmailErrorHandling.parseErrorOutput(errOutput, retStatusObj);</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineminus">-</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-    statusFlagsObj.value = retStatusObj.statusFlags;</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineminus">-    statusMsgObj.value = retStatusObj.statusMsg;</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineminus">-    const blockSeparation = retStatusObj.blockSeparation;</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineminus">-</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-    exitCodeObj.value = EnigmailExecution.fixExitCode(exitCodeObj.value, statusFlagsObj);</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-    if (blockSeparation.indexOf(&quot; &quot;) &gt; 0) {</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-      exitCodeObj.value = 2;</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-    }</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineminus">-</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineminus">-    EnigmailLog.CONSOLE(errorMsgObj.value + &quot;\n&quot;);</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineminus">-</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineminus">-    return outputData;</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-  },</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineminus">-</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineminus">-  /**</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineminus">-   * Execute a command and asynchronously, and return a Promise</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineminus">-   * Accepts input and returns error message and statusFlags.</span>
<a href="#l27.287"></a><span id="l27.287" class="difflineminus">-   *</span>
<a href="#l27.288"></a><span id="l27.288" class="difflineminus">-   * @param {String/nsIFile}  command: either full path to executable</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineminus">-   *                                    or: object referencing executable</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineminus">-   * @param {Array of Strings}   args: command line parameters for executable</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineminus">-   * @param {String}            input: data to pass to subprocess via stdin</span>
<a href="#l27.292"></a><span id="l27.292" class="difflineminus">-   * @param {Object} subprocessHandle: handle to subprocess. The subprocess may be</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-   *                        killed via subprocessHandle.value.killProcess();</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-   *</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineminus">-   * @return {Promise&lt;Object&gt;}: Object with:</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineminus">-   *        - {Number} exitCode</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineminus">-   *        - {String} stdoutData  - unmodified data from stdout</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineminus">-   *        - {String} stderrData  - unmodified data from stderr</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineminus">-   *        - {String} errorMsg    - error message from parseErrorOutput()</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineminus">-   *        - {Number} statusFlags</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineminus">-   *        - {String} statusMsg   - pre-processed status messages (without [GNUPG:])</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineminus">-   *        - blockSeparation</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineminus">-   *        - isKilled: 0</span>
<a href="#l27.304"></a><span id="l27.304" class="difflineminus">-   */</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineminus">-  execAsync: function(command, args, input, subprocessHandle = null) {</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineminus">-    EnigmailLog.WRITE(&quot;execution.jsm: execAsync: command = '&quot; + command.path + &quot;'\n&quot;);</span>
<a href="#l27.308"></a><span id="l27.308" class="difflineminus">-    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineminus">-</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineminus">-      if ((typeof input) != &quot;string&quot;) input = &quot;&quot;;</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineminus">-</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineminus">-      let outputData = &quot;&quot;;</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-      let errOutput = &quot;&quot;;</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-      let returnObj = {</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineminus">-        exitCode: -1,</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineminus">-        stdoutData: &quot;&quot;,</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-        stderrData: &quot;&quot;,</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineminus">-        errorMsg: &quot;&quot;,</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineminus">-        statusFlags: 0,</span>
<a href="#l27.320"></a><span id="l27.320" class="difflineminus">-        statusMsg: &quot;&quot;,</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineminus">-        blockSeparation: &quot;&quot;,</span>
<a href="#l27.322"></a><span id="l27.322" class="difflineminus">-        isKilled: 0</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineminus">-      };</span>
<a href="#l27.324"></a><span id="l27.324" class="difflineminus">-</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineminus">-      EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineminus">-      EnigmailLog.CONSOLE(input + &quot;\n&quot;);</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineminus">-</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineminus">-      const procBuilder = new EnigmailExecution.processBuilder();</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineminus">-      procBuilder.setCommand(command);</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineminus">-      procBuilder.setArguments(args);</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineminus">-      procBuilder.setEnvironment(EnigmailCore.getEnvList());</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineminus">-      procBuilder.setStdin(</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-        function(pipe) {</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineminus">-          if (input.length &gt; 0) {</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineminus">-            pipe.write(input);</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineminus">-          }</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineminus">-          pipe.close();</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineminus">-        }</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineminus">-      );</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineminus">-      procBuilder.setStdout(</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineminus">-        function(data) {</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineminus">-          outputData += data;</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineminus">-        }</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineminus">-      );</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineminus">-      procBuilder.setStderr(</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineminus">-        function(data) {</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineminus">-          errOutput += data;</span>
<a href="#l27.348"></a><span id="l27.348" class="difflineminus">-        }</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineminus">-      );</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineminus">-</span>
<a href="#l27.351"></a><span id="l27.351" class="difflineminus">-      procBuilder.setDone(</span>
<a href="#l27.352"></a><span id="l27.352" class="difflineminus">-        function(result) {</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineminus">-          let exitCode = result.exitCode;</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-          EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE\n&quot;);</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineminus">-          EnigmailLog.DEBUG(&quot;execution.jsm: execAsync: exitCode = &quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineminus">-          EnigmailLog.DEBUG(&quot;execution.jsm: execAsync: errOutput = &quot; + errOutput.substr(0, 500) + &quot;\n&quot;);</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineminus">-</span>
<a href="#l27.358"></a><span id="l27.358" class="difflineminus">-          let retStatusObj = {};</span>
<a href="#l27.359"></a><span id="l27.359" class="difflineminus">-          let errorMsg = EnigmailErrorHandling.parseErrorOutput(errOutput, retStatusObj);</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineminus">-</span>
<a href="#l27.361"></a><span id="l27.361" class="difflineminus">-          let statusFlagsObj = {</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineminus">-            value: retStatusObj.statusFlags</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineminus">-          };</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineminus">-</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineminus">-          exitCode = EnigmailExecution.fixExitCode(exitCode, statusFlagsObj);</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineminus">-</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineminus">-          if (retStatusObj.blockSeparation.indexOf(&quot; &quot;) &gt; 0) {</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineminus">-            exitCode = 2;</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineminus">-          }</span>
<a href="#l27.370"></a><span id="l27.370" class="difflineminus">-</span>
<a href="#l27.371"></a><span id="l27.371" class="difflineminus">-          EnigmailLog.CONSOLE(errorMsg + &quot;\n&quot;);</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineminus">-          returnObj.exitCode = exitCode;</span>
<a href="#l27.373"></a><span id="l27.373" class="difflineminus">-          returnObj.stdoutData = outputData;</span>
<a href="#l27.374"></a><span id="l27.374" class="difflineminus">-          returnObj.stderrData = errOutput;</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineminus">-          returnObj.errorMsg = errorMsg;</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineminus">-          returnObj.statusFlags = statusFlagsObj.value;</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineminus">-          returnObj.statusMsg = retStatusObj.statusMsg;</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineminus">-          returnObj.blockSeparation = retStatusObj.blockSeparation;</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineminus">-          resolve(returnObj);</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineminus">-        }</span>
<a href="#l27.382"></a><span id="l27.382" class="difflineminus">-      );</span>
<a href="#l27.383"></a><span id="l27.383" class="difflineminus">-      const proc = procBuilder.build();</span>
<a href="#l27.384"></a><span id="l27.384" class="difflineminus">-      try {</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineminus">-        let p = subprocess.call(proc);</span>
<a href="#l27.386"></a><span id="l27.386" class="difflineminus">-        if (subprocessHandle) {</span>
<a href="#l27.387"></a><span id="l27.387" class="difflineminus">-          p.killProcess = function(hardKill) {</span>
<a href="#l27.388"></a><span id="l27.388" class="difflineminus">-            returnObj.isKilled = 1;</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineminus">-            this.kill(hardKill);</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-          };</span>
<a href="#l27.391"></a><span id="l27.391" class="difflineminus">-          subprocessHandle.value = p;</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineminus">-        }</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineminus">-      }</span>
<a href="#l27.394"></a><span id="l27.394" class="difflineminus">-      catch (ex) {</span>
<a href="#l27.395"></a><span id="l27.395" class="difflineminus">-        EnigmailLog.ERROR(&quot;execution.jsm: execAsync: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineminus">-        EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineminus">-        reject(returnObj);</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineminus">-      }</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineminus">-    });</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineminus">-  },</span>
<a href="#l27.401"></a><span id="l27.401" class="difflineminus">-</span>
<a href="#l27.402"></a><span id="l27.402" class="difflineminus">-  /**</span>
<a href="#l27.403"></a><span id="l27.403" class="difflineminus">-   * Fix the exit code of GnuPG (which may be wrong in some circumstances)</span>
<a href="#l27.404"></a><span id="l27.404" class="difflineminus">-   *</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineminus">-   * @exitCode:       Number - the exitCode obtained from GnuPG</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineminus">-   * @statusFlagsObj: Object - the statusFlagsObj as received from parseErrorOutput()</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineminus">-   *</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineminus">-   * @return: Number - fixed exit code</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineminus">-   */</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineminus">-  fixExitCode: function(exitCode, statusFlagsObj) {</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineminus">-    EnigmailLog.DEBUG(&quot;execution.jsm: EnigmailExecution.fixExitCode: agentType: &quot; + EnigmailExecution.agentType + &quot; exitCode: &quot; + exitCode + &quot; statusFlags &quot; + statusFlagsObj.statusFlags + &quot;\n&quot;);</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineminus">-</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineminus">-    const statusFlags = statusFlagsObj.statusFlags;</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineminus">-</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineminus">-    if (exitCode !== 0) {</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineminus">-      if ((statusFlags &amp; (EnigmailConstants.BAD_PASSPHRASE | EnigmailConstants.UNVERIFIED_SIGNATURE)) &amp;&amp;</span>
<a href="#l27.417"></a><span id="l27.417" class="difflineminus">-        (statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY)) {</span>
<a href="#l27.418"></a><span id="l27.418" class="difflineminus">-        EnigmailLog.DEBUG(&quot;enigmailCommon.jsm: Enigmail.fixExitCode: Changing exitCode for decrypted msg &quot; + exitCode + &quot;-&gt;0\n&quot;);</span>
<a href="#l27.419"></a><span id="l27.419" class="difflineminus">-        exitCode = 0;</span>
<a href="#l27.420"></a><span id="l27.420" class="difflineminus">-      }</span>
<a href="#l27.421"></a><span id="l27.421" class="difflineminus">-      if ((EnigmailExecution.agentType === &quot;gpg&quot;) &amp;&amp; (exitCode == 256) &amp;&amp; (loadOS().getOS() == &quot;WINNT&quot;)) {</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineminus">-        EnigmailLog.WARNING(&quot;enigmailCommon.jsm: Enigmail.fixExitCode: Using gpg and exit code is 256. You seem to use cygwin-gpg, activating countermeasures.\n&quot;);</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineminus">-        if (statusFlags &amp; (EnigmailConstants.BAD_PASSPHRASE | EnigmailConstants.UNVERIFIED_SIGNATURE)) {</span>
<a href="#l27.424"></a><span id="l27.424" class="difflineminus">-          EnigmailLog.WARNING(&quot;enigmailCommon.jsm: Enigmail.fixExitCode: Changing exitCode 256-&gt;2\n&quot;);</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineminus">-          exitCode = 2;</span>
<a href="#l27.426"></a><span id="l27.426" class="difflineminus">-        }</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineminus">-        else {</span>
<a href="#l27.428"></a><span id="l27.428" class="difflineminus">-          EnigmailLog.WARNING(&quot;enigmailCommon.jsm: Enigmail.fixExitCode: Changing exitCode 256-&gt;0\n&quot;);</span>
<a href="#l27.429"></a><span id="l27.429" class="difflineminus">-          exitCode = 0;</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineminus">-        }</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineminus">-      }</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineminus">-    }</span>
<a href="#l27.433"></a><span id="l27.433" class="difflineminus">-    else {</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineminus">-      if (statusFlags &amp; (EnigmailConstants.INVALID_RECIPIENT | EnigmailConstants.DECRYPTION_FAILED | EnigmailConstants.BAD_ARMOR |</span>
<a href="#l27.435"></a><span id="l27.435" class="difflineminus">-          EnigmailConstants.MISSING_PASSPHRASE | EnigmailConstants.BAD_PASSPHRASE)) {</span>
<a href="#l27.436"></a><span id="l27.436" class="difflineminus">-        exitCode = 1;</span>
<a href="#l27.437"></a><span id="l27.437" class="difflineminus">-      }</span>
<a href="#l27.438"></a><span id="l27.438" class="difflineminus">-      else if (typeof(statusFlagsObj.extendedStatus) === &quot;string&quot; &amp;&amp; statusFlagsObj.extendedStatus.search(/\bdisp:/) &gt;= 0) {</span>
<a href="#l27.439"></a><span id="l27.439" class="difflineminus">-        exitCode = 1;</span>
<a href="#l27.440"></a><span id="l27.440" class="difflineminus">-      }</span>
<a href="#l27.441"></a><span id="l27.441" class="difflineminus">-    }</span>
<a href="#l27.442"></a><span id="l27.442" class="difflineminus">-</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineminus">-    return exitCode;</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineminus">-  },</span>
<a href="#l27.445"></a><span id="l27.445" class="difflineminus">-</span>
<a href="#l27.446"></a><span id="l27.446" class="difflineminus">-  processBuilder: function() {</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineminus">-    this.process = {};</span>
<a href="#l27.448"></a><span id="l27.448" class="difflineminus">-    this.setCommand = function(command) {</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineminus">-      this.process.command = command;</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineminus">-    };</span>
<a href="#l27.451"></a><span id="l27.451" class="difflineminus">-    this.setArguments = function(args) {</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineminus">-      this.process.arguments = args;</span>
<a href="#l27.453"></a><span id="l27.453" class="difflineminus">-    };</span>
<a href="#l27.454"></a><span id="l27.454" class="difflineminus">-    this.setEnvironment = function(envList) {</span>
<a href="#l27.455"></a><span id="l27.455" class="difflineminus">-      this.process.environment = envList;</span>
<a href="#l27.456"></a><span id="l27.456" class="difflineminus">-    };</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineminus">-    this.setStdin = function(stdin) {</span>
<a href="#l27.458"></a><span id="l27.458" class="difflineminus">-      this.process.stdin = stdin;</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineminus">-    };</span>
<a href="#l27.460"></a><span id="l27.460" class="difflineminus">-    this.setStdout = function(stdout) {</span>
<a href="#l27.461"></a><span id="l27.461" class="difflineminus">-      this.process.stdout = stdout;</span>
<a href="#l27.462"></a><span id="l27.462" class="difflineminus">-    };</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineminus">-    this.setStderr = function(stderr) {</span>
<a href="#l27.464"></a><span id="l27.464" class="difflineminus">-      this.process.stderr = stderr;</span>
<a href="#l27.465"></a><span id="l27.465" class="difflineminus">-    };</span>
<a href="#l27.466"></a><span id="l27.466" class="difflineminus">-    this.setDone = function(done) {</span>
<a href="#l27.467"></a><span id="l27.467" class="difflineminus">-      this.process.done = done;</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineminus">-    };</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineminus">-    this.build = function() {</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineminus">-      this.process.charset = null;</span>
<a href="#l27.471"></a><span id="l27.471" class="difflineminus">-      this.process.mergeStderr = false;</span>
<a href="#l27.472"></a><span id="l27.472" class="difflineminus">-      this.process.resultData = &quot;&quot;;</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineminus">-      this.process.errorData = &quot;&quot;;</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineminus">-      this.process.exitCode = -1;</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineminus">-      return this.process;</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineminus">-    };</span>
<a href="#l27.477"></a><span id="l27.477" class="difflineminus">-    return this;</span>
<a href="#l27.478"></a><span id="l27.478" class="difflineminus">-  },</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineminus">-</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineminus">-  execCmd2: function(command, args, stdinFunc, stdoutFunc, doneFunc) {</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineminus">-    const procBuilder = new EnigmailExecution.processBuilder();</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineminus">-    procBuilder.setCommand(command);</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineminus">-    procBuilder.setArguments(args);</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineminus">-    procBuilder.setEnvironment(EnigmailCore.getEnvList());</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineminus">-    procBuilder.setStdin(stdinFunc);</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineminus">-    procBuilder.setStdout(stdoutFunc);</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineminus">-    procBuilder.setDone(doneFunc);</span>
<a href="#l27.489"></a><span id="l27.489" class="difflineminus">-    const proc = procBuilder.build();</span>
<a href="#l27.490"></a><span id="l27.490" class="difflineminus">-    subprocess.call(proc).wait();</span>
<a href="#l27.491"></a><span id="l27.491" class="difflineminus">-  },</span>
<a href="#l27.492"></a><span id="l27.492" class="difflineminus">-</span>
<a href="#l27.493"></a><span id="l27.493" class="difflineminus">-</span>
<a href="#l27.494"></a><span id="l27.494" class="difflineminus">-  /**</span>
<a href="#l27.495"></a><span id="l27.495" class="difflineminus">-   * simple listener for using with execStart</span>
<a href="#l27.496"></a><span id="l27.496" class="difflineminus">-   *</span>
<a href="#l27.497"></a><span id="l27.497" class="difflineminus">-   * stdinFunc: optional function to write to stdin</span>
<a href="#l27.498"></a><span id="l27.498" class="difflineminus">-   * doneFunc : optional function that is called when the process is terminated</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineminus">-   */</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineminus">-  newSimpleListener: function(stdinFunc, doneFunc) {</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineminus">-    const simpleListener = {</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineminus">-      stdoutData: &quot;&quot;,</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineminus">-      stderrData: &quot;&quot;,</span>
<a href="#l27.504"></a><span id="l27.504" class="difflineminus">-      exitCode: -1,</span>
<a href="#l27.505"></a><span id="l27.505" class="difflineminus">-      stdin: function(pipe) {</span>
<a href="#l27.506"></a><span id="l27.506" class="difflineminus">-        if (stdinFunc) {</span>
<a href="#l27.507"></a><span id="l27.507" class="difflineminus">-          stdinFunc(pipe);</span>
<a href="#l27.508"></a><span id="l27.508" class="difflineminus">-        }</span>
<a href="#l27.509"></a><span id="l27.509" class="difflineminus">-        else {</span>
<a href="#l27.510"></a><span id="l27.510" class="difflineminus">-          pipe.close();</span>
<a href="#l27.511"></a><span id="l27.511" class="difflineminus">-        }</span>
<a href="#l27.512"></a><span id="l27.512" class="difflineminus">-      },</span>
<a href="#l27.513"></a><span id="l27.513" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l27.514"></a><span id="l27.514" class="difflineminus">-        simpleListener.stdoutData += data;</span>
<a href="#l27.515"></a><span id="l27.515" class="difflineminus">-      },</span>
<a href="#l27.516"></a><span id="l27.516" class="difflineminus">-      stderr: function(data) {</span>
<a href="#l27.517"></a><span id="l27.517" class="difflineminus">-        simpleListener.stderrData += data;</span>
<a href="#l27.518"></a><span id="l27.518" class="difflineminus">-      },</span>
<a href="#l27.519"></a><span id="l27.519" class="difflineminus">-      done: function(exitCode) {</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineminus">-        simpleListener.exitCode = exitCode;</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineminus">-        if (doneFunc) {</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineminus">-          doneFunc(exitCode);</span>
<a href="#l27.523"></a><span id="l27.523" class="difflineminus">-        }</span>
<a href="#l27.524"></a><span id="l27.524" class="difflineminus">-      }</span>
<a href="#l27.525"></a><span id="l27.525" class="difflineminus">-    };</span>
<a href="#l27.526"></a><span id="l27.526" class="difflineminus">-</span>
<a href="#l27.527"></a><span id="l27.527" class="difflineminus">-    return simpleListener;</span>
<a href="#l27.528"></a><span id="l27.528" class="difflineminus">-  }</span>
<a href="#l27.529"></a><span id="l27.529" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/gpg.jsm</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/gpg.jsm</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -12,23 +12,20 @@ const EXPORTED_SYMBOLS = [&quot;EnigmailGpg&quot;]</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l28.9"></a><span id="l28.9"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l28.10"></a><span id="l28.10"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l28.11"></a><span id="l28.11"> const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l28.14"></a><span id="l28.14"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l28.15"></a><span id="l28.15"> const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l28.16"></a><span id="l28.16"> const EnigmailVersioning = ChromeUtils.import(&quot;chrome://openpgp/content/modules/versioning.jsm&quot;).EnigmailVersioning;</span>
<a href="#l28.17"></a><span id="l28.17"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-const getGpgAgent = EnigmailLazy.loader(&quot;enigmail/gpgAgent.jsm&quot;, &quot;EnigmailGpgAgent&quot;);</span>
<a href="#l28.19"></a><span id="l28.19"> const getDialog = EnigmailLazy.loader(&quot;enigmail/dialog.jsm&quot;, &quot;EnigmailDialog&quot;);</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21"> const MINIMUM_GPG_VERSION = &quot;2.0.14&quot;;</span>
<a href="#l28.22"></a><span id="l28.22"> const GPG_BATCH_OPT_LIST = [&quot;--batch&quot;, &quot;--no-tty&quot;, &quot;--no-verbose&quot;, &quot;--status-fd&quot;, &quot;2&quot;];</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24"> function pushTrimmedStr(arr, str, splitStr) {</span>
<a href="#l28.25"></a><span id="l28.25">   // Helper function for pushing a string without leading/trailing spaces</span>
<a href="#l28.26"></a><span id="l28.26">   // to an array</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineat">@@ -41,64 +38,16 @@ function pushTrimmedStr(arr, str, splitS</span>
<a href="#l28.28"></a><span id="l28.28">       }</span>
<a href="#l28.29"></a><span id="l28.29">     } else {</span>
<a href="#l28.30"></a><span id="l28.30">       arr.push(str);</span>
<a href="#l28.31"></a><span id="l28.31">     }</span>
<a href="#l28.32"></a><span id="l28.32">   }</span>
<a href="#l28.33"></a><span id="l28.33">   return (str.length &gt; 0);</span>
<a href="#l28.34"></a><span id="l28.34"> }</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-function getDirmngrTorStatus(exitCodeObj) {</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-  const command = getGpgAgent().resolveToolPath(&quot;gpg-connect-agent&quot;);</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-  if (command === null) {</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-    return null;</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-  }</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-  const args = [&quot;--dirmngr&quot;];</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-  EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-  let stdout = &quot;&quot;;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-  try {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-    exitCodeObj.value = subprocess.call({</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-      command: command,</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-      arguments: args,</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-      stdin: function(stdin) {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-        stdin.write(&quot;GETINFO tor\r\n&quot;);</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-        stdin.write(&quot;bye\r\n&quot;);</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-        stdin.write(&quot;\r\n&quot;);</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-        stdin.close();</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-      },</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-        stdout += data;</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-      }</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-    }).wait();</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-  } catch (ex) {</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-    exitCodeObj.value = -1;</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-  }</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-  return stdout;</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-}</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineminus">-function dirmngrConfiguredWithTor() {</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-  if (!EnigmailGpg.getGpgFeature(&quot;supports-dirmngr&quot;)) return false;</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-  const exitCodeObj = {</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-    value: null</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineminus">-  };</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-  const output = getDirmngrTorStatus(exitCodeObj);</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-  if (output === null || exitCodeObj.value &lt; 0) {</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-    return false;</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-  }</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-  return output.match(/Tor mode is enabled/) !== null;</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-}</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-</span>
<a href="#l28.84"></a><span id="l28.84"> var EnigmailGpg = {</span>
<a href="#l28.85"></a><span id="l28.85">   agentVersion: &quot;&quot;,</span>
<a href="#l28.86"></a><span id="l28.86">   _agentPath: null,</span>
<a href="#l28.87"></a><span id="l28.87"> </span>
<a href="#l28.88"></a><span id="l28.88">   get agentPath() {</span>
<a href="#l28.89"></a><span id="l28.89">     return this._agentPath;</span>
<a href="#l28.90"></a><span id="l28.90">   },</span>
<a href="#l28.91"></a><span id="l28.91"> </span>
<a href="#l28.92"></a><span id="l28.92" class="difflineat">@@ -119,17 +68,16 @@ var EnigmailGpg = {</span>
<a href="#l28.93"></a><span id="l28.93">    @param featureName:  String; one of the following values:</span>
<a href="#l28.94"></a><span id="l28.94">    version-supported    - is the gpg version supported at all (true for gpg &gt;= 2.0.10)</span>
<a href="#l28.95"></a><span id="l28.95">    supports-gpg-agent   - is gpg-agent is auto-started (true for gpg &gt;= 2.0.16)</span>
<a href="#l28.96"></a><span id="l28.96">    keygen-passphrase    - can the passphrase be specified when generating keys (false for gpg 2.1 and 2.1.1)</span>
<a href="#l28.97"></a><span id="l28.97">    windows-photoid-bug  - is there a bug in gpg with the output of photoid on Windows (true for gpg &lt; 2.0.16)</span>
<a href="#l28.98"></a><span id="l28.98">    genkey-no-protection - is &quot;%no-protection&quot; supported for generting keys (true for gpg &gt;= 2.1)</span>
<a href="#l28.99"></a><span id="l28.99">    search-keys-cmd      - what command to use to terminate the --search-key operation. (&quot;save&quot; for gpg &gt; 2.1; &quot;quit&quot; otherwise)</span>
<a href="#l28.100"></a><span id="l28.100">    socks-on-windows     - is SOCKS proxy supported on Windows (true for gpg &gt;= 2.0.20)</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-   supports-dirmngr     - is dirmngr supported (true for gpg &gt;= 2.1)</span>
<a href="#l28.102"></a><span id="l28.102">    supports-ecc-keys    - are ECC (elliptic curve) keys supported (true for gpg &gt;= 2.1)</span>
<a href="#l28.103"></a><span id="l28.103">    supports-sender      - does gnupg understand the --sender argument (true for gpg &gt;= 2.1.15)</span>
<a href="#l28.104"></a><span id="l28.104">    supports-wkd         - does gpg support wkd (web key directory) (true for gpg &gt;= 2.1.19)</span>
<a href="#l28.105"></a><span id="l28.105">    export-result        - does gpg print EXPORTED when exporting keys (true for gpg &gt;= 2.1.10)</span>
<a href="#l28.106"></a><span id="l28.106">    decryption-info      - does gpg print DECRYPTION_INFO (true for gpg &gt;= 2.0.19)</span>
<a href="#l28.107"></a><span id="l28.107">    export-specific-uid  - does gpg support exporting a key with a specific UID (true for gpg &gt;= 2.2.8)</span>
<a href="#l28.108"></a><span id="l28.108">    supports-show-only   - does gpg support --import-options show-only (true for gpg &gt;= 2.1.14)</span>
<a href="#l28.109"></a><span id="l28.109">    handles-huge-keys    - can gpg deal with huge keys without aborting (true for gpg &gt;= 2.2.17)</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineat">@@ -157,18 +105,16 @@ var EnigmailGpg = {</span>
<a href="#l28.111"></a><span id="l28.111">       case &quot;supports-gpg-agent&quot;:</span>
<a href="#l28.112"></a><span id="l28.112">         return EnigmailVersioning.greaterThanOrEqual(gpgVersion, &quot;2.0.16&quot;);</span>
<a href="#l28.113"></a><span id="l28.113">       case &quot;keygen-passphrase&quot;:</span>
<a href="#l28.114"></a><span id="l28.114">         return EnigmailVersioning.lessThan(gpgVersion, &quot;2.1&quot;) || EnigmailVersioning.greaterThanOrEqual(gpgVersion, &quot;2.1.2&quot;);</span>
<a href="#l28.115"></a><span id="l28.115">       case &quot;genkey-no-protection&quot;:</span>
<a href="#l28.116"></a><span id="l28.116">         return EnigmailVersioning.greaterThan(gpgVersion, &quot;2.1&quot;);</span>
<a href="#l28.117"></a><span id="l28.117">       case &quot;windows-photoid-bug&quot;:</span>
<a href="#l28.118"></a><span id="l28.118">         return EnigmailVersioning.lessThan(gpgVersion, &quot;2.0.16&quot;);</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineminus">-      case &quot;supports-dirmngr&quot;:</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineminus">-        return EnigmailVersioning.greaterThan(gpgVersion, &quot;2.1&quot;);</span>
<a href="#l28.121"></a><span id="l28.121">       case &quot;supports-ecc-keys&quot;:</span>
<a href="#l28.122"></a><span id="l28.122">         return EnigmailVersioning.greaterThan(gpgVersion, &quot;2.1&quot;);</span>
<a href="#l28.123"></a><span id="l28.123">       case &quot;socks-on-windows&quot;:</span>
<a href="#l28.124"></a><span id="l28.124">         return EnigmailVersioning.greaterThanOrEqual(gpgVersion, &quot;2.0.20&quot;);</span>
<a href="#l28.125"></a><span id="l28.125">       case &quot;search-keys-cmd&quot;:</span>
<a href="#l28.126"></a><span id="l28.126">         // returns a string</span>
<a href="#l28.127"></a><span id="l28.127">         if (EnigmailVersioning.greaterThan(gpgVersion, &quot;2.1&quot;)) {</span>
<a href="#l28.128"></a><span id="l28.128">           return &quot;save&quot;;</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineat">@@ -188,159 +134,16 @@ var EnigmailGpg = {</span>
<a href="#l28.130"></a><span id="l28.130">         return EnigmailVersioning.greaterThanOrEqual(gpgVersion, &quot;2.1.14&quot;);</span>
<a href="#l28.131"></a><span id="l28.131">       case &quot;handles-huge-keys&quot;:</span>
<a href="#l28.132"></a><span id="l28.132">         return EnigmailVersioning.greaterThanOrEqual(gpgVersion, &quot;2.2.17&quot;);</span>
<a href="#l28.133"></a><span id="l28.133">     }</span>
<a href="#l28.134"></a><span id="l28.134"> </span>
<a href="#l28.135"></a><span id="l28.135">     return undefined;</span>
<a href="#l28.136"></a><span id="l28.136">   },</span>
<a href="#l28.137"></a><span id="l28.137"> </span>
<a href="#l28.138"></a><span id="l28.138" class="difflineminus">-  /**</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineminus">-   * get the standard arguments to pass to every GnuPG subprocess</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineminus">-   *</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineminus">-   * @withBatchOpts: Boolean - true: use --batch and some more options</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineminus">-   *                           false: don't use --batch and co.</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-   *</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-   * @return: Array of String - the list of arguments</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-   */</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-  getStandardArgs: function(withBatchOpts) {</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-    // return the arguments to pass to every GnuPG subprocess</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineminus">-    let r = [&quot;--charset&quot;, &quot;utf-8&quot;, &quot;--display-charset&quot;, &quot;utf-8&quot;, &quot;--no-auto-check-trustdb&quot;]; // mandatory parameters to add in all cases</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineminus">-</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineminus">-    try {</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineminus">-      let p = EnigmailPrefs.getPref(&quot;agentAdditionalParam&quot;).replace(/\\\\/g, &quot;\\&quot;);</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineminus">-      let i = 0;</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineminus">-      let last = 0;</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-      let foundSign = &quot;&quot;;</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-      let startQuote = -1;</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineminus">-</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineminus">-      while ((i = p.substr(last).search(/['&quot;]/)) &gt;= 0) {</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineminus">-        if (startQuote == -1) {</span>
<a href="#l28.160"></a><span id="l28.160" class="difflineminus">-          startQuote = i;</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineminus">-          foundSign = p.substr(last).charAt(i);</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-          last = i + 1;</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-        } else if (p.substr(last).charAt(i) == foundSign) {</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineminus">-          // found enquoted part</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineminus">-          if (startQuote &gt; 1) pushTrimmedStr(r, p.substr(0, startQuote), true);</span>
<a href="#l28.166"></a><span id="l28.166" class="difflineminus">-</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineminus">-          pushTrimmedStr(r, p.substr(startQuote + 1, last + i - startQuote - 1), false);</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-          p = p.substr(last + i + 1);</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineminus">-          last = 0;</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineminus">-          startQuote = -1;</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineminus">-          foundSign = &quot;&quot;;</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineminus">-        } else {</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineminus">-          last = last + i + 1;</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineminus">-        }</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineminus">-      }</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-      pushTrimmedStr(r, p, true);</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineminus">-</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineminus">-    if (withBatchOpts) {</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-      r = r.concat(GPG_BATCH_OPT_LIST);</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-    }</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineminus">-</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineminus">-    return r;</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-  },</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineminus">-  // returns the output of --with-colons --list-config</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineminus">-  getGnupgConfig: function(exitCodeObj, errorMsgObj) {</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineminus">-    if (!EnigmailGpg.agentPath) {</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineminus">-      exitCodeObj.value = 0;</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineminus">-    }</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineminus">-</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(true).</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineminus">-    concat([&quot;--fixed-list-mode&quot;, &quot;--with-colons&quot;, &quot;--list-config&quot;]);</span>
<a href="#l28.197"></a><span id="l28.197" class="difflineminus">-</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineminus">-    const statusMsgObj = {};</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-    const cmdErrorMsgObj = {};</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-    const statusFlagsObj = {};</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineminus">-</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineminus">-    const listText = EnigmailExecution.execCmd(EnigmailGpg.agentPath, args, &quot;&quot;, exitCodeObj, statusFlagsObj, statusMsgObj, cmdErrorMsgObj);</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineminus">-</span>
<a href="#l28.204"></a><span id="l28.204" class="difflineminus">-    if (exitCodeObj.value !== 0) {</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineminus">-      errorMsgObj.value = EnigmailLocale.getString(&quot;badCommand&quot;);</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineminus">-      if (cmdErrorMsgObj.value) {</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineminus">-        errorMsgObj.value += &quot;\n&quot; + EnigmailFiles.formatCmdLine(EnigmailGpg.agentPath, args);</span>
<a href="#l28.208"></a><span id="l28.208" class="difflineminus">-        errorMsgObj.value += &quot;\n&quot; + cmdErrorMsgObj.value;</span>
<a href="#l28.209"></a><span id="l28.209" class="difflineminus">-      }</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineminus">-    }</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineminus">-</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineminus">-    return listText.replace(/(\r\n|\r)/g, &quot;\n&quot;);</span>
<a href="#l28.215"></a><span id="l28.215" class="difflineminus">-  },</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineminus">-</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineminus">-  /**</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineminus">-   * return an array containing the aliases and the email addresses</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineminus">-   * of groups defined in gpg.conf</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineminus">-   *</span>
<a href="#l28.221"></a><span id="l28.221" class="difflineminus">-   * @return: array of objects with the following properties:</span>
<a href="#l28.222"></a><span id="l28.222" class="difflineminus">-   *  - alias: group name as used by GnuPG</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-   *  - keylist: list of keys (any form that GnuPG accepts), separated by &quot;;&quot;</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineminus">-   *</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineminus">-   * (see docu for gnupg parameter --group)</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineminus">-   */</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineminus">-  getGpgGroups: function() {</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineminus">-    const exitCodeObj = {};</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineminus">-    const errorMsgObj = {};</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineminus">-</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineminus">-    const cfgStr = EnigmailGpg.getGnupgConfig(exitCodeObj, errorMsgObj);</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineminus">-</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineminus">-    if (exitCodeObj.value !== 0) {</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineminus">-      getDialog().alert(errorMsgObj.value);</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineminus">-      return null;</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineminus">-    }</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-    const groups = [];</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineminus">-    const cfg = cfgStr.split(/\n/);</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineminus">-</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineminus">-    for (let i = 0; i &lt; cfg.length; i++) {</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineminus">-      if (cfg[i].indexOf(&quot;cfg:group&quot;) === 0) {</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineminus">-        const groupArr = cfg[i].split(/:/);</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineminus">-        groups.push({</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineminus">-          alias: groupArr[2],</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineminus">-          keylist: groupArr[3]</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineminus">-        });</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineminus">-      }</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineminus">-    }</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineminus">-</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineminus">-    return groups;</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineminus">-  },</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineminus">-  /**</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineminus">-   * Force GnuPG to recalculate the trust db. This is sometimes required after importing keys.</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineminus">-   *</span>
<a href="#l28.257"></a><span id="l28.257" class="difflineminus">-   * no return value</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineminus">-   */</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineminus">-  recalcTrustDb: function() {</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailCommon.jsm: recalcTrustDb:\n&quot;);</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineminus">-</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineminus">-    const command = EnigmailGpg.agentPath;</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(false).</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineminus">-    concat([&quot;--check-trustdb&quot;]);</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineminus">-</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineminus">-    try {</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineminus">-      const proc = subprocess.call({</span>
<a href="#l28.268"></a><span id="l28.268" class="difflineminus">-        command: EnigmailGpg.agentPath,</span>
<a href="#l28.269"></a><span id="l28.269" class="difflineminus">-        arguments: args,</span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-        environment: EnigmailCore.getEnvList(),</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineminus">-        charset: null,</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineminus">-        mergeStderr: false</span>
<a href="#l28.273"></a><span id="l28.273" class="difflineminus">-      });</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineminus">-      proc.wait();</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineminus">-    } catch (ex) {</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineminus">-      EnigmailLog.ERROR(&quot;enigmailCommon.jsm: recalcTrustDb: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineminus">-      throw ex;</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineminus">-    }</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineminus">-  },</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineminus">-</span>
<a href="#l28.281"></a><span id="l28.281">   signingAlgIdToString: function(id) {</span>
<a href="#l28.282"></a><span id="l28.282">     // RFC 4880 Sec. 9.1, RFC 6637 Sec. 5 and draft-koch-eddsa-for-openpgp-03 Sec. 8</span>
<a href="#l28.283"></a><span id="l28.283">     switch (parseInt(id, 10)) {</span>
<a href="#l28.284"></a><span id="l28.284">       case 1:</span>
<a href="#l28.285"></a><span id="l28.285">       case 2:</span>
<a href="#l28.286"></a><span id="l28.286">       case 3:</span>
<a href="#l28.287"></a><span id="l28.287">         return &quot;RSA&quot;;</span>
<a href="#l28.288"></a><span id="l28.288">       case 16:</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineat">@@ -376,16 +179,9 @@ var EnigmailGpg = {</span>
<a href="#l28.290"></a><span id="l28.290">       case 10:</span>
<a href="#l28.291"></a><span id="l28.291">         return &quot;SHA512&quot;;</span>
<a href="#l28.292"></a><span id="l28.292">       case 11:</span>
<a href="#l28.293"></a><span id="l28.293">         return &quot;SHA224&quot;;</span>
<a href="#l28.294"></a><span id="l28.294">       default:</span>
<a href="#l28.295"></a><span id="l28.295">         return EnigmailLocale.getString(&quot;unknownHashAlg&quot;, [parseInt(id, 10)]);</span>
<a href="#l28.296"></a><span id="l28.296">     }</span>
<a href="#l28.297"></a><span id="l28.297">   },</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineminus">-</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineminus">-  /**</span>
<a href="#l28.300"></a><span id="l28.300" class="difflineminus">-   * For versions of GPG 2.1 and higher, checks to see if the dirmngr is configured to use Tor</span>
<a href="#l28.301"></a><span id="l28.301" class="difflineminus">-   *</span>
<a href="#l28.302"></a><span id="l28.302" class="difflineminus">-   * @return    Boolean     - True if dirmngr is configured with Tor. False otherwise</span>
<a href="#l28.303"></a><span id="l28.303" class="difflineminus">-   */</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineminus">-  dirmngrConfiguredWithTor: dirmngrConfiguredWithTor</span>
<a href="#l28.305"></a><span id="l28.305" class="difflineminus">-};</span>
<a href="#l28.306"></a><span id="l28.306">\ No newline at end of file</span>
<a href="#l28.307"></a><span id="l28.307" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/gpgAgent.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,803 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-/*</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">- */</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailGpgAgent&quot;];</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-const ctypes = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;).ctypes;</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-const EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-const EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-const EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-const EnigmailSystem = ChromeUtils.import(&quot;chrome://openpgp/content/modules/system.jsm&quot;).EnigmailSystem;</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-const getEnigmailGpg = EnigmailLazy.loader(&quot;enigmail/gpg.jsm&quot;, &quot;EnigmailGpg&quot;);</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-const getDialog = EnigmailLazy.loader(&quot;enigmail/dialog.jsm&quot;, &quot;EnigmailDialog&quot;);</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-const NS_LOCAL_FILE_CONTRACTID = &quot;@mozilla.org/file/local;1&quot;;</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-const DIR_SERV_CONTRACTID = &quot;@mozilla.org/file/directory_service;1&quot;;</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-const NS_LOCALFILEOUTPUTSTREAM_CONTRACTID = &quot;@mozilla.org/network/file-output-stream;1&quot;;</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-const DEFAULT_FILE_PERMS = 0o600;</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-// Making this a var makes it possible to test windows things on linux</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-var nsIWindowsRegKey = Ci.nsIWindowsRegKey;</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-var gIsGpgAgent = -1;</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-const DUMMY_AGENT_INFO = &quot;none&quot;;</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-function cloneOrNull(v) {</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-  if (v &amp;&amp; typeof v.clone === &quot;function&quot;) {</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-    return v.clone();</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-  }</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-  else {</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-    return v;</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-  }</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-}</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-function extractAgentInfo(fullStr) {</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-  if (fullStr) {</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-    return fullStr.</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-    replace(/[\r\n]/g, &quot;&quot;).</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-    replace(/^.*=/, &quot;&quot;).</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-    replace(/;.*$/, &quot;&quot;);</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-  }</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-  else {</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-  }</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-}</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-function getHomedirFromParam(param) {</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-  let i = param.search(/--homedir/);</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-  if (i &gt;= 0) {</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-    param = param.substr(i + 9);</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-    let m = param.match(/^(\s*)([^\\]&quot;.+[^\\]&quot;)/);</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-    if (m &amp;&amp; m.length &gt; 2) {</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-      param = m[2].substr(1);</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-      let j = param.search(/[^\\]&quot;/);</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-      return param.substr(1, j);</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-    }</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineminus">-    m = param.match(/^(\s*)([^\\]'.+[^\\]')/);</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineminus">-    if (m &amp;&amp; m.length &gt; 2) {</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-      param = m[2].substr(1);</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-      let j = param.search(/[^\\]'/);</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-      return param.substr(1, j);</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-    }</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-    m = param.match(/^(\s*)(\S+)/);</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-    if (m &amp;&amp; m.length &gt; 2) {</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-      return m[2];</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-    }</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-  }</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-  return null;</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-}</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-var EnigmailGpgAgent = {</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-  agentType: &quot;&quot;,</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-  agentPath: null,</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-  connGpgAgentPath: null,</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-  gpgconfPath: null,</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-  gpgAgentInfo: {</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-    preStarted: false,</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineminus">-    envStr: &quot;&quot;</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineminus">-  },</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-  gpgAgentProcess: null,</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-  gpgAgentIsOptional: true,</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineminus">-  isDummy: function() {</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineminus">-    return EnigmailGpgAgent.gpgAgentInfo.envStr === DUMMY_AGENT_INFO;</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineminus">-  },</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineminus">-</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineminus">-  resetGpgAgent: function() {</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: resetGpgAgent\n&quot;);</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-    gIsGpgAgent = -1;</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineminus">-  },</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineminus">-</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineminus">-  isCmdGpgAgent: function(pid) {</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.isCmdGpgAgent()&quot;);</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineminus">-    return;</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineminus">-</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: isCmdGpgAgent:\n&quot;);</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineminus">-</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineminus">-    const environment = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(Ci.nsIEnvironment);</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineminus">-    let ret = false;</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineminus">-</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineminus">-    let path = environment.get(&quot;PATH&quot;);</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineminus">-    if (!path || path.length === 0) {</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineminus">-      path = &quot;/bin:/usr/bin:/usr/local/bin&quot;;</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineminus">-    }</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineminus">-</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineminus">-    const psCmd = EnigmailFiles.resolvePath(&quot;ps&quot;, path, false);</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-    let outStr = &quot;&quot;;</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineminus">-    const proc = {</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineminus">-      command: psCmd,</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineminus">-      arguments: [&quot;-o&quot;, &quot;comm&quot;, &quot;-p&quot;, pid],</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineminus">-      charset: null,</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineminus">-        outStr += data;</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-      }</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-    };</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-    try {</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-      subprocess.call(proc).wait();</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: isCmdGpgAgent: got data: '&quot; + outStr + &quot;'\n&quot;);</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-      var data = outStr.replace(/[\r\n]/g, &quot; &quot;);</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineminus">-      if (data.search(/gpg-agent/) &gt;= 0) {</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineminus">-        ret = true;</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineminus">-      }</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineminus">-    }</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineminus">-    catch (ex) {}</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineminus">-</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineminus">-    return ret;</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineminus">-</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineminus">-  },</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineminus">-</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineminus">-  isAgentTypeGpgAgent: function() {</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.isAgentTypeGpgAgent()&quot;);</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineminus">-    return;</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineminus">-</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineminus">-    // determine if the used agent is a gpg-agent</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: isAgentTypeGpgAgent:\n&quot;);</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineminus">-</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineminus">-    // to my knowledge there is no other agent than gpg-agent on Windows</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineminus">-    if (EnigmailOS.getOS() == &quot;WINNT&quot;) return true;</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineminus">-</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-    if (gIsGpgAgent &gt;= 0) {</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-      return gIsGpgAgent == 1;</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-    }</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineminus">-</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineminus">-    let pid = -1;</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineminus">-    let exitCode = -1;</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineminus">-    let outStr = &quot;&quot;;</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineminus">-    if (!EnigmailCore.getService()) return false;</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineminus">-</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineminus">-    const proc = {</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineminus">-      command: EnigmailGpgAgent.connGpgAgentPath,</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineminus">-      arguments: [],</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineminus">-      charset: null,</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineminus">-      stdin: function(pipe) {</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineminus">-        pipe.write(&quot;/subst\n&quot;);</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineminus">-        pipe.write(&quot;/serverpid\n&quot;);</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineminus">-        pipe.write(&quot;/echo pid: ${get serverpid}\n&quot;);</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineminus">-        pipe.write(&quot;/bye\n&quot;);</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-        pipe.close();</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineminus">-      },</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineminus">-        outStr += data;</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-      }</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineminus">-    };</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineminus">-</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineminus">-    try {</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineminus">-      exitCode = subprocess.call(proc).wait();</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineminus">-      if (exitCode) pid = -2;</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineminus">-      const data = outStr.replace(/[\r\n]/g, &quot;&quot;);</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineminus">-      if (data.search(/^pid: [0-9]+$/) === 0) {</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineminus">-        pid = data.replace(/^pid: /, &quot;&quot;);</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineminus">-      }</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineminus">-    }</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineminus">-    catch (ex) {}</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineminus">-</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: isAgentTypeGpgAgent: pid=&quot; + pid + &quot;\n&quot;);</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineminus">-</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineminus">-    EnigmailGpgAgent.isCmdGpgAgent(pid);</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineminus">-    let isAgent = false;</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineminus">-    try {</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineminus">-      isAgent = EnigmailGpgAgent.isCmdGpgAgent(pid);</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineminus">-      gIsGpgAgent = isAgent ? 1 : 0;</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineminus">-    }</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineminus">-    catch (ex) {}</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineminus">-    return isAgent;</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineminus">-  },</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-  getAgentMaxIdle: function() {</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.getAgentMaxIdle()&quot;);</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-    return;</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: getAgentMaxIdle:\n&quot;);</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineminus">-    let maxIdle = -1;</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineminus">-</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineminus">-    if (!EnigmailCore.getService()) return maxIdle;</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineminus">-</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineminus">-    const DEFAULT = 7;</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineminus">-    const CFGVALUE = 9;</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineminus">-    let outStr = &quot;&quot;;</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineminus">-</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineminus">-    const proc = {</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineminus">-      command: EnigmailGpgAgent.gpgconfPath,</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineminus">-      arguments: [&quot;--list-options&quot;, &quot;gpg-agent&quot;],</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineminus">-      charset: null,</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineminus">-        outStr += data;</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineminus">-      }</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineminus">-    };</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineminus">-</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineminus">-    subprocess.call(proc).wait();</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineminus">-</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineminus">-    const lines = outStr.split(/[\r\n]/);</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineminus">-</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineminus">-    for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: getAgentMaxIdle: line: &quot; + lines[i] + &quot;\n&quot;);</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineminus">-</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineminus">-      if (lines[i].search(/^default-cache-ttl:/) === 0) {</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineminus">-        const m = lines[i].split(/:/);</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineminus">-        if (m[CFGVALUE].length === 0) {</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineminus">-          maxIdle = Math.round(m[DEFAULT] / 60);</span>
<a href="#l29.261"></a><span id="l29.261" class="difflineminus">-        }</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineminus">-        else {</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineminus">-          maxIdle = Math.round(m[CFGVALUE] / 60);</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineminus">-        }</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineminus">-</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineminus">-        break;</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineminus">-      }</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineminus">-    }</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineminus">-    return maxIdle;</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineminus">-  },</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineminus">-</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineminus">-  setAgentMaxIdle: function(idleMinutes) {</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.setAgentMaxIdle()&quot;);</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineminus">-    return;</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineminus">-</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentMaxIdle:\n&quot;);</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineminus">-    if (!EnigmailCore.getService()) return;</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineminus">-</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineminus">-    const RUNTIME = 8;</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineminus">-</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineminus">-    const proc = {</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineminus">-      command: EnigmailGpgAgent.gpgconfPath,</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineminus">-      arguments: [&quot;--runtime&quot;, &quot;--change-options&quot;, &quot;gpg-agent&quot;],</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineminus">-      charset: null,</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineminus">-      mergeStderr: true,</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineminus">-      stdin: function(pipe) {</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineminus">-        pipe.write(&quot;default-cache-ttl:&quot; + RUNTIME + &quot;:&quot; + (idleMinutes * 60) + &quot;\n&quot;);</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineminus">-        pipe.write(&quot;max-cache-ttl:&quot; + RUNTIME + &quot;:&quot; + (idleMinutes * 600) + &quot;\n&quot;);</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineminus">-        pipe.close();</span>
<a href="#l29.291"></a><span id="l29.291" class="difflineminus">-      },</span>
<a href="#l29.292"></a><span id="l29.292" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineminus">-        EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentMaxIdle.stdout: &quot; + data + &quot;\n&quot;);</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineminus">-      }</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineminus">-    };</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineminus">-</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineminus">-    try {</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineminus">-      let exitCode = subprocess.call(proc);</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentMaxIdle.stdout: gpgconf exitCode=&quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l29.300"></a><span id="l29.300" class="difflineminus">-    }</span>
<a href="#l29.301"></a><span id="l29.301" class="difflineminus">-    catch (ex) {</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentMaxIdle: exception: &quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineminus">-    }</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineminus">-  },</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineminus">-</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineminus">-  getMaxIdlePref: function(win) {</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineminus">-    let maxIdle = EnigmailPrefs.getPref(&quot;maxIdleMinutes&quot;);</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineminus">-</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineminus">-    try {</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineminus">-      if (EnigmailCore.getService(win)) {</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineminus">-        if (EnigmailGpgAgent.gpgconfPath &amp;&amp;</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineminus">-          EnigmailGpgAgent.connGpgAgentPath) {</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineminus">-</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineminus">-          if (EnigmailGpgAgent.isAgentTypeGpgAgent()) {</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineminus">-            const m = EnigmailGpgAgent.getAgentMaxIdle();</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineminus">-            if (m &gt; -1) maxIdle = m;</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineminus">-          }</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineminus">-        }</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-      }</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineminus">-    }</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineminus">-    catch (ex) {}</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineminus">-</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineminus">-    return maxIdle;</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineminus">-  },</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineminus">-</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineminus">-  setMaxIdlePref: function(minutes) {</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineminus">-    EnigmailPrefs.setPref(&quot;maxIdleMinutes&quot;, minutes);</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineminus">-</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineminus">-    if (EnigmailGpgAgent.isAgentTypeGpgAgent()) {</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineminus">-      try {</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineminus">-        EnigmailGpgAgent.setAgentMaxIdle(minutes);</span>
<a href="#l29.332"></a><span id="l29.332" class="difflineminus">-      }</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineminus">-      catch (ex) {}</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineminus">-    }</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineminus">-  },</span>
<a href="#l29.336"></a><span id="l29.336" class="difflineminus">-</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineminus">-  /**</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineminus">-   * Determine the &quot;gpg home dir&quot;, i.e. the directory where gpg.conf and the keyring are</span>
<a href="#l29.339"></a><span id="l29.339" class="difflineminus">-   * stored using the &quot;additional parameter&quot; and gpgconf.</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineminus">-   *</span>
<a href="#l29.341"></a><span id="l29.341" class="difflineminus">-   * @return String - directory name, or NULL (in case the command did not succeed)</span>
<a href="#l29.342"></a><span id="l29.342" class="difflineminus">-   */</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineminus">-  getGpgHomeDir: function() {</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.getGpgHomeDir()&quot;);</span>
<a href="#l29.345"></a><span id="l29.345" class="difflineminus">-    return;</span>
<a href="#l29.346"></a><span id="l29.346" class="difflineminus">-</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineminus">-    let param = EnigmailPrefs.getPref(&quot;agentAdditionalParam&quot;);</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineminus">-</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineminus">-    if (param) {</span>
<a href="#l29.350"></a><span id="l29.350" class="difflineminus">-      let hd = getHomedirFromParam(param);</span>
<a href="#l29.351"></a><span id="l29.351" class="difflineminus">-</span>
<a href="#l29.352"></a><span id="l29.352" class="difflineminus">-      if (hd) return hd;</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineminus">-    }</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineminus">-</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineminus">-    if (EnigmailGpgAgent.gpgconfPath === null) return null;</span>
<a href="#l29.356"></a><span id="l29.356" class="difflineminus">-</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineminus">-    const command = EnigmailGpgAgent.gpgconfPath;</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineminus">-    let args = [&quot;--list-dirs&quot;];</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineminus">-</span>
<a href="#l29.360"></a><span id="l29.360" class="difflineminus">-    let exitCode = -1;</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineminus">-    let outStr = &quot;&quot;;</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: getGpgHomeDir: calling subprocess with '&quot; + command.path + &quot;'\n&quot;);</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineminus">-</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineminus">-</span>
<a href="#l29.366"></a><span id="l29.366" class="difflineminus">-    const proc = {</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineminus">-      command: command,</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineminus">-      arguments: args,</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineminus">-      charset: null,</span>
<a href="#l29.371"></a><span id="l29.371" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineminus">-        outStr += data;</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineminus">-      },</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineminus">-      mergeStderr: false</span>
<a href="#l29.375"></a><span id="l29.375" class="difflineminus">-    };</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineminus">-</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineminus">-    try {</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineminus">-      exitCode = subprocess.call(proc).wait();</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineminus">-    }</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineminus">-    catch (ex) {</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineminus">-      EnigmailLog.ERROR(&quot;gpgAgent.jsm: getGpgHomeDir: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l29.382"></a><span id="l29.382" class="difflineminus">-      EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineminus">-      throw ex;</span>
<a href="#l29.384"></a><span id="l29.384" class="difflineminus">-    }</span>
<a href="#l29.385"></a><span id="l29.385" class="difflineminus">-</span>
<a href="#l29.386"></a><span id="l29.386" class="difflineminus">-    let m = outStr.match(/^(homedir:)(.*)$/mi);</span>
<a href="#l29.387"></a><span id="l29.387" class="difflineminus">-    if (m &amp;&amp; m.length &gt; 2) {</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineminus">-      return EnigmailData.convertGpgToUnicode(unescape(m[2]));</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineminus">-    }</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineminus">-</span>
<a href="#l29.391"></a><span id="l29.391" class="difflineminus">-    return null;</span>
<a href="#l29.392"></a><span id="l29.392" class="difflineminus">-  },</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineminus">-</span>
<a href="#l29.394"></a><span id="l29.394" class="difflineminus">-  /**</span>
<a href="#l29.395"></a><span id="l29.395" class="difflineminus">-   * @param domWindow:     Object - parent window, may be NULL</span>
<a href="#l29.396"></a><span id="l29.396" class="difflineminus">-   * @param esvc:          Object - Enigmail service object</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineminus">-   * @param preferredPath: String - try to use specific path to locate gpg</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineminus">-   */</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineminus">-  setAgentPath: function(domWindow, esvc, preferredPath) {</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.setAgentPath()&quot;);</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineminus">-    return;</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineminus">-</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentPath()\n&quot;);</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineminus">-    let agentPath = &quot;&quot;;</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineminus">-    try {</span>
<a href="#l29.406"></a><span id="l29.406" class="difflineminus">-      if (preferredPath) {</span>
<a href="#l29.407"></a><span id="l29.407" class="difflineminus">-        agentPath = preferredPath;</span>
<a href="#l29.408"></a><span id="l29.408" class="difflineminus">-      }</span>
<a href="#l29.409"></a><span id="l29.409" class="difflineminus">-      else {</span>
<a href="#l29.410"></a><span id="l29.410" class="difflineminus">-        agentPath = EnigmailPrefs.getPrefBranch().getCharPref(&quot;agentPath&quot;);</span>
<a href="#l29.411"></a><span id="l29.411" class="difflineminus">-      }</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineminus">-    }</span>
<a href="#l29.413"></a><span id="l29.413" class="difflineminus">-    catch (ex) {}</span>
<a href="#l29.414"></a><span id="l29.414" class="difflineminus">-</span>
<a href="#l29.415"></a><span id="l29.415" class="difflineminus">-    var agentType = &quot;gpg&quot;;</span>
<a href="#l29.416"></a><span id="l29.416" class="difflineminus">-    var agentName = &quot;&quot;;</span>
<a href="#l29.417"></a><span id="l29.417" class="difflineminus">-</span>
<a href="#l29.418"></a><span id="l29.418" class="difflineminus">-    EnigmailGpgAgent.resetGpgAgent();</span>
<a href="#l29.419"></a><span id="l29.419" class="difflineminus">-</span>
<a href="#l29.420"></a><span id="l29.420" class="difflineminus">-    if (agentPath) {</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineminus">-      // Locate GnuPG executable</span>
<a href="#l29.422"></a><span id="l29.422" class="difflineminus">-</span>
<a href="#l29.423"></a><span id="l29.423" class="difflineminus">-      // Append default .exe extension for DOS-Like systems, if needed</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineminus">-      if (EnigmailOS.isDosLike &amp;&amp; (agentPath.search(/\.\w+$/) &lt; 0)) {</span>
<a href="#l29.425"></a><span id="l29.425" class="difflineminus">-        agentPath += &quot;.exe&quot;;</span>
<a href="#l29.426"></a><span id="l29.426" class="difflineminus">-      }</span>
<a href="#l29.427"></a><span id="l29.427" class="difflineminus">-</span>
<a href="#l29.428"></a><span id="l29.428" class="difflineminus">-      try {</span>
<a href="#l29.429"></a><span id="l29.429" class="difflineminus">-        let pathDir = Cc[NS_LOCAL_FILE_CONTRACTID].createInstance(Ci.nsIFile);</span>
<a href="#l29.430"></a><span id="l29.430" class="difflineminus">-</span>
<a href="#l29.431"></a><span id="l29.431" class="difflineminus">-        if (!EnigmailFiles.isAbsolutePath(agentPath, EnigmailOS.isDosLike)) {</span>
<a href="#l29.432"></a><span id="l29.432" class="difflineminus">-          // path relative to Mozilla installation dir</span>
<a href="#l29.433"></a><span id="l29.433" class="difflineminus">-          const ds = Cc[DIR_SERV_CONTRACTID].getService();</span>
<a href="#l29.434"></a><span id="l29.434" class="difflineminus">-          const dsprops = ds.QueryInterface(Ci.nsIProperties);</span>
<a href="#l29.435"></a><span id="l29.435" class="difflineminus">-          pathDir = dsprops.get(&quot;CurProcD&quot;, Ci.nsIFile);</span>
<a href="#l29.436"></a><span id="l29.436" class="difflineminus">-</span>
<a href="#l29.437"></a><span id="l29.437" class="difflineminus">-          const dirs = agentPath.split(new RegExp(EnigmailOS.isDosLike ? &quot;\\\\&quot; : &quot;/&quot;));</span>
<a href="#l29.438"></a><span id="l29.438" class="difflineminus">-          for (let i = 0; i &lt; dirs.length; i++) {</span>
<a href="#l29.439"></a><span id="l29.439" class="difflineminus">-            if (dirs[i] != &quot;.&quot;) {</span>
<a href="#l29.440"></a><span id="l29.440" class="difflineminus">-              pathDir.append(dirs[i]);</span>
<a href="#l29.441"></a><span id="l29.441" class="difflineminus">-            }</span>
<a href="#l29.442"></a><span id="l29.442" class="difflineminus">-          }</span>
<a href="#l29.443"></a><span id="l29.443" class="difflineminus">-          if (pathDir.exists()) {</span>
<a href="#l29.444"></a><span id="l29.444" class="difflineminus">-            pathDir.normalize();</span>
<a href="#l29.445"></a><span id="l29.445" class="difflineminus">-          }</span>
<a href="#l29.446"></a><span id="l29.446" class="difflineminus">-        }</span>
<a href="#l29.447"></a><span id="l29.447" class="difflineminus">-        else {</span>
<a href="#l29.448"></a><span id="l29.448" class="difflineminus">-          // absolute path</span>
<a href="#l29.449"></a><span id="l29.449" class="difflineminus">-          EnigmailFiles.initPath(pathDir, agentPath);</span>
<a href="#l29.450"></a><span id="l29.450" class="difflineminus">-        }</span>
<a href="#l29.451"></a><span id="l29.451" class="difflineminus">-        if (!(pathDir.isFile() /* &amp;&amp; pathDir.isExecutable()*/ )) {</span>
<a href="#l29.452"></a><span id="l29.452" class="difflineminus">-          throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.453"></a><span id="l29.453" class="difflineminus">-        }</span>
<a href="#l29.454"></a><span id="l29.454" class="difflineminus">-        agentPath = pathDir.QueryInterface(Ci.nsIFile);</span>
<a href="#l29.455"></a><span id="l29.455" class="difflineminus">-</span>
<a href="#l29.456"></a><span id="l29.456" class="difflineminus">-      }</span>
<a href="#l29.457"></a><span id="l29.457" class="difflineminus">-      catch (ex) {</span>
<a href="#l29.458"></a><span id="l29.458" class="difflineminus">-        esvc.initializationError = EnigmailLocale.getString(&quot;gpgNotFound&quot;, [agentPath]);</span>
<a href="#l29.459"></a><span id="l29.459" class="difflineminus">-        EnigmailLog.ERROR(&quot;gpgAgent.jsm: initialize: Error - &quot; + esvc.initializationError + &quot;\n&quot;);</span>
<a href="#l29.460"></a><span id="l29.460" class="difflineminus">-        throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.461"></a><span id="l29.461" class="difflineminus">-      }</span>
<a href="#l29.462"></a><span id="l29.462" class="difflineminus">-    }</span>
<a href="#l29.463"></a><span id="l29.463" class="difflineminus">-    else {</span>
<a href="#l29.464"></a><span id="l29.464" class="difflineminus">-      agentPath = this.resolveGpgPath(esvc.environment);</span>
<a href="#l29.465"></a><span id="l29.465" class="difflineminus">-      if (!agentPath) {</span>
<a href="#l29.466"></a><span id="l29.466" class="difflineminus">-        esvc.initializationError = EnigmailLocale.getString(&quot;gpgNotInPath&quot;);</span>
<a href="#l29.467"></a><span id="l29.467" class="difflineminus">-        EnigmailLog.ERROR(&quot;gpgAgent.jsm: Error - &quot; + esvc.initializationError + &quot;\n&quot;);</span>
<a href="#l29.468"></a><span id="l29.468" class="difflineminus">-        throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.469"></a><span id="l29.469" class="difflineminus">-      }</span>
<a href="#l29.470"></a><span id="l29.470" class="difflineminus">-    }</span>
<a href="#l29.471"></a><span id="l29.471" class="difflineminus">-</span>
<a href="#l29.472"></a><span id="l29.472" class="difflineminus">-    agentPath.normalize(); // replace a/../b with b</span>
<a href="#l29.473"></a><span id="l29.473" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;EnigmailAgentPath=&quot; + EnigmailFiles.getFilePathDesc(agentPath) + &quot;\n\n&quot;);</span>
<a href="#l29.474"></a><span id="l29.474" class="difflineminus">-</span>
<a href="#l29.475"></a><span id="l29.475" class="difflineminus">-    EnigmailGpgAgent.agentType = agentType;</span>
<a href="#l29.476"></a><span id="l29.476" class="difflineminus">-    EnigmailGpgAgent.agentPath = agentPath;</span>
<a href="#l29.477"></a><span id="l29.477" class="difflineminus">-    getEnigmailGpg().setAgentPath(agentPath);</span>
<a href="#l29.478"></a><span id="l29.478" class="difflineminus">-    EnigmailExecution.agentType = agentType;</span>
<a href="#l29.479"></a><span id="l29.479" class="difflineminus">-</span>
<a href="#l29.480"></a><span id="l29.480" class="difflineminus">-    const command = agentPath;</span>
<a href="#l29.481"></a><span id="l29.481" class="difflineminus">-    let args = [];</span>
<a href="#l29.482"></a><span id="l29.482" class="difflineminus">-    if (agentType == &quot;gpg&quot;) {</span>
<a href="#l29.483"></a><span id="l29.483" class="difflineminus">-      args = [&quot;--batch&quot;, &quot;--no-tty&quot;, &quot;--charset&quot;, &quot;utf-8&quot;, &quot;--display-charset&quot;, &quot;utf-8&quot;, &quot;--version&quot;, &quot;--version&quot;];</span>
<a href="#l29.484"></a><span id="l29.484" class="difflineminus">-    }</span>
<a href="#l29.485"></a><span id="l29.485" class="difflineminus">-</span>
<a href="#l29.486"></a><span id="l29.486" class="difflineminus">-    let exitCode = -1;</span>
<a href="#l29.487"></a><span id="l29.487" class="difflineminus">-    let outStr = &quot;&quot;;</span>
<a href="#l29.488"></a><span id="l29.488" class="difflineminus">-    let errStr = &quot;&quot;;</span>
<a href="#l29.489"></a><span id="l29.489" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentPath: calling subprocess with '&quot; + command.path + &quot;'\n&quot;);</span>
<a href="#l29.490"></a><span id="l29.490" class="difflineminus">-</span>
<a href="#l29.491"></a><span id="l29.491" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l29.492"></a><span id="l29.492" class="difflineminus">-</span>
<a href="#l29.493"></a><span id="l29.493" class="difflineminus">-    const proc = {</span>
<a href="#l29.494"></a><span id="l29.494" class="difflineminus">-      command: command,</span>
<a href="#l29.495"></a><span id="l29.495" class="difflineminus">-      arguments: args,</span>
<a href="#l29.496"></a><span id="l29.496" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l29.497"></a><span id="l29.497" class="difflineminus">-      charset: null,</span>
<a href="#l29.498"></a><span id="l29.498" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l29.499"></a><span id="l29.499" class="difflineminus">-        outStr += data;</span>
<a href="#l29.500"></a><span id="l29.500" class="difflineminus">-      },</span>
<a href="#l29.501"></a><span id="l29.501" class="difflineminus">-      stderr: function(data) {</span>
<a href="#l29.502"></a><span id="l29.502" class="difflineminus">-        errStr += data;</span>
<a href="#l29.503"></a><span id="l29.503" class="difflineminus">-      },</span>
<a href="#l29.504"></a><span id="l29.504" class="difflineminus">-      mergeStderr: false</span>
<a href="#l29.505"></a><span id="l29.505" class="difflineminus">-    };</span>
<a href="#l29.506"></a><span id="l29.506" class="difflineminus">-</span>
<a href="#l29.507"></a><span id="l29.507" class="difflineminus">-    try {</span>
<a href="#l29.508"></a><span id="l29.508" class="difflineminus">-      exitCode = subprocess.call(proc).wait();</span>
<a href="#l29.509"></a><span id="l29.509" class="difflineminus">-    }</span>
<a href="#l29.510"></a><span id="l29.510" class="difflineminus">-    catch (ex) {</span>
<a href="#l29.511"></a><span id="l29.511" class="difflineminus">-      EnigmailLog.ERROR(&quot;gpgAgent.jsm: setAgentPath: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l29.512"></a><span id="l29.512" class="difflineminus">-      EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE with FAILURE\n&quot;);</span>
<a href="#l29.513"></a><span id="l29.513" class="difflineminus">-      throw ex;</span>
<a href="#l29.514"></a><span id="l29.514" class="difflineminus">-    }</span>
<a href="#l29.515"></a><span id="l29.515" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  enigmail&gt; DONE\n&quot;);</span>
<a href="#l29.516"></a><span id="l29.516" class="difflineminus">-</span>
<a href="#l29.517"></a><span id="l29.517" class="difflineminus">-    outStr = EnigmailSystem.convertNativeToUnicode(outStr);</span>
<a href="#l29.518"></a><span id="l29.518" class="difflineminus">-</span>
<a href="#l29.519"></a><span id="l29.519" class="difflineminus">-    if (exitCode !== 0) {</span>
<a href="#l29.520"></a><span id="l29.520" class="difflineminus">-      EnigmailLog.ERROR(&quot;gpgAgent.jsm: setAgentPath: gpg failed with exitCode &quot; + exitCode + &quot; msg='&quot; + outStr + &quot; &quot; + errStr + &quot;'\n&quot;);</span>
<a href="#l29.521"></a><span id="l29.521" class="difflineminus">-      throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.522"></a><span id="l29.522" class="difflineminus">-    }</span>
<a href="#l29.523"></a><span id="l29.523" class="difflineminus">-</span>
<a href="#l29.524"></a><span id="l29.524" class="difflineminus">-    EnigmailLog.CONSOLE(outStr + &quot;\n&quot;);</span>
<a href="#l29.525"></a><span id="l29.525" class="difflineminus">-</span>
<a href="#l29.526"></a><span id="l29.526" class="difflineminus">-    // detection for Gpg4Win wrapper</span>
<a href="#l29.527"></a><span id="l29.527" class="difflineminus">-    if (outStr.search(/^gpgwrap.*;/) === 0) {</span>
<a href="#l29.528"></a><span id="l29.528" class="difflineminus">-      const outLines = outStr.split(/[\n\r]+/);</span>
<a href="#l29.529"></a><span id="l29.529" class="difflineminus">-      const firstLine = outLines[0];</span>
<a href="#l29.530"></a><span id="l29.530" class="difflineminus">-      outLines.splice(0, 1);</span>
<a href="#l29.531"></a><span id="l29.531" class="difflineminus">-      outStr = outLines.join(&quot;\n&quot;);</span>
<a href="#l29.532"></a><span id="l29.532" class="difflineminus">-      agentPath = firstLine.replace(/^.*;[ \t]*/, &quot;&quot;);</span>
<a href="#l29.533"></a><span id="l29.533" class="difflineminus">-</span>
<a href="#l29.534"></a><span id="l29.534" class="difflineminus">-      EnigmailLog.CONSOLE(&quot;gpg4win-gpgwrapper detected; EnigmailAgentPath=&quot; + agentPath + &quot;\n\n&quot;);</span>
<a href="#l29.535"></a><span id="l29.535" class="difflineminus">-    }</span>
<a href="#l29.536"></a><span id="l29.536" class="difflineminus">-</span>
<a href="#l29.537"></a><span id="l29.537" class="difflineminus">-    const versionParts = outStr.replace(/[\r\n].*/g, &quot;&quot;).replace(/ *\(gpg4win.*\)/i, &quot;&quot;).split(/ /);</span>
<a href="#l29.538"></a><span id="l29.538" class="difflineminus">-    const gpgVersion = versionParts[versionParts.length - 1];</span>
<a href="#l29.539"></a><span id="l29.539" class="difflineminus">-</span>
<a href="#l29.540"></a><span id="l29.540" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: detected GnuPG version '&quot; + gpgVersion + &quot;'\n&quot;);</span>
<a href="#l29.541"></a><span id="l29.541" class="difflineminus">-    getEnigmailGpg().agentVersion = gpgVersion;</span>
<a href="#l29.542"></a><span id="l29.542" class="difflineminus">-</span>
<a href="#l29.543"></a><span id="l29.543" class="difflineminus">-    if (!getEnigmailGpg().getGpgFeature(&quot;version-supported&quot;)) {</span>
<a href="#l29.544"></a><span id="l29.544" class="difflineminus">-      if (!domWindow) {</span>
<a href="#l29.545"></a><span id="l29.545" class="difflineminus">-        domWindow = EnigmailWindows.getBestParentWin();</span>
<a href="#l29.546"></a><span id="l29.546" class="difflineminus">-      }</span>
<a href="#l29.547"></a><span id="l29.547" class="difflineminus">-      getDialog().alert(domWindow, EnigmailLocale.getString(&quot;oldGpgVersion20&quot;, [gpgVersion, getEnigmailGpg().getMinimumGpgVersion()]));</span>
<a href="#l29.548"></a><span id="l29.548" class="difflineminus">-      throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.549"></a><span id="l29.549" class="difflineminus">-    }</span>
<a href="#l29.550"></a><span id="l29.550" class="difflineminus">-</span>
<a href="#l29.551"></a><span id="l29.551" class="difflineminus">-    EnigmailGpgAgent.gpgconfPath = EnigmailGpgAgent.resolveToolPath(&quot;gpgconf&quot;);</span>
<a href="#l29.552"></a><span id="l29.552" class="difflineminus">-    EnigmailGpgAgent.connGpgAgentPath = EnigmailGpgAgent.resolveToolPath(&quot;gpg-connect-agent&quot;);</span>
<a href="#l29.553"></a><span id="l29.553" class="difflineminus">-</span>
<a href="#l29.554"></a><span id="l29.554" class="difflineminus">-    EnigmailGpgAgent.checkGpgHomeDir(domWindow, esvc);</span>
<a href="#l29.555"></a><span id="l29.555" class="difflineminus">-</span>
<a href="#l29.556"></a><span id="l29.556" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: setAgentPath: gpgconf found: &quot; + (EnigmailGpgAgent.gpgconfPath ? &quot;yes&quot; : &quot;no&quot;) + &quot;\n&quot;);</span>
<a href="#l29.557"></a><span id="l29.557" class="difflineminus">-  },</span>
<a href="#l29.558"></a><span id="l29.558" class="difflineminus">-</span>
<a href="#l29.559"></a><span id="l29.559" class="difflineminus">-</span>
<a href="#l29.560"></a><span id="l29.560" class="difflineminus">-  /**</span>
<a href="#l29.561"></a><span id="l29.561" class="difflineminus">-   * Determine the location of the GnuPG executable</span>
<a href="#l29.562"></a><span id="l29.562" class="difflineminus">-   *</span>
<a href="#l29.563"></a><span id="l29.563" class="difflineminus">-   * @param env: Object: nsIEnvironment to use</span>
<a href="#l29.564"></a><span id="l29.564" class="difflineminus">-   *</span>
<a href="#l29.565"></a><span id="l29.565" class="difflineminus">-   * @return Object: nsIFile pointing to gpg, or NULL</span>
<a href="#l29.566"></a><span id="l29.566" class="difflineminus">-   */</span>
<a href="#l29.567"></a><span id="l29.567" class="difflineminus">-  resolveGpgPath: function(env) {</span>
<a href="#l29.568"></a><span id="l29.568" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.resolveGpgPath()&quot;);</span>
<a href="#l29.569"></a><span id="l29.569" class="difflineminus">-    return;</span>
<a href="#l29.570"></a><span id="l29.570" class="difflineminus">-</span>
<a href="#l29.571"></a><span id="l29.571" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: resolveGpgPath()\n&quot;);</span>
<a href="#l29.572"></a><span id="l29.572" class="difflineminus">-</span>
<a href="#l29.573"></a><span id="l29.573" class="difflineminus">-    let agentName = &quot;&quot;;</span>
<a href="#l29.574"></a><span id="l29.574" class="difflineminus">-    if (EnigmailOS.isDosLike) {</span>
<a href="#l29.575"></a><span id="l29.575" class="difflineminus">-      agentName = &quot;gpg2.exe;gpg.exe&quot;;</span>
<a href="#l29.576"></a><span id="l29.576" class="difflineminus">-    }</span>
<a href="#l29.577"></a><span id="l29.577" class="difflineminus">-    else {</span>
<a href="#l29.578"></a><span id="l29.578" class="difflineminus">-      agentName = &quot;gpg2;gpg&quot;;</span>
<a href="#l29.579"></a><span id="l29.579" class="difflineminus">-    }</span>
<a href="#l29.580"></a><span id="l29.580" class="difflineminus">-</span>
<a href="#l29.581"></a><span id="l29.581" class="difflineminus">-    // Resolve relative path using PATH environment variable</span>
<a href="#l29.582"></a><span id="l29.582" class="difflineminus">-    const envPath = env.get(&quot;PATH&quot;);</span>
<a href="#l29.583"></a><span id="l29.583" class="difflineminus">-    let agentPath = EnigmailFiles.resolvePath(agentName, envPath, EnigmailOS.isDosLike);</span>
<a href="#l29.584"></a><span id="l29.584" class="difflineminus">-</span>
<a href="#l29.585"></a><span id="l29.585" class="difflineminus">-    if (!agentPath &amp;&amp; EnigmailOS.isDosLike) {</span>
<a href="#l29.586"></a><span id="l29.586" class="difflineminus">-      // DOS-like systems: search for GPG in c:\gnupg, c:\gnupg\bin, d:\gnupg, d:\gnupg\bin</span>
<a href="#l29.587"></a><span id="l29.587" class="difflineminus">-      let gpgPath = &quot;c:\\gnupg;c:\\gnupg\\bin;d:\\gnupg;d:\\gnupg\\bin&quot;;</span>
<a href="#l29.588"></a><span id="l29.588" class="difflineminus">-      agentPath = EnigmailFiles.resolvePath(agentName, gpgPath, EnigmailOS.isDosLike);</span>
<a href="#l29.589"></a><span id="l29.589" class="difflineminus">-    }</span>
<a href="#l29.590"></a><span id="l29.590" class="difflineminus">-</span>
<a href="#l29.591"></a><span id="l29.591" class="difflineminus">-    if ((!agentPath) &amp;&amp; EnigmailOS.isWin32) {</span>
<a href="#l29.592"></a><span id="l29.592" class="difflineminus">-      // Look up in Windows Registry</span>
<a href="#l29.593"></a><span id="l29.593" class="difflineminus">-      const installDir = [&quot;Software\\GNU\\GNUPG&quot;, &quot;Software\\GNUPG&quot;];</span>
<a href="#l29.594"></a><span id="l29.594" class="difflineminus">-</span>
<a href="#l29.595"></a><span id="l29.595" class="difflineminus">-      try {</span>
<a href="#l29.596"></a><span id="l29.596" class="difflineminus">-        for (let i = 0; i &lt; installDir.length &amp;&amp; !agentPath; i++) {</span>
<a href="#l29.597"></a><span id="l29.597" class="difflineminus">-          let gpgPath = EnigmailOS.getWinRegistryString(installDir[i], &quot;Install Directory&quot;, nsIWindowsRegKey.ROOT_KEY_LOCAL_MACHINE);</span>
<a href="#l29.598"></a><span id="l29.598" class="difflineminus">-</span>
<a href="#l29.599"></a><span id="l29.599" class="difflineminus">-          agentPath = EnigmailFiles.resolvePath(agentName, gpgPath, EnigmailOS.isDosLike());</span>
<a href="#l29.600"></a><span id="l29.600" class="difflineminus">-          if (!agentPath) {</span>
<a href="#l29.601"></a><span id="l29.601" class="difflineminus">-            gpgPath += &quot;\\bin&quot;;</span>
<a href="#l29.602"></a><span id="l29.602" class="difflineminus">-            agentPath = EnigmailFiles.resolvePath(agentName, gpgPath, EnigmailOS.isDosLike());</span>
<a href="#l29.603"></a><span id="l29.603" class="difflineminus">-          }</span>
<a href="#l29.604"></a><span id="l29.604" class="difflineminus">-        }</span>
<a href="#l29.605"></a><span id="l29.605" class="difflineminus">-      }</span>
<a href="#l29.606"></a><span id="l29.606" class="difflineminus">-      catch (ex) {}</span>
<a href="#l29.607"></a><span id="l29.607" class="difflineminus">-</span>
<a href="#l29.608"></a><span id="l29.608" class="difflineminus">-      if (!agentPath) {</span>
<a href="#l29.609"></a><span id="l29.609" class="difflineminus">-        // try to determine the default PATH from the registry after the installation</span>
<a href="#l29.610"></a><span id="l29.610" class="difflineminus">-        // if we could not get any information from the registry</span>
<a href="#l29.611"></a><span id="l29.611" class="difflineminus">-        try {</span>
<a href="#l29.612"></a><span id="l29.612" class="difflineminus">-          let winPath = EnigmailOS.getWinRegistryString(&quot;SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment&quot;, &quot;Path&quot;, nsIWindowsRegKey.ROOT_KEY_LOCAL_MACHINE);</span>
<a href="#l29.613"></a><span id="l29.613" class="difflineminus">-          agentPath = EnigmailFiles.resolvePath(agentName, winPath, EnigmailOS.isDosLike);</span>
<a href="#l29.614"></a><span id="l29.614" class="difflineminus">-        }</span>
<a href="#l29.615"></a><span id="l29.615" class="difflineminus">-        catch (ex) {}</span>
<a href="#l29.616"></a><span id="l29.616" class="difflineminus">-      }</span>
<a href="#l29.617"></a><span id="l29.617" class="difflineminus">-</span>
<a href="#l29.618"></a><span id="l29.618" class="difflineminus">-      if (!agentPath) {</span>
<a href="#l29.619"></a><span id="l29.619" class="difflineminus">-        // default for gpg4win 3.0</span>
<a href="#l29.620"></a><span id="l29.620" class="difflineminus">-        let gpgPath = &quot;C:\\Program Files\\GnuPG\\bin;C:\\Program Files (x86)\\GnuPG\\bin&quot;;</span>
<a href="#l29.621"></a><span id="l29.621" class="difflineminus">-        agentPath = EnigmailFiles.resolvePath(agentName, gpgPath, EnigmailOS.isDosLike);</span>
<a href="#l29.622"></a><span id="l29.622" class="difflineminus">-      }</span>
<a href="#l29.623"></a><span id="l29.623" class="difflineminus">-    }</span>
<a href="#l29.624"></a><span id="l29.624" class="difflineminus">-</span>
<a href="#l29.625"></a><span id="l29.625" class="difflineminus">-    if (!agentPath &amp;&amp; !EnigmailOS.isDosLike) {</span>
<a href="#l29.626"></a><span id="l29.626" class="difflineminus">-      // Unix-like systems: check /usr/bin and /usr/local/bin</span>
<a href="#l29.627"></a><span id="l29.627" class="difflineminus">-      let gpgPath = &quot;/usr/bin:/usr/local/bin&quot;;</span>
<a href="#l29.628"></a><span id="l29.628" class="difflineminus">-      agentPath = EnigmailFiles.resolvePath(agentName, gpgPath, EnigmailOS.isDosLike);</span>
<a href="#l29.629"></a><span id="l29.629" class="difflineminus">-    }</span>
<a href="#l29.630"></a><span id="l29.630" class="difflineminus">-</span>
<a href="#l29.631"></a><span id="l29.631" class="difflineminus">-    if (!agentPath) {</span>
<a href="#l29.632"></a><span id="l29.632" class="difflineminus">-      return null;</span>
<a href="#l29.633"></a><span id="l29.633" class="difflineminus">-    }</span>
<a href="#l29.634"></a><span id="l29.634" class="difflineminus">-</span>
<a href="#l29.635"></a><span id="l29.635" class="difflineminus">-    return agentPath.QueryInterface(Ci.nsIFile);</span>
<a href="#l29.636"></a><span id="l29.636" class="difflineminus">-  },</span>
<a href="#l29.637"></a><span id="l29.637" class="difflineminus">-</span>
<a href="#l29.638"></a><span id="l29.638" class="difflineminus">-  // resolve the path for GnuPG helper tools</span>
<a href="#l29.639"></a><span id="l29.639" class="difflineminus">-  resolveToolPath: function(fileName) {</span>
<a href="#l29.640"></a><span id="l29.640" class="difflineminus">-    let filePath = cloneOrNull(EnigmailGpgAgent.agentPath);</span>
<a href="#l29.641"></a><span id="l29.641" class="difflineminus">-</span>
<a href="#l29.642"></a><span id="l29.642" class="difflineminus">-    if (filePath) {</span>
<a href="#l29.643"></a><span id="l29.643" class="difflineminus">-      // try to get the install directory of gpg/gpg2 executable</span>
<a href="#l29.644"></a><span id="l29.644" class="difflineminus">-      filePath.normalize();</span>
<a href="#l29.645"></a><span id="l29.645" class="difflineminus">-      filePath = filePath.parent;</span>
<a href="#l29.646"></a><span id="l29.646" class="difflineminus">-    }</span>
<a href="#l29.647"></a><span id="l29.647" class="difflineminus">-</span>
<a href="#l29.648"></a><span id="l29.648" class="difflineminus">-    if (filePath) {</span>
<a href="#l29.649"></a><span id="l29.649" class="difflineminus">-      filePath.append(EnigmailFiles.potentialWindowsExecutable(fileName));</span>
<a href="#l29.650"></a><span id="l29.650" class="difflineminus">-      if (filePath.exists()) {</span>
<a href="#l29.651"></a><span id="l29.651" class="difflineminus">-        filePath.normalize();</span>
<a href="#l29.652"></a><span id="l29.652" class="difflineminus">-        return filePath;</span>
<a href="#l29.653"></a><span id="l29.653" class="difflineminus">-      }</span>
<a href="#l29.654"></a><span id="l29.654" class="difflineminus">-    }</span>
<a href="#l29.655"></a><span id="l29.655" class="difflineminus">-</span>
<a href="#l29.656"></a><span id="l29.656" class="difflineminus">-    return EnigmailFiles.resolvePathWithEnv(fileName);</span>
<a href="#l29.657"></a><span id="l29.657" class="difflineminus">-  },</span>
<a href="#l29.658"></a><span id="l29.658" class="difflineminus">-</span>
<a href="#l29.659"></a><span id="l29.659" class="difflineminus">-  detectGpgAgent: function(domWindow, esvc) {</span>
<a href="#l29.660"></a><span id="l29.660" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: detectGpgAgent\n&quot;);</span>
<a href="#l29.661"></a><span id="l29.661" class="difflineminus">-</span>
<a href="#l29.662"></a><span id="l29.662" class="difflineminus">-    var gpgAgentInfo = esvc.environment.get(&quot;GPG_AGENT_INFO&quot;);</span>
<a href="#l29.663"></a><span id="l29.663" class="difflineminus">-    if (gpgAgentInfo &amp;&amp; gpgAgentInfo.length &gt; 0) {</span>
<a href="#l29.664"></a><span id="l29.664" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: detectGpgAgent: GPG_AGENT_INFO variable available\n&quot;);</span>
<a href="#l29.665"></a><span id="l29.665" class="difflineminus">-      // env. variable suggests running gpg-agent</span>
<a href="#l29.666"></a><span id="l29.666" class="difflineminus">-      EnigmailGpgAgent.gpgAgentInfo.preStarted = true;</span>
<a href="#l29.667"></a><span id="l29.667" class="difflineminus">-      EnigmailGpgAgent.gpgAgentInfo.envStr = gpgAgentInfo;</span>
<a href="#l29.668"></a><span id="l29.668" class="difflineminus">-      EnigmailGpgAgent.gpgAgentIsOptional = false;</span>
<a href="#l29.669"></a><span id="l29.669" class="difflineminus">-    }</span>
<a href="#l29.670"></a><span id="l29.670" class="difflineminus">-    else {</span>
<a href="#l29.671"></a><span id="l29.671" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: detectGpgAgent: no GPG_AGENT_INFO variable set\n&quot;);</span>
<a href="#l29.672"></a><span id="l29.672" class="difflineminus">-      EnigmailGpgAgent.gpgAgentInfo.preStarted = false;</span>
<a href="#l29.673"></a><span id="l29.673" class="difflineminus">-</span>
<a href="#l29.674"></a><span id="l29.674" class="difflineminus">-      if (!getEnigmailGpg().getGpgFeature(&quot;supports-gpg-agent&quot;)) {</span>
<a href="#l29.675"></a><span id="l29.675" class="difflineminus">-        esvc.initializationError = EnigmailLocale.getString(&quot;gpgAgent.noAutostart&quot;, getEnigmailGpg().agentVersion);</span>
<a href="#l29.676"></a><span id="l29.676" class="difflineminus">-        EnigmailLog.ERROR(&quot;gpgAgent.jsm: Error - &quot; + esvc.initializationError + &quot;\n&quot;);</span>
<a href="#l29.677"></a><span id="l29.677" class="difflineminus">-        throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.678"></a><span id="l29.678" class="difflineminus">-      }</span>
<a href="#l29.679"></a><span id="l29.679" class="difflineminus">-</span>
<a href="#l29.680"></a><span id="l29.680" class="difflineminus">-      var command = null;</span>
<a href="#l29.681"></a><span id="l29.681" class="difflineminus">-      var outStr = &quot;&quot;;</span>
<a href="#l29.682"></a><span id="l29.682" class="difflineminus">-      var errorStr = &quot;&quot;;</span>
<a href="#l29.683"></a><span id="l29.683" class="difflineminus">-      var exitCode = -1;</span>
<a href="#l29.684"></a><span id="l29.684" class="difflineminus">-      EnigmailGpgAgent.gpgAgentIsOptional = false;</span>
<a href="#l29.685"></a><span id="l29.685" class="difflineminus">-</span>
<a href="#l29.686"></a><span id="l29.686" class="difflineminus">-</span>
<a href="#l29.687"></a><span id="l29.687" class="difflineminus">-      EnigmailGpgAgent.gpgAgentInfo.envStr = DUMMY_AGENT_INFO;</span>
<a href="#l29.688"></a><span id="l29.688" class="difflineminus">-      var envFile = Components.classes[NS_LOCAL_FILE_CONTRACTID].createInstance(Ci.nsIFile);</span>
<a href="#l29.689"></a><span id="l29.689" class="difflineminus">-      EnigmailFiles.initPath(envFile, EnigmailGpgAgent.determineGpgHomeDir(esvc));</span>
<a href="#l29.690"></a><span id="l29.690" class="difflineminus">-      envFile.append(&quot;gpg-agent.conf&quot;);</span>
<a href="#l29.691"></a><span id="l29.691" class="difflineminus">-</span>
<a href="#l29.692"></a><span id="l29.692" class="difflineminus">-      if (!envFile.exists()) {</span>
<a href="#l29.693"></a><span id="l29.693" class="difflineminus">-        EnigmailLog.DEBUG(&quot;gpgAgent.jsm: detectGpgAgent: writing gpg-agent.conf file\n&quot;);</span>
<a href="#l29.694"></a><span id="l29.694" class="difflineminus">-        let data = &quot;default-cache-ttl &quot; + (EnigmailPassword.getMaxIdleMinutes() * 60) + &quot;\n&quot;;</span>
<a href="#l29.695"></a><span id="l29.695" class="difflineminus">-        data += &quot;max-cache-ttl 999999\n&quot;;</span>
<a href="#l29.696"></a><span id="l29.696" class="difflineminus">-        try {</span>
<a href="#l29.697"></a><span id="l29.697" class="difflineminus">-          var flags = 0x02 | 0x08 | 0x20;</span>
<a href="#l29.698"></a><span id="l29.698" class="difflineminus">-          var fileOutStream = Cc[NS_LOCALFILEOUTPUTSTREAM_CONTRACTID].createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l29.699"></a><span id="l29.699" class="difflineminus">-          fileOutStream.init(envFile, flags, 384, 0); // 0600</span>
<a href="#l29.700"></a><span id="l29.700" class="difflineminus">-          fileOutStream.write(data, data.length);</span>
<a href="#l29.701"></a><span id="l29.701" class="difflineminus">-          fileOutStream.flush();</span>
<a href="#l29.702"></a><span id="l29.702" class="difflineminus">-          fileOutStream.close();</span>
<a href="#l29.703"></a><span id="l29.703" class="difflineminus">-        }</span>
<a href="#l29.704"></a><span id="l29.704" class="difflineminus">-        catch (ex) {} // ignore file write errors</span>
<a href="#l29.705"></a><span id="l29.705" class="difflineminus">-      }</span>
<a href="#l29.706"></a><span id="l29.706" class="difflineminus">-</span>
<a href="#l29.707"></a><span id="l29.707" class="difflineminus">-    }</span>
<a href="#l29.708"></a><span id="l29.708" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: detectGpgAgent: GPG_AGENT_INFO='&quot; + EnigmailGpgAgent.gpgAgentInfo.envStr + &quot;'\n&quot;);</span>
<a href="#l29.709"></a><span id="l29.709" class="difflineminus">-  },</span>
<a href="#l29.710"></a><span id="l29.710" class="difflineminus">-</span>
<a href="#l29.711"></a><span id="l29.711" class="difflineminus">-  /**</span>
<a href="#l29.712"></a><span id="l29.712" class="difflineminus">-   * Determine the GnuPG home directory based on the same logic as GnuPG, but without involving</span>
<a href="#l29.713"></a><span id="l29.713" class="difflineminus">-   * any external tool.</span>
<a href="#l29.714"></a><span id="l29.714" class="difflineminus">-   *</span>
<a href="#l29.715"></a><span id="l29.715" class="difflineminus">-   * @return String - the path to the gpg home directory</span>
<a href="#l29.716"></a><span id="l29.716" class="difflineminus">-   */</span>
<a href="#l29.717"></a><span id="l29.717" class="difflineminus">-  determineGpgHomeDir: function(esvc) {</span>
<a href="#l29.718"></a><span id="l29.718" class="difflineminus">-</span>
<a href="#l29.719"></a><span id="l29.719" class="difflineminus">-    let param = EnigmailPrefs.getPref(&quot;agentAdditionalParam&quot;);</span>
<a href="#l29.720"></a><span id="l29.720" class="difflineminus">-    if (param) {</span>
<a href="#l29.721"></a><span id="l29.721" class="difflineminus">-      let hd = getHomedirFromParam(param);</span>
<a href="#l29.722"></a><span id="l29.722" class="difflineminus">-</span>
<a href="#l29.723"></a><span id="l29.723" class="difflineminus">-      if (hd) return hd;</span>
<a href="#l29.724"></a><span id="l29.724" class="difflineminus">-    }</span>
<a href="#l29.725"></a><span id="l29.725" class="difflineminus">-</span>
<a href="#l29.726"></a><span id="l29.726" class="difflineminus">-    let homeDir = esvc.environment.get(&quot;GNUPGHOME&quot;);</span>
<a href="#l29.727"></a><span id="l29.727" class="difflineminus">-</span>
<a href="#l29.728"></a><span id="l29.728" class="difflineminus">-    if (!homeDir &amp;&amp; EnigmailOS.isWin32) {</span>
<a href="#l29.729"></a><span id="l29.729" class="difflineminus">-      homeDir = EnigmailOS.getWinRegistryString(&quot;Software\\GNU\\GNUPG&quot;, &quot;HomeDir&quot;, nsIWindowsRegKey.ROOT_KEY_CURRENT_USER);</span>
<a href="#l29.730"></a><span id="l29.730" class="difflineminus">-</span>
<a href="#l29.731"></a><span id="l29.731" class="difflineminus">-      if (!homeDir) {</span>
<a href="#l29.732"></a><span id="l29.732" class="difflineminus">-        homeDir = esvc.environment.get(&quot;USERPROFILE&quot;) || esvc.environment.get(&quot;SystemRoot&quot;);</span>
<a href="#l29.733"></a><span id="l29.733" class="difflineminus">-</span>
<a href="#l29.734"></a><span id="l29.734" class="difflineminus">-        if (homeDir) homeDir += &quot;\\Application Data\\GnuPG&quot;;</span>
<a href="#l29.735"></a><span id="l29.735" class="difflineminus">-      }</span>
<a href="#l29.736"></a><span id="l29.736" class="difflineminus">-</span>
<a href="#l29.737"></a><span id="l29.737" class="difflineminus">-      if (!homeDir) homeDir = &quot;C:\\gnupg&quot;;</span>
<a href="#l29.738"></a><span id="l29.738" class="difflineminus">-    }</span>
<a href="#l29.739"></a><span id="l29.739" class="difflineminus">-</span>
<a href="#l29.740"></a><span id="l29.740" class="difflineminus">-    if (!homeDir) homeDir = esvc.environment.get(&quot;HOME&quot;) + &quot;/.gnupg&quot;;</span>
<a href="#l29.741"></a><span id="l29.741" class="difflineminus">-</span>
<a href="#l29.742"></a><span id="l29.742" class="difflineminus">-    return homeDir;</span>
<a href="#l29.743"></a><span id="l29.743" class="difflineminus">-  },</span>
<a href="#l29.744"></a><span id="l29.744" class="difflineminus">-</span>
<a href="#l29.745"></a><span id="l29.745" class="difflineminus">-  /**</span>
<a href="#l29.746"></a><span id="l29.746" class="difflineminus">-   * Check if the users directory for GnuPG exists and is writeable.</span>
<a href="#l29.747"></a><span id="l29.747" class="difflineminus">-   * Throw exception if directory cannot be created or adjusted.</span>
<a href="#l29.748"></a><span id="l29.748" class="difflineminus">-   */</span>
<a href="#l29.749"></a><span id="l29.749" class="difflineminus">-  checkGpgHomeDir: function(domWindow, esvc) {</span>
<a href="#l29.750"></a><span id="l29.750" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: checkGpgHomeDir:\n&quot;);</span>
<a href="#l29.751"></a><span id="l29.751" class="difflineminus">-</span>
<a href="#l29.752"></a><span id="l29.752" class="difflineminus">-    let homeDir = EnigmailGpgAgent.getGpgHomeDir();</span>
<a href="#l29.753"></a><span id="l29.753" class="difflineminus">-    if (!homeDir) homeDir = EnigmailGpgAgent.determineGpgHomeDir(esvc);</span>
<a href="#l29.754"></a><span id="l29.754" class="difflineminus">-</span>
<a href="#l29.755"></a><span id="l29.755" class="difflineminus">-    EnigmailLog.DEBUG(&quot;gpgAgent.jsm: checkGpgHomeDir: got homedir = '&quot; + homeDir + &quot;'\n&quot;);</span>
<a href="#l29.756"></a><span id="l29.756" class="difflineminus">-</span>
<a href="#l29.757"></a><span id="l29.757" class="difflineminus">-    let homeDirObj = Components.classes[NS_LOCAL_FILE_CONTRACTID].createInstance(Ci.nsIFile);</span>
<a href="#l29.758"></a><span id="l29.758" class="difflineminus">-    EnigmailFiles.initPath(homeDirObj, homeDir);</span>
<a href="#l29.759"></a><span id="l29.759" class="difflineminus">-</span>
<a href="#l29.760"></a><span id="l29.760" class="difflineminus">-    if (homeDirObj.exists()) {</span>
<a href="#l29.761"></a><span id="l29.761" class="difflineminus">-      homeDirObj.normalize(); // resolve symlinks etc.</span>
<a href="#l29.762"></a><span id="l29.762" class="difflineminus">-    }</span>
<a href="#l29.763"></a><span id="l29.763" class="difflineminus">-</span>
<a href="#l29.764"></a><span id="l29.764" class="difflineminus">-    let dirType = EnigmailFiles.ensureWritableDirectory(homeDirObj, 0x1C0); // 0700</span>
<a href="#l29.765"></a><span id="l29.765" class="difflineminus">-    let errMsg = &quot;&quot;;</span>
<a href="#l29.766"></a><span id="l29.766" class="difflineminus">-    switch (dirType) {</span>
<a href="#l29.767"></a><span id="l29.767" class="difflineminus">-      case 1:</span>
<a href="#l29.768"></a><span id="l29.768" class="difflineminus">-        errMsg = &quot;gpghomedir.notexists&quot;;</span>
<a href="#l29.769"></a><span id="l29.769" class="difflineminus">-        break;</span>
<a href="#l29.770"></a><span id="l29.770" class="difflineminus">-      case 2:</span>
<a href="#l29.771"></a><span id="l29.771" class="difflineminus">-        errMsg = &quot;gpghomedir.notwritable&quot;;</span>
<a href="#l29.772"></a><span id="l29.772" class="difflineminus">-        break;</span>
<a href="#l29.773"></a><span id="l29.773" class="difflineminus">-      case 3:</span>
<a href="#l29.774"></a><span id="l29.774" class="difflineminus">-        errMsg = &quot;gpghomedir.notdirectory&quot;;</span>
<a href="#l29.775"></a><span id="l29.775" class="difflineminus">-        break;</span>
<a href="#l29.776"></a><span id="l29.776" class="difflineminus">-    }</span>
<a href="#l29.777"></a><span id="l29.777" class="difflineminus">-</span>
<a href="#l29.778"></a><span id="l29.778" class="difflineminus">-    if (errMsg.length &gt; 0) {</span>
<a href="#l29.779"></a><span id="l29.779" class="difflineminus">-      if (!domWindow) {</span>
<a href="#l29.780"></a><span id="l29.780" class="difflineminus">-        domWindow = EnigmailWindows.getBestParentWin();</span>
<a href="#l29.781"></a><span id="l29.781" class="difflineminus">-      }</span>
<a href="#l29.782"></a><span id="l29.782" class="difflineminus">-      getDialog().alert(domWindow, EnigmailLocale.getString(errMsg, homeDir) + &quot;\n\n&quot; + EnigmailLocale.getString(&quot;gpghomedir.notusable&quot;));</span>
<a href="#l29.783"></a><span id="l29.783" class="difflineminus">-      throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l29.784"></a><span id="l29.784" class="difflineminus">-    }</span>
<a href="#l29.785"></a><span id="l29.785" class="difflineminus">-  },</span>
<a href="#l29.786"></a><span id="l29.786" class="difflineminus">-</span>
<a href="#l29.787"></a><span id="l29.787" class="difflineminus">-  finalize: function() {</span>
<a href="#l29.788"></a><span id="l29.788" class="difflineminus">-    console.debug(&quot;reaching disabled EnigmailGpgAgent.finalize()&quot;);</span>
<a href="#l29.789"></a><span id="l29.789" class="difflineminus">-    return;</span>
<a href="#l29.790"></a><span id="l29.790" class="difflineminus">-</span>
<a href="#l29.791"></a><span id="l29.791" class="difflineminus">-    if (EnigmailGpgAgent.gpgAgentProcess) {</span>
<a href="#l29.792"></a><span id="l29.792" class="difflineminus">-      EnigmailLog.DEBUG(&quot;gpgAgent.jsm: EnigmailGpgAgent.finalize: stopping gpg-agent\n&quot;);</span>
<a href="#l29.793"></a><span id="l29.793" class="difflineminus">-      try {</span>
<a href="#l29.794"></a><span id="l29.794" class="difflineminus">-        const proc = {</span>
<a href="#l29.795"></a><span id="l29.795" class="difflineminus">-          command: EnigmailGpgAgent.connGpgAgentPath,</span>
<a href="#l29.796"></a><span id="l29.796" class="difflineminus">-          arguments: ['killagent', '/bye'],</span>
<a href="#l29.797"></a><span id="l29.797" class="difflineminus">-          environment: EnigmailCore.getEnvList()</span>
<a href="#l29.798"></a><span id="l29.798" class="difflineminus">-        };</span>
<a href="#l29.799"></a><span id="l29.799" class="difflineminus">-</span>
<a href="#l29.800"></a><span id="l29.800" class="difflineminus">-        subprocess.call(proc).wait();</span>
<a href="#l29.801"></a><span id="l29.801" class="difflineminus">-      }</span>
<a href="#l29.802"></a><span id="l29.802" class="difflineminus">-      catch (ex) {</span>
<a href="#l29.803"></a><span id="l29.803" class="difflineminus">-        EnigmailLog.ERROR(&quot;gpgAgent.jsm: EnigmailGpgAgent.finalize ERROR: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l29.804"></a><span id="l29.804" class="difflineminus">-      }</span>
<a href="#l29.805"></a><span id="l29.805" class="difflineminus">-    }</span>
<a href="#l29.806"></a><span id="l29.806" class="difflineminus">-  }</span>
<a href="#l29.807"></a><span id="l29.807" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyEditor.jsm</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,1392 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">-/*</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">- */</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailKeyEditor&quot;];</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-const EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-const EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-const EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-const GET_BOOL = &quot;GET_BOOL&quot;;</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-const GET_LINE = &quot;GET_LINE&quot;;</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-const GET_HIDDEN = &quot;GET_HIDDEN&quot;;</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-const NS_PROMPTSERVICE_CONTRACTID = &quot;@mozilla.org/embedcomp/prompt-service;1&quot;;</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-function GpgEditorInterface(reqObserver, callbackFunc, inputData) {</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-  this._reqObserver = reqObserver;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-  this._callbackFunc = callbackFunc;</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-  this._inputData = inputData;</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-  if (this._inputData &amp;&amp; this._inputData.cardAdmin) {</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-    this._saveCmd = &quot;quit&quot;;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-  }</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-  else</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-    this._saveCmd = &quot;save&quot;;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-}</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-GpgEditorInterface.prototype = {</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-  _stdin: null,</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-  _data: &quot;&quot;,</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-  _txt: &quot;&quot;,</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-  _exitCode: 0,</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-  errorMsg: &quot;&quot;,</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-  setStdin: function(pipe) {</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-    this._stdin = pipe;</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-    if (this._data.length &gt; 0) this.processData();</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-  },</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-  gotData: function(data) {</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-    //EnigmailLog.DEBUG(&quot;keyEditor.jsm: GpgEditorInterface.gotData: '&quot;+data+&quot;'\n&quot;);</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-    this._data += data.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-    this.processData();</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-  },</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-  processData: function() {</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-    //EnigmailLog.DEBUG(&quot;keyEditor.jsm: GpgEditorInterface.processData\n&quot;);</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-    var txt = &quot;&quot;;</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-    while (this._data.length &gt; 0 &amp;&amp; this._stdin) {</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-      var index = this._data.indexOf(&quot;\n&quot;);</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-      if (index &lt; 0) {</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-        txt = this._data;</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-        this._data = &quot;&quot;;</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-      }</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-      else {</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-        txt = this._data.substr(0, index);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-        this._data = this._data.substr(index + 1);</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-      }</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-      this.nextLine(txt);</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-    }</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-  },</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-  closeStdin: function() {</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEditor.jsm: GpgEditorInterface.closeStdin:\n&quot;);</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-    if (this._stdin) {</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-      this._stdin.close();</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-      this._stdin = null;</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-    }</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-  },</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-  onComplete: function(parentCallback, exitCode) {</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.onComplete: exitCode=&quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-    if (exitCode === 0) exitCode = this._exitCode;</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.onComplete: returning exitCode &quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-    parentCallback(exitCode, this.errorMsg);</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-  },</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-  writeLine: function(inputData) {</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.writeLine: '&quot; + inputData + &quot;'\n&quot;);</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-    this._stdin.write(inputData + &quot;\n&quot;);</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-  },</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-  nextLine: function(txt) {</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-    if (txt.indexOf(&quot;[GNUPG:]&quot;) &gt;= 0) {</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-      if (this._reqObserver) {</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-        var newTxt = this._reqObserver.onDataAvailable(txt);</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-        if (newTxt.length &gt; 0) {</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-          txt = newTxt;</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-        }</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-      }</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-      this._txt = txt;</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-      this.processLine(txt);</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-    }</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-  },</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-  doCheck: function(inputType, promptVal) {</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineminus">-    var a = this._txt.split(/ /);</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineminus">-    return ((a[1] == inputType) &amp;&amp; (a[2] == promptVal));</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-  },</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-  getText: function() {</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-    return this._txt;</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-  },</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineminus">-  handleGpgError: function(lineTxt) {</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-    let retStatusObj = {};</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">-    EnigmailErrorHandling.parseErrorOutput(lineTxt, retStatusObj);</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineminus">-    return retStatusObj;</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineminus">-  },</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineminus">-</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineminus">-  processLine: function(txt) {</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: '&quot; + txt + &quot;'\n&quot;);</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-    var r = {</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-      quitNow: false,</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-      exitCode: -1</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineminus">-    };</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineminus">-    try {</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-      if (txt.indexOf(&quot;[GNUPG:] BAD_PASSPHRASE&quot;) &gt;= 0 ||</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineminus">-        txt.indexOf(&quot;[GNUPG:] SC_OP_FAILURE 2&quot;) &gt;= 0) {</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineminus">-        EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: detected bad passphrase\n&quot;);</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-        r.exitCode = -2;</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-        r.quitNow = true;</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-        this.errorMsg = EnigmailLocale.getString(&quot;badPhrase&quot;);</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-      }</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-      else if (txt.indexOf(&quot;[GNUPG:] ERROR &quot;) &gt;= 0 || txt.indexOf(&quot;[GNUPG:] FAILURE &quot;) &gt;= 0) {</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-        EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: detected GnuPG ERROR message\n&quot;);</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">-        let statusObj = this.handleGpgError(txt);</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">-        if (statusObj.statusFlags &amp; EnigmailConstants.DISPLAY_MESSAGE) {</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-          this.errorMsg = statusObj.statusMsg;</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-          r.exitCode = -3;</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">-          r.quitNow = true;</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-        }</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-      }</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-      else if (txt.indexOf(&quot;[GNUPG:] NO_CARD_AVAILABLE&quot;) &gt;= 0) {</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-        EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: detected missing card\n&quot;);</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-        this.errorMsg = EnigmailLocale.getString(&quot;sc.noCardAvailable&quot;);</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-        r.exitCode = -3;</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-        r.quitNow = true;</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineminus">-      }</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineminus">-      else if (txt.indexOf(&quot;[GNUPG:] ENIGMAIL_FAILURE&quot;) === 0) {</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineminus">-        EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: detected general failure\n&quot;);</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-        r.exitCode = -3;</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-        r.quitNow = true;</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-        this.errorMsg = txt.substr(26);</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineminus">-      }</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-      else if (txt.indexOf(&quot;[GNUPG:] ALREADY_SIGNED&quot;) &gt;= 0) {</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-        EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: detected key already signed\n&quot;);</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-        this.errorMsg = EnigmailLocale.getString(&quot;keyAlreadySigned&quot;);</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-        r.exitCode = -1;</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineminus">-        r.quitNow = true;</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineminus">-      }</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineminus">-      else if (txt.indexOf(&quot;[GNUPG:] MISSING_PASSPHRASE&quot;) &gt;= 0) {</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineminus">-        EnigmailLog.DEBUG(&quot;keyEdit.jsm: GpgEditorInterface.processLine: detected missing passphrase\n&quot;);</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineminus">-        this.errorMsg = EnigmailLocale.getString(&quot;noPassphrase&quot;);</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-        r.exitCode = -2;</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-        this._exitCode = -2;</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-        r.quitNow = true;</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-      }</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-      else if (txt.indexOf(&quot;[GNUPG:] GET_&quot;) &lt; 0) {</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-        // return if no &quot;GET&quot; statement</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-        return;</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-      }</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-    }</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-    catch (ex) {</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-      txt = &quot;&quot;;</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineminus">-      r.quitNow = true;</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-    }</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-    if (!r.quitNow) {</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-      if (txt.indexOf(&quot;[GNUPG:] GOT_IT&quot;) &lt; 0) {</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-        if (this._callbackFunc) {</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-          this._callbackFunc(this._inputData, this, r);</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-          if (r.exitCode === 0) {</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-            this.writeLine(r.writeTxt);</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-          }</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-          else {</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineminus">-            if (r.errorMsg &amp;&amp; r.errorMsg.length &gt; 0)</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineminus">-              this.errorMsg = r.errorMsg;</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineminus">-          }</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineminus">-        }</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-        else {</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineminus">-          r.quitNow = true;</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineminus">-          r.exitCode = 0;</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineminus">-        }</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-      }</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-      else {</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-        r.exitCode = 0;</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineminus">-      }</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineminus">-    }</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineminus">-</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineminus">-    if (r.quitNow) {</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-      try {</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-        this.writeLine(this._saveCmd);</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">-        this.closeStdin();</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">-      }</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-      catch (ex) {</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-        EnigmailLog.DEBUG(&quot;no more data\n&quot;);</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-      }</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-    }</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-    if (r.exitCode !== null)</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-      this._exitCode = r.exitCode;</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-  },</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">-  QueryInterface: function(iid) {</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">-    if (!iid.equals(Ci.nsISupports))</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineminus">-      throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineminus">-    return this;</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineminus">-  }</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineminus">-};</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineminus">-function editKey(parent, needPassphrase, userId, keyId, editCmd, inputData, callbackFunc, requestObserver, parentCallback) {</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineminus">-  EnigmailLog.DEBUG(&quot;keyEdit.jsm: editKey: parent=&quot; + parent + &quot;, editCmd=&quot; + editCmd + &quot;\n&quot;);</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-  if (!EnigmailCore.getService(parent)) {</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-    EnigmailLog.ERROR(&quot;keyEdit.jsm: Enigmail.editKey: not yet initialized\n&quot;);</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-    parentCallback(-1, EnigmailLocale.getString(&quot;notInit&quot;));</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-    return -1;</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">-  }</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">-</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-  var keyIdList = keyId.split(&quot; &quot;);</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineminus">-  var args = EnigmailGpg.getStandardArgs(false);</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineminus">-</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-  var statusFlags = {};</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineminus">-</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineminus">-  args = args.concat([&quot;--no-tty&quot;, &quot;--no-verbose&quot;, &quot;--status-fd&quot;, &quot;1&quot;, &quot;--logger-fd&quot;, &quot;1&quot;, &quot;--command-fd&quot;, &quot;0&quot;]);</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineminus">-  if (userId) args = args.concat([&quot;-u&quot;, userId]);</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineminus">-  var editCmdArr;</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineminus">-  if (typeof(editCmd) == &quot;string&quot;) {</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineminus">-    editCmdArr = [editCmd];</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineminus">-  }</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineminus">-  else {</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineminus">-    editCmdArr = editCmd;</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineminus">-  }</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">-</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineminus">-  if (editCmdArr[0] == &quot;revoke&quot;) {</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineminus">-    // escape backslashes and ' characters</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineminus">-    args = args.concat([&quot;-a&quot;, &quot;-o&quot;]);</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineminus">-    args.push(EnigmailFiles.getEscapedFilename(inputData.outFile.path));</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-    args.push(&quot;--gen-revoke&quot;);</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">-    args = args.concat(keyIdList);</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineminus">-  }</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineminus">-  else if (editCmdArr[0].indexOf(&quot;--&quot;) === 0) {</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineminus">-    args = args.concat(editCmd);</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineminus">-    args = args.concat(keyIdList);</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineminus">-  }</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineminus">-  else {</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineminus">-    args = args.concat([&quot;--ask-cert-level&quot;, &quot;--edit-key&quot;, keyId]);</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineminus">-    args = args.concat(editCmd);</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-  }</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-  var command = EnigmailGpgAgent.agentPath;</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineminus">-  EnigmailLog.CONSOLE(&quot;enigmail&gt; &quot; + EnigmailFiles.formatCmdLine(command, args) + &quot;\n&quot;);</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-  var keyEdit = new GpgEditorInterface(requestObserver, callbackFunc, inputData);</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineminus">-</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-  try {</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-    EnigmailExecution.execCmd2(command, args,</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-      keyEdit.setStdin.bind(keyEdit),</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-      keyEdit.gotData.bind(keyEdit),</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-      function(result) {</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-        EnigmailKeyRing.updateKeys(keyIdList);</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-        keyEdit.onComplete(parentCallback, 0); // ignore exit code from GnuPG</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-      }</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineminus">-    );</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineminus">-  }</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineminus">-  catch (ex) {</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineminus">-    EnigmailLog.ERROR(&quot;keyEditor.jsm: editKey: &quot; + command.path + &quot; failed\n&quot;);</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineminus">-    parentCallback(-1, &quot;&quot;);</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineminus">-  }</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineminus">-  return null;</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineminus">-}</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineminus">-</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineminus">-function runKeyTrustCheck(callbackFunc) {</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineminus">-  EnigmailLog.DEBUG(&quot;keyEdit.jsm: runKeyTrustCheck()\n&quot;);</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineminus">-</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineminus">-  let args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineminus">-  args = args.concat([&quot;--yes&quot;, &quot;--check-trustdb&quot;]);</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineminus">-  EnigmailExecution.execCmd2(EnigmailGpgAgent.agentPath,</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineminus">-    args,</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineminus">-    null,</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-    function stdout(data) {</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineminus">-      EnigmailLog.DEBUG(data);</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-    },</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-    function(result) {</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineminus">-      EnigmailLog.DEBUG(&quot;keyEdit.jsm: runKeyTrustCheck: done\n&quot;);</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-    });</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineminus">-}</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-/*</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">- * NOTE: the callbackFunc used in every call to the key editor needs to be implemented like this:</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineminus">- * callbackFunc(returnCode, errorMsg)</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineminus">- * returnCode = 0 in case of success</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">- * returnCode != 0 and errorMsg set in case of failure</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineminus">- */</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineminus">-var EnigmailKeyEditor = {</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-  setKeyTrust: function(parent, keyId, trustLevel, callbackFunc) {</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.setKeyTrust: trustLevel=&quot; + trustLevel + &quot;, keyId=&quot; + keyId + &quot;\n&quot;);</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-    return editKey(parent, false, null, keyId, &quot;trust&quot;, {</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-        trustLevel: trustLevel</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineminus">-      },</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-      keyTrustCallback,</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-      null,</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineminus">-      function _f(returnCode, errorMsg) {</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineminus">-        runKeyTrustCheck();</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineminus">-        EnigmailKeyRing.updateKeys([keyId]);</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-        callbackFunc(returnCode, errorMsg);</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineminus">-      });</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineminus">-  },</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineminus">-  /**</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-   * Call editKey() to set the expiration date of the chosen key and subkeys</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineminus">-   *</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineminus">-   * @param  Object    parent</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineminus">-   * @param  String    keyId         e.g. 8D18EB22FDF633A2</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-   * @param  Array     subKeys       List of Integer values, e.g. [0,1,3]</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">-   *                                 &quot;0&quot; should allways be set because it's the main key.</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-   * @param  Integer   expiryLength  A number between 1 and 100</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-   * @param  Integer   timeScale     1 or 30 or 365 meaning days, months, years</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">-   * @param  Boolean   noExpiry      True: Expire never. False: Use expiryLength.</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-   * @param  Function  callbackFunc  will be executed by editKey()</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineminus">-   * @return  Integer</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineminus">-   *          returnCode = 0 in case of success</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineminus">-   *          returnCode != 0 and errorMsg set in case of failure</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineminus">-   */</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineminus">-  setKeyExpiration: function(parent, keyId, subKeys, expiryLength, timeScale, noExpiry, callbackFunc) {</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.setKeyExpiry: keyId=&quot; + keyId + &quot;\n&quot;);</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineminus">-</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineminus">-    expiryLength = String(expiryLength);</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineminus">-    if (noExpiry === true) {</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineminus">-      expiryLength = &quot;0&quot;;</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineminus">-    }</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-    else {</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-      switch (parseInt(timeScale, 10)) {</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-        case 365:</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineminus">-          expiryLength += &quot;y&quot;;</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineminus">-          break;</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-        case 30:</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-          expiryLength += &quot;m&quot;;</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineminus">-          break;</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineminus">-        case 7:</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineminus">-          expiryLength += &quot;w&quot;;</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineminus">-          break;</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineminus">-      }</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineminus">-    }</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineminus">-</span>
<a href="#l30.383"></a><span id="l30.383" class="difflineminus">-    return editKey(parent,</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineminus">-      true,</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineminus">-      null,</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineminus">-      keyId,</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineminus">-      &quot;&quot;, /* &quot;expire&quot;, */ {</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineminus">-        expiryLength: expiryLength,</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineminus">-        subKeys: subKeys,</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineminus">-        currentSubKey: false</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineminus">-      },</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineminus">-      keyExpiryCallback, /* contains the gpg communication logic */</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-      null,</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineminus">-  },</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineminus">-</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineminus">-</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineminus">-  signKey: function(parent, userId, keyId, signLocally, trustLevel, callbackFunc) {</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.signKey: trustLevel=&quot; + trustLevel + &quot;, userId=&quot; + userId + &quot;, keyId=&quot; + keyId + &quot;\n&quot;);</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineminus">-    return editKey(parent, true, userId, keyId, (signLocally ? &quot;lsign&quot; : &quot;sign&quot;), {</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineminus">-        trustLevel: trustLevel,</span>
<a href="#l30.402"></a><span id="l30.402" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineminus">-      },</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineminus">-      signKeyCallback,</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineminus">-      null,</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineminus">-      function _f(returnCode, errorMsg) {</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-        runKeyTrustCheck();</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineminus">-        EnigmailKeyRing.updateKeys([keyId]);</span>
<a href="#l30.409"></a><span id="l30.409" class="difflineminus">-        callbackFunc(returnCode, errorMsg);</span>
<a href="#l30.410"></a><span id="l30.410" class="difflineminus">-      });</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineminus">-      </span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-  },</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineminus">-</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineminus">-  genRevokeCert: function(parent, keyId, outFile, reasonCode, reasonText, callbackFunc) {</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.genRevokeCert: keyId=&quot; + keyId + &quot;\n&quot;);</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineminus">-</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineminus">-    /**</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineminus">-     * GnuPG &lt; 2.1 does not properly report failures;</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineminus">-     * therefore we check if the revokation certificate was really generated</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineminus">-     */</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineminus">-    function checkGeneratedCert(exitCode, errorMsg) {</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineminus">-      if (!outFile.exists()) {</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineminus">-        exitCode = 1;</span>
<a href="#l30.424"></a><span id="l30.424" class="difflineminus">-        errorMsg = &quot;&quot;;</span>
<a href="#l30.425"></a><span id="l30.425" class="difflineminus">-      }</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineminus">-      callbackFunc(exitCode, errorMsg);</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineminus">-    }</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineminus">-</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineminus">-    return editKey(parent, true, null, keyId, &quot;revoke&quot;, {</span>
<a href="#l30.430"></a><span id="l30.430" class="difflineminus">-        outFile: outFile,</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineminus">-        reasonCode: reasonCode,</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineminus">-        reasonText: EnigmailData.convertFromUnicode(reasonText),</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineminus">-      },</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineminus">-      revokeCertCallback,</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineminus">-      null,</span>
<a href="#l30.437"></a><span id="l30.437" class="difflineminus">-      checkGeneratedCert);</span>
<a href="#l30.438"></a><span id="l30.438" class="difflineminus">-  },</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineminus">-</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineminus">-  addUid: function(parent, keyId, name, email, comment, callbackFunc) {</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.addUid: keyId=&quot; + keyId + &quot;, name=&quot; + name + &quot;, email=&quot; + email + &quot;\n&quot;);</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineminus">-    return editKey(parent, true, null, keyId, &quot;adduid&quot;, {</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineminus">-        email: email,</span>
<a href="#l30.444"></a><span id="l30.444" class="difflineminus">-        name: name,</span>
<a href="#l30.445"></a><span id="l30.445" class="difflineminus">-        comment: comment,</span>
<a href="#l30.446"></a><span id="l30.446" class="difflineminus">-        nameAsked: 0,</span>
<a href="#l30.447"></a><span id="l30.447" class="difflineminus">-        emailAsked: 0,</span>
<a href="#l30.448"></a><span id="l30.448" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.449"></a><span id="l30.449" class="difflineminus">-      },</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineminus">-      addUidCallback,</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineminus">-      null,</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineminus">-  },</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineminus">-</span>
<a href="#l30.455"></a><span id="l30.455" class="difflineminus">-  deleteKey: function(parent, keyId, deleteSecretKey, callbackFunc) {</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.addUid: keyId=&quot; + keyId + &quot;, deleteSecretKey=&quot; + deleteSecretKey + &quot;\n&quot;);</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineminus">-</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineminus">-    var cmd = [&quot;--yes&quot;, (deleteSecretKey ? &quot;--delete-secret-and-public-key&quot; : &quot;--delete-key&quot;)];</span>
<a href="#l30.459"></a><span id="l30.459" class="difflineminus">-    return editKey(parent, false, null, keyId, cmd, {</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineminus">-      },</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineminus">-      deleteKeyCallback,</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineminus">-      null,</span>
<a href="#l30.464"></a><span id="l30.464" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.465"></a><span id="l30.465" class="difflineminus">-  },</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineminus">-</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineminus">-  changePassphrase: function(parent, keyId, oldPw, newPw, callbackFunc) {</span>
<a href="#l30.468"></a><span id="l30.468" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.changePassphrase: keyId=&quot; + keyId + &quot;\n&quot;);</span>
<a href="#l30.469"></a><span id="l30.469" class="difflineminus">-</span>
<a href="#l30.470"></a><span id="l30.470" class="difflineminus">-    var pwdObserver = new ChangePasswdObserver();</span>
<a href="#l30.471"></a><span id="l30.471" class="difflineminus">-    return editKey(parent, false, null, keyId, &quot;passwd&quot;, {</span>
<a href="#l30.472"></a><span id="l30.472" class="difflineminus">-        oldPw: oldPw,</span>
<a href="#l30.473"></a><span id="l30.473" class="difflineminus">-        newPw: newPw,</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-        step: 0,</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-        observer: pwdObserver,</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineminus">-      },</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineminus">-      changePassphraseCallback,</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineminus">-      pwdObserver,</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.481"></a><span id="l30.481" class="difflineminus">-  },</span>
<a href="#l30.482"></a><span id="l30.482" class="difflineminus">-</span>
<a href="#l30.483"></a><span id="l30.483" class="difflineminus">-</span>
<a href="#l30.484"></a><span id="l30.484" class="difflineminus">-  enableDisableKey: function(parent, keyId, disableKey, callbackFunc) {</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.enableDisableKey: keyId=&quot; + keyId + &quot;, disableKey=&quot; + disableKey + &quot;\n&quot;);</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineminus">-</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineminus">-    var cmd = (disableKey ? &quot;disable&quot; : &quot;enable&quot;);</span>
<a href="#l30.488"></a><span id="l30.488" class="difflineminus">-    return editKey(parent, false, null, keyId, cmd, {</span>
<a href="#l30.489"></a><span id="l30.489" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.490"></a><span id="l30.490" class="difflineminus">-      },</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineminus">-      null,</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineminus">-      null,</span>
<a href="#l30.493"></a><span id="l30.493" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.494"></a><span id="l30.494" class="difflineminus">-  },</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineminus">-</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineminus">-  setPrimaryUid: function(parent, keyId, idNumber, callbackFunc) {</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.setPrimaryUid: keyId=&quot; + keyId + &quot;, idNumber=&quot; + idNumber + &quot;\n&quot;);</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineminus">-    return editKey(parent, true, null, keyId, &quot;&quot;, {</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineminus">-        idNumber: idNumber,</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineminus">-        step: 0,</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineminus">-      },</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineminus">-      setPrimaryUidCallback,</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineminus">-      null,</span>
<a href="#l30.505"></a><span id="l30.505" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineminus">-  },</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineminus">-</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineminus">-</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineminus">-  deleteUid: function(parent, keyId, idNumber, callbackFunc) {</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.deleteUid: keyId=&quot; + keyId + &quot;, idNumber=&quot; + idNumber + &quot;\n&quot;);</span>
<a href="#l30.511"></a><span id="l30.511" class="difflineminus">-    return editKey(parent, true, null, keyId, &quot;&quot;, {</span>
<a href="#l30.512"></a><span id="l30.512" class="difflineminus">-        idNumber: idNumber,</span>
<a href="#l30.513"></a><span id="l30.513" class="difflineminus">-        step: 0,</span>
<a href="#l30.514"></a><span id="l30.514" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineminus">-      },</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineminus">-      deleteUidCallback,</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineminus">-      null,</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineminus">-  },</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineminus">-</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineminus">-</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineminus">-  revokeUid: function(parent, keyId, idNumber, callbackFunc) {</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.revokeUid: keyId=&quot; + keyId + &quot;, idNumber=&quot; + idNumber + &quot;\n&quot;);</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineminus">-    return editKey(parent, true, null, keyId, &quot;&quot;, {</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineminus">-        idNumber: idNumber,</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineminus">-        step: 0,</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineminus">-      },</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineminus">-      revokeUidCallback,</span>
<a href="#l30.530"></a><span id="l30.530" class="difflineminus">-      null,</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineminus">-  },</span>
<a href="#l30.533"></a><span id="l30.533" class="difflineminus">-</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineminus">-  addPhoto: function(parent, keyId, photoFile, callbackFunc) {</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.addPhoto: keyId=&quot; + keyId + &quot;\n&quot;);</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineminus">-</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineminus">-    var photoFileName = EnigmailFiles.getEscapedFilename(EnigmailFiles.getFilePath(photoFile.QueryInterface(Ci.nsIFile)));</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineminus">-</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineminus">-    return editKey(parent, true, null, keyId, &quot;addphoto&quot;, {</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineminus">-        file: photoFileName,</span>
<a href="#l30.541"></a><span id="l30.541" class="difflineminus">-        step: 0,</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineminus">-        usePassphrase: true</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineminus">-      },</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineminus">-      addPhotoCallback,</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineminus">-      null,</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineminus">-      function _f(returnCode, errorMsg) {</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineminus">-        runKeyTrustCheck();</span>
<a href="#l30.548"></a><span id="l30.548" class="difflineminus">-        EnigmailKeyRing.updateKeys([keyId]);</span>
<a href="#l30.549"></a><span id="l30.549" class="difflineminus">-        callbackFunc(returnCode, errorMsg);</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineminus">-      });</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineminus">-  },</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineminus">-</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineminus">-</span>
<a href="#l30.554"></a><span id="l30.554" class="difflineminus">-  genCardKey: function(parent, name, email, comment, expiry, backupPasswd, requestObserver, callbackFunc) {</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.genCardKey: \n&quot;);</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineminus">-    var generateObserver = new EnigCardAdminObserver(requestObserver, EnigmailOS.isDosLike);</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineminus">-    return editKey(parent, false, null, &quot;&quot;, [&quot;--with-colons&quot;, &quot;--card-edit&quot;], {</span>
<a href="#l30.558"></a><span id="l30.558" class="difflineminus">-        step: 0,</span>
<a href="#l30.559"></a><span id="l30.559" class="difflineminus">-        name: EnigmailData.convertFromUnicode(name),</span>
<a href="#l30.560"></a><span id="l30.560" class="difflineminus">-        email: email,</span>
<a href="#l30.561"></a><span id="l30.561" class="difflineminus">-        comment: EnigmailData.convertFromUnicode(comment),</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineminus">-        expiry: expiry,</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineminus">-        backupPasswd: backupPasswd,</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineminus">-        cardAdmin: true,</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineminus">-        backupKey: (backupPasswd.length &gt; 0 ? &quot;Y&quot; : &quot;N&quot;),</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineminus">-        parent: parent</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineminus">-      },</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineminus">-      genCardKeyCallback,</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineminus">-      generateObserver,</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineminus">-  },</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineminus">-</span>
<a href="#l30.573"></a><span id="l30.573" class="difflineminus">-  cardAdminData: function(parent, name, firstname, lang, sex, url, login, forcepin, callbackFunc) {</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.cardAdminData: parent=&quot; + parent + &quot;, name=&quot; + name + &quot;, firstname=&quot; + firstname + &quot;, lang=&quot; + lang + &quot;, sex=&quot; + sex + &quot;, url=&quot; + url +</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineminus">-      &quot;, login=&quot; + login + &quot;, forcepin=&quot; + forcepin + &quot;\n&quot;);</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineminus">-    var adminObserver = new EnigCardAdminObserver(null, EnigmailOS.isDosLike);</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineminus">-    return editKey(parent, false, null, &quot;&quot;, [&quot;--with-colons&quot;, &quot;--card-edit&quot;], {</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineminus">-        step: 0,</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineminus">-        name: name,</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineminus">-        firstname: firstname,</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineminus">-        lang: lang,</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineminus">-        sex: sex,</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineminus">-        url: url,</span>
<a href="#l30.584"></a><span id="l30.584" class="difflineminus">-        login: login,</span>
<a href="#l30.585"></a><span id="l30.585" class="difflineminus">-        cardAdmin: true,</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineminus">-        forcepin: forcepin</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineminus">-      },</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineminus">-      cardAdminDataCallback,</span>
<a href="#l30.589"></a><span id="l30.589" class="difflineminus">-      adminObserver,</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.591"></a><span id="l30.591" class="difflineminus">-  },</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineminus">-</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineminus">-  cardChangePin: function(parent, action, oldPin, newPin, adminPin, pinObserver, callbackFunc) {</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: Enigmail.cardChangePin: parent=&quot; + parent + &quot;, action=&quot; + action + &quot;\n&quot;);</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineminus">-    var adminObserver = new EnigCardAdminObserver(pinObserver, EnigmailOS.isDosLike);</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineminus">-</span>
<a href="#l30.597"></a><span id="l30.597" class="difflineminus">-    return editKey(parent, true, null, &quot;&quot;, [&quot;--with-colons&quot;, &quot;--card-edit&quot;], {</span>
<a href="#l30.598"></a><span id="l30.598" class="difflineminus">-        step: 0,</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineminus">-        pinStep: 0,</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineminus">-        cardAdmin: true,</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineminus">-        action: action,</span>
<a href="#l30.602"></a><span id="l30.602" class="difflineminus">-        oldPin: oldPin,</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineminus">-        newPin: newPin,</span>
<a href="#l30.604"></a><span id="l30.604" class="difflineminus">-        adminPin: adminPin</span>
<a href="#l30.605"></a><span id="l30.605" class="difflineminus">-      },</span>
<a href="#l30.606"></a><span id="l30.606" class="difflineminus">-      cardChangePinCallback,</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineminus">-      adminObserver,</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineminus">-      callbackFunc);</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineminus">-  }</span>
<a href="#l30.610"></a><span id="l30.610" class="difflineminus">-</span>
<a href="#l30.611"></a><span id="l30.611" class="difflineminus">-}; // EnigmailKeyEditor</span>
<a href="#l30.612"></a><span id="l30.612" class="difflineminus">-</span>
<a href="#l30.613"></a><span id="l30.613" class="difflineminus">-</span>
<a href="#l30.614"></a><span id="l30.614" class="difflineminus">-function signKeyCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineminus">-</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.618"></a><span id="l30.618" class="difflineminus">-</span>
<a href="#l30.619"></a><span id="l30.619" class="difflineminus">-  if (keyEdit.doCheck(GET_BOOL, &quot;sign_uid.okay&quot;)) {</span>
<a href="#l30.620"></a><span id="l30.620" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineminus">-  }</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;keyedit.sign_all.okay&quot;)) {</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineminus">-  }</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;sign_uid.expire&quot;)) {</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineminus">-    ret.writeTxt = &quot;0&quot;;</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineminus">-  }</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;trustsig_prompt.trust_value&quot;)) {</span>
<a href="#l30.632"></a><span id="l30.632" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineminus">-    ret.writeTxt = &quot;0&quot;;</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineminus">-  }</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;trustsig_prompt.trust_depth&quot;)) {</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineminus">-    ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.638"></a><span id="l30.638" class="difflineminus">-  }</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;trustsig_prompt.trust_regexp&quot;)) {</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineminus">-    ret.writeTxt = &quot;0&quot;;</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineminus">-  }</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;siggen.valid&quot;)) {</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineminus">-    ret.writeTxt = &quot;0&quot;;</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineminus">-  }</span>
<a href="#l30.647"></a><span id="l30.647" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;sign_uid.local_promote_okay&quot;)) {</span>
<a href="#l30.648"></a><span id="l30.648" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.649"></a><span id="l30.649" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.650"></a><span id="l30.650" class="difflineminus">-  }</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;sign_uid.replace_expired_okay&quot;)) {</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineminus">-  }</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;sign_uid.class&quot;)) {</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineminus">-    ret.writeTxt = String(inputData.trustLevel);</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineminus">-  }</span>
<a href="#l30.659"></a><span id="l30.659" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.660"></a><span id="l30.660" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineminus">-  }</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.664"></a><span id="l30.664" class="difflineminus">-  }</span>
<a href="#l30.665"></a><span id="l30.665" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.666"></a><span id="l30.666" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineminus">-  }</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineminus">-  else {</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.672"></a><span id="l30.672" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineminus">-  }</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineminus">-}</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineminus">-</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineminus">-function keyTrustCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineminus">-</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;edit_ownertrust.value&quot;)) {</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineminus">-    ret.writeTxt = String(inputData.trustLevel);</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineminus">-  }</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;edit_ownertrust.set_ultimate.okay&quot;)) {</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineminus">-  }</span>
<a href="#l30.688"></a><span id="l30.688" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineminus">-  }</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineminus">-  }</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineminus">-  }</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineminus">-  else {</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineminus">-  }</span>
<a href="#l30.703"></a><span id="l30.703" class="difflineminus">-}</span>
<a href="#l30.704"></a><span id="l30.704" class="difflineminus">-</span>
<a href="#l30.705"></a><span id="l30.705" class="difflineminus">-/**</span>
<a href="#l30.706"></a><span id="l30.706" class="difflineminus">- *</span>
<a href="#l30.707"></a><span id="l30.707" class="difflineminus">- * @param  Array   inputData  Has the keys ...</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineminus">- *                        expiryLength (String): e.g. 8m = 8 month, 5 = 5 days, 3y = 3 years, 0 = never</span>
<a href="#l30.709"></a><span id="l30.709" class="difflineminus">- *                        subKeys (array): list of still unprocessed subkeys</span>
<a href="#l30.710"></a><span id="l30.710" class="difflineminus">- *                        currentSubKey (Integer or false): current subkey in progress</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineminus">- * @param  Object  keyEdit    Readonly messages from GPG.</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineminus">- * @param  Object  ret</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineminus">- */</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineminus">-function keyExpiryCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineminus">-  EnigmailLog.DEBUG(&quot;keyEdit.jsm: keyExpiryCallback()\n&quot;);</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineminus">-</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineminus">-</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineminus">-  if (inputData.subKeys.length === 0) {</span>
<a href="#l30.721"></a><span id="l30.721" class="difflineminus">-    // zero keys are submitted to edit: this must be a mistake.</span>
<a href="#l30.722"></a><span id="l30.722" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.723"></a><span id="l30.723" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.724"></a><span id="l30.724" class="difflineminus">-  }</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.726"></a><span id="l30.726" class="difflineminus">-    if (inputData.currentSubKey === false) {</span>
<a href="#l30.727"></a><span id="l30.727" class="difflineminus">-      // currently no subkey is selected. Chose the first subkey.</span>
<a href="#l30.728"></a><span id="l30.728" class="difflineminus">-      inputData.currentSubKey = inputData.subKeys[0];</span>
<a href="#l30.729"></a><span id="l30.729" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.730"></a><span id="l30.730" class="difflineminus">-      ret.writeTxt = &quot;key &quot; + inputData.currentSubKey;</span>
<a href="#l30.731"></a><span id="l30.731" class="difflineminus">-    }</span>
<a href="#l30.732"></a><span id="l30.732" class="difflineminus">-    else if (inputData.currentSubKey === inputData.subKeys[0]) {</span>
<a href="#l30.733"></a><span id="l30.733" class="difflineminus">-      // a subkey is selected. execute command &quot;expire&quot;</span>
<a href="#l30.734"></a><span id="l30.734" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.735"></a><span id="l30.735" class="difflineminus">-      ret.writeTxt = &quot;expire&quot;;</span>
<a href="#l30.736"></a><span id="l30.736" class="difflineminus">-    }</span>
<a href="#l30.737"></a><span id="l30.737" class="difflineminus">-    else {</span>
<a href="#l30.738"></a><span id="l30.738" class="difflineminus">-      // if (inputData.currentSubKey === inputData.subKeys[0])</span>
<a href="#l30.739"></a><span id="l30.739" class="difflineminus">-      // unselect the previous used subkey</span>
<a href="#l30.740"></a><span id="l30.740" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.741"></a><span id="l30.741" class="difflineminus">-      ret.writeTxt = &quot;key &quot; + inputData.currentSubKey;</span>
<a href="#l30.742"></a><span id="l30.742" class="difflineminus">-      inputData.currentSubKey = false;</span>
<a href="#l30.743"></a><span id="l30.743" class="difflineminus">-    }</span>
<a href="#l30.744"></a><span id="l30.744" class="difflineminus">-  }</span>
<a href="#l30.745"></a><span id="l30.745" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.valid&quot;)) {</span>
<a href="#l30.746"></a><span id="l30.746" class="difflineminus">-    // submit the expiry length.</span>
<a href="#l30.747"></a><span id="l30.747" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.748"></a><span id="l30.748" class="difflineminus">-    ret.writeTxt = inputData.expiryLength;</span>
<a href="#l30.749"></a><span id="l30.749" class="difflineminus">-    // processing of the current subkey is through.</span>
<a href="#l30.750"></a><span id="l30.750" class="difflineminus">-    // remove current subkey from list of &quot;to be processed keys&quot;.</span>
<a href="#l30.751"></a><span id="l30.751" class="difflineminus">-    inputData.subKeys.splice(0, 1);</span>
<a href="#l30.752"></a><span id="l30.752" class="difflineminus">-    // if the list of &quot;to be processed keys&quot; is empty, then quit.</span>
<a href="#l30.753"></a><span id="l30.753" class="difflineminus">-    if (inputData.subKeys.length === 0) {</span>
<a href="#l30.754"></a><span id="l30.754" class="difflineminus">-      ret.quitNow = true;</span>
<a href="#l30.755"></a><span id="l30.755" class="difflineminus">-    }</span>
<a href="#l30.756"></a><span id="l30.756" class="difflineminus">-  }</span>
<a href="#l30.757"></a><span id="l30.757" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.758"></a><span id="l30.758" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.759"></a><span id="l30.759" class="difflineminus">-  }</span>
<a href="#l30.760"></a><span id="l30.760" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.761"></a><span id="l30.761" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.762"></a><span id="l30.762" class="difflineminus">-  }</span>
<a href="#l30.763"></a><span id="l30.763" class="difflineminus">-  else {</span>
<a href="#l30.764"></a><span id="l30.764" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.765"></a><span id="l30.765" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.766"></a><span id="l30.766" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.767"></a><span id="l30.767" class="difflineminus">-  }</span>
<a href="#l30.768"></a><span id="l30.768" class="difflineminus">-}</span>
<a href="#l30.769"></a><span id="l30.769" class="difflineminus">-</span>
<a href="#l30.770"></a><span id="l30.770" class="difflineminus">-function addUidCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.771"></a><span id="l30.771" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.772"></a><span id="l30.772" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.773"></a><span id="l30.773" class="difflineminus">-</span>
<a href="#l30.774"></a><span id="l30.774" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;keygen.name&quot;)) {</span>
<a href="#l30.775"></a><span id="l30.775" class="difflineminus">-    ++inputData.nameAsked;</span>
<a href="#l30.776"></a><span id="l30.776" class="difflineminus">-    if (inputData.nameAsked == 1) {</span>
<a href="#l30.777"></a><span id="l30.777" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.778"></a><span id="l30.778" class="difflineminus">-      ret.writeTxt = inputData.name;</span>
<a href="#l30.779"></a><span id="l30.779" class="difflineminus">-    }</span>
<a href="#l30.780"></a><span id="l30.780" class="difflineminus">-    else {</span>
<a href="#l30.781"></a><span id="l30.781" class="difflineminus">-      ret.exitCode = -1;</span>
<a href="#l30.782"></a><span id="l30.782" class="difflineminus">-      ret.quitNow = true;</span>
<a href="#l30.783"></a><span id="l30.783" class="difflineminus">-      ret.errorMsg = &quot;Invalid name (too short)&quot;;</span>
<a href="#l30.784"></a><span id="l30.784" class="difflineminus">-    }</span>
<a href="#l30.785"></a><span id="l30.785" class="difflineminus">-  }</span>
<a href="#l30.786"></a><span id="l30.786" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.email&quot;)) {</span>
<a href="#l30.787"></a><span id="l30.787" class="difflineminus">-    ++inputData.emailAsked;</span>
<a href="#l30.788"></a><span id="l30.788" class="difflineminus">-    if (inputData.emailAsked == 1) {</span>
<a href="#l30.789"></a><span id="l30.789" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.790"></a><span id="l30.790" class="difflineminus">-      ret.writeTxt = inputData.email;</span>
<a href="#l30.791"></a><span id="l30.791" class="difflineminus">-    }</span>
<a href="#l30.792"></a><span id="l30.792" class="difflineminus">-    else {</span>
<a href="#l30.793"></a><span id="l30.793" class="difflineminus">-      ret.exitCode = -1;</span>
<a href="#l30.794"></a><span id="l30.794" class="difflineminus">-      ret.quitNow = true;</span>
<a href="#l30.795"></a><span id="l30.795" class="difflineminus">-      ret.errorMsg = &quot;Invalid email&quot;;</span>
<a href="#l30.796"></a><span id="l30.796" class="difflineminus">-    }</span>
<a href="#l30.797"></a><span id="l30.797" class="difflineminus">-  }</span>
<a href="#l30.798"></a><span id="l30.798" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.comment&quot;)) {</span>
<a href="#l30.799"></a><span id="l30.799" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.800"></a><span id="l30.800" class="difflineminus">-    if (inputData.comment) {</span>
<a href="#l30.801"></a><span id="l30.801" class="difflineminus">-      ret.writeTxt = inputData.comment;</span>
<a href="#l30.802"></a><span id="l30.802" class="difflineminus">-    }</span>
<a href="#l30.803"></a><span id="l30.803" class="difflineminus">-    else {</span>
<a href="#l30.804"></a><span id="l30.804" class="difflineminus">-      ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.805"></a><span id="l30.805" class="difflineminus">-    }</span>
<a href="#l30.806"></a><span id="l30.806" class="difflineminus">-  }</span>
<a href="#l30.807"></a><span id="l30.807" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.808"></a><span id="l30.808" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.809"></a><span id="l30.809" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.810"></a><span id="l30.810" class="difflineminus">-  }</span>
<a href="#l30.811"></a><span id="l30.811" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.812"></a><span id="l30.812" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.813"></a><span id="l30.813" class="difflineminus">-  }</span>
<a href="#l30.814"></a><span id="l30.814" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.815"></a><span id="l30.815" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.816"></a><span id="l30.816" class="difflineminus">-  }</span>
<a href="#l30.817"></a><span id="l30.817" class="difflineminus">-  else {</span>
<a href="#l30.818"></a><span id="l30.818" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.819"></a><span id="l30.819" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.820"></a><span id="l30.820" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.821"></a><span id="l30.821" class="difflineminus">-  }</span>
<a href="#l30.822"></a><span id="l30.822" class="difflineminus">-}</span>
<a href="#l30.823"></a><span id="l30.823" class="difflineminus">-</span>
<a href="#l30.824"></a><span id="l30.824" class="difflineminus">-</span>
<a href="#l30.825"></a><span id="l30.825" class="difflineminus">-function revokeCertCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.826"></a><span id="l30.826" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.827"></a><span id="l30.827" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.828"></a><span id="l30.828" class="difflineminus">-</span>
<a href="#l30.829"></a><span id="l30.829" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;ask_revocation_reason.code&quot;)) {</span>
<a href="#l30.830"></a><span id="l30.830" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.831"></a><span id="l30.831" class="difflineminus">-    ret.writeTxt = String(inputData.reasonCode);</span>
<a href="#l30.832"></a><span id="l30.832" class="difflineminus">-  }</span>
<a href="#l30.833"></a><span id="l30.833" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;ask_revocation_reason.text&quot;)) {</span>
<a href="#l30.834"></a><span id="l30.834" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.835"></a><span id="l30.835" class="difflineminus">-    ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.836"></a><span id="l30.836" class="difflineminus">-  }</span>
<a href="#l30.837"></a><span id="l30.837" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;gen_revoke.okay&quot;)) {</span>
<a href="#l30.838"></a><span id="l30.838" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.839"></a><span id="l30.839" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.840"></a><span id="l30.840" class="difflineminus">-  }</span>
<a href="#l30.841"></a><span id="l30.841" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;ask_revocation_reason.okay&quot;)) {</span>
<a href="#l30.842"></a><span id="l30.842" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.843"></a><span id="l30.843" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.844"></a><span id="l30.844" class="difflineminus">-  }</span>
<a href="#l30.845"></a><span id="l30.845" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;openfile.overwrite.okay&quot;)) {</span>
<a href="#l30.846"></a><span id="l30.846" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.847"></a><span id="l30.847" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.848"></a><span id="l30.848" class="difflineminus">-  }</span>
<a href="#l30.849"></a><span id="l30.849" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.850"></a><span id="l30.850" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.851"></a><span id="l30.851" class="difflineminus">-  }</span>
<a href="#l30.852"></a><span id="l30.852" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.853"></a><span id="l30.853" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.854"></a><span id="l30.854" class="difflineminus">-  }</span>
<a href="#l30.855"></a><span id="l30.855" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.856"></a><span id="l30.856" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.857"></a><span id="l30.857" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.858"></a><span id="l30.858" class="difflineminus">-  }</span>
<a href="#l30.859"></a><span id="l30.859" class="difflineminus">-  else {</span>
<a href="#l30.860"></a><span id="l30.860" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.861"></a><span id="l30.861" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.862"></a><span id="l30.862" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.863"></a><span id="l30.863" class="difflineminus">-  }</span>
<a href="#l30.864"></a><span id="l30.864" class="difflineminus">-}</span>
<a href="#l30.865"></a><span id="l30.865" class="difflineminus">-</span>
<a href="#l30.866"></a><span id="l30.866" class="difflineminus">-</span>
<a href="#l30.867"></a><span id="l30.867" class="difflineminus">-function setPrimaryUidCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.868"></a><span id="l30.868" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.869"></a><span id="l30.869" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.870"></a><span id="l30.870" class="difflineminus">-</span>
<a href="#l30.871"></a><span id="l30.871" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.872"></a><span id="l30.872" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.873"></a><span id="l30.873" class="difflineminus">-    switch (inputData.step) {</span>
<a href="#l30.874"></a><span id="l30.874" class="difflineminus">-      case 1:</span>
<a href="#l30.875"></a><span id="l30.875" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.876"></a><span id="l30.876" class="difflineminus">-        ret.writeTxt = &quot;uid &quot; + inputData.idNumber;</span>
<a href="#l30.877"></a><span id="l30.877" class="difflineminus">-        break;</span>
<a href="#l30.878"></a><span id="l30.878" class="difflineminus">-      case 2:</span>
<a href="#l30.879"></a><span id="l30.879" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.880"></a><span id="l30.880" class="difflineminus">-        ret.writeTxt = &quot;primary&quot;;</span>
<a href="#l30.881"></a><span id="l30.881" class="difflineminus">-        break;</span>
<a href="#l30.882"></a><span id="l30.882" class="difflineminus">-      case 3:</span>
<a href="#l30.883"></a><span id="l30.883" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.884"></a><span id="l30.884" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.885"></a><span id="l30.885" class="difflineminus">-        break;</span>
<a href="#l30.886"></a><span id="l30.886" class="difflineminus">-      default:</span>
<a href="#l30.887"></a><span id="l30.887" class="difflineminus">-        ret.exitCode = -1;</span>
<a href="#l30.888"></a><span id="l30.888" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.889"></a><span id="l30.889" class="difflineminus">-    }</span>
<a href="#l30.890"></a><span id="l30.890" class="difflineminus">-</span>
<a href="#l30.891"></a><span id="l30.891" class="difflineminus">-  }</span>
<a href="#l30.892"></a><span id="l30.892" class="difflineminus">-  else {</span>
<a href="#l30.893"></a><span id="l30.893" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.894"></a><span id="l30.894" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.895"></a><span id="l30.895" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.896"></a><span id="l30.896" class="difflineminus">-  }</span>
<a href="#l30.897"></a><span id="l30.897" class="difflineminus">-}</span>
<a href="#l30.898"></a><span id="l30.898" class="difflineminus">-</span>
<a href="#l30.899"></a><span id="l30.899" class="difflineminus">-</span>
<a href="#l30.900"></a><span id="l30.900" class="difflineminus">-function changePassphraseCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.901"></a><span id="l30.901" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.902"></a><span id="l30.902" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.903"></a><span id="l30.903" class="difflineminus">-</span>
<a href="#l30.904"></a><span id="l30.904" class="difflineminus">-  if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.enter&quot;)) {</span>
<a href="#l30.905"></a><span id="l30.905" class="difflineminus">-    switch (inputData.observer.passphraseStatus) {</span>
<a href="#l30.906"></a><span id="l30.906" class="difflineminus">-      case 0:</span>
<a href="#l30.907"></a><span id="l30.907" class="difflineminus">-        ret.writeTxt = inputData.oldPw;</span>
<a href="#l30.908"></a><span id="l30.908" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.909"></a><span id="l30.909" class="difflineminus">-        break;</span>
<a href="#l30.910"></a><span id="l30.910" class="difflineminus">-      case 1:</span>
<a href="#l30.911"></a><span id="l30.911" class="difflineminus">-        ret.writeTxt = inputData.newPw;</span>
<a href="#l30.912"></a><span id="l30.912" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.913"></a><span id="l30.913" class="difflineminus">-        break;</span>
<a href="#l30.914"></a><span id="l30.914" class="difflineminus">-      case -1:</span>
<a href="#l30.915"></a><span id="l30.915" class="difflineminus">-        ret.exitCode = -2;</span>
<a href="#l30.916"></a><span id="l30.916" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.917"></a><span id="l30.917" class="difflineminus">-        break;</span>
<a href="#l30.918"></a><span id="l30.918" class="difflineminus">-    }</span>
<a href="#l30.919"></a><span id="l30.919" class="difflineminus">-  }</span>
<a href="#l30.920"></a><span id="l30.920" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;change_passwd.empty.okay&quot;)) {</span>
<a href="#l30.921"></a><span id="l30.921" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.922"></a><span id="l30.922" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.923"></a><span id="l30.923" class="difflineminus">-  }</span>
<a href="#l30.924"></a><span id="l30.924" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.925"></a><span id="l30.925" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.926"></a><span id="l30.926" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.927"></a><span id="l30.927" class="difflineminus">-  }</span>
<a href="#l30.928"></a><span id="l30.928" class="difflineminus">-  else {</span>
<a href="#l30.929"></a><span id="l30.929" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.930"></a><span id="l30.930" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.931"></a><span id="l30.931" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.932"></a><span id="l30.932" class="difflineminus">-  }</span>
<a href="#l30.933"></a><span id="l30.933" class="difflineminus">-}</span>
<a href="#l30.934"></a><span id="l30.934" class="difflineminus">-</span>
<a href="#l30.935"></a><span id="l30.935" class="difflineminus">-</span>
<a href="#l30.936"></a><span id="l30.936" class="difflineminus">-function deleteUidCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.937"></a><span id="l30.937" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.938"></a><span id="l30.938" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.939"></a><span id="l30.939" class="difflineminus">-</span>
<a href="#l30.940"></a><span id="l30.940" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.941"></a><span id="l30.941" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.942"></a><span id="l30.942" class="difflineminus">-    switch (inputData.step) {</span>
<a href="#l30.943"></a><span id="l30.943" class="difflineminus">-      case 1:</span>
<a href="#l30.944"></a><span id="l30.944" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.945"></a><span id="l30.945" class="difflineminus">-        ret.writeTxt = &quot;uid &quot; + inputData.idNumber;</span>
<a href="#l30.946"></a><span id="l30.946" class="difflineminus">-        break;</span>
<a href="#l30.947"></a><span id="l30.947" class="difflineminus">-      case 2:</span>
<a href="#l30.948"></a><span id="l30.948" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.949"></a><span id="l30.949" class="difflineminus">-        ret.writeTxt = &quot;deluid&quot;;</span>
<a href="#l30.950"></a><span id="l30.950" class="difflineminus">-        break;</span>
<a href="#l30.951"></a><span id="l30.951" class="difflineminus">-      case 4:</span>
<a href="#l30.952"></a><span id="l30.952" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.953"></a><span id="l30.953" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.954"></a><span id="l30.954" class="difflineminus">-        break;</span>
<a href="#l30.955"></a><span id="l30.955" class="difflineminus">-      default:</span>
<a href="#l30.956"></a><span id="l30.956" class="difflineminus">-        ret.exitCode = -1;</span>
<a href="#l30.957"></a><span id="l30.957" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.958"></a><span id="l30.958" class="difflineminus">-    }</span>
<a href="#l30.959"></a><span id="l30.959" class="difflineminus">-  }</span>
<a href="#l30.960"></a><span id="l30.960" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;keyedit.remove.uid.okay&quot;)) {</span>
<a href="#l30.961"></a><span id="l30.961" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.962"></a><span id="l30.962" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.963"></a><span id="l30.963" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.964"></a><span id="l30.964" class="difflineminus">-  }</span>
<a href="#l30.965"></a><span id="l30.965" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.966"></a><span id="l30.966" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.967"></a><span id="l30.967" class="difflineminus">-  }</span>
<a href="#l30.968"></a><span id="l30.968" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.969"></a><span id="l30.969" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.970"></a><span id="l30.970" class="difflineminus">-  }</span>
<a href="#l30.971"></a><span id="l30.971" class="difflineminus">-  else {</span>
<a href="#l30.972"></a><span id="l30.972" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.973"></a><span id="l30.973" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.974"></a><span id="l30.974" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.975"></a><span id="l30.975" class="difflineminus">-  }</span>
<a href="#l30.976"></a><span id="l30.976" class="difflineminus">-}</span>
<a href="#l30.977"></a><span id="l30.977" class="difflineminus">-</span>
<a href="#l30.978"></a><span id="l30.978" class="difflineminus">-</span>
<a href="#l30.979"></a><span id="l30.979" class="difflineminus">-function revokeUidCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.980"></a><span id="l30.980" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.981"></a><span id="l30.981" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.982"></a><span id="l30.982" class="difflineminus">-</span>
<a href="#l30.983"></a><span id="l30.983" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.984"></a><span id="l30.984" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.985"></a><span id="l30.985" class="difflineminus">-    switch (inputData.step) {</span>
<a href="#l30.986"></a><span id="l30.986" class="difflineminus">-      case 1:</span>
<a href="#l30.987"></a><span id="l30.987" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.988"></a><span id="l30.988" class="difflineminus">-        ret.writeTxt = &quot;uid &quot; + inputData.idNumber;</span>
<a href="#l30.989"></a><span id="l30.989" class="difflineminus">-        break;</span>
<a href="#l30.990"></a><span id="l30.990" class="difflineminus">-      case 2:</span>
<a href="#l30.991"></a><span id="l30.991" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.992"></a><span id="l30.992" class="difflineminus">-        ret.writeTxt = &quot;revuid&quot;;</span>
<a href="#l30.993"></a><span id="l30.993" class="difflineminus">-        break;</span>
<a href="#l30.994"></a><span id="l30.994" class="difflineminus">-      case 7:</span>
<a href="#l30.995"></a><span id="l30.995" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.996"></a><span id="l30.996" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.997"></a><span id="l30.997" class="difflineminus">-        break;</span>
<a href="#l30.998"></a><span id="l30.998" class="difflineminus">-      default:</span>
<a href="#l30.999"></a><span id="l30.999" class="difflineminus">-        ret.exitCode = -1;</span>
<a href="#l30.1000"></a><span id="l30.1000" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.1001"></a><span id="l30.1001" class="difflineminus">-    }</span>
<a href="#l30.1002"></a><span id="l30.1002" class="difflineminus">-  }</span>
<a href="#l30.1003"></a><span id="l30.1003" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;keyedit.revoke.uid.okay&quot;)) {</span>
<a href="#l30.1004"></a><span id="l30.1004" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1005"></a><span id="l30.1005" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1006"></a><span id="l30.1006" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.1007"></a><span id="l30.1007" class="difflineminus">-  }</span>
<a href="#l30.1008"></a><span id="l30.1008" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;ask_revocation_reason.code&quot;)) {</span>
<a href="#l30.1009"></a><span id="l30.1009" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1010"></a><span id="l30.1010" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1011"></a><span id="l30.1011" class="difflineminus">-    ret.writeTxt = &quot;0&quot;; // no reason specified</span>
<a href="#l30.1012"></a><span id="l30.1012" class="difflineminus">-  }</span>
<a href="#l30.1013"></a><span id="l30.1013" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;ask_revocation_reason.text&quot;)) {</span>
<a href="#l30.1014"></a><span id="l30.1014" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1015"></a><span id="l30.1015" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1016"></a><span id="l30.1016" class="difflineminus">-    ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1017"></a><span id="l30.1017" class="difflineminus">-  }</span>
<a href="#l30.1018"></a><span id="l30.1018" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;ask_revocation_reason.okay&quot;)) {</span>
<a href="#l30.1019"></a><span id="l30.1019" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1020"></a><span id="l30.1020" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1021"></a><span id="l30.1021" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.1022"></a><span id="l30.1022" class="difflineminus">-  }</span>
<a href="#l30.1023"></a><span id="l30.1023" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.1024"></a><span id="l30.1024" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.1025"></a><span id="l30.1025" class="difflineminus">-  }</span>
<a href="#l30.1026"></a><span id="l30.1026" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.1027"></a><span id="l30.1027" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.1028"></a><span id="l30.1028" class="difflineminus">-  }</span>
<a href="#l30.1029"></a><span id="l30.1029" class="difflineminus">-  else {</span>
<a href="#l30.1030"></a><span id="l30.1030" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1031"></a><span id="l30.1031" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.1032"></a><span id="l30.1032" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.1033"></a><span id="l30.1033" class="difflineminus">-  }</span>
<a href="#l30.1034"></a><span id="l30.1034" class="difflineminus">-}</span>
<a href="#l30.1035"></a><span id="l30.1035" class="difflineminus">-</span>
<a href="#l30.1036"></a><span id="l30.1036" class="difflineminus">-</span>
<a href="#l30.1037"></a><span id="l30.1037" class="difflineminus">-function deleteKeyCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.1038"></a><span id="l30.1038" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1039"></a><span id="l30.1039" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.1040"></a><span id="l30.1040" class="difflineminus">-</span>
<a href="#l30.1041"></a><span id="l30.1041" class="difflineminus">-  if (keyEdit.doCheck(GET_BOOL, &quot;delete_key.secret.okay&quot;)) {</span>
<a href="#l30.1042"></a><span id="l30.1042" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1043"></a><span id="l30.1043" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.1044"></a><span id="l30.1044" class="difflineminus">-  }</span>
<a href="#l30.1045"></a><span id="l30.1045" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;keyedit.remove.subkey.okay&quot;)) {</span>
<a href="#l30.1046"></a><span id="l30.1046" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1047"></a><span id="l30.1047" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.1048"></a><span id="l30.1048" class="difflineminus">-  }</span>
<a href="#l30.1049"></a><span id="l30.1049" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;delete_key.okay&quot;)) {</span>
<a href="#l30.1050"></a><span id="l30.1050" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1051"></a><span id="l30.1051" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.1052"></a><span id="l30.1052" class="difflineminus">-  }</span>
<a href="#l30.1053"></a><span id="l30.1053" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.1054"></a><span id="l30.1054" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.1055"></a><span id="l30.1055" class="difflineminus">-  }</span>
<a href="#l30.1056"></a><span id="l30.1056" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.1057"></a><span id="l30.1057" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.1058"></a><span id="l30.1058" class="difflineminus">-  }</span>
<a href="#l30.1059"></a><span id="l30.1059" class="difflineminus">-  else {</span>
<a href="#l30.1060"></a><span id="l30.1060" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1061"></a><span id="l30.1061" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.1062"></a><span id="l30.1062" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.1063"></a><span id="l30.1063" class="difflineminus">-  }</span>
<a href="#l30.1064"></a><span id="l30.1064" class="difflineminus">-}</span>
<a href="#l30.1065"></a><span id="l30.1065" class="difflineminus">-</span>
<a href="#l30.1066"></a><span id="l30.1066" class="difflineminus">-function getPin(domWindow, promptMsg, ret) {</span>
<a href="#l30.1067"></a><span id="l30.1067" class="difflineminus">-  EnigmailLog.DEBUG(&quot;keyEdit.jsm: getPin: \n&quot;);</span>
<a href="#l30.1068"></a><span id="l30.1068" class="difflineminus">-</span>
<a href="#l30.1069"></a><span id="l30.1069" class="difflineminus">-  var passwdObj = {</span>
<a href="#l30.1070"></a><span id="l30.1070" class="difflineminus">-    value: &quot;&quot;</span>
<a href="#l30.1071"></a><span id="l30.1071" class="difflineminus">-  };</span>
<a href="#l30.1072"></a><span id="l30.1072" class="difflineminus">-  var dummyObj = {};</span>
<a href="#l30.1073"></a><span id="l30.1073" class="difflineminus">-</span>
<a href="#l30.1074"></a><span id="l30.1074" class="difflineminus">-  var success = false;</span>
<a href="#l30.1075"></a><span id="l30.1075" class="difflineminus">-</span>
<a href="#l30.1076"></a><span id="l30.1076" class="difflineminus">-  var promptService = Cc[NS_PROMPTSERVICE_CONTRACTID].getService(Ci.nsIPromptService);</span>
<a href="#l30.1077"></a><span id="l30.1077" class="difflineminus">-  success = promptService.promptPassword(domWindow,</span>
<a href="#l30.1078"></a><span id="l30.1078" class="difflineminus">-    EnigmailLocale.getString(&quot;Enigmail&quot;),</span>
<a href="#l30.1079"></a><span id="l30.1079" class="difflineminus">-    promptMsg,</span>
<a href="#l30.1080"></a><span id="l30.1080" class="difflineminus">-    passwdObj,</span>
<a href="#l30.1081"></a><span id="l30.1081" class="difflineminus">-    null,</span>
<a href="#l30.1082"></a><span id="l30.1082" class="difflineminus">-    dummyObj);</span>
<a href="#l30.1083"></a><span id="l30.1083" class="difflineminus">-</span>
<a href="#l30.1084"></a><span id="l30.1084" class="difflineminus">-  if (!success) {</span>
<a href="#l30.1085"></a><span id="l30.1085" class="difflineminus">-    ret.errorMsg = EnigmailLocale.getString(&quot;noPassphrase&quot;);</span>
<a href="#l30.1086"></a><span id="l30.1086" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1087"></a><span id="l30.1087" class="difflineminus">-    return false;</span>
<a href="#l30.1088"></a><span id="l30.1088" class="difflineminus">-  }</span>
<a href="#l30.1089"></a><span id="l30.1089" class="difflineminus">-</span>
<a href="#l30.1090"></a><span id="l30.1090" class="difflineminus">-  EnigmailLog.DEBUG(&quot;keyEdit.jsm: getPin: got pin\n&quot;);</span>
<a href="#l30.1091"></a><span id="l30.1091" class="difflineminus">-  ret.writeTxt = passwdObj.value;</span>
<a href="#l30.1092"></a><span id="l30.1092" class="difflineminus">-</span>
<a href="#l30.1093"></a><span id="l30.1093" class="difflineminus">-  return true;</span>
<a href="#l30.1094"></a><span id="l30.1094" class="difflineminus">-}</span>
<a href="#l30.1095"></a><span id="l30.1095" class="difflineminus">-</span>
<a href="#l30.1096"></a><span id="l30.1096" class="difflineminus">-function genCardKeyCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.1097"></a><span id="l30.1097" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1098"></a><span id="l30.1098" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.1099"></a><span id="l30.1099" class="difflineminus">-</span>
<a href="#l30.1100"></a><span id="l30.1100" class="difflineminus">-  var pinObj = {};</span>
<a href="#l30.1101"></a><span id="l30.1101" class="difflineminus">-</span>
<a href="#l30.1102"></a><span id="l30.1102" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;cardedit.prompt&quot;)) {</span>
<a href="#l30.1103"></a><span id="l30.1103" class="difflineminus">-    if (inputData.step === 0) {</span>
<a href="#l30.1104"></a><span id="l30.1104" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.1105"></a><span id="l30.1105" class="difflineminus">-      ret.writeTxt = &quot;admin&quot;;</span>
<a href="#l30.1106"></a><span id="l30.1106" class="difflineminus">-    }</span>
<a href="#l30.1107"></a><span id="l30.1107" class="difflineminus">-    else if (inputData.step == 1) {</span>
<a href="#l30.1108"></a><span id="l30.1108" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.1109"></a><span id="l30.1109" class="difflineminus">-      ret.writeTxt = &quot;generate&quot;;</span>
<a href="#l30.1110"></a><span id="l30.1110" class="difflineminus">-    }</span>
<a href="#l30.1111"></a><span id="l30.1111" class="difflineminus">-    else {</span>
<a href="#l30.1112"></a><span id="l30.1112" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.1113"></a><span id="l30.1113" class="difflineminus">-      ret.quitNow = true;</span>
<a href="#l30.1114"></a><span id="l30.1114" class="difflineminus">-      ret.writeTxt = &quot;quit&quot;;</span>
<a href="#l30.1115"></a><span id="l30.1115" class="difflineminus">-    }</span>
<a href="#l30.1116"></a><span id="l30.1116" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1117"></a><span id="l30.1117" class="difflineminus">-  }</span>
<a href="#l30.1118"></a><span id="l30.1118" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardedit.genkeys.backup_enc&quot;) ||</span>
<a href="#l30.1119"></a><span id="l30.1119" class="difflineminus">-    keyEdit.doCheck(GET_BOOL, &quot;cardedit.genkeys.backup_enc&quot;)) {</span>
<a href="#l30.1120"></a><span id="l30.1120" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1121"></a><span id="l30.1121" class="difflineminus">-    ret.writeTxt = String(inputData.backupKey);</span>
<a href="#l30.1122"></a><span id="l30.1122" class="difflineminus">-  }</span>
<a href="#l30.1123"></a><span id="l30.1123" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;cardedit.genkeys.replace_keys&quot;)) {</span>
<a href="#l30.1124"></a><span id="l30.1124" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1125"></a><span id="l30.1125" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;;</span>
<a href="#l30.1126"></a><span id="l30.1126" class="difflineminus">-  }</span>
<a href="#l30.1127"></a><span id="l30.1127" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.1128"></a><span id="l30.1128" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.1129"></a><span id="l30.1129" class="difflineminus">-  }</span>
<a href="#l30.1130"></a><span id="l30.1130" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.1131"></a><span id="l30.1131" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.1132"></a><span id="l30.1132" class="difflineminus">-  }</span>
<a href="#l30.1133"></a><span id="l30.1133" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.enter&quot;)) {</span>
<a href="#l30.1134"></a><span id="l30.1134" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1135"></a><span id="l30.1135" class="difflineminus">-    ret.writeTxt = inputData.backupPasswd;</span>
<a href="#l30.1136"></a><span id="l30.1136" class="difflineminus">-  }</span>
<a href="#l30.1137"></a><span id="l30.1137" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.valid&quot;)) {</span>
<a href="#l30.1138"></a><span id="l30.1138" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1139"></a><span id="l30.1139" class="difflineminus">-    ret.writeTxt = String(inputData.expiry);</span>
<a href="#l30.1140"></a><span id="l30.1140" class="difflineminus">-  }</span>
<a href="#l30.1141"></a><span id="l30.1141" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardedit.genkeys.size&quot;)) {</span>
<a href="#l30.1142"></a><span id="l30.1142" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1143"></a><span id="l30.1143" class="difflineminus">-    ret.writeTxt = &quot;2048&quot;;</span>
<a href="#l30.1144"></a><span id="l30.1144" class="difflineminus">-  }</span>
<a href="#l30.1145"></a><span id="l30.1145" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.name&quot;)) {</span>
<a href="#l30.1146"></a><span id="l30.1146" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1147"></a><span id="l30.1147" class="difflineminus">-    ret.writeTxt = inputData.name;</span>
<a href="#l30.1148"></a><span id="l30.1148" class="difflineminus">-  }</span>
<a href="#l30.1149"></a><span id="l30.1149" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.email&quot;)) {</span>
<a href="#l30.1150"></a><span id="l30.1150" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1151"></a><span id="l30.1151" class="difflineminus">-    ret.writeTxt = inputData.email;</span>
<a href="#l30.1152"></a><span id="l30.1152" class="difflineminus">-  }</span>
<a href="#l30.1153"></a><span id="l30.1153" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.comment&quot;)) {</span>
<a href="#l30.1154"></a><span id="l30.1154" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1155"></a><span id="l30.1155" class="difflineminus">-    if (inputData.comment) {</span>
<a href="#l30.1156"></a><span id="l30.1156" class="difflineminus">-      ret.writeTxt = inputData.comment;</span>
<a href="#l30.1157"></a><span id="l30.1157" class="difflineminus">-    }</span>
<a href="#l30.1158"></a><span id="l30.1158" class="difflineminus">-    else {</span>
<a href="#l30.1159"></a><span id="l30.1159" class="difflineminus">-      ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1160"></a><span id="l30.1160" class="difflineminus">-    }</span>
<a href="#l30.1161"></a><span id="l30.1161" class="difflineminus">-  }</span>
<a href="#l30.1162"></a><span id="l30.1162" class="difflineminus">-  else {</span>
<a href="#l30.1163"></a><span id="l30.1163" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1164"></a><span id="l30.1164" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.1165"></a><span id="l30.1165" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.1166"></a><span id="l30.1166" class="difflineminus">-  }</span>
<a href="#l30.1167"></a><span id="l30.1167" class="difflineminus">-}</span>
<a href="#l30.1168"></a><span id="l30.1168" class="difflineminus">-</span>
<a href="#l30.1169"></a><span id="l30.1169" class="difflineminus">-function cardAdminDataCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.1170"></a><span id="l30.1170" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1171"></a><span id="l30.1171" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.1172"></a><span id="l30.1172" class="difflineminus">-</span>
<a href="#l30.1173"></a><span id="l30.1173" class="difflineminus">-  var pinObj = {};</span>
<a href="#l30.1174"></a><span id="l30.1174" class="difflineminus">-</span>
<a href="#l30.1175"></a><span id="l30.1175" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;cardedit.prompt&quot;)) {</span>
<a href="#l30.1176"></a><span id="l30.1176" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1177"></a><span id="l30.1177" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1178"></a><span id="l30.1178" class="difflineminus">-    switch (inputData.step) {</span>
<a href="#l30.1179"></a><span id="l30.1179" class="difflineminus">-      case 1:</span>
<a href="#l30.1180"></a><span id="l30.1180" class="difflineminus">-        ret.writeTxt = &quot;admin&quot;;</span>
<a href="#l30.1181"></a><span id="l30.1181" class="difflineminus">-        break;</span>
<a href="#l30.1182"></a><span id="l30.1182" class="difflineminus">-      case 2:</span>
<a href="#l30.1183"></a><span id="l30.1183" class="difflineminus">-        ret.writeTxt = &quot;name&quot;;</span>
<a href="#l30.1184"></a><span id="l30.1184" class="difflineminus">-        break;</span>
<a href="#l30.1185"></a><span id="l30.1185" class="difflineminus">-      case 3:</span>
<a href="#l30.1186"></a><span id="l30.1186" class="difflineminus">-        ret.writeTxt = &quot;lang&quot;;</span>
<a href="#l30.1187"></a><span id="l30.1187" class="difflineminus">-        break;</span>
<a href="#l30.1188"></a><span id="l30.1188" class="difflineminus">-      case 4:</span>
<a href="#l30.1189"></a><span id="l30.1189" class="difflineminus">-        ret.writeTxt = &quot;sex&quot;;</span>
<a href="#l30.1190"></a><span id="l30.1190" class="difflineminus">-        break;</span>
<a href="#l30.1191"></a><span id="l30.1191" class="difflineminus">-      case 5:</span>
<a href="#l30.1192"></a><span id="l30.1192" class="difflineminus">-        ret.writeTxt = &quot;url&quot;;</span>
<a href="#l30.1193"></a><span id="l30.1193" class="difflineminus">-        break;</span>
<a href="#l30.1194"></a><span id="l30.1194" class="difflineminus">-      case 6:</span>
<a href="#l30.1195"></a><span id="l30.1195" class="difflineminus">-        ret.writeTxt = &quot;login&quot;;</span>
<a href="#l30.1196"></a><span id="l30.1196" class="difflineminus">-        break;</span>
<a href="#l30.1197"></a><span id="l30.1197" class="difflineminus">-      case 7:</span>
<a href="#l30.1198"></a><span id="l30.1198" class="difflineminus">-        if (inputData.forcepin !== 0) {</span>
<a href="#l30.1199"></a><span id="l30.1199" class="difflineminus">-          ret.writeTxt = &quot;forcesig&quot;;</span>
<a href="#l30.1200"></a><span id="l30.1200" class="difflineminus">-        }</span>
<a href="#l30.1201"></a><span id="l30.1201" class="difflineminus">-        else {</span>
<a href="#l30.1202"></a><span id="l30.1202" class="difflineminus">-          ret.writeTxt = &quot;quit&quot;;</span>
<a href="#l30.1203"></a><span id="l30.1203" class="difflineminus">-          ret.exitCode = 0;</span>
<a href="#l30.1204"></a><span id="l30.1204" class="difflineminus">-          ret.quitNow = true;</span>
<a href="#l30.1205"></a><span id="l30.1205" class="difflineminus">-        }</span>
<a href="#l30.1206"></a><span id="l30.1206" class="difflineminus">-        break;</span>
<a href="#l30.1207"></a><span id="l30.1207" class="difflineminus">-      default:</span>
<a href="#l30.1208"></a><span id="l30.1208" class="difflineminus">-        ret.writeTxt = &quot;quit&quot;;</span>
<a href="#l30.1209"></a><span id="l30.1209" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.1210"></a><span id="l30.1210" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.1211"></a><span id="l30.1211" class="difflineminus">-        break;</span>
<a href="#l30.1212"></a><span id="l30.1212" class="difflineminus">-    }</span>
<a href="#l30.1213"></a><span id="l30.1213" class="difflineminus">-  }</span>
<a href="#l30.1214"></a><span id="l30.1214" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.1215"></a><span id="l30.1215" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.1216"></a><span id="l30.1216" class="difflineminus">-  }</span>
<a href="#l30.1217"></a><span id="l30.1217" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.1218"></a><span id="l30.1218" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.1219"></a><span id="l30.1219" class="difflineminus">-  }</span>
<a href="#l30.1220"></a><span id="l30.1220" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.smartcard.surname&quot;)) {</span>
<a href="#l30.1221"></a><span id="l30.1221" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1222"></a><span id="l30.1222" class="difflineminus">-    ret.writeTxt = inputData.name.replace(/^$/, &quot;-&quot;);</span>
<a href="#l30.1223"></a><span id="l30.1223" class="difflineminus">-  }</span>
<a href="#l30.1224"></a><span id="l30.1224" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;keygen.smartcard.givenname&quot;)) {</span>
<a href="#l30.1225"></a><span id="l30.1225" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1226"></a><span id="l30.1226" class="difflineminus">-    ret.writeTxt = inputData.firstname.replace(/^$/, &quot;-&quot;);</span>
<a href="#l30.1227"></a><span id="l30.1227" class="difflineminus">-  }</span>
<a href="#l30.1228"></a><span id="l30.1228" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardedit.change_sex&quot;)) {</span>
<a href="#l30.1229"></a><span id="l30.1229" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1230"></a><span id="l30.1230" class="difflineminus">-    ret.writeTxt = inputData.sex;</span>
<a href="#l30.1231"></a><span id="l30.1231" class="difflineminus">-  }</span>
<a href="#l30.1232"></a><span id="l30.1232" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardedit.change_lang&quot;)) {</span>
<a href="#l30.1233"></a><span id="l30.1233" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1234"></a><span id="l30.1234" class="difflineminus">-    ret.writeTxt = inputData.lang.replace(/^$/, &quot;-&quot;);</span>
<a href="#l30.1235"></a><span id="l30.1235" class="difflineminus">-  }</span>
<a href="#l30.1236"></a><span id="l30.1236" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardedit.change_url&quot;)) {</span>
<a href="#l30.1237"></a><span id="l30.1237" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1238"></a><span id="l30.1238" class="difflineminus">-    ret.writeTxt = inputData.url.replace(/^$/, &quot;-&quot;);</span>
<a href="#l30.1239"></a><span id="l30.1239" class="difflineminus">-  }</span>
<a href="#l30.1240"></a><span id="l30.1240" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardedit.change_login&quot;)) {</span>
<a href="#l30.1241"></a><span id="l30.1241" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1242"></a><span id="l30.1242" class="difflineminus">-    ret.writeTxt = inputData.login.replace(/^$/, &quot;-&quot;);</span>
<a href="#l30.1243"></a><span id="l30.1243" class="difflineminus">-  }</span>
<a href="#l30.1244"></a><span id="l30.1244" class="difflineminus">-  else {</span>
<a href="#l30.1245"></a><span id="l30.1245" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1246"></a><span id="l30.1246" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.1247"></a><span id="l30.1247" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.1248"></a><span id="l30.1248" class="difflineminus">-  }</span>
<a href="#l30.1249"></a><span id="l30.1249" class="difflineminus">-}</span>
<a href="#l30.1250"></a><span id="l30.1250" class="difflineminus">-</span>
<a href="#l30.1251"></a><span id="l30.1251" class="difflineminus">-function cardChangePinCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.1252"></a><span id="l30.1252" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1253"></a><span id="l30.1253" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.1254"></a><span id="l30.1254" class="difflineminus">-</span>
<a href="#l30.1255"></a><span id="l30.1255" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;cardedit.prompt&quot;)) {</span>
<a href="#l30.1256"></a><span id="l30.1256" class="difflineminus">-    ++inputData.step;</span>
<a href="#l30.1257"></a><span id="l30.1257" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1258"></a><span id="l30.1258" class="difflineminus">-    switch (inputData.step) {</span>
<a href="#l30.1259"></a><span id="l30.1259" class="difflineminus">-      case 1:</span>
<a href="#l30.1260"></a><span id="l30.1260" class="difflineminus">-        ret.writeTxt = &quot;admin&quot;;</span>
<a href="#l30.1261"></a><span id="l30.1261" class="difflineminus">-        break;</span>
<a href="#l30.1262"></a><span id="l30.1262" class="difflineminus">-      case 2:</span>
<a href="#l30.1263"></a><span id="l30.1263" class="difflineminus">-        ret.writeTxt = &quot;passwd&quot;;</span>
<a href="#l30.1264"></a><span id="l30.1264" class="difflineminus">-        break;</span>
<a href="#l30.1265"></a><span id="l30.1265" class="difflineminus">-      default:</span>
<a href="#l30.1266"></a><span id="l30.1266" class="difflineminus">-        ret.writeTxt = &quot;quit&quot;;</span>
<a href="#l30.1267"></a><span id="l30.1267" class="difflineminus">-        ret.exitCode = 0;</span>
<a href="#l30.1268"></a><span id="l30.1268" class="difflineminus">-        ret.quitNow = true;</span>
<a href="#l30.1269"></a><span id="l30.1269" class="difflineminus">-        break;</span>
<a href="#l30.1270"></a><span id="l30.1270" class="difflineminus">-    }</span>
<a href="#l30.1271"></a><span id="l30.1271" class="difflineminus">-  }</span>
<a href="#l30.1272"></a><span id="l30.1272" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.1273"></a><span id="l30.1273" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1274"></a><span id="l30.1274" class="difflineminus">-    ret.writeTxt = inputData.adminPin;</span>
<a href="#l30.1275"></a><span id="l30.1275" class="difflineminus">-  }</span>
<a href="#l30.1276"></a><span id="l30.1276" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.1277"></a><span id="l30.1277" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1278"></a><span id="l30.1278" class="difflineminus">-    ret.writeTxt = inputData.oldPin;</span>
<a href="#l30.1279"></a><span id="l30.1279" class="difflineminus">-  }</span>
<a href="#l30.1280"></a><span id="l30.1280" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.new.ask&quot;) ||</span>
<a href="#l30.1281"></a><span id="l30.1281" class="difflineminus">-    keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.repeat&quot;) ||</span>
<a href="#l30.1282"></a><span id="l30.1282" class="difflineminus">-    keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.ask&quot;) ||</span>
<a href="#l30.1283"></a><span id="l30.1283" class="difflineminus">-    keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.new.ask&quot;)) {</span>
<a href="#l30.1284"></a><span id="l30.1284" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1285"></a><span id="l30.1285" class="difflineminus">-    ret.writeTxt = inputData.newPin;</span>
<a href="#l30.1286"></a><span id="l30.1286" class="difflineminus">-  }</span>
<a href="#l30.1287"></a><span id="l30.1287" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;cardutil.change_pin.menu&quot;)) {</span>
<a href="#l30.1288"></a><span id="l30.1288" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1289"></a><span id="l30.1289" class="difflineminus">-    ++inputData.pinStep;</span>
<a href="#l30.1290"></a><span id="l30.1290" class="difflineminus">-    if (inputData.pinStep == 1) {</span>
<a href="#l30.1291"></a><span id="l30.1291" class="difflineminus">-      ret.writeTxt = inputData.action.toString();</span>
<a href="#l30.1292"></a><span id="l30.1292" class="difflineminus">-    }</span>
<a href="#l30.1293"></a><span id="l30.1293" class="difflineminus">-    else {</span>
<a href="#l30.1294"></a><span id="l30.1294" class="difflineminus">-      ret.writeTxt = &quot;Q&quot;;</span>
<a href="#l30.1295"></a><span id="l30.1295" class="difflineminus">-    }</span>
<a href="#l30.1296"></a><span id="l30.1296" class="difflineminus">-  }</span>
<a href="#l30.1297"></a><span id="l30.1297" class="difflineminus">-  else {</span>
<a href="#l30.1298"></a><span id="l30.1298" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.1299"></a><span id="l30.1299" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1300"></a><span id="l30.1300" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.1301"></a><span id="l30.1301" class="difflineminus">-  }</span>
<a href="#l30.1302"></a><span id="l30.1302" class="difflineminus">-}</span>
<a href="#l30.1303"></a><span id="l30.1303" class="difflineminus">-</span>
<a href="#l30.1304"></a><span id="l30.1304" class="difflineminus">-</span>
<a href="#l30.1305"></a><span id="l30.1305" class="difflineminus">-function addPhotoCallback(inputData, keyEdit, ret) {</span>
<a href="#l30.1306"></a><span id="l30.1306" class="difflineminus">-  ret.writeTxt = &quot;&quot;;</span>
<a href="#l30.1307"></a><span id="l30.1307" class="difflineminus">-  ret.errorMsg = &quot;&quot;;</span>
<a href="#l30.1308"></a><span id="l30.1308" class="difflineminus">-</span>
<a href="#l30.1309"></a><span id="l30.1309" class="difflineminus">-  if (keyEdit.doCheck(GET_LINE, &quot;keyedit.prompt&quot;)) {</span>
<a href="#l30.1310"></a><span id="l30.1310" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1311"></a><span id="l30.1311" class="difflineminus">-    ret.writeTxt = &quot;save&quot;;</span>
<a href="#l30.1312"></a><span id="l30.1312" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1313"></a><span id="l30.1313" class="difflineminus">-  }</span>
<a href="#l30.1314"></a><span id="l30.1314" class="difflineminus">-  else if (keyEdit.doCheck(GET_LINE, &quot;photoid.jpeg.add&quot;)) {</span>
<a href="#l30.1315"></a><span id="l30.1315" class="difflineminus">-    if (inputData.step === 0) {</span>
<a href="#l30.1316"></a><span id="l30.1316" class="difflineminus">-      ++inputData.step;</span>
<a href="#l30.1317"></a><span id="l30.1317" class="difflineminus">-      ret.exitCode = 0;</span>
<a href="#l30.1318"></a><span id="l30.1318" class="difflineminus">-      ret.writeTxt = inputData.file;</span>
<a href="#l30.1319"></a><span id="l30.1319" class="difflineminus">-    }</span>
<a href="#l30.1320"></a><span id="l30.1320" class="difflineminus">-    else {</span>
<a href="#l30.1321"></a><span id="l30.1321" class="difflineminus">-      ret.exitCode = -1;</span>
<a href="#l30.1322"></a><span id="l30.1322" class="difflineminus">-      ret.quitNow = true;</span>
<a href="#l30.1323"></a><span id="l30.1323" class="difflineminus">-    }</span>
<a href="#l30.1324"></a><span id="l30.1324" class="difflineminus">-  }</span>
<a href="#l30.1325"></a><span id="l30.1325" class="difflineminus">-  else if (keyEdit.doCheck(GET_BOOL, &quot;photoid.jpeg.size&quot;)) {</span>
<a href="#l30.1326"></a><span id="l30.1326" class="difflineminus">-    ret.exitCode = 0;</span>
<a href="#l30.1327"></a><span id="l30.1327" class="difflineminus">-    ret.writeTxt = &quot;Y&quot;; // add large file</span>
<a href="#l30.1328"></a><span id="l30.1328" class="difflineminus">-  }</span>
<a href="#l30.1329"></a><span id="l30.1329" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.adminpin.ask&quot;)) {</span>
<a href="#l30.1330"></a><span id="l30.1330" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterAdminPin&quot;), ret);</span>
<a href="#l30.1331"></a><span id="l30.1331" class="difflineminus">-  }</span>
<a href="#l30.1332"></a><span id="l30.1332" class="difflineminus">-  else if (keyEdit.doCheck(GET_HIDDEN, &quot;passphrase.pin.ask&quot;)) {</span>
<a href="#l30.1333"></a><span id="l30.1333" class="difflineminus">-    getPin(inputData.parent, EnigmailLocale.getString(&quot;enterCardPin&quot;), ret);</span>
<a href="#l30.1334"></a><span id="l30.1334" class="difflineminus">-  }</span>
<a href="#l30.1335"></a><span id="l30.1335" class="difflineminus">-  else {</span>
<a href="#l30.1336"></a><span id="l30.1336" class="difflineminus">-    ret.quitNow = true;</span>
<a href="#l30.1337"></a><span id="l30.1337" class="difflineminus">-    EnigmailLog.ERROR(&quot;Unknown command prompt: &quot; + keyEdit.getText() + &quot;\n&quot;);</span>
<a href="#l30.1338"></a><span id="l30.1338" class="difflineminus">-    ret.exitCode = -1;</span>
<a href="#l30.1339"></a><span id="l30.1339" class="difflineminus">-  }</span>
<a href="#l30.1340"></a><span id="l30.1340" class="difflineminus">-}</span>
<a href="#l30.1341"></a><span id="l30.1341" class="difflineminus">-</span>
<a href="#l30.1342"></a><span id="l30.1342" class="difflineminus">-function EnigCardAdminObserver(guiObserver, isDosLike) {</span>
<a href="#l30.1343"></a><span id="l30.1343" class="difflineminus">-  this._guiObserver = guiObserver;</span>
<a href="#l30.1344"></a><span id="l30.1344" class="difflineminus">-  this._isDosLike = isDosLike;</span>
<a href="#l30.1345"></a><span id="l30.1345" class="difflineminus">-}</span>
<a href="#l30.1346"></a><span id="l30.1346" class="difflineminus">-</span>
<a href="#l30.1347"></a><span id="l30.1347" class="difflineminus">-EnigCardAdminObserver.prototype = {</span>
<a href="#l30.1348"></a><span id="l30.1348" class="difflineminus">-  _guiObserver: null,</span>
<a href="#l30.1349"></a><span id="l30.1349" class="difflineminus">-  _failureCode: 0,</span>
<a href="#l30.1350"></a><span id="l30.1350" class="difflineminus">-</span>
<a href="#l30.1351"></a><span id="l30.1351" class="difflineminus">-  onDataAvailable: function(data) {</span>
<a href="#l30.1352"></a><span id="l30.1352" class="difflineminus">-    var ret = &quot;&quot;;</span>
<a href="#l30.1353"></a><span id="l30.1353" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: enigCardAdminObserver.onDataAvailable: data=&quot; + data + &quot;\n&quot;);</span>
<a href="#l30.1354"></a><span id="l30.1354" class="difflineminus">-    if (this._isDosLike &amp;&amp; data.indexOf(&quot;[GNUPG:] BACKUP_KEY_CREATED&quot;) === 0) {</span>
<a href="#l30.1355"></a><span id="l30.1355" class="difflineminus">-      data = data.replace(/\//g, &quot;\\&quot;);</span>
<a href="#l30.1356"></a><span id="l30.1356" class="difflineminus">-    }</span>
<a href="#l30.1357"></a><span id="l30.1357" class="difflineminus">-    if (data.indexOf(&quot;[GNUPG:] SC_OP_FAILURE&quot;) &gt;= 0) {</span>
<a href="#l30.1358"></a><span id="l30.1358" class="difflineminus">-      data = data.substr(23);</span>
<a href="#l30.1359"></a><span id="l30.1359" class="difflineminus">-      if (data == &quot;2&quot;) {</span>
<a href="#l30.1360"></a><span id="l30.1360" class="difflineminus">-        data = &quot;[GNUPG:] BAD_PASSPHRASE 0&quot;;</span>
<a href="#l30.1361"></a><span id="l30.1361" class="difflineminus">-        this._failureCode = 2;</span>
<a href="#l30.1362"></a><span id="l30.1362" class="difflineminus">-      }</span>
<a href="#l30.1363"></a><span id="l30.1363" class="difflineminus">-      else</span>
<a href="#l30.1364"></a><span id="l30.1364" class="difflineminus">-        this._failureCode = 1;</span>
<a href="#l30.1365"></a><span id="l30.1365" class="difflineminus">-    }</span>
<a href="#l30.1366"></a><span id="l30.1366" class="difflineminus">-    if (this._failureCode == 1) {</span>
<a href="#l30.1367"></a><span id="l30.1367" class="difflineminus">-      ret = &quot;[GNUPG:] ENIGMAIL_FAILURE &quot; + data;</span>
<a href="#l30.1368"></a><span id="l30.1368" class="difflineminus">-    }</span>
<a href="#l30.1369"></a><span id="l30.1369" class="difflineminus">-    if (this._guiObserver) {</span>
<a href="#l30.1370"></a><span id="l30.1370" class="difflineminus">-      this._guiObserver.onDataAvailable(data);</span>
<a href="#l30.1371"></a><span id="l30.1371" class="difflineminus">-    }</span>
<a href="#l30.1372"></a><span id="l30.1372" class="difflineminus">-    return ret;</span>
<a href="#l30.1373"></a><span id="l30.1373" class="difflineminus">-  }</span>
<a href="#l30.1374"></a><span id="l30.1374" class="difflineminus">-};</span>
<a href="#l30.1375"></a><span id="l30.1375" class="difflineminus">-</span>
<a href="#l30.1376"></a><span id="l30.1376" class="difflineminus">-function ChangePasswdObserver() {}</span>
<a href="#l30.1377"></a><span id="l30.1377" class="difflineminus">-</span>
<a href="#l30.1378"></a><span id="l30.1378" class="difflineminus">-ChangePasswdObserver.prototype = {</span>
<a href="#l30.1379"></a><span id="l30.1379" class="difflineminus">-  _failureCode: 0,</span>
<a href="#l30.1380"></a><span id="l30.1380" class="difflineminus">-  passphraseStatus: 0,</span>
<a href="#l30.1381"></a><span id="l30.1381" class="difflineminus">-</span>
<a href="#l30.1382"></a><span id="l30.1382" class="difflineminus">-  onDataAvailable: function(data) {</span>
<a href="#l30.1383"></a><span id="l30.1383" class="difflineminus">-    var ret = &quot;&quot;;</span>
<a href="#l30.1384"></a><span id="l30.1384" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyEdit.jsm: ChangePasswdObserver.onDataAvailable: data=&quot; + data + &quot;\n&quot;);</span>
<a href="#l30.1385"></a><span id="l30.1385" class="difflineminus">-    if (this._failureCode) {</span>
<a href="#l30.1386"></a><span id="l30.1386" class="difflineminus">-      ret = &quot;[GNUPG:] ENIGMAIL_FAILURE &quot; + data;</span>
<a href="#l30.1387"></a><span id="l30.1387" class="difflineminus">-    }</span>
<a href="#l30.1388"></a><span id="l30.1388" class="difflineminus">-    if (data.indexOf(&quot;[GNUPG:] GOOD_PASSPHRASE&quot;) &gt;= 0) {</span>
<a href="#l30.1389"></a><span id="l30.1389" class="difflineminus">-      this.passphraseStatus = 1;</span>
<a href="#l30.1390"></a><span id="l30.1390" class="difflineminus">-    }</span>
<a href="#l30.1391"></a><span id="l30.1391" class="difflineminus">-    else if (data.indexOf(&quot;[GNUPG:] BAD_PASSPHRASE&quot;) &gt;= 0) {</span>
<a href="#l30.1392"></a><span id="l30.1392" class="difflineminus">-      this.passphraseStatus = -1;</span>
<a href="#l30.1393"></a><span id="l30.1393" class="difflineminus">-    }</span>
<a href="#l30.1394"></a><span id="l30.1394" class="difflineminus">-    return ret;</span>
<a href="#l30.1395"></a><span id="l30.1395" class="difflineminus">-  }</span>
<a href="#l30.1396"></a><span id="l30.1396" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -5,40 +5,37 @@</span>
<a href="#l31.4"></a><span id="l31.4">  */</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> &quot;use strict&quot;;</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> var EXPORTED_SYMBOLS = [&quot;EnigmailKeyRing&quot;];</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l31.11"></a><span id="l31.11"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l31.13"></a><span id="l31.13"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l31.14"></a><span id="l31.14"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l31.15"></a><span id="l31.15"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l31.16"></a><span id="l31.16"> const EnigmailTrust = ChromeUtils.import(&quot;chrome://openpgp/content/modules/trust.jsm&quot;).EnigmailTrust;</span>
<a href="#l31.17"></a><span id="l31.17"> const EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l31.18"></a><span id="l31.18"> const EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l31.19"></a><span id="l31.19"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-//const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l31.21"></a><span id="l31.21"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l31.22"></a><span id="l31.22"> const newEnigmailKeyObj = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyObj.jsm&quot;).newEnigmailKeyObj;</span>
<a href="#l31.23"></a><span id="l31.23"> const EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l31.24"></a><span id="l31.24"> const Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l31.25"></a><span id="l31.25"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l31.26"></a><span id="l31.26"> const EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l31.27"></a><span id="l31.27"> </span>
<a href="#l31.28"></a><span id="l31.28"> </span>
<a href="#l31.29"></a><span id="l31.29"> const getDialog = EnigmailLazy.loader(&quot;enigmail/dialog.jsm&quot;, &quot;EnigmailDialog&quot;);</span>
<a href="#l31.30"></a><span id="l31.30"> const getWindows = EnigmailLazy.loader(&quot;enigmail/windows.jsm&quot;, &quot;EnigmailWindows&quot;);</span>
<a href="#l31.31"></a><span id="l31.31"> const getKeyUsability = EnigmailLazy.loader(&quot;enigmail/keyUsability.jsm&quot;, &quot;EnigmailKeyUsability&quot;);</span>
<a href="#l31.32"></a><span id="l31.32"> </span>
<a href="#l31.33"></a><span id="l31.33"> const DEFAULT_FILE_PERMS = 0o600;</span>
<a href="#l31.34"></a><span id="l31.34"> </span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-let gKeygenProcess = null;</span>
<a href="#l31.36"></a><span id="l31.36"> let gKeyListObj = null;</span>
<a href="#l31.37"></a><span id="l31.37"> let gKeyIndex = [];</span>
<a href="#l31.38"></a><span id="l31.38"> let gSubkeyIndex = [];</span>
<a href="#l31.39"></a><span id="l31.39"> let gKeyCheckDone = false;</span>
<a href="#l31.40"></a><span id="l31.40"> let gLoadingKeys = false;</span>
<a href="#l31.41"></a><span id="l31.41"> </span>
<a href="#l31.42"></a><span id="l31.42"> /*</span>
<a href="#l31.43"></a><span id="l31.43"> </span>
<a href="#l31.44"></a><span id="l31.44" class="difflineat">@@ -416,127 +413,28 @@ var EnigmailKeyRing = {</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l31.47"></a><span id="l31.47">     let keyBlock = cApi.sync(cApi.getPublicKey(id[0]));</span>
<a href="#l31.48"></a><span id="l31.48">     if (!keyBlock) {</span>
<a href="#l31.49"></a><span id="l31.49">       errorMsgObj.value = EnigmailLocale.getString(&quot;failKeyExtract&quot;);</span>
<a href="#l31.50"></a><span id="l31.50">       return &quot;&quot;;</span>
<a href="#l31.51"></a><span id="l31.51">     }</span>
<a href="#l31.52"></a><span id="l31.52"> </span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-    /*</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true).concat([&quot;-a&quot;, &quot;--export&quot;]);</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-    if (userId) {</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-      args = args.concat(userId.split(/[ ,\t]+/));</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-    }</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-    const cmdErrorMsgObj = {};</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-    let keyBlock = EnigmailExecution.execCmd(EnigmailGpg.agentPath, args, &quot;&quot;, exitCodeObj, {}, {}, cmdErrorMsgObj);</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-    if ((exitCodeObj.value === 0) &amp;&amp; !keyBlock) {</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-      exitCodeObj.value = -1;</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-    }</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-    if (exitCodeObj.value !== 0) {</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-      errorMsgObj.value = EnigmailLocale.getString(&quot;failKeyExtract&quot;);</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-      if (cmdErrorMsgObj.value) {</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-        errorMsgObj.value += &quot;\n&quot; + EnigmailFiles.formatCmdLine(EnigmailGpg.agentPath, args);</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-        errorMsgObj.value += &quot;\n&quot; + cmdErrorMsgObj.value;</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-      }</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-    }</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-    if (includeSecretKey) {</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineminus">-</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-      let keyList;</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-      if (userId) {</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-        keyList = userId.split(/[ ,\t]+/);</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-      }</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-      else {</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-        keyList = this.getAllSecretKeys().map(keyObj =&gt; {</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-          return keyObj.keyId;</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineminus">-        });</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-      }</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-      let secKeyBlock = keyList.map(uid =&gt; {</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-        let keyObj = EnigmailKeyRing.getKeyById(uid);</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-        if (keyObj) return keyObj.getSecretKey(false).keyData;</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineminus">-        let k = EnigmailKeyRing.getKeysByUserId(uid);</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-        if (k &amp;&amp; k.length &gt; 0) {</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-          return k.map(keyObj =&gt; {</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-            return keyObj.getSecretKey(false).keyData;</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-          }).join(&quot;\n&quot;);</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-        }</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-        else {</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-          return &quot;&quot;;</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineminus">-        }</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-      }).join(&quot;\n&quot;);</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-      keyBlock += &quot;\n&quot; + secKeyBlock;</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-    }</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-    */</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-</span>
<a href="#l31.108"></a><span id="l31.108">     exitCodeObj.value = 0;</span>
<a href="#l31.109"></a><span id="l31.109">     if (outputFile) {</span>
<a href="#l31.110"></a><span id="l31.110">       if (!EnigmailFiles.writeFileContents(outputFile, keyBlock, DEFAULT_FILE_PERMS)) {</span>
<a href="#l31.111"></a><span id="l31.111">         exitCodeObj.value = -1;</span>
<a href="#l31.112"></a><span id="l31.112">         errorMsgObj.value = EnigmailLocale.getString(&quot;fileWriteFailed&quot;, [outputFile]);</span>
<a href="#l31.113"></a><span id="l31.113">       }</span>
<a href="#l31.114"></a><span id="l31.114">       return &quot;&quot;;</span>
<a href="#l31.115"></a><span id="l31.115">     }</span>
<a href="#l31.116"></a><span id="l31.116">     return keyBlock;</span>
<a href="#l31.117"></a><span id="l31.117">   },</span>
<a href="#l31.118"></a><span id="l31.118"> </span>
<a href="#l31.119"></a><span id="l31.119">   /**</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-   * Export the ownertrust database from GnuPG</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-   * @param outputFile        String or nsIFile - output file name or Object - or NULL</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-   * @param exitCodeObj       Object   - o.value will contain exit code</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-   * @param errorMsgObj       Object   - o.value will contain error message from GnuPG</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-   *</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-   * @return String - if outputFile is NULL, the key block data; &quot;&quot; if a file is written</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-   */</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-  extractOwnerTrust: function(outputFile, exitCodeObj, errorMsgObj) {</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true).concat([&quot;--export-ownertrust&quot;]);</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-    let trustData = EnigmailExecution.execCmd(EnigmailGpg.agentPath, args, &quot;&quot;, exitCodeObj, {}, {}, errorMsgObj);</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineminus">-    if (outputFile) {</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineminus">-      if (!EnigmailFiles.writeFileContents(outputFile, trustData, DEFAULT_FILE_PERMS)) {</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineminus">-        exitCodeObj.value = -1;</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-        errorMsgObj.value = EnigmailLocale.getString(&quot;fileWriteFailed&quot;, [outputFile]);</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-      }</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineminus">-    }</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineminus">-</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineminus">-    return trustData;</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineminus">-  },</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineminus">-  /**</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-   * Import the ownertrust database into GnuPG</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineminus">-   * @param inputFile        String or nsIFile - input file name or Object - or NULL</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineminus">-   * @param errorMsgObj       Object   - o.value will contain error message from GnuPG</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineminus">-   *</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-   * @return exit code</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineminus">-   */</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineminus">-  importOwnerTrust: function(inputFile, errorMsgObj) {</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true).concat([&quot;--import-ownertrust&quot;]);</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineminus">-    let exitCodeObj = {};</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-    try {</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-      let trustData = EnigmailFiles.readFile(inputFile);</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-      EnigmailExecution.execCmd(EnigmailGpg.agentPath, args, trustData, exitCodeObj, {}, {}, errorMsgObj);</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-    }</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-    catch (ex) {}</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineminus">-</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineminus">-    return exitCodeObj.value;</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineminus">-  },</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineminus">-  /**</span>
<a href="#l31.164"></a><span id="l31.164">    * import key from provided key data (synchronous)</span>
<a href="#l31.165"></a><span id="l31.165">    *</span>
<a href="#l31.166"></a><span id="l31.166">    * @param parent          nsIWindow</span>
<a href="#l31.167"></a><span id="l31.167">    * @param isInteractive   Boolean  - if true, display confirmation dialog</span>
<a href="#l31.168"></a><span id="l31.168">    * @param keyBlock        String   - data containing key</span>
<a href="#l31.169"></a><span id="l31.169">    * @param keyId           String   - key ID expected to import (no meaning)</span>
<a href="#l31.170"></a><span id="l31.170">    * @param errorMsgObj     Object   - o.value will contain error message from GnuPG</span>
<a href="#l31.171"></a><span id="l31.171">    * @param importedKeysObj Object   - [OPTIONAL] o.value will contain an array of the FPRs imported</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineat">@@ -599,92 +497,31 @@ var EnigmailKeyRing = {</span>
<a href="#l31.173"></a><span id="l31.173">     if (limitedUids.length &gt; 0) {</span>
<a href="#l31.174"></a><span id="l31.174">       throw &quot;importKeyAsync with limitedUids: not implemented&quot;;</span>
<a href="#l31.175"></a><span id="l31.175">     }</span>
<a href="#l31.176"></a><span id="l31.176"> </span>
<a href="#l31.177"></a><span id="l31.177">     if (minimizeKey) {</span>
<a href="#l31.178"></a><span id="l31.178">       throw &quot;importKeyAsync with minimizeKey: not implemented&quot;;</span>
<a href="#l31.179"></a><span id="l31.179">     }</span>
<a href="#l31.180"></a><span id="l31.180"> </span>
<a href="#l31.181"></a><span id="l31.181" class="difflineminus">-    /*</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(false).concat([&quot;--no-verbose&quot;, &quot;--status-fd&quot;, &quot;2&quot;]);</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineminus">-    if (minimizeKey) {</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineminus">-      args = args.concat([&quot;--import-options&quot;, &quot;import-minimal&quot;]);</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineminus">-    }</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineminus">-</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineminus">-    if (limitedUids.length &gt; 0 &amp;&amp; EnigmailGpg.getGpgFeature(&quot;export-specific-uid&quot;)) {</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineminus">-      let filter = limitedUids.map(i =&gt; {</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineminus">-        return `mbox =~ ${i}`;</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineminus">-      }).join(&quot; || &quot;);</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineminus">-</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineminus">-      args.push(&quot;--import-filter&quot;);</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineminus">-      args.push(`keep-uid=${filter}`);</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineminus">-    }</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineminus">-    args = args.concat([&quot;--no-auto-check-trustdb&quot;, &quot;--import&quot;]);</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineminus">-</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineminus">-    const res = await EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, pgpBlock);</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineminus">-</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineminus">-    const statusMsg = res.statusMsg;</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineminus">-    */</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineminus">-</span>
<a href="#l31.202"></a><span id="l31.202">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l31.203"></a><span id="l31.203">     let result = cApi.sync(cApi.importKeyBlock(pgpBlock));</span>
<a href="#l31.204"></a><span id="l31.204"> </span>
<a href="#l31.205"></a><span id="l31.205">     if (!importedKeysObj) {</span>
<a href="#l31.206"></a><span id="l31.206">       importedKeysObj = {};</span>
<a href="#l31.207"></a><span id="l31.207">     }</span>
<a href="#l31.208"></a><span id="l31.208">     importedKeysObj.value = [];</span>
<a href="#l31.209"></a><span id="l31.209"> </span>
<a href="#l31.210"></a><span id="l31.210">     let exitCode = 0;</span>
<a href="#l31.211"></a><span id="l31.211"> </span>
<a href="#l31.212"></a><span id="l31.212">     EnigmailKeyRing.clearCache();</span>
<a href="#l31.213"></a><span id="l31.213"> </span>
<a href="#l31.214"></a><span id="l31.214" class="difflineminus">-    /*</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineminus">-    let exitCode = 1;</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineminus">-    if (statusMsg &amp;&amp; (statusMsg.search(/^IMPORT_RES /m) &gt; -1)) {</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineminus">-      let importRes = statusMsg.match(/^IMPORT_RES ([0-9]+) ([0-9]+) ([0-9]+) 0 ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+) ([0-9]+)/m);</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineminus">-</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineminus">-      if (importRes !== null) {</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineminus">-        let secCount = parseInt(importRes[9], 10); // number of secret keys found</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineminus">-        let secImported = parseInt(importRes[10], 10); // number of secret keys imported</span>
<a href="#l31.222"></a><span id="l31.222" class="difflineminus">-        let secDups = parseInt(importRes[11], 10); // number of secret keys already on the keyring</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineminus">-</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineminus">-        if (secCount !== secImported + secDups) {</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineminus">-          EnigmailKeyRing.clearCache();</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineminus">-          errorMsgObj.value = EnigmailLocale.getString(&quot;import.secretKeyImportError&quot;);</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-          return 1;</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-        }</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineminus">-      }</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineminus">-</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineminus">-      exitCode = 0;</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineminus">-      // Normal return</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-      if (statusMsg.search(/^IMPORT_OK /m) &gt; -1) {</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-        let l = statusMsg.split(/\r|\n/);</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineminus">-        for (let i = 0; i &lt; l.length; i++) {</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineminus">-          const matches = l[i].match(/^(IMPORT_OK [0-9]+ )(([0-9a-fA-F]{8}){2,5})/);</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineminus">-          if (matches &amp;&amp; (matches.length &gt; 2)) {</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineminus">-            EnigmailLog.DEBUG(&quot;enigmail.js: Enigmail.importKey: IMPORTED 0x&quot; + matches[2] + &quot;\n&quot;);</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineminus">-            importedKeysObj.value.push(matches[2]);</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineminus">-          }</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineminus">-        }</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineminus">-</span>
<a href="#l31.243"></a><span id="l31.243" class="difflineminus">-        if (importedKeysObj.value.length &gt; 0) {</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineminus">-          EnigmailKeyRing.updateKeys(importedKeysObj.value);</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineminus">-        }</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineminus">-      }</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineminus">-    }</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineminus">-    */</span>
<a href="#l31.249"></a><span id="l31.249" class="difflineminus">-</span>
<a href="#l31.250"></a><span id="l31.250">     return exitCode;</span>
<a href="#l31.251"></a><span id="l31.251">   },</span>
<a href="#l31.252"></a><span id="l31.252"> </span>
<a href="#l31.253"></a><span id="l31.253" class="difflineminus">-  isGeneratingKey: function() {</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineminus">-    return gKeygenProcess !== null;</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineminus">-  },</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineminus">-</span>
<a href="#l31.257"></a><span id="l31.257">   /**</span>
<a href="#l31.258"></a><span id="l31.258">    * Generate a new key pair with GnuPG</span>
<a href="#l31.259"></a><span id="l31.259">    *</span>
<a href="#l31.260"></a><span id="l31.260">    * @name:       String     - name part of UID</span>
<a href="#l31.261"></a><span id="l31.261">    * @comment:    String     - comment part of UID (brackets are added)</span>
<a href="#l31.262"></a><span id="l31.262">    * @comment:    String     - email part of UID (&lt;&gt; will be added)</span>
<a href="#l31.263"></a><span id="l31.263">    * @expiryDate: Number     - Unix timestamp of key expiry date; 0 if no expiry</span>
<a href="#l31.264"></a><span id="l31.264">    * @keyLength:  Number     - size of key in bytes (e.g 4096)</span>
<a href="#l31.265"></a><span id="l31.265" class="difflineat">@@ -695,112 +532,17 @@ var EnigmailKeyRing = {</span>
<a href="#l31.266"></a><span id="l31.266">    *                             function onStopRequest(exitCode) {...}</span>
<a href="#l31.267"></a><span id="l31.267">    *                           }</span>
<a href="#l31.268"></a><span id="l31.268">    *</span>
<a href="#l31.269"></a><span id="l31.269">    * @return: handle to process</span>
<a href="#l31.270"></a><span id="l31.270">    */</span>
<a href="#l31.271"></a><span id="l31.271">   generateKey: function(name, comment, email, expiryDate, keyLength, keyType,</span>
<a href="#l31.272"></a><span id="l31.272">     passphrase, listener) {</span>
<a href="#l31.273"></a><span id="l31.273">     EnigmailLog.WRITE(&quot;keyRing.jsm: generateKey:\n&quot;);</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineminus">-</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineminus">-    if (EnigmailKeyRing.isGeneratingKey()) {</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineminus">-      // key generation already ongoing</span>
<a href="#l31.277"></a><span id="l31.277" class="difflineminus">-      throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineminus">-    }</span>
<a href="#l31.279"></a><span id="l31.279" class="difflineminus">-</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineminus">-    const args = EnigmailGpg.getStandardArgs(true).concat([&quot;--gen-key&quot;]);</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineminus">-</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineminus">-    EnigmailLog.CONSOLE(EnigmailFiles.formatCmdLine(EnigmailGpg.agentPath, args));</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineminus">-</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineminus">-    let inputData = &quot;%echo Generating key\nKey-Type: &quot;;</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineminus">-</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineminus">-    switch (keyType) {</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineminus">-      case &quot;RSA&quot;:</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineminus">-        inputData += &quot;RSA\nKey-Usage: sign,auth\nKey-Length: &quot; + keyLength;</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineminus">-        inputData += &quot;\nSubkey-Type: RSA\nSubkey-Usage: encrypt\nSubkey-Length: &quot; + keyLength + &quot;\n&quot;;</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineminus">-        break;</span>
<a href="#l31.291"></a><span id="l31.291" class="difflineminus">-      case &quot;ECC&quot;:</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineminus">-        inputData += &quot;EDDSA\nKey-Curve: Ed25519\nKey-Usage: sign\n&quot;;</span>
<a href="#l31.293"></a><span id="l31.293" class="difflineminus">-        inputData += &quot;Subkey-Type: ECDH\nSubkey-Curve: Curve25519\nSubkey-Usage: encrypt\n&quot;;</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineminus">-        break;</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineminus">-      default:</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-        return null;</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineminus">-    }</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineminus">-</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineminus">-    if (name.replace(/ /g, &quot;&quot;).length) {</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineminus">-      inputData += &quot;Name-Real: &quot; + name + &quot;\n&quot;;</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineminus">-    }</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineminus">-    if (comment &amp;&amp; comment.replace(/ /g, &quot;&quot;).length) {</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineminus">-      inputData += &quot;Name-Comment: &quot; + comment + &quot;\n&quot;;</span>
<a href="#l31.304"></a><span id="l31.304" class="difflineminus">-    }</span>
<a href="#l31.305"></a><span id="l31.305" class="difflineminus">-    inputData += &quot;Name-Email: &quot; + email + &quot;\n&quot;;</span>
<a href="#l31.306"></a><span id="l31.306" class="difflineminus">-    inputData += &quot;Expire-Date: &quot; + String(expiryDate) + &quot;\n&quot;;</span>
<a href="#l31.307"></a><span id="l31.307" class="difflineminus">-</span>
<a href="#l31.308"></a><span id="l31.308" class="difflineminus">-    EnigmailLog.CONSOLE(inputData + &quot; \n&quot;);</span>
<a href="#l31.309"></a><span id="l31.309" class="difflineminus">-</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineminus">-    if (passphrase.length) {</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineminus">-      inputData += &quot;Passphrase: &quot; + passphrase + &quot;\n&quot;;</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineminus">-    }</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineminus">-    else {</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineminus">-      if (EnigmailGpg.getGpgFeature(&quot;genkey-no-protection&quot;)) {</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineminus">-        inputData += &quot;%echo no-protection\n&quot;;</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineminus">-        inputData += &quot;%no-protection\n&quot;;</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineminus">-      }</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineminus">-    }</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineminus">-</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineminus">-    inputData += &quot;%commit\n%echo done\n&quot;;</span>
<a href="#l31.321"></a><span id="l31.321" class="difflineminus">-</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineminus">-    let proc = null;</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineminus">-</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineminus">-    console.debug(&quot;reaching disabled keyRing.generateKey&quot;);</span>
<a href="#l31.325"></a><span id="l31.325" class="difflineminus">-    /*</span>
<a href="#l31.326"></a><span id="l31.326" class="difflineminus">-    try {</span>
<a href="#l31.327"></a><span id="l31.327" class="difflineminus">-      proc = subprocess.call({</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineminus">-        command: EnigmailGpg.agentPath,</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineminus">-        arguments: args,</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineminus">-        environment: EnigmailCore.getEnvList(),</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineminus">-        charset: null,</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineminus">-        stdin: function(pipe) {</span>
<a href="#l31.333"></a><span id="l31.333" class="difflineminus">-          pipe.write(inputData);</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineminus">-          pipe.close();</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineminus">-        },</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineminus">-        stderr: function(data) {</span>
<a href="#l31.337"></a><span id="l31.337" class="difflineminus">-          // extract key ID</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineminus">-          if (data.search(/^\[GNUPG:\] KEY_CREATED/m)) {</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineminus">-            let m = data.match(/^(\[GNUPG:\] KEY_CREATED [BPS] )([^ \r\n\t]+)$/m);</span>
<a href="#l31.340"></a><span id="l31.340" class="difflineminus">-            if (m &amp;&amp; m.length &gt; 2) {</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineminus">-              listener.keyId = &quot;0x&quot; + m[2];</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineminus">-            }</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineminus">-          }</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineminus">-          listener.onDataAvailable(data);</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineminus">-        },</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineminus">-        done: function(result) {</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineminus">-          gKeygenProcess = null;</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineminus">-          try {</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineminus">-            if (result.exitCode === 0) {</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineminus">-              EnigmailKeyRing.clearCache();</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineminus">-            }</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineminus">-            listener.onStopRequest(result.exitCode);</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineminus">-          }</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineminus">-          catch (ex) {}</span>
<a href="#l31.355"></a><span id="l31.355" class="difflineminus">-        },</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineminus">-        mergeStderr: false</span>
<a href="#l31.357"></a><span id="l31.357" class="difflineminus">-      });</span>
<a href="#l31.358"></a><span id="l31.358" class="difflineminus">-    }</span>
<a href="#l31.359"></a><span id="l31.359" class="difflineminus">-    catch (ex) {</span>
<a href="#l31.360"></a><span id="l31.360" class="difflineminus">-      EnigmailLog.ERROR(&quot;keyRing.jsm: generateKey: subprocess.call failed with '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineminus">-      throw ex;</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineminus">-    }</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineminus">-    */</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineminus">-</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineminus">-    gKeygenProcess = proc;</span>
<a href="#l31.366"></a><span id="l31.366" class="difflineminus">-</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyRing.jsm: generateKey: subprocess = &quot; + proc + &quot;\n&quot;);</span>
<a href="#l31.368"></a><span id="l31.368" class="difflineminus">-</span>
<a href="#l31.369"></a><span id="l31.369" class="difflineminus">-    return proc;</span>
<a href="#l31.370"></a><span id="l31.370" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l31.371"></a><span id="l31.371">   },</span>
<a href="#l31.372"></a><span id="l31.372"> </span>
<a href="#l31.373"></a><span id="l31.373">   /**</span>
<a href="#l31.374"></a><span id="l31.374">    * try to find valid key for encryption to passed email address</span>
<a href="#l31.375"></a><span id="l31.375">    *</span>
<a href="#l31.376"></a><span id="l31.376">    * @param details if not null returns error in details.msg</span>
<a href="#l31.377"></a><span id="l31.377">    *</span>
<a href="#l31.378"></a><span id="l31.378">    * @return: found key ID (without leading &quot;0x&quot;) or null</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -11,17 +11,16 @@ const EXPORTED_SYMBOLS = [&quot;EnigmailKeySe</span>
<a href="#l32.4"></a><span id="l32.4"> Components.utils.importGlobalProperties([&quot;XMLHttpRequest&quot;]);</span>
<a href="#l32.5"></a><span id="l32.5"> const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l32.6"></a><span id="l32.6"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l32.7"></a><span id="l32.7"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l32.8"></a><span id="l32.8"> const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l32.9"></a><span id="l32.9"> const EnigmailKeyserverURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyserverUris.jsm&quot;).EnigmailKeyserverURIs;</span>
<a href="#l32.10"></a><span id="l32.10"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l32.11"></a><span id="l32.11"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l32.13"></a><span id="l32.13"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l32.14"></a><span id="l32.14"> const EnigmailHttpProxy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/httpProxy.jsm&quot;).EnigmailHttpProxy;</span>
<a href="#l32.15"></a><span id="l32.15"> const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l32.16"></a><span id="l32.16"> const EnigmailXhrUtils = ChromeUtils.import(&quot;chrome://openpgp/content/modules/xhrUtils.jsm&quot;).EnigmailXhrUtils;</span>
<a href="#l32.17"></a><span id="l32.17"> const EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l32.18"></a><span id="l32.18"> const EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20"> const IOSERVICE_CONTRACTID = &quot;@mozilla.org/network/io-service;1&quot;;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineat">@@ -831,68 +830,34 @@ const accessGnuPG = {</span>
<a href="#l32.22"></a><span id="l32.22">    * @param keyId:       String  - space-separated list of search terms or key IDs</span>
<a href="#l32.23"></a><span id="l32.23">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l32.24"></a><span id="l32.24">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l32.25"></a><span id="l32.25">    *</span>
<a href="#l32.26"></a><span id="l32.26">    * @return Promise&lt;Object&gt; Object from execAsync</span>
<a href="#l32.27"></a><span id="l32.27">    */</span>
<a href="#l32.28"></a><span id="l32.28">   accessKeyServer: function(actionFlag, keyserver, keyId, listener) {</span>
<a href="#l32.29"></a><span id="l32.29">     EnigmailLog.DEBUG(`keyserver.jsm: accessGnuPG: accessKeyServer(${keyserver})\n`);</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-    let processHandle = {</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-      value: null</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-    };</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l32.35"></a><span id="l32.35"> </span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-    if (listener) {</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-      listener._isCancelled = 0;</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-      listener.onCancel = function() {</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-        EnigmailLog.DEBUG(`keyserver.jsm: accessGnuPG: accessKeyServer: onCancel\n`);</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-        if (processHandle.value) {</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-          processHandle.value.killProcess();</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-        }</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-        this._isCancelled = 1;</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-      };</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-    }</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+    /*</span>
<a href="#l32.49"></a><span id="l32.49">     if (keyserver === null) {</span>
<a href="#l32.50"></a><span id="l32.50">       keyserver = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l32.51"></a><span id="l32.51">     }</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-    args.push(&quot;--log-file&quot;);</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-    args.push(EnigmailOS.isWin32 ? &quot;NUL&quot; : &quot;/dev/null&quot;);</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-    args.push(&quot;--with-colons&quot;);</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-    let cmd = &quot;&quot;;</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-</span>
<a href="#l32.60"></a><span id="l32.60">     let proxyHost = EnigmailHttpProxy.getHttpProxy();</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-    if (proxyHost) {</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-      args = args.concat([&quot;--keyserver-options&quot;, &quot;http-proxy=&quot; + proxyHost]);</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-    }</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-    args.push(&quot;--keyserver&quot;);</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-    args.push(keyserver);</span>
<a href="#l32.67"></a><span id="l32.67"> </span>
<a href="#l32.68"></a><span id="l32.68">     switch (actionFlag) {</span>
<a href="#l32.69"></a><span id="l32.69">       case EnigmailConstants.SEARCH_KEY:</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-        cmd = &quot;--search-keys&quot;;</span>
<a href="#l32.71"></a><span id="l32.71">         break;</span>
<a href="#l32.72"></a><span id="l32.72">       case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-        cmd = &quot;--recv-keys&quot;;</span>
<a href="#l32.74"></a><span id="l32.74">         break;</span>
<a href="#l32.75"></a><span id="l32.75">       case EnigmailConstants.UPLOAD_KEY:</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-        cmd = &quot;--send-keys&quot;;</span>
<a href="#l32.77"></a><span id="l32.77">         break;</span>
<a href="#l32.78"></a><span id="l32.78">     }</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-    args.push(cmd);</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-    args = args.concat(keyId.split(/ +/));</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-    return EnigmailExecution.execAsync(EnigmailGpg.agentPath, args, &quot;&quot;, processHandle);</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+    */</span>
<a href="#l32.85"></a><span id="l32.85">   },</span>
<a href="#l32.86"></a><span id="l32.86"> </span>
<a href="#l32.87"></a><span id="l32.87">   parseStatusMsg: function(execResult) {</span>
<a href="#l32.88"></a><span id="l32.88">     let errorCode = 0,</span>
<a href="#l32.89"></a><span id="l32.89">       errorType = null;</span>
<a href="#l32.90"></a><span id="l32.90"> </span>
<a href="#l32.91"></a><span id="l32.91">     // Find the 1st FAILURE message in the gpg status output</span>
<a href="#l32.92"></a><span id="l32.92">     let m = execResult.stderrData.match(/^\[GNUPG:\] (FAILURE|ERROR) ([^ ]+ )(\d+)/m);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/localizeHtml.jsm</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/localizeHtml.jsm</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -7,67 +7,49 @@</span>
<a href="#l33.4"></a><span id="l33.4"> &quot;use strict&quot;;</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> var EXPORTED_SYMBOLS = [&quot;EnigmailLocalizeHtml&quot;];</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l33.9"></a><span id="l33.9"> const EnigmailBuildDate = ChromeUtils.import(&quot;chrome://openpgp/content/modules/buildDate.jsm&quot;).EnigmailBuildDate;</span>
<a href="#l33.10"></a><span id="l33.10"> const EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l33.11"></a><span id="l33.11"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-const EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l33.13"></a><span id="l33.13"> const Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15"> function getEnigmailVersion() {</span>
<a href="#l33.16"></a><span id="l33.16">   let versionStr = EnigmailApp.getVersion() + &quot; (&quot; + EnigmailBuildDate.built + &quot;)&quot;;</span>
<a href="#l33.17"></a><span id="l33.17">   return EnigmailLocale.getString(&quot;usingVersion&quot;, versionStr);</span>
<a href="#l33.18"></a><span id="l33.18"> }</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-function getGpgWorking() {</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-  var enigmailSvc = EnigmailCore.getService();</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-  var agentStr;</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-  if (enigmailSvc) {</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-    agentStr = EnigmailLocale.getString(&quot;usingAgent&quot;, [EnigmailGpgAgent.agentType, EnigmailGpgAgent.agentPath.path]);</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-  } else {</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-    agentStr = EnigmailLocale.getString(&quot;agentError&quot;);</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-    if (enigmailSvc &amp;&amp; enigmailSvc.initializationError)</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-      agentStr += &quot;\n&quot; + enigmailSvc.initializationError;</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  }</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-  return agentStr;</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-}</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-</span>
<a href="#l33.36"></a><span id="l33.36"> var EnigmailLocalizeHtml = {</span>
<a href="#l33.37"></a><span id="l33.37">   getAllElementsWithAttribute: function(doc, attribute) {</span>
<a href="#l33.38"></a><span id="l33.38">     let matchingElements = [];</span>
<a href="#l33.39"></a><span id="l33.39">     let allElements = doc.getElementsByTagName('*');</span>
<a href="#l33.40"></a><span id="l33.40">     for (let i = 0, n = allElements.length; i &lt; n; i++) {</span>
<a href="#l33.41"></a><span id="l33.41">       if (allElements[i].getAttribute(attribute) !== null) {</span>
<a href="#l33.42"></a><span id="l33.42">         matchingElements.push(allElements[i]);</span>
<a href="#l33.43"></a><span id="l33.43">       }</span>
<a href="#l33.44"></a><span id="l33.44">     }</span>
<a href="#l33.45"></a><span id="l33.45">     return matchingElements;</span>
<a href="#l33.46"></a><span id="l33.46">   },</span>
<a href="#l33.47"></a><span id="l33.47"> </span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-</span>
<a href="#l33.49"></a><span id="l33.49">   onPageLoad: function(doc) {</span>
<a href="#l33.50"></a><span id="l33.50">     let elem = this.getAllElementsWithAttribute(doc, &quot;txtId&quot;);</span>
<a href="#l33.51"></a><span id="l33.51"> </span>
<a href="#l33.52"></a><span id="l33.52">     for (let i = 0; i &lt; elem.length; i++) {</span>
<a href="#l33.53"></a><span id="l33.53">       let node = elem[i];</span>
<a href="#l33.54"></a><span id="l33.54">       let txtId = node.getAttribute(&quot;txtId&quot;);</span>
<a href="#l33.55"></a><span id="l33.55">       let param = node.getAttribute(&quot;txtParam&quot;);</span>
<a href="#l33.56"></a><span id="l33.56"> </span>
<a href="#l33.57"></a><span id="l33.57">       switch (txtId) {</span>
<a href="#l33.58"></a><span id="l33.58">         case &quot;FNC_enigmailVersion&quot;:</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-          node.innerHTML = getEnigmailVersion();</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+          node.innerHTML = &quot;no version&quot;;</span>
<a href="#l33.61"></a><span id="l33.61">           break;</span>
<a href="#l33.62"></a><span id="l33.62">         case &quot;FNC_isGpgWorking&quot;:</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-          node.innerHTML = getGpgWorking();</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+          node.innerHTML = &quot;no agent&quot;;</span>
<a href="#l33.65"></a><span id="l33.65">           break;</span>
<a href="#l33.66"></a><span id="l33.66">         default:</span>
<a href="#l33.67"></a><span id="l33.67">           node.innerHTML = EnigmailLocale.getString(txtId, param);</span>
<a href="#l33.68"></a><span id="l33.68">       }</span>
<a href="#l33.69"></a><span id="l33.69"> </span>
<a href="#l33.70"></a><span id="l33.70">     }</span>
<a href="#l33.71"></a><span id="l33.71">   }</span>
<a href="#l33.72"></a><span id="l33.72"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -296,17 +296,17 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l34.4"></a><span id="l34.4">       } catch (ex) {</span>
<a href="#l34.5"></a><span id="l34.5">         // not a base64 encoded</span>
<a href="#l34.6"></a><span id="l34.6">       }</span>
<a href="#l34.7"></a><span id="l34.7">     }</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9">     return ret;</span>
<a href="#l34.10"></a><span id="l34.10">   },</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  // cache encrypted data for writing to subprocess</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  // cache encrypted data</span>
<a href="#l34.14"></a><span id="l34.14">   cacheData: function(str) {</span>
<a href="#l34.15"></a><span id="l34.15">     if (gDebugLogLevel &gt; 4)</span>
<a href="#l34.16"></a><span id="l34.16">       LOCAL_DEBUG(&quot;mimeDecrypt.jsm: cacheData: &quot; + str.length + &quot;\n&quot;);</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18">     this.outQueue += str;</span>
<a href="#l34.19"></a><span id="l34.19">   },</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21">   processBase64Message: function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -695,17 +695,16 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l35.4"></a><span id="l35.4">       exitCode,</span>
<a href="#l35.5"></a><span id="l35.5">       this.UIFlags,</span>
<a href="#l35.6"></a><span id="l35.6">       this.sendFlags,</span>
<a href="#l35.7"></a><span id="l35.7">       this.dataLength,</span>
<a href="#l35.8"></a><span id="l35.8">       retStatusObj);</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10">     if (this.exitCode !== 0)</span>
<a href="#l35.11"></a><span id="l35.11">       EnigmailDialog.alert(this.win, retStatusObj.errorMsg);</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-</span>
<a href="#l35.13"></a><span id="l35.13">   },</span>
<a href="#l35.14"></a><span id="l35.14"> };</span>
<a href="#l35.15"></a><span id="l35.15"> </span>
<a href="#l35.16"></a><span id="l35.16"> </span>
<a href="#l35.17"></a><span id="l35.17"> ////////////////////////////////////////////////////////////////////</span>
<a href="#l35.18"></a><span id="l35.18"> // General-purpose functions, not exported</span>
<a href="#l35.19"></a><span id="l35.19"> </span>
<a href="#l35.20"></a><span id="l35.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/msgRead.jsm</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/msgRead.jsm</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -9,17 +9,16 @@</span>
<a href="#l36.4"></a><span id="l36.4"> var EXPORTED_SYMBOLS = [&quot;EnigmailMsgRead&quot;];</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> /**</span>
<a href="#l36.7"></a><span id="l36.7">  * Message-reading related functions</span>
<a href="#l36.8"></a><span id="l36.8">  */</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l36.11"></a><span id="l36.11"> const EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-const EnigmailVersioning = ChromeUtils.import(&quot;chrome://openpgp/content/modules/versioning.jsm&quot;).EnigmailVersioning;</span>
<a href="#l36.13"></a><span id="l36.13"> const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l36.14"></a><span id="l36.14"> const EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l36.15"></a><span id="l36.15"> const EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l36.16"></a><span id="l36.16"> const EnigmailCompat = ChromeUtils.import(&quot;chrome://openpgp/content/modules/compat.jsm&quot;).EnigmailCompat;</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18"> const ExtraHeaders = [&quot;autocrypt&quot;, &quot;openpgp&quot;];</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20"> var EnigmailMsgRead = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/os.jsm</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/os.jsm</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -5,18 +5,16 @@</span>
<a href="#l37.4"></a><span id="l37.4">  */</span>
<a href="#l37.5"></a><span id="l37.5"> </span>
<a href="#l37.6"></a><span id="l37.6"> &quot;use strict&quot;;</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> const EXPORTED_SYMBOLS = [&quot;EnigmailOS&quot;];</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> const XPCOM_APPINFO = &quot;@mozilla.org/xre/app-info;1&quot;;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-// const getExecution = EnigmailLazy.loader(&quot;enigmail/execution.jsm&quot;, &quot;EnigmailExecution&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-</span>
<a href="#l37.14"></a><span id="l37.14"> let operatingSystem = null;</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16"> function getOS() {</span>
<a href="#l37.17"></a><span id="l37.17">   if (operatingSystem === null) {</span>
<a href="#l37.18"></a><span id="l37.18">     operatingSystem = Cc[XPCOM_APPINFO].getService(Ci.nsIXULRuntime).OS;</span>
<a href="#l37.19"></a><span id="l37.19">   }</span>
<a href="#l37.20"></a><span id="l37.20">   return operatingSystem;</span>
<a href="#l37.21"></a><span id="l37.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/passwords.jsm</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ /dev/null</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -1,79 +0,0 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-/*</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">- */</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailPassword&quot;];</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-const gpgAgent = EnigmailLazy.loader(&quot;enigmail/gpgAgent.jsm&quot;, &quot;EnigmailGpgAgent&quot;);</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-const getDialog = EnigmailLazy.loader(&quot;enigmail/dialog.jsm&quot;, &quot;EnigmailDialog&quot;);</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-const getLocale = EnigmailLazy.loader(&quot;enigmail/locale.jsm&quot;, &quot;EnigmailLocale&quot;);</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-var EnigmailPassword = {</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-  /*</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-   * Get GnuPG command line options for receiving the password depending</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-   * on the various user and system settings (gpg-agent/no passphrase)</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-   *</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-   * @return: Array the GnuPG command line options</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-   */</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-  command: function() {</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-    return [&quot;--use-agent&quot;];</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-  },</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-  getMaxIdleMinutes: function() {</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-    try {</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-      return EnigmailPrefs.getPref(&quot;maxIdleMinutes&quot;);</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-    }</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-    catch (ex) {}</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineminus">-</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-    return 5;</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineminus">-  },</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-  clearPassphrase: function(win) {</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineminus">-    // clear all passphrases from gpg-agent by reloading the config</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-    if (!EnigmailCore.getService()) return;</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-    let exitCode = -1;</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-    let isError = 0;</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-    const proc = {</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-      command: gpgAgent().connGpgAgentPath,</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-      arguments: [],</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-      charset: null,</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineminus">-      environment: EnigmailCore.getEnvList(),</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineminus">-      stdin: function(pipe) {</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">-        pipe.write(&quot;RELOADAGENT\n&quot;);</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineminus">-        pipe.write(&quot;/bye\n&quot;);</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-        pipe.close();</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-      },</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineminus">-        if (data.search(/^ERR/m) &gt;= 0) {</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineminus">-          ++isError;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-        }</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-      }</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-    };</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-    try {</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-      exitCode = subprocess.call(proc).wait();</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-    }</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-    catch (ex) {}</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-    if (isError === 0) {</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-      getDialog().alert(win, getLocale().getString(&quot;passphraseCleared&quot;));</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-    }</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-    else {</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-      getDialog().alert(win, getLocale().getString(&quot;cannotClearPassphrase&quot;));</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineminus">-    }</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-  }</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/persistentCrypto.jsm</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/persistentCrypto.jsm</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -8,34 +8,32 @@</span>
<a href="#l39.4"></a><span id="l39.4"> &quot;use strict&quot;;</span>
<a href="#l39.5"></a><span id="l39.5"> </span>
<a href="#l39.6"></a><span id="l39.6"> var EXPORTED_SYMBOLS = [&quot;EnigmailPersistentCrypto&quot;];</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> const EnigmailLazy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/lazy.jsm&quot;).EnigmailLazy;</span>
<a href="#l39.9"></a><span id="l39.9"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l39.10"></a><span id="l39.10"> const EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l39.11"></a><span id="l39.11"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l39.13"></a><span id="l39.13"> const GlodaUtils = ChromeUtils.import(&quot;chrome://openpgp/content/modules/glodaUtils.jsm&quot;).GlodaUtils;</span>
<a href="#l39.14"></a><span id="l39.14"> const EnigmailCompat = ChromeUtils.import(&quot;chrome://openpgp/content/modules/compat.jsm&quot;).EnigmailCompat;</span>
<a href="#l39.15"></a><span id="l39.15"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l39.16"></a><span id="l39.16"> const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l39.17"></a><span id="l39.17"> const EnigmailStreams = ChromeUtils.import(&quot;chrome://openpgp/content/modules/streams.jsm&quot;).EnigmailStreams;</span>
<a href="#l39.18"></a><span id="l39.18"> const EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l39.19"></a><span id="l39.19"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l39.20"></a><span id="l39.20"> const EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l39.21"></a><span id="l39.21"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l39.22"></a><span id="l39.22"> const jsmime = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;).jsmime;</span>
<a href="#l39.23"></a><span id="l39.23"> const EnigmailStdlib = ChromeUtils.import(&quot;chrome://openpgp/content/modules/stdlib.jsm&quot;).EnigmailStdlib;</span>
<a href="#l39.24"></a><span id="l39.24"> const EnigmailEncryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/encryption.jsm&quot;).EnigmailEncryption;</span>
<a href="#l39.25"></a><span id="l39.25"> </span>
<a href="#l39.26"></a><span id="l39.26"> const getFixExchangeMsg = EnigmailLazy.loader(&quot;enigmail/fixExchangeMsg.jsm&quot;, &quot;EnigmailFixExchangeMsg&quot;);</span>
<a href="#l39.27"></a><span id="l39.27"> const getDecryption = EnigmailLazy.loader(&quot;enigmail/decryption.jsm&quot;, &quot;EnigmailDecryption&quot;);</span>
<a href="#l39.28"></a><span id="l39.28"> const getDialog = EnigmailLazy.loader(&quot;enigmail/dialog.jsm&quot;, &quot;EnigmailDialog&quot;);</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineminus">-const getGpgAgent = EnigmailLazy.loader(&quot;enigmail/gpgAgent.jsm&quot;, &quot;EnigmailGpgAgent&quot;);</span>
<a href="#l39.30"></a><span id="l39.30"> </span>
<a href="#l39.31"></a><span id="l39.31"> const STATUS_OK = 0;</span>
<a href="#l39.32"></a><span id="l39.32"> const STATUS_FAILURE = 1;</span>
<a href="#l39.33"></a><span id="l39.33"> const STATUS_NOT_REQUIRED = 2;</span>
<a href="#l39.34"></a><span id="l39.34"> </span>
<a href="#l39.35"></a><span id="l39.35"> const IOSERVICE_CONTRACTID = &quot;@mozilla.org/network/io-service;1&quot;;</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37"> /*</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineat">@@ -428,83 +426,29 @@ CryptMessageIntoFolder.prototype = {</span>
<a href="#l39.39"></a><span id="l39.39">       subParts: []</span>
<a href="#l39.40"></a><span id="l39.40">     }];</span>
<a href="#l39.41"></a><span id="l39.41"> </span>
<a href="#l39.42"></a><span id="l39.42"> </span>
<a href="#l39.43"></a><span id="l39.43">     this.messageDecrypted = true;</span>
<a href="#l39.44"></a><span id="l39.44">   },</span>
<a href="#l39.45"></a><span id="l39.45"> </span>
<a href="#l39.46"></a><span id="l39.46">   decryptAttachment: function(mimePart) {</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+    EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment()\n&quot;);</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l39.49"></a><span id="l39.49"> </span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-    EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment()\n&quot;);</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+    /*</span>
<a href="#l39.52"></a><span id="l39.52">     let attachmentHead = mimePart.body.substr(0, 30);</span>
<a href="#l39.53"></a><span id="l39.53">     if (attachmentHead.search(/-----BEGIN PGP \w{5,10} KEY BLOCK-----/) &gt;= 0) {</span>
<a href="#l39.54"></a><span id="l39.54">       // attachment appears to be a PGP key file, we just go-a-head</span>
<a href="#l39.55"></a><span id="l39.55">       return;</span>
<a href="#l39.56"></a><span id="l39.56">     }</span>
<a href="#l39.57"></a><span id="l39.57"> </span>
<a href="#l39.58"></a><span id="l39.58">     let attachmentName = getAttachmentName(mimePart);</span>
<a href="#l39.59"></a><span id="l39.59">     attachmentName = attachmentName ? attachmentName.replace(/\.(pgp|asc|gpg)$/, &quot;&quot;) : &quot;&quot;;</span>
<a href="#l39.60"></a><span id="l39.60"> </span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-    let args = EnigmailGpg.getStandardArgs(true);</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-    args.push(&quot;-d&quot;);</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-    let statusMsgObj = {};</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-    let cmdLineObj = {};</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-    let exitCode = -1;</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-    let statusFlagsObj = {</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-      value: 0</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-    };</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">-    let errorMsgObj = {};</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">-</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineminus">-    let listener = EnigmailExecution.newSimpleListener((pipe) =&gt; {</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">-      pipe.write(mimePart.body);</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineminus">-      pipe.close();</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-    });</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-    do {</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-      // loop to allow for multiple tries of the passphrase</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-      let proc = EnigmailExecution.execStart(getGpgAgent().agentPath, args, false, null, listener, statusFlagsObj);</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineminus">-      if (!proc) {</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-        return;</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-      }</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineminus">-      // Wait for child STDOUT to close</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineminus">-      proc.wait();</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">-      EnigmailExecution.execEnd(listener, statusFlagsObj, statusMsgObj, cmdLineObj, errorMsgObj);</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-      if ((listener.stdoutData &amp;&amp; listener.stdoutData.length &gt; 0) ||</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">-        (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY)) {</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-        EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment: decryption OK\n&quot;);</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-        exitCode = 0;</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-      } else if (statusFlagsObj.value &amp; (EnigmailConstants.DECRYPTION_FAILED | EnigmailConstants.MISSING_MDC)) {</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-        EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment: decryption without MDC protection\n&quot;);</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineminus">-        exitCode = 0;</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineminus">-      } else if (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_FAILED) {</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-        EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment: decryption failed\n&quot;);</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-        // since we cannot find out if the user wants to cancel</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-        // we should ask</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-        let msg = EnigmailLocale.getString(&quot;converter.decryptAtt.failed&quot;, [attachmentName, this.subject]);</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-        if (!getDialog().confirmDlg(null, msg,</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineminus">-            EnigmailLocale.getString(&quot;dlg.button.retry&quot;), EnigmailLocale.getString(&quot;dlg.button.skip&quot;))) {</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-          return;</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-        }</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineminus">-      } else if (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_INCOMPLETE) {</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineminus">-        // failure; message not complete</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineminus">-        EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment: decryption incomplete\n&quot;);</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineminus">-        return;</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineminus">-      } else {</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineminus">-        // there is nothing to be decrypted</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-        EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment: no decryption required\n&quot;);</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-        return;</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineminus">-      }</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineminus">-</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineminus">-    } while (exitCode !== 0);</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineminus">-</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineminus">-</span>
<a href="#l39.117"></a><span id="l39.117">     EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptAttachment: decrypted to &quot; + listener.stdoutData.length + &quot; bytes\n&quot;);</span>
<a href="#l39.118"></a><span id="l39.118">     if (statusFlagsObj.encryptedFileName &amp;&amp; statusFlagsObj.encryptedFileName.length &gt; 0) {</span>
<a href="#l39.119"></a><span id="l39.119">       attachmentName = statusFlagsObj.encryptedFileName;</span>
<a href="#l39.120"></a><span id="l39.120">     }</span>
<a href="#l39.121"></a><span id="l39.121"> </span>
<a href="#l39.122"></a><span id="l39.122">     this.decryptedMessage = true;</span>
<a href="#l39.123"></a><span id="l39.123">     mimePart.body = listener.stdoutData;</span>
<a href="#l39.124"></a><span id="l39.124">     mimePart.headers._rawHeaders.set(&quot;content-disposition&quot;, `attachment; filename=&quot;${attachmentName}&quot;`);</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineat">@@ -516,16 +460,17 @@ CryptMessageIntoFolder.prototype = {</span>
<a href="#l39.126"></a><span id="l39.126">     for (let i of origCt.entries()) {</span>
<a href="#l39.127"></a><span id="l39.127">       if (i[0].toLowerCase() === &quot;name&quot;) {</span>
<a href="#l39.128"></a><span id="l39.128">         i[1] = i[1].replace(/\.(pgp|asc|gpg)$/, &quot;&quot;);</span>
<a href="#l39.129"></a><span id="l39.129">       }</span>
<a href="#l39.130"></a><span id="l39.130">       ct += `; ${i[0]}=&quot;${i[1]}&quot;`;</span>
<a href="#l39.131"></a><span id="l39.131">     }</span>
<a href="#l39.132"></a><span id="l39.132"> </span>
<a href="#l39.133"></a><span id="l39.133">     mimePart.headers._rawHeaders.set(&quot;content-type&quot;, [ct]);</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+    */</span>
<a href="#l39.135"></a><span id="l39.135">   },</span>
<a href="#l39.136"></a><span id="l39.136"> </span>
<a href="#l39.137"></a><span id="l39.137"> </span>
<a href="#l39.138"></a><span id="l39.138">   decryptINLINE: function(mimePart) {</span>
<a href="#l39.139"></a><span id="l39.139">     EnigmailLog.DEBUG(&quot;persistentCrypto.jsm: decryptINLINE()\n&quot;);</span>
<a href="#l39.140"></a><span id="l39.140"> </span>
<a href="#l39.141"></a><span id="l39.141">     if ((&quot;decryptedPgpMime&quot; in mimePart) &amp;&amp; mimePart.decryptedPgpMime) {</span>
<a href="#l39.142"></a><span id="l39.142">       return 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">deleted file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/subprocess.jsm</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ /dev/null</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -1,390 +0,0 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">-</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-/*</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">- * Import into a JS component using</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">- * 'ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;);'</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">- *</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">- * This object allows to start a process, and read/write data to/from it</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">- * using stdin/stdout/stderr streams.</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">- * Usage example:</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">- *</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">- *  var p = subprocess.call({</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">- *    command:     '/bin/foo',</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">- *    arguments:   ['-v', 'foo'],</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">- *    environment: [ &quot;XYZ=abc&quot;, &quot;MYVAR=def&quot; ],</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">- *    //stdin: &quot;some value to write to stdin\nfoobar&quot;,</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">- *    stdin: function(stdin) {</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">- *      stdin.write(&quot;some value to write to stdin\nfoobar&quot;);</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">- *      stdin.close();</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">- *    },</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">- *    stdout: function(data) {</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">- *      dump(&quot;got data on stdout:&quot; + data + &quot;\n&quot;);</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">- *    },</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">- *    stderr: function(data) {</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">- *      dump(&quot;got data on stderr:&quot; + data + &quot;\n&quot;);</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">- *    },</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">- *    done: function(result) {</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">- *      dump(&quot;process terminated with &quot; + result.exitCode + &quot;\n&quot;);</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">- *    },</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">- *    mergeStderr: false</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">- *  });</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineminus">- *  p.wait(); // wait for the subprocess to terminate</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineminus">- *            // this will block the main thread,</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">- *            // only do if you can wait that long</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineminus">- *</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">- *</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">- * Description of parameters:</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">- * --------------------------</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">- * Apart from &lt;command&gt;, all arguments are optional.</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineminus">- *</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">- * command:     either a |nsIFile| object pointing to an executable file or a</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">- *              String containing the platform-dependent path to an executable</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineminus">- *              file.</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineminus">- *</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineminus">- * arguments:   optional string array containing the arguments to the command.</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineminus">- *</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineminus">- * environment: optional string array containing environment variables to pass</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineminus">- *              to the command. The array elements must have the form</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineminus">- *              &quot;VAR=data&quot;. Please note that if environment is defined, it</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineminus">- *              replaces any existing environment variables for the subprocess.</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineminus">- *</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineminus">- * stdin:       optional input data for the process to be passed on standard</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">- *              input. stdin can either be a string or a function.</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineminus">- *              A |string| gets written to stdin and stdin gets closed;</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">- *              A |function| gets passed an object with write and close function.</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineminus">- *              Please note that the write() function will return almost immediately;</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineminus">- *              data is always written asynchronously on a separate thread.</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineminus">- *</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineminus">- * stdout:      an optional function that can receive output data from the</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineminus">- *              process. The stdout-function is called asynchronously; it can be</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">- *              called mutliple times during the execution of a process.</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineminus">- *              At a minimum at each occurance of \n or \r.</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineminus">- *              Please note that null-characters might need to be escaped</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineminus">- *              with something like 'data.replace(/\0/g, &quot;\\0&quot;);'.</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineminus">- *</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">- * stderr:      an optional function that can receive stderr data from the</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineminus">- *              process. The stderr-function is called asynchronously; it can be</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineminus">- *              called mutliple times during the execution of a process. Please</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineminus">- *              note that null-characters might need to be escaped with</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineminus">- *              something like 'data.replace(/\0/g, &quot;\\0&quot;);'.</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineminus">- *              (on windows it only gets called once right now)</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineminus">- *</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineminus">- *</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineminus">- * done:        optional function that is called when the process has terminated.</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineminus">- *              The exit code from the process available via result.exitCode. If</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineminus">- *              stdout is not defined, then the output from stdout is available</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineminus">- *              via result.stdout. stderr data is in result.stderr</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">- *              done() is guaranteed to be called before .wait() finishes</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineminus">- *</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineminus">- * mergeStderr: optional boolean value. If true, stderr is merged with stdout;</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineminus">- *              no data will be provided to stderr. Default is false.</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineminus">- *</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineminus">- *</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineminus">- * Description of object returned by subprocess.call(...)</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineminus">- * ------------------------------------------------------</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineminus">- * The object returned by subprocess.call offers a few methods that can be</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineminus">- * executed:</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">- *</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">- * wait():         waits for the subprocess to terminate. It is not required to use</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineminus">- *                 wait; done will be called in any case when the subprocess terminated.</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineminus">- *</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineminus">- * kill(hardKill): kill the subprocess. Any open pipes will be closed and</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineminus">- *                 done will be called.</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineminus">- *                 hardKill [ignored on Windows]:</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineminus">- *                  - false: signal the process terminate (SIGTERM)</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineminus">- *                  - true:  kill the process (SIGKILL)</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineminus">- *</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineminus">- *</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineminus">- * Other methods in subprocess</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineminus">- * ---------------------------</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineminus">- *</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineminus">- * registerDebugHandler(functionRef):   register a handler that is called to get</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineminus">- *                                      debugging information</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineminus">- * registerLogHandler(functionRef):     register a handler that is called to get error</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineminus">- *                                      messages</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineminus">- *</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineminus">- * example:</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">- *    subprocess.registerLogHandler( function(s) { dump(s); } );</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineminus">- */</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineminus">-</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineminus">-'use strict';</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineminus">-</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineminus">-const SubprocessMain = ChromeUtils.import(&quot;chrome://openpgp/content/modules/enigmailprocess_main.jsm&quot;).SubprocessMain;</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineminus">-const Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineminus">-</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;subprocess&quot;];</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineminus">-</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineminus">-const DEFAULT_ENVIRONMENT = [];</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineminus">-</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineminus">-var gDebugFunction = null;</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineminus">-var gErrorFunction = null;</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-var gRunningProcesses = []; // Array with all running subprocesses</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineminus">-</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineminus">-function write(pipe, data) {</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineminus">-  let buffer = new Uint8Array(Array.from(data, c =&gt; c.charCodeAt(0)));</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineminus">-  return pipe.write(buffer);</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineminus">-}</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineminus">-</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineminus">-function arrayBufferToString(buffer) {</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineminus">-  const MAXLEN = 102400;</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineminus">-</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineminus">-  let uArr = new Uint8Array(buffer);</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineminus">-  let ret = &quot;&quot;;</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineminus">-  let len = buffer.byteLength;</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineminus">-</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineminus">-  for (let j = 0; j &lt; Math.floor(len / MAXLEN) + 1; j++) {</span>
<a href="#l40.142"></a><span id="l40.142" class="difflineminus">-    ret += String.fromCharCode.apply(null, uArr.subarray(j * MAXLEN, ((j + 1) * MAXLEN)));</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineminus">-  }</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineminus">-</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineminus">-  return ret;</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineminus">-}</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineminus">-</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineminus">-async function read(pipe) {</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineminus">-  let buffer = await pipe.read();</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineminus">-</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineminus">-  try {</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineminus">-    if (buffer.byteLength &gt; 0) {</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineminus">-      return arrayBufferToString(buffer);</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineminus">-    }</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineminus">-  } catch (ex) {</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineminus">-    DEBUG_LOG(&quot;err: &quot; + ex.toString());</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineminus">-  }</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineminus">-  return &quot;&quot;;</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineminus">-}</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineminus">-</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineminus">-</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineminus">-var readAllData = async function(pipe, read, callback) {</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineminus">-  /* eslint no-cond-assign: 0 */</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineminus">-  let string;</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineminus">-  while (string = await read(pipe)) {</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineminus">-    callback(string);</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineminus">-  }</span>
<a href="#l40.168"></a><span id="l40.168" class="difflineminus">-};</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineminus">-</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineminus">-</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineminus">-function removeProcRef(proc) {</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineminus">-  if (proc) {</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineminus">-    let i = gRunningProcesses.indexOf(proc);</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineminus">-    if (i &gt;= 0) {</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineminus">-      gRunningProcesses.splice(i, 1);</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineminus">-    }</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineminus">-  }</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineminus">-}</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineminus">-</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineminus">-var subprocess = {</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineminus">-  registerLogHandler: function(func) {</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineminus">-    gErrorFunction = func;</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineminus">-  },</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineminus">-</span>
<a href="#l40.185"></a><span id="l40.185" class="difflineminus">-  registerDebugHandler: function(func) {</span>
<a href="#l40.186"></a><span id="l40.186" class="difflineminus">-    gDebugFunction = func;</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineminus">-  },</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineminus">-</span>
<a href="#l40.189"></a><span id="l40.189" class="difflineminus">-  call: function(options) {</span>
<a href="#l40.190"></a><span id="l40.190" class="difflineminus">-</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineminus">-    let resolved = null;</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineminus">-    let promises = [];</span>
<a href="#l40.193"></a><span id="l40.193" class="difflineminus">-    let inputPromises = [];</span>
<a href="#l40.194"></a><span id="l40.194" class="difflineminus">-    let stdinClosed = false;</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineminus">-    let stdoutData = &quot;&quot;;</span>
<a href="#l40.196"></a><span id="l40.196" class="difflineminus">-    let stderrData = &quot;&quot;;</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineminus">-</span>
<a href="#l40.198"></a><span id="l40.198" class="difflineminus">-    let formattedStack = Components.stack.formattedStack;</span>
<a href="#l40.199"></a><span id="l40.199" class="difflineminus">-</span>
<a href="#l40.200"></a><span id="l40.200" class="difflineminus">-    function writePipe(pipe, value) {</span>
<a href="#l40.201"></a><span id="l40.201" class="difflineminus">-      let p = write(pipe, value);</span>
<a href="#l40.202"></a><span id="l40.202" class="difflineminus">-      promises.push(p);</span>
<a href="#l40.203"></a><span id="l40.203" class="difflineminus">-      inputPromises.push(p);</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineminus">-    }</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineminus">-</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineminus">-    function subProcessThen(proc) {</span>
<a href="#l40.207"></a><span id="l40.207" class="difflineminus">-      gRunningProcesses.push(proc);</span>
<a href="#l40.208"></a><span id="l40.208" class="difflineminus">-</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineminus">-      if (typeof options.stdin === &quot;function&quot;) {</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineminus">-        // Some callers (e.g. child_process.js) depend on this</span>
<a href="#l40.211"></a><span id="l40.211" class="difflineminus">-        // being called synchronously.</span>
<a href="#l40.212"></a><span id="l40.212" class="difflineminus">-        options.stdin({</span>
<a href="#l40.213"></a><span id="l40.213" class="difflineminus">-          write(val) {</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineminus">-            writePipe(proc.stdin, val);</span>
<a href="#l40.215"></a><span id="l40.215" class="difflineminus">-          },</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineminus">-</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineminus">-          close() {</span>
<a href="#l40.218"></a><span id="l40.218" class="difflineminus">-            Promise.all(inputPromises).then(() =&gt; {</span>
<a href="#l40.219"></a><span id="l40.219" class="difflineminus">-              if (!stdinClosed) {</span>
<a href="#l40.220"></a><span id="l40.220" class="difflineminus">-                stdinClosed = true;</span>
<a href="#l40.221"></a><span id="l40.221" class="difflineminus">-                proc.stdin.close();</span>
<a href="#l40.222"></a><span id="l40.222" class="difflineminus">-              }</span>
<a href="#l40.223"></a><span id="l40.223" class="difflineminus">-            });</span>
<a href="#l40.224"></a><span id="l40.224" class="difflineminus">-          }</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineminus">-        });</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineminus">-</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineminus">-      } else {</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineminus">-        if (typeof options.stdin === &quot;string&quot;) {</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineminus">-          DEBUG_LOG(&quot;write Stdin&quot;);</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineminus">-          writePipe(proc.stdin, options.stdin);</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineminus">-        }</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineminus">-</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineminus">-        Promise.all(inputPromises).then(() =&gt; {</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineminus">-          proc.stdin.close();</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineminus">-        });</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineminus">-      }</span>
<a href="#l40.237"></a><span id="l40.237" class="difflineminus">-</span>
<a href="#l40.238"></a><span id="l40.238" class="difflineminus">-</span>
<a href="#l40.239"></a><span id="l40.239" class="difflineminus">-      promises.push(</span>
<a href="#l40.240"></a><span id="l40.240" class="difflineminus">-        readAllData(proc.stdout, read, data =&gt; {</span>
<a href="#l40.241"></a><span id="l40.241" class="difflineminus">-          DEBUG_LOG(&quot;Got Stdout: &quot; + data.length + &quot;\n&quot;);</span>
<a href="#l40.242"></a><span id="l40.242" class="difflineminus">-          if (typeof options.stdout === &quot;function&quot;) {</span>
<a href="#l40.243"></a><span id="l40.243" class="difflineminus">-            try {</span>
<a href="#l40.244"></a><span id="l40.244" class="difflineminus">-              options.stdout(data);</span>
<a href="#l40.245"></a><span id="l40.245" class="difflineminus">-            } catch (ex) {}</span>
<a href="#l40.246"></a><span id="l40.246" class="difflineminus">-          } else</span>
<a href="#l40.247"></a><span id="l40.247" class="difflineminus">-            stdoutData += data;</span>
<a href="#l40.248"></a><span id="l40.248" class="difflineminus">-        }));</span>
<a href="#l40.249"></a><span id="l40.249" class="difflineminus">-</span>
<a href="#l40.250"></a><span id="l40.250" class="difflineminus">-      if (!options.mergeStderr) {</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineminus">-        promises.push(</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineminus">-          readAllData(proc.stderr, read, data =&gt; {</span>
<a href="#l40.253"></a><span id="l40.253" class="difflineminus">-            DEBUG_LOG(&quot;Got Stderr: &quot; + data.length + &quot;\n&quot;);</span>
<a href="#l40.254"></a><span id="l40.254" class="difflineminus">-            if (typeof options.stderr === &quot;function&quot;) {</span>
<a href="#l40.255"></a><span id="l40.255" class="difflineminus">-              try {</span>
<a href="#l40.256"></a><span id="l40.256" class="difflineminus">-                options.stderr(data);</span>
<a href="#l40.257"></a><span id="l40.257" class="difflineminus">-              } catch (ex) {}</span>
<a href="#l40.258"></a><span id="l40.258" class="difflineminus">-            } else</span>
<a href="#l40.259"></a><span id="l40.259" class="difflineminus">-              stderrData += data;</span>
<a href="#l40.260"></a><span id="l40.260" class="difflineminus">-</span>
<a href="#l40.261"></a><span id="l40.261" class="difflineminus">-          }));</span>
<a href="#l40.262"></a><span id="l40.262" class="difflineminus">-      }</span>
<a href="#l40.263"></a><span id="l40.263" class="difflineminus">-</span>
<a href="#l40.264"></a><span id="l40.264" class="difflineminus">-      Promise.all(promises)</span>
<a href="#l40.265"></a><span id="l40.265" class="difflineminus">-        .then(() =&gt; proc.wait())</span>
<a href="#l40.266"></a><span id="l40.266" class="difflineminus">-        .then(result =&gt; {</span>
<a href="#l40.267"></a><span id="l40.267" class="difflineminus">-          DEBUG_LOG(&quot;Complete: &quot; + result.exitCode + &quot;\n&quot;);</span>
<a href="#l40.268"></a><span id="l40.268" class="difflineminus">-          removeProcRef(proc);</span>
<a href="#l40.269"></a><span id="l40.269" class="difflineminus">-          if (gRunningProcesses.indexOf(proc) &gt;= 0) {</span>
<a href="#l40.270"></a><span id="l40.270" class="difflineminus">-</span>
<a href="#l40.271"></a><span id="l40.271" class="difflineminus">-          }</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineminus">-          if (result.exitCode === null) result.exitCode = -1;</span>
<a href="#l40.273"></a><span id="l40.273" class="difflineminus">-          resolved = result.exitCode;</span>
<a href="#l40.274"></a><span id="l40.274" class="difflineminus">-          if (typeof options.done === &quot;function&quot;) {</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineminus">-            try {</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineminus">-              options.done({</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineminus">-                exitCode: result.exitCode,</span>
<a href="#l40.278"></a><span id="l40.278" class="difflineminus">-                stdout: stdoutData,</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineminus">-                stderr: stderrData</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineminus">-              });</span>
<a href="#l40.281"></a><span id="l40.281" class="difflineminus">-            } catch (ex) {}</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineminus">-          }</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineminus">-        })</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineminus">-        .catch(error =&gt; {</span>
<a href="#l40.285"></a><span id="l40.285" class="difflineminus">-          resolved = -1;</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineminus">-          let errStr = &quot;&quot;;</span>
<a href="#l40.287"></a><span id="l40.287" class="difflineminus">-          if (typeof error === &quot;string&quot;) {</span>
<a href="#l40.288"></a><span id="l40.288" class="difflineminus">-            errStr = error;</span>
<a href="#l40.289"></a><span id="l40.289" class="difflineminus">-          } else if (error) {</span>
<a href="#l40.290"></a><span id="l40.290" class="difflineminus">-            for (let i in error) {</span>
<a href="#l40.291"></a><span id="l40.291" class="difflineminus">-              errStr += &quot;\n&quot; + i + &quot;: &quot; + error[i];</span>
<a href="#l40.292"></a><span id="l40.292" class="difflineminus">-            }</span>
<a href="#l40.293"></a><span id="l40.293" class="difflineminus">-          }</span>
<a href="#l40.294"></a><span id="l40.294" class="difflineminus">-</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineminus">-          ERROR_LOG(errStr);</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineminus">-          throw (&quot;subprocess.jsm: caught error: &quot; + errStr);</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineminus">-        });</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineminus">-</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineminus">-    }</span>
<a href="#l40.300"></a><span id="l40.300" class="difflineminus">-</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineminus">-    let opts = {};</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineminus">-    if (options.mergeStderr) {</span>
<a href="#l40.303"></a><span id="l40.303" class="difflineminus">-      opts.stderr = &quot;stdout&quot;;</span>
<a href="#l40.304"></a><span id="l40.304" class="difflineminus">-    } else {</span>
<a href="#l40.305"></a><span id="l40.305" class="difflineminus">-      opts.stderr = &quot;pipe&quot;;</span>
<a href="#l40.306"></a><span id="l40.306" class="difflineminus">-    }</span>
<a href="#l40.307"></a><span id="l40.307" class="difflineminus">-</span>
<a href="#l40.308"></a><span id="l40.308" class="difflineminus">-    if (options.command instanceof Ci.nsIFile) {</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineminus">-      opts.command = options.command.path;</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineminus">-    } else {</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineminus">-      opts.command = options.command;</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineminus">-    }</span>
<a href="#l40.313"></a><span id="l40.313" class="difflineminus">-</span>
<a href="#l40.314"></a><span id="l40.314" class="difflineminus">-    if (options.workdir) {</span>
<a href="#l40.315"></a><span id="l40.315" class="difflineminus">-      opts.workdir = options.workdir;</span>
<a href="#l40.316"></a><span id="l40.316" class="difflineminus">-    }</span>
<a href="#l40.317"></a><span id="l40.317" class="difflineminus">-</span>
<a href="#l40.318"></a><span id="l40.318" class="difflineminus">-    opts.arguments = options.arguments || [];</span>
<a href="#l40.319"></a><span id="l40.319" class="difflineminus">-</span>
<a href="#l40.320"></a><span id="l40.320" class="difflineminus">-</span>
<a href="#l40.321"></a><span id="l40.321" class="difflineminus">-    // Set up environment</span>
<a href="#l40.322"></a><span id="l40.322" class="difflineminus">-</span>
<a href="#l40.323"></a><span id="l40.323" class="difflineminus">-    let envVars = options.environment || DEFAULT_ENVIRONMENT;</span>
<a href="#l40.324"></a><span id="l40.324" class="difflineminus">-    if (envVars.length) {</span>
<a href="#l40.325"></a><span id="l40.325" class="difflineminus">-      let environment = {};</span>
<a href="#l40.326"></a><span id="l40.326" class="difflineminus">-      for (let val of envVars) {</span>
<a href="#l40.327"></a><span id="l40.327" class="difflineminus">-        let idx = val.indexOf(&quot;=&quot;);</span>
<a href="#l40.328"></a><span id="l40.328" class="difflineminus">-        if (idx &gt;= 0)</span>
<a href="#l40.329"></a><span id="l40.329" class="difflineminus">-          environment[val.slice(0, idx)] = val.slice(idx + 1);</span>
<a href="#l40.330"></a><span id="l40.330" class="difflineminus">-      }</span>
<a href="#l40.331"></a><span id="l40.331" class="difflineminus">-</span>
<a href="#l40.332"></a><span id="l40.332" class="difflineminus">-      opts.environment = environment;</span>
<a href="#l40.333"></a><span id="l40.333" class="difflineminus">-    }</span>
<a href="#l40.334"></a><span id="l40.334" class="difflineminus">-</span>
<a href="#l40.335"></a><span id="l40.335" class="difflineminus">-    let subproc = SubprocessMain.call(opts).then(subProcessThen).catch(</span>
<a href="#l40.336"></a><span id="l40.336" class="difflineminus">-      error =&gt; {</span>
<a href="#l40.337"></a><span id="l40.337" class="difflineminus">-        resolved = -1;</span>
<a href="#l40.338"></a><span id="l40.338" class="difflineminus">-        let errStr = formattedStack;</span>
<a href="#l40.339"></a><span id="l40.339" class="difflineminus">-        throw (&quot;subprocess.jsm: launch error: &quot; + errStr + 'error: ' +</span>
<a href="#l40.340"></a><span id="l40.340" class="difflineminus">-          error + &quot;\n&quot; + JSON.stringify(error));</span>
<a href="#l40.341"></a><span id="l40.341" class="difflineminus">-      }</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineminus">-    );</span>
<a href="#l40.343"></a><span id="l40.343" class="difflineminus">-</span>
<a href="#l40.344"></a><span id="l40.344" class="difflineminus">-    return {</span>
<a href="#l40.345"></a><span id="l40.345" class="difflineminus">-      wait: function() {</span>
<a href="#l40.346"></a><span id="l40.346" class="difflineminus">-        let mainThread = Services.tm.mainThread;</span>
<a href="#l40.347"></a><span id="l40.347" class="difflineminus">-        try {</span>
<a href="#l40.348"></a><span id="l40.348" class="difflineminus">-          while (resolved === null) {</span>
<a href="#l40.349"></a><span id="l40.349" class="difflineminus">-            mainThread.processNextEvent(true);</span>
<a href="#l40.350"></a><span id="l40.350" class="difflineminus">-          }</span>
<a href="#l40.351"></a><span id="l40.351" class="difflineminus">-        } catch(ex) {</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineminus">-          console.log(ex);</span>
<a href="#l40.353"></a><span id="l40.353" class="difflineminus">-        }</span>
<a href="#l40.354"></a><span id="l40.354" class="difflineminus">-</span>
<a href="#l40.355"></a><span id="l40.355" class="difflineminus">-        return resolved;</span>
<a href="#l40.356"></a><span id="l40.356" class="difflineminus">-      },</span>
<a href="#l40.357"></a><span id="l40.357" class="difflineminus">-</span>
<a href="#l40.358"></a><span id="l40.358" class="difflineminus">-      kill: function(hard = false) {</span>
<a href="#l40.359"></a><span id="l40.359" class="difflineminus">-        subproc.then(proc =&gt; {</span>
<a href="#l40.360"></a><span id="l40.360" class="difflineminus">-          proc.kill(hard ? 0 : undefined);</span>
<a href="#l40.361"></a><span id="l40.361" class="difflineminus">-          removeProcRef();</span>
<a href="#l40.362"></a><span id="l40.362" class="difflineminus">-        });</span>
<a href="#l40.363"></a><span id="l40.363" class="difflineminus">-      }</span>
<a href="#l40.364"></a><span id="l40.364" class="difflineminus">-    };</span>
<a href="#l40.365"></a><span id="l40.365" class="difflineminus">-  },</span>
<a href="#l40.366"></a><span id="l40.366" class="difflineminus">-</span>
<a href="#l40.367"></a><span id="l40.367" class="difflineminus">-</span>
<a href="#l40.368"></a><span id="l40.368" class="difflineminus">-  /**</span>
<a href="#l40.369"></a><span id="l40.369" class="difflineminus">-   * on shutdown kill all still running child processes</span>
<a href="#l40.370"></a><span id="l40.370" class="difflineminus">-   */</span>
<a href="#l40.371"></a><span id="l40.371" class="difflineminus">-  onShutdown: function() {</span>
<a href="#l40.372"></a><span id="l40.372" class="difflineminus">-    // create a copy of the array because gRunningProcesses will</span>
<a href="#l40.373"></a><span id="l40.373" class="difflineminus">-    // get altered during kill()</span>
<a href="#l40.374"></a><span id="l40.374" class="difflineminus">-    let procs = gRunningProcesses.map(x =&gt; x);</span>
<a href="#l40.375"></a><span id="l40.375" class="difflineminus">-</span>
<a href="#l40.376"></a><span id="l40.376" class="difflineminus">-    for (let i = 0; i &lt; procs.length; i++) {</span>
<a href="#l40.377"></a><span id="l40.377" class="difflineminus">-      if (procs[i] &amp;&amp; (&quot;kill&quot; in procs[i])) {</span>
<a href="#l40.378"></a><span id="l40.378" class="difflineminus">-        procs[i].kill(true);</span>
<a href="#l40.379"></a><span id="l40.379" class="difflineminus">-      }</span>
<a href="#l40.380"></a><span id="l40.380" class="difflineminus">-    }</span>
<a href="#l40.381"></a><span id="l40.381" class="difflineminus">-  }</span>
<a href="#l40.382"></a><span id="l40.382" class="difflineminus">-};</span>
<a href="#l40.383"></a><span id="l40.383" class="difflineminus">-</span>
<a href="#l40.384"></a><span id="l40.384" class="difflineminus">-function DEBUG_LOG(str) {</span>
<a href="#l40.385"></a><span id="l40.385" class="difflineminus">-  if (gDebugFunction) {</span>
<a href="#l40.386"></a><span id="l40.386" class="difflineminus">-    gDebugFunction(&quot;subprocess.jsm: &quot; + str + &quot;\n&quot;);</span>
<a href="#l40.387"></a><span id="l40.387" class="difflineminus">-  }</span>
<a href="#l40.388"></a><span id="l40.388" class="difflineminus">-}</span>
<a href="#l40.389"></a><span id="l40.389" class="difflineminus">-</span>
<a href="#l40.390"></a><span id="l40.390" class="difflineminus">-function ERROR_LOG(str) {</span>
<a href="#l40.391"></a><span id="l40.391" class="difflineminus">-  if (gErrorFunction) {</span>
<a href="#l40.392"></a><span id="l40.392" class="difflineminus">-    gErrorFunction(&quot;subprocess.jsm: &quot; + str + &quot;\n&quot;);</span>
<a href="#l40.393"></a><span id="l40.393" class="difflineminus">-  }</span>
<a href="#l40.394"></a><span id="l40.394" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">deleted file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/system.jsm</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ /dev/null</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -1,288 +0,0 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineminus">-</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineminus">-</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailSystem&quot;];</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-const ctypes = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;).ctypes;</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-const subprocess = ChromeUtils.import(&quot;chrome://openpgp/content/modules/subprocess.jsm&quot;).subprocess;</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-var gKernel32Dll = null;</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-var gSystemCharset = null;</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-const CODEPAGE_MAPPING = {</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-  &quot;437&quot;: &quot;ISO-8859-1&quot;,</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-  &quot;855&quot;: &quot;IBM855&quot;,</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-  &quot;866&quot;: &quot;IBM866&quot;,</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-  &quot;874&quot;: &quot;ISO-8859-11&quot;,</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-  &quot;932&quot;: &quot;Shift_JIS&quot;,</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-  &quot;936&quot;: &quot;GB2312&quot;,</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-  &quot;950&quot;: &quot;BIG5&quot;,</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-  &quot;1200&quot;: &quot;UTF-16LE&quot;,</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-  &quot;1201&quot;: &quot;UTF-16BE&quot;,</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-  &quot;1250&quot;: &quot;windows-1250&quot;,</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-  &quot;1251&quot;: &quot;windows-1251&quot;,</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-  &quot;1252&quot;: &quot;windows-1252&quot;,</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-  &quot;1253&quot;: &quot;windows-1253&quot;,</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineminus">-  &quot;1254&quot;: &quot;windows-1254&quot;,</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-  &quot;1255&quot;: &quot;windows-1255&quot;,</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-  &quot;1256&quot;: &quot;windows-1256&quot;,</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-  &quot;1257&quot;: &quot;windows-1257&quot;,</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-  &quot;1258&quot;: &quot;windows-1258&quot;,</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-  &quot;20866&quot;: &quot;KOI8-R&quot;,</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-  &quot;20932&quot;: &quot;EUC-JP&quot;,</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-  &quot;28591&quot;: &quot;ISO-8859-1&quot;,</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineminus">-  &quot;28592&quot;: &quot;ISO-8859-2&quot;,</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineminus">-  &quot;28593&quot;: &quot;ISO-8859-3&quot;,</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-  &quot;28594&quot;: &quot;ISO-8859-4&quot;,</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineminus">-  &quot;28595&quot;: &quot;ISO-8859-5&quot;,</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineminus">-  &quot;28596&quot;: &quot;ISO-8859-6&quot;,</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineminus">-  &quot;28597&quot;: &quot;ISO-8859-7&quot;,</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineminus">-  &quot;28598&quot;: &quot;ISO-8859-8&quot;,</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineminus">-  &quot;28599&quot;: &quot;ISO-8859-9&quot;,</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineminus">-  &quot;28603&quot;: &quot;ISO-8859-13&quot;,</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineminus">-  &quot;28605&quot;: &quot;ISO-8859-15&quot;,</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineminus">-  &quot;38598&quot;: &quot;ISO-8859-8&quot;,</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-  &quot;50220&quot;: &quot;ISO-2022-JP&quot;,</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-  &quot;50221&quot;: &quot;ISO-2022-JP&quot;,</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineminus">-  &quot;50222&quot;: &quot;ISO-2022-JP&quot;,</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineminus">-  &quot;50225&quot;: &quot;ISO-2022-KR&quot;,</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineminus">-  &quot;50227&quot;: &quot;ISO-2022-CN&quot;,</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineminus">-  &quot;50229&quot;: &quot;ISO-2022-CN&quot;,</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineminus">-  &quot;51932&quot;: &quot;EUC-JP&quot;,</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineminus">-  &quot;51949&quot;: &quot;EUC-KR&quot;,</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineminus">-  &quot;52936&quot;: &quot;HZ-GB2312&quot;,</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineminus">-  &quot;65000&quot;: &quot;UTF-7&quot;,</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-  &quot;65001&quot;: &quot;UTF-8&quot;</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-};</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineminus">-/**</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">- * Get the default codepage that is set on Windows (which equals to the chatset of the console output of gpg)</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineminus">- */</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineminus">-function getWindowsCopdepage() {</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineminus">-  EnigmailLog.DEBUG(&quot;system.jsm: getWindowsCopdepage\n&quot;);</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-  if (EnigmailPrefs.getPref(&quot;gpgLocaleEn&quot;)) {</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-    return &quot;437&quot;;</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineminus">-  }</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineminus">-</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineminus">-  let output = &quot;&quot;;</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineminus">-  let env = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(Ci.nsIEnvironment);</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineminus">-  let sysRoot = env.get(&quot;SystemRoot&quot;);</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineminus">-</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineminus">-  if (!sysRoot || sysRoot.length === 0) {</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineminus">-    sysRoot = &quot;C:\\windows&quot;;</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-  }</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineminus">-</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-  try {</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineminus">-    let p = subprocess.call({</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineminus">-      command: sysRoot + &quot;\\system32\\chcp.com&quot;,</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineminus">-      arguments: [],</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineminus">-      environment: [],</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineminus">-      charset: null,</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineminus">-      mergeStderr: false,</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-        output += data;</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineminus">-      }</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineminus">-    });</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineminus">-    p.wait();</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-    output = output.replace(/[\r\n]/g, &quot;&quot;);</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineminus">-    output = output.replace(/^(.*[: ])([0-9]+)([^0-9].*)?$/, &quot;$2&quot;);</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineminus">-  }</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineminus">-  catch (ex) {</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineminus">-    output = &quot;437&quot;;</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineminus">-  }</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineminus">-</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-  return output;</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineminus">-}</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineminus">-</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineminus">-/**</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">- * Get the charset defined with LC_ALL or locale. That's the charset used by gpg console output</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineminus">- */</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-function getUnixCharset() {</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineminus">-  EnigmailLog.DEBUG(&quot;system.jsm: getUnixCharset\n&quot;);</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineminus">-  let env = Cc[&quot;@mozilla.org/process/environment;1&quot;].getService(Ci.nsIEnvironment);</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineminus">-  let lc = env.get(&quot;LC_ALL&quot;);</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineminus">-</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineminus">-</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineminus">-  if (lc.length === 0) {</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineminus">-    let places = [</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineminus">-      &quot;/usr/bin/locale&quot;,</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineminus">-      &quot;/usr/local/bin/locale&quot;,</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineminus">-      &quot;/opt/bin/locale&quot;</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineminus">-    ];</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineminus">-    var localeFile = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineminus">-</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineminus">-    for (let i = 0; i &lt; places.length; i++) {</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineminus">-      localeFile.initWithPath(places[i]);</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineminus">-      if (localeFile.exists()) break;</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineminus">-    }</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineminus">-</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineminus">-    if (!localeFile.exists()) return &quot;utf-8&quot;;</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineminus">-</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineminus">-    let output = &quot;&quot;;</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineminus">-</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineminus">-    let p = subprocess.call({</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineminus">-      command: localeFile,</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineminus">-      arguments: [],</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineminus">-      environment: [],</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineminus">-      charset: null,</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineminus">-      mergeStderr: false,</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineminus">-      stdout: function(data) {</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineminus">-        output += data;</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineminus">-      }</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineminus">-    });</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineminus">-    p.wait();</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineminus">-</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineminus">-    let m = output.match(/^(LC_ALL=)(.*)$/m);</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineminus">-    if (m &amp;&amp; m.length &gt; 2) {</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineminus">-      lc = m[2].replace(/&quot;/g, &quot;&quot;);</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineminus">-    }</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineminus">-    else return &quot;utf-8&quot;;</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineminus">-  }</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineminus">-</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineminus">-  let i = lc.search(/[.@]/);</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineminus">-</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineminus">-  if (i &lt; 0) return &quot;utf-8&quot;;</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineminus">-</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineminus">-  lc = lc.substr(i + 1);</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineminus">-</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineminus">-  return lc;</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineminus">-</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineminus">-}</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineminus">-</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineminus">-function getKernel32Dll() {</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineminus">-  if (!gKernel32Dll) {</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineminus">-    if (EnigmailOS.isWin32) {</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineminus">-      gKernel32Dll = ctypes.open(&quot;kernel32.dll&quot;);</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineminus">-    }</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineminus">-    else {</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineminus">-      return null;</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineminus">-    }</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineminus">-  }</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineminus">-</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineminus">-  return gKernel32Dll;</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineminus">-}</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineminus">-</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineminus">-</span>
<a href="#l41.185"></a><span id="l41.185" class="difflineminus">-var EnigmailSystem = {</span>
<a href="#l41.186"></a><span id="l41.186" class="difflineminus">-</span>
<a href="#l41.187"></a><span id="l41.187" class="difflineminus">-  determineSystemCharset: function() {</span>
<a href="#l41.188"></a><span id="l41.188" class="difflineminus">-    EnigmailLog.DEBUG(&quot;system.jsm: determineSystemCharset\n&quot;);</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineminus">-</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineminus">-    if (!gSystemCharset) {</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineminus">-      if (EnigmailOS.isWin32) {</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineminus">-        gSystemCharset = getWindowsCopdepage();</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineminus">-      }</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineminus">-      else {</span>
<a href="#l41.195"></a><span id="l41.195" class="difflineminus">-        gSystemCharset = getUnixCharset();</span>
<a href="#l41.196"></a><span id="l41.196" class="difflineminus">-      }</span>
<a href="#l41.197"></a><span id="l41.197" class="difflineminus">-    }</span>
<a href="#l41.198"></a><span id="l41.198" class="difflineminus">-</span>
<a href="#l41.199"></a><span id="l41.199" class="difflineminus">-    EnigmailLog.DEBUG(&quot;system.jsm: determineSystemCharset: charset='&quot; + gSystemCharset + &quot;'\n&quot;);</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineminus">-    return gSystemCharset;</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineminus">-  },</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineminus">-</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineminus">-  /**</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineminus">-   * Convert system output coming in a native charset into Unicode (Gecko-platfrom)</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineminus">-   * applying an appropriate charset conversion</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineminus">-   *</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineminus">-   * @param str   String - input string in native charset</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineminus">-   * @param cs    String - [Optional] character set (Unix), or codepage (Windows).</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineminus">-   *                       If not specified, determine the system default.</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineminus">-   *</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineminus">-   * @param String - output in Unicode format. If something failed, the unmodified</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineminus">-   *                 input isreturned.</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineminus">-   */</span>
<a href="#l41.214"></a><span id="l41.214" class="difflineminus">-</span>
<a href="#l41.215"></a><span id="l41.215" class="difflineminus">-  convertNativeToUnicode: function(str, cs) {</span>
<a href="#l41.216"></a><span id="l41.216" class="difflineminus">-    try {</span>
<a href="#l41.217"></a><span id="l41.217" class="difflineminus">-      if (!cs) cs = this.determineSystemCharset();</span>
<a href="#l41.218"></a><span id="l41.218" class="difflineminus">-</span>
<a href="#l41.219"></a><span id="l41.219" class="difflineminus">-      if (EnigmailOS.isWin32) {</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineminus">-        if (cs in CODEPAGE_MAPPING) {</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineminus">-          return EnigmailData.convertToUnicode(str, CODEPAGE_MAPPING[cs]);</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineminus">-        }</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineminus">-        else {</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineminus">-          let charSetNum = Number(cs);</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineminus">-          if (Number.isNaN(charSetNum)) {</span>
<a href="#l41.226"></a><span id="l41.226" class="difflineminus">-            return EnigmailData.convertToUnicode(str, cs);</span>
<a href="#l41.227"></a><span id="l41.227" class="difflineminus">-          }</span>
<a href="#l41.228"></a><span id="l41.228" class="difflineminus">-          else</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineminus">-            return EnigmailData.convertToUnicode(this.winConvertNativeToUnichar(str, Number(cs)), &quot;UTF-8&quot;);</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineminus">-        }</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineminus">-      }</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineminus">-      else {</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineminus">-        return EnigmailData.convertToUnicode(str, cs);</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineminus">-      }</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineminus">-    }</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineminus">-    catch (ex) {</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineminus">-      EnigmailLog.DEBUG(&quot;system.jsm: convertNativeToUnicode: exception +&quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l41.238"></a><span id="l41.238" class="difflineminus">-</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineminus">-      return str;</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineminus">-    }</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineminus">-  },</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineminus">-</span>
<a href="#l41.243"></a><span id="l41.243" class="difflineminus">-  /**</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineminus">-   * Convert from native Windows output (often Codepage 437) to a Mozilla Unichar string</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineminus">-   *</span>
<a href="#l41.246"></a><span id="l41.246" class="difflineminus">-   * @param byteStr: String - the data to convert in the current Windows codepage</span>
<a href="#l41.247"></a><span id="l41.247" class="difflineminus">-   *</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineminus">-   * @return String: the Unicode string directly display-able</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineminus">-   */</span>
<a href="#l41.250"></a><span id="l41.250" class="difflineminus">-  winConvertNativeToUnichar: function(byteStr, codePage) {</span>
<a href="#l41.251"></a><span id="l41.251" class="difflineminus">-    /*</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineminus">-    int MultiByteToWideChar(</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineminus">-    _In_      UINT   CodePage,</span>
<a href="#l41.254"></a><span id="l41.254" class="difflineminus">-    _In_      DWORD  dwFlags,</span>
<a href="#l41.255"></a><span id="l41.255" class="difflineminus">-    _In_      LPCSTR lpMultiByteStr,</span>
<a href="#l41.256"></a><span id="l41.256" class="difflineminus">-    _In_      int    cbMultiByte,</span>
<a href="#l41.257"></a><span id="l41.257" class="difflineminus">-    _Out_opt_ LPWSTR lpWideCharStr,</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineminus">-    _In_      int    cchWideChar</span>
<a href="#l41.259"></a><span id="l41.259" class="difflineminus">-    );</span>
<a href="#l41.260"></a><span id="l41.260" class="difflineminus">-    */</span>
<a href="#l41.261"></a><span id="l41.261" class="difflineminus">-</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineminus">-    if (!getKernel32Dll()) {</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineminus">-      return byteStr;</span>
<a href="#l41.264"></a><span id="l41.264" class="difflineminus">-    }</span>
<a href="#l41.265"></a><span id="l41.265" class="difflineminus">-</span>
<a href="#l41.266"></a><span id="l41.266" class="difflineminus">-    var multiByteToWideChar = gKernel32Dll.declare(&quot;MultiByteToWideChar&quot;,</span>
<a href="#l41.267"></a><span id="l41.267" class="difflineminus">-      ctypes.winapi_abi,</span>
<a href="#l41.268"></a><span id="l41.268" class="difflineminus">-      ctypes.int, // return value</span>
<a href="#l41.269"></a><span id="l41.269" class="difflineminus">-      ctypes.unsigned_int, // Codepage</span>
<a href="#l41.270"></a><span id="l41.270" class="difflineminus">-      ctypes.uint32_t, // dwFlags</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineminus">-      ctypes.char.ptr, // input string</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineminus">-      ctypes.int, // cbMultiByte</span>
<a href="#l41.273"></a><span id="l41.273" class="difflineminus">-      ctypes.jschar.ptr, // widechar string</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineminus">-      ctypes.int // ccWideChar</span>
<a href="#l41.275"></a><span id="l41.275" class="difflineminus">-    );</span>
<a href="#l41.276"></a><span id="l41.276" class="difflineminus">-</span>
<a href="#l41.277"></a><span id="l41.277" class="difflineminus">-    let n = multiByteToWideChar(codePage, 0, byteStr, byteStr.length, null, 0);</span>
<a href="#l41.278"></a><span id="l41.278" class="difflineminus">-</span>
<a href="#l41.279"></a><span id="l41.279" class="difflineminus">-    if (n &gt; 0) {</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineminus">-      let OutStrType = ctypes.jschar.array(n + 1);</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineminus">-      let outStr = new OutStrType();</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineminus">-</span>
<a href="#l41.283"></a><span id="l41.283" class="difflineminus">-      multiByteToWideChar(codePage, 0, byteStr, byteStr.length, outStr.addressOfElement(0), n);</span>
<a href="#l41.284"></a><span id="l41.284" class="difflineminus">-</span>
<a href="#l41.285"></a><span id="l41.285" class="difflineminus">-      let r = new RegExp(String.fromCharCode(9516), &quot;g&quot;);</span>
<a href="#l41.286"></a><span id="l41.286" class="difflineminus">-      return outStr.readString().replace(r, &quot;&quot;);</span>
<a href="#l41.287"></a><span id="l41.287" class="difflineminus">-</span>
<a href="#l41.288"></a><span id="l41.288" class="difflineminus">-    }</span>
<a href="#l41.289"></a><span id="l41.289" class="difflineminus">-    else</span>
<a href="#l41.290"></a><span id="l41.290" class="difflineminus">-      return byteStr;</span>
<a href="#l41.291"></a><span id="l41.291" class="difflineminus">-  }</span>
<a href="#l41.292"></a><span id="l41.292" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">deleted file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/tor.jsm</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ /dev/null</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -1,280 +0,0 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineminus">-/*</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">- */</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-const EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-const EnigmailRNG = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rng.jsm&quot;).EnigmailRNG;</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineminus">-const EnigmailVersioning = ChromeUtils.import(&quot;chrome://openpgp/content/modules/versioning.jsm&quot;).EnigmailVersioning;</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineminus">-const EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-const EnigmailSocks5Proxy = ChromeUtils.import(&quot;chrome://openpgp/content/modules/socks5Proxy.jsm&quot;).EnigmailSocks5Proxy;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-const EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-const EXPORTED_SYMBOLS = [&quot;EnigmailTor&quot;];</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">-// Minimum for using socks5h:// prefix</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">-const MINIMUM_CURL_SOCKS5H_VERSION = &quot;7.21.7&quot;;</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">-</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-// Minimum for using socks5 proxies with curl</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineminus">-const MINIMUM_CURL_SOCKS5_PROXY_VERSION = &quot;7.18.0&quot;;</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-const TORSOCKS_VERSION_2 = &quot;2.0.0&quot;;</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-const TOR_SERVICE_PORT_PREF = &quot;torServicePort&quot;;</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-const TOR_BROWSER_BUNDLE_PORT_PREF = &quot;torBrowserBundlePort&quot;;</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-const NEW_CURL_PROTOCOL = &quot;socks5h://&quot;;</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-const OLD_CURL_PROTOCOL = &quot;socks5-hostname://&quot;;</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineminus">-const TOR_USER_PREFERENCES = {</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  DOWNLOAD: {</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-    requires: &quot;downloadKeyRequireTor&quot;,</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineminus">-    uses: &quot;downloadKeyWithTor&quot;,</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineminus">-    constant: EnigmailConstants.DOWNLOAD_KEY</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineminus">-  },</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineminus">-  SEARCH: {</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineminus">-    requires: &quot;searchKeyRequireTor&quot;,</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineminus">-    uses: &quot;searchKeyWithTor&quot;,</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-    constant: EnigmailConstants.SEARCH_KEY</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-  },</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-  UPLOAD: {</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-    requires: &quot;uploadKeyRequireTor&quot;,</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-    uses: &quot;uploadKeyWithTor&quot;,</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-    constant: EnigmailConstants.UPLOAD_KEY</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-  },</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-  REFRESH: {</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-    requires: &quot;refreshAllKeysRequireTor&quot;,</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineminus">-    uses: &quot;refreshAllKeysWithTor&quot;,</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-    constant: EnigmailConstants.REFRESH_KEY</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-  }</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-};</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-function getAction(actionFlags) {</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-  for (let key in TOR_USER_PREFERENCES) {</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-    if (TOR_USER_PREFERENCES[key].constant &amp; actionFlags) {</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-      return TOR_USER_PREFERENCES[key];</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-    }</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-  }</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-  return null;</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">-}</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineminus">-</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineminus">-/**</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">- * Sets user preference about requiring requests only to be made over Tor</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">- *</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">- * @param actionFlags - long: A Keyserver action flag</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">- *</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">- * @return true if user has requested gpg requests to be attempted over Tor, false otherwise</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">- */</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-function isPreferred(actionFlags) {</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-  const action = getAction(actionFlags);</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineminus">-  return EnigmailPrefs.getPref(action.requires) || EnigmailPrefs.getPref(action.uses);</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-}</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-/**</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">- * Sets user preference about requiring requests only to be made over Tor</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">- *</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">- * @param actionFlags - long: A Keyserver action flag</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">- *</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineminus">- * @return true if user has requested gpg requests ONLY to be attempted over Tor, false otherwise</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineminus">- */</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineminus">-function isRequired(actionFlags) {</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineminus">-  return EnigmailPrefs.getPref(getAction(actionFlags).requires);</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineminus">-}</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineminus">-</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-function combineIntoProxyhostURI(protocol, tor) {</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: combineIntoProxyhostURI()\n&quot;);</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineminus">-  return protocol + createRandomCredential() + &quot;:&quot; + createRandomCredential() + &quot;@&quot; + tor.ip + &quot;:&quot; + tor.port;</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineminus">-}</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineminus">-</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineminus">-function gpgProxyArgs(tor, versioning) {</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: gpgProxyArgs()\n&quot;);</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-  if (EnigmailOS.isDosLike || !versioning.versionFoundMeetsMinimumVersionRequired(&quot;curl&quot;, MINIMUM_CURL_SOCKS5H_VERSION)) {</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-    return combineIntoProxyhostURI(OLD_CURL_PROTOCOL, tor);</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineminus">-  }</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineminus">-  else {</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineminus">-    return combineIntoProxyhostURI(NEW_CURL_PROTOCOL, tor);</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineminus">-  }</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineminus">-}</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineminus">-</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineminus">-function createHelperArgs(helper, addAuth) {</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: createHelperArgs()\n&quot;);</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineminus">-  let args = [];</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-  if (addAuth) {</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-    args = [&quot;--user&quot;, createRandomCredential(), &quot;--pass&quot;, createRandomCredential()];</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-  }</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-  args.push(EnigmailGpg.agentPath);</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineminus">-  return args;</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineminus">-}</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineminus">-</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineminus">-function buildEnvVars() {</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineminus">-  return [</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineminus">-    &quot;TORSOCKS_USERNAME=&quot; + createRandomCredential(),</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineminus">-    &quot;TORSOCKS_PASSWORD=&quot; + createRandomCredential()</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineminus">-  ];</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineminus">-}</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineminus">-</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineminus">-function createRandomCredential() {</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineminus">-  return EnigmailRNG.generateRandomUint32().toString();</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineminus">-}</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineminus">-</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineminus">-function torOn(portPref) {</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: torOn()\n&quot;);</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-  if (EnigmailSocks5Proxy.checkTorExists(portPref)) {</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineminus">-    const port = EnigmailPrefs.getPref(portPref);</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineminus">-</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineminus">-    EnigmailLog.CONSOLE(&quot;Tor found on IP: &quot; + EnigmailSocks5Proxy.torIpAddr() + &quot;, port: &quot; + port + &quot;\n\n&quot;);</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineminus">-</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineminus">-    return {</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineminus">-      ip: EnigmailSocks5Proxy.torIpAddr(),</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineminus">-      port: port</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineminus">-    };</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineminus">-  }</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineminus">-  return null;</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-}</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineminus">-function meetsOSConstraints() {</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-  if (EnigmailOS.isDosLike) {</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineminus">-    return EnigmailGpg.getGpgFeature(&quot;socks-on-windows&quot;);</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineminus">-  }</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineminus">-  else {</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineminus">-    return EnigmailVersioning.versionFoundMeetsMinimumVersionRequired(&quot;curl&quot;, MINIMUM_CURL_SOCKS5_PROXY_VERSION);</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineminus">-  }</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineminus">-}</span>
<a href="#l42.155"></a><span id="l42.155" class="difflineminus">-</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineminus">-function useAuthOverArgs(helper, versioning) {</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineminus">-  if (helper === &quot;torsocks2&quot;) {</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineminus">-    return versioning.versionFoundMeetsMinimumVersionRequired(&quot;torsocks2&quot;, TORSOCKS_VERSION_2);</span>
<a href="#l42.159"></a><span id="l42.159" class="difflineminus">-  }</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineminus">-  return versioning.versionFoundMeetsMinimumVersionRequired(&quot;torsocks&quot;, TORSOCKS_VERSION_2);</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineminus">-}</span>
<a href="#l42.162"></a><span id="l42.162" class="difflineminus">-</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineminus">-function usesDirmngr() {</span>
<a href="#l42.164"></a><span id="l42.164" class="difflineminus">-  return EnigmailGpg.getGpgFeature(&quot;supports-dirmngr&quot;);</span>
<a href="#l42.165"></a><span id="l42.165" class="difflineminus">-}</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineminus">-</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineminus">-function findTorExecutableHelper(versioning) {</span>
<a href="#l42.168"></a><span id="l42.168" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: findTorExecutableHelper()\n&quot;);</span>
<a href="#l42.169"></a><span id="l42.169" class="difflineminus">-  const helper = EnigmailFiles.resolvePathWithEnv(&quot;torsocks2&quot;) || EnigmailFiles.resolvePathWithEnv(&quot;torsocks&quot;);</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineminus">-  if (helper !== null) {</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineminus">-    const authOverArgs = useAuthOverArgs(helper, versioning);</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineminus">-    return {</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineminus">-      envVars: (authOverArgs ? [] : buildEnvVars()),</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineminus">-      command: helper,</span>
<a href="#l42.175"></a><span id="l42.175" class="difflineminus">-      args: createHelperArgs(helper, authOverArgs)</span>
<a href="#l42.176"></a><span id="l42.176" class="difflineminus">-    };</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineminus">-  }</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineminus">-  else {</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineminus">-    return null;</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineminus">-  }</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineminus">-}</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineminus">-</span>
<a href="#l42.183"></a><span id="l42.183" class="difflineminus">-/**</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineminus">- * Checks if Tor is running on specified ports in preferences for Tor browser bundle and Tor service</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineminus">- *</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">- * @return true if Tor is running on either port, false if Tor is not running on either</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineminus">- */</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineminus">-function findTor() {</span>
<a href="#l42.189"></a><span id="l42.189" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: findTor()\n&quot;);</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineminus">-  const torOnBrowser = torOn(TOR_BROWSER_BUNDLE_PORT_PREF);</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineminus">-  if (torOnBrowser !== null) {</span>
<a href="#l42.192"></a><span id="l42.192" class="difflineminus">-    return torOnBrowser;</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineminus">-  }</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineminus">-  return torOn(TOR_SERVICE_PORT_PREF);</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineminus">-}</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineminus">-</span>
<a href="#l42.197"></a><span id="l42.197" class="difflineminus">-const systemCaller = {</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineminus">-  findTor: findTor,</span>
<a href="#l42.199"></a><span id="l42.199" class="difflineminus">-  findTorExecutableHelper: findTorExecutableHelper</span>
<a href="#l42.200"></a><span id="l42.200" class="difflineminus">-};</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineminus">-</span>
<a href="#l42.202"></a><span id="l42.202" class="difflineminus">-function buildSocksProperties(tor) {</span>
<a href="#l42.203"></a><span id="l42.203" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: buildSocksProperties()\n&quot;);</span>
<a href="#l42.204"></a><span id="l42.204" class="difflineminus">-  return {</span>
<a href="#l42.205"></a><span id="l42.205" class="difflineminus">-    command: &quot;gpg&quot;,</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineminus">-    args: gpgProxyArgs(tor, EnigmailVersioning),</span>
<a href="#l42.207"></a><span id="l42.207" class="difflineminus">-    envVars: []</span>
<a href="#l42.208"></a><span id="l42.208" class="difflineminus">-  };</span>
<a href="#l42.209"></a><span id="l42.209" class="difflineminus">-}</span>
<a href="#l42.210"></a><span id="l42.210" class="difflineminus">-</span>
<a href="#l42.211"></a><span id="l42.211" class="difflineminus">-function torNotAvailableProperties() {</span>
<a href="#l42.212"></a><span id="l42.212" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: torNotAvailableProperties()\n&quot;);</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineminus">-  return {</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineminus">-    isAvailable: false,</span>
<a href="#l42.215"></a><span id="l42.215" class="difflineminus">-    useTorMode: false,</span>
<a href="#l42.216"></a><span id="l42.216" class="difflineminus">-    socks: null,</span>
<a href="#l42.217"></a><span id="l42.217" class="difflineminus">-    helper: null</span>
<a href="#l42.218"></a><span id="l42.218" class="difflineminus">-  };</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineminus">-}</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineminus">-</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineminus">-/**</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineminus">- * Constructs object with properites about how we will use tor for key refreshes</span>
<a href="#l42.223"></a><span id="l42.223" class="difflineminus">- *</span>
<a href="#l42.224"></a><span id="l42.224" class="difflineminus">- * @param system - object with functions to locate Tor and Tor helpers</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineminus">- *</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineminus">- * @return object with</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineminus">-      * isAvailable   - boolean, true if Tor is available, false otherwise</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineminus">-      * useTorMode    - boolean, true if dirManager is available and configured to use Tor, false otherwise</span>
<a href="#l42.229"></a><span id="l42.229" class="difflineminus">-      * socks         - object with</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineminus">-                          * command -  the name of the gpg executable</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineminus">-                          * args    -  proxy host URI</span>
<a href="#l42.232"></a><span id="l42.232" class="difflineminus">-                          * envVars -  an empty array</span>
<a href="#l42.233"></a><span id="l42.233" class="difflineminus">-</span>
<a href="#l42.234"></a><span id="l42.234" class="difflineminus">-                        null if Tor is not available</span>
<a href="#l42.235"></a><span id="l42.235" class="difflineminus">-</span>
<a href="#l42.236"></a><span id="l42.236" class="difflineminus">-      * helper        - object with</span>
<a href="#l42.237"></a><span id="l42.237" class="difflineminus">-                          * envVars    - environment variables, if we need them for the helper</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineminus">-                          * command    - the path to the helper executable</span>
<a href="#l42.239"></a><span id="l42.239" class="difflineminus">-                          * args       - flags used with the helper, if we do not use environment variables</span>
<a href="#l42.240"></a><span id="l42.240" class="difflineminus">-</span>
<a href="#l42.241"></a><span id="l42.241" class="difflineminus">-                          If no helper is found, return null</span>
<a href="#l42.242"></a><span id="l42.242" class="difflineminus">- */</span>
<a href="#l42.243"></a><span id="l42.243" class="difflineminus">-</span>
<a href="#l42.244"></a><span id="l42.244" class="difflineminus">-function torProperties(system) {</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineminus">-  EnigmailLog.DEBUG(&quot;tor.jsm: torProperties()\n&quot;);</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineminus">-</span>
<a href="#l42.247"></a><span id="l42.247" class="difflineminus">-  const tor = system.findTor();</span>
<a href="#l42.248"></a><span id="l42.248" class="difflineminus">-</span>
<a href="#l42.249"></a><span id="l42.249" class="difflineminus">-  if (!meetsOSConstraints()) {</span>
<a href="#l42.250"></a><span id="l42.250" class="difflineminus">-    EnigmailLog.DEBUG(&quot;tor.jsm: this version of curl does not support socks5 proxies \n&quot;);</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineminus">-    return torNotAvailableProperties();</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineminus">-  }</span>
<a href="#l42.253"></a><span id="l42.253" class="difflineminus">-</span>
<a href="#l42.254"></a><span id="l42.254" class="difflineminus">-  if (tor === null) {</span>
<a href="#l42.255"></a><span id="l42.255" class="difflineminus">-    return torNotAvailableProperties();</span>
<a href="#l42.256"></a><span id="l42.256" class="difflineminus">-  }</span>
<a href="#l42.257"></a><span id="l42.257" class="difflineminus">-</span>
<a href="#l42.258"></a><span id="l42.258" class="difflineminus">-  const helper = system.findTorExecutableHelper(EnigmailVersioning);</span>
<a href="#l42.259"></a><span id="l42.259" class="difflineminus">-  let socks = null;</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineminus">-  let useTorMode = false;</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineminus">-</span>
<a href="#l42.262"></a><span id="l42.262" class="difflineminus">-  if (usesDirmngr()) {</span>
<a href="#l42.263"></a><span id="l42.263" class="difflineminus">-    useTorMode = EnigmailGpg.dirmngrConfiguredWithTor();</span>
<a href="#l42.264"></a><span id="l42.264" class="difflineminus">-  }</span>
<a href="#l42.265"></a><span id="l42.265" class="difflineminus">-  else {</span>
<a href="#l42.266"></a><span id="l42.266" class="difflineminus">-    socks = buildSocksProperties(tor);</span>
<a href="#l42.267"></a><span id="l42.267" class="difflineminus">-  }</span>
<a href="#l42.268"></a><span id="l42.268" class="difflineminus">-</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineminus">-  return {</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineminus">-    isAvailable: true,</span>
<a href="#l42.271"></a><span id="l42.271" class="difflineminus">-    useTorMode: useTorMode,</span>
<a href="#l42.272"></a><span id="l42.272" class="difflineminus">-    socks: socks,</span>
<a href="#l42.273"></a><span id="l42.273" class="difflineminus">-    helper: helper</span>
<a href="#l42.274"></a><span id="l42.274" class="difflineminus">-  };</span>
<a href="#l42.275"></a><span id="l42.275" class="difflineminus">-}</span>
<a href="#l42.276"></a><span id="l42.276" class="difflineminus">-</span>
<a href="#l42.277"></a><span id="l42.277" class="difflineminus">-var EnigmailTor = {</span>
<a href="#l42.278"></a><span id="l42.278" class="difflineminus">-  torProperties: function() {</span>
<a href="#l42.279"></a><span id="l42.279" class="difflineminus">-    return torProperties(systemCaller);</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineminus">-  },</span>
<a href="#l42.281"></a><span id="l42.281" class="difflineminus">-  getTorNotAvailableProperties: torNotAvailableProperties,</span>
<a href="#l42.282"></a><span id="l42.282" class="difflineminus">-  isPreferred: isPreferred,</span>
<a href="#l42.283"></a><span id="l42.283" class="difflineminus">-  isRequired: isRequired</span>
<a href="#l42.284"></a><span id="l42.284" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/versioning.jsm</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/versioning.jsm</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -4,22 +4,17 @@</span>
<a href="#l43.4"></a><span id="l43.4">  * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l43.5"></a><span id="l43.5">  */</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> &quot;use strict&quot;;</span>
<a href="#l43.9"></a><span id="l43.9"> </span>
<a href="#l43.10"></a><span id="l43.10"> const EXPORTED_SYMBOLS = [&quot;EnigmailVersioning&quot;];</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-</span>
<a href="#l43.16"></a><span id="l43.16"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l43.18"></a><span id="l43.18"> </span>
<a href="#l43.19"></a><span id="l43.19"> let vc = null;</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21"> function getVersionComparator() {</span>
<a href="#l43.22"></a><span id="l43.22">   if (vc === null) {</span>
<a href="#l43.23"></a><span id="l43.23">     vc = Cc[&quot;@mozilla.org/xpcom/version-comparator;1&quot;].getService(Ci.nsIVersionComparator);</span>
<a href="#l43.24"></a><span id="l43.24">   }</span>
<a href="#l43.25"></a><span id="l43.25">   return vc;</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineat">@@ -42,39 +37,16 @@ function getVersion(output, executable) </span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28">     return versionResponse;</span>
<a href="#l43.29"></a><span id="l43.29">   }</span>
<a href="#l43.30"></a><span id="l43.30">   else {</span>
<a href="#l43.31"></a><span id="l43.31">     return null;</span>
<a href="#l43.32"></a><span id="l43.32">   }</span>
<a href="#l43.33"></a><span id="l43.33"> }</span>
<a href="#l43.34"></a><span id="l43.34"> </span>
<a href="#l43.35"></a><span id="l43.35" class="difflineminus">-/**</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineminus">- * Test the version number of any application (not gpg)</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineminus">- */</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineminus">-function versionFoundMeetsMinimumVersionRequired(executable, minimumVersion) {</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineminus">-  const args = [&quot;--version&quot;];</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">-  const exitCodeObj = {</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineminus">-    value: null</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineminus">-  };</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineminus">-  const output = EnigmailExecution.resolveAndSimpleExec(executable, args, exitCodeObj, {});</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineminus">-  if (!output || exitCodeObj.value &lt; 0) {</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineminus">-    EnigmailLog.DEBUG(&quot;executable not found: &quot; + executable + &quot;\n&quot;);</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineminus">-    return false;</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineminus">-  }</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineminus">-</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineminus">-  const version = getVersion(output, executable);</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-  if (!version) {</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineminus">-    EnigmailLog.DEBUG(&quot;couldn't find a version in the output from &quot; + executable + &quot; - total output: &quot; + output + &quot;\n&quot;);</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-    return false;</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineminus">-  }</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-  return greaterThanOrEqual(version, minimumVersion);</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-}</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineminus">-</span>
<a href="#l43.58"></a><span id="l43.58"> function greaterThanOrEqual(versionWeHave, versionWeAreComparingWith) {</span>
<a href="#l43.59"></a><span id="l43.59">   return getVersionComparator().compare(versionWeHave, versionWeAreComparingWith) &gt;= 0;</span>
<a href="#l43.60"></a><span id="l43.60"> }</span>
<a href="#l43.61"></a><span id="l43.61"> </span>
<a href="#l43.62"></a><span id="l43.62"> function greaterThan(versionWeHave, versionWeAreComparingWith) {</span>
<a href="#l43.63"></a><span id="l43.63">   return getVersionComparator().compare(versionWeHave, versionWeAreComparingWith) &gt; 0;</span>
<a href="#l43.64"></a><span id="l43.64"> }</span>
<a href="#l43.65"></a><span id="l43.65"> </span>
<a href="#l43.66"></a><span id="l43.66" class="difflineat">@@ -108,21 +80,9 @@ var EnigmailVersioning = {</span>
<a href="#l43.67"></a><span id="l43.67">    * we have is less than the version we are comparing with</span>
<a href="#l43.68"></a><span id="l43.68">    *</span>
<a href="#l43.69"></a><span id="l43.69">    * @param     String  versionWeHave               - version we have</span>
<a href="#l43.70"></a><span id="l43.70">    * @param     String  versionWeAreComparingWith   - version we want to compare with</span>
<a href="#l43.71"></a><span id="l43.71">    *</span>
<a href="#l43.72"></a><span id="l43.72">    * @return    Boolean     - The result of versionWeHave &lt; versionWeAreComparingWith</span>
<a href="#l43.73"></a><span id="l43.73">    */</span>
<a href="#l43.74"></a><span id="l43.74">   lessThan: lessThan,</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineminus">-  /**</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineminus">-   * Uses Mozilla's Version Comparator Component to identify whether an executable version</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineminus">-   * meets the required version specified</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineminus">-   *</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineminus">-   * @param     String  executable               - version of the executable</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineminus">-   * @param     String  minimumVersion           - version we want to compare with</span>
<a href="#l43.81"></a><span id="l43.81" class="difflineminus">-   *</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineminus">-   * @return    Boolean     - True if the executable version meets the minimum version required,</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineminus">-   *                          false if it does not or it does not exist, or if a version was not</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineminus">-   *                          parseable from its output</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineminus">-   */</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineminus">-  versionFoundMeetsMinimumVersionRequired: versionFoundMeetsMinimumVersionRequired</span>
<a href="#l43.87"></a><span id="l43.87"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/webKey.jsm</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/webKey.jsm</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -10,26 +10,20 @@</span>
<a href="#l44.4"></a><span id="l44.4">  * This module serves to integrate WKS (Webkey service) into Enigmail</span>
<a href="#l44.5"></a><span id="l44.5">  */</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7"> &quot;use strict&quot;;</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9"> var EXPORTED_SYMBOLS = [&quot;EnigmailWks&quot;];</span>
<a href="#l44.10"></a><span id="l44.10"> </span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-</span>
<a href="#l44.15"></a><span id="l44.15"> const EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l44.16"></a><span id="l44.16"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l44.17"></a><span id="l44.17"> const EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">-const EnigmailExecution = ChromeUtils.import(&quot;chrome://openpgp/content/modules/execution.jsm&quot;).EnigmailExecution;</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-const EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l44.20"></a><span id="l44.20"> const EnigmailStdlib = ChromeUtils.import(&quot;chrome://openpgp/content/modules/stdlib.jsm&quot;).EnigmailStdlib;</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-const EnigmailSend = ChromeUtils.import(&quot;chrome://openpgp/content/modules/send.jsm&quot;).EnigmailSend;</span>
<a href="#l44.22"></a><span id="l44.22"> const EnigmailMimeEncrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mimeEncrypt.jsm&quot;).EnigmailMimeEncrypt;</span>
<a href="#l44.23"></a><span id="l44.23"> const EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l44.24"></a><span id="l44.24"> const EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l44.25"></a><span id="l44.25"> const EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l44.26"></a><span id="l44.26"> </span>
<a href="#l44.27"></a><span id="l44.27"> const GPG_WKS_CLIENT = &quot;gpg-wks-client&quot;;</span>
<a href="#l44.28"></a><span id="l44.28"> </span>
<a href="#l44.29"></a><span id="l44.29"> var EnigmailWks = {</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineat">@@ -40,96 +34,31 @@ var EnigmailWks = {</span>
<a href="#l44.31"></a><span id="l44.31">    *</span>
<a href="#l44.32"></a><span id="l44.32">    * @param window  : Object - parent window for dialog display</span>
<a href="#l44.33"></a><span id="l44.33">    * @param cb      : Function(retValue) - callback function.</span>
<a href="#l44.34"></a><span id="l44.34">    *                   retValue: nsIFile Object to gpg-wks-client executable or NULL</span>
<a href="#l44.35"></a><span id="l44.35">    * @return        : Object - NULL or a process handle</span>
<a href="#l44.36"></a><span id="l44.36">    */</span>
<a href="#l44.37"></a><span id="l44.37">   getWksClientPathAsync: function(window, cb) {</span>
<a href="#l44.38"></a><span id="l44.38">     EnigmailLog.DEBUG(&quot;webKey.jsm: getWksClientPathAsync\n&quot;);</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineminus">-</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-    if (EnigmailWks.wksClientPath === null) {</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineminus">-      let listener = EnigmailExecution.newSimpleListener(null, function(ret) {</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineminus">-        if (ret === 0) {</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineminus">-          try {</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineminus">-            let stdout = listener.stdoutData;</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineminus">-</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineminus">-            let libexecdir = /^libexecdir:(.+?)$/m.exec(stdout)[1];</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineminus">-            if (libexecdir) {</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineminus">-              libexecdir = libexecdir.replace(/%3a/gi, &quot;:&quot;);</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineminus">-            }</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineminus">-            else {</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineminus">-              libexecdir = &quot;&quot;;</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-            }</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineminus">-            let wks_client = checkIfExists(libexecdir, GPG_WKS_CLIENT);</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineminus">-            if (!wks_client) {</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineminus">-              let bindir = /^bindir:(.+?)$/m.exec(stdout)[1];</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineminus">-              if (bindir) {</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineminus">-                bindir = bindir.replace(/%3a/gi, &quot;:&quot;);</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineminus">-              }</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineminus">-              else {</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineminus">-                bindir = &quot;&quot;;</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineminus">-              }</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineminus">-              wks_client = checkIfExists(bindir, GPG_WKS_CLIENT);</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineminus">-</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineminus">-              if (!wks_client) {</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineminus">-                cb(null);</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineminus">-                return;</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineminus">-              }</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineminus">-            }</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineminus">-</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineminus">-            EnigmailWks.wksClientPath = wks_client;</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineminus">-            cb(wks_client);</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineminus">-          }</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineminus">-          catch (e) {</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineminus">-            EnigmailLog.DEBUG(&quot;webKey.jsm: getWksClientPathAsync: &quot; + e.toString() + &quot;\n&quot;);</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineminus">-            cb(null);</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineminus">-          }</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineminus">-        }</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineminus">-        else {</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-          cb(null);</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineminus">-        }</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineminus">-      });</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineminus">-</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineminus">-      return EnigmailExecution.execStart(EnigmailGpgAgent.gpgconfPath, [&quot;--list-dirs&quot;], false, window, listener, {</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineminus">-        value: null</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineminus">-      });</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineminus">-    }</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineminus">-    else {</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineminus">-      cb(EnigmailWks.wksClientPath);</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-      return null;</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineminus">-    }</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l44.93"></a><span id="l44.93">   },</span>
<a href="#l44.94"></a><span id="l44.94"> </span>
<a href="#l44.95"></a><span id="l44.95">   /**</span>
<a href="#l44.96"></a><span id="l44.96">    * Determine if WKS is supported by email provider</span>
<a href="#l44.97"></a><span id="l44.97">    *</span>
<a href="#l44.98"></a><span id="l44.98">    * @param email : String - user's email address</span>
<a href="#l44.99"></a><span id="l44.99">    * @param window: Object - parent window of dialog display</span>
<a href="#l44.100"></a><span id="l44.100">    * @param cb    : Function(retValue) - callback function.</span>
<a href="#l44.101"></a><span id="l44.101">    *                   retValue: Boolean: true if WKS is supported / false otherwise</span>
<a href="#l44.102"></a><span id="l44.102">    * @return      : Object - process handle</span>
<a href="#l44.103"></a><span id="l44.103">    */</span>
<a href="#l44.104"></a><span id="l44.104">   isWksSupportedAsync: function(email, window, cb) {</span>
<a href="#l44.105"></a><span id="l44.105">     EnigmailLog.DEBUG(&quot;webKey.jsm: isWksSupportedAsync: email = &quot; + email + &quot;\n&quot;);</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineminus">-    return EnigmailWks.getWksClientPathAsync(window, function(wks_client) {</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineminus">-      if (wks_client === null) {</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineminus">-        cb(false);</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineminus">-      }</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineminus">-      let listener = EnigmailExecution.newSimpleListener(null, function(ret) {</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineminus">-        cb(ret === 0);</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineminus">-      });</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineminus">-      let proc = EnigmailExecution.execStart(wks_client, [&quot;--supported&quot;, email], false, window, listener, {</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineminus">-        value: null</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineminus">-      });</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineminus">-      if (proc === null) {</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineminus">-        cb(false);</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineminus">-      }</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineminus">-    });</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l44.121"></a><span id="l44.121">   },</span>
<a href="#l44.122"></a><span id="l44.122"> </span>
<a href="#l44.123"></a><span id="l44.123"> </span>
<a href="#l44.124"></a><span id="l44.124">   /**</span>
<a href="#l44.125"></a><span id="l44.125">    * Submit a set of keys to the Web Key Server (WKD)</span>
<a href="#l44.126"></a><span id="l44.126">    *</span>
<a href="#l44.127"></a><span id="l44.127">    * @param keys:     Array of KeyObj</span>
<a href="#l44.128"></a><span id="l44.128">    * @param win:      parent Window for displaying dialogs</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineat">@@ -174,125 +103,34 @@ var EnigmailWks = {</span>
<a href="#l44.130"></a><span id="l44.130">    * @param window: Object - parent window of dialog display</span>
<a href="#l44.131"></a><span id="l44.131">    * @param cb    : Function(retValue) - callback function.</span>
<a href="#l44.132"></a><span id="l44.132">    *                   retValue: Boolean: true if submit was successful / false otherwise</span>
<a href="#l44.133"></a><span id="l44.133">    * @return      : Object - process handle</span>
<a href="#l44.134"></a><span id="l44.134">    */</span>
<a href="#l44.135"></a><span id="l44.135"> </span>
<a href="#l44.136"></a><span id="l44.136">   submitKey: function(ident, key, window, cb) {</span>
<a href="#l44.137"></a><span id="l44.137">     EnigmailLog.DEBUG(&quot;webKey.jsm: submitKey(): email = &quot; + ident.email + &quot;\n&quot;);</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineminus">-    return EnigmailWks.getWksClientPathAsync(window, function(wks_client) {</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineminus">-      if (wks_client === null) {</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineminus">-        cb(false);</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineminus">-        return null;</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineminus">-      }</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineminus">-      let listener = EnigmailExecution.newSimpleListener(null, function(ret) {</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineminus">-        if (ret !== 0) {</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineminus">-          cb(false);</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineminus">-          return;</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineminus">-        }</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineminus">-        EnigmailLog.DEBUG(&quot;webKey.jsm: submitKey: send &quot; + listener.stdoutData + &quot;\n&quot;);</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineminus">-        let si = EnigmailMimeEncrypt.createMimeEncrypt(null);</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineminus">-        let subject = listener.stdoutData.match(/^Subject:[ \t]*(.+)$/im);</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineminus">-        let to = listener.stdoutData.match(/^To:[ \t]*(.+)$/im);</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineminus">-</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineminus">-        if (subject !== null &amp;&amp; to !== null) {</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineminus">-          si.sendFlags = EnigmailConstants.SEND_VERBATIM;</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineminus">-</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineminus">-          if (!EnigmailSend.simpleSendMessage({</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineminus">-                urls: [],</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineminus">-                identity: ident,</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineminus">-                to: to[1],</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineminus">-                subject: subject[1],</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineminus">-                composeSecure: si</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineminus">-              },</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineminus">-              listener.stdoutData,</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineminus">-              cb</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineminus">-            )) {</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineminus">-            cb(false);</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineminus">-          }</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineminus">-        }</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineminus">-        else {</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineminus">-          cb(false);</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineminus">-        }</span>
<a href="#l44.172"></a><span id="l44.172" class="difflineminus">-      });</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineminus">-      return EnigmailExecution.execStart(wks_client, [&quot;--create&quot;, key.fpr, ident.email], false, window, listener, {</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineminus">-        value: null</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineminus">-      });</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineminus">-    });</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l44.178"></a><span id="l44.178">   },</span>
<a href="#l44.179"></a><span id="l44.179"> </span>
<a href="#l44.180"></a><span id="l44.180">   /**</span>
<a href="#l44.181"></a><span id="l44.181">    * Submit a key to the email provider (= send publication request)</span>
<a href="#l44.182"></a><span id="l44.182">    *</span>
<a href="#l44.183"></a><span id="l44.183">    * @param ident : nsIMsgIdentity - user's ID</span>
<a href="#l44.184"></a><span id="l44.184">    * @param body  : String -  complete message source of the confirmation-request email obtained</span>
<a href="#l44.185"></a><span id="l44.185">    *                    from the email provider</span>
<a href="#l44.186"></a><span id="l44.186">    * @param window: Object - parent window of dialog display</span>
<a href="#l44.187"></a><span id="l44.187">    * @param cb    : Function(retValue) - callback function.</span>
<a href="#l44.188"></a><span id="l44.188">    *                   retValue: Boolean: true if submit was successful / false otherwise</span>
<a href="#l44.189"></a><span id="l44.189">    * @return      : Object - process handle</span>
<a href="#l44.190"></a><span id="l44.190">    */</span>
<a href="#l44.191"></a><span id="l44.191"> </span>
<a href="#l44.192"></a><span id="l44.192">   confirmKey: function(ident, body, window, cb) {</span>
<a href="#l44.193"></a><span id="l44.193">     EnigmailLog.DEBUG(&quot;webKey.jsm: confirmKey: ident=&quot; + ident.email + &quot;\n&quot;);</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineminus">-</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineminus">-    var sanitized = body.replace(/\r?\n/g, &quot;\r\n&quot;);</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineminus">-    return EnigmailWks.getWksClientPathAsync(window, function(wks_client) {</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineminus">-      if (wks_client === null) {</span>
<a href="#l44.198"></a><span id="l44.198" class="difflineminus">-        if (cb) {</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineminus">-          cb(false);</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineminus">-        }</span>
<a href="#l44.201"></a><span id="l44.201" class="difflineminus">-        return;</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineminus">-      }</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineminus">-      let listener = EnigmailExecution.newSimpleListener(function(pipe) {</span>
<a href="#l44.204"></a><span id="l44.204" class="difflineminus">-        try {</span>
<a href="#l44.205"></a><span id="l44.205" class="difflineminus">-          pipe.write(sanitized);</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineminus">-          pipe.close();</span>
<a href="#l44.207"></a><span id="l44.207" class="difflineminus">-        }</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineminus">-        catch (e) {</span>
<a href="#l44.209"></a><span id="l44.209" class="difflineminus">-          if (cb) {</span>
<a href="#l44.210"></a><span id="l44.210" class="difflineminus">-            cb(false);</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineminus">-          }</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineminus">-          EnigmailLog.DEBUG(e + &quot;\n&quot;);</span>
<a href="#l44.213"></a><span id="l44.213" class="difflineminus">-        }</span>
<a href="#l44.214"></a><span id="l44.214" class="difflineminus">-      }, function(ret) {</span>
<a href="#l44.215"></a><span id="l44.215" class="difflineminus">-        try {</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineminus">-          let si = EnigmailMimeEncrypt.createMimeEncrypt(null);</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineminus">-          let subject = listener.stdoutData.match(/^Subject:[ \t]*(.+)$/im);</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineminus">-          let to = listener.stdoutData.match(/^To:[ \t]*(.+)$/im);</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineminus">-</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineminus">-          if (subject !== null &amp;&amp; to !== null) {</span>
<a href="#l44.221"></a><span id="l44.221" class="difflineminus">-            si.sendFlags = EnigmailConstants.SEND_VERBATIM;</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineminus">-</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineminus">-            if (!EnigmailSend.simpleSendMessage({</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineminus">-                  urls: [],</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineminus">-                  identity: ident,</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineminus">-                  to: to[1],</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineminus">-                  subject: subject[1],</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineminus">-                  composeSecure: si</span>
<a href="#l44.229"></a><span id="l44.229" class="difflineminus">-                },</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineminus">-                listener.stdoutData,</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineminus">-                cb</span>
<a href="#l44.232"></a><span id="l44.232" class="difflineminus">-              )) {</span>
<a href="#l44.233"></a><span id="l44.233" class="difflineminus">-              cb(false);</span>
<a href="#l44.234"></a><span id="l44.234" class="difflineminus">-            }</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineminus">-          }</span>
<a href="#l44.236"></a><span id="l44.236" class="difflineminus">-        }</span>
<a href="#l44.237"></a><span id="l44.237" class="difflineminus">-        catch (e) {</span>
<a href="#l44.238"></a><span id="l44.238" class="difflineminus">-          if (cb) {</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineminus">-            cb(false);</span>
<a href="#l44.240"></a><span id="l44.240" class="difflineminus">-          }</span>
<a href="#l44.241"></a><span id="l44.241" class="difflineminus">-          EnigmailLog.DEBUG(e + &quot;\n&quot;);</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineminus">-        }</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineminus">-      });</span>
<a href="#l44.244"></a><span id="l44.244" class="difflineminus">-      EnigmailExecution.execStart(wks_client, [&quot;--receive&quot;], false, window, listener, {</span>
<a href="#l44.245"></a><span id="l44.245" class="difflineminus">-        value: null</span>
<a href="#l44.246"></a><span id="l44.246" class="difflineminus">-      });</span>
<a href="#l44.247"></a><span id="l44.247" class="difflineminus">-    });</span>
<a href="#l44.248"></a><span id="l44.248" class="difflineplus">+    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l44.249"></a><span id="l44.249">   }</span>
<a href="#l44.250"></a><span id="l44.250"> };</span>
<a href="#l44.251"></a><span id="l44.251"> </span>
<a href="#l44.252"></a><span id="l44.252"> /**</span>
<a href="#l44.253"></a><span id="l44.253">  * Check if a file exists and is executable</span>
<a href="#l44.254"></a><span id="l44.254">  *</span>
<a href="#l44.255"></a><span id="l44.255">  * @param path:         String - directory name</span>
<a href="#l44.256"></a><span id="l44.256">  * @param execFileName: String - executable name</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/wkdLookup.jsm</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/wkdLookup.jsm</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -13,17 +13,16 @@ var EXPORTED_SYMBOLS = [&quot;EnigmailWkdLook</span>
<a href="#l45.4"></a><span id="l45.4"> </span>
<a href="#l45.5"></a><span id="l45.5"> const EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l45.6"></a><span id="l45.6"> const EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l45.7"></a><span id="l45.7"> const PromiseUtils = ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;).PromiseUtils;</span>
<a href="#l45.8"></a><span id="l45.8"> const EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l45.9"></a><span id="l45.9"> const EnigmailZBase32 = ChromeUtils.import(&quot;chrome://openpgp/content/modules/zbase32.jsm&quot;).EnigmailZBase32;</span>
<a href="#l45.10"></a><span id="l45.10"> const EnigmailOpenPGP = ChromeUtils.import(&quot;chrome://openpgp/content/modules/openpgp.jsm&quot;).EnigmailOpenPGP;</span>
<a href="#l45.11"></a><span id="l45.11"> const EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-const EnigmailDns = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dns.jsm&quot;).EnigmailDns;</span>
<a href="#l45.13"></a><span id="l45.13"> const EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l45.14"></a><span id="l45.14"> const EnigmailSqliteDb = ChromeUtils.import(&quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;).EnigmailSqliteDb;</span>
<a href="#l45.15"></a><span id="l45.15"> </span>
<a href="#l45.16"></a><span id="l45.16"> Components.utils.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l45.17"></a><span id="l45.17"> </span>
<a href="#l45.18"></a><span id="l45.18"> // Those domains are not expected to have WKD:</span>
<a href="#l45.19"></a><span id="l45.19"> var BLACKLIST_DOMAINS = [</span>
<a href="#l45.20"></a><span id="l45.20">   /* Default domains included */</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineat">@@ -398,20 +397,23 @@ async function getSiteSpecificUrl(emailA</span>
<a href="#l45.22"></a><span id="l45.22">     case &quot;protonmail.ch&quot;:</span>
<a href="#l45.23"></a><span id="l45.23">     case &quot;protonmail.com&quot;:</span>
<a href="#l45.24"></a><span id="l45.24">     case &quot;pm.me&quot;:</span>
<a href="#l45.25"></a><span id="l45.25">       url = &quot;https://api.protonmail.ch/pks/lookup?op=get&amp;options=mr&amp;search=&quot; + escape(emailAddr);</span>
<a href="#l45.26"></a><span id="l45.26">       break;</span>
<a href="#l45.27"></a><span id="l45.27">   }</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29">   if (!url) {</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+    throw new Error(&quot;EnigmailWkdLookup getSiteSpecificUrl with DNS not implemented&quot;);</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+    /*</span>
<a href="#l45.32"></a><span id="l45.32">     try {</span>
<a href="#l45.33"></a><span id="l45.33">       let mxHosts = await EnigmailDns.lookup(&quot;MX&quot;, domain);</span>
<a href="#l45.34"></a><span id="l45.34">       if (mxHosts &amp; mxHosts.indexOf(&quot;mail.protonmail.ch&quot;) &gt;= 0 ||</span>
<a href="#l45.35"></a><span id="l45.35">         mxHosts.indexOf(&quot;mailsec.protonmail.ch&quot;) &gt;= 0) {</span>
<a href="#l45.36"></a><span id="l45.36">         url = &quot;https://api.protonmail.ch/pks/lookup?op=get&amp;options=mr&amp;search=&quot; + escape(emailAddr);</span>
<a href="#l45.37"></a><span id="l45.37">       }</span>
<a href="#l45.38"></a><span id="l45.38">     }</span>
<a href="#l45.39"></a><span id="l45.39">     catch (ex) {}</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+    */</span>
<a href="#l45.41"></a><span id="l45.41">   }</span>
<a href="#l45.42"></a><span id="l45.42"> </span>
<a href="#l45.43"></a><span id="l45.43">   return url;</span>
<a href="#l45.44"></a><span id="l45.44"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -30,18 +30,16 @@ dlg.button.ok=&amp;OK</span>
<a href="#l46.4"></a><span id="l46.4"> repeatPrefix=\n\nThis alert will repeat %S</span>
<a href="#l46.5"></a><span id="l46.5"> repeatSuffixSingular=more time.</span>
<a href="#l46.6"></a><span id="l46.6"> repeatSuffixPlural=more times.</span>
<a href="#l46.7"></a><span id="l46.7"> noRepeat=\n\nThis alert will not repeat until you upgrade Gine-Liam.</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> pgpNotSupported=You seem to be using Gine-Liam together with PGP 6.x\n\nUnfortunately, PGP 6.x has a number of issues that prevent Gine-Liam from working correctly. Therefore, Gine-Liam does not support PGP 6.x anymore; please switch to GnuPG (GPG) instead.\n\nIf you need help on switching to GnuPG, check the Help section of the Gine-Liam homepage.</span>
<a href="#l46.10"></a><span id="l46.10"> initErr.howToFixIt=In order to use Gine-Liam, GnuPG is required. If you did not install GnuPG yet, the easiest way to do this is using the &quot;Setup Wizard&quot; button below.</span>
<a href="#l46.11"></a><span id="l46.11"> initErr.setupWizard.button=&amp;Setup Wizard</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-passphraseCleared=The passphrase has been cleared.</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-cannotClearPassphrase=You are using a non-standard tool (such as gnome-keyring) for passphrase handling. Clearing the passphrase is therefore not possible from within Gine-Liam.</span>
<a href="#l46.14"></a><span id="l46.14"> noPhotoAvailable=No Photo available</span>
<a href="#l46.15"></a><span id="l46.15"> debugLog.title=Gine-Liam Debug Log</span>
<a href="#l46.16"></a><span id="l46.16"> error.photoPathNotReadable=Photo path '%S' is not readable</span>
<a href="#l46.17"></a><span id="l46.17"> </span>
<a href="#l46.18"></a><span id="l46.18"> generalError=Error: %S</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20"> # Strings in configure.jsm</span>
<a href="#l46.21"></a><span id="l46.21"> enigmailCommon.versionSignificantlyChanged=This new version of Gine-Liam has significant changes in the handling of preferences and options. We tried to transfer the old settings to this new version. However, we cannot cover all cases automatically. Please double check the resulting new preferences and options.</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineat">@@ -335,17 +333,16 @@ sc.removeCard=The operation requires no </span>
<a href="#l46.23"></a><span id="l46.23"> sc.noCardAvailable=No SmartCard could be found in your reader\nPlease insert your SmartCard and repeat the operation.</span>
<a href="#l46.24"></a><span id="l46.24"> sc.noReaderAvailable=Your SmartCard reader could not be accessed\nPlease attach your SmartCard reader, insert your card, and repeat the operation.</span>
<a href="#l46.25"></a><span id="l46.25"> keyError.keySpecNotFound=The email address '%S' cannot be matched to a key on your keyring.</span>
<a href="#l46.26"></a><span id="l46.26"> keyError.keyIdNotFound=The configured key ID '%S' cannot be found on your keyring.</span>
<a href="#l46.27"></a><span id="l46.27"> keyError.resolutionAction=Please select a valid key in the OpenPGP section of your Account Settings.</span>
<a href="#l46.28"></a><span id="l46.28"> missingPassphrase=Missing passphrase</span>
<a href="#l46.29"></a><span id="l46.29"> errorHandling.gpgAgentInvalid=Your system is running a version of gpg-agent that is not suitable for your GnuPG version.</span>
<a href="#l46.30"></a><span id="l46.30"> errorHandling.gpgAgentError=GnuPG reported an error in the communication with gpg-agent (a component of GnuPG).</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-errorHandling.dirmngrError=GnuPG reported an error in the communication with dirmngr (a component of GnuPG).</span>
<a href="#l46.32"></a><span id="l46.32"> errorHandling.pinentryError=GnuPG cannot query your passphrase via pinentry.</span>
<a href="#l46.33"></a><span id="l46.33"> errorHandling.pinentryCursesError=Your GnuPG installation is configured to use the console for pinentry. However, when using Gine-Liam you need a graphical version of pinentry.</span>
<a href="#l46.34"></a><span id="l46.34"> errorHandling.readFaq=This is a system setup or configuration error that prevents Gine-Liam from working properly and cannot be fixed automatically.\n\nWe strongly recommend that you consult our support web site at https://doesnotexist-openpgp-integration.thunderbird/faq.</span>
<a href="#l46.35"></a><span id="l46.35"> </span>
<a href="#l46.36"></a><span id="l46.36"> gpgNotFound=Unable to locate GnuPG program '%S'.\nMake sure you have set the GnuPG executable path correctly in the Gine-Liam Preferences.</span>
<a href="#l46.37"></a><span id="l46.37"> gpgNotInPath=Unable to locate GnuPG executable in the PATH.\nMake sure you have set the GnuPG executable path correctly in the Gine-Liam Preferences.</span>
<a href="#l46.38"></a><span id="l46.38"> enigmailNotAvailable=Gine-Liam core Service not available</span>
<a href="#l46.39"></a><span id="l46.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailCommon.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailCommon.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -18,17 +18,16 @@ var Ci = Components.interfaces;</span>
<a href="#l47.4"></a><span id="l47.4"> </span>
<a href="#l47.5"></a><span id="l47.5"> // enigmailCommon.js: shared JS functions for Enigmail</span>
<a href="#l47.6"></a><span id="l47.6"> </span>
<a href="#l47.7"></a><span id="l47.7"> // WARNING: This module functions must not be loaded in overlays to standard functionality!</span>
<a href="#l47.8"></a><span id="l47.8"> </span>
<a href="#l47.9"></a><span id="l47.9"> // Many of these components are not used in this file, but are instead used in other files that are loaded together with EnigmailCommon</span>
<a href="#l47.10"></a><span id="l47.10"> var EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l47.11"></a><span id="l47.11"> var EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-var EnigmailKeyEditor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyEditor.jsm&quot;).EnigmailKeyEditor;</span>
<a href="#l47.13"></a><span id="l47.13"> var EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l47.14"></a><span id="l47.14"> var EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l47.15"></a><span id="l47.15"> var EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l47.16"></a><span id="l47.16"> var EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l47.17"></a><span id="l47.17"> var EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l47.18"></a><span id="l47.18"> var EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l47.19"></a><span id="l47.19"> var EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l47.20"></a><span id="l47.20"> var EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineat">@@ -38,17 +37,16 @@ var EnigmailTime = ChromeUtils.import(&quot;c</span>
<a href="#l47.22"></a><span id="l47.22"> var EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l47.23"></a><span id="l47.23"> var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l47.24"></a><span id="l47.24"> var EnigmailTrust = ChromeUtils.import(&quot;chrome://openpgp/content/modules/trust.jsm&quot;).EnigmailTrust;</span>
<a href="#l47.25"></a><span id="l47.25"> var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l47.26"></a><span id="l47.26"> var EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l47.27"></a><span id="l47.27"> var EnigmailKeyServer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyserver.jsm&quot;).EnigmailKeyServer;</span>
<a href="#l47.28"></a><span id="l47.28"> var EnigmailEvents = ChromeUtils.import(&quot;chrome://openpgp/content/modules/events.jsm&quot;).EnigmailEvents;</span>
<a href="#l47.29"></a><span id="l47.29"> var EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineminus">-var EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l47.31"></a><span id="l47.31"> var EnigmailStreams = ChromeUtils.import(&quot;chrome://openpgp/content/modules/streams.jsm&quot;).EnigmailStreams;</span>
<a href="#l47.32"></a><span id="l47.32"> var EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l47.33"></a><span id="l47.33"> </span>
<a href="#l47.34"></a><span id="l47.34"> var OpenPGPMasterpass = ChromeUtils.import(&quot;chrome://openpgp/content/modules/masterpass.jsm&quot;).OpenPGPMasterpass;</span>
<a href="#l47.35"></a><span id="l47.35"> var RNP = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rnp.jsm&quot;).RNP;</span>
<a href="#l47.36"></a><span id="l47.36"> </span>
<a href="#l47.37"></a><span id="l47.37"> </span>
<a href="#l47.38"></a><span id="l47.38"> // The compatible Enigmime version</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineat">@@ -467,27 +465,24 @@ function EnigDisplayKeyDetails(keyId, re</span>
<a href="#l47.40"></a><span id="l47.40"> }</span>
<a href="#l47.41"></a><span id="l47.41"> </span>
<a href="#l47.42"></a><span id="l47.42"> function EnigSignKey(userId, keyId) {</span>
<a href="#l47.43"></a><span id="l47.43">   return EnigmailWindows.signKey(window, userId, keyId);</span>
<a href="#l47.44"></a><span id="l47.44"> }</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46"> </span>
<a href="#l47.47"></a><span id="l47.47"> function EnigChangeKeyPwd(keyId, userId) {</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineminus">-  // gpg-agent used: gpg-agent will handle everything</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineminus">-  EnigmailKeyEditor.changePassphrase(window, &quot;0x&quot; + keyId, &quot;&quot;, &quot;&quot;,</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-    function _changePwdCb(exitCode, errorMsg) {</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineminus">-      if (exitCode !== 0) {</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineminus">-        EnigAlert(EnigGetString(&quot;changePassFailed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineminus">-      }</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineminus">-    });</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l47.56"></a><span id="l47.56"> }</span>
<a href="#l47.57"></a><span id="l47.57"> </span>
<a href="#l47.58"></a><span id="l47.58"> </span>
<a href="#l47.59"></a><span id="l47.59"> function EnigRevokeKey(keyId, userId, callbackFunc) {</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+  /*</span>
<a href="#l47.63"></a><span id="l47.63">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l47.64"></a><span id="l47.64">   if (!enigmailSvc)</span>
<a href="#l47.65"></a><span id="l47.65">     return false;</span>
<a href="#l47.66"></a><span id="l47.66"> </span>
<a href="#l47.67"></a><span id="l47.67">   var userDesc = &quot;0x&quot; + keyId + &quot; - &quot; + userId;</span>
<a href="#l47.68"></a><span id="l47.68">   if (!EnigConfirm(EnigGetString(&quot;revokeKeyQuestion&quot;, userDesc), EnigGetString(&quot;keyMan.button.revokeKey&quot;)))</span>
<a href="#l47.69"></a><span id="l47.69">     return false;</span>
<a href="#l47.70"></a><span id="l47.70"> </span>
<a href="#l47.71"></a><span id="l47.71" class="difflineat">@@ -498,73 +493,49 @@ function EnigRevokeKey(keyId, userId, ca</span>
<a href="#l47.72"></a><span id="l47.72">     revFile.initWithPath(tmpDir);</span>
<a href="#l47.73"></a><span id="l47.73">     if (!(revFile.isDirectory() &amp;&amp; revFile.isWritable())) {</span>
<a href="#l47.74"></a><span id="l47.74">       EnigAlert(EnigGetString(&quot;noTempDir&quot;));</span>
<a href="#l47.75"></a><span id="l47.75">       return false;</span>
<a href="#l47.76"></a><span id="l47.76">     }</span>
<a href="#l47.77"></a><span id="l47.77">   } catch (ex) {}</span>
<a href="#l47.78"></a><span id="l47.78">   revFile.append(&quot;revkey.asc&quot;);</span>
<a href="#l47.79"></a><span id="l47.79"> </span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">-  EnigmailKeyEditor.genRevokeCert(window, &quot;0x&quot; + keyId, revFile, &quot;0&quot;, &quot;&quot;,</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">-    function _revokeCertCb(exitCode, errorMsg) {</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineminus">-      if (exitCode !== 0) {</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-        revFile.remove(false);</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineminus">-        EnigAlert(EnigGetString(&quot;revokeKeyFailed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineminus">-        return;</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineminus">-      }</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineminus">-      var errorMsgObj = {};</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineminus">-      var r = EnigmailKeyRing.importKeyFromFile(revFile, errorMsgObj);</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineminus">-      revFile.remove(false);</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineminus">-      if (r !== 0) {</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineminus">-        EnigAlert(EnigGetString(&quot;revokeKeyFailed&quot;) + &quot;\n\n&quot; + EnigConvertGpgToUnicode(errorMsgObj.value));</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineminus">-      } else {</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineminus">-        EnigAlert(EnigGetString(&quot;revokeKeyOk&quot;));</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineminus">-      }</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineminus">-      if (callbackFunc) {</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">-        callbackFunc(r === 0);</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineminus">-      }</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineminus">-    });</span>
<a href="#l47.99"></a><span id="l47.99">   return true;</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineplus">+  */</span>
<a href="#l47.101"></a><span id="l47.101"> }</span>
<a href="#l47.102"></a><span id="l47.102"> </span>
<a href="#l47.103"></a><span id="l47.103"> function EnigGetLocalFileApi() {</span>
<a href="#l47.104"></a><span id="l47.104">   return Components.interfaces.nsIFile;</span>
<a href="#l47.105"></a><span id="l47.105"> }</span>
<a href="#l47.106"></a><span id="l47.106"> </span>
<a href="#l47.107"></a><span id="l47.107"> function EnigShowPhoto(keyId, userId, photoNumber) {</span>
<a href="#l47.108"></a><span id="l47.108">   EnigmailWindows.showPhoto(window, keyId, userId, photoNumber);</span>
<a href="#l47.109"></a><span id="l47.109"> }</span>
<a href="#l47.110"></a><span id="l47.110"> </span>
<a href="#l47.111"></a><span id="l47.111"> function EnigGetFilePath(nsFileObj) {</span>
<a href="#l47.112"></a><span id="l47.112">   return EnigmailFiles.getFilePath(nsFileObj);</span>
<a href="#l47.113"></a><span id="l47.113"> }</span>
<a href="#l47.114"></a><span id="l47.114"> </span>
<a href="#l47.115"></a><span id="l47.115"> function EnigCreateRevokeCert(keyId, userId, callbackFunc) {</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineplus">+</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineplus">+  /*</span>
<a href="#l47.119"></a><span id="l47.119">   var defaultFileName = userId.replace(/[&lt;&gt;]/g, &quot;&quot;);</span>
<a href="#l47.120"></a><span id="l47.120">   defaultFileName += &quot; (0x&quot; + keyId + &quot;) rev.asc&quot;;</span>
<a href="#l47.121"></a><span id="l47.121">   var outFile = EnigFilePicker(EnigGetString(&quot;saveRevokeCertAs&quot;),</span>
<a href="#l47.122"></a><span id="l47.122">     &quot;&quot;, true, &quot;*.asc&quot;,</span>
<a href="#l47.123"></a><span id="l47.123">     defaultFileName, [EnigGetString(&quot;asciiArmorFile&quot;), &quot;*.asc&quot;]);</span>
<a href="#l47.124"></a><span id="l47.124">   if (!outFile) return -1;</span>
<a href="#l47.125"></a><span id="l47.125"> </span>
<a href="#l47.126"></a><span id="l47.126">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l47.127"></a><span id="l47.127">   if (!enigmailSvc)</span>
<a href="#l47.128"></a><span id="l47.128">     return -1;</span>
<a href="#l47.129"></a><span id="l47.129"> </span>
<a href="#l47.130"></a><span id="l47.130" class="difflineminus">-  EnigmailKeyEditor.genRevokeCert(window, &quot;0x&quot; + keyId, outFile, &quot;1&quot;, &quot;&quot;,</span>
<a href="#l47.131"></a><span id="l47.131" class="difflineminus">-    function _revokeCertCb(exitCode, errorMsg) {</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-      if (exitCode !== 0) {</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-        EnigAlert(EnigGetString(&quot;revokeCertFailed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineminus">-      } else {</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineminus">-        EnigAlert(EnigGetString(&quot;revokeCertOK&quot;));</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineminus">-      }</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineminus">-</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineminus">-      if (callbackFunc) callbackFunc(exitCode === 0);</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineminus">-    });</span>
<a href="#l47.140"></a><span id="l47.140">   return 0;</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineplus">+  */</span>
<a href="#l47.142"></a><span id="l47.142"> }</span>
<a href="#l47.143"></a><span id="l47.143"> </span>
<a href="#l47.144"></a><span id="l47.144"> </span>
<a href="#l47.145"></a><span id="l47.145"> // return the label of trust for a given trust code</span>
<a href="#l47.146"></a><span id="l47.146"> function EnigGetTrustLabel(trustCode) {</span>
<a href="#l47.147"></a><span id="l47.147">   return EnigmailTrust.getTrustLabel(trustCode);</span>
<a href="#l47.148"></a><span id="l47.148"> }</span>
<a href="#l47.149"></a><span id="l47.149"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -332,65 +332,21 @@ function enigmailDeleteKey() {</span>
<a href="#l48.4"></a><span id="l48.4">       if (!EnigConfirm(EnigGetString(&quot;deleteSelectedPubKey&quot;), EnigGetString(&quot;dlg.button.delete&quot;))) return;</span>
<a href="#l48.5"></a><span id="l48.5">     }</span>
<a href="#l48.6"></a><span id="l48.6">   }</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8">   for (let j in keyList) {</span>
<a href="#l48.9"></a><span id="l48.9">     RNP.deleteKey(gKeyList[keyList[j]].fpr, deleteSecret);</span>
<a href="#l48.10"></a><span id="l48.10">   }</span>
<a href="#l48.11"></a><span id="l48.11">   clearKeyCache();</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-  /*</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-  let fprArr = [];</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-  for (let j in keyList) {</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-    fprArr.push(&quot;0x&quot; + gKeyList[keyList[j]].fpr);</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-  }</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineminus">-</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-  EnigmailKeyEditor.deleteKey(window, fprArr.join(&quot; &quot;), deleteSecret,</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineminus">-    function(exitCode, errorMsg) {</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineminus">-      if (exitCode !== 0) {</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-        EnigAlert(EnigGetString(&quot;deleteKeyFailed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineminus">-        return;</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineminus">-      }</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineminus">-      refreshKeys();</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineminus">-    });</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineminus">-  */</span>
<a href="#l48.29"></a><span id="l48.29"> }</span>
<a href="#l48.30"></a><span id="l48.30"> </span>
<a href="#l48.31"></a><span id="l48.31"> </span>
<a href="#l48.32"></a><span id="l48.32"> function enigmailEnableKey() {</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-  var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineminus">-  if (!enigmailSvc)</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineminus">-    return;</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineminus">-</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineminus">-  var keyList = getSelectedKeys();</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-  var disableKey = (gKeyList[keyList[0]].keyUseFor.indexOf(&quot;D&quot;) &lt; 0 &amp;&amp;</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineminus">-    gKeyList[keyList[0]].keyTrust.indexOf(ENIG_KEY_DISABLED) &lt; 0);</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineminus">-</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-  var keyIndex = 0;</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineminus">-  function processNextKey() {</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineminus">-    EnigmailKeyEditor.enableDisableKey(window, &quot;0x&quot; + gKeyList[keyList[keyIndex]].keyId, disableKey, function _enDisCb(exitCode, errorMsg) {</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineminus">-      if (exitCode === 0) {</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineminus">-        ++keyIndex;</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-        if (keyIndex &lt; keyList.length) {</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-          processNextKey();</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-          return;</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-        } else {</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-          refreshKeys();</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-        }</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineminus">-      } else {</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineminus">-        EnigAlert(EnigGetString(&quot;enableKeyFailed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineminus">-        if (keyIndex &gt; 0) refreshKeys();</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineminus">-      }</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineminus">-    });</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineminus">-  }</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineminus">-</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineminus">-  processNextKey();</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l48.62"></a><span id="l48.62"> }</span>
<a href="#l48.63"></a><span id="l48.63"> </span>
<a href="#l48.64"></a><span id="l48.64"> function enigShowPhoto() {</span>
<a href="#l48.65"></a><span id="l48.65"> </span>
<a href="#l48.66"></a><span id="l48.66">   var keyList = getSelectedKeys();</span>
<a href="#l48.67"></a><span id="l48.67">   var keyType = &quot;&quot;;</span>
<a href="#l48.68"></a><span id="l48.68">   var uatNum = &quot;&quot;;</span>
<a href="#l48.69"></a><span id="l48.69">   if (keyList.length == 1) {</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineat">@@ -420,66 +376,17 @@ function enigShowSpecificPhoto(uatNumber</span>
<a href="#l48.71"></a><span id="l48.71"> </span>
<a href="#l48.72"></a><span id="l48.72"> function enigmailAddPhoto() {</span>
<a href="#l48.73"></a><span id="l48.73">   var keyList = getSelectedKeys();</span>
<a href="#l48.74"></a><span id="l48.74">   keyMgrAddPhoto(gKeyList[keyList[0]].userId, gKeyList[keyList[0]].keyId);</span>
<a href="#l48.75"></a><span id="l48.75"> </span>
<a href="#l48.76"></a><span id="l48.76"> }</span>
<a href="#l48.77"></a><span id="l48.77"> </span>
<a href="#l48.78"></a><span id="l48.78"> function keyMgrAddPhoto(userId, keyId) {</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-  var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-  if (!enigmailSvc)</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineminus">-    return;</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineminus">-  var inFile;</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineminus">-  var validFile = false;</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineminus">-  while (!validFile) {</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineminus">-    inFile = EnigFilePicker(EnigGetString(&quot;keyMan.addphoto.filepicker.title&quot;),</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineminus">-      &quot;&quot;, false, &quot;*.jpg&quot;,</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineminus">-      null, [&quot;JPG&quot;, &quot;*.jpg&quot;, &quot;JPEG&quot;, &quot;*.jpeg&quot;]);</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineminus">-    if (!inFile) return;</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineminus">-</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineminus">-    var jpgHeader = EnigReadFileContents(inFile, 10);</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineminus">-</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineminus">-    validFile = (jpgHeader.charCodeAt(0) == 0xFF &amp;&amp;</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineminus">-      jpgHeader.charCodeAt(1) == 0xD8 &amp;&amp;</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineminus">-      jpgHeader.substr(6, 4) == &quot;JFIF&quot;);</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineminus">-</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineminus">-    if (!validFile) {</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineminus">-      EnigAlert(EnigGetString(&quot;keyMan.addphoto.noJpegFile&quot;));</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineminus">-    }</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineminus">-  }</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineminus">-</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineminus">-  if (inFile.fileSize &gt; 25600) {</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineminus">-    // warn if file size &gt; 25 kB</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineminus">-    if (!EnigConfirm(EnigGetString(&quot;keyMan.addphoto.warnLargeFile&quot;), EnigGetString(&quot;dlg.button.continue&quot;), EnigGetString(&quot;dlg.button.cancel&quot;)))</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineminus">-      return;</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineminus">-  }</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineminus">-</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineminus">-  var ioServ = enigGetService(IOSERVICE_CONTRACTID, &quot;nsIIOService&quot;);</span>
<a href="#l48.108"></a><span id="l48.108" class="difflineminus">-  var photoUri = ioServ.newFileURI(inFile).spec;</span>
<a href="#l48.109"></a><span id="l48.109" class="difflineminus">-  var argsObj = {</span>
<a href="#l48.110"></a><span id="l48.110" class="difflineminus">-    photoUri: photoUri,</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineminus">-    userId: userId,</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineminus">-    keyId: keyId,</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineminus">-    okPressed: false</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineminus">-  };</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineminus">-</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineminus">-  window.openDialog(&quot;chrome://openpgp/content/ui/enigmailImportPhoto.xhtml&quot;, inFile, &quot;chrome,modal=1,resizable=1,dialog=1,centerscreen&quot;, argsObj);</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineminus">-</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineminus">-  if (!argsObj.okPressed) return;</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineminus">-</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineminus">-  EnigmailKeyEditor.addPhoto(window, &quot;0x&quot; + keyId, inFile,</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineminus">-    function(exitCode, errorMsg) {</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineminus">-      if (exitCode !== 0) {</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineminus">-        EnigAlert(EnigGetString(&quot;keyMan.addphoto.failed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineminus">-        return;</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineminus">-      }</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineminus">-      refreshKeys();</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineminus">-    });</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineminus">-</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l48.130"></a><span id="l48.130"> }</span>
<a href="#l48.131"></a><span id="l48.131"> </span>
<a href="#l48.132"></a><span id="l48.132"> function enigCreateKeyMsg() {</span>
<a href="#l48.133"></a><span id="l48.133">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l48.134"></a><span id="l48.134">   if (!enigmailSvc)</span>
<a href="#l48.135"></a><span id="l48.135">     return;</span>
<a href="#l48.136"></a><span id="l48.136"> </span>
<a href="#l48.137"></a><span id="l48.137">   var keyList = getSelectedKeyIds();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeySelection.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeySelection.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -122,24 +122,16 @@ function getKeyList(secretOnly, refresh)</span>
<a href="#l49.4"></a><span id="l49.4">       userList = EnigmailKeyRing.getAllKeys(window);</span>
<a href="#l49.5"></a><span id="l49.5">       if (!userList) return null;</span>
<a href="#l49.6"></a><span id="l49.6"> </span>
<a href="#l49.7"></a><span id="l49.7">       if (userList.trustModel === &quot;t&quot;) {</span>
<a href="#l49.8"></a><span id="l49.8">         gAlwaysTrust = true;</span>
<a href="#l49.9"></a><span id="l49.9">       }</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11">       keyList = EnigmailFuncs.cloneObj(userList.keyList);</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-      let grpList = cApi.getGroups().map(k =&gt; {</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-        return newEnigmailKeyObj(k);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-      });</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-      for (let i in grpList) {</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineminus">-        keyList.push(grpList[i]);</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineminus">-      }</span>
<a href="#l49.20"></a><span id="l49.20">     }</span>
<a href="#l49.21"></a><span id="l49.21">   } catch (ex) {</span>
<a href="#l49.22"></a><span id="l49.22">     EnigmailLog.writeException(&quot;enigmailKeySelection.js: getKeyList&quot;, ex);</span>
<a href="#l49.23"></a><span id="l49.23">   }</span>
<a href="#l49.24"></a><span id="l49.24"> </span>
<a href="#l49.25"></a><span id="l49.25">   return keyList;</span>
<a href="#l49.26"></a><span id="l49.26"> }</span>
<a href="#l49.27"></a><span id="l49.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l50.4"></a><span id="l50.4"> &quot;use strict&quot;;</span>
<a href="#l50.5"></a><span id="l50.5"> </span>
<a href="#l50.6"></a><span id="l50.6"> var Cu = Components.utils;</span>
<a href="#l50.7"></a><span id="l50.7"> var Cc = Components.classes;</span>
<a href="#l50.8"></a><span id="l50.8"> var Ci = Components.interfaces;</span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10"> // modules</span>
<a href="#l50.11"></a><span id="l50.11"> /* global EnigmailData: false, EnigmailLog: false, EnigmailLocale: false, EnigmailGpg: false, EnigmailKeyEditor: false */</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-/* global EnigmailOS: false, EnigmailPrefs: false, EnigmailGpgAgent: false, EnigmailApp: false, EnigmailKeyRing: false */</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+/* global EnigmailOS: false, EnigmailPrefs: false, EnigmailApp: false, EnigmailKeyRing: false */</span>
<a href="#l50.14"></a><span id="l50.14"> /* global EnigmailDialog: false, EnigmailFuncs: false */</span>
<a href="#l50.15"></a><span id="l50.15"> </span>
<a href="#l50.16"></a><span id="l50.16"> // from enigmailCommon.js:</span>
<a href="#l50.17"></a><span id="l50.17"> /* global EnigGetWindowOptions: false, EnigConfirm: false, EnigGetString: false, GetEnigmailSvc: false */</span>
<a href="#l50.18"></a><span id="l50.18"> /* global EnigLongAlert: false, EnigAlert: false, EnigInitCommon: false, ENIG_ACCOUNT_MANAGER_CONTRACTID: false */</span>
<a href="#l50.19"></a><span id="l50.19"> /* global EnigGetPref: false, EnigSetPref: false, EnigSavePrefs: false, EnigFilePicker: false, EnigGetFilePath: false */</span>
<a href="#l50.20"></a><span id="l50.20"> /* global EnigmailWindows: false, EnigCreateRevokeCert: false */</span>
<a href="#l50.21"></a><span id="l50.21"> </span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -62,23 +62,16 @@ function enigmailKeygenLoad() {</span>
<a href="#l50.23"></a><span id="l50.23">   // - specify expiry date</span>
<a href="#l50.24"></a><span id="l50.24">   var noExpiry = document.getElementById(&quot;noExpiry&quot;);</span>
<a href="#l50.25"></a><span id="l50.25">   noExpiry.checked = false;</span>
<a href="#l50.26"></a><span id="l50.26"> </span>
<a href="#l50.27"></a><span id="l50.27">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l50.28"></a><span id="l50.28">   if (!enigmailSvc) {</span>
<a href="#l50.29"></a><span id="l50.29">     EnigAlert(EnigGetString(&quot;accessError&quot;));</span>
<a href="#l50.30"></a><span id="l50.30">   }</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineminus">-  /*</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-  if (EnigmailGpgAgent.agentType != &quot;gpg&quot;) {</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-    EnigAlert(EnigGetString(&quot;onlyGPG&quot;));</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-    return;</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-  }</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineminus">-  */</span>
<a href="#l50.38"></a><span id="l50.38"> }</span>
<a href="#l50.39"></a><span id="l50.39"> </span>
<a href="#l50.40"></a><span id="l50.40"> function updateKeySizeSel(selectedObj) {</span>
<a href="#l50.41"></a><span id="l50.41">   if (selectedObj.id === &quot;keyType_ecc&quot;) {</span>
<a href="#l50.42"></a><span id="l50.42">     document.getElementById(&quot;keySize&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l50.43"></a><span id="l50.43">   } else {</span>
<a href="#l50.44"></a><span id="l50.44">     document.getElementById(&quot;keySize&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l50.45"></a><span id="l50.45">   }</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineat">@@ -154,34 +147,17 @@ function enigmailKeygenTerminate(exitCod</span>
<a href="#l50.47"></a><span id="l50.47"> /**</span>
<a href="#l50.48"></a><span id="l50.48">  * generate and save a revokation certificate.</span>
<a href="#l50.49"></a><span id="l50.49">  *</span>
<a href="#l50.50"></a><span id="l50.50">  * return: Promise object</span>
<a href="#l50.51"></a><span id="l50.51">  */</span>
<a href="#l50.52"></a><span id="l50.52"> </span>
<a href="#l50.53"></a><span id="l50.53"> function genAndSaveRevCert(keyId, uid) {</span>
<a href="#l50.54"></a><span id="l50.54">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: genAndSaveRevCert\n&quot;);</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineminus">-</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-  return new Promise(</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-    function(resolve, reject) {</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-      let keyFile = EnigmailApp.getProfileDirectory();</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineminus">-      keyFile.append(&quot;0x&quot; + keyId + &quot;_rev.asc&quot;);</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-      // create a revokation cert in the TB profile directoy</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineminus">-      EnigmailKeyEditor.genRevokeCert(window, &quot;0x&quot; + keyId, keyFile, &quot;1&quot;, &quot;&quot;,</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineminus">-        function _revokeCertCb(exitCode, errorMsg) {</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineminus">-          if (exitCode !== 0) {</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineminus">-            EnigAlert(EnigGetString(&quot;revokeCertFailed&quot;) + &quot;\n\n&quot; + errorMsg);</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineminus">-            reject(1);</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-          }</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-          saveRevCert(keyFile, keyId, uid, resolve, reject);</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineminus">-        });</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineminus">-    }</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-  );</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l50.74"></a><span id="l50.74"> }</span>
<a href="#l50.75"></a><span id="l50.75"> </span>
<a href="#l50.76"></a><span id="l50.76"> /**</span>
<a href="#l50.77"></a><span id="l50.77">  *  create a copy of the revokation cert at a user defined location</span>
<a href="#l50.78"></a><span id="l50.78">  */</span>
<a href="#l50.79"></a><span id="l50.79"> function saveRevCert(inputKeyFile, keyId, uid, resolve, reject) {</span>
<a href="#l50.80"></a><span id="l50.80"> </span>
<a href="#l50.81"></a><span id="l50.81">   let defaultFileName = uid.replace(/[\\/&lt;&gt;]/g, &quot;&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -33,17 +33,16 @@ var EnigmailWindows = ChromeUtils.import</span>
<a href="#l51.4"></a><span id="l51.4"> var EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l51.5"></a><span id="l51.5"> var EnigmailPersistentCrypto = ChromeUtils.import(&quot;chrome://openpgp/content/modules/persistentCrypto.jsm&quot;).EnigmailPersistentCrypto;</span>
<a href="#l51.6"></a><span id="l51.6"> var EnigmailStreams = ChromeUtils.import(&quot;chrome://openpgp/content/modules/streams.jsm&quot;).EnigmailStreams;</span>
<a href="#l51.7"></a><span id="l51.7"> var EnigmailEvents = ChromeUtils.import(&quot;chrome://openpgp/content/modules/events.jsm&quot;).EnigmailEvents;</span>
<a href="#l51.8"></a><span id="l51.8"> var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l51.9"></a><span id="l51.9"> var EnigmailDecryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/decryption.jsm&quot;).EnigmailDecryption;</span>
<a href="#l51.10"></a><span id="l51.10"> var EnigmailAttachment = ChromeUtils.import(&quot;chrome://openpgp/content/modules/attachment.jsm&quot;).EnigmailAttachment;</span>
<a href="#l51.11"></a><span id="l51.11"> var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-var EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l51.13"></a><span id="l51.13"> var EnigmailKeyUsability = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyUsability.jsm&quot;).EnigmailKeyUsability;</span>
<a href="#l51.14"></a><span id="l51.14"> var EnigmailURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/uris.jsm&quot;).EnigmailURIs;</span>
<a href="#l51.15"></a><span id="l51.15"> var EnigmailProtocolHandler = ChromeUtils.import(&quot;chrome://openpgp/content/modules/protocolHandler.jsm&quot;).EnigmailProtocolHandler;</span>
<a href="#l51.16"></a><span id="l51.16"> var EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l51.17"></a><span id="l51.17"> var EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l51.18"></a><span id="l51.18"> var EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l51.19"></a><span id="l51.19"> var EnigmailWks = ChromeUtils.import(&quot;chrome://openpgp/content/modules/webKey.jsm&quot;).EnigmailWks;</span>
<a href="#l51.20"></a><span id="l51.20"> var EnigmailStdlib = ChromeUtils.import(&quot;chrome://openpgp/content/modules/stdlib.jsm&quot;).EnigmailStdlib;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -68,35 +68,16 @@ Enigmail.hlp = {</span>
<a href="#l52.4"></a><span id="l52.4">     let resultingArray = []; // resulting key list (if all valid)</span>
<a href="#l52.5"></a><span id="l52.5">     try {</span>
<a href="#l52.6"></a><span id="l52.6">       // create array of address elements (email or key)</span>
<a href="#l52.7"></a><span id="l52.7">       let addresses = [];</span>
<a href="#l52.8"></a><span id="l52.8">       try {</span>
<a href="#l52.9"></a><span id="l52.9">         addresses = EnigmailFuncs.stripEmail(emailsOrKeys).split(',');</span>
<a href="#l52.10"></a><span id="l52.10">       } catch (ex) {}</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-      /*</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-      // resolve GnuPG groups</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-      let gpgGroups = EnigmailGpg.getGpgGroups();</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineminus">-      for (let i = 0; i &lt; addresses.length; i++) {</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineminus">-        let addr = addresses[i].toLowerCase();</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-        for (let j = 0; j &lt; gpgGroups.length; j++) {</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineminus">-          if (addr == gpgGroups[j].alias.toLowerCase() ||</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineminus">-            &quot;&lt;&quot; + addr + &quot;&gt;&quot; == gpgGroups[j].alias.toLowerCase()) {</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineminus">-            // replace address with keylist</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-            let grpList = gpgGroups[j].keylist.split(/;/);</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineminus">-            addresses[i] = grpList[0];</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineminus">-            for (let k = 1; k &lt; grpList.length; k++) {</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineminus">-              addresses.push(grpList[k]);</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineminus">-            }</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineminus">-          }</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-        }</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-      }</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineminus">-      */</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineminus">-</span>
<a href="#l52.31"></a><span id="l52.31">       // resolve all the email addresses if possible:</span>
<a href="#l52.32"></a><span id="l52.32">       keyMissing = EnigmailKeyRing.getValidKeysForAllRecipients(addresses, minTrustLevel, details, resultingArray);</span>
<a href="#l52.33"></a><span id="l52.33">     } catch (ex) {</span>
<a href="#l52.34"></a><span id="l52.34">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return null (exception: &quot; + ex.message + &quot;\n&quot; + ex.stack + &quot;)\n&quot;);</span>
<a href="#l52.35"></a><span id="l52.35">       return null;</span>
<a href="#l52.36"></a><span id="l52.36">     }</span>
<a href="#l52.37"></a><span id="l52.37">     if (keyMissing) {</span>
<a href="#l52.38"></a><span id="l52.38">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return null (key missing)\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -27,17 +27,16 @@ var EnigmailFiles = ChromeUtils.import(&quot;</span>
<a href="#l53.4"></a><span id="l53.4"> var EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l53.5"></a><span id="l53.5"> var EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l53.6"></a><span id="l53.6"> var EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l53.7"></a><span id="l53.7"> var EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l53.8"></a><span id="l53.8"> var EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l53.9"></a><span id="l53.9"> var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l53.10"></a><span id="l53.10"> var EnigmailURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/uris.jsm&quot;).EnigmailURIs;</span>
<a href="#l53.11"></a><span id="l53.11"> var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-var EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l53.13"></a><span id="l53.13"> var EnigmailDecryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/decryption.jsm&quot;).EnigmailDecryption;</span>
<a href="#l53.14"></a><span id="l53.14"> var EnigmailEncryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/encryption.jsm&quot;).EnigmailEncryption;</span>
<a href="#l53.15"></a><span id="l53.15"> var EnigmailClipboard = ChromeUtils.import(&quot;chrome://openpgp/content/modules/clipboard.jsm&quot;).EnigmailClipboard;</span>
<a href="#l53.16"></a><span id="l53.16"> var EnigmailWkdLookup = ChromeUtils.import(&quot;chrome://openpgp/content/modules/wkdLookup.jsm&quot;).EnigmailWkdLookup;</span>
<a href="#l53.17"></a><span id="l53.17"> var EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l53.18"></a><span id="l53.18"> var EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l53.19"></a><span id="l53.19"> var EnigmailMsgRead = ChromeUtils.import(&quot;chrome://openpgp/content/modules/msgRead.jsm&quot;).EnigmailMsgRead;</span>
<a href="#l53.20"></a><span id="l53.20"> var EnigmailMimeEncrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mimeEncrypt.jsm&quot;).EnigmailMimeEncrypt;</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineat">@@ -3207,154 +3206,16 @@ Enigmail.msg = {</span>
<a href="#l53.22"></a><span id="l53.22">     else {</span>
<a href="#l53.23"></a><span id="l53.23">       EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.sendMessageListener: sending in progress - autosave aborted\n&quot;);</span>
<a href="#l53.24"></a><span id="l53.24">       event.preventDefault();</span>
<a href="#l53.25"></a><span id="l53.25">       event.stopPropagation();</span>
<a href="#l53.26"></a><span id="l53.26">     }</span>
<a href="#l53.27"></a><span id="l53.27">     this.sendProcess = false;</span>
<a href="#l53.28"></a><span id="l53.28">   },</span>
<a href="#l53.29"></a><span id="l53.29"> </span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-  // encrypt attachments when sending inline PGP mails</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineminus">-  // It's quite a hack: the attachments are stored locally</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-  // and the attachments list is modified to pick up the</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-  // encrypted file(s) instead of the original ones.</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-  encryptAttachments: function(bucketList, newAttachments, window, uiFlags,</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-    fromAddr, toAddr, bccAddr, sendFlags,</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-    errorMsgObj) {</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptAttachments\n&quot;);</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineminus">-</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineminus">-</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineminus">-    var ioServ;</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineminus">-    var fileTemplate;</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineminus">-    errorMsgObj.value = &quot;&quot;;</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineminus">-</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-    try {</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineminus">-      ioServ = Components.classes[IOSERVICE_CONTRACTID].getService(Components.interfaces.nsIIOService);</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineminus">-      if (!ioServ)</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-        return -1;</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineminus">-    }</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineminus">-    catch (ex) {</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineminus">-      return -1;</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineminus">-    }</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineminus">-</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineminus">-    var tmpDir = EnigmailFiles.getTempDir();</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineminus">-    var extAppLauncher = Components.classes[&quot;@mozilla.org/mime;1&quot;].getService(Components.interfaces.nsPIExternalAppLauncher);</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineminus">-</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineminus">-    try {</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineminus">-      fileTemplate = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineminus">-      fileTemplate.initWithPath(tmpDir);</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineminus">-      if (!(fileTemplate.isDirectory() &amp;&amp; fileTemplate.isWritable())) {</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineminus">-        errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineminus">-        return -1;</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineminus">-      }</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineminus">-      fileTemplate.append(&quot;encfile&quot;);</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineminus">-    }</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineminus">-    catch (ex) {</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineminus">-      errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineminus">-      return -1;</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineminus">-    }</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptAttachments tmpDir=&quot; + tmpDir + &quot;\n&quot;);</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineminus">-    var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineminus">-    if (!enigmailSvc)</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineminus">-      return null;</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineminus">-</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineminus">-    var exitCodeObj = {};</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineminus">-    var statusFlagsObj = {};</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineminus">-</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineminus">-    var node = bucketList.firstChild;</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineminus">-    while (node) {</span>
<a href="#l53.82"></a><span id="l53.82" class="difflineminus">-      var origUrl = node.attachment.url;</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineminus">-      if (origUrl.substring(0, 7) != &quot;file://&quot;) {</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineminus">-        // this should actually never happen since it is pre-checked!</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineminus">-        errorMsgObj.value = &quot;The attachment '&quot; + node.attachment.name + &quot;' is not a local file&quot;;</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineminus">-        return -1;</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineminus">-      }</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineminus">-      // transform attachment URL to platform-specific file name</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineminus">-      var origUri = ioServ.newURI(origUrl, null, null);</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineminus">-      var origFile = origUri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineminus">-      if (node.attachment.temporary) {</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineminus">-        try {</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineminus">-          var origLocalFile = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-          origLocalFile.initWithPath(origFile.file.path);</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineminus">-          extAppLauncher.deleteTemporaryFileOnExit(origLocalFile);</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineminus">-        }</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineminus">-        catch (ex) {}</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineminus">-      }</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineminus">-</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineminus">-      var newFile = fileTemplate.clone();</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineminus">-      var txtMessage;</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineminus">-      try {</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineminus">-        newFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, 0x180);</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineminus">-        txtMessage = EnigmailEncryption.encryptAttachment(window, fromAddr, toAddr, bccAddr, sendFlags,</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineminus">-          origFile.file, newFile,</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineminus">-          exitCodeObj, statusFlagsObj,</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineminus">-          errorMsgObj);</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineminus">-      }</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineminus">-      catch (ex) {}</span>
<a href="#l53.111"></a><span id="l53.111" class="difflineminus">-</span>
<a href="#l53.112"></a><span id="l53.112" class="difflineminus">-      if (exitCodeObj.value !== 0) {</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineminus">-        return exitCodeObj.value;</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineminus">-      }</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineminus">-</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineminus">-      var fileInfo = {</span>
<a href="#l53.117"></a><span id="l53.117" class="difflineminus">-        origFile: origFile,</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineminus">-        origUrl: node.attachment.url,</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-        origName: node.attachment.name,</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineminus">-        origTemp: node.attachment.temporary,</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineminus">-        origCType: node.attachment.contentType</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineminus">-      };</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineminus">-</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineminus">-      // transform platform specific new file name to file:// URL</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineminus">-      var newUri = ioServ.newFileURI(newFile);</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineminus">-      fileInfo.newUrl = newUri.asciiSpec;</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineminus">-      fileInfo.newFile = newFile;</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineminus">-      fileInfo.encrypted = (sendFlags &amp; ENCRYPT);</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineminus">-</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineminus">-      newAttachments.push(fileInfo);</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineminus">-      node = node.nextSibling;</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineminus">-    }</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineminus">-</span>
<a href="#l53.134"></a><span id="l53.134" class="difflineminus">-    var i = 0;</span>
<a href="#l53.135"></a><span id="l53.135" class="difflineminus">-    if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l53.136"></a><span id="l53.136" class="difflineminus">-      // if we got here, all attachments were encrpted successfully,</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineminus">-      // so we replace their names &amp; urls</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineminus">-      node = bucketList.firstChild;</span>
<a href="#l53.139"></a><span id="l53.139" class="difflineminus">-</span>
<a href="#l53.140"></a><span id="l53.140" class="difflineminus">-      while (node) {</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineminus">-        node.attachment.url = newAttachments[i].newUrl;</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineminus">-        node.attachment.name += EnigmailPrefs.getPref(&quot;inlineAttachExt&quot;);</span>
<a href="#l53.143"></a><span id="l53.143" class="difflineminus">-        node.attachment.contentType = &quot;application/octet-stream&quot;;</span>
<a href="#l53.144"></a><span id="l53.144" class="difflineminus">-        node.attachment.temporary = true;</span>
<a href="#l53.145"></a><span id="l53.145" class="difflineminus">-</span>
<a href="#l53.146"></a><span id="l53.146" class="difflineminus">-        ++i;</span>
<a href="#l53.147"></a><span id="l53.147" class="difflineminus">-        node = node.nextSibling;</span>
<a href="#l53.148"></a><span id="l53.148" class="difflineminus">-      }</span>
<a href="#l53.149"></a><span id="l53.149" class="difflineminus">-    }</span>
<a href="#l53.150"></a><span id="l53.150" class="difflineminus">-    else {</span>
<a href="#l53.151"></a><span id="l53.151" class="difflineminus">-      // for inline signing we need to add new attachments for every</span>
<a href="#l53.152"></a><span id="l53.152" class="difflineminus">-      // signed file</span>
<a href="#l53.153"></a><span id="l53.153" class="difflineminus">-      for (i = 0; i &lt; newAttachments.length; i++) {</span>
<a href="#l53.154"></a><span id="l53.154" class="difflineminus">-        // create new attachment</span>
<a href="#l53.155"></a><span id="l53.155" class="difflineminus">-        var fileAttachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;].createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l53.156"></a><span id="l53.156" class="difflineminus">-        fileAttachment.temporary = true;</span>
<a href="#l53.157"></a><span id="l53.157" class="difflineminus">-        fileAttachment.url = newAttachments[i].newUrl;</span>
<a href="#l53.158"></a><span id="l53.158" class="difflineminus">-        fileAttachment.name = newAttachments[i].origName + EnigmailPrefs.getPref(&quot;inlineSigAttachExt&quot;);</span>
<a href="#l53.159"></a><span id="l53.159" class="difflineminus">-</span>
<a href="#l53.160"></a><span id="l53.160" class="difflineminus">-        // add attachment to msg</span>
<a href="#l53.161"></a><span id="l53.161" class="difflineminus">-        this.addAttachment(fileAttachment);</span>
<a href="#l53.162"></a><span id="l53.162" class="difflineminus">-      }</span>
<a href="#l53.163"></a><span id="l53.163" class="difflineminus">-</span>
<a href="#l53.164"></a><span id="l53.164" class="difflineminus">-    }</span>
<a href="#l53.165"></a><span id="l53.165" class="difflineminus">-    return 0;</span>
<a href="#l53.166"></a><span id="l53.166" class="difflineminus">-  },</span>
<a href="#l53.167"></a><span id="l53.167" class="difflineminus">-</span>
<a href="#l53.168"></a><span id="l53.168">   toggleAttribute: function(attrName) {</span>
<a href="#l53.169"></a><span id="l53.169">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleAttribute('&quot; + attrName + &quot;')\n&quot;);</span>
<a href="#l53.170"></a><span id="l53.170"> </span>
<a href="#l53.171"></a><span id="l53.171">     var menuElement = document.getElementById(&quot;enigmail_&quot; + attrName);</span>
<a href="#l53.172"></a><span id="l53.172"> </span>
<a href="#l53.173"></a><span id="l53.173">     var oldValue = EnigmailPrefs.getPref(attrName);</span>
<a href="#l53.174"></a><span id="l53.174">     EnigmailPrefs.setPref(attrName, !oldValue);</span>
<a href="#l53.175"></a><span id="l53.175">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mail/extensions/openpgp/prefs/openpgp-prefs.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mail/extensions/openpgp/prefs/openpgp-prefs.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,38 +1,26 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /* global pref: false */</span>
<a href="#l54.5"></a><span id="l54.5"> /*</span>
<a href="#l54.6"></a><span id="l54.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.7"></a><span id="l54.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.8"></a><span id="l54.8">  * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l54.9"></a><span id="l54.9">  */</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11" class="difflineminus">-// 0: disable openpgp</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-// 1: use internal default engine</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-// 2: use gnupg engine</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-pref(&quot;temp.openpgp.engine&quot;, 0);</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-</span>
<a href="#l54.17"></a><span id="l54.17"> /**</span>
<a href="#l54.18"></a><span id="l54.18">  * Default pref values for Enigmail</span>
<a href="#l54.19"></a><span id="l54.19">  */</span>
<a href="#l54.20"></a><span id="l54.20"> </span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22"> // the last configured Enigmail version</span>
<a href="#l54.23"></a><span id="l54.23"> pref(&quot;temp.openpgp.configuredVersion&quot;, &quot;&quot;);</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25"> // Hide prefs and menu entries from non-advanced users</span>
<a href="#l54.26"></a><span id="l54.26"> pref(&quot;temp.openpgp.advancedUser&quot;, false);</span>
<a href="#l54.27"></a><span id="l54.27"> </span>
<a href="#l54.28"></a><span id="l54.28" class="difflineminus">-// additional parameter(s) to pass to GnuPG</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineminus">-pref(&quot;temp.openpgp.agentAdditionalParam&quot;, &quot;&quot;);</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-// path to gpg executable</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineminus">-pref(&quot;temp.openpgp.agentPath&quot;, &quot;&quot;);</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineminus">-</span>
<a href="#l54.34"></a><span id="l54.34"> // ** enigmail keySel preferences:</span>
<a href="#l54.35"></a><span id="l54.35"> // use rules to assign keys</span>
<a href="#l54.36"></a><span id="l54.36"> pref(&quot;temp.openpgp.assignKeysByRules&quot;, true);</span>
<a href="#l54.37"></a><span id="l54.37"> // use email addresses to assign keys</span>
<a href="#l54.38"></a><span id="l54.38"> pref(&quot;temp.openpgp.assignKeysByEmailAddr&quot;, true);</span>
<a href="#l54.39"></a><span id="l54.39"> // use manual dialog to assign missing keys</span>
<a href="#l54.40"></a><span id="l54.40"> pref(&quot;temp.openpgp.assignKeysManuallyIfMissing&quot;, true);</span>
<a href="#l54.41"></a><span id="l54.41"> // always srats manual dialog for keys</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineat">@@ -57,19 +45,16 @@ pref(&quot;temp.openpgp.displaySignWarn&quot;, tru</span>
<a href="#l54.43"></a><span id="l54.43"> pref(&quot;temp.openpgp.displayPartiallySigned&quot;, true);</span>
<a href="#l54.44"></a><span id="l54.44"> </span>
<a href="#l54.45"></a><span id="l54.45"> // try to match secondary uid to from address</span>
<a href="#l54.46"></a><span id="l54.46"> pref(&quot;temp.openpgp.displaySecondaryUid&quot;, true);</span>
<a href="#l54.47"></a><span id="l54.47"> </span>
<a href="#l54.48"></a><span id="l54.48"> // treat '-- ' as signature separator</span>
<a href="#l54.49"></a><span id="l54.49"> pref(&quot;temp.openpgp.doubleDashSeparator&quot;, true);</span>
<a href="#l54.50"></a><span id="l54.50"> </span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-// last state of dialog to choose encryption method if there are attachments</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineminus">-pref(&quot;temp.openpgp.encryptAttachments&quot;, 1);</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineminus">-</span>
<a href="#l54.54"></a><span id="l54.54"> // skip the attachments dialog</span>
<a href="#l54.55"></a><span id="l54.55"> pref(&quot;temp.openpgp.encryptAttachmentsSkipDlg&quot;, 0);</span>
<a href="#l54.56"></a><span id="l54.56"> </span>
<a href="#l54.57"></a><span id="l54.57"> // Encrypt to self</span>
<a href="#l54.58"></a><span id="l54.58"> pref(&quot;temp.openpgp.encryptToSelf&quot;, true);</span>
<a href="#l54.59"></a><span id="l54.59"> </span>
<a href="#l54.60"></a><span id="l54.60"> // enable 'Decrypt &amp; open' for double click on attachment (if possible)</span>
<a href="#l54.61"></a><span id="l54.61"> pref(&quot;temp.openpgp.handleDoubleClick&quot;, true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

